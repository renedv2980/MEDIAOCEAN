*          DATA SET SPLNK16    AT LEVEL 182 AS OF 11/03/20                      
*PHASE T21E16C                                                                  
*INCLUDE SPOMCOM                                                                
*                                                                               
*=====================================================================*         
*                                                                               
* HISTORY                                                                       
* -------                                                                       
*        WHEN                                                                   
* WHO   DDMMMYR LVL WHAT                                                        
* ----  ------- --- ----                                                        
* HWON  04NOV20 182 SPEC-42842|SUPPORT OE RESEND                                
*               182 SPEC-50006|SEND 0 SPOT BUYHDR ON REVISION                   
* HWON  20NOV19 181 SPEC-29367|SUPPORT 2-DEC PREC IMPRESSIONS                   
* HWON  17JUL19 180 SPEC-29538|SUPPORT CUSTOM CS DEMOS FOR DARE MKGDS           
* HWON  16MAY19 179 SPEC-34065|HOTFIX|ADD PD SUPPORT FOR NRR REP                
* HWON  18MAR19 178 SPEC-34065|HOTFIX|ADD PD SUPPORT FOR GENMEDIA REPS          
* HWON  18MAR19 177 SPEC-33738|HOTFIX|FIX TV ORDER DARE DIRECT DUMPS            
* HWON  13MAR19 176 SPEC-33641|HOTFIX|FIX CANCEL REDI ORDER DUMPS               
* HWON  13MAR19 175 SPEC-27416|SUPPORT END OF CONTRACT                          
* HWON  13MAR19 175 SPEC-27472|ONLY SEND UUID OF BUYLINE IF MATCHES REP         
* HWON  13MAR19 175 SPEC-23940|2-BYTE BUYLINES                                  
* HWON  07NOV18 174 SPEC-29057|SUPPORT COMSCORE CUSTOM DEMOS                    
* HWON  14JUN18 173 SPEC-20852|UPDATE LOGIC FOR SENDING DARE WHEN               
*               173 SIGNED ON WITH A TEST ID                                    
* HWON  30MAY18 172 SPEC-21168|ALLOW REP PERS.DIR. WHEN HOME MARKET             
* HWON  30MAY18 172 SPEC-18262|SUPPORT MKGD BOOK AND BOOKTYPE                   
* HWON  12JAN18 171 SPEC-19502|ADD GMP AS VALID REDI REP FOR PERS'L DIR         
* HWON  21DEC17 170 SPEC-19160|DON'T ALLOW SEND OF OPEN DARE ORDER              
* HWON  02NOV17 169 SPEC-7780 - SUPPORT OE CANCEL CONFIRM  (17.3)               
*               169 RELAX RULES FOR TST/FQA EDI SENDABLE STATIONS               
*               169 FIX FAX REPORT DISPLAYING COMSCORE DEMOS                    
* HWON  03OCT17 168 SPEC-16298 - FIX 'OFFER NOT FOUND' ERROR                    
* HWON  15SEP17 167 SPEC-16077 - SEND ERROR FOR INVALID MKGD UPGRADE            
* HWON  13SEP17 166 SPEC-16077 - SEND ERROR FOR INVALID MKGD UPGRADE            
* HWON  12SEP17 165 SPEC-13049                                                  
*               165 -RELINK FOR LARGER IOAREAS                                  
*               165 -SUPPORT AGYTDM/AGYCDC/BUYCDV FOR COMSCORE                  
*               165 -SUPPORT COMSCORE MAKEGOOD DEMOS                            
* WHOA  14AUG17 164 FIX INCORRECT BAND (D BAND) FOR TV FIRST-EDI STA            
* HWON  13JUL17 162 FIX 'INVLD DEMO' ERROR WHEN SAVING MG COMSCORE DEMO         
* HWON  25MAY17 161 SUPPORT BUYAAU RECORD FOR DARE AUTO-AVAILS UUID             
* HWON  20ARP17 160 SEND 1ST EDI SEND STATION/DATE FOR AGYRCL & AGYCAN          
* HWON  27MAR17 159 FIX PREVENT SENDING ORDERS W/SYSCODE ONLY BUYS              
* HWON  20DEC16 158 TURN OFF 'NEED TO RESEND' FLAG WHEN ORDER IS SENT           
* HWON  20DEC16 157 RELAX RB SEND RESTRICTION TO ALLOW ALEGORY ENTITY           
*                   TO SEND ORDERS, ROUTING CODE ALG**                          
* HWON  04NOV16 155 COMSCORE BUG FIXES                                          
* HWON  01NOV16 154 COMSCORE SUPPORT                                            
* HWON  02JUN16 153 I-HEART CM BAND STATION SUPPORT                             
*               153 MOSBTK-546 - UPDATE PERSONAL DIRECTORY                      
*               153 MOSBTK-366 - SKIP REDI SALESPERSON FOR IHEART               
*               153 MOSBTK-431 - SUPPORT FAXING FOR MEDIA X(NTWK RADIO)         
* HWON  18APR16 152 FIX DARE INCORRECTLY SENDING BUYDM2                         
* HWON  10DEC15 151 UPDATE FLIGHT SENT FOR OE SENT ORDERS                       
* HWON  10DEC15 150 SUPERDESK META D/L, DON'T SEND MAP21 FOR EDAILY=N           
* WHOA  23OCT15 149 "LAST SENT TO VIDEA" FLAG SUPPORT                           
* HWON  20OCT15 148 UPDATE RB ORDER SEND EXCEPTION LOGIC                        
* HWON  14OCT15 147 SUPPORT 6K CABLE MAKEGOOD RECORDS                           
* HWON  08OCT15 146 ADD ADDTIONAL RB USERID TO EXCEPTION LIST                   
* HWON  28AUG15 145 NEW ERRORS WHEN SENDING OE ORDERS                           
* WHOA  08AUG15 144 UPDATE PERSONAL DIRECTORY TO SUPPORT MULTI-REP DSTA         
* HWON  18MAR15 143 ERROR IF SENDING OE TRADE WITH BUYLINE W/O COST2            
* HWON  26JUN15 142 SEND ERROR IF MAKEGOOD RECORD IS OVERFLOWING                
* WHOA  21JAN15 141 REMOVE CHECK FOR RB USERS FROM SENDING EDI                  
* WHOA  08JAN15 140 MARKET ORDER STATUS FOR BUYTRACKER                          
* HWON  06OCT14 139 PREVENT RB USERS FROM SENDING EDI IN CERTAIN CASES          
* HWON  15AUG14 138 UPDATE SBS TABLE FOR PD VALIDATION                          
* HWON  10JUL14 137 SUPPORT CROSS NETWORK MAKEGOOD RECORDS                      
* HWON  23APR14 136 FIX DUMP WHEN REDI SALESPERSON IS INVALID                   
* HWON  31MAR14 135 FIX BUYNWK TO SEND 4 CHAR NIELSON CABLE CODE                
* HWON  13MAR14 133 SEND NCC ORDERS                                             
*                   IGNORE SALESPERSON FOR RADIO STREAM                         
* HWON  18FEB14 132 FIX CABLE STATION PERSONAL DIRECTORY VALIDATION             
* HWON  04DEC13 131 CANCEL OF CONFIRMED ORDER WHEN STA CHANGED REPS             
* HWON  24JUN13 130 FIX PERSONAL DIRECTORY VALIDATION CALL DDGETDARE            
* HWON  04JAN13 129 CALL DDGETDARE                                              
* HWON  06SEP12 128 FIX RECALL TV ORDERS INCORRECTLY MARKED AS XML              
* HWON  20AUG12 127 TURN ON NEW ORDER FOR ALL CLIENTS                           
* HWON  13AUG12 126 SUPPORT MEDIA X (NETWORK RADIO)                             
* HWON  16MAY12 125 ADD RRP TO SBS TABLE                                        
* HWON  26MAR12 124 FIX -MO/-DS/-WO ROUTING                                     
* HWON  23MAR12 123 OE TOTAL SPOT/& CHECK BOTH PRETAX AND POSTTAX               
*               123 FIX META D/L SEND MARKET NAMES                              
* HWON  19MAR12 122 FIX BAD ORDER COM RECORDS, DUMP'G FOR NEW ORDER#            
* HWON  14MAR12 121 NEW ORDER NUMBER                                            
* HWON  13MAR12 120 DON'T ALLOW TV ORDER TO GO TO REDI XML HUB                  
* HWON  13MAR12 119 ALLOW MORE THAN 255 MARKETS FOR META D/L                    
* HWON  23FEB12 118 FIX OE VERIFY TOTAL SPOTS AND DOLLARS                       
* HWON  16JAN12 116 OE VERIFY TOTAL SPOTS AND DOLLARS                           
* HWON  20DEC11 115 FIX FAX SHOW NO BUYLINE SCHEDULES                           
* HWON  12DEC11 114 DISABLE FAXING FOR JWT (ALPHA JS)                           
* HWON  07DEC11 113 DON'T SET FIRST EDI DATE WHEN ORDER-EXPRESS STATUS          
* HWON  26AUG11 112 FIX ISSUE AGYCAN NOT SENDING CONTRACT                       
* HWON  11JUL11 111 OPTIMIZE TSAR BUFFER FOR OE/FAX CODE                        
* HWON  22MAR11 110 TURN PROTECTION OFF WHEN UPDATING TCBMINIO                  
*               110 ATTEMPT TO FIX DEADLY EMBRACE BUG                           
* HWON  09FEB11 108 FIX ORDERS STUCK IN *SENT/*FAXSENT STATUS                   
* WHOA  26JAN11 107 UPDATE DDMOREPTAB                                           
*               107 FIX TO ALLOW COST2 OF ZERO FOR MAKEGOODS                    
* HWON  25JAN11 106 SEND ERROR IF ADDING/SENDING ORDER WITH BAD FLIGHT          
*               106 ERROR IF RECALLING ORDER NOT IN OPEN OR SENT STATUS         
*               106 CLEAR PRODUCT AND PIGGYBACK ON EACH NEW ORDER               
* WHOA  28DEC10 105 GIVE US EARLY WARNING OF REACHING ORDER LIMITS              
* WHOA  23DEC10 104 STOP CREATING MORE THAN 10000 ORDERS/DAY                    
* WHOA  11NOV10 103 OOW AND DAILY SENT IN METADATA D/L X'0155'                  
* WHOA  30JUL10 102 SUPERDESK PID DOWNLOAD MOVED FROM SPLNK12                   
* HWON  22JUL10 101 DON'T ALLOW OOMGXOS TO UPDATE                               
* HWON  05MAY10 100 FIX PERS.DIR. VALIDT'N TO SEND CORRECT MASTER REP           
* HWON  18MAR10 099 LOCK FLIGHT RECORD ONCE ORDER IS SENT                       
*               099 DON'T ROLLBACK GAPSEQ# FOR UNSENT ORDERS                    
*               099 SEND ERROR IF DOWIG ELEMENT NOT PRESENT FOR OE              
* WHOA  12MAR10 098 NBC TO TRAILOUT TO WIDEORBIT                                
* WHOA  12MAR10 097 NBC TO TRAILOUT TO WIDEORBIT                                
* WHOA  09FEB10 096 UPDATE SBS TABLE : NEW KATZ RADIO REP   CCRD                
* WHOA  31DEC09 095 NEW DATE FORMAT IN DDMOREPTAB                               
* HWON  15DEC09 094 UPDATE SBS TABLE                                            
* HWON  08SEP09 093 PERSONAL DIRECTORY VALIDATION FIXES                         
* HWON  07JUL09 092 DELETE EMAIL IF SEND METHOD IS NOT EMAIL                    
* HWON  27APR09 088 DON'T ALLOW REDI WITHOUT VALID SALESPERSON                  
*               088 DON'T ALLOW USERID OMGBED TO FAX                            
* HWON  07APR09 087 DON'T ALLOW REDI WITHOUT VALID SALESPERSON                  
* HWON  20MAR09 086 FIX ZENITH SPECIAL DX HEADLINES                             
* HWON  19MAR09 085 FIX OE ROLLBACK AND SAVING EMAILS                           
* HWON  18MAR09 084 DON'T ALLOW FAXING FOR H7/FR                                
* HWON  16MAR09 083 DON'T ALLOW EDI IF NO DARE ROUTING CODE                     
* HWON  05MAR09 082 FIX DX 0-COST TRADE SHOWING BUYLINE COST                    
* HWON  19FEB09 081 FIX OE ROLLBACK                                             
* HWON  05FEB09 080 FIX ZENITH SPECIAL DX HEADLINES                             
* HWON  16JAN09 079 FIX PERSONAL DIRECTORY VALID TO SUPPORT SPECIAL LLC         
* HWON  07JAN09 078 READ THE CORRECT 00 PROFILE FOR EXCLUDE TAX FEATURE         
*               078 DIE IF PC SENDS REQUEST TO SEND CABLE VIA EDI!!!            
* HWON  16DEC08 077 CHANGE AGYCAN TO SUPPORT DSTA CALL LETTER SWITCHES          
*               077 ADD NEW KATZ RADIO GROUP TAKEOVER OLD INTEREP REPS          
* HWON  15OCT08 075 SPECIAL HEADLINES FOR AGENCY PC                             
* HWON  11SEP08 074 TEMPORARILY ALLOW TMNY/FQA TO SEND TO D STATIONS            
* HWON  11SEP08 073 ENHANCE CHG 62: BUT FOR WKLY EST, PRNT BUYLN FLAG           
* HWON  23JUN08 072 DON'T ALLOW ADD/SENDING ORDERS W/DEACTIVATED BUYERS         
* HWON  03JUN08 071 SET DOSPFSTA AND DOSPFAID FOR ORDEREXPRESS ORDERS           
*               071 FOR REDI, READ NY OFFICE FOR ALPHA CODE                     
*               071 FOR REDI, DON'T ALLOW REDIXML IF ORBITS EXIST               
* HWON  08MAY08 069 TELECAST SCHEDULE PRINTS INCORRECTLY FOR FLT-ORDERS         
*               069 DUMPING WHEN SENDING FLT-ORDERS VIA ORDER-EXPRESS           
* HWON  07MAY08 068 FIX FAX BUG, DUMPING WHEN SENDING 0-SPOT ORDER              
* HWON  29FEB08 066 ORDER EXPORT                                                
* HWON  21FEB08 065 FIX BUG WHEN SENDING ORDER TO A DARK STATION                
* HWON  20FEB08 064 PERSONAL DIRECTORY VALIDATION                               
* HWON  15FEB08 063 COMMIT ORDER#                                               
* HWON  04FEB08 062 ALWAYS PRINT BUYLINES AS DAILY IF ESTIMATE IS DAILY         
* HWON  18DEC07 060 SET 2-DECIMAL FLAG CORRECTLY FOR MAKEGOODS                  
* HWON  19NOV07 059 SAVE ALL NON-R/E RATINGS AS 1 DECIMAL AND DIV BY 10         
*               059 DON'T INC. THE SEND VERSION# WHEN QSNTPNDG                  
* HWON  15NOV07 055 ADJUST VALUES FOR NON-RATING/EXTENDED DEMOS CATS            
* HWON  15OCT07 054 CHANGE ZENITH HEADLINES                                     
* HWON  09OCT07 053 FIX REVISION SENDING BAD BUYLINE # AND CHANGED THE          
*                   BUYDTL DARE HEADER RECORD TO SEND 1-WEEK/0 SPOTS            
*                   FOR ZERO'D OUT BUYLINES                                     
* HWON  08OCT07 052 FIX PRODUCT2 NAME INCORRECTLY DISPLAYED IN AGYDS3           
* HWON  27AUG07 048 FIX FAX DUMP WHEN SENDING OOW ROTATORS                      
* HWON  24JUL07 047 FIX FAX BUG WHERE TOTAL DOLLARS WERE OFF IF THERE           
*                   WERE COST OVERRIDES                                         
* HWON  11JUL07 046 FIX BUG THAT DIDN'T ALLOW TEST STATION TO SEND EDI          
* HWON  10JUL07 045 ONLY ALLOW TEST IDS TO SEND TO TEST STATIONS                
* HWON  06JUN07 044 NEED TO CLEAR FOR THE CORRECT LENGTH                        
* HWON  25MAY07 043 CHANGED THE TSAR BUFFER TO BE A VARIABLE LENGTH, TO         
*                   FIX PROBLEM WHERE TSAR BUFFER WAS GETTING FULL              
* WHOA  24MAY07 042 FIX DUMPS WHEN ORDERING PIGGYBACK WHILST USING TPOL         
* HWON  23MAY07 041 WHEN FAXING, CHECK FLAG FOR COST IN DOLLARS                 
* WHOA  16MAY07 040 DIE WHEN TSAR BUFFER IS FULL                                
*                   REMOVED A TESTING QUEUE FOR REDI                            
* HWON  27APR07 039 REMOVE TRAP CODE FROM 038 AND 037                           
* HWON  18APR07 038 FIX TRAP - SAVING BAD MAKEGOOD ADJACENCY CODE               
* EJOR  28MAR07 037 TRAP - SAVING BAD MAKEGOOD ADJACENCY CODE                   
* EJOR  28MAR07 036 FIX ZENITH HEADER CODE                                      
* HWON  23MAR07 034 DONT' SET FIRST SEND STATION UNTIL SENT                     
* HWON  08MAR07 033 FIX CALL TO SPAUTH TO USE LARGER IOAREA                     
* HWON  08MAR07 032 FIX BUG WITH SENDING 3 LETTER STATIONS                      
* WHOA  07MAR07 031 SUPPORT NEW IOAREA LENGTHS                                  
* HWON  05MAR07 030 ADD EDI SUPPORT FOR CALL LETTER SWITCHES                    
*                   FIX A BUG WHERE ADJ. CODES WERE SAVED INCORRECTLY           
* HWON  09JAN07 029 SUPPORT 20 LINE OCOMS, INCREASE SPOMCOM BUFFER              
* HWON  02JAN07 028 UPDATE TO '024', CHECK IF ADJ-CODE IS SAVED ALREADY         
*                   SAVE VARIABLE LENGTH PURPOSE CODES                          
*                   DON'T INC. THE SEND VERSION# WHEN QSNTPNDG                  
*                   SET THE MINIMUM SENT DEMOS TO 0                             
*                   SEND ERROR WHEN SENDING FROM A NON DARE PARTNER             
*                   NEW ZENITH HEADLINES IN THE DX                              
* HWON  09AUG06 026 MEDIA OCEAN ICON SUPPORT                                    
* HWON  11SEP06 025 LOCK THE BLOCK WHEN FETCHING THE NEXT ORDER NUMBER          
*                   BY READING FOR UPDATE.                                      
* HWON  24AUG06 024 SEND ERROR WHEN MISSING MAKEGOOD ADJACENCY CODE             
*                   ALSO, DELETE THE WSSVR BUFFER                               
* HWON  17AUG06 023 FIX, INITIALIZE HEADLINES ON EVERY PAGE FOR DFX             
* HWON  04AUG06 022 FIX, CANCEL ORDER ONLY EXISTS FOR RADIO                     
* HWON  21JUN06 021 FIX 020, DON'T EXIT IF NO BUYLINES FOUND.                   
* HWON  31MAY06 020 EXIT WITH AN ERROR IF NO COST2 FOR TRADE CLIENT             
*                   FIX: WORKING STORAGE ADJUSTED TO SUPT CANAD. DESK           
*                     - THIS WAS ACCIDENTALLY REMOVED.                          
* HWON  28APR06 019 BETA 2.4 RELEASE                                            
*                   - MAKEGOOD ORBITS SUPPORT                                   
*                   - MG COMMENTS ARE NOW SAVED CORRECTLY                       
*                   - REDI XML SUPPORT                                          
*                     - NEW SALESPERSON VALIDATION                              
*                     - NO LONGER USING THE PQ-INVIS TO SEND XML ORDERS         
*                   - CANCEL AN ORDER IF NO SPOTS ARE SENT                      
*                   - DISPLAY THE ESTIMATE START DATE IF NO FIRST AIR-          
*                      DATE                                                     
* HWON  17MAY06 018 FIX: INITIALIZE THE TSAR RECORD AREA                        
* HWON  24APR06 017 FIX: WORKING STORAGE ADJUSTED TO SUPT CANAD. DESK           
* HWON  27JAN06 016 FIX: FAXING COST OVERRIDES                                  
* HWON  25JAN06 015 FIX: FIXED FAXING OF NON-OOW ORDER WITH NON MONDAY          
*                        START DATE, TO STILL FAX AS NON-OOW SCHEDULE           
* HWON  11JAN06 014 FIX: ORDERS GOING OUT WITH 0 DOLLARS AND SPOTS              
* HWON  02JAN06 013 FIX: CLEAR BAD CONTRACT WHEN SENDING NEW ORDER              
*                      : ALLOW FAXING OF UNDARE ORDERS                          
*                      : FIX FAXING TO NOT SEND ALL BANDS IF NOT CABLE          
*                   FTR: NEW CANCEL STATUS                                      
* WHOA  26DEC05 012 FIX: INCL. SPOTS THAT FALL ON LAST EST DAY WHEN FAX         
* HWON  21NOV05 011 FIX: ADD THE DARE BUYLINE ELEMENTS                          
*                   FIX: FIX LOOPING PROBLEM WHEN SAVING TAX ELEMENT            
* HWON  21NOV05 010 FIX: SAVING 2-DECIMAL MAKEGOODS DEMOS                       
* HWON  11NOV05 009 FIX: ACCEPT MAP CODE ONLY FIELDS                            
*                   FIX DFX BUGS: DEMOS, TELECAST, COMMENTS, PAGING             
* HWON  02NOV05 007 CLEAR REPBLK BEFORE EVERY SEND                              
* HWON  02NOV05 006 PIGGYBACK NAME NOT DISPLAYING CORRECTLY ON AGYDS3           
* HWON  02AUG05 005 BETA 2 DEVELOPMENT                                          
* HWON  18OCT05 004 FIX: ADDING COMMENTS TO MULT-ORDERS SINGLE UPLOAD           
* HWON  27SEP05 003 FIX: SEND IT LATER WHEN ITS SEND PENDING                    
* HWON  29JUL05 001 INITIAL DEVELOPMENT 1.0                                     
*                                                                               
*=====================================================================*         
*                                                                               
SPLNK16  TITLE 'SPOT/LINK DESKTOP ORDER MANAGER UPLOAD'                         
         PRINT NOGEN                                                            
SVRDEF   CSECT                                                                  
         LKSVR TYPE=U,CODE=ENTRY,RLEN=500,REQUEST=*,WORKERKEY=SPOM,    +        
               LINKIO=Y,BLOCKS=(B#WORKD,WORKD,B#SAVED,SAVED),          +        
               BLOCKS2=(B#ESTREC,ESTHDR),                              +        
               SYSTEM=SPTSYSQ                                                   
*                                                                               
***********************************************************************         
* KEY - OM ORDER AND MAKEGOOD                                                   
***********************************************************************         
*                                                                               
OMHDR    LKREQ H,I#SDOMHD,0,NEWREC=Y         0181                               
MEDIA    LKREQ F,1,(I,B#SAVED,I$BAGM),CHAR,                            *        
               MAXLEN=1,OLEN=1,TEXT=SP#MED,COL=*                                
ORDNUM   LKREQ F,2,(I,B#SAVED,I$BINORD),VSTR,                          *        
               MAXLEN=8,OLEN=8,TEXT=SP#ORDN,COL=*                               
GRPCODE  LKREQ F,4,(I,B#SAVED,I$GRPCD),CHAR,                           *        
               OLEN=3,TEXT=SP#GROUP,COL=*                                       
CLIENT   LKREQ F,5,(I,B#SAVED,I$BCLT),VSTR,                            *        
               MAXLEN=L'QCLTA,OLEN=L'QCLTA,TEXT=SP#CLI,COL=*                    
PRODUCT  LKREQ F,6,(I,B#SAVED,I$BPRD),VSTR,                            *        
               MAXLEN=L'PKEYPRD,OLEN=L'PKEYPRD,TEXT=SP#PRO,COL=*                
PRODUCT2 LKREQ F,7,(I,B#SAVED,I$BPRD2),VSTR,                           *        
               MAXLEN=L'PKEYPRD,OLEN=L'PKEYPRD,TEXT=SP#PIGGY,COL=*              
ESTIMATE LKREQ F,8,(I,B#SAVED,I$BEST),UBIN,                            *        
               OLEN=1,MAXLEN=3,TEXT=SP#EST,COL=*                                
FLIGHT   LKREQ F,9,(I,B#SAVED,I$BFLT),UBIN,                            *        
               OLEN=1,MAXLEN=3,TEXT=SP#FLGHT,COL=*                              
STTN/NET LKREQ F,10,(I,B#SAVED,I$STN),VSTR,                            *        
               MAXLEN=8,OLEN=8,TEXT=SP#STNET,COL=*                              
CASHTRD  LKREQ F,11,(I,B#SAVED,I$FLAG),VSTR,                           *        
               MAXLEN=1,OLEN=1,TEXT=SP#XMIT,COL=*                               
PCKEY    LKREQ F,12,(I,B#SAVED,I$PCKEY),VSTR,                          *        
               OLEN=0,TEXT=SP#KEY,COL=*                                         
ORDSUM1  LKREQ F,20,(D,B#SAVED,ORDCKS),HEXD,                           *        
               OLEN=#$CKSUM,TEXT=SP#CKSUM,COL=*                                 
OR2SUM1  LKREQ F,21,(D,B#SAVED,OR2CKS),HEXD,                           *        
               OLEN=#$CKSUM,TEXT=SP#CKSUM,COL=*                                 
NOTSUM1  LKREQ F,22,(D,B#SAVED,NOTCKS),HEXD,                           *        
               OLEN=#$CKSUM,TEXT=SP#CKSUM,COL=*                                 
OFFSUM1  LKREQ F,23,(D,B#SAVED,OFFCKS),HEXD,                           *        
               OLEN=#$CKSUM,TEXT=SP#CKSUM,COL=*                                 
OF2SUM1  LKREQ F,24,(D,B#SAVED,OF2CKS),HEXD,                           *        
               OLEN=#$CKSUM,TEXT=SP#CKSUM,COL=*                                 
DLDRESP  LKREQ F,25,(D,B#SAVED,DWNLDRSP),CHAR,                         *        
               OLEN=L'DWNLDRSP,TEXT=(*,TDNLDRSP),COL=*                          
         LKREQ E                                                                
         EJECT                                                                  
*                                                                               
***********************************************************************         
* ORDER MANAGER ORDER MAINTENANCE                                               
***********************************************************************         
*                                                                               
ORDMNT   LKREQ H,I#SDOSAV,0,NEWREC=Y         0182                               
BUYER    LKREQ F,1,(I,B#SAVED,I$BYR),VSTR,                             *        
               MAXLEN=3,OLEN=3,TEXT=SP#SBYR,COL=*                               
SALESP   LKREQ F,2,(I,B#SAVED,I$SALESP),VSTR,                          *        
               MAXLEN=26,OLEN=26,TEXT=SP#SALE,COL=*                             
POINTP   LKREQ F,3,(I,B#SAVED,I$PPFLAG),VSTR,                          *        
               MAXLEN=1,OLEN=1,TEXT=SP#POINT,COL=*                              
STNDCOM1 LKREQ F,4,(I,B#SAVED,I$STDCM1),VSTR,                          *        
               MAXLEN=8,OLEN=8,TEXT=SP#STD1,COL=*                               
STNDCOM2 LKREQ F,5,(I,B#SAVED,I$STDCM2),VSTR,                          *        
               MAXLEN=8,OLEN=8,TEXT=SP#STD2,COL=*                               
STNDCOM3 LKREQ F,6,(I,B#SAVED,I$STDCM3),VSTR,                          *        
               MAXLEN=8,OLEN=8,TEXT=SP#STD3,COL=*                               
DEST     LKREQ F,7,(I,B#SAVED,I$DEST),VSTR,                            *        
               MAXLEN=1,OLEN=1,TEXT=SP#DEST,COL=*                               
ROUTE    LKREQ F,8,(I,B#SAVED,I$METH),VSTR,                            *        
               MAXLEN=1,OLEN=1,TEXT=SP#METH,COL=*                               
FAX#     LKREQ F,9,(I,B#SAVED,I$FAX#),VSTR,                            *        
               MAXLEN=16,OLEN=16,TEXT=SP#FAX#,COL=*                             
SALESC   LKREQ F,16,(I,B#SAVED,I$SALESC),UBIN,                         *        
               OLEN=L'DOIDSALC,MAXLEN=8,TEXT=SP#SALC,COL=*                      
REPALPH  LKREQ F,17,(I,B#SAVED,I$REPALP),VSTR,                         *        
               OLEN=L'DOIDREPA,TEXT=SP#REPA,COL=*                               
*                                                                               
EMAILS   LKREQ F,18,(I,B#SAVED,I$EMAILS),CHAR,ARRAY=S,SORT=NO,         *        
               OLEN=L'EMLFLG,TEXT=(*,TEMFLAG),COL=*                             
EMFLAG   LKREQ F,19,,CHAR,OLEN=L'EMLADD,TEXT=(*,TEMAILS),ARRAY=E                
*                                                                               
INCDEM   LKREQ F,15,(I,B#SAVED,I$INCDM),VSTR,                          *        
               MAXLEN=1,OLEN=1,TEXT=SP#INDM,COL=*                               
INCODEM  LKREQ F,10,(I,B#SAVED,I$ORDDEM),CHAR,LIST=F,SORT=NO,          +        
               TEXT=SP#DEMO,OLEN=L'ENTRDDMO,COL=*                               
*                                                                               
HIDORD   LKREQ F,11,(I,B#SAVED,I$HIDORD),VSTR,                         *        
               MAXLEN=1,OLEN=1,TEXT=SP#HDFLG,COL=*                              
PREVNEW  LKREQ F,12,(I,B#SAVED,I$PRVNEW),VSTR,                         *        
               MAXLEN=1,OLEN=1,TEXT=SP#PRN,COL=*                                
REPPRFX  LKREQ F,13,(I,B#SAVED,I$REPPFX),VSTR,                         *        
               MAXLEN=8,OLEN=8,TEXT=SP#RUSRP,COL=*                              
REPOFFCE LKREQ F,14,(I,B#SAVED,I$REPOFF),VSTR,                         *        
               MAXLEN=2,OLEN=2,TEXT=SP#REPOF,COL=*                              
ORDCOM1  LKREQ F,20,(I,B#SAVED,I$COM1),VSTR,                           *        
               MAXLEN=78,OLEN=78,TEXT=SP#COM1,COL=*                             
ORDCOM2  LKREQ F,21,(I,B#SAVED,I$COM2),VSTR,                           *        
               MAXLEN=78,OLEN=78,TEXT=SP#COM2,COL=*                             
ORDCOM3  LKREQ F,22,(I,B#SAVED,I$COM3),VSTR,                           *        
               MAXLEN=78,OLEN=78,TEXT=SP#COM3,COL=*                             
ORDCOM4  LKREQ F,23,(I,B#SAVED,I$COM4),VSTR,                           *        
               MAXLEN=78,OLEN=78,TEXT=SP#COM4,COL=*                             
ORDCOM5  LKREQ F,24,(I,B#SAVED,I$COM5),VSTR,                           *        
               MAXLEN=78,OLEN=78,TEXT=SP#COM5,COL=*                             
ORDCOM6  LKREQ F,25,(I,B#SAVED,I$COM6),VSTR,                           *        
               MAXLEN=78,OLEN=78,TEXT=SP#COM6,COL=*                             
ORDCOM7  LKREQ F,26,(I,B#SAVED,I$COM7),VSTR,                           *        
               MAXLEN=78,OLEN=78,TEXT=SP#COM7,COL=*                             
ORDCOM8  LKREQ F,27,(I,B#SAVED,I$COM8),VSTR,                           *        
               MAXLEN=78,OLEN=78,TEXT=SP#COM8,COL=*                             
XMIT     LKREQ F,28,(I,B#SAVED,I$XMIT),VSTR,                           *        
               MAXLEN=1,OLEN=1,TEXT=SP#TMIT,COL=*                               
RESEND   LKREQ F,29,(I,B#SAVED,I$RESEND),VSTR,                         *        
               MAXLEN=1,OLEN=1,TEXT=SP#RESND,COL=*                              
         LKREQ E                                                                
         EJECT                                                                  
***********************************************************************         
* ORDER MANAGER BUYER CONFIRM                                                   
***********************************************************************         
*                                                                               
LNKBCNF  LKREQ H,I#SDBCNF,0,NEWREC=Y         0176                               
ORDCOM1  LKREQ F,20,(I,B#SAVED,I$COM1),VSTR,                           *        
               MAXLEN=78,OLEN=78,TEXT=SP#COM1,COL=*                             
ORDCOM2  LKREQ F,21,(I,B#SAVED,I$COM2),VSTR,                           *        
               MAXLEN=78,OLEN=78,TEXT=SP#COM2,COL=*                             
         LKREQ E                                                                
         EJECT                                                                  
***********************************************************************         
* ORDER MANAGER EXPORT SEND/CANCEL                                              
***********************************************************************         
ORDSTAT  LKREQ H,I#SDOEXS,0,NEWREC=Y         018B                               
STATUS   LKREQ F,1,(D,B#SAVED,STATTYPE),CHAR,TEXT=SP#STATS,COL=*                
STATFLG  LKREQ F,2,(D,B#SAVED,STATFLAG),CHAR,TEXT=SP#SQUAL,COL=*                
STTDATE  LKREQ F,3,(D,B#SAVED,STATDATE),JDAT,TEXT=SP#DATE,COL=*                 
STTTIME  LKREQ F,4,(D,B#SAVED,STATTIME),HEXD,TEXT=SP#TIME,COL=*                 
TOTSPTS  LKREQ F,5,(D,B#SAVED,AGYNSPTS),UBIN,                          *        
               OLEN=L'DOSTSPTS,TEXT=(*,TTOTSPT),COL=*                           
TOTDOLS  LKREQ F,6,(D,B#SAVED,AGYDOLRS),SPAK,                          *        
               OLEN=L'DOSTTOTL,TEXT=(*,TTOTDOL),COL=*                           
GAPTKN   LKREQ F,7,(I,B#SAVED,I$GAPTKN),VSTR,                          *        
               OLEN=0,TEXT=(*,TGAPTKN),COL=*                                    
GAPSEQ#  LKREQ F,8,(D,B#SAVED,GAPSEQ#),UBIN,TEXT=(*,TGAPSEQ),COL=*              
BUYDA    LKREQ F,11,(I,B#SAVED,I$BUYDA),HEXD,ARRAY=S,SORT=NO,          *        
               OLEN=L'BUYKDA,TEXT=SP#SDBDA,COL=*                                
BUYCKSM  LKREQ F,12,,HEXD,OLEN=#$CKSUM,TEXT=SP#CKSUM,COL=*,ARRAY=E              
         LKREQ E                                                                
         EJECT                                                                  
***********************************************************************         
* ORDER MANAGER MAKEGOOD MAINTENANCE                                            
***********************************************************************         
*                                                                               
LNKOFCH  LKREQ H,I#SDMGCH,0,NEWREC=Y         0180                               
OFFERNUM LKREQ F,1,(I,B#SAVED,I$OFFNUM),UBIN,                          *        
               OLEN=1,MAXLEN=3,TEXT=SP#OFNUM,COL=*                              
RECRDNUM LKREQ F,2,(I,B#SAVED,I$RECNUM),UBIN,                          *        
               OLEN=1,MAXLEN=3,TEXT=SP#RCNUM,COL=*                              
DAYPART  LKREQ F,3,(I,B#SAVED,I$DAYPRT),VSTR,                          *        
               OLEN=1,TEXT=SP#DAYPT,COL=*                                       
PRGNAME  LKREQ F,4,(I,B#SAVED,I$PRGNAM),VSTR,                          *        
               MAXLEN=17,OLEN=17,TEXT=SP#PROG,COL=*                             
ADJCODE  LKREQ F,5,(I,B#SAVED,I$ADJCOD),VSTR,                          *        
               OLEN=2,TEXT=SP#ADJCY,COL=*                                       
PURCODE  LKREQ F,6,(I,B#SAVED,I$PURPCD),VSTR,                          *        
               MAXLEN=6,OLEN=6,TEXT=SP#PURP,COL=*                               
RESCODE  LKREQ F,7,(I,B#SAVED,I$REASCD),VSTR,                          *        
               MAXLEN=6,OLEN=6,TEXT=SP#REASN,COL=*                              
UPGFORM  LKREQ F,8,(I,B#SAVED,I$UPGFRM),VSTR,                          *        
               MAXLEN=28,OLEN=28,TEXT=SP#UPGR,COL=*                             
COST2    LKREQ F,9,(I,B#SAVED,I$COST2),CBIN,                           *        
               OLEN=3,MAXLEN=8,TEXT=SP#COS2,COL=*                               
REPCODE  LKREQ F,10,(I,B#SAVED,I$REPCOD),VSTR,                         *        
               MAXLEN=3,OLEN=3,TEXT=SP#REPR,COL=*                               
HIDOFF   LKREQ F,11,(I,B#SAVED,I$HIDOFF),VSTR,                         *        
               MAXLEN=1,OLEN=1,TEXT=SP#HDFLG,COL=*                              
BOOK     LKREQ F,12,(I,B#SAVED,I$MGBOOK),VSTR,                         *        
               MAXLEN=5,OLEN=5,TEXT=SP#BOOK,COL=*                               
BOOKTYPE LKREQ F,13,(I,B#SAVED,I$MGBKTY),VSTR,                         *        
               MAXLEN=2,OLEN=2,TEXT=SP#BKTY,COL=*                               
*                                                                               
DEMODEF  LKREQ F,15,(I,B#SAVED,I$OFFDEM),CHAR,SORT=NO,OLEN=L'ENONTDMS, *        
               TEXT=SP#DEMD,COL=*,ARRAY=S                                       
DEMO     LKREQ F,16,,UBIN,OLEN=L'DEMVALUE,TEXT=SP#DEMO,COL=*                    
DEMOV    LKREQ F,17,,CHAR,OLEN=L'DEMOVRD,TEXT=SP#DEMOV,COL=*                    
DEMNTLKU LKREQ F,19,,CHAR,OLEN=1,TEXT=(*,TNTLKUP),COL=*                         
DEMNTNA  LKREQ F,27,,CHAR,OLEN=1,TEXT=(*,TNTSLKNA),COL=*,ARRAY=E                
*                                                                               
DEMODFT  LKREQ F,18,(I,B#SAVED,I$DEMDFT),VSTR,                         *        
               MAXLEN=1,OLEN=1,TEXT=SP#DMDEF,COL=*                              
*                                                                               
ORBPGM   LKREQ F,25,(I,B#SAVED,I$ORBITS),CHAR,SORT=NO,                 *        
               OLEN=L'MORNPROG,TEXT=SP#ORBPG,COL=*,ARRAY=S                      
ORBDEMO  LKREQ F,26,,UBIN,OLEN=L'MORNDEM,TEXT=SP#ORBDM,COL=*,ARRAY=E            
*                                                                               
OFFCOM1  LKREQ F,20,(I,B#SAVED,I$COM1),VSTR,                           *        
               MAXLEN=79,OLEN=79,TEXT=SP#COM1,COL=*                             
OFFCOM2  LKREQ F,21,(I,B#SAVED,I$COM2),VSTR,                           *        
               MAXLEN=79,OLEN=79,TEXT=SP#COM2,COL=*                             
OFFCOM3  LKREQ F,22,(I,B#SAVED,I$COM3),VSTR,                           *        
               MAXLEN=79,OLEN=79,TEXT=SP#COM3,COL=*                             
OFFCOM4  LKREQ F,23,(I,B#SAVED,I$COM4),VSTR,                           *        
               MAXLEN=79,OLEN=79,TEXT=SP#COM4,COL=*                             
OFFCOM5  LKREQ F,24,(I,B#SAVED,I$COM5),VSTR,                           *        
               MAXLEN=79,OLEN=79,TEXT=SP#COM5,COL=*                             
         LKREQ E                                                                
         EJECT                                                                  
***********************************************************************         
* DESKTOP OM PERSONAL DIRECTORY VALIDATION                            *         
***********************************************************************         
                                                                                
REQVPD   LKREQ H,I#SDPERD,NEWREC=Y           0086                               
                                                                                
MEDIA    LKREQ F,1,(D,B#SAVED,SVMED),CHAR,TEXT=SP#MED,COL=*                     
DEST     LKREQ F,2,(D,B#SAVED,SVDEST),CHAR,TEXT=SP#DEST,COL=*                   
ROUTE    LKREQ F,3,(D,B#SAVED,SVMTHD),CHAR,TEXT=SP#METH,COL=*                   
REPPRFX  LKREQ F,4,(D,B#SAVED,REPPREFX),CHAR,TEXT=SP#RUSRP,COL=*                
REPOFFCE LKREQ F,5,(D,B#SAVED,REPOFFCD),CHAR,TEXT=SP#REPOF,COL=*                
FAX#     LKREQ F,6,(I,B#SAVED,I$FAX#),VSTR,                            *        
               OLEN=16,TEXT=SP#FAX#,COL=*                                       
STTN/NET LKREQ F,7,(I,B#SAVED,I$STN),CHAR,LIST=F,SORT=NO,              *        
               OLEN=8,TEXT=SP#STNET,COL=*                                       
SALESC   LKREQ F,8,(I,B#SAVED,I$SALESC),UBIN,                          *        
               OLEN=L'DOIDSALC,TEXT=SP#SALC,COL=*                               
POINTP   LKREQ F,9,(I,B#SAVED,I$PPFLAG),CHAR,                          *        
               OLEN=1,TEXT=SP#POINT,COL=*                                       
CLIENT   LKREQ F,10,(D,B#SAVED,SVQCLT),CHAR,TEXT=SP#CLI,COL=*                   
PCKEY    LKREQ F,11,(I,B#SAVED,I$PCKEY),VSTR,OLEN=0,TEXT=SP#KEY,COL=*           
         LKREQ E                                                                
         EJECT                                                                  
***********************************************************************         
* DESKTOP METADATA DOWNLOAD                                                     
***********************************************************************         
                                                                                
REQMTA   LKREQ H,I#SDMETA,NEWREC=Y,ROUTINE=SDMETADL   X'0155'                   
MEDIA    LKREQ F,1,(D,B#SAVED,SVBAGM),(U,#VALMED,$VALMED),             +        
               OLEN=L'SVBAGM,MAXLEN=L'QMEDA,TEXT=SP#MED,COL=*                   
CLTCD    LKREQ F,2,(D,B#SAVED,SVBCLT),(U,#VALCLT,$VALCLT),             +        
               OLEN=L'SVBCLT,MAXLEN=L'QCLTA,TEXT=SP#CLI,COL=*                   
PRDCD    LKREQ F,3,(D,B#SAVED,SVBPRD),(U,#VALPRD,$VALPRD),             +        
               OLEN=L'SVBPRD,MAXLEN=L'QPRDA,TEXT=SP#PRO,COL=*                   
ESTNO    LKREQ F,4,(D,B#SAVED,SVBEST),LBIN,                            +        
               OLEN=L'SVBEST,MAXLEN=3,TEXT=SP#EST,COL=*                         
MKTNO    LKREQ F,5,(I,B#SAVED,I$MKTS),LBIN,                            +        
               OLEN=L'SVBMKT,MAXLEN=4,LIST=F,TEXT=SP#MKT,COL=*                  
DEMOC    LKREQ F,10,(D,B#SAVED,DLDDMOS),HDRO,TEXT=SP#DEMO,COL=*                 
ORDST    LKREQ F,11,(D,B#SAVED,DLDORST),HDRO,TEXT=SP#STATS,COL=*                
         LKREQ E                                                                
*                                                                               
         LKREQ X                                                                
*                                                                               
TDNLDRSP DC    C'Download Order Response?'                                      
TEMAILS  DC    C'Email Address'                                                 
TEMFLAG  DC    C'Email Flag'                                                    
TGAPTKN  DC    C'GAP Token'                                                     
TGAPSEQ  DC    C'GAP Sequence #'                                                
TTOTSPT  DC    C'Total Spots'                                                   
TTOTDOL  DC    C'Total Dollars'                                                 
TNTLKUP  DC    C'NT-Demo doesnt Req. Lkup?'                                     
TNTSLKNA DC    C'NT-Demo lookup is N/A?'                                        
         EJECT                                                                  
*                                                                               
SE#MAXOR EQU   0276                                                             
*                                                                               
         EJECT                                                                  
         DS    0D                                                               
ENTRY    NMOD1 0,**SL16**,RR=RE,CLEAR=Y                                         
         LR    R6,R1                                                            
         USING LP_D,R6             R6=A(LP_D)                                   
         L     R9,LP_ABLK1                                                      
         USING WORKD,R9            R9=A(GLOBAL W/S)                             
         L     RF,LP_ARUNP                                                      
         MVC   BYTE1,RUNPMODE-RUNPARMD(RF)                                      
         L     R8,LP_ABLK2                                                      
         USING SAVED,R8            R8=A(SAVE W/S)                               
         LHI   R7,MYWORK-SAVED                                                  
         LA    R7,SAVED(R7)                                                     
         USING MYWORKD,R7          R7=A(FAREPORT WORK AREA)                     
*                                                                               
         LARL  RA,GLOBALS                                                       
         USING GLOBALS,RA          RA=A(GLOBAL LITERALS)                        
*                                                                               
         ST    RE,SRVRRELO         SAVE PROGRAM RELOCATION FACTOR               
         STM   R2,RB,LP_R2RB       SAVE REGISTERS FOR SUB-ROUTINES              
*                                                                               
         CLI   BYTE1,RRUNSTRQ      TEST 'FIRST' MODE                            
         JE    FIRST                                                            
         CLI   BYTE1,RINIREQQ      TEST 'INITIALIZE' MODE                       
         JE    INIT                                                             
         CLI   BYTE1,RRUNREQQ      TEST 'RUN REQUEST' MODE                      
         JE    INPUT                                                            
         CLI   BYTE1,RRUNENDQ      TEST 'LAST TIME' MODE                        
         BNE   EXITY                                                            
*                                                                               
         MVC   PREVFLAG,CURRFLAG   SAVE CURR FLAG TO PREVIOUS                   
         BRAS  RE,PUTMYREC         PROCESS ANY OUTSTANDING IOS                  
*                                                                               
         BRAS  RE,XMITDARE         SEND OUTSTANDING DARE TRANSMISSIONS          
*                                                                               
         XC    PREVKEY,PREVKEY                                                  
*                                                                               
         B     EXITY                                                            
                                                                                
*AGLOBALS DC    A(GLOBALS)                                                      
         EJECT                                                                  
*                                                                               
         USING TSARD,TSARBLK                                                    
         USING STAPACKD,WORK                                                    
         USING ORDXMTD,TSARREC                                                  
         USING BUYHISD,TSARREC                                                  
***********************************************************************         
* RUN FIRST                                                                     
***********************************************************************         
*                                                                               
FIRST    DS    0H                                                               
*                                                                               
         LA    R0,SAVED            CLEAR SAVE STORAGE                           
         LHI   R1,SAVEL                                                         
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(15,JDTTODAY)   GET CURRENT DATE              
         GOTO1 VDATCON,DMCB,(5,0),(0,TDYDTCHR) TODAYS DATE IN CHAR              
*                                                                               
         GOTOR BUFFER,DMCB,('TSAINI',8),('ORDXKEYL',ORDXRECL),0                 
         JNE   *+2                                                              
*                                                                               
         MVC   LP_BLKS+((B#CLTREC-1)*L'LP_BLKS)(AIOLAST-AIO2),AIO2              
*                                                                               
         B     EXITY                                                            
*                                                                               
***********************************************************************         
* INIT - NOTE FIRST REC PROCESSED *BEFORE* INIT CALL!                           
***********************************************************************         
*                                                                               
INIT     DS    0H                                                               
         MVI   DATADISP+1,24                                                    
*                                                                               
         MVC   WVALUES(WVALUESL),LVALUES                                        
         LA    R1,ADCONS           RELOCATE ADDRESS CONSTANTS                   
         LHI   R0,ADCONSN                                                       
         BASR  RE,0                                                             
         L     R2,0(R1)                                                         
         A     R2,SRVRRELO                                                      
         ST    R2,0(R1)                                                         
         AHI   R1,L'ADCONS                                                      
         BCTR  R0,RE                                                            
*                                                                               
         L     R6,ALP                                                           
         MVC   ALIOB,LP_ALIOB      EXTRACT A(LIOB) FROM LP_D                    
         L     RF,ALIOB                                                         
         USING LIOBD,RF                                                         
         OI    LIOBINDS,LIOBINRM   INHIBIT AUTO RETURN MAP ELEMENT              
*                                                                               
         L     RF,LP_ACOM          EXTRACT A(LINKIO) FROM COMFACS               
         DROP  RF                                                               
*                                                                               
         MVC   ALINKIO,CLINKIO-COMFACSD(RF)                                     
*                                  EXTRACT A(RECUP) FROM COMFACS                
         MVC   ARECUP,CRECUP-COMFACSD(RF)                                       
*                                                                               
         L     RF,CSWITCH-COMFACSD(RF)                                          
         LA    R1,DMCB                                                          
         MVC   DMCB,=X'00FFFFFF'   SYS=0 GETS TCB ADDRESS                       
         BASR  RE,RF                                                            
         L     RE,0(R1)                                                         
         USING TCBD,RE                                                          
         MVC   AMINBUFF,TCBMINIO                                                
         DROP  RE                                                               
*                                                                               
         L     RF,ATWA                                                          
         USING TWAD,RF                                                          
         MVC   SVBORGID,TWAUSRID   SAVE THE BINARY SIGNON/ORIGIN ID             
         DROP  RF                                                               
*                                                                               
         XC    GETBLK,GETBLK                                                    
         MVI   GBYACT,GBYINIT                                                   
         MVC   GBYAGY,LP_AGY                                                    
         MVC   GBYCOMF,ACOMFACS                                                 
         GOTOR VGETBUY,GETBLK                                                   
         MVI   GBYACT,0                                                         
         MVC   SAVE1OR2,GBY1OR2                                                 
*                                                                               
         B     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* PROCESS AN UPLOAD RECORD                                                      
***********************************************************************         
*                                                                               
INPUT    L     RF,ATWA                                                          
         USING TWAD,RF                                                          
         CLC   TWAUSRID,=X'3AC7'     DON'T ALLOW OOMGXOS TO UPDATE              
         JNE   INPUT05                                                          
         GOTOR PUTERR,DMCB,('SE#SY002',SE#NOUPD)                                
         B     EXITY                                                            
         DROP  RF                                                               
*                                                                               
INPUT05  LA    RE,RECTAB                                                        
         USING RECTABD,RE                                                       
         LHI   R0,RECTABN                                                       
*                                                                               
INPUT10  CLC   RECTMAP#,LP_QMAPN   LOOK UP RECORD MAP CODE IN TABLE             
         JE    INPUT20                                                          
         AHI   RE,RECTABL                                                       
         JCT   R0,INPUT10                                                       
         DC    H'0'                                                             
*                                                                               
INPUT20  CLI   RECTFLAG,X'FF'        RESET ALL CURRENT ERRORS                   
         JNE   INPUT30                                                          
         MVC   PREVFLAG,CURRFLAG      SAVE CURR FLAG TO PREV                    
         MVI   CURRFLAG,0             AND RESET CURRENT                         
*                                                                               
INPUT30  CLI   CURRFLAG,0            ANY ERROR IN CURRENT?                      
         BNE   EXITY                  YES, SKIP REQUEST                         
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,7,RECTPROG                                                    
         A     R0,SRVRRELO                                                      
         ST    R0,RECADDR                                                       
*                                                                               
         GOTOR RECADDR                                                          
         B     EXITY               EXIT BACK TO DDLINK                          
         DROP  RB                                                               
*                                                                               
RECTABD  DSECT                     ** DSECT TO COVER RECORD TABLE **            
RECTMAP# DS    AL2                 RECORD MAP NUMBER                            
RECTPROG DS    AL3                 A(ROUTINE)                                   
RECTFLAG DS    X                                                                
RECTABL  EQU   *-RECTABD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* OUTPUT DEFINITION FOR SUPERDESK REQUEST RESPONSE                              
***********************************************************************         
OUTMTA   LKOUT H                   ** SUPERDESK META DOWNLOAD **                
                                                                                
OUTMT1   LKOUT R,X'0155'                                                        
PRout    LKOUT P,,TSTSM155                                                      
Array    LKOUT C,X'0155',(A,ARYMTA)                                             
         LKOUT E                                                                
                                                                                
OUTMT2   LKOUT R,X'0156'                                                        
Array    LKOUT C,X'0156',(A,ARYSPMK)                                            
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
*********                                                                       
* TEST SAME MEDIA, IF NOT, CLEAR PREVIOUS CLT AND THE MARKET LIST               
*********                                                                       
TSTSM155 DS    0H                                                               
         CLC   LP_QMAPN,PRQMAPN  SO WE KNOW WE'RE STILL PROCESSING              
         BE    EXITY                                                            
         MVC   PRQMAPN,LP_QMAPN                                                 
         XC    PRBAGM(L'PRBAGM+L'PRBCLT),PRBAGM                                 
         B     EXITY                  ALWAYS WANT                               
*                                                                               
***********************************************************************         
* ARRAY DEFINITION FOR THE SUPERDESK REQUEST RESPONSE                           
***********************************************************************         
                                                                                
ARYMTA   LKOUT A,(R,NXTMTA)                                                     
MedCd    LKOUT C,1,(D,B#SAVED,SVBAGM),(U,#EDTMED,$EDTMED),             +        
               FILTROUT=TSTOTMED                                                
                                                                                
CltCd    LKOUT C,2,(D,B#SAVED,SVBCLT),(U,#EDTCLT,$EDTCLT),             +        
               FILTROUT=TSTOTCLT,SKIPCOLS=2                                     
CltNm    LKOUT C,3,(D,B#SAVED,CLTNAME),CHAR                                     
CBPol    LKOUT C,4,(D,B#SAVED,CLTBPOL),HDRO,ND=Y                                
                                                                                
Array    LKOUT C,255,(A,ARYSPPR)                                                
Array    LKOUT C,255,(A,ARYSPES)                                                
                                                                                
         LKOUT E                                                                
*********                                                                       
* CHECK IF THE SAME MEDIA, CLEAR PREVIOUS CLT AND MARKET LIST IF NOT            
*********                                                                       
TSTOTMED DS    0H                                                               
         CLC   PRBAGM,SVBAGM          SAME MEDIA?                               
         JE    RTRNNO                 YES, DON'T OUTPUT MEDIA                   
         MVC   PRBAGM,SVBAGM          NO, IT CAN BE NEXT TIME                   
         XC    PRBCLT,PRBCLT                                                    
         LR    R2,RE                                                            
         L     RE,AIO6                                                          
         LHI   RF,IO6LQ                                                         
         XCEFL                                                                  
         LR    RE,R2                                                            
         J     EXITY                                                            
*                                                                               
*********                                                                       
* TEST SAME CLIENT, CLEAR PRD/EST LIST IF NOT                                   
*********                                                                       
TSTOTCLT DS    0H                                                               
         CLC   PRBCLT,SVBCLT          SAME CLIENT?                              
         JE    RTRNNO                 YES, DON'T OUTPUT CLIENT NAME             
         MVC   PRBCLT,SVBCLT          NO, IT CAN BE NEXT TIME                   
         LR    R2,RE                                                            
         L     RE,AIO5                                                          
         LHI   RF,IO5LQ                                                         
         XCEFL                                                                  
         LR    RE,R2                                                            
         J     RTRNYES                                                          
                                                                                
***********************************************************************         
* GET METADATA RECORDS FOR SUPERDESK REQUEST                          *         
***********************************************************************         
                                                                                
NXTMTA   MVC   LP_ADATA,AIO2     LP_ADATA NEEDS TO BE SET IF NOT DOING          
*                                  A NXTREC                                     
         MVC   QMEDX,SVBAGM                                                     
         GOTOR (#EDTMED,AEDTMED),DMCB,SVBAGM,,MEDIA                             
         JNE   *+2                                                              
*                                                                               
         MVC   AGENCY,LP_AGY                                                    
         MVC   QCLTX,SVBCLT                                                     
*                                                                               
         L     RF,ACLTREC          WE CANNOT ASSUME THIS IS SETUP FOR           
         USING CLTRECD,RF              OUR CLT CODE                             
         CLC   CKEYAM,SVBAGM                                                    
         JNE   NXTMTA10                                                         
         CLC   CKEYCLT,SVBCLT                                                   
         JE    NXTMTA20                                                         
*                                                                               
NXTMTA10 GOTOR (#GETCLT,AGETCLT)                                                
*                                                                               
NXTMTA20 L     RF,ACLTREC                                                       
         MVC   CLTNAME,CNAME       GET CLIENT NAME                              
         MVI   CLTBPOL,0           INIT BPOL FLAG                               
         CLI   CPROF,C'0'                                                       
         JE    *+8                                                              
         MVI   CLTBPOL,YESQ        SET CLIENT IS BRAND/POOL                     
         DROP  RF                                                               
         J     EXITY                                                            
                                                                                
***********************************************************************         
* GET PRODUCT INFO SUPERDESK REQUEST                                            
***********************************************************************         
ARYSPPR  LKOUT A,(R,NXTSPPR),ROWNAME=PRDHDR                                     
PrdCd    LKOUT C,5,(D,B#WORKD,QPRDA),CHAR,FILTROUT=TSTOTPRD,           +        
               SKIPCOLS=1                                                       
PrdNm    LKOUT C,6,PNAME,CHAR                                                   
         LKOUT E                                                                
                                                                                
NXTSPPR  DS    0H                                                               
         MVC   LP_ADATA,AIO3                                                    
         MVC   QPRDX,SVBPRD                                                     
         GOTOR (#EDTPRD,AEDTPRD),DMCB,QPRDX,,QPRDA                              
         JNE   *+2                                                              
*********                                                                       
* SET PRBPRD IF IT IS IN OUR PRD/X'00' LIST  (AIO5)                             
*********                                                                       
         L     R2,AIO5                                                          
         LA    R3,2(R2)             R3 = A(1ST PRD/EST IN LIST)                 
         XR    R1,R1                                                            
         ICM   R1,3,0(R2)           GET # OF ENTRIES IN PRD/EST LIST            
         JZ    NXTSPP50                                                         
NXTSPP20 CLI   1(R3),0              ONLY WANT PRODUCT, DON'T WANT EST           
         JNE   NXTSPP25                                                         
         CLC   0(L'SVBPRD,R3),SVBPRD                                            
         JNE   NXTSPP25                                                         
         MVC   PRBPRD,SVBPRD                                                    
         J     EXITY                                                            
*                                                                               
NXTSPP25 LA    R3,L'SVBPRD+L'SVBEST(R3)                                         
         JCT   R1,NXTSPP20                                                      
*                                                                               
NXTSPP50 LR    RF,R2                DO A BOUNDARY CHECK                         
         AHI   RF,IO5LQ                                                         
         CR    R3,RF                DIE IF WE'RE PAST SPACE ALLOTED             
         JNL   *+2                                                              
*                                                                               
         MVC   0(L'SVBPRD,R3),SVBPRD  JUST  PRD/X'00' ENTRY                     
         MVI   L'SVBPRD(R3),0                                                   
         LLH   R1,0(R2)             UPDATE # OF ENTRIES IN MARKET LIST          
         LA    R1,1(R1)                                                         
         STCM  R1,3,0(R2)                                                       
         XC    PRBPRD,PRBPRD        CLEAR SO WE KNOW TO OUTPUT PRODUCT          
*                                                                               
         LA    R2,IOKEY            READ PRODUCT RECORD                          
         USING PKEY,R2                                                          
         XC    PKEY,PKEY                                                        
         MVC   PKEYAM,QMEDX                                                     
         MVC   PKEYCLT,QCLTX                                                    
         MVC   PKEYPRD,QPRDA                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   NOMORE                                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO3'                              
         JNE   *+2                                                              
         J     EXITY                                                            
                                                                                
TSTOTPRD CLC   PRBPRD,SVBPRD        HAVE WE SEEN THIS PRODUCT BEFORE?           
         J     SETCCC                                                           
                                                                                
***********************************************************************         
* GET ESTIMATE INFO SUPERDESK REQUEST                                           
***********************************************************************         
ARYSPES  LKOUT A,(R,NXTSPES),ROWNAME=ESTHDR                                     
EstNo    LKOUT C,7,(D,B#SAVED,SVBEST),UBIN                                      
EDesc    LKOUT C,8,EDESC,CHAR                                                   
SDate    LKOUT C,9,ESTART,EDAT                                                  
Edate    LKOUT C,10,EEND,EDAT                                                   
OowSd    LKOUT C,20,EOWSDAY,UBIN,ND=Y                                           
Daily    LKOUT C,21,EDAILY,HDRO,ND=Y                                            
Array    LKOUT C,255,(A,ARYEDC),FILTROUT=TSTDMOS                                
         LKOUT E                                                                
                                                                                
NXTSPES  DS    0H                                                               
         MVC   LP_ADATA,AESTREC                                                 
*********                                                                       
* SET PRBEST IF IT IS IN OUR PRD/EST LIST  (AIO5)                               
*********                                                                       
         L     R2,AIO5                                                          
         LA    R3,2(R2)             R3 = A(1ST PRD/EST IN LIST)                 
         XR    R1,R1                                                            
         ICM   R1,3,0(R2)           GET # OF ENTRIES IN PRD/EST LIST            
         JZ    NXTSPE50                                                         
NXTSPE20 CLC   0(L'SVBPRD+L'SVBEST,R3),SVBPRD                                   
         JNE   NXTSPE25                                                         
         MVC   PRBEST,SVBEST                                                    
         J     EXITY                                                            
*                                                                               
NXTSPE25 LA    R3,L'SVBPRD+L'SVBEST(R3)                                         
         JCT   R1,NXTSPE20                                                      
*                                                                               
NXTSPE50 LR    RF,R2                DO A BOUNDARY CHECK                         
         AHI   RF,IO5LQ                                                         
         CR    R3,RF                DIE IF WE'RE PAST SPACE ALLOTED             
         JNL   *+2                                                              
*                                                                               
         MVC   0(L'SVBPRD+L'SVBEST,R3),SVBPRD                                   
         LLH   R1,0(R2)             UPDATE # OF ENTRIES IN MARKET LIST          
         LA    R1,1(R1)                                                         
         STCM  R1,3,0(R2)                                                       
         XC    PRBEST,PRBEST        CLEAR SO WE KNOW TO OUTPUT PRODUCT          
*                                                                               
         LA    R2,IOKEY            READ POL ESTIMATE RECORD                     
         USING EKEY,R2                                                          
         XC    EKEY,EKEY                                                        
         MVC   EKEYAM,QMEDX                                                     
         MVC   EKEYCLT,QCLTX                                                    
         MVC   EKEYPRD,QPRDA                                                    
         MVC   EKEYEST,SVBEST                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOBRD+IODIR+B#ESTREC'                         
         JNE   NOMORE                                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOBGET+IOFIL+B#ESTREC'                        
         JNE   *+2                                                              
*                                                                               
         L     R2,IOADDR                                                        
         USING ESTHDR,R2           R2=A(ESTIMATE RECORD)                        
         CLI   EDAILY,C'Y'                                                      
         JE    *+8                                                              
         MVI   EDAILY,0                                                         
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
TSTOTEST CLC   PRBEST,SVBEST      HAVE WE SEEN THIS estimate BEFORE?            
         J     SETCCC                                                           
                                                                                
TSTDMOS  CLI   DLDDMOS,0          TEST DOWNLOAD DEMOS                           
         J     SETCCC                                                           
                                                                                
TSTORST  CLI   DLDORST,0          TEST DOWNLOAD MARKET ORDER STATUS             
         J     SETCCC                                                           
                                                                                
***********************************************************************         
* ARRAY DEFINITION FOR ESTIMATE DEMO CATEGORIES                                 
***********************************************************************         
                                                                                
ARYEDC   LKOUT A,(D,B#ESTREC,EDEMLST),NROWS=EDEMLSTN,                  +        
               ROWWIDTH=L'EDEMLIST                                              
                                                                                
DEMCD    LKOUT C,11,EDEMLST,(U,#EDTDCD,$EDTDCD),LEN=L'EDEMLIST,ND=Y,   +        
               FILTROUT=TSTUDEMO                                                
UDEMTXT  LKOUT C,11,(D,B#SAVED,ESTUDEMO),CHAR,ND=Y                              
         LKOUT E                                                                
                                                                                
TSTUDEMO L     R1,LP_AINP          TEST USER DEFINED DEMO                       
         USING EDEMLIS1,R1                                                      
         XC    ESTUDEMO,ESTUDEMO   CLEAR THE TEXT                               
         CLI   EDEMLTY1,X'21'      USER DEFINED DEMO?                           
         JNE   EXITY                                                            
         LLC   RF,EDEMLNU1         WHICH ONE, U1, U2, U3 OR U4?                 
         SHI   RF,1                                                             
         MHI   RF,L'EUSRNML                                                     
         L     RE,IOADDR                                                        
         LA    RE,EUSRNMS-ESTHDR(RE)                                            
         AR    RF,RE                                                            
         MVC   ESTUDEMO,0(RF)                                                   
         J     EXITY                      YES, DON'T WANT DUPS                  
         DROP  R1                                                               
         EJECT                                                                  
***********************************************************************         
* GET MARKET INFO SUPERDESK REQUEST                                             
***********************************************************************         
ARYSPMK  LKOUT A,(R,NXTSPMK),NEWEL=B                                            
MktNo    LKOUT C,1,(D,B#SAVED,SVQMKT),CHAR                                      
Array    LKOUT C,255,(A,ARYMKT),FILTROUT=TSTOTMKT                               
Array    LKOUT C,255,(A,ARYSPGL)                                                
ARRAY    LKOUT C,255,(A,ARYORST),FILTROUT=TSTORST                               
         LKOUT E                                                                
*                                                                               
NXTSPMK  MVC   LP_ADATA,AIO3                                                    
*                                                                               
         CLI   LP_RMODE,LP_RFRST                                                
         JE    NXTSPMFM            GO RUN FIRST MODE CODE                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,7,AMKTDA                                                      
         LA    RF,L'STAPMKT(RF)    BUMP TO NEXT STATION                         
         STCM  RF,7,AMKTDA          AND SAVE ADDRESS                            
*                                                                               
NXTSPM10 SR    R1,R1                                                            
         ICM   R1,3,MKTIND                                                      
         JZ    NOMORE                                                           
         BCTR  R1,0                DECREMENT # OF MKTS                          
         STCM  R1,3,MKTIND          AND SAVE FOR NEXT TIME BACK                 
*                                                                               
         MVC   SVBMKT,0(RF)                                                     
         LLH   RE,0(RF)                                                         
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SVQMKT(4),DUB                                                    
*********                                                                       
* SET PRBMKT IF IT IS IN OUR MARKET LIST (AIO6)                                 
*********                                                                       
         L     R2,AIO6                                                          
         LA    R3,2(R2)             R3 = A(1ST MARKET IN LIST)                  
         XR    R1,R1                                                            
         ICM   R1,3,0(R2)           GET # OF ENTRIES IN MARKET LIST             
         JZ    NXTSPM50                                                         
NXTSPM30 CLC   0(L'SVBMKT,R3),SVBMKT                                            
         JNE   NXTSPM40                                                         
         MVC   PRBMKT,SVBMKT                                                    
         J     MORE                                                             
*                                                                               
NXTSPM40 LA    R3,L'SVBMKT(R3)                                                  
         JCT   R1,NXTSPM30                                                      
*                                                                               
NXTSPM50 LR    RF,R2                DO A BOUNDARY CHECK                         
         AHI   RF,IO6LQ                                                         
         CR    R3,RF                DIE IF WE'RE PAST THE SPACE ALLOTED         
         JNL   *+2                                                              
*                                                                               
         MVC   0(L'SVBMKT,R3),SVBMKT                                            
         LLH   R1,0(R2)             UPDATE # OF ENTRIES IN MARKET LIST          
         LA    R1,1(R1)                                                         
         STCM  R1,3,0(R2)                                                       
         XC    PRBMKT,PRBMKT        CLEAR SO WE KNOW TO OUTPUT MARKET           
         J     MORE                                                             
                                                                                
TSTOTMKT CLC   PRBMKT,SVBMKT        HAVE WE SEEN THIS MARKET BEFORE?            
         J     SETCCC                                                           
*                                                                               
* THIS CODE ONLY RUNS ONCE IN FIRST MODE!! **                                   
*                                                                               
NXTSPMFM L     R1,I$MKTS           **THIS ONLY RUNS ONCE!**                     
         MVC   MKTIND,LW_NUMN-LW_D(R1)                                          
         LA    RF,LW_DATA2-LW_D(R1)                                             
         STCM  RF,7,AMKTDA                                                      
         J     NXTSPM10                                                         
                                                                                
***********************************************************************         
* GET MARKET INFO SUPERDESK REQUEST                                             
***********************************************************************         
ARYMKT   LKOUT A,(R,NXTMKT),ROWNAME=MKTREC                                      
MktNm    LKOUT C,2,MKTNAME,CHAR                                                 
Alpha    LKOUT C,3,MKTALF,CHAR                                                  
         LKOUT E                                                                
                                                                                
NXTMKT   GOTOR (#NXTREC,ANXTREC),DMCB,MKTKEYT,('B#MKTREC',0),          +        
               ('$NXTRSTA',SAVED),0,0                                           
         J     EXITY                                                            
                                                                                
***********************************************************************         
* GET GOAL INFO SUPERDESK REQUEST                                               
***********************************************************************         
ARYSPGL  LKOUT A,(R,NXTSPGL)                                                    
GolSd    LKOUT C,4,(D,B#SAVED,GOLSTDT),CDAT,ND=Y                                
GolEd    LKOUT C,5,(D,B#SAVED,GOLNDDT),CDAT,ND=Y                                
         LKOUT E                                                                
*                                                                               
NXTSPGL  XC    GOLSTDT,GOLSTDT                                                  
         XC    GOLNDDT,GOLNDDT                                                  
         MVI   LP_RMODE,LP_RFRST                                                
NSPGL10  GOTOR (#NXTREC,ANXTREC),DMCB,SPGKEYT,('B#GOLREC',0),SAVED,0,0          
         JE    *+12                                                             
         MVI   LP_RMODE,LP_RNEXT                                                
         J     EXITY                                                            
*                                                                               
         L     R2,AIO4                                                          
         USING GKEY,R2                                                          
         LA    RE,GLEMENT                                                       
NSPGL15  CLI   0(RE),0                EOR?                                      
         JE    NSPGL10                                                          
         CLI   0(RE),GLCODEQ          X'21' - GOAL ELEMENT?                     
         JNE   NSPGL30                                                          
         USING GLEMENT,RE                                                       
         OC    GOLSTDT,GOLSTDT                                                  
         JNZ   NSPGL20                                                          
         MVC   GOLSTDT,GLWEEK                                                   
         MVC   GOLNDDT,GLWEEK                                                   
         J     NSPGL30                                                          
*                                                                               
NSPGL20  CLC   GLWEEK,GOLSTDT         GLWEEK < GOAL START DATE?                 
         JNL   NSPGL25                                                          
         MVC   GOLSTDT,GLWEEK                                                   
         J     NSPGL30                                                          
*                                                                               
NSPGL25  CLC   GLWEEK,GOLNDDT         GLWEEK > GOAL END DATE?                   
         JNH   NSPGL30                                                          
         MVC   GOLNDDT,GLWEEK                                                   
         DROP  RE                                                               
*                                                                               
NSPGL30  LLC   R0,1(RE)               GO THROUGH ALL THE GOAL ELEMS             
         AR    RE,R0                                                            
         J     NSPGL15                                                          
         EJECT                                                                  
***********************************************************************         
* GET MARKET ORDER STATUS FOR SPOT AUTHORIZATION TRACKING (BT)                  
***********************************************************************         
ARYORST  LKOUT A,(R,NXTORST),NROWS=1                                            
ORDRST   LKOUT C,6,(D,B#SAVED,MKTORDST),CHAR,ND=Y                               
         LKOUT E                                                                
*                                                                               
NXTORST  MVC   LP_ADATA,AIO3                                                    
         XC    MKTORDST,MKTORDST      NO STATUS                                 
         XC    IOKEY,IOKEY                                                      
*                                                                               
         LA    R2,IOKEY               SAME DSECT AS DOKEY                       
         USING DCMKTYPE,R2            PSV PTR BY CLT,PRD,EST,MKT                
         MVI   DCMKTYPE,DCMKTYPQ      X'0D' - TYPE                              
         MVI   DCMKSTYP,DCMKSTYQ      X'BD' - SUBTYPE                           
         MVC   DCMKAGMD,SVBAGM        AGENCY/MEDIA                              
         MVC   DCMKCLT,SVBCLT         CLIENT                                    
         MVC   DCMKPRD,SVBPRD         PRODUCT                                   
         MVC   DCMKEST,SVBEST         ESTIMATE                                  
         MVC   DCMKMKT,SVBMKT         MARKET                                    
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO4'                               
         JNE   *+2                                                              
NORST10  CLC   IOKEY(DCMKORDR-DCMKTYPE),IOKEYSAV  SAME MARKET?                  
         JNE   NORSTX                 NO, WE'RE DONE WITH THIS MARKET           
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO4'                              
         JNE   *+2                                                              
*                                                                               
         L     R2,IOADDR                                                        
         LA    R2,DORFRST                                                       
NORST15  CLI   0(R2),0                EOR?                                      
         JE    NORST20                YES, NO STATUS IS UNSENT                  
         CLI   0(R2),DOSTELQ          X'12' - STATUS ELEMENT?                   
         JE    NORSTX12                                                         
         LLC   R0,1(R2)               GO THROUGH ALL THE GOAL ELEMS             
         AR    R2,R0                                                            
         J     NORST15                                                          
*                                                                               
         USING DOSTELD,R2                                                       
NORSTX12 CLI   DOSTSTAT,QCFMD         ORDER IS CONFIRMED?                       
         JNE   NORSTPAR               NO, A STA HAS BEEN SENT NOT CNFMD         
********                                                                        
* WE'RE ON AN CONFIRMED ORDER                                                   
********                                                                        
         CLI   MKTORDST,C'U'          SEEN AN UNSENT ORDER BEFORE?              
         JE    NORSTPAR               YES, WE'RE PARTIAL                        
         MVI   MKTORDST,C'C'          NO, POSSIBLY ALL CONFIRMED                
         J     NORSTSQ                                                          
********                                                                        
* WE'RE ON AN UNSENT ORDER                                                      
********                                                                        
NORST20  CLI   MKTORDST,C'C'          ALL OTHERS WERE CONFIRMED?                
         JE    NORSTPAR               YES, WE GOT A PARTIAL                     
         MVI   MKTORDST,C'U'          SO WE KNOW WE HAD AN UNSENT ORDER         
*                                                                               
NORSTSQ  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO4'                               
         JNE   *+2                                                              
         LA    R2,IOKEY                                                         
         J     NORST10                                                          
*                                                                               
NORSTX   CLI   MKTORDST,0             NO ORDERS?                                
         JE    NORSTNSN               NONE, NEVER SENT                          
         CLI   MKTORDST,C'U'          WE HAVE ORDERS, BUT NEVER SENT?           
         JNE   NORSTCNF               NO, THEN HAS TO BE CONFIRMED              
NORSTNSN MVC   MKTORDST,=CL15'          '      "NEVER SENT"                     
         J     NORSTYES                            OR                           
NORSTCNF MVC   MKTORDST,=CL15'CONFIRMED'       "CONFIRMED"                      
         J     NORSTYES                                                         
*                                                                               
NORSTPAR MVC   MKTORDST,=CL15'PARTIAL'                                          
NORSTYES J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* VALIDATE THE PERSONAL DIRECTORY                                               
***********************************************************************         
*                                                                               
VALPERD  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTMAP',I#SDPERD)              
*                                                                               
         USING LW_D,R2                                                          
         ICM   R2,15,I$PCKEY                                                    
         JZ    VALPD010                                                         
         SR    RF,RF                                                            
         ICM   RF,3,LW_LN                                                       
         AHI   RF,-(LW_LN1Q)                                                    
         GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTRAW',21),          *        
               ('LD_CHARQ',LW_DATA1),((RF),0)                                   
         DROP  R2                                                               
*                                                                               
VALPD010 OC    SVMED,SVMED                                                      
         JZ    *+2                                                              
         GOTOR (#VALMED,AVALMED),DMCB,SVMED,L'SVMED,SVBAGM                      
         JNE   *+2                                                              
*                                                                               
         GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTRAW',1),           *        
               ('LD_CHARQ',SVMED),(L'SVMED,0)                                   
*                                                                               
VALPD015 OC    SVQCLT,SVQCLT                                                    
         JZ    VALPD020                                                         
         SR    RF,RF                                                            
         GOTOR (#VALCLT,AVALCLT),DMCB,SVQCLT,L'SVQCLT,QCLTX                     
         JE    VALPD020                                                         
         MVC   PDRETURN(L'QCLTA),SVQCLT  RETURN CLIENT CODE                     
         OI    PDERROR,PDINVCLT          X'80' SET CLIENT ERROR                 
         MVI   PDMAP#,PDCLT#             CLIENT CODE MAP 19                     
         BRAS  RE,VALPDERR                                                      
         XC    I$STN,I$STN               DON'T PROCESS STATIONS                 
*                                                                               
VALPD020 SR    R1,R1                                                            
         ICM   R1,15,I$STN         ANY STATIONS?                                
         JZ    EXITY                NO, EXIT                                    
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R1)                                            
         STC   R0,STTNIND          # OF ENTRIES                                 
         LA    R1,LW_DATA2-LW_D(R1)                                             
         STCM  R1,7,ASTATN         A(STATION ENTRIES)                           
*                                                                               
VALPDNXT SR    R1,R1                                                            
         ICM   R1,1,STTNIND        ANY MORE STATIONS?                           
         JZ    EXITY                NO, EXIT                                    
*                                                                               
VALPD030 SHI   R1,1                                                             
         STC   R1,STTNIND                                                       
         ICM   R1,7,ASTATN                                                      
         MVC   PDSTN,0(R1)                                                      
*                                                                               
         GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTRAW',13),          *        
               ('LD_CHARQ',PDSTN),(L'PDSTN,0)                                   
*                                                                               
VALPD040 OC    SVDEST,SVDEST                                                    
         JZ    VALPD045                                                         
         CLI   SVDEST,C'R'         DESTINATION IS REP?                          
         JE    VALPD050                                                         
         CLI   SVDEST,C'S'         DESTINATION IS STATION?                      
         JE    VALPD050                                                         
VALPD045 OI    PDERROR,PDINVDST    X'80' INVALID DESTINATION                    
         MVC   PDRETURN(L'SVDEST),SVDEST                                        
         MVI   PDMAP#,PDDEST#      DESTINATION MAP 3                            
VALERNXT BRAS  RE,VALPDERR                                                      
         J     VALPDNXT                                                         
*                                                                               
VALPD050 OC    SVMTHD,SVMTHD                                                    
         JZ    VALPD055                                                         
         CLI   SVMTHD,C'I'         METHOD IS INBOX?                             
         JE    VALPD060                                                         
         CLI   SVMTHD,C'F'         METHOD IS FAX?                               
         JE    VALPD060                                                         
VALPD055 OI    PDERROR,PDINVMTH    X'80' INVALID METHOD                         
         MVC   PDRETURN(L'SVMTHD),SVMTHD                                        
         MVI   PDMAP#,PDMETH#      METHOD MAP 5                                 
         J     VALERNXT                                                         
*                                                                               
         USING DSTAKEYD,RF                                                      
VALPD060 LA    RF,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   DSTAKTYP,DSTAKTYPQ                                               
         MVC   DSTAKMEDA,QMEDA                                                  
         MVC   DSTAKSTIN,PDSTN                                                  
         CLI   PDSTN,C'0'          EBCDIC CABLE STATION?                        
         BL    *+8                                                              
         MVI   DSTAKSTIN+4,C'T'    YES, APPEND A BAND OF T AS VB DIDN'T         
         DROP  RF                                                               
*                                                                               
         NI    MISCFLG2,X'FF'-MF2NODST                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGENDIR+IO3'                            
         JNE   *+2                                                              
         CLC   IOKEY(DSTAKEFDA-DSTAKEYD),IOKEYSAV                               
         JE    VALPD070                                                         
         OI    MISCFLG2,MF2NODST   SET NODSTA                                   
         CLI   SVMTHD,C'F'         IS METHOD FAX?                               
         JE    VALPD080            YES, ITS OK FOR DSTA TO NOT EXIST            
VALPD065 MVI   PDERROR,PDINVSTN    X'80' SET STATION INVALID                    
         MVI   PDMAP#,PDSTN#                                                    
         J     VALERNXT                                                         
*                                                                               
VALPD070 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGENFIL+IO3'                           
         JNE   *+2                                                              
*********                                                                       
* CHECK IF INBOX(REP/STA) IS VALID                                              
*********                                                                       
         L     R3,AIO3                                                          
         LA    R3,DSTAELDQ(R3)     POINT TO FIRST ELEMENT                       
VALPD080 CLI   SVDEST,C'S'         DESTINATION STATION?                         
         JNE   VALPD120            NO, CHECK IF ITS STA                         
         CLI   SVMTHD,C'F'         IS METHOD FAX?                               
         JE    VALPDNXT            YES, STATION FAX IS VALID                    
*********                                                                       
* CHECK IF STA INBOX IS VALID                                                   
*********                                                                       
VALPD090 OC    REPPREFX,REPPREFX   DO WE HAVE A STATION RECEIVING ID?           
         JZ    VALPD125            NO, SEND ERROR                               
*                                                                               
         TM    MISCFLG2,MF2NODST   NO DSTA?                                     
         JO    VALPD065             SEND ERROR, INVALID STATION                 
         CLI   0(R3),0             END OF RECORD?                               
         JE    VALPD115                                                         
         CLI   0(R3),DSTAHOMCQ     X'30' HOME MARKET INFO?                      
         JE    VALPD100                                                         
         CLI   0(R3),DSTAH2CQ      X'31' HIDDEN RECEIVING ID INFO?              
         JE    VALPD110                                                         
VALPD095 SR    R0,R0                                                            
         IC    R0,1(R3)                                                         
         AR    R3,R0                                                            
         J     VALPD090                                                         
         USING DSTAHOMD,R3                                                      
VALPD100 CLC   DSTAHOMIC,SPACES    DO WE HAVE A RECEIVING ID?                   
         JNH   VALPD095             NO, LETS CHECK SPECIAL LLC                  
         MVC   WORK(L'DSTAHOMIC),DSTAHOMIC                                      
         J     *+10                                                             
         USING DSTAH2D,R3                                                       
VALPD110 MVC   WORK(L'DSTAH2IC),DSTAH2IC                                        
         DROP  R3                                                               
*                                                                               
         CLC   REPPREFX,WORK       MATCH ON STATION RCV'G ID?                   
         JE    VALPDNXT            YES, ITS VALID                               
VALPD115 MVI   PDERROR,PDBADDST    X'40' SET BAD DESTINATION                    
         MVI   PDMAP#,PDDEST#      DESTINATINO MAP 03                           
         MVC   PDRETURN(L'SVDEST),SVDEST                                        
         J     VALERNXT                                                         
*********                                                                       
* CHECK IF REP INBOX IS VALID                                                   
*********                                                                       
VALPD120 OC    REPPREFX,REPPREFX   DO WE HAVE A REP PREFIX?                     
         JNZ   CHKDARTB                                                         
         CLI   SVMTHD,C'I'         IS DESTINATION INBOX?                        
         JNE   VALPDNXT            NO                                           
VALPD125 MVC   PDRETURN,SPACES     YES, ERROR, SHOULD HAVE A REP CODE           
         MVI   PDERROR,PDMISREP    X'80' SET MISSING REP CODE                   
         MVI   PDMAP#,PDREPAG#     REP CODE 07                                  
         J     VALERNXT                                                         
*                                                                               
CHKDARTB MVC   WORK(L'REPPREFX),REPPREFX                                        
         OC    REPOFFCD,REPOFFCD   HAVE OFFICE TO APPEND?                       
         JZ    CDT010                                                           
         LA    RF,WORK+L'REPPREFX-1                                             
CDT005   CLI   0(RF),C' '                                                       
         JNE   *+8                                                              
         BCT   RF,CDT005                                                        
         MVC   1(L'REPOFFCD,RF),REPOFFCD                                        
CDT010   GOTOR VGETDARE,DMCB,(C'U',0),WORK,AIO8,A(IO8LQ),VDATAMGR               
         BE    CDT020                                                           
*                                                                               
         MVI   PDERROR,PDINVREP    X'80' REP DOESN'T EXIST                      
         MVI   PDMAP#,PDREPAG#     REP CODE 07                                  
         MVC   PDRETURN,REPPREFX                                                
         J     VALERNXT                                                         
****                                                                            
CDT020   L     RE,AIO8                                                          
         USING DAREPTD,RE                                                       
*                                                                               
         TM    DAPTFLG2,DPF2EOC    END OF CONTRACT?                             
         JO    VALPD065            SEND ERROR, INVALID STATION                  
*                                                                               
         TM    DAPTFLG1,DPF1NOOF   X'80'- DOES THE REP APPEND OFFICE?           
         JZ    CDT030              YES                                          
         OC    REPOFFCD,REPOFFCD   NO, DID WE GET A REP OFFICE?                 
         JZ    CDT040                NO, EXIT                                   
         MVI   PDERROR,PDOFFNRQ    X'40' REP DOESNT APPEND OFFICE ERROR         
         J     CDT035                                                           
         DROP  RE                                                               
*                                                                               
CDT030   OC    REPOFFCD,REPOFFCD   YES, DID WE GET A REP OFFICE?                
         JNZ   CDT040                NO, ERROR                                  
         MVI   PDERROR,PDOFFREQ    X'80' REP APPENDS OFFICE                     
CDT035   CLI   SVMTHD,C'F'         AM METHOD FAX?                               
         JE    CDT040               ITS OK FOR FAX                              
         MVI   PDMAP#,PDREPOF#     REP OFFICE 09                                
         MVC   PDRETURN(L'REPOFFCD),REPOFFCD                                    
         J     VALERNXT                                                         
*                                                                               
CDT040   MVI   PDERROR,0           CLEAR ERROR                                  
*                                                                               
         TM    MISCFLG2,MF2NODST   DSTA RECORD FOUND?                           
         JNZ   VALPD220             NO                                          
***********************************************************************         
* COMMENT OUT TO ALLOW SELECT DESTINATION REP EVEN THOUGH USER IS               
* SENDING FROM MARKET MATCHING THE DSTA HOME MARKET   -HWON MAY15/18            
***********************************************************************         
*&&DO                                                                           
VALPD140 CLI   0(R3),0             END OF RECORD?                               
         JE    VALPD160                                                         
         CLI   0(R3),DSTAHOMCQ     X'30' HOME MARKET INFO?                      
         JE    VALPD150                                                         
         SR    R0,R0                                                            
         IC    R0,1(R3)                                                         
         AR    R3,R0                                                            
         J     VALPD140                                                         
         USING DSTAHOMD,R3                                                      
VALPD150 CLC   DSTAHOMCT,REPOFFCD  SENDING FROM HOME MARKET CITY?               
         JE    VALPD115            YES, SEND ERROR                              
         DROP  R3                                                               
*&&                                                                             
***********************************************************************         
*                                                                               
VALPD160 L     RE,AIO8             GET A(REP ENTRY IN DDDARETAB)                
         USING DAREPTD,RE                                                       
         L     R3,AIO3                                                          
         LA    R3,DSTAELDQ(R3)     POINT TO FIRST ELEMENT                       
VALPD170 CLI   0(R3),0             END OF DSTA RECORD?                          
         JE    VALPD190            YES, REP DOES NOT MATCH                      
*                                                                               
         CLI   0(R3),DSTAREPCQ     X'10'-REP INFO ELEMENT?                      
         JE    VALPD200                                                         
         CLI   0(R3),DSTARP2CQ     X'11'-REP2 INFO ELEMENT?                     
         JE    VALPD210                                                         
VALPD180 LLC   R0,1(R3)            R3=A(NEXT ELEMENT) IN DSTA RECORD            
         AR    R3,R0                                                            
         J     VALPD170                                                         
*                                                                               
VALPD190 MVI   PDERROR,PDBADREP    X'20' REP CODE DOESN'T MATCH                 
         MVI   PDMAP#,PDREPAG#     REP CODE 07                                  
         MVC   PDRETURN(L'REPPREFX),REPPREFX                                    
         J     VALERNXT                                                         
*                                                                               
* PROCESSING PRIMARY REP X'10' ELEM                                             
         USING DSTAREPD,R3                                                      
VALPD200 LA    RF,DSTAREPCR        SET CURRENT REP TO COMPARE                   
         OC    DSTAREPED,DSTAREPED HAVE REP EFF DATE?                           
         JZ    VALPD205             NO                                          
         CLC   DSTAREPED,JDTTODAY  HAS CURRENT REP TAKEN EFFECT?                
         JNH   VALPD205             YES                                         
         LA    RF,DSTAREPPR        SET PREVIOUS REP TO COMPARE                  
VALPD205 CLC   DAPTCODE,0(RF)      MATCH ON REP?                                
         JE    VALPD220             YES                                         
         J     VALPD180             CHECK FOR 2NDARY REP ELEMS                  
*                                                                               
* PROCESSING 2NDARY REP X'11' ELEM                                              
VALPD210 CLC   DSTAREPCR,DAPTCODE  MATCH ON REP?                                
         JE    VALPD220             YES                                         
         CLI   DSTAREPLN,DSTARP2LQ HAVE ADD'L 2ND REPS?                         
         JNE   VALPD180             NO                                          
         LA    R4,DSTAREPSN        LETS CHECK ADD'L 2ND REPS                    
         LA    RF,DSTAREPS         WE CAN HAVE MULTIPLE REPS HERE               
VALPD215 CLC   DAPTCODE,0(RF)      MATCH ON 2ND REP?                            
         JE    VALPD220             YES                                         
         LA    RF,L'DSTAREPS(RF)   BUMP TO NEXT 2ND REP                         
         JCT   R4,VALPD215                                                      
         J     VALPD190            NO MATCH ON REP CODE                         
         DROP  R3,RE                                                            
*                                                                               
VALPD220 CLI   QMEDA,C'T'          MEDIA T?                                     
         JNE   VALPD230                                                         
         CLI   SVMTHD,C'F'         IS METHOD FAX?                               
         JE    VALPDNXT            YES, REP FAX IS VALID                        
*                                                                               
         L     RF,AIO8             GET A(REP ENTRY IN DDDARETAB)                
         USING DAREPTD,RF                                                       
         LA    R4,IOKEY                                                         
         USING CTIREC,R4                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ                                                 
         SR    R3,R3                                                            
         IC    R3,DAPTLPFX                                                      
         BCTR  R3,0                                                             
         BASR  RE,0                                                             
         EX    R3,8(RE)                                                         
         J     *+10                                                             
         MVC   CTIKID(0),DAPTRPPF                                               
         LA    RE,CTIKID+1(R3)                                                  
         MVC   0(L'REPOFFCD,RE),REPOFFCD                                        
         OC    CTIKID,SPACES                                                    
         DROP  RF                                                               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOCTFILE+IO3'                            
         JE    VALPDNXT                                                         
VALPD225 MVI   PDERROR,PDINVOFF    X'20' SET REP OFFICE INVALID                 
         MVI   PDMAP#,PDREPOF#     REP OFFICE 09                                
         MVC   PDRETURN(L'REPOFFCD),REPOFFCD                                    
         J     VALERNXT                                                         
* IS THE RADIO OFFICE VALID?                                                    
*                                                                               
VALPD230 CLI   QMEDA,C'R'          MEDIA R?                                     
         JNE   VALPD300                                                         
         CLI   SVMTHD,C'F'         IS METHOD FAX?                               
         JE    VALPDNXT             EXIT                                        
*                                                                               
         CLI   PDSTN+4,C'S'        PANDORA STREAMING STATION?                   
         JE    VALPDNXT                                                         
         CLI   PDSTN+4,C'C'        I-HEART STREAMING STATION?                   
         JE    VALPDNXT                                                         
*                                                                               
         L     RF,AIO8                                                          
         USING DAREPTD,RF                                                       
*****    LA    RE,SBSTAB                                                        
         BRAS  RE,GETSBSTB                                                      
         LR    RE,R1                                                            
*****                                                                           
         SR    R0,R0                                                            
VALPD240 CLI   0(RE),X'FF'                                                      
         JE    *+2                                                              
         CLC   0(L'DRREPCOD,RE),DAPTCODE                                        
         JE    VALPD245                                                         
         LA    RE,L'SBSTAB(RE)                                                  
         J     VALPD240                                                         
         DROP  RF                                                               
*                                                                               
VALPD245 MVC   REPALPH1,3(RE)                                                   
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R3,IOKEY            CHECK IF THIS IS A SUBSIDIARY REP            
         USING GSPLRECD,R3                                                      
         MVI   GSPLKTYP,GSPLRECQ                                                
         MVC   GSPLKRP1,3(RE)      MOVE IN REP ALPHA                            
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGENDIR+IO3'                            
*                                                                               
         CLC   IOKEY(GSPLKRP2-GSPLKEY),IOKEYSAV    SUBSIDIARY REP?              
         JNE   VALPDNXT                            NO                           
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGENFIL+IO3'                           
         JNE   VALPDNXT                                                         
*                                                                               
         L     R4,IOADDR                                                        
         LA    R4,GSPLFRST(R4)     POINT TO FIRST ELEMENT                       
         USING GSPLOFFL,R4                                                      
         SR    R0,R0                                                            
VALPD250 CLI   GSPLOFFL,0          END OF RECORD?                               
         JE    VALPDNXT                                                         
         CLI   GSPLOFFL,X'02'      OFFICE ELEMENT?                              
         JE    VALPD260                                                         
         IC    R0,GSPLOFLN                                                      
         AR    R4,R0                                                            
         J     VALPD250                                                         
*                                                                               
VALPD260 SR    RE,RE                                                            
         IC    RE,GSPLOFNM                                                      
VALPD265 CLC   GSPLOFFN,REPOFFCD                                                
         JE    VALPD270                                                         
         LA    R4,L'GSPLOFFN(R4)                                                
         JCT   RE,VALPD265                                                      
         J     VALPD225            SEND ERROR                                   
         DROP  R4                                                               
*                                                                               
VALPD270 L     R4,IOADDR                                                        
R        USING GSPLRECD,R4                                                      
         XC    IOKEY,IOKEY                                                      
         MVI   GSPLKTYP,GSPLRECQ                                                
         MVC   GSPLKSRP,R.GSPLKRP2 MOVE IN MASTER REP                           
         MVI   GSPLKSTP,X'01'      SET TO SALESPERSON                           
*                                                                               
         USING LW_D,RE                                                          
         ICM   RE,15,I$SALESC                                                   
         MVC   GSPLKSAL,LW_DATA1                                                
*                                                                               
         ICM   RE,15,I$PPFLAG                                                   
         JZ    VALPD275                                                         
         CLI   LW_DATA1,C'P'       ARE WE DOING POINTPERSON?                    
         JNE   VALPD275            NO                                           
         MVI   GSPLKSTP,X'02'      SET TO POINTPERSON                           
         OC    R.GSPLMRP,R.GSPLMRP YES, DO WE HAVE A NEW MASTER REP?            
         JZ    VALPD275            NO                                           
         MVC   GSPLKPRP,R.GSPLMRP  YES, USE THAT ONE                            
         DROP  R,RE                                                             
*                                                                               
VALPD275 OC    LP_VRSN,LP_VRSN                                                  
         JZ    VALPD280                                                         
         CLC   LP_VRSN,V320060                                                  
         JL    VALPD285                                                         
VALPD280 GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTRAW',22),          *        
               ('LD_CHARQ',GSPLKPRP),(L'GSPLKPRP,0)                             
*                                                                               
VALPD285 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGENDIR+IO3'                            
*                                                                               
         CLC   IOKEY(L'GSPLKEY),IOKEYSAV     VALID SALESPERSON?                 
         JE    VALPDNXT                            NO                           
         MVI   PDERROR,PDINVSAL    X'80' SET SALESPERSON CODE INVALID           
         MVI   PDMAP#,PDSALCD#     SALEPERSON CODE 15                           
         ICM   RE,15,I$SALESC                                                   
         SR    RF,RF                                                            
         USING LW_D,RE                                                          
         ICM   RF,3,LW_LN                                                       
         AHI   RF,-(LW_LN1Q+1)                                                  
         MVC   PDRETURN(0),LW_DATA1                                             
         EX    RF,*-6                                                           
         J     VALERNXT                                                         
         DROP  RE                                                               
*                                                                               
VALPD300 CLI   QMEDA,C'X'          MEDIA X?                                     
         JNE   *+2                                                              
         CLI   SVMTHD,C'E'         IS METHOD EMAIL?                             
         JE    VALPDNXT             EXIT                                        
         J     VALPD055                                                         
                                                                                
VALPDERR NTR1                                                                   
         SR    R2,R2                                                            
         IC    R2,PDMAP#                                                        
         OC    PDRETURN,PDRETURN                                                
         JZ    VALPE010                                                         
         GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTRAW',(R2)),        *        
               ('LD_CHARQ',PDRETURN),(L'PDRETURN,0)                             
VALPE010 LA    R2,1(R2)                                                         
         CLI   PDERROR,0                                                        
         JE    VALPE020                                                         
         GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTRAW',(R2)),        *        
               ('LD_HEXDQ',PDERROR),(L'PDERROR,0)                               
VALPE020 XC    PDRETURN,PDRETURN                                                
         J     EXITY                                                            
*                                                                               
***************                                                                 
* NOTE: DSTA RECORD NEEDS A X'31' ELEMENT FOR THE RECEIVING ID SO THAT          
*       THE DARE DISPATCHER KNOWS THIS IS HARD-CODED                            
***************                                                                 
GETSBSTB BASR  R1,RE               RETURNS SBSTAB                               
SBSTAB   DS    0CL5                                                             
*                                                                               
* SBS LIST OF KATZ REPS                                                         
*                                                                               
         DC    C'K3 ',C'K3'        MASTER REP - ADVANTAGE                       
         DC    C'KR ',C'KU'        KR  - KATZ RADIO                             
         DC    C'KH ',C'KF'        KH  - UNIVISION RADIO SALES                  
         DC    C'CHR',C'CR'        CHR - CHRISTAL                               
*REUSED  DC    C'NOT',C'K6'        NOT - KZ RAD GRP (DIM)                       
*REUSED  DC    C'SPS',C'QD'        SPS - SPRTS SPEC                             
         DC    C'KRD',C'J0'        KRD - EASTMAN                                
         DC    C'WSM',C'WC'        WSM - WEST SIDE                              
         DC    C'CCR',C'NU'        CCR - CCM+E MMS                              
         DC    C'CRD',C'SM'        CRD - CLEAR CHANNEL                          
         DC    C'DED',C'EA'        DED - DEDICATED                              
         DC    C'KNR',C'6S'        KNR - NET RADIO SALES                        
         DC    C'KRG',C'RT'        KRG - KATZ RADIO GROUP                       
         DC    C'K36',C'UO'        K36 - KATZ360 NETWORK                        
         DC    C'WON',C'QD'        WON - WESTWOOD ONE NATIONAL                  
         DC    C'KNT',C'KI'        KNT - KATZNET                                
                                                                                
* TEST REPS                                                                     
***      DC    C'SG ',C'SG'        MASTER REP-KRGQA ADVANTAGE                   
         DC    C'KQ0',C'SJ'        KQ0 - KQACHR                                 
         DC    C'KT1',C'T1'        KT1 - KTPKR                                  
         DC    C'BBR',C'TM'        BBR - KBBKR                                  
         DC    C'MEG',C'HD'        MEG - MEG                                    
         DC    C'BB2',C'*B'        BB2 - KBBJR                                  
         DC    C'IBR',C'WJ'        IBR - IBBIR                                  
         DC    C'IB2',C'H9'        IB2 - IBBRR                                  
         DC    C'MQA',C'SD'        MQA - MQAGM                                  
         DC    C'MQA',C'SF'        MQA - MASTER REP                             
*                                                                               
* SBS LIST OF INTEREP REPS                                                      
*                                                                               
         DC    C'IR ',C'IR'        MASTER REP - SPECIALIZED                     
*REUSED  DC    C'ABR',C'IB'        ABR - ABC RADIO SALES                        
         DC    C'GMP',C'IB'        GMP - GEN MEDIA PARTNERS                     
***      DC    C'CML',C'UO'        CML - CUMULUS RADIO SALES                    
*REUSED  DC    C'DAR',C'D4'        DAR + D & R RADIO                            
*REUSED  DC    C'CBR',C'IF'        CBR - CBS RADIO SALES                        
         DC    C'MG ',C'MG'        MG  + MCGAVREN GUILD RADIO                   
*REUSED  DC    C'CMM',C'DE'        CMM - CUMULUS MAJOR MARKETS                  
         DC    C'SBI',C'GB'        SBI + SBS/INTEREP                            
         DC    C'CIT',C'MP'        CIT - ABC-CITADEL                            
         DC    C'LCF',C'NM'        LCF + INTEREP LOCAL FOCUS                    
         DC    C'NLF',C'NR'        NLF + NON-REP LOCAL FOCUS                    
         DC    C'MGM',C'PD'        MGM + MCGAVERN GUILD MEDIA                   
         DC    C'LFR',C'PM'        LFR + LOCAL FOCUS RADIO                      
         DC    C'TAC',C'D4'        TAC - TACHER                                 
         DC    C'RRG',C'IF'        RRG - REGIONAL REP GMP                       
         DC    C'NRR',C'DE'        NRR - NON-REGIONAL REPS                      
*                                                                               
***      DC    C'SUS',C'GR'        SUSQUEHANNA RAD SALES                        
***      DC    C'MGR',C'GV'        MG/RMR                                       
*                                                                               
* SBS LIST OF RMR REPS  - REGIONAL - ALSO USING ITG POWER CODES                 
*                                                                               
         DC    C'GR ',C'GR'        MASTER REP - REGIONAL                        
         DC    C'RRP',C'GV'        RRP - REGIONAL REPS                          
*                                                                               
* SBS LIST OF NPM REPS  - ALSO USING ITG POWER CODES                            
*                                                                               
         DC    C'NM ',C'NM'        MASTER - NAT'L PUBLIC MEDIA                  
         DC    C'NPM',C'RU'        NPM - NAT'L PUBLIC MEDIA                     
*                                                                               
* SBS LIST OF ENTRAVISION REPS  - ALSO USING ITG POWER CODES                    
*                                                                               
         DC    C'EN ',C'EN'        MASTER - ENTRAVISION                         
         DC    C'ENT',C'MP'        ENTRAVISION SOLUTIONS                        
         DC    C'???',C'DE'        LOTUS ENTRAVISION                            
*                                                                               
* DEV TEST                                                                      
         DC    C'DXM',C'KU'        KATZ RADIO                                   
         DC    X'FF'                                                            
                                                                                
                                                                                
PDSTN    DS    CL(L'DSTAKSTIN)     RETURN STATION                               
PDRETURN DS    CL25                FIELD IN ERROR                               
*                                                                               
PDERROR  DS    X                                                                
PDINVCLT EQU   X'80'               - X'80' INVALID CLIENT                       
PDINVFX# EQU   X'80'               - X'80' INVALID FAX NUMBER                   
PDINVDST EQU   X'80'               - X'80' INVALID DESTINATION                  
PDBADDST EQU   X'40'               - X'40' CANT CHOOSE THIS DESTINATION         
PDINVMTH EQU   X'80'               - X'80' INVALID METHOD                       
PDMISREP EQU   X'80'               - X'80' MISSING REP CODE                     
PDINVREP EQU   X'40'               - X'40' REP DOESN'T EXIST                    
PDBADREP EQU   X'20'               - X'20' INCORRECT REP                        
PDOFFNRQ EQU   X'80'               - X'80' REP DOESNT APPEND OFFICE             
PDOFFREQ EQU   X'40'               - X'40' REP APPENDS OFFICE                   
PDINVOFF EQU   X'20'               - X'20' OFFICE DOESN'T EXIST                 
PDINVSAL EQU   X'80'               - X'80' INVALID SALESPERSON CODE             
PDINVSTN EQU   X'80'               - X'80' INVALID DESTINATION                  
*                                                                               
PDMAP#   DS    X                   RETURN MAP CODE                              
PDDEST#  EQU   03                                                               
PDMETH#  EQU   05                                                               
PDREPAG# EQU   07                                                               
PDREPOF# EQU   09                                                               
PDFAXNM# EQU   11                                                               
PDSTN#   EQU   13                                                               
PDSALCD# EQU   15                                                               
PDCLT#   EQU   19                                                               
*                                                                               
***********************************************************************         
* BUYER CONFIRM ORDER                                                           
***********************************************************************         
*                                                                               
BCNFORD  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,IOADDR                                                        
         CLC   0(2,R4),=X'0D34'                                                 
         JE    BCNF005                                                          
         GOTOR PUTERR,DMCB,('SE#SY003',SE#UNEXP)                                
         J     BCNFXN                                                           
*                                                                               
BCNF005  L     R4,IOADDR                                                        
         MVI   ELCDLO,DOSTELQ      HAVE WE SENT THIS ORDER YET?                 
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   BCNFERR             NO, ERROR                                    
         USING DOSTELD,R4                                                       
*                                                                               
         CLI   DOSTSTAT,DFXDLVD    IS IT FAX DELIVERED?                         
         JE    BCNF010                                                          
         CLI   DOSTSTAT,DEMDLVD    OR EMAIL DELIVERED?                          
         JE    BCNF010                                                          
*                                                                               
         CLI   DOSTSTAT,QCFMD      AM I CONFIRMED!!                             
         JNE   BCNFERR                                                          
         TM    DOSTTYPE,DCNFMCOM   WITH COMMENTS?                               
         JZ    BCNFERR                                                          
         MVI   ELCDLO,MGCOLELQ     X'14' DO I HAVE ACTIVE MAKEGOODS?            
         MVI   ELCDHI,MGCOLELQ                                                  
         BRAS  RE,GETEL                                                         
         JE    BCNFERR             YES, ERROR                                   
*                                                                               
BCNF010  L     R4,IOADDR                                                        
         MVI   ELCDLO,DOXMTELQ     X'11' TRANSMISSION ELEMENT                   
         MVI   ELCDHI,DOXMTELQ                                                  
         BRAS  RE,GETEL                                                         
         USING DOXMTELD,R4                                                      
*                                                                               
         THMS  DDSTIME=YES                                                      
         STCM  R0,15,PACKOF4B                                                   
         ST    R1,FULL                                                          
         AP    PACKOF4B,FULL                                                    
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(0,DUB)   THE TIME                            
         CP    PACKOF4B,=P'240000'    PAST MIDNIGHT?                            
         JL    BCNF12                                                           
         SP    PACKOF4B,=P'240000'    YES, BUMP TO NEXT DAY AND ADJUST          
         GOTOR VADDAY,DMCB,DUB,DUB,F'1'                                         
                                                                                
BCNF12   GOTOR VDATCON,DMCB,(0,DUB),(19,DOXMTSTD)                               
         ICM   R1,15,PACKOF4B                                                   
         SRL   R1,12               GET RID OF SECONDS AND SIGN                  
         STCM  R1,3,DOXMTSTT                                                    
         MVI   DOXMTSTA,QBYRCNFM                                                
         DROP  R4                                                               
*                                                                               
         LA    R4,ELEM                                                          
         USING DOSTELD,R4                                                       
         XC    ELEM,ELEM                                                        
         MVI   DOSTEL,DOSTELQ                                                   
         MVI   DOSTLEN,DOSTLNQ                                                  
*                                                                               
         THMS  DDSTIME=YES                                                      
         STCM  R0,15,PACKOF4B                                                   
         ST    R1,FULL                                                          
         AP    PACKOF4B,FULL                                                    
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(0,DUB)   THE TIME                            
         CP    PACKOF4B,=P'240000'    PAST MIDNIGHT?                            
         JL    BCNF20                                                           
         SP    PACKOF4B,=P'240000'    YES, BUMP TO NEXT DAY AND ADJUST          
         GOTOR VADDAY,DMCB,DUB,DUB,F'1'                                         
                                                                                
BCNF20   GOTOR VDATCON,DMCB,(0,DUB),(19,DOSTDATE)                               
         ICM   R1,15,PACKOF4B                                                   
         SRL   R1,12               GET RID OF SECONDS AND SIGN                  
         STCM  R1,3,DOSTTIME                                                    
         MVI   DOSTSTAT,QBYRCNFM                                                
         DROP  R4                                                               
*                                                                               
         L     R4,IOADDR                                                        
         MVI   ELCDLO,DOSTELQ      X'12' STATUS ELEMENT                         
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,GETEL                                                         
         GOTOR ARECUP,DMCB,(C'S',IOADDR),ELEM,(R4)                              
*                                                                               
         GOTOR ADDIOLST,'IOPUT+IOFIL+IO3'                                       
*                                                                               
         L     R4,IOADDR                                                        
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOSPELD,R4                                                       
         MVC   BYTE,DOSPREVN                                                    
*                                                                               
         L     RE,IOADDR                                                        
         LA    R4,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         USING DOKEY,R4                                                         
         MVC   DOKEY,0(RE)                                                      
         MVI   DOKCMT,DOKCBCCQ     X'03' TYPE RECORD                            
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO4'                               
         JNE   *+2                                                              
*                                                                               
         CLC   IOKEY(L'DOKEY),IOKEYSAV                                          
         JNE   BCNF30                                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO4'                           
         JNE   *+2                                                              
         L     R4,IOADDR                                                        
         J     BCNF40                                                           
*                                                                               
BCNF30   OI    MISCFLG1,MF1RECNF   RECORD IS NEW                                
         L     R4,AIO4                                                          
         XC    0(256,R4),0(R4)     INIT IO4                                     
         MVC   DOKEY,IOKEYSAV                                                   
         MVC   DORLEN,=Y(DORFRST-DOKEY)                                         
         MVC   DORAGY,LP_AGY                                                    
BCNF40   LA    R4,DORFRST-DOKEY(R4)  R4 = A(FIRST ELEMENT IN RECORD)            
         DROP  R4                                                               
*                                                                               
         LA    R2,2                LOOP TWICE FOR COMMENTS                      
         ICM   RE,15,I$COM2                                                     
         JZ    BCNF50                                                           
         USING LW_D,RE                                                          
BCNF45   LH    RF,LW_LN            LENGTH OF ENTRY + L'FLDHDR                   
         AHI   RF,-(LW_LN1Q+1)     -(L'FLDHDR + 1 FOR EX)                       
         JM    BCNF50                                                           
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R3,ELEM                                                          
         USING DOCM2ELD,R3                                                      
         EX    RF,BCNFMV           SAVE THE STRING                              
         STC   R2,DOCM2LIN                                                      
         MVC   DOCM2REV,BYTE                                                    
         MVI   ELEM,DOCM2ELQ                                                    
         AHI   RF,DOCM2OVH+1       + OVERHEAD + 1 FOR EX                        
         STC   RF,ELEM+1           SAVE THE LENGTH                              
         GOTOR ARECUP,DMCB,(C'S',AIO4),ELEM,(R4)                                
*                                                                               
BCNF50   ICM   RE,15,I$COM1        MUST HAVE COMMENT1                           
         JZ    BCNFERR             NO, ERROR                                    
         JCT   R2,BCNF45                                                        
*                                                                               
BCNFXY   TM    MISCFLG1,MF1RECNF   RECORD IS NEW                                
         JNZ   BCNFXY1                                                          
         GOTOR ADDIOLST,'IOPUT+IOFIL+IO4'                                       
         J     BCNFXY2                                                          
BCNFXY1  GOTOR ADDIOLST,'IOADDREC+IOFIL+IO4'                                    
BCNFXY2  L     R4,AIO3                                                          
         USING DAREORDD,R4                                                      
         MVC   SVBAGM,DOKAGMD                                                   
         MVI   ELCDLO,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         MVI   ELCDHI,DOIDELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
         MVC   SVQBYR,DOIDBYR                                                   
         MVC   SVBCLT,DOIDCLT                                                   
         MVC   QCLTX,DOIDCLT                                                    
         GOTOR (#GETCLT,AGETCLT)   READ CLIENT RECORD                           
         MVC   SVBPRD,DOIDPRD                                                   
         GOTOR (#EDTPRD,AEDTPRD),DMCB,DOIDPRD,0,SVQPRD                          
         MVC   SVBPR2,DOIDPRD2                                                  
         MVC   SVBEST,DOIDEST                                                   
         MVC   SVBSTA,DOISTA                                                    
         MVC   SVBFLT,DOIDFLTN                                                  
*                                                                               
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID ELEMENT               
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,NEXTEL                                                        
         USING DOSPELD,R4                                                       
         MVC   SVBMKT,DOSPMKT                                                   
         DROP  R4                                                               
*                                                                               
         BRAS  RE,CHKFRCHG                                                      
*                                                                               
         BRAS  RE,GTESTINF         GET ESTIMATE INFO                            
*                                                                               
         GOTOR GTFLTINF,DMCB,0     GET FLIGHT INFO                              
         JNE   *+2                                                              
*                                                                               
         MVI   BYTE2,SPAUPBCN      UPDATE BUYER CONFIRMATION DATE               
         BRAS  RE,CHKAUTH                                                       
         J     EXITY                                                            
*                                                                               
BCNFERR  GOTOR PUTERR,DMCB,('SE#SY023',SE#NOBCF)                                
BCNFXN   J     EXITN                                                            
*                                                                               
BCNFMV   MVC   DOCM2TXT(0),LW_DATA1                                             
         DROP  R3,RB,RE                                                         
         EJECT                                                                  
*                                                                               
***********************************************************************         
* UPDATE THE OFFER RECORD                                                       
***********************************************************************         
*                                                                               
UPDMKO   NTR1  BASE=*,LABEL=*,WORK=(RC,UMKOWRKL)                                
         USING UMKOWRKD,RC                                                      
*                                                                               
         L     R4,AIO3                                                          
         CLC   0(2,R4),=X'0D36'                                                 
         JE    UPDMK000                                                         
UPDMKER  GOTOR PUTERR,DMCB,('SE#SY003',SE#UNEXP)                                
         J     UPDMKXN                                                          
UPDMK000 L     R4,AIO5                                                          
         CLC   0(2,R4),=X'0D37'                                                 
         JNE   UPDMKER                                                          
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JL    UPDMK005                                                         
         SR    RE,RE                                                            
         ICM   RE,7,MOXKSTTN-MOXKEY(R4)      NETWORK RECORD?                    
         JZ    UPDMK003                       NO                                
         CLM   RE,7,MKBSTA                   SAME NETWORK?                      
         JE    UPDMK005                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOXSPFIL+IO5'                        
UPDMK003 GOTOR GETXOFFR,DMCB,MKBSTA  GET XSPOT OFFER-NETWORK RECORD             
*                                                                               
UPDMK005 ICM   RE,15,I$HIDOFF                                                   
         JZ    UPDMK010                                                         
         GOTOR HIDEOFFR                                                         
         J     UPDMKXY                                                          
*                                                                               
UPDMK010 ICM   RE,15,I$OFFNUM                                                   
         USING LW_D,RE                                                          
         MVC   SVOFFNUM,LW_DATA1                                                
         ICM   RE,15,I$RECNUM                                                   
         MVC   SVRECNUM,LW_DATA1                                                
*                                                                               
         OC    OFFERREC(OFFERRCL),OFFERREC    OFFER CHANGES?                    
         JZ    UPDMK215                                                         
*                                                                               
         LHI   R1,IOPUT+IOXSPFIL+IO5                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LHI   R1,IOPUT+IOFIL+IO5                                               
         BRAS  RE,ADDIOLST                                                      
*                                                                               
         MVC   IOADDR,AIO5                                                      
         L     RF,IOADDR                                                        
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MOMBELQ      X'20' FIND MAKEGOOD BUY ELEMENT              
         MVI   ELCDHI,MOMBELQ                                                   
         BRAS  RE,NEXTEL2                                                       
         J     *+8                                                              
*                                                                               
UPDMK015 BRAS  RE,NEXTEL                                                        
         JNE   UPDMKXN                                                          
         CLC   2(2,R4),OFFRECNM    MATCH OFFER/RECNUM                           
         JNE   UPDMK015                                                         
*                                                                               
         MVC   ELEM(128),0(R4)     SAVE OLD ELEMENT                             
         BRAS  RE,DELEL                                                         
*                                                                               
E        USING MOMBELD,ELEM                                                     
         ICM   RE,15,I$DAYPRT      TEST HAVE DAYPART CODE?                      
         JZ    UPDMK020                                                         
         MVI   E.MOMBDYPT,0                                                     
         CLC   LW_LN,=AL2(LW_LN1Q) MAP CODE ONLY?                               
         JE    UPDMK020                                                         
         MVC   E.MOMBDYPT,LW_DATA1                                              
*                                                                               
UPDMK020 ICM   RE,15,I$PRGNAM      TEST HAVE PROGRAM NAME?                      
         JZ    UPDMK030                                                         
         LH    R1,LW_LN            LENGTH OF ENTRY + L'FLDHDR                   
         AHI   R1,-(LW_LN1Q+1)     -(L'FLDHDR + 1 FOR EX)                       
         JM    UPDMK025            NO PROGRAM NAME                              
         MVC   E.MOMBPROG(0),LW_DATA1 MOVE IN PROGRAM NAME                      
         EX    R1,*-6                                                           
UPDMK025 AHI   R1,MOMBOVRH+1       + MOMBELD OVERHEAD + 1 FOR EX                
         STC   R1,E.MOMBLEN        UPDATE ELEM LENGTH                           
         DROP  E                                                                
*                                                                               
UPDMK030 BRAS  RE,VMKADDEL                                                      
         JE    UPDMK040                                                         
         TM    CURRFLAG,CRFERROR   WAS THERE AN ERROR?                          
         JO    UPDMKXN             -YES, EXIT                                   
         L     RF,IOADDR                                                        
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MOBDELQ      X'50' FIND CORRESPONDING 50 ELEM             
         MVI   ELCDHI,MOBDELQ                                                   
*                                                                               
UPDMK035 BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         CLC   2(2,R4),OFFRECNM    MATCH OFFER/RECNUM                           
         JNE   UPDMK035                                                         
         J     UPDMK030            GO BACK AND TRY AGAIN                        
*                                                                               
* UPDATE ADJACENCY CODE, COST2, REP CODE ELEM                                   
*                                                                               
UPDMK040 OC    NWMOMBS(NWMOMBLN),NWMOMBS   IF ANY OF THE 3 HAVE AN ADDR         
         JZ    UPDMK076                    NONE ARE SET                         
*                                                                               
* TEST SUPPLEMENTAL ELEM PRESENT                                                
UPDMK045 LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         MVC   ELEM(MOMBSLNQ),0(R4)  SAVE OLD ELEMENT                           
         CLI   0(R4),MOMBSELQ        MAKEGOOD BUY SUPPLEMENTAL ELEM             
         JE    UPDMK050                                                         
         XC    ELEM,ELEM                                                        
         MVI   ELEM,X'21'                                                       
         MVI   ELEM+1,MOMBSLNQ                                                  
         J     UPDMK055                                                         
*                                                                               
E        USING MOMBSELD,ELEM                                                    
UPDMK050 BRAS  RE,DELEL                                                         
*                                                                               
UPDMK055 ICM   RE,15,I$ADJCOD      TEST ADJACENCY CODE                          
         JZ    UPDMK060                                                         
         MVI   E.MOMBSADJ,0        CLEAR IT                                     
         CLC   LW_LN,=AL2(LW_LN1Q+1)                                            
         JL    UPDMK060            MAP CODE ONLY!                               
         MVC   E.MOMBSADJ,LW_DATA1 SET ADJ CODE IN ELEM                         
         JE    UPDMK060            ITS 1 CHAR                                   
         CLI   LW_DATA1+1,C' '     ANYTHING IN SECOND CHAR?                     
         JNH   UPDMK060            NOPE, ITS STILL 1 CHAR                       
         PACK  E.MOMBSADJ,LW_DATA1                                              
         NI    E.MOMBSADJ,X'F0'                                                 
         OI    HALF+1,X'F0'                                                     
         MVC   BYTE,LW_DATA1+1                                                  
         NI    BYTE,X'0F'                                                       
         OC    E.MOMBSADJ,BYTE                                                  
*                                                                               
UPDMK060 NI    E.MOMBSFLG,X'FF'-MOMBSC2Z  TAKE OFF ZERO COS2 BIT                
         ICM   RE,15,I$COST2       TEST COST2 PASSED IN                         
         JZ    UPDMK065            NONE                                         
*                                                                               
         XC    E.MOMBSCS2,E.MOMBSCS2  CLEAR IT                                  
         CLC   LW_LN,=AL2(LW_LN1Q)    MAP CODE ONLY?                            
         JE    UPDMK065               YES                                       
         MVC   E.MOMBSCS2,LW_DATA1    NO, WE HAVE A VALUE, SET IT               
*                                                                               
         OC    E.MOMBSCS2,E.MOMBSCS2  WAS IT A VALUE OF ZERO?                   
         JNZ   UPDMK065               NO                                        
         OI    E.MOMBSFLG,MOMBSC2Z      X'80' - COS2 VALUE OF ZERO              
*                                                                               
UPDMK065 ICM   RE,15,I$REPCOD      TEST REP CODE?                               
         JZ    UPDMK075                                                         
         XC    E.MOMBSREP,E.MOMBSREP                                            
         LH    R1,LW_LN            LENGTH OF ENTRY + L'FLDHDR                   
         AHI   R1,-(LW_LN1Q+1)     -(L'FLDHDR + 1 FOR EX)                       
         JM    UPDMK070                                                         
         MVC   WORK(0),LW_DATA1                                                 
         EX    R1,*-6                                                           
         OC    WORK(3),SPACES                                                   
UPDMK070 GOTOR VRCPACK,DMCB,(C'P',WORK),E.MOMBSREP                              
         JE    UPDMK075                                                         
         GOTOR PUTERR,DMCB,('SE#SY002',SE#INVRC)                                
         J     UPDMKXN                                                          
*                                                                               
UPDMK075 OC    E.MOMBSUP,E.MOMBSUP IS THE USER CLEARING EVERYTHING?             
         JZ    UPDMK076            YES, ALREADY DELETED, SKIP ADD               
         BRAS  RE,VMKADDEL                                                      
         TM    CURRFLAG,CRFERROR   WAS THERE AN ERROR?                          
         JO    UPDMKXN             -YES, EXIT                                   
         DROP  E                                                                
*                                                                               
UPDMK076 L     RF,ACLTREC                                                       
         USING CLTRECD,RF                                                       
         CLI   CPROF+9,C'0'        TEST ADJ CODE REQD                           
         JE    UPDMK080             NO                                          
         L     RF,IOADDR                                                        
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
*                                                                               
         MVI   ELCDLO,MOMBSELQ     X'21' FIND CORRESPONDING 21 ELEM             
         MVI   ELCDHI,MOMBSELQ                                                  
         BRAS  RE,NEXTEL                                                        
         JNE   *+12                                                             
         USING MOMBSELD,R4                                                      
         CLI   MOMBSADJ,0          DO WE HAVE AN ADJ-CODE?                      
         JNE   UPDMK080                                                         
         GOTOR PUTERR,DMCB,('SE#SY002',SE#MSADJ)                                
         J     UPDMKXN                                                          
         DROP  RF                                                               
*                                                                               
* UPDATE THE ORBIT ELEMENTS                                                     
*                                                                               
UPDMK080 ICM   RE,15,I$ORBITS      TEST ORBITS                                  
         JZ    UPDMK110                                                         
         ICM   R0,3,LW_NUMN                                                     
         LA    R3,LW_DATA2         POINT TO START OF INPUT ARRAY                
         USING ORBITD,R3                                                        
*                                                                               
         L     RF,IOADDR                                                        
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MORNELQ      X'41' MAKEGOOD ORBIT ELEMENT                 
         MVI   ELCDHI,MORNELQ                                                   
*                                                                               
UPDMK085 BRAS  RE,NEXTEL                                                        
         JNE   UPDMKXN                                                          
         USING MORNELD,R4                                                       
         CLC   OFFRECNM,MORNOFFR   MATCH OFFER/RECNUM                           
         JNE   UPDMK085                                                         
*                                                                               
         MVC   MORNPROG,OBTDESC    UPDATE ORBIT DESCRIPTION                     
         MVC   MORNDEM,OBTDEM      UPDATE ORBIT DEMO                            
*                                                                               
         OC    ESTDEMOS,ESTDEMOS   MUST HAVE EST DEMO LIST!!                    
         JZ    *+2                                                              
         MVC   BYTE,ESTDEMOS+1     SAVE DEMO TYPE (IF NSI)                      
         LLC   RF,ESTDEMOS+2                                                    
         ICM   RF,B'0010',ESTDEMOS BYTE1&3 ZERO, NON-TRADITIONAL?               
         LTR   RF,RF               HAVE NON-TRADITIONAL DEMO CAT?               
         JNZ   UPDMK090             NO, HAVE TRADITIONAL                        
*                                                                               
         LLC   RF,ESTDEMOS+1       GET INDEX                                    
         SHI   RF,1                SUB 1 FROM INDEX                             
         MHI   RF,L'ENONTDMS       MULTIPLE * L'ENTRY = OFFSET                  
         LA    RE,ESTNTDEM         RE=A(START OF NONTRAD DEMO LIST)             
         LA    RF,0(RF,RE)         RF=A(OFFSET INTO NONTRAD DEMO LIST)          
*                                                                               
         LA    RE,L'ESTNTDEM(RE)   RE=A(END OF NONTRAD DEMO LIST)               
         CR    RF,RE               BEYOND NONTRAD DEMO LIST?                    
         JNL   UPDMK105             YES, SKIP IT                                
         MVC   BYTE,0(RF)          SAVE COMSCORE DEMO TYPE                      
*                                                                               
UPDMK090 OC    LP_VRSN,LP_VRSN     HAVE SBTK VER#?                              
         JZ    *+14                 NO, SUPPORT 2-DEC IMPRESSION                
         CLC   LP_VRSN,V470037     SBTK VER# LT V4.7.0.37                       
         JL    UPDMK095             YES, CHECK 00 RATING PROFILE                
*                                                                               
         L     RF,LP_ATWA                                                       
         LA    RE,SVS00A2DI-TWAD(RF)  CHECK 2-DEC IMPS (00A) PROFILE            
         CLI   BYTE,C'R'           RATING                                       
         BE    UPDMK095                                                         
         CLI   BYTE,C'E'           OR EXTENDED                                  
         BNE   UPDMK100                                                         
UPDMK095 L     RF,LP_ATWA                                                       
         LA    RE,SVS002DP-TWAD(RF)   CHECK 2-DEC RATS (00) PROFILE             
*                                                                               
UPDMK100 CLI   0(RE),C'Y'          USING 2-PLACE PREC DEMO VALUES?              
         JNE   UPDMK105                                                         
*                                                                               
         CLI   BYTE,C'R'           RATING                                       
         BE    UPDMK104            YES, SKIP TEST                               
         CLI   BYTE,C'E'           OR EXTENDED                                  
         BE    UPDMK104            YES, SKIP TEST                               
*                                  HAVE IMPRESSION                              
         CLC   MORNDEM,=X'3FFF'    2-DEC IMPS TO BIG?                           
         BNH   UPDMK104            NO                                           
         LLH   RE,MORNDEM                                                       
         SRDA  RE,31                                                            
         LHI   R1,10                                                            
         DR    RE,R1                                                            
         AHI   RF,1                                                             
         SRA   RF,1                                                             
         STCM  RF,3,MORNDEM                                                     
         B     UPDMK105                                                         
*                                                                               
UPDMK104 OI    MORNDEM,X'40'       TURN ON 2 DECIMAL                            
*                                                                               
UPDMK105 LA    R3,OBTTABLN(R3)                                                  
         JCT   R0,UPDMK085                                                      
         DROP  R4,R3                                                            
*                                                                               
UPDMK110 DS    0H                                                               
         NI    MISCFLG1,X'FF'-MF1DEMDF                                          
         ICM   RE,15,I$DEMDFT                                                   
         JZ    UPDMK120                                                         
         USING LW_D,RE                                                          
         CLI   LW_DATA1,C'N'                                                    
         JE    UPDMK120                                                         
         OI    MISCFLG1,MF1DEMDF                                                
         CLI   LW_DATA1,C'Y'                                                    
         JE    UPDMK120                                                         
         GOTOR PUTERR,DMCB,('SE#SY002',SE#ININP)                                
         J     UPDMKXN                                                          
*                                                                               
* ADD DEMO ELEMENT X'5E' & X'60' ELEM                                           
*                                                                               
UPDMK120 BRAS  RE,UPDMKDEM                                                      
         JNE   UPDMKXN                                                          
*                                                                               
* ADD DEMO UPGRADE ELEM X'61' ELEM - CHECK IF UPGRADE                           
*                                                                               
UPDMK130 DS    0H                                                               
         ICM   RE,15,I$UPGFRM      ANY UPGRADE FORMULA?                         
         JZ    UPDMK140             NO, CHECK FOR BOOK                          
         OC    I$MGBOOK,I$MGBOOK    YES, HAVE BOOK OR BOOKTYPE?                 
         JNZ   UPDMK132              YES, SEND ERROR                            
         OC    I$MGBKTY,I$MGBKTY                                                
         JNZ   UPDMK132              YES, SEND ERROR                            
*                                                                               
         USING LW_D,RE                                                          
         XC    ELEM,ELEM                                                        
E        USING MOUPGELD,ELEM                                                    
         MVI   E.MOUPGEL,MOUPGELQ      X'61' ELEMENT                            
         MVI   E.MOUPGLEN,MOUPGOVH     SET LENGTH                               
         MVC   E.MOUPGOFR(2),OFFRECNM  OFFERNUM/RECNUM                          
         LH    RF,LW_LN                LENGTH OF ENTRY + L'FLDHDR               
         AHI   RF,-(LW_LN1Q+1)         -(L'FLDHDR + 1 FOR EX)                   
         JM    UPDMK150                                                         
*                                                                               
* DUE TO DEFECT IN SBTK V4.6.0.137 AND V4.6.0.157, WE NEED TO VALIDATE          
* THE UPGRADE TO PREVENT ISSUE WHEN THE MAKEGOOD IS APPLIED                     
*                                                       -HWON 9/13/2017         
         CLC   LW_DATA1(4),=C'UPP='    HAVE VALID UPGRADE?  UPP=?               
         JE    UPDMK135                 YES                                     
         CLC   LW_DATA1(4),=C'UPT='    OR UPT=?                                 
         JNE   UPDMK132                 NO, ERROR                               
         CLC   LW_DATA1(9),=X'E4D7E37ED7E4E36100'  IS IT !"UPT=PUT/_"           
         JNE   UPDMK135                             NO, THEN OK                 
UPDMK132 GOTOR PUTERR,DMCB,('SE#SY002',SE#INUPG)                                
         J     UPDMKXN                                                          
*                                                                               
UPDMK135 MVC   E.MOUPGTXT(0),LW_DATA1  SAVE UPGRADE TEXT                        
         EX    RF,*-6                                                           
         J     UPDMK150                                                         
         DROP  RE                                                               
*                                                                               
* ADD DEMO UPGRADE ELEM X'61' ELEM - CHECK IF BOOK & BOOKTYPE                   
*                                                                               
UPDMK140 ICM   RE,15,I$MGBOOK      ANY BOOK                                     
         JNZ   UPDMK142             YES                                         
         ICM   RE,15,I$MGBKTY       NO, BOOKTYPE WITHOUT BOOK?                  
         JZ    UPDMK160              NO, SKIP                                   
         GOTOR PUTERR,DMCB,('SE#SY002',SE#BKREQ)   SEND ERROR                   
         J     UPDMKXN                                                          
*                                                                               
         USING LW_D,RE                                                          
UPDMK142 XC    ELEM,ELEM                                                        
E        USING MOUPGELD,ELEM                                                    
         MVI   E.MOUPGEL,MOUPGELQ      X'61' ELEMENT                            
         MVI   E.MOUPGLEN,MOUPGOVH     SET LENGTH                               
         MVC   E.MOUPGOFR(2),OFFRECNM  OFFERNUM/RECNUM                          
         LH    RF,LW_LN                LENGTH OF ENTRY + L'FLDHDR               
         AHI   RF,-(LW_LN1Q+1)         -(L'FLDHDR + 1 FOR EX)                   
         JM    UPDMK150                                                         
         MVC   E.MOUPGBKH,=C'BK='                                               
         MVC   E.MOUPGBK(0),LW_DATA1  UPGRADE TEXT                              
         EX    RF,*-6                                                           
*                                                                               
         ICM   RE,15,I$MGBKTY         HAVE BOOKTYPE?                            
         JZ    UPDMK150                NO                                       
         LH    RF,LW_LN                LENGTH OF ENTRY + L'FLDHDR               
         AHI   RF,-(LW_LN1Q+1)         -(L'FLDHDR + 1 FOR EX)                   
         JM    UPDMK150                                                         
         MVI   E.MOUPGCOM,C','                                                  
         MVC   E.MOUPGBTH,=C'BT='                                               
         MVC   E.MOUPGBT(0),LW_DATA1  UPGRADE TEXT                              
         EX    RF,*-6                                                           
         DROP  RE                                                               
*                                                                               
UPDMK150 L     RF,IOADDR                                                        
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MOUPGELQ       X'61' ELEMENT                              
         MVI   ELCDHI,MOUPGELQ                                                  
*                                                                               
UPDMK152 BRAS  RE,NEXTEL                                                        
         JNE   UPDMK154                                                         
         CLC   2(2,R4),OFFRECNM                                                 
         JNE   UPDMK152                                                         
         BRAS  RE,DELEL            DELETE IT                                    
*                                                                               
UPDMK154 OC    E.MOUPGTXT,E.MOUPGTXT   DELETING THE UPGRADE?                    
         JZ    UPDMK160                                                         
         L     RF,IOADDR           PUT MOUPGEL AFTER LAST X'50' ELEM            
         LA    R4,MOXFRST-MOXKEY(RF)  AND AFTER X'60' IF PRESENT                
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MOBDELQ      X'50' FIND CORRESPONDING 50 ELEM             
         MVI   ELCDHI,MOBDELQ                                                   
*                                                                               
UPDMK156 BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         CLC   2(2,R4),OFFRECNM                                                 
         JNE   UPDMK156                                                         
*                                                                               
UPDMK158 LLC   R0,1(R4)            ADD UPGRADE ELEM AFTER X'50' ELEM            
         AR    R4,R0                AND AFTER X'5E' & X'60' IF PRESENT          
         CLI   0(R4),MONTELQ       X'5E' - NON-TRAD DEMO                        
         JE    UPDMK158                                                         
         CLI   0(R4),MODMELQ       X'60' - NIELSEN DEMO                         
         JE    UPDMK158                                                         
         BRAS  RE,VMKADDEL                                                      
         JE    UPDMK160                                                         
         TM    CURRFLAG,CRFERROR   WAS THERE AN ERROR?                          
         JO    UPDMKXN             -YES, EXIT                                   
         J     UPDMK154            GO BACK AND LOCATE AGAIN                     
*                                                                               
* ADD PURPOSE CODE ELEM                                                         
*                                                                               
UPDMK160 DS    0H                                                               
         ICM   RE,15,I$PURPCD      PURPOSE CODE?                                
         JZ    UPDMK185                                                         
         USING LW_D,RE                                                          
         XC    ELEM,ELEM                                                        
         MVI   ELEM,MOPRPELQ       X'63' ELEMENT                                
         MVI   ELEM+1,MOPRPLNQ     SET LENGTH                                   
         MVC   ELEM+2(2),OFFRECNM  OFFERNUM/RECNUM                              
         LH    RF,LW_LN            LENGTH OF ENTRY + L'FLDHDR                   
         AHI   RF,-(LW_LN1Q+1)     -(L'FLDHDR + 1 FOR EX)                       
         JM    UPDMK161                                                         
         MVC   ELEM+4(0),LW_DATA1  COMMENT TEXT                                 
         EX    RF,*-6                                                           
UPDMK161 OC    ELEM+4(6),SPACES                                                 
*                                                                               
         L     RF,IOADDR                                                        
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MOPRPELQ     X'63' - FIND PURPSE CODE ELEMENT             
         MVI   ELCDHI,MOPRPELQ                                                  
*                                                                               
UPDMK165 BRAS  RE,NEXTEL                                                        
         JNE   UPDMK170                                                         
         CLC   2(2,R4),OFFRECNM    MATCH OFFER/RECNUM                           
         JNE   UPDMK165                                                         
         BRAS  RE,DELEL            DELETE EXISTING                              
*                                                                               
UPDMK170 L     RF,IOADDR           PUT MOUPGEL AFTER LAST X'50' ELEM            
         LA    R4,MOXFRST-MOXKEY(RF)   AND AFTER X'60' IF PRESENT               
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MOBDELQ      X'50' FIND CORRESPONDING 50 ELEM             
         MVI   ELCDHI,MOBDELQ                                                   
*                                                                               
UPDMK175 BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         CLC   2(2,R4),OFFRECNM                                                 
         JNE   UPDMK175                                                         
*                                                                               
UPDMK180 LLC   R0,1(R4)            ADD UPGRADE ELEM AFTER X'50' ELEM            
         AR    R4,R0                AND AFTER X'5E,60,61' IF PRESENT            
         CLI   0(R4),MONTELQ       X'5E' - NON-TRAD DEMO                        
         JE    UPDMK180                                                         
         CLI   0(R4),MODMELQ       X'60' - NIELSEN DEMO                         
         JE    UPDMK180                                                         
         CLI   0(R4),MOUPGELQ      X'61' - UPGRADE                              
         JE    UPDMK180                                                         
         BRAS  RE,VMKADDEL                                                      
         JE    UPDMK185                                                         
         TM    CURRFLAG,CRFERROR   WAS THERE AN ERROR?                          
         JO    UPDMKXN             -YES, EXIT                                   
         J     UPDMK170            GO BACK AND LOCATE AGAIN                     
*                                                                               
* ADD REASON CODE ELEM                                                          
*                                                                               
UPDMK185 DS    0H                                                               
         ICM   RE,15,I$REASCD                                                   
         JZ    UPDMK210                                                         
         USING LW_D,RE                                                          
         XC    ELEM,ELEM                                                        
         MVI   ELEM,MORSNELQ       X'64' ELEMENT                                
         MVI   ELEM+1,MOPRPLNQ     SET LENGTH                                   
         MVC   ELEM+2(2),OFFRECNM  OFFERNUM/RECNUM                              
         MVC   ELEM+4(6),8(RE)     REASON CODE                                  
         OC    ELEM+4(6),SPACES                                                 
*                                                                               
         L     RF,IOADDR                                                        
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MORSNELQ     X'64' - FIND PURPSE CODE ELEMENT             
         MVI   ELCDHI,MORSNELQ                                                  
*                                                                               
UPDMK190 BRAS  RE,NEXTEL                                                        
         JNE   UPDMK195                                                         
         CLC   2(2,R4),OFFRECNM    MATCH OFFER/RECNUM                           
         JNE   UPDMK190                                                         
         BRAS  RE,DELEL            DELETE EXISTING                              
*                                                                               
UPDMK195 L     RF,IOADDR           PUT MOUPGEL AFTER LAST X'50' ELEM            
         LA    R4,MOXFRST-MOXKEY(RF)  AND AFTER X'60,61,63' IF PRESENT          
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MOBDELQ      X'50' FIND CORRESPONDING 50 ELEM             
         MVI   ELCDHI,MOBDELQ                                                   
*                                                                               
UPDMK200 BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         CLC   2(2,R4),OFFRECNM                                                 
         JNE   UPDMK200                                                         
*                                                                               
UPDMK205 LLC   R0,1(R4)            ADD UPGRADE ELEM AFTER X'50' ELEM            
         AR    R4,R0                AND AFTER X'5E,60,61,63' IF PRESENT         
         CLI   0(R4),MONTELQ       X'5E' - NON-TRAD DEMO                        
         JE    UPDMK205                                                         
         CLI   0(R4),MODMELQ       X'60' - NIELSEN DEMO                         
         JE    UPDMK205                                                         
         CLI   0(R4),MOUPGELQ      X'61' - UPGRADE                              
         JE    UPDMK205                                                         
         CLI   0(R4),MOPRPELQ      X'63' - PURPOSE CODE                         
         JE    UPDMK205                                                         
         BRAS  RE,VMKADDEL                                                      
         JE    UPDMK210                                                         
         TM    CURRFLAG,CRFERROR   WAS THERE AN ERROR?                          
         JO    UPDMKXN             -YES, EXIT                                   
         J     UPDMK195            GO BACK AND LOCATE AGAIN                     
*                                                                               
UPDMK210 DS    0H                                                               
*                                                                               
* ADD MAKEGOOD BUYER BUY COMMENTS                                               
*                                                                               
UPDMK215 DS    0H                                                               
         OC    I$COM1(OFFCOMLN),I$COM1  ANY COMMENT CHANGES?                    
         JZ    UPDMK300            NO                                           
         MVC   IOADDR,AIO5                                                      
         OC    OFF2ADDR,OFF2ADDR   TEST TWO RECORDS?                            
         JZ    UPDMK220            NO                                           
         MVC   IOADDR,AIO6                                                      
*                                                                               
* MOVE NEW COMMENTS TO UMKOIO                                                   
*                                                                               
UPDMK220 LA    R2,UMKOIO           CLEAR IO7 FOR OUR COMMENT BLOCK              
         LHI   R3,L'UMKOIO                                                      
         LR    RE,R3                                                            
         SR    RF,RF                                                            
         MVCL  R2,RE                                                            
*                                                                               
         XC    ELEM,ELEM                                                        
E        USING MOBBCELD,ELEM                                                    
         MVI   E.MOBBCEL,MOBBCELQ      X'70' MG BUYER BUY COMMENT ELEM          
         MVC   E.MOBBCOFR(2),OFFRECNM  OFFERNUM/RECNUM                          
         MVI   E.MOBBCSEQ,1            SET SEQUENCE NUMBER                      
         MVI   E.MOBBCLNE,1            SET COMMENT LINE NUMBER                  
*                                                                               
         LA    R2,UMKOIO                                                        
         LA    R3,I$COM1           POINT TO COMMENTS                            
UPDMK225 MVI   E.MOBBCLEN,0        SET LENGTH TO ZERO                           
         ICM   RE,15,0(R3)                                                      
         JZ    UPDMK235                                                         
         MVI   E.MOBBCLEN,MOBBCOVH SET LENGTH TO OVERHEAD                       
         LH    RF,LW_LN            LENGTH OF ENTRY + L'FLDHDR                   
         AHI   RF,-(LW_LN1Q+1)     -(L'FLDHDR + 1 FOR EX)                       
         JM    UPDMK230                                                         
         MVC   E.MOBBCTXT(0),LW_DATA1  COMMENT TEXT                             
         EX    RF,*-6                                                           
         AHI   RF,MOBBCOVH+1           ELEM OVERHEAD + 1 FOR EX                 
         STC   RF,E.MOBBCLEN                                                    
         DROP  RE                                                               
*                                                                               
UPDMK230 MVC   0(80,R2),ELEM              INITILIZE ELEM                        
UPDMK235 LA    R3,4(R3)            BUMP TO NEXT COMMENT FIELD                   
         LA    R2,80(R2)           BUMP TO NEXT SAVE COMMENT ENTRY              
         LLC   RF,E.MOBBCSEQ       GET SEQUENCE NUMBER                          
         AHI   RF,1                ADD 1                                        
         STC   RF,E.MOBBCSEQ       SET AS SEQ NUMBER                            
         STC   RF,E.MOBBCLNE       SET AS COMMENT LINE NUMBER TOO               
         CLI   E.MOBBCSEQ,5        REACHED MAX 5 COMMENTS?                      
         JNH   UPDMK225            NO, GO BACK                                  
         DROP  E                                                                
*                                                                               
* CHECK IF COMMENTS ARE BEING OVERWRITTEN                                       
* -  IF YES DELETE IT FROM RECORD                                               
* -  IF NO, COPY INTO UMKOIO AND DELETE IT FROM RECORD                          
*                                                                               
         L     RF,IOADDR                                                        
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MOBBCELQ    X'70' MAKEGOOD BUYER BUY COMMENT ELEM         
         MVI   ELCDHI,MOBBCELQ                                                  
         BRAS  RE,NEXTEL2                                                       
         J     *+8                                                              
*                                                                               
UPDMK240 BRAS  RE,NEXTEL                                                        
         JNE   UPDMK270                                                         
*                                                                               
         USING MOBBCELD,R4                                                      
UPDMK245 CLC   MOBBCOFR(2),OFFRECNM   MATCH ON OFFER/REC #                      
         JNE   UPDMK240               NO                                        
UPDMK250 LA    R2,UMKOIO                                                        
         LLC   RE,MOBBCSEQ         RE = COMMENT#/SEQ#                           
         BCTR  RE,0                                                             
         MHI   RE,80               MULTIPLY BY 80, SIZE OF ENTRY                
         LA    R2,0(RE,R2)         BUMP TO N-TH SAVE COMMENT ENTRY              
E        USING MOBBCELD,R2                                                      
         CLI   E.MOBBCLEN,0        IS IT BEING REPLACED?                        
         JNE   UPDMK255            YES, DON'T SAVE IT                           
         LLC   RF,1(R4)                                                         
         BCTR  RF,0                                                             
         MVC   E.MOBBCEL(0),MOBBCEL   NO, SAVE IT                               
         EX    RF,*-6                                                           
         DROP  E                                                                
*                                                                               
UPDMK255 BRAS  RE,DELEL            DELETE COMMENTS FOR THIS REC/NUM             
         CLI   0(R4),MOBBCELQ      TEST ANOTHER X'70' COMMENT                   
         JNE   UPDMK270                                                         
         CLC   MOBBCOFR(2),OFFRECNM   MATCH ON OFFER/REC #                      
         JE    UPDMK250                                                         
         DROP  R4                                                               
*                                                                               
* LETS ADD BACK OUR NEW COMMENTS TO THE END OF THE RECORD                       
*                                                                               
UPDMK270 BRAS  RE,FINDEOR          R4 = A(EOR)                                  
*                                                                               
         LA    R2,UMKOIO           POINT TO FIRST COMMENTS                      
         USING MOBBCELD,R2                                                      
UPDMK275 CLI   MOBBCLEN,MOBBCOVH   DOES THIS HAVE COMMENTS                      
         JNH   UPDMK285                                                         
         MVC   ELEM(80),MOBBCEL    COMMENT TEXT                                 
*                                                                               
UPDMK280 BRAS  RE,VMKADDEL                                                      
* ASSUME ELEM ADDED, FIND EOR AND GET NEXT COMMENT                              
         LA    RE,UPDMK285                                                      
         JE    FINDEOR             ELEM ADDED                                   
         TM    CURRFLAG,CRFERROR   WAS THERE AN ERROR?                          
         JO    UPDMKXN             -YES, EXIT                                   
* RECORD JUST SPLIT - NEED TO ADD, FIND EOR AND ADD ELEMENT                     
         LA    RE,UPDMK280                                                      
FINDEOR  L     RF,IOADDR                                                        
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
FEOR10   CLI   0(R4),0             FIND EOR                                     
         BER   RE                  R4 = A(EOR)                                  
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         J     FEOR10                                                           
*                                                                               
UPDMK285 LA    R2,80(R2)           BUMP TO NEXT COMMENT FIELD                   
         CLI   0(R2),0             ANY MORE COMMENTS TO ADD                     
         JNE   UPDMK275            YES                                          
         TM    MISCFLG1,MF1RECNF                                                
         JO    UPDMK290                                                         
         OC    OFF2ADDR,OFF2ADDR   TEST TWO RECORDS?                            
         JZ    UPDMK295                                                         
         LHI   R1,IOPUT+IOXSPFIL+IO6                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LHI   R1,IOPUT+IOFIL+IO6                                               
         BRAS  RE,ADDIOLST                                                      
         J     UPDMK300                                                         
*                                                                               
UPDMK290 LHI   R1,IOADDREC+IOXSPFIL+IO6                                         
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LHI   R1,IOADDREC+IOFIL+IO6                                            
         BRAS  RE,ADDIOLST                                                      
*                                                                               
UPDMK295 LHI   R1,IOPUT+IOXSPFIL+IO5                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LHI   R1,IOPUT+IOFIL+IO5                                               
         BRAS  RE,ADDIOLST                                                      
*                                                                               
UPDMK300 CLI   MKBSTA,X'E8'        CABLE?                                       
         JL    UPDMKXY                                                          
*                                                                               
         LA    R1,IOKEY                                                         
         USING MOXKEY,R1                                                        
         XC    IOKEY,IOKEY                                                      
         MVI   MOXKTYPE,MOXKTYPQ                                                
         MVI   MOXKSBTY,MOXKSBTQ                                                
         MVC   MOXKAGMD,SVBAGM                                                  
         MVC   MOXKORDR,BINORDER                                                
         MVC   MOXKMGCD,MKGRPCOD                                                
         OC    MOXKMGCD,SPACES                                                  
*                                                                               
         L     RE,AIO4                                                          
         CLC   MOXKEY,0(RE)        SAME RECORD?                                 
         JE    UPDMKXY              YES, DON'T DO IT AGAIN                      
*                                                                               
* JUST A WARNING, WE ARE DELIBERATELY READING INTO AIO4 EVEN THOUGH             
* THE RECORDS ARE DEFINED AS 6K. BUT WE SHOULD BE SAFE, SINCE THE BASE          
* OFFER RECORD SHOULD NOT BE THAT BIG.   5/20/2014 -HWON                        
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOXSPDIR+IO4'                            
         JNE   *+2                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOXSPFIL+IO4'                        
         JNE   *+2                                                              
         MVC   IOADDR,AIO4                                                      
*                                                                               
         THMS  DDSTIME=YES                                                      
         STCM  R0,15,PACKOF4B                                                   
         ST    R1,FULL                                                          
         AP    PACKOF4B,FULL                                                    
                                                                                
         GOTOR VDATCON,DMCB,(5,0),(0,DUB)   THE TIME                            
         CP    PACKOF4B,=P'240000'    PAST MIDNIGHT?                            
         JL    UPDMK310                                                         
         SP    PACKOF4B,=P'240000'    YES, BUMP TO NEXT DAY AND ADJUST          
         GOTOR VADDAY,DMCB,DUB,DUB,F'1'                                         
*                                                                               
UPDMK310 L     RF,AIO4                                                          
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         MVI   ELCDLO,MOACTELQ    X'F0' ACTIVITY                                
         MVI   ELCDHI,MOACTELQ                                                  
         BRAS  RE,NEXTEL2                                                       
         JE    UPDMK320                                                         
*                                                                               
E        USING MOACTELD,ELEM                                                    
         XC    ELEM,ELEM                                                        
         MVI   E.MOACTEL,MOACTELQ  X'F0' ACTIVITY                               
         MVI   E.MOACTLEN,MOACTLNQ SET LENGTH                                   
         GOTOR VDATCON,DMCB,(0,DUB),(19,E.MOACTCDT)                             
         ICM   R1,15,PACKOF4B                                                   
         SRL   R1,12               GET RID OF SECONDS AND SIGN                  
         STCM  R1,3,E.MOACTCTM                                                  
         BRAS  RE,VMKADDEL                                                      
         JE    UPDMK330                                                         
         TM    CURRFLAG,CRFERROR   WAS THERE AN ERROR?                          
         JO    UPDMKXN             -YES, EXIT                                   
         J     UPDMK330                                                         
         DROP  E                                                                
*                                                                               
         USING MOACTELD,R4                                                      
UPDMK320 GOTOR VDATCON,DMCB,(0,DUB),(19,MOACTGDT)                               
         ICM   R1,15,PACKOF4B                                                   
         SRL   R1,12               GET RID OF SECONDS AND SIGN                  
         STCM  R1,3,MOACTGTM                                                    
         DROP  R4                                                               
*                                                                               
UPDMK330 GOTOR ADDIOLST,'IOPUT+IOXSPFIL+IO4'                                    
*                                                                               
UPDMKXY  J     EXITY                                                            
UPDMKXN  J     EXITN                                                            
         DROP  RC                                                               
*                                                                               
UMKOWRKD DSECT                                                                  
UMKOIO   DS    XL2000                                                           
UMKOWRKL EQU   *-UMKOWRKD                                                       
*                                                                               
DEMOD    DSECT                                                                  
DEMDEF   DS    XL(L'ENONTDMS)                                                   
DEMVALUE DS    XL(L'NDEMRAW)                                                    
DEMOVRD  DS    C                                                                
DEMNTFL1 DS    C                   DEMO DOES NOT REQUIRE LKUP?                  
DEMNTFL2 DS    C                   DEMO IS N/A?                                 
DEMTABLN EQU   *-DEMOD                                                          
*                                                                               
ORBITD   DSECT                                                                  
OBTDESC  DS    CL(L'MORNPROG)                                                   
OBTDEM   DS    XL(L'MORNDEM)                                                    
OBTTABLN EQU   *-ORBITD                                                         
SVRDEF   CSECT                                                                  
*                                                                               
DELEL    LR    R0,RE                                                            
         MVI   BYTE,C'T'                                                        
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         MVI   BYTE,C'S'                                                        
         GOTOR ARECUP,DMCB,(BYTE,IOADDR),(R4)                                   
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
UPDMKDEM NTR1  LABEL=*                                                          
*                                                                               
         XC    ELEM,ELEM                                                        
         XC    ELEM2,ELEM2                                                      
*                                                                               
         TM    MISCFLG1,MF1DEMDF   RETURN DEMOS TO DEFAULT VALUES?              
         JO    UPDMKD50             YES                                         
*                                                                               
         ICM   RE,15,I$OFFDEM      ANY DEMOS?                                   
         JZ    UPDMKDXY            NO                                           
         USING LW_D,RE                                                          
         XR    R4,R4                                                            
         ICM   R4,3,LW_NUMN        R4=# OF DEMO TO PROCESS                      
         USING DEMOD,R3                                                         
         LA    R3,LW_DATA2         R3=A(START OF INPUT ARRAY)                   
         DROP  RE                                                               
*                                                                               
         LA    R2,ELEM2+4          R2=(X'60' MODMELD)                           
         USING MODMDEMO,R2                                                      
         LA    R5,ELEM+4           R5=(X'5E' MONTELD)                           
         USING MONTDEMO,R5                                                      
*                                                                               
UPDMKD10 CLC   DEMDEF,SPACES       VALID DEMO NAME?                             
         JNH   COEINVDM             NO                                          
         XC    FULL,FULL                                                        
         GOTOR VALDCD,DMCB,DEMDEF,(0,L'DEMDEF),FULL                             
         JNE   COEINVDM                                                         
*                                                                               
** NOTE ***************************************************************         
* FOR ALL MEDIA (T, R, X), SBTK <4.7.0.37 INCORRECTLY SAVES ALL DEMO            
*  VALUES (RATS & IMPS) BASED ON SVS002DP PROFILE.                              
*     IE. IF SVS002DP IS Y, ALL DEMO VALUES ARE 2-DEC, ELSE 1-DEC               
*                                                                               
* **EXCEPTION CODE FOR MEDIA R/X NOT ADDED B/C NO MAKEGOODS                     
***********************************************************************         
*                                                                               
* CODE ADJUST DEMO VALUE PRECISION                                              
*                                                                               
         L     RF,LP_ATWA                                                       
         USING TWAD,RF                                                          
         LA    RE,SVS002DP         USING 2-PLACE PRECISION DEC RATS             
         OC    LP_VRSN,LP_VRSN     HAVE SBTK VER#?                              
         JZ    *+14                 NO, SUPPORT 2-DEC IMPRESSION                
         CLC   LP_VRSN,V470037     SBTK VER# LT V4.7.0.37                       
         JL    UPDMKD15             YES, ONLY CHECK 00 RATING PROFILE           
*                                                                               
         CLI   DEMDEF,C'R'         IF RATING                                    
         JE    UPDMKD15             YES, CHECK 00 2-DEC RATS PROF               
         CLI   DEMDEF,C'E'         OR EXTENDED RATING                           
         JE    UPDMKD15             YES, CHECK 00 2-DEC RATS PROF               
         LA    RE,SVS00A2DI         ELSE, CHECK 00A 2-DEC IMPS PROF             
         DROP  RF                                                               
*                                                                               
UPDMKD15 CLI   0(RE),C'Y'          USING 2-PLACE PREC DEMO VALUES?              
         JE    UPDMKD20            NO                                           
         ICM   RF,15,DEMVALUE      DEM VALUE 0?                                 
         JZ    UPDMKD25             YES, DON'T NEED TO CONVERT                  
         SR    RE,RE               ROUND 2-DEC TO 1-DEC PRECISION               
         M     RE,=F'2'                                                         
         D     RE,=F'10'                                                        
         AHI   RF,1                                                             
         SRL   RF,1                                                             
         STCM  RF,15,DEMVALUE                                                   
         J     UPDMKD25                                                         
*                                                                               
UPDMKD20 OI    DEMVALUE,MODM2DEC   TURN ON 2-PLACE PRECISION                    
*                                                                               
UPDMKD25 CLI   DEMOVRD,C'Y'        ITS AN OVERRIDE?                             
         JNE   *+8                                                              
         OI    DEMVALUE,X'80'      SET OVERRIDE IND                             
*                                                                               
* DETERMINE IF WE ARE PROCESSING A TRAD OR NON-TRAD DEMO AND                    
*  UPDATE ELEM2 OR ELEM RESPECTIVELY                                            
*                                                                               
         CLI   FULL+2,0            NON-TRAD DEMO?                               
         JE    UPDMKD30             YES                                         
*                                                                               
* UPDATE TRADITIONAL DEMO ELEM IN ELEM2                                         
*                                                                               
         MVC   MDEMNO,FULL         SET DEMO CATEGORY                            
         MVC   MDEMRAW,DEMVALUE    SET DEMO VALUE                               
         MVI   MDSVI,100           SET HUT VALUE = 100                          
         LA    R2,L'MODMDEMO(R2)                                                
         J     UPDMKD40                                                         
         DROP  R2                                                               
*                                                                               
* UPDATE NON-TRADITIONAL DEMO ELEM IN ELEM                                      
*                                                                               
UPDMKD30 MVC   MONTBDMO,FULL       SET DEMO CATEGORY                            
         MVC   MONTDVAL,DEMVALUE   SET DEMO VALUE                               
         MVI   MONTHUTA,100        SET HUT VALUE = 100                          
         CLI   DEMNTFL1,C'Y'       NT-DEMO DOESNT REQ LOOKUP?                   
         JNE   *+8                                                              
         OI    MONTFLG1,MONT1NLK   YES, SET X'80'                               
         CLI   DEMNTFL2,C'Y'       NT-DEMO IS N/A?                              
         JNE   *+8                                                              
         OI    MONTFLG1,MONT1NA    YES, SET X'40'                               
         LA    R5,L'MONTDEMO(R5)                                                
         DROP  R5                                                               
*                                                                               
UPDMKD40 LA    R3,DEMTABLN(R3)     BUMP TO NEXT DEMO TO PROCESS                 
         JCT   R4,UPDMKD10         DEC # OF DEMOS LEFT TO PROCESS               
*                                                                               
         OC    ELEM2,ELEM2         DID USER UPDATE X'60'?                       
         JZ    UPDMKD45             NO, SKIP                                    
         MVI   ELEM2,MODMELQ       X'60' - TRAD DEMO                            
         MVC   ELEM2+2(2),OFFRECNM OFFER/RECORD NUMBER                          
         LA    RE,ELEM2                                                         
         SR    R2,RE                                                            
         CHI   R2,255              IS THE ELEM LENGTH TO LARGE?                 
         JH    *+2                                                              
         STC   R2,ELEM2+1                                                       
*                                                                               
UPDMKD45 OC    ELEM,ELEM           DID USER UPDATE X'5E'?                       
         JZ    UPDMKD50             NO, SKIP                                    
         MVI   ELEM,MONTELQ        X'5E' - NON-TRAD DEMO                        
         MVC   ELEM+2(2),OFFRECNM  OFFER/RECORD NUMBER                          
         LA    RE,ELEM                                                          
         SR    R5,RE                                                            
         CHI   R5,255              IS THE ELEM LENGTH TO LARGE?                 
         JH    *+2                                                              
         STC   R5,ELEM+1                                                        
*                                                                               
* DONE PROCESSING DEMO VALUES, LETS UPDATE MKGD OFFER RECORD                    
*                                                                               
* UPDATE X'5E' IN MKGD OFFER RECORD                                             
*                                                                               
UPDMKD50 L     RF,IOADDR           PUT X'5E' AFTER LAST X'50' ELEM              
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MOBDELQ      X'50' FIND CORRESPONDING 50 ELEM             
         MVI   ELCDHI,MOBDELQ                                                   
*                                                                               
UPDMKD55 BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         CLC   2(2,R4),OFFRECNM    MATCH ON OFFER/REC NUMBER                    
         JNE   UPDMKD55                                                         
         LLC   RE,1(R4)            ADD UPGRADE ELEM AFTER X'50' ELEM            
         LA    R4,0(RE,R4)          AND AFTER X'60' IF PRESENT                  
*                                                                               
         CLI   0(R4),MONTELQ       REC HAS X'5E' NON-TRAD MG DEMOS?             
         JNE   UPDMKD65             NO, LETS ADD OUR X'5E'                      
         TM    MISCFLG1,MF1DEMDF   RETURN DEMOS TO DEFAULT VALUES?              
         JNZ   UPDMKD60             YES, DELETE X'5E' FROM OFFER REC            
         OC    ELEM,ELEM           DID USER UPDATE X'5E'?                       
         JZ    UPDMKD70             NO                                          
UPDMKD60 BRAS  RE,DELEL            DELETE IT                                    
*                                                                               
UPDMKD65 TM    MISCFLG1,MF1DEMDF   RETURN DEMOS TO DEFAULT VALUES?              
         JNZ   UPDMKD70             YES, DON'T ADD X'5E' TO OFFER REC           
         OC    ELEM,ELEM           DID USER UPDATE X'5E'?                       
         JZ    UPDMKD70             NO                                          
         BRAS  RE,VMKADDEL         ERROR ADDING X'5E' TO OFFER REC?             
         JE    UPDMKD70             NO                                          
         TM    CURRFLAG,CRFERROR   WAS THERE AN ERROR?                          
         JZ    UPDMKD50             NO, GO BACK AND LOCATE AGAIN                
         J     UPDMKDXN             YES, EXIT                                   
*                                                                               
* UPDATE X'60' IN MKGD OFFER RECORD                                             
*                                                                               
UPDMKD70 L     RF,IOADDR           PUT X'60' AFTER LAST X'50' ELEM              
         LA    R4,MOXFRST-MOXKEY(RF)                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    R4,MORFRST-MOKEY(RF)                                             
         MVI   ELCDLO,MOBDELQ      X'50' FIND CORRESPONDING 50 ELEM             
         MVI   ELCDHI,MOBDELQ                                                   
*                                                                               
UPDMKD75 BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         CLC   2(2,R4),OFFRECNM    MATCH ON OFFER/REC NUMBER                    
         JNE   UPDMKD75                                                         
UPDMKD76 LLC   R0,1(R4)            ADD UPGRADE ELEM AFTER X'50' ELEM            
         AR    R4,R0                                                            
         CLI   0(R4),MONTELQ        AND AFTER X'5E' IF PRESENT                  
         JE    UPDMKD76                                                         
*                                                                               
         CLI   0(R4),MODMELQ       X'60' TRAD MG DEMO?                          
         JNE   UPDMKD85                                                         
         TM    MISCFLG1,MF1DEMDF   RETURN DEMOS TO DEFAULT VALUES?              
         JNZ   UPDMKD80             YES, DELETE X'60' FROM OFFER REC            
         OC    ELEM2,ELEM2         DID USER UPDATE X'60'?                       
         JZ    UPDMKDXY            NO, DONE                                     
UPDMKD80 BRAS  RE,DELEL            DELETE IT                                    
*                                                                               
UPDMKD85 TM    MISCFLG1,MF1DEMDF   RETURN DEMOS TO DEFAULT VALUES?              
         JNZ   UPDMKDXY             YES, DON'T ADD X'60' TO OFFER REC           
         OC    ELEM2,ELEM2         DID USER UPDATE X'60'?                       
         JZ    UPDMKDXY            NO, DONE                                     
         MVC   ELEM,ELEM2                                                       
         BRAS  RE,VMKADDEL         ERROR ADDING X'60' TO OFFER REC?             
         JE    UPDMKDXY             NO                                          
         TM    CURRFLAG,CRFERROR   WAS THERE AN ERROR?                          
         JZ    UPDMKD70             NO, GO BACK AND LOCATE AGAIN                
UPDMKDXN J     EXITN               -YES, EXIT                                   
UPDMKDXY J     EXITY                                                            
*                                                                               
VMKADDEL NTR1  LABEL=*                                                          
*                                                                               
         GOTOR ARECUP,DMCB,(C'S',IOADDR),ELEM,(C'R',(R4))                       
         ORG   *-2                                                              
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JL    VMKADD2                                                          
* WE CAN'T USE THE C'T' IN THE 1ST PARAM BECAUSE RECUP WAS NOT CHANGED          
*  TO USE THE MAX RECORD SIZE THAT DMFILTAB HAS FOR XSPFIL                      
         MVI   0(R1),X'FE'                                                      
         LA    RE,XSPREC                                                        
         ST    RE,12(R1)                                                        
VMKADD2  BASR  RE,RF                                                            
         CLI   8(R1),C'R'          TEST OVERFLOW                                
         JE    EXITY               ARECUP RETURNS R ON OK/0 FOR ERROR           
         OC    OFF2ADDR,OFF2ADDR   RECORD SPLIT ALREADY                         
         JZ    VMKADD4             NO                                           
VMKERR   GOTOR PUTERR,DMCB,('SE#SY003',SE#TOMCH)                                
         J     EXITN               TOO MUCH DATA                                
         SPACE 1                                                                
*==================================================================             
* COPY AIO5 TO AIO6. DELETE ALL X'70' COMMENTS FROM AIO5                        
*                    DELETE ALL BUT X'70' ELEMENTS FROM AIO6                    
* REC3 WILL BE PUT BACK TO THE FILE AND                                         
* REC4 WILL BE ADDED TO THE FILE                                                
* NOTE THAT IF WE GET THIS FAR, CURRENT RECORD MUST BE AIO5 SINCE               
* SECOND RECORD DID NOT EXIST                                                   
*==================================================================             
         SPACE 1                                                                
VMKADD4  L     RE,AIO5                                                          
         LHI   RF,IO5LQ                                                         
         L     R0,AIO6                                                          
         LR    R1,RF                                                            
         MVCL  R0,RE               MOVE TO AIO6 FROM AIO5                       
         L     R4,AIO5                                                          
         LA    R4,24(R4)                                                        
*                                                                               
VMKADD10 CLI   0(R4),0             EOR?                                         
         JE    VMKADD20                                                         
         CLI   0(R4),MOBBCELQ      X'70'                                        
         JNE   VMKADD12                                                         
         GOTOR ARECUP,DMCB,AIO5,(R4)                                            
         J     VMKADD10                                                         
*                                                                               
VMKADD12 LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         J     VMKADD10                                                         
*                                                                               
VMKADD20 L     R4,AIO6                                                          
         LLC   R0,MOKSEQ-MOKEY(R4)                                              
         AHI   R0,1                BUMP SEQUENCE NUMBER                         
         STC   R0,MOKSEQ-MOKEY(R4)                                              
         LA    R4,24(R4)                                                        
*                                                                               
VMKADD22 CLI   0(R4),0             EOR?                                         
         JE    VMKADD30                                                         
         CLI   0(R4),MOBBCELQ      X'70'                                        
         JE    VMKADD24                                                         
         GOTOR ARECUP,DMCB,AIO6,(R4)                                            
         J     VMKADD22                                                         
*                                                                               
VMKADD24 LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         J     VMKADD22                                                         
*                                                                               
VMKADD30 L     R4,AIO6                                                          
         LA    R4,24(R4)                                                        
         CLI   0(R4),0             SHOULD HAVE AT LEAST ONE COMMENT             
         JE    VMKERR                                                           
         OI    MISCFLG1,MF1RECNF                                                
*                                                                               
         MVC   IOADDR,AIO6                                                      
         CLI   ELEM,MOBBCELQ       PROCESSING X'70' COMMENT?                    
         JE    EXITN                YES, THEN PASS BACK AIO6                    
         MVC   IOADDR,AIO5          OTHERWISE, PASS BACK AIO5                   
         J     EXITN               AND GO FIND OUT WHERE TO ADD ELEM            
         EJECT                                                                  
*                                                                               
***********************************************************************         
* HIDE/UNHIDE OFFER                                                             
***********************************************************************         
HIDEOFFR NTR1  LABEL=*                                                          
*                                                                               
         L     R4,AIO3                                                          
         CLC   0(2,R4),=X'0D36'                                                 
         JE    HIOF005                                                          
         GOTOR PUTERR,DMCB,('SE#SY003',SE#UNEXP)                                
         J     EXITN                                                            
*                                                                               
         USING DAREMGND,R4                                                      
HIOF005  ICM   RE,15,I$HIDOFF                                                   
         USING LW_D,RE                                                          
         CLI   LW_DATA1,C'H'       IS THIS HIDE?                                
         JNE   HIOF010                                                          
         SR    R1,R1                                                            
         LA    RF,MNXRSTAT                                                      
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    RF,MNRSTAT2                                                      
         ICM   R1,3,0(RF)                                                       
         O     R1,=X'00008000'     SET IT HIDDEN                                
         STCM  R1,3,0(RF)                                                       
*                                                                               
HIOF010  CLI   LW_DATA1,C'U'       IS THIS UN-HIDE?                             
         JNE   HIOF020                                                          
         SR    R1,R1                                                            
         LA    RF,MNXRSTAT                                                      
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LA    RF,MNRSTAT2                                                      
         ICM   R1,3,0(RF)                                                       
         N     R1,=X'FFFF7FFF'     SET IT UNHIDDEN                              
         STCM  R1,3,0(RF)                                                       
         DROP  RE                                                               
*                                                                               
HIOF020  LHI   R1,IOPUT+IOXSPFIL+IO3                                            
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JNL   *+8                                                              
         LHI   R1,IOPUT+IOFIL+IO3                                               
         BRAS  RE,ADDIOLST                                                      
         J     EXITY                                                            
         DROP  RB                                                               
         EJECT                                                                  
*                                                                               
***********************************************************************         
* MARK ORDER STATUS UPDATE                                                      
***********************************************************************         
OREXSTAT NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,AIO3                                                          
         CLC   0(2,R4),=X'0D34'                                                 
         JE    OED010                                                           
         GOTOR PUTERR,DMCB,('SE#SY003',SE#UNEXP)                                
         J     OEDNO                                                            
*                                                                               
OED010   DS    0H                                                               
         BRAS  RE,CHKDSEOC         CHECK DSTA END OF CONTRACT                   
         JNE   OEDNO               YES, DON'T ALLOW ADD                         
*                                                                               
         CLI   STATTYPE,DSENT      X'81' - *SENT/*CANCEL/*RESEND?               
         JNE   OED020                                                           
         BRAS  RE,OEDSNDG                                                       
         J     OEDCC                                                            
*                                                                               
OED020   CLI   STATTYPE,DDLVRD     X'82' - MARK ORDER DELIVERED                 
         JNE   OED030                                                           
         BRAS  RE,OEDSENT                                                       
         J     OEDCC                                                            
*                                                                               
OED030   CLI   STATTYPE,C'L'       ROLLBACK ORDER?                              
         JNE   OEDNO                                                            
         BRAS  RE,OEDRLBK                                                       
         J     OEDCC                                                            
*                                                                               
OEDCC    J     EXITCC                                                           
OEDNO    J     EXITN                                                            
         EJECT                                                                  
*=================================================================              
* MARK ORDER *SENT/*CANCEL/*RESEND VIA ORDER EXPORT/EXPRESS                     
*=================================================================              
OEDSNDG  NTR1  BASE=*,LABEL=*                                                   
         OC    STATDATE,STATDATE                                                
         JNZ   OES105                                                           
         OC    STATTIME,STATTIME                                                
         JNZ   OES105                                                           
         THMS  DDSTIME=YES                                                      
         STCM  R0,15,PACKOF4B                                                   
         ST    R1,FULL                                                          
         AP    PACKOF4B,FULL                                                    
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(0,DUB)   THE TIME                            
         CP    PACKOF4B,=P'240000'    PAST MIDNIGHT?                            
         JL    OES100                                                           
         SP    PACKOF4B,=P'240000'    YES, BUMP TO NEXT DAY AND ADJUST          
         GOTOR VADDAY,DMCB,DUB,DUB,F'1'                                         
                                                                                
OES100   GOTOR VDATCON,DMCB,(0,DUB),(19,STATDATE)                               
         ICM   R1,15,PACKOF4B                                                   
         SRL   R1,12               GET RID OF SECONDS AND SIGN                  
         STCM  R1,3,STATTIME                                                    
*                                                                               
OES105   L     R4,AIO3                                                          
         MVI   ELCDLO,DOWIGELQ       X'50' STATUS ELEMENT                       
         MVI   ELCDHI,DOWIGELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   OESNOSNT                                                         
         CLI   DOWIGMTH-DOWIGEL(R4),C'E' EMAIL?                                 
         JE    OES110                                                           
OESNOSNT GOTOR PUTERR,DMCB,('SE#SY023',SE#NOSNT)                                
         J     OESNO                                                            
*                                                                               
OES110   L     R4,AIO3                                                          
         USING DAREORDD,R4                                                      
         MVC   BINORDER,DOKORDER                                                
         MVC   SVBAGM,DOKAGMD                                                   
         GOTOR (#EDTMED,AEDTMED),DMCB,SVBAGM,0,SVMED                            
         JNE   *+2                                                              
*                                                                               
XM       USING DOXMTELD,DOXMELEM                                                
         XC    DOXMELEM,DOXMELEM                                                
         MVI   XM.DOXMTEL,DOXMTELQ                                              
         MVI   XM.DOXMTLEN,DOXMTLNQ                                             
         MVC   XM.DOXMTYMD,STATDATE   DATE                                      
         MVC   XM.DOXMTTIM,STATTIME   TIME                                      
         MVC   XM.DOXMTOID,SVBORGID   ORIGIN ID                                 
*                                                                               
         NI    MISCFLG2,X'FF'-MF2NTDAR                                          
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)  R4 = A(FIRST ELEMENT IN RECORD)            
         USING DOIDELD,R4                                                       
         MVC   SVQBYR,DOIDBYR                                                   
         MVC   SVBSTA,DOISTA                                                    
         MVC   SVBPRD,DOIDPRD                                                   
         MVC   SVBPR2,DOIDPRD2                                                  
         MVC   SVBCLT,DOIDCLT                                                   
         MVC   SVBFLT,DOIDFLTN                                                  
         MVC   SVBEST,DOIDEST                                                   
         DROP  R4                                                               
*                                                                               
         MVC   QCLTX,SVBCLT                                                     
         GOTOR (#GETCLT,AGETCLT)   READ CLIENT RECORD                           
         L     RF,ACLTREC                                                       
         USING CLTRECD,RF          R3=A(CLIENT RECORD)                          
         TM    COPT4,COP4TRD       IS THIS A TRADE CLIENT                       
         JZ    *+8                                                              
         OI    CLTFLAG1,CLTTRADE                                                
         DROP  RF                                                               
*                                                                               
         GOTOR (#EDTPRD,AEDTPRD),DMCB,SVBPRD,0,SVQPRD                           
*                                                                               
         BRAS  RE,GETPROFS                                                      
*                                                                               
         BRAS  RE,GTESTINF         GET ESTIMATE INFO                            
*                                                                               
         GOTOR GTFLTINF,DMCB,(C'L',0)  GET FLT REC AIO8 & SET FLT LOCK          
         JNE   OES115                                                           
         CLI   SVBFLT,0            HAVE FLIGHT                                  
         JE    OES120                                                           
         TM    FLTRCFLG,FRFEXIST   FLIGHT RECORD FOUND?                         
         JNZ   OES120                YES                                        
OES115   GOTOR PUTERR,DMCB,('SE#SY023',SE#INVFL)                                
         J     OESNO                                                            
*                                                                               
OES120   MVI   ELCDLO,DOSTELQ        X'12' STATUS ELEMENT                       
         MVI   ELCDHI,DOSTELQ                                                   
OES125   BRAS  RE,NEXTEL                                                        
         JNE   OES130                                                           
         USING DOSTELD,R4                                                       
         CLI   DOSTSTAT,DDLVRD                                                  
         JE    OES125                                                           
         CLI   DOSTSTAT,QUNDARE      PREVIOUSLY UNDARED?                        
         JE    OES126                                                           
         CLI   DOSTSTAT,QNODARE      PREVIOUSLY NOTDARED?                       
         JNE   OES130                                                           
OES126   OI    MISCFLG2,MF2NTDAR     YES                                        
         DROP  R4                                                               
*                                                                               
OES130   NI    SVFLAG1,X'FF'-SF1TRADE                                           
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         USING DOSPELD,R4                                                       
*                                                                               
         CLI   STATFLAG,STFGRSND    RESEND?                                     
         BE    OES140                YES                                        
*                                                                               
         MVC   DOSPSPTS,AGYNSPTS                                                
         MVC   DOSPTOTL,AGYDOLRS                                                
*                                                                               
         OC    GAPSEQ#,GAPSEQ#                                                  
         JZ    OES140                                                           
         MVC   DOSPPGP#,DOSPGAP#    SAVE THIS OFF IN CASE OF ROLLBACK           
         MVC   DOSPGAP#,GAPSEQ#                                                 
*                                                                               
OES140   MVC   SVBMKT,DOSPMKT                                                   
         CLI   DOSPTMTH,TRDESREP   DOING TRADE?                                 
         JNE   *+8                                                              
         OI    SVFLAG1,SF1TRADE                                                 
         MVC   DRCSHTRD,DOSPTMTH                                                
         OI    DOSPFLG2,DOSPOMDT   ORDER LAST SENT FROM DESKTOP                 
*                                                                               
         TM    MISCFLG2,MF2NTDAR   IS THE ORDER NOTDARED?                       
         JZ    *+8                                                              
         OI    DOSPFLG2,DOSPNTDR   SET BIT ORDER NOTDARED                       
*                                                                               
         OC    DOSPFSTA,DOSPFSTA                                                
         JNZ   *+10                                                             
         MVC   DOSPFSTA,SVBSTA                                                  
         DROP  R4                                                               
*                                                                               
         MVC   XM.DOXMTDID,=X'FFFD'   SET DESTID=EMAIL                          
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'S',AIO3),DOXMELEM,(R4)                            
         DROP  XM                                                               
*                                                                               
         XC    DOSTELEM,DOSTELEM                                                
         LA    R3,DOSTELEM                                                      
CUR      USING DOSTELD,R3                                                       
         MVI   CUR.DOSTEL,DOSTELQ                                               
         MVI   CUR.DOSTLEN,DOSTLNQ2                                             
         MVC   CUR.DOSTDATE,STATDATE                                            
         MVC   CUR.DOSTTIME,STATTIME                                            
         MVI   CUR.DOSTSTAT,DSENT  WE'RE SENDING EDI!!                          
         MVC   CUR.DOSTIDNM,SVBORGID                                            
*                                                                               
         CLI   STATFLAG,STFGCANC   CANCELLING?                                  
         JNE   *+12                                                             
         MVI   CUR.DOSTLEN,DOSTLNQ7                                             
         OI    CUR.DOSTTYP2,DOSTCNCL                                            
*                                                                               
         CLI   STATFLAG,STFGRSND   RESEND?                                      
         JNE   *+12                                                             
         MVI   CUR.DOSTLEN,DOSTLNQ7                                             
         OI    CUR.DOSTTYP2,DOSTXRSD                                            
         DROP  CUR                                                              
*                                                                               
         L     R4,AIO3             YES                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         LR    RF,R4               SAVE THE ADDRESS OF X'03' ELEMENT            
         USING DOSPELD,RF                                                       
*                                                                               
*        CLI   CUR.DOSTSTAT,QSNTPNDG ARE WE SEND PENDING?                       
*        JE    OES190                                                           
*        CLI   CUR.DOSTSTAT,QRECALL  ARE WE RECALLING?                          
*        JE    OES190                                                           
*                                                                               
**************************************************************                  
* COMMENTED OUT, AS THIS MAY BE PREMATURE                                       
* WHAT IF THE SEND RESULTS IN A ROLLBACK       -HWON 12/20/16                   
**************************************************************                  
*        NI    DOSPFLG2,X'FF'-DOSPRSND  CLR NEED TO RESEND FLG                  
*                                                                               
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSTELQ      X'12' STATUS ELEMENT                         
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,NEXTEL           WAS THE ORDER SENT B4?                       
         JNE   OES190              NO                                           
*                                                                               
         LLH   R0,DOSPVER#         GET THE VERSION#                             
         OC    LP_VRSN,LP_VRSN     HAVE SBTK VER#?                              
         JZ    OES145               NO, CHECK CANCELLING                        
         CLC   LP_VRSN,V4600156    SBTK VER# LT V4.6.0.156                      
         JL    OES146               YES, ALWAYS INC VER#                        
*                                                                               
OES145   CLI   STATFLAG,STFGCANC   CANCELLING?                                  
         JE    OES150               YES, DON'T INC VERSION #                    
         CLI   STATFLAG,STFGRSND   RESENDING?                                   
         JE    OES150               YES, DON'T INC VERSION #                    
OES146   C     R0,=X'0000FFFF'                                                  
         JH    *+2                                                              
         AHI   R0,1                INCREMENT THE VERSION #                      
         STCM  R0,3,DOSPVER#       BUMP IT UP BY ONE                            
*                                                                               
OES150   STC   R0,SVCURREV         SAVE CURR REV                                
         JZ    *+8                 ZERO, FIRST TIME, SKIP                       
         AHI   R0,-1               DEC BY 1 TO GET PREVIOUS REV#                
         STC   R0,SVPREREV         SAVE PREV REV                                
*                                                                               
OES160   L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSTELQ      X'12' STATUS ELEMENT                         
         MVI   ELCDHI,DOSTELQ                                                   
         USING DOSTELD,R4                                                       
OES165   BRAS  RE,NEXTEL                                                        
         JNE   OES190                                                           
         CLI   DOSTSTAT,DDLVRD     WAS IT DELIVERED?                            
         JE    OES165               YES, CHECK NEXT STATUS                      
         CLI   DOSTSTAT,QTOBESNT   WAS IT SENT PENDING?                         
         JE    OES165               YES, CHECK NEXT STATUS                      
         CLI   DOSTSTAT,QSNTXCNF   WAS IT SEND CANCELLED, PART. CNFRM           
         JE    OES165               YES, CHECK NEXT STATUS                      
         CLI   DOSTSTAT,QSNTPNDG   WAS IT SENT PENDING?                         
         JE    OES165               YES, CHECK NEXT STATUS                      
*                                                                               
         CLI   DOSTSTAT,QCFMD      WAS IT CONFIRMED?                            
         JE    OES170                                                           
         CLI   DOSTSTAT,QBYRCNFM   WAS IT BUYER CONFIRMED?                      
         JNE   OES190                                                           
         DROP  R4                                                               
OES170   LLC   R0,DOSPREVN                                                      
         AHI   R0,1                INCREMENT THE REVISION #                     
         STC   R0,DOSPREVN         BUMP IT UP BY ONE                            
         CHI   R0,255                                                           
         JNH   OES190                                                           
         GOTOR PUTERR,DMCB,('SE#SY023',SE#TMNRV)                                
         J     OESNO               TOO MANY REVISIONS FOR THIS ORDER!           
*                                                                               
OES190   DS    0H                                                               
*ES190   CLI   CUR.DOSTSTAT,DSENT    IS THE ORDER BEING SENT/CANCEL?            
*        JE    OES200                                                           
*        CLI   CUR.DOSTSTAT,DFXRSNT  OR FAXED                                   
*        JE    OES200                                                           
*        CLI   CUR.DOSTSTAT,DFXSENT  OR RESEND FAX?                             
*        JNE   OES210                                                           
OES200   MVC   DOSPIDST,DOSPDEST                                                
         MVC   DOSPIMTH,DOSPMTHD                                                
         DROP  RF                                                               
*                                                                               
OES210   L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)  R4 = A(FIRST ELEMENT IN RECORD)            
         SR    R0,R0                                                            
OES220   CLI   0(R4),0           ADD AFTER ALL TRANSMISSION ELEMENTS..          
         JE    OES230                                                           
         CLI   0(R4),DORPELQ2    AND BEFORE A X'09' REP CHANGE ELEMENT          
         JE    OES230                                                           
         CLI   0(R4),DOSTELQ     OR AUDIT X'12' ELEMENT                         
         JNL   OES230                                                           
         IC    R0,1(R4)                                                         
         AR    R4,R0                                                            
         J     OES220                                                           
*                                                                               
OES230   GOTOR ARECUP,DMCB,(C'S',AIO3),DOSTELEM,(R4)                            
*                                                                               
*        L     R4,AIO3                                                          
*        LA    R4,DORFRST-DOKEY(R4)                                             
*        MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
*        MVI   ELCDHI,DOSPELQ                                                   
*        BRAS  RE,NEXTEL                                                        
*        JNE   *+2                                                              
*        USING DOSPELD,R4                                                       
*        SR    R0,R0                                                            
*        ICM   R0,3,DOSPVER#       GET THE SEND COUNT                           
*        STC   R0,SVCURREV                                                      
*        JZ    *+8                 ZERO, FIRST TIME, SKIP                       
*        AHI   R0,-1               DEC BY 1 TO GET PREVIOUS REV#                
*        STC   R0,SVPREREV                                                      
*                                                                               
*        OC    DOSPFSTA,DOSPFSTA                                                
*        JNZ   *+10                                                             
*        MVC   DOSPFSTA,SVBSTA                                                  
*        DROP  R4                                                               
*                                                                               
*        BRAS  RE,GTESTINF         GET ESTIMATE INFO                            
*                                                                               
*        GOTOR GTFLTINF,DMCB,(C'L',0)  GET FLT REC AIO8 & SET FLT LOCK          
*        JNE   OES233                                                           
*        CLI   SVBFLT,0                                                         
*        JE    OES235                                                           
*        TM    FLTRCFLG,FRFEXIST   FLIGHT RECORD FOUND?                         
*        JNZ   OES235                                                           
*ES233   GOTOR PUTERR,DMCB,('SE#SY023',SE#INVFL)                                
*        J     OESNO                                                            
*                                                                               
OES235   BRAS  RE,CHKFRCHG         ADD CHECK FOR CHANGE KEYS ON XMIT            
*                                                                               
         GOTOR BUFFER,DMCB,('TSAINI',24),('BUYHKEYL',BUYHRECL),        X        
               ('TSRVAR',0)                                                     
         JNE   *+2                                                              
*                                                                               
         BRAS  RE,ESTF                                                          
*                                                                               
         MVC   SVAIRDAT,EFFS       INIT FIRST AIR DATE                          
         MVI   SVRESEND,0                                                       
         CLI   STATTYPE,DSENT                                                   
         JNE   OES240                                                           
*                                                                               
         CLI   STATFLAG,STFGRSND   RESEND ACTION?                               
         JNE   OES240                                                           
         MVI   SVRESEND,C'Y'       YES, SET FLAG                                
*                                                                               
OES240   BRAS  RE,READBUYS                                                      
         JNE   OESNO                                                            
         CLI   STATFLAG,STFGCANC   CANCELLING?                                  
         BE    OES250               YES, DON'T VALIDATE TOTAL $&SPTS            
         CLI   STATFLAG,STFGRSND   RESENDING?                                   
         BE    OES250               YES, DON'T VALIDATE TOTAL $&SPTS            
         BRAS  RE,VALTDLSP         VALIDATE TOTAL $ AND SPOTS                   
         JNE   OESNO                                                            
*                                                                               
OES250   L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,NEXTEL                                                        
         USING DOSPELD,R4                                                       
         CLC   SVAIRDAT,EFFS                                                    
         JE    *+10                                                             
         MVC   DOSPFAID,SVAIRDAT                                                
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(2,COMPDATE)                                  
*                                                                               
         MVC   IOADDR,AIO3                                                      
         GOTOR COLPASKY,DMCB,(C'R',0)                                           
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOFIL+IO3'                           
*                                                                               
         BRAS  RE,GTDESTID                                                      
*                                                                               
         BRAS  RE,UPDEXTRA         UPDATE ORDER EXTRA RECORD                    
*                                                                               
         CLI   STATFLAG,STFGRSND   RESENDING?                                   
         JE    *+8                  YES, DON'T UPDATE ORHIS RECS                
         BRAS  RE,UPDBUYSS         UPDATE THE BUY SNAPSHOTS                     
*                                                                               
         BRAS  RE,UPDBATCH         UPDATE BATCH RECORD FOR MED/CLT..PR2         
*                                                                               
         TM    SVFLAG1,SF1TRADE    ARE WE DOING TRADE?                          
         JZ    *+8                 NO                                           
         BRAS  RE,SETMETHD                                                      
*                                                                               
         MVI   BYTE2,SPAUPDSN      UPDATE DARE SENT DATE                        
         BRAS  RE,CHKAUTH                                                       
*                                                                               
         BRAS  RE,OESUCRSP                                                      
*                                                                               
OESYES   J     EXITY                                                            
*                                                                               
OESNO    J     EXITN                                                            
*------------------------                                                       
* READ TSAR RECORDS AND UPDATE THE BUYLINE SNAPSHOT RECORDS                     
*------------------------                                                       
UPDBUYSS NTR1  LABEL=*                                                          
         MVC   PASS,MAXPASS                                                     
         MVI   COPYTYPE,C'X'       ONLY UPDATE FOR FAX COPY                     
*                                                                               
         XC    BUYHISD(BUYHKEYH),BUYHISD   SEE IF RECORD IN TSAR BUFFER         
         MVI   BHISTYPE,BHISTYPQ   GET FIRST BUY TSAR RECORD                    
         GOTOR BUFFER,DMCB,('TSARDH',0)                                         
         TM    TSERRS,TSEEOF        END-OF-FILE                                 
         JO    EXITY                                                            
         J     UBSS020                                                          
*                                                                               
UBSS010  GOTOR BUFFER,DMCB,('TSANXT',0)                                         
         JNE   EXITY                                                            
UBSS020  CLI   BHISTYPE,BHISTYPQ   BUY TSAR RECORD?                             
         JNE   EXITY                                                            
         CLI   BHISSEQ,BHDATQ      IGNORE NON-BUY X'00' DATA                    
         JNE   UBSS010                                                          
*                                                                               
         BRAS  RE,SETMYSPT         SET SPOT COUNTS ACROSS RATES                 
*                                                                               
*------------------------                                                       
* READ FOR ORDER HISTORY RECORD                                                 
*------------------------                                                       
*                                                                               
         XC    IOKEY,IOKEY                                                      
K        USING OHISRECD,IOKEY                                                   
         MVI   K.OHISTYP,OHISTYQ             X'0D'                              
         MVI   K.OHISSTYP,OHISSTYQ           X'1B'                              
         MVC   K.OHISORD,BINORDER                                               
         MVC   K.OHISBKAM,SVBAGM                                                
         MVC   K.OHISBKCL,SVBCLT                                                
         MVC   K.OHISBKPR,SVBPRD                                                
         MVC   K.OHISBKMK,SVBMKT                                                
         MVC   K.OHISBKST,BHISSTA                                               
         MVC   K.OHISBKES,SVBEST                                                
         MVC   K.OHISBKLN,BHISLIN+1            BUYLINE NUMBER                   
*                                                                               
         CLI   BHISLIN,0           GREATER THAN 255?                            
         BE    UBSS025                                                          
UBSS022  MVI   K.OHISBKLN,0              CLEAR 1-BYTE BUYLINE                   
         MVC   K.OHISBKL2(2),BHISLIN     SET 2-BYTE BUYLINE                     
*                                                                               
UBSS025  MVC   SVTSRHIS(BUYHKEYL),BHISKEY                                       
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOXSPDIR+IO6'                            
         MVI   ANYHIST,C'N'              ASSUME NO HISTORY                      
         JNE   UBSS030                                                          
         MVI   ANYHIST,C'Y'              SET HISTORY RECORD PRESENT             
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOXSPFIL+IO6'                        
*                                                                               
*------------------------                                                       
* UPDATE THE BUYLINE SNAPSHOT RECORD                                            
*------------------------                                                       
UBSS030  BRAS  RE,UPDORHIS         UPDATE ORDER HISTORY RECORD                  
         J     UBSS010                                                          
         EJECT                                                                  
*                                                                               
*------------------------                                                       
* VALIDATE TOTAL DOLLARS AND SPOTS                                              
*------------------------                                                       
VALTDLSP NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    TOTSPOT,TOTSPOT                                                  
         ZAP   TOTCOST,=P'0'                                                    
         ZAP   TOTTAX,=P'0'                                                     
         XC    BUYHISD(BUYHKEYH),BUYHISD   SEE IF RECORD IN TSAR BUFFER         
         MVI   BHISTYPE,BHISTYPQ   GET FIRST BUY TSAR RECORD                    
         GOTOR BUFFER,DMCB,('TSARDH',0)                                         
         TM    TSERRS,TSEEOF        END-OF-FILE                                 
         JO    EXITY                                                            
         J     VTDS015                                                          
*                                                                               
VTDS010  GOTOR BUFFER,DMCB,('TSANXT',0)                                         
         JNE   VTDS200                                                          
VTDS015  CLI   BHISTYPE,BHISTYPQ   BUY TSAR RECORD?                             
         JNE   VTDS200                                                          
*                                                                               
         CLI   BHFLAG,0            DELETE/REMOVED IN THIS VERSION?              
         JNE   VTDS010                                                          
*                                                                               
* GET TOTAL SPOTS                                                               
*                                                                               
         CLI   BHISSEQ,BHDATQ      IGNORE NON-BUY DATA                          
         JE    VTDS040                                                          
*                                                                               
         CLI   BHISSEQ,BHCOVQ      TEST COST OVERRIDE DATA                      
         JL    VTDS060                                                          
         CLI   BHISSEQ,BHCOVQ+8                                                 
         JH    VTDS010                                                          
*                                                                               
VTDS040  SR    RF,RF                                                            
         ICM   RF,3,BHISLEN                                                     
         CLI   BHISSEQ,BHDATQ                                                   
         JNE   VTDS045                                                          
         AHI   RF,-(BHSPTS-BUYHISD)  RF = # OF WEEKS WITH SPOTS                 
         LA    RE,BHSPTS                                                        
         J     VTDS050                                                          
VTDS045  AHI   RF,-(BHCSPTS-BUYHISD)                                            
         LA    RE,BHCSPTS                                                       
*                                                                               
VTDS050  LTR   RF,RF                                                            
         JZ    VTDS010                                                          
         SR    R0,R0                                                            
VTDS055  LLC   R1,0(RE)            R0 = TOTAL REG SPOTS ON BUYLINE              
         AR    R0,R1                                                            
         AHI   RE,1                                                             
         BCT   RF,VTDS055                                                       
*                                                                               
         L     R1,TOTSPOT                                                       
         AR    R1,R0                                                            
         ST    R1,TOTSPOT          ADD TO TOTAL SPOTS FOR ALL BUYS              
*&&DO                                                                           
         SR    R1,R1                                                            
         ICM   R1,7,BHBDCOST       GET COST/COST OVERRIDE                       
         CVD   R1,DUB                                                           
         CVD   R0,DUB2                                                          
         ZAP   HALF,DUB2           MOVE TO HALF SO I CAN DO MP                  
         MP    DUB,HALF                (BE CAREFUL, PROBLEM IF >999)            
         CLI   BYTE2,C'Y'          IS RATE IN DOLLARS?                          
         JNE   VTDS057                                                          
         MP    DUB,=P'100'                                                      
VTDS057  AP    TOTCOST1,DUB                                                     
*&&                                                                             
         J     VTDS010                                                          
*                                                                               
* GET TOTAL COST                                                                
*                                                                               
VTDS060  CLI   BHISSEQ,BHDOLQ      CALCULATED RATE                              
         JNE   VTDS090                                                          
         SR    RF,RF                                                            
         ICM   RF,3,BHISLEN                                                     
         AHI   RF,-(BHDOLS-BUYHISD)  RF = # OF WEEKS WITH SPOTS                 
         SRL   RF,2                ADJUST FOR 4 BYTE ENTRIES                    
         LA    RE,BHDOLS                                                        
VTDS070  ICM   R1,15,0(RE)                                                      
         CVD   R1,DUB                                                           
         AP    TOTCOST,DUB                                                      
         AHI   RE,4                                                             
         BCT   RF,VTDS070                                                       
         J     VTDS010                                                          
*                                                                               
* GET TOTAL TAX                                                                 
*                                                                               
VTDS090  CLI   BHISSEQ,BHTAXQ      TAX                                          
         JNE   VTDS010                                                          
         SR    RF,RF                                                            
         ICM   RF,3,BHISLEN                                                     
         AHI   RF,-(BHTAX-BUYHISD)   RF = # OF WEEKS WITH SPOTS                 
         SRL   RF,2                ADJUST FOR 4 BYTE ENTRIES                    
         LA    RE,BHTAX                                                         
VTDS100  ICM   R1,15,0(RE)                                                      
         CVD   R1,DUB                                                           
         AP    TOTTAX,DUB                                                       
         AHI   RE,4                                                             
         BCT   RF,VTDS100                                                       
         J     VTDS010                                                          
*                                                                               
VTDS200  CLC   TOTSPOT,AGYNSPTS                                                 
         JNE   VTDSXN                                                           
         CLC   TOTCOST,AGYDOLRS     CHECK POST-TAX                              
         JE    VTDSXY                                                           
         SP    TOTCOST,TOTTAX       AND PRE-TAX AMOUNT                          
         CLC   TOTCOST,AGYDOLRS                                                 
         JNE   VTDSXN                                                           
VTDSXY   J     EXITY                                                            
VTDSXN   GOTOR PUTERR,DMCB,('SE#SY002',SE#NSREF)                                
         J     EXITN                                                            
*                                                                               
*==================================================================             
* MARK ORDER SENT                                                               
*==================================================================             
OEDSENT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSPELQ      X'03' SUPP ELEM                              
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         USING DOSPELD,R4                                                       
         NI    DOSPFLG2,X'FF'-DOSPRSND                                          
*                                                                               
         L     R1,AIO3                                                          
         TM    DORSTAT-DOKEY(R1),DORSVDAQ  CONFIRMED VIDEA ORDER?               
         JNZ   OEDSNT10                    YES, IT IS ALREADY, NO WORK          
         NI    DOSPFLG3,X'FF'-DOSPFVDA  DON'T KNOW LAST SENT TO VIDEA           
         DROP  R4                                                               
*                                                                               
OEDSNT10 MVI   ELCDLO,DOXMTELQ     X'11'                                        
         MVI   ELCDHI,DOXMTELQ                                                  
         BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         USING DOXMTELD,R4                                                      
         MVC   DOXMTDND,DOXMTYMD                                                
         MVC   DOXMTDNT,DOXMTTIM                                                
         MVC   DOXMTDID,=X'FFFD'                                                
         DROP  R4                                                               
*                                                                               
         MVI   ELCDLO,DOSTELQ      X'12' LAST SENT STATUS                       
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,NEXTEL           WAS THE ORDER SENT B4?                       
         JNE   *+2                                                              
         LR    R3,R4               R3 = A(FIRST STATUS ELEM)                    
         USING DOSTELD,R4                                                       
NEW      USING DOSTELD,DOSTELEM                                                 
         MVC   NEW.DOSTELD(DOSTLNQ7),DOSTELD                                    
         MVI   NEW.DOSTLEN,DOSTLNQ6                                             
         MVI   NEW.DOSTSTAT,DDLVRD  X'82'-LOWERCASE B   SENT & DLVD             
*                                                                               
         MVI   ELCDLO,DOWIGELQ     X'50' WHERE IT GO ELEMENT                    
         MVI   ELCDHI,DOWIGELQ                                                  
         BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         USING DOWIGELD,R4                                                      
         MVC   NEW.DOSTDRPP,DOWIGRPP   C'EMAIL   '                              
         MVC   NEW.DOSTDRPO,DOWIGRPO   X'0000'                                  
         DROP  NEW                                                              
*                                                                               
         GOTOR ARECUP,DMCB,(C'S',AIO3),DOSTELEM,(R3)                            
*                                                                               
         L     R1,AIO3                                                          
         TM    DORSTAT-DOKEY(R1),DORSVDAQ  CONFIRMED VIDEA ORDER?               
         JNZ   OEDSNT30                    YES, IT IS ALREADY                   
*                                                                               
         BRAS  RE,CHKIFVDA         CHECK IF EMAILED TO VIDEA                    
         JNE   OEDSNT30            NO, IT WAS NOT                               
*                                                                               
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSPELQ      X'03' SUPP ELEM                              
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
*                                                                               
         USING DOSPELD,R4                                                       
         OI    DOSPFLG3,DOSPFVDA   LAST SENT TO VIDEA                           
         DROP  R4                                                               
*                                                                               
OEDSNT30 GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOFIL+IO3'                           
*                                                                               
         BRAS  RE,OESUCRSP                                                      
*                                                                               
         J     EXITY                                                            
         EJECT                                                                  
*==================================================================             
* CHECK ORDER HISTORY TO SEE IF SENT TO A VIDEA EMAIL ADDRESS                   
*                                                                               
* ON ENTRY:    AIO3                A(ORDER RECORD)                              
*==================================================================             
CHKIFVDA NTR1  BASE=*,LABEL=*                                                   
         XC    IOKEY,IOKEY                                                      
         L     RE,AIO3                                                          
         MVC   IOKEY(L'DOKEY),0(RE)                                             
         MVI   IOKEY+DOKCMT-DOKEY,DOKEXTRA  X'05' - ORDER HISTORY               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO6'                               
         JNE   CKIVDANO                                                         
         CLC   IOKEY(L'DOKEY),IOKEYSAV                                          
         JNE   CKIVDANO                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO6'                              
         JNE   CKIVDANO                                                         
*                                                                               
         L     RE,AIO6                                                          
         LA    RE,DORFRST-DOKEY(RE)                                             
CKIVDA10 CLI   0(RE),0             LOOK FOR LAST SENT EMAIL                     
         JE    CKIVDANO                                                         
         CLI   0(RE),DOEMXELQ      X'53' - EMAIL EXPORT ELEMENT                 
         JE    CKIVDA20                                                         
CKIVDA15 LLC   R0,1(RE)                                                         
         AR    RE,R0                                                            
         J     CKIVDA10                                                         
*                                                                               
         USING DOEMXD,RE                                                        
CKIVDA20 CLI   DOEMXFLG,DOEMXTO    EMAILED  TO                                  
         JNE   CKIVDA15            NO, WE WANT THE PRIMARY                      
         XC    IOKEY,IOKEY         LET'S FIND OUT WHERE IT EMAILED TO           
         LA    R2,IOKEY                                                         
         USING EMLKEY,R2                                                        
         MVI   EMLKTYP,EMLKTYPQ    X'0E' - EMAIL TYPE                           
         MVI   EMLKSUB,EMLKSUBQ    X'15' -       SUBTYPE                        
         MVC   EMLKAGY,LP_AGY      AGENCY                                       
         MVC   EMLKTOK,DOEMXTOK    EMAIL TOKEN                                  
         DROP  RE                                                               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOXSPDIR+IO6'                            
         JNE   CKIVDANO                                                         
         CLC   IOKEY(L'EMLKEY),IOKEYSAV                                         
         JNE   CKIVDANO                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOXSPFIL+IO6'                           
         JNE   CKIVDANO                                                         
*                                                                               
         L     RE,AIO6                                                          
         LA    RE,EMLELS-EMLKEY(RE) 1ST ELEMENT                                 
CKIVDA30 CLI   0(RE),0             WE NEED TO LOOK AT THE EMAIL ADDR            
         JE    CKIVDANO            NONE, NOT VIDEA THEN                         
         CLI   0(RE),EMLELQ        X'10' - EMAIL ADDRESS ELEMENT                
         JE    CKIVDA40                                                         
         LLC   R0,1(RE)            CHECK THE NEXT ELEMENT                       
         AR    RE,R0                                                            
         J     CKIVDA30                                                         
*********                                                                       
* ASSUMPTION HERE THAT THE PC VALIDATED THE FORMAT FOR A VALID EMAIL            
*********                                                                       
         USING EMLELD,RE                                                        
CKIVDA40 LA    R2,EMLADDR                                                       
         LLC   R1,EMLLEN                                                        
         SHI   R1,EMLLENQ          R1 = L(EMAIL ADDRESS)                        
CKIVDA45 CLI   0(R2),C'@'          LOCATE THE @                                 
         JE    CKIVDA50            FOUND IT                                     
         LA    R2,1(R2)            R2 = A(NEXT CHAR IN EMAIL ADDR)              
         JCT   R1,CKIVDA45         R1 = DECREMENT THE LENGTH                    
         J     CKIVDANO            BOUNDARY CHECK FAILED, NOT VIDEA             
*                                                                               
CKIVDA50 LA    R2,1(R2)            WE'RE LOOKING AT THE DOMAIN NAME NOW         
         BCTR  R1,0                                                             
*                                                                               
         LR    RF,R1               MAKE SURE DOMAIN NAME IS UPPERCASE           
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         OC    0(0,R2),SPACES                                                   
         EX    RF,0(RE)                                                         
*                                                                               
         CHI   R1,5                WE'RE LOOKING FOR VIDEA AFTER @              
         JL    CKIVDANO            LENGTH LEFT OVER IS TOO SHORT                
         CLC   =C'VIDEA',0(R2)     SEE IF WE HAVE VIDEA IN DOMAIN SIDE          
         JNE   CKIVDA50            NOT HERE, CHECK FURTHER IN                   
         DROP  RE                                                               
*                                                                               
CKIVDAYS BRAS  RE,RSTROREC         RESTORE ORDER RECORD WRITE SEQ               
         J     EXITY                                                            
*                                                                               
CKIVDANO BRAS  RE,RSTROREC         RESTORE ORDER RECORD WRITE SEQ               
         J     EXITN                                                            
***********************************************************************         
* RESTORE READ OF ORDER RECORD JUST IN CASE                                     
***********************************************************************         
RSTROREC NTR1  BASE=*,LABEL=*                                                   
         L     R0,AIO6             COPY CONTENTS OF ORDER REC TO AIO6           
         L     RE,AIO3             AS IT IS PARTIALLY UPDATED                   
         LHI   R1,IO3LQ                                                         
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
*                                                                               
         XC    IOKEY,IOKEY                                                      
         L     RE,AIO6                                                          
         MVC   IOKEY(L'DOKEY),0(RE)                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JNE   *+2                                                              
         CLC   IOKEY(L'DOKEY),IOKEYSAV                                          
         JNE   *+2                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO3'                           
         JNE   *+2                                                              
*                                                                               
         L     R0,AIO6             RESTORE OUR PARTIALLY UPDATED ORDER          
         L     RE,AIO3               RECORD TO AIO3 SO WE CAN DO THE            
         LHI   R1,IO3LQ              PUTREC                                     
         LR    RF,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         J     EXITY                                                            
*==================================================================             
* ORDER ROLLBACK                                                                
*==================================================================             
OEDRLBK  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,OEREXT           ROLLBACK ORDER EXTRA RECORD                  
*                                                                               
         BRAS  RE,OERREC           ROLLBACK ORDER RECORD                        
*                                                                               
         OC    ELEM,ELEM           HAVE PREVIOUS DOSTELEM?                      
         JZ    *+2                                                              
RBS      USING DOSTELD,ELEM                                                     
         CLI   RBS.DOSTEL,DOSTELQ   HAVE ROLLBACK STATUS ELEM?                  
         JNE   *+2                                                              
         CLI   RBS.DOSTSTAT,DSENT   ROLLBACK STATUS SENT?                       
         JNE   *+2                                                              
         CLI   RBS.DOSTLEN,DOSTLNQ7                                             
         JNE   *+12                                                             
         TM    RBS.DOSTTYP2,DOSTXRSD ROLLBACK STATUS A RESEND?                  
         JO    *+8                   YES, DON'T ROLLBACK SNAPSHOT               
         BRAS  RE,OERBSS           ROLLBACK BUYLINE SNAPSHOT                    
         DROP  RBS                                                              
*                                                                               
         BRAS  RE,OESUCRSP                                                      
*                                                                               
         J     EXITY                                                            
*------------------------                                                       
* ROLL BACK THE ORDER RECORD                                                    
*------------------------                                                       
OERREC   NTR1  LABEL=*                                                          
*                                                                               
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOXMTELQ     X'11'                                        
         MVI   ELCDHI,DOXMTELQ                                                  
         BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         USING DOXMTELD,R4                                                      
         OC    DOXMTDND(DOXMTSTA-DOXMTDND+1),DOXMTDND                           
         JNZ   *+2                                                              
         GOTOR ARECUP,DMCB,(C'S',AIO3),(R4)    REMOVE IT                        
*                                                                               
         XC    ELEM,ELEM                                                        
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSTELQ      X'12'                                        
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         MVC   ELEM,0(R4)          SAVE ORIGINAL DOSTELEM                       
         USING DOSTELD,R4                                                       
*                                                                               
         MVI   BYTE,0                                                           
         CLI   DOSTSTAT,DSENT                                                   
         JNE   *+2                                                              
         CLI   DOSTLEN,DOSTLNQ7                                                 
         JNE   OER010                                                           
         TM    DOSTTYP2,DOSTCNCL+DOSTXRSD  CANCEL OR RESEND?                    
         JZ    OER010                                                           
         MVI   BYTE,C'C'           SET FLAG FOR LATER                           
*                                                                               
OER010   GOTOR ARECUP,DMCB,(C'S',AIO3),(R4)    REMOVE IT                        
         DROP  R4                                                               
*                                                                               
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSPELQ      X'03'                                        
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         USING DOSPELD,R4                                                       
RBS      USING DOSTELD,DOSTELEM      ROLLBACK EXTRA DOSTELEM                    
         MVC   DOSPSPTS,RBS.DOSTSPTS                                            
         MVC   DOSPTOTL,RBS.DOSTTOTL                                            
         MVC   DOSPREVN,RBS.DOSTREVN                                            
*        MVC   DOSPDEST,RBS.DOSTDEST                                            
*        MVC   DOSPMTHD,RBS.DOSTMTHD                                            
         DROP  RBS                                                              
*                                                                               
         OC    LP_VRSN,LP_VRSN     HAVE SBTK VER#?                              
         JZ    OER020               NO, CHECK ROLLING BACK CANCEL SEND          
         CLC   LP_VRSN,V4600156    SBTK VER# LT V4.6.0.156                      
         JL    OER030               YES, ALWAYS ROLL BACK SEND COUNT            
OER020   CLI   BYTE,C'C'           ROLLING BACK CANCEL/ RESEND?                 
         JE    OER040               YES, DON'T ROLL BACK SEND COUNT             
*                                                                               
OER030   ICM   R0,3,DOSPVER#       ROLLBACK SEND COUNT                          
         JZ    OER040                                                           
         BCTR  R0,0                                                             
         STCM  R0,3,DOSPVER#                                                    
*                                                                               
OER040   CLI   BYTE,C'C'           ROLLING BACK CANCEL/RESEND?                  
         JE    OER050               YES, CANCEL DOES NOT INC GAPSEQ#            
         OC    DOSPPGP#,DOSPPGP#   DON'T ROLLBACK GAPSEQ# IF PREV IS 0          
         JZ    OER050                                                           
         MVC   DOSPGAP#,DOSPPGP#   RESTORE THE GAP SEQ# FROM PREVIOCAN          
*                                                                               
OER050   GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOFIL+IO3'                           
         J     EXITY                                                            
*------------------------                                                       
* ROLL BACK THE EXTRA RECORD                                                    
*------------------------                                                       
OEREXT   NTR1  LABEL=*                                                          
         L     R4,AIO3                                                          
         XC    IOKEY,IOKEY                                                      
         MVC   IOKEY(L'DOKEY),0(R4)                                             
         MVI   IOKEY+12,DOKEXTRA   BUILD DARE EXTRA X'05' RECORD                
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO5'                               
         JNE   *+2                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO5'                           
         JNE   *+2                                                              
** DON'T EVER REMOVE THE GAP TOKEN                                              
*&&DO                                                                           
         L     R4,AIO5                                                          
         MVI   ELCDLO,DOEGTELQ     X'54' - GAP TOKEN?                           
         MVI   ELCDHI,DOEGTELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   OERX010                                                          
         GOTOR ARECUP,DMCB,(C'S',AIO5),(R4)    REMOVE IT                        
*&&                                                                             
** DON'T EVER REMOVE THE GAP TOKEN                                              
OERX010  L     R4,AIO5                                                          
         MVI   ELCDLO,DOSTELQ      X'12' - status element?                      
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         GOTOR ARECUP,DMCB,(C'S',AIO5),(R4)    REMOVE IT                        
*                                                                               
         CLI   0(R4),DOEMXELQ      X'53' - EMAIL ADDRESSS?                      
         JNE   OERX020                                                          
         GOTOR ARECUP,DMCB,(C'S',AIO5),(R4)    REMOVE IT                        
*                                                                               
OERX020  GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOFIL+IO5'                           
*                                                                               
         XC    DOSTELEM,DOSTELEM                                                
         L     R4,AIO5                                                          
         MVI   ELCDLO,DOSTELQ      X'12' - GET THE PREVIOUS DOSTELEM            
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,GETEL                                                         
         J     OERX035                                                          
*                                                                               
OERX030  BRAS  RE,NEXTEL                                                        
OERX035  JNE   OERXX                                                            
         USING DOSTELD,R4                                                       
         CLI   DOSTSTAT,DSENT                                                   
         JNE   OERX030                                                          
         MVC   DOSTELEM,0(R4)      SAVE DETAILS OF LAST SEND                    
*                                                                               
OERXX    J     EXITY                                                            
*------------------------                                                       
* ROLL BACK THE BUY SNAPSHOT RECORDS                                            
*------------------------                                                       
OERBSS   NTR1  LABEL=*                                                          
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(3,TODAYB)                                    
*                                                                               
         XC    IOKEY,IOKEY                                                      
K        USING OHISRECD,IOKEY                                                   
         MVI   K.OHISTYP,OHISTYQ                                                
         MVI   K.OHISSTYP,OHISSTYQ                                              
         MVC   K.OHISORD,BINORDER                                               
         MVC   K.OHISBKAM,SVBAGM                                                
         DROP  K                                                                
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOXSPDIR+IO6'                            
         J     OEB020                                                           
OEB010   GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IOXSPDIR+IO6'                            
*                                                                               
OEB020   CLC   IOKEY(OHISBUYK-OHISKEY+L'OHISBKAM),IOKEYSAV  TY/ORD#/A-M         
         JNE   OEBX                DO NOT MATCH                                 
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOXSPFIL+IO6'                        
*                                                                               
         XC    SVEL05,SVEL05                                                    
         XC    SVEL06,SVEL06                                                    
         XC    SVEL09,SVEL09                                                    
         LA    R0,SVEL08           THIS OVERWRITES PRINT LINES                  
         LHI   R1,SVEL08X-SVEL08                                                
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     R4,AIO6                                                          
         AHI   R4,OBDELEM-OHISRECD                                              
         MVI   ELCDLO,X'99'        FIND OLD ACTIVITY ELEM                       
         MVI   ELCDHI,X'99'                                                     
         BRAS  RE,NEXTEL2                                                       
         JNE   *+2                                                              
         USING OHACTVEL,R4                                                      
         MVC   FULL(3),OHACTADD    SAVE ELEM ADD DATE                           
*                                                                               
         L     R4,AIO6                                                          
         AHI   R4,OBDELEM-OHISRECD                                              
         MVI   ELCDLO,OBDELEMQ+X'10'  FIND PREVIOUS VERSION                     
         MVI   ELCDHI,OBDELEMQ+X'10'                                            
         BRAS  RE,NEXTEL2                                                       
         JNE   OEBO60                                                           
         MVC   SVEL05,0(R4)                                                     
         MVI   SVEL05,OBDELEMQ     SET IT AS NEW VERSION ELCODE                 
*                                                                               
OEB030   LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         CLI   0(R4),OHSPTELQ+X'10'   FIND PREVIOUS VERSION                     
         JNE   *+2                                                              
         MVC   SVEL06,0(R4)                                                     
         MVI   SVEL06,OHSPTELQ     SET IT AS NEW VERSION ELCODE                 
*                                                                               
         LA    R2,SVEL08                                                        
*                                                                               
OEB040   LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         CLI   0(R4),0             NOTHING LEFT?                                
         JE    OEBO60                                                           
         CLI   0(R4),OHCOVELQ+X'10'   FIND PREVIOUS VERSION                     
         JL    OEB040                                                           
         JH    OEB050                                                           
         MVC   0(62,R2),0(R4)      MOVE ELEMENT AT MAX LEN                      
         MVI   0(R2),OHCOVELQ      SET IT AS NEW VERSION ELCODE                 
         AHI   R2,L'SVEL08                                                      
         J     OEB040                                                           
*                                                                               
OEB050   CLI   0(R4),OHTAXELQ+X'10'  TEST FOR PREVIOUS TAX                      
         JNE   OEBO60                                                           
         MVC   SVEL09,0(R4)                                                     
         MVI   SVEL09,OHTAXELQ     SET IT AS NEW VERSION ELCODE                 
*                                                                               
OEBO60   L     R0,AIO6             CREATE A NEW RECORD                          
         LHI   R1,IO6LQ                                                         
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     R4,AIO6                                                          
         USING OHISRECD,R4                                                      
*                                                                               
         MVC   0(32,R4),IOKEY      MOVE IN RECORD KEY                           
         LHI   R0,OBDELEM-OHISRECD SET MIN LEN                                  
         STCM  R0,3,OHISLEN                                                     
*                                                                               
         AHI   R4,OBDELEM-OHISRECD                                              
         OC    SVEL05,SVEL05                                                    
         JZ    OEB070                                                           
         GOTOR ARECUP,DMCB,(C'T',AIO6),SVEL05,(R4)                              
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
*                                                                               
OEB070   OC    SVEL06,SVEL06                                                    
         JZ    OEB075                                                           
         GOTOR ARECUP,DMCB,(C'T',AIO6),SVEL06,(R4)                              
*                                                                               
OEB075   LA    R2,SVEL08                                                        
         LHI   R3,8                                                             
*                                                                               
OEB080   CLI   0(R2),OHCOVELQ      X'08' IS THERE ANOTHER ELEMENT               
         JNE   OEB085                                                           
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'T',AIO6),(R2),(R4)                                
         AHI   R2,L'SVEL08                                                      
         JCT   R3,OEB080                                                        
*                                                                               
OEB085   CLI   SVEL09,OHTAXELQ     X'09' TEST TAX ELEMENT                       
         JNE   OEB090                                                           
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'T',AIO6),SVEL09,(R4)                              
*                                                                               
K        USING OHACTVEL,ELEM                                                    
OEB090   XC    ELEM,ELEM                                                        
         MVI   K.OHACTVEL,X'99'                                                 
         MVI   K.OHACTELN,L'OHACTCHG+OHACTCHG-OHACTVEL                          
         MVC   K.OHACTADD,FULL     ELEM ADD DATE                                
         OC    K.OHACTADD,K.OHACTADD  TEST HAVE ADD DATE                        
         JZ    *+10                                                             
         MVC   K.OHACTCHG,TODAYB                                                
*                                                                               
         L     R4,AIO6                                                          
         SR    R0,R0                                                            
         ICM   R0,3,OHISLEN                                                     
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'T',AIO6),ELEM,(R4)                                
*                                                                               
OEB095   GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOXSPFIL+IO6'                        
         J     OEB010                                                           
*                                                                               
OEBX     J     EXITY                                                            
*                                                                               
*------------------------                                                       
* ORDER OE SUCCESS RESPONSE                                                     
*------------------------                                                       
OESUCRSP NTR1  BASE=*,LABEL=*                                                   
         SR    R0,R0               BUILD DOWNLOAD MAP ELEMENT                   
         ICM   R0,3,LP_QMAPN                                                    
         GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTMAP',(R0))                  
*                                                                               
         OC    PCKEYORD,PCKEYORD                                                
         JZ    OESRYES                                                          
         SR    R0,R0                                                            
         ICM   R0,3,LW_LN-LW_D(RF)                                              
         SHI   R0,LW_LN1Q                                                       
         GOTOR ALINKIO,(R1),('LIOAPUT',ALIOB),('LIOTRAW',1),           *        
               ('LD_CHARQ',PCKEYORD),(L'PCKEYORD,0)                             
OESRYES  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* SAVE THE CHANGES FOR THE ORDER                                                
***********************************************************************         
SAVEORD  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(2,COMPDATE)                                  
*                                                                               
         MVI   MISCFLG1,0                                                       
         MVI   PROFFLG1,0                                                       
         OC    BINORDER,BINORDER                                                
         JNZ   SVOR010                                                          
*                                                                               
         BRAS  RE,CHKDSEOC         CHECK DSTA END OF CONTRACT                   
         JNE   SVORXN              YES, DON'T ALLOW ADD                         
*                                                                               
         GOTOR ADDORDER            ADD THE ORDER FIRST                          
         JNE   SVORXN                                                           
         GOTOR GETORD              GET THE ORDER RECORD                         
         JNE   SVORXN                                                           
*                                                                               
SVOR010  GOTOR CHGORDER                                                         
         JNE   SVORXN                                                           
*                                                                               
SVOR050  DS    0H                                                               
         J     EXITY                                                            
SVORXN   J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* CHANGE THE ORDER                                                              
***********************************************************************         
CHGORDER NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         MVI   ELCDHI,DOIDELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
*                                                                               
         MVC   SVBCLT,DOIDCLT      WE MIGHT NEED THIS FOR GETEST                
         MVC   SVBEST,DOIDEST        FOR THE NON-TRAD DEMOS                     
****     MVC   SVBPRD,DOIDPRD                                                   
****     MVC   SVBPR2,DOIDPRD2                                                  
*                                                                               
         MVC   SVQBYR,DOIDBYR                                                   
         OC    SVQBYR,SPACES                                                    
         BRAS  RE,VALBYR                                                        
*                                                                               
         OC    ORDERREC(ORDRECLN),ORDERREC  CHGS TO X'00' ORDER REC?            
         JZ    CHOR001                       NO - SKIP CALL BUT FALL            
*                                             THRU TO SET SAVE FIELDS           
         GOTOR ADDIOLST,'IOPUT+IOFIL+IO3'    YES - ADD TO SAVE LIST             
*                                                                               
CHOR001  ICM   RE,15,I$SALESP                                                   
         JZ    CHOR003                                                          
         MVC   DOIDSPER,SPACES                                                  
         USING LW_D,RE                                                          
         LH    R1,LW_LN            LENGTH OF ENTRY + L'FLDHDR                   
         AHI   R1,-(LW_LN1Q+1)     -(L'FLDHDR + 1 FOR EX)                       
         JM    CHOR003             NO SALESPERSON, SO SPACES FOR YOU            
         MVC   DOIDSPER(0),LW_DATA1                                             
         EX    R1,*-6                                                           
*                                                                               
CHOR003  ICM   RE,15,I$REPALP                                                   
         JZ    CHOR007                                                          
         XC    DOIDSPER,DOIDSPER                                                
         CLC   LW_LN,=AL2(LW_LN1Q) MAP CODE ONLY?                               
         JE    *+10                                                             
         MVC   DOIDREPA,LW_DATA1                                                
         ICM   RE,15,I$SALESC                                                   
         JZ    COEREQDT            ERROR, ENTER REQUIRED DATA                   
         MVC   DOIDSALC,LW_DATA1                                                
         OC    DOIDSPER,DOIDSPER   USER WAS THE CLEARING THE FIELD?             
         JZ    CHOR007             YES                                          
         MVC   DOIDFFS,EFFS                                                     
*                                                                               
CHOR007  MVC   SALESPER,DOIDSPER                                                
*                                                                               
CHOR010  LA    RF,I$STDCM1                                                      
         OC    0(STDCOMLN,RF),0(RF)  ANY STANDARN COMMENT CHANGES?              
         JZ    CHOR018                                                          
         LA    R0,3                LOOP 3 TIMES                                 
         LR    R3,R4                                                            
CHORID   USING DOIDELD,R3                                                       
CHOR015  ICM   RE,15,0(RF)         STANDARD COMMENT CHANGE?                     
         JZ    CHOR016             NO                                           
         XC    CHORID.DOISCOM1,CHORID.DOISCOM1                                  
         LH    R1,LW_LN            LENGTH OF ENTRY + L'FLDHDR                   
         AHI   R1,-(LW_LN1Q+1)     -(L'FLDHDR + 1 FOR EX)                       
         JM    CHOR016                                                          
         MVC   CHORID.DOISCOM1(0),LW_DATA1                                      
         EX    R1,*-6                                                           
         OC    CHORID.DOISCOM1,SPACES     CAP AND SPACE PAD                     
CHOR016  CLC   CHORID.DOISCOM1,SPACES                                           
         JNH   CHOR017                                                          
         BRAS  RE,VALSTD                                                        
         JNE   COEIVSTC                                                         
*                                                                               
CHOR017  LA    R3,L'DOISCOM1(R3)                                                
         LA    RF,L'I$STDCM1(RF)                                                
         JCT   R0,CHOR015                                                       
         DROP  CHORID                                                           
*                                                                               
CHOR018  MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,NEXTEL                                                        
         USING DOSPELD,R4                                                       
*                                                                               
         ICM   RE,15,I$HIDORD                                                   
         JZ    CHOR020                                                          
         NI    DOSPFLG1,X'FF'-DOSPHIDE                                          
         CLI   LW_DATA1,C'H'       HIDE IT?                                     
         JNE   *+8                                                              
         OI    DOSPFLG1,DOSPHIDE                                                
*                                                                               
CHOR020  ICM   RE,15,I$PRVNEW                                                   
         JZ    CHOR021                                                          
         NI    DOSPFLG1,X'FF'-DOSPAVN    TURN OFF AVN                           
         CLI   LW_DATA1,C'P'                                                    
         JNE   *+8                                                              
         OI    DOSPFLG1,DOSPAVN    X'20' - AVN PREV ORDER, FAX ONLY             
*                                                                               
CHOR021  ICM   RE,15,I$PPFLAG                                                   
         JZ    CHOR023                                                          
         NI    DOSPFLG1,X'FF'-DOSPPPER                                          
         CLI   LW_DATA1,C'P'                                                    
         JNE   *+8                                                              
         OI    DOSPFLG1,DOSPPPER                                                
*                                                                               
CHOR023  NI    MISCFLG1,X'FF'-MF1CHGDS                                          
         ICM   RE,15,I$DEST                                                     
         JZ    CHOR025                                                          
         MVC   DOSPDEST,LW_DATA1                                                
         OI    MISCFLG1,MF1CHGDS                                                
*                                                                               
CHOR025  ICM   RE,15,I$METH                                                     
         JZ    CHOR027                                                          
         OI    MISCFLG1,MF1CHGDS                                                
         MVC   DOSPMTHD,LW_DATA1                                                
CHOR027  MVC   SVDEST,DOSPDEST                                                  
         MVC   SVMTHD,DOSPMTHD                                                  
         DROP  R4                                                               
*                                                                               
* UPDATE THE DOWIG ELEMENT                                                      
*                                                                               
         OC    NWDWG(NWDWGLN),NWDWG     ARE WE CHANGING DOWIG?                  
         JNZ   CHOR030                    YES                                   
         TM    MISCFLG1,MF1CHGDS          NO, BUT WE CHANGED DEST/MTHD?         
         JZ    CHOR050                      NO, OKAY                            
         J     COEREQDT                     YES, ENTER REQUIRED DATA            
*                                                                               
CHOR030  GOTOR VHELLO,DMCB,(C'D',=C'SPTFIL'),('DOWIGELQ',AIO3),0,0              
*                                                                               
         LA    R3,ELEM                                                          
         USING DOWIGELD,R3                                                      
         XC    ELEM,ELEM                                                        
         MVI   DOWIGEL,DOWIGELQ                                                 
         MVI   DOWIGLEN,DOWIGLNQ                                                
         MVC   DOWIGMTH,SVMTHD                                                  
*                                                                               
         ICM   RE,15,I$FAX#                                                     
         JZ    CHOR035                                                          
         LH    R1,LW_LN            LENGTH OF ENTRY + L'FLDHDR                   
         AHI   R1,-(LW_LN1Q+1)     -(L'FLDHDR + 1 FOR EX)                       
         JM    CHOR035                                                          
         MVC   DOWIGFXN(0),LW_DATA1                                             
         EX    R1,*-6                                                           
                                                                                
CHOR035  ICM   RE,15,I$REPPFX                                                   
         JZ    CHOR040                                                          
         LH    R1,LW_LN            LENGTH OF ENTRY + L'FLDHDR                   
         AHI   R1,-(LW_LN1Q+1)     -(L'FLDHDR + 1 FOR EX)                       
         JM    CHOR040                                                          
         MVC   DOWIGRPP(0),LW_DATA1                                             
         EX    R1,*-6                                                           
         OC    DOWIGRPP,SPACES                                                  
*                                                                               
CHOR040  ICM   RE,15,I$REPOFF                                                   
         JZ    CHOR045                                                          
         CLC   LW_LN,=AL2(LW_LN1Q) MAP CODE ONLY?                               
         JE    CHOR045                                                          
         MVC   DOWIGRPO,LW_DATA1                                                
         OC    DOWIGRPO,SPACES                                                  
*                                                                               
CHOR045  GOTOR VHELLO,DMCB,(C'P',=C'SPTFIL'),AIO3,ELEM,0                        
*                                                                               
CHOR050  ICM   RE,15,I$EMAILS      CHANGING EMAIL?                              
         JNZ   CHOR051              YES,                                        
         CLI   SVMTHD,C'E'         IS METHOD STILL EMAIL?                       
         JE    CHOR055              YES                                         
*                                                                               
CHOR051  GOTOR VHELLO,DMCB,(C'D',=C'SPTFIL'),('DOEMXELQ',AIO3),0,0              
*                                                                               
         ICM   RE,15,I$EMAILS                                                   
         JZ    CHOR055                                                          
         LA    R3,ELEM                                                          
         USING DOEMXD,R3                                                        
         XC    ELEM,ELEM                                                        
         MVI   DOEMXEL,DOEMXELQ                                                 
*                                                                               
         ICM   R0,3,LW_NUMN        ANY EMAILS TO SAVE?                          
         JZ    CHOR055                                                          
         LA    R2,LW_DATA2                                                      
* ADDED THIS B/C SANDEEP/JOHN ALLOW REMOVING ALL EMAIL ADDRESSES EVEN           
* THOUGH THE USER STILL WANTS TO SEND VIA EMAIL AND WILL ALSO GET AN            
* ERROR WHEN ATTEMPTING TO SEND SUCH ORDER. HWON 03/11/08                       
         CLI   0(R2),C' '          DO THEY JUST WANT TO REMOVE?                 
         JNH   CHOR055             YES, OK                                      
*                                                                               
         LR    R1,R0                                                            
         MHI   R1,DOEMXLN2         MULTIPLY BY LENGTH OF AN ENTRY (5)           
         AHI   R1,DOEMXLNQ         PLUS + OVERHEAD                              
         STC   R1,DOEMXLEN         SAVE THE LENGTH                              
*                                                                               
CHOR052  MVC   DOEMXFLG,0(R2)                                                   
         GOTOR GTEMLTKN,DMCB,(R2),DOEMXTOK                                      
         LA    R3,DOEMXLN2(R3)                                                  
         LA    R2,EMLNQ(R2)                                                     
         JCT   R0,CHOR052                                                       
         GOTOR VHELLO,DMCB,(C'P',=C'SPTFIL'),AIO3,ELEM,0                        
*                                                                               
CHOR055  XC    SALESCOD,SALESCOD                                                
         CLI   SVMED,C'R'          IS IT RADIO?                                 
         JNE   CHOR065                                                          
         CLI   SVMTHD,C'I'         IS IT INBOX?                                 
         JNE   CHOR065                                                          
*                                                                               
         L     RF,AIO3                                                          
         MVC   BYTE,DOKSTA-DAREORDD+2(RF)    LETS ISOLATE BAND                  
         NI    BYTE,X'0F'                                                       
         CLI   BYTE,X'06'          PANDORA RADIO STREAMING STATION?             
         BE    CHOR065              YES, SKIP                                   
         CLI   BYTE,X'07'          I-HEART RADIO STREAMING STATION?             
         BE    CHOR065              YES, SKIP                                   
*                                                                               
         CLC   SALESPER,SPACES                                                  
         JNH   CHOR065                                                          
         BRAS  RE,GTDESTID                                                      
*                                                                               
         BRAS  RE,CHKRPSAL                                                      
         JNE   COEINVSP            ERROR, INVL SALESPERSON                      
*                                                                               
CHOR065  ICM   RE,15,I$INCDM                                                    
         JZ    CHOR080                                                          
         GOTOR VHELLO,DMCB,(C'D',=C'SPTFIL'),('DODEMELQ',AIO3),0,0              
*                                                                               
         ICM   RE,15,I$INCDM                                                    
         LA    R3,ELEM                                                          
         USING DODEMELD,R3                                                      
         XC    ELEM,ELEM                                                        
         MVI   DODEMEL,DODEMELQ    X'25'                                        
         MVI   DODEMLEN,DODEMOVH                                                
         CLI   LW_DATA1,C'Y'       INCLUDE DEMOS ON THE ORDER?                  
         JNE   CHOR075             NO                                           
*                                                                               
         ICM   RE,15,I$ORDDEM      ANY DEMOS?                                   
         JZ    CHOR075             NONE, DON'T SEND ANY DEMOS                   
         ICM   RF,3,LW_NUMN        SEND ZERO DEMOS?                             
         STC   RF,DODEMNUM         SAVE NUMBER OF DEMOS                         
**************                                                                  
         LR    R1,RF               USING EST DISP FOR NON-TRAD DEMOS            
         MHI   R1,L'DODEMOS        x L'DEMO CATEGORY                            
         AHI   R1,DODEMOVH         PLUS + OVERHEAD                              
         STC   R1,DODEMLEN         SAVE THE LENGTH OF THE ELEMENT               
*                                                                               
         BRAS  RE,VALDEMOS                                                      
         JNE   COEINVDM            ERROR, INVALID DEMOS                         
**************                                                                  
CHOR075  GOTOR VHELLO,DMCB,(C'P',=C'SPTFIL'),AIO3,ELEM,0                        
*                                                                               
CHOR080  OC    I$COM1(ORDCOMLN),I$COM1   ORDER COMMENT CHANGES?                 
         JZ    CHOR155                   NO                                     
         L     R4,AIO4                                                          
         USING DAREORDD,R4                                                      
         OC    ORD2ADDR,ORD2ADDR         DO WE HAVE A COMMENT RECORD?           
         JNZ   CHOR090                   YES                                    
*                                                                               
         L     RE,AIO4                                                          
         LHI   RF,IO4LQ                                                         
         XCEFL                                                                  
*                                                                               
         XC    0(DORFRST-DOKEY,R4),0(R4)                                        
         L     RF,AIO3                                                          
         MVC   DOKEY,0(RF)                                                      
         MVC   DORLEN,=Y(DORFRST-DOKEY)                                         
         OI    DOKCMT,DOKCAGCQ                                                  
         MVC   DORAGY,LP_AGY                                                    
CHOR090  LA    R4,DORFRST                                                       
         DROP  R4                                                               
*                                                                               
         LA    R2,ELEM                                                          
         USING DOCOMELD,R2                                                      
         MVI   DOCOMEL,DOCOMELQ                                                 
         MVI   DOCOMLIN,1                                                       
         LA    R3,I$COM1                                                        
CHOR100  ICM   RE,15,0(R3)                                                      
         JZ    CHOR140                                                          
         LH    RF,LW_LN             LENGTH OF ENTRY + L'FLDHDR                  
         AHI   RF,DOCOMOVH-LW_LN1Q  MINUS L'FLDHDR + OVERHEAD                   
         STCM  RF,1,DOCOMLEN        NO, LETS ADD IT BACK                        
         AHI   RF,-DOCOMOVH-1       MINUS OVERHEAD - 1 FOR EX                   
         JM    CHOR110              MAP CODE ONLY                               
         MVC   DOCOMTXT(0),LW_DATA1                                             
         EX    RF,*-6                                                           
*                                                                               
CHOR110  CLI   0(R4),0             END OF RECORD?                               
         JE    CHOR130             YES, JUST ADD IT                             
         CLC   DOCOMLIN,DOCOMLIN-DOCOMEL(R4)  MATCH ON LINE NUMBER?             
         JE    CHOR120             YES, GO DELETE IT                            
         JL    CHOR130                IF HIGHER, NOTHING TO DELETE              
         LLC   RF,1(R4)               ITS LOWER, KEEP CHECKING                  
         AR    R4,RF                                                            
         J     CHOR110                                                          
CHOR120  GOTOR ARECUP,DMCB,(C'S',AIO4),(R4)  DELETE IT                          
*                                                                               
CHOR130  CLI   DOCOMLEN,DOCOMOVH   DELETING A COMMENT?                          
         JNH   CHOR140             YES, DONE                                    
         GOTOR ARECUP,DMCB,(C'S',AIO4),ELEM,(R4) LETS ADD THE NEW ONE           
         LLC   RF,1(R4)                                                         
         AR    R4,RF                                                            
*                                                                               
CHOR140  LA    R3,L'I$COM1(R3)                                                  
         SR    RF,RF                                                            
         ICM   RF,1,DOCOMLIN                                                    
         AHI   RF,1                                                             
         STCM  RF,1,DOCOMLIN                                                    
         CLI   DOCOMLIN,8                                                       
         JNH   CHOR100                                                          
         DROP  R2                                                               
*                                                                               
         OC    ORD2ADDR,ORD2ADDR                                                
         JNZ   CHOR150                                                          
         GOTOR ADDIOLST,'IOADDREC+IOFIL+IO4'                                    
         J     CHOR155                                                          
CHOR150  GOTOR ADDIOLST,'IOPUT+IOFIL+IO4'                                       
*                                                                               
* UPDATE THE STATUS ELEMENT                                                     
*                                                                               
CHOR155  ICM   RE,15,I$XMIT        ARE WE TRANSMITTING?                         
         JZ    CHOR600              NO                                          
         MVC   SVXMIT,LW_DATA1                                                  
*                                                                               
         CLI   SVMTHD,C'F'                                                      
         JNE   CHOR160                                                          
         CLC   LP_AGY,=C'JS'       THESE AGENCIES HAVE BEEN DISABLED            
         JE    COENOFAX              FOR FAXING                                 
         CLC   LP_AGY,=C'FR'                                                    
         JE    COENOFAX                                                         
         CLC   LP_AGY,=C'H7'                                                    
         JE    COENOFAX                                                         
*                                                                               
CHOR160  TM    MISCFLG2,MF2BRDAC   BUYER CODE HAS BEEN DEACTIVATED?             
         JNZ   COEINBYR            YES, INVALID BUYER                           
*                                                                               
         GOTOR GTUSERID,DMCB,(X'80',SVBORGID),SVORIGID                          
         CLI   SVMTHD,C'I'         ARE WE GOING EDI?                            
         JNE   CHOR165                                                          
         OC    SVDRROUT,SVDRROUT   CHECK FOR VALID ROUTING CODE                 
         JZ    COENODAR            NOT A DARE TRADING PARTNER, NO EDI           
*                                                                               
CHOR165  CLI   SVMTHD,C'F'                                                      
         JNE   CHOR166                                                          
         CLC   SVORIGID,=CL10'OMGBED'                                           
         JE    COENOFAX                                                         
*                                                                               
CHOR166  L     R4,AIO3                                                          
         MVI   ELCDLO,DOIDELQ      X'01' - PRIMARY ID ELEMENT                   
         MVI   ELCDHI,DOIDELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
*                                                                               
CHOR167  LA    R1,DOISTA                                                        
         BRAS  RE,GETQSTA                                                       
*                                                                               
* SBTK DEFECT IN 157 ALLOWS SENDING EDI ORDER IN OPENED STATUS                  
*                                                                               
         BRAS  RE,ALLOWSND         ALLOW SEND OF ORDER?                         
         JNE   COEONTSN             NO                                          
*                                                                               
* CODE TO PREVENT TESTID FROM SENDING TO LIVE STATIONS                          
*                                                                               
         BRAS  RE,SNDTSTID         ALLOW TEST ID TO SEND ORDER?                 
         JNE   COEONTSN             NO                                          
*                                                                               
         BRAS  RE,NOSENDRB         DO NOT ALLOW AGY RB TO SEND ORDER            
         JNE   CHORXN                                                           
*                                                                               
         BRAS  RE,CHKDSEOC         CHECK DSTA END OF CONTRACT                   
         JNE   CHORXN              YES, DON'T ALLOW SEND                        
*                                                                               
CHOR190  MVC   SVBCLT,DOIDCLT                                                   
         GOTOR (#EDTCLT,AEDTCLT),DMCB,SVBCLT,0,SVQCLT                           
         MVC   QCLTA,SVQCLT                                                     
*                                                                               
         BRAS  RE,GETPROFS                                                      
*                                                                               
         MVI   SVRESEND,0                                                       
         ICM   RE,15,I$RESEND                                                   
         JZ    CHOR230                                                          
         MVC   SVRESEND,LW_DATA1                                                
         CLI   SVRESEND,C'Y'                                                    
         JNE   CHOR230                                                          
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSTELQ                                                   
         MVI   ELCDHI,DOSTELQ                                                   
         LA    R4,DORFRST-DOKEY(R4)                                             
*                                                                               
CHOR200  BRAS  RE,NEXTEL                                                        
         JNE   COENORST            ORDER CANNOT BE RESENT                       
         USING DOSTELD,R4                                                       
CHOR220  CLI   DOSTSTAT,DFXSENT    LETS GET THE DATE OF LAST FAX                
         JNE   CHOR200                                                          
         LLC   R0,PDXSTYR                                                       
         AHI   R0,100                                                           
         STC   R0,DUB                                                           
         MVC   DUB+1(2),PDXSTMON                                                
         GOTOR VDATCON,DMCB,(3,DUB),(19,WORK) NEW FAX DATE PWOS                 
         CLC   DOSTDATE,WORK       TEST SENT BEFORE NEW FAX START               
         JL    COENORST            ORDER CANNOT BE RESENT                       
         DROP  RE                                                               
*                                                                               
CHOR230  THMS  DDSTIME=YES                                                      
         STCM  R0,15,PACKOF4B                                                   
         ST    R1,FULL                                                          
         AP    PACKOF4B,FULL                                                    
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(0,DUB)   THE TIME                            
         CP    PACKOF4B,=P'240000'    PAST MIDNIGHT?                            
         JL    CHOR240                                                          
         SP    PACKOF4B,=P'240000'    YES, BUMP TO NEXT DAY AND ADJUST          
         GOTOR VADDAY,DMCB,DUB,DUB,F'1'                                         
                                                                                
CHOR240  GOTOR VDATCON,DMCB,(0,DUB),(19,FULL)                                   
*                                                                               
         NI    MISCFLG2,X'FF'-MF2VIDEA  NOT SENDING VIDEA EDI YET               
         CLI   SVXMIT,C'C'         CANCELLING?                                  
         JE    *+12                                                             
         CLI   SVXMIT,C'S'         SENDING?                                     
         JNE   CHOR285                                                          
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOWIGELQ                                                  
         MVI   ELCDHI,DOWIGELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   COENOSNT                                                         
         USING DOWIGELD,R4                                                      
         CLI   DOWIGMTH,0          DO WE HAVE A METHOD?                         
         JE    COENOSNT                                                         
         CLC   DOWIGRPP,SPACES                                                  
         JNH   COENOSNT                                                         
         CLI   DOWIGMTH,C'F'       ARE WE GOING FAX?                            
         JNE   CHOR250                                                          
         MVC   DOWIGFXA,SALESPER                                                
         OC    DOWIGFXN,DOWIGFXN                                                
         JZ    COENOSNT                                                         
*                                                                               
CHOR250  DS    0H                                                               
         CLC   =C'VIDEA   ',DOWIGRPP  REP PREFIX IS VIDEA?                      
         JNE   CHOR255                NO                                        
         OI    MISCFLG2,MF2VIDEA      YES, WE HAVE VIDEA EDI                    
*                                                                               
XM       USING DOXMTELD,DOXMELEM                                                
CHOR255  XC    DOXMELEM,DOXMELEM                                                
         MVI   XM.DOXMTEL,DOXMTELQ                                              
         MVI   XM.DOXMTLEN,DOXMTLNQ                                             
         MVC   XM.DOXMTYMD,FULL       DATE                                      
         ICM   R1,15,PACKOF4B                                                   
         SRL   R1,12                  GET RID OF SECONDS AND SIGN               
         STCM  R1,3,XM.DOXMTTIM       TIME                                      
         MVC   XM.DOXMTOID,SVBORGID   ORIGIN ID                                 
*                                                                               
         NI    MISCFLG2,X'FF'-MF2NTDAR                                          
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)  R4 = A(FIRST ELEMENT IN RECORD)            
         MVI   ELCDLO,DOSTELQ        X'12' STATUS ELEMENT                       
         MVI   ELCDHI,DOSTELQ                                                   
CHOR260  BRAS  RE,NEXTEL                                                        
         JNE   CHOR280                                                          
         USING DOSTELD,R4                                                       
         CLI   DOSTSTAT,DDLVRD                                                  
         JE    CHOR260                                                          
         CLI   DOSTSTAT,QUNDARE                                                 
         JE    CHOR265                                                          
         CLI   DOSTSTAT,QNODARE                                                 
         JNE   CHOR270                                                          
CHOR265  OI    MISCFLG2,MF2NTDAR                                                
*                                                                               
CHOR270  CLI   DOSTSTAT,QRECALL                                                 
         JNE   CHOR280                                                          
         MVC   XM.DOXMTSTD,XM.DOXMTYMD                                          
         MVC   XM.DOXMTSTT,XM.DOXMTTIM                                          
         MVI   XM.DOXMTSTA,QSNTPNDG   SENT PENDING                              
         DROP  R4                                                               
*                                                                               
CHOR280  L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         USING DOSPELD,R4                                                       
         OI    DOSPFLG2,DOSPOMDT   ORDER LAST SENT FROM DESKTOP                 
*                                                                               
         L     R1,AIO3                                                          
         TM    DORSTAT-DOKEY(R1),DORSVDAQ  Confirmed videa order?               
         JNZ   CHOR283                     Yes, it is already, no work          
         NI    DOSPFLG3,X'FF'-DOSPFVDA                                          
*                                                                               
CHOR283  TM    MISCFLG2,MF2NTDAR   IS THE ORDER NOTDARED?                       
         JZ    *+8                                                              
         OI    DOSPFLG2,DOSPNTDR   SET BIT ORDER NOTDARED                       
*                                                                               
         CLI   DOSPMTHD,C'F'       ARE WE GOING FAX?                            
         JNE   *+10                                                             
         MVC   XM.DOXMTDID,EFFS       SET DESTID=FAX                            
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'S',AIO3),DOXMELEM,(R4)                            
         J     CHOR295                                                          
*                                                                               
CHOR285  L     R4,AIO3                                                          
         MVI   ELCDLO,DOXMTELQ     X'11' TRANSMISSION ELEMENT                   
         MVI   ELCDHI,DOXMTELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         USING DOXMTELD,R4                                                      
*                                                                               
         MVI   DOXMTSTA,QRECALL                                                 
         CLI   SVXMIT,C'R'                                                      
         JE    CHOR290                                                          
         MVI   DOXMTSTA,QNODARE                                                 
         CLI   SVXMIT,C'N'                                                      
         JNE   COEUNEXP               UNEXPECTED INPUT                          
*                                                                               
CHOR290  MVC   DOXMTSTD,FULL                                                    
         ICM   R1,15,PACKOF4B                                                   
         SRL   R1,12                  GET RID OF SECONDS AND SIGN               
         STCM  R1,3,DOXMTSTT          TIME                                      
         MVC   DOXMELEM,DOXMTEL       COPY OF DOXMEL                            
         DROP  R4                                                               
*                                                                               
* ADD THE DOSTEL ELEMENT                                                        
*                                                                               
CHOR295  XC    DOSTELEM,DOSTELEM                                                
         LA    R3,DOSTELEM                                                      
CUR      USING DOSTELD,R3                                                       
         MVI   CUR.DOSTEL,DOSTELQ                                               
         MVI   CUR.DOSTLEN,DOSTLNQ                                              
         MVC   CUR.DOSTDATE,FULL                                                
         ICM   R1,15,PACKOF4B                                                   
         SRL   R1,12                     GET RID OF SECONDS AND SIGN            
         STCM  R1,3,CUR.DOSTTIME         TIME                                   
         MVC   CUR.DOSTSTAT,XM.DOXMTSTA  COPY STATUS                            
         CLI   CUR.DOSTSTAT,QSNTPNDG     ARE WE SENT PENDING?                   
         JE    CHOR310                   YES                                    
         CLI   CUR.DOSTSTAT,0            SENT/FAX/RESEND/CANCEL?                
         JNE   CHOR390                   NO                                     
*                                                                               
CHOR300  CLC   XM.DOXMTDID,EFFS    ARE WE FAXING?                               
         JE    CHOR305             YUP                                          
         MVI   CUR.DOSTSTAT,DSENT  WE'RE SENDING EDI!!                          
         CLI   SVXMIT,C'C'         CANCELLING?                                  
         JNE   CHOR310                                                          
         MVI   CUR.DOSTLEN,DOSTLNQ7                                             
         OI    CUR.DOSTTYP2,DOSTCNCL                                            
         J     CHOR315                                                          
         DROP  XM                                                               
*                                                                               
CHOR305  MVI   CUR.DOSTSTAT,DFXSENT  ASSUME SENDING A FAX!!                     
         CLI   SVRESEND,0            ARE WE ACTUALLY RESENDING?                 
         JE    CHOR310               NO ,                                       
         MVI   CUR.DOSTSTAT,DFXRSNT  YES, WE'RE RESENDING!!                     
CHOR310  MVI   CUR.DOSTLEN,DOSTLNQ2                                             
CHOR315  MVC   CUR.DOSTIDNM,SVBORGID                                            
*                                                                               
         L     R4,AIO3             YES                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         LR    RF,R4               SAVE THE ADDRESS OF X'03' ELEMENT            
         USING DOSPELD,RF                                                       
*                                                                               
         CLI   CUR.DOSTSTAT,QSNTPNDG ARE WE SEND PENDING?                       
         JE    CHOR390                                                          
         CLI   CUR.DOSTSTAT,QRECALL  ARE WE RECALLING?                          
         JE    CHOR390                                                          
*                                                                               
         L     R4,AIO3                                                          
         TM    DORSTAT-DOKEY(R4),DORSVDAQ  X'02' - CNFRMED VIDEA ORDER?         
         JNZ   CHOR320                     YES, IT IS ALREADY                   
         CLI   CUR.DOSTSTAT,DSENT  X'81' - SENDING EDI?                         
         JNE   CHOR320             NO                                           
         TM    MISCFLG2,MF2VIDEA   X'01' - DOWIG HAS VIDEA?                     
         JZ    CHOR320             NO                                           
         OI    DOSPFLG3-DOSPEL(RF),DOSPFVDA X'80' - LAST SENT TO VIDEA          
*                                                                               
CHOR320  LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSTELQ      X'12' STATUS ELEMENT                         
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,NEXTEL           WAS THE ORDER SENT B4?                       
         JNE   CHOR390             NO                                           
         USING DOSTELD,R4                                                       
*                                                                               
         CLI   DOSTSTAT,QEMPTY     DON'T INC IF EMPTY STATUS B4                 
         JE    CHOR390                                                          
         NI    DOSPFLG2,X'FF'-DOSPRSND  CLR NEED TO RESEND FLG                  
*                                                                               
         CLI   CUR.DOSTSTAT,DFXSENT  FAX SENDING?                               
         JNE   CHOR340                                                          
         LLC   R0,DOSPFXRV                                                      
         AHI   R0,1                INCREMENT THE FAX REVISION #                 
         STC   R0,DOSPFXRV         BUMP IT UP BY ONE                            
         CHI   R0,255                                                           
         JH    COETMNRV            ERROR, TOO MANY FAX VERSIONS                 
*                                                                               
CHOR340  SR    R0,R0                                                            
         ICM   R0,3,DOSPVER#       INC THE VERSION#                             
         C     R0,=X'0000FFFF'                                                  
         JH    *+2                                                              
         AHI   R0,1                INCREMENT THE VERSION #                      
         STCM  R0,3,DOSPVER#       BUMP IT UP BY ONE                            
         J     CHOR360                                                          
*                                                                               
CHOR350  BRAS  RE,NEXTEL                                                        
         JNE   CHOR390                                                          
CHOR360  CLI   DOSTSTAT,DDLVRD     WAS IT DELIVERED?                            
         JE    CHOR350              YES, CHECK NEXT STATUS                      
         CLI   DOSTSTAT,QTOBESNT   WAS IT SENT PENDING?                         
         JE    CHOR350              YES, CHECK NEXT STATUS                      
         CLI   DOSTSTAT,QSNTXCNF   WAS IT SEND CANCELLED, PART. CNFRM           
         JE    CHOR350              YES, CHECK NEXT STATUS                      
         CLI   DOSTSTAT,QSNTPNDG   WAS IT SENT PENDING?                         
         JE    CHOR350              YES, CHECK NEXT STATUS                      
*                                                                               
* FOR OE CANCELLED CONFIRMED WORKFLOW, IF RESENDING VIA DARE OR FAX             
* RESET THE REVISION NUMBER TO 0                                                
*                                                                               
         CLI   DOSTSTAT,QCFMD      WAS IT CONFIRMED?                            
         JNE   CHOR365                                                          
         CLI   DOSTLEN,DOSTLNQ3    HAVE EXTENDED BIT?                           
         JL    CHOR370                                                          
         TM    DOSTTYPE,DCNFMCAN   CANCEL CONFIRMED?                            
         JZ    CHOR370                                                          
         CLI   DOSPIMTH,C'E'       INITIAL EMAIL CANCELLED CONFIRMED?           
         JNE   CHOR370                                                          
         MVI   DOSPREVN,0          YES, RESET REVISION BACK TO 0                
         J     CHOR390                                                          
*                                                                               
CHOR365  CLI   DOSTSTAT,QBYRCNFM   WAS IT BUYER CONFIRMED?                      
         JNE   CHOR390                                                          
         DROP  R4                                                               
CHOR370  LLC   R0,DOSPREVN                                                      
         AHI   R0,1                INCREMENT THE REVISION #                     
         STC   R0,DOSPREVN         BUMP IT UP BY ONE                            
         CHI   R0,255                                                           
         JH    COETMNRV            TOO MANY REVISIONS                           
*                                                                               
CHOR390  CLI   CUR.DOSTSTAT,DSENT    IS THE ORDER BEING SENT/CANCEL?            
         JE    CHOR400                                                          
         CLI   CUR.DOSTSTAT,DFXRSNT  OR FAXED                                   
         JE    CHOR400                                                          
         CLI   CUR.DOSTSTAT,DFXSENT  OR RESEND FAX?                             
         JNE   CHOR410                                                          
CHOR400  MVC   DOSPIDST,DOSPDEST                                                
         MVC   DOSPIMTH,DOSPMTHD                                                
         DROP  RF                                                               
*                                                                               
CHOR410  MVI   BYTE,0                                                           
         XC    FULL,FULL                                                        
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)  R4 = A(FIRST ELEMENT IN RECORD)            
CHOR420  CLI   0(R4),0           ADD AFTER ALL TRANSMISSION ELEMENTS..          
         JE    CHOR430                                                          
         CLI   0(R4),DORPELQ2    AND BEFORE A X'09' REP CHANGE ELEMENT          
         JNE   CHOR422                                                          
         OC    FULL,FULL         ALREADY HAVE A SAVED INSERTION ADDR            
         JNZ   CHOR422            YES                                           
         ST    R4,FULL            NO, SAVE THE INERTION ADDRESS                 
CHOR422  CLI   0(R4),DOSTELQ     OR AUDIT X'12' ELEMENT                         
         JE    CHOR425                                                          
         JH    CHOR430                                                          
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         J     CHOR420                                                          
*                                                                               
         USING DOSTELD,R4                                                       
CHOR425  CLI   SVXMIT,C'R'         WANT TO RECALL ORDER?                        
***      JE    CHOR427                                                          
***      CLI   SVXMIT,C'C'         OR CANCEL ORDER?                             
         JNE   CHOR430                                                          
CHOR427  CLI   DOSTSTAT,QAPP                                                    
         JE    CHOR430                                                          
         CLI   DOSTSTAT,DDLVRD                                                  
         JNE   COENORCL                                                         
         LLC   RE,1(R4)                                                         
         AR    RE,R4                                                            
         CLI   DOSTSTAT-DOSTEL(RE),DSENT                                        
         JNE   COENORCL            CANNOT BE RECALLED                           
         DROP  R4                                                               
*                                                                               
CHOR430  OC    FULL,FULL                                                        
         JZ    *+8                                                              
         L     R4,FULL                                                          
         GOTOR ARECUP,DMCB,(C'S',AIO3),DOSTELEM,(R4)                            
*                                                                               
         MVI   BYTE,C'R'                                                        
         CLI   CUR.DOSTSTAT,QNODARE                                             
         JNE   *+8                                                              
         MVI   BYTE,C'K'                                                        
         MVC   IOADDR,AIO3                                                      
         GOTOR COLPASKY,DMCB,(BYTE,0)                                           
*                                                                               
         LA    R0,TSARREC          CLEAR TSARREC                                
         LHI   R1,L'TSARREC                                                     
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         CLI   CUR.DOSTSTAT,QSNTPNDG                                            
         JE    CHOR540                                                          
         DROP  R3,CUR                                                           
*                                                                               
         MVI   ORXTYPE,ORXTYPEQ                                                 
*                                                                               
         L     R4,AIO3                                                          
         USING DAREORDD,R4                                                      
         MVC   ORXAGM,DOKAGMD                                                   
         MVI   ELCDLO,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         MVI   ELCDHI,DOIDELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
         MVC   ORXCLT,DOIDCLT                                                   
*                                                                               
         L     RF,ACLTREC                                                       
         USING CLTRECD,RF          R3=A(CLIENT RECORD)                          
         MVC   CLTNM,CNAME                                                      
         TM    COPT4,COP4TRD       IS THIS A TRADE CLIENT                       
         JZ    *+8                                                              
         OI    CLTFLAG1,CLTTRADE                                                
         DROP  RF                                                               
*                                                                               
         MVC   ORXPRD,DOIDPRD                                                   
         MVC   SVBPRD,DOIDPRD                                                   
         GOTOR (#EDTPRD,AEDTPRD),DMCB,DOIDPRD,0,SVQPRD                          
         MVC   ORXPRD2,DOIDPRD2                                                 
         MVC   SVBPR2,DOIDPRD2                                                  
         OC    DOIDPRD2,DOIDPRD2                                                
         JZ    CHOR440                                                          
         GOTOR (#EDTPRD,AEDTPRD),DMCB,DOIDPRD2,0,SVQPR2                         
CHOR440  MVC   ORXSTAC,DOISTA                                                   
         MVC   ORXEST,DOIDEST                                                   
         MVC   ORXFLT,DOIDFLTN                                                  
         MVC   SVBEST,DOIDEST                                                   
         LLC   R1,DOIDEST                                                       
         CVD   R1,DUB                                                           
         UNPK  SVQEST,DUB                                                       
         OI    SVQEST+2,X'F0'                                                   
         MVC   SVBFLT,DOIDFLTN                                                  
         MVC   SVBSTA,DOISTA                                                    
*                                                                               
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,NEXTEL                                                        
         USING DOSPELD,R4                                                       
         NI    SVFLAG1,X'FF'-SF1TRADE                                           
         MVC   DRCSHTRD,DOSPTMTH                                                
         NI    ORXFLAG,X'FF'-ORXTRADE                                           
         CLI   DOSPTMTH,TRDESREP       TRADE ONLY?                              
         JNE   CHOR450                                                          
         OI    SVFLAG1,SF1TRADE                                                 
         OI    ORXFLAG,ORXTRADE                                                 
CHOR450  MVC   ORXMKT,DOSPMKT                                                   
         MVC   SVBMKT,DOSPMKT                                                   
         DROP  R4                                                               
*                                                                               
         MVC   ORXORDDA,ORD1ADDR                                                
         MVI   ELCDLO,DOSTELQ      X'12' STATUS ELEMENT                         
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,NEXTEL                                                        
         USING DOSTELD,R4                                                       
         MVC   ORXSTATS,DOSTSTAT                                                
*                                                                               
         CLI   ORXSTATS,DSENT                                                   
         JNE   CHOR455                                                          
         CLI   DOSTLEN,DOSTLNQ7    CHECK IF ITS CANCELLED                       
         JNE   CHOR460                                                          
         MVC   ORXSTATF,DOSTTYP2                                                
         J     CHOR460                                                          
*                                                                               
CHOR455  CLI   ORXSTATS,DFXSENT                                                 
         JE    CHOR460                                                          
         CLI   ORXSTATS,DFXRSNT                                                 
         JNE   CHOR540                                                          
*                                                                               
CHOR460  BRAS  RE,GTESTINF         READ ESTIMATE RECORD INTO AIO7               
*                                                                               
         GOTOR GTFLTINF,DMCB,(C'L',0)  GET FLT REC AIO8 & SET FLT LOCK          
         JNE   COEINVFL                                                         
         CLI   SVBFLT,0                                                         
         JE    CHOR464                                                          
         TM    FLTRCFLG,FRFEXIST   FLIGHT RECORD FOUND?                         
         JZ    COEINVFL            CANNOT ADD THIS FLIGHT                       
*                                                                               
CHOR464  BRAS  RE,FRSTAIRD                                                      
         JE    CHOR465                                                          
         TM    CURRFLAG,CRFERROR   WAS THERE AN ERROR?                          
         JO    CHORXN              -YES, EXIT                                   
*                                                                               
CHOR465  L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOSPELD,R4                                                       
         XC    DOSPFAID,DOSPFAID                                                
         CLC   SVAIRDAT,EFFS                                                    
         JE    *+10                                                             
         MVC   DOSPFAID,SVAIRDAT                                                
         OC    DOSPFSTA,DOSPFSTA                                                
         JNZ   *+10                                                             
         MVC   DOSPFSTA,ORXSTAC                                                 
*                                                                               
         MVI   BYTE,DOCOMELQ       REMOVE THE ERRORS                            
CHOR470  MVC   ELCDLO,BYTE                                                      
         MVC   ELCDHI,BYTE                                                      
         L     R4,AIO3                                                          
         BRAS  RE,GETEL                                                         
         JNE   CHOR540                                                          
         GOTOR ARECUP,DMCB,(C'S',AIO3),(R4)                                     
         J     CHOR470                                                          
*                                                                               
CHOR540  XC    SVDESTID,SVDESTID                                                
         CLI   SVMED,C'R'          IS IT RADIO?                                 
         JNE   CHOR570             NO, SKIP UPDATING SALESPERSON RECORD         
         L     R4,AIO3                                                          
         MVC   BYTE,DOKSTA-DAREORDD+2(R4)    LETS ISOLATE BAND                  
         NI    BYTE,X'0F'                                                       
         CLI   BYTE,X'06'          PANDORA RADIO STREAMING STATION?             
         JE    CHOR570              YES, SKIP                                   
         CLI   BYTE,X'07'          I-HEART RADIO STREAMING STATION?             
         JE    CHOR570              YES, SKIP                                   
*                                                                               
         MVI   ELCDLO,DOWIGELQ     X'50' WHERE IT GO ELEMENT                    
         MVI   ELCDHI,DOWIGELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         USING DOWIGELD,R4                                                      
         CLI   DOWIGMTH,C'I'       IF ITS NOT INBOX, DON'T BOTHER               
         JNE   CHOR570                                                          
         CLC   SALESPER,SPACES                                                  
         JNH   COEMSSLP                                                         
*                                                                               
CHOR550  BRAS  RE,GTDESTID                                                      
*                                                                               
         BRAS  RE,CHKRPSAL                                                      
         JNE   COEINVSP                                                         
CHOR560  BRAS  RE,UPSALREC         UPDATE THE X'04' SALESPERSON RECORD          
*                                                                               
CHOR570  CLI   ORXSTATS,0          SEND IT LATER?                               
         JE    CHOR600             YES                                          
         GOTOR BUFFER,DMCB,('TSAADD',0)                                         
         JNE   *+2                                                              
*                                                                               
         CLI   ORXSTATS,DSENT                                                   
         JE    CHOR580                                                          
         CLI   ORXSTATS,DFXSENT                                                 
         JE    CHOR580                                                          
         CLI   ORXSTATS,DFXRSNT                                                 
         JNE   CHOR600                                                          
CHOR580  TM    SVFLAG1,SF1TRADE    ARE WE DOING TRADE?                          
         JZ    *+8                 NO                                           
         BRAS  RE,SETMETHD         UPDATE CASH ORDER W/TRADE SPEC REP           
CHOR590  BRAS  RE,UPDBATCH         UPDATE BATCH RECORD FOR MED/CLT..PR2         
         MVI   BYTE2,SPAUPDSN      UPDATE DARE SENT DATE                        
         BRAS  RE,CHKAUTH                                                       
CHOR600  DS    0H                                                               
*                                                                               
CHORXY   J     EXITY                                                            
*                                                                               
COEREQDT GOTOR PUTERR,DMCB,('SE#SY002',SI#REQDT)   SEND AN ERROR                
         J     CHORXN                                                           
COEIVSTC GOTOR PUTERR,DMCB,('SE#SY023',SE#IVSTC)   INVL STD COMMENT             
         J     CHORXN                                                           
COEINVDM GOTOR PUTERR,DMCB,('SE#SY002',SE#INVDM)   INVALID DEMOS                
         J     CHORXN                                                           
COENOFAX GOTOR PUTERR,DMCB,('SE#SY002',SE#NOFAX)   FAXING DISABLED              
         J     CHORXN                                                           
COENODAR GOTOR PUTERR,DMCB,('SE#SY023',SE#NODAR)   NOT A DARE TRADING-          
         J     CHORXN                                PARTNER, NO EDI            
COENTSNT GOTOR PUTERR,DMCB,('SE#SY023',SE#NTSNT)   CAN'T SEND FOR THIS          
         J     CHORXN                                STATION                    
COENORST GOTOR PUTERR,DMCB,('SE#SY023',SE#NORST)   CANNOT BE RESENT             
         J     CHORXN                                                           
COENOSNT GOTOR PUTERR,DMCB,('SE#SY023',SE#NOSNT)  ORDER WAS NOT SENT            
         J     CHORXN                                                           
COEUNEXP GOTOR PUTERR,DMCB,('SE#SY003',SE#UNEXP)  UNEXPECTED INPUT              
         J     CHORXN                                                           
COETMNRV GOTOR PUTERR,DMCB,('SE#SY023',SE#TMNRV)  TOO MANY REVISIONS!           
         J     CHORXN                                                           
COENORCL GOTOR PUTERR,DMCB,('SE#SY023',SE#NORCL)  CANNOT BE RECALLED            
         J     CHORXN                                                           
COEINVFL GOTOR PUTERR,DMCB,('SE#SY023',SE#INVFL)  CANNOT ADD FLIGHT             
         J     CHORXN                                                           
COEINBYR GOTOR PUTERR,DMCB,('SE#SY002',SE#INBYR)   INVALID BUYER                
         J     CHORXN                                                           
COEMSSLP GOTOR PUTERR,DMCB,('SE#SY023',SE#MSSLP)   MISSING SALESPERSON          
         J     CHORXN                                                           
COEINVSP GOTOR PUTERR,DMCB,('SE#SY023',SE#INVSP)   INVALID SALESPERSON          
         J     CHORXN                                                           
COEONTSN GOTOR PUTERR,DMCB,('SE#SY023',SE#ONTSD)   ORDER NOT SENT               
CHORXN   J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* FOR TEST IDS, ONLY ALLOW SENDING FOR CERTAIN STATIONS AND REPS                
***********************************************************************         
SNDTSTID NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         GOTO1 VGETFACT,DMCB,0                                                  
         L     R3,DMCB                                                          
         USING FACTSD,R3                                                        
         CLI   FADSPACE-FACTSD(R3),C'C' CSC DSPACE?                             
         JE    STIYES                   YES, ALLOW SEND                         
         CLI   FADSPACE-FACTSD(R3),C'R' REP DSPACE?                             
         JE    STINO                    YES, DON'T ALLOW SEND                   
*                                                                               
         CLI   FADSPACE-FACTSD(R3),C'T' TST DSPACE?                             
         JE    STI050                                                           
         CLI   FADSPACE-FACTSD(R3),C'Q' FQA DSPACE?                             
         JE    STI050                                                           
*                                                                               
         CLI   FADSPACE-FACTSD(R3),C'A' ADV DSPACE?                             
         JE    STI010                                                           
         CLI   FADSPACE-FACTSD(R3),C'P' PROD DSPACE?                            
         JNE   STINO                     UNKNOWN DSPACE, DON'T ALLOW            
*                                                                               
*  IF ADV OR PROD DSPACE, CHECK ACCESS RECORD FOR TEST ID FLAG                  
*                                                                               
STI010   LA    R2,IOKEY                                                         
         USING CT5REC,R2                                                        
         XC    CT5KEY,CT5KEY                                                    
         MVI   CT5KTYP,CT5KTYPQ    C'5'                                         
         MVC   CT5KALPH,LP_AGY                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOBRD+IOCTFILE+B#ACCREC'                      
         JNE   STINO                                                            
                                                                                
         L     R2,IOADDR                                                        
         LA    R2,CT5DATA          R2=A(FIRST ELEMENT ON ID RECORD)             
         USING CTAGDD,R2                                                        
         SR    R0,R0                                                            
STI020   CLI   CTAGDEL,0           TEST END OF RECORD                           
         JE    STINO                                                            
         CLI   CTAGDEL,CTAGDELQ    X'B4' AGENCY GROUP DETAILS?                  
         JE    STI030                                                           
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         J     STI020                                                           
STI030   TM    CTAGOPTS,CTAGTST+CTAGUAT  TESTING OR UAT ID?                     
         JZ    STIYES                     NO, ALLOW SEND                        
         J     STI060                     YES, APPLY RESTRICTIONS               
*                                                                               
* NO LONGER USING TESTID TABLE                                                  
*                                                                               
*&&DO                                                                           
STI040   LA    RF,TESTIDS                                                       
STI045   CLI   0(RF),0             EOT?                                         
         JE    STINO                YES, DON'T ALLOW SEND                       
         CLC   LP_AGY,0(RF)        ARE WE SENDING FROM A TEST ID?               
         JE    STI060               YES                                         
         AHI   RF,L'TESTIDS                                                     
         J     STI045                                                           
*&&                                                                             
************                                                                    
* EXCLUSIVE RULE FOR T/Q DSPACE                                                 
************                                                                    
STI050   CLC   =C'0000',SVSTAEDT   SENDING TO CABLE STATION?                    
         JL    STIYES              - YES, ALLOW                                 
         CLC   =C'PAAT-SM',SVSTAEDT  SENDING TO STREAMING PANDORA?              
         JE    STIYES                - YES, ALLOW                               
*                                                                               
         CLC   =C'CMNY-DV',SVSTAEDT  SENDING TO CMNY-DV?                        
         JE    STIYES                - YES, ALLOW                               
*                                                                               
************                                                                    
* RULE FOR (T/Q DSPACE) OR (A/P DSPACE & TEST AGENCY)                           
************                                                                    
STI060   CLC   =C'YY',SVSTAEDT     ALLOW SENDING TO TEST STATIONS               
         JE    STIYES                                                           
*                                                                               
************                                                                    
* EXCLUSIVE RULE FOR T/Q DSPACE                                                 
* IF STATION NOT ON EXCEPTION LIST, THEN ALLOW SENDING                          
* 1) TO ALL DXXXX STATIONS REP OR RECEIVING ID                                  
* 2) TO ALL LIVE STATIONS IF REP IS A TEST REP                                  
*                                                                               
* NOTE: PER EVAN/WALTER/ANTHONY, THIS WILL NO LONGER BE SUPPORTED.              
*                                                       -HWON 6/15/2018         
************                                                                    
STI070   DS    0H                                                               
         J     STINO                                                            
*&&DO                                                                           
         CLI   FADSPACE-FACTSD(R3),C'T' TST DSPACE?                             
         JE    STI080                                                           
         CLI   FADSPACE-FACTSD(R3),C'Q' FQA DSPACE?                             
         JNE   STINO                                                            
*                                                                               
STI080   BRAS  RE,GTDESTID                                                      
*                                                                               
         GOTOR VGETDARE,DMCB,(C'U',0),SVDESTID,AIO8,A(IO8LQ),VDATAMGR           
         JE    STI090              MUST BE SENDING TO STATION                   
***      CLC   =C'D',SVSTAEDT      TEMP ALLOW D STATION SENDING                 
***      JE    STIYES                                                           
         J     STINO                                                            
*                                                                               
STI090   L     RE,AIO8                                                          
         USING DAREPTD,RE                                                       
         TM    DAPTFLG1,DPF1TSTR   STATION HAS TEST REP?                        
         JZ    STINO                                                            
         DROP  RE                                                               
*&&                                                                             
STIYES   J     EXITY                                                            
STINO    J     EXITN                                                            
       ++INCLUDE DDTSTIDTAB                                                     
***********************************************************************         
* SBTK DEFECT IN 157 ALLOWS SENDING EDI ORDER IN OPENED STATUS                  
*  THIS CODE WILL VALIDATE SEND ACTION IS VALID                                 
***********************************************************************         
ALLOWSND NTR1  BASE=*,LABEL=*                                                   
         CLI   SVXMIT,C'S'         ARE WE SENDING                               
         JNE   ALSYES                                                           
         CLI   SVMTHD,C'I'         ARE WE GOING EDI?                            
         JNE   ALSYES               NO, THEN ALLOW SEND                         
         CLI   SVMED,C'R'          ARE WE RADIO?                                
         BNE   ALS010               NO, THEN STATUS                             
         CLI   SVQSTA+4,C'S'       ARE WE SM OR CM?                             
         BE    ALS010               YES, CHECK STATUS                           
         CLI   SVQSTA+4,C'C'                                                    
         BNE   ALSYES                                                           
                                                                                
ALS010   L     R4,AIO3                                                          
         MVI   ELCDLO,DOSTELQ      CHECK IF IN OPENED STATUS                    
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,GETEL                                                         
         BNE   ALSYES                                                           
         CLI   DOSTSTAT-DOSTELD(R4),QAPP  IF OPENED STATUS                      
         JE    EXITN                       DON'T ALLOW SEND                     
ALSYES   J     EXITY                                                            
***********************************************************************         
* ADD A NEW ORDER                                                               
*  CLOBBERS, AIO3 AND IOKEY                                                     
***********************************************************************         
ADDORDER NTR1  BASE=*,LABEL=*                                                   
         BRAS  RE,GETPROFS                                                      
         L     RE,AIO3                                                          
         LHI   RF,IO3LQ                                                         
         XCEFL                                                                  
*                                                                               
         LA    R4,IOKEY                                                         
         USING DOKEY,R4                                                         
         XC    DOKEY,DOKEY                                                      
         MVI   DCKTYPE,DCKTYPQ                                                  
         MVI   DCKSUBTY,DCKSTYPQ                                                
         MVC   DCKAGMD(SVFLAG1-SVBAGM+L'SVFLAG1),SVBAGM                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    ADOR001                                                          
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNZ   ADOR004                                                          
         DC    H'0'                                                             
*                                                                               
ADOR001  SR    R0,R0               BUILD DOWNLOAD MAP ELEMENT                   
         ICM   R0,3,LP_QMAPN                                                    
         AHI   R0,1                                                             
         GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTMAP',(R0))                  
*                                                                               
         MVC   ORD1ADDR,IOKEY+14                                                
         GOTOR PUTORD,ORD1ADDR     SEND RUN REQUEST AND DISK ADDRESS            
         GOTOR PUTERR,DMCB,('SE#SY002',SE#RCXST)                                
         J     ADORXN                                                           
*                                                                               
ADOR004  TM    SVFLAG1,SF1TRADE    IS THIS A TRADE ORDER?                       
         JNZ   ADOR005             YES,                                         
         MVC   IOKEY,IOKEYSAV      NO, CHECK FOR TRADE ORDER                    
         OI    DCKFLAG,DCKFTRDE                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JNE   *+2                                                              
         CLC   IOKEY(L'DOKEY),IOKEYSAV                                          
         JNE   ADOR005                                                          
         OI    MISCFLG1,MF1TRDCD   WE HAVE A TRADE CONDITION                    
         DROP  R4                                                               
*                                                                               
ADOR005  L     R4,AIO3                                                          
         USING DOKEY,R4                                                         
         MVI   DOKTYPE,DOKTYPQ                                                  
         MVI   DOKSUBTY,DOKSTYPQ                                                
         MVC   DOKAGMD,SVBAGM                                                   
         MVC   DOKSTA,SVBSTA                                                    
         MVC   DORLEN,=Y(DORFRST-DOKEY)                                         
         MVC   DORAGY,LP_AGY                                                    
         DROP  R4                                                               
*                                                                               
         LA    R2,ELEM                                                          
         XC    ELEM,ELEM                                                        
         USING DOIDELD,R2                                                       
         MVI   DOIDEL,DOIDELQ                                                   
         MVI   DOIDLEN,DOIDLNQ                                                  
         ICM   RE,15,I$BYR                                                      
         JNZ   ADOR007                                                          
         USING LW_D,RE                                                          
         GOTOR PUTERR,DMCB,('SE#SY023',SE#NOADD)                                
         J     ADORXN                                                           
ADOR007  MVC   SVQBYR,LW_DATA1                                                  
         OC    SVQBYR,SPACES                                                    
         BRAS  RE,VALBYR                                                        
         JE    ADOR008                                                          
         GOTOR PUTERR,DMCB,('SE#SY002',SE#INBYR)                                
         J     ADORXN                                                           
         DROP  RE                                                               
*                                                                               
ADOR008  GOTOR VRCPACK,DMCB,(C'P',SVQBYR),SVRBYR                                
         MVC   DOIDBYR,SVQBYR                                                   
         MVC   DOIDCLT,SVBCLT                                                   
         MVC   DOIDPRD,SVBPRD                                                   
         MVC   DOIDPRD2,SVBPR2                                                  
         MVC   DOIDEST,SVBEST                                                   
         MVC   DOISTA,SVBSTA                                                    
         MVC   DOIDFLTN,SVBFLT                                                  
         DROP  R2                                                               
*                                                                               
         GOTOR VHELLO,DMCB,(C'P',=C'SPTFIL'),AIO3,ELEM,0                        
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R2,ELEM                                                          
         USING DOSPELD,R2                                                       
         MVI   DOSPEL,DOSPELQ                                                   
         MVI   DOSPLEN,DOSPLNQ2                                                 
         ZAP   DOSPTOTL,=P'0'                                                   
         MVC   DOSPMKT,SVBMKT                                                   
         MVC   DOSPCRTR,SVBORGID   SAVE THE CREATOR OF THE ORDER                
         GOTO1 VDATCON,DMCB,(5,0),(19,DOSPCDAT)   CREATION DATE PWOS            
*                                                                               
         TM    SVFLAG1,SF1TRADE    X'80' - TRADE ORDER                          
         JZ    ADOR010                                                          
         OI    DOSPFLG1,DOSPTRDE   THIS IS THE TRADE ORDER                      
         MVI   DOSPTMTH,TRDESREP     USING SPECIAL REP CODE FOR TRADE           
         J     ADOR012                                                          
*                                                                               
ADOR010  OC    PDARTSRP(3),PDARTSRP ANY SPECIAL REP IN DARE PROFILE?            
         JZ    ADOR015             NONE                                         
         CLC   PDARTSRP(3),EZEROS  EBCDIC ZEROS                                 
         JE    ADOR015             NONE                                         
         TM    MISCFLG1,MF1TRDCD                                                
         JZ    ADOR015                                                          
         MVI   DOSPTMTH,TRDESREP-X'40'  LOWERCASE FOR CASH (X'99')              
ADOR012  MVC   DOSPTDAT(3),PDARTSRP  SPECIAL REP CODE USED STORED HERE          
ADOR015  GOTOR VHELLO,DMCB,(C'P',=C'SPTFIL'),AIO3,ELEM,0                        
*                                                                               
         LA    R2,ELEM                                                          
         USING COLOREL,R2                                                       
         XC    ELEM,ELEM                                                        
         MVI   COLEL,COLELQ                                                     
         MVI   COLELLEN,COLLENQ                                                 
         MVI   COLCOL,C'G'                                                      
         MVC   COLDATE,COMPDATE                                                 
         XC    COLDATE,EFFS                                                     
         GOTOR VHELLO,DMCB,(C'P',=C'SPTFIL'),AIO3,ELEM,0                        
*                                                                               
         GOTOR NXTORDNM                                                         
         JNE   ADORXN                                                           
*                                                                               
         MVC   PREVKEY,CURRKEY                                                  
*                                                                               
         L     R4,AIO3                                                          
         USING DOKEY,R4                                                         
         MVC   DOKORDER,BINORDER                                                
         XC    IOKEY,IOKEY                                                      
         MVC   IOKEY(L'DOKEY),0(R4)                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOFIL+IO3'                           
         JNE   *+2                                                              
         MVC   ORD1ADDR,IODA                                                    
*                                                                               
         GOTOR ADDPKEYS                                                         
*                                                                               
         BRAS  RE,CHKFRCHG         ADD CHECK FOR CHANGE XPOT KEYS               
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY                                                         
         USING DBTKEY,R2                                                        
         MVI   DBTKTYP,DBTKTYPQ                                                 
         MVI   DBTKSTYP,DBTKSTYQ                                                
         MVC   DBTKAGMD,SVBAGM                                                  
         MVC   DBTKCLT,SVBCLT                                                   
         MVC   DBTKPRD,SVBPRD                                                   
         MVC   DBTKEST,SVBEST                                                   
         MVC   DBTKMKT,SVBMKT                                                   
         MVC   DBTKSTA,SVBSTA                                                   
         MVC   DBTKPRD2,SVBPR2                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO5'                               
         JNE   ADORXY                                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO5'                           
         JNE   *+2                                                              
*                                                                               
         XC    ELEM,ELEM                                                        
         L     R4,AIO5                                                          
         MVI   ELCDLO,DBFLTELQ     X'20' FLIGHT ELEMENT                         
         MVI   ELCDHI,DBFLTELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   ADOR040                                                          
         USING DBFLTELD,R4                                                      
ADOR020  CLC   DBFLTFLT,SVBFLT                                                  
         JNE   ADOR025                                                          
         TM    SVFLAG1,SF1TRADE       DOING TRADE ORDER NOW?                    
         JZ    ADOR024                                                          
         TM    DBFLTFL1,DBFLTTRD                                                
         JO    ADOR030                                                          
         J     ADOR025                                                          
ADOR024  TM    DBFLTFL1,DBFLTTRD                                                
         JZ    ADOR030                                                          
ADOR025  BRAS  RE,NEXTEL                                                        
         JE    ADOR020                                                          
         J     ADOR040                                                          
*                                                                               
ADOR030  TM    DBFLTFL1,DBFLTDAR   ALREADY LINKED?                              
         JNZ   ADORXY              YES, NOTHING TO CHANGE                       
         LLC   R1,DBFLTLEN                                                      
         MVC   ELEM(0),DBFLTEL                                                  
         EX    R1,*-6                                                           
         GOTOR ARECUP,DMCB,(C'S',AIO5),(R4),(R4)                                
         DROP  R4                                                               
*                                                                               
ADOR040  LA    R1,ELEM                                                          
         USING DBFLTELD,R1                                                      
         MVI   DBFLTEL,DBFLTELQ                                                 
         MVI   DBFLTLEN,DBFLTOVH                                                
         MVC   DBFLTFLT,SVBFLT                                                  
         OI    DBFLTFL1,DBFLTDAR                                                
         DROP  R1                                                               
         GOTOR ARECUP,DMCB,(C'S',AIO5),ELEM,(R4)                                
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOPUT+IOFIL+IO5'                              
*                                                                               
ADORXY   GOTO1 VDATAMGR,DMCB,(0,=C'COMMIT'),0                                   
         J     EXITY                                                            
ADORXN   J     EXITN                                                            
*                                                                               
***********************************************************************         
* GET THE PROFILES                                                              
*  ON ENTRY : QMEDA AND QCLTA                                                   
*   ON EXIT : PROFOM, PROFDAR, PROFDX                                           
***********************************************************************         
GETPROFS NTR1                                                                   
         TM    PROFFLG1,PF1READ                                                 
         JNZ   GTPFXY                                                           
         OI    PROFFLG1,PF1READ                                                 
*                                                                               
         XC    WORK2,WORK2                                                      
         MVC   WORK2(4),=C'S0OM'                                                
         MVC   WORK2+4(2),LP_AGY   AGENCY ONLY                                  
         L     RF,ACOMFACS                                                      
         L     RF,CGETPROF-COMFACSD(RF)                                         
         GOTO1 (RF),DMCB,(X'D0',WORK2),PROFOM,VDATAMGR                          
*                                                                               
         MVC   WORK2+6(1),QMEDA                                                 
         MVC   WORK2+7(3),QCLTA                                                 
*                                                                               
         L     RE,ACLTREC                                                       
         USING CLTRECD,RE                                                       
         MVI   WORK2+10,C'*'                                                    
         MVC   WORK2+11(1),COFFICE                                              
         DROP  RE                                                               
*                                                                               
         MVC   WORK2+32(1),PROFOM+1   SAVE OFF "Uses New Order #'s"             
         GOTOR (RF),DMCB,(X'C0',WORK2),PROFOM,VDATAMGR                          
         MVC   PROFOM+1(1),WORK2+32   WANT AGY-LVL FOR "Uses New .."            
*                                                                               
         MVC   WORK2(4),=C'S000'                                                
         GOTOR (RF),DMCB,(X'C0',WORK2),PROFS00,VDATAMGR                         
*                                                                               
         MVC   WORK2(4),=C'sDAR'                                                
         GOTOR (RF),DMCB,(X'C0',WORK2),PROFDAR,VDATAMGR                         
*                                                                               
         MVC   WORK2(4),=C'S0DX'                                                
         GOTOR (RF),DMCB,(X'C0',WORK2),PROFDX,VDATAMGR                          
*                                                                               
         MVC   WORK2(4),=C'S0D2'                                                
         GOTOR (RF),DMCB,(X'C0',WORK2),PROFD2,VDATAMGR                          
*                                                                               
         LA    R1,PROFDX           GET DEFAULTS SET CORRECTLY !                 
         BRAS  RF,DXDFLTS          RE = A(DXDFLTS)                              
         LHI   RF,DXDFLTX-DXDFLTS                                               
*                                                                               
GTPF020  CLI   0(R1),0                                                          
         JNE   *+10                                                             
         MVC   0(1,R1),0(RE)                                                    
         AHI   R1,1                                                             
         AHI   RE,1                                                             
         BRCT  RF,GTPF020                                                       
         J     GTPF030                                                          
DXDFLTS  BASR  RE,RF                                                            
         DC    X'00'     +0        NUMBER OF DEMOS                              
         DC    C'N'      +1        NEW PAGE FOR CABLE NETWORK                   
         DC    C'N'      +2        NEW ORDER MANAGER FAXING                     
         DC    C'Y'      +3        FLAG DEMO OVERRIDES                          
         DC    C'Y'      +4        PRINT CPP                                    
         DC    C'Y'      +5        PRINT COSTS                                  
         DC    C'N'      +6        PUT COPY OF FAX TO PRTQUE                    
         DC    X'040101' +7/8/9    NEW FAX START DATE                           
DXDFLTX  EQU   *                                                                
*                                                                               
GTPF030  CLI   PDARDEMS,C'Y'       INCLUDE DEMOS ACCORDING TO PROFILE?          
         JNE   GTPFXY                                                           
         MVI   PDARDEMS,C'N'                                                    
         CLI   PROFDX,0                                                         
         JE    GTPFXY                                                           
         MVC   PDARDEMS(1),PROFDX                                               
         OI    PDARDEMS,X'F0'                                                   
         CLI   PROFDX,4            1-4 DEMOS                                    
         JNH   GTPFXY              HIGHER THAN THAT, WE KEEP AS 1               
GTPF040  MVI   PDARDEMS,1          A YES WOULD BE DEFAULT AS 1                  
*                                                                               
GTPFXY   J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* CALCULATES WHAT THE NEXT ORDER NUMBER SHOULD BE                               
*                                                                               
* ON EXIT:     BINORDER            WHAT NEXT ORDER NUMBER WILL BE               
***********************************************************************         
NXTORDNM NTR1                                                                   
         XC    IOKEY,IOKEY         SEE IF WE HAVE ANY SEQUENCE NUMBER           
         LA    R4,IOKEY              FOR THE IS PARTICULAR DATE                 
         USING DOKEY,R4                                                         
         MVI   DOKTYPE,DOKTYPQ                                                  
         MVI   DOKSUBTY,DOKSTYPQ                                                
         MVC   DOKAGMD,SVBAGM                                                   
*                                                                               
* TURNING ON NEW ORDER FOR ALL CLIENTS, SO TAKING THE BRANCH ALWAYS             
*                                              -HWON AUG20/2012                 
*        CLI   POMUSENW,C'Y'       USING NEW ORDER NUMBERS?                     
         B     NXTORD50            YES                                          
*                                                                               
* TURNING ON NEW ORDER FOR ALL CLIENTS, SO TAKING THE BRACH ALWAYS              
*                                                                               
         MVC   FULL,JDTTODAY       COPY TODAY'S JULIAN DATE                     
         XC    BINORDER,BINORDER                                                
*                                                                               
         ZAP   DUB,FULL            DIVIDE JULIAN DATE BY 1000 TO                
         SRP   DUB,61,0                ISOLATE THE CENTURY AND THE YEAR         
*                                                                               
         SP    DUB,=P'090'         CALCULATE NUMBER OF YEARS FROM 1990          
*                                                                               
         SRP   DUB,3,0             MULTIPLY BY 1000                             
         AP    DUB,FULL+2(2)       ADD NUMBER OF DAYS INTO THAT YEAR            
*                                                                               
         CVB   R0,DUB              CONVERT TO BINARY                            
         STCM  R0,3,BINORDDT                                                    
         XC    BINORDDT,EFFS                                                    
*                                                                               
         MVC   DOKORDDT,BINORDDT                                                
*********                                                                       
* READ FOR UPDATE SO WE DON'T GET TWO ORDERS WITH THE SAME ORDER #              
* ALSO READ FOR DELETE, WE DON'T WANT TO REUSE AN ORD #                         
*********                                                                       
         GOTOR (#IOEXEC,AIOEXEC),'IOHIUPD+IODIR+IO3'                            
         JE    *+12                                                             
         TM    IOERR,IOEDEL        RECORD IS DELETED?                           
         JZ    *+2                                                              
*                                                                               
         CLC   IOKEY(DOKORDSQ-DOKEY),IOKEYSAV   SAME DATE?                      
         JE    *+14                                                             
         MVC   BINORDSQ,EFFS                                                    
         J     NXTORDX                                                          
*                                                                               
         ZICM  R0,DOKORDSQ,2                                                    
         LTR   R0,R0                                                            
         JZ    *+2                                                              
         SHI   R0,1                                                             
         CLM   R0,3,=X'D8EF'       CAN'T HAVE > 10000 ORDERS PER DAY            
         JNH   NXTORD10                                                         
         STCM  R0,3,BINORDSQ                                                    
         J     NXTORD20                                                         
*                                                                               
NXTORD10 GOTOR PUTERR,DMCB,('SE#SY023',SE#MAXOR)   MAX OF 10000 ORDERS          
         J     EXITN                                                            
*                                                                               
NXTORD20 STCM  R0,3,FULL                                                        
         XC    FULL(2),EFFS                                                     
         ICM   R0,3,FULL                                                        
*                                                                               
         BRAS  RE,GTOTHRSH         RF = A(ORDER THRESHOLDS) TO INFORM           
NXTORD30 CLM   R0,3,0(RF)             DDS ABOUT                                 
         JE    NXTORDEM            SEND AN EMAIL                                
         JL    NXTORDX                                                          
*                                                                               
         LA    RF,L'OTHRSHLD(RF)                                                
         CLI   0(RF),0             EOT                                          
         JE    NXTORDX                                                          
         J     NXTORD30                                                         
*                                                                               
NXTORDEM BRAS  RE,GTOTHRMS         R3 = A(MESSAGE WE WANT TO EMAIL)             
         MVC   19(2,R3),LP_AGY                                                  
         MVC   22(1,R3),SVMED                                                   
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  28(4,R3),DUB                                                     
*                                                                               
         GOTO1 VDATAMGR,DMCB,=C'OPMSG',(L'OWRNMMSG,0(R3))                       
         J     NXTORDX                                                          
*********                                                                       
* NEW ORDER NUMBER SCHEME IS 04000000 (X'80000000') AND INCREMENTS              
*********                                                                       
NXTORD50 GOTOR (#IOEXEC,AIOEXEC),'IOHIUPD+IODIR+IO3'  NO RE-USING DEL           
NXTORD51 JE    *+12                                                             
         TM    IOERR,IOEDEL       RECORD IS DELETED?                            
         JZ    *+2                                                              
*                                                                               
         CLC   IOKEY(DOKORDER-DOKEY),IOKEYSAV   SAME AGY/MED?                   
         BNE   NXTORD70                       NOTHING FOR AGY/MED               
*                                                                               
         CLC   DOKORDER,=X'7FFFFFFF'  WE HAVE OLD STYLE NUMBER?                 
         BH    NXTORD70               YES, AGY STARTS WITH 04000000             
* HAVE TO ADD CODE B/C RP FILE HAS ORDER REC, MISSING BASE RECORD               
         CLI   DOKCMT,0            ARE WE LOOKING AT A BASE RECORD?             
         BNE   NXTORD60                                                         
*                                                                               
         ICM   R0,15,DOKORDER                                                   
         SHI   R0,1                                                             
         STCM  R0,15,BINORDER                                                   
         B     NXTORDX                                                          
*                                                                               
NXTORD60 GOTOR (#IOEXEC,AIOEXEC),'IOSQUPD+IODIR+IO3'  NO RE-USING DEL           
         B     NXTORD51                                                         
*                                                                               
NXTORD70 MVC   BINORDER,=X'7FFFFFFF'  BINORDER IS XC'D WITH EFFS                
*                                                                               
NXTORDX  J     EXITY                                                            
         DROP  R4                                                               
GTOTHRMS BASR  R3,RE               GET ORDER THRESHOLD MSG                      
OWRNMMSG DC    CL49'AUTONOTE*WHOA,HWON:??/? HAS ???? ORDERS TODAY !!!'          
*                   01234567890123456789012345678                               
GTOTHRSH BASR  RF,RE               GET ORDER THRESHOLDS                         
OTHRSHLD DS    0XL2                                                             
         DC    AL2(8500)                                                        
         DC    AL2(9000)                                                        
         DC    AL2(9500)                                                        
         DC    AL2(9600)                                                        
         DC    AL2(9700)                                                        
         DC    AL2(9800)                                                        
         DC    AL2(9900)                                                        
         DC    AL2(9950)                                                        
         DC    AL2(9960)                                                        
         DC    AL2(9970)                                                        
         DC    AL2(9980)                                                        
         DC    AL2(9990)                                                        
         DC    X'00'                                                            
         EJECT                                                                  
***********************************************************************         
* ADD THE PASSIVE KEYS                                                          
***********************************************************************         
ADDPKEYS NTR1                                                                   
         MVC   IOKEY+14(4),ORD1ADDR  SAVE THE DISK ADDRESS                      
         LA    R4,IOKEY            BUILD THE PASSIVE KEY FOR BUYER              
         USING DOKEY,R4                                                         
         XC    DOKEY,DOKEY                                                      
         MVI   DBKTYPE,DBKTYPQ                                                  
         MVI   DBKSUBTY,DBKSTYPQ                                                
         MVC   DBKAGMD,SVBAGM                                                   
         MVC   DBKBYR,SVQBYR                                                    
         MVC   DBKORD,BINORDER                                                  
         MVC   DBKSTA,SVBSTA                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR'                                  
         JNE   *+2                                                              
*                                                                               
         XC    DOKEY,DOKEY         BUILD THE PASSIVE KEY FOR BYR/STA            
         MVI   DSKTYPE,DSKTYPQ                                                  
         MVI   DSKSUBTY,DSKSTYPQ                                                
         MVC   DSKAGMD,SVBAGM                                                   
         MVC   DSKBYR,SVQBYR                                                    
         MVC   DSKSTA,SVBSTA                                                    
         MVC   DSKORD,BINORDER                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR'                                  
         JNE   *+2                                                              
*                                                                               
         XC    DOKEY,DOKEY                                                      
         MVI   DCKTYPE,DCKTYPQ     BUILD THE PASSIVE KEY FOR CLIENT             
         MVI   DCKSUBTY,DCKSTYPQ                                                
         MVC   DCKAGMD(SVFLAG1-SVBAGM+L'SVFLAG1),SVBAGM                         
         GOTOR (#IOEXEC,AIOEXEC),'IORDD+IODIR+IO3'                              
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNZ   ADPK020             GO ADD IT THEN                               
         TM    IOERR,IOEDEL        RECORD IS DELETED?                           
         JZ    *+2                 GO UNDELETE IT                               
*                                                                               
         NI    IOKEY+13,X'7F'      UNDELETE IT                                  
         MVC   IOKEY+14(4),ORD1ADDR  SAVE THE DISK ADDRESS                      
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO3'                            
         J     ADPK021                                                          
*                                                                               
ADPK020  MVC   IOKEY,IOKEYSAV      RESTORE KEY AND DA                           
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR'                                  
ADPK021  JNE   *+2                                                              
*                                                                               
         XC    DOKEY,DOKEY         BUILD THE COLOR PASSIVE KEY                  
         MVI   DSCKTYPE,DSCKTYPQ   X'0D'                                        
         MVI   DSCKSTYP,DSCKSTYQ   X'B8'                                        
         MVC   DSCKAGMD,SVBAGM     AGENCY/MEDIA                                 
         MVC   DSCKBYR,SVQBYR      CHAR BUYER                                   
         MVI   DSCKSTAT,C'G'       GREEN COLOR                                  
         MVC   DSCKDATE,COMPDATE                                                
         XC    DSCKDATE,EFFS                                                    
         MVC   DSCKORDR,BINORDER   ORDER NUMBER                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR'                                  
         JNE   *+2                                                              
*                                                                               
         XC    DOKEY,DOKEY         ADD CLT/PRD/EST/MKT/ORD# PASSIVE KEY         
         MVI   DCMKTYPE,DCMKTYPQ   X'0D'                                        
         MVI   DCMKSTYP,DCMKSTYQ   X'BD'                                        
         MVC   DCMKAGMD,SVBAGM     AGENCY/MEDIA                                 
         MVC   DCMKCLT,SVBCLT      CLIENT                                       
         MVC   DCMKPRD,SVBPRD      PRODUCT                                      
         MVC   DCMKEST,SVBEST      ESTIMATE                                     
         MVC   DCMKMKT,SVBMKT      MARKET                                       
         MVC   DCMKORDR,BINORDER   ORDER                                        
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR'                                  
         JNE   *+2                                                              
*                                                                               
         XC    DOKEY,DOKEY         ADD BYR/CLT/MKT/ORD# PASSIVE KEY             
         MVI   DBCKTYPE,DBCKTYPQ   X'0D'                                        
         MVI   DBCKSTYP,DBCKSTYQ   X'BE'                                        
         MVC   DBCKAGMD,SVBAGM     AGENCY MEDIA                                 
         MVC   DBCKBYR,SVRBYR      RCPACKED BUYER                               
         MVC   DBCKCLT,SVBCLT      CLIENT                                       
         MVC   DBCKMKT,SVBMKT      MARKET                                       
         MVC   DBCKORDR,BINORDER   ORDER NUMBER                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR'                                  
         JNE   *+2                                                              
*                                                                               
         XC    DOKEY,DOKEY         ADD BYR/MKT/CLT/ORD# PASSIVE KEY             
         MVI   DBMKTYPE,DBMKTYPQ   X'0D'                                        
         MVI   DBMKSTYP,DBMKSTYQ   X'BF'                                        
         MVC   DBMKAGMD,SVBAGM     AGENCY MEDIA                                 
         MVC   DBMKBYR,SVRBYR      RCPACKED BUYER                               
         MVC   DBMKMKT,SVBMKT      MARKET                                       
         MVC   DBMKCLT,SVBCLT      CLIENT                                       
         MVC   DBMKORDR,BINORDER   ORDER NUMBER                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR'                                  
         JNE   *+2                                                              
*                                                                               
         GOTO1 VDATAMGR,DMCB,(0,=C'COMMIT'),0                                   
*                                                                               
         J     EXITY                                                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* ADD CHECK FOR CHANGE XPOT KEYS                                                
***********************************************************************         
CHKFRCHG NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R2,IOKEY                                                         
         USING DOKEY,R2                                                         
         XC    IOKEY,IOKEY         ADD THE XSPOT PASSIVE KEY                    
         MVI   DODKTYPE,DODKTYPQ   X'0D'                                        
         MVI   DODKSTYP,DODKSTYQ   X'BC'                                        
         MVC   DODKAGMD,SVBAGM     AGENCY MEDIA                                 
         MVC   DODKCLT,SVBCLT      CLIENT                                       
         MVC   DODKMKT,SVBMKT      MARKET                                       
         MVC   DODKBYR,SVQBYR      BUYER                                        
         MVC   DODKEST,SVBEST      ESTIMATE                                     
         MVC   DODKPRD,SVBPRD      PRODUCT                                      
         MVC   DODKORDR,BINORDER   ORDER NUMBER                                 
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(2,DODKDATE)                                  
         THMS  DDSTIME=YES                                                      
         STCM  R0,15,PACKOF4B                                                   
         ST    R1,FULL                                                          
         AP    PACKOF4B,FULL                                                    
*                                                                               
         CP    PACKOF4B,=P'240000'    PAST MIDNIGHT?                            
         JL    CFC010                                                           
         SP    PACKOF4B,=P'240000'    YES, BUMP TO NEXT DAY AND ADJUST          
         GOTOR VDATCON,DMCB,(5,0),(0,DUB)   THE TIME                            
         GOTOR VADDAY,DMCB,DUB,DUB,F'1'                                         
         GOTOR VDATCON,DMCB,(0,DUB),(2,DODKDATE)                                
*                                                                               
CFC010   TIME  TU                  GET THE TIME IN 38400TH OF A SEC             
         STCM  R0,15,DODKTIME                                                   
         XC    DODKTIME,EFFS                                                    
*                                                                               
         MVC   IOKEY+36(4),ORD1ADDR DISK ADDRESS                                
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IOXSPDIR'                               
         JE    EXITY                                                            
         DC    H'0'                                                             
**********************************************************************          
* GET THE ESTIMATE RECORD INFORMATION                                           
*  ON ENTRY : SVBAGM, SVBCLT, SVQPRD, SVBEST                                    
*                                                                               
*  ON EXIT : AIO7 HAS THE ESTIMATE RECORD                                       
*            SEVERAL FIELDS HAVE BEEN SET                                       
*                                                                               
**********************************************************************          
GTESTINF NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R3,IOKEY            READ ESTIMATE HEADER                         
         USING ESTRECD,R3                                                       
         MVC   EKEYAM,SVBAGM                                                    
         MVC   EKEYCLT,SVBCLT                                                   
         MVC   EKEYPRD,SVQPRD                                                   
         MVC   EKEYEST,SVBEST                                                   
*                                                                               
         L     R3,AESTREC          R3 = AESTREC                                 
         CLC   IOKEY,0(R3)         ALREADY HAVE EST REC?                        
         BE    GEI010                                                           
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOBRD+IODIR+B#ESTREC'                         
         JNE   *+2                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOBGET+IOFIL+B#ESTREC'                        
         JNE   *+2                                                              
*                                                                               
GEI010   MVI   ESTFLAG1,0          INIT ESTFLAG1                                
         CLI   EDAILY,C'Y'         DAILY ESTIMATE?                              
         JNE   *+8                                                              
         OI    ESTFLAG1,ESTDAILY   SAVE IF DAILY SCHEDULE                       
*                                                                               
         TM    EFLAG1,EF1TRADE     TRADE ESTIMATE FOR DARE?                     
         JZ    *+8                                                              
         OI    ESTFLAG1,ESTTRADE   YES                                          
*                                                                               
         TM    EFLAG1,EF1SDE       SUPERDESK AUTHORIZATION OPEN?                
         JZ    *+8                                                              
         OI    ESTFLAG1,ESTSDE     YES                                          
*                                                                               
         MVC   SVOOWROT,EOWSDAY                                                 
         CLI   SVOOWROT,0          IF NO OUT OF WEEK ROTATOR                    
         JNE   *+8                                                              
         MVI   SVOOWROT,1          THEN START DAY IS ALWAYS MONDAY              
*                                                                               
         MVC   ESTNM,EDESC         SET ESTIMATE NAME                            
         MVC   ESTDYMNU,EDAYMENU   SET ESTIMATE DAYPART MENU                    
         MVC   ESTSTRT,ESTART      SET ESTIMATE PERIOD                          
         MVC   ESTEND,EEND                                                      
         MVC   ESTBOOK,EBOOK       SET ESTIMATE RATING BOOK                     
         MVC   SVEDAILY,EDAILY                                                  
*                                                                               
         XC    ESTNTDEM,ESTNTDEM                                                
         CLC   ELEN,=AL2(ESTHDRLN)                                              
         JNH   *+10                                                             
         MVC   ESTNTDEM,ENONTDMS                                                
*                                                                               
         MVC   ESTDEMOS,EDEMLST                                                 
         MVC   ESTUSNMS,EUSRNMS                                                 
*                                                                               
         XC    NUMDEMS,NUMDEMS                                                  
         TM    PROFFLG1,PF1READ    HAVE WE READ PROFILES?                       
         JZ    GEI020              NO                                           
*                                                                               
         CLI   PDARDEMS,C'N'       CAN HAVE 1-4 OR NO DEMOS                     
         JE    GEI020                                                           
         LLC   R1,PDARDEMS                                                      
         N     R1,=X'0000000F'     CONVERT TO SINGLE EBCDIC TO HEX              
         STH   R1,NUMDEMS                                                       
*                                                                               
GEI020   L     R4,AIO3                                                          
         CLC   0(2,R4),=X'0D34'    DID WE READ ORDER REC?                       
         JNE   EXITY                NO                                          
         MVI   ELCDLO,DODEMELQ     USER SPECIFIED DEMOS TO SEND?                
         MVI   ELCDHI,DODEMELQ     USER SPECIFIED DEMOS TO SEND?                
         BRAS  RE,GETEL                                                         
         JNE   EXITY               NO                                           
         USING DODEMELD,R4                                                      
         XC    ESTDEMOS,ESTDEMOS                                                
         SR    R1,R1                                                            
         ICM   R1,1,DODEMNUM       CAN HAVE 0-4 DEMOS                           
         STH   R1,NUMDEMS                                                       
         JZ    EXITY                                                            
         MHI   R1,3                                                             
         AHI   R1,-1                                                            
         MVC   ESTDEMOS(0),DODEMOS                                              
         EX    R1,*-6                                                           
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
******   THIS ROUTINE RESTICTS DARE SENDING FOR AGENCY RB        ******         
***********************************************************************         
*HISTORY                                                                        
*-------                                                                        
*       WHEN                                                                    
*WHO  DDMMMYR WHAT                                                              
*---- ------- ----                                                              
*HWON 06OCT14 INITIAL RELEASE, WITH THE EXCEPTION OF USERID RJTXM               
*             IF RTG-CD RJ_XX, CAN SEND IF ESD BEFORE DEC29/14                  
*             IF RTG-CD ASMXX, CAN SEND IF ESD ON-OR-ATER DEC29/14              
*HWON 04NOV14 RJNY360 & RJDC360 ADDED TO EXCEPTION                              
*HWON 04DEC14 RJPNY & PJPDC ADDED TO EXCEPTION                                  
*HWON 08OCT15 DETXM,ATTXM,LATXM,CHTXM ADDED TO EXCEPTION                        
*HWON 20OCT15 REMOVED ALL **TXM USERIDS FROM EXCEPTION LIST                     
*             IF USERID IS **TXM, CAN SEND IF ESD BEFORE DEC28/15               
*             IF RTG-CD IS TXM**, CAN SEND IF ON-OR-AFTER DEC28/15              
*HWON 20DEC16 ADD ALEGORY ENTITY TO EXCEPTION, ROUTING CODE ALG**               
*                                                                               
*   ESD = ESTIMATE STARTDATE                                                    
***********************************************************************         
NOSENDRB NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLC   LP_AGY,=C'RB'            AGENCY RB?                              
         JNE   NOSRBYS                   NO, SKIP CHECKS                        
*                                                                               
*** THE FOLLOWING ROUTING CODES ARE PART OF THE EXCEPTION LIST ***              
*** IE. THEY ARE ALLOWED TO SEND REGARDLESS OF ESD      ***                     
*                                                                               
         CLC   SVDRROUT(3),=CL3'ALG'    ROUTING CODE == ALG**                   
         JE    NOSRBYS                                                          
*                                                                               
*** THE FOLLOWING USERID ARE PART OF THE EXCEPTION LIST ***                     
*** IE. THEY ARE ALLOWED TO SEND REGARDLESS OF ESD      ***                     
*                                                                               
         CLC   SVORIGID,=CL10'RJNY360'  USERID == RJNY360?                      
         JE    NOSRBYS                                                          
         CLC   SVORIGID,=CL10'RJDC360'  USERID == RJDC360?                      
         JE    NOSRBYS                                                          
         CLC   SVORIGID,=CL10'RJPNY'    USERID == RJPNY?                        
         JE    NOSRBYS                                                          
         CLC   SVORIGID,=CL10'RJPDC'    USERID == RJPDC?                        
         JE    NOSRBYS                                                          
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ                                                   
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         CLI   DOSPMTHD-DOSPELD(R4),C'I'   IS IT GOING EDI?                     
         JNE   NOSRBYS                     DON'T CHECK IF NOT EDI               
*                                                                               
         MVC   SVQPRD,=C'POL'      LOOK FOR THE POL ESTIMATE                    
         BRAS  RE,GTESTINF         READ ESTIMATE RECORD INTO AIO7               
*                                                                               
         CLC   SVORIGID+2(3),=C'TXM'    ALLOW **TXM USER TO SEND                
         BNE   NOSRB20                                                          
         CLC   ESTSTRT,=X'FBF5F1F2F2F8' IF ESD IS BEFORE 12/28/15               
         JL    NOSRBYS                                                          
*                                                                               
NOSRB20  CLC   SVDRROUT(3),=C'TXM'      ALLOW TXM** RTG-CD TO SEND              
         JNE   NOSRB40                                                          
         CLC   ESTSTRT,=X'FBF5F1F2F2F8' IF ESD IS ON-OR-AFTER 12/28/15          
         JNL   NOSRBYS                                                          
         J     NOSRBNO                                                          
*                                                                               
NOSRB40  CLC   SVDRROUT(3),=C'RJ '      ALLOW RJ_** RTG-CD TO SEND              
         BNE   NOSRB60                                                          
         CLC   ESTSTRT,=X'FBF4F1F2F2F9' IF ESD IS BEFORE 12/29/14               
         JL    NOSRBYS                                                          
         J     NOSRBNO                                                          
*                                                                               
NOSRB60  CLC   SVDRROUT(3),=C'ASM'      ALLOW ASM** RTG-CD TO SEND              
         JNE   NOSRBNO                                                          
         CLC   ESTSTRT,=X'FBF4F1F2F2F9' IF ESD IS ON-OR-AFTER 12/29/14          
         JNL   NOSRBYS                                                          
*                                                                               
NOSRBNO  GOTOR PUTERR,DMCB,('SE#SY002',SE#NOSND)                                
         J     EXITN                                                            
NOSRBYS  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* ADD/CHANGE THE SALESPERSON RECORD                                             
***********************************************************************         
UPSALREC NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,AIO3                                                          
         XC    IOKEY,IOKEY                                                      
         MVC   IOKEY(L'DOKEY),0(R4)                                             
         MVI   IOKEY+12,DOKCSALQ   DARE SALESPERSON X'04' RECORD                
*                                                                               
         XC    ELEM,ELEM                                                        
         MVC   ELEM(DOSTLNQ),DOSTELEM                                           
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO5'                               
         JE    USR10                                                            
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNZ   USR20                                                            
         DC    H'0'                                                             
*                                                                               
USR10    GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO5'                           
         L     R2,AIO5                                                          
         J     USR40                                                            
*                                                                               
USR20    OI    MISCFLG1,MF1RECNF                                                
         L     RE,AIO5                                                          
         LHI   RF,IO5LQ                                                         
         XCEFL                                                                  
*                                                                               
         L     R2,AIO5             NOTE: SALESPERSON REASSIGNMENT REC           
         USING DOKEY,R2                                                         
         MVC   DOKEY,IOKEYSAV                                                   
         MVC   DORLEN,=Y(DORFRST-DOKEY)                                         
         MVC   DORAGY,LP_AGY                                                    
         DROP  R2                                                               
*                                                                               
USR40    LA    R2,DORFRST-DOKEY(R2)                                             
         CLI   0(R2),0                                                          
         JE    USR70                                                            
*                                                                               
OLD      USING DOSALPRD,R2                                                      
         CLI   OLD.DOSALEN,DOSALNQ           OLD VERSION, NO S/P CODE           
         JE    USR70                         YES, ADD                           
         CLC   SALESCOD,OLD.DOSASALC         SAME S/P CODE?                     
         JNE   USR70                         NO, ADD ONE                        
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' - SUPPLEMENTARY ID ELEMENT             
         MVI   ELCDHI,DOSPELQ      X'03' - SUPPLEMENTARY ID ELEMENT             
         BRAS  RE,GETEL                                                         
         USING DOSPELD,R4                                                       
         TM    DOSPFLG1,DOSPPPER             CURRENT IS P/P?                    
         DROP  R4                                                               
         JZ    USR47                                                            
         TM    OLD.DOSAFLAG,DOSAPPER         PREV WAS P/P?                      
         JO    USR50                         YES                                
         J     USR70                         NO, ADD                            
USR47    TM    OLD.DOSAFLAG,DOSAPPER         PREV WAS S/P?                      
         JO    USR70                         NO, ADD                            
*                                                                               
USR50    L     R4,AIO3                                                          
         MVI   ELCDLO,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         MVI   ELCDHI,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
         CLC   DOIDSPER,OLD.DOSASALP                                            
         JE    USRX                                                             
         MVC   OLD.DOSASALP,DOIDSPER                                            
         J     USRPUT                                                           
         DROP  R4                                                               
*                                                                               
USR70    LA    R3,ELEM                                                          
         USING DOSALPRD,R3                                                      
         MVI   DOSAPEL,DOSAPELQ    X'60'                                        
         MVI   DOSALEN,DOSALNQ2                                                 
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         MVI   ELCDHI,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
         MVC   DOSASALP,DOIDSPER                                                
         DROP  R4                                                               
*                                                                               
         MVC   DOSASALC,SALESCOD   S/P CODE                                     
         MVI   DOSAFLAG,0                                                       
         OI    DOSAFLAG,DOSABUYR   BUYER CHANGED                                
         MVI   ELCDLO,DOSPELQ                                                   
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,NEXTEL                                                        
         USING DOSPELD,R4                                                       
         TM    DOSPFLG1,DOSPPPER             CURRENT IS P/P?                    
         JZ    *+8                                                              
         OI    DOSAFLAG,DOSAPPER   YES                                          
         GOTOR ARECUP,DMCB,(C'S',AIO5),ELEM,(R2)                                
*                                                                               
         TM    MISCFLG1,MF1RECNF   ADDING OR PUTTING?                           
         JNZ   USRADD              ADDING                                       
USRPUT   GOTOR (#IOEXEC,AIOEXEC),'IOPUT+IOFIL+IO5'                              
         J     USRX                                                             
*                                                                               
USRADD   GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOFIL+IO5'                           
         NI    MISCFLG1,X'FF'-MF1RECNF                                          
*                                                                               
USRX     J     EXITY                                                            
         DROP  OLD                                                              
         EJECT                                                                  
***********************************************************************         
* UPDATE THE SPOTS AND DOLLARS OF THE ORDER RECORD                              
***********************************************************************         
UPDORD   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY                                                         
         USING DAREORDD,R4                                                      
         MVI   DOKTYPE,DOKTYPQ     X'0D'                                        
         MVI   DOKSUBTY,DOKSTYPQ   X'34'                                        
         MVC   DOKAGMD,SVBAGM                                                   
         MVC   DOKORDER,BINORDER                                                
         DROP  R4                                                               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JNE   *+2                                                              
*                                                                               
         CLC   IOKEY(DOKSTA-DOKEY),IOKEYSAV                                     
         JNE   *+2                                                              
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO3'                           
         JNE   *+2                                                              
*                                                                               
* CODE TO DELETE ALL DOBUYELQ/DOBY2ELS ELEMENTS                                 
*                                                                               
         L     R4,AIO3             POINT TO ORDER RECORD                        
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         USING DOSPELD,R4                                                       
         MVC   DOSPSPTS,AGYNSPTS                                                
         MVC   DOSPTOTL,AGYDOLRS                                                
*                                                                               
         CLI   ORXSTATS,DSENT      SENT EDI?                                    
         JNE   UPOR090                                                          
*                                                                               
         MVI   ELCDLO,DOCBLELQ     REMOVE ALL BUYLINE ELEMENTS                  
         MVI   ELCDHI,DOBY2ELQ     DOBUY, DOBY2, DOCBL ELEM                     
UPOR010  L     R4,AIO3                                                          
         BRAS  RE,GETEL                                                         
         JNE   UPOR020                                                          
         GOTOR ARECUP,DMCB,(C'S',AIO3),(R4)                                     
         J     UPOR010                                                          
*                                                                               
* ADD BUYLINE ELEMENTS                                                          
*                                                                               
UPOR020  XC    ELEM,ELEM                                                        
         L     R2,AIO8                                                          
*                                                                               
UPOR025  OC    0(2,R2),0(R2)       END OF BUYLINE LIST?                         
         JE    UPOR090              YES, PUT RECORD TO FILE                     
*                                                                               
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
*                                                                               
         TM    ANYFLAG1,AF1HTBL    HAVE 2-BYTE BUYLINES?                        
         JNZ   UPOR050              YES, ADD 2-BYTE BUYLINE FORMAT              
*                                                                               
         CLI   0(R2),0             STILL HAVE 2-BYTE BUYLINE?                   
         JNE   *+2                  SOMETHING WRONG                             
*                                                                               
* ADD DOBUYELQ                                                                  
*                                                                               
UPOR030  CLI   0(R4),0             END OF THE RECORD?                           
         JE    UPOR040                                                          
         CLI   0(R4),DOBUYELQ      HAVE A X'22' BUYLINE ELEMENT                 
         JL    UPOR035                                                          
         JH    UPOR040                                                          
*                                                                               
         USING DOBUYELD,R4                                                      
         CLC   DOBUYSPT,1(R2)      BUYLINE EXIST IN RECORD ALREADY?             
         JL    UPOR035                                                          
         JH    UPOR040                                                          
         CLC   DOBUYFLG,2(R2)      ALSO SAME FLAG?                              
         JE    UPOR085              YES, CHECK THE NEXT BUYLINE IN LIST         
         DROP  R4                                                               
*                                                                               
UPOR035  LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         J     UPOR030                                                          
*                                                                               
CHORD    USING DOBUYELD,ELEM                                                    
UPOR040  MVI   CHORD.DOBUYEL,DOBUYELQ                                           
         MVI   CHORD.DOBUYLEN,DOBUYLNQ                                          
         MVC   CHORD.DOBUYSPT,1(R2)                                             
         MVC   CHORD.DOBUYFLG,2(R2)                                             
         J     UPOR080             GO ADD ELEM TO RECORD                        
         DROP  CHORD                                                            
*                                                                               
* ADD DOBY2ELQ - 2 BYTE BUYLINE FORMAT                                          
*                                                                               
UPOR050  CLI   0(R4),0             END OF THE RECORD?                           
         JE    UPOR070                                                          
         CLI   0(R4),DOBY2ELQ      HAVE A X'23' BUYLINE ELEMENT                 
         JL    UPOR060                                                          
         JH    UPOR070                                                          
*                                                                               
         USING DOBY2ELD,R4                                                      
         CLC   DOBY2SPT,0(R2)      BUYLINE EXIST IN RECORD ALREADY?             
         JL    UPOR060                                                          
         JH    UPOR070                                                          
         CLC   DOBY2FLG,2(R2)      ALSO SAME FLAG?                              
         JE    UPOR085              YES, CHECK THE NEXT BUYLINE IN LIST         
         DROP  R4                                                               
*                                                                               
UPOR060  LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         J     UPOR050                                                          
*                                                                               
CHORD    USING DOBY2ELD,ELEM                                                    
UPOR070  MVI   CHORD.DOBY2EL,DOBY2ELQ                                           
         MVI   CHORD.DOBY2LEN,DOBY2LNQ                                          
         MVC   CHORD.DOBY2SPT,0(R2)                                             
         MVC   CHORD.DOBY2FLG,2(R2)                                             
         DROP  CHORD                                                            
*                                                                               
UPOR080  GOTOR ARECUP,DMCB,(C'S',AIO3),ELEM,(R4)                                
UPOR085  LA    R2,3(R2)            BUMP 3 BYTES = 2 BT BLINE + 1 BT ST          
         J     UPOR025             CHECK THE NEXT BUYLINE                       
*                                                                               
UPOR090  GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOFIL+IO3'                           
         J     EXITY                                                            
***********************************************************************         
* WRITE/ADD COLOR PASSIVE KEY                                                   
*                                                                               
* ON ENTRY: PARAM1                 NEW COLOR(1 CHAR)                            
*           DISKADDR IS SET                                                     
*                                                                               
***********************************************************************         
COLPASKY NTR1  BASE=*,LABEL=*                                                   
         MVC   BYTE,0(R1)                                                       
*                                                                               
         L     R4,IOADDR                                                        
         USING DOKEY,R4                                                         
         MVI   ELCDLO,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         MVI   ELCDHI,DOIDELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
*                                                                               
         XC    IOKEY,IOKEY         INITIALIZE THE COLOR PASSIVE KEY             
         LA    R3,IOKEY                                                         
         USING DOKEY,R3                                                         
         MVI   DSCKTYPE,DSCKTYPQ   X'0D'                                        
         MVI   DSCKSTYP,DSCKSTYQ   X'B8'                                        
         MVC   DSCKAGMD,SVBAGM                                                  
         MVC   DSCKBYR,DOIDBYR                                                  
         MVC   DSCKSTAT,BYTE                                                    
         MVC   DSCKDATE,COMPDATE                                                
         XC    DSCKDATE,EFFS                                                    
         MVC   DSCKORDR,BINORDER                                                
         DROP  R4                                                               
*                                                                               
         MVI   ELCDLO,COLELQ       X'13' ORDER COLOR ELEMENT                    
         MVI   ELCDHI,COLELQ                                                    
         BRAS  RE,NEXTEL           DID WE FIND A COLOR ELEMENT?                 
         JE    CPK020              YES                                          
*                                                                               
* ADD NEW COLOR ELEMENT THEN ADD PASSIVE KEY                                    
*                                                                               
         LA    R2,ELEM                                                          
         USING COLOREL,R2                                                       
         XC    ELEM,ELEM                                                        
         MVI   COLEL,COLELQ        X'13'                                        
         MVI   COLELLEN,COLLENQ                                                 
         MVC   COLCOL,BYTE         NEW COLOR TYPE                               
         MVC   COLDATE,COMPDATE    NEW DATE                                     
         XC    COLDATE,EFFS                                                     
         DROP  R2                                                               
*                                                                               
         L     R4,IOADDR                                                        
         LA    R4,DORFRST-DOKEY(R4)                                             
CPK005   CLI   0(R4),0             IF NO MORE ELEMENTS                          
         JE    CPK010              ADD AT TO THE END                            
         CLI   0(R4),COLELQ        ELSE ADD AFTER ALL ELEMENTS                  
         JNL   CPK010              < X'13'                                      
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         J     CPK005                                                           
CPK010   GOTOR ARECUP,DMCB,(C'S',IOADDR),ELEM,(R4)                              
*                                                                               
         MVC   DSCKDATE,COMPDATE                                                
         XC    DSCKDATE,EFFS                                                    
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORDD+IODIR'                                  
         JE    CPKXIT                                                           
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNZ   CPKADD              YES, GO ADD IT THEN                          
         TM    IOERR,IOEDEL        RECORD IS DELETED?                           
         JNZ   CPKWRITE            YES, GO UNDELETE IT                          
         DC    H'0'                                                             
*                                                                               
* FROM HERE, COLOR ELEMENT EXISTS                                               
*                                                                               
         USING COLOREL,R4                                                       
CPK020   MVC   DSCKSTAT,COLCOL                                                  
         MVC   DSCKDATE,COLDATE                                                 
*        XC    DSCKDATE,EFFS                                                    
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORDUPD+IODIR'                                
         JE    CPKDELET                                                         
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNZ   CPKUPDAT            YES, GO ADD THE NEW PASSIVE KEY              
         TM    IOERR,IOEDEL        RECORD IS DELETED?                           
         JZ    *+2                  NO, DIE                                     
*                                                                               
         CLC   DSCKSTAT,BYTE       SAME COLOR?                                  
         JNE   CPKUPDAT            NO, GO ADD THE NEW PASSIVE KEY               
         MVC   HALF,COMPDATE                                                    
         XC    HALF,EFFS                                                        
         CLC   DSCKDATE,HALF       SAME DATE?                                   
         JNE   CPKUPDAT            NO, GO ADD THE NEW PASSIVE KEY               
         J     CPKWRITE            SAME KEY, GO UNDELETE IT                     
*                                                                               
CPKDELET DS    0H                                                               
         OI    IOKEY+13,X'80'      YES: TURN DELETE BIT ON                      
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR'                                
*                                                                               
*  UPDATE COLOR ELEMENT AND WRITE/ADD PASSIVE KEY                               
CPKUPDAT DS    0H                                                               
         MVC   COLCOL,BYTE         UPDATE COLOR ELEMENT                         
         MVC   COLDATE,COMPDATE                                                 
         XC    COLDATE,EFFS                                                     
*                                                                               
         MVC   DSCKSTAT,COLCOL     UPDATE COLOR PASSIVE KEY                     
         MVC   DSCKDATE,COLDATE                                                 
         NI    IOKEY+13,X'FF'-X'80'                                             
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORDUPD+IODIR'                                
         JE    CPKXIT                                                           
         MVC   IOKEY,IOKEYSAV                                                   
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNZ   CPKADD              YES, GO ADD THE NEW PASSIVE KEY              
         TM    IOERR,IOEDEL        RECORD IS DELETED?                           
         JZ    *+2                   NO, DIE                                    
* UNDELETE THE KEY AND UPDATE                                                   
*                                                                               
CPKWRITE GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR'                                
         J     CPKXIT              EXIT                                         
*                                                                               
CPKADD   GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR'                                  
         DROP  R4,R3                                                            
*                                                                               
CPKXIT   J     EXITY                                                            
         EJECT                                                                  
*                                                                               
***********************************************************************         
* ROUTINE TO SET THE TRADE METHOD IN THE CASH ORDER                             
***********************************************************************         
SETMETHD NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY            FIND THE CASH ORDER RECORD                   
         USING DOKEY,R4                                                         
         MVI   DCKTYPE,DCKTYPQ                                                  
         MVI   DCKSUBTY,DCKSTYPQ                                                
         MVC   DCKAGMD,SVBAGM                                                   
         MVC   DCKCLT,SVBCLT                                                    
         MVC   DCKPRD,SVBPRD                                                    
         MVC   DCKEST,SVBEST                                                    
         MVC   DCKSTA,SVBSTA                                                    
         MVC   DCKPRD2,SVBPR2                                                   
         MVC   DCKFLTNM,SVBFLT                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO5'                               
         JE    STMTH02                                                          
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNE   STMTHX                                                           
         DC    H'0'                                                             
STMTH02  GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO5'                           
         L     R4,AIO5                                                          
         MVC   FULL2,BINORDER                                                   
         MVC   BINORDER,DOKORDER   GET BINARY ORDER NUMBER OF CASH              
*                                                                               
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID ELEMENT               
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL            A                                            
         USING DOSPELD,R4                                                       
         TM    DOSPTMTH,X'40'      CASH HAS UPPER CASE?                         
         JZ    STMTH05                                                          
         NI    DOSPTMTH,X'FF'-X'40'   MAKE LOWER CASE FOR CASH                  
         J     STMTH50                                                          
STMTH05  CLI   DOSPTMTH,0          ACTUALLY NON-ZERO?                           
         JNE   STMTH50             YES, NO NEED TO WRITE RECORD OUT             
         MVI   DOSPTMTH,TRDESREP-X'40'  LOWERCASE FOR CASH (X'99')              
         MVC   DOSPTDAT(3),PDARTSRP   SPECIAL REP CODE USED STORED HERE         
         DROP  R4                                                               
*                                                                               
STMTH50  CLC   LP_QMAPN,=AL2(I#SDOEXS)    ORDER EXPORT?                         
         JE    STMTH60                     DON'T DO THIS                        
         TM    MISCFLG1,MF1CSHCD   DO WE HAVE A CASH BUYLINE?                   
         JNZ   STMTH60                YES, DON'T CARE                           
*                                                                               
         SR    R0,R0                                                            
STMTH53  CLI   0(R4),0                                                          
         JE    STMTH56                                                          
         CLI   0(R4),DOSTELQ       EVER SENT BEFORE?                            
         JE    STMTH60             YES, WE'RE DONE                              
         JH    STMTH56             NO                                           
         IC    R0,1(R4)                                                         
         AR    R4,R0                                                            
         J     STMTH53                                                          
*                                                                               
STMTH56  MVC   IOADDR,AIO5                                                      
         GOTOR COLPASKY,DMCB,(C'K',0)                                           
*                                                                               
         LA    R2,DOXMELEM                                                      
         USING DOXMTELD,R2                                                      
         MVC   DOXMTOID,SVBORGID                                                
         MVC   DOXMTDID,=X'FFFE'   SET DESTID=NOBODY                            
         MVC   DOXMTSTD,DOXMTYMD                                                
         MVC   DOXMTSTT,DOXMTTIM                                                
         MVI   DOXMTSTA,QEMPTY     NO BUYS                                      
         DROP  R2                                                               
         GOTOR ARECUP,DMCB,(C'S',AIO5),DOXMELEM,(R4)  CASH IS EMPTY             
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
*                                                                               
         LA    R2,DOSTELEM         NEW STATUS ELEMENT (AUDIT TRAIL)             
         USING DOSTELD,R2                                                       
         XC    DOSTELEM,DOSTELEM                                                
         MVI   DOSTEL,DOSTELQ                                                   
         MVI   DOSTLEN,DOSTLNQ                                                  
         MVI   DOSTSTAT,QEMPTY     NO BUYS                                      
         DROP  R2                                                               
         GOTOR ARECUP,DMCB,(C'S',AIO5),DOSTELEM,(R4)                            
*                                                                               
STMTH60  GOTOR (#IOEXEC,AIOEXEC),'IOPUT+IOFIL+IO5'                              
         MVC   BINORDER,FULL2                                                   
STMTHX   J     EXITY                                                            
         EJECT                                                                  
*                                                                               
***********************************************************************         
* UPDATE THE BATCH RECORD                                                       
***********************************************************************         
UPDBATCH NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY            FIND THE APPR DARE BATCH RECORD              
         USING DBTKEY,R4                                                        
         MVI   DBTKTYP,DBTKTYPQ                                                 
         MVI   DBTKSTYP,DBTKSTYQ                                                
         MVC   DBTKAGMD,SVBAGM                                                  
         MVC   DBTKCLT,SVBCLT                                                   
         MVC   DBTKPRD,SVBPRD                                                   
         MVC   DBTKEST,SVBEST                                                   
         MVC   DBTKMKT,SVBMKT                                                   
         MVC   DBTKSTA,SVBSTA                                                   
         MVC   DBTKPRD2,SVBPR2                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO5'                               
         JE    UPBR10                                                           
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNZ   UPBRX                                                            
         DC    H'0'                                                             
UPBR10   GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO5'                           
*                                                                               
         L     R4,AIO5                                                          
         MVI   ELCDLO,DBFLTELQ     GET INFO ELEMENT (X'20')                     
         MVI   ELCDHI,DBFLTELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   UPBR30                                                           
         USING DBFLTELD,R4                                                      
UPBR23   CLC   DBFLTFLT,SVBFLT     NEEDS TO MATCH THE FLIGHT WE SENT            
         JNE   UPBR25                                                           
         TM    SVFLAG1,SF1TRADE    DOING TRADE ORDER NOW?                       
         JZ    UPBR24                                                           
         TM    DBFLTFL1,DBFLTTRD   YES, DO WE HAVE A TRADE FLIGHT?              
         JZ    UPBR25                NO                                         
         J     UPBR26                YES, MARK IT SENT                          
UPBR24   TM    DBFLTFL1,DBFLTTRD   NO, DO WE HAVE A TRADE FLIGHT?               
         JZ    UPBR26                NO, ITS CASH, MARK IT SENT                 
UPBR25   BRAS  RE,NEXTEL                                                        
         JE    UPBR23                                                           
         J     UPBR30                                                           
*                                                                               
UPBR26   OI    DBFLTFL1,DBFLTSNT   MARK THIS FLIGHT AS SENT                     
         J     UPBRPUT             PUT OUT THE RECORD                           
         DROP  R4                                                               
*                                                                               
UPBR30   XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         USING DBFLTELD,R1                                                      
         MVI   DBFLTEL,DBFLTELQ                                                 
         MVI   DBFLTLEN,DBFLTOVH                                                
         MVC   DBFLTFLT,SVBFLT                                                  
         OI    DBFLTFL1,DBFLTDAR+DBFLTSNT                                       
         TM    SVFLAG1,SF1TRADE    DOING TRADE ORDER NOW?                       
         JZ    *+8                                                              
         OI    DBFLTFL1,DBFLTTRD                                                
         DROP  R1                                                               
         GOTOR ARECUP,DMCB,(C'S',AIO5),ELEM,(R4)                                
UPBRPUT  GOTOR (#IOEXEC,AIOEXEC),'IOPUT+IOFIL+IO5'                              
*                                                                               
UPBRX    J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* CHECK IF AN AUTHORIZATION STATION RECORD EXISTS                     *         
*   BLOWS AWAY AIO7 AND AIO5                                                    
***********************************************************************         
CHKAUTH  NTR1  BASE=*,LABEL=*                                                   
         L     RF,ACLTREC                                                       
         USING CLTRECD,RF          R3=A(CLIENT RECORD)                          
         MVC   IOADDR,AIO2                                                      
         CLI   CPROF,C'0'          POL BUYING?                                  
         JNE   CAUT02              NO                                           
         CLI   CPOLONLY,C'Y'       TRUE POL?                                    
         JNE   CAUT02                                                           
         DROP  RF                                                               
*                                                                               
         MVC   IOADDR,AIO7                                                      
         LA    R4,IOKEY            READ ESTIMATE RECORD                         
         USING ESTHDR,R4                                                        
         XC    IOKEY,IOKEY         IF CLIENT IS TRUE POL                        
         MVI   EKEYTYPE,0                                                       
         MVC   EKEYAM,SVBAGM                                                    
         MVC   EKEYCLT,SVBCLT                                                   
         MVC   EKEYPRD,=C'POL'                                                  
         MVC   EKEYEST,SVBEST                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO7'                               
         JNE   *+2                                                              
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGETREC+IOFIL+IO7'                           
         JNE   *+2                                                              
         L     R4,AIO7                                                          
         TM    EFLAG1,EF1SDE       SDESK AUTH OPEN FOR POL ESTIMATE?            
         J     CAUT03                                                           
         DROP  R4                                                               
*                                                                               
CAUT02   TM    ESTFLAG1,ESTSDE     SUPERDESK AUTHORIZATION OPEN?                
CAUT03   JNO   CHKAUTHX            NO                                           
*                                                                               
         PUSH  USING                                                            
CAUT04   XC    ELEM,ELEM           CALL SPAUTH                                  
         USING SPAUTHD,ELEM                                                     
         MVC   SPACOM,ACOMFACS                                                  
         L     RF,AIO5                                                          
         ST    RF,SPAIO                                                         
         MVC   SPAKAM,SVBAGM                                                    
         MVC   SPAKCLT,SVBCLT                                                   
         MVC   SPAKPRD,SVBPRD                                                   
         MVC   SPAKPRD2,SVBPR2                                                  
         MVC   SPAKEST,SVBEST                                                   
*                                                                               
         CLI   SVBPR2,0            ANY PIGGYBACKS?                              
         JE    CAUT06                                                           
         CLC   SVQPRD,SVQPR2       IF PRODUCTS NOT IN ALPHABETICAL              
         JL    CAUT06              ORDER, SWAP THEM                             
         XC    SPAKPRD2,SPAKPRD                                                 
         XC    SPAKPRD,SPAKPRD2                                                 
         XC    SPAKPRD2,SPAKPRD                                                 
*                                                                               
CAUT06   GOTOR VDATCON,DMCB,ESTSTRT,(2,SPASDTE)                                 
         GOTOR (RF),DMCB,ESTEND,(2,SPAEDTE)                                     
         CLI   SVBFLT,0            IF FLIGHT NUMBER = 0, USE EST DATES          
         JE    CAUT08                                                           
         GOTOR (RF),DMCB,(3,SVFLTSDT),(2,SPASDTE)                               
         GOTOR (RF),DMCB,(3,SVFLTEDT),(2,SPAEDTE)                               
*                                                                               
CAUT08   MVC   SPAKMKT,SVBMKT                                                   
         MVC   SPAKSTA,SVBSTA                                                   
         MVC   SPAUPDT,BYTE2                                                    
*                                                                               
         GOTOR VSPAUTH,ELEM                                                     
         CLI   SPAERR,0                                                         
         JNE   *+2                                                              
         POP   USING                                                            
*                                                                               
CHKAUTHX J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* READS EMAIL RECORDS TO GET TOKEN, IF RECORD DOESN'T EXIST, ADD ONE            
* ON ENTRY:    P1 - EMAIL ADDRESS                                               
* ON EXIT:     P2 - EMAIL TOKEN                                                 
***********************************************************************         
GTEMLTKN NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         ICM   R3,15,0(R1)          R3 = A(EMFLAG/EMAIL)                        
         ICM   R5,15,4(R1)          R5 = A(RTRN TOKEN FIELD)                    
*                                                                               
         LA    R1,L'EMLADD(R3)                                                  
GET010   CR    R1,R3                                                            
         JNH   *+2                                                              
         CLI   0(R1),C' '                                                       
         JH    GET030                                                           
         JCT   R1,GET010                                                        
         DC    H'0'                                                             
*                                                                               
GET030   SR    R1,R3                                                            
         STCM  R1,3,HALF2           HALF2 = L'(EMAIL ADDRESS)                   
*                                                                               
         LA    R2,IOKEY                                                         
         USING EMLPKEY,R2                                                       
         XC    IOKEY,IOKEY                                                      
         MVI   EMLPTYP,EMLPTYPQ                                                 
         MVI   EMLPSUB,EMLPSUBQ                                                 
         MVC   EMLPAGY,LP_AGY                                                   
         MVC   EMLPEML,1(R3)       MOVE EMAIL ONLY, NOT THE FLAG                
         OC    EMLPEML,SPACES                                                   
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOXSPDIR+IO5'                            
         JE    GET050                                                           
         DC    H'0'                                                             
*                                                                               
GET040   GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IOXSPDIR+IO5'                            
         JNE   *+2                                                              
*                                                                               
GET050   CLC   IOKEY(EMLPTOK-EMLPKEY),IOKEYSAV                                  
         JNE   GET100              NO MATCHES FOUND, LETS ADD ONE               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGETREC+IOXSPFIL+IO5'                        
         JNE   *+2                                                              
*                                                                               
         L     R4,AIO5                                                          
         LA    R4,EMLELS-EMLRECD(R4)                                            
         USING EMLELD,R4                                                        
         LLC   R1,EMLLEN                                                        
         AHI   R1,-EMLLENQ         R1=L'EMAIL IN RECORD                         
         CH    R1,HALF2            MATCH ON LENGTH?                             
         JNE   GET040                                                           
*                                                                               
         BCTR  R1,0                                                             
         CLC   EMLADDR(0),1(R3)    A                                            
         EX    R1,*-6              DID WE FIND EXACT MATCH?                     
         JNE   GET040              NO                                           
*                                                                               
         MVC   0(L'EMLPTOK,R5),EMLPTOK                                          
         J     EXITY                                                            
*                                                                               
*  IF WE GET HERE, EMAIL RECORD WAS NOT FOUND, TIME TO ADD ONE                  
*                                                                               
GET100   LA    R2,IOKEY                                                         
         USING EMLKEY,R2                                                        
         XC    IOKEY,IOKEY                                                      
         MVI   EMLKTYP,EMLKTYPQ    READ ACTIVE KEY TO GET THE NEXT              
         MVI   EMLKSUB,EMLKSUBQ     AVAILABLE TOKEN                             
         MVC   EMLKAGY,LP_AGY                                                   
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHIUPD+IOXSPDIR+IO5'                         
         JE    *+12                                                             
         TM    IOERR,IOEDEL        RECORD IS DELETED?                           
         JZ    *+2                                                              
*                                                                               
         CLC   IOKEY(EMLKTOK-EMLKEY),IOKEYSAV    FOUND AN EMAIL RECORD?         
         JE    GET110                                                           
         ICM   R0,15,EFFS          NO, SET TOKEN TO X'FFFFFFFF'                 
         J     GET120                                                           
*                                                                               
GET110   ICM   R0,15,EMLKTOK                                                    
         LTR   R0,R0                                                            
         JZ    *+2                                                              
         SHI   R0,1                                                             
         DROP  R2                                                               
*                                                                               
GET120   STCM  R0,15,0(R5)         R5= A(NEW EMAIL TOKEN)                       
*                                                                               
         L     RE,AIO5                                                          
         LHI   RF,IO5LQ                                                         
         XCEFL                                                                  
*                                                                               
         L     R4,AIO5                                                          
         USING EMLKEY,R4                                                        
         MVI   EMLKTYP,EMLKTYPQ                                                 
         MVI   EMLKSUB,EMLKSUBQ                                                 
         MVC   EMLKAGY,LP_AGY                                                   
         MVC   EMLKTOK,0(R5)                                                    
*                                                                               
         LA    R2,EMLELS                                                        
         USING EMLELD,R2                                                        
         MVI   EMLEL,EMLELQ                                                     
         SR    R1,R1                                                            
         ICM   R1,3,HALF2          R1 = L'(EMAIL ADDRESSS)                      
         BCTR  R1,0                MINUS 1 FOR EX INTRUCTION                    
         MVC   EMLADDR(0),1(R3)                                                 
         EX    R1,*-6              MOVE TO ELEM                                 
         AHI   R1,3                GET LENGTH OF ELEMENT                        
         STC   R1,EMLLEN           AND SET IT                                   
*                                                                               
         AHI   R1,EMLELS-EMLRECD   GET LENGTH OF RECORD                         
         STCM  R1,3,EMLRLEN        AND SET IT                                   
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOXSPFIL+IO5'                        
         JNE   *+2                                                              
         DROP  R4                                                               
*                                                                               
         LA    R2,IOKEY                                                         
         USING EMLPKEY,R2                                                       
         XC    IOKEY,IOKEY                                                      
         MVI   EMLPTYP,EMLPTYPQ                                                 
         MVI   EMLPSUB,EMLPSUBQ                                                 
         MVC   EMLPAGY,LP_AGY                                                   
         MVC   EMLPEML,1(R3)       MOVE EMAIL ONLY, NOT THE FLAG                
         OC    EMLPEML,SPACES                                                   
         MVC   EMLPTOK,EMLKTOK-EMLKEY(R4)                                       
         MVC   IOKEY+36(4),IODA                                                 
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IOXSPDIR'                               
         JNE   *+2                                                              
*                                                                               
         J     EXIT                                                             
EMAILD   DSECT                                                                  
EMLFLG   DS    C                                                                
EMLADD   DS    CL100                                                            
EMLNQ    EQU   *-EMAILD                                                         
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* READ ORDER REC INTO IO3                                                       
* ON ENTRY:    BINORDER            BINARY ORDER NUMBER                          
* ON EXIT:     IOADDR              A(ORDER REC READ)                            
***********************************************************************         
*                                                                               
GETORD   NTR1  BASE=*,LABEL=*                                                   
         LA    R2,IOKEY                                                         
         USING DOKEY,R2                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   DOKTYPE,DOKTYPQ                                                  
         MVI   DOKSUBTY,DOKSTYPQ                                                
         MVC   DOKAGMD,SVBAGM                                                   
         MVC   DOKORDER,BINORDER                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JNE   *+2                                                              
         CLC   IOKEY(DOKSTA-DOKEY),IOKEYSAV                                     
         JE    GORD005                                                          
         GOTOR PUTERR,DMCB,('SE#SY023',SE#ORDNF)                                
         J     GORDXN                                                           
*                                                                               
GORD005  MVC   ORD1ADDR,IOKEY+14                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO3'                           
         JNE   *+2                                                              
*                                                                               
         ICM   RE,15,I$GRPCD       UPDATING A MAKEGOOD?                         
         JNZ   GORD020             YES, DON'T SEND ORDER DL REQUEST             
*                                                                               
         GOTOR CHKRECSM,DMCB,AIO3,ORDCKS,ORD1ADDR                               
         JNE   GORDCKSM                                                         
*                                                                               
* CHECK FOR COMMENT RECORD                                                      
GORD007  XC    ORD2ADDR,ORD2ADDR                                                
         MVI   DOKCMT,DOKCAGCQ     X'01' - AGENCY COMMENT RECORD                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO4'                               
         JE    GORD010                                                          
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNZ   GORD015                                                          
         DC    H'0'                                                             
         DROP  R2                                                               
*                                                                               
GORD010  MVC   ORD2ADDR,IOKEY+14                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO4'                           
         JNE   *+2                                                              
*                                                                               
         GOTOR CHKRECSM,DMCB,AIO4,OR2CKS,ORD2ADDR                               
         JNE   GORDCKSM                                                         
*                                                                               
GORD015  CLI   DWNLDRSP,C'N'       SEND A DOWNLOAD ORDER RESPONSE?              
         JE    GORD020                                                          
         GOTOR PUTORD,ORD1ADDR     SEND RUN REQUEST AND DISK ADDRESS            
*                                                                               
GORD020  MVC   IOADDR,AIO3                                                      
         J     EXITY                                                            
*                                                                               
GORDCKSM GOTOR PUTORD,ORD1ADDR     SEND RUN REQUEST AND DISK ADDRESS            
         GOTOR PUTERR,DMCB,('SE#SY023',SE#ORDNC)                                
*                                                                               
GORDXN   J     EXITN                                                            
*                                                                               
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* READ OFFER RECS IN AIO4, AIO5, AIO6                                           
* ON ENTRY:    BINORDER            BINARY ORDER NUMBER                          
* ON EXIT:     IOADDR              A(OFFER NOTICE REC READ)                     
***********************************************************************         
*                                                                               
GETMG    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   MKBSTA,X'E8'        CABLE?                                       
         JL    GTMG020                                                          
*                                                                               
         GOTOR GETXNOTC,DMCB,0     GET XSPOT NOTICE RECORD                      
         JNE   GTMGXN                                                           
         GOTOR GETXOFFR,DMCB,0     GET XSPOT OFFER RECORD                       
         JNE   GTMGXN                                                           
         J     GTMG030                                                          
*                                                                               
GTMG020  BRAS  RE,GETNOTC          GET NOTICE RECORD                            
         JNE   GTMGXN                                                           
         BRAS  RE,GETOFFR          GET OFFER RECORD                             
         JNE   GTMGXN                                                           
*                                                                               
GTMG030  GOTOR PUTMKGD,NOTCADDR                                                 
*                                                                               
         GOTOR CHKRECSM,DMCB,AIO3,NOTCKS,NOTCADDR                               
         JNE   GTMGCKSM                                                         
*                                                                               
         GOTOR CHKRECSM,DMCB,AIO5,OFFCKS,OFF1ADDR                               
         JNE   GTMGCKSM                                                         
*                                                                               
         GOTOR CHKRECSM,DMCB,AIO6,OF2CKS,OFF2ADDR                               
         JNE   GTMGCKSM                                                         
*                                                                               
GTMGXY   J     EXITY                                                            
*                                                                               
GTMGCKSM GOTOR PUTERR,DMCB,('SE#SY023',SE#ORDNC)                                
GTMGXN   J     EXITN                                                            
*                                                                               
***************                                                                 
* GET THE NOTICE RECORD                                                         
***************                                                                 
GETNOTC  NTR1                                                                   
         LA    R1,IOKEY                                                         
         USING MNKEY,R1                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   MNKTYPE,MNKTYPQ                                                  
         MVI   MNKSUBTY,MNKSTYPQ                                                
         MVC   MNKAGMD,SVBAGM                                                   
*                                                                               
         MVC   MNKBYR,SVQBYR                                                    
         OC    MNKBYR,SPACES                                                    
         MVC   MNKORDER,BINORDER                                                
         MVC   MNKGROUP,MKGRPCOD                                                
         OC    MNKGROUP,SPACES                                                  
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JNE   *+2                                                              
         CLC   IOKEY(L'MNKEY),IOKEYSAV                                          
         JE    GTNT010                                                          
         GOTOR PUTERR,DMCB,('SE#SY023',SE#OFFNF)                                
         J     GTNTXN                                                           
*                                                                               
GTNT010  MVC   NOTCADDR,IOKEY+14                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO3'                           
         JNE   *+2                                                              
GTNTXY   J     EXITY                                                            
GTNTXN   J     EXITN                                                            
***************                                                                 
* GET THE OFFER RECORD                                                          
***************                                                                 
GETOFFR  NTR1                                                                   
         LA    R1,IOKEY                                                         
         USING MOKEY,R1                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   MOKTYPE,MOKTYPQ                                                  
         MVI   MOKSUBTY,MOKSTYPQ                                                
         MVC   MOKAGMD,SVBAGM                                                   
         MVC   MOKORDER,BINORDER                                                
         MVC   MOKMGCD,MKGRPCOD                                                 
         OC    MOKMGCD,SPACES                                                   
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO5'                               
         JNE   *+2                                                              
         CLC   IOKEY(L'MOKEY),IOKEYSAV                                          
         JE    GTOF010                                                          
         GOTOR PUTERR,DMCB,('SE#SY023',SE#OFFNF)                                
         J     GTOFXN                                                           
*                                                                               
GTOF010  MVC   OFF1ADDR,IOKEY+14                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO5'                           
         JNE   *+2                                                              
*                                                                               
         XC    OFF2ADDR,OFF2ADDR                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO6'                               
         JNE   *+2                                                              
         CLC   IOKEY(10),IOKEYSAV    TYPE/MGORD/CODE                            
         JNE   GTOFXY                                                           
         CLI   IOKEY+10,X'FF'                                                   
         JE    GTOFXY                                                           
         MVC   OFF2ADDR,IOKEY+14   SAVE DISK ADDRESS                            
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO6'                           
         JNE   *+2                                                              
GTOFXY   J     EXITY                                                            
GTOFXN   J     EXITN                                                            
         EJECT                                                                  
***************                                                                 
* GET THE NOTICE RECORD                                                         
***************                                                                 
GETXNOTC NTR1                                                                   
         L     RE,0(R1)                                                         
         LA    R1,IOKEY                                                         
         USING MNXKEY,R1                                                        
         XC    IOKEY,IOKEY                                                      
         MVI   MNXKTYPE,MNXKTYPQ                                                
         MVI   MNXKSBTY,MNXKSBTQ                                                
         MVC   MNXKAGMD,SVBAGM                                                  
*                                                                               
         MVC   MNXKORDR,BINORDER                                                
         MVC   MNXKGRP,MKGRPCOD                                                 
         OC    MNXKGRP,SPACES                                                   
         LTR   RE,RE                                                            
         JZ    GTXNT005                                                         
         OC    MNXKSTTN,0(RE)                                                   
         JZ    *+2                 BETTER HAVE A STATION                        
*                                                                               
GTXNT005 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOXSPDIR+IO3'                            
         JNE   *+2                                                              
         CLC   IOKEY(L'MNXKEY),IOKEYSAV                                         
         JE    GTXNT010                                                         
         GOTOR PUTERR,DMCB,('SE#SY023',SE#OFFNF)                                
         J     GTXNTXN                                                          
*                                                                               
GTXNT010 MVC   NOTCADDR,IOKEY+36                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOXSPFIL+IO3'                        
         JNE   *+2                                                              
GTXNTXY  J     EXITY                                                            
GTXNTXN  J     EXITN                                                            
***************                                                                 
* GET THE OFFER RECORD                                                          
***************                                                                 
GETXOFFR NTR1                                                                   
         L     RE,0(R1)                                                         
         LA    R1,IOKEY                                                         
         USING MOXKEY,R1                                                        
         XC    IOKEY,IOKEY                                                      
         MVI   MOXKTYPE,MOXKTYPQ                                                
         MVI   MOXKSBTY,MOXKSBTQ                                                
         MVC   MOXKAGMD,SVBAGM                                                  
         MVC   MOXKORDR,BINORDER                                                
         MVC   MOXKMGCD,MKGRPCOD                                                
         OC    MOXKMGCD,SPACES                                                  
         LTR   RE,RE                                                            
         JZ    GTXOF005                                                         
         OC    MOXKSTTN,0(RE)                                                   
         JZ    *+2                 BETTER HAVE A STATION                        
*                                                                               
GTXOF005 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOXSPDIR+IO5'                            
         JNE   *+2                                                              
         CLC   IOKEY(L'MOXKEY),IOKEYSAV                                         
         JE    GTXOF010                                                         
         GOTOR PUTERR,DMCB,('SE#SY023',SE#OFFNF)                                
         J     GTXOFXN                                                          
*                                                                               
GTXOF010 MVC   OFF1ADDR,IOKEY+36                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOXSPFIL+IO5'                        
         JNE   *+2                                                              
*                                                                               
         XC    OFF2ADDR,OFF2ADDR                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IOXSPDIR+IO6'                            
         JNE   *+2                                                              
         CLC   IOKEY(MOXKSEQ-MOXKEY),IOKEYSAV    AGMD/ORD/MGCD/STN-NTWK         
         JNE   GTXOFXY                                                          
         CLI   IOKEY+MOXKDTYP-MOXKEY,0     HAVE DATA TYPE RECORD?               
         JNE   GTXOFXY                     YES                                  
         MVC   OFF2ADDR,IOKEY+36   SAVE DISK ADDRESS                            
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOXSPFIL+IO6'                        
         JNE   *+2                                                              
GTXOFXY  J     EXITY                                                            
GTXOFXN  J     EXITN                                                            
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* CHECK SUP ROUTINE                                                             
* ON ENTRY : PARAM1     A(RECORD)                                               
*            PARAM2     A(CHECKSUM VALUE)                                       
*            PARAM3     D/A OF THE RECORD                                       
*                                                                               
* ON EXIT :  CC = EQ    PARAM1 IS ZERO OR RECORD MATCHED ON CHECKSUM            
*                        - ADD D/A OF RECORD TO CKSMTAB IF                      
*            CC = NEQ   RECORD DID NOT MATCH ON CHECKSUM                        
***********************************************************************         
*                                                                               
CHKRECSM NTR1  BASE=*,LABEL=*                                                   
         ICM   R4,15,4(R1)         DID WE GET A CHECKSUM?                       
         OC    0(4,R4),0(R4)                                                    
         JZ    CKSUMY              NO, JUST EXIT                                
*                                                                               
         L     RE,8(R1)            RE = DISKADDRESS                             
         LA    RF,CKSMTAB          TEST IF WE ALREADY CHECKED THIS BUY          
         LA    R0,CKSMTABQ                                                      
CKSUM02  OC    0(L'DISKADDR,RF),0(RF)     END OF D/A TABLE                      
         JZ    CKSUM04                                                          
         C     RE,0(0,RF)          TEST CHECKED THIS REC ALREADY                
         JE    CKSUMY                                                           
         AHI   RF,L'CKSMTAB        BUMP TO NEXT D/A ENTRY                       
         BRCT  R0,CKSUM02                                                       
         DC    H'0'                INCREASE CKSMTAB                             
*                                                                               
CKSUM04  L     R2,0(R1)            R3 = A(RECORD)                               
         SR    R3,R3                                                            
         ICM   R3,3,13(R2)                                                      
         CLI   MKBSTA,X'E8'        CABLE?                                       
         BL    CKSUM08                                                          
         CLC   0(2,R2),=X'0D36'    NOTICE RECORD?                               
         JE    CKSUM06                                                          
         CLC   0(R2,R2),=X'0D37'   OFFER RECORD?                                
         JNE   CKSUM08                                                          
CKSUM06  ICM   R3,3,32(R2)                                                      
*                                                                               
CKSUM08  SR    R0,R0                                                            
         CKSM  R0,R2               CALCULATE CHECK SUM                          
         JO    *-4                                                              
         C     R0,0(R4)            TEST IF RECORD CHANGED                       
         JNE   CKSUMN                                                           
         ST    RE,0(RF)            SAVE D/A OF CHECKED RECORD                   
*                                                                               
CKSUMY   J     EXITY                                                            
*                                                                               
CKSUMN   J     EXITN                                                            
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* INTERFACE TO TSAR (ONLINE) OR BUFFERIN (OFFLINE)                    *         
***********************************************************************         
                                                                                
         USING BUFFD,FLMBUF                                                     
BUFFER   NTR1  BASE=*,LABEL=*                                                   
         LR    R2,R1                                                            
         MVC   TSACTN,0(R2)                                                     
*                                                                               
         CLI   TSACTN,TSAINI       TEST INITIALIZATION CALL                     
         JNE   BUFF030                                                          
         XC    TSARBLK,TSARBLK     CLEAR TSAR BLOCK                             
         MVI   TSACTN,TSAINI                                                    
         LA    R0,TSARREC                                                       
         ST    R0,TSAREC                                                        
         MVC   TSACOM,ACOMFACS                                                  
         MVC   TSPAGN,3(R2)                                                     
         OI    TSINDS,TSINODSK+TSIXTTWA                                         
         MVC   TSKEYL,4(R2)        SET KEY LENGTH                               
         MVC   TSRECL,6(R2)        SET REC LENGTH                               
         OC    TSRECI,8(R2)        SET IF VARIABLE LENGTH                       
*                                                                               
BUFF030  TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         JNZ   BUFF060             YES                                          
         CLI   TSACTN,TSAGET                                                    
         JE    BUFF040                                                          
         CLI   TSACTN,TSANXT                                                    
         JE    BUFF040                                                          
         CLI   TSACTN,TSARDH                                                    
         JNE   BUFF050                                                          
*                                                                               
BUFF040  LA    R0,TSARREC          CLEAR TSARREC                                
         LHI   R1,L'TSARREC                                                     
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
BUFF050  GOTOR VTSAR,TSARD         YES - USE TSAR                               
         J     EXITCC                                                           
*                                                                               
BUFF060  LHI   R0,BUFFAINI         CONVERT TSAR ACTION CODE TO BUFFERIN         
         CLI   TSACTN,TSAINI                                                    
         JNE   BUFF070                                                          
         LLC   RE,TSKEYL                                                        
         SR    RF,RF                                                            
         ICM   RF,3,TSRECL                                                      
         SR    RF,RE                                                            
         STCM  RE,3,BUFFLKEY       SET KEY LENGTH                               
         STCM  RF,3,BUFFLCOM       SET COMMENT LENGTH                           
         J     BUFF080                                                          
*                                                                               
BUFF070  LHI   R0,BUFFAPUT                                                      
         CLI   TSACTN,TSAADD                                                    
         JE    BUFF080                                                          
         CLI   TSACTN,TSAWRT                                                    
         JE    BUFF080                                                          
         LHI   R0,BUFFASEQ                                                      
         CLI   TSACTN,TSANXT                                                    
         JE    BUFF080                                                          
         LA    R0,TSARSAV                                                       
         LHI   R1,L'TSARSAV                                                     
         LA    RE,TSARREC                                                       
         LHI   RF,R1                                                            
         MVCL  R0,RE                                                            
         LHI   R0,BUFFARDH                                                      
         CLI   TSACTN,TSARDH                                                    
         JNE   *+2                                                              
*                                                                               
BUFF080  GOTOR ABUFFRIN,DMCB,((R0),BUFFD),TSARREC,ACOMFACS                      
         CLI   TSACTN,TSARDH                                                    
         JNE   BUFF090                                                          
         LLC   RF,TSKEYL                                                        
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         EX    RF,8(RE)                                                         
         JE    BUFF090                                                          
         CLC   TSARREC(0),TSARSAV                                               
         OI    BUFFERRS-BUFFPARM(R1),BUFFERNF                                   
*                                                                               
BUFF090  MVC   TSERRS,BUFFERRS-BUFFPARM(R1)                                     
         CLI   TSERRS,0                                                         
         J     EXITCC                                                           
         EJECT                                                                  
***********************************************************************         
* REPORT ROUTINE                                                                
***********************************************************************         
GOREPORT NTR1  BASE=*,LABEL=*                                                   
         LLC   RF,0(R1)                                                         
         BCTR  RF,0                                                             
         SLL   RF,2                                                             
         CHI   RF,GOREPTBL                                                      
         JNL   *+2                                                              
         B     GOREPTAB(RF)                                                     
*                                                                               
GOREPTAB B     GRINIT                                                           
         B     GROPEN                                                           
         B     GRCLEAR                                                          
         B     GRPUT                                                            
         B     GRCLOSE                                                          
         B     EXITN                                                            
         B     EXITN                                                            
         B     EXITN                                                            
         B     GRREOPEN                                                         
GOREPTBL EQU   *-GOREPTAB                                                       
*                                                                               
* INITIALIZE THE PRINT QUEUE                                                    
*                                                                               
GRINIT   TM    REPSTAT,X'02'       XML/MQ/REDI ORDER?                           
         JO    EXITY                                                            
         MVC   REPACOM,LP_ACOM     EXTRACT A(LINKIO) FROM COMFACS               
         MVI   REPACTN,REPAINI                                                  
         LA    R1,H1                                                            
         ST    R1,REPABUF                                                       
         GOTOR VREPORT,REPBLK                                                   
         CLI   REPERRS,0                                                        
         JNE   *+2                                                              
         J     EXITY                                                            
*                                                                               
* OPEN THE PRINT QUEUE                                                          
*                                                                               
GROPEN   TM    REPSTAT,X'02'       XML/MQ/REDI ORDER?                           
         JZ    GROPEN10                                                         
         MVI   LINENUM,0           NO LINES READ YET                            
         BRAS  RE,PRTOFF                                                        
         SAM31 ,                                                                
         L     R3,AMINBUFF         PUT MSG TO TSAR BUFFER                       
         MVC   0(16,R3),=CL16'RADIOEDIXML*****'                                 
*&&DO                                                                           
*  THIS IS NOT NEEDED ANYMORE  -  WHOA  2007-04-05                              
         CLC   SVDESTID(3),=C'MEG'                                              
         JNE   *+10                                                             
         MVC   0(16,R3),=CL16'DDSTESTINGQUEUE*'                                 
*&&                                                                             
         LA    R3,16(R3)                                                        
         ST    R3,AMINDISP                                                      
         SAM24 ,                                                                
         BRAS  RE,PRTON                                                         
         J     EXITY                                                            
*                                                                               
GROPEN10 MVI   REPACTN,REPAOPN                                                  
         L     RF,ATIA                                                          
         AHI   RF,4096                                                          
         ST    RF,REPAPQB          SET TIA+4K AS THE PRINT QUEUE BUFFER         
         MVC   REPAPQB,ATIA        SET TIA AS THE PRINT QUEUE BUFFER            
         MVC   REPUSRID,SVBORGID                                                
*        OI    REPTYPE,QLTYAD      REPORT ARCHIVED                              
         MVC   REPRLH,=H'48'       SET PRINTQ RETAIN TIMES  48 ACTIVE           
         MVC   REPRDH,=H'12'                                24 PRINTED          
         MVC   REPFORM,=CL4'SLK'                                                
         MVI   REPCOPY,1                                                        
         GOTOR VDATCON,DMCB,(5,0),(3,REPDATE)  BINARY YMD                       
*                                                                               
         GOTOR VREPORT,REPBLK                                                   
         CLI   REPERRS,0                                                        
         JNE   *+2                                                              
         J     EXITY                                                            
*                                                                               
GRCLEAR  TM    REPSTAT,X'02'       XML/MQ/REDI ORDER?                           
         JO    EXITY                                                            
         MVI   REPACTN,REPACLR                                                  
         GOTOR VREPORT,REPBLK                                                   
         CLI   REPERRS,0                                                        
         JNE   *+2                                                              
         J     EXITY                                                            
*                                                                               
* PUT TO THE PRINT QUEUE                                                        
*                                                                               
GRPUT    TM    REPSTAT,X'02'       XML/MQ/REDI ORDER?                           
         JZ    GRPUT20                                                          
         LA    R2,DARENTRY                                                      
GRPUT05  CLI   0(R2),X'FF'                                                      
         JE    GRPUT15                                                          
         CLC   PW(6),0(R2)                                                      
         JE    GRPUT10                                                          
         LA    R2,8(R2)                                                         
         J     GRPUT05                                                          
*                                                                               
GRPUT10  BRAS  RE,PRTOFF                                                        
         SAM31 ,                                                                
         L     R3,AMINDISP                                                      
         MVC   0(L'PW,R3),PW                                                    
         OC    0(L'SPACES,R3),SPACES                                            
         OC    L'SPACES(L'PW-L'SPACES,R3),SPACES                                
         AH    R3,6(R2)                                                         
         MVC   0(2,R3),=X'0D25'                                                 
         LA    R3,2(R3)                                                         
         ST    R3,AMINDISP                                                      
         SAM24 ,                                                                
         BRAS  RE,PRTON                                                         
GRPUT15  XC    PW,PW                                                            
         J     GRPUT25                                                          
*                                                                               
GRPUT20  MVI   REPACTN,REPAPUT                                                  
         GOTOR VREPORT,REPBLK                                                   
         CLI   REPERRS,0                                                        
         JNE   *+2                                                              
*                                                                               
GRPUT25  L     R1,AGYNMRCS         INCREMENT NUMBER OF RECORDS PRINTED          
         LLC   RF,REPPRNTN                                                      
         LA    R1,0(R1,RF)                                                      
         ST    R1,AGYNMRCS                                                      
GRPUTX   J     EXITY                                                            
*                                                                               
* CLOSE THE PRINT QUEUE                                                         
*                                                                               
GRCLOSE  TM    REPSTAT,X'02'       XML/MQ/REDI ORDER?                           
         JZ    GRCLOS10                                                         
         CLI   SVMED,C'R'          IF I'M HERE AND NOT MEDIA R, DIE!            
         JNE   GRCLOSDIE                                                        
         BRAS  RE,PRTOFF                                                        
         SAM31 ,                                                                
         L     R3,AMINDISP                                                      
         AHI   R3,-2               REMOVE LAST X'0D25'                          
         L     R2,AMINBUFF                                                      
         SR    R3,R2                                                            
         L     RF,ACOMFACS                                                      
         L     RF,ACOMFACS                                                      
         L     RF,CMQIO-COMFACSD(RF)                                            
         GOTOR (RF),DMCB,=CL8'PUT',AMINBUFF,(R3),0,0,DUB                        
         SAM24 ,                                                                
         BRAS  RE,PRTON                                                         
         J     EXITY                                                            
*                                                                               
GRCLOS10 MVI   REPACTN,REPACLO                                                  
         GOTOR VREPORT,REPBLK                                                   
         CLI   REPERRS,0                                                        
         JNE   *+2                                                              
         J     EXITY                                                            
GRCLOSDIE DC   H'0'                                                             
*                                                                               
* REOPEN THE PRINT QUEUE                                                        
*                                                                               
GRREOPEN TM    REPSTAT,X'02'       XML/MQ/REDI ORDER?                           
         JO    EXITY                                                            
         MVI   REPACTN,REPAREO                                                  
         GOTOR VREPORT,REPBLK                                                   
         CLI   REPERRS,0                                                        
         JNE   *+2                                                              
         J     EXITY                                                            
         EJECT                                                                  
*                                                                               
PRTOFF   LR    R1,RE                                                            
         L     RF,ACOMFACS                                                      
         L     RF,CPROTOFF-COMFACSD(RF)                                         
         GOTOR (RF)                                                             
         BR    R1                                                               
*                                                                               
PRTON    LR    R1,RE                                                            
         L     RF,ACOMFACS                                                      
         L     RF,CPROTON-COMFACSD(RF)                                          
         GOTOR (RF)                                                             
         BR    R1                                                               
*                                                                               
         PRINT OFF                                                              
       ++INCLUDE SPDARDAREL                                                     
         PRINT ON                                                               
         EJECT                                                                  
***********************************************************************         
* SAVE TIA TO WSSVR - ONLY FOR OM TRANSACTIONS                                  
* BECAUSE WE USE ATIA FOR PQ BUFFER                                             
***********************************************************************         
         USING FAWSSVRD,WORK                                                    
SAVETIA  NTR1  BASE=*,LABEL=*                                                   
         LHI   R0,18*ONEK                                                       
         STCM  R0,3,FAWSLEN                                                     
         MVC   FAWSTOKN,=C'STIA'                                                
         MVC   FAWSADR,ATIA                                                     
         MVI   FAWSACTN,FAWSASVE                                                
         L     RF,ACOMFACS                                                      
         L     RF,CWSSVR-COMFACSD(RF)                                           
         GOTOR (RF),FAWSSVRD       SAVE THE TIA                                 
         CLI   FAWSRTN,0                                                        
         JE    EXITY                                                            
         DC    H'0'                DIE IF CAN'T SAVE RECORD TO WSSVR            
*                                                                               
***********************************************************************         
* RESTORE TIA FROM WSSVR                                                        
***********************************************************************         
         USING FAWSSVRD,WORK                                                    
RESTTIA  NTR1  BASE=*,LABEL=*                                                   
         LHI   R0,18*ONEK                                                       
         STCM  R0,3,FAWSLEN                                                     
         MVC   FAWSTOKN,=C'STIA'                                                
         MVC   FAWSADR,ATIA                                                     
         MVI   FAWSACTN,FAWSARST                                                
         L     RF,ACOMFACS                                                      
         L     RF,CWSSVR-COMFACSD(RF)                                           
         GOTOR (RF),FAWSSVRD       RESTORE THE TIA                              
         CLI   FAWSRTN,0                                                        
         JNE   *+2                 DIE IF CAN'T RESTORE RECORD BUFFER           
*                                                                               
         MVI   FAWSACTN,FAWSADEL   AND DELETE IT                                
         GOTOR (RF),FAWSSVRD       RESTORE THE TIA                              
         CLI   FAWSRTN,0                                                        
         JNE   *+2                 DIE IF CAN'T RESTORE RECORD BUFFER           
*                                                                               
         J     EXITY                                                            
***********************************************************************         
* GET THE USER ID RECORD                                                        
*                                                                               
* ON ENTRY:    PARAM 1 BYTE  0     INPUT FLAGS                                  
*                                  X'80' - GET ROUTING CODE AND                 
*                                          ORIGIN NAME/ADDRESS                  
*                      BYTES 1-3   A(ID NUMBER)                                 
*                                                                               
*              PARAM 1 BYTE  0                                                  
*                      BYTES 1-3   A(OUTPUT FIELD)                              
*                                                                               
* ON EXIT:     IOKEY & IOKEYSAV GOT CLOBBERED                                   
*              AIO2 WAS USED                                                    
*              ELCDLO/ELCDHI GET CLOBBERED                                      
***********************************************************************         
GTUSERID NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(R1)            SET UP VARIABLES                             
         L     R2,4(R1)                                                         
         MVC   BYTE,0(R1)                                                       
*                                                                               
         OC    0(2,R3),0(R3)       ANY ID NUMBER?                               
         JZ    GUIXY               NONE, THEN EXIT                              
         CLC   =X'FFFE',0(R3)                                                   
         JE    GUIXY                                                            
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY                                                         
         USING CTIKEY,R4                                                        
         MVI   CTIKTYP,CTIKTYPQ                                                 
         MVC   CTIKNUM,0(R3)                                                    
         DROP  R4                                                               
*                                                                               
         MVC   IOADDR,AIO8                                                      
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOCTFILE'                                
         JNE   *+2                                                              
*                                                                               
         L     R4,AIO8                                                          
         USING CTIREC,R4                                                        
         LA    R4,CTIDATA                                                       
GUI005   CLI   0(R4),0                                                          
         JE    *+2                                                              
*                                                                               
         CLI   0(R4),CTDSCELQ      X'02' - DESCRIPTION ELEMENT?                 
         JE    GUI010                                                           
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         J     GUI005                                                           
*                                                                               
         USING CTDSCD,R4                                                        
GUI010   LLC   R1,CTDSCLEN                                                      
         SH    R1,=Y(CTDSC-CTDSCD+1)                                            
         MVC   0(0,R2),CTDSC       COPY USER ID TO OUTPUT                       
         EX    R1,*-6                                                           
         DROP  R4                                                               
*                                                                               
         TM    BYTE,X'80'       CALLER ASKED FOR DARE & ORIGIN DETAILS?         
         JZ    GUIXY               NO                                           
*                                                                               
         L     R4,AIO8                                                          
         USING CTIKEY,R4                                                        
         LA    R4,CTIDATA                                                       
         XC    SVDRROUT,SVDRROUT   CLEAR DARE ROUTING CODE                      
         MVI   ELCDLO,CTUSAELQ     X'33' US AGENCY EXTRA (DARE)                 
         MVI   ELCDHI,CTUSAELQ     X'33' US AGENCY EXTRA (DARE)                 
         BRAS  RE,NEXTEL2                                                       
         JNE   GUI020                                                           
         USING CTUSAD,R4                                                        
         MVC   SVDRROUT,CTUSADRC   GET DARE ROUTING CODE                        
         DROP  R4                                                               
*                                                                               
GUI020   L     R4,AIO8                                                          
         USING CTIKEY,R4                                                        
         LA    R4,CTIDATA                                                       
         MVI   ELCDLO,CTORGELQ     X'36' ORIGIN DETAILS                         
         MVI   ELCDHI,CTORGELQ     X'36' ORIGIN DETAILS                         
         BRAS  RE,NEXTEL2                                                       
         JNE   GUIXY                                                            
         USING CTORGD,R4                                                        
         MVC   REPUSRN,CTORGNAM    GET ORIGIN NAME                              
         MVC   REPUSRA,CTORGADD    GET ORIGIN ADDRESS                           
         DROP  R4                                                               
*                                                                               
GUIXY    J     EXITY                                                            
GUIXN    J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* ADD THE IO TO THE IOLIST                                                      
***********************************************************************         
ADDIOLST NTR1  BASE=*,LABEL=*                                                   
         LA    R2,AIOLIST                                                       
AIL005   OC    0(2,R2),0(R2)       FOUND AN ENTRY?                              
         JZ    AIL010               NO                                          
         CLM   R1,3,0(R2)          DO WE HAVE A DUPLICATE ENTRY?                
         JE    AILX                 YES, EXIT                                   
         LA    R2,2(R2)                                                         
         J     AIL005                                                           
*                                                                               
AIL010   LA    RF,AIOLIST+L'AIOLIST                                             
         CR    R2,RF                                                            
         JH    *+2                 NEED TO ADD MORE SPACE TO AIOLIST            
         STCM  R1,3,0(R2)                                                       
AILX     J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* PUT THE RECORD BACK                                                           
***********************************************************************         
PUTMYREC NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         TM    PREVFLAG,PRFERROR                                                
         JO    PTMYRCX                                                          
PTMYRC00 LA    R2,AIOLIST                                                       
PTMYRC01 LA    R1,AIOLIST+L'AIOLIST                                             
         CR    R2,R1                                                            
         JNL   PTMYRCX                                                          
         OC    0(2,R2),0(R2)                                                    
         JZ    PTMYRCX                                                          
         SR    R1,R1                                                            
         ICM   R1,3,0(R2)                                                       
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),(R1)                                           
         JNE   *+2                 SOMETHING BAD HAPPENED!!!                    
         LA    R2,2(R2)                                                         
         J     PTMYRC01                                                         
*                                                                               
PTMYRCX  XC    AIOLIST,AIOLIST                                                  
         MVI   MISCFLG1,0                                                       
         MVI   MISCFLG2,0                                                       
         MVI   PREVFLAG,0                                                       
         J     EXITY                                                            
         DROP  RB                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
* PROCESS THE METADATA U/L -> D/L  RECORD                                       
*                                                                               
***********************************************************************         
SDMETADL DS    0H                                                               
         LARL  R1,OUTMTA           GET A(LKOUT STATEMENTS)                      
         ST    R1,LP_AOMAP                                                      
*                                                                               
         GOTOR LP_APUTO,LP_D       CALL DDLINK OUTPUT PROCESSOR                 
*                                                                               
SDMDLY   J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* PROCESS THE OM HEADER RECORD                                                  
*  ON ENTRY : QMED        CHAR MEDIA CODE                                       
*             BINORDER    GET THE ORDER RECORD                                  
*             SVQBYR      HAVE BUYER, THEN GET NOTICE RECORD                    
*             MKGRPCOD    HAVE GRPCODE, THEN GET OFFER RECORD                   
*                                                                               
*   ON EXIT : CC = EQ     SAME RECORD                                           
*             CC = NEQ    DIFFERENT RECORD                                      
*                                                                               
***********************************************************************         
OMHEADER NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    PCKEYORD,PCKEYORD                                                
         ICM   RF,15,I$PCKEY                                                    
         JZ    OMHE000                                                          
         SR    R1,R1                                                            
         ICM   R1,3,LW_LN-LW_D(RF)                                              
         AHI   R1,-(LW_LN1Q+1)                                                  
         MVC   PCKEYORD(0),LW_DATA1-LW_D(RF)                                    
         EX    R1,*-6                                                           
*                                                                               
OMHE000  GOTOR VALHEADR                                                         
*                                                                               
         OC    PREVKEY,PREVKEY     HAVE WE ALREADY CHANGED A RECORD?            
         JZ    OMHEO20              NO, READ A NEW RECORD                       
         CLC   PREVKEY,CURRKEY      YES, IS IT SAME RECORD?                     
         JE    OMHEXY                YES, DON'T READ IT AGAIN                   
*                                                                               
OMHE010  BRAS  RE,PUTMYREC         CHK OUTSTANDIN IOS AND PUTREC THEM           
*                                                                               
OMHEO20  TM    CURRFLAG,CRFERROR   ANY CURRENT ERRORS IN VALHEADR?              
         JO    OMHEXN               YES, SKIP                                   
         ICM   RE,15,I$BINORD                                                   
         JZ    OMHEXY              PREVKEY SET IN ADDORDER                      
         GOTOR GETORD                                                           
         JNE   OMHEXN                                                           
*                                                                               
         ICM   RE,15,I$GRPCD                                                    
         JZ    OMHEX20                                                          
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         MVI   ELCDHI,DOIDELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
         MVC   SVQBYR,DOIDBYR      GET THE BUYER                                
*                                                                               
         CLI   DOISTA,X'E8'        CABLE?                                       
         BL    OMHEX05                                                          
         MVC   SVBSTA,DOISTA                                                    
         OC    MKBSTA,MKBSTA       DID PC SPECIFY STATION/NETWORK               
         BNZ   OMHEX10                                                          
         GOTOR PUTERR,DMCB,('SE#SY002',SE#MSGSN)                                
         J     OMHEXN                                                           
OMHEX05  XC    MKBSTA,MKBSTA                                                    
*                                                                               
* TEMPORARY CODE UNTIL DESKTOP VALIDATES ADJACENCY CODES                        
*                                                                               
OMHEX10  L     RF,ACLTREC          WE CANNOT ASSUME THIS IS SETUP FOR           
         USING CLTRECD,RF              OUR CLT CODE                             
         CLC   CKEYAM,SVBAGM                                                    
         JNE   OMHEX12                                                          
         CLC   CKEYCLT,DOIDCLT                                                  
         JE    OMHEX15                                                          
OMHEX12  MVC   QCLTX,DOIDCLT                                                    
         GOTOR (#GETCLT,AGETCLT)                                                
*                                                                               
OMHEX15  MVC   SVBCLT,DOIDCLT                                                   
         MVC   SVBEST,DOIDEST                                                   
         DROP  R4,RF                                                            
*                                                                               
         MVC   SVQPRD,=C'POL'      LOOK FOR THE POL ESTIMATE                    
         BRAS  RE,GTESTINF         AIO7 TO HOLD ESTIMATE                        
*                                                                               
         GOTOR GETMG                                                            
         JNE   OMHEXN                                                           
OMHEX20  MVC   PREVKEY,CURRKEY                                                  
*                                                                               
OMHEXY   J     EXITY                                                            
*                                                                               
OMHEXN   J     EXITN                                                            
*                                                                               
***********************************************************************         
* VALIDATES THE HEADER                                                          
***********************************************************************         
VALHEADR NTR1  BASE=*,LABEL=*                                                   
         XC    CURRKEY,CURRKEY           INIT CURRKEY                           
         XC    SVBAGM(SVBVALS),SVBAGM     AND SAVED BINARY VALUES               
*---------------                                                                
* VALIDATE MEDIA                                                                
*---------------                                                                
         ICM   RE,15,I$BAGM                                                     
         USING LW_D,RE                                                          
         SR    R3,R3                                                            
         ICM   R3,3,LW_LN                                                       
         AHI   R3,-(LW_LN1Q)                                                    
         GOTOR (#VALMED,AVALMED),DMCB,LW_DATA1,(R3),SVBAGM                      
         JE    VAHE005                                                          
         GOTOR PUTERR,DMCB,('SE#SY002',SE#INVMD)                                
         J     VAHEXN                                                           
VAHE005  MVC   SVMED,QMEDA                                                      
*--------------------------                                                     
* VALIDATE THE ORDER NUMBER                                                     
*--------------------------                                                     
         ICM   RE,15,I$BINORD                                                   
         JZ    VAHE020                                                          
         SR    R3,R3                                                            
         ICM   R3,3,LW_LN                                                       
         AHI   R3,-(LW_LN1Q)                                                    
         GOTOR (#VALORD,AVALORD),DMCB,LW_DATA1,(R3),BINORDER                    
         JE    VAHE010                                                          
         GOTOR PUTERR,DMCB,('SE#SY023',SE#ORDNF)                                
         J     VAHEXN                                                           
VAHE010  MVC   SVQORDER,LW_DATA1                                                
*------------------------                                                       
* VALIDATE THE GROUP CODE                                                       
*------------------------                                                       
VAHE020  ICM   RE,15,I$GRPCD                                                    
         JZ    VAHE030                                                          
         OC    BINORDER,BINORDER                                                
         JNZ   VAHE025                                                          
         GOTOR PUTERR,DMCB,('SE#SY003',SE#UNEXP)                                
         J     VAHEXN                                                           
         USING LW_D,RE                                                          
VAHE025  MVC   MKGRPCOD,LW_DATA1                                                
         OC    MKGRPCOD,SPACES                                                  
*-------------------------                                                      
* VALIDATE THE CLIENT CODE                                                      
*-------------------------                                                      
VAHE030  ICM   RE,15,I$BCLT                                                     
         JZ    VAHE040                                                          
         SR    R3,R3                                                            
         ICM   R3,3,LW_LN                                                       
         AHI   R3,-(LW_LN1Q)                                                    
         GOTOR (#VALCLT,AVALCLT),DMCB,LW_DATA1,(R3),SVBCLT                      
         JNE   VAHEXN                                                           
         MVC   SVQCLT,QCLTA                                                     
*--------------------------                                                     
* VALIDATE THE PRODUCT CODE                                                     
*--------------------------                                                     
VAHE040  XC    SVQPRD,SVQPRD                                                    
         ICM   RE,15,I$BPRD                                                     
         JZ    VAHE050                                                          
         SR    R3,R3                                                            
         ICM   R3,3,LW_LN                                                       
         AHI   R3,-(LW_LN1Q)                                                    
         GOTOR (#VALPRD,AVALPRD),DMCB,LW_DATA1,(R3),SVBPRD                      
         JNE   VAHEXN                                                           
         ICM   RE,15,I$BPRD                                                     
         MVC   SVQPRD,LW_DATA1                                                  
         OC    SVQPRD,SPACES                                                    
*---------------------------                                                    
* VALIDATE THE PRODUCT2 CODE                                                    
*---------------------------                                                    
VAHE050  XC    SVQPR2,SVQPR2                                                    
         ICM   RE,15,I$BPRD2                                                    
         JZ    VAHE060                                                          
         SR    R3,R3                                                            
         ICM   R3,3,LW_LN                                                       
         AHI   R3,-(LW_LN1Q)                                                    
         GOTOR (#VALPRD,AVALPRD),DMCB,LW_DATA1,(R3),SVBPR2                      
         JNE   VAHEXN                                                           
         ICM   RE,15,I$BPRD2                                                    
         MVC   SVQPR2,LW_DATA1                                                  
         OC    SVQPR2,SPACES                                                    
*----------------------                                                         
* VALIDATE THE ESTIMATE                                                         
*----------------------                                                         
VAHE060  ICM   RE,15,I$BEST                                                     
         JZ    VAHE070                                                          
         MVC   SVBEST,LW_DATA1                                                  
*--------------------                                                           
* VALIDATE THE FLIGHT                                                           
*--------------------                                                           
VAHE070  ICM   RE,15,I$BFLT                                                     
         JZ    VAHE075                                                          
         MVC   SVBFLT,LW_DATA1                                                  
*                                                                               
VAHE075  OC    BINORDER,BINORDER   NOT A NEW ORDER?                             
         JNZ   VAHE080                                                          
         BRAS  RE,GTESTINF         GET ESTIMATE INFO                            
*                                                                               
         GOTOR GTFLTINF,DMCB,0     GET FLT REC AIO8                             
         JNE   VAHE079                                                          
         CLI   SVBFLT,0                                                         
         JE    VAHE080                                                          
         TM    FLTRCFLG,FRFEXIST   FLIGHT RECORD FOUND?                         
         JNZ   VAHE080              YES, GOOD                                   
VAHE079  GOTOR PUTERR,DMCB,('SE#SY023',SE#INVFL)                                
         J     VAHEXN                                                           
*---------------------                                                          
* VALIDATE THE STATION                                                          
*---------------------                                                          
VAHE080  ICM   RE,15,I$STN                                                      
         JZ    VAHE090                                                          
         MVI   LP_VPARM,$VALMKAS                                                
         SR    R3,R3                                                            
         ICM   R3,3,LW_LN                                                       
         AHI   R3,-(LW_LN1Q)                                                    
         GOTOR (#VALSTA,AVALSTA),DMCB,LW_DATA1,(R3),WORK                        
         LA    RF,WORK                                                          
         USING STAPACKD,RF                                                      
         MVC   SVQSTA,STAPQSTA                                                  
         CLI   SVQSTA+4,C' '                                                    
         JH    *+10                                                             
         MVC   SVQSTA+4(1),QMEDA                                                
         MVC   SVBSTA,STAPSTA                                                   
         MVC   MKBSTA,STAPSTA                                                   
         MVC   SVQMKT,STAPQMKT                                                  
         MVC   SVBMKT,STAPMKT                                                   
         MVI   LP_VPARM,0                                                       
         DROP  RF                                                               
*------------------------                                                       
* VALIDATE THE TRADE FLAG                                                       
*------------------------                                                       
VAHE090  ICM   RE,15,I$FLAG                                                     
         JZ    VAHEXY                                                           
         CLI   LW_DATA1,C'C'                                                    
         JE    VAHEXY                                                           
         CLI   LW_DATA1,C'T'                                                    
         JE    VAHE095                                                          
         GOTOR PUTERR,DMCB,('SE#SY003',SE#UNEXP)                                
         J     VAHEXN                                                           
VAHE095  MVI   SVFLAG1,SF1TRADE    TURN ON TRADE FLAG                           
*                                                                               
VAHEXY   J     EXITY                                                            
VAHEXN   J     EXITN                                                            
         DROP  RE                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
* SEND DARE TRANSMISSIONS                                                       
***********************************************************************         
XMITDARE NTR1  BASE=*,LABEL=*                                                   
         BRAS  RE,SAVETIA                                                       
*                                                                               
         XC    ORDXMTD(ORDXBKYL),ORDXMTD                                        
         MVI   ORXTYPE,ORXTYPEQ    GET FIRST ORDER RECORD IN TSAR               
         GOTOR BUFFER,DMCB,('TSARDH',0)                                         
         TM    TSERRS,TSEEOF        END-OF-FILE?                                
         JO    XMDA015                                                          
         J     XMDA020                                                          
*                                                                               
XMDA010  GOTOR BUFFER,DMCB,('TSANXT',0)                                         
         JE    XMDA020                                                          
         TM    TSERRS,TSEEOF        END-OF-FILE?                                
         JZ    *+2                   NO, DIE                                    
XMDA015  BRAS  RE,RESTTIA          RESTORE TIA                                  
         J     EXITY               AND EXIT                                     
*                                                                               
XMDA020  CLI   ORXTYPE,ORXTYPEQ    DID WE GET AN ORDER RECORD IN TSAR?          
         JNE   XMDA010                                                          
*                                                                               
         XC    REPBLK,REPBLK                                                    
         GOTOR GTUSERID,DMCB,(X'80',SVBORGID),SVORIGID                          
*                                                                               
         MVC   QMEDX,ORXAGM                                                     
         GOTOR (#EDTMED,AEDTMED),DMCB,QMEDX,0,QMEDA                             
         JNE   *+2                                                              
         MVC   SVMED,QMEDA                                                      
         MVC   SVBAGM,ORXAGM                                                    
*                                                                               
         LA    R1,ORXSTAC                                                       
         BRAS  RE,GETQSTA                                                       
*                                                                               
         MVC   ORD1ADDR,ORXORDDA                                                
         MVC   IODAOVER,ORXORDDA                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGETREC+IOFIL+IO3'                           
         JNE   *+2                                                              
*                                                                               
         L     R4,AIO3                                                          
         USING DAREORDD,R4                                                      
         MVC   BINORDER,DOKORDER                                                
         GOTOR (#EDTORD,AEDTORD),DMCB,DOKORDER,0,SVQORDER                       
         MVI   ELCDLO,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         MVI   ELCDHI,DOIDELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
         MVC   DARECONT,DOIDCON                                                 
         MVC   SALESPER,DOIDSPER                                                
         MVC   SVQBYR,DOIDBYR                                                   
         MVC   SVBSTA,DOISTA                                                    
*                                                                               
         MVC   QCLTX,DOIDCLT                                                    
         GOTOR (#GETCLT,AGETCLT)   READ CLIENT RECORD                           
         L     RF,ACLTREC                                                       
         USING CLTRECD,RF          R3=A(CLIENT RECORD)                          
         MVC   CLTNM,CNAME                                                      
         TM    COPT4,COP4TRD       IS THIS A TRADE CLIENT                       
         JZ    *+8                                                              
         OI    CLTFLAG1,CLTTRADE                                                
         MVC   SVACCAGY,CACCAGY                                                 
         MVC   SVACCOFC,CACCOFC                                                 
         MVC   SVCLTOFF,COFFICE                                                 
*                                                                               
         GOTOR VCLUNPK,DMCB,(CPROF+6,DOIDCLT),SVQCLT  GET EBCDIC CLIENT         
         MVC   QCLTA,SVQCLT                                                     
         MVC   SVBCLT,DOIDCLT                                                   
         DROP  RF                                                               
*                                                                               
         MVI   PROFFLG1,0                                                       
         BRAS  RE,GETPROFS                                                      
*                                                                               
         MVC   SVBPRD,DOIDPRD                                                   
         GOTOR (#EDTPRD,AEDTPRD),DMCB,DOIDPRD,0,SVQPRD                          
*                                                                               
         XC    SVQPR2,SVQPR2                                                    
         MVC   SVBPR2,DOIDPRD2                                                  
         CLI   DOIDPRD2,0          DO WE HAVE A PIGGY?                          
         JE    XMDA035             NO                                           
         GOTOR (#EDTPRD,AEDTPRD),DMCB,DOIDPRD2,0,SVQPR2                         
*                                                                               
XMDA035  MVC   SVBFLT,DOIDFLTN                                                  
         MVC   SVBEST,DOIDEST                                                   
         LLC   R1,DOIDEST                                                       
         CVD   R1,DUB                                                           
         UNPK  SVQEST,DUB                                                       
         OI    SVQEST+2,X'F0'                                                   
         DROP  R4                                                               
*                                                                               
         BRAS  RE,GTPRDINF         GET PRODUCT INFO                             
*                                                                               
         BRAS  RE,GTESTINF         GET ESTIMATE INFO                            
*                                                                               
****NOP  BRAS  RE,CHKCOMSC         CHECK IF ESTIMATE IS COMSCORE                
*                                                                               
         GOTOR GTFLTINF,DMCB,0     GET FLIGHT INFO                              
         JNE   *+2                                                              
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID ELEMENT               
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOSPELD,R4                                                       
         SR    R1,R1                                                            
         ICM   R1,3,DOSPMKT                                                     
         STCM  R1,3,SVBMKT                                                      
         CVD   R1,DUB                                                           
         UNPK  SVQMKT,DUB                                                       
         OI    SVQMKT+3,X'F0'                                                   
*                                                                               
         MVC   DRCSHTRD,DOSPTMTH                                                
*                                                                               
         LA    R2,IOKEY                                                         
         USING STAKEY,R2                                                        
         MVI   IOKEY,C'0'                                                       
         MVC   IOKEY+1(16),IOKEY                                                
         MVI   STAKTYPE,STAKTYPQ                                                
         MVC   STAKMED,SVMED                                                    
         MVC   STAKCALL,SVQSTA                                                  
         MVC   STAKAGY,LP_AGY                                                   
         MVC   STAKCLT,SVQCLT                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOSTAFIL+IO7'                            
         JNE   *+2                                                              
*                                                                               
         L     R2,AIO7                                                          
         USING STARECD,R2                                                       
         MVC   SVAFFL,SNETWRK                                                   
*                                                                               
         BRAS  RE,GETMKT           GET THE MARKET INFO                          
*                                                                               
         BRAS  RE,CHKFRCHG         ADD CHECK FOR CHANGE KEYS ON XMIT            
*                                                                               
         LA    R1,XMITTAB                                                       
         USING XMITTABD,R1                                                      
XMDA50   CLI   0(R1),X'FF'         END OF TABLE?                                
         JE    *+2                   YES, DIE                                   
         CLC   ORXSTATS,XMSTA                                                   
         JNE   XMDA60                                                           
         CLI   ORXSTATF,0                                                       
         JE    XMDA70                                                           
         CLC   ORXSTATF,XMSTAF                                                  
         JE    XMDA70                                                           
*                                                                               
XMDA60   LA    R1,XMTTABLN(R1)                                                  
         J     XMDA50                                                           
XMDA70   ICM   RF,15,XMPROG                                                     
         A     RF,SRVRRELO                                                      
         BASR  RE,RF               GO TO XMIT ROUTINE                           
*                                                                               
         TM    XMFLAG,XMFUSPDL     UPDATE SPOTS AND DOLLARS?                    
         JZ    *+8                                                              
         BRAS  RE,UPDORD           UPDATE ORDER WITH BUY DETAILS                
*                                                                               
         TM    XMFLAG,XMFUEXTR     UPDATE EXTRA RECORD?                         
         JZ    *+8                                                              
         BRAS  RE,UPDEXTRA         UPDATE THE X'05' EXTRA RECORD                
         J     XMDA010                                                          
         DROP  R1                                                               
*                                                                               
XMITTAB  DS    0X                                                               
         DC    AL1(DSENT),AL1(0),X'C0',AL4(XMITSEND)                            
         DC    AL1(DSENT),AL1(DOSTCNCL),X'C0',AL4(XMITRNC)                      
         DC    AL1(DFXSENT),AL1(0),X'C0',AL4(XMITFAX)                           
         DC    AL1(DFXRSNT),AL1(0),X'40',AL4(XMITFAX)                           
         DC    AL1(QRECALL),AL1(0),X'40',AL4(XMITRNC)                           
         DC    AL1(QNODARE),AL1(0),X'40',AL4(XMITRNC)                           
         DC    X'FF'                                                            
*                                                                               
XMITTABD DSECT                     TABLE TO COVER XMIT TABLE                    
XMSTA    DS    C                                                                
XMSTAF   DS    C                   STATUS FLAG                                  
XMFLAG   DS    X                                                                
XMFUSPDL EQU   X'80'                                                            
XMFUEXTR EQU   X'40'                                                            
XMFGDAR  EQU   X'20'                                                            
XMPROG   DS    AL4                                                              
XMTTABLN EQU   *-XMITTABD                                                       
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* GET THE PRODUCT INFO                                                          
*                                                                               
*  ON EXIT  : PRDNM                PRODUCT NAME                                 
*             PR2NM                PIGGY NAME                                   
***********************************************************************         
*                                                                               
GTPRDINF NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY                                                         
         USING PRDRECD,R2                                                       
         MVC   PKEYAM,SVBAGM                                                    
         MVC   PKEYCLT,SVBCLT                                                   
         MVC   PKEYPRD,SVQPRD                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO7'                               
         JNE   *+2                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO7'                              
         JNE   *+2                                                              
         L     R2,AIO7                                                          
         MVC   PRDNM,PNAME                                                      
*                                                                               
         XC    PR2NM,PR2NM                                                      
         OC    SVQPR2,SVQPR2                                                    
         JZ    GPIXY                                                            
         LA    R2,IOKEY                                                         
         MVC   IOKEY,IOKEYSAV                                                   
         MVC   PKEYPRD,SVQPR2                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO7'                               
         JNE   *+2                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO7'                              
         JNE   *+2                                                              
         L     R2,AIO7                                                          
         MVC   PR2NM,PNAME                                                      
GPIXY    J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* SEND THE DARE ORDER EDI                                                       
***********************************************************************         
XMITSEND NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    EDIVALS(EDIVALEN),EDIVALS                                        
*                                                                               
         MVI   REPWIDTH,L'PW       SET WIDTH TO 198                             
         MVI   REPMAXL,255         SET MAXLINES TO 255                          
         MVI   REPPRNTN,1          SET NUMBER OF PRINT LINES                    
         MVC   REPSYSID,=C'T2'                                                  
         MVC   REPPRGID,=C'1E'                                                  
         GOTOR GOREPORT,DMCB,('REPAINI',0)                                      
*                                                                               
         MVC   REPDESC,=CL11'DARE ORDER'                                        
         MVC   REPSUBID,=C'DAR'                                                 
         MVI   REPCLASS,C'G'       CLASS G REPORT                               
*                                                                               
         BRAS  RE,GTDESTID                                                      
*                                                                               
*        CLI   SVMED,C'R'          WE DID THIS BECAUSE SOME TV STATIONS         
*        JNE   XMSE015              NO, NOT RADIO                               
*                                                                               
         GOTOR VGETDARE,DMCB,(C'U',0),SVDESTID,AIO8,A(IO8LQ),VDATAMGR           
         BNE   XMSE015             MUST BE SENDING TO STATION                   
*                                                                               
         L     RE,AIO8                                                          
         USING DAREPTD,RE                                                       
*****                                                                           
* GETDARE DEFECT VALIDATES A STATION RECEIVING ID AS A REP. SPEC-33738          
* (FUTURE FIX) - CHANGE GETDARE TO SUPPORT AND VALIDATE MEDIA PARAMETER         
* NOTE: GETDARE WILL STILL NEED TO DEAL WITH CASE WHERE MEDIA'S MATCH           
         CLC   DAPTMED,SVMED        (TEMP FIX) DOES MEDIA MATCH?                
         JNE   XMSE015               NO, NOT CORRECT REP                        
*****                                                                           
         MVC   SVREPCOD,DAPTCODE                                                
*                                                                               
         TM    DAPTFLG1,DPF1XMLR   X'08' XML REP?                               
         JZ    XMSE015                                                          
         OI    REPSTAT,X'02'       INVISIBLE/XML/REDI STATUS                    
         DROP  RE                                                               
*                                                                               
XMSE015  GOTOR GOREPORT,DMCB,('REPAOPN',0)                                      
*                                                                               
         MVC   PW+4(5),=C'*HDR*'   HEADER RECORD                                
         MVC   PW+9(14),=CL14'EDICT=*DDSDARA'                                   
         MVI   PW+34,C'W'          WIDE REPORT                                  
         MVI   PW+35,C'P'          /PAGE FOR EASYLINK AND SUPRESS TOP           
         MVC   PW+54+8(L'SVMED),SVMED        1ST 8 BYTES IS AGENCY              
         MVC   PW+54+8+L'SVMED(L'SVQCLT),SVQCLT                                 
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         LA    R2,PW                                                            
         USING EDICTD,R2                                                        
         MVC   EDIDDSID,=C'++DDS'                                               
         MVC   EDISYST,=C'DA'      DARE                                         
         MVC   EDIPROG,=C'ORD'     ORDER SEND                                   
         MVC   EDIIDEN,=C'TRN'     TRANSACTION DATA                             
*                                                                               
         MVC   EDIRDRAG,SVORIGID                                                
         MVC   EDIRDRST,SVQSTA                                                  
         MVC   EDIRDRMD,SVMED                                                   
         MVC   EDIRDRCL(L'SVQCLT),SVQCLT                                        
         MVC   EDIRDRP1(L'SVQPRD),SVQPRD                                        
         MVC   EDIRDRP2(L'SVQPR2),SVQPR2                                        
         MVC   EDIRDRES,SVQEST                                                  
         MVC   EDIRDRAN,SVQORDER                                                
         MVC   EDIRDRBY,SVQBYR                                                  
         MVC   EDIRDRSP,SALESPER                                                
         MVC   EDIRDRCN,DARECONT                                                
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         DROP  R2                                                               
*                                                                               
         XC    AGYNMRCS,AGYNMRCS   START COUNTING FROM HERE                     
*                                                                               
         LA    R2,PW                                                            
         USING PAGYHDRD,R2                                                      
         MVC   PAHDTID,=C'AGYHDR'     TRANSMISSION ID                           
*                                                                               
* FIND THE FIRST EDI SEND DATE                                                  
*                                                                               
         GOTOR GT1EDISD,DMCB,(C'I',0)  GET FIRST EDI SEND DATE                  
         JNE   XMSE020                                                          
         GOTOR VDATCON,DMCB,(8,FULL),(X'20',PAHDFSNT)                           
         GOTOR VDATCON,DMCB,(8,FULL),(0,EDIDATC)                                
*                                                                               
XMSE020  MVC   PAHDORDR,SVQORDER                                                
         MVI   PAHDVERS,C'1'                                                    
         MVC   PAHDFRID,SVORIGID                                                
*                                                                               
         MVC   PAHDTOID,SVDESTID                                                
         MVC   PAHDROUT,SVDRROUT                                                
*                                                                               
         XC    BUYLINS,BUYLINS     NO BUYLINES USED YET                         
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOBUYELQ     FIND BUYLINE ELEMENTS                        
         MVI   ELCDHI,DOBUYELQ     FIND BUYLINE ELEMENTS                        
XMSE030  BRAS  RE,NEXTEL                                                        
         JNE   XMSE035             NONE -OR- NO MORE                            
         USING DOBUYELD,R4                                                      
         SR    RF,RF                                                            
         LLC   RE,DOBUYSPT         GET THE BUYLINE NUMBER                       
         BCTR  RE,0                                                             
         SRDL  RE,3                                                             
         LA    RE,BUYLINS(RE)      RE=A(APPROPRIATE BYTE IN BUYLINS)            
         SRL   RF,5                                                             
         STCM  RF,8,BYTE           BYTE=BIT # FOR BUYLINE FROM LEFT             
*                                                                               
         LA    R0,X'80'                                                         
         LLC   R1,BYTE                                                          
         SRL   R0,0(R1)                                                         
         STC   R0,BYTE                                                          
         OC    0(L'BYTE,RE),BYTE                                                
         J     XMSE030                                                          
*                                                                               
XMSE035  L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOBY2ELQ     FIND BUYLINE ELEMENTS                        
         MVI   ELCDHI,DOBY2ELQ     FIND BUYLINE ELEMENTS                        
XMSE037  BRAS  RE,NEXTEL                                                        
         JNE   XMSE040             NONE -OR- NO MORE                            
         USING DOBY2ELD,R4                                                      
         SR    RF,RF                                                            
         LLH   RE,DOBY2SPT         GET THE BUYLINE NUMBER                       
         BCTR  RE,0                                                             
         SRDL  RE,3                                                             
         LA    RE,BUYLINS(RE)      RE=A(APPROPRIATE BYTE IN BUYLINS)            
         SRL   RF,5                                                             
         STCM  RF,8,BYTE           BYTE=BIT # FOR BUYLINE FROM LEFT             
*                                                                               
         LA    R0,X'80'                                                         
         LLC   R1,BYTE                                                          
         SRL   R0,0(R1)                                                         
         STC   R0,BYTE                                                          
         OC    0(L'BYTE,RE),BYTE                                                
         J     XMSE037                                                          
*                                                                               
XMSE040  L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID ELEMENT               
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOSPELD,R4                                                       
         CLI   DOSPREVN,0                                                       
         JE    XMSE050                                                          
         OI    MISCFLG1,MF1DRREV                                                
         EDIT  (B1,DOSPREVN),(3,PAHDREVN),FILL=0                                
*                                                                               
XMSE050  L     R4,AIO3                                                          
         MVI   ELCDLO,DOSTELQ      X'12' STATUS ELEMENT                         
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   XMSE051                                                          
         USING DOSTELD,R4                                                       
         GOTOR VDATCON,DMCB,(8,DOSTDATE),(X'20',PAHDDATE)                       
         GOTOR VHEXOUT,DMCB,DOSTTIME,PAHDTIME,L'DOXMTTIM,0                      
         J     XMSE054                                                          
*                                                                               
XMSE051  GOTOR VDATCON,DMCB,(5,0),(X'20',PAHDDATE)                              
         MVC   PAHDTIME,=C'0000'                                                
         DROP  R4                                                               
*                                                                               
XMSE054  MVC   PAHDQMED,SVMED                                                   
         MVC   PAHDQCLT(L'SVQCLT),SVQCLT                                        
         MVC   PAHDQSTA(L'SVQSTA),SVQSTA                                        
         MVC   PAHDQPRD(L'SVQPRD),SVQPRD                                        
         MVC   PAHDQPR2(L'SVQPR2),SVQPR2                                        
         OC    PAHDQPR2,SPACES                                                  
         MVC   PAHDQEST(L'SVQEST),SVQEST                                        
         MVC   PAHDESTS,ESTSTRT                                                 
         CLI   PAHDESTS,X'F9'                                                   
         JNH   XMSE055                                                          
         LLC   R1,PAHDESTS                                                      
         SHI   R1,10                                                            
         STC   R1,PAHDESTS                                                      
XMSE055  MVC   PAHDESTN,ESTEND                                                  
         CLI   PAHDESTN,X'F9'                                                   
         JNH   XMSE057                                                          
         LLC   R1,PAHDESTN                                                      
         SHI   R1,10                                                            
         STC   R1,PAHDESTN                                                      
XMSE057  TM    FLTRCFLG,FRFEXIST   USING FLIGHT RECS?                           
         JZ    XMSE060                                                          
***********************************************************************         
* THE X'20' IS TO ALLOW YEAR 2000 TO SHOW AS C'00' INSTEAD OF X'FAF0'           
***********************************************************************         
         GOTOR VDATCON,DMCB,(3,SVFLTSDT),(X'20',PAHDESTS)                       
         GOTOR VDATCON,DMCB,(3,SVFLTEDT),(X'20',PAHDESTN)                       
*                                                                               
XMSE060  L     R4,AIO3                                                          
         MVI   ELCDLO,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         MVI   ELCDHI,DOIDELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
         MVC   PAHDRPCN,DOIDCON                                                 
         DROP  R4                                                               
         CLC   PAHDRPCN,EZEROS                                                  
         JH    *+10                                                             
         MVC   PAHDRPCN,EZEROS     THEN '0' FOR NEW REP CONTRACT                
*                                                                               
         GOTOR VGETFACT,DMCB,0                                                  
         LA    R4,PAHDRTRN                                                      
         USING RTN2SNDR,R4                                                      
         MVC   RTNBUYER,SVQBYR     NEED THIS FOR DARE NOTIFICATIONS             
         L     R3,DMCB                                                          
         USING FACTSD,R3                                                        
         GOTOR VHEXOUT,DMCB,FASYSID,RTNSYSID,1,0                                
         DROP  R3                                                               
*                                                                               
*********                                                                       
* SPECIAL CODE FOR FACMEL                                                       
*********                                                                       
         CLC   RTNSYSID,=C'06'     ARE WE ON FACMEL?                            
         JNE   *+10                                                             
XMSE065  MVC   RTNSYSID,=C'01'     MAKE IT LOOK LIKE WE'RE ON FACTST            
*********                                                                       
* SPECIAL CODE FOR FACMEL                                                       
*********                                                                       
         MVC   RTNPWRCD,LP_AGY                                                  
         GOTOR VHEXOUT,DMCB,SVBAGM,RTNAGYMD,1,0                                 
*                                                                               
         MVC   RTNDDS,=C'D=Y'      THIS IS A DDS ORDER                          
         DROP  R4                                                               
                                                                                
         MVI   PAHDCTRD,C'C'       SET CASH OR TRADE INDICATOR                  
         TM    ESTFLAG1,ESTTRADE                                                
         JZ    *+8                                                              
         MVI   PAHDCTRD,C'T'       TRADE                                        
*                                                                               
         CLI   DRCSHTRD,TRDESREP   DOING TRADE?                                 
         JNE   *+8                                                              
         MVI   PAHDCTRD,C'T'       TRADE                                        
                                                                                
         MVI   PAHDSTYP,C'W'       DEFAULT IS WEEKLY SCHEDULE                   
         TM    ESTFLAG1,ESTDAILY   DAILY SCHEDULE?                              
         JZ    *+8                                                              
         MVI   PAHDSTYP,C'D'       YES                                          
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID ELEMENT               
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOSPELD,R4                                                       
         GOTOR VDATCON,DMCB,(0,ESTSTRT),(X'20',PAHDAIRD)                        
         OC    DOSPFAID,DOSPFAID   NO FIRST AIR DATE?                           
         JZ    XMSE070             NONE, SKIP IT                                
         GOTOR VDATCON,DMCB,(2,DOSPFAID),(X'20',PAHDAIRD)                       
*                                                                               
XMSE070  EDIT  (B1,SVOOWROT),(1,PAHDSDAY)     OUT-OF-WEEK ROTATOR               
*                                                                               
         LA    R1,DOSPFSTA                                                      
         BRAS  RE,GETQSTA                                                       
*                                                                               
XMSE080  MVC   PAHDFSTA,SVQSTA     SET EDITED STATION (IF ANY)                  
         DROP  R4                                                               
*                                                                               
* FOR RADIO ORDERS, AS DARE DISPATCHER IS BYPASSED, WE NEED TO                  
* READ DSTA TO GET THE CURRENT AND OLD STATIONS                                 
*                                                                               
         CLI   SVMED,C'R'          ONLY DO THIS FOR RADIO                       
         JNE   XMSE150                                                          
         GOTOR GETNEWST,DMCB,PAHDQSTA,PAHDOLDS                                  
*                                                                               
XMSE150  GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         XC    SALESCOD,SALESCOD   CLEAR THE SALESCOD                           
         BRAS  RE,PRTDESCS         PUT OUT THE AGENCY DESCRIPTIONS              
*                                                                               
*********                                                                       
* SEND SALESPERSON ASSIGNED TO THIS ORDER FOR CABLE                             
*********                                                                       
XMSL00   CLI   SVSTAEDT,C'0'       TEST CABLE                                   
         JL    XMBSC00                                                          
         CLC   SALESPER,SPACES     DO WE HAVE A SALESPERSON?                    
         BNH   XMBSC00                                                          
         LA    R2,PW                                                            
         USING PAGYSALD,R2                                                      
         MVC   PASLTID,=C'AGYSAL'                                               
         MVC   PASLORDR,SVQORDER                                                
         MVC   PASLNAME,SALESPER                                                
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*********                                                                       
*********                                                                       
* STANDARD COMMENT FROM BUYER     AIO7 HAS BUYER RECORD                         
*********                                                                       
XMBSC00  LA    R2,PW                                                            
         USING PAGYSTDD,R2                                                      
         XC    WORK,WORK                                                        
         L     R4,AIO7             AIO7 HAS BUYER RECORD                        
         MVI   ELCDLO,BYRCMCDQ     X'15' - COMMENT ELEMENT                      
         MVI   ELCDHI,BYRCMCDQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   XMBSCX                                                           
         USING BYRCMTD,R4                                                       
         MVC   WORK(L'BYRSCMNT),BYRSCMNT                                        
         DROP  R4                                                               
XMBSCX   DS    0H                                                               
*********                                                                       
* STANDARD COMMENTS                                                             
*********                                                                       
XMSTC00  L     R4,AIO3                                                          
         MVI   ELCDLO,DOIDELQ      X'01' PRIMARY ID ELEMENT                     
         MVI   ELCDHI,DOIDELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOIDELD,R4                                                       
         MVC   WORK+L'BYRSCMNT(L'DOISCOM1*3),DOISCOM1                           
         DROP  R4                                                               
*                                                                               
         LA    R3,WORK                                                          
XMSTC10  LA    R0,WORK+L'DOISCOM1*4                                             
         CR    R3,R0                                                            
         JNL   XMSTCX                                                           
         CLC   0(L'DOISCOM1,R3),SPACES                                          
         JNH   XMSTC55                                                          
*                                                                               
XMSTC15  LA    R4,IOKEY            LOOK UP THE STANDARD COMMENT                 
         USING COMKEY,R4                                                        
         XC    COMKEY,COMKEY                                                    
         MVI   COMKTYP,COMKTYPQ                                                 
         MVI   COMKSUB,COMKSUBQ                                                 
         MVC   COMKAM,SVBAGM                                                    
         MVC   COMKCOM,0(R3)                                                    
         OC    COMKCOM,SPACES                                                   
         DROP  R4                                                               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         JNE   XMSTC55                                                          
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO6'                              
         JNE   *+2                                                              
*                                                                               
         L     R4,AIO6                                                          
         MVI   ELCDLO,COMTXTEQ                                                  
         MVI   ELCDHI,COMTXTEQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   XMSTC20                                                          
         USING COMTXTD,R4                                                       
         MVI   BYTE,1              CURRENT LINE NUMBER OF RECORD                
*                                                                               
XMSTC20  CLC   PW(L'SPACES),SPACES         A LINE TO PRINT FROM BEFORE?         
         JNH   XMSTC30                                                          
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
XMSTC30  MVC   PASTTID,=C'AGYSTD'     TRANSMISSION ID                           
*                                                                               
         MVC   PASTORDR,SVQORDER                                                
         MVI   PASTCONT,C'*'       MORE LINES FOLLOW                            
         CLC   BYTE,COMTXTSQ       MAKE SURE WE GET THE RIGHT LINE              
         JE    XMSTC40                                                          
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         LLC   R1,BYTE                                                          
         AHI   R1,1                                                             
         STC   R1,BYTE                                                          
         J     XMSTC30                                                          
*                                                                               
XMSTC40  LLC   R1,COMTXTLN                                                      
         SH    R1,=Y(COMTXTOV+1)                                                
         MVC   PASTTEXT(0),COMTXTTX                                             
         EX    R1,*-6                                                           
         LLC   R1,BYTE                                                          
         AHI   R1,1                                                             
         STC   R1,BYTE                                                          
*                                                                               
         BRAS  RE,NEXTEL                                                        
         JE    XMSTC20             MORE LINES FOLLOW                            
***************                                                                 
*  DONE WITH THIS STANDARD COMMENT                                              
***************                                                                 
XMSTC55  LA    R3,L'DOISCOM1(R3)   CHECK IF ANY MORE STANDARD COMMENTS          
         J     XMSTC10                                                          
*                                                                               
XMSTCX   DS    0H                                                               
         DROP  R4                                                               
***************                                                                 
*  ANY OCOM RECORDS?                                                            
***************                                                                 
XMOCM00  LA    R2,PW                                                            
         USING PAGYSTDD,R2                                                      
         XC    IOKEY,IOKEY                                                      
         LA    R3,IOKEY                                                         
         USING OM$COMKEY,R3                                                     
         MVC   OM$COMKTYPE,=X'0D0C'   OCOM TYPE                                 
         MVC   OM$COMKAGY,SVBAGM                                                
         MVI   OM$COMCTYPE,C'O'       OCOM RECORDS                              
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         JNE   XMOCM05                                                          
         BRAS  RE,PRNTOCOM                                                      
*                                                                               
XMOCM05  MVC   IOKEY,IOKEYSAV                                                   
         MVC   OM$COMKCLT,SVBCLT                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         JNE   XMOCM10                                                          
         BRAS  RE,PRNTOCOM                                                      
*                                                                               
XMOCM10  MVC   IOKEY,IOKEYSAV                                                   
         MVC   OM$COMKPRD+2(1),SVBPRD                                           
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         JNE   XMOCM20                                                          
         BRAS  RE,PRNTOCOM                                                      
*                                                                               
XMOCM20  MVC   IOKEY,IOKEYSAV                                                   
         MVC   OM$COMKEST,SVBEST                                                
         MVC   OM$COMKFLT,SVBFLT                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         JE    XMOCM40                                                          
*                                                                               
         CLI   SVBFLT,0            ANY FLIGHT NUMBER?                           
         JE    XMOCM30             NONE, LOOK UNDER THE 'ALL' PRODUCT           
         MVC   IOKEY,IOKEYSAV      YES, MAYBE ONLY THE ESTIMATE LEVEL           
         MVI   OM$COMKFLT,0                                                     
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         JE    XMOCM40                                                          
*                                                                               
XMOCM30  MVC   IOKEY,IOKEYSAV                                                   
         MVC   OM$COMKPRD,=C'ALL'  TRY WITH PRODUCT  'ALL'                      
         MVC   OM$COMKFLT,SVBFLT   AND THE FLIGHT AGAIN                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         JE    XMOCM40                                                          
*                                                                               
         CLI   SVBFLT,0            ANY FLIGHT NUMBER?                           
         JE    XMOCM60             NONE, NOTHING FOR ESTIMATE OR FLIGHT         
         MVC   IOKEY,IOKEYSAV      YES, MAYBE ONLY THE ESTIMATE LEVEL           
         MVI   OM$COMKFLT,0                                                     
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         JNE   XMOCM60                                                          
*                                                                               
XMOCM40  BRAS  RE,PRNTOCOM                                                      
         DROP  R3                                                               
***************                                                                 
* DONE WITH OCOM RECORDS                                                        
***************                                                                 
XMOCM60  CLC   PW(L'SPACES),SPACES         A LINE TO PRINT FROM BEFORE?         
         JNH   XMOCMX                                                           
         MVI   PASTCONT,C' '       YES                                          
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
XMOCMX   DS    0H                                                               
         DROP  R2                                                               
*                                                                               
*********                                                                       
* BUYER FREE-FORM COMMENTS         AIO4 STILL HAS BUYER RECORD                  
*********                                                                       
XMBFF00  LA    R2,PW                                                            
         USING PAGYCOMD,R2                                                      
         L     R4,AIO7                                                          
         MVI   ELCDLO,BYRCMCDQ        X'15' - COMMENT ELEMENT                   
         MVI   ELCDHI,BYRCMCDQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   XMBFFX                                                           
*                                                                               
         USING BYRCMTD,R4                                                       
         CLC   BYROCMT1,SPACES                                                  
         JNH   XMBFF30                                                          
         MVC   PACMTID,=C'AGYCOM'     TRANSMISSION ID                           
*                                                                               
         MVC   PACMORDR,SVQORDER                                                
         MVI   PACMCONT,C'*'       MORE LINES FOLLOW                            
         MVC   PACMTEXT(L'BYROCMT1),BYROCMT1                                    
*                                                                               
XMBFF30  CLC   BYROCMT2,SPACES                                                  
         JNH   XMBFFX                                                           
*                                                                               
         CLC   PW(L'SPACES),SPACES         A LINE TO PRINT FROM BEFORE?         
         JNH   XMBFF40                                                          
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
XMBFF40  MVC   PACMTID,=C'AGYCOM'     TRANSMISSION ID                           
         MVC   PACMORDR,SVQORDER                                                
         MVI   PACMCONT,C'*'       MORE LINES FOLLOW                            
         MVC   PACMTEXT(L'BYROCMT2),BYROCMT2                                    
*                                                                               
XMBFFX   DS    0H                                                               
         DROP  R4                                                               
*                                                                               
*********                                                                       
* AGENCY COMMENT                                                                
*********                                                                       
XMAGC00  LA    R3,IOKEY            LOOK UP THE ORDER COMMENT                    
         USING DOKEY,R3                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   DOKTYPE,DOKTYPQ                                                  
         MVI   DOKSUBTY,DOKSTYPQ                                                
         MVC   DOKAGMD,SVBAGM                                                   
         MVC   DOKORDER,BINORDER                                                
         MVC   DOKSTA,SVBSTA                                                    
         MVI   DOKCMT,DOKCAGCQ     X'01' - DARE AGY COMMENT RECORD              
         DROP  R3                                                               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO4'                               
         JNE   XMAGC40                                                          
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO4'                              
         JNE   *+2                                                              
*                                                                               
         L     R4,AIO4                                                          
         MVI   ELCDLO,DOCOMELQ     X'30' DARE COMMENT ELEMENT                   
         MVI   ELCDHI,DOCOMELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   XMAGC40                                                          
         MVI   BYTE,1              CURRENT LINE NUMBER OF RECORD                
*                                                                               
         CLC   PW(L'SPACES),SPACES         A LINE TO PRINT FROM BEFORE?         
         JNH   XMAGC10                                                          
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         USING DOCOMELD,R4                                                      
XMAGC10  LA    R2,PW                                                            
         USING PAGYCOMD,R2                                                      
*                                                                               
XMAGC20  MVC   PACMTID,=C'AGYCOM'     TRANSMISSION ID                           
         MVC   PACMORDR,SVQORDER                                                
         MVI   PACMCONT,C'*'       MORE LINES FOLLOW                            
         CLC   BYTE,DOCOMLIN       MAKE SURE WE GET THE RIGHT LINE              
         JE    XMAGC30                                                          
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         LLC   R1,BYTE                                                          
         AHI   R1,1                                                             
         STC   R1,BYTE                                                          
         J     XMAGC20                                                          
*                                                                               
XMAGC30  LLC   R1,DOCOMLEN                                                      
         SH    R1,=Y(DOCOMOVH+1)                                                
         MVC   PACMTEXT(0),DOCOMTXT                                             
         EX    R1,*-6                                                           
*                                                                               
         BRAS  RE,NEXTEL                                                        
         JE    XMAGC10                                                          
*                                                                               
XMAGC40  CLC   PW(L'SPACES),SPACES         A LINE TO PRINT FROM BEFORE?         
         JNH   XMAGCX                                                           
         MVI   PACMCONT,C' '            NO MORE ORDER COMMENTS                  
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
XMAGCX   DS    0H                                                               
         DROP  R2,R4                                                            
*                                                                               
*********                                                                       
* DO THE AGENCY HIATUS WEEKS                                                    
*********                                                                       
XMHIATUS CLI   SVBPRD,X'FF'        POL ORDERS DON'T HAVE HIATUS WEEKS           
         JE    XMHIATX                                                          
         L     RF,ACLTREC          R4 = A(CLIENT RECORD)                        
         USING CLTRECD,RF                                                       
         CLI   CEXTRA+8,C'Y'       GOAL REQD FOR BUY?                           
         JNE   XMHIATX             NO, DON'T BOTHER WITH HIATUS WEEKS           
         CLC   =C'WI',LP_AGY       WESTERN?                                     
         JE    XMHIATX             YES, DON'T SHOW HIATUS WEEKS                 
         BRAS  RE,PRTHIATS                                                      
XMHIATX  DS    0H                                                               
         DROP  RF                                                               
*                                                                               
***************                                                                 
* DO THE BUYS NOW                                                               
***************                                                                 
*                                                                               
         XC    AGYNSPTS,AGYNSPTS   CLEAR AGENCY TOTAL AMOUNTS                   
         ZAP   AGYDOLRS,=P'0'                                                   
*                                                                               
         BRAS  RE,PRTBUYS                                                       
*                                                                               
         LA    R2,PW                                                            
         MVC   0(26,R2),=CL26'*** END OF DDS MESSAGE ***'                       
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         GOTOR GOREPORT,DMCB,('REPACLO',0)                                      
XMSEXY   J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* FIND THE FIRST EDI SEND DATE                                                  
* ON ENTRY:  P1-BT0   0 == FIRST SEND DATE                                      
*         :           C'I' == FIRST EDI SEND DATE                               
*         :  AIO3     A(DARE ORDER RECORD)                                      
*                                                                               
* ON EXIT :  FULL     CC=EQ - FIRST (EDI) SEND JULIAN DATE X'CYYDDD'            
*                     CC=NE - NULL                                              
*                                                                               
***********************************************************************         
GT1EDISD NTR1  BASE=*,LABEL=*                                                   
         MVC   BYTE,0(R1)          SAVE OPTION                                  
*                                                                               
         XC    FULL,FULL                                                        
         SR    R5,R5                                                            
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSTELQ      X'12' - TRANSMISSION ELEMENT                 
         MVI   ELCDHI,DOSTELQ                                                   
G1ESD010 BRAS  RE,NEXTEL                                                        
         JNE   G1ESD050                                                         
         USING DOSTELD,R4                                                       
*                                                                               
         CLI   BYTE,C'I'           GET FIRST EDI SEND DATE?                     
         BNE   G1ESD020            NO, R5 IS ALWAYS NULL                        
*                                                                               
         CLI   DOSTSTAT,DDLVRD                                                  
         JNE   G1ESD020                                                         
         LR    R5,R4               R5 = A(PREV DLVD DOSTELEM)                   
         J     G1ESD010                                                         
*                                                                               
G1ESD020 CLI   DOSTSTAT,DSENT      WAS IT SENT&DLVD EDI?                        
         JNE   G1ESD040            - NO                                         
         LTR   R5,R5               WANT FIRST EDI? PREV STATUS DLVD?            
         JZ    G1ESD030             NO, GET FIRST SEND DATE                     
N        USING DOSTELD,R5                                                       
         CLI   N.DOSTLEN,DOSTLNQ6  PREV STATUS OE OR REDI DLVD?                 
         JNE   G1ESD030             NO, ASSUME TV DARE, GO SAVE DATE            
         CLC   N.DOSTDRPP,=C'EMAIL'  DON'T SAVE IF IT WAS OE SENT               
         JE    G1ESD040                                                         
G1ESD030 MVC   FULL(3),DOSTDATE    - YES, SAVE THE DATE                         
G1ESD040 SR    R5,R5                                                            
         J     G1ESD010                                                         
         DROP  R4,N                                                             
*                                                                               
G1ESD050 OC    FULL(3),FULL        HAVE FIRST EDI SEND DATE?                    
         JZ    EXITN                                                            
         J     EXITY                                                            
***********************************************************************         
* RETRIEVES THE PRINT QUEUE ENTRY                                               
***********************************************************************         
RETRVREP NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R3,IOKEY            SET INDEX FOR REPORT                         
         USING UKRECD,R3                                                        
         MVC   UKSRCID,REPUSRID    USER ID CODE                                 
         MVC   UKSUBID,REPSUBID    SUBID                                        
         MVC   UKREPNO,REPREPNO    REPORT NUMBER                                
*                                                                               
         L     RE,REPAPQB          ADDRESS OF PRINTQ BUFFER                     
         ST    RE,DMCB+16                                                       
         GOTOR VDATAMGR,DMCB,(0,=C'GFILE'),=C'PRTQUE',IOKEY,PW                  
         CLI   8(R1),0                                                          
         JNE   *+2                 BAD GFILE CALL                               
*                                                                               
         L     RE,REPAPQB          ADDRESS OF PRINTQ BUFFER                     
         ST    RE,DMCB+16                                                       
         GOTOR VDATAMGR,DMCB,(0,=C'INDEX'),UKUSRINF,IOKEY,PW                    
         CLI   8(R1),0                                                          
         J     EXITCC                                                           
         DROP  R3                                                               
         EJECT                                                                  
*&&DO                                                                           
***********************************************************************         
* RETRIEVES LINES OF REPORT AND MOVES IT MQ VIA THE TSAR BUFFER                 
* AND THEN PURGES THE PQ REPORT                                                 
***********************************************************************         
MOVEXML  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R4,IOKEY            SET INDEX FOR REPORT                         
         USING UKRECD,R4                                                        
         MVI   LINENUM,0           NO LINES READ YET                            
         L     R3,AMINBUFF         PUT MSG TO TSAR BUFFER                       
         SAM31 ,                                                                
         MVC   0(16,R3),=CL16'RADIOEDIXML*****'                                 
         LA    R3,16(R3)                                                        
*                                                                               
MXML001  SAM24 ,                                                                
         XC    PW,PW                                                            
         L     RE,REPAPQB                                                       
         ST    RE,DMCB+16                                                       
         GOTOR VDATAMGR,DMCB,(0,=C'READ'),UKUSRINF,0,PW,,0                      
         CLI   DMCB+8,0            END OF PQ CONTROL INTERVAL?                  
         JNE   MXML010             YES - FINISHED - CHECK OUTPUT                
*                                                                               
         LA    R2,DARENTRY                                                      
MXML005  CLI   0(R2),X'FF'                                                      
         JE    MXML001                                                          
         CLC   PW+1(6),0(R2)                                                    
         JE    MXML008                                                          
         LA    R2,8(R2)                                                         
         J     MXML005                                                          
*                                                                               
MXML008  SAM31 ,                                                                
         MVC   0(L'PW,R3),PW+1                                                  
         OC    0(L'SPACES,R3),SPACES                                            
         OC    L'SPACES(L'PW-L'SPACES,R3),SPACES                                
         AH    R3,6(R2)                                                         
         MVC   0(2,R3),=X'0D25'                                                 
         LA    R3,2(R3)                                                         
         J     MXML001                                                          
*                                                                               
MXML010  SAM31 ,                                                                
         AHI   R3,-2               REMOVE LAST X'0D25'                          
         L     R2,AMINBUFF                                                      
         SR    R3,R2                                                            
         L     RF,ACOMFACS                                                      
         L     RF,ACOMFACS                                                      
         L     RF,CMQIO-COMFACSD(RF)                                            
         GOTOR (RF),DMCB,=CL8'PUT',AMINBUFF,(R3),0,0,DUB                        
*                                                                               
MXML020  SAM24 ,                                                                
         L     RE,REPAPQB                                                       
         ST    RE,DMCB+16                                                       
         GOTOR VDATAMGR,DMCB,(0,=C'PURGE'),UKUSRINF,IOKEY                       
         CLI   DMCB+8,0            IS IT 'PURGED'?                              
         JNE   *+2                  NO, DIE                                     
*                                                                               
MXML030  J     EXITY                                                            
         DROP  R4                                                               
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* SEND THE RECALL/NOTDARE/CANCEL                                                
***********************************************************************         
XMITRNC  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVI   REPWIDTH,L'PW SET WIDTH TO 198                                   
         MVI   REPMAXL,255         SET MAXLINES TO 255                          
         MVI   REPPRNTN,1          SET NUMBER OF PRINT LINES                    
         MVC   REPSYSID,=C'T2'                                                  
         MVC   REPPRGID,=C'1E'                                                  
         GOTOR GOREPORT,DMCB,('REPAINI',0)                                      
*                                                                               
         CLI   ORXSTATS,QNODARE    NOTDARE?                                     
         JE    XMRN030             YES, DON'T SKIP IT                           
*                                                                               
         CLI   ORXSTATS,DSENT      CANCEL?                                      
         JNE   *+10                                                             
         MVC   REPDESC,=CL11'CANCEL'                                            
         CLI   ORXSTATS,QRECALL    RECALL?                                      
         JNE   *+10                                                             
         MVC   REPDESC,=CL11'RECALL'                                            
*                                                                               
         BRAS  RE,GTDESTID                                                      
*                                                                               
         CLI   SVMED,C'R'                                                       
         JNE   XMRN030                                                          
*                                                                               
         GOTOR VGETDARE,DMCB,(C'U',0),SVDESTID,AIO8,A(IO8LQ),VDATAMGR           
         BNE   XMRN030             MUST BE SENDING TO STATION                   
*                                                                               
         L     RE,AIO8                                                          
         USING DAREPTD,RE                                                       
         TM    DAPTFLG1,DPF1XMLR   X'08' XML REP?                               
         JZ    XMRN030                                                          
         OI    REPSTAT,X'02'       INVISIBLE/XML/REDI STATUS                    
         DROP  RE                                                               
*                                                                               
XMRN030  CLI   ORXSTATS,QNODARE                                                 
         JNE   *+10                                                             
         MVC   REPDESC,=CL11'NOTDARE'                                           
         MVC   REPSUBID,=C'DAR'                                                 
*                                                                               
         MVI   REPCLASS,C'G'       CLASS G REPORT                               
         GOTOR GOREPORT,DMCB,('REPAOPN',0)                                      
*                                                                               
         MVC   PW+4(5),=C'*HDR*'            HEADER RECORD                       
         MVC   PW+9(14),=CL14'EDICT=*DDSDARA'                                   
         MVI   PW+34,C'W'                   WIDE REPORT                         
         MVI   PW+35,C'P'            /PAGE FOR EASYLINK AND SUPRESS TOP         
         MVC   PW+54+8(L'SVMED),SVMED        1ST 8 BYTES IS AGENCY              
         MVC   PW+54+8+L'SVMED(L'SVQCLT),SVQCLT                                 
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         LA    R3,PW                                                            
         USING EDICTD,R3                                                        
         MVC   EDIDDSID,=C'++DDS'                                               
         MVC   EDISYST,=C'DA'      DARE                                         
         MVC   EDIPROG,=C'RCL'     RECALL                                       
         CLI   ORXSTATS,QNODARE                                                 
         JNE   *+10                                                             
         MVC   EDIPROG,=C'NOT'     NOTDARE                                      
         MVC   EDIIDEN,=C'TRN'     TRANSACTION DATA                             
*                                                                               
         MVC   EDIRDRAG,SVORIGID                                                
         MVC   EDIRDRST,SVQSTA                                                  
         MVC   EDIRDRMD,SVMED                                                   
         MVC   EDIRDRCL(L'SVQCLT),SVQCLT                                        
         MVC   EDIRDRP1(L'SVQPRD),SVQPRD                                        
         MVC   EDIRDRP2(L'SVQPR2),SVQPR2                                        
         MVC   EDIRDRES,SVQEST                                                  
         MVC   EDIRDRAN,SVQORDER                                                
         MVC   EDIRDRBY,SVQBYR                                                  
         MVC   EDIRDRSP,SALESPER                                                
         MVC   EDIRDRCN,DARECONT                                                
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         DROP  R3                                                               
*                                                                               
* PAGYCAN AND PAGYRCL HAVE SIMILAR LAYOUT                                       
         USING PAGYRCLD,R2                                                      
         LA    R2,PW                                                            
         MVC   PARCTID,=C'AGYRCL'  ORDER RECALL (AGYRCL)                        
         CLI   ORXSTATS,QRECALL                                                 
         JE    *+10                                                             
         MVC   PARCTID,=C'AGYCAN'  NOTDARE/CANCEL (AGYCAN)                      
         MVC   PARCORDR,SVQORDER                                                
         MVC   PARCFRID,SVORIGID                                                
         MVC   PARCRPCN,DARECONT                                                
*                                                                               
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSTELQ      X'12' STATUS ELEMENT                         
         MVI   ELCDHI,DOSTELQ                                                   
XMRN035  BRAS  RE,NEXTEL                                                        
         JNE   *+2                 DIE CUZ WE DON'T HAVE DELNOT                 
         USING DOSTELD,R4                                                       
         CLI   DOSTSTAT,DDLVRD                                                  
         JNE   XMRN035                                                          
         CLI   DOSTLEN,DOSTLNQ6                                                 
         JNE   XMRN050                                                          
         MVC   PARCTOID(L'DOSTDRPP),DOSTDRPP                                    
         LA    RF,PARCTOID+L'PARCTOID-1                                         
XMRN040  CLI   0(RF),C' '                                                       
         JH    *+8                                                              
         JCT   RF,XMRN040                                                       
         MVC   1(L'DOSTDRPO,RF),DOSTDRPO                                        
         J     XMRN060                                                          
*                                                                               
XMRN050  GOTOR GTUSERID,DMCB,DOSTIDNM,PARCTOID                                  
         DROP  R4                                                               
*                                                                               
XMRN060  MVC   PARCROUT,SVDRROUT                                                
***********************************************************************         
* THE X'20' IS TO ALLOW YEAR 2000 TO SHOW AS C'00' INSTEAD OF X'FAF0'           
***********************************************************************         
         GOTOR VDATCON,DMCB,(5,0),(X'20',PARCDATE)                              
*                                                                               
         THMS  DDSTIME=YES                                                      
         STCM  R0,15,PACKOF4B                                                   
         ST    R1,FULL                                                          
         AP    PACKOF4B,FULL                                                    
*                                                                               
         CP    PACKOF4B,=P'240000'     PAST MIDNIGHT?                           
         JL    XMRN070                                                          
         SP    PACKOF4B,=P'240000'     YES, BUMP TO NEXT DAY AND ADJUST         
         GOTOR VADDAY,DMCB,PARCDATE,(X'20',PARCDATE),F'1'                       
*                                                                               
XMRN070  ICM   R1,15,PACKOF4B                                                   
         SRL   R1,12               GET RID OF SECONDS AND SIGN                  
         STH   R1,HALF                                                          
         GOTOR VHEXOUT,DMCB,HALF,PARCTIME,L'HALF,0                              
*                                                                               
         MVC   PARCQSTA(L'SVQSTA),SVQSTA                                        
*                                                                               
* THIS CODE WAS ORIGINALLY FOR OLD RADIO DARE WHICH IS NOW DEFUNCT              
* BUT I'M REUSING IT TO GET THE FIRST EDI SEND DATE TO FIX TV DARE              
*                                                       -HWON 4/14/2017         
***NOP   CLI   SVMED,C'R'          ONLY DO THIS FOR RADIO                       
***NOP   JNE   XMRN110                                                          
         GOTOR GT1EDISD,DMCB,(C'I',0)  GET FIRST EDI SEND DATE                  
         JNE   *+2                 RECALLING IF NEVER SENT??? DIE!!!!           
         GOTOR VDATCON,DMCB,(8,FULL),(0,EDIDATC)                                
*********                                                                       
* HERE IS WHERE PAGYRCLD AND PAGYCAND DIFFER                                    
*                                                                               
         LA    RF,PACNFSNT-PAGYCAND(R2)                                         
         CLI   ORXSTATS,QRECALL                                                 
         JNE   *+8                                                              
         LA    RF,PARCFSNT-PAGYRCLD(R2)                                         
         GOTOR VDATCON,DMCB,(8,FULL),(X'20',(RF))                               
*                                                                               
         L     R4,AIO3                                                          
         LA    R4,DORFRST-DOKEY(R4)                                             
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID                       
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
         LA    R1,DOSPFSTA-DOSPELD(R4)                                          
         BRAS  RE,GETQSTA                                                       
*                                                                               
* HERE IS WHERE PAGYRCLD AND PAGYCAND DIFFER                                    
*********                                                                       
XMRN100  LA    RF,PACNFSTA-PAGYCAND(R2)                                         
         CLI   ORXSTATS,QRECALL                                                 
         JNE   *+8                                                              
         LA    RF,PARCFSTA-PAGYRCLD(R2)                                         
         MVC   0(L'PACNFSTA,RF),SVQSTA                                          
*                                                                               
* FOR RADIO ORDERS, AS DARE DISPATCHER IS BYPASSED, WE NEED TO                  
* READ DSTA TO GET THE CURRENT AND OLD STATIONS                                 
*                                                                               
         CLI   STAPMED,C'R'        TEST RADIO                                   
         JNE   XMRN110                                                          
         TM    REPSTAT,X'02'       INVISIBLE/XML STATUS/REDI                    
         JZ    XMRN110                                                          
         GOTOR GETNEWST,DMCB,PARCQSTA,PARCOLDS                                  
*                                                                               
XMRN110  GOTOR VGETFACT,DMCB,0     SETUP 'RETURN TO SENDER' DATA                
         LA    R3,PARCRTRN                                                      
         USING RTN2SNDR,R3                                                      
         MVC   RTNBUYER,SVQBYR     NEED THIS FOR DARE NOTIFICATIONS             
         L     R4,DMCB                                                          
         USING FACTSD,R4                                                        
         GOTOR VHEXOUT,DMCB,FASYSID,RTNSYSID,1,0                                
         DROP  R4                                                               
*********                                                                       
* SPECIAL CODE FOR FACMEL                                                       
*********                                                                       
         CLC   RTNSYSID,=C'06'     ARE WE ON FACMEL?                            
         JNE   *+10                                                             
         MVC   RTNSYSID,=C'01'     MAKE IT LOOK LIKE WE'RE ON FACTST            
*********                                                                       
* SPECIAL CODE FOR FACMEL                                                       
*********                                                                       
         MVC   RTNPWRCD,LP_AGY                                                  
         GOTOR VHEXOUT,DMCB,SVBAGM,RTNAGYMD,1,0                                 
         DROP  R3                                                               
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         TM    REPSTAT,X'02'       INVISIBLE/XML STATUS/REDI                    
         JZ    XMRN200             NO, DON'T NEED TO SEND THIS                  
         XC    SALESCOD,SALESCOD                                                
         BRAS  RE,CHKRPSAL                                                      
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGENFIL+IO6'                           
*                                                                               
         LA    R2,PW                                                            
         USING PAGYXM1D,R2                                                      
         MVC   PAX1TID,=C'AGYXM1'     TRANSMISSION ID                           
         MVC   PAX1ORDR,SVQORDER                                                
*                                                                               
         CLC   REPHUBAD,=CL10'DDSXMLNY'                                         
         JE    XMRN120                                                          
*                                                                               
         L     R4,AIO6                                                          
         MVI   ELCDLO,X'02'        X'02'  NEW INFO ELEMENT                      
         MVI   ELCDHI,X'02'                                                     
         MVI   DATADISP+1,GSPLFRST                                              
         BRAS  RE,GETEL                                                         
         JE    XMRN130                                                          
         NOP   XMRN160                                                          
XMRN120  MVC   PAX1COMN(10),=C'CHRISTAL'                                        
         MVC   PAX1COMC,=CL5'00052'                                             
         MVC   PAX1OFFN(8),=C'NEW YORK'                                         
         MVC   PAX1OFFC,=CL5'00024'                                             
         MVC   PAX1OFFM,=CL5'00101'                                             
         MVC   PAX1FIRN(4),=C'JODY'                                             
         MVC   PAX1LASN(5),=C'SPORN'                                            
         MVC   PAX1SALC,=C'00001'                                               
         MVC   PAX1HUB,=CL10'DDSXMLNY'                                          
         J     XMRN150                                                          
*                                                                               
         USING GSPLNFCD,R4                                                      
XMRN130  MVC   PAX1COMN(L'GSPLNFCM),GSPLNFCM    COMPANY NAME                    
         EDIT  GSPLNFCC,PAX1COMC,FILL=0  COMPANY CODE                           
         MVC   PAX1FIRN(L'GSPLNFFR),GSPLNFFR  SALESPERSON FIRST NAME            
         MVC   PAX1LASN(L'GSPLNFLS),GSPLNFLS  SALESPERSON LAST NAME             
         EDIT  SALESCOD,PAX1SALC,FILL=0  SALESPERSON CODE                       
         MVC   PAX1HUB,REPHUBAD                                                 
*                                                                               
         LA    RF,SVDESTID+L'SVDESTID-1  LETS GET THE OFFICE                    
         CLI   0(RF),X'40'                                                      
         JH    *+10                                                             
         BCTR  RF,0                                                             
         J     *-10                                                             
         BCTR  RF,0                                                             
*                                                                               
         MVI   ELCDLO,X'03'        X'02'  NEW INFO ELEMENT                      
         MVI   ELCDHI,X'03'                                                     
XMRN140  BRAS  RE,NEXTEL                                                        
         JNE   XMRN150                                                          
         USING GSPLOFCD,R4                                                      
         CLC   GSPLOFDD,0(RF)                                                   
         JNE   XMRN140                                                          
         MVC   PAX1OFFN,GSPLOFON         SBS OFFICE NAME                        
         EDIT  GSPLOFOC,PAX1OFFC,FILL=0  SBS OFFICE CODE                        
         EDIT  GSPLOFMC,PAX1OFFM,FILL=0  NSI MARKET CODE                        
XMRN150  GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         DROP  R2,R4                                                            
*                                                                               
XMRN160  MVI   DATADISP+1,DORFRST-DOKEY                                         
         LA    R2,PW                                                            
         USING PAGYXM2D,R2                                                      
         MVC   PAX2TID,=C'AGYXM2'     TRANSMISSION ID                           
         MVC   PAX2ORDR,SVQORDER                                                
         MVC   PAX2COMN(L'REPUSRN),REPUSRN                                      
         MVC   PAX2AGID,SVDRROUT                                                
         MVC   PAX2OFFC(L'MKTTOFF),SVDRROUT+L'PAX2AGID                          
         BRAS  RE,GTMKTTAB                                                      
         USING MKTTABD,R3                                                       
XMRN170  CLI   MKTTNSI,X'FF'       END OF TABLE                                 
         JE    *+2                                                              
         CLC   MKTTOFF,PAX2OFFC                                                 
         JE    XMRN180                                                          
         LA    R3,MKTTABLN(R3)                                                  
         J     XMRN170                                                          
XMRN180  MVC   PAX2OFFN,MKTTNAME                                                
         EDIT  MKTTNSI,PAX2OFFM,FILL=0                                          
         DROP  R3                                                               
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID                       
         MVI   ELCDHI,DOSPELQ      X'03' SUPPLEMENTARY ID                       
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         USING DOSPELD,R4                                                       
         EDIT  DOSPVER#,PAX2VER#,FILL=0                                         
         DROP  R2,R4                                                            
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         LA    R2,PW               PRINT THE TRAILER                            
         USING PAGYTLRD,R2                                                      
         MVC   PATLTID,=C'AGYTLR'                                               
         MVC   PATLORDR,SVQORDER                                                
*                                                                               
         MVC   PATLSPTS,EZEROS                                                  
         MVC   PATLTOTL,EZEROS                                                  
         MVC   PATLNMRC,EZEROS                                                  
         MVI   AGYNMRCS+5,C'4'                                                  
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         DROP  R2                                                               
*                                                                               
XMRN200  MVC   PW(26),=CL26'*** END OF DDS MESSAGE ***'                         
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         GOTOR GOREPORT,DMCB,('REPACLO',0)                                      
*                                                                               
         L     RE,AIO8             CLEAR IO8 FOR UPDORD, O/W DUMP               
         LHI   RF,IO8LQ                                                         
         XCEFL                                                                  
*                                                                               
XMRNXY   J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* CHECK IF NEW STATION CALL LETTERS ARE IN EFFECT                               
* ON ENTRY:  SVQSTA            FIRST EDI SEND STATION (CHAR)                    
*         :  EDIDATC           FIRST EDI SEND DATE (CHAR)                       
*                                                                               
*  ON EXIT:  PARM1             MOST CURRENT CALL LETTERS                        
*            PARM2             OLD STATION IF CALL LETTER CHANGE                
*                                                                               
***********************************************************************         
GETNEWST NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(R1)           A(MOST CURRENT CALL LETTERS)                  
         L     R5,4(R1)           A(OLD STATION IF CALLER CHANGE)               
*                                                                               
         LA    R3,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         USING DSTAKEY,R3                                                       
         MVI   DSTAKEY,DSTAKSYSQ      X'005A'                                   
         MVI   DSTAKTYP,DSTAKTYPQ                                               
         MVC   DSTAKMEDA,SVMED                                                  
         MVC   DSTAKSTIN,SVQSTA                                                 
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGENDIR+IO7'                            
         JNE   *+2                                                              
*                                                                               
GTNS010  CLC   DSTAKEY(DSTAKEFDA-DSTAKEY),IOKEYSAV  STATION MATCH?              
         JNE   *+2                                                              
*                                                                               
         XR    RE,RE                                                            
         ICM   RE,7,DSTAKEFDA                                                   
         JZ    *+2                                                              
         LNR   RE,RE               DSTA DATES ARE NEGATED                       
         STCM  RE,7,FULL                                                        
         GOTO1 VDATCON,DMCB,(3,FULL),(0,EFDATEC)  CONVERT TO CHAR               
*                                                                               
         CLC   EFDATEC,TDYDTCHR    IS 1ST EDI STATION IN EFFECT?                
         JH    GTNS020              NO, READ THE NEXT ONE                       
         CLC   EFDATEC,EDIDATC     STAT'N EFF'TIVE WHEN ORDER 1ST SENT?         
         JNH   GTNS030              YES, USE CURRENT DSTA                       
*                                                                               
GTNS020  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IOGENDIR+IO7'                            
         JE    GTNS010              NO, NOT EFFECTIVE YET                       
         DC    H'0'                                                             
*                                                                               
GTNS030  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGENFIL+IO7'                           
         JNE   *+2                                                              
*                                                                               
         L     R4,AIO7                                                          
         AHI   R4,DSTAELDQ                                                      
         MVI   ELCDLO,DSTASTACQ    X'20' - NEW STATON ELEMENT                   
         MVI   ELCDHI,DSTASTACQ                                                 
         BRAS  RE,NEXTEL           FIND NEW STATION ELEMENT                     
         JNE   GTNS040                                                          
         USING DSTASTAD,R4                                                      
         GOTO1 VDATCON,DMCB,(6,DSTASTADT),(0,EFDATEC)  CONVERT TO CHAR          
         CLC   EFDATEC,TDYDTCHR    IS NEW STATION IN EFFECT?                    
         JH    GTNS040              NO, KEEP THIS                               
         MVC   0(L'DSTAKSTIN,R5),DSTAKSTIN   SEND AS THE OLD STATION            
         MVC   DSTAKSTIN,DSTASTA                                                
*                                                                               
         GOTO1 VDATCON,DMCB,(6,DSTASTADT),(3,DSTAKEFDA)                         
         ICM   RE,7,DSTAKEFDA                                                   
         LNR   RE,RE                                                            
         STCM  RE,7,DSTAKEFDA                                                   
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOGENDIR+IO7'                            
         JE    GTNS030                                                          
         DC    H'0'                                                             
*                                                                               
GTNS040  MVC   0(L'DSTAKSTIN,R2),DSTAKSTIN                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* SEND DARE FAX VIA DX REQUEST                                                  
***********************************************************************         
XMITFAX  NTR1  BASE=*,LABEL=*                                                   
         MVC   SVTSRNUM,TSRNUM                                                  
         GOTOR BUFFER,DMCB,('TSASAV',0)                                         
         JNE   *+2                                                              
*                                                                               
***********************************                                             
* CREATE THE REQUEST CARDS NOW AND USE WHAT WAS SAVED IN SVREVDAT               
* FOR SECOND REQUEST CARD                                                       
***********************************                                             
         L     R3,AIO7                                                          
         XC    0(80,R3),0(R3)                                                   
         USING SPOOK,R3                                                         
*                                                                               
         MVC   SPOOKUID,SVBORGID                                                
         MVC   SPOOKDES,SVBORGID                                                
         MVC   SPOOKAGY,LP_AGY                                                  
         MVC   SPOOKDID,=C'DFX'    DARE FAX                                     
         MVC   SPOOKSYS,=C'SP'                                                  
         MVC   SPOOKEOD,=C'DX'                                                  
         MVC   SPOOKJCL,=C'DX'                                                  
         MVI   SPOOKWEN,2          SOON                                         
         MVC   SPOOKRLD(3),=C'LD='                                              
         MVC   SPOOKRLD+3(2),=H'48'                                             
         MVC   SPOOKRLD+5(2),=H'24'                                             
         DROP  R3                                                               
*                                                                               
         MVI   SVRESEND,0                                                       
         CLI   ORXSTATS,DFXRSNT    FAX RESENDING?                               
         JNE   *+8                                                              
         MVI   SVRESEND,C'Y'       SET RESEND FLAG                              
*                                                                               
         XC    SVREVDAT,SVREVDAT                                                
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID ELEMENT               
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOSPELD,R4                                                       
         SR    R0,R0                                                            
         ICM   R0,1,DOSPFXRV       GET THE FAX REV#?                            
         STC   R0,SVCURREV                                                      
         JZ    *+8                 ZERO, FIRST TIME, SKIP                       
         AHI   R0,-1               DEC BY 1 TO GET PREVIOUS REV#                
         STC   R0,SVPREREV                                                      
*                                                                               
XMFX016  L     R4,AIO3                                                          
         MVI   ELCDLO,DOSTELQ      X'12' STATUS ELEMENT                         
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   XMFX024                                                          
XMFX021  BRAS  RE,NEXTEL           GET THE DATE OF THE PREVIOUS SEND            
         JNE   XMFX024                                                          
         USING DOSTELD,R4                                                       
         CLI   DOSTSTAT,DSENT                                                   
         JE    XMFX022                                                          
         CLI   DOSTSTAT,DFXSENT                                                 
         JE    XMFX022                                                          
         CLI   DOSTSTAT,DFXRSNT                                                 
         JNE   XMFX021                                                          
XMFX022  GOTOR VDATCON,DMCB,(8,DOSTDATE),(2,SVPRVDAT)                           
*                                                                               
XMFX024  GOTOR VGETFACT,DMCB,0     SETUP 'RETURN TO SENDER' DATA                
         L     RE,DMCB                                                          
         USING FACTSD,RE                                                        
         MVC   DUB(1),FASYSID      MOVE VALUE                                   
         MVC   DUB+1(1),SVBAGM                                                  
         DROP  RE                                                               
         GOTOR VHEXOUT,DMCB,DUB,SAVSYSID,1,0                                    
*********                                                                       
* SPECIAL CODE FOR FACMEL                                                       
*********                                                                       
         CLC   SAVSYSID,=C'06'     ARE WE ON FACMEL?                            
         JNE   *+10                                                             
XMFX025  MVC   SAVSYSID,=C'01'     MAKE IT LOOK LIKE WE'RE ON FACTST            
*********                                                                       
* SPECIAL CODE FOR FACMEL                                                       
*********                                                                       
         GOTOR (RF),(R1),DUB+1,SAVAGYMD,1                                       
*                                                                               
         GOTOR BUFFER,DMCB,('TSAINI',24),('BUYHKEYL',BUYHRECL),        X        
               ('TSRVAR',0)                                                     
         JNE   *+2                                                              
*                                                                               
         BRAS  RE,ESTF             DO ESTIMATE FIRST PROCESSING                 
*                                                                               
         BRAS  RE,READBUYS                                                      
*                                                                               
         MVI   COPYTYPE,C'X'       SET THIS IS FAX COPY                         
         CLI   PDXTOPQ,C'Y'        TEST TO PUT COPY TO PRTQUE                   
         JNE   *+8                                                              
         MVI   COPYTYPE,C'Q'       SET THIS IS PRTQUE COPY                      
*                                                                               
REOPEN   MVI   REPWIDTH,L'P1       SET WIDTH TO 132                             
         MVI   REPPRNTN,PNUM       SET NUMBER OF PRINT LINES                    
         MVI   REPMIDSN,MNUM       MIDLINES                                     
         MVI   REPHEADN,HNUM       HEADLINES                                    
         MVI   REPMAXL,64          SET MAXLINES TO 64                           
         MVC   REPSYSID,=C'T2'                                                  
         MVC   REPPRGID,=C'1E'                                                  
         GOTOR GOREPORT,DMCB,('REPAINI',0)                                      
*                                                                               
         MVC   REPDESC(3),=CL3'DF*'                                             
         MVC   REPDESC+3(8),SVQORDER                                            
         MVC   REPSUBID,=CL3'DFX'                                               
         MVI   REPCLASS,C'G'                                                    
         CLI   COPYTYPE,C'X'         TEST THIS IS FAX COPY                      
         JE    REOPEN10                                                         
         MVC   REPSUBID,SVQBYR       COPY GOES TO BUYER                         
         MVI   REPCLASS,C'H'                                                    
REOPEN10 GOTOR GOREPORT,DMCB,('REPAOPN',0)                                      
*                                                                               
         OI    REPIND2,REPISKP     SKIP SPEC PRINTING                           
         XC    REPAUSR,REPAUSR     SKIP HEADLINE PRINTING                       
         BRAS  RE,PRTCOVER                                                      
         NI    REPIND2,X'FF'-REPISKP                                            
*                                                                               
         MVC   REPPAGE,=H'1'                                                    
         BRAS  RE,PRFAX            PRINT REPORT                                 
*                                                                               
         GOTOR GOREPORT,DMCB,('REPACLO',0)                                      
*                                                                               
         CLI   COPYTYPE,C'X'       TEST THIS IS FAX COPY                        
         JE    XMFX030                                                          
         XC    REPBLK,REPBLK                                                    
         MVI   COPYTYPE,C'X'       SET FOR FAX COPY                             
         MVI   PASS,1              RESET                                        
         MVI   MIDPASS,0           RESET                                        
         J     REOPEN                                                           
*                                                                               
XMFX030  GOTOR BUFFER,DMCB,('TSARES',0)                                         
         JNE   *+2                                                              
*                                                                               
         MVC   TSRNUM,SVTSRNUM                                                  
         GOTOR BUFFER,DMCB,('TSAGET',0)                                         
         JNE   *+2                                                              
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* ESTIMATE FIRST PROCESSING - BUILD DATE TABLES                                 
***********************************************************************         
ESTF     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(3,TODAYB)                                    
*                                                                               
         MVI   SVPOL,C'N'                                                       
         XC    IOKEY,IOKEY         SEE IF THIS IS A POL ESTIMATE                
         MVC   IOKEY+1(1),SVBAGM                                                
         MVC   IOKEY+2(2),SVBCLT                                                
         MVC   IOKEY+4(3),=C'POL'                                               
         MVC   IOKEY+7(1),SVBEST                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         JE    *+14                                                             
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNZ   *+10                                                             
         DC    H'0'                                                             
         MVI   SVPOL,C'Y'                                                       
*                                                                               
         L     R4,AIO6                                                          
         XC    0(256,R4),0(R4)                                                  
         USING DBLOCKD,R4                                                       
*                                                                               
         MVC   DBSELAGY,LP_AGY                                                  
         MVC   DBSELMED,SVMED      SET MEDIA CODE IN DBLOCK                     
         MVC   DBFILE,=C'TP '                                                   
         MVC   DBCOMFCS,ACOMFACS                                                
         DROP  R4                                                               
* GET 6 CHARACTER DEMO NAMES                                                    
         MVC   SVDEMNMS,SPACES                                                  
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,NUMDEMS        HAVE DEMOS TO PRINT?                         
         JZ    ESTF8C              NO                                           
*                                                                               
         LA    R1,ESTDEMOS         COUNT ESTHDR DEMOS                           
ESTF8A   OC    0(L'EDEMLIS1,R1),0(R1)  TEST FOR NO DEMO                         
         JZ    ESTF8B                                                           
         AHI   R1,3                                                             
         JCT   R0,ESTF8A                                                        
*                                                                               
ESTF8B   LLH   R2,NUMDEMS                                                       
         SR    R2,R0               GIVES DEMOS PRESENT                          
         CH    R2,NUMDEMS          #DEMO PRESENT LT #DEMO TO PRINT              
         JH    *+8                 NO                                           
         STH   R2,NUMDEMS          YES, SET TO #DEMOS PRESENT                   
*                                                                               
         GOTOR VDEMOCON,DMCB,((R2),ESTDEMOS),(6,SVDEMNMS),             *        
               (C'S',(R4)),ESTUSNMS,ESTNTDEM                                    
                                                                                
*=================================================================              
* SET UP REPORT PERIODS                                                         
* BACK UP TO MONDAY START FOR WEEKLY ESTIMATE UNLESS OOWR                       
*=================================================================              
                                                                                
ESTF8C   MVC   SVQSTART(12),ESTSTRT                                             
         TM    FLTRCFLG,FRFEXIST   FLIGHT?                                      
         JZ    ESTF09                                                           
         GOTOR VDATCON,DMCB,(3,SVFLTSDT),(0,SVQSTART)                           
         GOTOR (RF),(R1),(3,SVFLTEDT),(0,SVQEND)                                
*                                                                               
ESTF09   CLI   SVEDAILY,C'Y'       TEST DAILY ESTIMATE                          
         JE    ESTF10                                                           
         CLI   SVOOWROT,1          TEST OOWR                                    
         JNE   ESTF10                                                           
         GOTOR VGETDAY,DMCB,ESTSTRT,DUB                                         
         LLC   R0,0(R1)                                                         
         AHI   R0,-1                                                            
         JZ    ESTF10                                                           
         LCR   R0,R0                                                            
         GOTOR VADDAY,DMCB,ESTSTRT,SVQSTART,(R0)                                
                                                                                
ESTF10   GOTOR VDATCON,DMCB,SVQSTART,(3,SVQSTB)                                 
         GOTOR (RF),(R1),,(2,SVQSTP)                                            
         GOTOR (RF),(R1),SVQEND,(3,SVQENDB)                                     
         GOTOR (RF),(R1),,(2,SVQENDP)                                           
*                                                                               
         XC    PASSTAB,PASSTAB       CLEAR TABLE OF PERIODS                     
* BUILD NEW TABLE                                                               
         LA    R4,PASSTAB                                                       
         MVC   PASSTAB(6),SVQSTART                                              
         LHI   R2,7                MAX IS 7 PERIODS                             
         CLI   SVEDAILY,C'Y'       TEST DAILY ESTIMATE                          
         JNE   ESTF20                                                           
                                                                                
**** DAILY                                                                      
                                                                                
ESTF12   GOTOR VADDAY,DMCB,0(R4),6(R4),F'13'  GET END DATE                      
         CLC   6(6,R4),SVQEND                 TEST PAST REQUEST END             
         JNL   ESTF14                                                           
         GOTO1 (RF),(R1),6(R4),12(R4),F'1'   GET NEXT START DATE                
         LA    R4,12(R4)                                                        
         JCT   R2,ESTF12                                                        
*                                                                               
ESTF14   MVC   6(6,R4),SVQEND      SET REQ END DATE IN LAST ENTRY               
                                                                                
* FILL IN WEEKTAB WITH DAYS                                                     
                                                                                
         MVC   WORK(6),SVQSTART                                                 
         LA    R4,WEEKTAB                                                       
         LHI   R2,53                                                            
         J     ESTF17                                                           
*                                                                               
ESTF16   GOTOR VADDAY,DMCB,WORK,WORK+6,1                                        
         CLC   WORK+6(6),SVQEND    TEST PAST REQUEST END                        
         JH    ESTF18                                                           
         MVC   WORK(6),WORK+6                                                   
*                                                                               
ESTF17   GOTOR VDATCON,DMCB,WORK,(2,(R4))                                       
         MVC   2(2,R4),0(R4)       SET END DAY TOO                              
         AHI   R4,4                NEXT  ENTRY                                  
         JCT   R2,ESTF16                                                        
*                                                                               
ESTF18   MVI   0(R4),X'FF'         SET EOT                                      
         J     ESTF37                                                           
                                                                                
*** WEEKLY                                                                      
                                                                                
ESTF20   CLI   SVOOWROT,1          IS IT OOWR?                                  
         JE    ESTF25                NO, DON'T USE MOBILE                       
         MVC   WORK(6),SVQSTART                                                 
         LA    R4,WEEKTAB                                                       
         LHI   R2,53                                                            
*                                                                               
ESTF21   GOTOR VADDAY,DMCB,WORK,WORK+6,F'6'                                     
         CLC   WORK+6(6),SVQEND    TEST END DATE PAST REQUEST END               
         JNH   ESTF22                                                           
         CLC   WORK(6),SVQEND      TEST START DATE PAST REQUEST END?            
         JH    ESTF23              YES, FINISHED                                
         MVC   WORK+6(6),SVQEND    NO, SET REQUEST END AS END DATE              
         J     ESTF22                                                           
*                                                                               
ESTF22   GOTOR VDATCON,DMCB,WORK,(2,(R4))                                       
         GOTOR VDATCON,DMCB,WORK+6,(2,2(R4))                                    
         AHI   R4,4                NEXT  ENTRY                                  
         GOTOR VADDAY,DMCB,WORK+6,WORK,F'1'                                     
         JCT   R2,ESTF21                                                        
*                                                                               
ESTF23   MVI   0(R4),X'FF'         SET EOT                                      
*                                                                               
ESTF25   LA    R0,QGETBRD          GET A(GETBROAD)                              
         ICM   R0,B'1110',T00A                                                  
         GOTOR VCALLOV,DMCB,0,(R0)                                              
         MVC   WORK(4),0(R1)                                                    
         MVC   WORK+4(4),VADDAY                                                 
         MVC   WORK+8(4),VGETDAY                                                
         MVC   WORK+12(4),VDATCON                                               
                                                                                
* BUILD TABLE OF 53 (MAX) BROADCAST WEEKS                                       
* FROM START DATE IF OOWR OR FROM MONDAY IF NOT                                 
                                                                                
         LA    R0,QMOBILE          GET A(MOBILE)                                
         ICM   R0,B'1110',T00A                                                  
         GOTOR VCALLOV,DMCB,0,(R0)                                              
         L     RF,0(R1)                                                         
*                                                                               
         CLI   SVOOWROT,1          IS IT OOWR?                                  
         JNE   ESTF27               - YES, SKIP THIS AS WE DID IT ABOVE         
         GOTO1 (RF),DMCB,(53,SVQSTART),(5,WEEKTAB),WORK,0                       
                                                                                
* NOW DO BROADCAST MONTHS                                                       
                                                                                
ESTF27   GOTOR (RF),DMCB,(13,SVQSTART),(0,AIO6),WORK,0                          
                                                                                
* CALL PERVERT FOR THE NUMBER OF WEEKS IN REQUEST PERIOD                        
* IF LESS THAN 14, THE REPORT WILL HAVE ONLY ONE PERIOD                         
                                                                                
         GOTO1 VPERVERT,DMCB,SVQSTART,SVQEND                                    
         LH    R0,12(R1)           GET NUMBER OF WHOLE WEEKS                    
         OC    10(2,R1),10(R1)     TEST ANY REMAINDER                           
         JZ    *+8                                                              
         AHI   R0,1                                                             
         CHI   R0,14               TEST MORE THAN 14 WEEKS                      
         JH    ESTF28                                                           
         MVC   PASSTAB(12),SVQSTART SET START/END DATES                         
         J     ESTF37                                                           
*                                                                               
ESTF28   SR    R0,R0                                                            
         ICM   R0,1,SVOOWROT                                                    
         AHI   R0,-1               SET TO LAST DAY OF OOWR                      
         JZ    ESTF30              TEST FOR 0, NOT OOW?                         
         L     R3,AIO6             YES, ADJUST THE MONTHS                       
ESTF29   CLI   4(R3),X'FF'                                                      
         JE    ESTF30                                                           
         GOTOR VDATCON,DMCB,(2,2(R3)),WORK                                      
         GOTOR VADDAY,DMCB,WORK,WORK+6,(R0)                                     
         GOTOR VDATCON,DMCB,WORK+6,(2,2(R3))                                    
         MVC   WORK(6),WORK+6                                                   
         GOTOR VADDAY,DMCB,WORK,WORK+6,1                                        
         GOTOR VDATCON,DMCB,WORK+6,(2,4(R3))                                    
         LA    R3,4(R3)                                                         
         J     ESTF29                                                           
*                                                                               
* NOW UP TO 3 BROADCAST MONTHS PER PERIOD                                       
                                                                                
ESTF30   LA    R4,PASSTAB                                                       
         L     R3,AIO6                                                          
*                                                                               
ESTF31   GOTOR VDATCON,DMCB,(2,0(R3)),0(R4)                                     
*                                                                               
ESTF33   CLI   4(R3),X'FF'         TEST MONTH 2 IS THERE                        
         JE    ESTF35              NO - USE CURRENT                             
         AHI   R3,4                POINT TO NEXT MONTH                          
         CLI   4(R3),X'FF'         TEST MONTH 3 IS THERE                        
         JE    ESTF35                                                           
         AHI   R3,4                                                             
*                                                                               
ESTF35   GOTOR VDATCON,DMCB,(2,2(R3)),6(R4)                                     
         AHI   R4,12                                                            
         AHI   R3,4                                                             
         CLI   0(R3),X'FF'                                                      
         JNE   ESTF31                                                           
*                                                                               
ESTF37   MVI   PASS,1              RESET PASS COUNTER                           
         MVI   MIDPASS,0           RESET MIDPASS                                
*                                                                               
         LA    R1,PASSTAB                                                       
         SR    R0,R0                                                            
ESTF40   OC    0(12,R1),0(R1)                                                   
         JZ    *+12                                                             
         AHI   R1,12                                                            
         JCT   R0,ESTF40                                                        
         LPR   R0,R0                                                            
         STC   R0,MAXPASS                                                       
         J     EXIT                                                             
         EJECT                                                                  
*                                                                               
*=============================================================                  
* READ BUY RECORDS AND BUILD TSAR BUFFER                                        
*=============================================================                  
READBUYS NTR1  BASE=*,LABEL=*                                                   
         XC    RPTTOTS,RPTTOTS                                                  
*                                                                               
         CLC   LP_QMAPN,=AL2(I#SDOEXS)       ORDER EXPORT?                      
         JNE   RDBY005                                                          
         ICM   RE,15,I$BUYDA       ANY BUY D/A TO READ?                         
         JZ    RDBY007              NO                                          
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(RE)                                            
         STCM  R0,3,BUYIND         # OF BUYLINES TO READ                        
*                                                                               
         LA    R1,LW_DATA2-LW_D(RE)                                             
         STCM  R1,7,ABUYDA         A(BUY D/A ENTRIES)                           
         J     RDBY010                                                          
*                                                                               
         XC    IOKEY,IOKEY                                                      
*        MVC   IOKEY(ORDXBKYL),ORXAGM                                           
RDBY005  MVC   SVBUYKEY,ORXAGM                                                  
*                                                                               
         MVC   SV1OR2,SAVE1OR2                                                  
         CLC   LP_AGY,=C'SJ'                                                    
         JNE   RDBY007                                                          
         CLC   QCLTA,=C'TBL'                                                    
         JE    *+10                                                             
         CLC   QCLTA,=C'PG0'                                                    
         JE    *+10                                                             
         CLC   QCLTA,=C'PG1'                                                    
         JNE   RDBY007                                                          
         MVI   SV1OR2,2                                                         
*                                                                               
RDBY007  CLI   SVRESEND,C'Y'       TEST RESEND                                  
         JE    RDBY100              YES                                         
*                                                                               
         MVI   LP_RMODE,LP_RFRST                                                
*                                                                               
         USING BUYREC,R4                                                        
RDBY010  L     R4,AIO5                                                          
*                                                                               
         CLC   LP_QMAPN,=AL2(I#SDOEXS)       ORDER EXPORT?                      
         JNE   RDBY012                                                          
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,3,BUYIND         ANY MORE BUYLINES TO READ?                   
         JZ    RDBY100              NO, EXIT                                    
         SHI   R1,1                SUBTRACT 1 FROM # OF BUY D/A                 
         STCM  R1,3,BUYIND                                                      
*                                                                               
         ICM   R1,7,ABUYDA                                                      
         MVC   IODAOVER,0(R1)      GET THE BUY D/A TO READ                      
         MVC   FULL,4(R1)                                                       
         LA    R1,L'BUYKDA+#$CKSUM(R1)                                          
         STCM  R1,7,ABUYDA         A(NEXT BUY D/A)                              
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOBGET+IOFIL+B#BUYREC'                        
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   GBY1OR2,SAVE1OR2    NEED TO SET GBY1OR2, I CALL GETBUY           
         MVC   SV1OR2,SAVE1OR2                                                  
         CLC   LP_AGY,=C'SJ'                                                    
         JNE   RDBY011                                                          
         L     RE,AIO5                                                          
         CLC   BUYKCLT-BUYKEY(L'BUYKCLT,RE),=X'CC2B'    CLIENT TBL?             
         JE    *+10                                                             
         CLC   BUYKCLT-BUYKEY(L'BUYKCLT,RE),=X'BCC9'    CLIENT PG0?             
         JE    *+10                                                             
         CLC   BUYKCLT-BUYKEY(L'BUYKCLT,RE),=X'BCDA'    CLIENT PG1?             
         JNE   RDBY011                                                          
         MVI   GBY1OR2,2                                                        
         MVI   SV1OR2,2                                                         
RDBY011  MVC   GBYIOA,AIO5                                                      
         MVI   GBYACT,GBYCONV                                                   
         GOTOR VGETBUY,GETBLK                                                   
         MVI   GBYACT,0                                                         
*                                                                               
         GOTOR CHKRECSM,DMCB,AIO5,FULL,IODA                                     
         JE    RDBY020                                                          
         CLC   LP_QMAPN,=AL2(I#SDOEXS)       ORDER EXPORT?                      
         JNE   *+2                                                              
         GOTOR PUTERR,DMCB,('SE#SY002',SE#NSREF)                                
         J     EXITN                                                            
*                                                                               
RDBY012  GOTOR (#NXTREC,ANXTREC),DMCB,('YESQ',BUYKEYT),('B#BUYREC',0), *        
               SAVED,AFLTBKY,AFLTBRD                                            
         JNE   RDBY100                                                          
*                                                                               
RDBY015  CLC   IOKEY(10),IOKEYSAV  TEST CHANGE OF NTWK                          
         JE    RDBY020             NO                                           
         MVC   IOKEYSAV(13),IOKEY  THEN SAVE NEW NETWORK                        
*                                                                               
RDBY020  LA    R0,TSARREC          CLEAR TSARREC                                
         LHI   R1,L'TSARREC                                                     
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         LA    R0,COVTAB                                                        
         LHI   R1,COVTABX-COVTAB                                                
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         XC    MYDOLS,MYDOLS                                                    
         XC    MYTAX,MYTAX                                                      
*                                                                               
         LA    R4,BDELEM                                                        
*                                                                               
         CLC   LP_QMAPN,=AL2(I#SDOEXS)       ORDER EXPORT?                      
         JNE   RDBY022                                                          
         TM    BDCIND-BDELEM(R4),BDCMINSQ  X'01' MINUS SPOTS?                   
***      BNZ   RDBY021                                                          
***      TM    BDCIND2-BDELEM(R4),BDCRNEGQ  X'08' NEGATIVE RATE?                
         JZ    RDBY022                                                          
RDBY021  GOTOR PUTERR,DMCB,('SE#SY002',SE#NSNEG)                                
         J     EXITN                                                            
*                                                                               
RDBY022  MVI   ELCDLO,RCPOLOQ      X'0B' - POOL ORIGINAL                        
         MVI   ELCDHI,RCPOTOQ      X'0C' - POOL OTO                             
         DROP  R4                                                               
*                                                                               
RDBY025  BRAS  RE,NEXTEL                                                        
         JNE   RDBY040                                                          
*                                                                               
         CLI   1(R4),10            TEST ALLOCATED                               
         JNH   RDBY025                                                          
         TM    6(R4),RSMINUSQ+RSMINSDQ TEST MINUS OR MINUSED SPOT               
         JNZ   RDBY025                                                          
         CLC   2(2,R4),SVQSTP      TEST PRIOR TO START                          
         JL    RDBY025                                                          
         CLC   2(2,R4),SVQENDP     OR AFTER END                                 
         JH    RDBY025                                                          
*                                                                               
         CLI   1(R4),14            TEST PIGGYBACK SPOT                          
         JH    RDBY030             YES                                          
*                                                                               
         CLI   SVBPR2,0            TEST PIGGYBACK REQUEST                       
         JNE   RDBY025             YES -IGNORE                                  
         CLC   10(1,R4),SVBPRD     RIGHT PRODUCT                                
         JNE   RDBY025                                                          
         J     RDBYPST                                                          
* THIS IS A PIGGYBACK SPOT                                                      
                                                                                
RDBY030  CLI   SVBPR2,0            TEST PIGGYBACK REQUEST                       
         JE    RDBY025             NO - SO SKIP P/B SPOT                        
*                                                                               
         CLC   10(1,R4),SVBPRD     MATCH FIRST PRD                              
         JE    RDBY035                                                          
         CLC   14(1,R4),SVBPRD     MATCH TO SECOND PRD                          
         JNE   RDBY025             NO - THEN MATCHES NEITHER                    
*                                                                               
RDBY035  CLC   10(1,R4),SVBPR2      NOW MATCH PRD2                              
         JE    RDBYPST                                                          
         CLC   14(1,R4),SVBPR2                                                  
         JNE   RDBY025                                                          
*                                                                               
RDBYPST  BRAS  RE,POSTIT           POST SPTS, DOLLARS AND TAX                   
         J     RDBY025                                                          
         EJECT                                                                  
*=============================================================                  
* END OF BUY ELEMENTS                                                           
*=============================================================                  
RDBY040  L     R4,AIO5                                                          
         USING BUYREC,R4                                                        
         MVI   BHISTYPE,BHISTYPQ        BUY TYPE TO TSAR KEY                    
         MVC   BHISSTA,BUYKSTAC         STATION TO TSAR KEY                     
         MVC   BHISLIN,BUYKBUY          AND 2-BYTE LINE NUMBER                  
*                                                                               
         OC    BHSPTS,BHSPTS       TEST ANY SPOTS POSTED                        
         JNZ   RDBY052                                                          
         OC    COVTAB,COVTAB       OR ANY COST OVRD SPOTS                       
         JZ    RDBY010             NO SPOTS - SKIP TSAR                         
*                                                                               
* FILL IN REMAINDER OF TSAR RECORD                                              
*                                                                               
RDBY052  MVC   BHBDDAY,BDDAY                                                    
         MVC   BHBDTIME,BDTIMST                                                 
         MVC   BHBDCOST,BDCOST                                                  
         MVC   BHBDCIND,BDCIND                                                  
         MVC   BHBDCIN2,BDCIND2                                                 
         MVC   BHBDSEC,BDSEC                                                    
         MVC   BHBDPROG,BDPROGRM                                                
*                                                                               
         CLI   DRCSHTRD,TRDESREP   DOING TRADE NOW?                             
         JNE   RDBY054                                                          
         CLI   PDAR0TRD,C'Y'       TRADE ORDER $0 COST?                         
         JNE   RDBY054                                                          
         XC    BHBDCOST,BHBDCOST                                                
*                                                                               
RDBY054  BRAS  RE,GETDEMS          EXTRACT DEMO VALUES                          
*                                                                               
RDBY056  CLI   DRCSHTRD,TRDESREP   DOING TRADE NOW?                             
         JNE   RDBY057                                                          
         TM    CLTFLAG1,CLTTRADE   IS IT A TRADE CLIENT?                        
         JZ    RDBY057                                                          
         MVI   ELCDLO,X'71'        CHECK FOR COST2                              
         MVI   ELCDHI,X'71'                                                     
         BRAS  RE,GETEL                                                         
         JE    RDBY056A                                                         
         CLC   LP_QMAPN,=AL2(I#SDOEXS)       ORDER EXPORT?                      
         JNE   RDBY057                                                          
         L     R4,AIO5                                                          
         LLH   R1,BUYKBUY          GET THE BUYLINE#                             
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  XTRATEXT(3),DUB                                                  
         GOTOR PUTERR,DMCB,('SE#SY002',SE#MSCS2)                                
         J     EXITN                                                            
*                                                                               
RDBY056A ICM   RE,15,2(R4)                                                      
         STCM  RE,7,BHBDCOST                                                    
*                                                                               
RDBY057  LHI   RF,BUYHRCLD         RF = L'ENTRY                                 
         OC    BHSPTS,BHSPTS                                                    
         JZ    RDBY058                                                          
         LA    RF,BHSPTS+L'BHSPTS-1                                             
RDBY057A CLI   0(RF),0                                                          
         JNE   *+8                                                              
         JCT   RF,*-8                                                           
*                                                                               
         LA    RE,BUYHISD-1        +1 FOR EX INTR                               
         SR    RF,RE                                                            
RDBY058  STCM  RF,3,BHISLEN                                                     
*                                                                               
RDBY060  GOTOR BUFFER,DMCB,('TSAADD',0)                                         
         JNE   *+2                                                              
*                                                                               
         MVI   BHISSEQ,BHDOLQ      SET X'01' DOLLARS                            
         OC    MYDOLS,MYDOLS       ANY DOLLARS TO SAVE?                         
         JZ    RDBY061                                                          
*                                                                               
         MVC   BHDOLS,MYDOLS                                                    
         LA    RF,BHDOLS+L'BHDOLS                                               
         AHI   RF,-4               A(PREVIOUS ENTRY)                            
         OC    0(4,RF),0(RF)                                                    
         JZ    *-10                                                             
*                                                                               
         LA    RE,BUYHISD-4        (L'RECORD + 4 BYTE LAST ENTRY)               
         SR    RF,RE                                                            
         STCM  RF,3,BHISLEN                                                     
         GOTOR BUFFER,DMCB,('TSAADD',0)                                         
         JNE   *+2                                                              
*                                                                               
RDBY061  MVI   BHISSEQ,BHTAXQ      SET X'02' TAX                                
         OC    MYTAX,MYTAX                                                      
         JZ    RDBY061A                                                         
*                                                                               
         MVC   BHTAX,MYTAX                                                      
         LA    RE,BHTAX+L'BHTAX                                                 
         AHI   RE,-4               A(LAST ENTRY)                                
         OC    0(4,RE),0(RE)                                                    
         JZ    *-10                                                             
         LA    RF,BUYHISD-4        (L'RECORD + 4 BYTE LAST ENTRY)               
         SR    RE,RF                                                            
         STCM  RE,3,BHISLEN                                                     
         GOTOR BUFFER,DMCB,('TSAADD',0)                                         
         JNE   *+2                                                              
                                                                                
*===============================================================                
* ADD TSAR RECORDS FOR COST OVRDS, ORBITS AND COMMENTS AS NEEDED                
*===============================================================                
                                                                                
RDBY061A LA    R4,COVTAB                                                        
         LHI   R2,(COVTABX-COVTAB)/L'COVTAB                                     
         MVI   BHISSEQ,BHCOVQ      SET X'10' COST OVERRIDE CODE                 
*                                                                               
RDBY062  OC    0(3,R4),0(R4)       TEST ENTRY PRESENT                           
         JZ    RDBY070                                                          
*                                                                               
         LA    R0,BUYHISD+BUYHKYH2    CLEAR ALL BUT KEY                         
         LHI   R1,BUYHRECL-BUYHKYH2                                             
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         ICM   R0,7,0(R4)          GET COST                                     
         N     R0,=X'007FFFFF'     DROP ZERO FLAG                               
         STCM  R0,7,BHBDCOST                                                    
         MVC   BHCSPTS,3(R4)       MOVE SPOT TABLE                              
         LA    RF,BHCSPTS+L'BHCSPTS-1                                           
         LA    RE,BHCSPTS                                                       
RDBY065  CR    RF,RE                                                            
         JL    *+2                 THATS STRANGE?? DIE!!                        
         CLI   0(RF),0                                                          
         JNE   *+8                                                              
         JCT   RF,RDBY065                                                       
*                                                                               
         AHI   RF,1+BUYHRCLC                                                    
         SR    RF,RE                                                            
         STCM  RF,3,BHISLEN                                                     
*                                                                               
         GOTOR BUFFER,DMCB,('TSAADD',0)                                         
         JNE   *+2                                                              
*                                                                               
         LLC   R0,BHISSEQ                                                       
         AHI   R0,1                                                             
         STC   R0,BHISSEQ                                                       
*                                                                               
         AHI   R4,L'COVTAB                                                      
         JCT   R2,RDBY062                                                       
                                                                                
RDBY070  L     R4,AIO5                                                          
         MVI   ELCDLO,X'67'        SEARCH FOR ORBIT ELEMENTS                    
         MVI   ELCDHI,X'67'                                                     
         BRAS  RE,GETEL                                                         
         JNE   RDBY072                                                          
*                                                                               
         LA    R0,BUYHISD+BUYHKYH2    CLEAR ALL BUT KEY                         
         LHI   R1,BUYHRECL-BUYHKYH2                                             
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVI   BHISSEQ,BHORBQ      SET X'20' ORBIT RECORD CODE                  
*                                                                               
         LLC   RE,1(R4)                                                         
         AHI   RE,-5               SET FOR EX                                   
         MVC   BHORBS(0),4(R4)                                                  
         EX    RE,*-6                                                           
*                                                                               
         AHI   RE,BUYHKEYH+1                                                    
         STCM  RE,3,BHISLEN                                                     
*                                                                               
         GOTOR BUFFER,DMCB,('TSAADD',0)                                         
         JNE   *+2                                                              
*                                                                               
RDBY072  BRAS  RE,DOBUYCOM                                                      
         J     RDBY010                                                          
         EJECT                                                                  
*=====================================================================          
* READ THROUGH HISTORY RECORDS AND ADD DELETED BUYS TO TSAR BUFFER              
* THIS CODE ALSO BUILDS TSAR RECORDS FOR RESEND                                 
*=====================================================================          
                                                                                
RDBY100  XC    SVXSPKEY,SVXSPKEY   CLEAR SAVE AREA                              
         XC    IOKEY,IOKEY                                                      
K        USING OHISRECD,IOKEY                                                   
         MVI   K.OHISTYP,OHISTYQ                                                
         MVI   K.OHISSTYP,OHISSTYQ                                              
         MVC   K.OHISORD,BINORDER                                               
         MVC   K.OHISBKAM,SVBAGM                                                
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOXSPDIR+IO6'                            
*                                                                               
RDBY101  CLC   IOKEY(OHISBUYK-OHISKEY+L'OHISBKAM),IOKEYSAV  TY/ORD#/A-M         
         JNE   EXITY                                                            
*                                                                               
RDBY102  XC    BUYHISD(BUYHKEYH),BUYHISD   SEE IF RECORD IN TSAR BUFFER         
         MVI   BHISTYPE,BHISTYPQ        SET BUY TYPE                            
         MVC   BHISSTA,K.OHISBKST       SET STATION                             
         MVC   BHISLIN+1(1),K.OHISBKLN  AND LINE                                
         CLI   K.OHISBKLN,0             2-BYTE BLN HISTORY RECORD?              
         JNE   *+10                                                             
         MVC   BHISLIN,K.OHISBKL2       AND SET 2-BYTE BUYLINE                  
         GOTOR BUFFER,DMCB,('TSARDH',0)                                         
         JE    RDBY125             RECORD IS IN BUFFER                          
*                                                                               
* IF WE GET HERE, IT MEANS THE BUYLINE WAS DELETED/REMOVED                      
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOXSPFIL+IO6'                           
*                                                                               
         L     R4,AIO6                                                          
         LA    R4,OBDELEM-OHISKEY(R4)                                           
         MVI   ELCDLO,OBDELEMQ                                                  
         MVI   ELCDHI,OBDELEMQ                                                  
         BRAS  RE,NEXTEL2                                                       
         JNE   RDBY125                                                          
         USING OBDELEM,R4                                                       
*                                                                               
         LA    R0,TSARREC          PREPARE A NEW TSAR RECORD                    
         LHI   R1,L'TSARREC                                                     
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVI   BHISTYPE,BHISTYPQ        SET BUY TYPE                            
         MVC   BHISSTA,K.OHISBKST       SET STATION                             
         MVC   BHISLIN+1(1),K.OHISBKLN  AND BUYLINE                             
         CLI   K.OHISBKLN,0             2-BYTE BUYLINE?                         
         JNE   *+10                     NO                                      
         MVC   BHISLIN,K.OHISBKL2       SET 2-BYTE BUYLINE                      
*                                                                               
         CLI   SVRESEND,C'Y'       TEST RESEND                                  
         JE    RDBY111             YES                                          
*                                                                               
         CLI   OBDFLAG,0           TEST BUY WAS DELETED PREVIOUSLY              
         JNE   RDBY125             YES - IGNORE                                 
*                                                                               
RDBY103  MVC   BHFLAG,SVCURREV     SET DEL VERSION NUMBER IN TSARREC            
         DROP  R4                                                               
*                                                                               
* NEED SPOTS IN TSAR RECORD SO KNOW WHICH PERIODS TO PRINT                      
*                                                                               
         XC    BHSPTS,BHSPTS                                                    
         MVI   ELCDLO,OHSPTELQ          X'06' SPOTS ELEMENT                     
         CLI   SVRESEND,C'Y'            TEST RESEND                             
         JNE   *+8                      NO                                      
         MVI   ELCDLO,OHSPTELQ+X'10'    X'16' PREVIOUS SPOTS ELEMENT            
         MVC   ELCDHI,ELCDLO                                                    
*                                                                               
         BRAS  RE,NEXTEL                                                        
         JNE   RDBY107                                                          
         USING OHSPTEL,R4                                                       
         LLC   RE,OHSPTLN                                                       
         AHI   RE,-3               2 - 1(FOR EX INTR)                           
         OC    BHSPTS(0),OHDSPTS                                                
         EX    RE,*-6                                                           
*                                                                               
RDBY107  MVI   ELCDLO,OHCOVELQ     X'08' NOW RATE OVERRIDE ELEMENTS             
         CLI   SVRESEND,C'Y'       TEST RESEND                                  
         JNE   *+8                 NO                                           
         MVI   ELCDLO,OHCOVELQ+X'10'                                            
         MVC   ELCDHI,ELCDLO                                                    
*                                                                               
RDBY109  BRAS  RE,NEXTEL                                                        
         JNE   RDBY110                                                          
         USING OHCOVEL,R4                                                       
         LLC   RE,OHCOVLN                                                       
         AHI   RE,-6               5 - 1(FOR EX INTR)                           
         OC    BHSPTS(0),OHCSPOTS  SET NON-ZERO IN ACTIVE WEEKS                 
         EX    RE,*-6                                                           
         J     RDBY109                                                          
         DROP  R4                                                               
*                                                                               
RDBY110  LA    RE,BHSPTS+L'BHSPTS-1                                             
         CLI   0(RE),0                                                          
         JNE   *+8                                                              
         JCT   RE,*-8                                                           
         LA    RF,BUYHISD-1                                                     
         SR    RE,RF                                                            
         STCM  RE,3,BHISLEN                                                     
*                                                                               
         GOTOR BUFFER,DMCB,('TSAADD',0)                                         
         J     RDBY125                                                          
         DROP  K                                                                
                                                                                
* FOR RESEND. CREATE TSAR RECORD FROM ORDER HISTORY RECORD                      
                                                                                
         USING OBDELEM,R4                                                       
RDBY111  CLI   OBDFLAG,0           TEST PREVIOUSLY DELETED                      
         JE    RDBY113             NO - RECREATE BUY DATA                       
*                                                                               
         CLC   OBDFLAG,SVCURREV    TEST DELETED IN THIS VERSION                 
         JNE   RDBY125             NO - IGNORE                                  
         J     RDBY103             AND BUILD SPOTS FROM PRIOR ELEMS             
*                                                                               
RDBY113  MVC   BHBDDAY,OBDDAY                                                   
         MVC   BHBDTIME,OBDTIME                                                 
         MVC   BHBDSEC,OBDSEC                                                   
         MVC   BHBDCOST,OBDCOST                                                 
         MVC   BHBDCIND,OBDCIND                                                 
         MVC   BHBDCIN2,OBDCIND2                                                
         MVC   BHBDPROG,OBDPROG                                                 
         MVC   BHDEMS(32),OBDDEMS                                               
         DROP  R4                                                               
*                                                                               
         LLC   R0,1(R4)                                                         
         AR    R4,R0               POINT TO SPOTS ELEMENT                       
         CLI   0(R4),OHSPTELQ      X'06'                                        
         JNE   *+2                                                              
         LLC   RE,1(R4)                                                         
         AHI   RE,-(OHDSPTS-OHSPTEL+1)  MINUS ELEM OV'HD AND -1 FOR EX          
         MVC   BHSPTS(0),2(R4)                                                  
         EX    RE,*-6                                                           
         AHI   RE,BUYHRCLD+1            ADD TSAR OVHD AND +1 FOR EX             
         STCM  RE,3,BHISLEN                                                     
*                                                                               
         GOTOR BUFFER,DMCB,('TSAADD',0)      ADD BUY DESC REC                   
         JNE   *+2                                                              
*                                                                               
         LA    R0,BUYHISD+BUYHKYH2    CLEAR ALL BUT KEY                         
         LHI   R1,BUYHRECL-BUYHKYH2                                             
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         LLC   R0,1(R4)                                                         
         AR    R4,R0               POINT TO DOLLARS ELEMENT                     
         CLI   0(R4),OHDOLELQ      X'07'                                        
         JNE   RDBY114                                                          
***      DC    H'0'                                                             
         LLC   RE,1(R4)                                                         
         AHI   RE,-(OHDOLS-OHDOLEL+1)  MINUS ELEM OV'HD AND -1 FOR EX           
         MVC   BHDOLS(0),2(R4)                                                  
         EX    RE,*-6                                                           
         AHI   RE,BUYHKYH2+1           ADD TSAR OVHD AND +1 FOR EX              
         STCM  RE,3,BHISLEN                                                     
         MVI   BHISSEQ,BHDOLQ      SET X'01' DOLLARS                            
*                                                                               
         GOTOR BUFFER,DMCB,('TSAADD',0)                                         
         JNE   *+2                                                              
*                                                                               
RDBY114  LA    R0,BUYHISD+BUYHKYH2    CLEAR ALL BUT KEY                         
         LHI   R1,BUYHRECL-BUYHKYH2                                             
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
RDBY115  LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         CLI   0(R4),0                                                          
         JE    RDBY116                                                          
         CLI   0(R4),OHTAXELQ      X'09' - TEST TAX ELEMENT                     
         JNE   RDBY115                                                          
*                                                                               
         LLC   RE,1(R4)                                                         
         AHI   RE,-(OHTAX-OHTAXEL+1)  MINUS ELEM OV'HD AND -1 FOR EX            
         MVC   BHTAX(0),2(R4)                                                   
         EX    RE,*-6                                                           
         AHI   RE,BUYHKYH2+1          ADD TSAR OVHD AND +1 FOR EX               
         STCM  RE,3,BHISLEN                                                     
         MVI   BHISSEQ,BHTAXQ                                                   
*                                                                               
RDBY116  GOTOR BUFFER,DMCB,('TSAADD',0)      ADD BUY DESC REC                   
*                                                                               
         LA    R0,BUYHISD+BUYHKYH2    CLEAR ALL BUT KEY                         
         LHI   R1,BUYHRECL-BUYHKYH2                                             
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     R4,AIO6             RESET RECORD POINTER                         
         AHI   R4,OBDELEM-OHISRECD                                              
         MVI   BHISSEQ,BHCOVQ      SET X'10' COST OVERRIDE CODE                 
*                                                                               
RDBY118  LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         CLI   0(R4),0             TEST END OF THE RECORD                       
         JE    RDBY120                                                          
         CLI   0(R4),OHCOVELQ      X'08' TEST COST OVRD ELEM                    
         JL    RDBY118                                                          
         JH    RDBY120                                                          
         USING OHCOVEL,R4                                                       
*                                                                               
         ICM   R0,7,OHCCOST                                                     
         N     R0,=X'007FFFFF'     DROP X'80' FLAG                              
         STCM  R0,7,BHBDCOST       MOVE COST                                    
*                                                                               
         LLC   RE,OHCOVLN                                                       
         AHI   RE,-(OHCSPOTS-OHCOVEL+1)  MINUS ELEM OV'HD AND -1 FOR EX         
         MVC   BHCSPTS(0),OHCSPOTS       ADD SPOTS                              
         EX    RE,*-6                                                           
         AHI   RE,BUYHRCLC+1             ADD TSAR OVHD AND +1 FOR EX            
         STCM  RE,3,BHISLEN                                                     
         DROP  R4                                                               
*                                                                               
         GOTOR BUFFER,DMCB,('TSAADD',0)                                         
*                                                                               
         LLC   R0,BHISSEQ                                                       
         AHI   R0,1                                                             
         STC   R0,BHISSEQ          THIS SHOULD ADD SEQNUMS 01-08                
         J     RDBY118                                                          
*                                                                               
* NOW READ THE BUY RECORD FOR COMMENTS AND ORBIT DATA                           
                                                                                
RDBY120  L     RE,AIO5                                                          
         XC    0(13,RE),0(RE)      CLEAR IN CASE NOT FOUND                      
*                                                                               
         MVC   SVXSPKEY,IOKEY      SAVE ORDER HISTORY KEY                       
*                                                                               
         XC    IOKEY,IOKEY         READ BUY KEY                                 
         MVC   IOKEY(ORDXBKYL),ORXAGM                                           
         MVC   IOKEY+11(2),BHISLIN                                              
*                                                                               
         MVI   GBYACT,GBYHIGH                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO5'                               
         CLC   IOKEY(12),IOKEYSAV                                               
         JNE   RDBY122                                                          
*                                                                               
         MVI   GBYACT,GBYGET                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO5'                              
*                                                                               
         MVI   ELCDLO,X'67'        FIND ORBIT DATA                              
         MVI   ELCDHI,X'67'                                                     
         L     R4,AIO5                                                          
         AHI   R4,BDELEM-BUYREC                                                 
         BRAS  RE,NEXTEL                                                        
         JNE   RDBY122                                                          
*                                                                               
         LA    R0,BUYHISD+BUYHKYH2    CLEAR ALL BUT KEY                         
         LHI   R1,BUYHRECL-BUYHKYH2                                             
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVI   BHISSEQ,BHORBQ      SET X'20' ORBIT SEQNUM                       
         LLC   RE,1(R4)                                                         
         AHI   RE,-5               MINUS ELEM OV'HD AND -1 FOR EX               
         MVC   BHORBS(0),4(R4)                                                  
         EX    RE,*-6                                                           
         AHI   RE,BUYHKYH2+1       ADD TSAR OVHD AND +1 FOR EX                  
         STCM  RE,3,BHISLEN                                                     
*                                                                               
         GOTOR BUFFER,DMCB,('TSAADD',0)                                         
*                                                                               
RDBY122  CLI   BHFLAG,0            TEST DELETED BUY RECORD                      
         JNE   RDBY125                                                          
         BRAS  RE,DOBUYCOM         ADD TSAR COMMENT RECORDS                     
*                                                                               
RDBY125  OC    SVXSPKEY,SVXSPKEY   TEST BROKE READ SEQUENCE                     
         JZ    RDBY127                                                          
         MVC   IOKEY,SVXSPKEY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOXSPDIR+IO6'                            
         JNE   *+2                                                              
         XC    SVXSPKEY,SVXSPKEY                                                
*                                                                               
RDBY127  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IOXSPDIR+IO6'                            
         J     RDBY101                                                          
         EJECT                                                                  
*                                                                               
POSTIT   NTR1                                                                   
*                                                                               
         L     RF,AIO5                                                          
         MVC   BYTE,3(RF)                                                       
POSTIT1  GOTOR GTMYRATE,DMCB,(BYTE,0)                                           
*                                                                               
         LA    R1,WEEKTAB                                                       
         LHI   R0,53                                                            
*                                                                               
POSTIT2  CLC   2(2,R4),0(R1)       TEST PRIOR TO WEEK START                     
         JL    *+14                                                             
         CLC   2(2,R4),2(R1)       TEST PRIOR TO WEEK END                       
         JNH   POSTIT4                                                          
         AHI   R1,4                                                             
         JCT   R0,POSTIT2                                                       
         DC    H'0'                                                             
*                                                                               
POSTIT4  CLC   SVAIRDAT,2(R4)      GOT AN EARLIER DATE?                         
         JL    POSTIT6             NO                                           
         MVC   SVAIRDAT,2(R4)      YES, EARLIER AIR DATE                        
*                                                                               
POSTIT6  LA    R0,WEEKTAB                                                       
         SR    R1,R0                                                            
         LR    RE,R1               SAVE DSPL IN 4 BYTE TABLE                    
*                                                                               
         LA    R1,MYDOLS(R1)       POINT TO DOLLAR TABLE ENTRY                  
         L     R0,0(R1)                                                         
         A     R0,GROSS                                                         
         ST    R0,0(R1)                                                         
*                                                                               
         AHI   R1,MYTAX-MYDOLS     POINT TO TAX TABLE ENTRY                     
         L     R0,0(R1)                                                         
         A     R0,TAX                                                           
         ST    R0,0(R1)                                                         
*                                                                               
         SRL   RE,2                ADJUST FOR 1 BYTE SPOT ENTRIES               
         LA    R1,BHSPTS(RE)                                                    
         LLC   R0,0(R1)                                                         
         A     R0,SPOTS                                                         
*                                                                               
         CLI   PDXCOSTS,C'Y'       TEST REPORTING COST                          
         JNE   POSTIT8             NO - IGNORE COST OVERRIDES                   
         TM    6(R4),X'20'         TEST COST OVERRIDE THIS SPOT                 
         JO    POSTIT10            YES - DON'T COUNT HERE                       
*                                                                               
POSTIT8  STC   R0,0(R1)                                                         
         J     POSTITX                                                          
                                                                                
*=================================================================              
* FIND THIS COST IN THE COVTAB OR ADD IT IF THERE'S ROOM                        
*=================================================================              
                                                                                
         USING REGELEM,R4                                                       
POSTIT10 LA    R1,COVTAB                                                        
         LHI   R0,(COVTABX-COVTAB)/L'COVTAB                                     
         SR    RF,RF                                                            
         ICM   RF,7,RPCOST         GET GROSS COST THIS SPOT                     
         JNZ   *+8                                                              
         O     RF,=X'00800000'     SET SPECIAL VALUE FOR ZERO                   
         DROP  R4                                                               
*                                                                               
POSTIT12 OC    0(3,R1),0(R1)       TEST ENTRY PRESENT                           
         JZ    POSTIT14                                                         
         CLM   RF,7,0(R1)          MATCH COST                                   
         JE    POSTIT14                                                         
         AHI   R1,L'COVTAB                                                      
         JCT   R0,POSTIT12                                                      
         DC    H'0'                NO MORE ROOM IN TABLE !                      
***NOP   J     POSTITX             NO MORE ROOM IN TABLE !                      
*                                                                               
POSTIT14 STCM  RF,7,0(R1)          SET COST IN COVTAB ENTRY                     
         LA    R1,3(R1,RE)         POINT TO WEEK IN COVTAB ENTRY                
         LLC   R0,0(R1)                                                         
         A     R0,SPOTS                                                         
         STC   R0,0(R1)                                                         
*                                                                               
POSTITX  J     EXIT                                                             
         EJECT                                                                  
*===============================================================                
* EXTRACT DEMO VALUES TO TSAR RECORD                                            
*===============================================================                
*                                                                               
GETDEMS  NTR1                                                                   
         L     R4,AIO5                                                          
         MVI   ELCDLO,NDCORGQ      X'02' ORIGINAL DEMO ELEMENT                  
         MVI   ELCDHI,NDCORGQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
*                                                                               
         SR    R2,R2                                                            
         ICM   R2,3,NUMDEMS                                                     
         JZ    EXIT                                                             
         LA    R3,ESTDEMOS         POINT TO CURRENT DEMO LIST                   
         LA    R1,BHDEMS                                                        
*                                                                               
GETD02   OC    0(3,R3),0(R3)       TEST THERE IS A DEMO THERE                   
         JZ    EXIT                NO                                           
*                                                                               
         BRAS  RE,FINDDEM          FIND DEMO ENTRY IN NDELEM                    
         JNE   GETD20               NOT FOUND                                   
         MVC   0(8,R1),0(RF)                                                    
*                                                                               
         MVC   BYTE,1(R1)          SAVE NIELSEN DEMO TYPE                       
         LLC   RF,2(R1)                                                         
         ICM   RF,B'0010',0(R1)    BYTE1&3 ZERO, NON-TRADITIONAL?               
         LTR   RF,RF               HAVE NON-TRADITIONAL DEMO CAT?               
         JNZ   GETD05               NO, HAVE TRADITIONAL                        
*                                                                               
         LLC   RF,1(R1)            GET INDEX                                    
         L     RE,AESTREC                                                       
         LA    RE,ENONTDMS-ESTHDR(RE)  RE=A(START OF NONTRAD DEMO LIST)         
         SHI   RF,1                SUB 1 FROM INDEX                             
         MHI   RF,L'ENONTDMS       MULTIPLE * LENGTH OF ENTRY                   
         AR    RF,RE               ADD OFFSET TO START OF LIST                  
         LA    RE,20*L'ENONTDMS(RE)                                             
         CR    RF,RE               BEYOND LIST?                                 
         JNL   GETD20               YES, SKIP IT                                
         MVC   BYTE,0(RF)          SAVE COMSCORE DEMO TYPE                      
*                                                                               
GETD05   DS    0H                                                               
         CLI   SVMED,C'R'          MEDIA R?                                     
         JE    GETD15               ALWAYS USE 1-DEC RATS&IMPS                  
*                                                                               
         CLI   SVMED,C'X'          MEDIA X?                                     
         JNE   GETD07                                                           
         CLI   BYTE,C'R'           IF RATING OR                                 
         JE    GETD12                                                           
         CLI   BYTE,C'E'           OR EXTENDED RATING                           
         JE    GETD12               THEN, USE 2-DEC RATS                        
         J     GETD15               ELSE, USE 1-DEC IMPS                        
*                                                                               
GETD07   CLI   SVMED,C'T'          MEDIA T?                                     
         JNE   *+2                                                              
         L     RF,LP_ATWA                                                       
         USING TWAD,RF                                                          
         LA    RE,SVS002DP         RE=A(00 PROFILE 2-DEC PREC RATS)             
*                                                                               
         CLI   BYTE,C'R'           IF RATING                                    
         JE    GETD10               YES, CHECK 00 2-DEC RATS PROF               
         CLI   BYTE,C'E'           OR EXTENDED RATING                           
         JE    GETD10               YES, CHECK 00 2-DEC RATS PROF               
*                                  ELSE,                                        
         LA    RE,SVS00A2DI        RE=A(00 PROFILE 2-DEC PREC IMPS)             
         DROP  RF                                                               
*                                                                               
GETD10   CLI   0(RE),C'Y'          USING 2-PLACE PREC DEMO VALUES?              
         JNE   GETD15              NO                                           
*                                   YES, SEE IF WE HAVE TO CONVERT              
* AGENCY USES 2-DEC RATINGS / 2-DEC IMPRESSIONS                                 
                                                                                
GETD12   TM    4(R1),X'40'         TEST 2-DEC VALUE                             
         JO    GETD20                                                           
         L     RF,4(R1)            CONVERT 1-DEC VALUE TO 2-DEC                 
         N     RF,=X'3FFFFFFF'     DROP FLAGS                                   
         M     RE,=F'10'                                                        
         O     RF,=X'40000000'                                                  
         TM    4(R1),X'80'                                                      
         JZ    *+8                                                              
         O     RF,=X'80000000'                                                  
         ST    RF,4(R1)                                                         
         J     GETD20                                                           
                                                                                
* AGENCY USES 1-DEC RATINGS / 1-DEC IMPRESSIONS                                 
                                                                                
GETD15   TM    4(R1),X'40'         TEST 2-DEC VALUE                             
         JZ    GETD20                                                           
*                                                                               
         L     RF,4(R1)            CONVERT 2-DEC TO 1-DEC                       
         N     RF,=X'3FFFFFFF'     DROP FLAGS                                   
         M     RE,=F'2'                                                         
         D     RE,=F'10'                                                        
         AHI   RF,1                                                             
         SRL   RF,1                                                             
         TM    4(R1),X'80'         TEST OVERRIDE                                
         JZ    *+8                                                              
         O     RF,=X'80000000'                                                  
         ST    RF,4(R1)                                                         
*                                                                               
GETD20   AHI   R3,3                                                             
         LA    R1,8(R1)                                                         
         JCT   R2,GETD02                                                        
         J     EXIT                                                             
*                                                                               
FINDDEM  LLC   R0,1(R4)                                                         
         AHI   R0,-(NDEMNO-NDELEM)                                              
         SRL   R0,3                COUNT OF DEMOS IN DEMEL                      
         LA    RF,24(R4)           RF = A(NDEMNO)                               
*                                                                               
FINDDEM2 CLC   0(3,R3),0(RF)                                                    
         BER   RE                  RETURN WITH CC EQ                            
         AHI   RF,8                                                             
         JCT   R0,FINDDEM2                                                      
         LTR   RE,RE               SET CC NEQ                                   
         BR    RE                                                               
         EJECT                                                                  
*=================================================================              
* FIND BUY COMMENTS AND ADD TSAR RECORDS FOR THEM                               
*=================================================================              
DOBUYCOM NTR1  BASE=*,LABEL=*                                                   
         MVI   BHISSEQ,BHCOMQ      SET BASE X'30' SEQNUM FOR COMMENTS           
*                                                                               
         MVI   ELCDLO,CMCODEQ      X'66' - BUY COMMENT                          
         MVI   ELCDHI,CMCODEQ                                                   
         L     R4,AIO5                                                          
         CLI   0(R4),0             TEST BUY RECORD PRESENT                      
         JE    EXIT                NO - GET OUT                                 
         LA    R4,BDELEM-BUYREC(R4)                                             
*                                                                               
DOCOM2   BRAS  RE,NEXTEL                                                        
         JNE   EXIT                                                             
*                                                                               
         CLC   3(2,R4),=C'X-'      THESE COMMENTS NEVER PRINT                   
         JE    DOCOM2                                                           
*                                                                               
         CLI   PD2COMCT,C'0'                                                    
         JE    DOCOM6                                                           
         CLI   PD2COMCT,C'1'       TEST PRINT ACCTG COMMENTS ONLY               
         JNE   DOCOM4                                                           
         CLI   3(R4),C'$'          TEST COMMENT BEGINS WITH $                   
         JE    DOCOM6                                                           
         CLI   2(R4),4             TEST COMMENT NUMBER 4                        
         JE    DOCOM6                                                           
         CLI   2(R4),5             OR 5                                         
         JE    DOCOM6                                                           
         J     DOCOM2                                                           
*                                                                               
DOCOM4   CLC   =C'COMMENT-',3(R4)  PRINT COMMENT- COMMENTS                      
         JNE   DOCOM2                                                           
*                                                                               
DOCOM6   MVC   BHCOM,SPACES                                                     
         LLC   RE,1(R4)                                                         
         AHI   RE,-4               SET FOR EXE                                  
         MVC   BHCOM(0),3(R4)         MOVE COMMENT                              
         EX    RE,*-6                                                           
*                                                                               
         AHI   RE,BUYHKEYH+1                                                    
         STH   RE,BHISLEN                                                       
         GOTOR BUFFER,DMCB,('TSAADD',0)                                         
*                                                                               
         LLC   R0,BHISSEQ          SET SEQUENCE NUMBER                          
         AHI   R0,1                                                             
         STC   R0,BHISSEQ                                                       
         J     DOCOM2                                                           
         EJECT                                                                  
*                                                                               
***********************************************************************         
* TIME TO READ THE BUYS                                                         
***********************************************************************         
PRTBUYS  NTR1  BASE=*,LABEL=*                                                   
         J     PRBY010                                                          
*                                                                               
PRBLINE  LR    R0,RE                                                            
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
PRBY010  L     RE,AIO8             SAVE THE LIST OF BUYLINES USED IO8           
         LHI   RF,IO8LQ                                                         
         XCEFL                                                                  
*                                                                               
         L     RE,AIO7             CLEAR OUT IO7 FOR MAKEGOODS                  
         LHI   RF,IO7LQ                                                         
         XCEFL                                                                  
*                                                                               
         MVC   SV1OR2,SAVE1OR2                                                  
         CLC   LP_AGY,=C'SJ'                                                    
         JNE   PRBY012                                                          
         CLC   QCLTA,=C'TBL'                                                    
         JE    *+10                                                             
         CLC   QCLTA,=C'PG0'                                                    
         JE    *+10                                                             
         CLC   QCLTA,=C'PG1'                                                    
         JNE   PRBY012                                                          
         MVI   SV1OR2,2                                                         
*                                                                               
PRBY012  MVI   ANYFLAG1,0          CLEAR PRESENCE OF ANY FLAG                   
*                                                                               
*        XC    IOKEY,IOKEY                                                      
*        MVC   IOKEY(ORDXBKYL),ORXAGM  (NOT NEEDED)                             
         XC    SVNETWRK,SVNETWRK                                                
         MVC   SVBUYKEY,ORXAGM                                                  
*                                                                               
         MVI   LP_RMODE,LP_RFRST                                                
*                                                                               
PRBY020  GOTOR (#NXTREC,ANXTREC),DMCB,('YESQ',BUYKEYT),('B#BUYREC',0), *        
               SAVED,AFLTBKY,AFLTBRD                                            
         JNE   PRBY300                                                          
***************                                                                 
* WE CAN PROCESS THE BUY NOW                                                    
***************                                                                 
         MVI   PR1TIMSH,0          0 MEANS USE BDTIME                           
*********                                                                       
* BRAND-POL BUY                                                                 
*********                                                                       
         MVI   BYTE2,C'N'          NO SPOTS FOUND                               
         L     R5,AIO5                                                          
         USING BUYREC,R5                                                        
PRBY030  SR    R0,R0               USE ANY SPOTS THAT MATCH                     
         LA    R4,BDELEM                                                        
*                                                                               
PRBY040  CLI   0(R4),0             NO MORE POOL ORIGINAL ELEMS?                 
         JNE   PRBY050             NO, GOT MORE                                 
         TM    MISCFLG1,MF1DRREV   DOING ORDER REVISION?                        
         JZ    PRBY020             NO, CHECK NEXT BUY RECORD                    
*                                                                               
         CLI   BUYKSTA,X'E8'       CABLE?                                       
         JL    PRBY045              NO                                          
         CLI   BYTE2,C'N'          ANY SPOTS FOUND ON BUYLINE?                  
         JE    PRBY070              NO, SEND IT                                 
         B     PRBY047                                                          
*                                                                               
PRBY045  SR    RF,RF               CHECK IF THIS BUY IS ONE OF OUR              
         LLH   RE,BUYKBUY           ORIGINAL WE SENT OVER FIRST TIME            
         BCTR  RE,0                                                             
         SRDL  RE,3                                                             
         LA    RE,BUYLINS(RE)                                                   
         SRL   RF,5                                                             
         STCM  RF,8,BYTE                                                        
*                                                                               
         LA    R0,X'80'                                                         
         LLC   R1,BYTE                                                          
         SRL   R0,0(R1)                                                         
         STC   R0,HALF                                                          
*                                                                               
         NC    HALF(1),0(RE)                                                    
         JNZ   PRBY070             ONE OF THE ORIGINAL BUYLINES                 
PRBY047  OC    BDMGDATE,BDMGDATE   IS THIS MAKING GOOD SOEMTHING?               
         JNZ   PRBY070             YES, THIS LINE IS IMPORTANT                  
         J     PRBY020             NO, THEN WHO CARES                           
         DROP  R5                                                               
*                                                                               
PRBY050  CLI   0(R4),X'0B'         POOL ORIGINAL ELEM?                          
         JE    *+12                                                             
         CLI   0(R4),X'0C'         POOL OTO ELEM?                               
         JNE   PRBY060             NO, CHECK NEXT ELEMENT                       
*                                                                               
         MVI   BYTE2,C'Y'          SPOTS FOUND                                  
         BRAS  RE,CHKPOLEL         ONE THAT MATCHES ORDER?                      
         JE    PRBY070             YES                                          
         DC    X'0700'             WHY IS THERE A NOP HERE?                     
*                                                                               
PRBY060  LLC   R0,1(R4)            CHECK NEXT ELEMENT                           
         AR    R4,R0                                                            
         J     PRBY040                                                          
         EJECT                                                                  
*********                                                                       
* DOES THIS BUY HAVE ANY SPOTS?                                                 
*********                                                                       
PRBY070  SR    R0,R0                                                            
         L     R4,AIO5                                                          
         USING BUYKEY,R4                                                        
         LA    R4,BDELEM                                                        
*                                                                               
         USING REGELEM,R4                                                       
PRBY080  CLI   0(R4),0             NO MORE POOL ORIGINAL ELEMS?                 
         JNE   PRBY090             NO, GOT MORE                                 
         TM    MISCFLG1,MF1DRREV   DOING ORDER REVISION?                        
         JZ    PRBY020             NO, CHECK NEXT BUY RECORD                    
         J     PRBY140                                                          
*                                                                               
PRBY090  CLI   0(R4),RCORGQ        X'06' - ORIGINAL ELEM?                       
         JE    PRBY100                                                          
         CLI   0(R4),RCOTOQ        X'07' - OTO ELEM?                            
         JE    PRBY100                                                          
         CLI   0(R4),RCPOLOQ       X'0B' - POOL ORIGINAL ELEM?                  
         JE    PRBY100                                                          
         CLI   0(R4),RCPOTOQ       X'0C' - POOL OTO ELEM?                       
         JNE   PRBY110             NO, CHECK NEXT ELEMENT                       
*                                                                               
PRBY100  TM    RSTATUS,RSMINUSQ+RSMINSDQ  MINUS OR MINUSED SPOT?                
         JNZ   PRBY110             YES, NOT AN ACTUAL SPOT                      
         TM    FLTRCFLG,FRFEXIST   NO, DOING AN ORDER W/ FLIGHT?                
         JZ    PRBY120                 NO, NORMAL ORDER                         
         GOTOR VDATCON,DMCB,(3,SVFLTSDT),(2,FULL)                               
         GOTOR VDATCON,DMCB,(3,SVFLTEDT),(2,FULL+2)                             
         CLC   RDATE,FULL                                                       
         JL    PRBY110                                                          
         CLC   RDATE,FULL+2                                                     
         JNH   PRBY120                                                          
*                                                                               
PRBY110  LLC   R0,1(R4)            CHECK NEXT ELEMENT                           
         AR    R4,R0                                                            
         J     PRBY080                                                          
         DROP  R4                                                               
*********                                                                       
* WE'RE GOING TO USE THIS RECORD                                                
*********                                                                       
PRBY120  L     R4,AIO5                                                          
         USING BUYREC,R4                                                        
*                                                                               
         CLI   BUYKSTA,X'E8'       CABLE?                                       
         BNL   PRBY140             YES, ORDLIN DOES NOT SUPPORT NETWORK         
*                                    SO WE CANNOT SAVE LINE NUMBERS             
*                                                                               
         MVC   HALF,BUYKBUY        SAVE THE LINE NUMBER                         
         L     RE,AIO8             STORE BUYLINE IN OUR LIST FOR LATER          
PRBY130  OC    0(2,RE),0(RE)                                                    
         JZ    *+12                                                             
         LA    RE,3(RE)            3 BYTES = 2 BT BLINE + 1 BT STATUS           
         J     PRBY130                                                          
         MVC   0(2,RE),HALF                                                     
*                                                                               
         CLI   HALF,0              HAVE TWO BYTE BUYLINE?                       
         JE    *+8                                                              
         OI    ANYFLAG1,AF1HTBL                                                 
         DROP  R4                                                               
*                                                                               
PRBY140  L     R4,AIO5                                                          
         USING BUYREC,R4                                                        
         CLI   BUYKSTA,X'E8'       CABLE?                                       
         BL    PRBY145             NO                                           
         LA    R1,BUYKSTA                                                       
         BRAS  RE,GETQSTA                                                       
         MVI   STAPACT,C'X'        CONVERT DDS 3 TO NIELSEN 4                   
         GOTOR VSTAPACK,STAPACKD                                                
*                                                                               
         CLC   SVNETWRK,STAPQSTA   ALREADY SENT BUYNWK?                         
         BE    PRBY145             - YES                                        
*                                  - NO                                         
         MVC   SVNETWRK,STAPQSTA    SAVE 4 CHAR NIELSEN NETWORK CODE            
         LA    R2,PW                                                            
         USING PBUYNWKD,R2                                                      
         MVC   PBNWTID,=C'BUYNWK'                                               
         MVC   PBNWORDR,SVQORDER                                                
         MVC   PBNWNTWK,SVNETWRK                                                
         BRAS  RE,PRBLINE                                                       
*                                                                               
PRBY145  L     R4,AIO5                                                          
         USING BUYREC,R4                                                        
         MVC   HALF,BUYKBUY        SAVE THE LINE NUMBER                         
         MVI   ELCDLO,BDCODEQ      R4 = A(X'01' BUY DESCRIPTION ELEM)           
         MVI   ELCDHI,BDCODEQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
*                                                                               
         USING BDELEM,R4                                                        
         LA    R2,PW                                                            
         USING PBUYHDRD,R2                                                      
*                                                                               
         GOTOR GTMYRATE,DMCB,(0,0)                                              
         L     R1,GROSS            GROSS DOLLARS                                
         L     R0,TAX              TAXED DOLLARS                                
         SR    R1,R0                                                            
         STCM  R1,15,SVBDCOST      GROSS-TAX                                    
         MVC   SVBDNOWK,BDNOWK     PER WEEK FOR LATER                           
*                                                                               
         MVC   PBHDTID,=C'BUYHDR'                                               
         MVC   PBHDORDR,SVQORDER                                                
         EDIT  (B2,HALF),(4,PBHDBLIN),0,FILL=0                                  
*********                                                                       
         OC    BDMGDATE,BDMGDATE   ANY MAKEGOOD GROUP CODE?                     
         JZ    PRBY190             NONE                                         
         TM    MISCFLG1,MF1DRREV   DOING DARE REVISIONS?                        
         JZ    PRBY220                                                          
*                                                                               
         LA    R1,JDSREPS          DETERMINE IF WE HAVE A JDS REP               
PRBY150  CLI   0(R1),0                                                          
         JE    PRBY160                                                          
         CLC   0(L'JDSREPS,R1),SVDESTID                                         
         JE    PRBY220             YES, THEY DON'T WANT MAKEGOOD LINK           
         LA    R1,L'JDSREPS(R1)                                                 
         J     PRBY150                                                          
*                                                                               
       ++INCLUDE SPDARJDSRP                                                     
*                                                                               
PRBY160  OC    SVNETWRK,SVNETWRK   CABLE?                                       
         BNZ   PRBY220                                                          
                                                                                
         L     RE,AIO7                                                          
PRBY170  CLI   0(RE),0                                                          
         JE    PRBY190                                                          
         CLC   1(2,RE),BDMGDATE    MATCHES ALPHA MAKEGOOD CODE?                 
         JE    PRBY180             YES, SHOW BUYLINE MAKEGOOD IS FOR            
         LA    RE,3(RE)                                                         
         L     R1,AIO7                                                          
         AHI   R1,IO7LQ                                                         
         CR    RE,R1                                                            
         JL    PRBY170                                                          
         DC    H'0'                                                             
*                                                                               
PRBY180  MVC   BYTE,0(RE)                                                       
         EDIT  (B1,BYTE),(3,PBHDMGBL),FILL=0                                    
         J     PRBY220                                                          
*********                                                                       
* NOT A MAKEGOOD BUY, LOOK TO SEE IF SENDING A DARE BONUS BUYLINE               
*********                                                                       
PRBY190  TM    MISCFLG1,MF1DRREV   DOING DARE REVISIONS?                        
         J     PRBY220         *** DO NOT SEND THE BONUS FLAG!! ***             
         SR    R1,R1                                                            
         L     RE,AIO5             LOOK AT THE BUY                              
         LA    RE,24(RE)                                                        
PRBY200  CLI   0(RE),0             ANY DARE MAKEGOOD TRACE ELEMENT?             
         JE    PRBY220                                                          
         CLI   0(RE),BDARCODQ      X'9E'                                        
         JE    PRBY210             THIS LINE MUST BE A BONUS FROM DARE          
         IC    R1,1(RE)                                                         
         AR    RE,R1                                                            
         J     PRBY200                                                          
*                                                                               
PRBY210  MVI   PBHDMGBL,C'B'       LET SELLER KNOW BONUS                        
*********                                                                       
PRBY220  GOTOR SHWDAYS,DMCB,(BDDAY,PBHDROTN)                                    
*                                                                               
         CLI   BDSEDAY,0           =====> ACCORDING TO MEL <=====               
         JNE   PRBY230             USE BDXMDAY'S START DAY # UNLESS 0           
         GOTOR VDATCON,DMCB,(3,BDSTART),(0,DUB)   OTHERWISE USE START           
         GOTOR VGETDAY,DMCB,(0,DUB),FULL          DAY'S DAY #                   
         MVC   BYTE,0(R1)                                                       
         J     PRBY240                                                          
*                                                                               
PRBY230  LLC   R1,BDSEDAY                                                       
         SRL   R1,4                                                             
         STC   R1,BYTE                                                          
*                                                                               
PRBY240  EDIT  (B1,BYTE),(1,PBHDRSDT)     OUT-OF-WEEK ROTATOR                   
*                                                                               
         MVI   PBHDSTYP,C'W'                                                    
         TM    ESTFLAG1,ESTDAILY   IS ESTIMATE DAILY SHEDULE?                   
         JO    PRBY245             YES, SET BUYLINES AS DAILY EVEN THO          
*                                  BUYLINES MAY BE WEEKLY (DUE TO BUG)          
*                                                                               
         TM    BDSTAT2,X'80'       DAILY SCHEDULE IN BUY?                       
         JZ    *+8                                                              
PRBY245  MVI   PBHDSTYP,C'D'                                                    
*                                                                               
         OC    BDTIMST,BDTIMST                                                  
         JNZ   *+14                                                             
         MVC   PBHDSTIM,EZEROS                                                  
         J     PRBY250                                                          
*                                                                               
         ZICM  R3,BDTIMST,2                                                     
         CHI   R3,600                                                           
         JNL   *+8                                                              
         AHI   R3,2400                                                          
         EDIT  (R3),(4,PBHDSTIM),FILL=0                                         
*                                                                               
PRBY250  OC    BDTIMEND,BDTIMEND                                                
         JNZ   *+14                                                             
*****    MVC   PBHDETIM,EZEROS                                                  
         MVC   PBHDETIM,PBHDSTIM    <=== FOR THOSE OTHER SYSTEMS                
         J     PRBY260                                                          
*                                                                               
         ZICM  R3,BDTIMEND,2                                                    
         CHI   R3,600                                                           
         JNL   *+8                                                              
         AHI   R3,2400                                                          
         EDIT  (R3),(4,PBHDETIM),FILL=0                                         
*                                                                               
PRBY260  EDIT  (B1,BDSEC),(3,PBHDTSLN),FILL=0                                   
*                                                                               
         MVI   PBHDLUNT,C'S'                                                    
*                                                                               
         MVC   PBHDPGNM(L'BDPROGRM),BDPROGRM                                    
         EDIT  (B4,SVBDCOST),(9,PBHDCOST),FILL=0                                
*                                                                               
         MVI   PBHDCSQL,C'C'       COMMISSION ONLY                              
         TM    BDCIND2,X'80'                                                    
         JO    PRBY270                                                          
         MVI   PBHDCSQL,C' '       GROSS                                        
         TM    BDCIND,X'20'                                                     
         JO    PRBY270                                                          
         MVI   PBHDCSQL,C'F'       FEE                                          
         TM    BDCIND,X'80'                                                     
         JO    PRBY270                                                          
         MVI   PBHDCSQL,C'Q'       Q-RATE                                       
         TM    BDCIND,X'40'                                                     
         JO    PRBY270                                                          
         MVI   PBHDCSQL,C'N'       17.65 NET                                    
         TM    BDCIND,X'10'                                                     
         JO    PRBY270                                                          
         MVI   PBHDCSQL,C'V'       15.00 NET                                    
         TM    BDCIND,X'08'                                                     
         JO    PRBY270                                                          
         MVI   PBHDCSQL,C'S'       SPECIAL - NO COMMISSION                      
         TM    BDCIND,X'04'                                                     
         JO    PRBY270                                                          
         MVI   PBHDCSQL,C'X'       X RATE - 10% COMMISSION                      
         TM    BDCIND,X'02'                                                     
         JO    PRBY270                                                          
         MVI   PBHDCSQL,C'P'                                                    
*                                                                               
PRBY270  MVC   BYTE,PR1TIMSH       COPY PRODUCT 1 TIME SHARE                    
         CLI   PR1TIMSH,0          USE BDTIME?                                  
         JNE   PRBY280                                                          
         CLI   BDTIME,0                         ANY PRODUCT TIME SHARE?         
         JE    PRBY290                                                          
         MVC   BYTE,BDTIME                                                      
PRBY280  EDIT  (B1,BYTE),(3,PBHDTMSH),FILL=0  YES                               
*                                                                               
PRBY290  BRAS  RE,PRBLINE                                                       
         XC    BDNTAX,BDNTAX       IGNORE ANY TAX                               
         DROP  R2,R4                                                            
************************************************************                    
* HANDLE BUY DEMOS                                                              
************************************************************                    
PBDEM00  DS    0H                                                               
         NI    ANYFLAG1,X'FF'-AF1NTRDM  WE DON'T HAVE NON-TRAD DEMO YET         
         OC    NUMDEMS,NUMDEMS          HAVE ANY DEMOS TO SEND?                 
         JZ    PBDEMX                   NO                                      
*                                                                               
         L     R4,AIO5                  R4= A(BUY RECORD)                       
         MVI   ELCDLO,NDCORGQ           X'02' DEMO ELEMENT                      
         MVI   ELCDHI,NDCORGQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   PBDEMX                   NO DEMO VALUES                          
*                                                                               
DM2      USING PBUYDV2D,PW                                                      
         MVC   DM2.PBDV2TID,=C'BUYDV2'  TRANSMISSION ID                         
         TM    REPSTAT,X'02'            XML RADIO?                              
         JZ    *+10                      NO, PROCESS AS DARE                    
         MVC   DM2.PBDV2TID,=C'BUYDEM'   YES, REDI ONLY SUPPORTS BUYDEM         
         MVC   DM2.PBDV2ORDR,SVQORDER   ORDER NUMBER                            
*                                                                               
CDV      USING PBUYCDVD,PW2                                                     
         MVC   CDV.PBCDVTID,=C'BUYCDV'  TRANSMISSION ID                         
         MVC   CDV.PBCDVORDR,SVQORDER   ORDER NUMBER                            
*                                                                               
         LA    R2,ESTDEMOS              R2= A(1ST ORDER DEMOS TO SEND)          
         LR    RE,R4                    RE= A(BUYLINE'S DEMO ELEM)              
         LA    R4,L'EDEMLIST            R4= L(SINGLE EST DEMO CAT)              
         LLH   RF,NUMDEMS               RF= # OF DEMOS TO SEND                  
         MHI   RF,L'EDEMLIST                                                    
         LA    R5,ESTDEMOS-1(RF)        R5=A(END OF ORD DEMOS TO SEND)          
*                                                                               
         DO JXLE,FROM=(R2),TO=(R5),BY=(R4) GO THROUGH ESTDEMOS                  
           DOEXIT (OC,0(3,R2),0(R2),Z)     UNTIL NO MORE DEMOS TO SEND          
           LLC   RF,1(RE)                                                       
           AR    RF,RE                  RF=A(ELEM AFTER DEMO ELEM)              
           LA    R3,NDEMNO-NDELEM(RE)   R3=A(BUYLINE DEMO ELEM)                 
           XC    FULL,FULL                                                      
*                                                                               
           DO WHILE=(CR,R3,LT,RF)                                               
             IF (CLC,0(L'NDEMNO,R2),EQ,0(R3))   SAME DEMO TYPE AND #?           
               MVC   FULL,4(R3)         MOVE IN DEMO VALUE                      
               NI    FULL,X'3F'         GET RID OF OVR AND 2 DEC BITS           
               ASMLEAVE ,                                                       
             ENDIF ,                                                            
             LA    R3,NDEMLNQ(R3)                                               
           ENDDO ,  WHILE=(CR,R3,LT,RF)                                         
*                                                                               
           LR    R0,RE                  SAVE RE                                 
           IF (TM,REPSTAT,X'02',O)      PROCESS XML RADIO ORDER?                
             BRAS RE,STBDEMVL            YES, UPDATE BUYDEM                     
           ELSE ,                                                               
             IF (CLI,2(R2),NE,0)        HAVE TRAD DEMO CATEGORY?                
               BRAS  RE,STBDM2VL        YES, UPDATE BUYDV2                      
             ELSE ,                     NO                                      
               OI    ANYFLAG1,AF1NTRDM  SET NT-DEM FLAG FOR LATER               
               BRAS  RE,STBCDVVL        UPDATE BUYCDV                           
             ENDIF ,                                                            
           ENDIF ,                                                              
           LR    RE,R0                  RESTORE RE                              
         ENDDO ,  JXLE,FROM=(R2),TO=(R5),BY=(R4)                                
*                                                                               
         IF (TM,ANYFLAG1,AF1NTRDM,O)    HAVE NON-TRAD DEMO?                     
           MVI   REPPRNTN,2             YES, SET # OF PRINT LINES TO 2          
         ENDIF ,                                                                
         BRAS  RE,PRBLINE                                                       
         MVI   REPPRNTN,1               RESET PRINT LINES BACK TO 1             
PBDEMX   J     PRBOR00                                                          
*                                                                               
***************************************                                         
* SET DEMO VALUE IN BUYDEM                                                      
*  IMPLICIT 1 DECIMAL PRECISION FOR BOTH RATINGS AND IMPRESSIONS                
***************************************                                         
DEM      USING PBUYDEMD,PW                                                      
STBDEMVL NTR1  ,                          R3= A(DEMO IN X'02' ELEM)             
         LA    R2,DEM.PBDMVAL             R2= A(1ST DEMOCAT ON PRTLN)           
         LA    R5,DEM.PBUYDEMD+PBUYDEML-1 R5= A(END DEMOCAT ON PRTLN)           
         LA    R4,L'PBDMVAL                R4= L'(DEMO CAT ON PRTLN)            
         LA    R1,10                                                            
*                                                                               
         DO JXLE,FROM=(R2),TO=(R5),BY=(R4)                                      
           IF (CLC,0(L'PBDMVAL,R2),NH,SPACES)                                   
             IF (OC,FULL,FULL,NZ)         IF NON-ZERO VALUE THEN                
               IF (TM,4(R3),X'40',O)    IF WE HAVE 2 DEC RTG VALUE              
                 XR    RE,RE                                                    
                 L     RF,FULL          ADJUST TO APPEAR                        
                 DR    RE,R1            AS 1 DEC VALUE (DIV BY 10)              
                 ST    RF,FULL                                                  
               ENDIF ,                                                          
             ENDIF ,                                                            
             EDIT  (B4,FULL),(L'PBDMVAL,0(R2)),ALIGN=RIGHT,FILL=0               
             ASMLEAVE ,                                                         
           ENDIF ,                                                              
         ENDDO ,                                                                
         J     EXIT                                                             
         DROP  DEM                                                              
*                                                                               
***************************************                                         
* SET DEMO VALUE IN BUYDV2                                                      
*  IMPLICIT 2 DECIMAL PRECISION FOR BOTH RATINGS AND IMPRESSIONS                
***************************************                                         
DM2      USING PBUYDV2D,PW                                                      
STBDM2VL NTR1  ,                          R3= A(DEMO IN X'02' ELEM)             
         LA    R2,DM2.PBDV2VAL            R2= A(1ST DEMOCAT ON PRTLN)           
         LA    R5,DM2.PBUYDV2D+PBUYDV2L-1 R5= A(END DEMOCAT ON PRTLN)           
         LA    R4,L'PBDV2VAL               R4= L'(DEMO CAT ON PRTLN)            
*                                                                               
         DO JXLE,FROM=(R2),TO=(R5),BY=(R4)                                      
           IF (CLC,0(L'PBDV2VAL,R2),NH,SPACES)                                  
             IF (OC,FULL,FULL,NZ)         IF NON-ZERO VALUE THEN                
*NOP BUYDV2*   IF (CLI,1(R3),EQ,C'R')     RATING CATEGORY?                      
               IF (TM,4(R3),X'40',Z)    IF WE HAVE 1 DEC RTG VALUE              
                 L     RF,FULL          ADJUST TO APPEAR                        
                 MHI   RF,10            AS 2 DEC RTG VALUE                      
                 ST    RF,FULL                                                  
               ENDIF ,                                                          
*NOP BUYDV2*   ENDIF ,                                                          
             ENDIF ,                                                            
             EDIT  (B4,FULL),(L'PBDV2VAL,0(R2)),ALIGN=RIGHT,FILL=0              
             ASMLEAVE ,                                                         
           ENDIF ,                                                              
         ENDDO ,                                                                
         J     EXIT                                                             
         DROP  DM2                                                              
*                                                                               
***************************************                                         
* SET DEMO VALUE IN BUYCDV                                                      
*  EXPLICIT 4 DECIMAL PRECISION                                                 
***************************************                                         
STBCDVVL NTR1  ,                          R3= A(DEMO IN X'02' ELEM)             
         LA    R2,CDV.PBCDVVAL1           R2= A(1ST DEMOCAT ON PRTLN)           
         LA    R5,CDV.PBUYCDVD+PBUYCDVL-1 R5= A(END DEMOCAT ON PRTLN)           
         LA    R4,L'PBCDVVAL1             R4= L'(DEMO CAT ON PRTLN)             
*                                                                               
         DO JXLE,FROM=(R2),TO=(R5),BY=(R4)                                      
           IF (CLC,0(L'PBCDVVAL1,R2),NH,SPACES)                                 
             IF (OC,FULL,FULL,NZ)         IF NON-ZERO VALUE THEN                
               L     R4,AIO5              R4= A(BUY RECORD)                     
               MVI   ELCDLO,NTDELCDQ      X'50' NON-TRAD DEMO ELEMENT           
               MVI   ELCDHI,NTDELCDQ                                            
               BRAS  RE,GETEL                                                   
               IF (EQ)                    IF NON-TRAD DEMO ELEM FOUND           
                 LLC   RF,1(R3)           GET NON-TRAD INDEX                    
                 BCTR  RF,0               DEC BY 1                              
                 LR    RE,RF              COPY THE VALUE                        
                 MHI   RE,L'ENONTDMS      MULT BY LENGTH OF ENTRY               
                 LA    R5,ESTNTDEM(RE)    R5= A(EST NT-DEMO NAME)               
                 MHI   RF,NTDDLEN         MULT BY LENGTH OF ENTRY               
                 LA    R4,NTDOVHDQ(R4,RF) R4= A(BUY NT-DEMO NAME)               
                 IF (CLC,0(L'NTDDMONM,R5),EQ,0(R4)) IF NAMES MATCH THEN         
                   LHI   R5,1000          SET DEFAULT ADJUST TO 1000            
*                                         FOR 1-DECIMAL PREC VALUES             
*NOP BUYDV2*       IF (CLI,0(R4),EQ,C'R') BUT IF RATING CATEGORY                
                   IF (TM,4(R3),X'40',O)  IF 2-DEC VALUE THEN                   
                     LHI   R5,100         ONLY ADJUST BY 100                    
                   ENDIF ,                                                      
*NOP BUYDV2*       ENDIF ,                                                      
                   SR    RE,RE            SETUP RE/RF FOR MULTIPLY              
                   L     RF,FULL                                                
                   MR    RE,R5            ADJUST PREC TO 4-DEC PREC             
                   ST    RF,FULL                                                
                 ELSE ,                   NO MATCH NON-TRAD DEMO NAME           
                   XC    FULL,FULL        PRINT 0'S                             
                 ENDIF ,                                                        
               ELSE ,                     BUY NON-TRAD ELEM NOT FOUND           
                 XC    FULL,FULL          PRINT 0'S                             
               ENDIF ,                                                          
             ENDIF ,                                                            
             EDIT  (B4,FULL),(L'PBCDVVAL1,0(R2)),4,ALIGN=RIGHT,FILL=0           
             ASMLEAVE ,                                                         
           ENDIF ,                                                              
         ENDDO ,                                                                
         J     EXIT                                                             
*                                                                               
*********                                                                       
* HANDLE THE BUY ORBITS                                                         
*********                                                                       
PRBOR00  L     R4,AIO5                                                          
         MVI   ELCDLO,X'67'        ORBIT DESC ELEMENT                           
         MVI   ELCDHI,X'67'                                                     
         BRAS  RE,GETEL                                                         
         JNE   PRBORX                                                           
*                                                                               
         GOTOR ,BINPARMS,,AIO6,0,PBUYORBL,PBORPGNM-PBORTID,10                   
         L     RE,AIO6             CLEAR OUT OUR BINSRCH TABLE                  
         LHI   RF,IO6LQ                                                         
         XCEFL                                                                  
*                                                                               
         LA    R2,PW                                                            
         USING PBUYORBD,R2                                                      
         USING ORBELEM,R4                                                       
         LLC   R3,ORBLEN                                                        
         SH    R3,=Y(ORBDAY-ORBELEM)                                            
         SRL   R3,4                R3 = NUMBER OF SHOWS                         
         LTR   R3,R3                                                            
         JZ    PRBORX              EXIT IF NONE                                 
*                                                                               
         LA    R4,ORBDAY                                                        
         USING ORBDAY,R4                                                        
*                                                                               
PRBOR10  MVC   PBORTID,=C'BUYORB'                                               
         MVC   PBORORDR,SVQORDER                                                
         MVI   PBORCONT,C'*'                                                    
         GOTOR SHWDAYS,DMCB,(ORBDAY,PBORROTN)                                   
         EDIT  (B1,SVOOWROT),(1,PBORRSDT)                                       
*                                                                               
         OC    ORBTIME(2),ORBTIME                                               
         JNZ   *+14                                                             
         MVC   PBORSTIM,EZEROS                                                  
         J     PRBOR20                                                          
*                                                                               
         ZICM  R1,ORBTIME,2                                                     
         CHI   R1,600                                                           
         JNL   *+8                                                              
         AHI   R1,2400                                                          
         EDIT  (R1),(4,PBORSTIM),FILL=0                                         
*                                                                               
PRBOR20  OC    ORBTIME+2(2),ORBTIME+2                                           
         JNZ   *+14                                                             
         MVC   PBORETIM,EZEROS                                                  
         J     PRBOR30                                                          
*                                                                               
         ZICM  R1,ORBTIME+2,2                                                   
         CHI   R1,600                                                           
         JNL   *+8                                                              
         AHI   R1,2400                                                          
         EDIT  (R1),(4,PBORETIM),FILL=0                                         
*                                                                               
PRBOR30  MVC   PBORPGNM(L'ORBDESC),ORBDESC                                      
*                                                                               
         GOTOR VBINSRCH,BINPARMS,(X'01',PBORTID)                                
*                                                                               
         LA    R4,16(R4)           R4 = A(NEXT ORBIT)                           
         MVC   PBORTID(PBUYORBL),SPACES                                         
         JCT   R3,PRBOR10                                                       
*****************************************                                       
* NOW WE CAN START PRINTING BUYORB'S (WE HAVE TO GO BACKWARDS THOUGH)           
*****************************************                                       
         L     R4,AIO6             R4 = A(FIRST ENTRY IN TABLE)                 
         L     R3,BINPARMS+8                                                    
         LR    RF,R3                                                            
         BCTR  RF,0                                                             
         MHI   RF,PBUYORBL                                                      
         AR    R4,RF               R4 = A(LAST ENTRY IN TABLE)                  
         J     *+8                                                              
PRBOR40  BRAS  RE,PRBLINE                                                       
         MVC   PBORTID(PBUYORBL),0(R4)                                          
         SHI   R4,PBUYORBL         R4 = A(NEXT ORBIT)                           
         JCT   R3,PRBOR40                                                       
*                                                                               
         MVI   PBORCONT,C' '                                                    
         BRAS  RE,PRBLINE                                                       
*                                                                               
PRBORX   DS    0H                                                               
         DROP  R2,R4                                                            
*********                                                                       
* HANDLE THE BUY COMMENTS                                                       
*********                                                                       
PRBCM00  LA    R2,PW                                                            
         USING PBUYCOMD,R2                                                      
*                                                                               
         CLI   PDARBCOM,C'N'       DEFAULT IS 'Y'                               
         JE    PRBCM50              DON'T PRINT BUY COMMENT BUT CHECK           
*                                   IF WE HAVE NON-TRAD DEMO TO PRINT           
         L     R4,AIO5                                                          
         MVI   ELCDLO,CMCODEQ      X'66' - BUY COMMENT ELEMENT                  
         MVI   ELCDHI,CMCODEQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   PRBCM50             NO BUY CMMNTS, MAYBE NON-TRAD DEMOS          
*                                                                               
         USING COMELEM,R4                                                       
PRBCM10  CLC   0(L'SPACES,R2),SPACES                                            
         JNH   *+8                                                              
         BRAS  RE,PRBLINE                                                       
*                                                                               
         MVC   PBCMTID,=C'BUYCOM'                                               
         MVC   PBCMORDR,SVQORDER                                                
         MVI   PBCMCONT,C'*'                                                    
         EDIT  (B1,CMNUM),(1,PBCMTEXT)                                          
         MVI   PBCMTEXT+1,C'-'                                                  
         LLC   R1,CMLEN                                                         
         SH    R1,=Y(CMDATA-COMELEM)                                            
         CHI   R1,68               MAKE SURE WE DON'T GO BEYOND 70 CHAR         
         JNH   *+8                                                              
         LHI   R1,68                                                            
         BCTR  R1,0                                                             
         MVC   PBCMTEXT+2(0),CMDATA                                             
         EX    R1,*-6                                                           
*                                                                               
         BRAS  RE,NEXTEL           ANY MORE ACTUAL BUY COMMENTS?                
         JE    PRBCM10             YES                                          
*                                  NO, WE MIGHT HAVE DEMO COMMENTS              
PRBCM50  TM    ANYFLAG1,AF1NTRDM   DO WE HAVE A NON-TRAD DEMO CATEGORY?         
         JZ    PRBCM80             NO                                           
*                                                                               
         BRAS  RE,DMOCMNTS         PROCESS NON-TRAD DEMOS AS COMMENTS           
*                                                                               
PRBCM80  DS    0H                                                               
         IF  (CLC,PBCMTID,EQ,=C'BUYCOM')  DO WE HAVE A COMMENT TO SHOW?         
           MVI   PBCMCONT,C' '       NO MORE COMMENTS AFTER THIS ONE            
           BRAS  RE,PRBLINE                                                     
         ENDIF                                                                  
*                                                                               
PRBCMX   DS    0H                                                               
         DROP  R2,R4                                                            
*                                                                               
*********                                                                       
* HANDLE THE BUY AUTOMATED AVAILS UUID                                          
*********                                                                       
         CLC   0(L'SPACES,R2),SPACES A LINE TO PRINT FROM BEFORE?               
         JH    *+2                    SOMETHING WRONG                           
*                                                                               
PRBAA00  LA    R2,PW                                                            
         USING PBUYAAUD,R2                                                      
*                                                                               
         L     R4,AIO5                                                          
         MVI   ELCDLO,AAVCODQ      X'7A' - AUTO-AVAIL UUID                      
         MVI   ELCDHI,AAVCODQ                                                   
         BRAS  RE,GETEL            HAVE AUTO-AVAIL UUID?                        
         JNE   PRBAAX               NO, SKIP BUYAAU                             
*                                                                               
         USING AAVELEM,R4                                                       
         CLC   SVREPCOD,AAVUUID    DOES AA-UID MATCH REP?                       
         BNE   PRBAAX               NO SKIP BUYAAU RECORD                       
*                                                                               
         LLC   RF,AAVLEN                                                        
         LAY   R3,-AAVLENQ(RF)     GET LENGTH OF UUID TEXT                      
*                                                                               
PRBAA10  MVC   PAAUTID,=C'BUYAAU'                                               
         MVC   PAAUORDR,SVQORDER                                                
*                                                                               
         MVI   PAAUCONT,C' '                                                    
         CHI   R3,L'PAAUTEXT       BEYOND 150 CHAR?                             
         JNH   PRBAA20              NO                                          
         MVI   PAAUCONT,C'*'        YES, PUT OUT CONTINUATION *                 
         LA    R3,L'PAAUTEXT        AND PRINT MAX 150 CHARS                     
*                                                                               
PRBAA20  BCTR  R3,0                SETUP FOR EX INSTR                           
         MVC   PAAUTEXT(0),AAVUUID                                              
         EX    R3,*-6                                                           
         BRAS  RE,PRBLINE          PUT THE BUYAAU LINE OUT TO REPORT            
*                                                                               
         CHI   R3,L'PAAUTEXT-1     DID I JUST PRINT OUT 150 CHAR?               
         BL    PRBAAX                NO                                         
         CLI   0(R4),AAVCODQ         YES, 1ST TIME GOING BACK?                  
         JNE   *+2                     NO, SOMETHING WRONG, DIE                 
         LLC   R3,AAVLEN                 GET L'ELEM AND                         
         AHI   R3,-(L'PAAUTEXT+AAVLENQ)  SUB 150+OV'HD, MORE TO PRINT?          
         LA    R4,L'PAAUTEXT(R4)          R4 = A(UUID + 150 CHARS)              
         BP    PRBAA10                    YES, PRINT ANOTHER BUYAAU             
*                                                                               
PRBAAX   DS    0H                                                               
         DROP  R2,R4                                                            
*                                                                               
*********                                                                       
* HANDLE THE BUY DETAILS                                                        
*********                                                                       
         BRAS  RE,PRBYDTL          PRINT THE BUY DETAILS                        
         J     PRBY020                                                          
*                                                                               
*********                                                                       
* NO MORE BUY RECORDS                                                           
*********                                                                       
PRBY300  LA    R2,PW               PRINT THE TRAILER                            
         USING PAGYTLRD,R2                                                      
         MVC   PATLTID,=C'AGYTLR'                                               
         MVC   PATLORDR,SVQORDER                                                
*                                                                               
         EDIT  (B4,AGYNSPTS),(6,PATLSPTS),FILL=0                                
         EDIT  (P6,AGYDOLRS),(10,PATLTOTL),FILL=0                               
         L     R3,AGYNMRCS         ADD ONE FOR ITSELF                           
         AHI   R3,1                                                             
         EDIT  (R3),(6,PATLNMRC),FILL=0                                         
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         DROP  R2                                                               
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* PRINT OUT THE BUY DETAILS                                                     
*                                                                               
* ON ENTRY:    (R4)                A(BUY RECORD)                                
***********************************************************************         
PRBYDTL  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
PRBDT00  GOTO1 ,BINPARMS,,AIO6,0,BSRCRLEN,BSRCKLEN,165                          
         L     RE,AIO6             CLEAR OUT BINSRCH TABLE                      
         LHI   RF,IO6LQ                                                         
         XCEFL                                                                  
*                                                                               
         L     R4,AIO5                                                          
         AH    R4,DATADISP                                                      
*                                                                               
PRBDT10  CLI   0(R4),0             END OF RECORD?                               
         JE    PRBDT100            YES, PRINT OUT THE DETAILS NOW               
         CLI   0(R4),RCORGQ        X'06' -  ORIGINAL ELEMENT?                   
         JE    PRBDT20                                                          
         CLI   0(R4),RCOTOQ        X'07' - OTO ELEMENT?                         
         JE    PRBDT20                                                          
         CLI   0(R4),RCPOLOQ       X'0B' - POOL ORIGINAL?                       
         JE    PRBDT20                                                          
         CLI   0(R4),RCPOTOQ       X'0C' - POOL OTO ELEMENT?                    
         JE    PRBDT20                                                          
PRBDT15  LLC   R1,1(R4)            NEITHER, ADVANCE TO NEXT ELEMENT             
         AR    R4,R1                                                            
         J     PRBDT10                                                          
*                                                                               
         USING REGELEM,R4                                                       
PRBDT20  TM    RSTATUS,RSMINUSQ    X'80' - MINUS SPOT?                          
         JZ    PRBDT20A            NO                                           
         TM    MISCFLG1,MF1DRREV   DOING REVISIONS?                             
         JNZ   PRBDT20C            YES, CAPTURE ALL THE COSTS & WEEKS           
         CLI   0(R4),RCPOLOQ       X'0B' - POOL ORIGINAL?                       
         JNL   PRBDT15                                                          
         J     PRBDT20C                                                         
*                                                                               
PRBDT20A TM    RSTATUS,RSMINSDQ+RSMGONLQ  X'42'- SPOT MINUSED AND MKGD?         
         JZ    PRBDT20C            NO, NEITHER ONE                              
*****    JNO   PRBDT15                                                          
         TM    MISCFLG1,MF1DRREV   DOING REVISIONS?                             
         JZ    PRBDT15             NO                                           
*                                                                               
PRBDT20C TM    FLTRCFLG,FRFEXIST   USING FLIGHT RECORDS?                        
         JZ    PRBDT21                                                          
         GOTOR VDATCON,DMCB,(3,SVFLTSDT),(2,FULL)                               
         GOTOR VDATCON,DMCB,(3,SVFLTEDT),(2,FULL+2)                             
         CLC   RDATE,FULL                                                       
         JL    PRBDT15                                                          
         CLC   RDATE,FULL+2                                                     
         JH    PRBDT15                                                          
*                                                                               
PRBDT21  LA    R2,BINSREC                                                       
         USING BINSRECD,R2                                                      
         GOTOR VDATCON,DMCB,(2,RDATE),(0,BSRCDATE)                              
*                                                                               
         CLI   0(R4),RCORGQ        X'06' - ORIGINAL ELEMENT?                    
         JE    *+12                                                             
         CLI   0(R4),RCOTOQ        X'07' - OTO ELEMENT?                         
         JNE   PRBDT30                                                          
*                                                                               
         GOTOR GTMYRATE,DMCB,(SVBPRD,0)                                         
         MVC   BSRCCOST,GROSS                                                   
*                                                                               
         CLI   SVBPR2,0                                                         
         JE    PRBDT25                                                          
         GOTOR GTMYRATE,DMCB,(SVBPR2,0)                                         
         L     R1,GROSS                                                         
         ICM   R0,15,BSRCCOST                                                   
         AR    R1,R0                                                            
         STCM  R1,15,BSRCCOST                                                   
*                                                                               
PRBDT25  ICM   R1,15,BSRCCOST      BSRCCOST = COST FOR ALL THE SPOTS            
         CVD   R1,DUB                                                           
         AP    AGYDOLRS,DUB                                                     
PRBDT26  MVC   BSRCCOST,SVBDCOST   NOW ->  BSRCCOST = COST FOR 1 SPOT           
*                                                                               
         MVC   BSRCNSPT,RNUM                                                    
         MVC   BSRCTSPT,RNUM                                                    
         J     PRBDT40                                                          
*                                                                               
PRBDT30  TM    MISCFLG1,MF1DRREV   DOING DARE REVISIONS?                        
         JZ    PRBDT35             NO, DON'T WORRY ABOUT MAKEGOODS              
         TM    RSTATUS,RSMGONLQ    X'02' - MAKEGOOD ON NEW LINE?                
         JZ    PRBDT35                                                          
         CLI   RLEN,RPALLOC-REGELEM    ANYTHING ALLOCATED?                      
         JNH   PRBDT35                                                          
*****                                                                           
         LA    R1,ELEM                                                          
         USING MGABLKD,R1                                                       
         XC    0(MGALNQ,R1),0(R1)                                               
         MVI   MGAACT,MGAQTRNS                                     E            
         L     RF,AIO5             A(BUYREC)                                    
         ST    RF,MGAIO                                                         
         ST    R4,MGAELEM          A(REGELEM)                                   
                                                                                
         GOTO1 VBLDMGN,MGABLKD                                                  
         CLI   MGAERR,0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
*****                                                                           
         LA    R1,ELEM                                                          
         L     RF,AIO5                                                          
         L     RE,AIO7             RE=A(BUYLINE/MAKEGOOD LIST)                  
         MVC   FULL(2),BUYKBUY-BUYREC(RF)                                       
         MVC   FULL+2(L'HALF),MGQCODE                                           
         DROP  R1                                                               
*                                                                               
PRBDT32  CLI   0(RE),0                                                          
         JE    PRBDT34                                                          
         CLC   0(4,RE),FULL        MATCH BOTH THE BUYLINE/MAKEGOOD?             
         JE    PRBDT34                                                          
         LA    RE,4(RE)            BUMP TO THE NEXT ENTRY                       
         L     R1,AIO7             MAKE SURE WE DON'T PASS TABLE                
         AHI   R1,IO7LQ                                                         
         CR    RE,R1                                                            
         JL    PRBDT32             CHECK THIS NEXT ENTRY                        
         DC    H'0'                                                             
*                                                                               
PRBDT34  MVC   0(4,RE),FULL        SAVE THIS BUYLINE/MAKEGOOD                   
*****    J     PRBDT15             DON'T INCLUDE AS COUNT THOUGH                
*                                                                               
PRBDT35  BRAS  RE,CHKPOLEL         POOL ORIGINAL ELEMENT MATCHES ORDER?         
         JNE   PRBDT15             NO, SKIP TO NEXT ELEMENT                     
*                                                                               
         GOTOR GTMYRATE,DMCB,(SVBPRD,0)                                         
         MVC   BSRCCOST,GROSS                                                   
*                                                                               
         CLI   SVBPR2,0                                                         
         JE    PRBDT36                                                          
         GOTOR GTMYRATE,DMCB,(SVBPR2,0)                                         
         L     R1,GROSS                                                         
         ICM   R0,15,BSRCCOST                                                   
         AR    R1,R0                                                            
         STCM  R1,15,BSRCCOST                                                   
*                                                                               
PRBDT36  ICM   R1,15,BSRCCOST      BSRCCOST = COST FOR ALL THE SPOTS            
         CVD   R1,DUB                                                           
         AP    AGYDOLRS,DUB                                                     
*****                                                                           
         TM    RSTATUS,RSMINUSQ    X'80' - MINUS SPOT?                          
         JZ    PRBDT37             NO                                           
         ICM   R1,15,BSRCCOST      NEGATE THE NEGATIVE COST RETURNED BY         
         LPR   R1,R1                   GETRATE                                  
         STCM  R1,15,BSRCCOST                                                   
*****                                                                           
PRBDT37  MVI   BSRCNSPT,1          MULTI-SPOT ARE SPLIT TO MULTI-ELEMS          
         MVI   BSRCTSPT,1            7 SPOTS/WEEK = 7 X'0B' ELEMS/WEEK          
         L     R1,AIO5                                                          
         USING BUYREC,R1                                                        
         TM    BDSTAT,BDSPRECQ     X'80' - POL NPW DATA IN REC                  
         JZ    PRBDT40                                                          
         DROP  R1                                                               
         LLC   R1,RPCOST           1ST 6 BITS OF RPCOST HAS NPW                 
         SRL   R1,2                                                             
         STC   R1,BSRCNSPT                                                      
         STC   R1,BSRCTSPT                                                      
         ICM   RF,15,BSRCCOST      DIVIDE AS GETRATE GOT $$/WK                  
         XR    RE,RE                  WHEN WE WANT PER SPOT                     
         DR    RE,R1                                                            
         STCM  RF,15,BSRCCOST                                                   
*                                                                               
PRBDT40  GOTOR VBINSRCH,BINPARMS,(X'01',BINSREC)                                
         OC    BINPARMS,BINPARMS   TABLE FULL?                                  
         JZ    *+2                  YES, DIE                                    
*                                                                               
PRBDT49  CLI   BINPARMS,X'01'      RECORD NOT FOUND?                            
         JE    PRBDT15             NOT FOUND, WEEK IS IN TABLE NOW              
*                                                                               
PRBDT50  L     R1,BINPARMS         FOUND, UPDATE NUMBER OF SPOTS                
         LLC   RE,BSRCTSPT                                                      
*                                                                               
         TM    RSTATUS,RSMINUSQ    X'80' - MINUS SPOT?                          
         JZ    *+6                                                              
         LNR   RE,RE                                                            
*                                                                               
         LLC   RF,BSRCTSPT-BINSRECD(R1)   UPDATE NUMBER OF SPOTS                
         AR    RE,RF                                                            
         STC   RE,BSRCTSPT-BINSRECD(R1)                                         
*                                                                               
         CHI   RE,0                IF NO SPOTS, THEN DELETE                     
         JNE   PRBDT15                                                          
         TM    MISCFLG1,MF1DRREV   DOING DARE REVISIONS?                        
         JNZ   PRBDT15             YES, DON'T DELETE THIS ENTRY                 
*                                                                               
         LR    R2,R1                                                            
         GOTOR VBINSRCH,BINPARMS,(X'80',(R2))                                   
         L     RE,AIO6                                                          
         OC    BINPARMS+8(4),BINPARMS+8   ANY RECORDS?                          
         JZ    PRBDT60                                                          
         L     R1,BINPARMS+8                                                    
         MHI   R1,BSRCRLEN                                                      
         AR    RE,R1                                                            
PRBDT60  XC    0(BSRCRLEN,RE),0(RE)   CLEAR THE RECORD HERE                     
         LA    R2,BINSREC                                                       
         J     PRBDT15                                                          
         DROP  R2,R4                                                            
*                                                                               
PRBDT100 L     R4,AIO6                                                          
         USING BINSRECD,R4                                                      
         LA    R2,PW                                                            
         USING PBUYDTLD,R2                                                      
*                                                                               
PRBDT110 MVC   PBDTTID,=C'BUYDTL'                                               
         MVC   PBDTORDR,SVQORDER                                                
         MVI   PBDTCONT,C'*'                                                    
*                                                                               
         L     R1,AIO5                                                          
         CLI   BUYKPRD-BUYREC(R1),X'FF'          POL-BUY?                       
         JE    PRBDT113                                                         
PRBDT111 EDIT  (B4,SVBDCOST),(9,PBDTCOST),FILL=0  NO, FROM HEADER               
         J     PRBDT116                                                         
PRBDT113 OC    BINPARMS+8(4),BINPARMS+8       NO ENTRIES?                       
         JZ    PRBDT111                       NONE, USE BUY COST                
         EDIT  (B4,BSRCCOST),(9,PBDTCOST),FILL=0                                
*                                                                               
PRBDT116 MVC   PBDTSTDT,BSRCDATE                                                
         CLI   PBDTSTDT,X'F9'                                                   
         JNH   PRBDT117                                                         
         LLC   R1,PBDTSTDT                                                      
         SHI   R1,10                                                            
         STC   R1,PBDTSTDT                                                      
PRBDT117 EDIT  (B1,BSRCTSPT),(2,PBDTSPTS),FILL=0                                
*                                                                               
         L     R1,AGYNSPTS                                                      
         LLC   R0,BSRCTSPT                                                      
         AR    R1,R0                                                            
         ST    R1,AGYNSPTS                                                      
*                                                                               
         MVI   BYTE,1              BYTE = NUMBER OF WEEKS                       
         MVC   CURRDATE,BSRCDATE                                                
********                                                                        
         CLC   CURRDATE,SPACES     WE HAVE A SPOT?                              
         JH    PRBDT119            YES                                          
*                                                                               
         L     RF,AIO5                                                          
**   USE THE BUY START DATE                                                     
         GOTOR VDATCON,DMCB,(3,BDSTART-BUYREC(RF)),(0,CURRDATE)                 
         MVC   PBDTSTDT,CURRDATE                                                
         CLI   PBDTSTDT,X'F9'                                                   
         JNH   PRBDT119                                                         
         LLC   R1,PBDTSTDT                                                      
         SHI   R1,10                                                            
         STC   R1,PBDTSTDT                                                      
********                                                                        
PRBDT119 LA    R3,BSRCRLEN(R4)     R3 = A(NEXT BINSRCH RECORD)                  
PRBDTDS1 USING BINSRECD,R3                                                      
*                                                                               
PRBDT120 OC    0(BSRCRLEN,R3),0(R3)   ANY RECORD HERE?                          
         JZ    PRBDT150               NO MORE RECORDS                           
*                                                                               
         CLC   BSRCCOST,PRBDTDS1.BSRCCOST    IS THE COST THE SAME?              
         JNE   PRBDT150                                                         
         CLC   BSRCTSPT,PRBDTDS1.BSRCTSPT    IS # OF SPOTS THE SAME?            
         JNE   PRBDT150                                                         
*                                                                               
         TM    ESTFLAG1,ESTDAILY           DAILY ESTIMATE?                      
         JNZ   PRBDT150                                                         
         L     RF,AIO5                                                          
         TM    BDSTAT2-BUYREC(RF),X'80'   OR BUYLINE IS DAILY?                  
         JNZ   PRBDT150                      YES, PRINT OUT THE DETAIL          
*                                                                               
         GOTOR VADDAY,DMCB,CURRDATE,CURRDATE,F'7'  THE NEXT WEEK?               
         CLC   CURRDATE,PRBDTDS1.BSRCDATE                                       
         JNE   PRBDT150                      NO, PRINT OUT THE DETAIL           
*                                                                               
         LLC   R1,BYTE             INCREMENT NUMBER OF WEEKS FOR A              
         AHI   R1,1                    SPECIFIC DOLLAR AND # OF SPOTS           
         STC   R1,BYTE                                                          
*                                                                               
         L     R1,AGYNSPTS         INCREMENT NUMBER OF SPOTS                    
         LLC   R0,PRBDTDS1.BSRCTSPT                                             
         AR    R1,R0                                                            
         ST    R1,AGYNSPTS                                                      
*                                                                               
         LA    R3,BSRCRLEN(R3)     R3 = A(NEXT BINSRCH RECORD)                  
         J     PRBDT120                                                         
*                                                                               
PRBDT150 EDIT  (B1,BYTE),(2,PBDTNOWK),FILL=0                                    
         LR    R4,R3               R4 = A(NEXT SET OF ELEMENTS)                 
*                                                                               
         OC    BSRCCOST(BSRCRLEN),BSRCCOST   ANY MORE BUY DETAILS?              
         JZ    *+12                          NO MORE                            
         BRAS  RE,PRBLINE                                                       
         J     PRBDT110            NEXT BUY DETAIL                              
*                                                                               
         MVI   PBDTCONT,C' '       NO MORE FOLLOW                               
         BRAS  RE,PRBLINE                                                       
*                                                                               
PRBDTX   J     EXITY                                                            
         DROP  R2,R4,PRBDTDS1                                                   
         EJECT                                                                  
***********************************************************************         
* GET MY GROSS COST AND TAX                                                     
*   RETRUN COST2 IF THIS IS A TRADE CLIENT BUT                                  
*   RETURN ZERO COST IF ZERO COST TRADE PROFILE IS SET                          
*                                                                               
*   ON ENTRY :  PARAM1 BYTE 0   PRODUCT CODE                                    
*               R4 = A(REGELEM)                                                 
*                                                                               
*   ON EXIT  :  WORK+4(4)       GROSS DOLLARS                                   
*               WORK+12(4)      TAX DOLLARS                                     
*   HALF GET CLOBBERED                                                          
***********************************************************************         
GTMYRATE NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   BYTE2,0(R1)         SAVE PRODUCT CODE                            
*                                                                               
         L     RF,AAGYREC          SET CANADIAN AGENCY FLAG                     
         MVC   BYTE3,AGYPCNDA-AGYHDR(RF)                                        
*                                                                               
         CLI   DRCSHTRD,TRDESREP   DOING TRADE NOW?                             
         JNE   GMR10                                                            
         TM    CLTFLAG1,CLTTRADE                                                
         JZ    GMR10                                                            
         MVC   SPOTS,=C'COS2'      NOW GET COST2                                
*                                                                               
GMR10    GOTOR VGETRATE,DMCB,(BYTE2,MYRATE),(0,AIO5),(0,(R4)),(BYTE3,0)         
*                                                                               
         CLI   DRCSHTRD,TRDESREP   DOING TRADE NOW?                             
         JNE   GMRX                                                             
         CLI   PDAR0TRD,C'Y'       TRADE ORDER $0 COST?                         
         JNE   GMRX                                                             
         XC    GROSS,GROSS         ZERO OUT GROSS                               
         XC    NET,NET               .. NET                                     
         XC    TAX,TAX               .. ADJ                                     
*                                                                               
GMRX     J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* MARKS THE DAYS OF THE WEEK IN THE FORMAT MTWTFSS.                             
* IE:  'XX X  X' = MONDAY,TUESDAY,THURSDAY, & SUNDAY                            
*                                                                               
* ON ENTRY:    PARAM 1  BYTE  0    BYTE WHICH CONTAINS THE DAYS                 
*                       BYTES 1-3  A(WHERE TO DISPLAY THE FORMAT)               
***********************************************************************         
SHWDAYS  NTR1  BASE=*,LABEL=*                                                   
         ZICM  R0,0(R1),(8)        WE KNOW (BIT 0 == 0)                         
         L     RF,0(R1)            FIGURE OUT WHICH DAYS ARE ON                 
         LA    R1,7                7 BITS TO SHIFT                              
*                                                                               
SHWDAY10 SLA   R0,1                IF (BIT 1 = 1) AND IT IS SHIFTED OUT         
         JNO   *+8                                                              
         MVI   0(RF),C'X'          THEN WE KNOW THE DAY IS SET                  
         LA    RF,1(RF)                                                         
         JCT   R1,SHWDAY10                                                      
*                                                                               
SHWDAYX  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* ROUTINE FOR THE OCOM RECORDS                                                  
*                                                                               
* ON ENTRY: R4  A(PW)                                                           
*                                                                               
***********************************************************************         
PRNTOCOM NTR1  BASE=*,LABEL=*                                                   
         LA    R2,PW                                                            
         USING PAGYSTDD,R2                                                      
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO6'                              
*                                                                               
         L     R4,AIO6                                                          
         MVI   ELCDLO,X'05'        COMMENT TEXT ELEMENT?                        
         MVI   ELCDHI,X'05'                                                     
         BRAS  RE,GETEL                                                         
         JNE   PRTOCMX                                                          
PRTOCM10 CLC   0(L'SPACES,R2),SPACES    A LINE TO PRINT FROM BEFORE?            
         JNH   PRTOCM20                                                         
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
PRTOCM20 MVC   PASTTID,=C'AGYSTD'     TRANSMISSION ID                           
         MVC   PASTORDR,SVQORDER                                                
         MVI   PASTCONT,C'*'       MORE LINES FOLLOW                            
         LLC   R1,1(R4)                                                         
         SHI   R1,3                OVERHEAD AND 1 MORE FOR EX                   
         MVC   PASTTEXT(0),2(R4)                                                
         EX    R1,*-6                                                           
*                                                                               
         BRAS  RE,NEXTEL                                                        
         JE    PRTOCM10                                                         
*                                                                               
PRTOCMX  J     EXITY                                                            
         DROP  R2                                                               
***********************************************************************         
* PUTS OUT THE AGENCY DESCRIPTION RECORDS                                       
***********************************************************************         
PRTDESCS NTR1  BASE=*,LABEL=*                                                   
***************                                                                 
* PUT OUT AGENCY DESCRIPTION LINE 1                                             
***************                                                                 
         LA    R2,PW                                                            
         USING PAGYDS1D,R2                                                      
         MVC   PAD1TID,=C'AGYDS1'     TRANSMISSION ID                           
*                                                                               
         MVC   PAD1ORDR,SVQORDER                                                
         MVC   PAD1AGNM(L'REPUSRN),REPUSRN                                      
         MVC   PAD1AGAD(L'REPUSRA),REPUSRA                                      
         DROP  R2                                                               
*                                                                               
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
******************************************************                          
* PUT OUT AGENCY DESCRIPTION LINE 2 (DEMOS)                                     
* EFFICTIVE 17.3                                                                
*  -PUT OUT THE COMSCORE DEMO CATEGORIES (AGYCDC)                               
*  -PUT OUT THE AGENCY TARGET DEMO CATEGORIES (AGYTDM)                          
******************************************************                          
DS2      USING PAGYDS2D,PW                                                      
         MVC   DS2.PAD2TID,=C'AGYDS2'     TRANSMISSION ID                       
         MVC   DS2.PAD2ORDR,SVQORDER                                            
         MVC   DS2.PAD2CLTN(L'CLTNM),CLTNM                                      
         MVC   DS2.PAD2ESTN(L'ESTNM),ESTNM                                      
*                                                                               
CDC      USING PAGYCDCD,PW2                                                     
         MVC   CDC.PCDCTID,=C'AGYCDC'     TRANSMISSION ID                       
         MVC   CDC.PCDCORDR,SVQORDER                                            
*                                                                               
TDM      USING PAGYTDMD,PW3                                                     
         MVC   TDM.PTDMTID,=C'AGYTDM'     TRANSMISSION ID                       
         MVC   TDM.PTDMORDR,SVQORDER                                            
*                                                                               
*********                                                                       
* ITERATE THROUGH ESTIMATE DEMO CATEGORIES LOOKING FOR UPTO 4                   
*  DEMO CATEGORIES, ONLY TRADITIONAL WILL SHOW IN AGYDS2                        
*********                                                                       
         NI    ANYFLAG1,X'FF'-AF1NTRDM  WE DON'T HAVE NON-TRAD DEMO YET         
*                                                                               
         LA    R1,ESTDEMOS         R2= A(ORDER DEMOS TO SEND)                   
         LA    R4,L'EDEMLIST       R4= L(SINGLE EST DEMO CAT)                   
         LLH   RF,NUMDEMS          RF= # OF DEMOS TO SEND                       
         MHI   RF,L'EDEMLIST                                                    
         LA    R5,ESTDEMOS-1(RF)   R5=A(END OF ORDER DEMOS TO SEND)             
*                                                                               
* WE SET THE REGISTERS ABOVE AS WE CANNOT DO A "FROM=(R1,ESTDEMOS)"             
*                         AS THAT ASSEMBLES TO "L   R1,ESTDEMOS"                
*                     WHEREAS WE WANT IT TO BE "LA  R1,ESTDEMOS"                
*                                                                               
         DO JXLE,FROM=(R1),TO=(R5),BY=(R4) GO THRU ESTDEMOS                     
           DOEXIT (OC,0(3,R1),0(R1),Z)     UNTIL NO MORE DEMOS TO SEND          
           IF (CLI,2(R1),NE,0)     IS THIS DEMO CAT TRADITIONAL?                
             BRAS  RE,STADS2DM     -YES, SET DEMO IN AGYDS2 AND AGYTDM          
           ELSE ,                  -NO, HAVE NON-TRAD                           
             OI    ANYFLAG1,AF1NTRDM  SET FLAG FOR LATER                        
             BRAS  RE,STACDCDM     SET DEMO IN AGYCDC AND AGYTDM                
           ENDIF ,                                                              
         ENDDO ,                                                                
*                                                                               
         IF (TM,ANYFLAG1,AF1NTRDM,O) HAVE NON-TRAD?                             
           MVI   REPPRNTN,3          YES, SET # OF PRINT LINES TO 3             
         ENDIF ,                                                                
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         MVI   REPPRNTN,1            SET # OF PRINT LINES BACK TO 1             
         J     PRDS030                                                          
*********************************                                               
* SET DEMO CATEGORY IN THE AGYDS2                                               
*********************************                                               
STADS2DM NTR1                                                                   
         LA    R3,DS2.PAD2TDEM           R3= A(START DEMO CAT ON PRTLN)         
         LA    R5,DS2.PAGYDS2D+PAGYDS2L-1  R5= A(END DEMO CAT ON PRTLN)         
         LA    R4,L'PAD2TDEM               R4= L'(DEMO CAT ON PRTLN)            
*                                                                               
         DO JXLE,FROM=(R3),TO=(R5),BY=(R4)     GO THRU AGYDS2 DEMOS             
           IF (CLC,0(L'PAD2TDEM,R3),NH,SPACES) UNTIL OPEN SPOT                  
             MVC   0(1,R3),1(R1)      MOVE DEMO MODIFIER                        
             EDIT  (B1,2(R1)),(3,1(R3)),ALIGN=RIGHT,ZERO=NOBLANK,FILL=0         
*                                     NIELSEN CATEGORY NUMBER                   
*&&DO                                                                           
             IF (CLI,1(R1),EQ,X'21')   X'21' -USER DEFINED?                     
               MVC   0(1,R3),C'U'       SET RATING TYPE C'U'                    
             IF (CLI,1(R1),EQ,X'3F')   X'3F'- IGNORE WEIGHTED DEMOS?            
               MVC   0(1,R3),C'W'       SET RATING TYPE C'W'                    
*&&                                                                             
***************                                                                 
* UPDATE AGYTDM RECORD                                                          
***************                                                                 
             LA    RE,DS2.PAD2TDEM    R3 = 1ST DS2 DEM CAT                      
             SR    R3,RE              GET DISPLACEMENT                          
             SRL   R3,2               DIV/4 TO GET INDEX (START AT 0)           
             GOTOR STATDMDM,DMCB,((R3),=C'AGYDS2')                              
             ASMLEAVE ,                                                         
           ENDIF ,                                                              
         ENDDO ,                                                                
         J     EXIT                                                             
*                                                                               
*********************************                                               
* SET DEMO CATEGORY IN THE AGYCDC                                               
*********************************                                               
STACDCDM NTR1                                                                   
         LA    R3,CDC.PCDCDEM1           R3= A(START DEMO CAT ON PRTLN)         
         LA    R5,CDC.PAGYCDCD+PAGYCDCL-1  R5= A(END DEMO CAT ON PRTLN)         
         LA    R4,L'PCDCDEM1               R4= L'(DEMO CAT ON PRTLN)            
*                                                                               
         DO JXLE,FROM=(R3),TO=(R5),BY=(R4)      GO THRU AGYCDC DEMOS            
           IF (CLC,0(L'PAD2TDEM,R3),NH,SPACES)  UNTIL OPEN SPOT                 
             LLC   RF,1(R1)            GET NON-TRAD DEMO INDEX                  
             BCTR  RF,0                INDEX SHOULD START AT 0                  
             MHI   RF,L'ENONTDMS       MULT BY L'NON-TRAD DEMO NAME             
             LA    RF,ESTNTDEM(RF)     POINT TO NON-TRAD DEMO NAME              
             IF (CLC,0(L'ENONTDMS,RF),NL,SPACES) HAVE A NON-TRAD NAME?          
               MVC   0(1,R3),0(RF)     MOVE DEMO MODIFIER                       
               XC    DUB,DUB                                                    
               MVC   DUB(L'ENONTDMS-2),1(RF)                                    
               IF (CLI,0(RF),EQ,C'X')  IF IMPRESSION                            
                 MVI   0(R3),C'I'      THEN MOVE IN IMPRESSION MOD              
                 MVC   DUB(L'ENONTDMS-1),0(RF)                                  
               ENDIF ,                                                          
               OC    DUB,SPACES                                                 
***************                                                                 
* CALL DEMOCON TO GET COMSCORE TAG#                                             
***************                                                                 
*                                                                               
               IF (OC,SVCSLIC,SVCSLIC,Z)  ALREADY CALLED GETCSLIC?              
                 XC    WORK2,WORK2                                              
                 BRAS  RE,GETCSLIC        NO, GET COMSCORE LICENSE              
                 IF (EQ)                                                        
                   MVC   WORK2(4),=C'DEXB'  SET UNIQUE TABLE ID                 
                   LA    RF,SVCSLIC                                             
                   ST    RF,WORK2+4         SET A(COMSCORE LICENSE)             
                 ENDIF ,                                                        
               ENDIF ,                                                          
*                                                                               
               L     RF,AIO6           SETUP DBLOCK FOR DEMOCON CALL            
               XC    0(256,RF),0(RF)                                            
               USING DBLOCKD,RF                                                 
               MVC   DBSELAGY,LP_AGY   SET AGENCY                               
               MVC   DBSELMED,SVMED    SET MEDIA CODE                           
               MVC   DBFILE,=C'TP '    SET TP FILE TYPE                         
               MVC   DBCOMFCS,ACOMFACS SET ADDRESS OF COMFACS                   
               DROP  RF                                                         
RT             USING RENTABD,TEMP12                                             
               XC    TEMP12,TEMP12                                              
               GOTOR VDEMOCON,DMCB,(C'C',DUB),(20,TEMP12),(C'S',AIO6),          
                     WORK2,0,0                                                  
               CLI   DMCB,X'FF'        HAVE ERROR?                              
               JE    *+2                YES, CAN'T CONTINUE, DIE                
               OC    TEMP12,TEMP12     DID WE GET SOMETHING BACK?               
               JZ    *+2                NO, CAN'T CONTINUE, DIE                 
***************                                                                 
*  CONVERT COMSCORE TAG#                                                        
*  FROM - LEFT ALIGNED EBCDIC, NO LEADING 0, TRAILING SPACE                     
*    TO - RIGHT ALIGNED EBCDIC WITH LEADING 0'S                                 
***************                                                                 
               LA    RE,RT.RENDESC     RE= A(COMSCORE TAG#)                     
               LA    RF,RT.RENDESC+L'RENDESC-1                                  
               DO WHILE=(CLI,0(RF),NH,C' ')                                     
                 BCTR  RF,0                                                     
                 CR    RF,RE                                                    
                 JL    *+2                                                      
               ENDDO ,                                                          
               SR    RF,RE             LENGTH OF COMSCORE TAG#                  
               EX    RF,*+8                                                     
               B     *+10                                                       
               PACK  DUB,0(0,RE)                                                
               OI    DUB+7,X'0F'                                                
               UNPK  1(L'PCDCDEM1-1,R3),DUB                                     
               DROP  RT                                                         
***************                                                                 
* UPDATE AGYTDM RECORD                                                          
***************                                                                 
               LA    RE,CDC.PCDCDEM1   RE = 1ST CDC DEM CAT                     
               SR    R3,RE             GET DISPLACEMENT                         
               SR    R2,R2             SETUP R2/R3 FOR DIVIDE                   
               LA    RE,L'PCDCDEM1     GET LENGTH OF EACH ENTRY                 
               DR    R2,RE             DIV/LEN TO GET INDEX(START AT 0)         
               GOTOR STATDMDM,DMCB,((R3),=C'AGYCDC')                            
             ENDIF ,                                                            
             ASMLEAVE ,                                                         
           ENDIF ,                                                              
         ENDDO ,                                                                
         J     EXIT                                                             
                                                                                
*********************************                                               
* SET DEMO CATEGORY IN THE AGYTDM                                               
*********************************                                               
STATDMDM DS    0H                                                               
         LA    R3,TDM.PTDMDEM1           R3= A(START DEMO CAT ON PRTLN)         
         LA    R5,TDM.PAGYTDMD+PAGYTDML-1  R5= A(END DEMO CAT ON PRTLN)         
         LA    R4,L'PTDMDEM1               R4= L'(DEMO CAT ON PRTLN)            
*                                                                               
         DO JXLE,FROM=(R3),TO=(R5),BY=(R4)      GO THRU AGYTDM DEMOS            
           IF (CLC,0(L'PTDMDEM1,R3),NH,SPACES)  UNTIL OPEN SPOT                 
             L     RF,0(R1)                MOVE SOURCE DEMO RECORD              
             MVC   0(L'PTDMDREC,R3),0(RF)  AGYDS2 OR AGYCDC                     
             LLC   RF,0(R1)                GET INDEX (STARTS AT 0)              
             LA    RF,1(RF)                ADD 1                                
             EDIT  (RF),(L'PTDMDIND,L'PTDMDREC(R3)),ALIGN=RIGHT,                
                   ZERO=NOBLANK,FILL=0 ,   MOVE IN INDEX                        
             ASMLEAVE ,                                                         
           ENDIF ,                                                              
         ENDDO ,                                                                
         J     EXIT                                                             
         DROP  DS2,CDC,TDM                                                      
         EJECT                                                                  
***********************************************************************         
* GET THE COMSCORE SECURITY LICSENSE FROM TOKEN RECORD                          
*                                                                               
* NOTE:  AIO8 WILL BE CLOBBERED TO READ THE TOKEN RECORD                        
***********************************************************************         
GETCSLIC NTR1  LABEL=*                                                          
         MVC   SVCSLIC,SPACES      INIT TO SPACES                               
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY                                                         
         USING TOKKEY,R4                                                        
         XC    IOKEY,IOKEY         X'00'                                        
         MVI   TOKKMIN,TOKKMINQ    C'K'                                         
         MVI   TOKKTYP,TOKKRTRK    X'01' - RENTRAK RECORD                       
         L     R1,LP_ASECD                                                      
         MVC   TOKKSAGY,SECAGY-SECD(R1)  SECURITY AGENCY CODE                   
         MVC   TOKKAAGY,SECOAGY-SECD(R1) AGENCY ALPHA CODE                      
         MVI   TOKKSYS,X'02'       SPOT SYSTEM                                  
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOBHI+IOGENDIR+B#TOKREC'                      
         JNE   GTCSLNO                                                          
         CLC   IOKEY(TOKKUSR-TOKKEY),IOKEYSAV                                   
         JNE   GTCSLNO                                                          
         CLI   TOKKSYS,X'02'       SPOT?                                        
         JNE   GTCSLNO                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOBGET+IOGENFIL+B#TOKREC'                     
         JNE   GTCSLNO                                                          
*                                                                               
         L     R4,IOADDR                                                        
         LA    R4,TOKFIRST(R4)     R4=A(1ST ELEMENT)                            
GTCSL10  CLI   0(R4),0             ANY ELEMENTS?                                
         JE    GTCSLNO                                                          
         CLI   0(R4),RTAUTELQ      X'0A' - RENTRAK AUTHOR ELEM?                 
         JE    GTCSL30                                                          
         LLC   R0,1(R4)            CHECK THE NEXT ELEMENT                       
         AR    R4,R0                                                            
         J     GTCSL10                                                          
*                                                                               
         USING RTAUTHD,R4                                                       
GTCSL30  CLC   RTAUTID,SPACES      LICENSE ID BETTER BE > SPACES                
         JNH   GTCSLNO                                                          
         MVC   SVCSLIC,RTAUTID     LICENSE ID                                   
         DROP  R4                                                               
*                                                                               
GTCSLYES J     EXITY                                                            
GTCSLNO  J     EXITN                                                            
*                                                                               
***************                                                                 
* PUT OUT AGENCY DESCRIPTION LINE 3                                             
***************                                                                 
PRDS030  LA    R2,PW                                                            
         USING PAGYDS3D,R2                                                      
         MVC   PAD3TID,=C'AGYDS3'     TRANSMISSION ID                           
*                                                                               
         MVC   PAD3ORDR,SVQORDER                                                
         MVC   PAD3PRDN(L'PRDNM),PRDNM                                          
         MVC   PAD3PR2N(L'PR2NM),PR2NM                                          
         DROP  R2                                                               
*                                                                               
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
***************                                                                 
* PUT OUT AGENCY DESCRIPTION LINE 4                                             
***************                                                                 
         LA    R2,PW                                                            
         USING PAGYDS4D,R2                                                      
         MVC   PAD4TID,=C'AGYDS4'     TRANSMISSION ID                           
*                                                                               
         MVC   PAD4ORDR,SVQORDER                                                
         MVC   PAD4BUYR(L'SVQBYR),SVQBYR                                        
*                                                                               
         BRAS  RE,VALBYR                                                        
         JNE   *+2                                                              
*                                                                               
         L     R4,AIO7                                                          
         MVI   ELCDLO,BYRDCDQ      X'10' BUYER DESCRIPTION ELEMENT              
         MVI   ELCDHI,BYRDCDQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
                                                                                
         USING BYRDSCD,R4                                                       
         MVC   PAD4BYRN(L'BYRFNAME),BYRFNAME                                    
         OC    PAD4BYRN,SPACES                                                  
*                                                                               
         LA    RE,BYRPHONE         STRIP PHONE NUMBER OF HYPHENS                
         LA    RF,L'BYRPHONE           AND PARENTHESIS                          
PRDS040  CLI   0(RE),C'('                                                       
         JE    PRDS045                                                          
         CLI   0(RE),C')'                                                       
         JE    PRDS045                                                          
         CLI   0(RE),C'-'                                                       
         JNE   PRDS050                                                          
PRDS045  LR    R1,RF                                                            
         SHI   R1,2                                                             
         MVC   0(0,RE),1(RE)                                                    
         EX    R1,*-6                                                           
         LA    R1,0(RF,RE)                                                      
         BCTR  R1,0                                                             
         MVI   0(R1),C' '                                                       
         J     *+8                                                              
PRDS050  LA    RE,1(RE)                                                         
         JCT   RF,PRDS040                                                       
*                                                                               
         MVC   PAD4BYRT(L'BYRPHONE),BYRPHONE                                    
         MVC   PAD4BYRX(L'BYRPHEXT),BYRPHEXT                                    
         DROP  R2,R4                                                            
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
***************                                                                 
* PUT OUT AGENCY DESCRIPTION LINE 5                                             
***************                                                                 
         TM    REPSTAT,X'02'       DATA RECORD MEANT ONLY FOR XML RADIO         
         JZ    PRTDSCX             NO, DON'T NEED TO SEND THIS                  
         LA    R2,PW                                                            
         USING PAGYDS5D,R2                                                      
         MVC   PAD5TID,=C'AGYDS5'     TRANSMISSION ID                           
*                                                                               
         MVC   PAD5ORDR,SVQORDER                                                
*                                                                               
         BRAS  RE,CHKRPSAL                                                      
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGENFIL+IO6'                           
*                                                                               
         MVC   PAD5SALP,SPACES     CHANGED TO SPACES SINCE AGYXM1               
         MVI   PAD5UNWR,C'N'                                                    
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' DARE SUPPLEMENTARY ID ELEMENT          
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
*                                                                               
         USING DOSPELD,R4                                                       
         TM    DOSPFLG1,DOSPPPER                                                
         JZ    *+8                                                              
         MVI   PAD5UNWR,C'Y'                                                    
         DROP  R2,R4                                                            
*                                                                               
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         TM    REPSTAT,X'02'       INVISIBLE/XML STATUS                         
         JZ    PRTDSCX             NO, DON'T NEED TO SEND THIS                  
         LA    R2,PW                                                            
         USING PAGYXM1D,R2                                                      
         MVC   PAX1TID,=C'AGYXM1'     TRANSMISSION ID                           
         MVC   PAX1ORDR,SVQORDER                                                
*                                                                               
         CLC   REPHUBAD,=CL10'DDSXMLNY'                                         
         JE    PRDS052                                                          
*                                                                               
         L     R4,AIO6                                                          
         MVI   ELCDLO,X'02'        X'02'  NEW INFO ELEMENT                      
         MVI   ELCDHI,X'02'                                                     
         MVI   DATADISP+1,GSPLFRST                                              
         BRAS  RE,GETEL                                                         
         JE    PRDS055                                                          
         NOP   PRDS059                                                          
PRDS052  MVC   PAX1COMN(10),=C'KATZ RADIO'                                      
         MVC   PAX1COMC,=CL5'00001'                                             
         MVC   PAX1OFFN(8),=C'NEW YORK'                                         
         MVC   PAX1OFFC,=CL5'00024'                                             
         MVC   PAX1OFFM,=CL5'00101'                                             
         MVC   PAX1FIRN(4),=C'JODY'                                             
         MVC   PAX1LASN(5),=C'SPORN'                                            
         MVC   PAX1SALC,=C'00001'                                               
         MVC   PAX1HUB,=CL10'DDSXMLNY'                                          
         J     PRDS057                                                          
*                                                                               
         USING GSPLNFCD,R4                                                      
PRDS055  MVC   PAX1COMN(L'GSPLNFCM),GSPLNFCM    COMPANY NAME                    
         EDIT  GSPLNFCC,PAX1COMC,FILL=0  COMPANY CODE                           
         MVC   PAX1FIRN(L'GSPLNFFR),GSPLNFFR  SALESPERSON FIRST NAME            
         MVC   PAX1LASN(L'GSPLNFLS),GSPLNFLS  SALESPERSON LAST NAME             
         EDIT  SALESCOD,PAX1SALC,FILL=0  SALESPERSON CODE                       
         MVC   PAX1HUB,REPHUBAD                                                 
*                                                                               
         LA    RF,SVDESTID+L'SVDESTID-1  LETS GET THE OFFICE                    
         CLI   0(RF),X'40'                                                      
         JH    *+10                                                             
         BCTR  RF,0                                                             
         J     *-10                                                             
         BCTR  RF,0                                                             
*                                                                               
         MVI   ELCDLO,X'03'        X'02'  NEW INFO ELEMENT                      
         MVI   ELCDHI,X'03'                                                     
PRDS056  BRAS  RE,NEXTEL                                                        
         JNE   PRDS057                                                          
         USING GSPLOFCD,R4                                                      
         CLC   GSPLOFDD,0(RF)                                                   
         JNE   PRDS056                                                          
         MVC   PAX1OFFN,GSPLOFON         SBS OFFICE NAME                        
         EDIT  GSPLOFOC,PAX1OFFC,FILL=0  SBS OFFICE CODE                        
         EDIT  GSPLOFMC,PAX1OFFM,FILL=0  NSI MARKET CODE                        
PRDS057  GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         DROP  R2,R4                                                            
*                                                                               
PRDS059  MVI   DATADISP+1,24                                                    
         LA    R2,PW                                                            
         USING PAGYXM2D,R2                                                      
         MVC   PAX2TID,=C'AGYXM2'     TRANSMISSION ID                           
         MVC   PAX2ORDR,SVQORDER                                                
         MVC   PAX2COMN(L'REPUSRN),REPUSRN                                      
         MVC   PAX2AGID,SVDRROUT                                                
         MVC   PAX2OFFC(L'MKTTOFF),SVDRROUT+L'PAX2AGID                          
         BRAS  RE,GTMKTTAB                                                      
         USING MKTTABD,R3                                                       
PRDS060  CLI   MKTTNSI,X'FF'       END OF TABLE                                 
         JE    *+2                                                              
         CLC   MKTTOFF,PAX2OFFC                                                 
         JE    PRDS065                                                          
         LA    R3,MKTTABLN(R3)                                                  
         J     PRDS060                                                          
PRDS065  MVC   PAX2OFFN,MKTTNAME                                                
         EDIT  MKTTNSI,PAX2OFFM,FILL=0                                          
         DROP  R3                                                               
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID                       
         MVI   ELCDHI,DOSPELQ      X'03' SUPPLEMENTARY ID                       
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         USING DOSPELD,R4                                                       
         EDIT  DOSPVER#,PAX2VER#,FILL=0                                         
         DROP  R2,R4                                                            
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
PRTDSCX  J     EXITY                                                            
*                                                                               
MKTTABD  DSECT                                                                  
MKTTNSI  DS    XL3                                                              
MKTTOFF  DS    CL2                                                              
MKTTNAME DS    CL20                                                             
MKTTABLN EQU   *-MKTTABD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
*====================================================================           
* PRINT COVER PAGE AND ASSOCIATED COMMENTS NOT PART OF ORDER                    
*                                                                               
* -- COVER SHEET - RECEIVER DATA --                                             
*    STATION CALL LETTERS                                                       
*    STATION FAX NUMBER (FROM OM LAST METHOD)                                   
*    ATTENTION  (FROM OM LAST METHOD OR ORDER)                                  
*    TEL NUMBER (FROM OM DESTIN RECORD)                                         
*                                                                               
* -- COVER SHEET SENDER DATA --                                                 
*    BUYER NAME (FROM OM BUYER REC)/AGENCY/AGENCY ADDR                          
*    ORIGINATING ID                                                             
*    TEL NUMBER   "  "                                                          
*    FAX NUMBER   "  "                                                          
*    EMAIL ADDR   "  "                                                          
*    STD COMMENT  "  "                                                          
*    ORD COMMENT  "  "                                                          
*                                                                               
* -- DX REPORT --                                                               
*    OCOM COMMENTS (VIA SPGETOMCOM)                                             
*    ORDER STD COMMENTS                                                         
*    ORDER COMMENTS                                                             
*================================================================*              
                                                                                
PRTCOVER NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOWIGELQ                                                  
         MVI   ELCDHI,DOWIGELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         USING DOWIGELD,R4                                                      
*                                                                               
PC1      LA    R2,P1                                                            
         MVC   4(15,R2),=C'*HDR*EDICT=*BDE'                                     
         CLI   DOWIGMTH,C'E'            TEST EMAIL                              
         JE    PC2                                                              
         MVC   9(4,R2),=C'FAX '         OVERWRITE EDICT=                        
         MVC   13(16,R2),DOWIGFXN       AND THEN THE FAX NUMBER                 
         OC    13(16,R2),SPACES                                                 
*                                                                               
PC2      MVI   34(R2),C'W'              132 CHARS WIDE                          
         MVI   35(R2),C'P'              PAGE BREAKS                             
*                                                                               
         L     RE,AIO3                                                          
         USING DOKEY,RE                                                         
         LA    R1,DOKSTA                POINT TO REQUESTED STATION              
         BRAS  RE,GETQSTA                                                       
         DROP  RE                                                               
         MVC   38(8,R2),SVSTAEDT        FORMATTED DESTINATION NAME              
         MVI   67(R2),C'D'              THE D FOR YI IF E                       
         MVI   70(R2),C'N'              SUPPRESS EDICT COVER PAGE               
*                                                                               
         LA    R2,54(R2)                ADD BILLING INFO                        
         MVC   0(1,R2),SVMED                                                    
         MVC   1(3,R2),SVQCLT                                                   
*                                                                               
         MVI   REPFMIDS,C'N'                                                    
         MVI   REPLINE,0                                                        
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         MVC   P1(14),DXTRAN                                                    
         LA    R1,P1+15                                                         
         BRAS  RE,DXFMTAPP                                                      
         OC    P1,SPACES                                                        
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         CLI   DOWIGMTH,C'E'       TEST EMAIL                                   
         JNE   PC10                                                             
         MVC   P1(14),=C'++DDS      RCP'                                        
         MVC   P1+15(40),DOWIGEML   MOVE EMAIL ADDRESS                          
         OC    P1,SPACES                                                        
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         BRAS  RE,DXFMTORD                                                      
         OC    P1,SPACES                                                        
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         EJECT                                                                  
PC10     MVI   REPLINE,0                                                        
*                                                                               
         MVC   P1+33(10),=C'COVER PAGE'                                         
         MVC   P2+33(10),=C'----- ----'                                         
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         LA    R2,P1                                                            
         MVC   20(8,R2),=C'SENT TO:'                                            
         MVC   33(8,R2),SVSTAEDT                                                
*                                                                               
         LA    R2,132(R2)                                                       
         CLI   DOWIGMTH,C'E'          TEST EMAIL                                
         JNE   PC12                                                             
         MVC   33(64,R2),DOWIGEML                                               
         OC    P1,SPACES                                                        
         J     PC14                                                             
*                                                                               
PC12     MVC   33(12,R2),DOWIGFXN     FAX NUMBER                                
*                                                                               
         LA    R2,132(R2)                                                       
         MVC   33(24,R2),DOWIGFXA     FAX ATTN NAME                             
         OC    DOWIGFXA,DOWIGFXA      ANY ATTENTION NAME?                       
         JNZ   *+10                                                             
         MVC   33(24,R2),SALESPER     SALESPERSON NAME                          
         OC    0(132,R2),SPACES                                                 
*                                                                               
         LA    R2,132(R2)                                                       
         MVC   33(12,R2),DOWIGFXT     TELEPHONE NUMBER                          
         OC    0(132,R2),SPACES                                                 
*                                                                               
PC14     GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         MVI   REPLINE,0                                                        
         EJECT                                                                  
*                                                                               
         BRAS  RE,VALBYR           READ THE BUYER RECORD                        
*                                                                               
         L     R4,AIO7                                                          
         MVI   ELCDLO,BYRDCDQ      X'10' BUYER DESCRIPTION ELEMENT              
         MVI   ELCDHI,BYRDCDQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         USING BYRDSCD,R4                                                       
*                                                                               
         LA    R2,P1                                                            
         MVC   20(10,R2),=C'SENT FROM:'                                         
         MVC   33(24,R2),BYRFNAME                                               
*                                                                               
         MVC   60(4,R2),=C'(ID='                                                
         MVC   64(8,R2),SVORIGID                                                
*                                                                               
         LA    R1,74(R2)                                                        
         CLI   0(R1),C' '                                                       
         JH    *+8                                                              
         JCT   R1,*-8                                                           
         MVI   1(R1),C')'                                                       
*                                                                               
         LA    R2,L'P1(R2)                                                      
         MVC   36(33,R2),REPUSRN   INDENT AGENCY SLIGHTLY                       
         OC    0(132,R2),SPACES                                                 
*                                                                               
         LA    R2,132(R2)                                                       
         MVC   36(33,R2),REPUSRA                                                
         OC    0(132,R2),SPACES                                                 
*                                                                               
         LA    R2,132(R2)                                                       
         MVC   20(10,R2),=C'TELEPHONE:'                                         
         MVC   33(12,R2),BYRPHONE   BUYER TELEPHONE                             
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         DROP  R4                                                               
*                                                                               
         L     R4,AIO3             POINT TO ORDER RECORD                        
         LA    R4,24(R4)                                                        
         MVI   ELCDLO,DOSTELQ                                                   
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,NEXTEL           FIND TRANSMISSION ELEMENT                    
         JNE   *+2                                                              
*                                                                               
         USING DOSTELD,R4                                                       
*                                                                               
         LA    R2,P1                                                            
         MVC   20(8,R2),=C'SENT ON:'                                            
         GOTOR VDATCON,DMCB,(8,DOSTDATE),(8,33(R2))                             
*                                                                               
         LA    R2,132(R2)                                                       
         MVC   20(8,R2),=C'SENT AT:'                                            
         GOTOR VHEXOUT,DMCB,DOSTTIME,DUB,2,=C'TOG'                              
         MVC   33(2,R2),DUB                                                     
         MVI   35(R2),C'.'                                                      
         MVC   36(2,R2),DUB+2                                                   
         MVI   REPPRNSA,2          FORCE A BLANK LINE AFTER                     
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         MVI   REPLINE,0                                                        
                                                                                
* SEE IF THERE IS PREVIOUS TRANSMISSION ELEMENT (NEXT ELEMENT)                  
                                                                                
         MVI   SHOWCHGS,C'N'       DEFAULT TO SHOWING CHANGES                   
         CLI   SVCURREV,0          TEST ORIGINAL                                
         JE    PC16                                                             
         MVI   SHOWCHGS,C'Y'                                                    
*                                                                               
PC15     BRAS  RE,NEXTEL                                                        
         JNE   PC16                                                             
         CLI   DOSTSTAT,DFXSENT                                                 
         JNE   PC15                                                             
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,PDXSTYR        TEST ANY START DATE IN PROFILE               
         JZ    PC16                NO                                           
         AHI   R0,100                                                           
         STC   R0,DUB                                                           
         MVC   DUB+1(2),PDXSTMON                                                
         GOTOR VDATCON,DMCB,(3,DUB),(19,FULL) NEW FAX DATE PWOS                 
         CLC   DOSTDATE,FULL       TEST SENT BEFORE NEW FAX START               
         JH    PC16                NO                                           
         MVI   SHOWCHGS,C'N'       ELSE SUPPRESS CHANGES                        
         DROP  R4                                                               
         EJECT                                                                  
*===========================================================                    
* NOW PRINT BUYER COMMENTS                                                      
*===========================================================                    
         SPACE 1                                                                
PC16     L     R4,AIO7             POINT TO BUYER RECORD                        
         MVI   ELCDLO,X'15'        FIND BYRCMTD                                 
         MVI   ELCDHI,X'15'        FIND BYRCMTD                                 
         LA    R4,24(R4)                                                        
         BRAS  RE,NEXTEL                                                        
         JNE   PC30                                                             
*                                                                               
         USING BYRCMTD,R4                                                       
*                                                                               
         CLI   BYRSCMNT,C' '       TEST STANDARD COMMENT PRESENT                
         JNH   PC20                                                             
         LA    R1,BYRSCMNT                                                      
         BRAS  RE,DARSTD           READ STANDARD COMMENT                        
         JNE   PC20                                                             
*                                                                               
         MVI   ELCDLO,X'10'        STANDARD COMMENT TEXT ELEM                   
         BRAS  RE,DARPRT           PRINT STANDARD COMMENT                       
*                                                                               
PC20     MVC   P1(70),BYROCMT1                                                  
         CLC   P1(70),SPACES        TEST FOR A BUYER COMMENT                    
         JNH   PC22                                                             
         OC    P1,SPACES                                                        
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
PC22     MVC   P1(70),BYROCMT2                                                  
         CLC   P1(70),SPACES                                                    
         JNH   PC30                                                             
         OC    P1,SPACES                                                        
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         DROP  R4                                                               
*                                                                               
PC30     OC    DARECONT,DARECONT   TEST CONTRACT PRESENT                        
         JZ    PCX                                                              
*                                                                               
         MVC   P1(36),=C'*** ORDER PREVIOUSLY SET TO REP FIRM'                  
         MVC   P1+36(10),=C', CONTRACT'                                         
         MVC   P1+48(8),DARECONT                                                
         MVC   P1+57(3),=C'***'                                                 
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
PCX      J     EXIT                                                             
         EJECT                                                                  
*=============================================================                  
* FORMAT ++DDS   SUB                                                            
*        ++DDS   FIL                                                            
*=============================================================                  
                                                                                
DXFMTORD NTR1  BASE=*,LABEL=*                                                   
         MVC   P1(14),=C'++DDS      SUB'                                        
         MVC   P1+15(5),=C'ORDER'                                               
*                                                                               
         LA    RE,P1+21                                                         
         MVC   0(3,RE),SVQCLT                                                   
         LA    RE,3(RE)                                                         
         CLI   0(RE),C' '                                                       
         JH    *+8                                                              
         JCT   RE,*-8                                                           
*                                                                               
         MVC   2(3,RE),SVQPRD                                                   
         LA    RE,5(RE)                                                         
         CLI   0(RE),C' '                                                       
         JH    *+8                                                              
         JCT   RE,*-8                                                           
*                                                                               
         LLC   R0,SVBEST                                                        
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  2(3,RE),DUB                                                      
*                                                                               
         LA    RE,6(RE)                                                         
         ST    RE,DMCB+4           SET OUTPUT DATE POSN                         
         MVI   DMCB+4,11           SET TYPE=MMMDD/YY                            
         GOTOR VDATCON,DMCB,SVQSTART                                            
         L     RE,DMCB+4           POINT TO THE OUTPUT                          
         ICM   RF,3,6(RE)          GET THE YY                                   
         MVC   5(2,RE),=C'20'      OVERWRITE THE /                              
         STCM  RF,3,7(RE)                                                       
*                                                                               
         MVC   P2(14),=C'++DDS      FIL'                                        
*                                                                               
         MVC   P2+15(33),REPAUSR                                                
         LA    RE,P2+15                                                         
         CLC   REPAUSR,SPACES                                                   
         JE    DXFMT02                                                          
*                                                                               
         AHI   RE,33                                                            
         CLI   0(RE),C' '                                                       
         JH    *+8                                                              
         JCT   RE,*-8                                                           
*                                                                               
DXFMT02  MVI   1(RE),C'-'                                                       
         MVC   2(3,RE),SVQBYR                                                   
*                                                                               
         MVI   5(RE),C'{'                                                       
         MVC   6(30,RE),P1+21       PRINT CLT/PRD/EST/DATE AGAIN !              
         J     EXIT                                                             
         EJECT                                                                  
*=============================================================                  
* FORMAT APPL PART OF ++DDS REC RECORD                                          
*=============================================================                  
                                                                                
DXFMTAPP NTR1  BASE=*,LABEL=*      FORMAT APPLICATION PART OF ++DDS REC         
         USING SPEDICTD,R1                                                      
         MVI   SPCPTYPE,SPCPDATQ                                                
         MVC   SPCPMED,SVMED                                                    
         MVC   SPCPCLT,SVQCLT                                                   
         MVC   SPCPPRD,SVQPRD                                                   
         MVC   SPCPEST,SVQEST                                                   
         MVC   SPCPMKT,SVQMKT                                                   
         MVC   SPCPSTA,SVQSTA                                                   
         MVC   SPCPRQST,SVQBYR                                                  
         MVC   SPCDRORD,SVQORDER                                                
         LA    R1,SPCDRUSR                                                      
         USING RTN2SNDR,R1                                                      
         MVC   RTNSYSID,SAVSYSID                                                
         MVC   RTNPWRCD,LP_AGY                                                  
         MVC   RTNAGYMD,SAVAGYMD                                                
         J     EXIT                                                             
         DROP  R1                                                               
*                                                                               
DXTRAN   DC    CL14'++DDS SPXDXTRN'                                             
DXEMAIL  DC    C'N'                                                             
         EJECT                                                                  
*================================================================               
* READ STANDARD COMMENT RECORD                                                  
*================================================================               
                                                                                
DARSTD   NTR1  BASE=*,LABEL=*                                                   
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY                                                         
         USING COMRECD,R2                                                       
         MVI   COMKTYP,X'0D'                                                    
         MVI   COMKSUB,X'33'                                                    
         MVC   COMKAM,SVBAGM                                                    
         MVC   COMKCOM,0(R1)                                                    
         OC    COMKCOM,SPACES      SHOULDN'T NEED THIS !                        
         DROP  R2                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO5'                               
         J     EXITCC                                                           
         EJECT                                                                  
*===============================================================                
* PRINT A COMMENT RECORD. ELCDLO HAS TEXT ELEMENT ID                            
*===============================================================                
                                                                                
DARPRT   NTR1  BASE=*,LABEL=*                                                   
         MVI   REPALLN,8           ALLOW 8 LINES WITHOUT A BREAK                
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO5'                              
*                                                                               
         L     R4,AIO5                                                          
         MVC   ELCDHI,ELCDLO       COPY ELCODE                                  
         BRAS  RE,GETEL                                                         
         J     DARPRT3                                                          
*                                                                               
DARPRT2  BRAS  RE,NEXTEL                                                        
DARPRT3  JNE   DARPRTX                                                          
*                                                                               
         LLC   RE,1(R4)                                                         
         AHI   RE,-4               ADJUST FOR OVERHEAD                          
         JM    DARPRT2                                                          
*                                                                               
         MVC   P1(0),3(R4)                                                      
         EX    RE,*-6                                                           
         OC    P1,SPACES                                                        
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         J     DARPRT2                                                          
*                                                                               
DARPRTX  DS    0H                  SKIP A LINE AFTER COMMENT                    
         MVI   REPPRNSA,1                                                       
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         J     EXIT                                                             
         EJECT                                                                  
*================================================================               
* PRINT THE FAX                                                                 
*================================================================               
PRFAX    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    BUYHISD(BUYHKEYH),BUYHISD   SEE IF RECORD IN TSAR BUFFER         
         MVI   BHISTYPE,BHISTYPQ   GET FIRST BUY TSAR RECORD                    
         GOTOR BUFFER,DMCB,('TSARDH',0)                                         
*                                                                               
         XC    RPTTOTS,RPTTOTS     CLEAR REPORT TOTALS                          
*                                                                               
         BRAS  RE,SETHEAD          SET THE SUBPROGRAM                           
         MVI   REPFHEAD,C'Y'       FORCE HEAD PRINTING                          
*                                                                               
*===================================================================            
* BUILD A BUFFER OF OCOMS THAT APPLY TO THIS MD/CLT/PRD/EST                     
* THESE COMMENTS PRINT AFTER THE REPORT HEADLINES BUT BEFORE SKED               
*===================================================================            
                                                                                
PRF010   LA    R1,WORK                                                          
         USING OMCOMD,R1                                                        
*                                                                               
         MVI   OMCACT,C'G'                                                      
         MVC   OMCLBUFF,=H'7000'                                                
         MVC   OMCABUFF,AIO5       THIS WILL BLOW AWAY AIO6 ALSO                
         MVC   OMCACOMF,ACOMFACS                                                
         MVC   OMCAGMD,SVBAGM                                                   
         MVC   OMCCLT,SVBCLT                                                    
         MVC   OMCPRD,SVBPRD                                                    
         MVC   OMCEST,SVBEST                                                    
         MVC   OMCFLT,SVBFLT                                                    
*                                                                               
         GOTOR VSPOMCOM,(R1)                                                    
*                                                                               
         OC    OMCCOUNT,OMCCOUNT   TEST ANY COMMENTS                            
         JZ    PRF030                                                           
*                                                                               
         MVI   REPFMIDS,C'N'                                                    
         L     R4,AIO5                                                          
         LH    R3,OMCCOUNT                                                      
*                                                                               
         MVI   REPPRNSA,1                                                       
         GOTOR GOREPORT,DMCB,('REPAPUT',0)   SKIP A LINE                        
*                                                                               
PRF020   MVC   P1(72),8(R4)                                                     
         MVC   P1+73(8),0(R4)      SHOW COMMENT SOURCE                          
         CLC   0(8,R4),80(R4)      TEST NEXT COM HAS SAME SOURCE                
         JE    *+8                                                              
         MVI   REPPRNSA,2          ELSE FORCE EXTRA BLANK LINE                  
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         AHI   R4,80                                                            
         JCT   R3,PRF020                                                        
*                                                                               
PRF030   L     R4,AIO3             POINT TO ORDER RECORD                        
         LA    R4,24(R4)                                                        
         USING DOIDELD,R4                                                       
*                                                                               
         LA    R1,DOISCOM1         STANDARD COMMENT 1                           
         LA    R0,3                MAX 3 STANDARD COMMENTS                      
         MVI   ELCDLO,X'10'        STANDARD COMMENT TEXT ELEM                   
*                                                                               
PRF040   CLI   0(R1),C' '                                                       
         JNH   PRF050                                                           
*                                                                               
         BRAS  RE,DARSTD           READ STANDARD COMMENT                        
         JNE   PRF050                                                           
         BRAS  RE,DARPRT           PRINT STANDARD COMMENT                       
*                                                                               
PRF050   LA    R1,8(R1)                                                         
         JCT   R0,PRF040                                                        
*============================================================                   
* NOW PRINT ORDER COMMENTS                                                      
*============================================================                   
                                                                                
         L     R4,AIO3             POINT TO ORDER RECORD                        
         XC    IOKEY,IOKEY                                                      
         MVC   IOKEY(13),0(R4)     MOVE ORDER KEY                               
         LA    R4,IOKEY                                                         
         USING DAREORDD,R4                                                      
         MVI   DOKCMT,DOKCAGCQ     X'01' - SET FOR COMMENT RECORD               
         DROP  R4                                                               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO5'                               
         JE    PRF070                                                           
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JNZ   PRF080                                                           
         DC    H'0'                                                             
*                                                                               
PRF070   MVI   ELCDLO,X'30'        ORDER COMMENT ELCODE                         
         BRAS  RE,DARPRT           DO GETREC AND PRINT                          
         EJECT                                                                  
*====================================================================           
* NOW PRINT THE ORDER                                                           
*====================================================================           
                                                                                
PRF080   MVI   REPFMIDS,C'Y'       FORCE MIDLINE PRINTING                       
*                                                                               
         XC    BUYHISD(BUYHKEYH),BUYHISD   SEE IF RECORD IN TSAR BUFFER         
         MVI   BHISTYPE,BHISTYPQ   GET FIRST BUY TSAR RECORD                    
         GOTOR BUFFER,DMCB,('TSARDH',0)                                         
         TM    TSERRS,TSEEOF       END-OF-FILE?                                 
         JO    PRF090                                                           
         CLI   BHISTYPE,BHISTYPQ   DID WE FIND A BUY TSAR RECORD?               
         JE    PRF100                                                           
PRF090   MVI   REPFMIDS,C'N'                                                    
*                                                                               
         MVC   P1(29),=C'** NO BUYS ON THIS STATION **'                         
*                                                                               
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         J     PRFX                                                             
*                                                                               
PRF100   LLC   R4,PASS                                                          
         BCTR  R4,0                                                             
         MHI   R4,12                                                            
         LA    R4,PASSTAB(R4)                                                   
         GOTOR VDATCON,DMCB,0(R4),(2,BPERST)  GET 2-BYTE PER START              
         GOTOR (RF),(R1),6(R4),(2,BPEREND)    AND END DATES                     
*                                                                               
         XC    PASSTOTS,PASSTOTS   CLEAR PASS TOTALS                            
         MVI   PASSACT,C'N'        RESET PASS ACTIVE FLAG                       
                                                                                
* NOW GET DISPLACEMENT OF START WEEK IN WEEKTAB                                 
                                                                                
         LA    R4,WEEKTAB                                                       
         LHI   R3,53                                                            
PRF110   CLC   BPERST,0(R4)        MATCH DATE                                   
         JE    PRF120                                                           
         AHI   R4,4                                                             
         JCT   R3,PRF110                                                        
         DC    H'0'                                                             
*                                                                               
PRF120   LA    R0,WEEKTAB                                                       
         SR    R4,R0                                                            
         STH   R4,WEEKDSPL         SAVE START DSPL IN WEEKTAB                   
         STH   R4,DOLDSPL          SAME DSPL IN BHDOLS                          
*                                                                               
         LHI   R0,53                                                            
         SR    R0,R3                                                            
         STH   R0,SPTDSPL          SET DSPL OF START WEEK IN BHSPTS             
         XC    WEEKSPTS,WEEKSPTS                                                
         J     PRF140                                                           
*                                                                               
PRF130   MVI   ANYCHANG,C'N'                                                    
         GOTOR BUFFER,DMCB,('TSANXT',0)                                         
         JNE   PRF400                                                           
         CLI   BHISTYPE,BHISTYPQ   DID WE GET A BUY TSAR RECORD?                
         JNE   PRF130                                                           
         CLI   BHISSEQ,BHDATQ      IGNORE NON-BUY X'00' DATA                    
         JNE   PRF130                                                           
*                                                                               
PRF140   LA    R1,BHISSTA                                                       
         BRAS  RE,GETQSTA                                                       
*                                                                               
         CLI   BHFLAG,0            TEST DELETED BUY                             
         JE    PRF190              NO                                           
                                                                                
* SPOT COUNTERS REFLECT PREVIOUS ACTIVITY                                       
* SEE IF NEED TO PRINT THIS DELETED BUY FOR THIS PERIOD                         
                                                                                
         LA    R4,WEEKTAB          COUNT NUMBER OF ACTIVE WEEKS                 
         AH    R4,DOLDSPL          ADD 4 BYTE DSPL TO FIRST WEEK                
         SR    R0,R0                                                            
*                                                                               
PRF150   AHI   R4,4                NEXT WEEK IN TABLE                           
         CLC   0(2,R4),BPEREND     TEST STILL IN PERIOD                         
         JH    *+8                                                              
         JCT   R0,PRF150                                                        
*                                                                               
         BCTR  R0,0                ADD ONE TO COUNT                             
         LPR   R0,R0                                                            
*                                                                               
         LA    RE,BHSPTS           SPTS/WEEK TABLE                              
         AH    RE,SPTDSPL                                                       
*                                                                               
PRF160   CLI   0(RE),0                                                          
         JNE   PRF170                                                           
         AHI   RE,1                                                             
         JCT   R0,PRF160                                                        
         J     PRF230                                                           
*                                                                               
PRF170   CLI   PASSACT,C'Y'        TEST FIRST ACTIVITY                          
         JE    PRF180                                                           
         MVI   PASSACT,C'Y'        SET ACTIVITY FLAG                            
         CLI   REPFMIDS,C'Y'       IF FORCEMID SET?                             
         JE    PRF180              SKIP FORCEHEAD                               
         MVI   REPFHEAD,C'Y'                                                    
*                                                                               
PRF180   MVI   ANYCHANG,C'Y'       SET CHANGED !                                
         MVC   P1(3),SVQEST                                                     
         CLI   SVSTAEDT,C'0'       IS IT CABLE?                                 
         JL    *+10                                                             
         MVC   P1(3),SVSTAEDT+L'STAPQSTA     SHOW THE NETWORK                   
*                                                                               
         MVI   P1+3,C'-'                                                        
         LLH   R0,BHISLIN                                                       
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P1+4(3),DUB                                                      
         MVC   P1+8(16),=C'==> DELETED <=='                                     
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         J     PRF230                                                           
*                                                                               
PRF190   BRAS  RE,SETMYSPT         SET SPOT COUNTS ACROSS RATES                 
*                                                                               
         BRAS  RE,BUYSKED          FORMAT BUY DATA                              
         TM    ANYFLAG1,AF1SPOTS   X'80' - ANY ACTIVITY FOR THIS PASS?          
         JZ    PRF230                                                           
*                                                                               
         SR    R3,R3                                                            
         MVC   SVTSRNM2,TSRNUM     SAVE CURRENT TSAR REC NUMBER                 
PRF200   GOTOR BUFFER,DMCB,('TSANXT',0) READ FOR ADDITIONAL RECORDS             
         JNE   PRF220                                                           
*                                                                               
         CLI   BHISTYPE,BHISTYPQ   DID WE GET A BUY TSAR RECORD?                
         JNE   PRF220                                                           
         CLI   BHISSEQ,0           TEST BUY DATA                                
         JE    PRF220              YES - NO COMMENTS                            
         CLI   BHISSEQ,BHDOLQ      SKIP X'01' DOLLAR RECORD                     
         JE    PRF200                                                           
         CLI   BHISSEQ,BHTAXQ      AND X'02' TAX RECORD                         
         JE    PRF200                                                           
*                                                                               
         LHI   R3,4                ASSUME 4 LINES OF BUY DATA                   
*                                                                               
PRF210   AHI   R3,1                ADD ONE FOR THIS DATA LINE                   
         GOTOR BUFFER,DMCB,('TSANXT',0)                                         
         JNE   PRF220                                                           
         CLI   BHISTYPE,BHISTYPQ   DID WE GET A BUY TSAR RECORD?                
         JNE   PRF220                                                           
         CLI   BHISSEQ,0           TEST ANOTHER SUPP REC                        
         JNE   PRF210                                                           
*                                                                               
PRF220   LTR   R3,R3               TEST ANY SUPP RECS                           
         JZ    *+8                                                              
         STC   R3,REPALLN                                                       
*                                                                               
         MVC   TSRNUM,SVTSRNM2     RESTORE TSAR REC NUMBER                      
         GOTOR BUFFER,DMCB,('TSAGET',0)                                         
         JNE   *+2                                                              
                                                                                
*=====================================================                          
* READ FOR ORDER HISTORY RECORD                                                 
*=====================================================                          
                                                                                
PRF230   XC    IOKEY,IOKEY                                                      
K        USING OHISRECD,IOKEY                                                   
         MVI   K.OHISTYP,OHISTYQ             X'0D'                              
         MVI   K.OHISSTYP,OHISSTYQ           X'1B'                              
         MVC   K.OHISORD,BINORDER                                               
         MVC   K.OHISBUYK(L'SVBUYKEY),SVBUYKEY                                  
         MVC   K.OHISBKST(L'BHISSTA),BHISSTA   STATION !                        
         MVC   K.OHISBKLN,BHISLIN+1            BUYLINE NUMBER                   
         CLI   BHISLIN,0                       2-BYTE BLN?                      
         BE    *+10                                                             
         MVC   K.OHISBKL2,BHISLIN              YES, SET 2-BY BLN NUMBER         
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOXSPDIR+IO6'                            
         MVI   ANYHIST,C'N'              ASSUME NO HISTORY                      
         JNE   PRF240                                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOXSPFIL+IO6'                        
*                                                                               
         L     R4,AIO6                                                          
         AHI   R4,OBDELEM-OHISKEY                                               
*                                                                               
         MVI   ELCDLO,OBDELEMQ     THEN POINT TO PREV VRSN DATA                 
         MVI   ELCDHI,OBDELEMQ                                                  
         BRAS  RE,NEXTEL2                                                       
         JNE   PRF240                                                           
         MVI   ANYHIST,C'Y'              SET HISTORY RECORD PRESENT             
*                                                                               
         USING OBDELEM,R4                                                       
         CLI   BHFLAG,0            TEST DELETED                                 
         JNE   PRF395                                                           
         CLI   SVRESEND,C'Y'       TEST RESEND                                  
         JNE   PRF240                                                           
         MVI   ELCDLO,X'15'        THEN POINT TO PREV VRSN DATA                 
         MVI   ELCDHI,X'15'                                                     
         BRAS  RE,NEXTEL                                                        
         JE    *+6                                                              
         SR    R4,R4               CLEAR ELEM POINTER                           
*                                                                               
PRF240   TM    ANYFLAG1,AF1SPOTS   X'80' - TEST TO PRINT                        
         JZ    PRF395                                                           
         CLI   SVCURREV,0          TEST ORIGINAL ORDER                          
         JE    PRF260              YES                                          
         CLI   OBDFLAG,0           TEST BUY WAS DELETED                         
         JNE   PRF250              YES - SO NOW IT IS 'NEW' AGAIN               
*                                                                               
         CLI   SHOWCHGS,C'Y'                                                    
         JNE   PRF260                                                           
         LTR   R4,R4               TEST NO PREVIOUS ELEM                        
         JZ    *+12                YES - SO MUST BE NEW                         
         CLI   ANYHIST,C'Y'        TEST FOUND HISTORY RECORD                    
         JE    PRF260              YES - SO NOT NEW                             
PRF250   MVC   P3(11),=C'==> NEW <=='                                           
*                                                                               
PRF260   GOTOR GOREPORT,DMCB,('REPAPUT',0)  PRINT BUY DETAILS                   
                                                                                
* CHECK FOR SUPPLEMENTAL RECORDS                                                
                                                                                
         MVC   SVTSRNM2,TSRNUM     SAVE CURRENT TSAR REC NUMBER                 
PRF270   GOTOR BUFFER,DMCB,('TSANXT',0)                                         
         JNE   PRF310                                                           
         CLI   BHISTYPE,BHISTYPQ   DID WE GET A BUY TSAR RECORD?                
         JNE   PRF310                                                           
         CLI   BHISSEQ,BHDATQ      TEST BUYLINE X'00' DATA                      
         JE    PRF310              YES - NO (MORE) SUPP DATA                    
*                                                                               
         CLI   BHISSEQ,BHCOVQ      TEST COST OVRD REC (X'10'-X'18')             
         JL    PRF270                                                           
         CLI   BHISSEQ,BHCOVQ+8                                                 
         JH    PRF280                                                           
*                                                                               
         BRAS  RE,BUYSKED          PRINT COST OVERRIDE AND SPOTS                
         MVC   SKDAYS-2(20),=C'** COST OVERRIDES **'                            
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         J     PRF270                                                           
*                                                                               
PRF280   CLI   BHISSEQ,BHORBQ      TEST AN X'20' ORBIT RECORD                   
         JNE   PRF290              NO                                           
*                                                                               
         BRAS  RE,PRTORB                                                        
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         GOTOR BUFFER,DMCB,('TSANXT',0) READ FOR COMMENT RECORD                 
         JNE   PRF310                                                           
         CLI   BHISTYPE,BHISTYPQ   DID WE GET A BUY TSAR RECORD?                
         JNE   PRF310                                                           
*                                                                               
PRF290   CLI   BHISSEQ,BHCOMQ      TEST A X'30' COMMENT RECORD                  
         JL    PRF310              NO                                           
*                                                                               
         MVC   SKTIME(14),=C'** COMMENTS **'                                    
         LA    R3,SKGRID           COMMENTS PRINT UNDER GRID                    
*                                                                               
PRF300   SR    RF,RF                                                            
         ICM   RF,3,BHISLEN                                                     
         AHI   RF,-(BUYHKEYH+1)                                                 
         MVC   0(0,R3),BHCOM                                                    
         EX    RF,*-6                                                           
*                                                                               
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
         GOTOR BUFFER,DMCB,('TSANXT',0)                                         
         JNE   PRF310                                                           
         CLI   BHISTYPE,BHISTYPQ   DID WE GET A BUY TSAR RECORD?                
         JNE   PRF310                                                           
         CLI   BHISSEQ,BHCOMQ      TEST A X'30' COMMENT                         
         JNL   PRF300              YES                                          
*                                                                               
PRF310   MVC   TSRNUM,SVTSRNM2     RESTORE TSAR BUYREC NUMBER                   
         GOTOR BUFFER,DMCB,('TSAGET',0)                                         
         JNE   *+2                                                              
*                                                                               
         CLI   ANYHIST,C'Y'        TEST ORDER HISTORY FOUND                     
         JNE   PRF390                                                           
*                                                                               
         LTR   R4,R4               TEST NO PREV ELEMENT                         
         JZ    PRF390                                                           
         CLI   OBDFLAG,0           TEST BUY WAS DELETED                         
         JNE   PRF390              YES - SO IT WAS NEW AND THAT'S ALL           
*                                                                               
         CLI   SHOWCHGS,C'Y'                                                    
         JNE   PRF390                                                           
*                                                                               
         LA    R2,P1                                                            
         MVC   0(14,R2),=C'==> CHANGES TO'                                      
         AHI   R2,15                                                            
*                                                                               
         MVI   ANYCHANG,C'N'       ASSUME NO CHANGES                            
*                                                                               
         CLC   OBDDAY,BHBDDAY                                                   
         JE    PRF320                                                           
         MVI   ANYCHANG,C'Y'                                                    
         MVC   0(5,R2),=C'DAYS,'                                                
         AHI   R2,5                                                             
*                                                                               
PRF320   CLC   OBDTIME,BHBDTIME                                                 
         JE    PRF330                                                           
         MVI   ANYCHANG,C'Y'                                                    
         MVC   0(5,R2),=C'TIME,'                                                
         AHI   R2,5                                                             
*                                                                               
PRF330   CLC   OBDSEC,BHBDSEC                                                   
         JE    PRF340                                                           
         MVI   ANYCHANG,C'Y'                                                    
         MVC   0(8,R2),=C'SPOTLEN,'                                             
         AHI   R2,8                                                             
*                                                                               
PRF340   CLC   OBDCOST,BHBDCOST                                                 
         JE    PRF350                                                           
         MVI   ANYCHANG,C'Y'                                                    
         MVC   0(5,R2),=C'COST,'                                                
         AHI   R2,5                                                             
*                                                                               
PRF350   CLC   OBDPROG,BHBDPROG                                                 
         JE    PRF360                                                           
         MVI   ANYCHANG,C'Y'                                                    
         MVC   0(8,R2),=C'PROGRAM,'                                             
         AHI   R2,8                                                             
*                                                                               
PRF360   OC    NUMDEMS,NUMDEMS     TEST PRINTING DEMOS                          
         JZ    PRF370              NO                                           
         CLC   OBDDEMS(32),BHDEMS  TEST DEMOS MATCH                             
         JE    PRF370                                                           
         MVI   ANYCHANG,C'Y'                                                    
         MVC   0(6,R2),=C'DEMOS,'                                               
         AHI   R2,6                                                             
*                                                                               
PRF370   LA    R1,BHSPTS                                                        
         AH    R1,SPTDSPL          POINT TO FIRST SCHEDULE WEEK                 
*                                                                               
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         USING OHSPTEL,R4                                                       
*                                                                               
         XC    MYSPTS,MYSPTS                                                    
         LLC   RF,1(R4)            GET ELEMENT LENGTH                           
         AHI   RF,-3               SET FOR EX                                   
         MVC   MYSPTS(0),OHDSPTS   MOVE SCHEDULE TO 53 BYTE AREA                
         EX    RF,*-6                                                           
*                                                                               
         LA    RE,MYSPTS                                                        
         AH    RE,SPTDSPL                                                       
         LH    RF,NUMWEEKS         GET NUMBER OF WEEKS THIS PASS                
         BCTR  RF,0                                                             
         CLC   0(0,R1),0(RE)                                                    
         EX    RF,*-6                                                           
         JE    PRF380                                                           
         MVC   0(8,R2),=C'SCHEDULE'                                             
         AHI   R2,8                                                             
         MVI   ANYCHANG,C'Y'       SET CHANGED                                  
*                                                                               
PRF380   BCTR  R2,0                                                             
         CLI   0(R2),C','                                                       
         JNE   *+8                                                              
         MVI   0(R2),C' '                                                       
         AHI   R2,1                                                             
*                                                                               
         CLI   ANYCHANG,C'Y'       TEST ANY CHANGES                             
         JE    PRF390                                                           
         MVC   P1,SPACES                                                        
         J     PRF395                                                           
*                                                                               
PRF390   GOTOR GOREPORT,DMCB,('REPAPUT',0)  PRINT CHANGE COMMENTS               
         EJECT                                                                  
*=================================================================              
* UPDATE ORDER HISTORY RECORD AS REQUIRED                                       
*=================================================================              
                                                                                
PRF395   MVC   SVTSRHIS(BUYHKEYL),BHISKEY                                       
         MVC   SVTSRNM2,TSRNUM     SAVE BUY TSAR NUMBER                         
         BRAS  RE,UPDORHIS         UPDATE ORDER HISTORY RECORD                  
                                                                                
         MVC   TSRNUM,SVTSRNM2     RESTORE TSAR BUYREC NUMBER                   
         GOTOR BUFFER,DMCB,('TSAGET',0)                                         
         JNE   *+2                                                              
         J     PRF130                                                           
         DROP  R4,K                                                             
         EJECT                                                                  
*=================================================================              
* PRINT SCHEDULE TOTALS                                                         
*=================================================================              
                                                                                
PRF400   OC    PASSSPTS,PASSSPTS   TEST ANYTHING TO PRINT                       
         JZ    PRF470                                                           
         MVI   REPPRNSA,1                                                       
         MVI   REPALLN,4                                                        
         GOTOR GOREPORT,DMCB,('REPAPUT',0)  SKIP A LINE                         
*                                                                               
         MVC   P1+4(10),=C'TOTALS FOR'                                          
         LLC   R4,PASS                                                          
         BCTR  R4,0                                                             
         MHI   R4,12                                                            
         LA    R4,PASSTAB(R4)      POINT TO DATES THIS PASS                     
         GOTOR VDATCON,DMCB,(R4),(8,P1+15)                                      
         MVI   P1+23,C'-'                                                       
         GOTOR (RF),(R1),6(R4),(8,P1+24)                                        
                                                                                
* SEE IF ANY WEEK HAS MORE THAN 100 SPOTS - IF SO, STAGGER TOTALS               
                                                                                
         MVI   TOOMANY,C'N'                                                     
         LHI   R4,14                                                            
         LA    R3,WEEKSPTS                                                      
*                                                                               
PRF405   CLC   0(2,R3),=H'99'                                                   
         JH    PRF410                                                           
         AHI   R3,2                                                             
         JCT   R4,PRF405                                                        
         J     PRF415                                                           
*                                                                               
PRF410   MVI   TOOMANY,C'Y'                                                     
*                                                                               
PRF415   LHI   R4,7                SET COUNTER                                  
         LA    R2,SKGRID           POINT TO FIRST PRINT POSN                    
         LA    R3,WEEKSPTS                                                      
*                                                                               
PRF420   LH    R0,0(R3)                                                         
         LH    R1,2(R3)                                                         
*                                                                               
         LTR   R0,R0                                                            
         JZ    PRF425                                                           
         EDIT  (R0),(3,(R2))                                                    
         MVI   3(R2),C'*'                                                       
*                                                                               
PRF425   AHI   R2,4                                                             
         LTR   R1,R1                                                            
         JZ    PRF435                                                           
         CLI   TOOMANY,C'Y'                                                     
         JE    PRF430                                                           
         EDIT  (R1),(3,(R2))                                                    
         MVI   3(R2),C'*'                                                       
         J     PRF435                                                           
*                                                                               
PRF430   EDIT  (R1),(3,132(R2))                                                 
         MVI   135(R2),C'*'                                                     
*                                                                               
PRF435   AHI   R2,4                NEXT OUTPUT WEEK                             
         AHI   R3,4                                                             
         JCT   R4,PRF420                                                        
*                                                                               
         ICM   R0,15,PASSSPTS                                                   
         JZ    PRF440                                                           
         EDIT  (R0),SKTOTSP                                                     
         MVI   SKTOTSP+4,C'*'                                                   
*                                                                               
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
PRF440   L     RE,PASSSPTS         ADD PASSTOTS TO RPTTOTS                      
         A     RE,RPTSPOTS                                                      
         ST    RE,RPTSPOTS                                                      
*                                                                               
         L     RE,PASSDOLS                                                      
         A     RE,RPTDOLS                                                       
         ST    RE,RPTDOLS                                                       
*                                                                               
         L     RE,PASSTAX                                                       
         A     RE,RPTTAX                                                        
         ST    RE,RPTTAX                                                        
*                                                                               
         OC    NUMDEMS,NUMDEMS     TEST PRINTING DEMOS                          
         JZ    PRF450              NO - SKIP DEMO TOTALING                      
*                                                                               
         LHI   R0,8                ADD PASS DEMS/EQDEMS TO RPT DEMS             
         LA    R2,PASSDEMS                                                      
         LA    R3,RPTDEMS                                                       
*                                                                               
PRF445   L     RE,0(R2)                                                         
         N     RE,=X'3FFFFFFF'                                                  
*                                                                               
         L     RF,0(R3)                                                         
         N     RF,=X'3FFFFFFF'                                                  
*                                                                               
         AR    RE,RF                                                            
         TM    0(R2),X'40'                                                      
         JZ    *+8                                                              
         O     RE,=X'40000000'                                                  
         ST    RE,0(R3)                                                         
*                                                                               
         AHI   R2,4                                                             
         AHI   R3,4                                                             
         JCT   R0,PRF445                                                        
                                                                                
* PRINT TOTALS FOR THIS PERIOD                                                  
                                                                                
PRF450   MVC   P1(12),=C'123456 SPOTS'                                          
         L     R0,PASSSPTS                                                      
         EDIT  (R0),(6,P1)                                                      
         CHI   R0,1                                                             
         JNE   *+8                                                              
         MVI   P1+11,C' '                                                       
*                                                                               
         MVI   EXCLTAX,C'N'                                                     
         CLI   P00XCLTX,C'Y'       TEST TO EXCLUDE TAX                          
         JNE   PRF452                                                           
         OC    PASSTAX,PASSTAX     TEST ANY TAX THIS TIME                       
         JZ    *+8                                                              
         MVI   EXCLTAX,C'Y'                                                     
*                                                                               
PRF452   L     R0,PASSDOLS                                                      
         CLI   EXCLTAX,C'Y'                                                     
         JNE   *+8                                                              
         S     R0,PASSTAX                                                       
         EDIT  (R0),(12,P1+13),2,ALIGN=LEFT,FLOAT=$                             
*                                                                               
         CLI   EXCLTAX,C'Y'        TEST TAX EXCLUDED                            
         JNE   PRF453                                                           
         MVC   P2+7(16),=C'EXCLUDING TAX OF'                                    
         L     R0,PASSTAX                                                       
         EDIT  (R0),(8,P2+24),2,ALIGN=LEFT,FLOAT=$                              
*                                                                               
PRF453   LA    R4,PASSDEMS                                                      
         SR    R3,R3                                                            
         ICM   R3,3,NUMDEMS                                                     
         JZ    PRF470                                                           
*                                                                               
PRF455   TM    0(R4),X'40'                                                      
         JZ    PRF460                                                           
         L     R1,0(R4)            ROUND 2-DEC TO 1-DEC PRECISION               
         N     R1,=X'3FFFFFFF'                                                  
         M     R0,=F'2'                                                         
         D     R0,=F'10'                                                        
         AHI   R1,1                                                             
         SRL   R1,1                                                             
         ST    R1,0(R4)                                                         
*                                                                               
PRF460   AHI   R4,8                NEXT UNEQUIV DEMO                            
         JCT   R3,PRF455                                                        
*                                                                               
         LA    R3,SVDEMNMS                                                      
         LA    R4,PASSDEMS                                                      
         LA    R1,P1+30                                                         
         LLH   R2,NUMDEMS                                                       
*                                                                               
PRF465   MVC   0(6,R1),0(R3)       DEMO NAME                                    
         L     R0,0(R4)                                                         
         EDIT  (R0),(9,8(R1)),1,ALIGN=LEFT                                      
         AHI   R3,6                NEXT DEMO NAME                               
         AHI   R4,8                NEXT UNEQIV DEMO VALUE                       
         AHI   R1,20                                                            
         JCT   R2,PRF465                                                        
*                                                                               
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
PRF470   MVC   P1,SPACES                                                        
         LLC   R0,PASS                                                          
         AHI   R0,1                                                             
         CLM   R0,1,MAXPASS                                                     
         JH    PRF475                                                           
         STC   R0,PASS                                                          
         J     PRF080                                                           
*                                                                               
PRF475   MVI   P1,0                                                             
         XC    REPAUSR,REPAUSR                                                  
         OI    REPHEADI,REPHSPAC                                                
         MVI   REPPRNSA,1                                                       
         GOTOR GOREPORT,DMCB,('REPAPUT',0)  SKIP A LINE                         
*                                                                               
         MVC   P1(30),=C'*****  TOTALS FOR ORDER  *****'                        
         MVC   P2(14),=C'* 123456 SPOTS'                                        
         MVI   P2+29,C'*'                                                       
         L     R0,RPTSPOTS                                                      
         EDIT  (R0),(6,P2+2)                                                    
*                                                                               
         MVI   EXCLTAX,C'N'                                                     
         CLI   P00XCLTX,C'Y'       TEST TO EXCLUDE TAX                          
         JNE   PRF480                                                           
         OC    RPTTAX,RPTTAX       TEST ANY TAX THIS TIME                       
         JZ    *+8                                                              
         MVI   EXCLTAX,C'Y'                                                     
*                                                                               
PRF480   L     R0,RPTDOLS                                                       
         CLI   EXCLTAX,C'Y'                                                     
         JNE   *+8                                                              
         S     R0,RPTTAX                                                        
         EDIT  (R0),(12,P2+16),2,ALIGN=LEFT,FLOAT=$                             
*                                                                               
         CLI   EXCLTAX,C'Y'        TEST TAX EXCLUDED                            
         JNE   PRF485                                                           
         MVC   P3(19),=C'*  EXCLUDING TAX OF'                                   
         L     R0,RPTTAX                                                        
         EDIT  (R0),(8,P3+20),2,ALIGN=LEFT,FLOAT=$                              
         MVI   P3+29,C'*'                                                       
*                                                                               
PRF485   LA    R4,P3               SET CLOSING *'S                              
         CLI   EXCLTAX,C'Y'                                                     
         JNE   *+8                                                              
         LA    R4,P4                                                            
         MVI   0(R4),C'*'                                                       
         MVC   1(29,R4),0(R4)                                                   
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
                                                                                
* UPDATE TOTAL DOLLARS AND SPOTS IN ORDER RECORD                                
                                                                                
         CLI   SVRESEND,C'Y'       TEST RESEND                                  
         JE    PRFX                                                             
         CLI   COPYTYPE,C'X'       TEST FAX COPY                                
         JNE   PRFX                                                             
*                                                                               
         L     R0,RPTDOLS                                                       
         CVD   R0,DUB                                                           
         ZAP   AGYDOLRS,DUB                                                     
         MVC   AGYNSPTS,RPTSPOTS                                                
*                                                                               
PRFX     J     EXITY                                                            
         EJECT                                                                  
*                                                                               
*=================================================================              
* GET THE HEADING AND SPEC                                                      
*=================================================================              
SETHEAD  NTR1  BASE=*,LABEL=*                                                   
         BRAS  RE,GETHDNG          GET HEADING ADDRESS                          
         ST    R1,REPAPHS                                                       
         BRAS  RE,GETHOOK          GET HOOK ADDRESS                             
         ST    R1,REPAUSR                                                       
         MVI   REPSUBPG,1                                                       
*                                                                               
         CLC   LP_AGY,=C'PC'       TEST OPTIMEDIA                               
         JNE   SEHE010                                                          
         CLI   SVCLTOFF,C'I'                                                    
         JNE   EXITY                                                            
         MVI   REPSUBPG,5          PUT SPECIAL HEADLINES OUT                    
         J     EXITY                                                            
*                                                                               
SEHE010  CLC   LP_AGY,=C'TH'       TEST ZENITH                                  
         JNE   EXITY                                                            
*                                                                               
         LA    RF,ZENTABX                                                       
         LA    R1,ZENTAB                                                        
         USING ZENTABD,R1                                                       
SEHE020  CR    R1,RF                                                            
         JH    *+2                 EOT???  BUG IN MY CODE!                      
         LLC   R0,ZNLEN                                                         
         OC    ZNACCAGY,ZNACCAGY                                                
         JZ    SEHE030                                                          
         CLC   ZNACCAGY,SVACCAGY   MATCH ON ACC AGENCY?                         
         JE    SEHE030                                                          
         AR    R1,R0               GET NEXT ENTRY                               
         J     SEHE020                                                          
*                                                                               
SEHE030  AHI   R0,-(ZNTABL)        HAVE ANY ACC OFF ENTRIES?                    
         JZ    SEHE050             - NOPE, FOUND A MATCH!!                      
         SRL   R0,1                DIVIDE BY 2 TO GET # OF ENTRIES              
*                                                                               
SEHE040  CLC   ZNACCOFC,SVACCOFC   MATCH ON ACC OFFICE CODE?                    
         JE    SEHE050                                                          
         LA    R1,ZNTAB2L(R1)                                                   
         JCT   R0,SEHE040                                                       
         AHI   R1,ZNTABL                                                        
         J     SEHE020             NO MATCH ACC OFFICE, GET NEXT ACCAGY         
*                                                                               
SEHE050  MVC   REPSUBPG,ZNSPROG                                                 
         DROP  R1                                                               
SEHEXY   J     EXITY                                                            
                                                                                
ZENTAB   DS    0X                  ACC AGENCY OVERRIDE TABLE                    
*                                                                               
SPROG11Q EQU   11                                                               
SPROG11  DC    AL1(SPROG11X-SPROG11)                                            
         DC    AL1(SPROG11Q)                                                    
         DC    X'0000'             NO ACC OFFICE                                
         DC    C'3A',C'3C',C'3D',C'3K',C'3P'                                    
SPROG11X DC    0X                                                               
*                                                                               
SPROG12Q EQU   12                                                               
SPROG12  DC    AL1(SPROG12X-SPROG12)                                            
         DC    AL1(SPROG12Q)                                                    
         DC    C'TH'                                                            
         DC    0X                                                               
SPROG12X DC    0X                                                               
*                                                                               
SPROG13Q EQU   13                                                               
SPROG13  DC    AL1(SPROG13X-SPROG13)                                            
         DC    AL1(SPROG13Q)                                                    
         DC    C'BS'                                                            
         DC    0X                                                               
SPROG13X DC    0X                                                               
*                                                                               
SPROG14Q EQU   14                                                               
SPROG14  DC    AL1(SPROG14X-SPROG14)                                            
         DC    AL1(SPROG14Q)                                                    
         DC    C'DF'                                                            
         DC    0X                                                               
SPROG14X DC    0X                                                               
*                                                                               
SPROG15Q EQU   15                                                               
SPROG15  DC    AL1(SPROG15X-SPROG15)                                            
         DC    AL1(SPROG15Q)                                                    
         DC    C'DW'                                                            
         DC    0X                                                               
SPROG15X DC    0X                                                               
*                                                                               
SPROG10Q EQU   10                                                               
SPROG10  DC    AL1(SPROG10X-SPROG10)                                            
         DC    AL1(SPROG10Q)                                                    
         DC    X'0000'                                                          
         DC    0X                                                               
SPROG10X DC    0X                                                               
*                                                                               
ZENTABX  DC    0X                                                               
*                                                                               
ZENTABD  DSECT                                                                  
ZNLEN    DS    X                   LENGTH OF ENTRY                              
ZNSPROG  DS    X                   ZENITH SPROG                                 
ZNACCAGY DS    CL2                 ACC AGENCY OVERRIDE                          
ZNTABL   EQU   *-ZENTABD                                                        
*                                                                               
ZNACCOFC DS    CL2                 2 CHAR ACC OFFICE CODE                       
ZNTAB2L  EQU   *-ZNACCOFC                                                       
*                                                                               
SVRDEF   CSECT                                                                  
         EJECT                                                                  
*=================================================================              
* UPDATE ORDER HISTORY RECORD AS REQUIRED                                       
*=================================================================              
UPDORHIS NTR1  BASE=*,LABEL=*                                                   
         XC    SVEL05,SVEL05                                                    
         XC    SVEL06,SVEL06                                                    
         XC    SVEL09,SVEL09                                                    
*                                                                               
         CLC   PASS,MAXPASS        TEST LAST PASS                               
         JNE   UOHX                NO - UPDATE LAST PASS ONLY !                 
         CLI   COPYTYPE,C'X'       ONLY UPDATE FOR FAX COPY                     
         JNE   UOHX                                                             
*                                                                               
         LA    R0,SVEL08           THIS OVERWRITES PRINT LINES                  
         LHI   R1,SVEL08X-SVEL08                                                
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         XC    FULL,FULL                                                        
         CLC   IOKEY(32),IOKEYSAV  DID WE FIND THE RECORD                       
         JNE   UOH040              NO                                           
*                                                                               
         MVI   ELCDLO,X'99'        FIND OLD ACTIVITY ELEM                       
         MVI   ELCDHI,X'99'                                                     
         L     R4,AIO6                                                          
         AHI   R4,OBDELEM-OHISRECD                                              
         BRAS  RE,NEXTEL2                                                       
         JNE   *+2                                                              
         USING OHACTVEL,R4                                                      
         MVC   FULL(3),OHACTADD    SAVE ELEM ADD DATE                           
*                                                                               
         CLI   SVRESEND,C'Y'       TEST RESEND                                  
         JNE   UOH010                                                           
         LA    R1,2(R4)                                                         
         OC    0(3,R1),0(R1)       TEST HAVE ADD DATE                           
         JZ    *+8                                                              
         AHI   R1,3                POINT TO CHANGE DATE                         
         MVC   0(3,R1),TODAYB      SET NEW ACTIVITY DATE                        
         J     UOH180              AND WRITE RECORD NOW                         
*                                                                               
UOH010   MVI   ELCDLO,OBDELEMQ     X'05'                                        
         MVI   ELCDHI,OBDELEMQ     X'05'                                        
         L     R4,AIO6                                                          
         AHI   R4,OBDELEM-OHISRECD                                              
         BRAS  RE,NEXTEL2                                                       
         JNE   UOH040                                                           
         MVC   SVEL05,0(R4)                                                     
         MVI   SVEL05,OBDELEMQ+X'10' X'15' SET PREV VERSION ELCODE              
*                                                                               
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         CLI   0(R4),OHSPTELQ      X'06'                                        
         JNE   *+2                                                              
         MVC   SVEL06,0(R4)                                                     
         MVI   SVEL06,OHSPTELQ+X'10' X'16' SET PREV VERSION ELCODE              
*                                                                               
         LA    R2,SVEL08                                                        
*                                                                               
UOH020   LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         CLI   0(R4),OHCOVELQ      X'08'                                        
         JL    UOH020                                                           
         JH    UOH030                                                           
         MVC   0(62,R2),0(R4)      MOVE ELEMENT AT MAX LEN                      
         MVI   0(R2),OHCOVELQ+X'10'  X'18' SET PREV VERSION ELCODE              
         AHI   R2,L'SVEL08                                                      
         J     UOH020                                                           
*                                                                               
UOH030   CLI   0(R4),OHTAXELQ      TEST FOR TAX X'09'                           
         JNE   UOH040                                                           
         MVC   SVEL09,0(R4)                                                     
         MVI   SVEL09,OHTAXELQ+X'10' X'19' SET PREV VERSION ELCODE              
*                                                                               
UOH040   L     R0,AIO6             CREATE A NEW RECORD                          
         LHI   R1,IO6LQ                                                         
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     R4,AIO6                                                          
         USING OHISRECD,R4                                                      
*                                                                               
         MVC   0(32,R4),IOKEYSAV   MOVE IN RECORD KEY                           
         LHI   R0,OBDELEM-OHISRECD SET MIN LEN                                  
         STCM  R0,3,OHISLEN                                                     
*                                                                               
E        USING OBDELEM,ELEM                                                     
         XC    ELEM,ELEM                                                        
         MVI   ELEM,OBDELEMQ                                                    
         MVI   ELEM+1,OBDELEMX-OBDELEM                                          
*                                                                               
         CLI   BHFLAG,0              TEST DELETED BUYREC                        
         JE    *+14                  NO                                         
         MVC   E.OBDFLAG,SVCURREV    ELSE SAVE VERSION NUMBER                   
         J     UOH050                                                           
*                                                                               
         MVC   E.OBDDAY,BHBDDAY                                                 
         MVC   E.OBDTIME,BHBDTIME                                               
         MVC   E.OBDSEC,BHBDSEC                                                 
         MVC   E.OBDCOST,BHBDCOST                                               
         MVC   E.OBDCIND,BHBDCIND                                               
         MVC   E.OBDCIND2,BHBDCIN2                                              
         MVC   E.OBDPROG,BHBDPROG                                               
         MVC   E.OBDDEMS(32),BHDEMS                                             
         DROP  E                                                                
*                                                                               
UOH050   SR    R0,R0                                                            
         ICM   R0,3,OHISLEN                                                     
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'T',AIO6),ELEM,(R4)                                
*                                                                               
         XC    ELEM,ELEM                                                        
         MVI   ELEM,OHSPTELQ                                                    
         MVI   ELEM+1,3            SET MIN LENGTH                               
         CLI   BHFLAG,0            TEST DELETED                                 
         JNE   UOH060              YES - DO MIN ELEM                            
         OC    BHSPTS,BHSPTS       ANY SPOTS SCHEDULED                          
         JZ    UOH060                                                           
*                                                                               
         MVC   ELEM+2(53),BHSPTS                                                
         LA    RF,ELEM+54          POINT TO LAST POSSIBLE WEEK                  
         CLI   0(RF),0                                                          
         JNE   *+8                                                              
         JCT   RF,*-8                                                           
         LA    R0,ELEM                                                          
         SR    RF,R0                                                            
         AHI   RF,1                                                             
         STC   RF,ELEM+1           SET ELEM LEN                                 
*                                                                               
UOH060   L     R4,AIO6                                                          
         SR    R0,R0                                                            
         ICM   R0,3,OHISLEN                                                     
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'T',AIO6),ELEM,(R4)                                
*                                                                               
* ADD THE DOLLAR/COST ELEMENT                                                   
*                                                                               
         XC    ELEM,ELEM                                                        
         MVI   ELEM,OHDOLELQ       X'07' DOLLAR ELEMENT                         
         MVI   ELEM+1,3                                                         
         CLI   BHFLAG,0            TEST DELETED RECORD                          
         JNE   UOH090                                                           
*                                                                               
UOH064   GOTOR BUFFER,DMCB,('TSANXT',0)   READ FOR DOLLARS/TAX RECORDS          
         JNE   UOH090                                                           
         CLC   BHISKEY(6),SVTSRHIS    SAME TYPE/STATION/LINE?                   
         JNE   UOH090                                                           
         CLI   BHISSEQ,BHDOLQ      CHECK X'01' DOLLAR?                          
         JNE   UOH090                                                           
         OC    BHDOLS,BHDOLS       ANY DOLLARS?                                 
         JZ    UOH090                                                           
         MVC   ELEM+2(L'BHDOLS),BHDOLS                                          
         LA    RF,ELEM+2+L'BHDOLS-4   POINT TO LAST POSSIBLE WEEK               
*                                                                               
UOH070   OC    0(4,RF),0(RF)                                                    
         JNZ   UOH080                                                           
         AHI   RF,-4                                                            
         J     UOH070                                                           
UOH080   LA    R0,ELEM                                                          
         SR    RF,R0                                                            
         AHI   RF,4                                                             
         STC   RF,ELEM+1           SET ELEM LEN                                 
*                                                                               
UOH090   L     R4,AIO6                                                          
         SR    R0,R0                                                            
         ICM   R0,3,OHISLEN                                                     
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'T',AIO6),ELEM,(R4)                                
*                                                                               
* LETS ADD TAX IF ANY                                                           
*                                                                               
UOH100   MVC   TSRNUM,SVTSRNM2     RESTORE TSAR BUYREC NUMBER                   
         GOTOR BUFFER,DMCB,('TSAGET',0)                                         
         JNE   *+2                                                              
                                                                                
UOH105   CLC   BHISKEY(6),SVTSRHIS    SAME TYPE/STATION/LINE?                   
         JNE   UOH125                                                           
         CLI   BHISSEQ,BHTAXQ      CHECK X'02' TAX?                             
         JH    UOH125                                                           
         JE    UOH110                                                           
*                                                                               
         GOTOR BUFFER,DMCB,('TSANXT',0)   READ FOR DOLLARS/TAX RECORDS          
         JNE   UOH125                                                           
         J     UOH105                                                           
*                                                                               
UOH110   XC    ELEM,ELEM                                                        
         MVI   ELEM,OHTAXELQ       X'09' TAX ELEMENT                            
         MVI   ELEM+1,3                                                         
         MVC   ELEM+2(L'BHDOLS),BHDOLS                                          
         LA    RF,ELEM+2+L'BHDOLS-4   POINT TO LAST POSSIBLE WEEK               
*                                                                               
UOH115   OC    0(4,RF),0(RF)                                                    
         JNZ   UOH120                                                           
         AHI   RF,-4                                                            
         J     UOH115                                                           
UOH120   LA    R0,ELEM                                                          
         SR    RF,R0                                                            
         AHI   RF,4                                                             
         STC   RF,ELEM+1           SET ELEM LEN                                 
*                                                                               
         L     R4,AIO6                                                          
         SR    R0,R0                                                            
         ICM   R0,3,OHISLEN                                                     
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'T',AIO6),ELEM,(R4)                                
*                                                                               
* ADD COST OVERRIDE ELEMENTS                                                    
*                                                                               
UOH125   MVC   TSRNUM,SVTSRNM2     RESTORE TSAR BUYREC NUMBER                   
         GOTOR BUFFER,DMCB,('TSAGET',0)                                         
         JNE   *+2                                                              
*                                                                               
         CLI   BHFLAG,0            TEST DELETED RECORD                          
         JNE   UOH140                                                           
         LA    R2,COVTAB                                                        
         LHI   R3,8                                                             
*                                                                               
UOH130   XC    ELEM,ELEM                                                        
         MVI   ELEM,OHCOVELQ       X'08'                                        
         OC    0(56,R2),0(R2)      TEST COST AND SPOTS                          
         JZ    UOH140              NONE?  WE'RE DONE                            
*                                                                               
         MVC   ELEM+2(56),0(R2)    MOVE COST(3) AND SPOTS                       
         LA    RF,ELEM+57          POINT TO LAST POSSIBLE WEEK                  
         CLI   0(RF),0                                                          
         JNE   *+8                                                              
         JCT   RF,*-8                                                           
         LA    R0,ELEM                                                          
         SR    RF,R0                                                            
         AHI   RF,1                                                             
         STC   RF,ELEM+1           SET ELEM LEN                                 
*                                                                               
         L     R4,AIO6                                                          
         SR    R0,R0                                                            
         ICM   R0,3,OHISLEN                                                     
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'T',AIO6),ELEM,(R4)                                
*                                                                               
         AHI   R2,L'COVTAB                                                      
         JCT   R3,UOH130                                                        
*                                                                               
UOH140   XC    ELEM,ELEM                                                        
         MVI   ELEM,X'99'                                                       
         MVI   ELEM+1,8                                                         
         MVC   ELEM+2(3),FULL      ELEM ADD DATE                                
         LA    R1,ELEM+2                                                        
         OC    0(3,R1),0(R1)       TEST HAVE ADD DATE                           
         JZ    *+8                                                              
         AHI   R1,3                POINT TO CHANGE DATE                         
         MVC   0(3,R1),TODAYB                                                   
*                                                                               
         L     R4,AIO6                                                          
         SR    R0,R0                                                            
         ICM   R0,3,OHISLEN                                                     
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,(C'T',AIO6),ELEM,(R4)                                
*                                                                               
         CLC   IOKEY(32),IOKEYSAV  DID WE FIND THE RECORD                       
         JE    UOH150              YES                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOXSPFIL+IO6'                        
         J     UOHX                                                             
*                                                                               
UOH150   OC    SVEL05,SVEL05                                                    
         JZ    UOH180                                                           
         LLC   R0,1(R4)            INSERT PREVIOUS VERSION ELEMENTS             
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,,SVEL05,(R4)                                         
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,,SVEL06,(R4)                                         
*                                                                               
         LA    R2,SVEL08                                                        
         LHI   R3,8                                                             
*                                                                               
UOH160   CLI   0(R2),OHCOVELQ+X'10' IS THERE ANOTHER ELEMENT X'18'              
         JNE   UOH170                                                           
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,,(R2),(R4)                                           
         AHI   R2,L'SVEL08                                                      
         JCT   R3,UOH160                                                        
*                                                                               
UOH170   CLI   SVEL09,OHTAXELQ+X'10' TEST TAX ELEMENT X'19'                     
         JNE   UOH180                                                           
         LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         GOTOR ARECUP,DMCB,,SVEL09,(R4)                                         
*                                                                               
UOH180   GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOXSPFIL+IO6'                        
UOHX     J     EXITY                                                            
         EJECT                                                                  
*==============================================================                 
* SET SPOT COUNTS ACROSS ALL RATE TYPES FOR THIS BUY                            
*==============================================================                 
                                                                                
SETMYSPT NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    MYSPTS,MYSPTS                                                    
         ICM   RF,3,BHISLEN                                                     
         AHI   RF,-(BHSPTS-BUYHISD)-1                                           
         MVC   MYSPTS(0),BHSPTS    SET SPOTS FOR BDCOST                         
         EX    RF,*-6                                                           
         MVC   SVTSRNM2,TSRNUM     SAVE CURRENT TSAR REC NUMBER                 
*                                                                               
         LA    R0,COVTAB                                                        
         LHI   R1,COVTABX-COVTAB                                                
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         LA    R4,COVTAB                                                        
SETMYSP2 GOTOR BUFFER,DMCB,('TSANXT',0)                                         
         JNE   SETMYSPX                                                         
         CLI   BHISTYPE,BHISTYPQ   BUY TSAR RECORD?                             
         JNE   SETMYSPX                                                         
*                                                                               
         CLI   BHISSEQ,BHCOVQ      TEST RATE DATA                               
         JL    SETMYSPX            NO - DONE                                    
         CLI   BHISSEQ,BHCOVQ+8                                                 
         JH    SETMYSPX                                                         
*                                                                               
         MVC   0(3,R4),BHBDCOST    MOVE COST OVERRIDE                           
         OC    0(3,R4),0(R4)                                                    
         JNZ   *+8                                                              
         OI    0(R4),X'80'                                                      
         SR    RF,RF                                                            
         ICM   RF,3,BHISLEN                                                     
         AHI   RF,-(BHCSPTS-BUYHISD)-1  SETUP FOR EX                            
         MVC   3(0,R4),BHCSPTS     AND SPOTS                                    
         EX    RF,*-6                                                           
         AHI   R4,L'COVTAB                                                      
*                                                                               
         LA    RE,MYSPTS                                                        
         LA    RF,BHCSPTS                                                       
         LHI   R0,53                                                            
         SR    R2,R2                                                            
         SR    R3,R3                                                            
*                                                                               
SETMYSP4 IC    R2,0(RE)                                                         
         IC    R3,0(RF)                                                         
         AR    R2,R3                                                            
         STC   R2,0(RE)                                                         
*                                                                               
         AHI   RE,1                                                             
         AHI   RF,1                                                             
         JCT   R0,SETMYSP4                                                      
         J     SETMYSP2                                                         
*                                                                               
SETMYSPX MVC   TSRNUM,SVTSRNM2     RESTORE TSAR REC NUMBER                      
         GOTOR BUFFER,DMCB,('TSAGET',0)                                         
         JNE   *+2                                                              
         J     EXIT                                                             
         EJECT                                                                  
*===============================================================                
* PRINT THE BUY SCHEDULE                                                        
* MYSPTS HAS SPOT COUNTS BY WEEK FOR ALL RATES FOR THIS BUYLINE                 
* SO THAT IF ANY RATE IS ACTIVE, THE BUY DESC DATA WILL PRINT!                  
*===============================================================                
BUYSKED  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         MVC   SVTSRNM3,TSRNUM     SAVE CURRENT TSAR REC NUMBER                 
*                                                                               
* COUNT NUMBER OF DAYS (OR WEEKS) IN THIS PERIOD                                
                                                                                
         LA    R4,WEEKTAB                                                       
         AH    R4,DOLDSPL          ADD 4 BYTE DSPL TO FIRST WEEK                
         SR    RE,RE                                                            
*                                                                               
BUYSK010 AHI   R4,4                NEXT WEEK IN TABLE                           
         CLC   0(2,R4),BPEREND     TEST STILL IN PERIOD                         
         JH    *+8                                                              
         JCT   RE,BUYSK010                                                      
*                                                                               
         BCTR  RE,0                ADD ONE TO COUNT                             
         LPR   RE,RE                                                            
         STH   RE,NUMWEEKS         AND SAVE WEEKS IN THIS PERIOD                
*                                                                               
         XC    BUYSPTS,BUYSPTS     GET BUY TOTAL SPOTS/DOLS THIS PER            
         XC    BUYDOLS,BUYDOLS                                                  
         XC    BUYTAX,BUYTAX                                                    
                                                                                
         LA    RE,BHSPTS           SPTS/WEEK TABLE                              
         CLI   BHISSEQ,BHDATQ      X'00' DATA ELEM?                             
         JE    *+8                                                              
         LA    RE,BHCSPTS          COST OVERRIDE SPTS/WEEK TABLE                
         AH    RE,SPTDSPL                                                       
         LH    R0,NUMWEEKS                                                      
*                                                                               
BUYSK020 LLC   R1,0(RE)                                                         
         A     R1,BUYSPTS                                                       
         ST    R1,BUYSPTS                                                       
         AHI   RE,1                NEXT WEEK IN SPOT TABLE                      
         JCT   R0,BUYSK020                                                      
*                                                                               
         CLI   BHISSEQ,BHDATQ      X'00' DATA ELEM?                             
         JNE   BUYSK040                                                         
*                                                                               
BUYSK022 GOTOR BUFFER,DMCB,('TSANXT',0)   READ FOR DOLLARS/TAX RECORDS          
         JNE   BUYSK035                                                         
         CLI   BHISTYPE,BHISTYPQ   BUY TSAR RECORD?                             
         JNE   BUYSK035                                                         
         CLI   BHISSEQ,BHDOLQ      CHECK X'01' DOLLAR?                          
         JL    BUYSK035                                                         
         CLI   BHISSEQ,BHTAXQ      CHECK X'02' TAX?                             
         LA    RF,BHDOLS           MUST BE DOLLARS                              
         LA    RE,BUYDOLS                                                       
         JL    BUYSK025                                                         
         LA    RF,BHTAX            MUST BE TAX                                  
         LA    RE,BUYTAX                                                        
         JH    BUYSK035            ITS NEITHER, SKIP                            
*                                                                               
BUYSK025 AH    RF,DOLDSPL                                                       
         LH    R0,NUMWEEKS                                                      
*                                                                               
BUYSK030 ICM   R1,15,0(RF)                                                      
         A     R1,0(RE)                                                         
         ST    R1,0(RE)                                                         
         AHI   RF,4                NEXT WEEK IN DOLLAR TABLE                    
         JCT   R0,BUYSK030                                                      
         J     BUYSK022                                                         
*                                                                               
BUYSK035 MVC   TSRNUM,SVTSRNM3     RESTORE TSAR REC NUMBER                      
         GOTOR BUFFER,DMCB,('TSAGET',0)                                         
         JNE   *+2                                                              
*                                                                               
BUYSK040 L     R1,BUYSPTS                                                       
         A     R1,PASSSPTS                                                      
         ST    R1,PASSSPTS                                                      
*                                                                               
         L     R1,BUYDOLS                                                       
         A     R1,PASSDOLS                                                      
         ST    R1,PASSDOLS                                                      
*                                                                               
         L     R1,BUYTAX                                                        
         A     R1,PASSTAX                                                       
         ST    R1,PASSTAX                                                       
*                                                                               
         NI    ANYFLAG1,X'FF'-AF1SPOTS                                          
         CLI   BHISSEQ,BHDATQ      TEST BUY X'00' DESC REC                      
         JNE   BUYSK060             NO, WE'RE DOING COST OVERRIDE               
*                                                                               
         LA    R3,MYSPTS           POINT TO MY SPOT TABLE                       
         AH    R3,SPTDSPL          POINT TO FIRST WEEK THIS PASS                
*                                                                               
         LA    R4,WEEKTAB                                                       
         AH    R4,DOLDSPL          ADD 4 BYTE DSPL TO FIRST WEEK                
*                                                                               
         SR    R0,R0                                                            
         SR    RE,RE                                                            
*                                                                               
BUYSK050 ICM   R0,1,0(R3)          GET SPOT COUNTER                             
         AR    RE,R0                                                            
         AHI   R3,1                                                             
         AHI   R4,4                                                             
         CLC   0(2,R4),BPEREND     TEST REACHED END OF THIS PASS                
         JNH   BUYSK050                                                         
         LTR   RE,RE                                                            
         JZ    BUYSKX              NO ACTIVITY THIS PASS                        
*                                                                               
         ST    RE,MYBUYSPT         SAVE SPOT COUNT FOR CPP CALC                 
         OI    ANYFLAG1,AF1SPOTS   SET FLAG TO FORCE PRINTING                   
*                                                                               
BUYSK060 LA    R3,BHSPTS           POINT TO SCHEDULE                            
         CLI   BHISSEQ,BHDATQ      X'00' DATA ELEM?                             
         JE    *+8                                                              
         LA    R3,BHCSPTS          COST OVERRIDE SPTS/WEEK TABLE                
         AH    R3,SPTDSPL          POINT TO FIRST WEEK                          
*                                                                               
         LA    R4,WEEKTAB                                                       
         AH    R4,DOLDSPL          ADD 4 BYTE DSPL TO FIRST WEEK                
*                                                                               
         LA    R2,SKGRID           POINT TO FIRST PRINT POSN                    
         LA    RE,WEEKSPTS                                                      
*                                                                               
BUYSK070 SR    R0,R0                                                            
         ICM   R0,1,0(R3)          GET SPOT COUNT                               
*                                                                               
         CLI   PASSACT,C'Y'                                                     
         JE    BUYSK080                                                         
         MVI   PASSACT,C'Y'                                                     
         CLI   REPFMIDS,C'Y'       IF MIDLINE PENDING                           
         JE    BUYSK080            DON'T FORCE HEADLINES AGAIN                  
         MVI   REPFHEAD,C'Y'                                                    
*                                                                               
BUYSK080 LH    R1,0(RE)                                                         
         AR    R1,R0                                                            
         STH   R1,0(RE)                                                         
*                                                                               
         OI    ANYFLAG1,AF1SPOTS   SET FLAG TO FORCE PRINTING                   
         LTR   R0,R0                                                            
         JZ    BUYSK090                                                         
         EDIT  (R0),(3,(R2))                                                    
*                                                                               
BUYSK090 AHI   R3,1                NEXT BHSPTS VALUE                            
         AHI   R4,4                NEXT WEEKTAB ENTRY                           
         AHI   R2,4                NEXT GRID POSITION                           
         AHI   RE,2                NEXT WEEK TOTAL                              
         CLC   0(2,R4),BPEREND     TEST REACHED END OF THIS PASS                
         JNH   BUYSK070                                                         
*                                                                               
         L     R0,BUYSPTS                                                       
         EDIT  (R0),(4,SKTOTSP)    PUT OUT TOTAL SPOTS THIS LINE                
         MVI   SKTOTSP+4,C'*'                                                   
*                                                                               
         TM    ANYFLAG1,AF1SPOTS                                                
         JZ    BUYSKX                                                           
         CLI   BHISSEQ,BHDATQ      TEST X'00' BUYLINE DATA                      
         JNE   BUYSK110                                                         
*                                                                               
         MVC   SKBUYLIN,SVQEST                                                  
         CLI   SVSTAEDT,C'0'       IS IT CABLE?                                 
         JL    *+10                                                             
         MVC   SKBUYLIN,SVSTAEDT+L'STAPQSTA     SHOW THE NETWORK                
         MVI   SKBUYLIN+3,C'-'                                                  
         LLH   R0,BHISLIN          GET BUYLINE NUMBER                           
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SKBUYLIN+4(3),DUB                                                
*                                                                               
         LHI   R0,7                                                             
         LA    R1,SKDAYS                                                        
         MVC   0(7,R1),=C'MTWTFSS'                                              
*                                                                               
         LLC   RE,BHBDDAY                                                       
         SLL   RE,25               GET MONDAY BIT LEFT ALIGNED                  
*                                                                               
BUYSK100 LTR   RE,RE               REG IS NEG IF DAY BIT ON                     
         JM    *+8                                                              
         MVI   0(R1),C'.'                                                       
*                                                                               
         LA    R1,1(R1)                                                         
         SLL   RE,1                                                             
         JCT   R0,BUYSK100                                                      
*                                                                               
         GOTOR VUNTIME,DMCB,BHBDTIME,SKTIME                                     
*                                                                               
         MVC   SKPROG,BHBDPROG                                                  
*                                                                               
BUYSK110 CLI   PDXCOSTS,C'Y'       TEST TO PRINT COST                           
         JNE   BUYSK180                                                         
         SR    R0,R0                                                            
         ICM   R0,7,BHBDCOST       GET COST OR COSTOVERRIDE                     
         TM    BHBDCIN2,BDCNBRDQ                                                
         JO    BUYSK130                                                         
         C     R0,=F'99999999'      MAX COST IN 8 DIGITS                        
         JH    BUYSK120                                                         
         EDIT  (R0),(9,SKCOST),2                                                
         J     BUYSK180                                                         
*                                                                               
BUYSK120 AR    R0,R0               PRINT COST IN $                              
         SRDL  R0,32                                                            
         D     R0,=F'100'                                                       
         SRA   R1,1                                                             
         LR    R0,R1                                                            
BUYSK130 EDIT  (R0),(9,SKCOST),0,FLOAT=$                                        
*                                                                               
BUYSK180 CLI   BHISSEQ,BHDATQ      TEST X'00' BUYLINE DETAIL                    
         JNE   BUYSKX                                                           
         LLC   R0,BHBDSEC                                                       
         EDIT  (R0),(3,SKSLN)                                                   
         EJECT                                                                  
*=============================================================                  
* DEMOS                                                                         
*=============================================================                  
                                                                                
BUYSK200 LA    R3,SVDEMNMS                                                      
         LA    R4,BHDEMS                                                        
         LA    R2,SKDEMS                                                        
         SR    R5,R5                                                            
         ICM   R5,3,NUMDEMS                                                     
         JZ    BUYSKX                                                           
*                                                                               
BUYSK210 MVC   0(6,R2),0(R3)       MOVE DEMO NAME                               
         ICM   R1,15,4(R4)         DEMO FROM TSAR RECORD                        
         N     R1,=X'3FFFFFFF'     DROP FLAGS                                   
         TM    4(R4),X'40'         TEST 2 DECIMALS                              
         JZ    BUYSK230                                                         
         C     R1,=F'9999'         MAX VALUE TO 2 DEC                           
         JH    BUYSK220                                                         
         EDIT  (R1),(5,7(R2)),2                                                 
         J     BUYSK250                                                         
*                                                                               
BUYSK220 M     R0,=F'2'                                                         
         D     R0,=F'10'                                                        
         AHI   R1,1                                                             
         SRL   R1,1                                                             
*                                                                               
BUYSK230 C     R1,=F'9999'         MAX VALUE TO 1 DEC                           
         JH    BUYSK240                                                         
         EDIT  (R1),(5,7(R2)),1                                                 
         J     BUYSK250                                                         
*                                                                               
BUYSK240 M     R0,=F'2'                                                         
         D     R0,=F'10'                                                        
         AHI   R1,1                                                             
         SRL   R1,1                                                             
         EDIT  (R1),(5,7(R2))                                                   
*                                                                               
BUYSK250 TM    4(R4),X'80'         TEST OVERRIDE                                
         JZ    *+8                                                              
         MVI   12(R2),C'*'                                                      
*                                                                               
         CLI   PDXCPP,C'Y'         TEST TO PRINT CPP                            
         JNE   BUYSK320                                                         
                                                                                
*====================================================================           
* NOTE THAT BUYDOLS GOES ACROSS RATE TYPES BUT BUYSPOTS IS FOR CURRENT          
* RATE TYPE ONLY                                                                
* USE MYBUYSPT (COMPUTED ABOVE) WHICH IS TOTAL FOR THIS PASS ACROSS             
* ALL RATE TYPES                                                                
*====================================================================           
                                                                                
         L     R1,BUYDOLS          BUY DOLLARS IN PENNIES                       
*                                                                               
         L     RF,ATWA             ONLY TIME WE NEED TO USE ATWA                
         USING TWAD,RF             RF=A(TWA)                                    
         CLI   P00XCLTX,C'Y'       TEST EXCLUDE TAX FOR CPP CALC                
         JNE   *+8                                                              
         S     R1,BUYTAX                                                        
*                                                                               
         LHI   R0,20               SET TO MULT X 10 X 2                         
         TM    4(R4),X'40'         TEST DEMO TO 2-DEC                           
         JZ    *+8                                                              
         LHI   R0,200              THEN MULT DOLS X 100 X 2                     
         MR    R0,R0                                                            
         L     RF,4(R4)            DEMO VALUE                                   
         N     RF,=X'3FFFFFFF'                                                  
         M     RE,MYBUYSPT         USE SPOT COUNT ACROSS RATES                  
         LTR   RF,RF                                                            
         JZ    BUYSK320                                                         
         DR    R0,RF                                                            
         AHI   R1,1                                                             
         SRL   R1,1                GIVES CPP TO 2-DEC                           
         C     R1,=F'99999'        MAX VALUE TO 2-DEC                           
         JH    BUYSK310                                                         
         EDIT  (R1),(6,16(R2)),2                                                
         J     BUYSK320                                                         
*                                                                               
BUYSK310 M     R0,=F'2'                                                         
         D     R0,=F'100'                                                       
         AHI   R1,1                                                             
         SRL   R1,1                                                             
         EDIT  (R1),(6,16(R2)),0,FLOAT=$                                        
*                                                                               
BUYSK320 LA    R3,6(R3)            NEXT DEMO NAME                               
         AHI   R4,8                NEXT DEMO IN TSAR RECORD                     
         AHI   R2,132              NEXT DEMO GOES ON NEXT LINE                  
         JCT   R5,BUYSK210                                                      
*                                                                               
         BRAS  RE,EQUIV            GET EQUIVALENCED DEMO VALUES                 
*                                                                               
         LLH   R0,NUMDEMS          AND ADD THEM TO PASS TOTALS                  
         LA    R1,PASSDEMS                                                      
         LA    R3,BHDEMS           UNEQUIV DEMO TYPES/VALUES                    
         LA    R4,EQUDEMS          EQUIV VALUES                                 
*                                                                               
BUYSK330 L     RF,4(R3)            UNEQUIV DEMO VALUE                           
         N     RF,=X'3FFFFFFF'     DROP 2-DEC FLAG                              
         M     RE,MYBUYSPT         USE SPOT COUNT ACROSS RATE TYPES             
         A     RF,0(R1)            ADD TO UNEQUIV TOT                           
         TM    4(R3),X'40'         TEST 2-DEC                                   
         JZ    *+8                                                              
         O     RF,=X'40000000'                                                  
         ST    RF,0(R1)                                                         
*                                                                               
         L     RF,0(R4)            GET EQUIV DEMO VALUE                         
         N     RF,=X'3FFFFFFF'     DROP 2-DEC FLAG                              
         M     RE,BUYSPTS          X SPOTS THIS BUYLINE                         
         A     RF,4(R1)                                                         
         TM    0(R4),X'40'         TEST 2-DEC FLAG                              
         JZ    *+8                                                              
         O     RF,=X'40000000'                                                  
         ST    RF,4(R1)                                                         
*                                                                               
         AHI   R1,8                NEXT 00D9....                                
         AHI   R3,8                NEXT UNEQ/EQ PAIR                            
         AHI   R4,4                NEXT EQUIV DEMO                              
         JCT   R0,BUYSK330                                                      
*                                                                               
BUYSKX   J     EXIT                                                             
         EJECT                                                                  
*===============================================================                
* PRINT ORBIT DESCRIPTIONS                                                      
*===============================================================                
PRTORB   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   SKGRID,SPACES                                                    
         MVC   SKORB(11),=C'** ORBIT **'                                        
*                                                                               
         LA    R3,ORBTAB           POINT TO PRINT POSN TABLE                    
         LA    R5,BHORBS                                                        
*                                                                               
         SR    R2,R2                                                            
         ICM   R2,3,BHISLEN                                                     
         AHI   R2,-(BUYHKEYH+1)                                                 
         SRL   R2,3                DIVIDE BY 8 TO GET # OF ORBITS               
*                                                                               
PRTORB4  LH    R4,0(R3)                                                         
         LA    R4,SKORB(R4)                                                     
*                                                                               
         GOTOR VUNDAY,DMCB,0(R5),(R4)                                           
         BRAS  RE,ADDCOMMA                                                      
*                                                                               
         GOTOR VUNTIME,DMCB,1(R5),(R4)                                          
         BRAS  RE,ADDCOMMA                                                      
*                                                                               
         MVC   0(7,R4),5(R5)                PROGRAM                             
         BRAS  RE,ADDCOMMA                                                      
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,12(R5)                                                      
         N     R0,=X'FFFFBFFF'                                                  
         TM    12(R5),X'40'        IS IT 2 PRECISION                            
         JO    PRTORB6                                                          
         EDIT  (R0),(5,(R4)),1,ALIGN=LEFT   DEMO                                
         J     PRTORB9                                                          
PRTORB6  EDIT  (R0),(5,(R4)),2,ALIGN=LEFT   DEMO                                
*                                                                               
PRTORB9  AHI   R3,2                                                             
         AHI   R5,16                                                            
         CLI   0(R5),0             TEST MORE DATA                               
         JE    *+8                 NO                                           
         JCT   R2,PRTORB4                                                       
         J     EXIT                                                             
*                                                                               
ADDCOMMA AHI   R4,8                POINT TO END (MAX LEN 8)                     
*                                                                               
ADDCOMM2 OI    0(R4),C' '                                                       
         CLI   0(R4),C' '                                                       
         JNE   *+8                                                              
         JCT   R4,ADDCOMM2                                                      
         MVI   1(R4),C','                                                       
         AHI   R4,2                                                             
         BR    RE                                                               
*                                                                               
ORBTAB   DC    AL2(16,43,70,148,175,202,280,307,334) PRINT DSPLS                
         EJECT                                                                  
*===============================================================                
* SUBROUTINE TO EQUIVALENCE DEMOS IN TSDEM1...4                                 
* REMEMBER TSDEMS ARE 8 BYTE DEMOS WITH HDR PRECEDING                           
*===============================================================                
                                                                                
EQUIV    NTR1  BASE=*,LABEL=*                                                   
         XC    EQUDEMS,EQUDEMS                                                  
         OC    NUMDEMS,NUMDEMS                                                  
         JZ    EXIT                                                             
*                                                                               
         LHI   R0,SLNTABX-SLNTAB   FIND SLN IN SLNTAB                           
         LA    R1,SLNTAB                                                        
         LA    R3,EQUSECT1                                                      
*                                                                               
EQV2     CLI   0(R1),0             LAST SLNTAB ENTRY                            
         JE    EQV10                                                            
*                                                                               
         CLC   BHBDSEC,0(R1)       SAME LENGTH?                                 
         JE    EQV20                                                            
*                                                                               
         AHI   R1,1                LEN TABLE                                    
         AHI   R3,4                EQV TABLE                                    
         JCT   R0,EQV2                                                          
*                                                                               
EQV10    LHI   R3,1000             USE 1000 IF NOT IN TABLE !                   
                                                                                
* CALCULATE EQUIVALENCIES                                                       
                                                                                
EQV20    LLH   R0,NUMDEMS          JCT LOOP                                     
         LA    R4,BHDEMS           INPUT                                        
         LA    R2,EQUDEMS          OUTPUT                                       
*                                                                               
EQV30    L     RF,4(R4)            INPUT                                        
         N     RF,=X'3FFFFFFF'     DROP FLAGS                                   
         AR    RF,RF               X 2                                          
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,3,0(R3)          FACTOR                                       
         JNZ   *+8                                                              
         LHI   RE,1000             USE 1000 IF FACTOR IS 0                      
*                                                                               
         MR    RE,RE                                                            
         D     RE,=F'1000'                                                      
         AHI   RF,1                ROUND                                        
         SRL   RF,1                                                             
*                                                                               
         TM    4(R4),X'40'         TEST INPUT TO 2-DEC                          
         JZ    *+8                                                              
         O     RF,=X'40000000'                                                  
*                                                                               
         ST    RF,0(R2)            EQUIVALENCED DATA                            
*                                                                               
         AHI   R4,8                INPUT                                        
         AHI   R2,4                OUTPUT                                       
         JCT   R0,EQV30                                                         
         J     EXIT                                                             
*                                                                               
SLNTAB   DS    0C                                                               
       ++INCLUDE SPSLNTAB                                                       
         DC    3X'00'                                                           
SLNTABX  EQU   *                                                                
         EJECT                                                                  
***********************************************************************         
* VALIDATE THE BUYER RECORD EXISTS                                              
*  READS THE BUYER RECORD INTO AIO7                                             
***********************************************************************         
VALBYR   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R3,IOKEY            SET UP THE KEY                               
         USING BYRRECD,R3          READ THE BUYER RECORD                        
         XC    IOKEY,IOKEY                                                      
         MVI   BYRKTYP,BYRKTYPQ                                                 
         MVI   BYRKSUB,BYRKSUBQ                                                 
         MVC   BYRKAM,SVBAGM                                                    
         MVC   BYRKBYR,SVQBYR                                                   
         DROP  R3                                                               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO7'                               
         JNE   EXITN                                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO7'                              
         JNE   EXITN                                                            
*                                                                               
         NI    MISCFLG2,X'FF'-MF2BRDAC                                          
         L     R4,AIO7                                                          
         MVI   ELCDLO,BYRDCD2Q     X'11' -DESCRIPTION ELEMENT                   
         MVI   ELCDHI,BYRDCD2Q                                                  
         BRAS  RE,GETEL                                                         
         JNE   EXITY                                                            
         USING BYRDSCD2,R4                                                      
         TM    BYRMFLG1,BYRMFDAC   IS IT DEACTIVATED?                           
         JZ    EXITY                                                            
         OI    MISCFLG2,MF2BRDAC   BUYER CODE DEACTIVATED                       
         J     EXITN                                                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* GET THE DESTINATION                                                           
*  ON ENTRY :  ORDER RECORD IN AIO3                                             
*                                                                               
*   ON EXIT :  SVDESTID CONTAINS DESTINATION                                    
***********************************************************************         
GTDESTID NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,AIO3                                                          
         BRAS  RE,CLCORDDT                                                      
*                                                                               
         MVI   ELCDLO,DOWIGELQ     X'50' WHERE IT GO ELEMENT                    
         MVI   ELCDHI,DOWIGELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
         USING DOWIGELD,R4                                                      
         MVC   SVDESTID(L'DOWIGRPP),DOWIGRPP                                    
         OC    DOWIGRPO,DOWIGRPO                                                
         JZ    GTDI015                                                          
         LA    R1,SVDESTID                                                      
GTDI010  CLI   0(R1),C' '                                                       
         JNH   *+12                                                             
         LA    R1,1(R1)                                                         
         J     GTDI010                                                          
         MVC   0(L'DOWIGRPO,R1),DOWIGRPO                                        
GTDI015  OC    SVDESTID,SPACES     THE RIGHT ONE IF NOT HOME MKT                
***********************************                                             
* WIDE ORBIT:  REP-DATE   or  LOCAL STATION-DATE                                
***********************************                                             
         BRAS  RE,GTMOOFTB                                                      
         AHI   R1,WORPDTAB-MOREPTAB                                             
GTDI020  CLI   0(R1),X'FF'         EOT?                                         
         JE    GTDI030             YES                                          
         LLC   R4,3(R1)            L(REP/STATION) ENTRY                         
         BCTR  R4,0                MINUS 1 FOR EX!                              
         EX    R4,*+8              MATCH ON REP/STATION                         
         JE    GTDI023             YES, CHECK DATE                              
         CLC   4(0,R1),SVDESTID                                                 
         LLC   R4,3(R1)            NO, BUMP TO NEXT REP                         
         LA    R1,4(R1,R4)                                                      
         J     GTDI020                                                          
         PUSH  USING                                                            
*                                                                               
***  POINT TO DATE FOR COMPARE                                                  
GTDI023  LLC   R4,3(R1)                                                         
         LA    R6,SVDESTID                                                      
         CLC   =C'NBC',SVDESTID    IS IT A REP?                                 
         JE    GTDI026                                                          
         CLC   =C'MON',SVDESTID                                                 
         JNE   *+12                                                             
GTDI026  LA    R6,2(R4,R6)         R6=A(AFTER OFFICE CODE IN EDICT)             
         J     GTDI028                                                          
*                                                                               
         BCTR  R4,0                TO ACCOUNT FOR SPACE IN ENTRY                
         LA    R6,0(R4,R6)         R6=A(AFTER LOCAL STATION IN EDICT)           
*                                                                               
GTDI028  CLC   ORDRDATE,0(R1)      ON/AFTER THE CUTOFF DATE?                    
         JL    GTDIYES             NO, NO CHANGE TO THE RECEIVING ID            
         MVC   0(3,R6),=C'-WO'     GOES TO WIDEORBIT                            
         J     GTDIYES                                                          
***********************************                                             
* REP-OFFICE-DATE                                                               
*                                                                               
* WE HAVE OTHER REP-OFFICE THAT ARE GOING TO MEDIAOCEAN BY DATE                 
* **NOTE**                                                                      
* IF WE MATCH ON REP-OFFICE BUT NOT DATE, ORDER STAYS AS -MO SUFFIX             
***********************************                                             
GTDI030  BRAS  RE,GTMOOFTB                                                      
         AHI   R1,MORODTAB-MOREPTAB                                             
GTDI033  CLI   0(R1),X'FF'         EOT?                                         
         JE    GTDI040             YES                                          
         LLC   R4,3(R1)            L(REP-OFFICE) ENTRY                          
         BCTR  R4,0                MINUS 1 FOR EX!                              
         EX    R4,*+8              MATCH ON REP-OFFICE?                         
         JE    GTDI036             YES, CHECK DATE                              
         CLC   4(0,R1),SVDESTID                                                 
         LLC   R4,3(R1)            NO, BUMP TO NEXT REP                         
         LA    R1,4(R1,R4)                                                      
         J     GTDI033                                                          
*                                                                               
***  POINT TO DATE FOR COMPARE                                                  
GTDI036  LLC   R4,3(R1)                                                         
         LA    R6,SVDESTID                                                      
         LA    R6,0(R4,R6)         R6=A(AFTER OFFICE CODE IN EDICT)             
*                                                                               
         CLC   ORDRDATE,0(R1)      ON/AFTER THE CUTOFF DATE?                    
         JNL   GTDIYES             YES, NO CHANGE TO THE RECEIVING ID           
         MVC   0(3,R6),=C'-MO'     GOES TO MEDIAOCEAN                           
         J     GTDIYES                                                          
***********************************                                             
* UNIVISION LOCAL STATION DATE                                                  
*                                                                               
* WE HAVE OTHER LOCAL STATIONS GOING TO MEDIAOCEAN BY DATE                      
* **NOTE**                                                                      
* IF WE MATCH AND ON OR AFTER THE DATE, ORDER GOES AS -DS SUFFIX                
***********************************                                             
GTDI040  BRAS  RE,GTMOOFTB                                                      
         AHI   R1,MOUNLTAB-MOREPTAB                                             
GTDI043  CLI   0(R1),X'FF'         EOT?                                         
         JE    GTDI050             YES                                          
         LLC   R4,3(R1)            L(REP-OFFICE) ENTRY                          
         BCTR  R4,0                MINUS 1 FOR EX!                              
         EX    R4,*+8              MATCH ON REP-OFFICE?                         
         JE    GTDI046             YES, CHECK DATE                              
         CLC   4(0,R1),SVDESTID                                                 
         LLC   R4,3(R1)            NO, BUMP TO NEXT REP                         
         LA    R1,4(R1,R4)                                                      
         J     GTDI043                                                          
*                                                                               
***  POINT TO DATE FOR COMPARE                                                  
GTDI046  LLC   R4,3(R1)                                                         
         BCTR  R4,0                TO ACCOUNT FOR SPACE IN ENTRY                
         LA    R6,SVDESTID                                                      
         LA    R6,0(R4,R6)         R6=A(AFTER LOCAL STATION IN EDICT)           
*                                                                               
         CLC   ORDRDATE,0(R1)      ON/AFTER THE CUTOFF DATE?                    
         JL    GTDIYES             NO, NO CHANGE TO THE RECEIVING ID            
         MVC   0(3,R6),=C'-DS'     GOES TO DDS REPPAK                           
         J     GTDIYES                                                          
***********************************                                             
* MEDIAOCEAN  REP-OFFICE-STATION-DATE                                           
*                                                                               
* WE HAVE OTHER REP-OFFICE THAT ARE GOING TO MEDIAOCEAN BY STATION/DATE         
* **NOTE**                                                                      
* IF WE MATCH ON REP-OFFICE BUT NOT STATION/DATE, ORDER STAYS ON REPPAK         
***********************************                                             
GTDI050  BRAS  RE,GTMOOFTB                                                      
         AHI   R1,MOOFSTTB-MOREPTAB                                             
GTDI055  CLI   0(R1),X'FF'         EOT?                                         
         JE    GTDI080             YES                                          
         LLC   R4,2(R1)            L(REP-OFFICE ENTRY)                          
         BCTR  R4,0                MINUS 1 FOR EX!                              
         CLC   3(0,R1),SVDESTID                                                 
         EX    R4,*-6              MATCH ON REP-OFFICE?                         
         JE    GTDI060             YES, CHECK STATION AND DATE                  
         XR    R4,R4               NO, BUMP TO NEXT REP                         
         ICM   R4,3,0(R1)                                                       
         AR    R1,R4                                                            
         J     GTDI055                                                          
*                                                                               
***  POINT TO OFFICE FOR COMPARE                                                
GTDI060  LLC   R4,2(R1)                                                         
         LA    R6,SVDESTID                                                      
         LA    R6,0(R4,R6)         R6=A(AFTER OFFICE CODE IN EDICT)             
         LA    R1,3(R4,R1)         R1=A(OFFICE CODE IN TABLE)                   
*                                                                               
GTDI065  CLI   0(R1),0             END OF STATION/DATE LIST?                    
         JE    GTDI080             YES, THEN STAYS ON REPPAK                    
         CLC   SVQSTA,0(R1)        MATCH ON STATION?                            
         JE    GTDI070             NO, CHECK NEXT ENTRY                         
         LA    R1,14(R1)           NO, BUMP TO NEXT ENTRY IN TABLE              
         J     GTDI065                                                          
*                                                                               
GTDI070  OC    5(3,R1),5(R1)       WAS THE STATION ALREADY CONVERTED?           
         JZ    GTDI075             YES, AUTOMATICALLY GO TO MEDIAOCEAN          
         CLC   ORDRDATE,5(R1)      ON/AFTER THE CUTOFF DATE?                    
         JL    GTDI080             NO, NO CHANGE TO THE RECEIVING ID            
*                                                                               
         OC    8(3,R1),8(R1)       ANY END DATE?                                
         JZ    GTDI075             NONE, GOES TO MEDIAOCEAN                     
         CLC   ORDRDATE,8(R1)      ON/AFTER THE ENDDATE (REPPAK)?               
         JL    GTDI075             NO, NO CHANGE TO THE RECEIVING ID            
*                                                                               
         CLC   ORDRDATE,11(R1)     ON/AFTER NEW START DATE (-MO AGAIN)?         
         JL    GTDI080             NO, NO CHANGE TO THE RECEIVING ID            
GTDI075  MVC   0(3,R6),=C'-MO'     GOES TO MEDIAOCEAN                           
*                                                                               
***********************************                                             
* WIDEORBIT  REP-OFFICE-STATION-DATE                                            
*                                                                               
* WE HAVE OTHER REP-OFFICE THAT ARE GOING TO WIDEORBIT BY STATION/DATE          
* **NOTE**                                                                      
* IF WE MATCH ON REP-OFFICE BUT NOT STATION/DATE, ORDER STAYS ON REPPAK         
***********************************                                             
GTDI080  DS    0H                                                               
         BRAS  RE,GTMOOFTB                                                      
         AHI   R1,WOOFSTTB-MOREPTAB                                             
GTDI085  CLI   0(R1),X'FF'         EOT?                                         
         JE    GTDI110             YES                                          
         LLC   R4,2(R1)            L(REP-OFFICE ENTRY)                          
         BCTR  R4,0                MINUS 1 FOR EX!                              
         CLC   3(0,R1),SVDESTID                                                 
         EX    R4,*-6              MATCH ON REP-OFFICE?                         
         JE    GTDI090             YES, CHECK STATION AND DATE                  
         XR    R4,R4               NO, BUMP TO NEXT REP                         
         ICM   R4,3,0(R1)                                                       
         AR    R1,R4                                                            
         J     GTDI085                                                          
*                                                                               
***  POINT TO OFFICE FOR COMPARE                                                
GTDI090  LLC   R4,2(R1)                                                         
         LA    R6,SVDESTID                                                      
         LA    R6,0(R4,R6)         R6=A(AFTER OFFICE CODE IN EDICT)             
         LA    R1,3(R4,R1)         R1=A(OFFICE CODE IN TABLE)                   
*                                                                               
GTDI095  CLI   0(R1),0             END OF STATION/DATE LIST?                    
         JE    GTDI110             YES, THEN NO CHANGE TO RECEIVING ID          
         CLC   SVQSTA,0(R1)        MATCH ON STATION?                            
         JE    GTDI100             NO, CHECK NEXT ENTRY                         
         LA    R1,14(R1)           NO, BUMP TO NEXT ENTRY IN TABLE              
         J     GTDI095                                                          
*                                                                               
GTDI100  OC    5(3,R1),5(R1)       WAS THE STATION ALREADY CONVERTED?           
         JZ    GTDI105             YES, AUTOMATICALLY GO TO WIDEORBIT           
         CLC   ORDRDATE,5(R1)      ON/AFTER THE CUTOFF DATE?                    
         JL    GTDI110             NO, NO CHANGE TO THE RECEIVING ID            
*                                                                               
         OC    8(3,R1),8(R1)       ANY END DATE?                                
         JZ    GTDI105             NONE, GOES TO WIDEORBIT                      
         CLC   ORDRDATE,8(R1)      ON/AFTER THE ENDDATE (NO CHANGE)             
         JL    GTDI105             NO, NO CHANGE TO THE RECEIVING ID            
*                                                                               
         CLC   ORDRDATE,11(R1)     ON/AFTER NEW START DATE (-WO AGAIN)?         
         JL    GTDI110             NO, THEN NO CHANGE TO RECEIVING ID           
GTDI105  MVC   0(3,R6),=C'-WO'     GOES TO WIDEORBIT                            
*                                                                               
GTDI110  DS    0H                                                               
*                                                                               
GTDIYES  J     EXITY                                                            
         DROP  R4                                                               
         POP   USING                                                            
***********************************************************************         
* CALCULATE ORDRDATE PWOS JULIAN DATE                                           
*  ON ENTRY :  ORDER RECORD IN AIO3                                             
*                                                                               
*   ON EXIT :  ORDRDATE IS THE ORDER CREATION DATE IN PWOS JULIAN               
***********************************************************************         
CLCORDDT NTR1                                                                   
         TM    BINORDER,X'80'      NEW STYLE ORDER NUMBER?                      
         BNZ   CLCOD20             NO, REMEMBER, BINORDER IS FF'D               
*                                                                               
         CLC   0(2,R4),=X'0D34'                                                 
         BNE   CLCODDIE                                                         
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID ELEMENT               
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   CLCODDIE                                                         
         USING DOSPELD,R4                                                       
CLCOD15  MVC   ORDRDATE,DOSPCDAT                                                
         J     CLCODX                                                           
         DROP  R4                                                               
*                                                                               
CLCODDIE DC    H'0'                                                             
*                                                                               
CLCOD20  MVC   HALF,BINORDDT       THE 1ST 2 BYTES OF ORDER #                   
         XC    HALF,=X'FFFF'                                                    
         SR    R1,R1                                                            
         ICM   R1,3,HALF           CONTAINS THE DATE OF CREATION                
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         MVC   HALF,DUB+6          SAVE OFF THE DDDF                            
         SRP   DUB,64-3,0          ISOLATE # OF YEARS FROM 1990                 
         AP    DUB,=P'90'           AS ORDER #'S BASED OFF 1990                 
         SRP   DUB,3,0                                                          
         MVC   DUB+6(2),HALF       PUT BACK  DDDF TO GET A FULL DATE            
         SRP   DUB,1,0                                                          
         MVC   ORDRDATE,DUB+4      WE NOW HAVE PWOS JULIAN                      
CLCODX   J     EXITY                                                            
***********************************************************************         
* CHECKS TO SEE IF THE SALESPERSON FOR THE REP IS STILL VALID                   
*                                                                               
* ON EXIT:     SALESCOD            SALESPERSON CODE USED BY REPPAK              
*              REPALPHA            ALPHA CODE OF REP'S MASTER REP               
***********************************************************************         
CRS      USING DOIDSPER,SALESPER                                                
CHKRPSAL NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         OC    SALESCOD,SALESCOD                                                
         JNZ   CKRSPYES                                                         
*                                                                               
         OC    SVDESTID,SVDESTID                                                
         JZ    CKRSPNO                                                          
*                                                                               
         XC    REPHUBAD,REPHUBAD                                                
         XC    REPALPH1,REPALPH1                                                
         CLC   CRS.DOIDFFS,EFFS   HAVE REP ALPHA ALREADY?                       
         JNE   CKRSP001           NO                                            
         MVC   REPALPHA,CRS.DOIDREPA                                            
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOWIGELQ     X'50' SUPPLEMENTARY ID ELEMENT               
         MVI   ELCDHI,DOWIGELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   CKRSP005                                                         
         USING DOWIGELD,R4                                                      
         CLC   DOWIGRPO,SPACES                                                  
         JNH   CKRSP005                                                         
         MVC   REPOFFCD,DOWIGRPO                                                
         J     CKRSP005                                                         
*                                                                               
CKRSP001 XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY                                                         
         USING CTIKEY,R4                                                        
         MVI   CTIKTYP,CTIKTYPQ    C'I' - ID RECORD TO GET POWER CODE           
         MVC   CTIKID,SVDESTID                                                  
         OC    CTIKID,SPACES                                                    
                                                                                
         GOTOR VGETDARE,DMCB,(C'U',0),CTIKID,AIO8,A(IO8LQ),VDATAMGR             
         BNE   CKRSP004            MUST BE SENDING TO STATION                   
                                                                                
         L     RE,AIO8                                                          
         USING DAREPTD,RE                                                       
         TM    DAPTFLG1,DPF1NOOF   X'80' - REP DOESN'T APPEND OFFICE?           
         JO    CKRSP004            NO, SKIP THIS                                
         LLC   R1,DAPTLPFX                                                      
         LA    RF,CTIKID(R1)       YES, MOVE IN NY DEFAULT                      
         MVC   0(2,RF),=C'NY'                                                   
         DROP  RE,R4                                                            
*                                                                               
CKRSP004 GOTOR (#IOEXEC,AIOEXEC),'IORD+IOCTFILE+IO6'                            
         JNE   *+2                                                              
*                                                                               
         L     R4,AIO6                                                          
         USING CTIREC,R4                                                        
*                                                                               
         LA    R4,CTIDATA          POINT TO FIRST ELEMENT                       
         MVI   ELCDLO,X'06'        LOOK FOR THE AGENCY ALPHA                    
         MVI   ELCDHI,X'06'        LOOK FOR THE AGENCY ALPHA                    
         BRAS  RE,NEXTEL                                                        
         JNE   *+2                                                              
*                                                                               
         USING CTAGYD,R4                                                        
         MVC   REPALPHA,CTAGYID    SAVE THE REP AGENCY ALPHA CODE               
         DROP  R4                                                               
***********************************************************************         
* WITH THE REP ALPHA CODE, WE CAN SEE IF IT IS A SUBSIDIARY OF A MASTER         
***********************************************************************         
CKRSP005 XC    IOKEY,IOKEY                                                      
         LA    R3,IOKEY                                                         
         USING GSPLKEY,R3                                                       
         MVI   GSPLKTYP,GSPLRECQ   X'71'                                        
         MVC   GSPLKRP1,REPALPHA                                                
*                                                                               
         L     R4,AIO6                                                          
         MVC   0(L'IOKEY,R4),IOKEY           SAVE PREVIOUS KEY                  
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGENDIR+IO6'                            
         JNE   *+2                                                              
*                                                                               
         CLC   0(GSPLKRP2-GSPLKEY,R4),IOKEY  REP HAS A MASTER REP?              
         JNE   CKRSP020                      NO                                 
         MVC   REPALPHA,GSPLKRP2   USE MASTER REP'S POWER (PRE 2005)            
         MVC   REPALPH1,GSPLMRP    USE MASTER REP'S POWER (POST 2005)           
         DROP  R3                                                               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGENFIL+IO6'                           
         JNE   CKRSP020                                                         
*                                                                               
         USING GSPLKEY,R4                                                       
         SR    R0,R0                                                            
         MVC   REPHUBAD,=CL10'DDSXMLNY'                                         
CKRSP010 CLI   GSPLHUBL,0          END OF RECORD                                
         JE    CKRSP020                                                         
         CLI   GSPLHUBL,X'05'      END OF RECORD                                
         JE    CKRSP015                                                         
         IC    R0,GSPLHBLN                                                      
         AR    R4,R0                                                            
         J     CKRSP010                                                         
CKRSP015 MVC   REPHUBAD,GSPLHBAD                                                
         DROP  R4                                                               
***********************************************************************         
* FIND THE SALESPERSON CODE                                                     
***********************************************************************         
CKRSP020 XC    IOKEY,IOKEY                                                      
         LA    R3,IOKEY                                                         
         USING GSPLKEY,R3                                                       
         MVI   GSPLPTYP,GSPLPTYQ   X'F1' - PASSIVE FOR SALESPERSON              
         MVC   GSPLPREP,REPALPHA                                                
         MVC   GSPKPCOD,CRS.DOIDSALC                                            
         MVC   GSPKPOFF,REPOFFCD                                                
*                                                                               
         CLC   CRS.DOIDFFS,EFFS   HAVE REP ALPHA ALREADY?                       
         JE    CKRSP030           YES                                           
         MVC   GSPLPNAM,SALESPER                                                
         OC    GSPLPNAM,SPACES                                                  
*                                                                               
CKRSP030 L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ID ELEMENT               
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOSPELD,R4                                                       
         MVI   GSPLPSTP,X'01'      X'01' SALERSERSON KEY                        
         TM    DOSPFLG1,DOSPPPER   LOOKING FOR POINTPERSON?                     
         JZ    CKRSP040             NO                                          
         MVI   GSPLPSTP,X'02'       YES, SET X'02' POINTPERSON KEY AND          
         OC    REPALPH1,REPALPH1    HAVE MASTER REP CODE (POST 2005)            
         JZ    CKRSP040                                                         
         MVC   GSPLPREP,REPALPH1                                                
         DROP  R4                                                               
*                                                                               
CKRSP040 L     R4,AIO6                                                          
         MVC   0(L'IOKEY,R4),IOKEY                                              
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOGENDIR+IO6'                            
         JNE   CKRSPNO          ** BUG IN DESKTOP, SAVED BAD PP-FLAG **         
*                                                                               
         LHI   R1,GSPLPCOD-GSPLKEY                                              
         CLC   CRS.DOIDFFS,EFFS   HAVE REP ALPHA ALREADY?                       
         JNE   *+8                       YES                                    
         LHI   R1,GSPLKSAL-GSPLKEY+L'GSPLKSAL                                   
         BCTR  R1,0                                                             
         CLC   0(0,R4),IOKEY      REP HAS A MASTER REP?                         
         EX    R1,*-6                                                           
         JNE   CKRSPNO                                                          
*                                                                               
         MVC   SALESCOD,GSPKPCOD                                                
         CLC   CRS.DOIDFFS,EFFS   HAVE REP ALPHA ALREADY?                       
         JE    CKRSPYES                  YES                                    
         MVC   SALESCOD,GSPLPCOD  SAVE THE SALESPERSON CODE                     
         DROP  CRS                                                              
*                                                                               
CKRSPYES J     EXITY                                                            
CKRSPNO  J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* READ THE FLIGHT RECORD INTO AIO6                                              
*  ENTRY:  LOCKFLT   -IF C'Y', THEN MARK FLIGHT LOCKED                          
*          ESTSTRT                                                              
***********************************************************************         
GTFLTINF NTR1  BASE=*,LABEL=*                                                   
         MVC   LOCKFLT,0(R1)                                                    
*                                                                               
         MVI   FLTRCFLG,0               DIDN'T GET A FLIGHT REC YET             
         XC    SVFLTSDT,SVFLTSDT                                                
         XC    SVFLTEDT,SVFLTEDT                                                
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY            READ ESTIMATE HEADER                         
         USING DFLRECD,R4                                                       
         MVI   DFLKTYP,DFLKTYPQ                                                 
         MVI   DFLKSUB,DFLKSUBQ                                                 
         MVC   DFLKAGMD,SVBAGM                                                  
         MVC   DFLKCLT,SVBCLT                                                   
         MVC   DFLKPRD,=C'POL'     READ POL FLIGHT                              
         MVC   DFLKEST,SVBEST                                                   
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOBRD+IODIR+B#FLTREC'                         
         JE    GFR010                                                           
*                                                                               
         MVC   IOKEY,IOKEYSAV      RESTORE THE KEY                              
         MVC   DFLKPRD,SVQPRD      READ PRIMARY PRODUCT ON THE ESTIMATE         
         GOTOR (#IOEXEC,AIOEXEC),'IOBRD+IODIR+B#FLTREC'                         
         JE    GFR010                                                           
*                                                                               
         MVC   IOKEY,IOKEYSAV      RESTORE THE KEY                              
         MVC   DFLKPRD,=C'ALL'     'ALL' PRODUCTS ON THIS ESTIMATE              
         GOTOR (#IOEXEC,AIOEXEC),'IOBRD+IODIR+B#FLTREC'                         
         JNE   GFRXY                                                            
*                                                                               
GFR010   LHI   R1,IOBGET+IOFIL+B#FLTREC                                         
         CLI   LOCKFLT,C'L'        READ FOR UPDATE?                             
         JNE   *+8                                                              
         LHI   R1,IOBGETUP+IOFIL+B#FLTREC                                       
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   *+2                                                              
         OI    FLTRCFLG,FRFEXIST   FLIGHT RECORD EXISTS                         
*                                                                               
         L     R4,AFLTREC                                                       
         USING DFLRECD,R4                                                       
         MVI   ELCDLO,DFINFELQ     X'01' FLIGHT INFO ELEMENT                    
         MVI   ELCDHI,DFINFELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   *+10                                                             
         USING DFINFEL,R4                                                       
         MVC   SVFLTEDT,DFINFSDT                                                
*                                                                               
         L     R4,AFLTREC                                                       
         USING DFLRECD,R4                                                       
         MVI   ELCDLO,DFFLTELQ     GET 1ST FLIGHT ELEMENT                       
         MVI   ELCDHI,DFFLTELQ                                                  
         BRAS  RE,GETEL                                                         
         JNE   *+2                                                              
*                                                                               
         USING DFFLTEL,R4                                                       
         CLI   SVBFLT,0            PURPOSELY NO FLIGHT? ORIG ORDER?             
         JNE   GFR020                                                           
         GOTOR VDATCON,DMCB,(0,ESTSTRT),(3,SVFLTSDT)                            
*                                                                               
         OC    SVFLTEDT,SVFLTEDT   DO WE HAVE FLIGHT0 END DATE?                 
         JNZ   GFRXY                                                            
         GOTOR VDATCON,DMCB,(3,DFFLTSTR),(0,WORK)                               
         GOTOR VADDAY,DMCB,WORK,WORK,-1                                         
         GOTOR VDATCON,DMCB,(0,WORK),(3,SVFLTEDT)                               
         CLC   SVFLTSDT,SVFLTEDT                                                
         JNH   GFRXY                                                            
         OI    FLTRCFLG,FRFINVFL   FLIGHT NUMBER IS INVALID                     
         J     GFRXN                                                            
*                                                                               
GFR020   CLC   SVBFLT,DFFLTNUM                                                  
         JE    GFR025                                                           
         BRAS  RE,NEXTEL                                                        
         JE    GFR020                                                           
         OI    FLTRCFLG,FRFINVFL   FLIGHT NUMBER IS INVALID                     
         J     GFRXN                                                            
*                                                                               
GFR025   MVC   SVFLTSDT,DFFLTSTR   SAVE THE FLIGHT DATES                        
         MVC   SVFLTEDT,DFFLTEND                                                
*                                                                               
         CLI   LOCKFLT,C'L'                                                     
         JNE   GFRXY                                                            
         OI    DFFLTSTA,DFFLTSLK                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOBPUT+IOFIL+B#FLTREC'                        
*                                                                               
GFRXY    J     EXITY                                                            
GFRXN    J     EXITN                                                            
         DROP  R3                                                               
LOCKFLT  DS    X                                                                
         EJECT                                                                  
*                                                                               
***********************************************************************         
* PRINT HIATUS WEEK DEFINITIONS                                                 
***********************************************************************         
PRTHIATS NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    ELEM2(53),ELEM2     53 WEEKS/DAYS                                
*                                                                               
         LA    R3,IOKEY            LOOK UP THE GOALS                            
         USING GKEY,R3                                                          
         XC    IOKEY,IOKEY                                                      
         MVI   GKEYTYPE,X'02'                                                   
         MVC   GKEYAM,SVBAGM                                                    
         MVC   GKEYCLT,SVBCLT                                                   
*                                                                               
         MVC   GOALPRD,SVBPRD                                                   
         MVC   GOALPR2,SVBPR2                                                   
*                                                                               
         MVC   GKEYPRD,SVBPRD                                                   
         CLI   SVBPR2,0            ANY PIGGYBACK?                               
         JE    PRHIA04             NO                                           
         CLC   SVQPR2,SVQPRD       PB IS ALPHABETICALLY < PRODUCT?              
         JNL   PRHIA04                                                          
         MVC   GKEYPRD,SVBPR2      GOALS ARE ALPHABETICALLY BY PRODUCT          
         MVC   GOALPRD,SVBPR2      WE SWAPPED THEM                              
         MVC   GOALPR2,SVBPRD                                                   
*                                                                               
PRHIA04  MVC   GKEYMKT,SVBMKT                                                   
         MVC   GKEYEST,SVBEST      WE HAVE ONLY UP TO ESTIMATE                  
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO6'                               
         JNE   *+2                                                              
*                                                                               
PRHIA10  CLC   GKEYAM,SVBAGM       SAME BASE KEY?                               
         JNE   PRHIA100                                                         
         CLC   GKEYCLT,SVBCLT                                                   
         JNE   PRHIA100                                                         
         CLC   GKEYPRD,GOALPRD                                                  
         JNE   PRHIA100                                                         
         CLC   GKEYMKT,SVBMKT                                                   
         JNE   PRHIA100                                                         
         CLC   GKEYEST,SVBEST                                                   
         JNE   PRHIA100            NO, DONE                                     
*                                                                               
         CLC   GKEYPRD2,GOALPR2    PIGGYBACKS MATCH?                            
         JNE   PRHIANXT                                                         
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOFIL+IO6'                              
*                                                                               
         L     R4,AIO6                                                          
         MVI   ELCDLO,X'21'        LOOK FOR GOAL WEEK ELEMENTS                  
         MVI   ELCDHI,X'21'                                                     
         BRAS  RE,GETEL                                                         
         JNE   PRHIANXT                                                         
*                                                                               
         USING GLEMENT,R4                                                       
         MVC   ELEM2+100(L'ESTSTRT),ESTSTRT                                     
         GOTOR VGETDAY,DMCB,(0,ESTSTRT),ELEM2+110                               
*                                                                               
         TM    ESTFLAG1,ESTDAILY   DAILY                                        
         JNZ   PRHIA15                                                          
         CLC   SVOOWROT,DMCB       START DAY IS SAME AS ROTATOR?                
         JE    PRHIA15             YES                                          
*                                                                               
         LLC   R1,DMCB             THIS WOULD BE NOT OUT OF WEEK                
         LLC   R0,SVOOWROT            BUT EST START DAY DOESN'T START           
         SR    R0,R1                  ON MONDAY (ALIGN IT TO PREV MON)          
         GOTOR VADDAY,DMCB,ELEM2+100,ELEM2+100,(R0) FIND OUT THE MONDAY         
*                                                                               
PRHIA15  XC    FAKEFLD,FAKEFLD                                                  
         GOTOR VDATCON,DMCB,(0,ELEM2+100),(8,FAKEFLD)                           
         MVI   FAKEFLD+8,C'-'                                                   
PRHIA20  GOTOR VDATCON,DMCB,(2,GLWEEK),(8,FAKEFLD+9)                            
         GOTOR VPERVAL,DMCB,(17,FAKEFLD),PERVALST                               
*                                                                               
PRHIAPVD USING PERVALD,PERVALST                                                 
         ZICM  R1,PRHIAPVD.PVALNDYS,2                                           
         TM    ESTFLAG1,ESTDAILY                                                
         JNZ   PRHIA30                                                          
         ZICM  R1,PRHIAPVD.PVALNWKS,2                                           
         DROP  PRHIAPVD                                                         
*                                                                               
PRHIA30  BCTR  R1,0                DISP(FROM EST START DATE)                    
         LA    R2,ELEM2(R1)                                                     
         OI    0(R2),X'80'         WE HAVE GOALS FOR THIS WEEK/DAY              
*                                                                               
         BRAS  RE,NEXTEL           GO THROUGH ALL GOAL WEEK ELEMENTS            
         JE    PRHIA20                                                          
*                                                                               
PRHIANXT DS    0H                  READ NEXT GOAL RECORD                        
         LA    R3,IOKEY            LOOK UP THE GOALS                            
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO6'                               
         JE    PRHIA10                                                          
         DC    H'0'                                                             
         DROP  R4                                                               
*                                                                               
PRHIA100 LA    R2,PW                                                            
         USING PAGYHIAD,R2                                                      
*                                                                               
         MVC   DUB(L'ESTSTRT),ELEM2+100   DUB IS THE START DATE                 
         LA    R4,ELEM2                   R4 = A(FIRST WEEK/DAY)                
*                                                                               
         OC    ELEM2(53),ELEM2     ANY GOALS AT ALL?                            
         JZ    PRHIAX              NONE, DON'T SEND ANY AGYHIA RECORDS          
*                                                                               
         TM    FLTRCFLG,FRFEXIST   USING FLIGHT RECORDS?                        
         JZ    PRHIA110                                                         
         GOTOR VDATCON,DMCB,(3,SVFLTSDT),(0,ELEM2+120)                          
         GOTOR VDATCON,DMCB,(3,SVFLTEDT),(0,ELEM2+126)                          
*                                                                               
PRHIA110 MVC   PAHITID,=C'AGYHIA'                                               
         MVC   PAHIORDR,SVQORDER                                                
         MVI   PAHICONT,C'*'                                                    
         LA    R3,PAHIWKDT         R4 = A(FIRST WEEK/DAY IN AGYHIA)             
*                                                                               
PRHIA120 TM    0(R4),X'80'         DO WE HAVE A GOAL FOR THIS WEEK/DAY          
         JZ    PRHIA130                                                         
*                                                                               
PRHIA125 LA    R4,1(R4)            YES, R4 = A(NEXT GOAL WEEK/DAY)              
         LR    R1,R4                                                            
         LA    R0,ELEM2                                                         
         SR    R1,R0                                                            
         CHI   R1,53               LOOK AT ALL THE 53 WEEKS/DAYS?               
         JL    PRHIA128                                                         
         MVI   PAHICONT,C' '       YES                                          
         LA    R1,PAHIWKDT                                                      
         CR    R3,R1                                                            
         JNE   PRHIA140                                                         
         J     PRHIAX                                                           
*                                                                               
PRHIA128 MVC   DMCB+8(4),=F'7'        ASSUME WEEK FIRST                         
         TM    ESTFLAG1,ESTDAILY   IF DAILY                                     
         JZ    *+8                                                              
         MVI   DMCB+11,X'01'       THEN BUMP BY 1 ONLY                          
         GOTOR VADDAY,DMCB,DUB,DUB,,0                                           
         CLC   DUB(L'ESTEND),ESTEND   PAST THE ESTIMATE END?                    
         JNH   PRHIA120               NO, KEEP CHECKING                         
         MVI   PAHICONT,C' '          YES                                       
         LA    R1,PAHIWKDT                                                      
         CR    R3,R1                                                            
         JNE   PRHIA140                                                         
         J     PRHIAX                                                           
*                                                                               
PRHIA130 LR    R1,R3                                                            
         LA    R0,PAHIWKDT                                                      
         SR    R1,R0                                                            
         CHI   R1,60               HIT MAX OF 10 WEEKS/DAYS PER AGYHIA?         
         JL    PRHIA131            NO                                           
         GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
         J     PRHIA110            SET UP THE AGYHIA RECORD AGAIN               
*                                                                               
PRHIA131 CLC   DUB,ESTSTRT              IF WE ADJUSTED THE DATE                 
         JNL   PRHIA132                                                         
         MVC   0(L'ESTSTRT,R3),ESTSTRT  THEN FIRST DATE IS EST START            
         J     PRHIA136                                                         
*                                                                               
PRHIA132 TM    FLTRCFLG,FRFEXIST   USING FLIGHT RECORDS                         
         JZ    PRHIA133                                                         
         CLC   DUB,ELEM2+120       WE STORED THE FLIGHT START AND END           
         JL    PRHIA125               HERE IN THE YYMMDD FORM                   
         CLC   DUB,ELEM2+126                                                    
         JH    PRHIA125                                                         
*                                                                               
PRHIA133 MVC   0(L'ESTSTRT,R3),DUB                                              
PRHIA136 CLI   0(R3),C'9'                                                       
         JNH   PRHIA139                                                         
         LLC   R1,0(R3)                                                         
         SHI   R1,10                                                            
         STC   R1,0(R3)                                                         
PRHIA139 LA    R3,L'ESTSTRT(R3)                                                 
         J     PRHIA125                                                         
*                                                                               
PRHIA140 GOTOR GOREPORT,DMCB,('REPAPUT',0)                                      
*                                                                               
PRHIAX   J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* FIND THE FIRST AIR DATE OF THE BUYS                                           
*                                                                               
* ON EXIT:     SVAIRDAT            FIRST AIR DATE (COMPRESSED FORMAT)           
***********************************************************************         
FRSTAIRD NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   SVAIRDAT,EFFS       INIT FIRST AIR DATE                          
*                                                                               
*        XC    IOKEY,IOKEY                                                      
*        MVC   IOKEY(ORDXBKYL),ORXAGM   (NOT NEEDED)                            
         MVC   SVBUYKEY,ORXAGM                                                  
*                                                                               
         MVI   LP_RMODE,LP_RFRST                                                
*                                                                               
FSTA010  GOTOR (#NXTREC,ANXTREC),DMCB,('YESQ',BUYKEYT),('B#BUYREC',0), *        
               SAVED,AFLTBKY,AFLTBRD                                            
         JNE   FSTA110                                                          
***************                                                                 
* WE CAN READ THE BUY NOW                                                       
***************                                                                 
         CLI   DRCSHTRD,TRDESREP   DOING TRADE NOW?                             
         JNE   FSTA020                                                          
         TM    CLTFLAG1,CLTTRADE   TRADE CLIENT                                 
         JZ    FSTA020               NO                                         
         L     R4,AIO5                                                          
         MVI   ELCDLO,X'71'          YES, CHECK FOR COS2 ELEMENT                
         MVI   ELCDHI,X'71'                                                     
         BRAS  RE,GETEL            DO WE HAVE COS2?                             
         JE    FSTA020             YES                                          
         GOTOR PUTERR,DMCB,('SE#SY002',SE#MSCS2)                                
         J     FSTANO                                                           
*                                                                               
FSTA020  CLI   SVMED,C'R'          IS IT RADIO?                                 
         JNE   FSTA040                                                          
*                                                                               
         L     R4,AIO5                                                          
         MVI   ELCDLO,X'67'        CHECK FOR ORBITS                             
         MVI   ELCDHI,X'67'                                                     
         BRAS  RE,GETEL            DO WE HAVE ORBITS?                           
         JNE   FSTA040              NO, GOOD, LET THEM SEND                     
         GOTOR PUTERR,DMCB,('SE#SY002',SE#XSORB)                                
         J     FSTANO                                                           
*********                                                                       
* DOES THIS BUY HAVE ANY SPOTS FOR OUR PRD(S)?                                  
*********                                                                       
FSTA040  MVI   PR1TIMSH,0          0 MEANS USE BDTIME                           
*                                                                               
         L     R4,AIO5                                                          
         USING BUYKEY,R4                                                        
****                                                                            
         CLI   BUYKSTA,X'E8'       IS STATION IN BUYLINE A CABLE STA?           
         BL    FSTA045                                                          
         MVC   FULL(3),BUYKSTA     YES, WHAT IS THE BINARY SYSCODE?             
         NC    FULL(3),=X'FFFF80'                                               
         CLC   BUYKSTA,FULL        STATION IS ALSO THE SYSCODE?                 
         BE    FSTAERR            YES, PUT OUT AN ERROR                         
****                                                                            
FSTA045  LA    R4,BDELEM                                                        
*                                                                               
         USING REGELEM,R4                                                       
         SR    R0,R0                                                            
FSTA050  BRAS  RE,VLDREGEL         ANY MORE ORIGINAL ELEMS?                     
         JNE   FSTA010             NO MORE, CHECK NEXT BUY RECORD               
         CLI   0(R4),X'09'                                                      
         JNH   FSTA070                                                          
         BRAS  RE,CHKPOLEL                                                      
         JE    FSTA070             NO, THIS BUY HAS AN ACTUAL SPOT              
FSTA060  IC    R0,1(R4)            CHECK NEXT ELEMENT                           
         AR    R4,R0                                                            
         J     FSTA050                                                          
*                                                                               
FSTAERR  GOTOR PUTERR,DMCB,('SE#SY023',SE#SYSCD)                                
         J     FSTANO              Syscode only buys are not allowed            
SE#SYSCD EQU   0312                allowed for EDI Orders                       
*                                                                               
FSTA070  TM    FLTRCFLG,FRFEXIST   USING FLIGHT RECS?                           
         JZ    FABDT10             NO                                           
         GOTOR VDATCON,DMCB,(2,RDATE),(3,WORK)                                  
         CLC   WORK(3),SVFLTSDT    MAKE SURE BUY DATE IN FLIGHT WEEKS           
         JL    FSTA060                                                          
         CLC   WORK(3),SVFLTEDT                                                 
         JH    FSTA060                                                          
         DROP  R4                                                               
*********                                                                       
* HANDLE THE BUY DETAILS                                                        
*********                                                                       
*                                                                               
FABDT10  BRAS  RE,VLDREGEL         END OF RECORD?                               
         JNE   FSTA010             YES, PRINT OUT THE DETAILS NOW               
         J     FABDT20                                                          
*                                                                               
FABDT15  LLC   R1,1(R4)            NEITHER, ADVANCE TO NEXT ELEMENT             
         AR    R4,R1                                                            
         J     FABDT10                                                          
*                                                                               
         USING REGELEM,R4                                                       
FABDT20  CLI   0(R4),X'09'         NON-POOL ELEMENT?                            
         JNH   FABDT30             YES                                          
*                                                                               
         BRAS  RE,CHKPOLEL         POOL ORIGINAL ELEMENT MATCHES ORDER?         
         JNE   FABDT15             NO, SKIP TO NEXT ELEMENT                     
*                                                                               
FABDT30  CLC   SVAIRDAT,RDATE      GOT AN EARLIER DATE?                         
         JL    FABDT15             NO                                           
*                                                                               
         TM    FLTRCFLG,FRFEXIST   USING FLIGHT RECS?                           
         JZ    FABDT40             NO                                           
         GOTOR VDATCON,DMCB,(2,RDATE),(3,WORK)                                  
         CLC   WORK(3),SVFLTSDT    MAKE SURE BUY DATE IN FLIGHT WEEKS           
         JL    FABDT15                                                          
         CLC   WORK(3),SVFLTEDT                                                 
         JH    FABDT15                                                          
*                                                                               
FABDT40  MVC   SVAIRDAT,RDATE      YES, EARLIER AIR DATE                        
         J     FABDT15                                                          
         DROP  R4                                                               
*********                                                                       
* NO MORE BUY RECORDS                                                           
*********                                                                       
FSTA110  CLC   SVAIRDAT,EFFS       ANY BUYLINES?                                
         JE    FSTANO              NONE                                         
FSTAYES  J     EXITY                                                            
FSTANO   J     EXITN                                                            
*                                                                               
*********                                                                       
* CHECK FOR VALID BUY ELEMENT (REGELEM)                                         
*********                                                                       
VLDREGEL NTR1                                                                   
         USING REGELEM,R4                                                       
VLDREG10 CLI   0(R4),0             ANY MORE ORIGINAL ELEMS?                     
         JE    VLDREGNO            NO MORE                                      
*                                                                               
         CLI   0(R4),RCORGQ        X'06' - ORIGINAL ELEM?                       
         JE    VLDREGYS                                                         
         CLI   0(R4),RCOTOQ        X'07' - OTO ELEM?                            
         JE    VLDREGYS                                                         
         CLI   0(R4),RCPOLOQ       X'0B' - POOL ORIGINAL ELEM?                  
         JE    VLDREGYS                                                         
         CLI   0(R4),RCPOTOQ       X'0C' - POOL OTO ELEM?                       
         JE    VLDREGYS                                                         
*                                                                               
VLDREG15 LLC   R0,1(R4)            NO, CHECK NEXT ELEMENT                       
         AR    R4,R0                                                            
         J     VLDREG10                                                         
*                                                                               
VLDREGYS SR    RF,RF                                                            
VLDREGNO LTR   RF,RF                                                            
         XIT1  REGS=(R4)           RETURN R4 TO USER                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* CHECK IF THE BUY IS A TRADE BUY                                               
*                                                                               
* ON ENTRY:    (R4)                A(BUY RECORD)                                
*                                                                               
* ON EXIT:     (CC)                CONDITION CODE                               
***********************************************************************         
CHKIFTRD NTR1  BASE=*,LABEL=*                                                   
         USING BUYKEY,R4                                                        
***************                                                                 
* TRADE USING  SPECIAL REP                                                      
***************                                                                 
         OC    PDARTSRP(3),PDARTSRP ANY DARE SPECIAL REP IN PROFILE?            
         JZ    IFTRDNO              NO, NOT A TRADE BUY                         
         CLC   PDARTSRP(3),EZEROS                                               
         JE    IFTRDNO              NO, NOT A TRADE BUY                         
*                                                                               
         OC    BDREP,BDREP                                                      
         JZ    IFTRDNO                                                          
*                                                                               
         GOTOR VRCPACK,DMCB,(C'U',BDREP),DUB                                    
*                                                                               
         CLI   PDARMTRD,C'Y'       USING MULTIPLE TRADE CODES?                  
         JE    *+14                                                             
         CLC   PDARTSRP(3),DUB     IF IT MATCHES THEN TRADE                     
         J     IFTRDX                                                           
         CLC   PDARTSRP(2),DUB                                                  
*                                                                               
IFTRDX   J     EXITCC                                                           
IFTRDNO  J     EXITN                                                            
         EJECT                                                                  
         DROP  R4                                                               
***********************************************************************         
* CHECKS IF POOL ORIGINAL ELEM MATCHES OUR ORDER                                
*                                                                               
* ON ENTRY:    R4                  A(POOL ORIGINAL ELEMENT)                     
*                                                                               
* ON EXIT:     PR1TIMSH            PRODUCT 1 TIME SHARE                         
*              (CC)                EQ = YES                                     
*                                                                               
* NOTE:  WORK  GETS CLOBBERED                                                   
***********************************************************************         
CHKPOLEL NTR1  BASE=*,LABEL=*                                                   
         USING REGELEM,R4                                                       
         CLI   1(R4),RPALLOC-REGELEM  ANY PRODUCT ALLOCATION?                   
         JNH   CPOLNO                 YES                                       
***********************************                                             
* PRODUCT ALLOCATED                                                             
***********************************                                             
CPOL10   TM    RSTATUS,RSMINUSQ+RSMINSDQ  IGNORE THESE -OTO                     
         JNZ   CPOLNO                                                           
*                                                                               
         LLC   R0,1(R4)                                                         
         SH    R0,=Y(RPALLOC-REGELEM)                                           
         LA    R1,RPALLOC                                                       
*                                                                               
         CLC   SVBPRD,0(R1)        MATCH ON PRODUCT?                            
         JNE   CPOL40              NO, SEE IF OUR P/B IS BUY'S PRD              
*                                                                               
         SH    R0,=Y(L'RPALLOC)    ANY PIGGYBACK?                               
         JNP   CPOL20              NO PIGGYBACK                                 
         CLI   SVBPR2,0            DOES ORDER HAVE P/B?                         
         JE    CPOLNO              NO, SKIP THIS SPOT                           
         LA    R1,L'RPALLOC(R1)                                                 
         CLC   SVBPR2,0(R1)        PIGGYBACKS MATCH?                            
         JNE   CPOLNO              NO, NEXT SPOT                                
         MVC   PR1TIMSH,RPTIME     YES, SAVE PRODUCT 1 TIME SHARE               
         J     CPOLYES                                                          
*                                                                               
CPOL20   CLI   SVBPR2,0            DOES ORDER HAVE P/B?                         
         JE    CPOLYES             NO, WE CAN USE THIS SPOT                     
         J     CPOLNO                                                           
*********                                                                       
* REVERSED, PRD IS P/B & P/B IS PRD                                             
*********                                                                       
CPOL40   CLI   SVBPR2,0            DOES THE ORDER HAVE PIGGYBACK?               
         JE    CPOLNO              NO, CHECK NEXT ELEM                          
         CLC   SVBPR2,0(R1)        YES, PIGGYBACK IS PRD?                       
         JNE   CPOLNO                   NO, OUR P/B IS NOT PRD EITHER           
*                                                                               
         SH    R0,=Y(L'RPALLOC)    SEE IF ANY PIGGYBACK                         
         JNP   CPOLNO              NEED ONE NOW                                 
         LA    R1,L'RPALLOC(R1)                                                 
         CLC   SVBPRD,0(R1)                                                     
         JNE   CPOLNO                                                           
         MVC   PR1TIMSH,RPTIME-RPALLOC(R1)    SAVE PRD 1 TIME SHARE             
CPOLYES  J     EXITY                                                            
CPOLNO   J     EXITN                                                            
         EJECT                                                                  
*                                                                               
GETHDNG  BASR  R1,RE               RETURN TO RE WITH A(HEADING) IN R1           
HEADING  DS    0X                                                               
         SPROG 1,5,10,11,12,13,14,15                                            
         SPEC  H2,1,REQUESTOR                                                   
         SPEC  H1,54,C'CONFIRMATION OF PURCHASE'                                
         SPEC  H2,54,C'------------------------'                                
         SPEC  H1,95,AGYNAME                                                    
         SPEC  H2,95,AGYADD                                                     
         SPEC  H3,50,C'PERIOD FROM JAN01/01 TO DEC31/01'                        
         SPEC  H3,108,RUN                                                       
         SPEC  H4,1,C'CLIENT'                                                   
         SPEC  H4,95,PAGE                                                       
         SPEC  H5,1,C'PRODUCT'                                                  
         SPEC  H6,1,C'ESTIMATE'                                                 
         SPEC  H7,95,C'------------------------------------'                    
         SPEC  H8,95,C'SALESPERSON'                                             
         SPEC  H8,106,X'7D'                                                     
         SPEC  H8,107,C'S SIGNATURE'                                            
*                                                                               
* SPECIAL HEADLINES FOR ZENITH                                                  
*                                                                               
         SPROG 10,11,13,14,15                                                   
         SPEC  H10,2,C'STATION INVOICE TO:'                                     
*                                                                               
         SPROG 10,11,12,13,14,15                                                
         SPEC  H13,2,C'--- MUST INCLUDE REFERENCE NUMBER ---'                   
*                                                                               
*  DEFAULT                                                                      
*                                                                               
         SPROG 10                                                               
         SPEC  H11,2,AGYNAME                                                    
         SPEC  H11,33,C','                                                      
         SPEC  H11,34,AGYADD                                                    
*                                                                               
*  SVACCAGY = DF + DW  -OR-                                                     
*  SVACCOFC = 3A + 3C + 3D + 3K + 3P                                            
*                                                                               
         SPROG 11,14,15                                                         
         SPEC  H11,2,C'SAATCHI'                                                 
         SPEC  H11,10,X'50'                                                     
         SPEC  H11,12,C'SAATCHI,'                                               
         SPEC  H11,21,C'79 MADISON AVENUE, NEW YORK, NY 10016-7802'             
         SPEC  H12,2,C'AGENT FOR SAATCHI AND SAATCHI, AGENT FOR CLIENT'         
*                                                                               
*  SVACCAGY = TH                                                                
*                                                                               
         SPROG 12                                                               
         SPEC  H11,2,C'ZENITH MEDIA SERVICES, INC.,'                            
         SPEC  H11,30,C'79 MADISON AVE., NEW YORK, NY 10016-7802'               
         SPEC  H12,2,C'AS AGENT FOR CLIENT'                                     
         SPEC  H14,2,C'THIS ORDER IS MADE UNDERAND IS SUBJECT TO AAAA'          
         SPEC  H14,48,C'AND AND CONDITIONS FOR LOCAL BROADCAST'                 
*                                                                               
*  SVACCAGY = BS                                                                
*                                                                               
         SPROG 13                                                               
         SPEC  H11,2,C'BATES USA, '                                             
         SPEC  H11,14,C'498 SEVENTH AVENUE,NY NY 10018'                         
*                                                                               
* SPECIAL HEADLINES FOR OPTIMEDIA                                               
*                                                                               
         SPROG 5                                                                
         SPEC  H10,2,C'ORIGINAL INVOICES AND AFFIDAVITS SHOULD BE SENT'         
         SPEC  H10,50,C'BY THE 10TH OF THE FOLLOWING MONTH TO:'                 
         SPEC  H11,2,C'SIMON PROPERTY GROUP C/O OPTIMEDIA,'                     
         SPEC  H11,38,C'79 MADISON AVENUE, NEW YORK, NY 10016-7802'             
         SPEC  H12,2,C'SIMON PROPERTY GROUP, LP, BY AND THROUGH ITS'            
         SPEC  H12,47,C'AGENT, OPTIMEDIA INTERNATIONAL US, INC.'                
*                                                                               
         SPEC  END                                                              
         EJECT                                                                  
*==================================================================             
* HOOK ROUTINE                                                                  
*==================================================================             
GETHOOK  BASR  R1,RE               RETURN TO RE WITH A(HOOK) IN R1              
HOOK     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         SRL   RF,24                                                            
         CHI   RF,HOOKTABN                                                      
         JNL   *+2                                                              
         CHI   RF,0                                                             
         JNH   *+2                                                              
         BCTR  RF,0                                                             
         SLL   RF,2                                                             
         B     HOOKTAB(RF)                                                      
*                                                                               
HOOKTAB  B     HEADHOOK                                                         
         B     MIDHOOK                                                          
         B     EXITY                                                            
HOOKTABN EQU   (*-HOOKTAB)/L'HOOKTAB                                            
*                                                                               
HEADHOOK OI    REPHEADI,REPHCLRA                                                
*                                                                               
         MVC   H1(10),=CL10'SPOT TV'                                            
         CLI   SVMED,C'T'          IS IT TV?                                    
         JE    HDHK4                                                            
         MVC   H1(10),=CL10'SPOT RADIO'                                         
         CLI   SVMED,C'R'          IS IT RADIO?                                 
         JE    HDHK4                                                            
         MVC   H1(10),=CL10'NTWK RADIO'                                         
         CLI   SVMED,C'X'          IS IT NETWORK RADIO?                         
         JNE   *+2                                                              
HDHK4    MVC   H4+9(3),SVQCLT                                                   
         MVC   H4+13(20),CLTNM                                                  
         MVC   H5+9(3),SVQPRD                                                   
         MVC   H5+13(20),PRDNM                                                  
         LA    R4,H6                                                            
         CLC   SVQPR2,SPACES                                                    
         JNH   HDHK10                                                           
         MVC   H6(8),=C'PARTNER '                                               
         MVC   H6+9(3),SVQPR2                                                   
         MVC   H6+13(20),PR2NM                                                  
*                                                                               
         LA    R4,H7                                                            
HDHK10   MVC   0(8,R4),=C'ESTIMATE'                                             
         MVC   9(3,R4),SVQEST                                                   
         MVC   13(20,R4),ESTNM                                                  
         AHI   R4,2*132            SKIP TWO LINES                               
         BRAS  RE,PRTVRSN                                                       
*                                                                               
         GOTOR VDATCON,DMCB,ESTSTRT,(8,H3+61)                                   
         GOTOR (RF),(R1),ESTEND,(8,H3+73)                                       
*                                                                               
         TM    FLTRCFLG,FRFEXIST   FLIGHT?                                      
         JNZ   *+8                                                              
         MVI   H3+81,C'*'          INDICATE ES DATES                            
*                                                                               
         MVC   H3+94(10),=C'REPORT DFX'                                         
*                                                                               
         MVC   H5+48(36),SPACES                                                 
         MVC   H5+48(6),=C'MARKET'                                              
         MVC   H5+55(4),SVQMKT                                                  
         MVC   H5+60(24),MKTNM                                                  
         OC    H5+48(36),SPACES                                                 
         GOTOR VCENTER,DMCB,H5+48,36                                            
*                                                                               
         MVC   H7+48(36),SPACES                                                 
         MVC   H7+48(7),=C'STATION'                                             
*                                                                               
         TM    TSERRS,TSEEOF       DID WE GET A BUY RECORD IN TSAR?             
         JO    HDHK15              NO, SKIP THIS                                
         OC    BHISSTA,BHISSTA     DO WE HAVE A STATION?                        
         JZ    *+2                  NO, JUST DIE                                
         LA    R1,BHISSTA                                                       
         BRAS  RE,GETQSTA                                                       
*                                                                               
HDHK15   LA    R1,7                                                             
         CLI   SVSTAEDT,C'0'       IS IT CABLE?                                 
         JL    *+8                                                              
         LA    R1,4                YES, ONLY MOVE THE SYS CODE + /              
*                                                                               
         MVC   H7+56(0),SVSTAEDT                                                
         EX    R1,*-6                                                           
         MVC   H7+65(3),SVAFFL                                                  
         OC    H7+48(36),SPACES                                                 
         GOTOR VCENTER,DMCB,H7+48,36                                            
*                                                                               
HDHKX    J     EXITY                                                            
*                                                                               
PRTVRSN  NTR1                                                                   
         MVC   0(37,R4),=CL37'** DARE ORDER 12345678 - ORIGINAL **'             
         MVC   14(8,R4),SVQORDER                                                
         CLI   SVCURREV,0        TEST ORIGINAL                                  
         JNE   PRTVRS2                                                          
         CLI   SVRESEND,C'Y'     TEST RESEND                                    
         JNE   PRTVRS10            NO                                           
         MVC   34(12,R4),=CL12'- RESEND **'                                     
         J     PRTVRS10                                                         
*                                                                               
PRTVRS2  MVC   25(14,R4),SPACES                                                 
         MVC   25(10,R4),=C'REV 001 **'                                         
         LLC   R0,SVCURREV                                                      
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  29(3,R4),DUB                                                     
         CLI   SVRESEND,C'Y'    TEST RESEND                                     
         JNE   PRTVRS4            NO                                            
         MVC   33(12,R4),=CL12'- RESEND **'                                     
         J     PRTVRS10           DON'T PRINT REPLACES - DATE IS LOST           
*                                                                               
PRTVRS4  AHI   R4,132              ADVANCE TO NEXT LINE                         
         MVC   3(20,R4),=C'REPLACES REV 000  OF'                                
         LLC   R0,SVPREREV                                                      
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  16(3,R4),DUB                                                     
         CLI   SVPREREV,0        TEST REPLACES ORIGINAL                         
         JNE   *+10                                                             
         MVC   12(8,R4),=C'ORIGINAL'                                            
         GOTOR VDATCON,DMCB,(2,SVPRVDAT),(5,24(R4))                             
*                                                                               
PRTVRS10 CLI   DRCSHTRD,0          CASH OR TRADE ONLY?                          
         JZ    PRTVRSX             NONE                                         
         AHI   R4,132                                                           
         MVC   0(30,R4),=CL30'*****  TRADE SPOTS ONLY  *****'                   
         CLI   DRCSHTRD,TRDESREP   C'R' TRADE ONLY?                             
         JE    PRTVRSX                                                          
         MVC   0(30,R4),=CL30'*****  CASH  SPOTS ONLY  *****'                   
*                                                                               
PRTVRSX  J     EXIT                                                             
         EJECT                                                                  
*                                                                               
MIDHOOK  OI    REPMIDSI,REPMCLRA                                                
*                                                                               
         CLC   PASS,MIDPASS        TEST NEED TO CHANGE DATES                    
         JE    MIDHK10             NO                                           
*                                                                               
         MVC   SVMID2(L'MYMID2),MYMID2                                          
         MVC   SVMID3(30),=C'      PROGRAMMING          LEN'                    
         MVC   SVMID3+124(7),=C'CPP/CPM'                                        
*                                                                               
         MVC   SVMID2+35(56),SPACES  BLANK OUT THE DATES                        
         MVC   SVMID3+35(56),SPACES                                             
*                                                                               
         MVC   MIDPASS,PASS          SAVE CURRENT PASS NUMBER                   
         LLC   R4,PASS                                                          
         BCTR  R4,0                                                             
         MHI   R4,12               12 BYTES/ENTRY                               
         LA    R4,PASSTAB(R4)                                                   
         MVC   WORK(12),0(R4)      SET CURRENT PERIOD DATES YYMMDD              
*                                                                               
         LA    R4,SVMID2+35                                                     
         LHI   R3,14               MAX WEEK/DAY ENTRIES                         
*                                                                               
MIDHK4   GOTOR VDATCON,DMCB,WORK,(4,DUB)   GET MMMDD                            
         MVC   0(3,R4),DUB         MOVE MMM                                     
         MVC   133(2,R4),DUB+3     MOVE DD                                      
*                                                                               
         LHI   R0,7                                                             
         CLI   SVEDAILY,C'Y'                                                    
         JNE   *+8                                                              
         LHI   R0,1                                                             
         GOTOR VADDAY,DMCB,WORK,WORK+12,(R0)                                    
         MVC   WORK(6),WORK+12                                                  
         CLC   WORK(6),WORK+6                                                   
         JH    MIDHK10                                                          
         AHI   R4,4                                                             
         JCT   R3,MIDHK4                                                        
         DC    H'0'                                                             
*                                                                               
MIDHK10  MVC   M1+35(L'MYM1),MYM1                                               
         MVC   M2,SVMID2                                                        
         MVC   M3,SVMID3                                                        
*                                                                               
MIDHKX   J     EXIT                                                             
*                                                                               
MYM1     DC    C'----------------- NUMBER OF TELECASTS ----------------X        
               --'                                                              
*                                                                               
MYMID2   DC    C'BUYLINE DAYS       TIME            JAN JAN JAN JAN  JAX        
               N FEB FEB FEB FEB MAR MAR MAR MAR MAR    TOT     COST  -X        
               --- DEMOGRAPHICS ----'                                           
         EJECT                                                                  
***********************************************************************         
* CALL LINKIO TO BUILD ERROR RETURN ELEMENT                                     
*                                                                               
*  ON ENTRY : 0     - SYSTEM NUMBER                                             
*             1-3   - ERROR NUMBER                                              
*             XTRATEXT                                                          
*                                                                               
***********************************************************************         
*                                                                               
PUTERR   NTR1  BASE=*,LABEL=*                                                   
         MVC   WORK(2),2(R1)                                                    
*                                                                               
         L     RF,ALIOB                                                         
         USING LIOBD,RF                                                         
         MVC   LIOBMSYS,0(R1)      GET ERROR MESSAGE FROM SYSTEM                
         DROP  RF                                                               
*                                                                               
         TM    MISCFLG2,MF2PUTDA                                                
         JNZ   PUTERR10                                                         
         CLI   0(R1),SE#SY023           SYSTEM 23 MESSAGE?                      
         JNE   PUTERR05                                                         
         CLC   2(2,R1),=AL2(SE#OFFNF)    OFFER NOT FOUND ERROR?                 
         JNE   PUTERR05                                                         
         GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTMAP',321)                   
         J     PUTERR20                                                         
*                                                                               
PUTERR05 GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTMAP',177)                   
         J     PUTERR20                                                         
*                                                                               
PUTERR10 GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTMAP',1)                     
PUTERR20 GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTERR',D#UPLERR),    *        
               WORK,(L'XTRATEXT,XTRATEXT)                                       
*                                                                               
         NI    MISCFLG2,X'FF'-MF2PUTDA                                          
         OI    CURRFLAG,CRFERROR                                                
*                                                                               
PUTERRX  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* SEND RUN ORDER DOWNLOAD REQUEST AND DISK ADDRESS OF BUY TO DDLINK             
*                                                                               
* NTRY:- R1=A(RECORD DISK ADDRESS)                                              
***********************************************************************         
PUTORD   NTR1  BASE=*,LABEL=*                                                   
         LR    R2,R1               R2=A(RECORD DISK ADDRESS)                    
*                                                                               
         L     R4,ALIOB                                                         
         USING LIOBD,R4                                                         
*                                                                               
         SR    R0,R0               BUILD DOWNLOAD MAP ELEMENT                   
         ICM   R0,3,LP_QMAPN                                                    
         AHI   R0,1                                                             
         GOTOR ALINKIO,DMCB,('LIOAPUT',ALIOB),('LIOTMAP',(R0))                  
*                                                                               
         GOTOR (RF),(R1),('LIOAPUT',ALIOB),('LIOTRUN',I#SDOOAR)                 
*                                                                               
         GOTOR (RF),(R1),('LIOAPUT',ALIOB),('LIOTRAW',D#DA),           *        
               ('LD_HEXDQ',(R2)),(L'DISKADDR,0)                                 
*                                                                               
         OC    PCKEYORD,PCKEYORD                                                
         JZ    PUTOR015                                                         
         SR    R0,R0                                                            
         ICM   R0,3,LW_LN-LW_D(RF)                                              
         SHI   R0,LW_LN1Q                                                       
         GOTOR ALINKIO,(R1),('LIOAPUT',ALIOB),('LIOTRAW',D#PCKEY),     *        
               ('LD_CHARQ',PCKEYORD),(L'PCKEYORD,0)                             
*                                                                               
PUTOR015 GOTOR ALINKIO,(R1),('LIOAPUT',LIOBD),('LIOTERU',0),0,0                 
*                                                                               
PUTOR020 OI    MISCFLG2,MF2PUTDA                                                
*                                                                               
         J     EXITY                                                            
         EJECT                                                                  
         DROP  R4                                                               
***********************************************************************         
* SEND RUN MG DOWNLOAD REQUEST AND DISK ADDRESS OF BUY TO DDLINK                
*                                                                               
* NTRY:- R1=A(RECORD DISK ADDRESS)                                              
***********************************************************************         
PUTMKGD  NTR1  BASE=*,LABEL=*                                                   
         L     R4,ALIOB                                                         
         USING LIOBD,R4                                                         
         LR    R2,R1               R2=A(RECORD DISK ADDRESS)                    
*                                                                               
         GOTOR ALINKIO,DMCB,('LIOAPUT',LIOBD),('LIOTRUN',I#SDOOFC)              
         GOTOR (RF),(R1),('LIOAPUT',LIOBD),('LIOTRAW',D#DA),           *        
               ('LD_HEXDQ',(R2)),(L'DISKADDR,0)                                 
*                                                                               
         ICM   RF,15,I$PCKEY                                                    
         JZ    PUTMK015                                                         
         SR    R0,R0                                                            
         ICM   R0,3,LW_LN-LW_D(RF)                                              
         SHI   R0,LW_LN1Q                                                       
         GOTOR ALINKIO,(R1),('LIOAPUT',LIOBD),('LIOTRAW',D#PCKEY),     *        
               ('LD_CHARQ',LW_DATA1-LW_D(RF)),((R0),0)                          
*                                                                               
PUTMK015 CLI   SVBSTA,X'E8'        CABLE?                                       
         BL    PUTMK030                                                         
**                                                                              
* PASSING RAW FORMAT, SO NO NEED TO VALIDATE IN SPLNK32                         
**                                                                              
         GOTOR ALINKIO,(R1),('LIOAPUT',LIOBD),('LIOTRAW',D#STA),       *        
               ('LD_HEXDQ',SVBSTA),(L'SVBSTA,0)                                 
*                                                                               
PUTMK030 GOTOR ALINKIO,(R1),('LIOAPUT',LIOBD),('LIOTERU',0),0,0                 
         OI    MISCFLG2,MF2PUTDA                                                
*                                                                               
PUTMKX   J     EXITY                                                            
         EJECT                                                                  
         DROP  R4                                                               
*                                                                               
***********************************************************************         
* ROUTINE TO APPLY FILTERS TO BUY KEY (DROP PASSIVE KEYS/SET SPILL)             
***********************************************************************         
FLTBKY   ICM   RF,15,EFFS          SET NORMAL MASK (0 BIT NTWK)                 
         CLI   SVMED,C'T'          TELEVISION?                                  
         JNE   FLTBKY02                                                         
         CLI   SBKSTAC,X'E8'       CABLE?                                       
         JL    FLTBKY02            NO                                           
         LHI   RF,-X'80'           SET LOCAL CABLE MASK/CLR LAST 7 BITS         
*                                                                               
FLTBKY02 SR    R0,R0                                                            
         ICM   R0,7,IOKEY+BUYKSTA-BUYKEY                                        
         NR    R0,RF                                                            
         SR    R1,R1                                                            
         ICM   R1,7,SVBSTA                                                      
         NR    R1,RF                                                            
         CR    R0,R1                                                            
         BR    RE                                                               
***********************************************************************         
* ROUTINE TO APPLY FILTERS TO BUY RECORD                                        
***********************************************************************         
         USING BUYREC,R1                                                        
FLTBRD   NTR1  LABEL=NO                                                         
*                                                                               
         TM    FLTRCFLG,FRFEXIST   DOING FLIGHT?                                
         JZ    FLTBRD20                                                         
*                                                                               
         CLC   BDSTART,SVFLTSDT    MAKE SURE BUY IS IN FLIGHT                   
         JL    FLTBRD10                                                         
         CLC   BDSTART,SVFLTEDT                                                 
         JH    FLTBRDNO                                                         
         J     FLTBRD20                                                         
*                                                                               
FLTBRD10 CLC   BDEND,SVFLTSDT                                                   
         JL    FLTBRDNO                                                         
*                                                                               
FLTBRD20 LR    R4,R1                                                            
         CLI   DRCSHTRD,TRDESREP   DOING TRADE NOW?                             
         JNE   FLTBRD30            NO, LET'S SEE IF WE HAVE TRADE BUYS          
         BRAS  RE,CHKIFTRD                                                      
         JE    FLTBRDYS                                                         
         OI    MISCFLG1,MF1CSHCD   NO, SO WE KNOW THAT WE HAD CASH              
         J     FLTBRDNO                                                         
*                                                                               
FLTBRD30 BRAS  RE,CHKIFTRD                                                      
         JNE   FLTBRDYS                                                         
         OI    MISCFLG1,MF1TRDCD   WE HAVE A TRADE CONDITION                    
*        J     FLTBRDNO                                                         
*&&DO                                                                           
FLTBRD40 CLC   SVREPCOD,=C'VDA'    SENDING TO VDA?                              
         JE    FLTBRD50                                                         
         CLC   SVREPCOD,=C'ITN'    OR ITN?                                      
         JNE   FLTBRD60            NO                                           
*                                                                               
FLTBRD50 LR    R4,R1               YES, MATCH AAVUUID PREFIX TO REPCODE         
         MVI   ELCDLO,AAVCODQ                                                   
         MVI   ELCDHI,AAVCODQ      LETS FIND AAVUUID ELEMENT                    
         BRAS  RE,GETEL                                                         
         JNE   FLTBRDNO            NO ELEMENT FOUND, THEN NO MATCH              
*                                                                               
         CLC   SVREPCOD,AAVUUID    REP CODE MATCHES AAVUUID PREFIX?             
         JE    FLTBRDYS             YES, SEND THE BUYLINE                       
         J     FLTBRDNO                                                         
*                                                                               
FLTBRD60 LR    R4,R1               NO MATCH AAVUUID PREFIX TO REPCODE           
         MVI   ELCDLO,AAVCODQ                                                   
         MVI   ELCDHI,AAVCODQ      LETS FIND AAVUUID ELEMENT                    
         BRAS  RE,GETEL                                                         
         JNE   FLTBRDYS            ELEMENT NOT FOUND, OK TO SEND                
*&&                                                                             
FLTBRDNO J     EXITN                                                            
FLTBRDYS J     EXITY                                                            
         DROP  R1                                                               
*                                                                               
GETEL    AH    R4,DATADISP                                                      
         J     NEXTEL2                                                          
NEXTEL   CLI   0(R4),0                                                          
         JE    NEXTELX                                                          
         LLC   R0,1(R4)                                                         
         LTR   R0,R0                                                            
         JZ    *+2                                                              
         AR    R4,R0                                                            
NEXTEL2  CLI   0(R4),0                                                          
         JE    NEXTELX                                                          
         CLC   ELCDLO,0(R4)                                                     
         JH    NEXTEL                                                           
         CLC   ELCDHI,0(R4)                                                     
         JL    NEXTEL                                                           
         CR    RB,RB                                                            
         J     *+6                                                              
NEXTELX  LTR   RB,RB                                                            
         BR    RE                                                               
         EJECT                                                                  
*                                                                               
GLOBALS  DS    0D                  ** GLOBAL LITERALS **                        
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
RTRNYES  CR    RE,RE               RETURN WITH CC=EQUAL                         
         BR    RE                                                               
                                                                                
RTRNNO   LTR   RE,RE               RETURN WITH CC=NOT EQUAL                     
         BR    RE                                                               
*                                                                               
SETCCC   JE    *+8                 SET CONVERSE CONDITION CODE                  
         CR    RE,RE               CC=EQUAL IF INDICATOR ON                     
         BR    RE                                                               
         LTR   RE,RE               CC=NOT EQUAL IF INDICATOR OFF                
         BR    RE                                                               
*                                                                               
MORE     MVI   LP_RMODE,LP_RMORE   TELL DDLINK TO CALL ME AGAIN                 
         J     EXITY                                                            
*                                                                               
NOMORE   MVI   LP_RMODE,LP_RLAST   SET NO MORE RECORDS & EXIT                   
EXITN    LHI   RE,0                                                             
         J     EXIT                                                             
EXITY    LHI   RE,1                                                             
EXIT     CHI   RE,1                                                             
EXITCC   XIT1  ,                                                                
*                                                                               
LVALUES  DS    0F                                                               
         DC    A(FLTBKY)                                                        
         DC    A(FLTBRD)                                                        
         DC    V(SPOMCOM)                                                       
*                                                                               
         DC    X'00FF'                                                          
         DC    C'00000000'                                                      
         DC    AL1(3,2,0,060)      ASSOCIATED WITH LABEL V320060                
         DC    AL1(4,6,0,050)      ASSOCIATED WITH LABLE V460050                
         DC    AL1(4,6,0,156)      ASSOCIATED WITH LABLE V4600156               
         DC    AL1(4,7,0,37)       ASSOCIATED WITH LABLE V470037                
         DC    AL2(42,32,5970),AL4(0)                                           
         EJECT                                                                  
*                                                                               
RECTAB   DS    0XL(RECTABL)                ** RECORD TABLE **                   
         DC    AL2(I#SDPERD),AL3(VALPERD),X'FF'      X'0086                     
*                                                                               
         DC    AL2(I#SDOMHD),AL3(OMHEADER),X'FF'     X'0181'                    
         DC    AL2(I#SDBCNF),AL3(BCNFORD),X'0'       X'0176'                    
         DC    AL2(I#SDMGCH),AL3(UPDMKO),X'0'        X'0180'                    
         DC    AL2(I#SDOSAV),AL3(SAVEORD),X'0'       X'0182'                    
         DC    AL2(I#SDOEXS),AL3(OREXSTAT),X'0'      X'018B'                    
         DC    AL2(I#SDMETA),AL3(SDMETADL),X'0'      X'0155'                    
*                                                                               
RECTABX  EQU   *                                                                
RECTABN  EQU   (*-RECTAB)/L'RECTAB                                              
         EJECT                                                                  
*                                                                               
* TABLE IS SETUP TO SUPPORT CABLE READING                                       
*  TRYING TO NARROW DOWN TO THE SYSCODE LVL (ALMOST)                            
BUYKEYT  LKKEY H,BUYKEY,SAVED                                                   
         LKKEY SIN,BUYKAM,SBKAGM                                                
         LKKEY SIN,BUYKCLT,SBKCLT                                               
         LKKEY SIN,BUYKPRD,SBKPRD                                               
         LKKEY SIN,BUYKMKT,SBKMKT                                               
         LKKEY SIN,BUYKSTA,SBKSTAC,L'SBKSTAC-1                                  
         LKKEY ALL,BUYKSTA+2,,1                                                 
         LKKEY SIN,BUYKEST,SBKEST                                               
         LKKEY LIT,BUYKBUY,FF,1                                                 
         LKKEY ALL,BUYKBUY+1,,2                                                 
         LKKEY E                                                                
*                                                                               
MKTKEYT  LKKEY H,MKTKEY,SAVED      ** MARKET DRIVER **                          
         LKKEY LIT,MKTKTYPE,MKTKTYPQ                                            
         LKKEY SIN,MKTKMED,MEDIA                                                
         LKKEY SIN,MKTKMKT,SVQMKT                                               
         LKKEY SIN,MKTKAGY,AGENCY                                               
         LKKEY LIT,MKTKFILL,C'0'                                                
         LKKEY E                                                                
*                                                                               
SPGKEYT  LKKEY H,GKEY              ** SUPERDESK GOAL DRIVER TABLE **            
         LKKEY LIT,GKEYTYPE,GKEYTYPQ                                            
         LKKEY SIN,GKEYAM,SVBAGM                                                
         LKKEY SIN,GKEYCLT,SVBCLT                                               
         LKKEY SIN,GKEYPRD,SVBPRD                                               
         LKKEY SIN,GKEYMKT,SVBMKT                                               
         LKKEY SIN,GKEYEST,SVBEST                                               
         LKKEY ALL,GKEYDPT,,L'GKEYDPT+L'GKEYSLN+L'GKEYSEC                       
         LKKEY LIT,GKEYAGY,0                                                    
         LKKEY LIT,GKEYPRD2,0                                                   
         LKKEY E                                                                
*                                                                               
FLMBUF   BUFFD TYPE=D,KEYLEN=0,COMLEN=0,BUFFERS=10                              
*                                                                               
B#CLTREC EQU   3                   IO2 - CLIENT RECORD                          
B#ORDREC EQU   4                   IO3 - ORDER RECORD                           
B#MKTREC EQU   4                       - MARKET RECORD                          
B#NOTREC EQU   4                       - NOTICE RECORD                          
B#ORD1RC EQU   5                   IO4   ORDER AGENCY COMMENT RECORD            
*B#ESTREC EQU   5                       - ESTIMATE RECORD                       
B#GOLREC EQU   5                         GOAL RECORD                            
B#OFFREC EQU   6                   IO5 - OFFER RECORD                           
B#BUYREC EQU   6                         BUY RECORD                             
B#OF2REC EQU   7                   IO6 - OFFER 2 RECORD                         
B#BTCREC EQU   7                         BATCH RECORD                           
B#ESTREC EQU   8                   IO7 - ESTIMATE RECORD                        
AESTREC  EQU   LP_BLKS+((B#ESTREC-1)*L'LP_BLKS)                                 
B#FLTREC EQU   9                   IO8 - FLIGHT RECORD                          
AFLTREC  EQU   LP_BLKS+((B#FLTREC-1)*L'LP_BLKS)                                 
B#ACCREC EQU   9                   IO8 - ACCESS RECORD                          
B#TOKREC EQU   9                   IO8 - TOKEN RECORD                           
*                                                                               
***********************************************************************         
* CALL STAPACK TO UNPACK THE STATION                                            
* ON ENTRY : R1   A(PACKED STATION)                                             
*                                                                               
* ON EXIT  : STAPQSTA  FORMAT SSSSB  (IF BAND T, THEN BAND IS EMPTY)            
*          : SVQSTA    FORMAT SSSSB                                             
*          : SVQSTA    FORMAT SSSSB                                             
*          : SVSTAEDT  FORMAT SSSS-BB/NNN    /NNN CABLE ONLY                    
***********************************************************************         
GETQSTA  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVI   STAPACT,C'U'                                                     
         MVC   STAPAGY,LP_AGY                                                   
         L     RF,AAGYREC                                                       
         MVC   STAPCTRY,AGYPCNDA-AGYHDR(RF)                                     
         MVC   STAPMED,SVMED                                                    
         MVC   STAPACOM,ACOMFACS                                                
         XC    STAPQMKT,STAPQMKT                                                
         MVC   STAPSTA,0(R1)                                                    
         GOTOR VSTAPACK,STAPACKD                                                
*                                                                               
         MVC   SVQSTA,STAPQSTA                                                  
         CLI   SVQSTA+4,C' '                                                    
         JH    *+10                                                             
         MVC   SVQSTA+4(1),SVMED                                                
         MVC   SVSTAEDT(4),STAPQSTA                                             
         LA    RE,SVSTAEDT+3                                                    
         CLI   0(RE),C' '                                                       
         JH    *+6                                                              
         BCTR  RE,0                                                             
         AHI   RE,1                POINT AFTER STATION                          
         MVI   0(RE),C'-'                                                       
*                                                                               
         CLI   STAPQSTA,C'0'       TEST CABLE                                   
         JL    GETQSTA2                                                         
         MVI   0(RE),C'/'                                                       
         MVC   1(3,RE),STAPQNET    MOVE NETWORK                                 
         J     GETQSTAX                                                         
*                                                                               
GETQSTA2 MVI   1(RE),C'L'                                                       
         CLI   STAPQSTA+4,C'L'                                                  
         JE    GETQSTAX                                                         
*                                                                               
         MVC   1(2,RE),=C'DV'      DIGITAL VIDEO STREAMING MEDIA?               
         CLI   STAPQSTA+4,C'D'                                                  
         JE    GETQSTAX                                                         
*                                                                               
         MVC   1(2,RE),=C'TV'                                                   
         CLI   SVMED,C'T'                                                       
         JE    GETQSTAX                                                         
*                                                                               
         MVC   1(2,RE),=C'AM'                                                   
         CLI   STAPQSTA+4,C'A'                                                  
         JE    GETQSTAX                                                         
*                                                                               
         MVC   1(2,RE),=C'FM'                                                   
         CLI   STAPQSTA+4,C'F'                                                  
         JE    GETQSTAX                                                         
*                                                                               
         MVC   1(2,RE),=C'SM'      PANDORA RADIO STREAMING MEDIA?               
         CLI   STAPQSTA+4,C'S'                                                  
         JE    GETQSTAX                                                         
*                                                                               
         MVC   1(2,RE),=C'CM'      I-HEART RADIO COMBINED MEASUREMENT?          
         CLI   STAPQSTA+4,C'C'                                                  
         JE    GETQSTAX                                                         
*                                                                               
         MVC   1(1,RE),SVMED                                                    
         MVI   2(RE),C' '                                                       
*                                                                               
GETQSTAX J     EXIT                                                             
***********************************************************************         
* GET THE MARKET RECORD                                                         
***********************************************************************         
GETMKT   NTR1  BASE=*,LABEL=*                                                   
         MVI   IOKEY,C'0'                                                       
         MVC   IOKEY+1(16),IOKEY                                                
         LA    R2,IOKEY                                                         
         USING MKTRECD,R2                                                       
         MVI   MKTKTYPE,C'M'       MARKET TYPE                                  
         MVC   MKTKMED,SVMED                                                    
         MVC   MKTKMKT,SVQMKT                                                   
         MVC   MKTKAGY,LP_AGY                                                   
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOSTAFIL+IO7'                            
         JNE   *+2                                                              
         L     R2,AIO7                                                          
         CLC   IOKEY(MKTKFILL-MKTKEY),0(R2)                                     
         JNE   *+2                                                              
         MVC   MKTNM,MKTNAME                                                    
         DROP  R2                                                               
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* VALIDATE THE STANDARD COMMENT                                                 
***********************************************************************         
VALSTD   NTR1  BASE=*,LABEL=*                                                   
         USING DOIDELD,R3                                                       
         LA    R4,IOKEY            LOOK UP THE STANDARD COMMENT                 
         USING COMKEY,R4                                                        
         XC    COMKEY,COMKEY                                                    
         MVI   COMKTYP,COMKTYPQ                                                 
         MVI   COMKSUB,COMKSUBQ                                                 
         MVC   COMKAM,SVBAGM                                                    
         MVC   COMKCOM,DOISCOM1                                                 
         OC    COMKCOM,SPACES                                                   
         DROP  R3,R4                                                            
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         J     EXITCC                                                           
*                                                                               
***********************************************************************         
* PRINT OUT THE DEMO COMMENTS                                                   
*                                                                               
* ON ENTRY:    (AIO5)              A(BUY RECORD)                                
*              PW                  MIGHT HAVE A COMMENT TO DISPLAY              
*                                                                               
* ON EXIT:     PW                  LAST COMMENT TO PRINT                        
***********************************************************************         
DMOCMNTS NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO5             R4 = A(BUY RECORD)                           
         MVI   ELCDLO,NDCORGQ      X'02' DEMO ELEMENT                           
         MVI   ELCDHI,NDCORGQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   DMOCMNTX            NO DEMO VALUES                               
         LR    R6,R4               R6 = A(DEMO ELEMENT)                         
*                                                                               
         LA    R2,ESTDEMOS         R2= A(ORDER DEMOS TO SEND)                   
         LA    R4,L'EDEMLIST       R4= L(SINGLE EST DEMO CAT)                   
         LLH   RF,NUMDEMS          RF= # OF DEMOS TO SEND                       
         MHI   RF,L'EDEMLIST                                                    
         LA    R5,ESTDEMOS-1(RF)   R5=A(END OF ORDER DEMOS TO SEND)             
*                                                                               
         DO  JXLE,FROM=(R2),TO=(R5),BY=(R4)                                     
           DOEXIT (OC,0(3,R2),0(R2),Z)  DONE IF NO MORE DEMOS IN EST            
           BRAS RE,CKNONTRD        CHECK NON-TRAD DEMO                          
         ENDDO ,                                                                
*                                                                               
DMOCMNTX J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* IF THE DEMO CATEGORY IS NON-TRAD, THEN PRINT OUT THE COMMENT LINE             
*                                                                               
* ON ENTRY:    (R2)                 BINARY DEMO IN ESTIMATE                     
*              (R6)                 A(DEMO ELEMENT FROM BUY RECORD)             
***********************************************************************         
CKNONTRD NTR1  BASE=*,LABEL=*                                                   
         IF  (CLI,2(R2),EQ,0)       IS THIS A NON-TRAD DEMO?                    
           LA  R3,NDEMNO-NDELEM(R6) YES                                         
           LLC R4,1(R6)                                                         
           AR  R4,R6                R1=A(AFTER DEMO ELEM) BOUNDS                
CKNNTRDLP  DO WHILE=(CR,R3,LT,R4)   WHILE WE'RE IN OUR DEMO ELEMENT             
             IF (CLC,0(L'NDEMNO,R2),EQ,0(R3))  MATCH ON THIS DEMO?              
               LA  R5,PW                                                        
               USING PBUYCOMD,R5                                                
               IF  (CLC,0(L'SPACES,R5),GT,SPACES) ANYTHING TO PRINT?            
                 BRAS RE,PRBLINE                  YES, THEN DO IT               
               ENDIF ,                                                          
               MVC  PBCMTID,=C'BUYCOM'   PREPARE DEMO COMMENT LINE              
               MVC  PBCMORDR,SVQORDER                                           
               MVI  PBCMCONT,C'*'                                               
               MVC  PBCMTEXT(13),=C'COMSCORE DEMO'                              
               MVI  PBCMTEXT+14+L'NTDDMONM,C'='                                 
                                                                                
               MVC  FULL,NDEMRAW-NDEMNO(R3)  GET THE VALUE                      
               NI   FULL,X'FF'-X'C0'  REMOVE OVERRIDE AND 2 DEC BITS            
                                                                                
               IF  (TM,NDEMRAW-NDEMNO(R3),NDEM2DEC,Z)  1 DEC ?                  
                 EDIT (B4,FULL),(9,PBCMTEXT+14+L'NTDDMONM),1,FILL=0             
               ELSE ,                               2 DEC                       
                 EDIT (B4,FULL),(9,PBCMTEXT+14+L'NTDDMONM),2,FILL=0             
               ENDIF ,                                                          
*                                                                               
               LR  R4,R6             FIND DEMO NAME ELEM IN BUY REC             
               DO  UNTIL=(CLI,0(R4),EQ,0)                                       
                 IF (CLI,0(R4),EQ,NTDELCDQ) X'50'-NON-TRAD DEMO NAME            
                   USING NTDELEM,R4                                             
                   LLC  RF,1(R2)   GET NON-TRAD DEMO INDEX                      
                   AHI  RF,-1      REDUCE BY 1 TO GET DISPLACMENT               
                   MHI  RF,L'NTDDMONM+L'NTDDMOFL                                
                   LA   RF,NTDOVHDQ(R4,RF)                                      
                   MVC  PBCMTEXT+14(L'NTDDMONM),0(RF) WE FOUND NAME             
                   ASMLEAVE CKNNTRDLP                 AND WE'RE DONE            
                   DROP R4                                                      
                 ELSE ,                                                         
                   LLC  RF,1(R4)                                                
                   AR   R4,RF                                                   
                 ENDIF ,                                                        
               ENDDO ,                                                          
*                                  IF WE CAN'T FIND THE DEMO NAME THEN          
               MVC  PW(L'SPACES),SPACES  DON'T DISPLAY THIS DEMO VALUE          
               DROP R5                                                          
               ASMLEAVE ,          DONE WITH THIS DEMO CATEGORY                 
             ENDIF ,                                                            
             LA  R3,NDEMLNQ(R3)    BUMP TO NEXT DEMO IN DEMO ELEM               
           ENDDO ,                                                              
         ENDIF ,                                                                
CNNTRDX  J     EXITY                                                            
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* VALIDATE THE DEMO CATEGORIES INPUT TO SAVE TO ORDER                           
* ON ENTRY:    R3                  A(ORDER'S DEMO ELEM)                         
*              I$ORDDEM                                                         
***********************************************************************         
VALDEMOS NTR1  BASE=*,LABEL=*                                                   
         LA    R3,ELEM                                                          
         USING DODEMELD,R3                                                      
         MVC   QCLTX,SVBCLT                                                     
         GOTOR (#GETCLT,AGETCLT)   READ CLIENT RECORD                           
         MVC   SVQPRD,=C'POL'      LOOK FOR THE POL ESTIMATE                    
         BRAS  RE,GTESTINF         AIO7 TO HOLD ESTIMATE                        
*                                                                               
         ICM   R2,15,I$ORDDEM      ANY DEMOS?                                   
         USING LW_D,R2                                                          
         LA    R2,LW_DATA2                                                      
         LLC   R0,DODEMNUM         NUMBER OF DEMOS FROM INPUT                   
*                                                                               
         LA    R3,DODEMOS                                                       
VALDM010 GOTOR VALDCD,DMCB,0(R2),(0,L'ENTRDDMO),0(R3)                           
         JNE   VALDMERR                                                         
         LA    R3,L'DODEMOS(R3)                                                 
         LA    R2,L'ENTRDDMO(R2)                                                
         JCT   R0,VALDM010                                                      
*                                                                               
VALDMOYS J     EXITY                                                            
*                                                                               
VALDMERR LHI   RE,SE#INVDM         INVALID DEMO                                 
         J     EXITN                                                            
         DROP  R2,R3                                                            
         LTORG                                                                  
***********************************************************************         
* VALIDATE THE DEMO FORMAT                                                      
* ON ENTRY : PARM1 = A(INPUT FIELD)                                             
*            PARM2 = L'INPUT FIELD                                              
*            PARM3 = A(OUTPUT FIELD)                                            
*                                                                               
* ON EXIT  : PARM3 = CC IS EQ, OUTPUT IS SET                                    
*                    CC IS NEQ, ERROR HAS BEEN SENT                             
***********************************************************************         
VALDCD   NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R4,0(R1)                                                      
*                                                                               
         CLI   0(R2),C'X'          COMSCORE?                                    
         JE    VLDC020              YES                                         
         CLI   1(R2),C'X'          COMSCORE?                                    
         JE    VLDC020              YES                                         
         LAY   RF,-1(R2,R3)        TREAT INPUT AS TRAD DEMO CATEGORY            
VLDC010  CLI   0(RF),C' '          GET THE LENGTH OF INPUT                      
         JH    *+8                                                              
         JCT   RF,VLDC010                                                       
*                                                                               
         LAY   RE,-1(R2)                                                        
         SR    RF,RE                IF LESS THAN 1                              
         JNP   VLDCNO                SEND ERROR                                 
         CHI   RF,4                 OR GREATER THAN 4                           
         JH    VLDCNO                SEND ERROR                                 
         GOTOR (#VALDCD,AVALDCD),DMCB,(R2),(RF),(R4),0                          
         JNE   VLDCNO                                                           
         J     VLDCYES                                                          
*                                                                               
VLDC020  GOTOR GTNTDEMC,DMCB,(R2),(R4)                                          
         JNE   VLDCNO                                                           
*                                                                               
VLDCYES  J     EXITY                                                            
VLDCNO   J     EXITN                                                            
*============================================                                   
* GET NON-TRADITIONAL INTERNAL DEMO CODE                                        
* ON ENTRY : PARM1 = A(NON-TRADITION DEMO NAME)                                 
*            PARM2 = A(OUTPUT)                                                  
*                                                                               
* ON EXIT  : PARM2 = CC IS EQ, OUTPUT IS SET                                    
*                    CC IS NEQ, ERROR HAS BEEN SENT                             
*============================================                                   
GTNTDEMC NTR1  LABEL=NO                                                         
         L     R2,DMCB                                                          
         L     R4,DMCB+4                                                        
         L     R5,AIO7                                                          
         USING ESTHDR,R5                                                        
*                                                                               
GTNTD010 LA    RE,20              SPOT ONLY HAS 20 MAX ENTRIES                  
         LA    RF,ENONTDMS                                                      
GTNTD020 CLC   0(L'ENONTDMS,RF),0(R2)  FOUND MATCH?                             
         BE    GTNTD030                -YES                                     
         LA    RF,L'ENONTDMS(RF)       -NO, BUMP TO NEXT                        
         BCT   RE,GTNTD020                                                      
         J     EXITN                   IF EOL, EXIT NO                          
GTNTD030 LA    RE,ENONTDMS-L'ENONTDMS                                           
         SR    RF,RE               GET DISPLACEMENT                             
         SRL   RF,3                GET INDEX                                    
         STC   RF,1(R4)                                                         
         DROP  R5                                                               
*                                                                               
         J     EXITY                                                            
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CHECK IF DSTA HAS REP WITH END-OF-CONTRACT                                    
* ON ENTRY : SVQSTA                                                             
*            BINORDER                                                           
*                                                                               
* ON EXIT  :                                                                    
***********************************************************************         
         USING CHKDSEOD,RC                                                      
CHKDSEOC NTR1  BASE=*,LABEL=*,WORK=(RC,CHKDSEOL)                                
*                                                                               
         LR    R0,RC               CLEAR SAVED STORAGE                          
         LHI   R1,CHKDSEOL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         BNO   *+6                 DESTRUCTIVE MOVE?                            
         DCHO                                                                   
*                                                                               
         OC    BINORDER,BINORDER   NEW GHOST ORDER?                             
         BZ    CDE006               YES                                         
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' - SUPP ELEMENT?                        
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                 MUST BE THERE                                
         USING DOSPELD,R4                                                       
         LA    R1,DOSPFSTA                                                      
         OC    DOSPFSTA,DOSPFSTA   HAVE FIRST SEND STATION?                     
         BNZ   CDE004               YES, USE IT                                 
         DROP  R4                                                               
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOIDELQ      X'01' - PRIMARY ID ELEMENT                   
         MVI   ELCDHI,DOIDELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   *+2                 MUST BE THERE                                
         USING DOIDELD,R4                                                       
         LA    R1,DOISTA                                                        
CDE004   BRAS  RE,GETQSTA                                                       
*                                                                               
CDE005   GOTOR GT1EDISD,DMCB,0     GET FIRST SEND DATE                          
         BNE   CDE006                                                           
         GOTOR VDATCON,DMCB,(8,FULL),(0,FSTSDTC)                                
*                                                                               
CDE006   LA    R3,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         USING DSTAKEY,R3                                                       
         MVI   DSTAKEY,DSTAKSYSQ      X'005A'                                   
         MVI   DSTAKTYP,DSTAKTYPQ                                               
         MVC   DSTAKMEDA,SVMED                                                  
         MVC   DSTAKSTIN,SVQSTA                                                 
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGENDIR+IO7'                            
         BNE   CDEYES                                                           
*                                                                               
CDE007   CLC   DSTAKEY(DSTAKEFDA-DSTAKEY),IOKEYSAV  STATION MATCH?              
         BNE   CDEYES                                                           
*                                                                               
         XR    RE,RE                                                            
         ICM   RE,7,DSTAKEFDA                                                   
         JZ    *+2                                                              
         LNR   RE,RE               DSTA DATES ARE NEGATED                       
         STCM  RE,7,FULL                                                        
         GOTO1 VDATCON,DMCB,(3,FULL),(0,EFDATEC)  CONVERT TO CHAR               
*                                                                               
         CLC   EFDATEC,TDYDTCHR    IS 1ST EDI STATION IN EFFECT?                
         BH    CDE008               NO, READ THE NEXT ONE                       
         OC    FSTSDTC,FSTSDTC     HAVE 1ST SEND DATE?                          
         BZ    CDE009              NO, USE LATEST DSTA                          
         CLC   EFDATEC,FSTSDTC     STAT'N EFF'TIVE WHEN ORDER 1ST SENT?         
         BNH   CDE009               YES, USE CURRENT DSTA                       
*                                                                               
CDE008   GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IOGENDIR+IO7'                            
         JE    CDE007               NO, NOT EFFECTIVE YET                       
         DC    H'0'                                                             
*                                                                               
CDE009   GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGENFIL+IO7'                           
         JNE   *+2                                                              
*                                                                               
         L     R3,AIO7                                                          
         LA    R3,DSTAELDQ(R3)     POINT TO FIRST ELEMENT                       
CDE010   CLI   0(R3),0             END OF DSTA RECORD?                          
         BE    CDEYES              YES, REP DOES NOT MATCH                      
         CLI   0(R3),DSTAREPCQ     X'10'-REP INFO ELEMENT?                      
         BE    CDE020                                                           
         USING DSTAREPD,R3                                                      
         LLC   R1,1(R3)                                                         
         LA    R3,0(R3,R1)                                                      
         B     CDE010                                                           
*                                                                               
CDE020   LA    RF,DSTAREPCR                                                     
         OC    DSTAREPED,DSTAREPED HAVE REP EFF DATE?                           
         JZ    CDE030              NO                                           
         CLC   DSTAREPED,JDTTODAY  HAS NEW REP TAKEN EFFECT?                    
         JNH   CDE030              YES                                          
         LA    RF,DSTAREPPR                                                     
CDE030   GOTOR VGETDARE,DMCB,(C'R',0),(RF),AIO8,A(IO8LQ),VDATAMGR               
         JE    CDE040                                                           
         GOTOR PUTERR,DMCB,('SE#SY002',SE#INVRC)                                
         J     EXITN                                                            
*                                                                               
CDE040   L     RE,AIO8                                                          
         USING DAREPTD,RE                                                       
         TM    DAPTFLG2,DPF2EOC    END OF CONTRACT?                             
         JO    CDENO                                                            
CDEYES   J     EXITY                                                            
*                                                                               
CDENO    GOTOR PUTERR,DMCB,('SE#SY023',SE#ONSEO)                                
         J     EXITN                                                            
         DROP  RC,RE                                                            
         LTORG                                                                  
*                                                                               
CHKDSEOD DSECT                                                                  
FSTSDTC  DS    CL6                 FIRST SEND DATE (CHAR)                       
CHKDSEOL EQU   *-CHKDSEOD                                                       
         EJECT                                                                  
SVRDEF   CSECT                                                                  
                                                                                
***********************************************************************         
* UPDATE THE EXTRA RECORD FOR OM DESKTOP                                        
*                                                                               
*  ON ENTRY: DARE RECORD IN AIO1                                                
*                                                                               
***********************************************************************         
UPDEXTRA NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   SVBDSTID,EFFS                                                    
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSTELQ      X'12' STATUS ELEMENT                         
         MVI   ELCDHI,DOSTELQ      X'12' STATUS ELEMENT                         
         BRAS  RE,GETEL                                                         
         USING DOSTELD,R4                                                       
         CLI   DOSTSTAT,DFXRSNT                                                 
         JE    UEX005                                                           
         CLI   DOSTSTAT,DFXSENT                                                 
         JE    UEX005                                                           
         CLI   DOSTSTAT,DEMSENT                                                 
         JE    UEX005                                                           
         CLI   DOSTSTAT,QSNTPNDG   SENT PENDING?                                
         JNE   UEX001                                                           
         DROP  R4                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         MVI   ELCDHI,DOSPELQ      X'03' SUPPLEMENTARY ELEMENT                  
         BRAS  RE,NEXTEL                                                        
         USING DOSPELD,R4                                                       
         CLI   DOSPMTHD,C'F'       SENDING PENDING FAX?                         
         JE    UEX005               YES, SKIP                                   
         DROP  R4                                                               
*                                                                               
UEX001   XC    SVBDSTID,SVBDSTID                                                
         XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY                                                         
         USING CTIKEY,R4                                                        
         MVI   CTIKTYP,CTIKTYPQ                                                 
         MVC   CTIKID,SVDESTID                                                  
         DROP  R4                                                               
*                                                                               
         MVC   IOADDR,AIO8                                                      
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOCTFILE'                                
         JE    UEX002                                                           
         TM    IOERR,IOERNF                                                     
         JNZ   UEX005                                                           
         DC    H'0'                                                             
*                                                                               
UEX002   L     R4,AIO8                                                          
         USING CTIREC,R4                                                        
         LA    R4,CTIDATA                                                       
         MVI   ELCDLO,CTDSCELQ     X'02' LOOK FOR THE DESCRIPTION ELEM          
         MVI   ELCDHI,CTDSCELQ                                                  
         BRAS  RE,NEXTEL                                                        
         MVC   SVBDSTID,2(R4)      SAVE ID NUM                                  
         DROP  R4                                                               
*                                                                               
UEX005   L     R4,AIO3                                                          
         XC    IOKEY,IOKEY                                                      
         MVC   IOKEY(L'DOKEY),0(R4)                                             
         MVI   IOKEY+12,DOKEXTRA   X'05' - UPDATE EXTRA X'05' RECORD            
*                                                                               
         MVI   ELCDLO,DOSTELQ      X'12' GET THE FIRST STATUS                   
         MVI   ELCDHI,DOSTELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOSTELD,R4                                                       
         CLI   DOSTSTAT,DSENT                                                   
         JE    UEX010                                                           
         CLI   DOSTSTAT,DFXSENT                                                 
         JE    UEX010                                                           
         CLI   DOSTSTAT,DFXRSNT                                                 
         JE    UEX010                                                           
         CLI   DOSTSTAT,QRECALL                                                 
         JE    UEX010                                                           
         CLI   DOSTSTAT,QSNTPNDG                                                
         JE    UEX010                                                           
         CLI   DOSTSTAT,QNODARE                                                 
         JNE   UEXX                                                             
UEX010   MVC   DOSTELEM(DOSTLNQ),0(R4)                                          
         DROP  R4                                                               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO5'                               
         JE    UEX015                                                           
         TM    IOERR,IOERNF        RECORD NOT FOUND?                            
         JO    UEX020                                                           
         DC    H'0'                                                             
*                                                                               
UEX015   GOTOR (#IOEXEC,AIOEXEC),'IOGETRUP+IOFIL+IO5'                           
         L     R2,AIO5                       NOTE: EXTRA REC                    
         J     UEX040                                                           
*                                                                               
UEX020   OI    MISCFLG1,MF1RECNF                                                
         L     RE,AIO5                                                          
         LHI   RF,IO5LQ                                                         
         XCEFL                                                                  
                                                                                
         L     R2,AIO5                       NOTE: EXTRA REC                    
         USING DOKEY,R2                                                         
         MVC   DOKEY,IOKEYSAV                                                   
         MVC   DORLEN,=Y(DORFRST-DOKEY)                                         
         MVC   DORAGY,LP_AGY                                                    
         DROP  R2                                                               
*                                                                               
UEX040   LA    R2,DORFRST-DOKEY(R2)                                             
UEX045   CLI   0(R2),0             EOR?                                         
         JE    UEX050                                                           
         CLI   0(R2),DOSTELQ                                                    
         JE    UEX050                                                           
         CLI   0(R2),DOEMXELQ                                                   
         JE    UEX050                                                           
         LLC   R1,1(R2)                                                         
         LA    R2,0(R2,R1)                                                      
         J     UEX045                                                           
*                                                                               
UEX050   L     R4,AIO3                                                          
         MVI   ELCDLO,DOEMXELQ     X'53' EMAIL ELEMENT                          
         MVI   ELCDHI,DOEMXELQ     X'53' EMAIL ELEMENT                          
         BRAS  RE,GETEL                                                         
         JNE   UEX060              ONLY ADD IT IF WE FIND IT                    
         USING DOEMXD,R4                                                        
         SR    R1,R1                                                            
         LLC   R1,DOEMXLEN                                                      
         BCTR  R1,0                                                             
         MVC   ELEM(0),DOEMXD                                                   
         EX    R1,*-6                                                           
EXT      USING DOEMXD,ELEM                                                      
         MVC   EXT.DOEMXDAT,STATDATE DATE                                       
         MVC   EXT.DOEMXTIM,STATTIME TIME                                       
         DROP  EXT,R4                                                           
*                                                                               
         GOTOR ARECUP,DMCB,(C'S',AIO5),ELEM,(R2)                                
*                                                                               
UEX060   LA    R3,DOSTELEM                                                      
         USING DOSTELD,R3                                                       
         MVI   DOSTLEN,DOSTLNQ4                                                 
         XC    DOSTPID(DOSTLNQ4-DOSTLNQ),DOSTPID                                
*                                                                               
         GOTOR VGETFACT,DMCB,0                                                  
         L     R1,0(R1)                                                         
         USING FACTSD,R1                                                        
         MVC   DOSTPID,FAPASSWD                                                 
         DROP  R1                                                               
*                                                                               
         L     R4,AIO3                                                          
         MVI   ELCDLO,DOSPELQ                                                   
         MVI   ELCDHI,DOSPELQ                                                   
         BRAS  RE,GETEL                                                         
         USING DOSPELD,R4                                                       
         MVC   DOSTDEST,DOSPDEST   SAVE DESTINATION                             
         MVC   DOSTMTHD,DOSPMTHD   SAVE METHOD                                  
         MVC   DOSTDID,SVBDSTID    BINARY DEST ID                               
         MVC   DOSTSPTS,DOSPSPTS   SAVE SPOTS                                   
         MVC   DOSTTOTL,DOSPTOTL   SAVE TOTAL DOLLARS                           
         MVC   DOSTREVN,DOSPREVN   SAVE REVISION                                
         MVI   ELCDLO,DOWIGELQ     X'50' WHERE'D IT GO ELEMENT                  
         MVI   ELCDHI,DOWIGELQ                                                  
         BRAS  RE,NEXTEL           DO WE HAVE A FAX?                            
         JNE   *+10                NO                                           
         USING DOWIGELD,R4                                                      
         MVC   DOSTFXN,DOWIGFXN    SAVE FAX                                     
         DROP  R4                                                               
*                                                                               
         GOTOR ARECUP,DMCB,(C'S',AIO5),DOSTELEM,(R2)                            
*                                                                               
         ICM   RE,15,I$GAPTKN      DID WE GET A GAP TOKEN?                      
         JZ    UEX070                                                           
         GOTOR VHELLO,DMCB,(C'D',=C'SPTFIL'),('DOEGTELQ',AIO5),0,0              
*                                                                               
         L     R2,AIO5                       NOTE: EXTRA REC                    
         LA    R2,DORFRST-DOKEY(R2)                                             
*                                                                               
         LA    R3,ELEM                                                          
         USING DOEGTKND,R3                                                      
         MVI   DOEGTEL,DOEGTELQ                                                 
         MVC   DOEGTDAT,STATDATE                                                
         MVC   DOEGTTIM,STATTIME                                                
*                                                                               
         ICM   RE,15,I$GAPTKN      DID WE GET A GAP TOKEN?                      
         USING LW_D,RE                                                          
         LH    RF,LW_LN            LENGTH OF ENTRY + L'FLDHDR                   
         AHI   RF,-(LW_LN1Q+1)     -(L'FLDHDR + 1 FOR EX)                       
         JNP   *+2                 DID WE REALLY GET A GAP TOKEN?               
*                                                                               
         MVC   DOETOKEN(0),LW_DATA1   MOVE IN GAP TOKEN                         
         EX    RF,*-6                                                           
         AHI   RF,DOEGTOVR+1       + DOEGTOVR OVERHEAD + 1 FOR EX B4            
         STC   RF,DOEGTLEN         UPDATE ELEM LENGTH                           
         DROP  RE,R3                                                            
*                                                                               
         GOTOR ARECUP,DMCB,(C'S',AIO5),ELEM,(R2)                                
*                                                                               
UEX070   TM    MISCFLG1,MF1RECNF   ADDING OR PUTTING?                           
         JNZ   UEXADD              ADDING                                       
UEXPUT   GOTOR (#IOEXEC,AIOEXEC),'IOPUT+IOFIL+IO5'                              
         J     UEXX                                                             
*                                                                               
UEXADD   GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOFIL+IO5'                           
         NI    MISCFLG1,X'FF'-MF1RECNF                                          
*                                                                               
UEXX     J     EXITY                                                            
         LTORG                                                                  
         EJECT                                                                  
GTMOOFTB BASR  R1,RE               GET MEDIAOCEAN OFFICE TABLE                  
       ++INCLUDE DDMOREPTAB                                                     
GTMKTTAB BASR  R3,RE                                                            
       ++INCLUDE SPDARNSI                                                       
*                                                                               
SAVED    DSECT                                                                  
WVALUES  DS    0X                                                               
ADCONS   DS    0A                  ** RELOCATED ADDRESS CONSTANTS **            
AFLTBKY  DS    A                   A(BUY KEY FILTER ROUTINE)                    
AFLTBRD  DS    A                   A(BUY RECORD FILTER ROUTINE)                 
VSPOMCOM DS    V                   V(SPOMCOM)                                   
ADCONSN  EQU   (*-ADCONS)/L'ADCONS                                              
*                                                                               
RANGE10F DS    XL2                 X'00FF'                                      
EZEROS   DS    8C                  C'00000000'                                  
V320060  DS    XL4                 PC VERSION 3.2.0.60                          
V460050  DS    XL4                 PC VERSION 4.6.0.50                          
V4600156 DS    XL4                 PC VERSION 4.6.0.156                         
V470037  DS    XL4                 PC VERSION 4.7.0.37                          
XSPREC   DS    AL2,AL2,AL2,AL4     AL2(42,32,5970),AL4(0)                       
WVALUESL EQU   *-WVALUES                                                        
*                                                                               
AIOLIST  DS    XL20                10H'0'                                       
*                                                                               
BINPARMS DS    6F                  BINSRCH PARAMETERS                           
*                                                                               
ALIOB    DS    A                   A(ALIOB)                                     
ALINKIO  DS    A                   A(LINKIO)                                    
ARECUP   DS    A                   A(ARECUP)                                    
ABUFFRIN DS    A                   A(BUFFERIN)                                  
AMINBUFF DS    A                   A(MINIO BUFFER)                              
AMINDISP DS    F                   A(DISPLACEMENT INTO MINIO BUFFER)            
RECADDR  DS    A                   A(RECORD HANDLING ROUTINE)                   
*                                                                               
DATADISP DS    H                                                                
ELCDLO   DS    X                                                                
ELCDHI   DS    X                                                                
*                                                                               
XTRATEXT DS    CL20                EXTRA ERROR MESSAGE TEXT                     
*                                                                               
FAKEFLDH DS    CL8                 FAKE FIELD HEADER AND FIELD DATA             
FAKEFLD  DS    CL64                                                             
*                                                                               
PACKOF4B DS    PL4                 PACKED OF 4 BYTES                            
AGYDOLRS DS    PL6                 NUMBER OF DOLLARS                            
TOTCOST  DS    PL6                 TOTAL DOLLARS                                
TOTTAX   DS    PL6                 TOTAL TAX                                    
JDTTODAY DS    PL4                 TODAY'S DATE (0CYYDDDF)                      
ORDRDATE DS    XL3                 ORDER'S DATE (PWOS JULIAN DATE)              
*                                                                               
MEDIA    DS    CL1                                                              
AGENCY   DS    CL2                                                              
MKTRNGE  DS    CL8                                                              
*                                                                               
DOSTELEM DS    XL(DOSTLNQ4)                                                     
DOXMELEM DS    XL(DOXMTLNQ)                                                     
*                                                                               
SVBORGID DS    XL2                 BINARY SIGN ON USERID                        
SVORIGID DS    CL10                SIGN ON USER ID                              
SVBDSTID DS    XL2                 BINARY DESTINATION ID                        
SVDESTID DS    CL(L'PAHDTOID)      DESTINATION ID                               
SVREPCOD DS    XL3                 SAVE 3-CHAR REP CODE                         
SVDRROUT DS    CL5                 DARE ROUTING CODE                            
BUYLN    DS    XL2                                                              
PCKEYORD DS    CL12                PC KEY FOR ORDERS                            
*                                                                               
         DS    0F                                                               
DISKADDR DS    0AL4                                                             
ORD1ADDR DS    0A                  A(ORDER RECORD)                              
NOTCADDR DS    A                   A(MG NOTICE RECORD)                          
ORD2ADDR DS    0A                  A(ORDER AGENCY COMMENT RECORD)               
OFF1ADDR DS    A                   A(MG OFFER RECORD)                           
OFF2ADDR DS    A                   A(MG OFFER COMMENT RECORD)                   
*                                                                               
AGYNSPTS DS    F                   NUMBER OF SPOTS                              
TOTSPOT  DS    F                   NUMBER OF SPOTS                              
AGYNMRCS DS    F                   NUMBER OF RECORDS PRINTED                    
*                                                                               
* EDI ROUTINE VALUES                                                            
*                                                                               
EDIVALS  DS    0X                  EDI'ING DATA                                 
EDIDATC  DS    CL6                 FIRST EDI SEND DATE (CHAR)                   
EFDATEC  DS    CL6                 DSTATION EFFECTIVE DATE (CHAR)               
*                                                                               
PERVALST DS    XL(L'PVALOUTB)      PERVAL STORAGE AREA                          
BUYLINS  DS    XL125               WHAT BUYLINES DARE ORDER USED                
BINSREC  DS    XL(BSRCRLEN)        BINSRCH RECORD                               
CURRDATE DS    CL6                 BUY START DATE                               
*                                                                               
GOALPRD  DS    XL1                 GOAL PRODUCT 1                               
GOALPR2  DS    XL1                 GOAL PIGGYBACK                               
*                                                                               
SVBDCOST DS    XL4                 SAVED BUY COST                               
SVBDNOWK DS    XL1                 SAVED BUY NUMBER OF WEEKS                    
SVCSLIC  DS    CL32                                                             
EDIVALEN EQU   *-EDIVALS                                                        
*                                                                               
* END OF EDI VALUES                                                             
*                                                                               
*                                                                               
* FAX ROUTINE VALUES                                                            
*                                                                               
         ORG   EDIVALS                                                          
FAXVALS  DS    0X                  FAXING VALUES                                
PASS     DS    XL1                                                              
MAXPASS  DS    XL1                                                              
MIDPASS  DS    XL1                                                              
PASSTAB  DS    XL96                                                             
SVXSPKEY DS    XL32                                                             
PASSACT  DS    C                                                                
EXCLTAX  DS    C                                                                
*                                                                               
TODAYB   DS    XL3                                                              
SVPOL    DS    C                                                                
SVDEMNMS DS    4CL6                                                             
SVQSTART DS    CL6                                                              
SVQEND   DS    CL6                                                              
SVQSTP   DS    XL2                                                              
SVQENDP  DS    XL2                                                              
SVQSTB   DS    XL3                                                              
SVQENDB  DS    XL3                                                              
*                                                                               
SHOWCHGS DS    C                                                                
COPYTYPE DS    X                   CURRENT OUTPUT TYPE Q=PQ,X=FAX               
*                                                                               
BPERST   DS    XL2                                                              
BPEREND  DS    XL2                                                              
*                                                                               
ANYHIST  DS    C                                                                
ANYFLAG1 DS    X                   FLAGS FOR TESTING ANY                        
AF1SPOTS EQU   X'80'               - SPOTS                                      
AF1NTRDM EQU   X'40'               - NON-TRAD DEMOS                             
AF1HTBL  EQU   X'20'               - HAS TWO BYTE BUYLINE                       
*                                                                               
ANYCHANG DS    C                                                                
EQUDEMS  DS    0XL16                                                            
EQUDEM1  DS    F                                                                
EQUDEM2  DS    F                                                                
EQUDEM3  DS    F                                                                
EQUDEM4  DS    F                                                                
*                                                                               
         DS    0D                                                               
MYSPTS   DS    XL53                53                                           
         DS    0D                                                               
MYDOLS   DS    XL212               4BYTES/WEEK (53*4)                           
         DS    0D                                                               
MYTAX    DS    XL212               4BYTES/WEEK (53*4)                           
*                                                                               
SVREVDAT DS    0XL4                SAVED REVISION NUMBERS AND SENT DATE         
SVCURREV DS    XL1                 SAVED CURRENT REVISION NUMBER                
SVPREREV DS    XL1                 SAVED PREVIOUS REVISIN NUMBER                
SVPRVDAT DS    XL2                 SAVED PREVIOUS DATE OF LAST SEND             
*                                                                               
SAVSYSID DS    CL2                 SYSTEM ID                                    
SAVAGYMD DS    CL2                 EBCDIC AGENCY/MEDIA                          
*                                                                               
WEEKDSPL DS    H                   DISP TO FIRST WEEK ENTRY THIS PERIOD         
SPTDSPL  DS    H                   DISP TO FIRST SPOT ENTRY THIS PERIOD         
DOLDSPL  DS    H                   DISP TO FIRST DOL ENTRY THHIS PERIOD         
NUMWEEKS DS    H                   NUMBER OF WEEKS IN CURRENT PERIOD            
         DS    0D                                                               
WEEKTAB  DS    XL224               4 BYTES/WEEK + EOF                           
         DS    0D                                                               
WEEKSPTS DS    XL28                14X2 BYTE ACCUMS                             
WEEKDOLS DS    XL56                14X4 BYTE ACCUMS                             
         DS    0D                                                               
RPTTOTS  DS    0XL44                                                            
RPTSPOTS DS    F                                                                
RPTDOLS  DS    F                                                                
RPTTAX   DS    F                                                                
RPTDEMS  DS    0XL32                                                            
RPTDEM1  DS    F                                                                
RPTDEQ1  DS    F                                                                
RPTDEM2  DS    F                                                                
RPTDEQ2  DS    F                                                                
RPTDEM3  DS    F                                                                
RPTDEQ3  DS    F                                                                
RPTDEM4  DS    F                                                                
RPTDEQ4  DS    F                                                                
         DS    0D                                                               
PASSTOTS DS    0XL44                                                            
PASSSPTS DS    F                                                                
PASSDOLS DS    F                                                                
PASSTAX  DS    F                                                                
PASSDEMS DS    0XL32                                                            
PASSDEM1 DS    F                                                                
PASSDEQ1 DS    F                                                                
PASSDEM2 DS    F                                                                
PASSDEQ2 DS    F                                                                
PASSDEM3 DS    F                                                                
PASSDEQ3 DS    F                                                                
PASSDEM4 DS    F                                                                
PASSDEQ4 DS    F                                                                
*                                                                               
BUYSPTS  DS    F                                                                
BUYDOLS  DS    F                                                                
BUYTAX   DS    F                                                                
MYBUYSPT DS    F                                                                
*                                                                               
         DS    0D                                                               
COVTAB   DS    8XL56               COV(3)+WKS(53) X MAX 8 COST OVRDS            
COVTABX  EQU   *                                                                
*                                                                               
         DS    0D                                                               
EQVREC   DS    XL256                                                            
*                                                                               
*******  END OF FAXVALS                                                         
*                                                                               
SVBUYKEY DS    0XL10                                                            
SBKAGM   DS    XL1                 MEDIA                                        
SBKCLT   DS    XL2                 CLIENT                                       
SBKPRD   DS    XL1                 PRODUCT                                      
SBKMSTA  DS    0XL5                MARKET/STATION                               
SBKMKT   DS    XL2                 MARKET                                       
SBKSTAC  DS    XL3                 STATION                                      
SBKEST   DS    XL1                 ESTIMATE                                     
LINENUM  DS    X                                                                
*                                                                               
MYRATE   DS    0F                                                               
SPOTS    DS    F                                                                
GROSS    DS    F                                                                
NET      DS    F                                                                
TAX      DS    F                                                                
*                                                                               
TDYDTCHR DS    CL6                 TODAYS DATE (CHAR)                           
NUMDEMS  DS    H                   NUMBER OF DEMOS TO PRINT                     
SAVE1OR2 DS    X                                                                
*                                                                               
MISCFLG1 DS    X                   MISCELLANEOUS FLAGS 1                        
MF1RECNF EQU   X'80'               - RECORD NOT FOUND                           
MF1SPAR1 EQU   X'40'               - ** SPARE **                                
MF1CHGDS EQU   X'20'               - DEST/METH HAS CHANGED                      
MF1DEMDF EQU   X'10'               - RETURN DEMOS TO DEFAULT VALUES             
MF1SPARE EQU   X'08'               - SPARE                                      
MF1CSHCD EQU   X'04'               - WE HAVE A CASH CONDITION                   
MF1TRDCD EQU   X'02'               - WE HAVE A TRADE CONDITION                  
MF1DRREV EQU   X'01'               - WE ARE DOING A DARE REVISION               
*                                                                               
MISCFLG2 DS    X                   MISCELLANEOUS FLAGS 2                        
MF2PUTDA EQU   X'80'               - HAVE PUT A DA DOWNLOAD REQUEST             
MF2NTDAR EQU   X'40'               - ORDER HAS BEEN NOTDARED                    
MF2ADDEL EQU   X'20'               - ADD THE ELEMENT, USER CHANGED IT           
MF2NODST EQU   X'10'               - NO DSTA RECORD                             
MF2BRDAC EQU   X'08'               - BUYER CODE HAS BEEN DEACTIVATED            
MF2VIDEA EQU   X'01'               - WE HAVE A VIDEA EDI                        
*                                                                               
CURRFLAG DS    X                   CURRENT REQ ERROR FLAGS                      
CRFERROR EQU   X'80'               - PENDING IOS                                
*                                                                               
PREVFLAG DS    X                   PREVIOUS REQ ERROR FLAGS                     
PRFERROR EQU   X'80'               - PENDING IOS                                
*                                                                               
FLTRCFLG DS    X                                                                
FRFEXIST EQU   X'80'               - FLIGHT RECORD EXISTS FOR ESTIMATE          
FRFINVFL EQU   X'40'               - INVALID FLIGHT                             
*                                                                               
CLTNAME  DS    CL(L'CNAME)         CLIENT NAME                                  
CLTBPOL  DS    X                   CLIENT IS BRAND/POOL                         
CLTFLAG1 DS    XL1                                                              
CLTTRADE EQU   X'80'               THIS IS A TRADE CLIENT                       
SVACCAGY DS    CL2                                                              
SVACCOFC DS    CL2                                                              
SVCLTOFF DS    CL1                                                              
ESTFLAG1 DS    XL1                 ESTIMATE FLAG SET 1                          
ESTDAILY EQU   X'80'                - DAILY SCHEDULE                            
ESTTRADE EQU   X'40'                - TRADE ESTIMATE                            
ESTSDE   EQU   X'20'                - SUPERDESK AUTHORIZATION OPEN              
PR1TIMSH DS    XL1                 PRODUCT 1 TIME SHARE, 0 - USE BDTIME         
*                                                                               
COMPDATE DS    XL2                 TODAY'S DATE COMPRESSED FORMAT               
DWNLDRSP DS    C                   DOWNLOAD ORDER RESPONSE?                     
*                                                                               
BINORDER DS    0XL(L'DOKORDER)     BINARY ORDER NUMBER                          
BINORDDT DS    XL2                                                              
BINORDSQ DS    XL2                                                              
MKGRPCOD DS    CL(L'MNKGROUP)      CHAR MAKEGOOD GROUP CODE                     
*                                                                               
OMKEYLN  EQU   *-BINORDER                                                       
         ORG   BINORDER                                                         
CURRKEY  DS    XL(OMKEYLN)                                                      
PREVKEY  DS    XL(OMKEYLN)                                                      
MKBSTA   DS    XL(L'DCKSTA)                                                     
*                                                                               
SVBAGM   DS    X                                                                
SVBCLT   DS    XL(L'DCKCLT)        BINARY CLIENT CODE                           
SVBPRD   DS    XL(L'DCKPRD)                                                     
SVBEST   DS    XL(L'DCKEST)                                                     
SVBSTA   DS    XL(L'DCKSTA)                                                     
SVBPR2   DS    XL(L'DCKPRD2)                                                    
SVBFLT   DS    XL(L'DCKFLTNM)                                                   
SVFLAG1  DS    XL1                 FLAG BITS                                    
SF1TRADE EQU   X'80'               TRADE ORDER ONLY                             
SVBVALS  EQU   *-SVBAGM            L(SAVED BINARY VALUES)                       
*                                                                               
SVQORDER DS    CL8                 CHAR ORDER NUMBER                            
SVMED    DS    C                   MEDIA CODE                                   
SVQBYR   DS    XL(L'DBKBYR)        CHAR BUYER CODE                              
SVRBYR   DS    XL2                 RCPACKED BUYER CODE                          
SVQCLT   DS    XL(L'QCLTA)         CHAR CLIENT CODE                             
SVQPRD   DS    CL3                 CHAR PRODUCT CODE                            
PRDNM    DS    CL20                PRODUCT NAME                                 
SVQPR2   DS    CL3                 CHAR PRODUCT 2 CODE                          
PR2NM    DS    CL20                PRODUCT NAME                                 
SVQEST   DS    CL3                 CHAR ESTIMATE CODE                           
SVQSTA   DS    CL(L'STAPQSTA)                                                   
SVSTAEDT DS    CL(L'STAPQSTA+L'STAPQNET+1)                                      
SVNETWRK DS    CL4                 NIELSEN 4 CHAR NETWORK                       
SVAFFL   DS    CL3                                                              
SVTSRHIS DS    CL(BUYHKEYL)                                                     
*                                                                               
PRQMAPN  DS    XL2                 PREVIOUS QMAPN                               
PRBAGM   DS    XL1                          BINARY AGY/MED                      
PRBCLT   DS    XL2                          BINARY CLT                          
PRBPRD   DS    XL1                          BINARY PRD                          
PRBEST   DS    XL1                          BINARY EST                          
PRBMKT   DS    XL2                          BINARY MARKET                       
*                                                                               
CLTNM    DS    CL20                CLIENT NAME                                  
GOLSTDT  DS    XL2                 GOAL START DATE FOR THE MARKET               
GOLNDDT  DS    XL2                 GOAL END   DATE FOR THE MARKET               
MKTORDST DS    CL15                MARKET ORDER STATUS                          
*                                                                               
DARECONT DS    CL8                 CONTRACT NUMBER                              
SVQMKT   DS    CL4                 CHAR MARKET                                  
MKTNM    DS    CL24                MARKET NAME                                  
SVBMKT   DS    XL2                 BINARY MARKET                                
SVDEST   DS    C                   DESTINATION                                  
SVMTHD   DS    C                   METHOD                                       
SVFLTSDT DS    XL3                 SAVED FLIGHT START DATE                      
SVFLTEDT DS    XL3                              END   DATE                      
SVAIRDAT DS    XL2                 SAVED FIRST AIR DATE                         
SVXMIT   DS    C                   SEND/RECALL/NOTDARE                          
SVRESEND DS    C                   FAX RESEND FLAG                              
ESTNM    DS    CL20                SAVED ESTIMATE NAME                          
ESTDYMNU DS    XL1                 DAYPART MENU NUMBER                          
ESTSTRT  DS    CL6                 START DATE (YYMMDD)                          
ESTEND   DS    CL6                 END DATE   (YYMMDD)                          
ESTBOOK  DS    XL2                 RATING BOOK                                  
ESTDEMOS DS    XL(L'EDEMLIS1*EDEMLS1N) SAVE EST DEMOS                           
ESTUSNMS DS    CL(L'EUSRNML*EUSRNMN)   SAVE EST USER DEMO NAMES                 
ESTNTDEM DS    CL(L'ENONTDMS*20)       SAVE EST NON-TRAD DEMO NAMES             
SVEDAILY DS    XL1                                                              
SVOOWROT DS    XL1                 SAVED OUT OF WEEK ROTATOR START DAY          
SALESPER DS    XL(L'DOIDSPER)      SAVED SALESEPERSON                           
REPALPH1 DS    CL2                 SAVED REP ALPHA CODE                         
REPALPHA DS    CL2                 SAVED REP ALPHA CODE                         
REPOFFCD DS    CL2                 SAVED REP OFFICE CODE                        
SALESCOD DS    CL3                 SAVED SALESPERSON CODE                       
REPPREFX DS    0CL10               SAVED REP USERID PREFIX                      
REPHUBAD DS    CL10                RADIO/SBS REP HUB ADDRESS                    
*                                                                               
* MAKEGOOD DATA                                                                 
*                                                                               
OFFRECNM DS    0XL2                                                             
SVOFFNUM DS    X                                                                
SVRECNUM DS    X                                                                
*                                                                               
* PROFILE INFORMATION                                                           
*                                                                               
PROFFLG1 DS    X                                                                
PF1READ  EQU   X'80'               PROFILES HAVE BEEN READ                      
*                                                                               
PROFDAR  DS    CL16                DARE PROFILE                                 
PDARDEMS EQU   PROFDAR+1             INCLUDE DEMOS IN ORDER? (N,Y,1-4)          
PDARBCOM EQU   PROFDAR+2             INCLUDE BUY COMMENTS IN ORDER?             
PDARTSRP EQU   PROFDAR+6   3 BYTES   TRADE SPECIAL REP DIGITS                   
PDARPORN EQU   PROFDAR+9             REQUIRES PREV/NEW?                         
PDAR0TRD EQU   PROFDAR+12            TRADE ORDER $0 COST                        
PDARMTRD EQU   PROFDAR+14            MULTIPLE TRADE CODES                       
PDAROROM EQU   PROFDAR+15            USES ORDER MANAGER? (FROM OM PROF)         
*                                                                               
PROFOM   DS    CL16                OM PROFILE                                   
POMUSEOM EQU   PROFOM               - USES ORDER MANAGER?                       
POMUSENW EQU   PROFOM+1             - USES NEW ORDER #'S?                       
POMAUCFM EQU   PROFOM+2             - PARITAL CONFIRM WORKFLOW                  
POMFXRAD EQU   PROFOM+3             - FAX RADIO ALL RADIO ORDERS?               
POMMGREP EQU   PROFOM+15            - CREATE MKGD TRANSACTION REPORT?           
*                                                                               
PROFDX   DS    CL16                DX PROFILE                                   
PDXNEWPG EQU   PROFDX+1            TEST NEW PAGE BY NETWORK                     
PDXDEMOV EQU   PROFDX+3            FLAG DEMO OVERRIDES                          
PDXCPP   EQU   PROFDX+4            PRINT CPP                                    
PDXCOSTS EQU   PROFDX+5            PRINT COSTS                                  
PDXTOPQ  EQU   PROFDX+6            PUT A COPY OF FAX TO PRTQUE                  
PDXSTYR  EQU   PROFDX+7            NEW FAX START YEAR (200X)                    
PDXSTMON EQU   PROFDX+8            NEW FAX START MONTH                          
PDXSTDAY EQU   PROFDX+9            NEW FAX START DAY                            
*                                                                               
PROFD2   DS    CL16                D2,PROFILE                                   
PD2COMCT EQU   PROFD2+4            COMMENT CONTROL                              
*                                                                               
PROFS00  DS    CL16                                                             
P00XCLTX EQU   PROFS00+12          EXCLUDE TAX ON MEDIA REPORTS                 
*                                                                               
DLDDMOS  DS    X                                                                
DLDORST  DS    X                   DOWNLOAD MARKET ORDER STATUS                 
*                                                                               
TOOMANY  DS    C                                                                
DRCSHTRD DS    X                                                                
*                                                                               
SVTSRNUM DS    XL(L'TSRNUM)                                                     
SVTSRNM2 DS    XL(L'TSRNUM)                                                     
SVTSRNM3 DS    XL(L'TSRNUM)                                                     
TSARBLK  DS    XL(TSARDL)          TSAR BLOCK FOR ORDERS                        
*                                                                               
         DS    0D                                                               
TSARREC  DS    XL(BUYHRECL)                                                     
TSARSAV  DS    XL(BUYHRECL)                                                     
*                                                                               
*  FIELD INDEX ADDRESSES                                                        
I$BAGM   DS    A                   A(BINARY AGENCY/MEDIA)                       
I$BINORD DS    A                   A(BINARY ORDER NUMBER)                       
I$GRPCD  DS    A                   A(CHAR MAKEGOOD GROUP CODE)                  
I$BYR    DS    A                   A(CHARACTER BUYER CODE)                      
I$BCLT   DS    A                   A(CLIENT)                                    
I$BPRD   DS    A                   A(PRODUCT)                                   
I$BEST   DS    A                   A(BINARY ESTIMATE)                           
I$BSTA   DS    A                   A(BINARY STATION)                            
I$BPRD2  DS    A                   A(PIGGY)                                     
I$BFLT   DS    A                   A(BINARY FLIGHT)                             
*                                                                               
I$STN    DS    0A                  A(STATION)                                   
STTNIND  DS    AL1                                                              
ASTATN   DS    AL3                                                              
*                                                                               
I$FLAG   DS    A                   A(FLAG BITS)                                 
I$PCKEY  DS    A                   A(PCKEY)                                     
*                                                                               
I$OFFNUM DS    A                   A(OFFER NUMBER)                              
I$RECNUM DS    A                   A(RECORD NUMBER)                             
I$HIDOFF DS    A                   A(HIDE OFFER FLAG)                           
*                                                                               
OFFERREC DS    0A                                                               
I$DAYPRT DS    A                   A(DAYPART CODE)                              
I$PRGNAM DS    A                   A(PROGRAM NAME)                              
I$PURPCD DS    A                   A(PURPOSE CODE)                              
I$REASCD DS    A                   A(REASON CODE)                               
I$UPGFRM DS    A                   A(UPGRADE FORMULA)                           
I$DEMDFT DS    A                   A(DEFAULT DEMOS)                             
I$OFFDEM DS    A                   A(OFFER DEMOS)                               
I$ORBITS DS    A                   A(ORBITS)                                    
NWMOMBS  DS    0A                                                               
I$ADJCOD DS    A                   A(ADJACENCY CODE)                            
I$COST2  DS    A                   A(COST2)                                     
I$REPCOD DS    A                   A(REP CODE)                                  
I$MGBOOK DS    A                   A(BOOK)                                      
I$MGBKTY DS    A                   A(BOOKTYPE)                                  
NWMOMBLN EQU   *-NWMOMBS                                                        
OFFERRCL EQU   *-OFFERREC                                                       
*                                                                               
         ORG   I$OFFNUM                                                         
STATTYPE DS    C                                                                
STATFLAG DS    C                                                                
STFGCANC EQU   C'C'                CANCEL SEND                                  
STFGRSND EQU   C'R'                RESEND SEND                                  
*                                                                               
STATDATE DS    XL3                                                              
STATTIME DS    XL2                                                              
GAPSEQ#  DS    XL(L'DOSPGAP#)                                                   
*                                                                               
I$BUYDA  DS    0A                  A(STATION)                                   
BUYIND   DS    AL2                                                              
ABUYDA   DS    AL3                                                              
         ORG   I$OFFNUM                                                         
ORDERREC DS    0A                                                               
I$HIDORD DS    A                   A(HIDE ORDER FLAG)                           
I$SALESP DS    A                   A(SALESPERSON)                               
I$PPFLAG DS    A                   A(POINTPERSON FLAG)                          
I$SALESC DS    A                   A(SALESPERSON CODE)                          
I$REPALP DS    A                   A(REP ALPHA CODE)                            
*                                                                               
*                                                                               
I$DEST   DS    A                   A(DESTINATION)                               
I$METH   DS    A                   A(METHOD)                                    
NWDWG    DS    0A                                                               
I$FAX#   DS    A                   A(FAX NUMBER)                                
I$REPPFX DS    A                   A(REP USERIDE PREFIX)                        
I$REPOFF DS    A                   A(REP OFFICE)                                
NWDWGLN  EQU   *-NWDWG                                                          
I$EMAILS DS    A                   A(EMAIL ADDY'S)                              
*                                                                               
STDCOMS  DS    0XL12                                                            
I$STDCM1 DS    A                   A(STANDARD COMMENTS 1)                       
I$STDCM2 DS    A                   A(STANDARD COMMENTS 2)                       
I$STDCM3 DS    A                   A(STANDARD COMMENTS 3)                       
STDCOMLN EQU   *-I$STDCM1                                                       
*                                                                               
I$INCDM  DS    A                   A(INCLUDE DEMOS)                             
I$ORDDEM DS    A                   A(ORDER DEMOS)                               
I$PRVNEW DS    A                   A(PREVIOUS/NEW)                              
I$XMIT   DS    A                   A(TRANSMIT FLAG)                             
I$RESEND DS    A                   A(FAX RESEND)                                
ORDRECLN EQU   *-ORDERREC                                                       
*                                                                               
I$COM1   DS    A                   A(COMMENTS 1)                                
I$COM2   DS    A                   A(COMMENTS 2)                                
I$COM3   DS    A                   A(COMMENTS 3)                                
I$COM4   DS    A                   A(COMMENTS 4)                                
I$COM5   DS    A                   A(COMMENTS 5)                                
OFFCOMLN EQU   *-I$COM1                                                         
I$COM6   DS    A                   A(COMMENTS 6)                                
I$COM7   DS    A                   A(COMMENTS 7)                                
I$COM8   DS    A                   A(COMMENTS 8)                                
ORDCOMLN EQU   *-I$COM1                                                         
*                                                                               
I$GAPTKN DS    A                   A(GAP TOKEN)                                 
*                                                                               
I$MKTS   DS    0A                   A(MARKETS)                                  
MKTIND   DS    AL2                                                              
AMKTDA   DS    AL3                                                              
*                                                                               
ESTUDEMO DS    CL(L'EUSRNML)       HOLDS TEXT OF USER DEMO                      
*                                                                               
ORDCKS   DS    F                   ORDER RECORD CHECK SUM                       
OR2CKS   DS    F                   ORDER AGENCY COMMENT CHECK SUM               
NOTCKS   DS    F                   NOTICE RECORD CHECK SUM                      
OFFCKS   DS    F                   OFFER RECORD CHECK SUM                       
OF2CKS   DS    F                   OFFER RECORD2 CHECK SUM                      
*                                                                               
CKSMTAB  DS    0XL4                ** TABLE OF ORDERS CHECKED **                
CKSMTABQ EQU   256                                                              
         DS    (CKSMTABQ)XL4                                                    
*                                                                               
         ORG   EQVREC                                                           
       ++INCLUDE SPGENEQU                                                       
         ORG                                                                    
MYWORK   DS    XL(MYWORKL)         FAREPORT WORK AREA                           
SAVEL    EQU   *-SAVED                                                          
*                                                                               
* INCLUDED DSECTS                                                               
         PRINT OFF                                                              
       ++INCLUDE SPLNKWRK                                                       
         PRINT ON                                                               
WORKD    DSECT                     ** REDEFINE OVERWORK **                      
         ORG   TEMP1                                                            
TEMP12   DS    XL(L'TEMP1+L'TEMP2)                                              
*                                                                               
         ORG   OVERWORK                                                         
*                                                                               
MYWORKD  DSECT                                                                  
*                                                                               
       ++INCLUDE FAREPBLK                                                       
PW       DS    CL198              WIDE PWE                                      
PW2      DS    CL198                                                            
PW3      DS    CL198                                                            
         ORG   PW                                                               
H1       DS    CL132                                                            
H2       DS    CL132                                                            
H3       DS    CL132                                                            
H4       DS    CL132                                                            
H5       DS    CL132                                                            
H6       DS    CL132                                                            
H7       DS    CL132                                                            
H8       DS    CL132                                                            
H9       DS    CL132                                                            
H10      DS    CL132                                                            
H11      DS    CL132                                                            
H12      DS    CL132                                                            
H13      DS    CL132                                                            
HNUM     EQU   (*-H1)/L'H1                                                      
M1       DS    CL132                                                            
M2       DS    CL132                                                            
M3       DS    CL132                                                            
MNUM     EQU   (*-M1)/L'M1                                                      
P1       DS    CL132                                                            
P2       DS    CL132                                                            
P3       DS    CL132                                                            
P4       DS    CL132                                                            
PNUM     EQU   (*-P1)/L'P1                                                      
*                                                                               
SVMID2   DS    CL132                                                            
SVMID3   DS    CL132                                                            
*                                                                               
         ORG   P1                                                               
SKBUYLIN DS    CL7                                                              
         DS    CL1                                                              
SKDAYS   DS    CL7                                                              
         DS    CL4                                                              
SKTIME   DS    CL11                                                             
         DS    CL5                                                              
SKGRID   DS    14CL4                                                            
         DS    CL2                                                              
SKTOTSP  DS    CL4                                                              
         DS    CL1                                                              
SKCOST   DS    CL9                                                              
         DS    CL2                                                              
SKDEMS   DS    CL21                                                             
         ORG   P2                                                               
         DS    CL6                                                              
SKPROG   DS    CL17                                                             
         DS    CL4                                                              
SKSLN    DS    CL3                                                              
*                                                                               
SKORB    EQU   P1+6                                                             
* AREA BELOW USED TO SAVE ORDER HISTORY ELEMENTS                                
         ORG                                                                    
SSAGENT  DS    CL47                                                             
SVEL05   DS    XL128                                                            
SVEL06   DS    XL64                                                             
SVEL08   DS    8XL64                                                            
SVEL08X  EQU   *                                                                
SVEL09   DS    XL128               TAX                                          
*                                                                               
MYWORKL  EQU   *-MYWORKD                                                        
*                                                                               
         PRINT OFF                                                              
       ++INCLUDE SPMSGEQUS                                                      
LIOBD    DSECT                                                                  
       ++INCLUDE DDLINKIOD                                                      
       ++INCLUDE SPGENDRORD                                                     
       ++INCLUDE SPGENDRMKN                                                     
       ++INCLUDE SPGENDRMKO                                                     
MOMBSELD DSECT                                                                  
         ORG   MOMBSADJ                                                         
MOMBSUP  DS    XL(MOMBSLNQ-(L'MOMBSEL+L'MOMBSLEN))                              
*                                                                               
MODMELD  DSECT                                                                  
         ORG   MODMDEMO                                                         
MDEMNO   DS    XL3       B         X'00'/DEMO TYPE/DEMO NUMBER                  
MDSVI    DS    CL1       B         HUT ADJUSTMENT                               
MDEMRAW  DS    CL4       B         DEMO VALUE                                   
*                                                                               
       ++INCLUDE SPGENDRBTC                                                     
       ++INCLUDE SPGENDRFLT                                                     
STARECD  DSECT                                                                  
       ++INCLUDE SPGENSTA                                                       
       ++INCLUDE SPSTAPACKD                                                     
       ++INCLUDE SPDARDARED                                                     
       ++INCLUDE CTGENFILE                                                      
       ++INCLUDE FAWSSVRD                                                       
       ++INCLUDE DMPRTQL                                                        
       ++INCLUDE DDBUFFD                                                        
       ++INCLUDE DDTSARD                                                        
       ++INCLUDE SPGENBUY                                                       
       ++INCLUDE FAFACTS                                                        
       ++INCLUDE DDSPOOK                                                        
       ++INCLUDE SPADBUYER                                                      
       ++INCLUDE GEGENSPSAL                                                     
       ++INCLUDE SPADAVCOM                                                      
       ++INCLUDE SPGENORHIS                                                     
       ++INCLUDE SPOMCOMD                                                       
       ++INCLUDE SPAUTHD                                                        
       ++INCLUDE DMPRTQK                                                        
       ++INCLUDE FATCB                                                          
       ++INCLUDE DDDARETABD                                                     
       ++INCLUDE SPGENEMAIL                                                     
       ++INCLUDE SPMGADN                                                        
       ++INCLUDE DDGETDARED                                                     
       ++INCLUDE DERENTABD                                                      
       ++INCLUDE GEGENTOK                                                       
*PREFIX=OM$                                                                     
COMHDRD  DSECT                                                                  
       ++INCLUDE SPGENCOM                                                       
*PREFIX=                                                                        
       ++INCLUDE DDPERVALD                                                      
*PREFIX=D                                                                       
       ++INCLUDE CTGENSTAD                                                      
*PREFIX=                                                                        
DBLOCKD  DSECT                                                                  
       ++INCLUDE DEDBLOCK                                                       
         PRINT ON                                                               
*                                                                               
ORDXMTD  DSECT                     ORDER TRANSMISSION BUFFER                    
ORXTYPE  DS    C                   ORDER XMIT RECORD                            
ORXTYPEQ EQU   C'O'                                                             
*                                                                               
ORXAGM   DS    XL1                 MEDIA                                        
ORXCLT   DS    XL2                 CLIENT                                       
ORXPRD   DS    XL1                 PRODUCT                                      
ORXMSTA  DS    0XL5                MARKET/STATION                               
ORXMKT   DS    XL2                 MARKET                                       
ORXSTAC  DS    XL3                 STATION                                      
ORXEST   DS    XL1                 ESTIMATE                                     
ORDXBKYL EQU   *-ORDXMTD                                                        
*                                                                               
ORXPRD2  DS    XL1                 PIGGY                                        
ORXFLT   DS    XL1                 FLIGHT                                       
ORXFLAG  DS    XL1                 FLAGS                                        
ORXTRADE EQU   X'80'               TRADE ORDER                                  
ORDXKEYL EQU   *-ORDXMTD                                                        
*                                                                               
ORXORDDA DS    XL4                 D/A(ORDER RECORD)                            
ORXSTATS DS    B                   STATUS OF ORDER                              
ORXSTATF DS    B                   STATUS FLAG                                  
ORDXRECL EQU   *-ORDXMTD                                                        
*                                                                               
BUYHISD  DSECT                     BUY HISTORY RECORD BUFFER                    
BHISLEN  DS    XL2                 KEYLEN + DATALEN + 2                         
*                                                                               
BHISKEY  DS    0X                                                               
BHISTYPE DS    C                                                                
BHISTYPQ EQU   C'B'                                                             
*                                                                               
BHISSTA  DS    XL3                 PACKED STATION                               
BHISLIN  DS    XL2                 LINE NUMBER                                  
BHISSEQ  DS    XL1                 SEQNUM                                       
BHDATQ   EQU   X'00'                      X'00'       BUY DATA                  
BHDOLQ   EQU   X'01'                      X'01'       DOLLARS                   
BHTAXQ   EQU   X'02'                      X'02'       TAX                       
BHCOVQ   EQU   X'11'                      X'11'-X'19' COST OVRDS                
BHORBQ   EQU   X'20'                      X'20'       ORBITUIARY                
BHCOMQ   EQU   X'30'                      X'30'-X'34' COMMENTS                  
*                                                                               
BUYHKEYL EQU   *-BHISKEY           L'KEY                                        
BUYHKEYH EQU   *-BUYHISD           L'KEY+2 BYTE LENGTH                          
*                                                                               
BHFLAG   DS    XL1                 NON-ZERO = RECORD DELETED                    
BUYHKYH2 EQU   *-BUYHISD           L'KEY+2 BYTE LENGTH+1                        
BHISREC  DS    0X                                                               
*                                  00 BUY DATA                                  
BHBDCOST DS    XL3                                                              
*                                                                               
BHBDDAY  DS    XL1                                                              
BHBDTIME DS    XL4                                                              
*                                                                               
BHDEMS   DS    4XL8                                                             
*                                                                               
BHBDCIND DS    XL1                                                              
BHBDCIN2 DS    XL1                                                              
BHBDSEC  DS    XL1                                                              
BHBDPROG DS    CL17                                                             
BUYHRCLD EQU   *-BUYHISD                                                        
BHSPTS   DS    XL53                53 WEEKS OR DAYS                             
*                                                                               
         ORG   BHISREC             X'01' DOLLARS                                
BHDOLS   DS    XL212                                                            
BUYHRECL EQU   *-BUYHISD                                                        
*                                                                               
         ORG   BHISREC             X'02' TAX                                    
BHTAX    DS    XL212                                                            
*                                                                               
         ORG   BHBDDAY             X'10' COST OVERRIDES                         
BUYHRCLC EQU   *-BUYHISD                                                        
BHCSPTS  DS    XL53                                                             
*                                                                               
         ORG   BHISREC             X'20' ORBITS                                 
BHORBS   DS    XL128               MAX 8 ORBITS FOR 16 BYTES EACH               
*                                                                               
         ORG   BHISREC             X'30' COMMENTS                               
BHCOM    DS    CL70                                                             
         ORG                                                                    
***********************************************************************         
* EDICT CHUNKY DSECT                                                            
***********************************************************************         
EDICTD   DSECT                                                                  
       ++INCLUDE EDIDDSHD                                                       
       ++INCLUDE EDILINKD                                                       
         EJECT                                                                  
SPEDICTD DSECT                                                                  
       ++INCLUDE SPEDICT                                                        
***********************************************************************         
* BINSRCH RECORD DSECT                                                          
***********************************************************************         
BINSRECD DSECT                                                                  
BSRCCOST DS    XL4                 COST                                         
BSRCDATE DS    CL6                 DATE   YYMMDD                                
BSRCNSPT DS    XL1                 NUMBER OF SPOTS                              
BSRCKLEN EQU   *-BINSRECD          LEN OF THE KEY                               
BSRCTSPT DS    XL1                 TOTAL NUMBER OF SPOTS FOR THIS WEEK          
BSRCRLEN EQU   *-BINSRECD          LEN OF THE RECORD                            
*                                                                               
LAYOUT2D DSECT                                                                  
LAY2MED  DS    CL1                 FIELDS MADE UP IN THE DARE SCREEN            
LAY2BYR  DS    CL3                                                              
LAY2MTHD DS    CL1                 - CASH OR TRADE                              
LAY2CLT  DS    CL3                                                              
LAY2PRDS DS    CL7                                                              
LAY2EST  DS    CL6                                                              
LAY2STA  DS    CL8                                                              
LAY2OORD DS    CL8                                                              
LAY2SALP DS    0CL25                SALESPERSON                                 
LAY2RPRF DS    CL3                  RADIO PREFIX                                
LAY2RSAL DS    CL23                                                             
LAY2END  EQU   *                                                                
*                                                                               
TWAD     DSECT                                                                  
         ORG   TWAUSER                                                          
SVVALS   DS    0X                  ** SAVED VALUES **                           
SVVALL   EQU   *-SVVALS                                                         
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'182SPLNK16   11/03/20'                                      
         END                                                                    
