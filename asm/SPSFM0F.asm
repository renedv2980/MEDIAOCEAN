*          DATA SET SPSFM0F    AT LEVEL 020 AS OF 08/11/11                      
*PHASE T2170FA                                                                  
*                                                                               
***********************************************************************         
*                                                                     *         
*  TITLE        T2170F - SIR DETAIL RECORD MAINTENANCE                *         
*                                                                     *         
*  CALLED FROM  GENCON VIA T21700 (SFM CONTROLLER)                    *         
*               T2171F (NSID/DETAIL MINI-CONTROLLER) VIA T21700       *         
*                                                                     *         
*  COMMENTS     SUPPORTS ADD, DISPLAY, DELETE, RESTORE, CHANGE        *         
*                                                                     *         
*  INPUTS       SCREEN T217BF (MAINTENANCE)                           *         
*                                                                     *         
*  OUTPUTS      UPDATED DETAIL, COMPETITION, AND NSID RECORDS         *         
*                                                                     *         
*  REGISTERS    R0 -- WORK                                            *         
*               R1 -- WORK                                            *         
*               R2 -- WORK                                            *         
*               R3 -- WORK                                            *         
*               R4 -- WORK                                            *         
*               R5 -- WORK                                            *         
*               R6 -- WORK                                            *         
*               R7 -- THIRD BASE                                      *         
*               R8 -- SECOND BASE                                     *         
*               R9 -- SYSD                                            *         
*               RA -- TWA                                             *         
*               RB -- FIRST BASE                                      *         
*               RC -- GEND                                            *         
*               RD -- SYSTEM                                          *         
*               RE -- SYSTEM                                          *         
*               RF -- SYSTEM                                          *         
*                                                                     *         
*  I/O AREAS    IO1 - DETAIL RECORD                                   *         
*               IO2 - NSID RECORD                                     *         
*               IO3 - MISC.                                           *         
*                                                                     *         
*  JUN05/06 AKAT - NEW SPOT LENGTH VALIDATION                         *         
*  COMMENTS                                                           *         
*                                                                     *         
*  THERE IS A STRICT ONE-TO-ONE CORRESPONDENCE BETWEEN EACH DETAIL    *         
*  RECORD AND A DAY/TIME ELEMENT IN ITS PARENT NSID RECORD.  EVERY    *         
*  TIME A DETAIL RECORD IS ADDED, CHANGED, OR DELETED, THIS IS        *         
*  REFLECTED BY A CHANGE TO THE PARENT NSID RECORD.                   *         
*                                                                     *         
*  THE ACTION SELECT IS ALLOWED ONLY WHEN GENERATED BY A SELECT FROM  *         
*  THE NSID SCREEN (T217BE).  IN THAT CASE, THIS PHASE IS LOADED BY   *         
*  T2171F, THE NSID/DETAIL SELECT MINI-CONTROLLER.                    *         
*                                                                     *         
***********************************************************************         
         TITLE 'T2170F - SIR INVENTORY DETAIL RECORDS'                          
T2170F   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,T2170F                                                         
*                                                                               
         USING T2170F,RB,R8,R7                                                  
         LA    R8,2048(RB)                                                      
         LA    R8,2048(R8)                                                      
         LA    R7,2048(R8)                                                      
         LA    R7,2048(R7)                                                      
*                                                                               
         L     RC,0(R1)                                                         
         USING GEND,RC                                                          
         L     RA,ATWA                                                          
         USING CONHEADH-64,RA      BASE SCREEN FOR SYSTEM + THIS PROG           
         L     R9,ASYSD                                                         
         USING SYSD,R9                                                          
         ST    RD,SAVERD                                                        
*                                                                               
         CLC   =C'SELECT',CONACT   TEST WE ARE HERE VIA NSID                    
         BE    SELECT              YES                                          
*                                                                               
         CLI   MODE,VALKEY         VALIDATE DETAIL KEY                          
         BNE   *+12                                                             
         BAS   RE,VK                                                            
         B     XIT                                                              
*                                                                               
         CLI   MODE,VALREC         VALIDATE DETAIL RECORD                       
         BNE   *+12                                                             
         BAS   RE,VR                                                            
         B     XIT                                                              
*                                                                               
         CLI   MODE,DISPREC        DISPLAY DETAIL RECORD                        
         BNE   *+12                                                             
         BAS   RE,DR                                                            
         B     XIT                                                              
*                                                                               
         CLI   MODE,XRECADD        UPDATE NSID RECORD                           
         BE    XADD                                                             
*                                                                               
         CLI   MODE,XRECPUT        UPDATE NSID RECORD                           
         BNE   *+12                                                             
         BAS   RE,XPUT                                                          
         B     XIT                                                              
*                                                                               
         CLI   MODE,XRECDEL        UPDATE NSID RECORD                           
         BE    XDELETE                                                          
*                                                                               
         CLI   MODE,XRECREST       UPDATE NSID RECORD                           
         BE    XRESTORE                                                         
*                                                                               
XIT      XIT1                                                                   
         EJECT                                                                  
* VALIDATE KEY                                                                  
*                                                                               
VK       NTR1                                                                   
*                                                                               
         LA    R5,SAVEKEY          PUT KEY IN SAVEKEY, THEN MOVE TO KEY         
         USING SIRKEY,R5                                                        
         XC    SAVEKEY,SAVEKEY                                                  
         MVI   SIRKTYPE,SIRKTYPQ   SIR RECORD TYPE                              
*                                                                               
         LA    R2,=X'0900000000010000E3'                                        
         GOTO1 VALIMED             FAKE THE MEDIA FIELD TO 'T'                  
         MVC   SIRKAM,BAGYMD                                                    
*                                                                               
         LA    R2,SRDSCHH          SCHEME                                       
         CLI   5(R2),0                                                          
         BNE   VK7                 SCHEME WAS GIVEN                             
*                                                                               
         XC    WORK,WORK           READ SID PROFILE FOR AGENCY/MEDIA            
         MVC   WORK+16(4),=C'S0SI'                                              
         MVC   WORK+20(2),AGENCY                                                
         MVC   WORK+22(1),QMED                                                  
         GOTO1 GETPROF,DMCB,WORK+16,WORK,DATAMGR                                
         OC    WORK(16),WORK       TEST PROFILE FOUND                           
         BZ    VK5                 NO -- NO SCHEME IS OK                        
         CLI   WORK+2,C'N'         DEFAULT ALLOWED?                             
         BNE   VK5                 YES                                          
         MVI   ERROR,MISSING                                                    
         B     TRAPERR                                                          
*                                                                               
VK5      MVC   8(3,R2),=C'ALL'                                                  
         OI    6(R2),FOUTTRN       XMIT                                         
         B     VK10                                                             
*                                                                               
VK7      CLC   =C'ALL',8(R2)       TEST SCHEME FOR ENTIRE AGENCY                
         BE    VK10                                                             
         OC    SRDSCH,=C'   '                                                   
         GOTO1 CLPACK,DMCB,8(R2),SIRKCODE                                       
         CLI   DMCB,0              TEST VALID SCHEME CODE                       
         BE    VK10                YES                                          
         MVI   ERROR,INVSCH                                                     
         B     TRAPERR                                                          
*                                                                               
VK10     MVI   SVUSECMP,C'N'       ASSUME USER DOESN'T USE COMPETITION          
         MVI   SVUSEREP,C'N'       ASSUME USER DOESN'T USE REP MARKETS          
         XC    WORK,WORK           READ SID PROFILE                             
         MVC   WORK+16(4),=C'S0SI'                                              
         MVC   WORK+20(2),AGENCY                                                
         MVC   WORK+22(1),QMED                                                  
         CLC   SRDSCH,=C'ALL'                                                   
         BE    *+10                                                             
         MVC   WORK+23(3),SRDSCH                                                
         GOTO1 GETPROF,DMCB,WORK+16,WORK,DATAMGR                                
         OC    WORK(16),WORK       TEST PROFILE FOUND                           
         BZ    *+16                NO                                           
         MVC   SVUSECMP,WORK       SAVE PROFILE VALUES                          
         MVC   SVUSEREP,WORK+1                                                  
*                                                                               
         LA    R2,SRDSTAH          MARKET/STATION                               
         CLI   5(R2),0                                                          
         BNE   *+12                                                             
         MVI   ERROR,MISSING                                                    
         B     TRAPERR                                                          
*                                                                               
         CLI   SVUSEREP,C'Y'       TEST READING REP MARKETS                     
         BNE   VK15                NO                                           
         GOTO1 VALIRSTA            YES                                          
         B     VK18                                                             
VK15     GOTO1 VALISTA                                                          
*                                                                               
VK18     MVC   SIRKMS,BMKTSTA                                                   
         MVI   STAMATCH,C'Y'       ASSUME STATION MATCHES NSID STATION          
         CLC   SIRKSTA,SVKEY+6     COMPARE STATION WITH NSID STATION            
         BE    *+8                 IT'S A MATCH                                 
         MVI   STAMATCH,C'N'       THEY DON'T MATCH                             
*                                                                               
         LA    R2,SRDDPTH          DAYPART                                      
         CLI   5(R2),0                                                          
         BNE   *+12                                                             
         MVI   ERROR,MISSING                                                    
         B     TRAPERR                                                          
*                                                                               
         MVC   DAYPART,SRDDPT                                                   
         MVC   SIRKDPT,DAYPART                                                  
*                                                                               
         LA    R2,SRDYRH           YEAR                                         
         CLI   5(R2),0                                                          
         BE    VK20                                                             
*                                                                               
         XC    WORK,WORK                                                        
         GOTO1 PERVAL,DMCB,(SRDYRH+5,SRDYR),('PVINSGLO',WORK)                   
*                                                                               
         CLI   DMCB+4,PVRCOK       YEAR WAS OK?                                 
         BE    *+12                                                             
         MVI   ERROR,INVYEAR                                                    
         B     TRAPERR             NO                                           
*                                                                               
         LA    RF,WORK             PERVAL OUTPUT AREA                           
         MVC   SIRKYEAR,PVALBSTA-PERVALD(RF)  BINARY YEAR                       
         XI    SIRKYEAR,X'FF'      YEAR IS IN ONE'S COMPLEMENT FORM             
*                                                                               
VK20     LA    R5,KEY              CREATE THE SCHEME KEY                        
         XC    KEY,KEY                                                          
         MVC   SIRKEY,SAVEKEY                                                   
         XC    SIRKMS(9),SIRKMS                                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   SIRKEY,KEYSAVE      TEST SCHEME EXISTS                           
         BE    *+16                                                             
         LA    R2,SRDSCHH                                                       
         MVI   ERROR,NOSCHM                                                     
         B     TRAPERR                                                          
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EDYCODEQ     LOOK FOR DEFAULT YEAR ELEMENT                
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING EDYELEM,R6                                                       
         MVC   CURYEAR,EDYYEAR     GET THE YEAR                                 
         DROP  R6                                                               
*                                                                               
         LA    R5,SAVEKEY                                                       
         CLI   SIRKYEAR,0          TEST YEAR IS ABSENT                          
         BNE   VK40                NO, WE HAVE ONE                              
         MVC   SIRKYEAR,CURYEAR    USE THE CURRENT YEAR                         
         MVC   FULL(1),CURYEAR                                                  
         MVC   FULL+1(2),=X'0101'  PRETEND IT'S JAN01                           
         GOTO1 DATCON,DMCB,(3,FULL),(20,DUB)                                    
         MVC   SRDYR,DUB+2         PRINTABLE YY                                 
         OI    SRDYRH+6,FOUTTRN    XMIT THE CURRENT YEAR                        
         XI    SIRKYEAR,X'FF'      SAVE YEAR IN ONE'S COMPLEMENT FORM           
         B     VK50                                                             
*                                                                               
VK40     ZIC   R1,SIRKYEAR         COMPARE GIVEN YEAR TO CURRENT YEAR           
         X     R1,=F'255'          MAKE YEAR POSITIVE                           
         ZIC   R0,CURYEAR                                                       
         SR    R1,R0                                                            
         LPR   R1,R1               DIFFERENCE IN YEARS                          
         CH    R1,=H'1'            NO GREATER THAN ONE YEAR DIFFERENCE          
         BNH   VK50                                                             
         LA    R2,SRDYRH                                                        
         MVI   ERROR,INVYEAR                                                    
         B     TRAPERR                                                          
*                                                                               
VK50     L     R6,AIO                                                           
         MVI   ELCODE,EDCCODEQ     LOOK FOR DAYPART CODES                       
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         SR    R0,R0                                                            
         ZIC   R1,1(R6)                                                         
         SH    R1,=H'2'                                                         
         D     R0,=F'8'            R1 = NO. OF DAYPARTS                         
         LA    R6,2(R6)            FIRST DAYPART                                
*                                                                               
VK60     CLC   DAYPART,0(R6)       LOOK FOR THE GIVEN DAYPART                   
         BE    VK65                                                             
         LA    R6,8(R6)            NEXT DAYPART                                 
         BCT   R1,VK60                                                          
         LA    R2,SRDDPTH                                                       
         MVI   ERROR,INVDPT                                                     
         B     TRAPERR                                                          
*                                                                               
VK65     LA    R3,PRGTYPSV         SAVE PROGTYPE CODE/NAME IN PRGTYPSV          
         XC    PRGTYPSV,PRGTYPSV                                                
         L     R6,AIO                                                           
         MVI   ELCODE,EPCCODEQ                                                  
         BAS   RE,GETEL                                                         
         BNE   VK80                PROGTYP IS OPTIONAL                          
*                                                                               
         USING EPCELEM,R6                                                       
         SR    R0,R0                                                            
         ZIC   R1,EPCLEN                                                        
         SH    R1,=H'2'                                                         
         D     R0,=F'8'            LEAVES NO. OF PROGTYPES IN R1                
*                                                                               
VK70     MVC   0(8,R3),EPCDCODE    CODE+NAME                                    
         LA    R6,8(R6)                                                         
         LA    R3,8(R3)                                                         
         BCT   R1,VK70                                                          
         DROP  R6                                                               
*                                                                               
VK80     L     R6,AIO                                                           
         MVI   ELCODE,EPNCODEQ     PERIOD NAMES ELEMENT                         
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         SR    R0,R0                                                            
         ZIC   R1,1(R6)                                                         
         SH    R1,=H'2'                                                         
         D     R0,=F'5'            R1 = NO. OF PERIODS                          
         LA    R6,2(R6)            FIRST PERIOD NAME                            
*                                                                               
         MVI   PERNUM,0            PERIOD                                       
         LA    R2,SRDPERH                                                       
         CLI   5(R2),0                                                          
         BNE   *+12                                                             
         MVI   ERROR,MISSING                                                    
         B     TRAPERR                                                          
         OC    SRDPER,=C'    '     PAD NAME WITH BLANKS                         
*                                                                               
VK90     CLC   SRDPER,1(R6)        LOOK FOR MATCH OF PERIOD NAME                
         BE    VK95                                                             
         LA    R6,5(R6)                                                         
         BCT   R1,VK90                                                          
         MVI   ERROR,INVBUYP                                                    
         B     TRAPERR                                                          
*                                                                               
VK95     MVC   PERNUM,0(R6)        SAVE THE PERIOD NUMBER                       
         MVC   SIRKMON,PERNUM                                                   
         OI    SIRKMON,SIRKBUYQ                                                 
*                                                                               
         LA    R5,KEY                                                           
         MVC   SIRKEY,SAVEKEY      BUILD THE PERIOD KEY                         
         XC    SIRKMS,SIRKMS                                                    
         MVI   SIRKDPT,0                                                        
         MVI   SIRKMON,0                                                        
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR PERIOD KEY                          
         CLC   SIRKEY,KEYSAVE                                                   
         BE    *+16                                                             
         LA    R2,SRDPERH                                                       
         MVI   ERROR,NOPERREC                                                   
         B     TRAPERR                                                          
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EPDCODEQ     LOOK FOR PERIOD ELEMENT                      
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING EPDELEM,R6                                                       
VK100    CLC   PERNUM,EPDNUM       LOOK FOR THE GIVEN PERIOD                    
         BE    VK105                                                            
         BAS   RE,NEXTEL                                                        
         BE    VK100                                                            
         LA    R2,SRDPERH                                                       
         MVI   ERROR,INVBUYP                                                    
         B     TRAPERR                                                          
*                                                                               
VK105    GOTO1 DATCON,DMCB,(3,EPDSTART),(5,SRDDPER)                             
         GOTO1 DATCON,DMCB,(3,EPDEND),(5,SRDDPER+9)                             
         MVC   PERSTART,EPDSTART                                                
         MVC   PEREND,EPDEND                                                    
         MVI   SRDDPER+8,C'-'                                                   
         OI    SRDDPERH+6,FOUTTRN  XMIT PERIOD DATES                            
*                                                                               
         MVI   WORK,C' '           BUILD PERIOD UPGRADE EXPRESSION              
         MVC   WORK+1(L'WORK-1),WORK                                            
         MVC   WORK(4),=C'UPX='                                                 
         MVC   WORK+2(1),EPDUPFIL                                               
         MVC   WORK+4(16),EPDUPINP                                              
*                                                                               
         OC    EPDUPFBK,EPDUPFBK   TEST ANY SHARE BOOK                          
         BZ    VK110                                                            
         OC    EPDUPINP,EPDUPINP   CANADIAN UPGRADE EXPRESSION?                 
         BNZ   *+18                                                             
         LA    R3,WORK+4           YES                                          
         MVC   0(3,R3),=C'BK/'                                                  
         B     VK107                                                            
*                                                                               
         LA    R3,WORK+21                                                       
         CLI   0(R3),C' '          BACK UP TO NON-BLANK                         
         BNE   *+8                                                              
         BCT   R3,*-8                                                           
         MVI   1(R3),C','          EDIT IN COMMA                                
         LA    R3,2(R3)                                                         
         MVC   0(3,R3),=C'BK='                                                  
*                                                                               
VK107    GOTO1 DATCON,DMCB,(3,EPDUPFBK),(6,3(R3))                               
         CLI   EPDLEN,EPDLENXQ     NEW VERSION OF ELEMENT?                      
         BL    VK110               NO                                           
*                                                                               
         LA    R3,9(R3)            BUMP PAST THIS BOOK                          
         LA    R0,3                MAXIMUM OF 3 MORE BOOKS                      
         LA    R2,EPDUPMBK         EXTRA BOOKS FOR CANADA                       
VK108    OC    0(2,R2),0(R2)       ANY MORE?                                    
         BZ    VK110                                                            
         MVI   0(R3),C'/'          BOOK DELIMITER                               
         GOTO1 DATCON,DMCB,(3,0(R2)),(6,1(R3))                                  
         LA    R3,7(R3)                                                         
         LA    R2,2(R2)                                                         
         BCT   R0,VK108                                                         
         DROP  R6                                                               
*                                                                               
VK110    MVC   PERUPG,WORK         SAVE THE UPGRADE EXPRESSION                  
         MVI   SIRKYEAR,0          YEAR IS ABSENT IN UPGRADE KEY                
         MVC   SIRKMON,PERNUM      BUT PERIOD IS THERE                          
         OI    SIRKMON,SIRKBUYQ                                                 
         MVC   SIRKMS,BMKTSTA      SO IS MKT/STA                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR STATION DEFAULT UPGRADE KEY         
         CLC   SIRKEY,KEYSAVE                                                   
         BE    VK115               WE HAVE IT                                   
*                                                                               
         MVC   SIRKEY,KEYSAVE      TRY MARKET DEFAULT UPGRADE                   
         XC    SIRKSTA,SIRKSTA                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   SIRKEY,KEYSAVE      TEST WE HAVE IT                              
         BE    VK115               YES                                          
         MVC   WORK(34),PERUPG     WE DON'T - USE THE PERIOD UPGRADE            
         B     VK130                                                            
*                                                                               
VK115    MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC              GET STATION RECORD                           
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EUPCODEQ     STATION DEFAULT UPGRADE ELEMENT              
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING EUPELEM,R6                                                       
         MVI   WORK,C' '           BUILD STATION UPGRADE EXPRESSION             
         MVC   WORK+1(L'WORK-1),WORK                                            
         MVC   WORK(4),=C'UPX='                                                 
         MVC   WORK+2(1),EUPUPFIL                                               
*                                                                               
         CLI   EUPUPGRD,SPUPTPUT   TEST HUT OR PUT                              
         BNE   VK120               NO, NEITHER ONE                              
         CLI   EUPUPGRD+1,C'P'     TEST PUT                                     
         BNE   VK120               NO, IT'S A HUT                               
*                                                                               
         MVC   WORK+4(4),=C'PUT/'                                               
         ZIC   R0,CURYEAR          CURRENT YEAR FROM SCHEME RECORD              
         SR    R1,R1                                                            
         ICM   R1,8,EUPUPGRD+2     RELATIVE PUT BOOK YEAR                       
         SRA   R1,24                                                            
         AR    R1,R0               DETERMINE ABSOLUTE YEAR                      
         STC   R1,EUPUPGRD+2                                                    
         GOTO1 DATCON,DMCB,(3,EUPUPGRD+2),(6,WORK+8)                            
         MVC   WORK+11(2),WORK+12  GET RID OF '/'                               
         MVI   WORK+13,C' '                                                     
         B     *+10                                                             
*                                                                               
VK120    MVC   WORK+4(16),EUPUPINP                                              
         OC    EUPUPFBK,EUPUPFBK   TEST ANY SHARE BOOK                          
         BZ    VK130                                                            
         ZIC   R0,CURYEAR          CURRENT YEAR FROM SCHEME RECORD              
         SR    R1,R1                                                            
         ICM   R1,8,EUPUPFBK       RELATIVE SHARE BOOK YEAR                     
         SRA   R1,24                                                            
         AR    R1,R0               DETERMINE ABSOLUTE YEAR                      
         STC   R1,EUPUPFBK                                                      
*                                                                               
         LA    R3,WORK+21                                                       
         CLI   0(R3),C' '          BACK UP TO NON-BLANK                         
         BNE   *+8                                                              
         BCT   R3,*-8                                                           
         MVI   1(R3),C','          EDIT IN COMMA                                
         LA    R3,2(R3)                                                         
         MVC   0(3,R3),=C'BK='                                                  
         GOTO1 DATCON,DMCB,(3,EUPUPFBK),(6,3(R3))                               
*                                                                               
VK130    LA    R2,SRDDUPGH         DEFAULT UPGRADE FIELD                        
         ZIC   RE,0(R2)                                                         
         SH    RE,=H'9'                                                         
         TM    1(R2),FATBXHDR      TEST EXTENDED HEADER                         
         BZ    *+8                                                              
         SH    RE,=H'8'                                                         
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   8(0,R2),WORK        EBCDIC UPGRADE EXPRESSION                    
         OI    6(R2),FOUTTRN       XMIT                                         
         MVC   SVDEFUPG,SRDDUPG                                                 
         DROP  R6                                                               
*                                                                               
         LA    R2,SRDDAYH          DAY                                          
         GOTO1 ANY                                                              
         MVC   SRDDAY,WORK                                                      
         ZIC   R4,5(R2)                                                         
         GOTO1 DAYVAL,DMCB,((R4),SRDDAY),DAY,DAYNUM                             
         CLI   DAY,0                                                            
         BNE   *+12                                                             
         MVI   ERROR,INVDAY                                                     
         B     TRAPERR                                                          
         ZIC   R4,DAYNUM                                                        
         SRL   R4,4                KEEP START DAY ONLY                          
         STC   R4,DAYNUM                                                        
*                                                                               
         LA    R2,SRDTIMEH         TIME                                         
         GOTO1 ANY                                                              
         MVC   SRDTIME,WORK                                                     
         ZIC   R4,5(R2)                                                         
         GOTO1 TIMVAL,DMCB,((R4),SRDTIME),TIME                                  
         MVI   ERROR,INVTIME                                                    
         CLI   0(R1),X'FF'                                                      
         BE    TRAPERR                                                          
         CLC   =C'NONE',TIME                                                    
         BE    TRAPERR                                                          
         CLC   =C'VARY',TIME                                                    
         BE    TRAPERR                                                          
*                                                                               
         MVI   ADDFLAG,C'N'        ASSUME WE'LL DO A PUTREC LATER               
         XC    SEQNUMS,SEQNUMS     CLEAR USED SEQUENCE NUMBER ARRAY             
         MVC   AIO,AIO2            USE AIO2 FOR NSID RECORD                     
         XC    KEY,KEY                                                          
         MVC   SIRKEY,SAVEKEY      RESTORE DETAIL KEY                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   SIRKEY,KEYSAVE      TEST NSID IS THERE                           
         BE    VK140               YES                                          
*                                                                               
         CLI   ACTNUM,ACTADD       IF NOT, THIS MUST BE AN ADD                  
         BE    *+16                                                             
         LA    R2,SRDSTAH          POSITION CURSOR                              
         MVI   ERROR,NOTFOUND                                                   
         B     TRAPERR                                                          
*                                                                               
         MVI   ADDFLAG,C'Y'        WE'LL DO AN ADDREC LATER                     
         XC    KEY,KEY                                                          
         MVC   SIRKEY,SAVEKEY                                                   
         MVI   SIRKYEAR,0          LOOK FOR LATEST YEAR                         
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR NSID RECORD                         
         CLC   KEY(11),KEYSAVE     TEST ONE IS THERE                            
         BNE   *+14                                                             
         CLC   KEY+12(1),KEYSAVE+12                                             
         BE    VK140               YES                                          
*                                                                               
         XC    SVNSIDKY,SVNSIDKY   NO NSID RECORD AT ALL                        
         MVI   SEQNUM,1            FIRST AND ONLY ELEMENT OF NEW RECORD         
         B     VK170                                                            
*                                                                               
VK140    MVC   SVNSIDKY,KEY        USE THIS NSID RECORD LATER                   
         CLI   ACTNUM,ACTREST      TEST ACTION RESTORE                          
         BNE   *+12                                                             
         BAS   RE,RESTSEQ          FIND SEQUENCE NUMBER TO RESTORE              
         B     VK170                                                            
*                                                                               
         GOTO1 GETREC                                                           
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENT                             
         BAS   RE,GETEL                                                         
         BNE   VK155                                                            
*                                                                               
         USING EDPELEM,R6                                                       
VK150    CLC   DAYTIME,EDPDAY      LOOK FOR THE GIVEN DAY/TIME                  
         BNE   *+14                                                             
         MVC   SEQNUM,EDPSEQ                                                    
         B     VK170                                                            
*                                                                               
         ZIC   R0,EDPSEQ                                                        
         LA    R3,SEQNUMS                                                       
         LA    R3,1(R3)                                                         
         BCT   R0,*-4                                                           
         MVI   0(R3),X'FF'         MARK SEQUENCE NUMBER AS USED                 
         DROP  R6                                                               
*                                                                               
         BAS   RE,NEXTEL                                                        
         BE    VK150                                                            
*                                                                               
VK155    LA    R1,1                                                             
         LA    R3,SEQNUMS+1        LOOK FOR FIRST AVAILABLE SEQNUM              
VK160    CLI   0(R3),0                                                          
         BE    *+16                                                             
         LA    R1,1(R1)                                                         
         LA    R3,1(R3)                                                         
         B     VK160                                                            
         STC   R1,SEQNUM           HERE IT IS                                   
*                                                                               
VK170    LA    R5,SAVEKEY                                                       
         MVC   SIRKSEQ,SEQNUM      PUT SEQUENCE NUMBER IN KEY                   
*                                                                               
         CLI   ACTNUM,ACTADD       TEST ACTION ADD                              
         BNE   *+8                                                              
         OI    GENSTAT1,OKADDEL    OK TO ADD BACK DELETED RECORDS               
*                                                                               
         MVC   AIO,AIO1            RESTORE AIO                                  
         XC    KEY,KEY                                                          
         MVC   KEY(13),SAVEKEY     THE DETAIL RECORD KEY                        
*                                                                               
         LA    R2,SRDDEMOH                                                      
         LA    R3,3                3 LINES OF DEMO OVERRIDES                    
VK180    CLI   SVUSECMP,C'Y'       TEST ESTIMATE/COMPETITION USER               
         BE    *+12                YES                                          
         NI    1(R2),X'FF'-FATBPROT  UNPROTECT                                  
         B     *+12                                                             
         OI    1(R2),FATBPROT      PROTECT                                      
         NI    1(R2),X'FF'-FATBMOD UNMODIFY                                     
*                                                                               
         OI    6(R2),FOUTTRN       XMIT                                         
         ZIC   R0,0(R2)                                                         
         AR    R2,R0                                                            
         BCT   R3,VK180                                                         
*                                                                               
         B     XIT                                                              
         DROP  R5                                                               
         EJECT                                                                  
* FIND SEQUENCE NUMBER TO RESTORE                                               
*                                                                               
RESTSEQ  NTR1                                                                   
*                                                                               
         LA    R4,KEY                                                           
         USING SIRKEY,R4                                                        
         MVC   AIO,AIO3            USE AIO3 FOR DETAIL RECORDS                  
         LA    R3,1                USE R3 FOR SEQUENCE NOS.                     
*                                                                               
REST10   XC    SIRKEY,SIRKEY                                                    
         MVC   SIRKEY,SVNSIDKY     THE NSID KEY                                 
         STC   R3,SIRKSEQ                                                       
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   SIRKEY,KEYSAVE      TEST UNDELETED KEY IS THERE                  
         BE    *+18                YES                                          
         CLC   SIRKEY(10),KEYSAVE  TEST ANY MORE OF ANY SEQ. NO.                
         BE    REST20              YES                                          
         B     REST30                                                           
*                                                                               
         GOTO1 GETREC              GET THE DETAIL RECORD                        
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         USING EDPELEM,R6                                                       
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENTS                            
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   DAYTIME,EDPDAY      TEST MATCH ON DAY/TIME                       
         BNE   REST20                                                           
         LA    R2,SRDSTAH          POSITION CURSOR                              
         MVI   ERROR,RECEXIST      RECORD ALREADY EXISTS                        
         B     TRAPERR                                                          
*                                                                               
REST20   LA    R3,1(R3)            INCREMENT SEQ. NO.                           
         B     REST10                                                           
*                                                                               
REST30   LA    R3,1                START AGAIN                                  
         OI    DMINBTS,X'08'       THIS TIME, LOOK AT DELETED RECORDS           
*                                                                               
REST40   XC    SIRKEY,SIRKEY                                                    
         MVC   SIRKEY,SVNSIDKY     THE NSID KEY                                 
         STC   R3,SIRKSEQ          LOOK AT DELETED DETAIL RECORDS               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   SIRKEY,KEYSAVE      TEST KEY FOUND                               
         BE    REST50              YES                                          
         CLC   SIRKEY(10),KEYSAVE  TEST ANY MORE OF ANY SEQ. NO.                
         BE    REST60                                                           
         LA    R2,SRDSTAH          POSITION CURSOR                              
         MVI   ERROR,NOTFOUND      NOTHING WITH THIS DAY/TIME                   
         B     TRAPERR                                                          
*                                                                               
REST50   TM    DMCB+8,X'02'        TEST RECORD WAS DELETED                      
         BZ    REST60              NO                                           
*                                                                               
         GOTO1 GETREC              GET THE DETAIL RECORD                        
         CLI   DMCB+8,X'02'        RECORD MUST HAVE BEEN DELETED                
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENTS                            
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   DAYTIME,EDPDAY      TEST MATCH ON DAY/TIME                       
         BNE   *+14                                                             
         MVC   SEQNUM,EDPSEQ       USE THIS SEQUENCE NO.                        
         B     RESTX                                                            
         DROP  R6                                                               
*                                                                               
REST60   LA    R3,1(R3)            INCREMENT SEQ. NO.                           
         B     REST40                                                           
*                                                                               
RESTX    NI    DMINBTS,X'F7'                                                    
         B     XIT                                                              
         DROP  R4                                                               
         EJECT                                                                  
* VALIDATE RECORD                                                               
*                                                                               
VR       NTR1                                                                   
*                                                                               
         USING EECELEM,R6                                                       
         MVI   ELCODE,EECCODEQ     EFFECTIVE COST ELEMENT                       
         GOTO1 REMELEM                                                          
*                                                                               
         LA    R2,SRDCST1H                                                      
         CLI   5(R2),0             TEST ANY COST DATA ON SCREEN                 
         BNE   *+18                YES                                          
         MVI   SVCOST1L,0          NO - CLEAR COST FIELD ON NSID SCREEN         
         XC    SVCOST1,SVCOST1                                                  
         B     VR35                                                             
*                                                                               
         LA    R6,ELEM             FIRST COST ELEMENT                           
         XC    ELEM,ELEM                                                        
         MVI   EECCODE,EECCODEQ                                                 
         MVI   EECLEN,EECLENEQ                                                  
         MVI   EECINDEX,1          SEQUENCE NO. (FOR SORTING)                   
         MVI   EECSLN,30           DEFAULT SPOT LENGTH                          
*                                                                               
         ZIC   R5,5(R2)                                                         
         CLI   STAMATCH,C'Y'       TEST WE SHOULD UPDATE NSID SCREEN            
         BNE   *+8                 NO                                           
         STC   R5,SVCOST1L                                                      
         GOTO1 CASHVAL,DMCB,(C'N',8(R2)),(R5)                                   
         CLI   0(R1),X'FF'                                                      
         BNE   *+12                                                             
         MVI   ERROR,INVALID                                                    
         B     TRAPERR                                                          
         L     R1,4(R1)                                                         
         MH    R1,=H'100'                                                       
         STCM  R1,15,EECCOST1      SAVE COST IN PENNIES                         
*                                                                               
         CLI   STAMATCH,C'Y'       TEST WE SHOULD UPDATE NSID SCREEN            
         BNE   VR5                 NO                                           
         ZIC   R1,SVCOST1L         SAVE COST FOR POSSIBLE NSID UPDATE           
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SVCOST1(0),SRDCST1                                               
*                                                                               
VR5      ZIC   R0,0(R2)                                                         
         AR    R2,R0               BUMP TO 1ST DATE FIELD                       
         XC    LASTDATE,LASTDATE   MAKE LASTDATE VERY LOW TO START              
         LA    R3,EECDATE2                                                      
*                                                                               
VR10     CLI   5(R2),0             TEST ANYTHING IN DATE FIELD                  
         BE    VR15                NO - DO NEXT ROW OF COSTS                    
*                                                                               
         XC    WORK,WORK                                                        
         LA    R5,WORK             PERVAL OUTPUT AREA                           
         USING PERVALD,R5                                                       
         MVC   BYTE,5(R2)          INPUT LENGTH                                 
         OI    BYTE,PVINXTND+PVINDDMM  EXTENDED PARAM BLOCK / MONTH/DAY         
         ZIC   R4,BYTE                                                          
         MVI   PVALIND1,PVALBVP    PASSING VALIDATION PERIOD IN BINARY          
         MVC   PVALPERD,PERSTEND   VALIDATION PERIOD                            
         GOTO1 PERVAL,DMCB,((R4),8(R2)),('PVINSGLO',(R5))                       
*                                                                               
         TM    DMCB+4,X'FF'-PVRCONE  DATE WAS OK?                               
         BZ    *+20                YES                                          
         TM    DMCB+4,PVRINVP      DATE FALLS WITHIN GIVEN PERIOD?              
         BO    OUTOFPER            NO                                           
         MVI   ERROR,INVDATE                                                    
         B     TRAPERR             SOME OTHER ERROR                             
*                                                                               
         MVC   0(3,R3),PVALBSTA    BINARY DATE                                  
*                                                                               
         CLC   LASTDATE,0(R3)      MAKE SURE DATES INCREASE                     
         BNL   LOWDATE                                                          
         MVC   LASTDATE,0(R3)                                                   
*                                                                               
         GOTO1 GETDAY,DMCB,PVALESTA,DUB                                         
         CLC   DAYNUM,DMCB         TEST MATCH ON START DAY                      
         BNE   STARTDAY                                                         
         DROP  R5                                                               
*                                                                               
         ZIC   R0,0(R2)            BUMP TO COST                                 
         AR    R2,R0                                                            
*                                                                               
         CLI   5(R2),0                                                          
         BNE   *+12                                                             
         MVI   ERROR,MISSING       IF DATE IS THERE, COST ALSO MUST BE          
         B     TRAPERR                                                          
*                                                                               
         ZIC   R5,5(R2)                                                         
         GOTO1 CASHVAL,DMCB,(C'N',8(R2)),(R5)                                   
         CLI   0(R1),X'FF'                                                      
         BNE   *+12                                                             
         MVI   ERROR,INVALID                                                    
         B     TRAPERR                                                          
         L     R1,4(R1)                                                         
         MH    R1,=H'100'                                                       
         ST    R1,3(R3)            SAVE COST IN PENNIES                         
*                                                                               
         ZIC   R0,0(R2)            BUMP TO NEXT DATE                            
         AR    R2,R0                                                            
         LA    R3,7(R3)                                                         
*                                                                               
         LA    R1,EECDATE4                                                      
         CR    R3,R1               TEST ANY MORE DATES                          
         BNH   VR10                YES                                          
*                                                                               
VR15     GOTO1 ADDELEM             ADD COSTS FOR 30'S                           
         MVI   INDEX,2             GET READY FOR 2ND ROW OF COSTS               
         LA    R2,SRDSLN2H                                                      
*                                                                               
VR20     CLI   5(R2),0             TEST ANY SPOT LENGTH                         
         BE    VR35                NO                                           
         TM    4(R2),FINPNUM       TEST NUMERIC                                 
         BO    *+12                                                             
         MVI   ERROR,NOTNUM                                                     
         B     TRAPERR                                                          
*                                                                               
         ZIC   R1,5(R2)            GET BINARY SPOT LENGTH                       
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         PACK  DUB,8(0,R2)                                                      
         CVB   R1,DUB                                                           
         STC   R1,BYTE                                                          
*                                                                               
         MVC   DMCB+4(4),=X'D9000A57'                                           
         GOTO1 CALLOV,DMCB,0         GET SPSLENTAB                              
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     R1,DMCB             POINT TO START OF PHASE                      
         LH    RE,0(R1)            ENTRY LENGTH                                 
         L     RF,2(R1)            EOT DSPL                                     
         AR    RF,R1               RELOCATE EOT ADDRESS                         
         AHI   R1,6                POINT TO FIRST ENTRY                         
*                                                                               
         MVI   HALF,C'T'                                                        
         CLI   QMED,C'T'                                                        
         BE    VR21                                                             
         CLI   QMED,C'N'                                                        
         BE    VR21                                                             
         CLI   QMED,C'C'                                                        
         BE    VR21                                                             
*                                                                               
         MVI   HALF,C'R'                                                        
         CLI   QMED,C'R'                                                        
         BE    VR21                                                             
         CLI   QMED,C'X'                                                        
         BE    VR21                                                             
         DC    H'0'                                                             
*                                                                               
VR21     CLC   =C'00',0(R1)        TEST DEFAULT TABLE                           
         BE    VR22                                                             
         CLC   0(2,R1),AGENCY      ELSE MATCH AGY                               
         BNE   *+14                                                             
VR22     CLC   HALF(1),2(R1)       AND MEDIA                                    
         BE    VR23                                                             
*                                                                               
         BXLE  R1,RE,VR21                                                       
         DC    H'0'                                                             
*                                                                               
VR23     AHI   R1,4                POINT BEYOND HEADER                          
*                                                                               
         MVI   ERROR,BADSLN                                                     
         ZIC   R4,BYTE             GET SLN                                      
         AR    R4,R4               X 2                                          
         AR    R4,R1               POINT TO ENTRY                               
         CLI   1(R4),0             SLN VALID?                                   
         BE    TRAPERR             NO                                           
*                                                                               
         LA    R6,ELEM             FIRST COST ELEMENT                           
         XC    ELEM,ELEM                                                        
         MVI   EECCODE,EECCODEQ                                                 
         MVI   EECLEN,EECLENEQ                                                  
         MVC   EECINDEX,INDEX      SEQUENCE NO. (FOR SORTING)                   
         MVC   EECSLN,BYTE                                                      
*                                                                               
         ZIC   R0,0(R2)            COST                                         
         AR    R2,R0                                                            
         CLI   5(R2),0                                                          
         BNE   *+12                                                             
         MVI   ERROR,MISSING       MUST BE THERE IF SLN IS THERE                
         B     TRAPERR                                                          
*                                                                               
         ZIC   R5,5(R2)                                                         
         GOTO1 CASHVAL,DMCB,(C'N',8(R2)),(R5)                                   
         CLI   0(R1),X'FF'                                                      
         BNE   *+12                                                             
         MVI   ERROR,INVALID                                                    
         B     TRAPERR                                                          
         L     R1,4(R1)                                                         
         MH    R1,=H'100'                                                       
         STCM  R1,15,EECCOST1      SAVE COST IN PENNIES                         
*                                                                               
         ZIC   R0,0(R2)                                                         
         AR    R2,R0               BUMP TO 1ST DATE FIELD                       
         XC    LASTDATE,LASTDATE   MAKE LASTDATE VERY LOW TO START              
         LA    R3,EECDATE2                                                      
*                                                                               
VR25     CLI   5(R2),0             TEST ANYTHING IN DATE FIELD                  
         BE    VR30                NO                                           
*                                                                               
         XC    WORK,WORK                                                        
         LA    R5,WORK             PERVAL OUTPUT AREA                           
         USING PERVALD,R5                                                       
         MVC   BYTE,5(R2)          INPUT LENGTH                                 
         OI    BYTE,PVINXTND+PVINDDMM  EXTENDED PARAM BLOCK / MONTH/DAY         
         ZIC   R4,BYTE                                                          
         MVI   PVALIND1,PVALBVP    PASSING VALIDATION PERIOD IN BINARY          
         MVC   PVALPERD,PERSTEND   VALIDATION PERIOD                            
         GOTO1 PERVAL,DMCB,((R4),8(R2)),('PVINSGLO',(R5))                       
*                                                                               
         TM    DMCB+4,X'FF'-PVRCONE  DATE WAS OK?                               
         BZ    *+20                YES                                          
         TM    DMCB+4,PVRINVP      DATE FALLS WITHIN GIVEN PERIOD?              
         BO    OUTOFPER            NO                                           
         MVI   ERROR,INVDATE                                                    
         B     TRAPERR             SOME OTHER ERROR                             
*                                                                               
         MVC   0(3,R3),PVALBSTA    BINARY DATE                                  
*                                                                               
         CLC   LASTDATE,0(R3)      MAKE SURE DATES INCREASE                     
         BNL   LOWDATE                                                          
         MVC   LASTDATE,0(R3)                                                   
*                                                                               
         GOTO1 GETDAY,DMCB,PVALESTA,DUB                                         
         CLC   DAYNUM,DMCB         TEST MATCH ON START DAY                      
         BNE   STARTDAY                                                         
         DROP  R5                                                               
*                                                                               
         ZIC   R0,0(R2)            BUMP TO COST                                 
         AR    R2,R0                                                            
*                                                                               
         CLI   5(R2),0                                                          
         BNE   *+12                                                             
         MVI   ERROR,MISSING       IF DATE IS THERE, COST ALSO MUST BE          
         B     TRAPERR                                                          
*                                                                               
         ZIC   R5,5(R2)                                                         
         GOTO1 CASHVAL,DMCB,(C'N',8(R2)),(R5)                                   
         CLI   0(R1),X'FF'                                                      
         BNE   *+12                                                             
         MVI   ERROR,INVALID                                                    
         B     TRAPERR                                                          
         L     R1,4(R1)                                                         
         MH    R1,=H'100'                                                       
         ST    R1,3(R3)            SAVE COST IN PENNIES                         
*                                                                               
         ZIC   R0,0(R2)            BUMP TO NEXT FIELD                           
         AR    R2,R0                                                            
         LA    R3,7(R3)                                                         
*                                                                               
         LA    R1,EECDATE4                                                      
         CR    R3,R1               TEST ANY MORE DATES                          
         BNH   VR25                YES                                          
         DROP  R6                                                               
*                                                                               
VR30     GOTO1 ADDELEM             ADD COSTS FOR THIS SPOTLEN                   
         CLI   INDEX,3                                                          
         BE    VR35                                                             
         LA    R2,SRDSLN3H         THIRD ROW OF COSTS                           
         MVI   INDEX,3                                                          
         B     VR20                                                             
*                                                                               
VR35     LA    R2,SRDPRGH          PROGRAM TYPE                                 
         MVI   PROGTYPE,0          ASSUME PROGRAM TYPE IS NOT GIVEN             
         CLI   5(R2),0                                                          
         BE    VR50                                                             
*                                                                               
         LA    R3,PRGTYPSV         LOOK FOR MATCH IN LIST                       
VR40     CLC   0(1,R3),SRDPRG                                                   
         BE    VR45                                                             
         LA    R3,8(R3)                                                         
         CLI   0(R3),0                                                          
         BNE   VR40                                                             
         MVI   ERROR,INVPRGTP                                                   
         B     TRAPERR                                                          
*                                                                               
VR45     MVC   PROGTYPE,SRDPRG     PUT PROGTYPE CODE IN ELEMENT                 
VR50     CLI   STAMATCH,C'Y'       TEST WE SHOULD UPDATE NSID SCREEN            
         BNE   *+10                NO                                           
         MVC   SVPRGTYP,PROGTYPE                                                
*                                                                               
         MVI   ELCODE,EDPCODEQ     DAY/TIME/PROGTYPE ELEMENT                    
         GOTO1 REMELEM                                                          
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING EDPELEM,R6                                                       
*                                                                               
         MVI   EDPCODE,EDPCODEQ                                                 
         MVI   EDPLEN,EDPLENEQ                                                  
         MVI   EDPINDEX,0                                                       
         MVC   EDPSEQ,SEQNUM                                                    
         MVC   EDPDAY,DAY                                                       
         MVC   EDPTIME,TIME                                                     
         MVC   EDPPROG,PROGTYPE                                                 
         GOTO1 ADDELEM                                                          
         DROP  R6                                                               
*                                                                               
         CLI   SVUSECMP,C'Y'       TEST COMPETITION USER                        
         BE    VR95                YES - IGNORE THESE FIELDS                    
*                                                                               
         MVI   ELCODE,EDOCODEQ     OVERRIDE DEMO VALUES                         
         GOTO1 REMELEM                                                          
*                                                                               
         LA    RE,BLOCK            SET UP FOR DEMOVAL                           
         USING DBLOCK,RE                                                        
         XC    BLOCK(256),BLOCK                                                 
         MVC   DBFILE,=C'TP '                                                   
         MVC   DBCOMFCS,ACOMFACS                                                
         MVI   DBSELSRC,C'N'                                                    
         MVI   DBSELMED,C'T'                                                    
         CLI   SVAPROF+7,C'C'      CANADIAN AGENCY?                             
         BNE   *+8                                                              
         MVI   DBSELMED,C'C'                                                    
         DROP  RE                                                               
*                                                                               
         L     RE,AIO2                                                          
         LA    RF,400                                                           
         XCEF                                                                   
         LA    R2,SRDDEMOH         R2 - SCREEN                                  
         LA    R3,3                R3 - 3 SCREEN FIELDS                         
         LA    R4,1                R4 - FIELD NUMBER (FOR ERRORS)               
         L     R5,AIO2             R5 - SCAN OUT AREA                           
         B     VR70                                                             
*                                                                               
VR60     ZIC   R0,0(R2)            BUMP                                         
         AR    R2,R0                                                            
*                                                                               
VR70     CLI   5(R2),0             TEST ANY INPUT                               
         BE    VR90                                                             
*                                                                               
         GOTO1 SCANNER,DMCB,(R2),(R5)                                           
*                                                                               
* TO CHK DEMONAME, BUILD HEADER & MVC DEMONAME FROM SCAN OUTAREA                
* TO DEMWRK. DEMOVAL REQUIRES ADDRS OF A HEADER.                                
*                                                                               
VR80     XC    DEMWRK(40),DEMWRK                                                
         ZIC   R1,0(R5)            L'DEMO NAME                                  
         STC   R1,DEMWRK+5                                                      
         LA    R1,8(R1)            L'DEMONAME + HEADER                          
         STC   R1,DEMWRK                                                        
         MVC   DEMWRK+8(10),12(R5) DEMNAME TO DEMWRK                            
*                                                                               
         XC    DMCB(24),DMCB                                                    
         L     R6,ACOMFACS                                                      
         USING COMFACSD,R6                                                      
         GOTO1 CDEMOVAL,DMCB,(1,DEMWRK),DEMWRK+20,(C'S',BLOCK)                  
         ZIC   R0,4(R1)                                                         
         LTR   R0,R0               TEST DEMO ERROR                              
         BZ    DEMOERR                                                          
         DROP  R6                                                               
*                                                                               
         CLI   1(R5),0             L'2ND SCAN OUTFIELD (DEMVALUE)               
         BE    RTNGERR                                                          
         ZIC   R6,1(R5)                                                         
         GOTO1 CASHVAL,DMCB,(1,22(R5)),(R6)                                     
         CLI   0(R1),X'FF'                                                      
         BE    RTNGERR                                                          
         CLC   4(4,R1),=F'32678'   MAX CASHVALUE IN HALF WRD                    
         BH    RTNGERR                                                          
*                                                                               
         LA    R6,ELEM                                                          
         USING EDOELEM,R6                                                       
         XC    ELEM,ELEM                                                        
         MVI   ELEM,EDOCODEQ                                                    
         MVI   EDOLEN,EDOLENEQ                                                  
         MVC   EDODEMO,DEMWRK+21   LAST 2 BYTES OF 3 BYTE CODE                  
         MVC   EDOVALUE,6(R1)      AFTER CASHVAL,2ND PARM=VALUE                 
*                                                                               
         GOTO1 ADDELEM                                                          
         LA    R4,1(R4)            INCREMENT FIELD ERROR NUMBER                 
         LA    R5,32(R5)           INCREMENT POSITION IN SCANNER BLOCK          
         OC    0(7,R5),0(R5)                                                    
         BNZ   VR80                                                             
*                                                                               
VR90     BCT   R3,VR60                                                          
         DROP  R6                                                               
*                                                                               
VR95     MVI   ELCODE,EUPCODEQ     UPGRADE ELEMENT                              
         GOTO1 REMELEM                                                          
         MVI   ELCODE,EOVCODEQ     OVERRIDE ELEMENT                             
         GOTO1 REMELEM                                                          
*                                                                               
         LA    R2,SRDUPGH                                                       
         CLI   5(R2),0                                                          
         BE    VR110                                                            
*                                                                               
         GOTO1 VALIUPG,DMCB,BLOCK+256                                           
         OC    CONHEAD,CONHEAD     TEST FOR ERROR MESSAGE                       
         BNZ   SOLONG              YES - LEAVE                                  
         LA    R4,BLOCK+256                                                     
         USING SPDEMUPD,R4                                                      
*                                                                               
         LA    R6,ELEM                                                          
         XC    ELEM,ELEM                                                        
         USING EUPELEM,R6                                                       
         MVI   EUPCODE,EUPCODEQ                                                 
         MVI   EUPLEN,EUPLENXQ                                                  
         MVC   EUPUPFIL,SPUPFIL                                                 
         MVC   EUPUPGRD,SPUPTYPE                                                
         MVC   EUPUPFBK,SPUPFBK                                                 
         MVC   EUPUPINP,SPUPPRG                                                 
         MVC   EUPUPMBK(6),SPUPFBKL                                             
         GOTO1 ADDELEM                                                          
         DROP  R6                                                               
*                                                                               
         OC    SPUPUDAY,SPUPUDAY                                                
         BNZ   VR100                                                            
         OC    SPUPUTIM,SPUPUTIM                                                
         BNZ   VR100                                                            
         OC    SPUPSTA,SPUPSTA                                                  
         BZ    VR110                                                            
*                                                                               
VR100    LA    R6,ELEM                                                          
         XC    ELEM,ELEM                                                        
         USING EOVELEM,R6                                                       
*                                                                               
         MVI   EOVCODE,EOVCODEQ                                                 
         MVI   EOVLEN,EOVLENXQ                                                  
         MVC   EOVUPDAY,SPUPUDAY                                                
         MVC   EOVUPTIM,SPUPUTIM                                                
         MVC   EOVUPSTA,SPUPSTA                                                 
*                                                                               
         GOTO1 ADDELEM                                                          
         DROP  R4,R6                                                            
*                                                                               
VR110    MVI   ELCODE,ECOCODEQ     COMMENTS ELEMENT                             
         GOTO1 REMELEM                                                          
         CLI   SRDCOMH+5,0                                                      
         BE    VR120                                                            
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING ECOELEM,R6                                                       
         MVI   ECOCODE,ECOCODEQ                                                 
         ZIC   R1,SRDCOMH+5                                                     
         LA    R1,2(R1)                                                         
         STC   R1,ECOLEN                                                        
         ZIC   R1,SRDCOMH+5                                                     
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ECOMMENT(0),SRDCOM                                               
         GOTO1 ADDELEM                                                          
         DROP  R6                                                               
*                                                                               
VR120    MVI   ELCODE,EPRCODEQ     PROGRAMMING ELEMENT                          
         GOTO1 REMELEM                                                          
         CLI   SRDPGMH+5,0                                                      
         BE    VRX                                                              
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING EPRELEM,R6                                                       
         MVI   EPRCODE,EPRCODEQ                                                 
         MVI   EPRLEN,EPRLENEQ                                                  
         MVC   EPRTEXT,SRDPGM                                                   
         GOTO1 ADDELEM                                                          
         DROP  R6                                                               
*                                                                               
VRX      B     XIT                                                              
         EJECT                                                                  
* UPDATE THE NSID AND COMPETITION RECORDS AFTER A PUTREC                        
*                                                                               
XPUT     NTR1                                                                   
*                                                                               
         L     R6,AIO              DETAIL RECORD                                
         USING EDPELEM,R6                                                       
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENT                             
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         ZIC   R1,EDPLEN           PUT ELEMENT IN ELEM                          
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELEM(0),EDPELEM                                                  
*                                                                               
         XC    KEY,KEY             BUILD NSID KEY                               
         MVC   KEY(13),SVNSIDKY    NSID KEY                                     
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR NSID RECORD                         
         CLC   KEY(13),KEYSAVE     BETTER BE THERE                              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   AIO,AIO2            USE AIO2 FOR NSID RECORD                     
         GOTO1 GETREC              GET THE NSID RECORD                          
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENT                             
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R5,ELEM                                                          
*                                                                               
XPUT10   CLC   EDPSEQ,EDPSEQ-EDPELEM(R5)                                        
         BNE   XPUT20              LOOK FOR THE ELEMENT BEING CHANGED           
*                                                                               
         CLC   EDPPROG,EDPPROG-EDPELEM(R5)                                      
         BE    XPUT40              PROGTYPE DIDN'T CHANGE - NSID IS OK          
         MVC   EDPPROG,EDPPROG-EDPELEM(R5)                                      
         B     XPUT30              MUST UPDATE NSID FOR PROGTYPE                
*                                                                               
XPUT20   BAS   RE,NEXTEL                                                        
         BE    XPUT10                                                           
         DC    H'0'                MUST BE THERE                                
         DROP  R6                                                               
*                                                                               
XPUT30   GOTO1 PUTREC              UPDATE THE NSID RECORD                       
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
XPUT40   CLI   SVUSECMP,C'Y'       TEST COMPETITION USER                        
         BNE   XPUTX               NO                                           
         CLI   QSTANEW,X'F0'       LOCAL CABLE STATION?                         
         BNL   XPUTX               YES -- IGNORE COMPETITION                    
*                                                                               
         MVC   WORK(13),KEY        NSID KEY                                     
         XC    KEY,KEY                                                          
         LA    R6,KEY              BUILD COMPETITION KEY                        
         USING COMPRECD,R6                                                      
*                                                                               
         LA    R4,WORK             NSID KEY                                     
         USING SIRRECD,R4                                                       
         MVI   CMPKTYP,CMPKTYPQ    RECORD TYPE                                  
         MVI   CMPKFIL,CMPKFILQ                                                 
         MVC   CMPKAM,SIRKAM       A/M                                          
         ZIC   R1,SIRKYEAR                                                      
         X     R1,=X'000000FF'     MAKE YEAR POSITIVE                           
         CVD   R1,DUB                                                           
         MVC   CMPKYM,DUB+7        ONE'S DIGIT OF YEAR                          
         MVN   CMPKYM,SIRKMON      PERIOD NUMBER                                
         MVC   CMPKCODE,SIRKCODE   SCHEME                                       
         MVC   CMPKMKT,SIRKMKT     MARKET                                       
         MVC   CMPKDAY,DAY         DAY CODE                                     
         MVC   CMPKSTIM,TIME       START TIME                                   
         MVC   CMPKETIM,TIME+2     END TIME                                     
         DROP  R4,R6                                                            
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR COMPETITION KEY                     
         CLC   KEY(13),KEYSAVE     TEST RECORD IS THERE                         
         BNE   XPUTX               NO - LEAVE                                   
*                                                                               
         GOTO1 GETREC              COMPETITION RECORD IN IO2                    
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO              BEGINNING OF COMP RECORD                     
         MVI   ELCODE,CMSCODEQ     LOOK FOR STATION ELEMENT                     
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R4,1                LOOK THROUGH UP TO 20 STATIONS               
         LA    R6,2(R6)            BUMP TO FIRST STATION                        
XPUT50   CLC   QSTANEW,0(R6)       TEST MATCH ON STATION                        
         BE    XPUT60              YES                                          
         LA    R6,5(R6)            BUMP TO NEXT STATION                         
         LA    R4,1(R4)            R4 = STATION INDEX NUMBER                    
         CH    R4,=H'21'           TEST AGAINST MAXIMUM                         
         BNE   XPUT50              NOT THERE YET                                
         B     XPUTX               STATION IS NOT IN ELEMENT                    
*                                                                               
XPUT60   L     R6,AIO              BEGINNING OF COMP RECORD                     
         MVI   ELCODE,CMPCODEQ     LOOK FOR PROGRAMMING ELEMENT                 
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING CMPEL,R6                                                         
XPUT70   MVC   BYTE,CMPSEQ                                                      
         NI    BYTE,X'7F'          TURN OFF OVERRIDE BIT IF IT'S ON             
         CLM   R4,1,BYTE           TEST PROGRAM FOR THIS STATION                
         BE    *+14                YES                                          
         BAS   RE,NEXTEL           NO - TRY NEXT                                
         BE    XPUT70                                                           
         DC    H'0'                NO PROGRAM FOR THIS STATION                  
         MVC   CMPPROG,SRDPGM      PUT PROGRAM IN ELEMENT                       
         DROP  R6                                                               
*                                                                               
         GOTO1 PUTREC              UPDATE THE COMPETITION RECORD                
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
XPUTX    MVC   AIO,AIO1            DETAIL RECORD                                
         BAS   RE,DR               DISPLAY RECORD                               
         B     XIT                                                              
         EJECT                                                                  
* UPDATE OR CREATE NSID RECORD AFTER ADDREC (AND UPDATE COMPETITION)            
*                                                                               
XADD     XC    KEY,KEY             LOOK FOR THE KEY WE JUST ADDED               
         MVC   KEY(13),SAVEKEY                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 GETREC              GET THE NEWLY ADDED RECORD                   
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING SIRREC,R6                                                        
         L     R6,AIO              DETAIL RECORD                                
         MVC   YEAR,SIRKYEAR                                                    
         DROP  R6                                                               
*                                                                               
         USING EDPELEM,R6                                                       
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENT                             
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         ZIC   R1,EDPLEN           PUT ELEMENT IN ELEM                          
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELEM(0),EDPELEM                                                  
         LA    R6,ELEM                                                          
*                                                                               
         MVC   AIO,AIO2            USE AIO2 FOR NSID RECORD                     
         CLI   ADDFLAG,C'Y'        TEST WE WILL DO AN ADDREC                    
         BE    XADD5               YES                                          
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(13),SVNSIDKY    BUILD NSID KEY                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR NSID RECORD                         
         CLC   KEY(13),KEYSAVE     TEST IT IS THERE                             
         BE    XADD20              BETTER BE THERE                              
         DC    H'0'                                                             
*                                                                               
XADD5    OC    SVNSIDKY,SVNSIDKY   TEST BRAND NEW NSID RECORD                   
         BZ    XADD10              YES                                          
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(13),SVNSIDKY    USE THIS NSID KEY                            
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR THE NSID RECORD                     
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                BETTER BE THERE                              
*                                                                               
         GOTO1 GETREC              GET THE OLD NSID RECORD                      
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING SIRREC,R5                                                        
         L     R5,AIO                                                           
         MVC   SIRKYEAR,YEAR       BUT USE THE GIVEN YEAR                       
         B     XADD30                                                           
*                                                                               
XADD10   L     R5,AIO              BUILD NEW NSID RECORD                        
         XC    0(256,R5),0(R5)     CLEAR I/O AREA                               
         MVC   SIRKEY,SAVEKEY      DETAIL KEY                                   
         MVI   SIRKSEQ,0           WITHOUT SEQUENCE NO.                         
         MVC   SIRRLEN,=H'24'      RECORD LENGTH                                
         DROP  R5                                                               
*                                                                               
         LA    R6,ELEM                                                          
         MVI   EDPINDEX,1          THE SORTING SEQUENCE NO.                     
         GOTO1 ADDELEM             ADD NSID ELEMENT                             
         GOTO1 ADDREC              ADD NEW NSID RECORD                          
         CLI   DMCB+8,0                                                         
         BE    XADD130                                                          
         DC    H'0'                                                             
*                                                                               
XADD20   GOTO1 GETREC              GET THE NSID RECORD                          
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
XADD30   L     R6,AIO                                                           
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENT                             
         BAS   RE,GETEL                                                         
         BE    XADD50                                                           
*                                                                               
         LA    R6,ELEM                                                          
         MVI   EDPINDEX,1          THE SORTING SEQUENCE NO.                     
         GOTO1 ADDELEM             ADD NSID ELEMENT                             
*                                                                               
         CLI   ADDFLAG,C'Y'                                                     
         BNE   XADD40                                                           
         GOTO1 ADDREC              THIS COPIES A NEW RECORD TO NEW YEAR         
         CLI   DMCB+8,0                                                         
         BE    XADD130                                                          
         DC    H'0'                                                             
*                                                                               
XADD40   GOTO1 PUTREC              THIS UPDATES AN EXISTING RECORD              
         CLI   DMCB+8,0                                                         
         BE    XADD130                                                          
         DC    H'0'                                                             
*                                                                               
XADD50   LA    R5,ELEM             PREPARE ELEM FOR SORTING CHECK               
         MVI   INDEX,1                                                          
         XI    EDPDAY-EDPELEM(R5),X'FF'                                         
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,EDPSTRT-EDPELEM(R5)                                         
         CH    R0,=H'600'                                                       
         BNL   *+12                                                             
         AH    R0,=H'2400'                                                      
         STCM  R0,3,EDPSTRT-EDPELEM(R5)                                         
*                                                                               
         OC    EDPENDT-EDPELEM(2,R5),EDPENDT-EDPELEM(R5)                        
         BZ    XADD60                                                           
         CLC   =C'CC',EDPENDT-EDPELEM(R5)                                       
         BE    XADD60                                                           
         ICM   R0,3,EDPENDT-EDPELEM(R5)                                         
         CH    R0,=H'600'                                                       
         BNL   XADD60                                                           
         AH    R0,=H'2400'                                                      
         STCM  R0,3,EDPENDT-EDPELEM(R5)                                         
*                                                                               
XADD60   XC    WORK,WORK                                                        
         ZIC   R1,1(R6)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),0(R6)       PUT THE ELEMENT IN WORK                      
*                                                                               
         LA    R3,WORK                                                          
         XI    EDPDAY-EDPELEM(R3),X'FF'  PUT BYTES IN SORTING ORDER             
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,EDPSTRT-EDPELEM(R3)                                         
         CH    R0,=H'600'                                                       
         BNL   *+12                                                             
         AH    R0,=H'2400'                                                      
         STCM  R0,3,EDPSTRT-EDPELEM(R3)                                         
*                                                                               
         OC    EDPENDT-EDPELEM(2,R3),EDPENDT-EDPELEM(R3)                        
         BZ    XADD65                                                           
         CLC   =C'CC',EDPENDT-EDPELEM(R3)                                       
         BE    XADD65                                                           
         ICM   R0,3,EDPENDT-EDPELEM(R3)                                         
         CH    R0,=H'600'                                                       
         BNL   *+12                                                             
         AH    R0,=H'2400'                                                      
         STCM  R0,3,EDPENDT-EDPELEM(R3)                                         
*                                                                               
XADD65   CLC   EDPDAY-EDPELEM(5,R5),EDPDAY-EDPELEM(R3)                          
         BL    XADD70              PUT ELEMENT RIGHT HERE                       
*                                                                               
         BH    *+14                ELEMENT OCCURS LATER ON                      
         MVC   EDPPROG,EDPPROG-EDPELEM(R5)                                      
         B     XADD90              DAY/TIME IS ALREADY THERE                    
*                                                                               
         ZIC   R1,INDEX            TRY NEXT ELEMENT                             
         LA    R1,1(R1)                                                         
         STC   R1,INDEX                                                         
         BAS   RE,NEXTEL                                                        
         BE    XADD60                                                           
         B     XADD80              ELEMENT GOES IN LAST POSITION                
*                                                                               
XADD70   ZIC   R1,EDPINDEX         INCREMENT ALL SUCCEEDING SEQ NOS.            
         LA    R1,1(R1)                                                         
         STC   R1,EDPINDEX                                                      
         BAS   RE,NEXTEL                                                        
         BE    XADD70                                                           
*                                                                               
XADD80   LA    R6,ELEM                                                          
         XI    EDPDAY,X'FF'        RESET DAYCODE TO NORMAL                      
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,EDPSTRT        RESET START TIME TO NORMAL                   
         CH    R0,=H'2400'                                                      
         BNH   *+12                                                             
         SH    R0,=H'2400'                                                      
         STCM  R0,3,EDPSTRT                                                     
*                                                                               
         CLC   =C'CC',EDPENDT                                                   
         BE    XADD85                                                           
         ICM   R0,3,EDPENDT        RESET END TIME TO NORMAL                     
         CH    R0,=H'2400'                                                      
         BNH   XADD85                                                           
         SH    R0,=H'2400'                                                      
         STCM  R0,3,EDPENDT                                                     
*                                                                               
XADD85   MVC   EDPINDEX,INDEX      THE SORTING SEQUENCE NO.                     
         GOTO1 ADDELEM             ADD NSID ELEMENT                             
*                                                                               
XADD90   CLI   ADDFLAG,C'Y'                                                     
         BNE   XADD120                                                          
         GOTO1 ADDREC              THIS COPIES A NEW RECORD                     
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO2             BEGINNING OF NEW NSID RECORD                 
         MVC   SVNSIDKY,0(R6)      DETAIL KEY W/OUT SEQ. NO.                    
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENT                             
         BAS   RE,GETEL                                                         
         BE    *+6                 MUST BE AT LEAST ONE (ACTUALLY, TWO)         
         DC    H'0'                                                             
         MVC   AIO,AIO3            USE AIO3 FOR NEW DETAIL RECORDS              
*                                                                               
XADD100  XC    KEY,KEY                                                          
         USING SIRREC,R5                                                        
         LA    R5,KEY                                                           
         MVC   SIRKEY,SVNSIDKY                                                  
         MVC   SIRKSEQ,EDPSEQ      USE SEQ. NO. FROM NSID ELEMENT               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST THE RECORD IS THERE                     
         BE    XADD110                                                          
*                                                                               
         L     R5,AIO                                                           
         XC    0(256,R5),0(R5)                                                  
         MVC   SIRKEY,KEYSAVE      BUILD THE DETAIL RECORD KEY                  
         MVC   SIRRLEN,=H'24'                                                   
         DROP  R5                                                               
*                                                                               
         ZIC   R1,EDPLEN           PUT ELEMENT IN ELEM                          
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELEM(0),EDPELEM                                                  
         MVI   ELEM+2,0            NO SORTING SEQ. NO. IN DETAIL RECORD         
         GOTO1 ADDELEM                                                          
         GOTO1 ADDREC              ADD THE NEW DETAIL RECORD                    
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
XADD110  MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENT                             
         BAS   RE,NEXTEL                                                        
         BE    XADD100                                                          
         B     XADD130             NO MORE - LEAVE                              
         DROP  R6                                                               
*                                                                               
XADD120  GOTO1 PUTREC              THIS UPDATES AN EXISTING RECORD              
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
XADD130  CLI   SVUSECMP,C'Y'       TEST COMPETITION USER                        
         BNE   XADDX               NO                                           
         CLI   QSTANEW,X'F0'       LOCAL CABLE STATION?                         
         BNL   XADDX               YES -- IGNORE COMPETITION                    
*                                                                               
         MVC   WORK(13),KEY        NSID KEY                                     
         XC    KEY,KEY                                                          
         LA    R6,KEY              BUILD COMPETITION KEY                        
         USING COMPRECD,R6                                                      
*                                                                               
         LA    R4,WORK             NSID KEY                                     
         USING SIRRECD,R4                                                       
         MVI   CMPKTYP,CMPKTYPQ    RECORD TYPE                                  
         MVI   CMPKFIL,CMPKFILQ                                                 
         MVC   CMPKAM,SIRKAM       A/M                                          
         ZIC   R1,SIRKYEAR                                                      
         X     R1,=X'000000FF'     MAKE YEAR POSITIVE                           
         CVD   R1,DUB                                                           
         MVC   CMPKYM,DUB+7        ONE'S DIGIT OF YEAR                          
         MVN   CMPKYM,SIRKMON      PERIOD NUMBER                                
         MVC   CMPKCODE,SIRKCODE   SCHEME                                       
         MVC   CMPKMKT,SIRKMKT     MARKET                                       
         MVC   CMPKDAY,DAY         DAY CODE                                     
         MVC   CMPKSTIM,TIME       START TIME                                   
         MVC   CMPKETIM,TIME+2     END TIME                                     
         DROP  R4,R6                                                            
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR COMPETITION KEY                     
         CLC   KEY(13),KEYSAVE     TEST RECORD IS THERE                         
         BNE   XADDX               NO - LEAVE                                   
*                                                                               
         MVC   AIO,AIO2                                                         
         GOTO1 GETREC              COMPETITION RECORD IN IO2                    
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO              BEGINNING OF COMP RECORD                     
         MVI   ELCODE,CMSCODEQ     LOOK FOR STATION ELEMENT                     
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R4,1                LOOK THROUGH UP TO 20 STATIONS               
         LA    R6,2(R6)            BUMP TO FIRST STATION                        
XADD140  CLC   QSTANEW,0(R6)       TEST MATCH ON STATION                        
         BE    XADD150             YES                                          
         LA    R6,5(R6)            BUMP TO NEXT STATION                         
         LA    R4,1(R4)            R4 = STATION INDEX NUMBER                    
         CH    R4,=H'21'           TEST AGAINST MAXIMUM                         
         BNE   XADD140             NOT THERE YET                                
         B     XADDX               STATION IS NOT IN ELEMENT                    
*                                                                               
XADD150  L     R6,AIO              BEGINNING OF COMP RECORD                     
         MVI   ELCODE,CMPCODEQ     LOOK FOR PROGRAMMING ELEMENT                 
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING CMPEL,R6                                                         
XADD160  MVC   BYTE,CMPSEQ                                                      
         NI    BYTE,X'7F'          TURN OFF OVERRIDE BIT IF IT'S ON             
         CLM   R4,1,BYTE           TEST PROGRAM FOR THIS STATION                
         BE    *+14                YES                                          
         BAS   RE,NEXTEL           NO - TRY NEXT                                
         BE    XADD160                                                          
         DC    H'0'                NO PROGRAM FOR THIS STATION                  
         MVC   CMPPROG,SRDPGM      PUT PROGRAM IN ELEMENT                       
         DROP  R6                                                               
*                                                                               
         GOTO1 PUTREC              UPDATE THE COMPETITION RECORD                
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
XADDX    MVC   AIO,AIO1            DETAIL RECORD                                
         NI    GENSTAT1,X'FF'-OKADDEL                                           
         BAS   RE,DR               DISPLAY DETAIL RECORD                        
         B     XIT                                                              
         EJECT                                                                  
* UPDATE NSID RECORD AFTER DELETING DETAIL RECORD                               
*                                                                               
XDELETE  L     R6,AIO              DETAIL RECORD                                
         LA    R5,KEY                                                           
         XC    KEY,KEY             BUILD NSID KEY                               
         USING SIRKEY,R5                                                        
         MVC   SIRKEY,0(R6)        DETAIL KEY                                   
         MVI   SIRKSEQ,0           WITHOUT SEQUENCE NUMBER                      
         DROP  R5                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR NSID RECORD                         
         CLC   KEY(13),KEYSAVE     BETTER BE THERE                              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   AIO,AIO2            USE AIO2 FOR NSID RECORD                     
         GOTO1 GETREC              GET THE NSID RECORD                          
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EDPCODEQ                                                  
         BAS   RE,GETEL            LOOK FOR DAY/TIME ELEMENTS                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING EDPELEM,R6                                                       
XDEL10   CLC   EDPSEQ,SEQNUM       FIND THE ELEMENT TO BE DELETED               
         BE    *+14                HERE IT IS                                   
         BAS   RE,NEXTEL           TRY AGAIN                                    
         BE    XDEL10                                                           
         DC    H'0'                IT'S GOT TO BE THERE                         
         MVI   EDPCODE,X'FF'       MARK ELEMENT FOR DELETION                    
*                                                                               
         L     R6,AIO              BEGINNING OF NSID RECORD                     
         MVI   ELCODE,X'FF'                                                     
         GOTO1 REMELEM             DELETE THE ELEMENT                           
*                                                                               
         L     R6,AIO                                                           
         LA    R3,1                COUNT THE SORTING SEQUENCE NOS.              
         MVI   ELCODE,EDPCODEQ                                                  
         BAS   RE,GETEL                                                         
         BNE   XDELX                                                            
*                                                                               
XDEL20   STC   R3,EDPINDEX         UPDATE THE SORTING SEQUENCE NOS.             
         BAS   RE,NEXTEL                                                        
         BNE   XDELX                                                            
         LA    R3,1(R3)                                                         
         B     XDEL20                                                           
         DROP  R6                                                               
*                                                                               
XDELX    GOTO1 PUTREC              UPDATE THE NSID RECORD                       
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   AIO,AIO1            RESTORE AIO TO DETAIL RECORD                 
         B     XIT                 DON'T DISPLAY THE DELETED RECORD             
         EJECT                                                                  
* UPDATE NSID RECORD AFTER RESTORING DETAIL RECORD                              
*                                                                               
XRESTORE XC    KEY,KEY             LOOK FOR THE KEY WE JUST RESTORED            
         MVC   KEY(13),SAVEKEY                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 GETREC              GET NEWLY RESTORED DETAIL RECORD             
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         USING EDPELEM,R6                                                       
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENT                             
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         ZIC   R1,EDPLEN           PUT ELEMENT IN ELEM                          
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELEM(0),EDPELEM                                                  
         LA    R6,ELEM                                                          
*                                                                               
         LA    R5,KEY                                                           
         USING SIRKEY,R5                                                        
         XC    KEY,KEY             BUILD NSID KEY                               
         L     R6,AIO                                                           
         MVC   SIRKEY,0(R6)        DETAIL KEY                                   
         MVI   SIRKSEQ,0           WITHOUT SEQUENCE NUMBER                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR NSID RECORD                         
         CLC   KEY(13),KEYSAVE     TEST IT IS THERE                             
         BE    *+6                 YES                                          
         DC    H'0'                                                             
         DROP  R5                                                               
*                                                                               
         MVC   AIO,AIO2            USE AIO2 FOR NSID RECORD                     
         GOTO1 GETREC              GET THE NSID RECORD                          
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENT                             
         BAS   RE,GETEL                                                         
         BE    XREST10                                                          
*                                                                               
         LA    R6,ELEM                                                          
         MVI   EDPINDEX,1          THE SORTING SEQUENCE NO.                     
         GOTO1 ADDELEM             ADD NSID ELEMENT                             
         B     XRESTX                                                           
*                                                                               
XREST10  LA    R5,ELEM             PREPARE ELEM FOR SORTING CHECK               
         MVI   INDEX,1                                                          
         XI    EDPDAY-EDPELEM(R5),X'FF'                                         
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,EDPSTRT-EDPELEM(R5)                                         
         CH    R0,=H'600'                                                       
         BNL   *+12                                                             
         AH    R0,=H'2400'                                                      
         STCM  R0,3,EDPSTRT-EDPELEM(R5)                                         
*                                                                               
         OC    EDPENDT-EDPELEM(2,R5),EDPENDT-EDPELEM(R5)                        
         BZ    XREST20                                                          
         CLC   =C'CC',EDPENDT-EDPELEM(R5)                                       
         BE    XREST20                                                          
         ICM   R0,3,EDPENDT-EDPELEM(R5)                                         
         CH    R0,=H'600'                                                       
         BNL   XREST20                                                          
         AH    R0,=H'2400'                                                      
         STCM  R0,3,EDPENDT-EDPELEM(R5)                                         
*                                                                               
XREST20  XC    WORK,WORK                                                        
         ZIC   R1,1(R6)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),0(R6)       PUT THE ELEMENT IN WORK                      
*                                                                               
         LA    R3,WORK                                                          
         XI    EDPDAY-EDPELEM(R3),X'FF'  PUT BYTES IN SORTING ORDER             
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,EDPSTRT-EDPELEM(R3)                                         
         CH    R0,=H'600'                                                       
         BNL   *+12                                                             
         AH    R0,=H'2400'                                                      
         STCM  R0,3,EDPSTRT-EDPELEM(R3)                                         
*                                                                               
         OC    EDPENDT-EDPELEM(2,R3),EDPENDT-EDPELEM(R3)                        
         BZ    XREST25                                                          
         CLC   =C'CC',EDPENDT-EDPELEM(R3)                                       
         BE    XREST25                                                          
         ICM   R0,3,EDPENDT-EDPELEM(R3)                                         
         CH    R0,=H'600'                                                       
         BNL   XREST25                                                          
         AH    R0,=H'2400'                                                      
         STCM  R0,3,EDPENDT-EDPELEM(R3)                                         
*                                                                               
XREST25  CLC   EDPDAY-EDPELEM(5,R5),EDPDAY-EDPELEM(R3)                          
         BNE   *+6                 THE ELEMENT IS ALREADY THERE - DIE           
         DC    H'0'                                                             
         BL    XREST30             PUT ELEMENT RIGHT HERE                       
*                                                                               
         ZIC   R1,INDEX            ELEMENT OCCURS LATER ON                      
         LA    R1,1(R1)                                                         
         STC   R1,INDEX                                                         
         BAS   RE,NEXTEL                                                        
         BE    XREST20                                                          
         B     XREST40             ELEMENT GOES IN LAST POSITION                
*                                                                               
XREST30  ZIC   R1,EDPINDEX         INCREMENT ALL SUCCEEDING SEQ NOS.            
         LA    R1,1(R1)                                                         
         STC   R1,EDPINDEX                                                      
         BAS   RE,NEXTEL                                                        
         BE    XREST30                                                          
*                                                                               
XREST40  LA    R6,ELEM                                                          
         XI    EDPDAY,X'FF'        RESET DAYCODE TO NORMAL                      
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,EDPSTRT        RESET START TIME TO NORMAL                   
         CH    R0,=H'2400'                                                      
         BNH   *+12                                                             
         SH    R0,=H'2400'                                                      
         STCM  R0,3,EDPSTRT                                                     
*                                                                               
         CLC   =C'CC',EDPENDT                                                   
         BE    XREST50                                                          
         ICM   R0,3,EDPENDT        RESET END TIME TO NORMAL                     
         CH    R0,=H'2400'                                                      
         BNH   XREST50                                                          
         SH    R0,=H'2400'                                                      
         STCM  R0,3,EDPENDT                                                     
*                                                                               
XREST50  MVC   EDPINDEX,INDEX      THE SORTING SEQUENCE NO.                     
         GOTO1 ADDELEM             ADD NSID ELEMENT                             
         DROP  R6                                                               
*                                                                               
XRESTX   GOTO1 PUTREC              UPDATE THE NSID RECORD                       
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   AIO,AIO1            RESTORE AIO                                  
         BAS   RE,DR               DISPLAY THE RESTORED RECORD                  
         B     XIT                                                              
         EJECT                                                                  
* DISPLAY DETAIL KEY ON SELECT                                                  
*                                                                               
DK       NTR1                                                                   
*                                                                               
         LA    R2,CONRECH          PROTECT ALL KEY FIELDS                       
         LA    R3,SRDCST1H                                                      
DK10     OI    1(R2),FATBPROT      PROTECT                                      
         NI    1(R2),X'FF'-FATBMOD UNMODIFY                                     
         ZIC   R0,0(R2)            BUMP                                         
         AR    R2,R0                                                            
         CR    R2,R3                                                            
         BL    DK10                                                             
*                                                                               
         MVC   CONHEAD(17),=C'Now enter changes'                                
         OI    CONHEADH+6,FOUTTRN  XMIT                                         
         OI    CONSERVH+6,FOUTTRN+FOUTMOD   SET MODIFIED BIT AND XMIT           
         OI    SRDCST1H+6,FOUTCUR  POSITION CURSOR                              
         CLI   SVUSECMP,C'Y'       TEST COMPETITION USER                        
         BE    *+14                                                             
         MVC   SRDPF(24),=C'ENTER=NEXT SEL PF12=QUIT'                           
         B     *+10                                                             
         MVC   SRDPF(41),=C'ENTER=NEXT SEL PF1=COMP PF2=CES PF12=QUIT'          
         OI    SRDPFH+6,FOUTTRN    XMIT                                         
*                                                                               
         MVC   AIO,AIO2            DETAIL RECORD IS IN IO2                      
         L     R4,AIO                                                           
         USING SIRREC,R4                                                        
*                                                                               
         LA    R2,SRDSTAH          DISPLAY STATION                              
         XC    WORK,WORK                                                        
         GOTO1 MSUNPK,DMCB,(X'80',SIRKMS),WORK,8(R2)                            
         OI    6(R2),FOUTTRN       XMIT                                         
         CLI   8(R2),X'F0'         CABLE HEADEND?                               
         BL    *+8                                                              
         MVI   12(R2),C'/'         YES                                          
         BAS   RE,FUDGEINP         FUDGE INPUT LENGTH                           
*                                                                               
         MVC   SRDDPT,SIRKDPT      DISPLAY DAYPART                              
         OI    SRDDPTH+6,FOUTTRN   XMIT                                         
         MVI   SRDDPTH+5,1         FUDGE INPUT LENGTH                           
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EDPCODEQ     DAY/TIME ELEMENT                             
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING EDPELEM,R6                                                       
         LA    R2,SRDDAYH          DISPLAY DAY                                  
         GOTO1 UNDAY,DMCB,EDPDAY,8(R2)                                          
         OI    6(R2),FOUTTRN       XMIT                                         
         MVC   DAY,EDPDAY          HANG ON TO DAY                               
         BAS   RE,FUDGEINP         FUDGE INPUT LENGTH                           
*                                                                               
         LA    R2,SRDTIMEH         DISPLAY TIME                                 
         GOTO1 UNTIME,DMCB,EDPTIME,8(R2)                                        
         OI    6(R2),FOUTTRN       XMIT                                         
         MVC   TIME,EDPTIME        HANG ON TO TIME                              
         BAS   RE,FUDGEINP         FUDGE INPUT LENGTH                           
         DROP  R6                                                               
*                                                                               
         XC    SRDPER,SRDPER                                                    
         OI    SRDPERH+6,FOUTTRN   XMIT PERIOD NAME                             
         MVI   PERNUM,0                                                         
         MVN   PERNUM,SIRKMON      HANG ON TO PERIOD NUMBER                     
*                                                                               
         XC    SRDDPER,SRDDPER                                                  
         OI    SRDDPERH+6,FOUTTRN  XMIT PERIOD DATES                            
*                                                                               
         XC    KEY,KEY             BUILD SCHEME KEY                             
         MVC   KEY(13),0(R4)                                                    
         LA    R4,KEY                                                           
         XC    SIRKMS(9),SIRKMS                                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR SCHEME KEY                          
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+12                                                             
         MVI   ERROR,NOSCHM                                                     
         B     TRAPERR                                                          
*                                                                               
         MVC   AIO,AIO3            USE IO3 FOR SCHEME RECORD                    
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EPNCODEQ     LOOK AT PERIOD NAMES ELEMENT                 
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R2,SRDPERH          DISPLAY PERIOD NAME                          
         LA    R6,2(R6)            GO PAST OVERHEAD                             
DK20     CLC   PERNUM,0(R6)        TEST MATCH ON PERIOD                         
         BE    *+12                                                             
         LA    R6,5(R6)            NEXT PERIOD                                  
         B     DK20                                                             
         MVC   8(L'SRDPER,R2),1(R6)                                             
*                                                                               
         L     R4,AIO2             DETAIL RECORD                                
         XC    KEY,KEY             BUILD PERIOD KEY                             
         MVC   KEY(13),0(R4)                                                    
         LA    R4,KEY                                                           
         XC    SIRKMS,SIRKMS                                                    
         MVI   SIRKDPT,0                                                        
         MVI   SIRKSEQ,0                                                        
         MVI   SIRKMON,0                                                        
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR PERIOD KEY                          
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+16                                                             
         LA    R2,SRDPERH                                                       
         MVI   ERROR,NOPERREC                                                   
         B     TRAPERR                                                          
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC              USE IO3 FOR PERIOD RECORD                    
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EPDCODEQ     LOOK FOR PERIOD DEFINITION ELEMENT           
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING EPDELEM,R6                                                       
DK30     CLC   PERNUM,EPDNUM       TEST MATCH ON PERIOD NUMBER                  
         BE    DK35                                                             
         BAS   RE,NEXTEL                                                        
         BE    DK30                                                             
         LA    R2,SRDPERH                                                       
         MVI   ERROR,INVBUYP                                                    
         B     TRAPERR                                                          
*                                                                               
DK35     BAS   RE,FUDGEINP         FUDGE INPUT LENGTH                           
         GOTO1 DATCON,DMCB,(3,EPDSTART),(5,SRDDPER)                             
         GOTO1 DATCON,DMCB,(3,EPDEND),(5,SRDDPER+9)                             
         MVI   SRDDPER+8,C'-'                                                   
         DROP  R6                                                               
*                                                                               
         MVC   AIO,AIO2            RESTORE AIO                                  
         L     R4,AIO                                                           
         MVC   BYTE,SIRKYEAR       YEAR IN 1'S COMPLEMENT                       
         XI    BYTE,X'FF'                                                       
         MVC   FULL(1),BYTE                                                     
         MVC   FULL+1(2),=X'0101'  PRETEND IT'S JAN01                           
         GOTO1 DATCON,DMCB,(3,FULL),(20,DUB)                                    
         MVC   SRDYR,DUB+2         PRINTABLE YY                                 
         OI    SRDYRH+6,FOUTTRN    XMIT                                         
         MVI   SRDYRH+5,2          FUDGE INPUT LENGTH                           
         OI    SRDYRH+4,FINPNUM    FUDGE NUMERIC                                
*                                                                               
         LA    R2,SRDSCHH          DISPLAY SCHEME                               
         OC    SIRKCODE,SIRKCODE   TEST SCHEME 'ALL'                            
         BNZ   *+14                                                             
         MVC   8(3,R2),=C'ALL'                                                  
         B     DK40                                                             
         GOTO1 CLUNPK,DMCB,SIRKCODE,8(R2)                                       
*                                                                               
DK40     OI    6(R2),FOUTTRN       XMIT                                         
         BAS   RE,FUDGEINP         FUDGE INPUT LENGTH                           
         DROP  R4                                                               
*                                                                               
DKX      MVC   AIO,AIO1            RESTORE AIO                                  
         B     XIT                                                              
         SPACE 5                                                                
FUDGEINP ZIC   RF,0(R2)            FIELD LENGTH                                 
         SH    RF,=H'16'           MINUS (HEADER + EXTENSION)                   
         STC   RF,5(R2)            ASSUME INPUT LENGTH IS MAXIMUM               
*                                                                               
         ZIC   RF,0(R2)            FIELD LENGTH                                 
         AR    RF,R2               BUMP TO NEXT FIELD                           
         SH    RF,=H'9'            BACK UP JUST BEFORE EXTENSION                
         LA    R0,8(R2)            A(BEGINNING OF FIELD)                        
*                                                                               
FUDGEIN5 CLI   0(RF),C' '          TEST THERE'S A CHARACTER THERE               
         BH    FUDGEINX            YES - LEAVE                                  
         MVI   0(RF),0             REPLACE WHATEVER'S THERE WITH NULL           
         ZIC   R1,5(R2)                                                         
         BCTR  R1,0                                                             
         STC   R1,5(R2)            DECREMENT INPUT LENGTH                       
         BCTR  RF,0                BACK UP ONE CHARACTER                        
*                                                                               
         CR    RF,R0               TEST WE'VE BACKED UP PAST THE FIELD          
         BNL   FUDGEIN5            NO                                           
         DC    H'0'                                                             
*                                                                               
FUDGEINX BR    RE                                                               
         EJECT                                                                  
* DISPLAY RECORD                                                                
*                                                                               
DR       NTR1                                                                   
*                                                                               
         LA    R2,SRDCST1H         CLEAR SCREEN                                 
DR10     TM    1(R2),FATBPROT      IS IT A PROTECTED FIELD                      
         BO    DR20                                                             
         ZIC   RF,0(R2)            RF HAS LENGTH OF FIELD                       
         SH    RF,=H'9'            SUBTRACT HEADER LENGTH +1                    
         TM    1(R2),FATBXHDR      TEST EXTENDED HEADER                         
         BZ    *+8                                                              
         SH    RF,=H'8'                                                         
*                                                                               
         EX    RF,*+8              PAD WITH BLANKS                              
         B     *+10                                                             
         OC    8(0,R2),=80X'40'                                                 
         EX    RF,*+8              TEST FIELD EMPTY                             
         B     *+10                                                             
         CLC   8(0,R2),=80X'40'                                                 
         BE    DR20                YES                                          
         EX    RF,*+8              NO - CLEAR FIELD                             
         B     *+10                                                             
         XC    8(0,R2),8(R2)                                                    
         OI    6(R2),FOUTTRN       XMIT                                         
*                                                                               
DR20     ZIC   R0,0(R2)            BUMP                                         
         AR    R2,R0                                                            
         CLI   0(R2),0             TEST END OF SCREEN                           
         BNE   DR10                                                             
*                                                                               
         TM    SRDDEMOH+1,FATBPROT DEMO FIELDS ARE PROTECTED?                   
         BZ    DR23                NO                                           
*                                                                               
         LA    R2,SRDDEMOH                                                      
         LA    R3,3                3 LINES OF DEMO OVERRIDES                    
DR22     XC    8(L'SRDDEMO,R2),8(R2)                                            
         OI    6(R2),FOUTTRN       CLEAR AND XMIT                               
         ZIC   R0,0(R2)                                                         
         AR    R2,R0                                                            
         BCT   R3,DR22                                                          
*                                                                               
DR23     L     R6,AIO              LOOK FOR COST ELEMENTS                       
         MVI   ELCODE,EECCODEQ                                                  
         BAS   RE,GETEL                                                         
         BNE   DR40                THERE ARE NONE                               
*                                                                               
         MVI   INDEX,1                                                          
         LA    R2,SRDCST1H         FIRST SLN FIELD IS PROTECTED                 
         B     DR30                                                             
*                                                                               
         USING EECELEM,R6                                                       
DR25     EDIT  EECSLN,(3,8(R2)),ALIGN=LEFT                                      
         OI    6(R2),FOUTTRN       SPOT LENGTH                                  
         ZIC   R0,0(R2)                                                         
         AR    R2,R0                                                            
*                                                                               
DR30     SR    R4,R4               COST                                         
         ICM   R5,15,EECCOST1                                                   
         D     R4,=F'100'                                                       
         EDIT  (R5),(5,WORK),ALIGN=LEFT,ZERO=NOBLANK                            
         MVC   8(5,R2),WORK                                                     
         OI    6(R2),FOUTTRN                                                    
         LA    R3,EECDATE2                                                      
*                                                                               
DR35     OC    0(3,R3),0(R3)       TEST DATE IS PRESENT                         
         BZ    DR37                YES                                          
*                                                                               
         ZIC   R0,0(R2)            EFFECTIVE DATE                               
         AR    R2,R0                                                            
         GOTO1 DATCON,DMCB,(3,0(R3)),(5,8(R2))                                  
         OI    6(R2),FOUTTRN                                                    
*                                                                               
         ZIC   R0,0(R2)            COST                                         
         AR    R2,R0                                                            
         SR    R4,R4                                                            
         ICM   R5,15,3(R3)                                                      
         D     R4,=F'100'                                                       
         EDIT  (R5),(5,WORK),ALIGN=LEFT,ZERO=NOBLANK                            
         MVC   8(5,R2),WORK                                                     
         OI    6(R2),FOUTTRN                                                    
*                                                                               
         LA    R1,EECDATE4         A(LAST DATE FOR SLN)                         
         CR    R3,R1               TEST ALL DATES ARE DONE                      
         BE    *+12                YES                                          
         LA    R3,7(R3)            BUMP TO NEXT DATE                            
         B     DR35                                                             
         DROP  R6                                                               
*                                                                               
DR37     BAS   RE,NEXTEL           TEST ANY MORE ROWS OF COSTS                  
         BNE   DR40                                                             
         CLI   INDEX,1             PUT CURSOR ON APPROPRIATE ROW                
         BNE   *+16                                                             
         MVI   INDEX,2                                                          
         LA    R2,SRDSLN2H                                                      
         B     DR25                                                             
*                                                                               
         CLI   INDEX,2                                                          
         BNE   *+16                                                             
         MVI   INDEX,3                                                          
         LA    R2,SRDSLN3H                                                      
         B     DR25                                                             
*                                                                               
         CLI   INDEX,3                                                          
         BE    DR40                                                             
         DC    H'0'                                                             
*                                                                               
DR40     XC    SRDDPRG,SRDDPRG     PROGTYPE NAME                                
         OI    SRDDPRGH+6,FOUTTRN                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EDPCODEQ     DAY/TIME/PROGTYPE ELEMENT                    
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING EDPELEM,R6                                                       
         CLI   EDPPROG,0           TEST ANY PROGRAM TYPE                        
         BE    DR60                NO                                           
*                                                                               
         LA    R2,SRDPRGH                                                       
         MVC   SRDPRG,EDPPROG      PROGTYPE CODE                                
         OI    SRDPRGH+6,FOUTTRN                                                
*                                                                               
         LA    R3,PRGTYPSV         LOOK FOR MATCH IN LIST                       
DR50     CLC   0(1,R3),SRDPRG                                                   
         BE    DR55                                                             
         LA    R3,8(R3)                                                         
         CLI   0(R3),0                                                          
         BNE   DR50                                                             
         MVI   ERROR,INVPRGTP                                                   
         B     TRAPERR                                                          
*                                                                               
DR55     MVC   SRDDPRG,1(R3)       DISPLAY PROGTYPE NAME                        
         DROP  R6                                                               
*                                                                               
DR60     L     R2,AIO2             USE AIO2 FOR DEMOS                           
         XC    0(200,R2),0(R2)                                                  
*                                                                               
         CLI   SVUSECMP,C'Y'       TEST COMPETITION USER                        
         BNE   DR70                NO                                           
         CLI   QSTANEW,X'F0'       LOCAL CABLE STATION?                         
         BNL   DR70                YES -- IGNORE COMPETITION                    
*                                                                               
         MVC   WORK(13),KEY        DETAIL KEY                                   
         XC    KEY,KEY                                                          
         LA    R6,KEY              BUILD COMPETITION KEY                        
         USING COMPRECD,R6                                                      
*                                                                               
         LA    R4,WORK                                                          
         USING SIRRECD,R4                                                       
         MVI   CMPKTYP,CMPKTYPQ    RECORD TYPE                                  
         MVI   CMPKFIL,CMPKFILQ                                                 
         MVC   CMPKAM,SIRKAM       A/M                                          
         ZIC   R1,SIRKYEAR                                                      
         X     R1,=X'000000FF'     MAKE YEAR POSITIVE                           
         CVD   R1,DUB                                                           
         MVC   CMPKYM,DUB+7        ONE'S DIGIT OF YEAR                          
         MVN   CMPKYM,SIRKMON      PERIOD NUMBER                                
         MVC   CMPKCODE,SIRKCODE   SCHEME                                       
         MVC   CMPKMKT,SIRKMKT     MARKET                                       
         MVC   CMPKDAY,DAY         DAY CODE                                     
         MVC   CMPKSTIM,TIME       START TIME                                   
         MVC   CMPKETIM,TIME+2     END TIME                                     
         DROP  R4,R6                                                            
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                LOOK FOR COMPETITION KEY                     
         CLC   KEY(13),KEYSAVE     TEST RECORD IS THERE                         
         BE    *+12                YES                                          
         MVI   STAINDEX,0          NO COMPETITION RECORD FOUND                  
         B     DR70                                                             
*                                                                               
         MVC   AIO,AIO3                                                         
         GOTO1 GETREC              GET COMPETITION RECORD                       
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO              BEGINNING OF COMP RECORD                     
         MVI   ELCODE,CMSCODEQ     LOOK FOR STATION ELEMENT                     
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R4,1                LOOK THROUGH UP TO 20 STATIONS               
         LA    R6,2(R6)            BUMP TO FIRST STATION                        
DR62     CLC   QSTANEW,0(R6)       TEST MATCH ON STATION                        
         BE    DR65                YES                                          
         LA    R6,5(R6)            BUMP TO NEXT STATION                         
         LA    R4,1(R4)            R4 = STATION INDEX NUMBER                    
         CH    R4,=H'21'           TEST AGAINST MAXIMUM                         
         BNE   DR62                NOT THERE YET                                
         MVC   AIO,AIO1            RESTORE AIO                                  
         B     DR75                STATION IS NOT IN ELEMENT                    
*                                                                               
DR65     STC   R4,STAINDEX         STATION INDEX NUMBER                         
         BCTR  R4,0                                                             
         MH    R4,=H'3'                                                         
         LA    R4,4(R4)            R4 = DISP TO DEMO FOR STATION                
*                                                                               
         L     R6,AIO              BEGINNING OF COMP RECORD                     
         MVI   ELCODE,CMDCODEQ     LOOK FOR DEMO ELEMENTS                       
         BAS   RE,GETEL                                                         
         BE    *+6                 MUST BE AT LEAST ONE                         
         DC    H'0'                                                             
*                                                                               
         L     R2,AIO2             USE AIO2 FOR DEMOS                           
         BAS   RE,CNVRTCMP         CONVERT TO PRINTABLE FORMAT                  
         BAS   RE,NEXTEL           LOOK FOR MORE DEMOS                          
         BE    *-8                                                              
*                                                                               
         MVC   AIO,AIO1            RESTORE AIO                                  
         B     DR75                DISPLAY ALL DEMOS                            
*                                                                               
DR70     L     R6,AIO              GET DEMOS FROM DETAIL RECORD                 
         MVI   ELCODE,EDOCODEQ                                                  
         BAS   RE,GETEL                                                         
         BNE   DR110                                                            
*                                                                               
         L     R2,AIO2             USE AIO2 FOR DEMOS                           
         BAS   RE,CNVRT            GOTO CONVERT BIN CODES TO NAMES              
         BAS   RE,NEXTEL                                                        
         BE    *-8                                                              
*                                                                               
DR75     L     R5,AIO2                                                          
         OC    0(10,R5),0(R5)      ANY DEMO OVERRIDES                           
         BNZ   *+12                                                             
         MVI   SRDDEMOH+5,0                                                     
         B     DR110                                                            
*                                                                               
* DIVIDE BLOCK OUTPUT AREA (MAX 60 BYTES)                                       
*                                                                               
         LA    R2,SRDDEMOH                                                      
DR80     LA    R3,60(R5)           R5 - START OF BLOCK AREA                     
         CLI   0(R3),C','          R3 - END OF BLOCK AREA                       
         BNE   DR90                                                             
         MVI   0(R3),C' '                                                       
         B     DR100                                                            
*                                                                               
DR90     BCTR  R3,0                                                             
         CR    R5,R3               R3 MUST NOT BE LESS THEN R5                  
         BL    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   0(R3),C','                                                       
         BNE   DR90                                                             
         MVI   0(R3),C' '                                                       
*                                                                               
DR100    LR    RE,R3               R3 - END OF BLOCK AREA                       
         SR    RE,R5               R5 - BEG OF BLOCK AREA                       
         STC   RE,5(R2)            MAKE THIS THE NEW INPUT LENGTH               
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   8(0,R2),0(R5)                                                    
         OI    6(R2),FOUTTRN       XMIT                                         
*                                                                               
         LA    R5,1(R3)            SET R5 TO BEG OF NEXT BLOCK AREA             
         OC    0(7,R5),=7X'40'                                                  
         CLC   0(7,R5),=7X'40'                                                  
         BE    DR110               NO MORE DATA                                 
*                                                                               
         ZIC   R0,0(R2)                                                         
         AR    R2,R0                                                            
         LA    R0,SRDDEMLH         A(LAST DEMO ROW)                             
         CR    R2,R0               TEST WE HAVE ROOM TO DISPLAY MORE            
         BNH   DR80                YES                                          
*                                                                               
DR110    MVC   SRDDUPG,SVDEFUPG    DEFAULT UPGRADE                              
         OI    SRDDUPGH+6,FOUTTRN                                               
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,EUPCODEQ     UPGRADE ELEMENT                              
         BAS   RE,GETEL                                                         
         BNE   DR150                                                            
*                                                                               
         USING EUPELEM,R6                                                       
         MVI   WORK,C' '           BUILD UPGRADE EXPRESSION                     
         MVC   WORK+1(L'WORK-1),WORK                                            
         MVC   WORK(4),=C'UPX='                                                 
         MVC   WORK+2(1),EUPUPFIL                                               
         MVC   WORK+4(16),EUPUPINP                                              
*                                                                               
         OC    EUPUPINP,EUPUPINP   CANADIAN UPGRADE EXPRESSION?                 
         BNZ   *+18                                                             
         LA    R5,WORK+4           YES                                          
         MVC   0(3,R5),=C'BK/'                                                  
         B     DR115                                                            
*                                                                               
         LA    R5,WORK+21                                                       
         OC    EUPUPFBK,EUPUPFBK   TEST ANY SHARE BOOK                          
         BZ    DR120                                                            
         BAS   RE,SETCOMMA                                                      
         MVC   0(3,R5),=C'BK='                                                  
*                                                                               
DR115    GOTO1 DATCON,DMCB,(3,EUPUPFBK),(6,3(R5))                               
         LA    R5,9(R5)                                                         
         CLI   EUPLEN,EUPLENXQ     NEW VERSION OF ELEMENT?                      
         BL    DR120               NO                                           
*                                                                               
         LA    R0,3                MAXIMUM OF 3 MORE BOOKS                      
         LA    R3,EUPUPMBK         EXTRA BOOKS FOR CANADA                       
DR117    OC    0(2,R3),0(R3)       ANY MORE?                                    
         BZ    DR120                                                            
         MVI   0(R5),C'/'          BOOK DELIMITER                               
         GOTO1 DATCON,DMCB,(3,0(R3)),(6,1(R5))                                  
         LA    R5,7(R5)                                                         
         LA    R3,2(R3)                                                         
         BCT   R0,DR117                                                         
         DROP  R6                                                               
*                                                                               
DR120    L     R6,AIO                                                           
         MVI   ELCODE,EOVCODEQ     OVERRIDE ELEMENT                             
         BAS   RE,GETEL                                                         
         BNE   DR140                                                            
*                                                                               
         USING EOVELEM,R6                                                       
         OC    EOVUPDAY,EOVUPDAY   TEST DAY/TIME OVERRIDE                       
         BZ    DR130                                                            
         BAS   RE,SETCOMMA                                                      
         MVC   0(3,R5),=C'DT='                                                  
         GOTO1 UNDAY,DMCB,EOVUPDAY,3(R5)                                        
         LA    R5,11(R5)                                                        
*                                                                               
         BAS   RE,SETCOMMA                                                      
         BCTR  R5,0                                                             
         MVI   0(R5),C'/'                                                       
         GOTO1 UNTIME,DMCB,EOVUPTIM,1(R5)                                       
         LA    R5,14(R5)                                                        
*                                                                               
DR130    OC    EOVUPSTA,EOVUPSTA   TEST STATION OVERRIDE                        
         BZ    DR140                                                            
         BAS   RE,SETCOMMA                                                      
         MVC   0(3,R5),=C'ST='                                                  
         MVC   3(4,R5),EOVUPSTA                                                 
         CLI   EOVLEN,EOVLENXQ     NEW VERSION OF ELEMENT?                      
         BL    DR140               NO                                           
         OC    EOVUPSTX,EOVUPSTX                                                
         BZ    DR140                                                            
         MVC   7(3,R5),EOVUPSTX                                                 
         DROP  R6                                                               
*                                                                               
DR140    ZIC   RE,SRDUPGH                                                       
         SH    RE,=H'17'           HEADER LENGTH + EXTENSION + 1 FOR EX         
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   SRDUPG(0),WORK      EBCDIC UPGRADE EXPRESSION                    
*                                                                               
         OI    SRDUPGH+6,FOUTTRN   XMIT                                         
         LA    R3,SRDUPGX          A(EXTENSION)                                 
         LA    RE,1(RE)                                                         
*                                                                               
DR145    BCTR  R3,0                BACK UP ONE CHARACTER                        
         CLI   0(R3),C' '          LOOK FOR NON-BLANK                           
         BH    *+14                                                             
         MVI   0(R3),0                                                          
         BCTR  RE,0                                                             
         B     DR145                                                            
         STC   RE,SRDUPGH+5        NEW INPUT LENGTH                             
*                                                                               
DR150    L     R6,AIO                                                           
         MVI   ELCODE,ECOCODEQ     COMMENTS ELEMENT                             
         BAS   RE,GETEL                                                         
         BNE   DR160                                                            
*                                                                               
         USING ECOELEM,R6                                                       
         ZIC   R1,ECOLEN                                                        
         SH    R1,=H'3'            INCLUDE BCTR AND OVERHEAD                    
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SRDCOM(0),ECOMMENT                                               
         OI    SRDCOMH+6,FOUTTRN   XMIT                                         
         DROP  R6                                                               
*                                                                               
DR160    CLI   SVUSECMP,C'Y'       TEST COMPETITION USER                        
         BNE   DR180               NO - USE DETAIL                              
         CLI   QSTANEW,X'F0'       LOCAL CABLE STATION?                         
         BNL   DR180               YES -- IGNORE COMPETITION                    
*                                                                               
         CLI   STAINDEX,0          TEST WE HAVE COMPETITION RECORD              
         BE    DR180               NO - USE DETAIL                              
         L     R6,AIO3             YES                                          
         MVI   ELCODE,CMPCODEQ     LOOK FOR PROGRAMMING ELEMENT                 
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING CMPEL,R6                                                         
DR170    MVC   BYTE,CMPSEQ                                                      
         NI    BYTE,X'7F'          TURN OFF OVERRIDE BIT IF IT'S                
         CLC   STAINDEX,BYTE       TEST PROGRAM FOR THIS STATION                
         BE    *+14                YES                                          
         BAS   RE,NEXTEL           NO - TRY NEXT                                
         BE    DR170                                                            
         DC    H'0'                NO PROGRAM FOR THIS STATION                  
*                                                                               
         CLC   CMPPROG,=17X'FF'    TEST ELEMENT WAS NEVER INITIALIZED           
         BE    DR180               RIGHT - USE DETAIL                           
         MVC   SRDPGM,CMPPROG                                                   
         OI    SRDPGMH+6,FOUTTRN   XMIT                                         
         B     DRX                                                              
         DROP  R6                                                               
*                                                                               
DR180    L     R6,AIO              DETAIL RECORD                                
         MVI   ELCODE,EPRCODEQ     PROGRAMMING ELEMENT                          
         BAS   RE,GETEL                                                         
         BNE   DRX                                                              
*                                                                               
         USING EPRELEM,R6                                                       
         MVC   SRDPGM,EPRTEXT                                                   
         OI    SRDPGMH+6,FOUTTRN   XMIT                                         
         DROP  R6                                                               
*                                                                               
DRX      B     XIT                                                              
         SPACE 5                                                                
SETCOMMA CLI   0(R5),C' '          BACK UP TO NON-BLANK/NULL                    
         BE    *+12                                                             
         CLI   0(R5),0                                                          
         BNE   *+8                                                              
         BCT   R5,SETCOMMA                                                      
*                                                                               
         MVI   1(R5),C','          EDIT IN COMMA                                
         LA    R5,2(R5)                                                         
         BR    RE                                                               
         EJECT                                                                  
* SELECT FROM NSID SCREEN                                                       
*                                                                               
SELECT   OC    SRDSTA,SRDSTA       TEST STATION FIELD IS FILLED IN              
         BNZ   SEL10               YES - WE'RE HERE VIA MINI-CONTROLLER         
*                                                                               
         BAS   RE,DK               WE'RE HERE VIA NSID - DISPLAY KEY            
         BAS   RE,VK               VALIDATE THE KEY                             
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                DETAIL KEY IS IN KEY                         
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                 BETTER BE THERE                              
         DC    H'0'                                                             
*                                                                               
         MVC   SVDETADR,KEY+14     SAVE DETAIL DISK ADDRESS                     
         GOTO1 GETREC              PUTS DETAIL RECORD IN IO1                    
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         BAS   RE,DR               DISPLAY THE RECORD                           
         B     SELX                                                             
*                                                                               
SEL10    CLI   GCMODE,C'S'         TEST GENCON WAS SLAVED                       
         BE    *+16                                                             
         MVI   ERROR,INVACT        THEY TYPED 'SELECT' - THAT'S A NO NO         
         LA    R2,CONACTH                                                       
         B     TRAPERR                                                          
*                                                                               
         CLC   SRDSCRN,=C'BF'      TEST DETAIL SCREEN IS LOADED                 
         BE    *+16                                                             
         MVI   ERROR,INVACT        NO                                           
         LA    R2,CONACTH                                                       
         B     TRAPERR                                                          
*                                                                               
         MVC   SRDSTAH+5(1),SRDSTAH+7   FAKE FIELDS FOR VALIDATION              
         MVC   SRDDPTH+5(1),SRDDPTH+7                                           
         MVC   SRDDAYH+5(1),SRDDAYH+7                                           
         MVC   SRDTIMEH+5(1),SRDTIMEH+7                                         
         MVC   SRDYRH+5(1),SRDYRH+7                                             
         OI    SRDYRH+4,FINPNUM                                                 
         MVC   SRDPERH+5(1),SRDPERH+7                                           
         MVC   SRDSCHH+5(1),SRDSCHH+7                                           
*                                                                               
         BAS   RE,VK               VALIDATE THE KEY                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                DETAIL KEY IS IN KEY                         
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                 BETTER BE THERE                              
         DC    H'0'                                                             
*                                                                               
         MVC   SVDETADR,KEY+14     SAVE DETAIL DISK ADDRESS                     
         GOTO1 GETREC              PUTS DETAIL RECORD IN IO1                    
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         BAS   RE,VR               VALIDATE THE RECORD                          
         GOTO1 PUTREC              UPDATE THE DETAIL RECORD                     
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         BAS   RE,XPUT             UPDATE NSID AND COMPETITION RECORDS          
*                                                                               
         CLI   SRDUPGH+5,0         TEST ANY UPGRADE                             
         BNE   SEL30               YES                                          
         CLI   SVUSECMP,C'Y'       TEST COMPETITION/ESTIMATE USER               
         BNE   *+18                NO                                           
         MVI   SVUPGL,0            YES - CLEAR UPGRADE FIELD ON NSID            
         XC    SVUPG,SVUPG                                                      
         B     SELX                                                             
*                                                                               
         CLI   SRDDEMOH+5,0        TEST ANY DEMO OVERRIDES                      
         BNE   SEL20               YES                                          
         CLI   SRDPGMH+5,0         TEST ANY PROGRAMMING                         
         BNE   *+18                YES                                          
         MVI   SVUPGL,0            NO - CLEAR UPGRADE FIELD ON NSID             
         XC    SVUPG,SVUPG                                                      
         B     SELX                                                             
*                                                                               
         ZIC   R1,SRDPGMH+5        MOVE IN PROGRAMMING                          
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SVUPG+5(0),SRDPGM   FOR NSID SCREEN UPDATE                       
         AH    R1,=H'6'            'PROG=' PLUS 1 FOR EX                        
         STC   R1,SVUPGL                                                        
         MVC   SVUPG(5),=C'PROG='                                               
         B     SELX                                                             
*                                                                               
SEL20    CLI   SRDDEMOH+5,40       TEST OVERRIDE WILL FIT ON NSID               
         BNH   *+18                YES                                          
         MVC   SVUPG,=CL40'* OVERRIDE TOO LONG *'                               
         MVI   SVUPGL,21           FOR NSID SCREEN UPDATE                       
         B     SELX                                                             
*                                                                               
         ZIC   R1,SRDDEMOH+5       MOVE IN OVERRIDE                             
         STC   R1,SVUPGL                                                        
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SVUPG(0),SRDDEMO                                                 
         B     SELX                                                             
*                                                                               
SEL30    CLI   STAMATCH,C'Y'       TEST WE SHOULD UPDATE NSID SCREEN            
         BNE   SELX                NO                                           
         CLI   SRDUPGH+5,40        TEST UPGRADE WILL FIT ON NSID                
         BNH   *+18                YES                                          
         MVC   SVUPG,=CL40'* UPGRADE TOO LONG *'                                
         MVI   SVUPGL,20           FOR NSID SCREEN UPDATE                       
         B     SELX                                                             
*                                                                               
         ZIC   R1,SRDUPGH+5        MOVE IN UPGRADE                              
         STC   R1,SVUPGL                                                        
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SVUPG(0),SRDUPG                                                  
*                                                                               
SELX     B     XIT                                                              
         EJECT                                                                  
CNVRT    NTR1                      CONVERT DEMO CODE/VALUE                      
*                                                                               
         LR    R4,R6                                                            
         USING EDOELEM,R4                                                       
*                                                                               
         LA    RE,BLOCK                                                         
         USING DBLOCK,RE                                                        
         XC    BLOCK(256),BLOCK                                                 
         MVC   DBFILE,=C'TP '                                                   
         MVC   DBCOMFCS,ACOMFACS                                                
         MVI   DBSELSRC,C'N'                                                    
         MVI   DBSELMED,C'T'                                                    
         CLI   SVAPROF+7,C'C'      CANADIAN AGENCY?                             
         BNE   *+8                                                              
         MVI   DBSELMED,C'C'                                                    
         DROP  RE                                                               
*                                                                               
         LA    R3,DEMWRK                                                        
         XC    0(3,R3),0(R3)       EDODEMO=2 BYTES/BUT                          
         MVC   1(2,R3),EDODEMO     DEMOCON NEEDS 3                              
         GOTO1 DEMOCON,DMCB,(0,(R3)),(2,(R2)),(C'S',BLOCK)  7 CHAR              
*                                                                               
CNV10    CLI   0(R2),C' '          LOOK FOR END OF DEMNAME                      
         BNH   *+12                                                             
         LA    R2,1(R2)                                                         
         B     CNV10                                                            
*                                                                               
         MVI   0(R2),C'='          GOT IT - MOVE IN '='                         
         LA    R2,1(R2)                                                         
         EDIT  (2,EDOVALUE),(6,(R2)),1,ALIGN=LEFT                               
         DROP  R4                                                               
*                                                                               
CNV20    CLI   0(R2),C' '          LOOK FOR END OF VALUE                        
         BNH   *+12                                                             
         LA    R2,1(R2)                                                         
         B     CNV20                                                            
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
*                                                                               
         XIT1  REGS=(R2)           R2-NEXT POSSIBLE NAME=VALUE AREA             
         EJECT                                                                  
CNVRTCMP NTR1                      CONVERT DEMO CODE FROM COMPETITION           
*                                                                               
         LA    RE,BLOCK                                                         
         USING DBLOCK,RE                                                        
         XC    BLOCK(256),BLOCK                                                 
         MVC   DBFILE,=C'TP '                                                   
         MVC   DBCOMFCS,ACOMFACS                                                
         MVI   DBSELSRC,C'N'                                                    
         MVI   DBSELMED,C'T'                                                    
         CLI   SVAPROF+7,C'C'      CANADIAN AGENCY?                             
         BNE   *+8                                                              
         MVI   DBSELMED,C'C'                                                    
         DROP  RE                                                               
*                                                                               
         ST    R4,FULL             SAVE R4                                      
         AR    R4,R6               R4 = A(STATION INDEX)                        
         MVC   BYTE,0(R4)                                                       
         NI    BYTE,X'7F'          TURN OFF OVERRIDE BIT IF IT'S ON             
         CLC   STAINDEX,BYTE       BETTER BE FOR THE RIGHT STATION              
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   =X'FFFF',1(R4)      TEST ANY VALUE FOR THIS STATION              
         BE    CNVCMPX2            NO - IGNORE                                  
*                                                                               
         LA    R3,DEMWRK                                                        
         XC    0(3,R3),0(R3)       CMDTYP=2 BYTES/BUT                           
         MVC   1(2,R3),2(R6)       DEMOCON NEEDS 3                              
         GOTO1 DEMOCON,DMCB,(0,(R3)),(2,(R2)),(C'S',BLOCK)  7 CHAR              
*                                                                               
CNVCMP10 CLI   0(R2),C' '          LOOK FOR END OF DEMNAME                      
         BNH   *+12                                                             
         LA    R2,1(R2)                                                         
         B     CNVCMP10                                                         
*                                                                               
         MVI   0(R2),C'='          GOT IT - MOVE IN '='                         
         LA    R2,1(R2)                                                         
         TM    0(R4),X'80'         TEST DEMO IS AN OVERRIDE                     
         BZ    *+12                NO                                           
         MVI   0(R2),C'*'          FLAG OVERRIDE ON SCREEN                      
         LA    R2,1(R2)                                                         
         L     R4,FULL             RESTORE R4                                   
         LA    R4,1(R6,R4)         R4 = A(DEMOVALUE)                            
         EDIT  (2,(R4)),(6,(R2)),1,ALIGN=LEFT                                   
*                                                                               
CNVCMP20 CLI   0(R2),C' '          LOOK FOR END OF VALUE                        
         BNH   *+12                                                             
         LA    R2,1(R2)                                                         
         B     CNVCMP20                                                         
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
*                                                                               
CNVCMPX2 XIT1  REGS=(R2)           R2-NEXT POSSIBLE NAME=VALUE AREA             
         EJECT                                                                  
         GETEL R6,DATADISP,ELCODE                                               
         SPACE 3                                                                
TRAPERR  GOTO1 ERREX                                                            
         OI    6(R2),FOUTCUR       PUT CURSOR HERE                              
         OI    CONHEADH+6,FOUTTRN  XMIT HEADER                                  
         GOTO1 SAVEUWKA            SAVE SYSD                                    
         L     RD,SAVERD           BACK ALL THE WAY OUT                         
         B     XIT                                                              
*                                                                               
RTNGERR  CVD   R4,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'RTNGERRM),RTNGERRM                                     
         UNPK  CONHEAD+31(2),DUB                                                
         B     SOLONG                                                           
RTNGERRM DC    C'* ERROR * Value error in field    *'                           
*                                                                               
DEMOERR  CVD   R4,DUB              YES - ERROR                                  
         OI    DUB+7,X'0F'                                                      
         XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'DEMOERRM),DEMOERRM                                     
         UNPK  CONHEAD+30(2),DUB                                                
         B     SOLONG                                                           
DEMOERRM DC    C'* ERROR * Demo error in field    *'                            
*                                                                               
LOWDATE  XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'LOWDATEM),LOWDATEM                                     
         B     SOLONG                                                           
LOWDATEM DC    C'* ERROR * Effective date lower than previous date *'           
*                                                                               
OUTOFPER XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'OUTOFPEM),OUTOFPEM                                     
         B     SOLONG                                                           
OUTOFPEM DC    C'* ERROR * Effective date must be within period *'              
*                                                                               
STARTDAY XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'STARTDAM),STARTDAM                                     
         B     SOLONG                                                           
STARTDAM DC    C'* ERROR * Date and day do not match *'                         
*                                                                               
SOLONG   GOTO1 ERREX2                                                           
         OI    6(R2),FOUTCUR       PUT CURSOR HERE                              
         OI    CONHEADH+6,FOUTTRN  XMIT HEADER                                  
         GOTO1 SAVEUWKA            SAVE SYSD                                    
         L     RD,SAVERD           BACK ALL THE WAY OUT                         
         B     XIT                                                              
         SPACE 3                                                                
SLNTAB   DS    0C                                                               
       ++INCLUDE SPSLNTAB                                                       
         DC    X'00'                                                            
         EJECT                                                                  
         LTORG                                                                  
         PRINT OFF                                                              
       ++INCLUDE DDSPOOLD                                                       
       ++INCLUDE DDSPLWORKD                                                     
       ++INCLUDE SPSFMFFD                                                       
         PRINT ON                                                               
         EJECT                                                                  
         ORG   CONTAGH                                                          
       ++INCLUDE SPSFMBFD                                                       
         PRINT OFF                                                              
       ++INCLUDE SPSFMWORKD                                                     
         PRINT ON                                                               
         SPACE 5                                                                
* WORK AREA                                                                     
*                                                                               
         ORG   SYSSPARE+1024       DON'T CREAM T2170E STORAGE                   
SAVERD   DS    F                                                                
SAVEKEY  DS    XL13                THE DETAIL KEY                               
PERNUM   DS    X                   PERIOD                                       
CURYEAR  DS    X                   CURRENT YEAR                                 
PERSTEND DS    0XL6                                                             
PERSTART DS    XL3                 PERIOD START DATE (YMD)                      
PEREND   DS    XL3                 PERIOD END DATE (YMD)                        
DAYPART  DS    C                   DAYPART                                      
DAYTIME  DS    0XL5                                                             
DAY      DS    X                   DAY(S) CODE                                  
TIME     DS    XL4                 START/END TIMES                              
DAYNUM   DS    X                   BINARY START DAY                             
PROGTYPE DS    C                   PROGRAM TYPE                                 
YEAR     DS    X                   YEAR                                         
INDEX    DS    X                   SEQUENCE NO. FOR SORTING                     
SEQNUM   DS    X                   SEQUENCE NO. FOR DAY/TIME                    
PERUPG   DS    CL34                PERIOD UPGRADE EXPRESSION                    
SVDEFUPG DS    CL34                SAVE DEFAULT UPGRADE VALUES                  
DEMWRK   DS    CL40                                                             
LASTDATE DS    XL3                                                              
SVNSIDKY DS    XL13                NSID KEY USED                                
ADDFLAG  DS    C                   'Y' IF ADDREC, 'N' IF PUTREC                 
STAINDEX DS    X                   STATION NUMBER IN COMPETITION RECS           
STAMATCH DS    C                   'Y' IF DETAIL STATION = NSID STATION         
PRGTYPSV DS    CL170               PROGRAM TYPE SAVE (CODE+NAME)                
SEQNUMS  DS    XL256               INDICATES USED SEQUENCE NUMBERS              
         PRINT OFF                                                              
       ++INCLUDE DDCOMFACS                                                      
       ++INCLUDE DDFLDHDR                                                       
       ++INCLUDE DDPERVALD                                                      
DBLKD    DSECT                                                                  
       ++INCLUDE DEDBLOCK                                                       
       ++INCLUDE SPDEMUPD                                                       
         PRINT ON                                                               
         EJECT                                                                  
SIRRECD  DSECT                                                                  
       ++INCLUDE SPGENSIR                                                       
         EJECT                                                                  
COMPRECD DSECT                                                                  
       ++INCLUDE SPGENCOMP                                                      
         SPACE 4                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'020SPSFM0F   08/11/11'                                      
         END                                                                    
