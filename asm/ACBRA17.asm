*          DATA SET ACBRA17    AT LEVEL 135 AS OF 07/07/20                      
*PHASE T62417A                                                                  
                                                                                
ACBRA17  TITLE '- BRA Estimates download Server'                                
                                                                                
***********************************************************************         
* Level change comments                                                         
* ---------------------                                                         
* UK Levels                                                                     
* ---------                                                                     
* TKLU 001 16MAY06 Estimates DownLoads - first version                          
* TKLU 002 22MAY06 <UKCR0000672> - work code name bug fix                       
* TKLU 003 31MAY06 'Awaiting approval' needs EMDSCA check                       
* TKLU     31MAY06 Items - flag for price override                              
* TKLU 004 02JUN06 Approval list bug fix                                        
* TKLU 005 14JUN06 Ballpark adjustments                                         
* TKLU     16JUN06 RESTBA/ballparl bug fix                                      
* TKLU 006 26JUN06 EST/LIST - display bug fix with added/activity data          
* TKLU 007 26JUN06 'awaiting approval' folder - exclude rejected                
* TKLU 008 26JUL06 PROTRX IO bug fix                                            
* TKLU 009 27JUL06 <UKCR00008124> error message bug fix                         
* TKLU 010 01AUG06 Scheme list initial call - change type check                 
* TKLU 011 11AUG06 Client approver name/date in STCELD                          
*                  and bug fix if client invalid                                
* TKLU 012 25AUG06 <LO01-5729> Foreign names support                            
* NSHE 013 15SEP06 CHANGES FOR QA TESTING WITH STATIC DATA                      
* TKLU 014 18SEP06 <DU01-5734> column restrictions for GAOV calls               
*          27SEP06 Preparations for MCS -> BRA                                  
* TKLU 015 11OCT06 Estimate search bug fixes                                    
*          12OCT06 Implement category text download                             
*          12OCT06 Prepare for 'copy estimate' display (ESTDIS)                 
* TKLU 016 16OCT06 More estimate search bug fixes                               
* TKLU 017 17OCT06 Estimate search improvements and bug fixes                   
*          18OCT06 Add all Con/Sec person request                               
*          20OCT06 GETITM final implementation                                  
* TKLU 018 23OCT06 FINAL RENAME FROM MCS TO BRA                                 
* TKLU 019 24OCT06 <UKCR00009586> estimate approvers bug fix                    
*                  <UKCR00009741> estimate reconcile all work codes             
* TKLU 020 06NOV06 <UKCR00009911> reconcile balance calculation change          
*                  <LO01-5946> estimate approver changes                        
*                  <UKCR00009773> Job level search bug fix                      
* TKLU 021 13NOV06 <UKCR00009771> Media search on non-ballpark esttim.          
* TKLU 022 28NOV06 Currency revaluation call via estiamte display               
*                  Ensure 'EX   Rn,*+4' is not used anymore (assembler)         
*                  <UKCR00010214> Media columns in lst fixed                    
* TKLU 023 15DEC06 SUMLST bug fix                                               
* TKLU 024 19DEC06 Implement Estimate display copy for currency values          
*                  - main data done only, work code and item data o/s           
*          21DEC06 Increase GTAAPP limit to 1000 IOs                            
* TKLU 024 18JAN07 <DU01-5937> Suppress printing flags                          
* TKLU 025 26JAN07 Use different message to make error more clear               
*                  New job status (draft=Y/N) return data for Est/List          
* TKLU 026 29JAN07 New job status (draft=Y/N) return data for Est/Disp          
* NSHE 027 08FEB07 <LO01-6033> SHOW DIFFERENT NAMES                             
* TKLU             Estimate copy: artist + NIC items adjustments                
* TKLU 029 28FEB07 Estimate search currency bug fix                             
* TKLU 030 08MAR07 <UKCR00011691> Estimate approvers check 'previous'           
* TKLU 031 15MAR07 <UKCR00011691> Prevent from appr if not approver             
* TKLU 032 20MAR07 Estimate approver check improvement                          
* TKLU 033 20MAR07 Display action 'copy' bug fix when multiple records          
* TKLU 034 23MAR07 Estimate/Display copy mode FC fixes                          
* TKLU 035 29MAR07 Xtra data field - seperate field for amounts                 
* TKLU 036 16APR07 Bug fix from Jim Shea                                        
* TKLU 037 26APR07 US merger                                                    
* TKLU 038 03MAY07 <BR10702D> Init. SJACCNT (missed in prev. merger)            
* TKLU 039 15MAY07 <UKCR00012587> Estimate reconcile bug fix                    
*                  <UKCR00012591> Estimate copy - allow US to copy              
*                  across offices                                               
*          21MAY07 <UKCR00012155> Estimate search by owner - IO fix             
*                  US specific GETOPT parameter changes (JSHA)                  
*          23MAY07 <DU01-6486> Preparatns for Est/Merge within Est/Disp         
*          31MAY07 Estimate items (no code) - copy over on COPY action          
* TKLU 040 11JUN07 <DU01-6538> Cli/Pro/Job address on Estimate/Display          
*                  US merger (JSHA)                                             
* TKLU 041 19JUN07 <UKCR00013003> Scheme download bug fix                       
* TKLU 042 18JUL07 <DU01-6355> Estimate copy for differing clients              
*          19JUL07 <DU01-6665> New security values for Est/Reconcile            
* TKLU 043 20JUL07 <DU01-6665> Enable 'Time estimating (phase 1)' in            
*                  Estimate/reconcile views                                     
*          23JUL07 <UKCR00013309> Estimate category foreign names               
*          08AUG07 US merger                                                    
*          09AUG07 Single Person (PID) lookup in EAPPDL                         
*          17AUG07 <UKCR00013309> GETCAT5 fix: category names/instr's           
*          29AUG07 Estimate/copy artist item treatment bug fix                  
* TKLU 044 10SEP07 <DU01-6486> Estimate merge - implementation                  
*          24SEP07 <LO01-6530> Preparations for 'Print Side By Side'            
*          28SEP07 Initial for add - AMUR request for extra fields              
*          09OCT07 US merger (for JSHA)                                         
*          19OCT07 Copy value for EMSELD source type copy                       
* NSHE 045 13NOV07 <LO01-6995> Set FACPAK code for analysis                     
* TKLU 046 08NOV07 <UKCR00012444> Allow status change comment (auto             
*                  generated) to be 120 characters                              
* TKLU 047 27NOV07 <UKCR00015179> Scheme code for est. list & search            
*          29NOV07 <UKCR00015250> CWITIND fix in PROCWI                         
* TKLU 048 03DEC07 <UKCR00015262> Estimate approver 'get' bug fix               
*          10DEC07 <UKCR00015118> Add missing CWKCAT to scheme d/load           
*                  and return GOESTPER in COMVAT                                
*          11DEC07 US merger (JSHA)                                             
* TKLU 049 18DEC07 <UKCR00015118> Estimate percentage & w/c behaviour           
* TKLU 050 07JAN08 <UKCR00015627> STCUSER display bug fix                       
* TKLU 051 15JAN08 <UKCR00015446> Commission look up on estimate/copy           
*          19JAN08 <DU01-5718> Contingency redo (w/c level with DVIL)           
*          06FEB08 Estimate/Merge bug fixes for 'no base'                       
* TKLU 052 08MAR08 <UKCR00016524> Get commission on copy - bug fix              
* TKLU 053 03APR08 <UKCR00016847> Estimate Search bug fixes                     
* TKLU 054 24APR08 <UKCR00017144> Company uses FC estimate - fix                
* TKLU 055 24APR08 PHASE CARD CHANGE                                            
* TKLU 056 09JUL08 <DU01-7767> Foreign name support (item texts)                
*          01AUG08 JobDashBoard: Add last activity time to Est/List             
* TFRY 057 21AUG08 Increase number of characters read from Cat/Detail           
* TKLU     03SEP08 <DU01-8040> UNIT support for items/articles                  
* TKLU 058 11SEP08 Some 2CO adjustments                                         
* TKLU 059 24SEP08 <UKCR0001906> estimate reconcile order trx bug fix           
* NSHE 060 08OCT08 <BR20591L> Change estimate approver look up                  
* TKLU 061 16OCT08 <LO01-8207> 'Internal Approvals' implementation              
* YNGX     21NOV08 <LO01-2599> bug fix displaying estimate record               
* TKLU     07JAN09 <LO01-8495> Estimate name to be optional field               
* TKLU     12JAN09 <UKCR00012458> Estimate search by media bug fix              
* TKLU     13JAN09 <UKCR00018988> IO3 for CHKITM (IO1 used for TSAR)            
* TKLU     21JAN09 <DU01-8087> Return phone extension of est. raiser            
* TKLU 062 12MAY09 BR14180D OFFAL call in RESTOS and RESTBA                     
* NSHE 064 11MAY09 Change to approver records                                   
* SMAN 065 28JAN09 LO01-8458 View Several Estimates & Extra Columns             
* SMAN     11MAR09 LO01-8421 Internal Approvals for Estimates                   
* SMAN     11MAY09 LO01-8642 Merge wc rows                                      
* SMAN     18JUN09 LO01-8837 Limit Scheme list / GAPLST calls                   
* SMAN     16JUL09 LO01-8950 Override Item text on WC row                       
* SMAN 066 10JUL09 LO01-8983 Changes to Estimate approvals                      
*                  and prepare to take Estimates offline                        
*                  UKCR00023681 Fix work code order and text                    
*                  UKCR00023682 Base View Several est on editable est.          
*                  UKCR00022185 Pass previous approver only if valid            
* SMAN 067 26AUG09 LO01-9260 Send Media code and name in ESTDIS                 
* TKLU     02SEP09 UKCR00023947 - LimList processing fix (ELFBLL75)             
* SMAN 067 29SEP09 BR27654L Increase X#MAXIOQ to 3000                           
* SMAN 068 05OCT09 Change PIDKSTAT to PIDKSTA2 for merge and sub to int         
* SMAN 069 09OCT09 UKCR00024823 Rtn CCTPID as creator on cpy/merge              
*                  UKCR00021484 Change AE$SPNMC to AE$ESCFM                     
* SMAN 070 20OCT09 Use #GOATSR/TSARABUF for GAPLST                              
*                  UKCR00025211 Ensure use of supposed client approver          
* SMAN 071 29OCT09 BR10028X Small bug fix to level 70                           
* SMAN 072 03NOV09 BR28539L Fix to GETOPT call                                  
* SMAN 073 09NOV09 UKCR00024980 Add 'Int Use only' to lst/srch calls            
* SMAN     09NOV09 UKCR00025468 Use dft PDF format for copying estimate         
* SMAN     11NOV09 UKCR00025707 Use current VAT rate on copy                    
* SMAN 074 16NOV09 UKCR00025514 Fix to recent estimates (SUMLST)                
* SMAN 075 17NOV09 BR28848L Fix to GETCOM                                       
* SMAN 076 20NOV09 BR10288Y Retrieve global internal approvers                  
* SMAN 077 20NOV09 UKCR00024691 Make estimate number uppercase                  
* SMAN 078 18NOV09 UKCR00016098 Use current VAT rate when merging ests          
* SMAN     19NOV09 UKCR00025815 Fix to ELFBLL for US                            
* SMAN     26NOV09 UKCR00025765 Small change in FLTKEY for lvl 70               
* JFOS 079 29JAN09 BR30485L limit GAOV return else corrupts RUNPARMS            
* SMAN 080 04DEC09 Ignore wc 99 for US                                          
* SMAN     10DEC09 UKCR00026184 Fix to 'search by approver'                     
* SMAN     04JAN10 LO01-9542 Pass back supposed internal approver code          
* SMAN     06JAN10 UKCR00026398 Further fix to client appr date filters         
* SMAN     27JAN10 UKCR00025515 Rewrite of ELFBLL to cope with offices          
* SMAN     29JAN10 UKCR00022748 Increment X#CWIITX per item code                
* MPEN 081 02FEB10 <LO01-9750> Control what unapproved time/orders/exp          
* NSHE     02FEB10 Filter control security pids according to module             
* SMAN     13APR10 UKCR00027532 Fix to ELFBLL                                   
* MPEN     16APR10 <PR000141> Return real work code name                        
* SMAN     26APR10 <UKCR00020696> Chg correct cur vals in Revaluation           
* SMAN     26APR10 <UKCR00022741> Retain comm rate when copying to              
*                                 same job                                      
* SMAN 082 12MAY10 <BR15955D> Use AGOBLOCB in COMVAT (not AGOBLOCK)             
* SMAN 083 12MAY10 <BR33103L> Check TRNKDATE prior to FLTTIM calls              
* SMAN 084 14JUN10 <UKCR00028124> Fixes to Estimate Reconcile                   
* SMAN 085 21JUN10 <BR16145D> Bug fix to foreign wc description                 
* NSHE 085 04JUN10 <UKCR00028081> Treat R-time as actual                        
* SMAN 086 20JUL10 <BR34490L> Fix to FLTREC/implement limit search ovr          
* TKLU 087 08SEP10 <PR000801> Category details language support Germany         
* NSHE 088 05AUG10 Change to GAPLST call, remove CONPIDC replace CCTPID         
* MPEN 089 15DEC10 <PR001254> Change all downloads to show job lock sta         
* MPEN     12FEB11 <PR001483> Return job comments with display                  
* MPEN     16FEB11 <PR001523> Pass estimate actuals setting                     
* NSHE     23FEB11 <PR001575> Calculated columns                                
* MPEN 090 24JUN11 <BR18201D> Fix for compare on 7 byte job code                
* NSHE 091 07JUN11 US fix to recent estimates view when on list access          
* NSHE     15JUN11 US fix for memo expenses                                     
* MPEN     09AUG11 <PR002045> improvements to foreign estimate handling         
* NSHE 092 26OCT11 <BR18757D> Disallow self selection for approval              
* JFOS 093 28OCT11 <BR18781D> Clear IA_WCDES b4 overwriting wth XNMSUBN         
* JFOS 094 02NOV11 <PR002367> Return 1R/rate/hours in Estimate display          
* JFOS     09DEC11 <UKCR32948> Fix HR-Actuals extra col display                 
* NSHE 095 15MAY12 Add work code extra name                                     
* JFOS 096 15AUG12 <UKCR34341> fix ERDTIRQ corruption in PDF Several +          
* NSHE 097 31AUG12 <PR003191> Add colour code setting to est display            
* JFOS 098 20DEC12 <BR20743D> 'not' signs hex value different for Ger           
*                  lvl 98 change disabled, pending java support                 
* MPEN 099 14MAR13 <BR21114D> Always return item unit and language              
* JFOS 098 27MAR13 <BR21120D> Skip agency-lvl approver, don't exit              
* JFOS 103 18JUL13 <PR003402> New JOBBER:skip 1r-lvl ents on view sevrl         
* NSHE     19JUL13 Call SETFAC earlier                                          
* YNGX 104 25MAR14 <BO-759> REVALUATE AGENCY CURRENCY AMOUNT                    
* MPEN 105 30APR14 <DSRD-2283> PRINT OUT VIEW SEVERAL REQUESTS                  
* MPEN 106 27JUN14 <DSRD-2734> Correct estimate search field #17                
* MPEN 108 10JUL14 <DSRD-1957> Exclude terminated users from app list           
* MPEN             <DSRD-3303> Move est to separate audit                       
*                              Recent action list response                      
*                  <DSRD-3760> Add estimate date to list/display/search         
*                  <DSRD-2916> Job status in estimate list/search               
* TKLU     18Aug14 <DSRD-3776> Pass agency currency in list & display           
*                  <DSRD-3354> Aura MVP version - error if not standard         
*                              estimate (date bound, see AURAMVP)               
*          28Aug14 <DSRD-4093> New EstimateList 'by status' flavour for         
*                              'created by me' and 'actioned by me'             
*                  <DSRD-4095> For Aura filter out ballpark estimates           
*          02Sep14 <DSRD-3362> US: Support HR/OE/CE in EstimateDisplay          
* MPEN     03Sep14 <DSRD-2733> Improved estimate audit                          
*                  <DSRD-4228> Ensure only last 3 months for my action          
* TKLU     15Sep14 <DSRD-4318> EstimateDisplay via Cli/Pro/Job/Local#           
*                  <DSRD-4350> EstimateDisplay - show XData names               
*                * ERAPASD/AUDRECD not deleted though Estimate is ...           
*                * Skip missing AUDRECDs in LIST: should be scanned for         
*                * Change 13 months to 3 months for all views                   
*                  <DSRD-4400> STCCLNAM is on AUDREC now                        
*                  <DSRD-4388> Use different TODAYP for QA unless Aura          
*                  <DSRD-4430> OUTAPP and GTAAPP fixes                          
*          22Sep14 <DSRD-4350> Return XData at end of estimate display          
*                              (as of X#XDFA ACBRA1F.REQXDFH), limit to         
*                              10 returns                                       
*          24Sep14 <DSRD-3957> XCode edit from HEXD to routine                  
*          21Nov14 <DSRD-5198> FLTKEY/GAPLST filtering fixes                    
* MPEN     01Dec14 <DSBO-1265> Ignore future expiry dates                       
*          01Dec14 <DSRD-5132> Remove categories where they have work           
*                              codes and calculated categories                  
*          03Dec14 <DSRD-5337> Ensure recently actioned estimates               
*                              are sent only once - no dupes                    
* TKLU 109 11Dec14 <DSRD-5425> Reinstate 13 months check (JSHA) plus            
*                              a few minor NSHE/TKLU approval fixes             
* NSHE 110 11Dec14 <DSRD-4650> Allow currency for Aura                          
* MPEN     16Dec14 <DSRD-5488> Add xdata field code to display                  
* MPEN     29Dec14 <DSRD-5552> Use TSAR to buffer account/person/media          
* NRAK     13Jan15 <DSBO-1321> Fix X#SJACT building for reconciliation          
* MPEN 111 16Jan15 <DSRD-5783> For aura search don't return error               
* MPEN 112 12Feb15 <DSRD-6046> Aura PDF display changes                         
* MPEN 113 16FEB15 <DSRD-1364> Skip internal use/name change for BO             
* JFOS 114 24MAR15 <DSBO-1411> Fix bad len EX move                              
* NSHE 115 25MAR15 <DSRD-6688> Return closed status for job                     
* NSHE     31MAR15 <DSRD-6737> Deny access to estimates for W&K                 
* TKLU 116 09Mar15 <RD006455> US only support for HR/OE/CE on Job               
* NSHE     01May15 <DSBO-1443> Ensure expense orders are included               
* NSHE 117 20May15 <DSRD-7275> Fix bug when checking limit list for job         
* NSHE 118 21Jul15 <DSRD-7726> Add estimate date to search parameters           
* NSHE     20Aug15 <DSRD-8352> Add estimate additional text                     
* TKLU     26Aug15 <DSRD-8436> Search estimates by 'created by' only            
*          27Aug15 <DSRD-8416> VAGEST20 bug fix                                 
*          07Sep15 <RD007727>  Estimate name search enhancement                 
* NSHE     17Sep15 <DSRD-8536> Allow users to view estimates they have          
*          added outside their limit list providing they have security          
* NSHE 119 05Oct15 <DSRD-8923> Change estimate list to support looking          
*          for internal and client approvals for approved and awaiting          
* NRAK     15Oct15 <DSRD-8560> return zero item Rate                            
* NSHE 120 25Nov15 <DSRD-9550> Allow items for Aura estimates                   
* TKLU     16Dec15 <DSRD-9807> For AURA adjust 'item change indicator'          
* TKLU     06Jan16             Prepare offline tracing support                  
* NSHE     12Jan16 <DSRD-9704> Return error message for no price items          
* TKLU 121 27Jan16 <RD010160>  Performance improvements (GETOPT)                
*                              Unified AGOBLOCB (not AGOBLOCK) use              
*                              Change ESTSRC FLTKEY/FLTREC job checks           
*                              when searching by Cli(/Pro/Job)                  
* NSHE 122 07Mar16 <DSBO-1695> Clear media field for GETOPT call                
* NSHE 123 03Jun16 DSRD-11681 Clear prior approvals if est rejected             
* NSHE     17Jun16 DSRD-11011 US issue with wc not showing time                 
* NSHE 124 08Jul16 DSRD-12265 Add approved date to list/search response         
* MPEN 125 09Sep16 DSRD-13153 Fix for cli/pro + med search                      
* MPEN 126 16Dec16 DSRD-13912 Fix for job description offline                   
* MPEN 127 10Jan17 DSRD-14617 Remove date checks from AURAMVP                   
* NSHE 128 05May17 DSRD-15706 Add commission and vat rates                      
* NSHE 129 12Jul17 DSRD-15793 Add new error for ballpark estimates              
* MPEN     17Jul17 DSRD-15589 Relink for longer TIMNARR                         
* NSHE 130 29Jan18 DSRD-18005 electronic signature changes                      
* MPEN 131 05Apr18 DSRD-18275 Apply limlist/access sec to saved search          
* NSHE     04May18 DSRD-18997 Show rejection comments on display                
* NSHE 132 25Oct18 DSRD-20397 Don't send currency values for items if           
*      copying foreign currency est to a new agency currency estimate           
* NSHE 133 14Feb19 DSRD-21687 Fix for recently actioned estimates               
*      when client codes are 5 characters                                       
* MPEN     27Feb19 DSRD-21604 Estimate search by office                         
* MPEN 134 19Mar19 DSRD-21604 Support multiple offices for est search           
*          04Apr19 DSRD-22125 Fix for estimate name searching                   
*          10Apr19 DSRD-22256 Return job locked from t/s                        
* MPEN 135 12Mar20 DSRD-25729 Estimate int/ext breakdown                        
* MPEN     18May20 DSRD-25987 New opt maint allow est in last fiscal            
***********************************************************************         
                                                                                
SVRDEF   CSECT                                                                  
         LKSVR TYPE=D,IDF=Y,REQUEST=*,CODE=CODE,FILES=FILES,           x        
               SLOWLIST=SLOWS,FACS=FACS,WORKERKEY=ACBO,ABENDLIST=FAILS,x        
               SYSPHASE=X'0624',SYSTEM=ACCSYSQ,APPEND=Y,               x        
               SERVERTYPE=TSTACBO,SEGMENT=Y,LOADFACSOFF=Y,             x        
               BLOCKS=(B#WORKD,WORKD,                                  x        
               B#SAVED,SAVED,                                          x        
               B#TWA,TWAD,                                             x        
               B#ACEX,AEXRECD)                                                  
                                                                                
SLOWS    DC    C':'                                                             
FAILS    DC    C':'                                                             
                                                                                
         EJECT                                                                  
CODE     DS    0D                                                               
         PRINT NOGEN                                                            
         NMOD1 0,**BO17**,CLEAR=YES,RR=RE                                       
         LARL  RA,GLOBALS                                                       
         USING GLOBALS,RA          RA=A(GLOBAL LITERALS)                        
         LR    R5,R1                                                            
         USING LP_D,R5                                                          
         L     R7,LP_ARUNP         R7=A(RUNPARMS)                               
         USING RUNPARMD,R7                                                      
         XR    R6,R6                                                            
         ICM   R6,7,RUNPARUN                                                    
         USING RUNFACSD,R6         R6=A(RUNFACS)                                
                                                                                
         USING WORKD,R9            R9=A(GLOBAL W/S)                             
         USING SAVED,R8            R8=A(SAVE W/S)                               
                                                                                
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         JNZ   INIT02                                                           
         L     R9,LP_ABLK1         ONLINE - ROOT PROVIDES WORKD/SAVED           
         ICM   R8,15,RSVRSAVE      R8=A(4K SAVE AREA)                           
         J     INIT04                                                           
                                                                                
INIT02   L     R9,RSVRSAVE         A(64K SAVE AREA)                             
         ST    R9,LP_BLKS+((B#WORKD-1)*L'LP_BLKS)              BLOCK #1         
         SR    R8,R8                                                            
         ICM   R8,3,WORKLEN                                                     
         LA    R8,WORKD(R8)                                                     
INIT04   ST    R8,LP_BLKS+((B#SAVED-1)*L'LP_BLKS)                               
         LR    RC,R8                                                            
         AHI   RC,4096                                                          
         USING SAVED+4096,RC       RC=A(2ND 4K OF W/S)                          
         MVC   ATWA,LP_ATWA        OFFLINE TWA AREA SET BY RUNNER               
                                                                                
         MVC   RUNMODE,RUNPMODE    EXTRACT DDLINK/RUNNER CALLING MODE           
         MVC   ACOMFACS,RCOMFACS                                                
         MVC   ARCPRINT,RCPRINT                                                 
         MVC   APRINTER,RPRINTER                                                
         MVC   AMASTC,RMASTC                                                    
         ST    R6,ARUNFACS                                                      
         DROP  R6,R7                                                            
                                                                                
         MVI   TWAMODE,0                                                        
                                                                                
         ST    R5,ALP              SAVE A(DDLINK PARAMETER LIST)                
         ST    RE,SRVRRELO         SAVE PROGRAM RELOCATION FACTOR               
         STM   R2,RB,LP_R2RB       SAVE REGISTERS FOR SUB-ROUTINES              
         EJECT                                                                  
         L     R1,LP_ARUNP         R1=A(RUNPARMS)                               
         USING RUNPARMD,R1                                                      
         CLI   RUNPMODE,RRUNSTRQ   FIRST FOR RUN                                
         JE    RUNSTR                                                           
         CLI   RUNPMODE,RPRCWRKQ   PROCESS WORK                                 
         JE    PRCWRK                                                           
         CLI   RUNPMODE,RRUNREQQ   RUN REQUEST                                  
         JE    RUNREQ                                                           
         J     EXITY                                                            
         DROP  R1                                                               
                                                                                
***********************************************************************         
* INITIALISE FOR RUNNING                                              *         
***********************************************************************         
                                                                                
RUNSTR   TM    LP_FLAG,LP_FOFFL    TEST RUNNING OFFLINE                         
         JZ    RUNSTR02                                                         
                                                                                
         L     RF,AMASTC                                                        
         MVC   VACCEMU,MCVACEMU-MASTD(RF)                                       
         L     RF,ACOMFACS         YES - LOAD FACILITIES OVERLAYS               
         L     RF,CCALLOV-COMFACSD(RF)                                          
         GOTOR (RF),DMCB,(1,0),0,0                                              
         MVC   AROUT1,0(R1)                                                     
         GOTOR (RF),DMCB,(2,0),0,0                                              
         MVC   AROUT2,0(R1)                                                     
         J     RUNSTR04                                                         
                                                                                
RUNSTR02 L     RF,AACCFACS                                                      
         MVC   VACCEMU,X_AACCEMU-X_ACCFACSD(RF)                                 
                                                                                
RUNSTR04 GOTOR (#WRKINI,AWRKINI)   INITIALISE WORKING STORAGE                   
         MVC   LP_AUIR1,AROUT1     SET A(INDEX ROUTINES 1)                      
         MVC   LP_AUIR2,AROUT2     SET A(INDEX ROUTINES 2)                      
         MVC   LP_BLKS+((B#ACEX-1)*L'LP_BLKS)(L'LP_BLKS),AIO5                   
                                                                                
         OI    LP_AIND1,LP_AICOM   COMMA OK FOR LIST DELIMITERS                 
         J     EXITY                                                            
                                                                                
***********************************************************************         
* FIRST FOR NEW WORK                                                  *         
***********************************************************************         
                                                                                
PRCWRK   LA    R0,SAVEVAR                                                       
         LHI   R1,SAVEVARL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     R0,AGENAXTN                                                      
         LHI   R1,L'GENAEXTN                                                    
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         JZ    PRCWRK02                                                         
                                                                                
         LA    R0,WORKD            CLEAR I/O AREAS                              
         AHI   R0,IOAREA1-WORKD                                                 
         LHI   R1,IOAREASL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
PRCWRK02 GOTOR (#GOATSR,AGOATSR),DMCB,('TSAINI',ATSRERRS),0,GAPAREA2,  +        
               TSARABUF                                                         
         J     EXITY                                                            
                                                                                
***********************************************************************         
* RUN A DOWNLOAD REQUEST                                              *         
***********************************************************************         
                                                                                
RUNREQ   MVI   GIND2,GI2EEST                                                    
                                                                                
         GOTOR (#CPYINI,ACPYINI)   (RE)INITIALISE COMPANY VALUES                
         GOTO1 VDICTATE,DMCB,C'LL  ',DCDICTL,DSDICTL                            
         MVC   AGENCY,CUXCPY                                                    
         USING CPXELD,SCPXEL                                                    
         USING CPYELD,SCPYEL                                                    
                                                                                
         GOTOR VDATCON,DMCB,(5,0),(1,XL#TODP)                                   
                                                                                
         GOTOR INIOBUF                                                          
                                                                                
*&&UK                                                                           
         CLI   CUTSYS,X'73'                                                     
         JNE   RUNREQ2                                                          
         XR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JE    RUNREQ2                                                          
         MVC   XL#TODP,=X'A60701'                                               
*&&                                                                             
                                                                                
RUNREQ2  GOTOR VDATCON,DMCB,(1,XL#TODP),(2,XL#TODC)                             
         GOTO1 (RF),(R1),,(X'20',XL#TODPR)                                      
         GOTO1 VADDAY,DMCB,(C'M',XL#TODPR),XL#TODM3,F'-3'                       
         GOTO1 VDATCON,DMCB,(0,XL#TODM3),(1,XL#TODP3)                           
         GOTO1 VADDAY,DMCB,(C'M',XL#TODPR),XL#TDM13,F'-13'                      
         GOTO1 VDATCON,DMCB,(0,XL#TDM13),(1,XL#TDP13)                           
                                                                                
         TM    LP_FLAG,LP_FOFFL    Test offline                                 
         JZ    RUNREQ4                                                          
                                                                                
         L     R0,AGOBLOCB                                                      
         AHI   R0,GOADM-GOBLOCK                                                 
         LHI   R1,GOBLOCKX-GOBLOCKD                                             
         SHI   R0,GOADM-GOBLOCK                                                 
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
*    open all files to read from/write to (offline only)                        
                                                                                
         L     RF,AMASTC           Set trace option                             
         MVC   IOTRACE,MCTRACE-MASTD(RF)                                        
         GOTOR VDATAMGR,DMCB,DMKEY,ACCDIR,(4,0),0                               
         GOTOR VDATAMGR,DMCB,DMKEY,ACCMST,(4,0),0                               
         GOTOR VDATAMGR,DMCB,DMKEY,ACCARC,(4,0),0                               
                                                                                
RUNREQ4  XR    RF,RF                                                            
         ICM   RF,3,LP_QMAPN                                                    
         CHI   RF,A#EIFA           *** initial d/load for add                   
         JE    EIFADL                                                           
         CHI   RF,A#ELIS           *** estimate list d/load                     
         JE    ESTLST                                                           
         CHI   RF,A#EDIS           *** estimate display d/load                  
         JE    ESTDIS                                                           
         CHI   RF,A#ESRC           *** estimate search download                 
         JE    ESTSRC                                                           
         CHI   RF,A#EAPP           *** estimate approvers download              
         JE    EAPPDL                                                           
         DC    H'0'                UNKNOWN REQUEST                              
         EJECT                                                                  
                                                                                
***********************************************************************         
* Estimates: initial for add download                                 *         
***********************************************************************         
                                                                                
         USING LW_D,RF                                                          
EIFADL   DS    0H                                                               
                                                                                
*&&UK                                                                           
                                                                                
EIFA02   XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=CL2'SG'                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JE    EIFA08                                                           
                                                                                
         MVC   LP_ERROR,=AL2(AE$INLDG)                                          
         J     XERROR                                                           
                                                                                
EIFA08   MVC   X#SGOPOS,LDGAOP                                                  
*&&                                                                             
                                                                                
         OC    RQ_IACLI(RQ_IALNQ),SPACES                                        
         CLC   RQ_IACLI,SPACES                                                  
         JNE   EIFA10                                                           
                                                                                
         MVC   LP_ERROR,=AL2(AE$MSCLI)                                          
         J     XERROR                                                           
                                                                                
EIFA10   MVC   X#SJOFF,SPACES                                                   
         MVC   X#SJAD1(5*L'ADRADD1),SPACES                                      
         MVC   SJACCNT,SPACES                                                   
         MVC   SJACCNT(L'RQ_IACLI),RQ_IACLI                                     
         MVI   X#ETYP,1                                                         
         GOTOR GETSJA                                                           
         JE    EIFA12                                                           
                                                                                
         MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
                                                                                
EIFA12   MVC   X#CLINM,TEMP2                                                    
         MVC   X#CLIPN,TEMP2+36                                                 
         MVC   X#PRONM,SPACES                                                   
         MVC   X#PROPN,SPACES                                                   
         MVC   X#JOBNM,SPACES                                                   
         CLC   RQ_IAPRO,SPACES                                                  
         JNE   EIFA14                                                           
         CLC   RQ_IAJOB,SPACES                                                  
         JE    EIFA20                                                           
                                                                                
         MVC   LP_ERROR,=AL2(AE$RQDIN)                                          
         J     XERROR                                                           
                                                                                
EIFA14   LLC   R1,PCLILEN                                                       
         LA    R1,SJACCNT(R1)                                                   
         MVC   0(L'RQ_IAPRO,R1),RQ_IAPRO                                        
         MVI   X#ETYP,2                                                         
         GOTOR GETSJA                                                           
         JE    EIFA16                                                           
                                                                                
         MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
                                                                                
EIFA16   MVC   X#PRONM,TEMP2                                                    
         MVC   X#PROPN,TEMP2+36                                                 
         CLC   RQ_IAJOB,SPACES                                                  
         JE    EIFA20                                                           
                                                                                
         LLC   R1,PPROLEN                                                       
         LA    R1,SJACCNT(R1)                                                   
         LLC   RF,PPROLEN                                                       
         LA    RE,L'ACTKACT                                                     
         SR    RE,RF                                                            
         CHI   RE,L'RQ_IAJOB                                                    
         JNH   *+8                                                              
         LHI   RE,L'RQ_IAJOB                                                    
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),RQ_IAJOB                                                 
         EX    RE,0(RF)                                                         
         MVI   X#ETYP,3                                                         
         GOTOR GETSJA                                                           
         JE    EIFA18                                                           
                                                                                
         MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
                                                                                
EIFA18   MVC   X#JOBNM,TEMP2                                                    
                                                                                
EIFA20   CLC   X#SJOFF,SPACES      office set?                                  
         JE    EIFA22                                                           
                                                                                
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,X#SJOFF    move in office and validate                  
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JE    EIFA22                                                           
                                                                                
         MVC   LP_ERROR,=AL2(AE$SECLK)                                          
         J     XERROR                                                           
                                                                                
EIFA22   MVC   X#CLIC,RQ_IACLI       Save values for extra data                 
         MVC   X#PROC,RQ_IAPRO          and work code list download             
         MVC   X#JOBC,RQ_IAJOB                                                  
         MVC   X#MEDC,RQ_IAJOB                                                  
         MVC   X#SCHC,RQ_IASCH                                                  
                                                                                
EIFA24   XC    X#TEMP,X#TEMP                                                    
         LA    RF,X#TEMP                                                        
         MVC   0(L'RQ_IACLI+L'RQ_IAPRO+L'RQ_IAJOB,RF),RQ_IACLI                  
         AHI   RF,L'RQ_IACLI+L'RQ_IAPRO+L'RQ_IAJOB                              
         MVC   0(L'RQ_IAMED,RF),RQ_IAMED                                        
         GOTOR GETOMV              get opt/maint values                         
                                                                                
         CLC   RQ_IASCH,SPACES     validate scheme code                         
         JNE   EIFA26                                                           
                                                                                
         MVC   LP_ERROR,=AL2(AE$MISCH)                                          
         J     XERROR                                                           
                                                                                
EIFA26   GOTOR PROSCH              process scheme                               
         JE    EIFA28                                                           
                                                                                
         MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
                                                                                
EIFA28   GOTOR DOXDATA             Send extra data list                         
                                                                                
EIFA30   XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   EIFADLY             No                                           
         CLI   RQ_IAARW,YESQ       Can the user add work code rows              
         JNE   EIFADLY             No                                           
         GOTOR WCOLIS              Send work code list                          
                                                                                
EIFADLY  J     EXITY               Finished                                     
         DROP  RF                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* Estimates: list download                                            *         
***********************************************************************         
                                                                                
         USING LW_D,RF                                                          
ESTLST   DS    0H                                                               
                                                                                
         GOTOR TRACEIT,0           offline tracing request                      
                                                                                
ESTLST02 MVC   X#GAOV,RQ_ELGAO                                                  
         MVI   X#LLUIND,0          limit list use indicator                     
                                                                                
         GOTOR SETAPP,1                                                         
                                                                                
         OC    CCTPID,CCTPID       check connected PID code                     
         JNZ   ESTLST06                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$NCPID)                                           
         J     ESTLSTN                                                          
                                                                                
ESTLST06 CLI   RQ_ELTYP,RQ_ELTLQ   list for summary (recent estimates)?         
         JNE   ESTLST16                                                         
                                                                                
*  limit list call for schemes                                                  
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT4Q',TSARABUF),            +        
               ('GAPLLIML',SPACES),('GAPLTACC',GAPLPARM),('QEST',0)             
         JE    ESTLST08                                                         
         OI    X#LLUIND,X#LLUISQ   Schemes Limlist in use...                    
         J     ESTLST10            but no entries + default access=no           
                                                                                
K        USING GAPTABD,GAPAREA                                                  
ESTLST08 XC    GAPAREA,GAPAREA                                                  
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         CLC   K.GAPTACT,SPACES    if 1st entry is spaces, means...             
         JNH   ESTLST10            no entries + default access=yes              
         OI    X#LLUIND,X#LLUISQ   Schemes Limlist in use                       
         TM    ATSRERRS,TSEEOF                                                  
         JNZ   ESTLST10            End of buffer                                
         MVC   GAPAREA3,GAPAREA                                                 
         CLI   K.GAPTDAT1,GAPTT4Q                                               
         JNE   *+2                                                              
         DROP  K                                                                
                                                                                
ESTLST10 GOTOR SUMLST                                                           
         J     ESTLSTY                                                          
                                                                                
ESTLST16 CLI   RQ_ELOVL,C'Y'       Override limit list search                   
         JE    ESTLST20                                                         
         CLI   RQ_ELFLA,RQ_ELFAQ   No need to check for actioned by me          
         JE    ESTLST20                                                         
         MVC   GAPLRUNL,PRODUL                                                  
         MVC   GAPLRACT,SPACES     SJ account filter                            
         MVC   GAPLRACT(L'RQ_ELCLI),RQ_ELCLI                                    
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT21Q',TSARABUF),           +        
               ('GAPLLIML',GAPLRUNL),('GAPLTACC',GAPLPARM),('QEST',0)           
         JE    ESTLST18                                                         
         OI    X#LLUIND,X#LLUICQ   C/P/J Limlist in use...                      
         J     ESTLST20            but no entries + default access=no           
                                                                                
ESTLST18 GOTOR LLSUSE                                                           
                                                                                
ESTLST20 CLI   RQ_ELTYP,RQ_ELTAQ   account view                                 
         JNE   ESTLST40                                                         
                                                                                
         MVC   X#CLIC,RQ_ELCLI                                                  
         MVC   X#PROC,RQ_ELPRO                                                  
         MVC   X#JOBC,RQ_ELJOB                                                  
         MVC   X#CUROF,SPACES                                                   
         GOTOR ELMCPJ              validate C/P/J                               
         JNE   ESTLSTN                                                          
         CLI   BYTE4,YESQ          any estimates there?                         
         JNE   ESTLSTY                                                          
                                                                                
         XC    IOKEY,IOKEY                                                      
                                                                                
ESTLST30 GOTOR RESTBA              read for estimates by account                
         JNE   ESTLST90                                                         
                                                                                
         LA    R4,X#SSTAT                                                       
         MVC   L'STASTA1+L'STASTA2(L'STAAPPV,R4),RQ_ELAPP                       
         ST    R4,ASTALST                                                       
         GOTOR OUTEST              output estimate record                       
                                                                                
         J     ESTLST30                                                         
                                                                                
ESTLST40 CLI   RQ_ELTYP,RQ_ELTSQ   status view                                  
         JNE   ESTLST60                                                         
                                                                                
         GOTOR ELMSTA              validate status                              
         JNE   ESTLSTN                                                          
                                                                                
         XC    IOKEY,IOKEY                                                      
         LA    R4,X#SSTAT                                                       
         ST    R4,ASTALST                                                       
                                                                                
ESTLST50 GOTOR RESTOS              read for estimates by status                 
         JNE   ESTLST90                                                         
                                                                                
         GOTOR OUTEST              output estimate record                       
                                                                                
         CLI   X#GAOV,YESQ         TEST GAOV REQUEST                            
         JNE   ESTLST50                                                         
         LH    RF,X#ESTCNT                                                      
         CHI   RF,X#MAXGAO         TEST MAX N'ESTIMATES OUTPUT                  
         JNL   ESTLST90            FINISH                                       
         J     ESTLST50                                                         
                                                                                
ESTLST60 DC    H'0'                                                             
                                                                                
ESTLST90 DS    0H                  end of list                                  
                                                                                
ESTLSTY  DS    0H                                                               
                                                                                
         GOTOR TRACEIT,1           offline tracing IOs                          
                                                                                
         J     EXITY                                                            
                                                                                
ESTLSTNG MVC   ROUERRV,FULL2       MOVE GAPLST ERROR TO ROUERRV                 
ESTLSTN  MVC   LP_ERROR,ROUERRV                                                 
         J     EXITN                                                            
         DROP  RF                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* Estimates: search download                                          *         
***********************************************************************         
                                                                                
ESTSRC   DS    0H                                                               
*&&US                                                                           
         MVI   X#SRCCNT,250        set counter to 250 estimates                 
*&&                                                                             
                                                                                
         GOTOR TRACEIT,0           offline tracing request                      
                                                                                
         MVI   X#KTYPE,C' '        validate fields on set key type              
         MVC   X#CPMJ,SPACES                                                    
         MVI   X#DESCL,FF                                                       
         MVI   X#COMML,FF                                                       
         MVI   X#ACAPL,FF                                                       
         XC    X#OWNER,X#OWNER                                                  
         XC    X#CREBY,X#CREBY                                                  
         XC    X#ICAPP,X#ICAPP                                                  
         XC    X#INAPP,X#INAPP                                                  
         MVI   X#GAOV,NOQ                                                       
         GOTOR SETAPP              See if connected user is an approver         
                                                                                
         GOTOR SETLLS                deal with limit list first                 
         JNE   ESTSRCN                                                          
                                                                                
         OC    RQ_ESGLO,SPACES                                                  
         CLC   RQ_ESGLO,SPACES     - global number                              
         JNH   ESTSRC04                                                         
         MVI   X#KTYPE,C'N'          read by number                             
                                                                                
ESTSRC04 XC    X#MEDNO,X#MEDNO     check media list                             
         XC    X#MEDLS,X#MEDLS                                                  
         OC    RQ_ESMAD,RQ_ESMAD                                                
         JZ    ESTSRC10                                                         
                                                                                
         USING LW_D,R1                                                          
         XR    R1,R1               point to list in WMP                         
         ICM   R1,7,RQ_ESMAD                                                    
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        number of entries                            
         STC   R0,X#MEDNO                                                       
         LA    RF,LW_DATA2         start of list                                
         LA    RE,X#MEDLS                                                       
                                                                                
ESTSRC06 MVC   0(L'PMDKMED,RE),0(RF)                                            
         AHI   RF,L'PMDKMED                                                     
         AHI   RE,L'PMDKMED                                                     
         JCT   R0,ESTSRC06                                                      
                                                                                
         CLI   X#MEDNO,1                                                        
         JE    ESTSRC10                                                         
         LHI   R0,L'PMDKMED                                                     
         XR    RF,RF                                                            
         ICM   RF,3,LW_NUMN                                                     
         DROP  R1                                                               
         GOTO1 VXSORT,DMCB,X#MEDLS,(RF),(R0),(R0),0                             
                                                                                
ESTSRC10 OC    RQ_ESOFA,RQ_ESOFA     Office search?                             
         JZ    ESTSRC12                                                         
*                                                                               
         USING LW_D,R1                                                          
         XR    R1,R1               point to list in WMP                         
         ICM   R1,7,RQ_ESOFA                                                    
         XR    R3,R3                                                            
         ICM   R3,3,LW_NUMN                                                     
         LTR   R3,R3                                                            
         JZ    ESTSRCY             No entries?                                  
         STC   R3,X#OFFNO                                                       
         LA    RF,LW_DATA2         start of list                                
         STCM  RF,7,X#AOFFL                                                     
         MVI   X#KTYPE,X#ESOFF     Set to office search                         
         DROP  R1                                                               
*                                                                               
ESTSRC12 OC    RQ_ESCLI(RQ_ESL1Q),SPACES                                        
*                                                                               
         CLC   RQ_ESCLI,SPACES       Any client code?                           
         JNH   ESTSRC15                                                         
         GOTOR ESVCPJ                                                           
         JL    ESTSRCN               error and exit                             
         JH    ESTSRCY               exit and return                            
*                                                                               
ESTSRC15 CLC   RQ_ESDES,SPACES                                                  
         JNH   ESTSRC17                                                         
         GOTOR ESVDES                                                           
                                                                                
ESTSRC17 GOTOR ESVANS                Aura name search                           
         JNE   ESTSRCN               error and exit                             
                                                                                
ESTSRC20 OC    RQ_ESOWN,SPACES                                                  
         CLC   RQ_ESOWN,SPACES                                                  
         JE    ESTSRC25                                                         
         GOTOR ESVOWN,C'O'                                                      
         JNE   ESTSRCN                                                          
                                                                                
ESTSRC25 OC    RQ_ESCRB,SPACES                                                  
         CLC   RQ_ESCRB,SPACES                                                  
         JE    ESTSRC30                                                         
         GOTOR ESVOWN,C'C'                                                      
         JNE   ESTSRCN                                                          
                                                                                
ESTSRC30 DS    0H                                                               
                                                                                
ESTSRC70 OC    RQ_ESICA,SPACES                                                  
         CLC   RQ_ESICA,SPACES                                                  
         JE    ESTSRC72                                                         
         GOTOR ESVICA                                                           
         JNE   ESTSRCN                                                          
                                                                                
ESTSRC72 OC    RQ_ESIAA,SPACES                                                  
         CLC   RQ_ESIAA,SPACES                                                  
         JE    ESTSRC75                                                         
         GOTOR ESVIAP                                                           
         JNE   ESTSRCN                                                          
                                                                                
ESTSRC75 CLC   RQ_ESACO,SPACES                                                  
         JNH   ESTSRC80                                                         
         GOTOR ESVACO                                                           
                                                                                
ESTSRC80 OC    RQ_ESACA,SPACES                                                  
         CLC   RQ_ESACA,SPACES                                                  
         JE    ESTSRC85                                                         
         GOTOR ESVACA                                                           
                                                                                
ESTSRC85 GOTOR ESVSTA                                                           
         JNE   ESTSRCN                                                          
                                                                                
                                                                                
ESTSRC86 GOTOR ESVALL              'cross check'                                
         JNE   ESTSRCN                                                          
                                                                                
         XC    IOKEY,IOKEY         Clear iokey ready for processing             
         LA    R4,X#SSTAT          Set status list                              
         ST    R4,ASTALST                                                       
                                                                                
         XC    X#SVSJA,X#SVSJA                                                  
                                                                                
ESTSRC90 GOTOR RESTSR              read estimate/search module                  
         JNE   ESTSRC95                                                         
                                                                                
         GOTOR OUTEST              output estimate record                       
                                                                                
*&&UK*&& J     ESTSRC90                                                         
                                                                                
*&&US                                                                           
         XR    RF,RF               For aura ignore counter                      
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JE    ESTSRC90                                                         
         LLC   R1,X#SRCCNT         Decrement counter                            
         SHI   R1,1                                                             
         STC   R1,X#SRCCNT                                                      
         CLI   X#SRCCNT,0                                                       
         JNE   ESTSRC90                                                         
         MVC   ROUERRV,=AL2(AE$NASRC)                                           
         J     ESTSRCN                                                          
*&&                                                                             
                                                                                
ESTSRC95 DS    0H                  end of search                                
                                                                                
ESTSRCY  DS    0H                                                               
                                                                                
         GOTOR TRACEIT,1           offline tracing IOs                          
                                                                                
         J     EXITY                                                            
                                                                                
ESTSRCN  MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
         EJECT                                                                  
***********************************************************************         
* Estimates: display download                                         *         
***********************************************************************         
                                                                                
         USING LW_D,RF                                                          
K        USING GAPTABD,GAPAREA                                                  
ESTDIS   DS    0H                                                               
                                                                                
ESTDIS02 MVI   X#DDS,0             Patch to FF if DDS investigation             
                                                                                
         XR    RF,RF               If Aura check we can display est             
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ         BrandO has full access                       
         JNE   ESTDIS06                                                         
                                                                                
ESTDIS04 CLI   RQ_EDOVL,YESQ       Override limit list (view any est)?          
         JE    ESTDIS06                                                         
                                                                                
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSAINI',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
*                                  Build table for scheme/cli/med               
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT21Q',TSARABUF),           +        
               ('GAPLLIML',GAPLRUNL),('GAPLTACC',GAPLPARM),('QEST',0)           
         JNE   ESTDISNV                                                         
                                                                                
ESTDIS06 GOTOR SETAPP,0                                                         
                                                                                
         GOTOR SETDTS              set dates                                    
                                                                                
         XC    X#SVPID(X#SVPLQ),X#SVPID  clear optimisation values              
         XC    X#SVUID(X#SVULQ),X#SVUID                                         
                                                                                
         MVI   X#DISTYP,0          preset type                                  
         MVI   X#SBSIND,0                                                       
                                                                                
         XC    X#WCSEQ,X#WCSEQ     Clear W/C and item sequence                  
         XC    X#ITSEQ,X#ITSEQ                                                  
         XC    X#SVCAT,X#SVCAT     Clear saved category and work code           
         XC    X#SVWC,X#SVWC                                                    
                                                                                
*&&UK                                                                           
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=CL2'SG'                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JE    ESTDIS08                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$INLDG)                                           
         J     ESTDISN                                                          
                                                                                
ESTDIS08 MVC   X#SGOPOS,LDGAOP                                                  
*&&                                                                             
ESTDIS22 CLI   RQ_EDCOP,YESQ       copy action?                                 
         JNE   ESTDIS24                                                         
                                                                                
         GOTOR EDMVAL              validate estimate                            
         JNE   ESTDISN                                                          
                                                                                
         GOTOR EDCVAL              validate 'destination' (sets                 
         JNE   ESTDISN             X#DISTYP flags)                              
                                                                                
         J     ESTDIS28                                                         
                                                                                
ESTDIS24 GOTOR EDMVAL              validate estimate                            
         JNE   ESTDISN                                                          
                                                                                
ESTDIS26 CLI   RQ_EDOVL,YESQ       Override limit list (view any est)?          
         JE    ESTDIS28                                                         
         USING ESTRECD,R2                                                       
         USING EMDELD,R3                                                        
         L     R2,AIO2                                                          
         LA    R3,ESTRFST                                                       
         CLI   EMDEL,EMDELQ                                                     
         JNE   *+2                                                              
         CLC   EMDAPI,CCTPID       Check whether connected user added           
         JNE   ESTDIS27             estimates                                   
         CLI   RQ_EDOLA,YESQ         Do they have security to add               
         JE    ESTDIS28               estimates outside their limlist           
*                                      if so let them view estimate             
ESTDIS27 L     RF,=A(CHKVIEW)      Otherwise go through limlist check           
         A     RF,SRVRRELO                                                      
         BASR  RE,RF               Check user can view estimate                 
         JNE   ESTDISNV                                                         
                                                                                
ESTDIS28 GOTOR AURAMVP,1           Aura MVP version checks                      
         JNE   ESTDISN                                                          
         GOTOR EDMRGD              return global and audit data                 
         JNE   ESTDISN                                                          
                                                                                
ESTDIS30 LA    R2,IOKEY            build key for data record                    
         MVC   ESTKEY,CSVKEY1                                                   
         LLC   R1,ESTKSEQ                                                       
         AHI   R1,1                                                             
         STC   R1,ESTKSEQ                                                       
         MVC   CSVKEY1,ESTKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   ESTDIS60            finish off display                           
                                                                                
ESTDIS32 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
                                                                                
         USING XDFELD,R3                                                        
         L     R2,AIO2             loop through elements                        
         LA    R3,ESTRFST          (AIO2 for current record)                    
         J     ESTDIS40                                                         
                                                                                
ESTDIS35 LLC   R0,XDFLN                                                         
         AR    R3,R0                                                            
                                                                                
ESTDIS40 CLI   XDFEL,0             go for next record                           
         JE    ESTDIS30                                                         
                                                                                
         CLI   XDFEL,XDFELQ                                                     
         JNE   ESTDIS45                                                         
         GOTOR EDMXDF              Xtra data module                             
         J     ESTDIS35                                                         
                                                                                
ESTDIS45 CLI   XDFEL,ERDELQ                                                     
         JNE   ESTDIS50                                                         
         GOTOR AURAMVP,2           Aura MVP version checks                      
         JNE   ESTDISN                                                          
         GOTOR EDMROW              Row data element                             
         JNE   ESTDISN                                                          
         J     ESTDIS35                                                         
                                                                                
ESTDIS50 J     ESTDIS35            (ignore other elements)                      
         DROP  R2,R3                                                            
                                                                                
ESTDIS60 GOTOR DOXDATA             Send extra data list                         
                                                                                
ESTDIS70 CLI   RQ_EDARW,YESQ       Can the user add work code rows              
         JNE   ESTDISY                                                          
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   ESTDISY             No                                           
         CLI   X#MSTAT,RQ_ESSCQ    Is the status in progress                    
         JNE   ESTDISY             No - can't add work codes                    
         GOTOR WCOLIS              Send work code list                          
                                                                                
ESTDISY  J     EXITY                                                            
*                                                                               
ESTDISNV MVC   LP_ERROR,=AL2(AE$NOSTE)                                          
         J     XERROR              user cannot view estimate                    
                                                                                
ESTDISN  MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
         DROP  RF                                                               
                                                                                
***********************************************************************         
* Estimates: approvers download                                       *         
* (This is also used in the Client approver and Internal Approver     *         
* fields of the search dialogue)                                      *         
***********************************************************************         
                                                                                
         USING LW_D,RF                                                          
EAPPDL   DS    0H                                                               
                                                                                
         CLC   RQ_EAPID,SPACES     bring back specified person only?            
         JNH   EAPPDL00            (used in Search dialogue)                    
                                                                                
         GOTOR VSINPID             yes                                          
         JNE   EAPPDLN                                                          
         J     EAPPDLY                                                          
                                                                                
EAPPDL00 MVI   BYTE1,0                                                          
         XC    X#CLAP,X#CLAP                                                    
         XC    X#INAP,X#INAP                                                    
                                                                                
         CLI   RQ_EAALL,YESQ       bring back all Con/Sec persons?              
         JE    EAPPDL20            (used in Search dialogue)                    
                                                                                
         MVC   X#SJOFF,SPACES                                                   
                                                                                
         MVC   X#CRETR,CCTPID      Assume creator connected PID                 
*                                                                               
         CLC   RQ_EANUM,SPACES     global number specified?                     
         JNH   EAPPDL05                                                         
                                                                                
         GOTOR VAGEST              validate and get estimate details            
         JNE   EAPPDLN                                                          
                                                                                
         CLC   X#JOBC,SPACES                                                    
         JH    EAPPDL10                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$NLOWA)                                           
         J     EAPPDLN                                                          
                                                                                
EAPPDL05 GOTOR VALCPJ              validate Cli/Pro/Job                         
         JNE   EAPPDLN                                                          
                                                                                
EAPPDL10 GOTOR VALOFF              get client and product office codes          
                                                                                
         GOTOR PREAPP              get previous approver and check              
*                                  if still valid                               
         CLI   RQ_EAINT,C'B'                                                    
         JE    *+12                                                             
         CLI   RQ_EAINT,YESQ                                                    
         JNE   EAPPDL12                                                         
                                                                                
         GOTOR GTCAPP,1            get SJ internal approvers                    
         JNE   EAPPDLN                                                          
                                                                                
         GOTOR GTEAPP,1            get all (global) internal approvers          
         JNE   EAPPDLN                                                          
                                                                                
         CLI   RQ_EAINT,C'B'                                                    
         JE    EAPPDL12                                                         
         USING LAPPRTD,RF                                                       
         LA    RF,ACCBLK                                                        
         OC    LAPPRPID,LAPPRPID   any internal approvers?                      
         JNZ   EAPPDL15                                                         
                                                                                
EAPPDL12 GOTOR GTCAPP,2            get SJ estimate approvers                    
         JNE   EAPPDLN                                                          
                                                                                
         GOTOR GTEAPP,2            get all (global) estimate approvers          
         JNE   EAPPDLN                                                          
                                                                                
EAPPDL15 GOTOR OUTAPP              pass out all approvers                       
         JNE   EAPPDL20            no approvers found                           
         J     EAPPDLY                                                          
                                                                                
EAPPDL20 GOTOR GTAAPP              else get all and put them out                
         JE    EAPPDLY                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$MIAPP)                                           
         J     EAPPDLN                                                          
                                                                                
EAPPDLY  J     EXITY                                                            
                                                                                
EAPPDLN  MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
* REQUEST DEFINITIONS (REQUEST and OUTPUT)                            *         
***********************************************************************         
*** Initial for Add ***************************************************         
                                                                                
REQEIFA  LKREQ H,A#EIFA,OUTEIFA                                                 
                                                                                
CliC     LKREQ F,01,(D,B#SAVED,RQ_IACLI),CHAR,OLEN=L'RQ_IACLI,         X        
               MAXLEN=L'RQ_IACLI,TEXT=AC#CLIC,COL=*                             
ProC     LKREQ F,02,(D,B#SAVED,RQ_IAPRO),CHAR,OLEN=L'RQ_IAPRO,         X        
               MAXLEN=L'RQ_IAPRO,TEXT=AC#PROC,COL=*                             
JobC     LKREQ F,03,(D,B#SAVED,RQ_IAJOB),CHAR,OLEN=L'RQ_IAJOB,         X        
               MAXLEN=L'RQ_IAJOB,TEXT=AC#JOBC,COL=*                             
SchC     LKREQ F,04,(D,B#SAVED,RQ_IASCH),CHAR,OLEN=L'RQ_IASCH,         X        
               MAXLEN=L'RQ_IASCH,TEXT=AC#SCMCD,COL=*                            
MedC     LKREQ F,05,(D,B#SAVED,RQ_IAMED),CHAR,OLEN=L'RQ_IAMED,         X        
               MAXLEN=L'RQ_IAMED,TEXT=AC#MEDC,COL=*                             
Lang     LKREQ F,06,(D,B#SAVED,RQ_IALAN),CHAR,OLEN=L'RQ_IALAN,         X        
               MAXLEN=L'RQ_IALAN,TEXT=AC#LANG,COL=*                             
AddRw    LKREQ F,07,(D,B#SAVED,RQ_IAARW),CHAR,OLEN=L'RQ_IAARW,         X        
               MAXLEN=L'RQ_IAARW,TEXT=(*,ADDRWLIT),COL=*                        
                                                                                
         LKREQ E                                                                
                                                                                
*** Estimate Approvers ************************************************         
                                                                                
REQEAPP  LKREQ H,A#EAPP,OUTEAPP                                                 
                                                                                
CliC     LKREQ F,01,(D,B#SAVED,RQ_EACLI),CHAR,OLEN=L'RQ_EACLI,         X        
               MAXLEN=L'RQ_EACLI,TEXT=AC#CLIC,COL=*                             
ProC     LKREQ F,02,(D,B#SAVED,RQ_EAPRO),CHAR,OLEN=L'RQ_EAPRO,         X        
               MAXLEN=L'RQ_EAPRO,TEXT=AC#PROC,COL=*                             
JobC     LKREQ F,03,(D,B#SAVED,RQ_EAJOB),CHAR,OLEN=L'RQ_EAJOB,         X        
               MAXLEN=L'RQ_EAJOB,TEXT=AC#JOBC,COL=*                             
GNum     LKREQ F,04,(D,B#SAVED,RQ_EANUM),CHAR,OLEN=L'RQ_EANUM,         X        
               MAXLEN=L'RQ_EANUM,TEXT=AC#RSESB,COL=*                            
AllC     LKREQ F,05,(D,B#SAVED,RQ_EAALL),CHAR,OLEN=L'RQ_EAALL,         X        
               MAXLEN=L'RQ_EAALL,TEXT=AC#ALL,COL=*                              
*&&UK                                                                           
Sngl     LKREQ F,06,(D,B#SAVED,RQ_EAPID),CHAR,OLEN=L'RQ_EAPID,         X        
               MAXLEN=L'RQ_EAPID,TEXT=AC#PIDCD,COL=*                            
*&&                                                                             
*&&US                                                                           
Sngl     LKREQ F,06,(D,B#SAVED,RQ_EAPID),CHAR,OLEN=L'RQ_EAPID,         X        
               MAXLEN=L'RQ_EAPID,TEXT=AC#RSPID,COL=*                            
*&&                                                                             
IntAp    LKREQ F,07,(D,B#SAVED,RQ_EAINT),CHAR,OLEN=L'RQ_EAINT,         X        
               MAXLEN=L'RQ_EAINT,TEXT=AC#INTAR,COL=*                            
                                                                                
Appl     LKREQ F,08,(D,B#SAVED,RQ_EAAPL),LBIN,OLEN=L'RQ_EAAPL,         X        
               MAXLEN=L'RQ_EAAPL,TEXT=AC#APPLI,COL=*                            
                                                                                
Appr     LKREQ F,09,(D,B#SAVED,RQ_EAAPR),CHAR,OLEN=L'RQ_EAAPR,         X        
               MAXLEN=L'RQ_EAAPR,TEXT=AC#APRVR,COL=*                            
                                                                                
         LKREQ E                                                                
                                                                                
*** Estimate List *****************************************************         
                                                                                
REQELIS  LKREQ H,A#ELIS,OUTELIS                                                 
                                                                                
Type     LKREQ F,01,(D,B#SAVED,RQ_ELTYP),CHAR,OLEN=L'RQ_ELTYP,         X        
               MAXLEN=L'RQ_ELTYP,TEXT=AC#TYPE,COL=*                             
CliC     LKREQ F,02,(D,B#SAVED,RQ_ELCLI),CHAR,OLEN=L'RQ_ELCLI,         X        
               MAXLEN=L'RQ_ELCLI,TEXT=AC#CLIC,COL=*                             
ProC     LKREQ F,03,(D,B#SAVED,RQ_ELPRO),CHAR,OLEN=L'RQ_ELPRO,         X        
               MAXLEN=L'RQ_ELPRO,TEXT=AC#PROC,COL=*                             
JobC     LKREQ F,04,(D,B#SAVED,RQ_ELJOB),CHAR,OLEN=L'RQ_ELJOB,         X        
               MAXLEN=L'RQ_ELJOB,TEXT=AC#JOBC,COL=*                             
Stat     LKREQ F,05,(I,B#SAVED,RQ_ELSIN),CHAR,OLEN=L'ESTKSTA1,         X        
               LIST=(F,NOSORT),TEXT=AC#STT,COL=*                                
Appr     LKREQ F,06,(D,B#SAVED,RQ_ELAPP),CHAR,OLEN=L'RQ_ELAPP,         X        
               MAXLEN=L'RQ_ELAPP,TEXT=AC#APRVR,COL=*                            
GAOV     LKREQ F,07,(D,B#SAVED,RQ_ELGAO),CHAR,OLEN=L'RQ_ELGAO,         X        
               MAXLEN=L'RQ_ELGAO,TEXT=AC#GAOV,COL=*                             
OvLL     LKREQ F,08,(D,B#SAVED,RQ_ELOVL),CHAR,OLEN=L'RQ_ELOVL,         X        
               MAXLEN=L'RQ_ELOVL,TEXT=AC#LIMLS,COL=*                            
Flavour  LKREQ F,09,(D,B#SAVED,RQ_ELFLA),CHAR,OLEN=L'RQ_ELFLA,         X        
               MAXLEN=L'RQ_ELFLA,TEXT=(*,FLAVLIT),COL=*                         
                                                                                
         LKREQ E                                                                
                                                                                
*** Estimate Search ***************************************************         
                                                                                
REQESRC  LKREQ H,A#ESRC,OUTESRC                                                 
                                                                                
CliC     LKREQ F,01,(D,B#SAVED,RQ_ESCLI),CHAR,OLEN=L'RQ_ESCLI,         X        
               MAXLEN=L'RQ_ESCLI,TEXT=AC#CLIC,COL=*                             
ProC     LKREQ F,02,(D,B#SAVED,RQ_ESPRO),CHAR,OLEN=L'RQ_ESPRO,         X        
               MAXLEN=L'RQ_ESPRO,TEXT=AC#PROC,COL=*                             
MediaC   LKREQ F,03,(I,B#SAVED,RQ_ESMIN),CHAR,OLEN=L'PMDKMED,          X        
               LIST=(F,NOSORT),TEXT=AC#MEDC,COL=*                               
JobC     LKREQ F,04,(D,B#SAVED,RQ_ESJOB),CHAR,OLEN=L'RQ_ESJOB,         X        
               MAXLEN=L'RQ_ESJOB,TEXT=AC#JOBC,COL=*                             
GloN     LKREQ F,05,(D,B#SAVED,RQ_ESGLO),CHAR,OLEN=L'RQ_ESGLO,         X        
               MAXLEN=L'RQ_ESGLO,TEXT=AC#ESTNO,COL=*                            
Desc     LKREQ F,06,(D,B#SAVED,RQ_ESDES),CHAR,OLEN=L'RQ_ESDES,         X        
               MAXLEN=L'RQ_ESDES,TEXT=AC#ESTNM,COL=*                            
Ownr     LKREQ F,07,(D,B#SAVED,RQ_ESOWN),CHAR,OLEN=L'RQ_ESOWN,         X        
               MAXLEN=L'RQ_ESOWN,TEXT=AC#OWNER,COL=*                            
Curr     LKREQ F,08,(D,B#SAVED,RQ_ESCUR),CHAR,OLEN=L'RQ_ESCUR,         X        
               MAXLEN=L'RQ_ESCUR,TEXT=AC#CURRC,COL=*                            
ADSt     LKREQ F,09,(D,B#SAVED,RQ_ESADS),PDAT,OLEN=L'RQ_ESADS,         X        
               TEXT=AC#CRTDT,COL=*                                              
ADEn     LKREQ F,10,(D,B#SAVED,RQ_ESADE),PDAT,OLEN=L'RQ_ESADE,         X        
               TEXT=AC#ENDDT,COL=*                                              
LDSt     LKREQ F,11,(D,B#SAVED,RQ_ESLDS),PDAT,OLEN=L'RQ_ESLDS,         X        
               TEXT=AC#ACTST,COL=*                                              
LDEn     LKREQ F,12,(D,B#SAVED,RQ_ESLDE),PDAT,OLEN=L'RQ_ESLDE,         X        
               TEXT=AC#ACTND,COL=*                                              
InCA     LKREQ F,13,(D,B#SAVED,RQ_ESICA),CHAR,OLEN=L'RQ_ESICA,         X        
               MAXLEN=L'RQ_ESICA,TEXT=AC#APRVR,COL=*                            
ApCo     LKREQ F,14,(D,B#SAVED,RQ_ESACO),CHAR,OLEN=L'RQ_ESACO,         X        
               MAXLEN=L'RQ_ESACO,TEXT=AC#CMT,COL=*                              
Stat     LKREQ F,15,(I,B#SAVED,RQ_ESSIN),CHAR,OLEN=L'ESTKSTA1,         X        
               LIST=(F,NOSORT),TEXT=AC#STT,COL=*                                
ClAp     LKREQ F,16,(D,B#SAVED,RQ_ESACA),CHAR,OLEN=L'RQ_ESACA,         X        
               MAXLEN=L'RQ_ESACA,TEXT=AC#CLIAP,COL=*                            
CASt     LKREQ F,17,(D,B#SAVED,RQ_ESAAE),PDAT,OLEN=L'RQ_ESAAE,         X        
               TEXT=AC#STEND,COL=*                                              
CAEn     LKREQ F,18,(D,B#SAVED,RQ_ESAAS),PDAT,OLEN=L'RQ_ESAAS,         X        
               TEXT=AC#STEND,COL=*                                              
InAp     LKREQ F,21,(D,B#SAVED,RQ_ESIAA),CHAR,OLEN=L'RQ_ESIAA,         X        
               MAXLEN=L'RQ_ESIAA,TEXT=AC#APRVR,COL=*                            
IASt     LKREQ F,22,(D,B#SAVED,RQ_ESIAS),PDAT,OLEN=L'RQ_ESIAS,         X        
               TEXT=AC#STEND,COL=*                                              
IAEn     LKREQ F,23,(D,B#SAVED,RQ_ESIAE),PDAT,OLEN=L'RQ_ESIAE,         X        
               TEXT=AC#STEND,COL=*                                              
*&&UK                                                                           
SrOv     LKREQ F,24,(D,B#SAVED,RQ_ESOVR),CHAR,OLEN=L'RQ_ESOVR,         X        
               MAXLEN=L'RQ_ESOVR,TEXT=AC#SRCOV,COL=*                            
*&&                                                                             
*&&US                                                                           
SrOv     LKREQ F,24,(D,B#SAVED,RQ_ESOVR),CHAR,OLEN=L'RQ_ESOVR,         X        
               MAXLEN=L'RQ_ESOVR,TEXT=(*,SRCOLIT),COL=*                         
*&&                                                                             
Lckd     LKREQ F,25,(D,B#SAVED,RQ_ESLKD),CHAR,OLEN=L'RQ_ESLKD,         +        
               MAXLEN=L'RQ_ESLKD,TEXT=(*,LCKDLIT),COL=*                         
Clsd     LKREQ F,26,(D,B#SAVED,RQ_ESCLS),CHAR,OLEN=L'RQ_ESCLS,         +        
               MAXLEN=L'RQ_ESCLS,TEXT=(*,CLSDLIT),COL=*                         
EsSDte   LKREQ F,27,(D,B#SAVED,RQ_ESSTR),PDAT,OLEN=L'RQ_ESSTR,         +        
               TEXT=(*,STRTLIT),COL=*                                           
EsEDte   LKREQ F,28,(D,B#SAVED,RQ_ESEND),PDAT,OLEN=L'RQ_ESEND,         +        
               TEXT=(*,ENDLIT),COL=*                                            
CreatBy  LKREQ F,29,(D,B#SAVED,RQ_ESCRB),CHAR,OLEN=L'RQ_ESCRB,         X        
               MAXLEN=L'RQ_ESCRB,TEXT=AC#CRTDB,COL=*                            
NamSrch  LKREQ F,30,(I,B#SAVED,RQ_ESNIN),CHAR,OLEN=L'SRCKWRD1,         X        
               LIST=(F,NOSORT),LOWERCASE=Y,TEXT=AC#NAME,COL=*                   
SrOvA    LKREQ F,31,(D,B#SAVED,RQ_ESOVA),CHAR,OLEN=L'RQ_ESOVA,         X        
               MAXLEN=L'RQ_ESOVA,TEXT=(*,SRCOLIT),COL=*                         
Office   LKREQ F,32,(I,B#SAVED,RQ_ESOFI),CHAR,OLEN=L'OFFKOFF,          X        
               LIST=(F,NOSORT),TEXT=AC#OFFC,COL=*                               
                                                                                
         LKREQ E                                                                
                                                                                
*** Estimate Display **************************************************         
                                                                                
REQEDIS  LKREQ H,A#EDIS,OUTEDIS                                                 
                                                                                
Est#     LKREQ F,01,(D,B#SAVED,RQ_EDEST),CHAR,OLEN=L'RQ_EDEST,         X        
               MAXLEN=L'RQ_EDEST,TEXT=AC#RSESB,COL=*                            
Copy     LKREQ F,02,(D,B#SAVED,RQ_EDCOP),CHAR,OLEN=L'RQ_EDCOP,         X        
               MAXLEN=L'RQ_EDCOP,TEXT=AC#REMC2,COL=*                            
CliC     LKREQ F,03,(D,B#SAVED,RQ_EDCLI),CHAR,OLEN=L'RQ_EDCLI,         X        
               MAXLEN=L'RQ_EDCLI,TEXT=AC#CLIC,COL=*                             
ProC     LKREQ F,04,(D,B#SAVED,RQ_EDPRO),CHAR,OLEN=L'RQ_EDPRO,         X        
               MAXLEN=L'RQ_EDPRO,TEXT=AC#PROC,COL=*                             
JobC     LKREQ F,05,(D,B#SAVED,RQ_EDJOB),CHAR,OLEN=L'RQ_EDJOB,         X        
               MAXLEN=L'RQ_EDJOB,TEXT=AC#JOBC,COL=*                             
CCur     LKREQ F,10,(D,B#SAVED,RQ_EDCCC),CHAR,OLEN=L'RQ_EDCCC,         X        
               MAXLEN=L'RQ_EDCCC,TEXT=AC#CURRC,COL=*                            
CExc     LKREQ F,11,(D,B#SAVED,RQ_EDCEX),CHAR,OLEN=L'RQ_EDCEX,         X        
               MAXLEN=L'RQ_EDCEX,TEXT=AC#EXCHR,COL=*                            
ClPrJob  LKREQ F,21,(D,B#SAVED,RQ_EDCPJ),CHAR,OLEN=L'RQ_EDCPJ,         X        
               MAXLEN=L'RQ_EDCPJ,TEXT=AC#CLPJO,COL=*                            
Local#   LKREQ F,22,(D,B#SAVED,RQ_EDLNO),UBIN,OLEN=L'RQ_EDLNO,         X        
               MAXLEN=3,TEXT=AC#SNUMR,COL=*                                     
Ovll     LKREQ F,23,(D,B#SAVED,RQ_EDOVL),CHAR,OLEN=L'RQ_EDOVL,         X        
               MAXLEN=L'RQ_EDOVL,TEXT=AC#LIMLS,COL=*                            
AddRw    LKREQ F,24,(D,B#SAVED,RQ_EDARW),CHAR,OLEN=L'RQ_EDARW,         X        
               MAXLEN=L'RQ_EDARW,TEXT=(*,ADDRWLIT),COL=*                        
PDF      LKREQ F,25,(D,B#SAVED,RQ_EDPDF),CHAR,OLEN=L'RQ_EDPDF,         X        
               MAXLEN=L'RQ_EDPDF,TEXT=(*,PDFLIT),COL=*                          
Ovlla    LKREQ F,26,(D,B#SAVED,RQ_EDOLA),CHAR,OLEN=L'RQ_EDOLA,         X        
               MAXLEN=L'RQ_EDOLA,TEXT=AC#LIMLS,COL=*                            
                                                                                
         LKREQ E                                                                
                                                                                
         LKREQ X                                                                
                                                                                
         EJECT                                                                  
***********************************************************************         
* OUTPUT MAPS                                                         *         
***********************************************************************         
                                                                                
*** Initial for Add ***************************************************         
                                                                                
OUTEIFA  LKOUT H                                                                
OUTEIFAS LKOUT R,R#EIFA                                                         
                                                                                
RTyp     LKOUT C,01,(D,B#SAVED,IA_RTYPE),CHAR,ND=Y                              
SchN     LKOUT C,02,(D,B#SAVED,IA_SCHNA),CHAR,ND=Y                              
CCod     LKOUT C,03,(D,B#SAVED,IA_CACOD),CHAR,ND=Y                              
CNam     LKOUT C,04,(D,B#SAVED,IA_CANAM),CHAR,ND=Y                              
CTNa     LKOUT C,05,(D,B#SAVED,IA_CATNA),CHAR,ND=Y                              
CIns     LKOUT C,06,(D,B#SAVED,IA_CAINS),CHAR,ND=Y                              
CSta     LKOUT C,09,(D,B#SAVED,IA_CASTA),CHAR,ND=Y                              
CTyp     LKOUT C,10,(D,B#SAVED,IA_CATYP),CHAR,ND=Y                              
WTyp     LKOUT C,11,(D,B#SAVED,IA_WCTYP),CHAR,ND=Y                              
WCod     LKOUT C,12,(D,B#SAVED,IA_WCCOD),CHAR,ND=Y                              
WDes     LKOUT C,13,(D,B#SAVED,IA_WCDES),CHAR,ND=Y                              
WArt     LKOUT C,14,(D,B#SAVED,IA_WCART),CHAR,ND=Y                              
OffC     LKOUT C,15,(D,B#SAVED,IA_OFFCD),CHAR,ND=Y                              
WCom     LKOUT C,16,(D,B#SAVED,IA_WCACR),SPAK,ND=Y,PZERO=S                      
WVAT     LKOUT C,17,(D,B#SAVED,IA_WCOVR),LBIN,ND=Y                              
WVCo     LKOUT C,18,(D,B#SAVED,IA_WCOVC),CHAR,ND=Y                              
Frmt     LKOUT C,19,(D,B#SAVED,IA_FRMTC),CHAR,ND=Y                              
IsFL     LKOUT C,20,(D,B#SAVED,IA_JBIFL),CHAR,ND=Y                              
JSta     LKOUT C,22,(D,B#SAVED,IA_JOBST),CHAR,ND=Y                              
CPNa     LKOUT C,23,(D,B#SAVED,IA_CLIPN),CHAR,ND=Y                              
PPNa     LKOUT C,24,(D,B#SAVED,IA_PROPN),CHAR,ND=Y                              
SJA1     LKOUT C,25,(D,B#SAVED,IA_SJAD1),CHAR,ND=Y                              
SJA2     LKOUT C,26,(D,B#SAVED,IA_SJAD2),CHAR,ND=Y                              
SJA3     LKOUT C,27,(D,B#SAVED,IA_SJAD3),CHAR,ND=Y                              
SJA4     LKOUT C,28,(D,B#SAVED,IA_SJAD4),CHAR,ND=Y                              
SJA5     LKOUT C,29,(D,B#SAVED,IA_SJAD5),CHAR,ND=Y                              
WCCC     LKOUT C,30,(D,B#SAVED,IA_WCCAT),CHAR,ND=Y                              
WCPc     LKOUT C,31,(D,B#SAVED,IA_WCESP),SPAK,ND=Y,PZERO=S                      
InUs     LKOUT C,32,(D,B#SAVED,IA_INTUS),CHAR,ND=Y                              
TxtCop   LKOUT C,33,(D,B#SAVED,IA_TXTCP),CHAR,ND=Y                              
UnCom    LKOUT C,34,(D,B#SAVED,IA_UNCOM),CHAR,ND=Y                              
OrInPr   LKOUT C,35,(D,B#SAVED,IA_ORIPR),CHAR,ND=Y                              
OrSubI   LKOUT C,36,(D,B#SAVED,IA_ORSUI),CHAR,ND=Y                              
OrIapp   LKOUT C,37,(D,B#SAVED,IA_ORIAP),CHAR,ND=Y                              
OrSubC   LKOUT C,38,(D,B#SAVED,IA_ORSUC),CHAR,ND=Y                              
OrClAp   LKOUT C,39,(D,B#SAVED,IA_ORCAP),CHAR,ND=Y                              
UACWC    LKOUT C,40,(D,B#SAVED,IA_WIAC),CHAR,ND=Y                               
PrRate   LKOUT C,41,(D,B#SAVED,IA_PRRAT),CHAR,ND=Y                              
CCWc     LKOUT C,42,(D,B#SAVED,IA_CCWC),CHAR,ND=Y                               
WCflg    LKOUT C,43,(D,B#SAVED,IA_WCF),CHAR,ND=Y                                
WCEsCk   LKOUT C,44,(D,B#SAVED,IA_WESCK),CHAR,ND=Y                              
WCSeq    LKOUT C,45,(D,B#SAVED,IA_WCSEQ),LBIN,ND=Y                              
                                                                                
         LKOUT E                                                                
                                                                                
*** Estimate Init for Add XData return ********************************         
                                                                                
OUTIAXDS LKOUT R,R#XDFA                                                         
                                                                                
Fieldcd  LKOUT C,01,(D,B#SAVED,XD_PTRS),(U,#EDTHEX,$EDTHEX),ND=Y                
Field    LKOUT C,02,(D,B#SAVED,XD_CODE),CHAR,ND=Y                               
DataTyp  LKOUT C,03,(D,B#SAVED,XD_EDIT),CHAR,ND=Y                               
FieldLn  LKOUT C,04,(D,B#SAVED,XD_MXLN),LBIN,ND=Y                               
FieldRq  LKOUT C,05,(D,B#SAVED,XD_REQD),CHAR,ND=Y                               
FieldAc  LKOUT C,06,(D,B#SAVED,XD_ACTV),CHAR,ND=Y                               
FieldNm  LKOUT C,07,(D,B#SAVED,XD_NAME),CHAR,ND=Y                               
                                                                                
         LKOUT E                                                                
                                                                                
*** Estimate Init for Add XData List return ***************************         
                                                                                
OUTIAXLS LKOUT R,R#XDFL                                                         
                                                                                
Deflt    LKOUT C,08,(D,B#SAVED,XD_STAT),CHAR,ND=Y                               
FieldNm  LKOUT C,09,(D,B#SAVED,XD_LDAT),CHAR,ND=Y                               
FieldAct LKOUT C,10,(D,B#SAVED,XD_ACTL),CHAR,ND=Y                               
                                                                                
         LKOUT E                                                                
                                                                                
*** Estimate Init for Add work code list return ***********************         
                                                                                
OUTIAWCL LKOUT R,R#WCOL                                                         
                                                                                
WC       LKOUT C,01,(D,B#SAVED,WL_WC),CHAR,ND=Y                                 
WCDes    LKOUT C,02,(D,B#SAVED,WL_DESC),CHAR,ND=Y                               
Group    LKOUT C,03,(D,B#SAVED,WL_GRP),CHAR,ND=Y                                
Status   LKOUT C,04,(D,B#SAVED,WL_STAT),CHAR,ND=Y                               
Artist   LKOUT C,05,(D,B#SAVED,WL_ART),CHAR,ND=Y                                
Comm     LKOUT C,06,(D,B#SAVED,WL_COMM),SPAK,ND=Y,PZERO=S                       
VATr     LKOUT C,07,(D,B#SAVED,WL_VATR),CHAR,ND=Y                               
VATc     LKOUT C,08,(D,B#SAVED,WL_VATC),CHAR,ND=Y                               
VATn     LKOUT C,09,(D,B#SAVED,WL_VATN),CHAR,ND=Y                               
ForDesc  LKOUT C,10,(D,B#SAVED,WL_FDES),CHAR,ND=Y                               
EstChk   LKOUT C,24,(D,B#SAVED,WL_EST),CHAR,ND=Y                                
CCW      LKOUT C,25,(D,B#SAVED,WL_CCW),CHAR,ND=Y                                
WCF      LKOUT C,26,(D,B#SAVED,WL_WCF),CHAR,ND=Y                                
                                                                                
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
*** Estmate Approvers *************************************************         
                                                                                
OUTEAPP  LKOUT H                                                                
OUTEAPPS LKOUT R,R#EAPP                                                         
                                                                                
PID      LKOUT C,01,(D,B#SAVED,EA_CODE),CHAR,ND=Y                               
FNam     LKOUT C,02,(D,B#SAVED,EA_FNAM),CHAR,ND=Y                               
LNam     LKOUT C,03,(D,B#SAVED,EA_LNAM),CHAR,ND=Y                               
IDef     LKOUT C,04,(D,B#SAVED,EA_IDEF),CHAR,ND=Y                               
ApTy     LKOUT C,05,(D,B#SAVED,EA_APTY),CHAR,ND=Y                               
ApLv     LKOUT C,06,(D,B#SAVED,EA_ALEV),HEXD,ND=Y                               
MNam     LKOUT C,07,(D,B#SAVED,EA_MNAM),CHAR,ND=Y                               
PIN      LKOUT C,08,(D,B#SAVED,EA_BPID),HEXD,ND=Y                               
                                                                                
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
*** Estimate List *****************************************************         
                                                                                
OUTELIS  LKOUT H                                                                
OUTELISS LKOUT R,R#ELIS                                                         
                                                                                
Glo#     LKOUT C,01,(D,B#SAVED,EL_GLNO),CHAR,ND=Y                               
Loc#     LKOUT C,02,(D,B#SAVED,EL_LONO),LBIN,ND=Y                               
Name     LKOUT C,03,(D,B#SAVED,EL_NAME),CHAR,ND=Y                               
Adde     LKOUT C,04,(D,B#SAVED,EL_ADDD),PDAT,ND=Y                               
Acty     LKOUT C,05,(D,B#SAVED,EL_ACTD),PDAT,ND=Y                               
Stat     LKOUT C,06,(D,B#SAVED,EL_STAT),CHAR,ND=Y                               
MedC     LKOUT C,07,(D,B#SAVED,EL_MEDC),CHAR,ND=Y                               
MedN     LKOUT C,08,(D,B#SAVED,EL_MEDN),CHAR,ND=Y                               
CliC     LKOUT C,09,(D,B#SAVED,EL_CLIC),CHAR,ND=Y                               
CliN     LKOUT C,10,(D,B#SAVED,EL_CLIN),CHAR,ND=Y                               
ProC     LKOUT C,11,(D,B#SAVED,EL_PROC),CHAR,ND=Y                               
ProN     LKOUT C,12,(D,B#SAVED,EL_PRON),CHAR,ND=Y                               
JobC     LKOUT C,13,(D,B#SAVED,EL_JOBC),CHAR,ND=Y                               
JobN     LKOUT C,14,(D,B#SAVED,EL_JOBN),CHAR,ND=Y                               
JobL     LKOUT C,15,(D,B#SAVED,EL_JOBL),CHAR,ND=Y                               
TotA     LKOUT C,16,(D,B#SAVED,EL_TAMT),SPAK,ND=Y                               
TotF     LKOUT C,17,(D,B#SAVED,EL_FAMT),SPAK,ND=Y                               
AddP     LKOUT C,18,(D,B#SAVED,EL_ADDP),CHAR,ND=Y                               
AddF     LKOUT C,19,(D,B#SAVED,EL_ADDF),CHAR,ND=Y                               
AddL     LKOUT C,20,(D,B#SAVED,EL_ADDL),CHAR,ND=Y                               
ActP     LKOUT C,21,(D,B#SAVED,EL_ACTP),CHAR,ND=Y                               
ActF     LKOUT C,22,(D,B#SAVED,EL_ACTF),CHAR,ND=Y                               
ActL     LKOUT C,23,(D,B#SAVED,EL_ACTL),CHAR,ND=Y                               
CurC     LKOUT C,24,(D,B#SAVED,EL_CURR),CHAR,ND=Y                               
Nodp     LKOUT C,25,(D,B#SAVED,EL_NODP),CHAR,ND=Y                               
TotF     LKOUT C,26,(D,B#SAVED,EL_FAMT),SPAK,ND=Y                               
IDNo     LKOUT C,27,(D,B#SAVED,EL_IDNO),HEXD,ND=Y                               
ASta     LKOUT C,28,(D,B#SAVED,EL_ASTA),CHAR,ND=Y                               
SCAP     LKOUT C,29,(D,B#SAVED,EL_SCAP),CHAR,ND=Y                               
SCAF     LKOUT C,30,(D,B#SAVED,EL_SCAF),CHAR,ND=Y                               
SCAL     LKOUT C,31,(D,B#SAVED,EL_SCAL),CHAR,ND=Y                               
JSta     LKOUT C,32,(D,B#SAVED,EL_JOBS),CHAR,ND=Y                               
SchC     LKOUT C,33,(D,B#SAVED,EL_SCHC),CHAR,ND=Y                               
ActT     LKOUT C,34,(D,B#SAVED,EL_ACTT),CHAR,ND=Y                               
ConI     LKOUT C,35,(D,B#SAVED,EL_CONI),CHAR,ND=Y                               
ConC     LKOUT C,36,(D,B#SAVED,EL_CONC),CHAR,ND=Y                               
IntU     LKOUT C,37,(D,B#SAVED,EL_INTU),CHAR,ND=Y                               
SIAP     LKOUT C,38,(D,B#SAVED,EL_SIAP),CHAR,ND=Y                               
LGAPst   LKOUT C,45,(D,B#SAVED,EL_GAPST),LBIN,ND=Y                              
LGAPsd   LKOUT C,46,(D,B#SAVED,EL_GAPSD),PDAT,ND=Y                              
LGAPed   LKOUT C,47,(D,B#SAVED,EL_GAPED),PDAT,ND=Y                              
PrRates  LKOUT C,50,(D,B#SAVED,EL_PRRAT),CHAR,ND=Y                              
JClose   LKOUT C,51,(D,B#SAVED,EL_JOBCL),CHAR,ND=Y                              
Edat     LKOUT C,52,(D,B#SAVED,EL_EDAT),PDAT,ND=Y                               
AgyCurr  LKOUT C,53,(D,B#SAVED,EL_ACUR),CHAR,ND=Y                               
*&&US                                                                           
HR#      LKOUT C,54,(D,B#SAVED,EL_AEHR),LBIN,ND=Y                               
OE#      LKOUT C,55,(D,B#SAVED,EL_AEOE),LBIN,ND=Y                               
CE#      LKOUT C,56,(D,B#SAVED,EL_AECE),LBIN,ND=Y                               
*&&                                                                             
HrsWc    LKOUT C,57,(D,B#SAVED,EL_WCTM),CHAR,ND=Y                               
HrsItm   LKOUT C,58,(D,B#SAVED,EL_ITTM),CHAR,ND=Y                               
Itms     LKOUT C,59,(D,B#SAVED,EL_ITMS),CHAR,ND=Y                               
Flt1     LKOUT C,60,(D,B#SAVED,EL_FLT1),CHAR,ND=Y                               
Flt2     LKOUT C,61,(D,B#SAVED,EL_FLT2),CHAR,ND=Y                               
Flt3     LKOUT C,62,(D,B#SAVED,EL_FLT3),CHAR,ND=Y                               
Flt4     LKOUT C,63,(D,B#SAVED,EL_FLT4),CHAR,ND=Y                               
Flt5     LKOUT C,64,(D,B#SAVED,EL_FLT5),CHAR,ND=Y                               
AprDte   LKOUT C,65,(D,B#SAVED,EL_APDT),PDAT,ND=Y                               
Esoff    LKOUT C,66,(D,B#SAVED,EL_OFFC),CHAR,ND=Y                               
IWcTot   LKOUT C,67,(D,B#SAVED,EL_IWCT),SPAK,ND=Y                               
XWcTot   LKOUT C,68,(D,B#SAVED,EL_XWCT),SPAK,ND=Y                               
                                                                                
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
*** Estimate Search (same as List) ************************************         
                                                                                
OUTESRC  LKOUT H                                                                
OUTESRCS LKOUT R,R#ESRC                                                         
                                                                                
Glo#     LKOUT C,01,(D,B#SAVED,EL_GLNO),CHAR,ND=Y                               
Loc#     LKOUT C,02,(D,B#SAVED,EL_LONO),LBIN,ND=Y                               
Name     LKOUT C,03,(D,B#SAVED,EL_NAME),CHAR,ND=Y                               
Adde     LKOUT C,04,(D,B#SAVED,EL_ADDD),PDAT,ND=Y                               
Acty     LKOUT C,05,(D,B#SAVED,EL_ACTD),PDAT,ND=Y                               
Stat     LKOUT C,06,(D,B#SAVED,EL_STAT),CHAR,ND=Y                               
MedC     LKOUT C,07,(D,B#SAVED,EL_MEDC),CHAR,ND=Y                               
MedN     LKOUT C,08,(D,B#SAVED,EL_MEDN),CHAR,ND=Y                               
CliC     LKOUT C,09,(D,B#SAVED,EL_CLIC),CHAR,ND=Y                               
CliN     LKOUT C,10,(D,B#SAVED,EL_CLIN),CHAR,ND=Y                               
ProC     LKOUT C,11,(D,B#SAVED,EL_PROC),CHAR,ND=Y                               
ProN     LKOUT C,12,(D,B#SAVED,EL_PRON),CHAR,ND=Y                               
JobC     LKOUT C,13,(D,B#SAVED,EL_JOBC),CHAR,ND=Y                               
JobN     LKOUT C,14,(D,B#SAVED,EL_JOBN),CHAR,ND=Y                               
JobL     LKOUT C,15,(D,B#SAVED,EL_JOBL),CHAR,ND=Y                               
TotA     LKOUT C,16,(D,B#SAVED,EL_TAMT),SPAK,ND=Y                               
TotF     LKOUT C,17,(D,B#SAVED,EL_FAMT),SPAK,ND=Y                               
AddP     LKOUT C,18,(D,B#SAVED,EL_ADDP),CHAR,ND=Y                               
AddF     LKOUT C,19,(D,B#SAVED,EL_ADDF),CHAR,ND=Y                               
AddL     LKOUT C,20,(D,B#SAVED,EL_ADDL),CHAR,ND=Y                               
ActP     LKOUT C,21,(D,B#SAVED,EL_ACTP),CHAR,ND=Y                               
ActF     LKOUT C,22,(D,B#SAVED,EL_ACTF),CHAR,ND=Y                               
ActL     LKOUT C,23,(D,B#SAVED,EL_ACTL),CHAR,ND=Y                               
CurC     LKOUT C,24,(D,B#SAVED,EL_CURR),CHAR,ND=Y                               
Nodp     LKOUT C,25,(D,B#SAVED,EL_NODP),CHAR,ND=Y                               
TotF     LKOUT C,26,(D,B#SAVED,EL_FAMT),SPAK,ND=Y                               
IDNo     LKOUT C,27,(D,B#SAVED,EL_IDNO),HEXD,ND=Y                               
ASta     LKOUT C,28,(D,B#SAVED,EL_ASTA),CHAR,ND=Y                               
SCAP     LKOUT C,29,(D,B#SAVED,EL_SCAP),CHAR,ND=Y                               
SCAF     LKOUT C,30,(D,B#SAVED,EL_SCAF),CHAR,ND=Y                               
SCAL     LKOUT C,31,(D,B#SAVED,EL_SCAL),CHAR,ND=Y                               
JSta     LKOUT C,32,(D,B#SAVED,EL_JOBS),CHAR,ND=Y                               
SchC     LKOUT C,33,(D,B#SAVED,EL_SCHC),CHAR,ND=Y                               
ActT     LKOUT C,34,(D,B#SAVED,EL_ACTT),CHAR,ND=Y                               
ConI     LKOUT C,35,(D,B#SAVED,EL_CONI),CHAR,ND=Y                               
ConC     LKOUT C,36,(D,B#SAVED,EL_CONC),CHAR,ND=Y                               
IntU     LKOUT C,37,(D,B#SAVED,EL_INTU),CHAR,ND=Y                               
SIAP     LKOUT C,38,(D,B#SAVED,EL_SIAP),CHAR,ND=Y                               
LGAPst   LKOUT C,45,(D,B#SAVED,EL_GAPST),LBIN,ND=Y                              
LGAPsd   LKOUT C,46,(D,B#SAVED,EL_GAPSD),PDAT,ND=Y                              
LGAPed   LKOUT C,47,(D,B#SAVED,EL_GAPED),PDAT,ND=Y                              
PrRates  LKOUT C,50,(D,B#SAVED,EL_PRRAT),CHAR,ND=Y                              
JClose   LKOUT C,51,(D,B#SAVED,EL_JOBCL),CHAR,ND=Y                              
Edat     LKOUT C,52,(D,B#SAVED,EL_EDAT),PDAT,ND=Y                               
AgyCurr  LKOUT C,53,(D,B#SAVED,EL_ACUR),CHAR,ND=Y                               
*&&US                                                                           
HR#      LKOUT C,54,(D,B#SAVED,EL_AEHR),LBIN,ND=Y                               
OE#      LKOUT C,55,(D,B#SAVED,EL_AEOE),LBIN,ND=Y                               
CE#      LKOUT C,56,(D,B#SAVED,EL_AECE),LBIN,ND=Y                               
*&&                                                                             
HrsWc    LKOUT C,57,(D,B#SAVED,EL_WCTM),CHAR,ND=Y                               
HrsItm   LKOUT C,58,(D,B#SAVED,EL_ITTM),CHAR,ND=Y                               
Itms     LKOUT C,59,(D,B#SAVED,EL_ITMS),CHAR,ND=Y                               
Flt1     LKOUT C,60,(D,B#SAVED,EL_FLT1),CHAR,ND=Y                               
Flt2     LKOUT C,61,(D,B#SAVED,EL_FLT2),CHAR,ND=Y                               
Flt3     LKOUT C,62,(D,B#SAVED,EL_FLT3),CHAR,ND=Y                               
Flt4     LKOUT C,63,(D,B#SAVED,EL_FLT4),CHAR,ND=Y                               
Flt5     LKOUT C,64,(D,B#SAVED,EL_FLT5),CHAR,ND=Y                               
AprDte   LKOUT C,65,(D,B#SAVED,EL_APDT),PDAT,ND=Y                               
Esoff    LKOUT C,66,(D,B#SAVED,EL_OFFC),CHAR,ND=Y                               
IWcTot   LKOUT C,67,(D,B#SAVED,EL_IWCT),SPAK,ND=Y                               
XWcTot   LKOUT C,68,(D,B#SAVED,EL_XWCT),SPAK,ND=Y                               
                                                                                
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
*** Estimate Display **************************************************         
                                                                                
OUTEDIS  LKOUT H                                                                
OUTEDISS LKOUT R,R#EDIS                                                         
                                                                                
RType    LKOUT C,01,(D,B#SAVED,ED_RTYPE),CHAR,ND=Y                              
SrtCh    LKOUT C,02,(D,B#SAVED,ED_EMSRT),HEXD,ND=Y                              
SbSSq    LKOUT C,03,(D,B#SAVED,ED_SBSSQ),CHAR,ND=Y                              
                                                                                
GCliC    LKOUT C,10,(D,B#SAVED,ED_MCLIC),CHAR,ND=Y                              
GCliN    LKOUT C,11,(D,B#SAVED,ED_MCLIN),CHAR,ND=Y                              
GProC    LKOUT C,12,(D,B#SAVED,ED_MPROC),CHAR,ND=Y                              
GProN    LKOUT C,13,(D,B#SAVED,ED_MPRON),CHAR,ND=Y                              
GJobC    LKOUT C,14,(D,B#SAVED,ED_MJOBC),CHAR,ND=Y                              
GJobN    LKOUT C,15,(D,B#SAVED,ED_MJOBN),CHAR,ND=Y                              
GJloc    LKOUT C,16,(D,B#SAVED,ED_MJOBL),CHAR,ND=Y                              
GGloN    LKOUT C,17,(D,B#SAVED,ED_MGLNO),CHAR,ND=Y                              
GLocN    LKOUT C,18,(D,B#SAVED,ED_MLONO),LBIN,ND=Y                              
GAddD    LKOUT C,19,(D,B#SAVED,ED_MADAT),PDAT,ND=Y                              
GActD    LKOUT C,20,(D,B#SAVED,ED_MACTY),PDAT,ND=Y                              
GCurC    LKOUT C,21,(D,B#SAVED,ED_MCURC),CHAR,ND=Y                              
GExch    LKOUT C,22,(D,B#SAVED,ED_MEXCH),(U,#EDTHEX,$EDTHEX),ND=Y               
GSchC    LKOUT C,23,(D,B#SAVED,ED_MSCHC),CHAR,ND=Y                              
GLang    LKOUT C,24,(D,B#SAVED,ED_MLANG),CHAR,ND=Y                              
GStat    LKOUT C,25,(D,B#SAVED,ED_MSTAT),CHAR,ND=Y                              
GName    LKOUT C,26,(D,B#SAVED,ED_MNAME),CHAR,ND=Y                              
GIDNo    LKOUT C,27,(D,B#SAVED,ED_MIDNO),HEXD,ND=Y                              
GOffC    LKOUT C,28,(D,B#SAVED,ED_MOFFC),CHAR,ND=Y                              
GAppr    LKOUT C,29,(D,B#SAVED,ED_MAPPC),CHAR,ND=Y                              
GApFN    LKOUT C,30,(D,B#SAVED,ED_MAPPF),CHAR,ND=Y                              
GApLN    LKOUT C,31,(D,B#SAVED,ED_MAPPL),CHAR,ND=Y                              
GTVRT    LKOUT C,32,(D,B#SAVED,ED_MTVRT),SPAK,ND=Y,PZERO=S                      
LockF    LKOUT C,33,(D,B#SAVED,ED_MLOCK),CHAR,ND=Y                              
FrmtC    LKOUT C,34,(D,B#SAVED,ED_MFRMT),CHAR,ND=Y                              
CCDat    LKOUT C,36,(D,B#SAVED,ED_MDCDA),PDAT,ND=Y                              
CCNam    LKOUT C,37,(D,B#SAVED,ED_MDCLN),CHAR,ND=Y                              
SupEL    LKOUT C,39,(D,B#SAVED,ED_MSELP),CHAR,ND=Y                              
SupDL    LKOUT C,40,(D,B#SAVED,ED_MSELD),CHAR,ND=Y                              
* see GJSta / 140/160                                                           
                                                                                
WCatC    LKOUT C,41,(D,B#SAVED,ED_WCATC),CHAR,ND=Y                              
WCode    LKOUT C,42,(D,B#SAVED,ED_WCODE),CHAR,ND=Y                              
WName    LKOUT C,43,(D,B#SAVED,ED_WNAME),CHAR,ND=Y                              
WAmnt    LKOUT C,44,(D,B#SAVED,ED_WAMNT),SPAK,ND=Y,PZERO=S                      
WFAmt    LKOUT C,45,(D,B#SAVED,ED_WFCAM),SPAK,ND=Y,PZERO=S                      
WCAmt    LKOUT C,46,(D,B#SAVED,ED_WCAMT),SPAK,ND=Y,PZERO=S                      
WCFCA    LKOUT C,47,(D,B#SAVED,ED_WCFCA),SPAK,ND=Y,PZERO=S                      
WCoRa    LKOUT C,48,(D,B#SAVED,ED_WCRAT),SPAK,ND=Y,PZERO=S                      
WInds    LKOUT C,49,(D,B#SAVED,ED_WINDS),CHAR,ND=Y                              
WVATR    LKOUT C,50,(D,B#SAVED,ED_WCVRA),LBIN,ND=Y                              
WVATA    LKOUT C,51,(D,B#SAVED,ED_WCVAM),SPAK,ND=Y,PZERO=S                      
WVATF    LKOUT C,52,(D,B#SAVED,ED_WCVFC),SPAK,ND=Y,PZERO=S                      
WVATC    LKOUT C,53,(D,B#SAVED,ED_WCVCO),CHAR,ND=Y                              
WNICA    LKOUT C,54,(D,B#SAVED,ED_WCNIC),SPAK,ND=Y,PZERO=S                      
WNICF    LKOUT C,55,(D,B#SAVED,ED_WCNFC),SPAK,ND=Y,PZERO=S                      
WCoWC    LKOUT C,56,(D,B#SAVED,ED_WCCWC),CHAR,ND=Y                              
WCoRa    LKOUT C,57,(D,B#SAVED,ED_WCESP),SPAK,ND=Y,PZERO=S                      
OthWC    LKOUT C,58,(D,B#SAVED,ED_WCOTH),CHAR,ND=Y                              
WXNam    LKOUT C,59,(D,B#SAVED,ED_WXNAM),CHAR,ND=Y                              
                                                                                
Itype    LKOUT C,60,(D,B#SAVED,ED_ITYPE),CHAR,ND=Y                              
ICode    LKOUT C,61,(D,B#SAVED,ED_ICODE),CHAR,ND=Y                              
ISeqN    LKOUT C,62,(D,B#SAVED,ED_ISEQN),HEXD,ND=Y                              
IDesc    LKOUT C,63,(D,B#SAVED,ED_IDESC),CHAR,ND=Y                              
IPriA    LKOUT C,64,(D,B#SAVED,ED_IAPRI),SPAK,ND=Y                              
IPriF    LKOUT C,65,(D,B#SAVED,ED_IFPRI),SPAK,ND=Y,PZERO=S                      
IMult    LKOUT C,66,(D,B#SAVED,ED_IMULT),SPAK,ND=Y,PZERO=S                      
IInds    LKOUT C,67,(D,B#SAVED,ED_IINDS),CHAR,ND=Y                              
INICA    LKOUT C,68,(D,B#SAVED,ED_ITNIC),SPAK,ND=Y,PZERO=S                      
INICF    LKOUT C,69,(D,B#SAVED,ED_ITNFC),SPAK,ND=Y,PZERO=S                      
ICInd    LKOUT C,70,(D,B#SAVED,ED_ICIND),CHAR,ND=Y                              
IRInd    LKOUT C,71,(D,B#SAVED,ED_IRIND),CHAR,ND=Y                              
ITxt1    LKOUT C,72,(D,B#SAVED,ED_IETX1),CHAR,ND=Y                              
ITxt2    LKOUT C,73,(D,B#SAVED,ED_IETX2),CHAR,ND=Y                              
IUnit    LKOUT C,74,(D,B#SAVED,ED_IUNIT),CHAR,FILTROUT=TSTMAT,ND=Y              
IUnLa    LKOUT C,75,(D,B#SAVED,ED_IUNLA),CHAR,ND=Y                              
Office   LKOUT C,76,(D,B#SAVED,ED_1RULA),(U,#EDTOFF,$EDTOFF),ND=Y               
OffNam   LKOUT C,77,(D,B#SAVED,ED_1RULA),(U,#EDTOFN,$EDTOFN),ND=Y               
Dept     LKOUT C,78,(D,B#SAVED,ED_1RULA),(U,#EDTDPT,$EDTDPT),ND=Y               
DeptNm   LKOUT C,79,(D,B#SAVED,ED_1RULA),(U,#EDTDPN,$EDTDPN),ND=Y               
SubDpt   LKOUT C,86,(D,B#SAVED,ED_1RULA),(U,#EDTSUB,$EDTSUB),ND=Y               
SubNam   LKOUT C,87,(D,B#SAVED,ED_1RULA),(U,#EDTSUN,$EDTSUN),ND=Y               
PerCode  LKOUT C,88,(D,B#SAVED,ED_1RULA),(U,#EDTPER,$EDTPER),ND=Y               
PerName  LKOUT C,89,(D,B#SAVED,ED_1RULA),(U,#EDTPEN,$EDTPEN),ND=Y               
                                                                                
CCode    LKOUT C,80,(D,B#SAVED,ED_CACOD),CHAR,ND=Y                              
CName    LKOUT C,81,(D,B#SAVED,ED_CANAM),CHAR,ND=Y                              
CTotN    LKOUT C,82,(D,B#SAVED,ED_CATNA),CHAR,ND=Y                              
CInst    LKOUT C,83,(D,B#SAVED,ED_CAINS),CHAR,ND=Y                              
CType    LKOUT C,84,(D,B#SAVED,ED_CATYP),CHAR,ND=Y                              
CElse    LKOUT C,85,(D,B#SAVED,ED_CAELS),CHAR,ND=Y                              
                                                                                
HTxt1    LKOUT C,90,(D,B#SAVED,ED_HTXT1),CHAR,ND=Y                              
                                                                                
FTxt1    LKOUT C,92,(D,B#SAVED,ED_FTXT1),CHAR,ND=Y                              
                                                                                
WTxt1    LKOUT C,94,(D,B#SAVED,ED_WTXT1),CHAR,ND=Y                              
                                                                                
ITxt1    LKOUT C,96,(D,B#SAVED,ED_ITXT1),CHAR,ND=Y                              
                                                                                
VTxt1    LKOUT C,97,(D,B#SAVED,ED_VTXT1),CHAR,ND=Y                              
                                                                                
XCode    LKOUT C,100,(D,B#SAVED,ED_XDCOD),(U,#EDTHEX,$EDTHEX),ND=Y              
XType    LKOUT C,101,(D,B#SAVED,ED_XDTYP),CHAR,ND=Y                             
Data     LKOUT C,102,(D,B#SAVED,ED_XDDAT),CHAR,FILTROUT=TSTXDFC                 
Date     LKOUT C,102,(D,B#SAVED,ED_XDDAT),PDAT,LEN=3,FILTROUT=TSTXDFD           
Amnt     LKOUT C,103,(D,B#SAVED,ED_XDDAT),SPAK,LEN=6,FILTROUT=TSTXDFA, +        
               ND=Y,PZERO=S                                                     
XDName   LKOUT C,104,(D,B#SAVED,ED_XDNAM),CHAR,ND=Y                             
XDCode   LKOUT C,105,(D,B#SAVED,ED_XDCDE),CHAR,FILTROUT=TSTRODK,ND=Y            
                                                                                
AFrSt    LKOUT C,110,(D,B#SAVED,ED_AUFRS),CHAR,ND=Y                             
AToSt    LKOUT C,111,(D,B#SAVED,ED_AUTOS),CHAR,ND=Y                             
ADate    LKOUT C,112,(D,B#SAVED,ED_AUDTE),PDAT,ND=Y                             
ATime    LKOUT C,113,(D,B#SAVED,ED_AUTIM),CHAR,ND=Y                             
AUser    LKOUT C,114,(D,B#SAVED,ED_AUUSR),CHAR,ND=Y                             
APerC    LKOUT C,115,(D,B#SAVED,ED_AUPID),CHAR,ND=Y                             
APerF    LKOUT C,116,(D,B#SAVED,ED_AUPER),CHAR,ND=Y                             
APerL    LKOUT C,117,(D,B#SAVED,ED_AUPEL),CHAR,ND=Y                             
AComm    LKOUT C,118,(D,B#SAVED,ED_AUTXT),CHAR,ND=Y                             
                                                                                
GJSta    LKOUT C,140,(D,B#SAVED,ED_MJOBS),CHAR,ND=Y                             
GClPN    LKOUT C,141,(D,B#SAVED,ED_MCLIP),CHAR,ND=Y                             
GPrPN    LKOUT C,142,(D,B#SAVED,ED_MPROP),CHAR,ND=Y                             
GAdd1    LKOUT C,143,(D,B#SAVED,ED_MJAD1),CHAR,ND=Y                             
GAdd2    LKOUT C,144,(D,B#SAVED,ED_MJAD2),CHAR,ND=Y                             
GAdd3    LKOUT C,145,(D,B#SAVED,ED_MJAD3),CHAR,ND=Y                             
GAdd4    LKOUT C,146,(D,B#SAVED,ED_MJAD4),CHAR,ND=Y                             
GAdd5    LKOUT C,147,(D,B#SAVED,ED_MJAD5),CHAR,ND=Y                             
IntUs    LKOUT C,148,(D,B#SAVED,ED_INTUS),CHAR,ND=Y                             
Eactu    LKOUT C,149,(D,B#SAVED,ED_WIAC),CHAR,ND=Y                              
SEstN    LKOUT C,150,(D,B#SAVED,ED_SMEST),CHAR,ND=Y                             
SBase    LKOUT C,151,(D,B#SAVED,ED_SMBAS),CHAR,ND=Y                             
AgyCur   LKOUT C,152,(D,B#SAVED,ED_MACUR),CHAR,ND=Y                             
*&&US                                                                           
HROECE   LKOUT C,153,(D,B#SAVED,ED_MHOCS),CHAR,ND=Y                             
*&&                                                                             
                                                                                
GIApr    LKOUT C,160,(D,B#SAVED,ED_MIAPC),CHAR,ND=Y                             
GIAFN    LKOUT C,161,(D,B#SAVED,ED_MIAPF),CHAR,ND=Y                             
GIALN    LKOUT C,162,(D,B#SAVED,ED_MIAPL),CHAR,ND=Y                             
RaisC    LKOUT C,163,(D,B#SAVED,ED_MRAIC),CHAR,ND=Y                             
RaisF    LKOUT C,164,(D,B#SAVED,ED_MRAIF),CHAR,ND=Y                             
RaisL    LKOUT C,165,(D,B#SAVED,ED_MRAIL),CHAR,ND=Y                             
RaisE    LKOUT C,166,(D,B#SAVED,ED_MRAIE),CHAR,ND=Y                             
RaisT    LKOUT C,167,(D,B#SAVED,ED_MRAIT),CHAR,ND=Y                             
MedC     LKOUT C,168,(D,B#SAVED,ED_MMEDC),CHAR,ND=Y                             
MedN     LKOUT C,169,(D,B#SAVED,ED_MMEDN),CHAR,ND=Y                             
ConI     LKOUT C,170,(D,B#SAVED,ED_MCONI),CHAR,ND=Y                             
ConC     LKOUT C,171,(D,B#SAVED,ED_MCONC),CHAR,ND=Y                             
LckOrd   LKOUT C,172,(D,B#SAVED,ED_MORLK),CHAR,ND=Y                             
JobOrd   LKOUT C,173,(D,B#SAVED,ED_ORNJB),CHAR,ND=Y                             
BilOrd   LKOUT C,174,(D,B#SAVED,ED_ORBIL),CHAR,ND=Y                             
XdtCop   LKOUT C,175,(D,B#SAVED,ED_XDTCP),CHAR,ND=Y                             
TxtCop   LKOUT C,176,(D,B#SAVED,ED_TXTCP),CHAR,ND=Y                             
UnCom    LKOUT C,177,(D,B#SAVED,ED_UNCOM),CHAR,ND=Y                             
OrInPr   LKOUT C,178,(D,B#SAVED,ED_ORIPR),CHAR,ND=Y                             
OrSubI   LKOUT C,179,(D,B#SAVED,ED_ORSUI),CHAR,ND=Y                             
OrIapp   LKOUT C,180,(D,B#SAVED,ED_ORIAP),CHAR,ND=Y                             
OrSubC   LKOUT C,181,(D,B#SAVED,ED_ORSUC),CHAR,ND=Y                             
OrClAp   LKOUT C,182,(D,B#SAVED,ED_ORCAP),CHAR,ND=Y                             
OrSwpd   LKOUT C,183,(D,B#SAVED,ED_SWPD),HEXD,ND=Y                              
Guse     LKOUT C,185,(D,B#SAVED,ED_GAPYN),CHAR,ND=Y                             
Gsta     LKOUT C,186,(D,B#SAVED,ED_GAPST),LBIN,ND=Y                             
Gsen     LKOUT C,187,(D,B#SAVED,ED_GAPSD),PDAT,ND=Y                             
Gexp     LKOUT C,188,(D,B#SAVED,ED_GAPED),PDAT,ND=Y                             
Array1   LKOUT C,189,(A,ARYEML)                                                 
Array    LKOUT C,190,(A,ARYDESC),FILTROUT=TSTDSC                                
Gdexp    LKOUT C,191,(D,B#SAVED,ED_GAPDE),LBIN,ND=Y                             
WAmNC    LKOUT C,197,(D,B#SAVED,ED_WAMNC),SPAK,ND=Y,PZERO=S                     
PrRates  LKOUT C,200,(D,B#SAVED,ED_PRRAT),CHAR,ND=Y                             
WType    LKOUT C,201,(D,B#SAVED,ED_WTYPE),CHAR,ND=Y                             
WEsck    LKOUT C,202,(D,B#SAVED,ED_WESCK),CHAR,ND=Y                             
CCWc     LKOUT C,203,(D,B#SAVED,ED_CCWC),CHAR,ND=Y                              
WCFlg    LKOUT C,204,(D,B#SAVED,ED_WCF),CHAR,ND=Y                               
Eddat    LKOUT C,205,(D,B#SAVED,ED_MEDAT),PDAT,ND=Y                             
WCSeq    LKOUT C,206,(D,B#SAVED,ED_WCSEQ),LBIN,ND=Y                             
WCTime   LKOUT C,207,(D,B#SAVED,ED_MWCTM),CHAR,ND=Y                             
ItmTime  LKOUT C,208,(D,B#SAVED,ED_MITTM),CHAR,ND=Y                             
*&&US                                                                           
USJof    LKOUT C,209,(D,B#SAVED,ED_SJOF),CHAR,ND=Y                              
*&&                                                                             
ITSeq    LKOUT C,210,(D,B#SAVED,ED_ITSEQ),LBIN,ND=Y                             
Itms     LKOUT C,211,(D,B#SAVED,ED_MITMS),CHAR,ND=Y                             
Jlckti   LKOUT C,212,(D,B#SAVED,ED_MTILK),CHAR,ND=Y                             
Eedt     LKOUT C,213,(D,B#SAVED,ED_EEDT),CHAR,ND=Y                              
                                                                                
         LKOUT E                                                                
                                                                                
*** Estimate Display XData return *************************************         
                                                                                
OUTEDXDS LKOUT R,R#XDFA                                                         
                                                                                
Fieldcd  LKOUT C,01,(D,B#SAVED,XD_PTRS),(U,#EDTHEX,$EDTHEX),ND=Y                
Field    LKOUT C,02,(D,B#SAVED,XD_CODE),CHAR,ND=Y                               
DataTyp  LKOUT C,03,(D,B#SAVED,XD_EDIT),CHAR,ND=Y                               
FieldLn  LKOUT C,04,(D,B#SAVED,XD_MXLN),LBIN,ND=Y                               
FieldRq  LKOUT C,05,(D,B#SAVED,XD_REQD),CHAR,ND=Y                               
FieldAc  LKOUT C,06,(D,B#SAVED,XD_ACTV),CHAR,ND=Y                               
FieldNm  LKOUT C,07,(D,B#SAVED,XD_NAME),CHAR,ND=Y                               
                                                                                
         LKOUT E                                                                
                                                                                
*** Estimate Display XData List return ********************************         
                                                                                
OUTEDXLS LKOUT R,R#XDFL                                                         
                                                                                
Deflt    LKOUT C,08,(D,B#SAVED,XD_STAT),CHAR,ND=Y                               
FieldNm  LKOUT C,09,(D,B#SAVED,XD_LDAT),CHAR,ND=Y                               
FieldAct LKOUT C,10,(D,B#SAVED,XD_ACTL),CHAR,ND=Y                               
                                                                                
         LKOUT E                                                                
                                                                                
*** Estimate Display work code list return ****************************         
                                                                                
OUTEDWCL LKOUT R,R#WCOL                                                         
                                                                                
WC       LKOUT C,01,(D,B#SAVED,WL_WC),CHAR,ND=Y                                 
WCDes    LKOUT C,02,(D,B#SAVED,WL_DESC),CHAR,ND=Y                               
Group    LKOUT C,03,(D,B#SAVED,WL_GRP),CHAR,ND=Y                                
Status   LKOUT C,04,(D,B#SAVED,WL_STAT),CHAR,ND=Y                               
Artist   LKOUT C,05,(D,B#SAVED,WL_ART),CHAR,ND=Y                                
Comm     LKOUT C,06,(D,B#SAVED,WL_COMM),SPAK,ND=Y,PZERO=S                       
VATr     LKOUT C,07,(D,B#SAVED,WL_VATR),CHAR,ND=Y                               
VATc     LKOUT C,08,(D,B#SAVED,WL_VATC),CHAR,ND=Y                               
VATn     LKOUT C,09,(D,B#SAVED,WL_VATN),CHAR,ND=Y                               
ForDesc  LKOUT C,10,(D,B#SAVED,WL_FDES),CHAR,ND=Y                               
EstChk   LKOUT C,24,(D,B#SAVED,WL_EST),CHAR,ND=Y                                
CCW      LKOUT C,25,(D,B#SAVED,WL_CCW),CHAR,ND=Y                                
WCF      LKOUT C,26,(D,B#SAVED,WL_WCF),CHAR,ND=Y                                
                                                                                
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYDESC  LKOUT A,(R,NXTAEX),NROWS=1,ROWNAME=AEXRECD,NEWEL=N                     
Array    LKOUT C,190,(A,ARYDSC)                                                 
                                                                                
         LKOUT E                                                                
                                                                                
ARYEML   LKOUT A,(D,B#SAVED,ED_GAPEM),NROWS=MAXEML,                    +        
               ROWNAME=ED_GAPEM,ROWWIDTH=L'ED_GAPEM                             
                                                                                
Gema     LKOUT C,189,ED_GAPEM,CHAR,ND=Y                                         
                                                                                
         LKOUT E                                                                
                                                                                
ARYDSC   LKOUT A,(D,B#ACEX,AEXRFST),EOT=EOR, Job description array     +        
               ROWID=(JLDEL,JLDELQ),ROWWIDTH=(V,JLDLN)                          
                                                                                
Descrip  LKOUT C,190,JLDDESC,CHAR,LEN=V,ND=Y                                    
                                                                                
         LKOUT E                                                                
                                                                                
TSTXDFC  CLI   ED_XDTYP,XDFEDCQ Test if character string for xdata              
         BER   RE                                                               
         CLI   ED_XDTYP,XDFEDNQ Test if numerical string for xdata              
         BER   RE                                                               
         CLI   ED_XDTYP,XDFEDXQ Test if dropdown for xdata                      
         BER   RE                                                               
         CLI   ED_XDTYP,XDFEDYQ Test if yes/no field for xdata                  
         BR    RE                                                               
                                                                                
TSTXDFA  CLI   ED_XDTYP,XDFEDAQ Test if amount field for xdata                  
         BR    RE                                                               
                                                                                
TSTXDFD  CLI   ED_XDTYP,XDFEDDQ Test if date field for xdata                    
         BR    RE                                                               
                                                                                
TSTMAT   CLI   ED_ITYPE,ED_IMAT Test materials                                  
         BR    RE                                                               
                                                                                
         USING GOXBLKD,RF                                                       
TSTDSC   CLI   ED_RTYPE,ED_RTMLQ Only do it for main record                     
         BNER  RE                                                               
         L     RF,AGOXBLCK      Test if displaying job description              
         CLI   GOGDSC,YESQ                                                      
         BR    RE                                                               
         DROP  RF                                                               
                                                                                
TSTRODK  SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether Brandocean rewrite             
         CHI   RF,XPRODIKQ          app is connected                            
         BR    RE                                                               
**********************************************************************          
* GENERAL EXIT AND DECLARATIONS                                      *          
**********************************************************************          
                                                                                
***********************************************************************         
* Clear work area (RC=A(Work area), R1=L'Work area)                   *         
***********************************************************************         
                                                                                
CLRWRK   STM   RE,R1,12(RD)                                                     
         LR    R0,RC                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LM    RE,R1,12(RD)                                                     
         BR    RE                                                               
                                                                                
***********************************************************************         
                                                                                
XERROR   DS    0H                                                               
         MVI   LP_RMODE,LP_RERRR                                                
         MVI   LP_EMSYS,6                                                       
         J     EXITN                                                            
                                                                                
EXITH    LHI   RE,2                SET CC=HIGH                                  
         J     EXITCC                                                           
                                                                                
EXITN    TM    TWAMODE,TWAMUWD                                                  
         JZ    EXITL                                                            
         NI    TWAMODE,FF-TWAMUWD                                               
         DC    H'0'                Unwind here|                                 
EXITL    LHI   RE,0                SET CC=LOW                                   
         J     EXITCC                                                           
                                                                                
EXITY    TM    TWAMODE,TWAMUWD                                                  
         JZ    EXITYX                                                           
         NI    TWAMODE,FF-TWAMUWD                                               
         DC    H'0'                Unwind here|                                 
EXITYX   LHI   RE,1                                                             
EXITCC   CHI   RE,1                                                             
EXIT     XIT1  ,                                                                
         EJECT                                                                  
                                                                                
***********************************************************************         
* LOCAL ROUTINES                                                      *         
***********************************************************************         
                                                                                
***********************************************************************         
* Get account extension records                                       *         
***********************************************************************         
                                                                                
NXTAEX   GOTOR (#NXTREC,ANXTREC),DMCB,AEXKEYT,('B#ACEX',0),            +        
               (0,SAVED),0,0                                                    
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Trace Request and IOs                                               *         
***********************************************************************         
                                                                                
TRACEIT  NTR1  BASE=*,LABEL=*      Trace in SYSPRINT (offline)                  
                                                                                
         TM    LP_FLAG,LP_FOFFL    Test offline                                 
         JZ    TRACEITX                                                         
                                                                                
         L     RF,ARUNFACS         Get A(RUNFACS)                               
         L     R3,RCPRINT-RUNFACSD(RF)                                          
         AHI   R3,X_P-X_DPRINT                                                  
         USING PTRACED,R3                                                       
                                                                                
         XR    R2,R2                                                            
         ICM   R2,3,LP_QMAPN                                                    
                                                                                
         CHI   R1,0                Request tracing                              
         JNE   TRACIT50                                                         
                                                                                
         L     RF,ARUNFACS         Get A(RUNFACS)                               
         MVC   LIOTRACE,RTOTSIO-RUNFACSD(RF)                                    
                                                                                
         MVC   PTTTIME,TTIMED                                                   
         THMS                                                                   
         ST    R1,FULL1                                                         
         UNPK  WORK(6),FULL1                                                    
         MVC   PTHH,WORK           Set HH:MM:SS                                 
         MVI   PTCO1,C':'                                                       
         MVC   PTMM,WORK+2                                                      
         MVI   PTCO2,C':'                                                       
         OI    WORK+5,X'F0'                                                     
         MVC   PTSS,WORK+4                                                      
                                                                                
         MVC   PTTALPH,TALPHAID                                                 
         MVC   PTALPH,CUAALF                                                    
         MVC   PTTUSER,TUSERPID                                                 
         XOUT  CCTPID,PTUSER,2     (CUPASS may be empty)                        
                                                                                
         CHI   R2,A#ELIS                                                        
         JE    TRACIT10                                                         
         CHI   R2,A#ESRC                                                        
         JE    TRACIT20                                                         
         J     TRACEITX                                                         
                                                                                
TRACIT10 MVC   PTTWHO,TELIS                                                     
         LA    R4,PTFIELD                                                       
         MVC   0(4,R4),=C'Typ='                                                 
         MVC   4(1,R4),RQ_ELTYP                                                 
         AHI   R4,4+1+1                                                         
         MVC   0(6,R4),=C'AwApV='                                               
         MVC   6(1,R4),RQ_ELAPP                                                 
         AHI   R4,6+1+1                                                         
         MVC   0(5,R4),=C'StFl='                                                
         MVC   5(1,R4),RQ_ELFLA                                                 
         AHI   R4,5+1+1                                                         
         MVC   0(5,R4),=C'GAOV='                                                
         MVC   5(1,R4),RQ_ELGAO                                                 
         AHI   R4,5+1+1                                                         
         MVC   0(4,R4),=C'OLL='                                                 
         MVC   4(1,R4),RQ_ELOVL                                                 
         AHI   R4,4+1+1                                                         
                                                                                
         J     TRACIT90                                                         
                                                                                
TRACIT20 MVC   PTTWHO,TESRC                                                     
         LA    R4,PTFIELD                                                       
         CLI   RQ_ESCLI,C' '                                                    
         JNH   TRACIT24                                                         
         MVC   0(3,R4),=C'C...'                                                 
         CLI   RQ_ESPRO,C' '                                                    
         JNH   TRACIT22                                                         
         MVI   1(R4),C'P'                                                       
         CLI   RQ_ESJOB,C' '                                                    
         JNH   TRACIT22                                                         
         MVI   2(R4),C'J'                                                       
                                                                                
TRACIT22 AHI   R4,3+1                                                           
                                                                                
TRACIT24 CLC   RQ_ESGLO,SPACES                                                  
         JNH   TRACIT26                                                         
         MVC   0(3,R4),=C'GN='                                                  
         MVC   3(6,R4),RQ_ESGLO                                                 
         AHI   R4,3+6+1                                                         
                                                                                
TRACIT26 CLC   RQ_ESOWN,SPACES                                                  
         JNH   TRACIT28                                                         
         MVC   0(4,R4),=C'OWN='                                                 
         MVC   4(8,R4),RQ_ESOWN                                                 
         AHI   R4,4+8+1                                                         
                                                                                
TRACIT28 CLC   RQ_ESCRB,SPACES                                                  
         JNH   TRACIT30                                                         
         MVC   0(4,R4),=C'CBY='                                                 
         MVC   4(8,R4),RQ_ESCRB                                                 
         AHI   R4,4+8+1                                                         
                                                                                
TRACIT30 OC    RQ_ESNAD,RQ_ESNAD                                                
         JZ    TRACIT32                                                         
         MVC   0(6,R4),=C'NamSrc'                                               
         AHI   R4,6+1                                                           
                                                                                
TRACIT32 DS    0H                                                               
         J     TRACIT90                                                         
                                                                                
TRACIT50 CHI   R1,1                IO tracing                                   
         JNE   TRACEITX                                                         
                                                                                
         CHI   R2,A#ESRC                                                        
         JE    TRACIT52                                                         
         CHI   R2,A#ELIS                                                        
         JNE   TRACEITX                                                         
                                                                                
TRACIT52 MVC   PTTIO(L'TIOTRACE),TIOTRACE                                       
         L     R0,LIOTRACE                                                      
         EDITR (R0),(8,PTTIO+12),0,ZERO=NOBLANK                                 
         MVC   PTTIO+12+8+2(2),TFROMTO                                          
         L     RF,ARUNFACS         Get A(RUNFACS)                               
         L     R0,RTOTSIO-RUNFACSD(RF)                                          
         EDITR (R0),(8,PTTIO+12+8+2+2+2),0,ZERO=NOBLANK                         
         J     TRACIT90                                                         
                                                                                
TRACIT90 GOTO1 APRINTER                                                         
                                                                                
TRACEITX XIT1                                                                   
                                                                                
TTIMED   DC    C'Time:'                                                         
TALPHAID DC    C'AlphaID:'                                                      
TUSERPID DC    C'PID:'                                                          
TELIS    DC    C'A#ELIS'                                                        
TESRC    DC    C'A#ESRC'                                                        
TIOTRACE DC    C'I/O Trace:'                                                    
TFROMTO  DC    C'=>'                                                            
                                                                                
         DROP  R3                                                               
                                                                                
***********************************************************************         
* Initialise optimisation buffer (uses WSSVR buffer)                  *         
***********************************************************************         
                                                                                
INIOBUF  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*INIOBUF'                                                      
                                                                                
         XC    TSAROBUF(TSPNEWL),TSAROBUF                                       
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSAINI     Set action to 'Initialise'                   
         MVI   T.TSRECI,TSRXTN+TSRWSSVR                                         
         MVI   T.TSKEYL,L'OB_KEY                                                
         LHI   R0,2*ONEK                                                        
         OC    T.TSBUFFL,T.TSBUFFL                                              
         JNZ   *+8                                                              
         STCM  R0,3,T.TSBUFFL                                                   
         LHI   R0,OB_LNQ                                                        
         STCM  R0,3,T.TSRECL                                                    
         MVC   T.TSACOM,ACOMFACS                                                
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  T                                                                
                                                                                
***********************************************************************         
* Get SJ account and save values                                      *         
***********************************************************************         
                                                                                
GETSJA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETSJA*'                                                      
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY            validate client and save it                  
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT,SJACCNT                                                  
         MVC   TEMP2(2*36),SPACES  (note EIFA doesnt return SJ names)           
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
*&&UK*&& JE    GETSJA05                                                         
*&&US*&& JE    GETSJA10            US able to add est to locked jobs            
         MVC   ROUERRV,=AL2(AE$INCLI)                                           
         CLI   X#ETYP,1                                                         
         JE    EXITN                                                            
         MVC   ROUERRV,=AL2(AE$INPRO)                                           
         CLI   X#ETYP,2                                                         
         JE    EXITN                                                            
         MVC   ROUERRV,=AL2(AE$INJOB)                                           
         J     EXITN                                                            
                                                                                
GETSJA05 TM    ACTKSTAT,ACTSLOCK                                                
         JZ    GETSJA10                                                         
         MVC   ROUERRV,=AL2(AE$CLILK)                                           
         CLI   X#ETYP,1                                                         
         JE    EXITN                                                            
         MVC   ROUERRV,=AL2(AE$PROLK)                                           
         CLI   X#ETYP,2                                                         
         JE    EXITN                                                            
*&&UK*&& MVC   ROUERRV,=AL2(AE$JOBLK)                                           
*&&UK*&& J     EXITN                                                            
                                                                                
GETSJA10 TM    ACTKSTAT,ACTSCLOS                                                
         JZ    GETSJA12                                                         
         MVC   ROUERRV,=AL2(AE$ACTCL)                                           
         CLI   X#ETYP,1                                                         
         JE    EXITN                                                            
         MVC   ROUERRV,=AL2(AE$ACTCL)                                           
         CLI   X#ETYP,2                                                         
         JE    EXITN                                                            
         MVC   ROUERRV,=AL2(AE$JBCLO)                                           
         J     EXITN                                                            
                                                                                
GETSJA12 CLI   X#ETYP,3                                                         
         JNE   GETSJA15                                                         
         MVI   X#JOBDS,NOQ                                                      
         TM    ACTKSTAT,ACTSDRFT                                                
         JZ    GETSJA15                                                         
         MVI   X#JOBDS,YESQ                                                     
                                                                                
GETSJA15 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         MVI   BYTE3,NOQ                                                        
                                                                                
GETSJA20 CLI   PPREL,0                                                          
         JE    GETSJA70                                                         
         CLI   PPREL,PPRELQ                                                     
         JE    GETSJA30                                                         
         CLI   PPREL,NAMELQ                                                     
         JE    GETSJA35                                                         
         CLI   PPREL,XNMELQ                                                     
         JE    GETSJA45                                                         
         CLI   PPREL,SNMELQ                                                     
         JE    GETSJA50                                                         
         CLI   PPREL,ADRELQ                                                     
         JE    GETSJA55                                                         
*&&US*&& CLI   PPREL,JOBELQ                                                     
*&&US*&& JE    GETSJA65                                                         
                                                                                
GETSJA25 LLC   R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     GETSJA20                                                         
                                                                                
GETSJA30 CLC   PPRGAOFF,SPACES                                                  
         JNH   GETSJA25                                                         
         MVC   X#SJOFF,PPRGAOFF                                                 
         OC    X#SJOFF,SPACES                                                   
         J     GETSJA25                                                         
                                                                                
         USING NAMELD,R2                                                        
GETSJA35 LLC   RE,NAMLN                                                         
         SHI   RE,3                                                             
         LTR   RE,RE                                                            
         JM    GETSJA25                                                         
         BASR  R1,0                                                             
         MVC   TEMP2+36(0),NAMEREC                                              
         EX    RE,0(R1)                                                         
         J     GETSJA25                                                         
                                                                                
         USING XNMELD,R2                                                        
GETSJA45 TM    CPYSTATC,CPYSALTN                                                
         JZ    GETSJA25                                                         
         MVI   BYTE3,1                                                          
         LLC   RE,XNMSUBL                                                       
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         MVC   TEMP2(0),XNMSUBN                                                 
         EX    RE,0(R1)                                                         
         J     GETSJA25                                                         
                                                                                
         USING SNMELD,R2                                                        
GETSJA50 TM    CPYSTATC,CPYSMEDN                                                
         JZ    GETSJA25                                                         
         MVI   BYTE3,1                                                          
         LLC   RE,SNMLN                                                         
         SHI   RE,SNMLN1Q+1                                                     
         BASR  R1,0                                                             
         MVC   TEMP2(0),SNMNAME                                                 
         EX    RE,0(R1)                                                         
         J     GETSJA25                                                         
                                                                                
         USING ADRELD,R2                                                        
GETSJA55 MVC   X#SJAD1(5*L'ADRADD1),SPACES                                      
         LLC   RE,ADRNUM                                                        
         LTR   RE,RE                                                            
         JZ    GETSJA25                                                         
         LA    RF,ADRADD1                                                       
         LA    R1,X#SJAD1                                                       
GETSJA60 MVC   0(L'ADRADD1,R1),0(RF)                                            
         AHI   R1,L'ADRADD1                                                     
         AHI   RF,L'ADRADD1                                                     
         JCT   RE,GETSJA60                                                      
         J     GETSJA25                                                         
                                                                                
         USING JOBELD,R2                                                        
GETSJA65 CLI   JOBLN,JOBLN3Q                                                    
         JL    GETSJA67                                                         
         TM    JOBSTA1,JOBSMCSE                                                 
         JNZ   GETSJA25                                                         
                                                                                
GETSJA67 MVC   ROUERRV,=AL2(AE$NOMCS)                                           
         J     EXITN                                                            
                                                                                
GETSJA70 CLI   BYTE3,1             if override name found skip                  
         JE    EXITY               else swap name fields                        
         MVC   TEMP2(36),TEMP2+36                                               
         MVC   TEMP2+36(36),SPACES                                              
         J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Process scheme                                                      *         
***********************************************************************         
                                                                                
PROSCH   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PROSCH*'                                                      
                                                                                
         OC    RQ_IASCH,SPACES                                                  
         XC    ELEMENT,ELEMENT                                                  
                                                                                
         USING SCHRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    SCHKEY,SCHKEY                                                    
         MVI   SCHKTYP,SCHKTYPQ                                                 
         MVI   SCHKSUB,SCHKSUBQ                                                 
         MVC   SCHKCPY,CUXCPY                                                   
         MVC   SCHKUNT(2),PRODUL                                                
         MVC   SCHKCODE,RQ_IASCH                                                
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    PROSCH00                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$INSCH)                                           
         J     EXITN                                                            
                                                                                
PROSCH00 TM    SCHKSTA,SCHSMCSN    exclude non MCS schemes                      
         JZ    PROSCH05                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$INSCH)                                           
         J     EXITN                                                            
                                                                                
PROSCH05 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING SCHELD,R3                                                        
         L     R2,AIO2                                                          
         LA    R3,SCHRFST                                                       
                                                                                
PROSCH10 CLI   SCHEL,0                                                          
         JE    PROSCH30                                                         
         CLI   SCHEL,SCHELQ                                                     
         JE    PROSCH20                                                         
         CLI   SCHEL,SCSELQ                                                     
         JE    PROSCH25                                                         
                                                                                
PROSCH15 LLC   R0,SCHLN                                                         
         AR    R3,R0                                                            
         J     PROSCH10                                                         
                                                                                
PROSCH20 MVC   X#SCHNM,SCHNAME     save scheme name                             
         J     PROSCH15                                                         
                                                                                
         USING SCSELD,R3                                                        
PROSCH25 LLC   R1,SCSLN                                                         
         SHI   R1,SCSLN1Q+1                                                     
         BASR  RF,0                                                             
         MVC   ELEMENT(0),SCSCAT   save categories                              
         EX    R1,0(RF)                                                         
         J     PROSCH15                                                         
                                                                                
         USING SCHCATD,R4                                                       
PROSCH30 L     R4,AGENAREA                                                      
         MVI   SCHCELE,SCHCEOT     set end of table                             
                                                                                
         LA    R3,ELEMENT                                                       
                                                                                
PROSCH35 CLC   0(2,R3),SPACES      end of category list?                        
         JNH   PROSCH70                                                         
                                                                                
         CLC   0(2,R3),=X'FFFF'                                                 
         JE    PROSCH40                                                         
                                                                                
         GOTOR GETCAT                                                           
         JNE   EXITN                                                            
                                                                                
PROSCH40 AHI   R3,2                                                             
         J     PROSCH35                                                         
                                                                                
PROSCH70 L     R4,AGENAREA         process AGENAREA                             
                                                                                
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
*&&UK                                                                           
         USING GOBLOCKD,R3                                                      
***      L     R3,AGOBLOCK                                                      
         L     R3,AGOBLOCB                                                      
         MVC   IA_FRMTC,GOREPFOR                                                
*&&                                                                             
         USING GOXBLKD,R3                                                       
         L     R3,AGOXBLCK                                                      
         MVC   IA_CCWC,GOCCW                                                    
         MVC   IA_WCF,GOWCF                                                     
         MVC   IA_TXTCP,GODCTEO                                                 
         MVC   IA_UNCOM,GOACUA                                                  
         MVC   IA_WIAC,GOGUWC                                                   
         MVC   IA_PRRAT,GOGPRE                                                  
*&&US*&& MVC   IA_FRMTC,GOREPFOR                                                
         MVC   IA_ORIPR,=C'NNNNN'                                               
         LA    R3,GOCOES                                                        
         LA    R1,5                                                             
PROSCH71 CLI   0(R3),C'P'                                                       
         JNE   *+8                                                              
         MVI   IA_ORIPR,C'Y'                                                    
         CLI   0(R3),C'B'                                                       
         JNE   *+8                                                              
         MVI   IA_ORSUI,C'Y'                                                    
         CLI   0(R3),C'I'                                                       
         JNE   *+8                                                              
         MVI   IA_ORIAP,C'Y'                                                    
         CLI   0(R3),C'S'                                                       
         JNE   *+8                                                              
         MVI   IA_ORSUC,C'Y'                                                    
         CLI   0(R3),C'A'                                                       
         JNE   *+8                                                              
         MVI   IA_ORCAP,C'Y'                                                    
         LA    R3,1(R3)                                                         
         JCT   R1,PROSCH71                                                      
                                                                                
         MVI   IA_RTYPE,IA_RTGVQ   *** send global values                       
         MVC   IA_SCHNA,X#SCHNM                                                 
         MVC   IA_OFFCD,X#SJOFF                                                 
         MVC   IA_JBIFL,RQ_IALAN                                                
         MVC   IA_JOBST,X#JOBDS                                                 
         MVC   IA_CLIPN,X#CLIPN                                                 
         MVC   IA_PROPN,X#PROPN                                                 
         MVC   IA_SJAD1(5*L'ADRADD1),X#SJAD1                                    
         MVC   IA_INTUS,SPACES                                                  
         TM    G#OFSTA2,OFFSIAEQ   Internal approvals in use?                   
         JZ    PROSCH72                                                         
         MVI   IA_INTUS,NOQ                                                     
         TM    G#OFSTA2,OFFIUSDF                                                
         JZ    *+8                                                              
         MVI   IA_INTUS,YESQ                                                    
                                                                                
PROSCH72 GOTOR LP_APUTO,LP_D                                                    
                                                                                
PROSCH75 CLI   SCHCELE,SCHCEOT     output record                                
         JE    EXITY                                                            
                                                                                
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         CLI   SCHCELE,SCHCELQ     category?                                    
         JNE   PROSCH80                                                         
                                                                                
         XC    X#WCSEQ,X#WCSEQ     Clear work code sequence for every           
         MVI   IA_RTYPE,IA_RTCVQ   *** send category values                     
         MVC   IA_CACOD,SCHCACO                                                 
         MVC   IA_CANAM,SCHCANA                                                 
         MVC   IA_CATNA,SCHCATN                                                 
         MVC   IA_CAINS,SCHCAIN                                                 
                                                                                
         CLI   RQ_IALAN,YESQ                                                    
         JNE   PROSCH76                                                         
         CLC   SCHCFNA,SPACES                                                   
         JNH   *+10                                                             
         MVC   IA_CANAM,SCHCFNA                                                 
         CLC   SCHCFNT,SPACES                                                   
         JNH   *+10                                                             
         MVC   IA_CATNA,SCHCFNT                                                 
                                                                                
PROSCH76 MVC   IA_CASTA,=C'NNNNN'                                               
         TM    SCHCAST,CADSSUPT    SUPPRESS TOTALS                              
         JZ    *+8                                                              
         MVI   IA_CASTA+0,C'Y'                                                  
         TM    SCHCAST,CADSCONT    CATEGORY IS A CONTINUATION                   
         JZ    *+8                                                              
         MVI   IA_CASTA+1,C'Y'                                                  
         TM    SCHCAST,CADSRHS     CATEGORY PRINTS ON RHS                       
         JZ    *+8                                                              
         MVI   IA_CASTA+2,C'Y'                                                  
         TM    SCHCAST,CADSNPRT    DO NOT PRINT CAT NAME ON ESTIMATE            
         JZ    *+8                                                              
         MVI   IA_CASTA+3,C'Y'                                                  
         TM    SCHCAST,CADSFLAN    FOREIGN LANGUAGE NAMES PRESENT               
         JZ    *+8                                                              
         MVI   IA_CASTA+4,C'Y'                                                  
                                                                                
         MVC   IA_CATYP,SCHCATY                                                 
         OI    IA_CATYP,X'F0'                                                   
                                                                                
         J     PROSCH95                                                         
                                                                                
PROSCH80 CLI   SCHCELE,SCHWELQ     work code?                                   
         JNE   *+2                                                              
                                                                                
         MVI   IA_RTYPE,IA_RTWVQ   *** send work code values                    
*        MVC   IA_WCTYP,SCHWTYP                                                 
*        OI    IA_WCTYP,X'F0'                                                   
         LLH   RF,X#WCSEQ                                                       
         AHI   RF,1                                                             
         STH   RF,X#WCSEQ                                                       
         STCM  RF,3,IA_WCSEQ                                                    
                                                                                
         MVC   IA_WCCOD,SCHWCOD                                                 
         MVC   IA_WCCAT,SCHWCAT                                                 
         MVC   IA_WCDES,SCHWDES                                                 
                                                                                
         OC    SCHWESP,SCHWESP                                                  
         JNZ   *+10                                                             
         ZAP   SCHWESP,PZERO                                                    
         ZAP   IA_WCESP,SCHWESP                                                 
                                                                                
         MVC   TEMP2(2),SCHWCOD                                                 
         GOTOR (#GETWCD,AGETWCD)   get work code                                
         MVI   IA_WCART,NOQ                                                     
*&&UK                                                                           
         TM    TEMP2+20+WCOSTAT2-WCOELD,WCOSART                                 
         JZ    *+8                 artist w/c?                                  
         MVI   IA_WCART,YESQ                                                    
*&&                                                                             
         MVI   IA_WCTYP,IA_WTIME                                                
         TM    TEMP2+20+WCOSTAT-WCOELD,WCOSHCOE    Cost workcode?               
         JNZ   *+8                                                              
         MVI   IA_WCTYP,IA_WCOST                                                
*&&US                                                                           
         CLI   TEMP2+20+WCOTYPE-WCOELD,C'T'        Is it time or cost           
         JNE   *+8                                                              
         MVI   IA_WCTYP,IA_WTIME                                                
*&&                                                                             
         MVI   IA_WESCK,YESQ                                                    
*&&UK                                                                           
         TM    TEMP2+20+WCOSTAT3-WCOELD,WCOSESCK                                
         JZ    *+8                                                              
         MVI   IA_WESCK,NOQ                                                     
*&&                                                                             
         CLC   SCHWDES,SPACES      set description only if blank                
         JH    PROSCH90                                                         
         MVC   IA_WCDES(15),TEMP2                                               
         CLI   RQ_IALAN,YESQ                                                    
         JNE   PROSCH90                                                         
         L     R1,AIO3                                                          
         AHI   R1,WCORFST-WCORECD                                               
                                                                                
         USING XNMELD,R1                                                        
PROSCH86 CLI   XNMEL,0                                                          
         JE    PROSCH90                                                         
         CLI   XNMEL,XNMELQ                                                     
         JE    PROSCH87                                                         
         LLC   R0,XNMLN                                                         
         AR    R1,R0                                                            
         J     PROSCH86                                                         
                                                                                
PROSCH87 LLC   RE,XNMSUBL                                                       
         SHI   RE,2                                                             
         LTR   RE,RE                                                            
         JM    PROSCH90                                                         
         MVC   IA_WCDES,SPACES     in case prev. contents were longer           
         BASR  RF,0                                                             
         MVC   IA_WCDES(0),XNMSUBN                                              
         EX    RE,0(RF)                                                         
                                                                                
PROSCH90 MVC   TEMP2(2),SCHWCOD                                                 
*&&US                                                                           
         XC    IA_WCOVR,IA_WCOVR   Not defined in the US                        
         MVI   IA_WCOVC,X'40'                                                   
*&&                                                                             
         GOTOR COMVAT                                                           
         JNE   EXITN                                                            
         ZAP   IA_WCACR,DUB2                                                    
*&&UK                                                                           
         MVC   IA_WCOVR,HALF2                                                   
         MVC   IA_WCOVC,BYTE2                                                   
*&&                                                                             
                                                                                
PROSCH95 GOTOR LP_APUTO,LP_D                                                    
                                                                                
         LLC   R0,SCHCLEN                                                       
         AR    R4,R0                                                            
         J     PROSCH75                                                         
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Get Category and details                                            *         
***********************************************************************         
                                                                                
GETCAT   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*GETCAT*'                                                      
                                                                                
         ST    R4,X#SCHLI                                                       
         XC    X#BYTE1,X#BYTE1                                                  
                                                                                
         USING CATRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    CATKEY,CATKEY                                                    
         MVI   CATKTYP,CATKTYPQ                                                 
         MVI   CATKSUB,CATKSUBQ                                                 
         MVC   CATKCPY,CUXCPY                                                   
         MVC   CATKUNT(2),PRODUL                                                
         MVC   CATKSCH,RQ_IASCH                                                 
         MVC   CATKCODE,0(R3)                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    GETCAT1                                                          
         MVC   ROUERRV,=AL2(AE$INVCD)                                           
         J     GETCATN                                                          
                                                                                
GETCAT1  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING CADELD,R3                                                        
         L     R2,AIO2                                                          
         LA    R3,CATRFST                                                       
                                                                                
GETCAT2  CLI   CADEL,0                                                          
         JE    GETCATY                                                          
         CLI   CADEL,CADELQ                                                     
         JE    GETCAT4                                                          
         CLI   CADEL,CWKELQ                                                     
         JE    GETCAT6                                                          
                                                                                
GETCAT3  LLC   R0,CADLN                                                         
         AR    R3,R0                                                            
         J     GETCAT2                                                          
                                                                                
GETCAT4  MVI   SCHCELE,SCHCELQ     save category data                           
         MVI   SCHCLEN,SCHCLNQ                                                  
         MVC   SCHCACO,CATKCODE                                                 
         MVC   SCHCANA,CADNAME                                                  
         MVC   SCHCATN,CADTNAM                                                  
         CLC   CADTNAM,SPACES                                                   
         JH    GETCAT5                                                          
         MVC   SCHCATN(6),=CL6'TOTAL'                                           
         MVC   SCHCATN+6(14),CADNAME                                            
                                                                                
GETCAT5  MVC   SCHCAST,CADSTAT                                                  
         MVC   SCHCATY,CADTYPE                                                  
         CLI   CADTYPE,CADTWORK                                                 
         JE    *+8                                                              
         MVI   X#BYTE1,YESQ        Is it a calculated category                  
                                                                                
         MVC   SCHCAIN,SPACES                                                   
         MVC   SCHCFNA,SPACES                                                   
         MVC   SCHCFNT,SPACES                                                   
                                                                                
         CLI   CADLN,CADLN1Q                                                    
*&&UK*&& JNH   GETCAT5X                                                         
*&&US*&& JNH   GETCAT5G                                                         
                                                                                
         TM    CADSTAT,CADSFLAN                                                 
         JZ    GETCAT5C                                                         
                                                                                
         LA    R1,CADLINP                                                       
         CLI   CADTYPE,CADTFORM                                                 
         JNE   GETCAT5A                                                         
         LLC   RF,CADLINP          add lengths of input string and              
         AR    R1,RF               internal formula                             
         LLC   RF,0(R1)                                                         
         AR    R1,RF                                                            
                                                                                
GETCAT5A LLC   RF,0(R1)            length of foreign name                       
         SHI   RF,2                subtract length byte and for EX              
         LTR   RF,RF                                                            
         JM    GETCAT5B                                                         
         BASR  RE,0                                                             
         MVC   SCHCFNA(0),1(R1)    FOREIGN NAME                                 
         EX    RF,0(RE)                                                         
                                                                                
GETCAT5B LLC   RF,0(R1)            add length of foreign name                   
         AR    R1,RF               (R1 from above)                              
         LLC   RF,0(R1)            length of foreign total name                 
         SHI   RF,2                subtract length byte and for EX              
         LTR   RF,RF                                                            
         JM    GETCAT5C                                                         
         BASR  RE,0                                                             
         MVC   SCHCFNT(0),1(R1)    FOREIGN TOTAL NAME                           
         EX    RF,0(RE)                                                         
                                                                                
GETCAT5C DS    0H                                                               
         CLI   CADTYPE,CADTCTY     Intructions - for contingency or             
         JE    GETCAT5D            calculation or formula                       
*&&UK*&& CLI   CADTYPE,CADTCAL                                                  
*&&UK*&& JE    GETCAT5D                                                         
         CLI   CADTYPE,CADTFORM                                                 
         JNE   GETCAT5G                                                         
                                                                                
GETCAT5D XR    RF,RF                                                            
         ICM   RF,1,CADLINP                                                     
         JZ    GETCAT5G                                                         
         SHI   RF,2                subtract length byte and for EX              
         LTR   RF,RF                                                            
         JM    GETCAT5G                                                         
         BASR  RE,0                                                             
         MVC   SCHCAIN(0),CADINP   INSTRUCTION                                  
         EX    RF,0(RE)                                                         
*&&UK                                                                           
         CLI   CADTYPE,CADTCAL                                                  
         JNE   GETCAT5G                                                         
         LA    RF,SCHCAIN                                                       
         LA    RE,L'SCHCAIN-3                                                   
                                                                                
GETCAT5E CLC   0(2,RF),=C'MX'      make MX into MAX                             
         JNE   GETCAT5F                                                         
         CLC   2(2,RF),SPACES                                                   
         JH    GETCAT5F                                                         
         MVC   0(3,RF),=C'MAX'                                                  
GETCAT5F AHI   RF,1                                                             
         JCT   RE,GETCAT5E                                                      
*&&                                                                             
GETCAT5G DS    0H                                                               
                                                                                
*&&US                                                                           
*        XR    RF,RF                                                            
*        ICM   RF,3,LP_QMAPN                                                    
*        CHI   RF,A#EIFA           Only for initial d/load for add              
*        JNE   GETCAT5X                                                         
         SR    RF,RF                                                            
         LR    RE,R3                                                            
GETCAT5H LLC   RF,1(RE)                                                         
         AR    RE,RF               Look ahead to CWKEL (A8) elem                
         CLI   0(RE),0                                                          
         JE    GETCAT5X                                                         
         CLI   0(RE),CWKELQ                                                     
         JNE   GETCAT5H                                                         
*                                                                               
         USING CWKELD,RE                                                        
         CLI   CWKTYPE,CWKTWORK    Make sure that it's a work code line         
         JNE   GETCAT5H                                                         
         CLC   CWKCAT,SPACES       Does it have a calculation Category?         
         JNH   GETCAT5X                                                         
         MVI   SCHCATY,C'1'        Alway set as 1 per Dinesh 10/2010            
         MVC   SCHCAIN,SPACES                                                   
         DROP  RE                                                               
*&&                                                                             
*                                                                               
*&&DO                                                                           
         MVI   SCHCATY,CADTCTY     Make it a contingency for frontend           
         MVC   TEMP2(2),CWKWORK                                                 
         MVC   SCHCAIN(4),=C'CTY=' Filling in Formula                           
         MVC   SCHCAIN+4(L'CWKCAT),CWKCAT                                       
         MVI   SCHCAIN+6,C'*'                                                   
*                                                                               
         GOTOR COMVAT              Get Estimate %                               
         EDIT  (P6,X#WCESP),(12,WORK),4,ALIGN=LEFT,TRAIL=C'%'                   
         SR    R1,R1                                                            
         LA    R0,12                                                            
         LA    RE,WORK             Find last byte                               
         CLI   0(RE),C' '          Did we find the end?                         
         JE    *+16                                                             
         AHI   R1,1                                                             
         AHI   RE,1                                                             
         JCT   R0,*-16                                                          
         BASR  RF,0                                                             
         MVC   SCHCAIN+7(0),WORK                                                
         EX    R1,0(RF)                                                         
*&&                                                                             
                                                                                
GETCAT5X AHI   R4,SCHCLNQ                                                       
         MVI   SCHCELE,SCHCEOT                                                  
         J     GETCAT3                                                          
                                                                                
         USING CWKELD,R3                                                        
GETCAT6  CLI   CWKSUFF,0           skip sub work codes                          
         JNE   GETCAT3                                                          
                                                                                
         CLI   X#BYTE1,YESQ        If a calculated category                     
         JE    GETCAT30            Yes - don't send out                         
         MVI   SCHCELE,SCHWELQ     save work code data                          
         MVI   SCHCLEN,SCHWLNQ                                                  
         MVC   SCHWTYP,CWKTYPE                                                  
         MVC   SCHWCOD,CWKWORK                                                  
         MVC   SCHWCAT,CWKCAT                                                   
                                                                                
         MVC   TEMP2,CWKWORK                                                    
         GOTOR COMVAT                                                           
         ZAP   SCHWESP,X#WCESP                                                  
                                                                                
         MVC   SCHWDES,SPACES                                                   
         CLI   CWKLN,CWKLN1Q                                                    
         JNH   GETCAT7                                                          
                                                                                
         CLI   CUCTRY,CTRYGER                                                   
         JNE   GETCAT6C                                                         
         CLI   RQ_IALAN,YESQ                                                    
         JE    GETCAT6A                                                         
                                                                                
         TM    CWKSTAT,CWKSLAN     any language on it?                          
         JZ    GETCAT6C                                                         
         MVC   BYTE1,CWKSTAT                                                    
         NI    BYTE1,X'FF'-(CWKSPRE+CWKSLAN)                                    
         LLC   R1,BYTE1                                                         
         CHI   R1,0                                                             
         JNH   GETCAT7                                                          
         SHI   R1,1                                                             
         J     GETCAT6D                                                         
                                                                                
GETCAT6A TM    CWKSTAT,CWKSLAN     any language on it?                          
         JZ    GETCAT7                                                          
         MVC   BYTE1,CWKSTAT                                                    
         NI    BYTE1,X'FF'-(CWKSPRE+CWKSLAN)                                    
         LLC   R1,BYTE1                                                         
         LLC   RE,CWKLN                                                         
         SHI   RE,CWKLN1Q+1                                                     
         SR    RE,R1                                                            
         LA    R1,CWKDESL(R1)                                                   
         BASR  RF,0                                                             
         MVC   SCHWDES(0),0(R1)                                                 
         EX    RE,0(RF)                                                         
         J     GETCAT7                                                          
                                                                                
GETCAT6C LLC   R1,CWKLN                                                         
         SHI   R1,CWKLN1Q+1                                                     
                                                                                
GETCAT6D BASR  RF,0                                                             
         MVC   SCHWDES(0),CWKDESL                                               
         EX    R1,0(RF)                                                         
                                                                                
GETCAT7  AHI   R4,SCHWLNQ                                                       
         MVI   SCHCELE,SCHCEOT                                                  
         J     GETCAT3                                                          
                                                                                
GETCAT30 L     R4,X#SCHLI          Reset address so data not sent out           
         MVI   SCHCELE,SCHCEOT                                                  
                                                                                
GETCATY  CR    RB,RB                                                            
         J     *+6                                                              
GETCATN  LTR   RB,RB                                                            
         XIT1  REGS=(R4)                                                        
         DROP  R2,R3,R4                                                         
***********************************************************************         
* Get opt maint for orders                                            *         
***********************************************************************         
                                                                                
GETOPT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETOPT*'                                                      
                                                                                
         USING GOBLOCKD,R2                                                      
***      L     R2,AGOBLOCK                                                      
         L     R2,AGOBLOCB                                                      
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOAEXT,AGOXBLCK     US USES 1ST EXTENSION BLOCK                  
*&&UK*&& MVC   GOABEXT,AGOBBLCK    UK USES 2ND EXTENSION BLOCK                  
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(2),PRODUL                                             
         MVC   GOSELCLI,ED_MCLIC                                                
         MVC   GOSELPRO,ED_MPROC                                                
         MVC   GOSELJOB,SPACES                                                  
         XC    GOSELMED,GOSELMED                                                
         CLC   ED_MJOBC,SPACES                                                  
         JNH   GETOPT02                                                         
         MVC   GOSELJOB,ED_MJOBC                                                
         MVC   GOSELMED,ED_MJOBC                                                
GETOPT02 OI    GOSPEC3,GOSPNERQ                                                 
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
         USING GOXBLKD,R3                                                       
         L     R3,AGOXBLCK                                                      
         MVC   ED_ORBIL,GOBILO                                                  
         MVC   ED_CCWC,GOCCW                                                    
         MVC   ED_WCF,GOWCF                                                     
*&&US*&& MVC   ED_SJOF,GOSJOF                                                   
*&&UK*&& MVC   ED_ORNJB,GONJLE                                                  
         MVC   ED_XDTCP,GOCECE                                                  
         MVC   ED_TXTCP,GODCTEO                                                 
         MVC   ED_UNCOM,GOACUA                                                  
         MVC   ED_SWPD,GOSWPD                                                   
         MVC   ED_WIAC,GOGUWC                                                   
         MVC   ED_ORIPR,=C'NNNNN'                                               
         MVC   ED_GAPYN,GOGAPS     electronic signature in use                  
         MVC   ED_GAPDE,GOGDES     default expiration period                    
         MVC   ED_EEDT,GOEEDT      Estimate date in last fiscal year            
         LA    R3,GOCOES                                                        
         LA    R1,5                                                             
GETOPT04 CLI   0(R3),C'P'                                                       
         JNE   *+8                                                              
         MVI   ED_ORIPR,C'Y'                                                    
         CLI   0(R3),C'B'                                                       
         JNE   *+8                                                              
         MVI   ED_ORSUI,C'Y'                                                    
         CLI   0(R3),C'I'                                                       
         JNE   *+8                                                              
         MVI   ED_ORIAP,C'Y'                                                    
         CLI   0(R3),C'S'                                                       
         JNE   *+8                                                              
         MVI   ED_ORSUC,C'Y'                                                    
         CLI   0(R3),C'A'                                                       
         JNE   *+8                                                              
         MVI   ED_ORCAP,C'Y'                                                    
         LA    R3,1(R3)                                                         
         JCT   R1,GETOPT04                                                      
                                                                                
GETOPTX  J     EXITY                                                            
         DROP  R2,R3                                                            
                                                                                
***********************************************************************         
* Get agency commission rate and VAT rate for work code               *         
***********************************************************************         
                                                                                
COMVAT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*COMVAT*'                                                      
                                                                                
         USING GOBLOCKD,R2                                                      
         L     R2,AGOBLOCB         call GETOPT for scheme code                  
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(2),PRODUL                                             
         MVC   GOSELCLI,RQ_IACLI                                                
         MVC   GOSELPRO,RQ_IAPRO                                                
         MVC   GOSELJOB,RQ_IAJOB                                                
                                                                                
         CLC   GOSELJOB,SPACES                                                  
         JH    *+10                                                             
         XC    GOSELJOB,GOSELJOB                                                
                                                                                
         MVC   GOSELMED,RQ_IAMED                                                
         CLI   RQ_IAMED,C' '                                                    
         JH    *+10                                                             
         MVC   GOSELMED,GOSELJOB   BINARY ZERO OR 1ST LETTER OF JOB             
         MVC   GOSELWC,TEMP2                                                    
         MVI   GOANYWC,YESQ                                                     
*&&UK*&& MVC   GOABEXT,AGOXBLCK    UK USES 2ND EXTENSION BLOCK                  
                                                                                
         OI    GOSPEC3,GOSPNERQ                                                 
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
         ZAP   DUB2,GOAGYCOM                                                    
         MVC   BYTE2,GOTAXCOD                                                   
         ZAP   X#WCESP,GOESTPER    Estimate WC %                                
                                                                                
*&&UK                                                                           
         CLI   CUCTRY,CTRYGER      internal we/c and Germany?                   
         JNE   COMVAT2                                                          
         CLI   GOSELWC,C'Z'                                                     
         JH    COMVAT2                                                          
         OC    GOPROVPC,GOPROVPC   if internal comm rate override               
         JZ    COMVAT2             regular comm rate with it                    
         ZAP   DUB2,GOPROVPC                                                    
                                                                                
         USING VTCD,R2                                                          
COMVAT2  LAY   R2,X#VTCBL          build VATICAN call block                     
         XC    VTCD(VTCLNQ),VTCD                                                
         MVI   VTCACTN,VTCALOOK                                                 
         MVC   VTCCPY,CUXCPY                                                    
         MVC   VTCOFFC,X#SJOFF                                                  
         MVC   VTCCOMF,ACOMFACS                                                 
         MVC   VTCINVD,XL#TODP                                                  
         MVC   VTCTYPE,BYTE2                                                    
         MVC   VTCCPYS1,CPYSTAT1                                                
         MVC   VTCSGOPO,X#SGOPOS                                                
                                                                                
         GOTO1 VATICAN,VTCD                                                     
         JE    COMVAT4                                                          
         MVC   ROUERRV,VTCERR                                                   
         J     COMVATN                                                          
                                                                                
COMVAT4  TM    VTCINDS,VTCINA         tax is not applicable                     
         JZ    COMVAT6                                                          
         MVC   ROUERRV,=AL2(AE$VRNDE) VAT rates not defined for date            
         J     COMVATN                                                          
                                                                                
COMVAT6  MVC   HALF2,VTCRATE                                                    
*&&                                                                             
                                                                                
COMVATY  J     EXITY                                                            
                                                                                
COMVATN  J     EXITN                                                            
                                                                                
         DROP  R2                                                               
***********************************************************************         
* Get OPT/MAINT estimate percentage for a work code                   *         
***********************************************************************         
                                                                                
GETEPT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETEPT*'                                                      
                                                                                
         USING GOBLOCKD,R2                                                      
***      L     R2,AGOBLOCK         call GETOPT for scheme code                  
         L     R2,AGOBLOCB         call GETOPT for scheme code                  
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(2),PRODUL                                             
         MVC   GOSELCLI,X#CLIC                                                  
         MVC   GOSELPRO,X#PROC                                                  
         MVC   GOSELJOB,X#JOBC                                                  
                                                                                
         CLC   GOSELJOB,SPACES                                                  
         JH    *+10                                                             
         XC    GOSELJOB,GOSELJOB                                                
                                                                                
         MVC   GOSELMED,GOSELJOB   BINARY ZERO OR 1ST LETTER OF JOB             
         MVC   GOSELWC,TEMP2                                                    
         MVI   GOANYWC,YESQ                                                     
         MVC   GOABEXT,AGOXBLCK                                                 
         OI    GOSPEC3,GOSPNERQ                                                 
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
         ZAP   X#WCESP,GOESTPER    Estimate WC %                                
                                                                                
GETEPTX  J     EXIT                                                             
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Get Opt/Maint values (AIO2 contains SJ account record)              *         
***********************************************************************         
                                                                                
GETOMV   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETOMV*'                                                      
                                                                                
         USING GOBLOCKD,R2                                                      
***      L     R2,AGOBLOCK         call GETOPT for scheme code                  
         L     R2,AGOBLOCB         call GETOPT for scheme code                  
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOAEXT,AGOXBLCK                                                  
         MVC   GOABEXT,AGOBBLCK                                                 
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(2),PRODUL                                             
                                                                                
         USING OMVD,RF                                                          
         LA    RF,X#TEMP                                                        
         MVC   GOSELCLI,OMVCLI                                                  
         MVC   GOSELPRO,OMVPRO                                                  
                                                                                
         MVC   GOSELJOB,OMVJOB                                                  
                                                                                
         CLC   GOSELJOB,SPACES                                                  
         JH    *+10                                                             
         XC    GOSELJOB,GOSELJOB  NEED BINARY ZEROES FOR GETOPT CALL            
                                                                                
         MVC   GOSELMED,OMVMED                                                  
         CLI   OMVMED,C' '                                                      
         JH    *+10                                                             
         DROP  RF                                                               
                                                                                
         MVC   GOSELMED,GOSELJOB   BINARY ZERO OR 1ST LETTER OF JOB             
         OI    GOSPEC3,GOSPNERQ                                                 
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
         J     EXIT                                                             
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Validate and get estimate details for approvers                     *         
***********************************************************************         
                                                                                
VAGEST   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VAGEST '                                                      
                                                                                
         USING EGNPASD,R2                                                       
         LA    R2,IOKEY            read for global estimate number              
         XC    EGNPAS,EGNPAS                                                    
         MVI   EGNPTYP,EGNPTYPQ                                                 
         MVI   EGNPSUB,EGNPSUBQ                                                 
         MVC   EGNPCPY,CUXCPY                                                   
         MVC   EGNPNUM,RQ_EANUM                                                 
                                                                                
         MVC   CSVKEY1,EGNPAS      save key                                     
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
         CLC   CSVKEY1(EGNPCLI-EGNPASD),EGNPAS     does record exist?           
         JE    VAGEST05                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$ESTNE)                                           
         J     VAGESTN                                                          
                                                                                
VAGEST05 CLC   EGNPSOFF,SPACES     validate limit access                        
         JNH   VAGEST10                                                         
                                                                                
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,EGNPSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         DROP  R1                                                               
         GOTO1 VOFFAL              validate office                              
         JE    VAGEST10                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     VAGESTN                                                          
                                                                                
VAGEST10 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING ESTRECD,R2                                                       
         L     R2,AIO2                                                          
         MVC   CSVKEY1,0(R2)       save main record key                         
         MVC   BYTE1,ESTKLNO                                                    
                                                                                
         MVC   X#CLIC,ESTKCLI                                                   
         MVC   X#PROC,ESTKPRO                                                   
         MVC   X#JOBC,ESTKJOB                                                   
                                                                                
         MVC   SJACCNT,SPACES                                                   
         LA    RF,SJACCNT                                                       
         LLC   RE,PCLILEN                                                       
         LR    R1,RE                                                            
         SHI   RE,1                                                             
         BASR  R3,0                                                             
         MVC   0(0,RF),ESTKCLI                                                  
         EX    RE,0(R3)                                                         
         LA    RF,1(RE,RF)                                                      
         LLC   RE,PPROLEN                                                       
         SR    RE,R1                                                            
         LLC   R1,PPROLEN                                                       
         SHI   RE,1                                                             
         BASR  R3,0                                                             
         MVC   0(0,RF),ESTKPRO                                                  
         EX    RE,0(R3)                                                         
         LA    RF,1(RE,RF)                                                      
         LA    RE,L'ESTKJOB-1                                                   
         BASR  R3,0                                                             
         MVC   0(0,RF),ESTKJOB                                                  
         EX    RE,0(R3)                                                         
                                                                                
         USING EMDELD,RF                                                        
         LA    RF,ESTRFST                                                       
         MVC   X#CLAP,EMDSCA                                                    
         MVC   X#INAP,EMDSIA                                                    
         MVC   X#CRETR,EMDAPI                                                   
                                                                                
VAGEST15 LR    R3,R2                                                            
         AHI   R3,ESTRFST-ESTRECD                                               
         XR    R0,R0                                                            
         XC    X#CRETR,X#CRETR                                                  
         USING STCELD,R3                                                        
VAGEST20 CLI   STCEL,0                                                          
         JE    VAGESTY                                                          
         CLI   STCEL,STCELQ                                                     
         JNE   VAGEST25                                                         
         CLI   STCIND,STCIEST2     New aura estimate status                     
         JNE   VAGEST22                                                         
         CLI   STCETY2,STCEAEA     Added element?                               
         JNE   VAGEST25                                                         
         J     *+12                                                             
*                                                                               
VAGEST22 CLI   STCDFR,STCEADDE     Who added estimate                           
         JNE   VAGEST25                                                         
         MVC   X#CRETR,STCPERS                                                  
         J     VAGESTY                                                          
VAGEST25 LLC   R0,STCLN                                                         
         AR    R3,R0                                                            
         J     VAGEST20                                                         
*                                                                               
VAGESTY  J     EXITY                                                            
                                                                                
VAGESTN  J     EXITN                                                            
         DROP  R2,RF                                                            
         EJECT                                                                  
***********************************************************************         
* Validate single PID entry                                           *         
***********************************************************************         
                                                                                
VSINPID  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VSINPID'                                                      
                                                                                
         MVC   TEMP2(L'RQ_EAPID),RQ_EAPID                                       
         GOTOR (#GETPIN,AGETPIN)                                                
         JE    VSINPID2                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$INPID)                                           
         J     VSINPIDN                                                         
                                                                                
VSINPID2 MVC   EA_CODE,RQ_EAPID                                                 
         MVC   EA_BPID,TEMP2+50                                                 
         MVC   EA_FNAM,TEMP2                                                    
         MVC   EA_MNAM,TEMP2+32                                                 
         MVC   EA_LNAM,WORK2                                                    
         MVI   EA_IDEF,NOQ                                                      
                                                                                
         GOTOR LP_APUTO,LP_D                                                    
                                                                                
VSINPIDY J     EXITY                                                            
                                                                                
VSINPIDN J     EXITN                                                            
                                                                                
***********************************************************************         
* Validate client, product and job                                    *         
***********************************************************************         
                                                                                
VALCPJ   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VALCPJ '                                                      
                                                                                
         MVC   X#CLIC,RQ_EACLI                                                  
         MVC   X#PROC,RQ_EAPRO                                                  
         MVC   X#JOBC,RQ_EAJOB                                                  
         OC    X#CLIC(L'X#CLIC+L'X#PROC+L'X#JOBC),SPACES                        
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY            read for SJ account                          
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT(L'X#CLIC),X#CLIC                                         
         LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         LLC   R1,PJOBLEN                                                       
         LA    R3,ACTKACT(RE)                                                   
         LR    R4,RF                                                            
         SR    R4,RE                                                            
         SHI   R4,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),X#PROC                                                   
         EX    R4,0(RE)                                                         
         AHI   R4,1                                                             
         AR    R3,R4                                                            
         LR    R4,R1                                                            
         SR    R4,RF                                                            
         CHI   R4,6                                                             
         JNH   *+8                                                              
         LA    R4,6                                                             
         SHI   R4,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),X#JOBC                                                   
         EX    R4,0(RE)                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    VALCPJ10                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$INJOB)                                           
         J     VALCPJN                                                          
                                                                                
VALCPJ10 TM    ACTKSTAT,ACTSABLP                                                
         JNZ   VALCPJ15                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$NLOWA)                                           
         J     VALCPJN                                                          
                                                                                
VALCPJ15 MVC   SJACCNT,ACTKACT                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING PPRELD,R3                                                        
         L     R2,AIO2                                                          
         LR    R3,R2                                                            
         AHI   R3,ACTRFST-ACTRECD                                               
                                                                                
VALCPJ20 CLI   PPREL,0                                                          
         JE    VALCPJY                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    VALCPJ25                                                         
         LLC   R0,PPRLN                                                         
         AR    R3,R0                                                            
         J     VALCPJ20                                                         
                                                                                
VALCPJ25 MVC   X#SJOFF,PPRGAOFF                                                 
         OC    X#SJOFF,SPACES                                                   
                                                                                
VALCPJY  J     EXITY                                                            
                                                                                
VALCPJN  J     EXITN                                                            
                                                                                
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Get Office code                                                     *         
***********************************************************************         
                                                                                
VALOFF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VALOFF '                                                      
                                                                                
         CLC   X#SJOFF,SPACES      (set earlier in VALCPJ?)                     
         JH    VALOFFY             (yes)                                        
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'PRODUL),PRODUL                                         
         LLC   RE,PJOBLEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),SJACCNT                                               
         EX    RE,0(RF)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   VALOFFN                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   VALOFFN                                                          
                                                                                
         USING PPRELD,R3                                                        
         L     R2,AIO2                                                          
         LR    R3,R2                                                            
         AHI   R3,ACTRFST-ACTRECD                                               
                                                                                
VALOFF20 CLI   PPREL,0                                                          
         JE    VALOFF30                                                         
         CLI   PPREL,PPRELQ                                                     
         JE    VALOFF25                                                         
         LLC   R0,PPRLN                                                         
         AR    R3,R0                                                            
         J     VALOFF20                                                         
                                                                                
VALOFF25 CLC   PPRGAOFF,SPACES                                                  
         JNH   VALOFF30                                                         
         MVC   X#SJOFF,PPRGAOFF                                                 
         OC    X#SJOFF,SPACES                                                   
         J     VALOFFY                                                          
                                                                                
VALOFF30 LA    R2,IOKEY                                                         
         MVC   ACTKACT,SPACES                                                   
         LLC   RE,PPROLEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),SJACCNT                                               
         EX    RE,0(RF)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   VALOFFN                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   VALOFFN                                                          
                                                                                
         USING PPRELD,R3                                                        
         L     R2,AIO2                                                          
         LR    R3,R2                                                            
         AHI   R3,ACTRFST-ACTRECD                                               
                                                                                
VALOFF35 CLI   PPREL,0                                                          
         JE    VALOFF45                                                         
         CLI   PPREL,PPRELQ                                                     
         JE    VALOFF40                                                         
         LLC   R0,PPRLN                                                         
         AR    R3,R0                                                            
         J     VALOFF35                                                         
                                                                                
VALOFF40 CLC   PPRGAOFF,SPACES                                                  
         JNH   VALOFF45                                                         
         MVC   X#SJOFF,PPRGAOFF                                                 
         OC    X#SJOFF,SPACES                                                   
         J     VALOFFY                                                          
                                                                                
VALOFF45 LA    R2,IOKEY                                                         
         MVC   ACTKACT,SPACES                                                   
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),SJACCNT                                               
         EX    RE,0(RF)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   VALOFFN                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   VALOFFN                                                          
                                                                                
         USING PPRELD,R3                                                        
         L     R2,AIO2                                                          
         LR    R3,R2                                                            
         AHI   R3,ACTRFST-ACTRECD                                               
                                                                                
VALOFF50 CLI   PPREL,0                                                          
         JE    VALOFFY                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    VALOFF55                                                         
         LLC   R0,PPRLN                                                         
         AR    R3,R0                                                            
         J     VALOFF50                                                         
                                                                                
VALOFF55 MVC   X#SJOFF,PPRGAOFF                                                 
         OC    X#SJOFF,SPACES                                                   
                                                                                
VALOFFY  J     EXITY                                                            
                                                                                
VALOFFN  J     EXITN                                                            
                                                                                
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Get previous estimate's approver                                    *         
***********************************************************************         
                                                                                
PREAPP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PREAPP '                                                      
                                                                                
         LA    R0,ACCBLK           init approver area                           
         LHI   R1,L'ACCBLK                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         USING ESTRECD,R2                                                       
         LA    R2,IOKEY            read for previous estimates                  
         XC    ESTKEY,ESTKEY          on job to extract approvers               
         MVI   ESTKTYP,ESTKTYPQ         previuously chosen                      
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CUXCPY                                                   
         MVC   ESTKCLI,X#CLIC                                                   
         MVC   ESTKPRO,X#PROC                                                   
         MVC   ESTKJOB,X#JOBC                                                   
                                                                                
         MVC   CSVKEY1,ESTKEY                                                   
         MVI   BYTE2,0                                                          
                                                                                
PREAPP10 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
         CLC   CSVKEY1(ESTKLNO-ESTRECD),ESTKEY                                  
         JNE   PREAPPX                                                          
         CLC   ESTKLNO,BYTE2       Get last estimate                            
         JNH   PREAPPX                                                          
         MVC   BYTE2,ESTKLNO                                                    
                                                                                
PREAPP20 CLI   ESTKSEQ,ESTKSMQ     only interested in main records              
         JNE   PREAPP40                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING EMDELD,R3                                                        
         L     R2,AIO2                                                          
         LR    R3,R2                                                            
         AHI   R3,ESTRFST-ESTRECD                                               
         CLI   EMDEL,EMDELQ                                                     
         JNE   PREAPP30                                                         
         OC    EMDSCA,EMDSCA                                                    
         JZ    *+10                                                             
         MVC   X#CLAPJ,EMDSCA      Client approver                              
         OC    EMDSIA,EMDSIA                                                    
         JZ    *+10                                                             
         MVC   X#INAPJ,EMDSIA      Internal approver                            
                                                                                
         USING STCELD,R3                                                        
PREAPP30 LLC   R0,STCLN                                                         
         AR    R3,R0                                                            
                                                                                
         CLI   STCEL,0                                                          
         JE    PREAPP40                                                         
         CLI   STCEL,STCELQ                                                     
         JNE   PREAPP30                                                         
         CLI   STCDTO,OCLIAPP      fully (client) approved?                     
         JE    *+12                                                             
         CLI   STCDTO,STCECAPP                                                  
         JNE   PREAPP32                                                         
         MVC   X#CLAPJ,STCPERS                                                  
         J     PREAPP30                                                         
PREAPP32 CLI   STCDTO,OINTAPP      internally approved?                         
         JE    *+12                                                             
         CLI   STCDTO,STCEIAPP                                                  
         JNE   PREAPP30                                                         
         MVC   X#INAPJ,STCPERS                                                  
         J     PREAPP30                                                         
                                                                                
PREAPP40 LA    R2,IOKEY                                                         
         MVI   ESTKSEQ,FF                                                       
         J     PREAPP10            read high for next estimate                  
                                                                                
PREAPPX  J     EXIT                                                             
                                                                                
***********************************************************************         
* Output approvers                                                    *         
***********************************************************************         
                                                                                
OUTAPP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*OUTAPP '                                                      
                                                                                
         USING LAPPRTD,R3                                                       
         LA    R3,ACCBLK                                                        
         OC    LAPPRPID,LAPPRPID   any approvers?                               
         JZ    OUTAPPN                                                          
                                                                                
         CLC   RQ_EANUM,SPACES     Global number specified?                     
         JNH   OUTAPP32            No - no previous approvers                   
         CLI   RQ_EAINT,C'B'       Retrun both internal and client              
         JE    *+12                Yes                                          
         CLI   RQ_EAINT,YESQ       Only internal                                
         JE    OUTAPP18            Yes                                          
*        TM    G#OFSTA2,OFFSIAEQ   Internal approvals in use?                   
*        JZ    OUTAPP18                                                         
                                                                                
         OC    X#CLAP,X#CLAP       client approver already chosen?              
         JZ    OUTAPP16            no                                           
OUTAPP04 OC    LAPPRPID,LAPPRPID                                                
         JZ    OUTAPP16                                                         
         CLI   LAPPRCOI,C'C'                                                    
         JNE   OUTAPP06                                                         
         CLC   LAPPRPID,X#CLAP                                                  
         JE    OUTAPP08                                                         
OUTAPP06 AHI   R3,LAPPRLQ                                                       
         J     OUTAPP04                                                         
                                                                                
OUTAPP08 MVC   TEMP2(2),X#CLAP     pass out supposed client approver            
         MVC   EA_BPID,X#CLAP                                                   
         GOTOR (#GETPID,AGETPID)                                                
         MVC   EA_CODE,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   OUTAPP16                                                         
         L     R2,AIO1                                                          
         LA    RF,SAPEDATA-SAPEREC(R2)                                          
*                                                                               
         USING SAPERD,RF                                                        
OUTAPP10 CLI   SAPEREL,0           Check if user terminated                     
         JE    *+2                                                              
         CLI   SAPEREL,SAPERELQ                                                 
         JE    OUTAPP12                                                         
         LLC   R0,SAPERLN          L'ELEMENT                                    
         AR    RF,R0                                                            
         J     OUTAPP10                                                         
*                                                                               
OUTAPP12 OC    SAPERDTE,SAPERDTE   Are they terminated?                         
         JZ    OUTAPP14                                                         
         CLC   SAPERDTE,XL#TODC    Check whether terminated in the              
         JNH   OUTAPP16              in the now or in the past                  
         DROP  RF                                                               
*                                                                               
OUTAPP14 MVC   EA_FNAM,TEMP2                                                    
         MVC   EA_MNAM,TEMP2+32                                                 
         MVC   EA_LNAM,WORK2                                                    
         MVI   EA_IDEF,YESQ                                                     
         MVI   EA_APTY,C'S'        'supposed' client approver                   
         MVC   EA_ALEV,LAPPRLEV                                                 
                                                                                
         GOTOR LP_APUTO,LP_D       download main data                           
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   OUTAPPY                                                          
                                                                                
OUTAPP16 CLI   RQ_EAINT,C'B'       Return both internal and client              
         JNE   OUTAPP32            Yes                                          
         LA    R3,ACCBLK                                                        
OUTAPP18 OC    X#INAP,X#INAP       Internal approver already chosen             
         JZ    OUTAPP32            no                                           
OUTAPP20 OC    LAPPRPID,LAPPRPID                                                
         JZ    OUTAPP32                                                         
         CLI   LAPPRCOI,C'I'                                                    
         JNE   OUTAPP22                                                         
         CLC   LAPPRPID,X#INAP                                                  
         JE    OUTAPP24                                                         
OUTAPP22 AHI   R3,LAPPRLQ                                                       
         J     OUTAPP20                                                         
                                                                                
OUTAPP24 MVC   TEMP2(2),X#INAP     pass out supposed internal approver          
         MVC   EA_BPID,X#INAP                                                   
         GOTOR (#GETPID,AGETPID)                                                
         MVC   EA_CODE,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   OUTAPP32                                                         
         L     R2,AIO1                                                          
         LA    RF,SAPEDATA-SAPEREC(R2)                                          
*                                                                               
         USING SAPERD,RF                                                        
OUTAPP26 CLI   SAPEREL,0           Check if user terminated                     
         JE    *+2                                                              
         CLI   SAPEREL,SAPERELQ                                                 
         JE    OUTAPP28                                                         
         LLC   R0,SAPERLN          L'ELEMENT                                    
         AR    RF,R0                                                            
         J     OUTAPP26                                                         
*                                                                               
OUTAPP28 OC    SAPERDTE,SAPERDTE   Are they terminated?                         
         JZ    OUTAPP30                                                         
         CLC   SAPERDTE,XL#TODC    Check whether terminated in the              
         JNH   OUTAPP32              in the now or in the past                  
         DROP  RF                                                               
*                                                                               
OUTAPP30 MVC   EA_FNAM,TEMP2                                                    
         MVC   EA_MNAM,TEMP2+32                                                 
         MVC   EA_LNAM,WORK2                                                    
         MVI   EA_IDEF,YESQ                                                     
         MVI   EA_APTY,C'Q'        'supposed' internal approver                 
         MVC   EA_ALEV,LAPPRLEV                                                 
                                                                                
         GOTOR LP_APUTO,LP_D       download main data                           
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   OUTAPPY                                                          
*                                                                               
OUTAPP32 MVI   BYTE1,NOQ                                                        
         CLI   RQ_EAINT,C'B'       Return both internal and client              
         JE    *+12                Yes                                          
         CLI   RQ_EAINT,YESQ       Only internal                                
         JE    OUTAPP52            Yes                                          
         LA    R3,ACCBLK                                                        
OUTAPP34 OC    LAPPRPID,LAPPRPID                                                
         JZ    OUTAPP40                                                         
         CLI   LAPPRCOI,C'I'                                                    
         JE    OUTAPP36                                                         
         CLI   LAPPRDEF,YESQ       default approver found?                      
         JE    OUTAPP38                                                         
         CLC   LAPPRPID,X#CLAPJ    previous approver still valid?               
         JNE   *+8                                                              
         MVI   BYTE1,YESQ                                                       
OUTAPP36 AHI   R3,LAPPRLQ                                                       
         J     OUTAPP34                                                         
                                                                                
OUTAPP38 MVC   X#CLAPJ,LAPPRPID    pass out default approver                    
         J     OUTAPP42                                                         
                                                                                
OUTAPP40 OC    X#CLAPJ,X#CLAPJ     any previous approver found?                 
         JZ    OUTAPP50                                                         
         CLI   BYTE1,YESQ          still valid?                                 
         JNE   OUTAPP50                                                         
                                                                                
OUTAPP42 MVC   TEMP2(2),X#CLAPJ    pass out first default approver or           
         MVC   EA_BPID,X#CLAPJ                                                  
         GOTOR (#GETPID,AGETPID)   previous approver if still valid             
         MVC   EA_CODE,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   OUTAPP50                                                         
         L     R2,AIO1                                                          
         LA    RF,SAPEDATA-SAPEREC(R2)                                          
*                                                                               
         USING SAPERD,RF                                                        
         XR    R0,R0                                                            
OUTAPP44 CLI   SAPEREL,0           Check if user terminated                     
         JE    *+2                                                              
         CLI   SAPEREL,SAPERELQ                                                 
         JE    OUTAPP46                                                         
         IC    R0,SAPERLN          L'ELEMENT                                    
         AR    RF,R0                                                            
         J     OUTAPP44                                                         
*                                                                               
OUTAPP46 OC    SAPERDTE,SAPERDTE   Are they terminated user?                    
         JZ    OUTAPP48                                                         
         CLC   SAPERDTE,XL#TODC    Check whether terminated before              
         JNH   OUTAPP50             today - if so skip them                     
         DROP  RF                                                               
OUTAPP48 MVC   EA_FNAM,TEMP2                                                    
         MVC   EA_LNAM,WORK2                                                    
         MVC   EA_MNAM,TEMP2+32                                                 
         MVI   EA_IDEF,YESQ                                                     
         MVI   EA_APTY,C'C'                                                     
         MVC   EA_ALEV,LAPPRLEV                                                 
                                                                                
         GOTOR LP_APUTO,LP_D       download main data                           
OUTAPP50 CLI   RQ_EAINT,C'B'       Return both internal and client              
         JNE   OUTAPP70            Yes                                          
                                                                                
OUTAPP52 MVI   BYTE1,NOQ                                                        
         LA    R3,ACCBLK                                                        
OUTAPP54 OC    LAPPRPID,LAPPRPID                                                
         JZ    OUTAPP60                                                         
         CLI   LAPPRCOI,C'C'                                                    
         JE    OUTAPP56                                                         
         CLI   LAPPRDEF,YESQ       default approver found?                      
         JE    OUTAPP58                                                         
         CLC   LAPPRPID,X#INAPJ    previous approver still valid?               
         JNE   *+8                                                              
         MVI   BYTE1,YESQ                                                       
OUTAPP56 AHI   R3,LAPPRLQ                                                       
         J     OUTAPP54                                                         
                                                                                
OUTAPP58 MVC   X#INAPJ,LAPPRPID    pass out default approver                    
         J     OUTAPP62                                                         
                                                                                
OUTAPP60 OC    X#INAPJ,X#INAPJ     any previous approver found?                 
         JZ    OUTAPP70                                                         
         CLI   BYTE1,YESQ          still valid?                                 
         JNE   OUTAPP70                                                         
                                                                                
OUTAPP62 MVC   TEMP2(2),X#INAPJ    pass out first default approver or           
         MVC   EA_BPID,X#INAPJ                                                  
         GOTOR (#GETPID,AGETPID)   previous approver if still valid             
         MVC   EA_CODE,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   OUTAPP70                                                         
         L     R2,AIO1                                                          
         LA    RF,SAPEDATA-SAPEREC(R2)                                          
*                                                                               
         USING SAPERD,RF                                                        
         XR    R0,R0                                                            
OUTAPP64 CLI   SAPEREL,0           Check if user terminated                     
         JE    *+2                                                              
         CLI   SAPEREL,SAPERELQ                                                 
         JE    OUTAPP66                                                         
         IC    R0,SAPERLN          L'ELEMENT                                    
         AR    RF,R0                                                            
         J     OUTAPP64                                                         
*                                                                               
OUTAPP66 OC    SAPERDTE,SAPERDTE   Are they terminated user?                    
         JZ    OUTAPP68                                                         
         CLC   SAPERDTE,XL#TODC    Check whether terminated before              
         JNH   OUTAPP70             today - if so skip them                     
         DROP  RF                                                               
OUTAPP68 MVC   EA_FNAM,TEMP2                                                    
         MVC   EA_LNAM,WORK2                                                    
         MVC   EA_MNAM,TEMP2+32                                                 
         MVI   EA_IDEF,YESQ                                                     
         MVI   EA_APTY,C'I'                                                     
         MVC   EA_ALEV,LAPPRLEV                                                 
                                                                                
         GOTOR LP_APUTO,LP_D       download main data                           
                                                                                
OUTAPP70 MVI   BYTE1,YESQ                                                       
         LA    R3,ACCBLK                                                        
         CLI   LAPPRLEV,AGENCYQ    all entries for global approvers?            
         JE    OUTAPP72                                                         
         MVI   BYTE1,NOQ           no                                           
                                                                                
OUTAPP72 OC    LAPPRPID,LAPPRPID   end of table                                 
         JZ    OUTAPPY                                                          
         CLI   BYTE1,YESQ                                                       
         JE    *+12                                                             
         CLI   LAPPRLEV,AGENCYQ                                                 
         JE    OUTAPP90                                                         
                                                                                
         CLI   RQ_EAINT,C'B'       Return both internal and client              
         JE    OUTAPP76                                                         
         MVI   BYTE2,C'C'                                                       
         CLI   RQ_EAINT,YESQ       Return internal only                         
         JE    *+8                                                              
         MVI   BYTE2,C'I'                                                       
         CLC   LAPPRCOI,BYTE2      Are we dealing with client or                
         JE    OUTAPP90                                    internal             
                                                                                
OUTAPP76 LA    RE,X#CLAPJ                                                       
         CLI   LAPPRCOI,C'C'       Are we dealing with client or                
         JE    *+8                                         internal             
         LA    RE,X#INAPJ                                                       
         CLC   LAPPRPID,0(RE)      exclude if it was 'previous'                 
         JE    OUTAPP90                                                         
                                                                                
         MVC   TEMP2(2),LAPPRPID   pass it out                                  
         MVC   EA_BPID,LAPPRPID                                                 
         GOTOR (#GETPID,AGETPID)                                                
         MVC   EA_CODE,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   OUTAPP90                                                         
         L     R2,AIO1                                                          
         LA    RF,SAPEDATA-SAPEREC(R2)                                          
*                                                                               
         USING SAPERD,RF                                                        
         XR    R0,R0                                                            
OUTAPP84 CLI   SAPEREL,0           Check if user terminated                     
         JE    *+2                                                              
         CLI   SAPEREL,SAPERELQ                                                 
         JE    OUTAPP86                                                         
         IC    R0,SAPERLN          L'ELEMENT                                    
         AR    RF,R0                                                            
         J     OUTAPP84                                                         
*                                                                               
OUTAPP86 OC    SAPERDTE,SAPERDTE   Are they terminated?                         
         JZ    OUTAPP88                                                         
         CLC   SAPERDTE,XL#TODC    Check whether terminated after today         
         JNH   OUTAPP90              as should be allowed if in future          
         DROP  RF                                                               
*                                                                               
OUTAPP88 MVC   EA_FNAM,TEMP2                                                    
         MVC   EA_MNAM,TEMP2+32                                                 
         MVC   EA_LNAM,WORK2                                                    
         MVC   EA_IDEF,LAPPRDEF                                                 
         MVC   EA_APTY,LAPPRCOI                                                 
         MVC   EA_ALEV,LAPPRLEV                                                 
                                                                                
         GOTOR LP_APUTO,LP_D       download main data                           
                                                                                
OUTAPP90 AHI   R3,LAPPRLQ                                                       
         J     OUTAPP72                                                         
                                                                                
OUTAPPN  J     EXITN                                                            
OUTAPPY  J     EXITY                                                            
         DROP  R3                                                               
                                                                                
***********************************************************************         
* Get all client approvers                                            *         
***********************************************************************         
                                                                                
GTCAPP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GTCAPP*'                                                      
                                                                                
         STC   R1,BYTE1                                                         
                                                                                
         USING JOBPASD,R2                                                       
         USING LAPPRTD,R3                                                       
         LA    R4,APRTABL                                                       
         USING APRTABD,R4                                                       
         LA    R2,IOKEY                                                         
GTCAPP00 XC    JOBPAS,JOBPAS                                                    
         MVI   JOBPTYP,JOBPTYPQ                                                 
         MVI   JOBPSUB,JOBPSUBQ                                                 
         MVC   JOBPCPY,CUXCPY                                                   
         MVI   JOBPAPPL,JOBPAEST                                                
         CLI   BYTE1,1            read for internal approvers?                  
         JNE   *+8                                                              
         MVI   JOBPAPPL,JOBPAESI                                                
         MVI   JOBPVIEW,JOBPVOFF                                                
         MVC   JOBPCOFF,SPACES                                                  
         MVC   JOBPCPJ,SPACES                                                   
         MVC   JOBPCMED,SPACES                                                  
                                                                                
         XR    RE,RE                                                            
         TM    APRSTAT,APRJOB      Are we looking at job level                  
         JZ    GTCAPP02                                                         
         MVC   JOBPCPJ,SJACCNT                                                  
         J     GTCAPP04                                                         
                                                                                
GTCAPP02 TM    APRSTAT,APRPRO      Are we looking at pro level                  
         JZ    GTCAPP03                                                         
         LLC   RE,PPROLEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   JOBPCPJ(0),SJACCNT                                               
         EX    RE,0(RF)                                                         
         J     GTCAPP04                                                         
                                                                                
GTCAPP03 TM    APRSTAT,APRCLI      Are we looking at cli level                  
         JZ    GTCAPP04                                                         
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   JOBPCPJ(0),SJACCNT                                               
         EX    RE,0(RF)                                                         
                                                                                
GTCAPP04 TM    APRSTAT,APRMED      Media level                                  
         JZ    GTCAPP06                                                         
         MVC   JOBPCMED,X#JOBC                                                  
                                                                                
GTCAPP06 TM    APRSTAT,APROFF      Office level                                 
         JZ    GTCAPP08                                                         
         CLC   X#SJOFF,SPACES                                                   
         JNH   GTCAPP12                                                         
         MVC   JOBPCOFF,X#SJOFF                                                 
                                                                                
GTCAPP08 MVC   CSVKEY1,JOBPAS                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
GTCAPP10 CLC   JOBPAS(JOBPPIDB-JOBPASD),CSVKEY1                                 
         JE    GTCAPP35                                                         
                                                                                
GTCAPP12 LA    R4,APRTABLQ(R4)                                                  
         CLI   0(R4),X'FF'                                                      
         JNE   GTCAPP00                                                         
         J     GTCAPPY                                                          
                                                                                
GTCAPP20 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JE    GTCAPP10                                                         
         MVC   ROUERRV,=AL2(AE$DSKER)                                           
         J     GTCAPPN                                                          
                                                                                
GTCAPP35 LA    R3,ACCBLK                                                        
         TM    CPXSTAT8,CPXNSLFS   Is self selection allowed                    
         JZ    GTCAPP40            Yes                                          
         OC    X#CRETR,X#CRETR     No - did we find the creator                 
         JZ    GTCAPP40            No                                           
         CLC   X#CRETR,JOBPPIDB    Same person as approver                      
         JE    GTCAPP20            Yes - look for another approver              
                                                                                
GTCAPP40 OC    LAPPRPID,LAPPRPID                                                
         JZ    GTCAPP50                                                         
         CLI   BYTE1,2             Are we getting internal or client            
         JNE   *+12                Internal                                     
         CLI   LAPPRCOI,C'I'       Client - therefore ignore previous           
         JE    GTCAPP45             internal approver entries                   
         CLC   LAPPRPID,JOBPPIDB                                                
         JE    GTCAPP20                                                         
GTCAPP45 AHI   R3,LAPPRLQ                                                       
         J     GTCAPP40                                                         
                                                                                
GTCAPP50 MVC   LAPPRPID,JOBPPIDB   save to table                                
         MVI   LAPPRCOI,C'C'       client approver                              
         CLI   JOBPAPPL,JOBPAEST                                                
         JE    *+8                                                              
         MVI   LAPPRCOI,C'I'       internal approver                            
         MVC   LAPPRLEV,1(R4)                                                   
         MVI   LAPPRDEF,NOQ                                                     
         TM    JOBPSTAT,JOBPDFLT                                                
         JZ    GTCAPP20                                                         
         MVI   LAPPRDEF,YESQ                                                    
         J     GTCAPP20            and get next record                          
                                                                                
GTCAPPY  J     EXITY                                                            
                                                                                
GTCAPPN  J     EXITN                                                            
                                                                                
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* Get all estimate approvers                                          *         
***********************************************************************         
                                                                                
GTEAPP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GTEAPP*'                                                      
                                                                                
         STC   R1,BYTE1                                                         
                                                                                
         USING LAPPRTD,R3                                                       
         USING JOBPASD,R2                                                       
         LA    R2,IOKEY            read for job estimates                       
         XC    JOBPAS,JOBPAS                                                    
         MVI   JOBPTYP,JOBPTYPQ                                                 
         MVI   JOBPSUB,JOBPSUBQ                                                 
         MVC   JOBPCPY,CUXCPY                                                   
         MVI   JOBPAPPL,JOBPAEST                                                
         CLI   BYTE1,1                                                          
         JNE   *+8                                                              
         MVI   JOBPAPPL,JOBPAESI                                                
         MVI   JOBPVIEW,JOBPVOFF                                                
         MVI   JOBPCODE,FF                                                      
         MVC   JOBPCODE+1(L'JOBPCODE-1),JOBPCODE                                
         MVC   CSVKEY2,JOBPAS                                                   
                                                                                
GTEAPP10 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    GTEAPP25                                                         
         MVC   ROUERRV,=AL2(AE$DSKER)                                           
         J     GTEAPPN                                                          
                                                                                
GTEAPP20 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JE    GTEAPP25                                                         
         MVC   ROUERRV,=AL2(AE$DSKER)                                           
         J     GTEAPPN                                                          
                                                                                
GTEAPP25 CLC   JOBPAS(JOBPPIDB-JOBPASD),CSVKEY2                                 
         JNE   GTEAPPY             end of file                                  
                                                                                
         LA    R3,ACCBLK                                                        
         TM    CPXSTAT8,CPXNSLFS   Is self selection allowed                    
         JZ    GTEAPP40            Yes                                          
         OC    X#CRETR,X#CRETR     No - did we find the creator                 
         JZ    GTEAPP40            No                                           
         CLC   X#CRETR,JOBPPIDB    Same person as approver                      
         JE    GTEAPP20            Yes - look for another approver              
                                                                                
GTEAPP40 OC    LAPPRPID,LAPPRPID                                                
         JZ    GTEAPP50                                                         
         CLI   BYTE1,2             Are we getting internal or client            
         JNE   *+12                Internal                                     
         CLI   LAPPRCOI,C'I'       Client - therefore ignore previous           
         JE    GTEAPP45             internal approver entries                   
         CLC   LAPPRPID,JOBPPIDB                                                
         JE    GTEAPP20                                                         
GTEAPP45 AHI   R3,LAPPRLQ                                                       
         J     GTEAPP40                                                         
                                                                                
GTEAPP50 MVC   LAPPRPID,JOBPPIDB   save to table                                
         MVI   LAPPRDEF,NOQ                                                     
         MVI   LAPPRCOI,C'C'       Client approver                              
         CLI   JOBPAPPL,JOBPAEST                                                
         JE    *+8                                                              
         MVI   LAPPRCOI,C'I'       Internal approver                            
         MVI   LAPPRLEV,AGENCYQ    1R level approver                            
         J     GTEAPP20            and get next record                          
                                                                                
GTEAPPY  J     EXITY                                                            
                                                                                
GTEAPPN  J     EXITN                                                            
                                                                                
         DROP  R2,R3                                                            
                                                                                
***********************************************************************         
* Get all PIDS as approvers                                           *         
***********************************************************************         
                                                                                
GTAAPP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GTAAPP*'                                                      
                                                                                
         L     R0,AGENAREA         Use GENAREA for PIDs                         
         LHI   R1,L'GENAREA        Clear this area                              
         XR    RF,RF                                                            
         XR    RE,RE                                                            
         MVCL  R0,RE                                                            
                                                                                
         USING SAPEREC,R2                                                       
         LA    R4,X#MAXIOQ         set counter to max                           
         MVI   BYTE1,NOQ                                                        
         MVC   HALF2,X#CLAPJ                                                    
         CLI   RQ_EAINT,YESQ       Return internal only                         
         JNE   *+10                                                             
         MVC   HALF2,X#INAPJ                                                    
         OC    HALF2,HALF2         look for 'previous'                          
         JZ    GTAAPP05                                                         
                                                                                
         MVI   BYTE1,YESQ                                                       
         MVC   TEMP2(L'X#INAPJ),HALF2 then pass it out                          
         GOTOR (#GETPID,AGETPID)                                                
         MVC   EA_CODE,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   GTAAPP05                                                         
         MVC   EA_BPID,TEMP2+50                                                 
         MVC   EA_FNAM,TEMP2                                                    
         MVC   EA_MNAM,TEMP2+32                                                 
         MVC   EA_LNAM,WORK2                                                    
         MVI   EA_IDEF,YESQ                                                     
                                                                                
         GOTOR LP_APUTO,LP_D       download main data                           
                                                                                
GTAAPP05 CLI   RQ_EAAPR,YESQ       read for all PIDS                            
         JE    GTAAPP50            No - read for approvers                      
                                                                                
         LA    R2,IOKEY                                                         
         XC    SAPEKEY,SAPEKEY     BUILD KEY TO READ                            
         MVI   SAPETYP,SAPETYPQ                                                 
         MVI   SAPESUB,SAPESUBQ                                                 
         OC    SAPEAGY,CUSALF      USE SECURITY AGENCY IF PRESENT               
         JNZ   *+10                                                             
         MVC   SAPEAGY,CUAALF      ELSE NATIVE AGENCY                           
         MVC   SAPEPID,SPACES                                                   
         MVI   SAPEPID+L'SAPEPID-1,X'41'                                        
                                                                                
GTAAPP08 MVC   CSVKEY1,SAPEKEY                                                  
         XC    DUB,DUB                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOCTL+IO2'                               
         JE    GTAAPP12                                                         
         DC    H'0'                                                             
                                                                                
GTAAPP10 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IOCTL+IO2'                               
         JNE   *+2                                                              
                                                                                
GTAAPP12 L     R2,AIO2                                                          
         CLC   SAPEKEY(SAPEPID-SAPEREC),CSVKEY1                                 
         JNE   GTAAPP90                                                         
                                                                                
         SHI   R4,1                check against maximum                        
         LTR   R4,R4                                                            
         JZ    GTAAPP90                                                         
                                                                                
         CLC   SAPEPID,SPACES                                                   
         JNH   GTAAPP10                                                         
                                                                                
         CLC   DUB,SAPEPID         ignore duplicates                            
         JE    GTAAPP10                                                         
         CLC   HALF2,SAPEPID       also against 'previous'                      
                                                                                
         MVC   DUB,SAPEPID                                                      
         MVI   BYTE1,YESQ                                                       
         MVC   EA_CODE,SAPEPID                                                  
         MVI   EA_IDEF,NOQ                                                      
         MVC   EA_FNAM,SPACES                                                   
         MVC   EA_LNAM,SPACES                                                   
         MVC   EA_MNAM,SPACES                                                   
                                                                                
         LA    R3,SAPEDATA                                                      
         USING SANAMD,R3                                                        
GTAAPP14 CLI   SANAMEL,SANAMELQ                                                 
         JE    GTAAPP30                                                         
         CLI   SANAMEL,SAPERELQ                                                 
         JE    GTAAPP18                                                         
         CLI   SANAMEL,SAPWDELQ                                                 
         JE    GTAAPP20                                                         
         CLI   SANAMEL,0                                                        
         JE    GTAAPP40            NO NAMES?                                    
                                                                                
GTAAPP16 LLC   R0,SANAMLN          L'ELEMENT                                    
         AR    R3,R0                                                            
         J     GTAAPP14                                                         
                                                                                
         USING SAPERD,R3                                                        
GTAAPP18 OC    SAPERDTE,SAPERDTE   Any terminated date?                         
         JZ    GTAAPP16                                                         
         CLC   SAPERDTE,XL#TODC    Check whether terminated in the              
         JNH   GTAAPP42             in the future                               
         J     GTAAPP16                                                         
                                                                                
         USING SAPWDD,R3                                                        
GTAAPP20 MVC   EA_BPID,SAPWDNUM    PASS 2 CHAR HEX PID                          
         J     GTAAPP16                                                         
                                                                                
         USING SANAMD,R3                                                        
GTAAPP30 LA    R1,SANAMELN         L'NAME                                       
         USING SANAMELN,R1                                                      
         TM    SANAMIND,SANAMIFN   TEST FIRST NAME PRESENT                      
         JZ    GTAAPP32                                                         
         LLC   RF,SANAMELN                                                      
         CHI   RF,16               TEST > MAX LENGTH                            
         JNH   *+8                                                              
         LA    RF,16               SET IT IF GREATER                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   EA_FNAM(0),SANAME                                                
         EX    RF,0(RE)                                                         
         LA    R1,2(RF,R1)                                                      
                                                                                
GTAAPP32 TM    SANAMIND,SANAMIMN   TEST MIDDLE NAME PRESENT TOO                 
         JZ    GTAAPP34                                                         
         LLC   RF,SANAMELN                                                      
         CHI   RF,16               TEST > MAX LENGTH                            
         JNH   *+8                                                              
         LA    RF,16               SET IT IF GREATER                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   EA_MNAM(0),SANAME                                                
         EX    RF,0(RE)                                                         
         LA    R1,2(RF,R1)         BUMP PAST IT TO LAST NAME                    
                                                                                
GTAAPP34 TM    SANAMIND,SANAMILN   TEST LAST NAME PRESENT                       
         JZ    GTAAPP16                                                         
         LLC   RF,SANAMELN                                                      
         CHI   RF,58               TEST > MAX LENGTH                            
         JNH   *+8                                                              
         LA    RF,58               SET IT IF GREATER                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   EA_LNAM(0),SANAME                                                
         EX    RF,0(RE)                                                         
         J     GTAAPP16                                                         
                                                                                
GTAAPP40 GOTOR LP_APUTO,LP_D       download main data                           
GTAAPP42 MVC   IOKEY(SAPEDEF-SAPEREC),0(R2)                                     
         LA    R2,IOKEY                                                         
         SR    R1,R1                                                            
         IC    R1,SAPEPID+7                                                     
         AHI   R1,1                                                             
         STC   R1,SAPEPID+7                                                     
         J     GTAAPP08                                                         
                                                                                
GTAAPP50 CLI   RQ_EAAPL,RQ_EAESC                                                
         JE    GTAAPP70                                                         
         CLI   RQ_EAAPL,RQ_EAESI                                                
         JE    GTAAPP70                                                         
         LA    R6,APLTAB           R6=A(Application table)                      
GTAAPP52 CLI   0(R6),X'FF'                                                      
         JE    GTAAPP90                                                         
         CLC   RQ_EAAPL,0(R6)      Does table entry match application           
         JE    GTAAPP54            Yes                                          
         LA    R6,APLTABL(R6)                                                   
         J     GTAAPP52                                                         
                                                                                
GTAAPP54 CLI   L'APPPCAT(R6),0     Do we have a value for the passive           
         JE    GTAAPP80            category we want to search on                
AP       USING APPPASD,IOKEY                                                    
GTAAPP56 XC    AP.APPPAS,AP.APPPAS Build passive key                            
         MVI   AP.APPPTYP,APPPTYPQ                                              
         MVI   AP.APPPSUB,APPPSUBQ                                              
         MVC   AP.APPPCPY,CUXCPY                                                
         MVC   AP.APPPCAT,L'APPPCAT(R6)                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     GTAAPP60                                                         
                                                                                
GTAAPP58 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
GTAAPP60 CLC   AP.APPPAS(APPPVAL-APPPASD),IOKEYSAV                              
         JNE   GTAAPP66                                                         
         LAY   R3,GENAREA                                                       
GTAAPP62 OC    0(L'APPPPIDB,R3),0(R3)                                           
         JZ    GTAAPP64                                                         
         CLC   AP.APPPPIDB,0(R3)                                                
         JE    GTAAPP58                                                         
         LA    R3,L'APPPPIDB(R3)                                                
         J     GTAAPP62                                                         
*                                                                               
GTAAPP64 CLC   HALF2,AP.APPPPIDB   avolid dupes (against 'previous')            
         JE    GTAAPP58                                                         
         MVC   0(L'APPPPIDB,R3),AP.APPPPIDB                                     
         J     GTAAPP58                                                         
         DROP  AP                                                               
                                                                                
GTAAPP66 LA    R6,L'APPPCAT(R6)                                                 
         J     GTAAPP54                                                         
                                                                                
SJ       USING JOBPASD,IOKEY                                                    
GTAAPP70 XC    SJ.JOBPAS,SJ.JOBPAS                                              
         MVI   SJ.JOBPTYP,JOBPTYPQ                                              
         MVI   SJ.JOBPSUB,JOBPSUBQ                                              
         MVC   SJ.JOBPCPY,CUXCPY                                                
         MVI   SJ.JOBPAPPL,JOBPAEST                                             
         CLI   RQ_EAAPL,RQ_EAESI                                                
         JNE   *+8                                                              
         MVI   SJ.JOBPAPPL,JOBPAESI                                             
         MVI   SJ.JOBPVIEW,JOBPVOFF                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     GTAAPP74                                                         
                                                                                
GTAAPP72 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
GTAAPP74 CLC   SJ.JOBPAS(JOBPCODE-JOBPASD),IOKEYSAV                             
         JNE   GTAAPP80                                                         
         LAY   R3,GENAREA                                                       
GTAAPP76 OC    0(L'JOBPPIDB,R3),0(R3)                                           
         JZ    GTAAPP78                                                         
         CLC   SJ.JOBPPIDB,0(R3)                                                
         JE    GTAAPP72                                                         
         LA    R3,L'JOBPPIDB(R3)                                                
         J     GTAAPP76                                                         
*                                                                               
GTAAPP78 CLC   HALF2,SJ.JOBPPIDB   avolid dupes (against 'previous')            
         JE    GTAAPP72                                                         
         MVC   0(L'JOBPPIDB,R3),SJ.JOBPPIDB                                     
         J     GTAAPP72                                                         
         DROP  SJ                                                               
                                                                                
GTAAPP80 LAY   R3,GENAREA                                                       
GTAAPP82 OC    0(L'JOBPPIDB,R3),0(R3)  Do we have any PIDs                      
         JZ    GTAAPP90            No                                           
         MVI   BYTE1,YESQ          Yes                                          
         MVC   TEMP2(L'JOBPPIDB),0(R3)    Get PID info                          
         MVC   EA_BPID,0(R3)                                                    
         GOTOR (#GETPID,AGETPID)                                                
         MVC   EA_CODE,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   GTAAPP88                                                         
         L     R2,AIO1                                                          
         LA    RF,SAPEDATA-SAPEREC(R2)                                          
*                                                                               
         USING SAPERD,RF                                                        
         XR    R0,R0                                                            
GTAAPP84 CLI   SAPEREL,0           Check if user terminated                     
         JE    *+2                                                              
         CLI   SAPEREL,SAPERELQ                                                 
         JE    GTAAPP86                                                         
         IC    R0,SAPERLN          L'ELEMENT                                    
         AR    RF,R0                                                            
         J     GTAAPP84                                                         
*                                                                               
GTAAPP86 OC    SAPERDTE,SAPERDTE   Are they terminated?                         
         JZ    GTAAPP87                                                         
         CLC   SAPERDTE,XL#TODC    Check whether terminated in the              
         JNH   GTAAPP88                      future                             
         DROP  RF                                                               
*                                                                               
GTAAPP87 MVC   EA_FNAM,TEMP2                                                    
         MVC   EA_MNAM,TEMP2+32                                                 
         MVC   EA_LNAM,WORK2                                                    
         MVI   EA_IDEF,NOQ                                                      
                                                                                
         GOTOR LP_APUTO,LP_D                                                    
*                                                                               
GTAAPP88 LA    R3,L'JOBPPIDB(R3)   Get next entry from table                    
         J     GTAAPP82                                                         
                                                                                
GTAAPP90 CLI   BYTE1,YESQ          anything done?                               
         JNE   GTAAPPN                                                          
                                                                                
GTAAPPY  J     EXITY                                                            
                                                                                
GTAAPPN  J     EXITN                                                            
                                                                                
         DROP  R1,R2,R3                                                         
                                                                                
***********************************************************************         
* Set NIC and TVR dates                                               *         
***********************************************************************         
                                                                                
SETDTS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SETDTS*'                                                      
                                                                                
         XC    X#NICST,X#NICST                                                  
         XC    X#NICEN,FFS                                                      
         XC    X#TVRST,X#TVRST                                                  
         XC    X#TVREN,FFS                                                      
                                                                                
*&&UK                                                                           
         CLI   CUCTRY,CTRYDFL                                                   
         JE    SETDTS05                                                         
*&&                                                                             
         CLI   CUCTRY,CTRYGBR                                                   
         JNE   SETDTSX                                                          
                                                                                
         USING GFEED,R2                                                         
SETDTS05 DS    0H                                                               
         LA    R2,IOKEY                                                         
         XC    GFKEY,GFKEY                                                      
         MVI   GFKMIN,GFKMINQ                                                   
         MVI   GFKREC,GFKTVRQ                                                   
         MVI   GFKCSEQ,AGREEM1Q                                                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOGND+IO1'                               
         JNE   SETDTS20                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGNF+IO1'                              
         JNE   SETDTS20                                                         
                                                                                
         USING GRECD,R2                                                         
         L     R2,AIO1                                                          
         LA    R3,GFIRST(R2)                                                    
         USING GFAGRD,R3                                                        
SETDTS10 CLI   GFAGREL,0                                                        
         JE    SETDTS20                                                         
         CLI   GFAGREL,GFAGRELQ                                                 
         JE    SETDTS15                                                         
         LLC   R1,GFAGRELL                                                      
         AR    R3,R1                                                            
         J     SETDTS10                                                         
                                                                                
SETDTS15 MVC   X#TVREN,GFAGRTOD                                                 
         MVC   X#TVRST,=X'911101'                                               
                                                                                
SETDTS20 MVC   FULL1,XL#TODP                                                    
                                                                                
         CLC   FULL1+1(2),=X'0405' all depends on tax year                      
         JH    SETDTS25                                                         
                                                                                
         GOTO1 VDATCON,DMCB,(1,FULL1),(0,WORK)                                  
         GOTO1 VADDAY,DMCB,(C'Y',WORK),WORK+6,F'-1'                             
         GOTO1 VDATCON,DMCB,(0,WORK+6),(1,FULL1)                                
                                                                                
SETDTS25 MVC   X#NICST+1(2),=X'0405'                                            
         MVC   X#NICST(1),FULL1                                                 
                                                                                
         GOTO1 VDATCON,DMCB,(1,FULL1),(0,WORK)                                  
         GOTO1 VADDAY,DMCB,(C'Y',WORK),WORK+6,F'1'                              
         GOTO1 VDATCON,DMCB,(0,WORK+6),(1,FULL1)                                
                                                                                
         MVC   X#NICEN+1(2),=X'0404'                                            
         MVC   X#NICEN(1),FULL1                                                 
                                                                                
SETDTSX  J     EXITY                                                            
AGREEM1Q EQU   1                                                                
         DROP  R2,R3                                                            
                                                                                
***********************************************************************         
* Set flag whether user is approver                                   *         
***********************************************************************         
                                                                                
SETAPP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SETAPP*'                                                      
                                                                                
         STC   R1,BYTE1            1=List, 0=Display                            
                                                                                
         MVI   X#ISUAPP,0                                                       
                                                                                
         USING APPRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    APPKEY,APPKEY                                                    
         MVI   APPKTYP,APPKTYPQ                                                 
         MVI   APPKSUB,APPKSUBQ                                                 
         MVC   APPKCPY,CUXCPY                                                   
         MVC   APPKPIDB,CCTPID                                                  
         MVC   CSVKEY1,IOKEY                                                    
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   SETAPPX                                                          
                                                                                
         TM    APPKSTA2,APPSESTQ+APPSESIQ                                       
         JZ    SETAPP10                                                         
         TM    APPKSTA2,APPSESTQ                                                
         JZ    SETAPP00                                                         
         OI    X#ISUAPP,X#ISESTQ                                                
         TM    G#OFSTA2,OFFSIAEQ   Internal approvals in use?                   
         JZ    SETAPP05                                                         
                                                                                
SETAPP00 TM    APPKSTA2,APPSESIQ                                                
         JZ    SETAPP10                                                         
         OI    X#ISUAPP,X#ISINTQ                                                
         J     SETAPP10                                                         
                                                                                
SETAPP05 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         JNE   *+2                                                              
                                                                                
         CLC   CSVKEY1(APPKSEQ-APPRECD),APPKEY                                  
         JNE   SETAPPX                                                          
                                                                                
SETAPP10 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
                                                                                
         USING LIDELD,R3                                                        
         L     R2,AIO1                                                          
         LA    R3,APPRFST                                                       
                                                                                
SETAPP15 CLI   LIDEL,0                                                          
         JE    SETAPP05                                                         
         CLI   LIDEL,LIDELQ                                                     
         JNE   SETAPP20                                                         
         CLI   LIDTYPE,LIDTAPSJ                                                 
         JE    SETAPP25                                                         
SETAPP20 LLC   RE,LIDLN                                                         
         AR    R3,RE                                                            
         J     SETAPP15            Get next                                     
                                                                                
SETAPP25 LLC   RE,LIDLN            save CPJ entries                             
         CLI   LIDLN,LIDDATA-LIDELD                                             
         JNH   SETAPP20            no contents                                  
         LA    RE,LIDELD(RE)                                                    
         LA    R1,LIDDATA                                                       
                                                                                
SETAPP30 CR    R1,RE               end of element?                              
         JNL   SETAPP20                                                         
         TM    0(R1),LIDAESTY+LIDAESTD  check they est approver                 
         JZ    SETAPP35                                                         
         OI    X#ISUAPP,X#ISESTQ                                                
                                                                                
SETAPP35 TM    1(R1),LIDAESID+LIDAESI   check they est internal appr.           
         JZ    SETAPP40                                                         
         OI    X#ISUAPP,X#ISINTQ                                                
                                                                                
SETAPP40 AHI   R1,LIDSJLNQ                                                      
         J     SETAPP30                                                         
                                                                                
SETAPPX  J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* Download XData (pseudo embedded)                                    *         
***********************************************************************         
                                                                                
DOXDATA  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*DOXDATA'                                                      
                                                                                
         XR    RF,RF               Now mimic A#XDFA call under Aura             
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   DOXDATAX                                                         
                                                                                
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         USING XDFRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    XDFKEY,XDFKEY                                                    
         MVI   XDFKTYP,XDFKTYPQ                                                 
         MVI   XDFKSUB,XDFKSUBQ                                                 
         MVC   XDFKCPY,CUXCPY                                                   
         MVC   CSVKEY1,XDFKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JNE   *+2                                                              
         J     DOXDA04                                                          
                                                                                
DOXDA02  LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
DOXDA04  CLC   CSVKEY1(XDFKREM-XDFRECD),XDFKEY                                  
         JNE   DOXDATAX                                                         
                                                                                
         OC    XDFKOFF,XDFKOFF                                                  
         JNZ   DOXDA06                                                          
         OC    XDFKCLI(XDFKSEQ-XDFKCLI),XDFKCLI                                 
         JNZ   DOXDA06                                                          
         CLI   XDFKORTY,XDFKDFT    Always show it if it is top level            
         JE    DOXDA16                                                          
         CLI   XDFKORTY,XDFKTYES   or top application level                     
         JE    DOXDA16                                                          
         J     DOXDA02             Otherwise - get next record                  
                                                                                
DOXDA06  CLI   XDFKORTY,XDFKDFT    Default order type ?                         
         JE    DOXDA08                                                          
         CLI   XDFKORTY,XDFKTYES                                                
         JNE   DOXDA02             No - get the next one                        
                                                                                
DOXDA08  OC    XDFKOFF,XDFKOFF                                                  
         JZ    DOXDA10                                                          
         CLC   XDFKOFF,X#SJOFF                                                  
         JNE   DOXDA02                                                          
                                                                                
DOXDA10  OC    XDFKCLI,XDFKCLI                                                  
         JZ    DOXDA12                                                          
         CLC   XDFKCLI,X#CLIC                                                   
         JNE   DOXDA02                                                          
                                                                                
DOXDA12  OC    XDFKETY,XDFKETY                                                  
         JNZ   DOXDA02                                                          
         OC    XDFKWC,XDFKWC                                                    
         JNZ   DOXDA02                                                          
                                                                                
         OC    XDFKMED,XDFKMED                                                  
         JZ    DOXDA14                                                          
         CLC   XDFKMED,X#MEDC                                                   
         JNE   DOXDA02             Get next XData record                        
                                                                                
DOXDA14  OC    XDFKSCH,XDFKSCH                                                  
         JZ    DOXDA16                                                          
         CLC   XDFKSCH,X#SCHC                                                   
         JNE   DOXDA02             Get next XData record                        
                                                                                
DOXDA16  MVC   CSVKEY2,XDFKEY                                                   
         L     R2,AIO2             take this record                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING XDFELD,R3                                                        
         LA    R3,XDFRFST                                                       
                                                                                
DOXDA18  CLI   XDFEL,XDFELQ                                                     
         JE    DOXDA22                                                          
         CLI   XDFEL,0                                                          
         JE    DOXDA60                                                          
                                                                                
DOXDA20  LLC   R0,XDFLN                                                         
         AR    R3,R0                                                            
         J     DOXDA18                                                          
                                                                                
DOXDA22  XC    XD_VALS(XD_VALQ),XD_VALS  Set return data                        
                                                                                
         MVC   XD_PTRS,XDFRPTR                                                  
         MVC   XD_PTRS+L'XDFRPTR(L'XDFSEQ),XDFSEQ                               
         MVC   XD_CODE,XDFCODE                                                  
         MVC   XD_EDIT,XDFEDIT                                                  
         MVC   XD_MXLN,XDFMXLN                                                  
         TM    XDFSTAT1,XDFSRECP                                                
         JZ    DOXDA24                                                          
         MVI   XD_REQD,C'X'                                                     
         J     DOXDA26                                                          
DOXDA24  MVI   XD_REQD,C'N'                                                     
         TM    XDFSTAT1,XDFSREQD                                                
         JZ    DOXDA26                                                          
         MVI   XD_REQD,C'R'                                                     
DOXDA26  MVI   XD_ACTV,C'A'                                                     
         OC    XDFCUT,XDFCUT                                                    
         JZ    DOXDA28                                                          
         CLC   XDFCUT,XL#TODP                                                   
         JH    DOXDA28                                                          
         MVI   XD_ACTV,C'N'                                                     
DOXDA28  LLC   R1,XDFLN                                                         
         SHI   R1,XDFNAME-XDFELD                                                
         CHI   R1,0                                                             
         JNH   DOXDA32                                                          
         CHI   R1,L'XD_NAME                                                     
         JNH   DOXDA30                                                          
         LHI   R1,L'XD_NAME                                                     
DOXDA30  SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   XD_NAME(0),XDFNAME                                               
         EX    R1,0(RE)                                                         
                                                                                
DOXDA32  GOTOR LP_APUTO,LP_D       return XDF data from element                 
         CLI   XDFEDIT,XDFEDXQ     Is it a dropdown list                        
         JNE   DOXDA20             No - get next element                        
                                                                                
         ST    R3,X#XDFEA          Save current xdata element                   
                                                                                
         USING XDLRECD,R4                                                       
         LA    R4,IOKEY            now look for list values                     
         XC    XDLKEY,XDLKEY                                                    
         MVI   XDLKTYP,XDLKTYPQ                                                 
         MVI   XDLKSUB,XDLKSUBQ                                                 
         MVC   XDLKCPY,CUXCPY                                                   
         MVC   XDLKOFF,XDFKOFF                                                  
         MVC   XDLKORTY,XDFKORTY                                                
         MVC   XDLKCLI,XDFKCLI                                                  
         MVC   XDLKMED,XDFKMED                                                  
         MVC   XDLKSCH,XDFKSCH                                                  
         MVC   XDLKCODE,XDFCODE                                                 
         DROP  R3                                                               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   DOXDA50                                                          
         L     R4,AIO1             take this record                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
                                                                                
         USING XDFELD,R3                                                        
         LA    R3,XDLRFST                                                       
                                                                                
DOXDA34  CLI   XDFEL,XDFELQ                                                     
         JE    DOXDA38                                                          
         CLI   XDFEL,0                                                          
         JE    DOXDA50                                                          
                                                                                
DOXDA36  LLC   R0,XDFLN                                                         
         AR    R3,R0                                                            
         J     DOXDA34                                                          
                                                                                
****A38  XC    XD_LIST(XD_LISTQ),XD_LIST   Set return data                      
DOXDA38  XC    XD_VALS(XD_VALQ),XD_VALS  Set return data                        
                                                                                
         OC    XDFLCDAT,XDFLCDAT                                                
         JZ    DOXDA40                                                          
         CLC   XDFLCDAT,XL#TODC                                                 
         JL    DOXDA42                                                          
DOXDA40  TM    XDFLSTAT,XDFLDFT                                                 
         JZ    DOXDA42                                                          
         MVI   XD_STAT,C'Y'                                                     
DOXDA42  LLC   R1,XDFLN                                                         
         SHI   R1,XDFLDATA-XDFELD                                               
         CHI   R1,0                                                             
         JNH   DOXDA46                                                          
         CHI   R1,L'XD_LDAT                                                     
         JNH   DOXDA44                                                          
         LHI   R1,L'XD_LDAT                                                     
DOXDA44  SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   XD_LDAT(0),XDFLDATA                                              
         EX    R1,0(RE)                                                         
DOXDA46  MVI   XD_ACTL,C'A'                                                     
         OC    XDFLCDAT,XDFLCDAT                                                
         JZ    DOXDA48                                                          
         CLC   XDFLCDAT,XL#TODC                                                 
         JNL   DOXDA48                                                          
         MVI   XD_ACTL,C'N'                                                     
                                                                                
DOXDA48  GOTOR LP_APUTO,LP_D       return XDL/XDF data from element             
         J     DOXDA36             and go for next                              
         DROP  R3                                                               
                                                                                
DOXDA50  L     R3,X#XDFEA                                                       
         J     DOXDA20             process next XDF record XDFEL                
                                                                                
DOXDA60  LA    R2,IOKEY            reread XDF key for sequential IOs            
         MVC   XDFKEY,CSVKEY2                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
         J     DOXDA02             process next XDF record                      
         DROP  R2,R4                                                            
                                                                                
DOXDATAX J     EXIT                                                             
                                                                                
***********************************************************************         
* Download work code list (pseudo embedded)                           *         
***********************************************************************         
                                                                                
WCOLIS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*WCOLIS*'                                                      
                                                                                
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         USING GOBLOCKD,RF                                                      
         L     RF,AGOBLOCB                                                      
         L     RE,ATWA                                                          
         LA    RE,2304+FALINKDL(RE)                                             
         ST    RE,GOABUFF          A(AFTER FALINK BLOCK)                        
         L     RE,=AL4(TWAMAXRL-(FALINKDL+2304))   MAX L'TWA                    
         ST    RE,GOLBUFF                                                       
         TM    LP_FLAG,LP_FOFFL                                                 
         JNZ   *+16                 OFFLINE                                     
         MVC   GOABUFF,ATIA         USE TIA ONLINE                              
         MVC   GOLBUFF,=AL4(TWAMAXRL)   SHOULD BE OK, TIA IS 14K?               
         DROP  RF                                                               
                                                                                
         LA    R1,IOKEY                                                         
         USING WCORECD,R1                                                       
         MVC   WCOKEY,SPACES                                                    
         MVI   WCOKTYP,WCOKTYPQ                                                 
         MVC   WCOKCPY,CUXCPY                                                   
         MVC   WCOKUNT(2),CPYPROD                                               
         MVC   WCOKWRK,=C'AA'                                                   
         MVC   CSVKEY1(WCOKWRK-WCORECD),WCOKEY                                  
         LHI   R1,IOHI+IODIR+IO1                                                
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    WCOL16                                                           
         DC    H'0'                                                             
*                                                                               
WCOL14   GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JNE   *+2                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         JNE   *+2                                                              
                                                                                
WCOL16   LA    R1,IOKEY                                                         
         CLC   CSVKEY1(WCOKWRK-WCORECD),WCOKEY                                  
         JNE   WCOLISX                                                          
         CLC   WCOKWRK,=C'98'                                                   
         JH    WCOLISX                                                          
                                                                                
WCOL20   GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
                                                                                
         XC    WL_VALS(WL_VALQ),WL_VALS                                         
         L     R1,AIO1                                                          
         LA    R2,WCORFST                                                       
         USING WCOELD,R2                                                        
WCOL22   CLI   WCOEL,0                                                          
         JE    WCOL56                                                           
         CLI   WCOEL,WCOELQ                                                     
         JE    WCOL30                                                           
         CLI   WCOEL,XNMELQ                                                     
         JE    WCOL40                                                           
WCOL26   LLC   R0,WCOLN                                                         
         AR    R2,R0                                                            
         J     WCOL22                                                           
*                                                                               
WCOL30   TM    WCOSTAT2,WCOSLEST   Locked from estimates                        
         JNZ   WCOL14              Yes - skip work code                         
         MVC   WL_WC,WCOKWRK       - Pass work code                             
         MVC   WL_DESC,WCODESC     - Pass work code description                 
         MVC   WL_GRP,WCOGRP       - Pass work code group                       
         MVC   WL_STAT,SPACES      - Pass work code status block                
         MVI   WL_STAT,C'C'          cost                                       
         TM    WCOSTAT,WCOSHCOE                                                 
         JZ    *+8                                                              
         MVI   WL_STAT,C'T'          time                                       
*&&US                                                                           
         CLI   WCOTYPE,C'T'          In US check type                           
         JNE   *+8                                                              
         MVI   WL_STAT,C'T'          time                                       
*&&                                                                             
         MVI   WL_ART,NOQ                                                       
         TM    WCOSTAT2,WCOSART    - Pass artist flag                           
         JZ    *+8                                                              
         MVI   WL_ART,YESQ                                                      
         MVI   WL_EST,YESQ                                                      
*&&UK                                                                           
         TM    WCOSTAT3,WCOSESCK   - Estimate check required?                   
         JZ    *+8                                                              
         MVI   WL_EST,NOQ                                                       
*&&                                                                             
         J     WCOL26                                                           
*                                                                               
         USING XNMELD,R2                                                        
WCOL40   XR    RE,RE                                                            
         IC    RE,XNMSUBL                                                       
         SHI   RE,2                                                             
         LTR   RE,RE                                                            
         JM    WCOL26                                                           
         CHI   RE,L'WL_FDES-1                                                   
         JNH   *+8                                                              
         LHI   RE,L'WL_FDES-1                                                   
         BASR  RF,0                                                             
         MVC   WL_FDES(0),XNMSUBN                                               
         EX    RE,0(RF)                                                         
         J     WCOL26                                                           
*                                                                               
         USING GOBLOCKD,R3                                                      
WCOL56   L     R3,AGOBLOCB                                                      
*                                                                               
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
*                                                                               
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOAEXT,AGOXBLCK     US USES 1ST EXTENSION BLOCK                  
         MVC   GOABEXT,AGOBBLCK    UK USES 2ND EXTENSION BLOCK                  
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(2),PRODUL                                             
         MVC   GOSELCLI,X#CLIC                                                  
         MVC   GOSELPRO,X#PROC                                                  
         MVC   GOSELJOB,X#JOBC                                                  
         MVC   GOSELWC,WL_WC                                                    
         MVI   GOANYWC,YESQ                                                     
         MVC   GOCTRY,CUCTRY                                                    
         L     RF,ACOMFACS                                                      
                                                                                
         XC    GOACOVL,GOACOVL                                                  
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         JZ    *+10                                                             
         MVC   GOACOVL,VCOVAIL                                                  
         MVC   GOABINSR,CBINSRCH-COMFACSD(RF)                                   
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
         ZAP   WL_COMM,GOAGYCOM                                                 
*&&UK                                                                           
         MVC   WL_VATC,GOTAXCOD                                                 
                                                                                
         USING VTCD,R2                                                          
         LA    R2,ELEMENT          build VATICAN call block                     
         XC    VTCD(VTCLNQ),VTCD                                                
         MVI   VTCACTN,VTCALOOK                                                 
         MVC   VTCCPY,CUXCPY                                                    
         MVC   VTCOFFC,X#SJOFF                                                  
         MVC   VTCCOMF,ACOMFACS                                                 
         MVC   VTCINVD,XL#TODP                                                  
         MVC   VTCTYPE,WL_VATC                                                  
         MVC   VTCCPYS1,CPYSTAT1                                                
         MVC   VTCSGOPO,X#SGOPOS                                                
         GOTO1 VATICAN,VTCD                                                     
         JNE   WCOL58                                                           
         MVC   WL_VATN,SPACES                                                   
         MVC   WL_VATN(10),VTCTTYPE                                             
         CURED (B2,VTCRATE),(L'WL_VATR,WL_VATR),0,ZERO=YES,ALIGN=LEFT           
         DROP  R2                                                               
*&&                                                                             
                                                                                
         USING GOXBLKD,R3                                                       
WCOL58   L     R3,AGOXBLCK                                                      
         MVC   WL_CCW,GOCCW                                                     
         MVC   WL_WCF,GOWCF                                                     
         DROP  R3                                                               
*                                                                               
WCOL62   GOTOR LP_APUTO,LP_D       send data for this work code                 
         J     WCOL14                                                           
*                                                                               
WCOLISX  J     EXITY                                                            
                                                                                
***********************************************************************         
* Put data to TSAR for estimate merge                                 *         
***********************************************************************         
                                                                                
PUTSAR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PUTSAR*'                                                      
                                                                                
         LR    R3,R1               point to data element                        
                                                                                
         ICM   RF,15,X#TINUM                                                    
         AHI   RF,1                                                             
         STCM  RF,15,X#TINUM                                                    
                                                                                
         USING ZTSARECD,R2                                                      
         L     R2,AIO1             IO1 used for TSAR (clear it)                 
         LR    R0,R2                                                            
         LHI   R1,IOLENQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         LTR   R3,R3               called from XCOLSBS                          
         JNZ   PUTSAR0                                                          
         XR    R1,R1                                                            
         AHI   R1,L'X#CWIAOH+L'X#CWIANC                                         
         J     PUTSAR1                                                          
                                                                                
PUTSAR0  CLI   0(R3),0             ensure good element                          
         JE    *+2                                                              
         CLI   1(R3),0                                                          
         JE    *+2                                                              
                                                                                
         LLC   R1,1(R3)            determine length                             
         LR    RF,R1                                                            
PUTSAR1  AHI   R1,ZTRKEYL                                                       
         AHI   R1,L'ZTRLEN                                                      
         STCM  R1,3,ZTRLEN         and set it                                   
                                                                                
         MVC   ZTRKSEQ,X#TINUM     set sequence number                          
                                                                                
                                                                                
         LTR   R3,R3               called from XCOLSBS                          
         JNZ   PUTSAR2                                                          
         ZAP   ZTRDAOH,X#CWIAOH                                                 
         ZAP   ZTRDANC,X#CWIANC                                                 
         J     PUTSAR8                                                          
                                                                                
PUTSAR2  SHI   RF,1                pass element as data                         
         BASR  RE,0                                                             
         MVC   ZTRDELM(0),0(R3)                                                 
         EX    RF,0(RE)                                                         
                                                                                
         TM    X#MRGIND,X#MRGIGQ                                                
         JZ    PUTSAR8                                                          
         MVI   ZTRDGYN,C'Y'                                                     
         NI    X#MRGIND,FF-X#MRGIGQ                                             
                                                                                
PUTSAR8  MVC   ZTRKSRT,X#MSRTV     set SORT values                              
         CLI   X#DDS,FF            DDS investigation mode                       
         JNE   PUTSAR12                                                         
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   ED_EMSRT,ZTRKEY                                                  
         LTR   R3,R3               called by XCOLSBS                            
         JZ    PUTSAR10                                                         
         LA    R1,IOKEY                                                         
         MVC   ED_MLONO,ESTKLNO-ESTRECD(R1)                                     
PUTSAR10 GOTOR LP_APUTO,LP_D                                                    
                                                                                
PUTSAR12 GOTOR (#MTSAR,AMTSAR),DMCB,TSAADD,TSAREBUF,                   +        
               X#TSAR                                                           
         CLI   TSARERRS,0          sets condition code                          
                                                                                
PUTSARX  J     EXIT                                                             
                                                                                
***********************************************************************         
* Validate module for estimate display                                *         
***********************************************************************         
                                                                                
EDMVAL   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*EDMVAL*'                                                      
                                                                                
         MVC   X#SJOFF,SPACES                                                   
                                                                                
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   EDMVAL06                                                         
         CLC   RQ_EDEST,SPACES     Display via global or local number           
         JH    EDMVAL10                                                         
         CLC   RQ_EDCPJ,SPACES                                                  
         JNH   EDMVAL06                                                         
                                                                                
         USING ESTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    ESTKEY,ESTKEY                                                    
         MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CUXCPY                                                   
*&&UK*&& MVC   ESTKSJ,SPACES                                                    
*&&US*&& XC    ESTKSJ,ESTKSJ                                                    
         LLC   R1,PCLILEN                                                       
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   ESTKCLI(0),RQ_EDCPJ                                              
         EX    R1,0(RE)                                                         
         LA    RF,RQ_EDCPJ+1(R1)                                                
         LLC   R1,PPROLEN                                                       
         LLC   R0,PCLILEN                                                       
         SR    R1,R0                                                            
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   ESTKPRO(0),0(RF)                                                 
         EX    R1,0(RE)                                                         
         AR    RF,R1                                                            
         AHI   RF,1                                                             
         LLC   R1,PJOBLEN                                                       
         LLC   R0,PPROLEN                                                       
         SR    R1,R0                                                            
         CHI   R1,L'ESTKJOB                                                     
         JNH   EDMVAL02                                                         
         LHI   R1,L'ESTKJOB                                                     
EDMVAL02 SHI   R1,0                                                             
         BASR  RE,0                                                             
         MVC   ESTKJOB(0),0(RF)                                                 
         EX    R1,0(RE)                                                         
         MVC   ESTKLNO,RQ_EDLNO                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   EDMVAL12                                                         
         USING OFFALD,R3                                                        
         L     R3,AOFFAREA                                                      
         MVC   OFFAOFFC,ESTKSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL,OFFALD       validate office                              
         JE    EDMVAL04                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EDMVALN                                                          
         DROP  R3                                                               
                                                                                
EDMVAL04 MVC   X#SJOFF,ESTKSOFF                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
         USING EMDELD,R3                                                        
         L     R2,AIO2                                                          
         LA    R3,ESTRFST                                                       
         CLI   EMDEL,EMDELQ                                                     
         JNE   *+2                                                              
         MVC   RQ_EDEST,EMDGNO                                                  
         J     EDMVAL20                                                         
         DROP  R2                                                               
                                                                                
         USING EGNPASD,R2                                                       
EDMVAL06 CLC   RQ_EDEST,SPACES                                                  
         JH    EDMVAL10                                                         
                                                                                
EDMVAL08 MVC   ROUERRV,=AL2(AE$ENONS)                                           
         J     EDMVALN                                                          
                                                                                
EDMVAL10 LA    R2,IOKEY            read for global estimate number              
         XC    EGNPAS,EGNPAS                                                    
         MVI   EGNPTYP,EGNPTYPQ                                                 
         MVI   EGNPSUB,EGNPSUBQ                                                 
         MVC   EGNPCPY,CUXCPY                                                   
         MVC   EGNPNUM,RQ_EDEST                                                 
                                                                                
         MVC   CSVKEY1,EGNPAS      save key                                     
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
         CLC   CSVKEY1(EGNPCLI-EGNPASD),EGNPAS     does record exist?           
         JE    EDMVAL14                                                         
                                                                                
EDMVAL12 MVC   ROUERRV,=AL2(AE$ESTNE)                                           
         J     EDMVALN                                                          
                                                                                
EDMVAL14 CLC   EGNPSOFF,SPACES     validate limit access                        
         JNH   EDMVAL16                                                         
         MVC   X#SJOFF,EGNPSOFF                                                 
                                                                                
         USING OFFALD,R3                                                        
         L     R3,AOFFAREA                                                      
         MVC   OFFAOFFC,EGNPSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL,OFFALD       validate office                              
         JE    EDMVAL16                                                         
         DROP  R3                                                               
                                                                                
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EDMVALN                                                          
                                                                                
EDMVAL16 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
EDMVAL20 L     R2,AIO2                                                          
         MVC   CSVKEY1,0(R2)       save main record key                         
                                                                                
EDMVALY  J     EXITY                                                            
                                                                                
EDMVALN  J     EXITN                                                            
                                                                                
         DROP  R2                                                               
***********************************************************************         
* Aura MVP version checks                                             *         
***********************************************************************         
AURAMVP  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AURAMVP'                                                      
                                                                                
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   AMVPYES                                                          
         CLI   RQ_EDPDF,YESQ       Skip checks for PDF request                  
         JE    AMVPYES                                                          
                                                                                
AMVP1    CHI   R1,1                                                             
         JNE   AMVP2                                                            
                                                                                
         USING ESTRECD,R2                                                       
         L     R2,AIO2                                                          
         CLI   ESTKJOB,ESTKBPQ     If ballpark don't show in aura               
         JNE   AMVPYES                                                          
         MVC   ROUERRV,=AL2(AE$CVBPE)  error message                            
         J     AMVPNO                                                           
         DROP  R2                                                               
                                                                                
AMVP2    CHI   R1,2                                                             
         JNE   *+2                                                              
                                                                                
         USING ERDELD,R3                                                        
         CLI   ERDTYP,ERDTIDQ      Items/Articles                               
         JNE   AMVPYES                                                          
         MVC   ROUERRV,=AL2(AE$UCVEI)                                           
         TM    ERDIIND,ERDIITQ          Don't show time items in Aura           
         JNZ   AMVPNO                                                           
         MVC   ROUERRV,=AL2(AE$VESNP)                                           
         TM    ERDIIND,ERDIIPQ          Don't show items with no price          
         JNZ   AMVPNO                                      in Aura              
         DROP  R3                                                               
                                                                                
AMVPYES  XC    ROUERRV,ROUERRV                                                  
         J     EXITY                                                            
                                                                                
AMVPNO   J     EXITN                                                            
                                                                                
***********************************************************************         
* Return module for estimate display data from main record            *         
***********************************************************************         
EDMRGD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*EDMRGD*'                                                      
                                                                                
         USING ESTRECD,R2                                                       
         USING EMDELD,R3                                                        
         L     R2,AIO2                                                          
         LA    R3,ESTRFST                                                       
                                                                                
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         CLI   EMDEL,EMDELQ                                                     
         JNE   *+2                                                              
                                                                                
         MVI   ED_RTYPE,ED_RTMLQ   set main values                              
         MVI   ED_MLOCK,NOQ                                                     
         MVC   ED_GAPST,EMDGSTAT   Electronic signature status                  
         XC    X#CURWC,X#CURWC                                                  
                                                                                
         MVI   ED_MSELP,NOQ        suppress empty print lines                   
         MVI   ED_MSELD,NOQ        suppress empty display lines                 
         MVI   ED_PRRAT,YESQ       print rates                                  
         TM    X#DISTYP,X#DISMDQ                                                
         JNZ   EDMRG002                                                         
         TM    EMDSTA,EMDSPQ                                                    
         JZ    *+8                                                              
         MVI   ED_MSELP,YESQ                                                    
         TM    EMDSTA,EMDSDQ                                                    
         JZ    *+8                                                              
         MVI   ED_MSELD,YESQ                                                    
         TM    EMDSTA,EMDSRQ                                                    
         JZ    *+8                                                              
         MVI   ED_PRRAT,NOQ                                                     
                                                                                
EDMRG002 CP    EMDTVR,PZERO        apply lock for TV estimates                  
         JE    EDMRG006                                                         
         CLC   EMDDAT,X#NICST      if outside date ranges                       
         JL    EDMRG004                                                         
         CLC   EMDDAT,X#NICEN                                                   
         JH    EDMRG004                                                         
         CLC   EMDDAT,X#TVRST                                                   
         JL    EDMRG004                                                         
         CLC   EMDDAT,X#TVREN                                                   
         JNH   EDMRG006                                                         
                                                                                
EDMRG004 MVI   ED_MLOCK,YESQ                                                    
                                                                                
EDMRG006 MVI   ED_MLANG,NOQ                                                     
         TM    ESTRSTA2,ESTKLANG                                                
         JZ    *+8                                                              
         MVI   ED_MLANG,YESQ                                                    
                                                                                
         MVI   ED_MWCTM,NOQ                                                     
         TM    ESTRSTA3,ESTSWCTM   Any hours at wc level                        
         JZ    *+8                                                              
         MVI   ED_MWCTM,YESQ       Yes                                          
                                                                                
         MVI   ED_MITTM,NOQ                                                     
         TM    ESTRSTA3,ESTSITTM   Any time at item level                       
         JZ    *+8                                                              
         MVI   ED_MITTM,YESQ       Yes                                          
                                                                                
         MVI   ED_MITMS,NOQ                                                     
         TM    ESTRSTA3,ESTSITMS   Any items                                    
         JZ    *+8                                                              
         MVI   ED_MITMS,YESQ       Yes                                          
                                                                                
EDMRG008 DS    0H                                                               
                                                                                
         MVC   ED_MCLIC,SPACES                                                  
         MVC   ED_MPROC,SPACES                                                  
         MVC   ED_MJOBC,SPACES                                                  
*                                                                               
         LA    RF,TEMP             Temp storage for GETSJN/GETAPP               
         MVC   TEMP,SPACES                                                      
         LA    RE,ESTKCLI          Assume its from the key                      
         TM    X#DISTYP,X#DISCOQ   Copy call?                                   
         JZ    *+8                                                              
         LA    RE,RQ_EDCLI         Else it's from the request                   
         LLC   R1,PCLILEN                                                       
         SHI   R1,1                                                             
         BASR  R4,0                                                             
         MVC   ED_MCLIC(0),0(RE)                                                
         EX    R1,0(R4)                                                         
         BASR  R4,0                                                             
         MVC   0(0,RF),0(RE)                                                    
         EX    R1,0(R4)                                                         
*&&US*&& LA    RE,1(R1,RE)         Bump to next place in key or request         
*&&UK*&& LA    RE,ESTKPRO                                                       
         TM    X#DISTYP,X#DISCOQ   Copy call?                                   
         JZ    *+8                                                              
         LA    RE,RQ_EDPRO         Else it's from the request                   
         LA    RF,1(R1,RF)         Bump to next place in temp storage           
         LLC   R0,PCLILEN                                                       
         LLC   R1,PPROLEN                                                       
         SR    R1,R0                                                            
         SHI   R1,1                                                             
         BASR  R4,0                                                             
         MVC   ED_MPROC(0),0(RE)                                                
         EX    R1,0(R4)                                                         
         BASR  R4,0                                                             
         MVC   0(0,RF),0(RE)                                                    
         EX    R1,0(R4)                                                         
         LA    RF,1(R1,RF)         Bump to next place in temp storage           
         TM    X#DISTYP,X#DISCOQ   Copy call?                                   
         JNZ   *+8                                                              
         AHI   R1,1                If using key-skip an extra byte              
*&&US*&& LA    RE,1(R1,RE)         Bump to next place in key or request         
*&&UK*&& LA    RE,ESTKJOB                                                       
         TM    X#DISTYP,X#DISCOQ   Copy call?                                   
         JZ    *+8                                                              
         LA    RE,RQ_EDJOB         Else it's from the request                   
         LLC   R0,PPROLEN                                                       
         LLC   R1,PJOBLEN                                                       
         SR    R1,R0                                                            
         CHI   R1,L'ESTKJOB                                                     
         JNH   *+8                                                              
         LHI   R1,L'ESTKJOB                                                     
         SHI   R1,1                                                             
         BASR  R4,0                                                             
         MVC   ED_MJOBC(0),0(RE)                                                
         EX    R1,0(R4)                                                         
         BASR  R4,0                                                             
         MVC   0(0,RF),0(RE)                                                    
         EX    R1,0(R4)                                                         
*                                                                               
EDMRG010 MVC   SVSJACT(L'PRODUL),PRODUL save for reading extension key          
         MVC   SVSJACT+L'PRODUL(L'ACTKACT),TEMP                                 
         OC    SVSJACT,SPACES                                                   
         GOTOR GETSJN                                                           
         GOTOR GETOPT              get getopt settings                          
         MVC   ED_MCLIN,X#CLINM                                                 
         MVC   ED_MCLIP,X#CLIPN                                                 
         MVC   ED_MPRON,X#PRONM                                                 
         MVC   ED_MPROP,X#PROPN                                                 
         MVC   ED_MJOBN,X#JOBNM                                                 
         MVI   ED_MORLK,NOQ                                                     
         TM    X#SJLKF,RSTLSORQ    Locked from orders                           
         JZ    *+8                                                              
         MVI   ED_MORLK,YESQ                                                    
         MVI   ED_MTILK,NOQ                                                     
         TM    X#SJLKF,RSTLSTIQ    Locked from timesheets                       
         JZ    *+8                                                              
         MVI   ED_MTILK,YESQ                                                    
         MVC   ED_MJOBS,X#JOBDS                                                 
         MVC   ED_MJOBL,X#JOBDL                                                 
         MVC   ED_MJAD1(5*L'ADRADD1),X#SJAD1                                    
                                                                                
         MVC   X#CLIC,ED_MCLIC                                                  
         MVC   X#PROC,ED_MPROC                                                  
         MVC   X#JOBC,ED_MJOBC                                                  
         MVC   X#MEDC,ED_MJOBC                                                  
                                                                                
         MVI   ED_MCONI,NOQ                                                     
         MVI   ED_MCONC,NOQ                                                     
         GOTOR GETAPP,DMCB,TEMP,ESTRSOFF                                        
         TM    X#BYTE2,X'40'                                                    
         JZ    *+8                                                              
         MVI   ED_MCONI,YESQ      user is valid internal approver               
         TM    X#BYTE2,X'04'                                                    
         JZ    *+8                                                              
         MVI   ED_MCONC,YESQ      user is valid client approver                 
                                                                                
EDMRG012 MVC   ED_MMEDC,X#JOBC                                                  
         MVC   TEMP2,ED_MMEDC                                                   
         GOTOR ESVMED,1              validate media code + get name             
         MVC   ED_MMEDN,X#TEMP                                                  
         XC    ED_MIDNO,ED_MIDNO                                                
         MVC   ED_INTUS,SPACES                                                  
         TM    G#OFSTA2,OFFSIAEQ   Internal approvals in use?                   
         JZ    *+10                                                             
         MVC   ED_INTUS,EMDIUS                                                  
                                                                                
         TM    X#DISTYP,X#DISCOQ+X#DISMDQ   Copy/Merge call?                    
         JNZ   EDMRG022                                                         
         OC    EMDSCA,EMDSCA                                                    
         JZ    EDMRG014                                                         
         MVC   TEMP2(L'EMDSCA),EMDSCA                                           
         GOTOR (#GETPID,AGETPID)                                                
         MVC   ED_MAPPC,TEMP2                                                   
         GOTOR (#GETPIN,AGETPIN)                                                
         MVC   ED_MAPPF,TEMP2+00                                                
         MVC   ED_MAPPL,TEMP2+16                                                
                                                                                
EDMRG014 OC    EMDSIA,EMDSIA                                                    
         JZ    EDMRG016                                                         
         MVC   TEMP2(L'EMDSIA),EMDSIA                                           
         GOTOR (#GETPID,AGETPID)                                                
         MVC   ED_MIAPC,TEMP2                                                   
         GOTOR (#GETPIN,AGETPIN)                                                
         MVC   ED_MIAPF,TEMP2+00                                                
         MVC   ED_MIAPL,TEMP2+16                                                
                                                                                
EDMRG016 OC    EMDAPI,EMDAPI                                                    
         JZ    EDMRG018                                                         
         MVC   TEMP2(L'EMDAPI),EMDAPI                                           
         GOTOR (#GETPID,AGETPID)                                                
         MVC   ED_MRAIC,TEMP2                                                   
         GOTOR (#GETPIN,AGETPIN)                                                
         MVC   ED_MRAIF,TEMP2+00                                                
         MVC   ED_MRAIL,TEMP2+16                                                
         MVC   ED_MRAIE,APPEMAIL                                                
         MVC   ED_MRAIT,TEMP2+52                                                
                                                                                
EDMRG018 MVC   ED_MGLNO,EMDGNO                                                  
         MVC   ED_MLONO,ESTKLNO                                                 
         MVC   ED_MADAT,EMDADT                                                  
         MVC   ED_MEDAT,EMDDAT                                                  
         MVC   ED_MACTY,EMDLDT                                                  
         MVC   ED_MIDNO,EMDIDN                                                  
*&&US*&& GOTOR SETHCO              set HR/CE/OE status                          
         J     EDMRG024                                                         
                                                                                
EDMRG022 MVC   TEMP2(L'EMDAPI),CCTPID                                           
         GOTOR (#GETPID,AGETPID)                                                
         MVC   ED_MRAIC,TEMP2                                                   
         GOTOR (#GETPIN,AGETPIN)                                                
         MVC   ED_MRAIF,TEMP2+00                                                
         MVC   ED_MRAIL,TEMP2+16                                                
                                                                                
EDMRG024 MVC   ED_MCURC,EMDCUR                                                  
         MVC   ED_MACUR,AGYCURR                                                 
         TM    X#DISTYP,X#DISCOQ   Copy call?                                   
         JZ    EDMRG026                                                         
         MVC   ED_MCURC,X#CPCUR                                                 
         OC    X#CPEXB,X#CPEXB                                                  
         JZ    EDMRG026                                                         
         MVC   ED_MEXCH,X#CPEXB                                                 
                                                                                
EDMRG026 MVC   ED_MSCHC,EMDSCH                                                  
         MVC   X#SCHC,EMDSCH                                                    
         ZAP   ED_MTVRT,EMDTVR                                                  
         TM    X#DISTYP,X#DISCOQ                                                
         JZ    EDMRG028                                                         
         XC    X#TEMP,X#TEMP                                                    
         LA    RF,X#TEMP                                                        
         MVC   0(RQ_EDCCC-RQ_EDCLI,RF),RQ_EDCLI                                 
         GOTOR GETOMV                                                           
*&&UK                                                                           
         USING GOBLOCKD,RF                                                      
***      L     RF,AGOBLOCK                                                      
         L     RF,AGOBLOCB                                                      
*&&                                                                             
*&&US                                                                           
         USING GOXBLKD,RF                                                       
         L     RF,AGOXBLCK                                                      
*&&                                                                             
         MVC   ED_MFRMT,GOREPFOR                                                
         DROP  RF                                                               
         J     *+10                                                             
                                                                                
EDMRG028 MVC   ED_MFRMT,EMDFMT                                                  
                                                                                
         MVC   ED_MOFFC,ESTRSOFF                                                
         MVC   X#CUROF,ESTRSOFF                                                 
                                                                                
         CLC   EMDCUR,AGYCURR                                                   
         JE    EDMRG034                                                         
         TM    X#DISTYP,X#DISRVQ   FC revaluation?                              
         JNZ   EDMRG032                                                         
         TM    X#DISTYP,X#DISCOQ                                                
         JZ    EDMRG030                                                         
         OC    X#CPEXB,X#CPEXB                                                  
         JNZ   EDMRG034                                                         
                                                                                
EDMRG030 MVC   ED_MEXCH,EMDRAT                                                  
         J     EDMRG034                                                         
                                                                                
EDMRG032 MVC   ED_MEXCH,X#RVEXB                                                 
                                                                                
EDMRG034 MVI   ED_MSTAT,RQ_ELSCQ                                                
         TM    X#DISTYP,X#DISCOQ+X#DISMDQ   Copy/Merge call?                    
         JNZ   EDMRG044                                                         
         LA    RE,STATAB                                                        
         USING STATABD,RE                                                       
EDMRG036 MVC   BYTE1,ESTRSTA1      Check status byte 1                          
         NC    BYTE1,STASTA1       Any match?                                   
         JZ    EDMRG040            No                                           
         OC    STASTA2,STASTA2     Do we have any status 2 to check             
         JNZ   EDMRG038            Yes                                          
         MVC   BYTE1,ESTRSTA2      No - check we have nothing                   
         NI    BYTE1,ESTKMERG+ESTKSINA                                          
         JZ    EDMRG042            Yes - match                                  
         J     EDMRG040            No - check next status entry in list         
                                                                                
EDMRG038 MVC   BYTE1,ESTRSTA2      Check status byte 2 matches                  
         NC    BYTE1,STASTA2                                                    
         JNZ   EDMRG042            Matches entry                                
EDMRG040 LA    RE,STATABL(RE)      RF=A(next entry of status list)              
         CLI   STACHAR,C'*'        Have we reached end of table                 
         JNE   EDMRG036            No                                           
         DC    H'0'                Yes - die as we should find                  
*                                   something                                   
EDMRG042 MVC   ED_MSTAT,STACHAR                                                 
         XR    R1,R1                                                            
         ICM   R1,B'0011',CUXPNUM  For Aura never set merge                     
         CHI   R1,XPRODIKQ                                                      
         JNE   EDMRG044                                                         
         CLI   ED_MSTAT,RQ_ELSMQ    Merged?                                     
         JNE   EDMRG044                                                         
         MVI   ED_MSTAT,RQ_ELSDQ    No, must be logically deleted               
         DROP  RE                                                               
                                                                                
EDMRG044 MVC   X#MSTAT,ED_MSTAT   Save status                                   
         LLC   R0,EMDLN            process name element                         
         AR    R3,R0                                                            
         LA    R4,ED_GAPEM        R4=A(Gap email list)                          
         USING ENMELD,R3                                                        
         CLI   ENMEL,ENMELQ                                                     
         JNE   EDMRG048                                                         
                                                                                
         TM    X#DISTYP,X#DISMDQ   on merge name only if base set               
         JZ    EDMRG046                                                         
         TM    X#MRGIND,X#MRGIBQ                                                
         JZ    EDMRG048                                                         
                                                                                
EDMRG046 LLC   R1,ENMLN                                                         
         SHI   R1,ENMLNQ+1                                                      
         LTR   R1,R1                                                            
         JM    EDMRG048                                                         
         BASR  RF,0                                                             
         MVC   ED_MNAME(0),ENMNAME                                              
         EX    R1,0(RF)                                                         
                                                                                
EDMRG048 CLI   0(R3),0            Now deal with all other els                   
         JE    EDMRG058                                                         
         CLI   0(R3),GDAELQ                                                     
         JE    EDMRG052                                                         
         CLI   0(R3),FFTELQ                                                     
         JE    EDMRG054                                                         
EDMRG050 LLC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         J     EDMRG048                                                         
                                                                                
         USING GDAELD,R3                                                        
EDMRG052 LA    RF,ED_GAPSD                                                      
         CLI   GDATYPE,GDAGAPST    Read for GAP sent date                       
         JE    EDMRG050                                                         
         LA    RF,ED_GAPED                                                      
         CLI   GDATYPE,GDAGAPEX    Read for GAP expiry date                     
         JNE   EDMRG050                                                         
         MVC   0(L'GDADATE,RF),GDADATE                                          
         J     EDMRG050                                                         
                                                                                
         USING FFTELD,R3                                                        
EDMRG054 DS    0H                  GAP email address                            
*&&UK*&& CLI   FFTTYPE,FFTTPEML                                                 
*&&US*&& CLI   FFTTYPE,FFTTEML                                                  
         JNE   EDMRG050                                                         
*                                                                               
EDMRG056 MVC   0(L'ED_GAPEM,R4),FFTEML1                                         
         AHI   R4,L'ED_GAPEM                                                    
         CLI   FFTLN,FFEM1LL                                                    
         JNH   EDMRG050                                                         
         MVC   0(L'ED_GAPEM,R4),FFTEML2                                         
         AHI   R4,L'ED_GAPEM                                                    
         CLI   FFTLN,FFEM2LL                                                    
         JNH   EDMRG050                                                         
         MVC   0(L'ED_GAPEM,R4),FFTEML3                                         
         AHI   R4,L'ED_GAPEM                                                    
         CLI   FFTLN,FFEM3LL                                                    
         JNH   EDMRG050                                                         
         MVC   0(L'ED_GAPEM,R4),FFTEML4                                         
         AHI   R4,L'ED_GAPEM                                                    
         CLI   FFTLN,FFEM4LL                                                    
         JNH   EDMRG050                                                         
         MVC   0(L'ED_GAPEM,R4),FFTEML5                                         
         AHI   R4,L'ED_GAPEM                                                    
         J     EDMRG050                                                         
*                                                                               
EDMRG058 TM    X#DISTYP,X#DISCOQ+X#DISMDQ   Copy/Merge call?                    
         JZ    EDMRG102                                                         
         GOTOR LP_APUTO,LP_D       download main data here for copy             
         J     EDMRG150                                     and merge           
*                                                                               
         USING STCELD,R3                                                        
EDMRG102 LA    R3,ESTRFST                                                       
EDMRG104 CLI   STCEL,0             Locate estimates client detail               
         JE    EDMRG110            audit element                                
         CLI   STCEL,STCELQ                                                     
         JNE   EDMRG108                                                         
         CLI   STCIND,STCIECD                                                   
         JE    EDMRG106                                                         
         CLI   STCIND,STCIEST2                                                  
         JNE   EDMRG108                                                         
         CLI   STCETY2,STCAPDTE                                                 
         JNE   *+10                                                             
         MVC   ED_MDCDA,STCECAPD                                                
         CLI   STCETY2,STCECCN                                                  
         JNE   EDMRG108                                                         
         LLC   R1,STCLN                                                         
         SHI   R1,STCELN1Q+1                                                    
         BASR  R4,0                                                             
         MVC   ED_MDCLN(0),STCECNAM                                             
         EX    R1,0(R4)                                                         
         J     EDMRG108                                                         
                                                                                
EDMRG106 MVC   ED_MDCDA,STCDATE                                                 
         CLI   STCLN,STCLNSQ                                                    
         JNH   EDMRG110                                                         
         LLC   R1,STCLN                                                         
         SHI   R1,STCLNSQ+1                                                     
         LTR   R1,R1                                                            
         JM    EDMRG110                                                         
         BASR  R4,0                                                             
         MVC   ED_MDCLN(0),STCCLNAM                                             
         EX    R1,0(R4)                                                         
         J     EDMRG110                                                         
*                                                                               
EDMRG108 LLC   R1,STCLN            process STC/client details                   
         AR    R3,R1                                                            
         J     EDMRG104                                                         
         DROP  R3                                                               
*                                                                               
EDMRG110 GOTOR LP_APUTO,LP_D       download main data here now                  
*                                                                               
         XR    R1,R1                                                            
         ICM   R1,B'0011',CUXPNUM  For Aura we need to set approver             
         CHI   R1,XPRODIKQ                          comments                    
         JNE   EDMRG130            If brandocean send Audit                     
         CLI   RQ_EDPDF,YESQ       If PDF request then also return              
         JE    EDMRG130            audit in old style                           
*                                                                               
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         USING STCELD,R3                                                        
         LA    R3,ESTRFST                                                       
EDMRG112 CLI   STCEL,0             Locate estimates client detail               
         JE    EDMRG144            audit element                                
         CLI   STCEL,STCELQ                                                     
         JNE   EDMRG120                                                         
         CLI   STCIND,STCIEST                                                   
         JE    EDMRG118                                                         
         CLI   STCIND,STCIEST2                                                  
         JNE   EDMRG120                                                         
         CLI   STCETY2,STCSTATE    electronic status comments                   
         JE    EDMRG119                                                         
         CLI   STCETY2,STCAPCMT    Look for approver comments                   
         JE    *+12                                                             
         CLI   STCETY2,STCAPCMI    And internal approver comments               
         JNE   EDMRG120                                                         
         LA    R1,EDTTAB           Estimate status change                       
         MVI   ED_AUFRS,C'*'       Dummy values in case bad data                
         MVI   ED_AUTOS,C'*'                                                    
*                                                                               
EDMRG114 CLI   0(R1),X'FF'                                                      
         JE    EDMRG116                                                         
         CLC   STCECES,1(R1)       Current estimate status                      
         JNE   *+10                                                             
         MVC   ED_AUTOS,0(R1)                                                   
         CLC   STCEPES,1(R1)       Previous estimate status                     
         JNE   *+10                                                             
         MVC   ED_AUFRS,0(R1)                                                   
         AHI   R1,EDTTABQ                                                       
         J     EDMRG114                                                         
                                                                                
EDMRG116 XC    ED_AUTXT,ED_AUTXT                                                
         LLC   R1,STCLN                                                         
         SHI   R1,STCELN2Q+1                                                    
         LTR   R1,R1                                                            
         JM    EDMRG122                                                         
         BASR  R4,0                                                             
         MVC   ED_AUTXT(0),STCECOMM                                             
         EX    R1,0(R4)                                                         
         J     EDMRG122                                                         
                                                                                
EDMRG118 CLI   STCDTO,C'A'         Only interested in approved or               
         JE    *+12                                          rejected           
         CLI   STCDTO,C'R'                                                      
         JNE   EDMRG120                                                         
         MVC   ED_AUFRS,STCDFR                                                  
         CLI   STCDFR,FF                                                        
         JNE   *+8                                                              
         MVI   ED_AUFRS,C'*'        * to indicate added                         
         MVC   ED_AUTOS,STCDTO                                                  
         LLC   RE,STCLN                                                         
         SHI   RE,STCLN1Q                                                       
         SHI   RE,1                                                             
         LTR   RE,RE                                                            
         JM    EDMRG122                                                         
         BASR  R1,0                                                             
         MVC   ED_AUTXT(0),STCESCO                                              
         EX    RE,0(R1)                                                         
         J     EDMRG122                                                         
*                                                                               
EDMRG119 CLI   STCELSTC,EMDGREJ    Only interested in rejected                  
         JNE   *+12                   and approved                              
         MVI   ED_AUTOS,C'R'        Set output as rejected                      
         J     EDMR119A                                                         
         CLI   STCELSTC,EMDGAPP                                                 
         JNE   EDMRG120                                                         
         MVI   ED_AUTOS,C'A'        Set output as approved                      
EDMR119A MVI   ED_AUFRS,C'S'       Could only be submitted previously           
         LLC   RE,STCLN                                                         
         SHI   RE,STCELNEQ+L'STCECIDN+L'STCECSEQ+1 Work out exc length          
         LTR   RE,RE               Check we have text                           
         JM    EDMRG122                                                         
         BASR  R1,0                                                             
         MVC   ED_AUTXT(0),STCECOMT                                             
         EX    RE,0(R1)                                                         
         J     EDMRG122                                                         
*                                                                               
EDMRG120 LLC   R1,STCLN            process STC/client details                   
         AR    R3,R1                                                            
         J     EDMRG112                                                         
*                                                                               
EDMRG122 MVI   ED_RTYPE,ED_RTAUQ   indicate STC data returned                   
         MVC   TEMP2(2),STCPERS                                                 
         XC    X#SVPID(X#SVPLQ),X#SVPID                                         
         MVC   X#SVPID,TEMP2                                                    
         GOTOR (#GETPID,AGETPID)                                                
         JNE   EDMRG124                                                         
         MVC   ED_AUPID,TEMP2                                                   
         MVC   X#SVPCD,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   EDMRG124                                                         
         MVC   ED_AUPER,TEMP2                                                   
         MVC   ED_AUPEL,TEMP2+16                                                
         MVC   X#SVPFN,TEMP2                                                    
         MVC   X#SVPLN,TEMP2+16                                                 
                                                                                
EDMRG124 MVC   ED_AUDTE,STCDATE                                                 
         UNPK  DUB2,STCTIME                                                     
         OI    DUB2+7,C'0'                                                      
         MVC   ED_AUTIM,DUB2+2                                                  
*                                                                               
EDMRG126 MVC   TEMP2(2),STCUSER                                                 
         XC    X#SVUID(X#SVULQ),X#SVUID                                         
         MVC   X#SVUID,TEMP2                                                    
         GOTOR (#GETUSR,AGETUSR)                                                
         JNE   EDMRG128                                                         
         MVC   ED_AUUSR,TEMP2                                                   
         MVC   X#SVUSR,TEMP2                                                    
*                                                                               
EDMRG128 GOTOR LP_APUTO,LP_D       send data for this STC element               
         J     EDMRG120                                                         
         DROP  R3                                                               
                                                                                
EDMRG130 XC    IOKEY,IOKEY         Read audit records for brandocean            
         LA    R3,IOKEY                                         only            
         USING AUDRECD,R3                                                       
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,ESTKCPY                                                  
         MVI   AUDKAUDT,AUDKEST                                                 
         LA    R4,AUDKECPJ                                                      
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,R4),ESTKCLI                                                  
         EX    RF,0(R1)                                                         
         AHI   RF,1                                                             
         AR    R4,RF                                                            
         LLC   RE,PPROLEN                                                       
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,R4),ESTKPRO                                                  
         EX    RE,0(R1)                                                         
         AHI   RE,1                                                             
         AR    R4,RE                                                            
         LHI   RF,L'ESTKJOB-1                                                   
         BASR  R1,0                                                             
         MVC   0(0,R4),ESTKJOB                                                  
         EX    RF,0(R1)                                                         
         OC    AUDKECPJ,SPACES                                                  
         MVC   AUDKELNO,ESTKLNO                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   *+2                 die if no main audit record                  
         MVC   CSVKEY3,IOKEY                                                    
         J     EDMRG134                                                         
*                                                                               
EDMRG132 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         JNE   *+2                                                              
         CLC   CSVKEY3(AUDKSEQ-AUDRECD),IOKEY                                   
         JNE   EDMRG144            finished reading audits?                     
*                                                                               
EDMRG134 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
*                                                                               
         L     R3,AIO3                                                          
         LA    R3,AUDRFST                                                       
         USING STCELD,R3                                                        
EDMRG136 CLI   STCEL,0             Locate estimates client detail               
         JE    EDMRG132            audit element                                
         CLI   STCEL,STCELQ                                                     
         JNE   EDMRG142                                                         
                                                                                
EDMRG138 CLI   STCIND,STCIEST      Ensure old estimate audit                    
         JNE   EDMRG140            Ignore new (returned in ACBRA1D)             
         GOTOR EDMAUD              (uses IO1 and IO7)                           
EDMRG140 CLI   STCIND,STCIEST2     New style estimate audit?                    
         JNE   EDMRG142                                                         
         GOTOR EDANEW              Edit new style as old style                  
                                                                                
EDMRG142 LLC   R1,STCLN            process STC and EMS elements                 
         AR    R3,R1                                                            
         J     EDMRG136                                                         
                                                                                
* Put out source record if source element exists on main estimate               
                                                                                
EDMRG144 L     R2,AIO2             Read EMSEL elements                          
         LA    R3,ESTRFST                                                       
*                                                                               
         USING EMSEL,R3                                                         
EDMRG146 CLI   EMSEL,0                                                          
         JE    EDMRGY                                                           
         CLI   EMSEL,EMSELQ                                                     
         JNE   EDMRG148                                                         
         GOTOR EDMSRC                                                           
*                                                                               
EDMRG148 LLC   R0,EMSLN                                                         
         AR    R3,R0                                                            
         J     EDMRG146                                                         
*                                                                               
EDMRG150 TM    X#DISTYP,X#DISCOQ   pass dummy EMS data on copy                  
         JZ    EDMRGY                                                           
                                                                                
         USING EMSELD,R3                                                        
         LA    R3,ELEMENT                                                       
         XC    EMSEL(EMSLNQ),EMSEL                                              
                                                                                
         MVI   EMSIND,EMSICQ                                                    
         MVC   EMSEST,RQ_EDEST                                                  
                                                                                
         GOTOR EDMSRC              return sources for merge                     
                                                                                
EDMRGY   J     EXITY                                                            
                                                                                
EDMRGN   J     EXITN                                                            
         DROP  R2,R3                                                            
***********************************************************************         
* Edit out Xtra Data Fields on Estimate/Display                       *         
***********************************************************************         
                                                                                
EDMXDF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*EDMXDF*'                                                      
                                                                                
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         USING XDFELD,R3                                                        
         MVI   ED_RTYPE,ED_RTXDQ   indicate XDF data returned                   
                                                                                
         MVC   ED_XDCOD,XDFOCOD                                                 
         MVC   ED_XDTYP,XDFOTYP                                                 
                                                                                
         LLC   RE,XDFLN                                                         
         SHI   RE,XDFOLNQ+1                                                     
         LTR   RE,RE                                                            
         JM    EDMXDF1                                                          
         BASR  RF,0                                                             
         MVC   ED_XDDAT(0),XDFODTA                                              
         EX    RE,0(RF)                                                         
                                                                                
EDMXDF1  MVC   ED_XDNAM,SPACES     get name via XDFPASD                         
         MVC   ED_XDCDE,SPACES                                                  
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   EDMXDF9                                                          
                                                                                
         USING XDFPASD,R2                                                       
         LA    R2,IOKEY            READ XDFRECD USING PASSIVES                  
         XC    IOKEY,IOKEY                                                      
         MVI   XDFPTYP,XDFPTYPQ                                                 
         MVI   XDFPSUB,XDFPSUBQ                                                 
         MVC   XDFPCPY,CUXCPY                                                   
         MVC   XDFPPTR(L'XDFPPTR+L'XDFPSEQ),XDFOCOD                             
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   EDMXDF9                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
         USING XDFRECD,R2                                                       
         L     R2,AIO1                                                          
XDF      USING XDFEL,R1                                                         
         LA    R1,XDFRFST                                                       
                                                                                
EDMXDF2  CLI   XDF.XDFEL,XDFELQ                                                 
         JNE   EDMXDF3                                                          
         CLC   XDF.XDFSEQ,XDFOCOD+L'XDFPPTR                                     
         JE    EDMXDF5                                                          
         J     EDMXDF4                                                          
                                                                                
EDMXDF3  CLI   XDF.XDFEL,0                                                      
         JE    EDMXDF9                                                          
                                                                                
EDMXDF4  LLC   R0,XDF.XDFLN                                                     
         AR    R1,R0                                                            
         J     EDMXDF2                                                          
                                                                                
EDMXDF5  MVC   ED_XDCDE,XDF.XDFCODE                                             
         LLC   RF,XDF.XDFLN                                                     
         SHI   RF,XDFLN1Q                                                       
         CHI   RF,0                                                             
         JNH   EDMXDF9                                                          
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   ED_XDNAM(0),XDF.XDFNAME                                          
         EX    RF,0(RE)                                                         
                                                                                
EDMXDF9  DS    0H                                                               
         GOTOR LP_APUTO,LP_D       send data for this XDF element               
                                                                                
EDMXDFY  J     EXIT                                                             
         DROP  R2,R3,XDF                                                        
***********************************************************************         
* US only: Set HR/CE/OE status for this estimate into ED_MHOCS        *         
*          Code is based on US-ACJOBBER.MCSINI logic                  *         
***********************************************************************         
*&&US                                                                           
                                                                                
SETHCO   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SETHCO*'                                                      
                                                                                
         USING ESTRECD,R2                                                       
         LA    R2,IOKEY            read through this job's estimates            
         MVC   ESTKEY,CSVKEY1                                                   
         MVI   ESTKLNO,0                                                        
         MVI   ESTKSEQ,ESTKSMQ                                                  
         MVC   CSVKEY4,ESTKEY                                                   
                                                                                
         XC    BYTE1(L'BYTE1+L'BYTE2+L'BYTE3+L'BYTE4),BYTE1                     
         XC    X#BYTE1,X#BYTE1                                                  
*              BYTE1   = MCSHIE = HIGHEST ESTIMATE     (ACJOBBER)               
*              BYTE2   = MCSHAE = HIGHEST APPROVED     (ACJOBBER)               
*              BYTE3   = MCSORE = ORIGINAL ESTIMATE    (ACJOBBER)               
*              BYTE4   = MCSCUE = CURRENT ESTIMATE     (ACJOBBER)               
*              X#BYTE1 = MCSHUE = HIGHEST UNAPPROVED   (ACJOBBER)               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JNE   *+2                                                              
         J     SETHCO2                                                          
                                                                                
SETHCO1  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         JNE   *+2                                                              
                                                                                
SETHCO2  CLC   CSVKEY4(ESTKLNO-ESTKEY),ESTKEY                                   
         JNE   SETHCO5                                                          
         CLI   ESTKSEQ,ESTKSMQ     main records only                            
         JNE   SETHCO1                                                          
         TM    ESTKSTA1,ESTKCAPP   filter on status                             
         JNZ   SETHCO3                                                          
         TM    ESTKSTA1,ESTKSUBM                                                
         JZ    SETHCO1                                                          
         MVC   X#BYTE1,ESTKLNO     set highest unapproved                       
         J     SETHCO1                                                          
                                                                                
SETHCO3  MVC   BYTE2,ESTKLNO       set highest approved                         
         CLI   BYTE3,0                                                          
         JE    SETHCO4                                                          
         CLC   BYTE3,ESTKLNO       original estimate set?                       
         JL    SETHCO1                                                          
                                                                                
SETHCO4  MVC   BYTE3,ESTKLNO       first approved estimate is OE                
         J     SETHCO1                                                          
                                                                                
SETHCO5  MVC   BYTE1,BYTE2         set highest estimate etc.                    
         CLC   BYTE2,X#BYTE1                                                    
         JH    SETHCO6                                                          
         MVC   BYTE1,X#BYTE1                                                    
                                                                                
SETHCO6  MVC   BYTE4,X#BYTE1                                                    
         CLI   BYTE2,0                                                          
         JE    SETHCO7                                                          
         MVC   BYTE4,BYTE2                                                      
                                                                                
SETHCO7  XR    RF,RF                                                            
         ICM   RF,B'0011',X#MCESQ  'CE'                                         
         CLC   BYTE4,CSVKEY1+ESTKLNO-ESTKEY                                     
         JE    SETHCO8                                                          
         ICM   RF,B'0011',X#MOESQ  'OE'                                         
         CLC   BYTE3,CSVKEY1+ESTKLNO-ESTKEY                                     
         JE    SETHCO8                                                          
         ICM   RF,B'0011',X#MHRSQ  'HR'                                         
         CLC   BYTE1,CSVKEY1+ESTKLNO-ESTKEY                                     
         JE    SETHCO8                                                          
         XR    RF,RF               naught                                       
                                                                                
SETHCO8  STCM  RF,B'0011',ED_MHOCS                                              
                                                                                
SETHCOX  J     EXIT                                                             
*&&                                                                             
***********************************************************************         
* Estimate display/copy validation                                    *         
***********************************************************************         
                                                                                
EDCVAL   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*EDCVAL*'                                                      
                                                                                
         USING ESTRECD,R2                                                       
         USING EMDELD,R3                                                        
         XC    X#CPEXB,X#CPEXB                                                  
         CLC   RQ_EDCEX,SPACES                                                  
         JNH   EDCVAL00                                                         
         GOTO1 VHEXIN,DMCB,RQ_EDCEX+2,X#CPEXR,10                                
                                                                                
EDCVAL00 MVC   X#CPCUR,AGYCURR                                                  
         CLC   RQ_EDCCC,SPACES                                                  
         JNH   EDCVAL02                                                         
         MVC   X#CPCUR,RQ_EDCCC                                                 
                                                                                
EDCVAL02 L     R2,AIO2             point to main record key                     
         LA    R3,ESTRFST                                                       
                                                                                
         MVC   SJACCNT,SPACES      build SJ key                                 
         OI    X#DISTYP,X#DISCOQ   set 'copy call'                              
                                                                                
         OC    RQ_EDCLI,SPACES                                                  
         OC    RQ_EDPRO,SPACES                                                  
         OC    RQ_EDJOB,SPACES                                                  
                                                                                
EDCVAL04 CLC   RQ_EDCLI(L'RQ_EDCLI+L'RQ_EDPRO+L'RQ_EDJOB),SPACES                
         JE    EDCVALY                                                          
                                                                                
         CLC   RQ_EDCLI,SPACES                                                  
         JH    EDCVAL06                                                         
         MVC   ROUERRV,=AL2(AE$MSCLI)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL06 MVI   X#CSJLVL,1                                                       
         CLC   RQ_EDPRO,SPACES                                                  
         JNH   EDCVAL08                                                         
         MVI   X#CSJLVL,2                                                       
         CLC   RQ_EDJOB,SPACES                                                  
         JNH   EDCVAL08                                                         
         MVI   X#CSJLVL,3                                                       
                                                                                
EDCVAL08 CLC   RQ_EDJOB,SPACES     ensure media is set                          
         JH    EDCVAL10                                                         
         MVC   ROUERRV,=AL2(AE$MCMIS)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL10 LLC   R1,PCLILEN                                                       
         SHI   R1,1                                                             
         BASR  RF,0                                                             
         MVC   SJACCNT(0),RQ_EDCLI                                              
         EX    R1,0(RF)                                                         
         CLI   X#CSJLVL,1                                                       
         JE    EDCVAL12                                                         
         LA    R1,SJACCNT+1(R1)                                                 
         LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  R4,0                                                             
         MVC   0(0,R1),RQ_EDPRO                                                 
         EX    RF,0(R4)                                                         
         CLI   X#CSJLVL,2                                                       
         JE    EDCVAL12                                                         
         LA    R1,1(RF,R1)                                                      
         LLC   RE,PPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         SR    RF,RE                                                            
         CHI   RF,6                                                             
         JNH   *+8                                                              
         LA    RF,6                                                             
         SHI   RF,1                                                             
         BASR  R4,0                                                             
         MVC   0(0,R1),RQ_EDJOB                                                 
         EX    RF,0(R4)                                                         
                                                                                
EDCVAL12 CLC   ESTKCLI,RQ_EDCLI    Check for same SJ account                    
         JNE   EDCVAL14                                                         
         CLC   ESTKPRO,RQ_EDPRO                                                 
         JNE   EDCVAL14                                                         
         CLC   ESTKJOB,RQ_EDJOB                                                 
         JNE   EDCVAL14                                                         
         OI    X#DISTYP,X#DISSJQ   (same job)                                   
                                                                                
         USING ACTRECD,R3                                                       
EDCVAL14 LA    R3,IOKEY            validate client                              
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),SJACCNT                                               
         EX    RE,0(RF)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    EDCVAL16                                                         
         MVC   ROUERRV,=AL2(AE$INCLI)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL16 TM    ACTKSTAT,ACTSLOCK                                                
         JZ    EDCVAL18                                                         
         MVC   ROUERRV,=AL2(AE$CLILK)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL18 TM    ACTKSTAT,ACTSCLOS                                                
         JZ    EDCVAL20                                                         
         MVC   ROUERRV,=AL2(AE$ACCLO)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL20 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
                                                                                
         L     R3,AIO1                                                          
         LA    R4,ACTRFST                                                       
         USING PPRELD,R4                                                        
EDCVAL22 CLI   PPREL,0                                                          
         JE    EDCVAL30                                                         
*&&UK*&& CLI   PPREL,PPRELQ                                                     
*&&UK*&& JE    EDCVAL26                                                         
         CLI   PPREL,RSTELQ                                                     
         JE    EDCVAL28                                                         
                                                                                
EDCVAL24 LLC   R0,PPRLN                                                         
         AR    R4,R0                                                            
         J     EDCVAL22                                                         
                                                                                
*&&UK                                                                           
EDCVAL26 MVC   X#SJOFF,PPRGAOFF                                                 
         J     EDCVAL24                                                         
*&&                                                                             
                                                                                
         USING RSTELD,R4                                                        
EDCVAL28 CLC   RSTSECY+1(1),CUAUTH+1                                            
         JNH   EDCVAL24                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL30 CLI   X#CSJLVL,2          validate product                             
         JL    EDCVAL48                                                         
         LA    R3,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         LLC   RE,PPROLEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),SJACCNT                                               
         EX    RE,0(RF)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    EDCVAL32                                                         
         MVC   ROUERRV,=AL2(AE$INPRO)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL32 TM    ACTKSTAT,ACTSLOCK                                                
         JZ    EDCVAL34                                                         
         MVC   ROUERRV,=AL2(AE$PROLK)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL34 TM    ACTKSTAT,ACTSCLOS                                                
         JZ    EDCVAL36                                                         
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL36 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
                                                                                
         L     R3,AIO1                                                          
         LA    R4,ACTRFST                                                       
         USING PPRELD,R4                                                        
EDCVAL40 CLI   PPREL,0                                                          
         JE    EDCVAL48                                                         
*&&UK*&& CLI   PPREL,PPRELQ                                                     
*&&UK*&& JE    EDCVAL44                                                         
         CLI   PPREL,RSTELQ                                                     
         JE    EDCVAL46                                                         
                                                                                
EDCVAL42 LLC   R0,PPRLN                                                         
         AR    R4,R0                                                            
         J     EDCVAL40                                                         
                                                                                
*&&UK                                                                           
EDCVAL44 CLI   PPRGAOFF,X'40'                                                   
         JNH   EDCVAL42                                                         
         MVC   X#SJOFF,PPRGAOFF                                                 
         J     EDCVAL42                                                         
*&&                                                                             
                                                                                
         USING RSTELD,R4                                                        
EDCVAL46 CLC   RSTSECY+1(1),CUAUTH+1                                            
         JNH   EDCVAL42                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL48 CLI   X#CSJLVL,3          validate job                                 
         JL    EDCVAL70                                                         
         LA    R3,IOKEY            validate SJ account                          
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT,SJACCNT                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    EDCVAL50                                                         
         MVC   ROUERRV,=AL2(AE$INJOB)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL50 DS    0H                                                               
*&&UK                                                                           
         TM    ACTKSTAT,ACTSLOCK                                                
         JZ    EDCVAL52                                                         
         MVC   ROUERRV,=AL2(AE$JOBLK)                                           
         J     EDCVALN                                                          
*&&                                                                             
                                                                                
EDCVAL52 TM    ACTKSTAT,ACTSCLOS                                                
         JZ    EDCVAL54                                                         
         MVC   ROUERRV,=AL2(AE$JOBCL)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL54 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
                                                                                
         L     R3,AIO1                                                          
         LA    R4,ACTRFST                                                       
         USING PPRELD,R4                                                        
EDCVAL56 CLI   PPREL,0                                                          
         JE    EDCVAL70                                                         
*&&UK*&& CLI   PPREL,PPRELQ                                                     
*&&UK*&& JE    EDCVAL60                                                         
         CLI   PPREL,RSTELQ                                                     
         JE    EDCVAL62                                                         
         CLI   PPREL,JOBELQ                                                     
         JE    EDCVAL64                                                         
                                                                                
EDCVAL58 LLC   R0,PPRLN                                                         
         AR    R4,R0                                                            
         J     EDCVAL56                                                         
                                                                                
*&&UK                                                                           
EDCVAL60 CLI   PPRGAOFF,X'40'                                                   
         JNH   EDCVAL58                                                         
         MVC   X#SJOFF,PPRGAOFF                                                 
         J     EDCVAL58                                                         
*&&                                                                             
                                                                                
         USING RSTELD,R4                                                        
EDCVAL62 CLC   RSTSECY+1(1),CUAUTH+1                                            
         JNH   EDCVAL58                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EDCVALN                                                          
                                                                                
         USING JOBELD,R4                                                        
EDCVAL64 CLI   JOBLN,JOBLN3Q                                                    
         JL    EDCVAL66                                                         
         TM    JOBSTA1,JOBSMCSE                                                 
         JNZ   EDCVAL58                                                         
                                                                                
EDCVAL66 MVC   ROUERRV,=AL2(AE$NOMCS)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL70 CLC   X#SJOFF,SPACES                                                   
         JNH   EDCVAL72                                                         
         CLC   ESTRSOFF,X#SJOFF                                                 
         JE    EDCVAL72                                                         
         MVC   ROUERRV,=AL2(AE$OFFMM)                                           
         J     EDCVALN                                                          
                                                                                
EDCVAL72 DS    0H                                                               
                                                                                
EDCVALY  J     EXITY                                                            
                                                                                
EDCVALN  J     EXITN                                                            
                                                                                
         DROP  R2,R3,R4                                                         
                                                                                
***********************************************************************         
* Edit out Row Fields on Estimate/Display                             *         
***********************************************************************         
                                                                                
EDMROW   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*EDMROW*'                                                      
                                                                                
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         DS    0H                  Return data routine depends on type          
                                                                                
         USING ERDELD,R3                                                        
         MVI   ED_RTYPE,ED_RTHTQ                                                
         LA    R1,ED_HTXT1                                                      
         CLI   ERDTYP,ERDTHTQ      - HEADER TEXT                                
         JE    EDMR100                                                          
                                                                                
         MVI   ED_RTYPE,ED_RTETQ                                                
         LA    R1,ED_HTXT1                                                      
         CLI   ERDTYP,ERDTETQ      - Estimate additional text                   
         JE    EDMR100                                                          
                                                                                
         MVI   ED_RTYPE,ED_RTFTQ                                                
         LA    R1,ED_FTXT1                                                      
         CLI   ERDTYP,ERDTFTQ      - FOOTER TEXT                                
         JE    EDMR100                                                          
                                                                                
         MVI   ED_RTYPE,ED_RTWTQ                                                
         LA    R1,ED_WTXT1                                                      
         CLI   ERDTYP,ERDTWTQ      - WORK CODE TEXT                             
         JE    EDMR100                                                          
                                                                                
         MVI   ED_RTYPE,ED_RTITQ                                                
         LA    R1,ED_ITXT1                                                      
         CLI   ERDTYP,ERDTITQ      - ITEM TEXT                                  
         JE    EDMR100                                                          
                                                                                
         MVI   ED_RTYPE,ED_RTVTQ                                                
         LA    R1,ED_VTXT1                                                      
         CLI   ERDTYP,ERDTCTQ      - CATEGORY TEXT                              
         JE    EDMR100                                                          
                                                                                
         MVI   ED_RTYPE,ED_RTWCQ                                                
         CLI   ERDTYP,ERDTWDQ      - WORK CODE DATA                             
         JE    EDMR160                                                          
                                                                                
         MVI   ED_RTYPE,ED_RTIDQ                                                
         CLI   ERDTYP,ERDTIDQ      - ITEM DATA                                  
         JE    EDMR300                                                          
                                                                                
         MVI   ED_RTYPE,ED_RTIRQ                                                
         CLI   ERDTYP,ERDTIRQ      - ITEM DATA (HOURS+RATE)                     
         JE    EDMR340                                                          
                                                                                
         MVI   ED_RTYPE,ED_RTCAQ                                                
         CLI   ERDTYP,ERDTCSQ      - CATEGORY LAYOUT                            
         JE    EDMR400                                                          
         DC    H'0'                                                             
                                                                                
EDMR100  LLC   RE,ERDLN            general text processing                      
         SHI   RE,ERDTLNQ+1                                                     
         LTR   RE,RE                                                            
         JM    EDMR900                                                          
         BASR  RF,0                                                             
         MVC   0(0,R1),ERDTEXT                                                  
         EX    RE,0(RF)                                                         
         LR    RF,R1                                                            
         AHI   RE,1                                                             
EDMR150  CLC   0(2,RF),=C'??'      double ?? causes DDLINK mayhem               
***      JNE   EDMR154                                                          
         J     EDMR154                                                          
         CLI   CUCTRY,CTRYGER                                                   
         JE    *+14                                                             
         MVC   0(2,RF),=X'5F5F'    make 'not' signs - web will fix              
         J     *+10                                                             
         MVC   0(2,RF),=X'6969'    same sign, different hex for Germany         
EDMR154  AHI   RF,1                                                             
         JCT   RE,EDMR150                                                       
         J     EDMR900                                                          
                                                                                
EDMR160  DS    0H                  work code data processing                    
         MVC   X#CURWC,ERDWCOD     (save current w/c for items)                 
                                                                                
         TM    X#SBSIND,X#SBSOTH   Other Workcode?                              
         JZ    *+8                                                              
         MVI   ED_WCOTH,YESQ                                                    
                                                                                
         TM    X#SBSIND,X#SBSSEQ   'sequentials'                                
         JZ    EDMR162                                                          
         MVI   ED_SBSSQ,YESQ                                                    
         ZAP   ED_WCRAT,X#WCRAT    pass back rate                               
                                                                                
EDMR162  MVC   ED_WCATC,ERDWCAT                                                 
         MVC   ED_WCODE,ERDWCOD                                                 
         MVC   ED_WNAME,ERDWNAM                                                 
*                                                                               
         XC    X#SVWC,X#SVWC       Clear saved work code and item seq           
         XC    X#ITSEQ,X#ITSEQ                                                  
         OC    X#SVCAT,X#SVCAT     First time through                           
         JZ    *+14                                                             
         CLC   X#SVCAT,X#CURCAT    Has the category changed                     
         JE    EDMR163             No                                           
         MVC   X#SVCAT,X#CURCAT    Yes - save new category                      
         XC    X#WCSEQ,X#WCSEQ      and reset work code sequence                
*                                                                               
EDMR163  LLH   RF,X#WCSEQ          Pass W/C seq                                 
         AHI   RF,1                                                             
         STH   RF,X#WCSEQ                                                       
         STCM  RF,7,ED_WCSEQ                                                    
*                                                                               
K        USING WCORECD,IOKEY                                                    
         MVC   K.WCOKEY,SPACES                                                  
         MVI   K.WCOKTYP,WCOKTYPQ                                               
         MVC   K.WCOKCPY,CUXCPY                                                 
         MVC   K.WCOKUNT(L'WCOKUNT+L'WCOKLDG),PRODUL                            
         MVC   K.WCOKWRK,ERDWCOD                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   *+2                                                              
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
*                                                                               
         USING NAMELD,RF                                                        
         L     RF,AIO3             loop through elements                        
         AHI   RF,WCORFST-WCORECD                                               
                                                                                
EDMR164  CLI   NAMEL,0                                                          
         JE    EDMR172                                                          
         CLI   NAMEL,NAMELQ                                                     
         JE    EDMR168                                                          
         CLI   NAMEL,WCOELQ                                                     
         JE    EDMR170                                                          
EDMR166  LLC   R0,NAMLN                                                         
         AR    RF,R0                                                            
         J     EDMR164                                                          
*                                                                               
         USING NAMELD,RF                                                        
EDMR168  LLC   RE,NAMLN                                                         
         SHI   RE,1+NAMLN1Q                                                     
         BASR  R1,0                                                             
         MVC   ED_WXNAM(0),NAMEREC                                              
         EX    RE,0(R1)                                                         
         J     EDMR166                                                          
*                                                                               
         USING WCOELD,RF                                                        
EDMR170  MVC   TEMP(L'WCODESC),WCODESC                                          
         MVI   ED_WESCK,YESQ                                                    
         MVI   ED_WTYPE,ED_WTIME                                                
*&&UK                                                                           
         TM    WCOSTAT3,WCOSESCK   Estimate check?                              
         JZ    *+8                                                              
         MVI   ED_WESCK,NOQ                                                     
*&&                                                                             
         TM    WCOSTAT,WCOSHCOE    Cost workcode?                               
         JNZ   EDMR166                                                          
         MVI   ED_WTYPE,ED_WCOST                                                
*&&US                                                                           
         CLI   WCOTYPE,C'T'        Do additional check for US                   
         JNE   EDMR166                                                          
         MVI   ED_WTYPE,ED_WTIME                                                
*&&                                                                             
         J     EDMR166                                                          
         DROP  RF                                                               
*                                                                               
EDMR172  CLC   ED_WXNAM,SPACES                                                  
         JH    *+10                                                             
         MVC   ED_WXNAM(L'WCODESC),TEMP                                         
         MVC   ED_WCVCO,ERDWVCO                                                 
         ZAP   ED_WCRAT,ERDWCRA                                                 
         MVC   ED_WCCWC,SPACES                                                  
         ZAP   ED_WCESP,PZERO                                                   
         CLI   ERDLN,ERDWLXQ                                                    
         JL    EDMR207                                                          
         CLC   ERDWCCC,SPACES                                                   
         JNH   EDMR207                                                          
         MVC   ED_WCCWC,ERDWCCC    ESP % always retrieved                       
         MVC   TEMP2(2),ERDWCOD                                                 
         GOTOR GETEPT                                                           
         ZAP   ED_WCESP,X#WCESP                                                 
                                                                                
EDMR207  DS    0H                                                               
*&&UK                        (merge/copy/reval. for UK, always for US)          
         TM    X#DISTYP,X#DISRVQ+X#DISCOQ+X#DISMDQ                              
         JZ    EDMR209                                                          
*                                                                               
EDMR208  TM    X#DISTYP,X#DISCOQ   copying?                                     
         JZ    EDMR208A                                                         
         TM    ERDWIND,ERDWICQ     commission override exists?                  
         JZ    EDMR208A                                                         
         TM    X#DISTYP,X#DISSJQ   same job?                                    
         JNZ   EDMR209A                                                         
*&&                                                                             
                                                                                
EDMR208A MVC   TEMP2(2),ERDWCOD                                                 
         ZAP   DUB2,ED_WCRAT                                                    
         ZAP   X#WCRAT,PZERO                                                    
         GOTOR GETCOM              Get current commission                       
         JNE   EDMROWN                                                          
                                                                                
         ZAP   ED_WCRAT,DUB2                                                    
*&&UK*&& MVC   ED_WCVRA,HALF2                                                   
         ZAP   X#WCRAT,DUB2        Save off rate for SxS columns                
         J     EDMR209A                                                         
                                                                                
EDMR209  MVC   ED_WCVRA,ERDWVRA                                                 
                                                                                
EDMR209A TM    X#DISTYP,X#DISRVQ   revaluation?                                 
         JNZ   EDMR210                                                          
         ZAP   ED_WAMNT,ERDWAMT                                                 
         ZAP   ED_WFCAM,ERDWFCA                                                 
         ZAP   ED_WCAMT,ERDWCAM                                                 
         ZAP   ED_WCFCA,ERDWCFC                                                 
*&&UK                                                                           
         ZAP   ED_WCVAM,ERDWVAM                                                 
         ZAP   ED_WCVFC,ERDWVFC                                                 
*&&                                                                             
         ZAP   ED_WCNIC,ERDWNIC                                                 
         ZAP   ED_WCNFC,ERDWNFC                                                 
         J     EDMR240                                                          
                                                                                
EDMR210  TM    X#DISTYP,X#DISFCQ   revaluation depends on base                  
         JZ    EDMR220                                                          
         DS    0H                  base is foreign currency                     
         ZAP   ED_WFCAM,ERDWFCA                                                 
         ZAP   ED_WCFCA,ERDWCFC                                                 
*&&UK*&& ZAP   ED_WCVFC,ERDWVFC                                                 
         ZAP   ED_WCNFC,ERDWNFC                                                 
         ZAP   ED_WAMNT,PZERO                                                   
         ZAP   ED_WAMNC,PZERO                                                   
         ZAP   ED_WCAMT,PZERO                                                   
         ZAP   ED_WCVAM,PZERO                                                   
         ZAP   ED_WCNIC,PZERO                                                   
         TM    ERDWIND,ERDWIIQ     if items exist pass zeroes                   
         JNZ   EDMR240                                                          
         GOTOR CURCON,ERDWFCA                                                   
         ZAP   ED_WAMNT,DUB1                                                    
         GOTOR CURCON,ERDWCFC                                                   
         ZAP   ED_WCAMT,DUB1                                                    
         GOTOR CURCON,ERDWVFC                                                   
*&&UK*&& ZAP   ED_WCVAM,DUB1                                                    
         GOTOR CURCON,ERDWNFC                                                   
         ZAP   ED_WCNIC,DUB1                                                    
         J     EDMR240                                                          
                                                                                
EDMR220  DS    0H                  base is agency currency                      
         ZAP   ED_WAMNT,ERDWAMT                                                 
         ZAP   ED_WCAMT,ERDWCAM                                                 
*&&UK*&& ZAP   ED_WCVAM,ERDWVAM                                                 
         ZAP   ED_WCNIC,ERDWNIC                                                 
         ZAP   ED_WFCAM,PZERO                                                   
         ZAP   ED_WCFCA,PZERO                                                   
         ZAP   ED_WCVFC,PZERO                                                   
         ZAP   ED_WCNFC,PZERO                                                   
         TM    ERDWIND,ERDWIIQ     if items exist pass zeroes                   
         JNZ   EDMR240                                                          
         GOTOR CURCON,ERDWAMT                                                   
         ZAP   ED_WFCAM,DUB1                                                    
         GOTOR CURCON,ERDWCAM                                                   
         ZAP   ED_WCFCA,DUB1                                                    
         GOTOR CURCON,ERDWVAM                                                   
*&&UK*&& ZAP   ED_WCVFC,DUB1                                                    
         GOTOR CURCON,ERDWNIC                                                   
         ZAP   ED_WCNFC,DUB1                                                    
                                                                                
EDMR240  MVI   ED_WINDS,C'N'                                                    
         MVC   ED_WINDS+1(L'ED_WINDS-1),ED_WINDS                                
                                                                                
EDMR242  TM    ERDWIND,ERDWIIQ                                                  
         JZ    EDMR250                                                          
         MVI   ED_WINDS+0,YESQ                                                  
                                                                                
EDMR250  TM    ERDWIND,ERDWICQ                                                  
         JZ    EDMR260                                                          
*&&UK                                                                           
         TM    X#DISTYP,X#DISCOQ   copying?                                     
         JZ    *+12                                                             
         TM    X#DISTYP,X#DISSJQ   same job?                                    
         JZ    *+8                                                              
*&&                                                                             
         MVI   ED_WINDS+1,YESQ                                                  
                                                                                
EDMR260  TM    ERDWIND,ERDWIXQ                                                  
         JZ    EDMR280                                                          
         MVI   ED_WINDS+4,YESQ                                                  
                                                                                
EDMR280  TM    ERDWIND,ERDWIMQ                                                  
         JZ    EDMR282                                                          
         MVI   ED_WINDS+5,YESQ                                                  
                                                                                
EDMR282  TM    ERDWIND,ERDWIOQ                                                  
         JZ    EDMR284                                                          
         MVI   ED_WINDS+6,YESQ                                                  
                                                                                
EDMR284  TM    ERDWIND,ERDWIAC                                                  
         JZ    EDMR286                                                          
         MVI   ED_WINDS+7,YESQ                                                  
                                                                                
EDMR286  CLI   ERDLN,ERDWLX1Q      Are we time at work code level?              
         JNE   EDMR900             No                                           
         MVI   ED_ITYPE,ED_IHRS    Set type as hours                            
         MVI   ED_IINDS,C'N'                                                    
         MVC   ED_IINDS+1(L'ED_IINDS-1),ED_IINDS                                
         ZAP   ED_IAPRI,ERDWRAT                                                 
*&&UK*&& ZAP   ED_IFPRI,ERDWRATF                                                
         ZAP   ED_IMULT,ERDWHRS                                                 
         TM    ERDWIND2,ERDWTOQ                                                 
         JZ    EDMR288                                                          
         MVI   ED_IINDS+5,YESQ                                                  
                                                                                
EDMR288  DS    0H                                                               
         J     EDMR900                                                          
                                                                                
EDMR300  DS    0H                  item data processing                         
                                                                                
         OC    X#SVWC,X#SVWC       First time through                           
         JZ    *+14                                                             
         CLC   X#SVWC,X#CURWC                                                   
         JE    EDMR302                                                          
         MVC   X#SVWC,X#CURWC                                                   
         XC    X#ITSEQ,X#ITSEQ                                                  
*                                                                               
EDMR302  LLH   RF,X#ITSEQ          Pass item sequence                           
         AHI   RF,1                                                             
         STH   RF,X#ITSEQ                                                       
         STCM  RF,7,ED_ITSEQ                                                    
*                                                                               
         MVI   ED_ITYPE,ED_IMAT    set item type is materials                   
         TM    X#SBSIND,X#SBSSEQ   ''sequentials'                               
         JZ    EDMR301                                                          
         MVI   ED_SBSSQ,YESQ                                                    
         ZAP   ED_WCRAT,X#WCRAT    pass back rate                               
                                                                                
EDMR301  MVI   ED_ICIND,C'U'       unchanged                                    
         TM    X#DISTYP,X#DISCOQ   copy action?                                 
         JZ    EDMR325                                                          
         CLC   ERDICOD,SPACES      skip 'no code' items                         
         JE    EDMR325                                                          
         TM    ERDIIND,ERDIIAQ+ERDIINQ+ERDIIPQ+ERDIIOQ                          
         JNZ   EDMR325    skip if NIC, Artist or no price or overriden          
*                                                                               
EDMR304  MVC   G#SGOOFF,X#CUROF                                                 
*&&UK                                                                           
         MVC   G#SGOCLI,RQ_EDCLI                                                
         MVC   G#SGOPRO,RQ_EDPRO                                                
         MVC   G#SGOJOB,RQ_EDJOB                                                
*&&                                                                             
*&&US                                                                           
         MVC   G#SGOCLI,SPACES                                                  
         MVC   G#SGOCLI(L'RQ_EDCLI),RQ_EDCLI                                    
         MVC   G#SGOPRO,SPACES                                                  
         MVC   G#SGOPRO(L'RQ_EDPRO),RQ_EDPRO                                    
         MVC   G#SGOJOB,SPACES                                                  
         MVC   G#SGOJOB(L'RQ_EDJOB),RQ_EDJOB                                    
*&&                                                                             
         MVC   G#SGWRKC,X#CURWC                                                 
         MVC   G#SGOLLA,ERDISEQ                                                 
         MVC   G#SGRATE,X#CPEXR                                                 
         MVC   G#SGCURR,X#CPCUR                                                 
         MVC   G#SGSUPP,SPACES                                                  
                                                                                
         LA    R1,C'E'                                                          
         GOTOR (#GETITM,AGETITM)   check item for current values                
         JE    EDMR308                                                          
                                                                                
         MVI   ED_ICIND,C'D'       drop it if 'error'                           
         J     EDMR325                                                          
                                                                                
         USING X_LISTTABD,RF                                                    
EDMR308  L     RF,AELEAREA                                                      
                                                                                
EDMR310  OC    X_LISTSEQ,X_LISTSEQ end of list?                                 
         JNZ   EDMR315                                                          
                                                                                
         MVI   ED_ICIND,C'D'       drop it if not same item                     
         J     EDMR325                                                          
                                                                                
EDMR315  CLC   X_LISTSEQ,ERDISEQ                                                
         JE    EDMR320                                                          
         AHI   RF,X_LISTLNQ        next entry                                   
         J     EDMR310                                                          
                                                                                
EDMR320  LA    RE,ERDIFPR          Use currency if present                      
         LA    R1,ED_IFPRI                                                      
         CLC   X#CPCUR,SPACES      Do we have a foreign currency                
         JNH   EDMR321                                                          
         CLC   X#CPCUR,AGYCURR                                                  
         JE    EDMR321                                                          
         CP    ERDIFPR,PZERO                                                    
         JNE   EDMR322                                                          
EDMR321  LA    RE,ERDIAPR                                                       
         LA    R1,ED_IAPRI                                                      
                                                                                
EDMR322  CP    X_LISTPRI,0(L'ERDIAPR,RE)                                        
         JE    EDMR325             it is OK, else                               
                                                                                
         MVI   ED_ICIND,C'C'       mark as changed and pass new price           
         ZAP   0(L'ED_IAPRI,R1),X_LISTPRI                                       
         DROP  RF                                                               
                                                                                
EDMR325  MVC   ED_ICODE,ERDICOD                                                 
         MVC   ED_ISEQN,ERDISEQ                                                 
         MVC   ED_IDESC,ERDIDES                                                 
         ZAP   ED_IMULT,ERDIMUL                                                 
                                                                                
         TM    X#DISTYP,X#DISRVQ   revaluation?                                 
         JNZ   EDMR330                                                          
         ZAP   ED_ITNIC,ERDINIC                                                 
         ZAP   ED_ITNFC,ERDINFC                                                 
         CLI   ED_ICIND,C'C'       skip if price has changed                    
         JE    EDMR350                                                          
         ZAP   ED_IAPRI,ERDIAPR                                                 
         ZAP   ED_IFPRI,ERDIFPR                                                 
         J     EDMR350                                                          
                                                                                
EDMR330  TM    X#DISTYP,X#DISFCQ                                                
         JNZ   EDMR335                                                          
         ZAP   ED_IAPRI,ERDIAPR    basis is agency                              
         ZAP   ED_ITNIC,ERDINIC                                                 
         GOTOR CURCON,ERDIAPR                                                   
         ZAP   ED_IFPRI,DUB1                                                    
         GOTOR CURCON,ERDINIC                                                   
         ZAP   ED_ITNFC,DUB1                                                    
         J     EDMR350                                                          
                                                                                
EDMR335  ZAP   ED_IFPRI,ERDIFPR    basis is foreign currency                    
         ZAP   ED_ITNFC,ERDINFC                                                 
         GOTOR CURCON,ERDIFPR                                                   
         ZAP   ED_IAPRI,DUB1                                                    
         GOTOR CURCON,ERDINFC                                                   
         ZAP   ED_ITNIC,DUB1                                                    
         J     EDMR350                                                          
                                                                                
EDMR340  OC    X#SVWC,X#SVWC       First time through                           
         JZ    *+14                                                             
         CLC   X#SVWC,X#CURWC                                                   
         JE    EDMR342                                                          
         MVC   X#SVWC,X#CURWC                                                   
         XC    X#ITSEQ,X#ITSEQ                                                  
*                                                                               
EDMR342  LLH   RF,X#ITSEQ          Pass item sequence                           
         AHI   RF,1                                                             
         STH   RF,X#ITSEQ                                                       
         STCM  RF,7,ED_ITSEQ                                                    
         MVI   ED_ITYPE,ED_IHRS    set item type is hours                       
         TM    X#SBSIND,X#SBSSEQ   ''sequentials'                               
         JZ    *+8                                                              
         MVI   ED_SBSSQ,YESQ                                                    
         MVC   ED_1RULA(L'ACTKUNT+L'ACTKLDG),LEDGER1R                           
         MVC   ED_1RACT,ERDITAC                                                 
         ZAP   ED_IAPRI,ERDIRAT    hourly rate                                  
         ZAP   ED_IFPRI,PZERO                                                   
         MVC   ED_IMULT,ERDIHRS    n'hours                                      
         MVC   ED_IRIND,ASTERS     null revaluation                             
         TM    ERDITND,ERDITFQ     test f/currency hourly rate present          
         JZ    EDMR344                                                          
         MVC   ED_IFPRI,ERDIRAF                                                 
         TM    X#DISTYP,X#DISRVQ   revaluation?                                 
         JZ    EDMR344                                                          
         GOTOR CURCON,ERDIRAT                                                   
         ZAP   ED_IFPRI,DUB1                                                    
EDMR344  XC    FULL1,FULL1         set by CHKITM, ensure cleared                
         XC    FULL2,FULL2                                                      
         J     EDMR352                                                          
                                                                                
EDMR350  GOTOR CHKITM,ERDELD                                                    
         MVC   ED_IRIND,X#IRSTA                                                 
                                                                                
EDMR352  MVI   ED_IINDS,C'N'                                                    
         MVC   ED_IINDS+1(L'ED_IINDS-1),ED_IINDS                                
                                                                                
         CLI   ED_RTYPE,ED_RTIRQ   test hours item                              
         JNE   EDMR353                                                          
         TM    ERDITND,ERDITOQ     test rate overridden                         
         JZ    *+8                                                              
         MVI   ED_IINDS+5,C'Y'                                                  
         J     EDMR381             no indicators apply                          
                                                                                
EDMR353  TM    ERDIIND,ERDIIAQ                                                  
         JZ    EDMR355                                                          
         MVI   ED_IINDS,YESQ                                                    
                                                                                
EDMR355  TM    ERDIIND,ERDIINQ                                                  
         JZ    EDMR360                                                          
         MVI   ED_IINDS+1,YESQ                                                  
                                                                                
EDMR360  TM    ERDIIND,ERDIIDQ                                                  
         JZ    EDMR365                                                          
         MVI   ED_IINDS+2,YESQ                                                  
                                                                                
EDMR365  TM    ERDIIND,ERDIIFQ                                                  
         JZ    EDMR370                                                          
         MVI   ED_IINDS+3,YESQ                                                  
                                                                                
EDMR370  TM    ERDIIND,ERDIIPQ                                                  
         JZ    EDMR375                                                          
         MVI   ED_IINDS+4,YESQ                                                  
                                                                                
EDMR375  TM    ERDIIND,ERDIIOQ                                                  
         JZ    EDMR380                                                          
         MVI   ED_IINDS+5,C'Y'                                                  
                                                                                
EDMR380  TM    ERDIIND,ERDIITQ                                                  
         JZ    EDMR381                                                          
         MVI   ED_IINDS+6,YESQ                                                  
                                                                                
         USING SCMELD,RF                                                        
EDMR381  XC    ED_IETX1,ED_IETX1                                                
         ICM   RF,15,FULL1                                                      
         JZ    EDMR382                                                          
         LLC   RE,SCMLN                                                         
         SHI   RE,SCMLN1Q+1                                                     
         BASR  R1,0                                                             
         MVC   ED_IETX1(0),SCMNARR                                              
         EX    RE,0(R1)                                                         
                                                                                
EDMR382  XC    ED_IETX2,ED_IETX2                                                
         ICM   RF,15,FULL2                                                      
         JZ    EDMR383                                                          
         LLC   RE,SCMLN                                                         
         SHI   RE,SCMLN1Q+1                                                     
         BASR  R1,0                                                             
         MVC   ED_IETX2(0),SCMNARR                                              
         EX    RE,0(R1)                                                         
         DROP  RF                                                               
                                                                                
EDMR383  MVC   ED_IUNIT,X#UNIT                                                  
         MVC   ED_IUNLA,X#UNLA                                                  
                                                                                
EDMR385  DS    0H                                                               
         J     EDMR900                                                          
                                                                                
EDMR400  MVC   ED_CACOD,ERDCCOD    category layout                              
         MVC   ED_CANAM,ERDCNAM                                                 
         MVC   ED_CATNA,ERDCTNA                                                 
         MVC   ED_CAINS,ERDCINS                                                 
         MVC   ED_CATYP,ERDCTYP                                                 
         MVC   ED_CAELS,ERDCELS                                                 
                                                                                
         MVC   X#CURCAT,ERDCCOD                                                 
*&&US                                                                           
         CLI   ED_CATYP,C'6'       Is this a contingency?                       
         JNE   EDMR900                                                          
         MVI   ED_CATYP,C'1'       In US we do not set at CATEGORY lev          
         MVC   ED_CAINS,SPACES                                                  
*&&                                                                             
                                                                                
EDMR900  GOTOR LP_APUTO,LP_D       send data for this element                   
         J     EDMROWY                                                          
                                                                                
EDMROWN  J     EXITN                                                            
                                                                                
EDMROWY  J     EXITY                                                            
                                                                                
         DROP  R3                                                               
***********************************************************************         
* Get Commission Rate                                                 *         
***********************************************************************         
                                                                                
GETCOM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETCOM*'                                                      
                                                                                
         USING ESTRECD,R2                                                       
         L     R2,AIO2                                                          
                                                                                
         USING GOBLOCKD,R3                                                      
***      L     R3,AGOBLOCK                                                      
         L     R3,AGOBLOCB                                                      
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(2),PRODUL                                             
         MVC   GOSELCLI,X#CLIC                                                  
         MVC   GOSELPRO,X#PROC                                                  
         MVC   GOSELJOB,X#JOBC                                                  
*&&US                                                                           
         CLC   X#JOBC,SPACES     Do we have a job?                              
         JNH   GETCOMX                                                          
*&&                                                                             
         CLC   GOSELJOB,SPACES                                                  
         JH    *+10                                                             
         XC    GOSELJOB,GOSELJOB                                                
                                                                                
GETCOM2  CLI   X#JOBC,C' '                                                      
         JNH   GETCOM4                                                          
         MVC   GOSELMED,GOSELJOB                                                
                                                                                
GETCOM4  MVC   GOSELWC,TEMP2                                                    
         MVI   GOANYWC,YESQ                                                     
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
         ZAP   DUB2,GOAGYCOM                                                    
         MVC   BYTE2,GOTAXCOD                                                   
*&&UK                                                                           
         CLI   CUCTRY,CTRYGER      internal we/c and Germany?                   
         JNE   GETCOM6                                                          
         CLI   GOSELWC,C'Z'                                                     
         JH    GETCOM6                                                          
         OC    GOPROVPC,GOPROVPC   if internal comm rate override               
         JZ    GETCOM6             regular comm rate with it                    
         ZAP   DUB2,GOPROVPC                                                    
                                                                                
         USING VTCD,R2                                                          
GETCOM6  LAY   R2,X#VTCBL          build VATICAN call block                     
         XC    VTCD(VTCLNQ),VTCD                                                
         MVI   VTCACTN,VTCALOOK                                                 
         MVC   VTCCPY,CUXCPY                                                    
         MVC   VTCOFFC,X#SJOFF                                                  
         MVC   VTCCOMF,ACOMFACS                                                 
         MVC   VTCINVD,XL#TODP                                                  
         MVC   VTCTYPE,BYTE2                                                    
         MVC   VTCCPYS1,CPYSTAT1                                                
         MVC   VTCSGOPO,X#SGOPOS                                                
                                                                                
         GOTO1 VATICAN,VTCD                                                     
         JE    GETCOM8                                                          
         MVC   ROUERRV,VTCERR                                                   
         J     GETCOMN                                                          
                                                                                
GETCOM8  TM    VTCINDS,VTCINA         tax is not applicable                     
         JZ    GETCO10                                                          
         MVC   ROUERRV,=AL2(AE$VRNDE) VAT rates not defined for date            
         J     GETCOMN                                                          
                                                                                
GETCO10  MVC   HALF2,VTCRATE                                                    
*&&                                                                             
         J     GETCOMX                                                          
                                                                                
GETCOMN  J     EXITN                                                            
                                                                                
GETCOMX  J     EXITY                                                            
                                                                                
         DROP  R2,R3                                                            
                                                                                
         EJECT                                                                  
                                                                                
***********************************************************************         
* Edit out Audit Trail data on Estimate/Display (Old BO style audit)  *         
***********************************************************************         
                                                                                
EDMAUD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*EDMAUD*'                                                      
                                                                                
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         USING STCELD,R3                                                        
                                                                                
         MVI   ED_RTYPE,ED_RTAUQ   indicate STC data returned                   
                                                                                
         MVC   ED_AUFRS,STCDFR                                                  
         CLI   STCDFR,FF                                                        
         JNE   *+8                                                              
         MVI   ED_AUFRS,C'*'        * to indicate added                         
                                                                                
         MVC   ED_AUTOS,STCDTO                                                  
         CLI   ED_AUTOS,STCEXBOX    Skip internal use flag/name for BO          
         JE    EDMAUDX                                                          
         CLI   ED_AUTOS,STCENAME                                                
         JE    EDMAUDX                                                          
         CLC   STCPERS,X#SVPID                                                  
         JNE   EDMAUD1                                                          
         MVC   ED_AUPID,X#SVPCD                                                 
         MVC   ED_AUPER,X#SVPFN                                                 
         MVC   ED_AUPEL,X#SVPLN                                                 
         J     EDMAUD2                                                          
                                                                                
EDMAUD1  MVC   TEMP2(2),STCPERS                                                 
         XC    X#SVPID(X#SVPLQ),X#SVPID                                         
         MVC   X#SVPID,TEMP2                                                    
         GOTOR (#GETPID,AGETPID)                                                
         JNE   EDMAUD2                                                          
         MVC   ED_AUPID,TEMP2                                                   
         MVC   X#SVPCD,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   EDMAUD2                                                          
         MVC   ED_AUPER,TEMP2                                                   
         MVC   ED_AUPEL,TEMP2+16                                                
         MVC   X#SVPFN,TEMP2                                                    
         MVC   X#SVPLN,TEMP2+16                                                 
                                                                                
EDMAUD2  MVC   ED_AUDTE,STCDATE                                                 
         UNPK  DUB2,STCTIME                                                     
         OI    DUB2+7,C'0'                                                      
         MVC   ED_AUTIM,DUB2+2                                                  
                                                                                
         CLC   X#SVUID,STCUSER                                                  
         JNE   EDMAUD3                                                          
         MVC   ED_AUUSR,X#SVUSR                                                 
         J     EDMAUD4                                                          
                                                                                
EDMAUD3  MVC   TEMP2(2),STCUSER                                                 
         XC    X#SVUID(X#SVULQ),X#SVUID                                         
         MVC   X#SVUID,TEMP2                                                    
         GOTOR (#GETUSR,AGETUSR)                                                
         JNE   EDMAUD4                                                          
         MVC   ED_AUUSR,TEMP2                                                   
         MVC   X#SVUSR,TEMP2                                                    
                                                                                
EDMAUD4  LLC   RE,STCLN                                                         
         SHI   RE,STCLN1Q                                                       
         SHI   RE,1                                                             
         LTR   RE,RE                                                            
         JM    EDMAUD5                                                          
         BASR  R1,0                                                             
         MVC   ED_AUTXT(0),STCESCO                                              
         EX    RE,0(R1)                                                         
                                                                                
EDMAUD5  GOTOR LP_APUTO,LP_D       send data for this STC element               
                                                                                
EDMAUDX  J     EXITY                                                            
         DROP  R3                                                               
***********************************************************************         
* Edit new style audit into old style                                 *         
***********************************************************************         
         SPACE 1                                                                
         USING STCELD,R3                                                        
EDANEW   NTR1  LABEL=NO                                                         
                                                                                
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                               ** Only include changes we want **              
         CLI   STCETY2,STCEAEA     Estimate added                               
         JE    EDAN02                                                           
         CLI   STCETYP,STCECHG     All these must be change only                
         JNE   EDANX                                                            
         CLI   STCETY2,STCEESN     Estimate name change                         
         JE    EDAN08                                                           
         CLI   STCETY2,STCEINO     Estimate internal use on                     
         JE    EDAN08                                                           
         CLI   STCETY2,STCEINF     Estimate internal use off                    
         JE    EDAN08                                                           
         CLI   STCETY2,STCESTA     Estimate status change                       
         JE    EDAN10                                                           
         J     EDANX                                                            
*                                                                               
EDAN02   MVI   ED_AUFRS,C'*'       * to indicate added                          
         MVI   ED_AUTOS,C'C'                                                    
         J     EDAN20                                                           
*                                                                               
EDAN08   J     EDANX               Skip internal use/name change                
*                                                                               
EDAN10   LA    R1,EDTTAB           Estimate status change                       
         MVI   ED_AUFRS,C'*'       Dummy values in case bad data                
         MVI   ED_AUTOS,C'*'                                                    
*                                                                               
EDAN11   CLI   0(R1),X'FF'                                                      
         JE    EDAN20                                                           
         CLC   STCECES,1(R1)       Current estimate status                      
         JNE   *+10                                                             
         MVC   ED_AUTOS,0(R1)                                                   
         CLC   STCEPES,1(R1)       Previous estimate status                     
         JNE   *+10                                                             
         MVC   ED_AUFRS,0(R1)                                                   
         AHI   R1,EDTTABQ                                                       
         J     EDAN11                                                           
*                                                                               
EDAN20   MVI   ED_RTYPE,ED_RTAUQ   indicate STC data returned                   
                                                                                
         CLC   STCPERS,X#SVPID                                                  
         JNE   EDAN22                                                           
         MVC   ED_AUPID,X#SVPCD                                                 
         MVC   ED_AUPER,X#SVPFN                                                 
         MVC   ED_AUPEL,X#SVPLN                                                 
         J     EDAN24                                                           
                                                                                
EDAN22   MVC   TEMP2(2),STCPERS                                                 
         XC    X#SVPID(X#SVPLQ),X#SVPID                                         
         MVC   X#SVPID,TEMP2                                                    
         GOTOR (#GETPID,AGETPID)                                                
         JNE   EDAN24                                                           
         MVC   ED_AUPID,TEMP2                                                   
         MVC   X#SVPCD,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   EDAN24                                                           
         MVC   ED_AUPER,TEMP2                                                   
         MVC   ED_AUPEL,TEMP2+16                                                
         MVC   X#SVPFN,TEMP2                                                    
         MVC   X#SVPLN,TEMP2+16                                                 
                                                                                
EDAN24   MVC   ED_AUDTE,STCDATE                                                 
         UNPK  DUB2,STCTIME                                                     
         OI    DUB2+7,C'0'                                                      
         MVC   ED_AUTIM,DUB2+2                                                  
                                                                                
         CLC   X#SVUID,STCUSER                                                  
         JNE   EDAN26                                                           
         MVC   ED_AUUSR,X#SVUSR                                                 
         J     EDAN28                                                           
*                                                                               
EDAN26   MVC   TEMP2(2),STCUSER                                                 
         XC    X#SVUID(X#SVULQ),X#SVUID                                         
         MVC   X#SVUID,TEMP2                                                    
         GOTOR (#GETUSR,AGETUSR)                                                
         JNE   EDAN24                                                           
         MVC   ED_AUUSR,TEMP2                                                   
         MVC   X#SVUSR,TEMP2                                                    
*                                                                               
EDAN28   GOTOR LP_APUTO,LP_D       send data for this STC element               
                                                                                
EDANX    J     EXITY                                                            
         DROP  R3                                                               
***********************************************************************         
* Edit out Source information on Estimate/Display                     *         
***********************************************************************         
                                                                                
EDMSRC   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*EDMSRC*'                                                      
                                                                                
         LA    R0,OVALUES                                                       
         LHI   R1,OVALUESL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         USING EMSELD,R3                                                        
         MVI   ED_RTYPE,ED_RTSMQ   indicate source (merge) data                 
         MVC   ED_SMEST,EMSEST                                                  
         MVI   ED_SMBAS,NOQ                                                     
         TM    EMSIND,EMSIBQ                                                    
         JZ    EDMSRC2                                                          
         MVI   ED_SMBAS,YESQ                                                    
                                                                                
EDMSRC2  TM    EMSIND,EMSICQ                                                    
         JZ    EDMSRC4                                                          
         MVI   ED_SMBAS,C'C'       (or copy)                                    
                                                                                
EDMSRC4  GOTOR LP_APUTO,LP_D       send data for this STC element               
                                                                                
EDMSRCX  J     EXITY                                                            
         DROP  R3                                                               
                                                                                
***********************************************************************         
* Get SJ account names (supports foreign)                             *         
***********************************************************************         
                                                                                
GETSJN   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETSJN*'                                                      
                                                                                
         MVC   X#CLIC,ED_MCLIC                                                  
         MVC   X#PROC,ED_MPROC                                                  
         MVC   X#JOBC(L'ED_MJOBC),ED_MJOBC                                      
                                                                                
         MVC   X#CLINM,SPACES                                                   
         MVC   X#CLIPN,SPACES                                                   
         MVC   X#PRONM,SPACES                                                   
         MVC   X#PROPN,SPACES                                                   
         MVC   X#JOBNM,SPACES                                                   
         MVI   X#JOBDS,C' '                                                     
         MVC   X#SJAD1(5*L'ADRADD1),SPACES                                      
                                                                                
         USING ACTRECD,R2          READ CLIENT                                  
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),PRODUL                                                
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   ACTKACT(0),TEMP                                                  
         EX    RF,0(R1)                                                         
                                                                                
         MVC   CSVKEY3,ACTKEY                                                   
                                                                                
         LA    R3,X#CLINM                                                       
         GOTOR GETNAM                                                           
                                                                                
         CLC   X#PROC,SPACES                                                    
         JNH   GETSJNX                                                          
                                                                                
         LA    R2,IOKEY            READ PRODUCT                                 
         MVC   ACTKEY,CSVKEY3                                                   
         LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RF,RE                                                            
         LA    R3,TEMP(RE)                                                      
         LA    RE,ACTKACT(RE)                                                   
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,RE),0(R3)                                                    
         EX    RF,0(R1)                                                         
         MVC   CSVKEY3,ACTKEY                                                   
                                                                                
         LA    R3,X#PRONM                                                       
         GOTOR GETNAM                                                           
                                                                                
         CLC   X#JOBC,SPACES                                                    
         JNH   GETSJNX                                                          
                                                                                
         LA    R2,IOKEY            READ JOB                                     
         MVC   ACTKEY,CSVKEY3                                                   
         LLC   RE,PPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         SR    RF,RE                                                            
         CHI   RF,L'ESTKJOB                                                     
         JNH   *+8                                                              
         LHI   RF,L'ESTKJOB                                                     
         LA    R3,TEMP(RE)                                                      
         LA    RE,ACTKACT(RE)                                                   
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,RE),0(R3)                                                    
         EX    RF,0(R1)                                                         
                                                                                
         LA    R3,X#JOBNM                                                       
         GOTOR GETNAM                                                           
                                                                                
         L     R1,AIO3             job draft status                             
         MVI   X#JOBDS,NOQ                                                      
         TM    ACTRSTAT-ACTRECD(R1),ACTSDRFT                                    
         JZ    *+8                                                              
         MVI   X#JOBDS,YESQ                                                     
                                                                                
         MVI   X#JOBDL,NOQ                                                      
         TM    ACTRSTAT-ACTRECD(R1),ACTSLOCK                                    
         JZ    GETSJN02                                                         
         MVI   X#JOBDL,YESQ                                                     
                                                                                
GETSJN02 XR    RF,RF               For Aura check whether job is closed         
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JNE   GETSJNX                                                          
         TM    ACTRSTAT-ACTRECD(R1),ACTSCLOS                                    
         JZ    GETSJNX                                                          
         MVI   X#JOBDL,C'C'        Set C for closed                             
                                                                                
GETSJNX  DS    0H                                                               
         J     EXIT                                                             
                                                                                
GETNAM   ST    RE,SAVERE                                                        
                                                                                
         MVC   TEMP2(L'ACTKULA),IOKEY+ACTKULA-ACTRECD                           
         GOTOR (#GETACN,AGETACN)                                                
         MVC   0(36,R3),TEMP2                                                   
         MVC   36(36,R3),TEMP2+40                                               
                                                                                
         L     R2,AIO3                                                          
         AHI   R2,ACTRFST-ACTRECD                                               
         USING ASTELD,R2                                                        
GETNAM2  CLI   ASTEL,ADRELQ                                                     
         JE    GETNAM8                                                          
         CLI   ASTEL,RSTELQ                                                     
         JE    GETNAM12                                                         
         CLI   ASTEL,0                                                          
         JE    GETNAMX                                                          
                                                                                
GETNAM4  LLC   R0,ASTLN                                                         
         AR    R2,R0                                                            
         J     GETNAM2                                                          
                                                                                
         USING ADRELD,R2                                                        
GETNAM8  MVC   X#SJAD1(5*L'ADRADD1),SPACES                                      
         LLC   R0,ADRNUM                                                        
         LTR   R0,R0                                                            
         JZ    GETNAM4                                                          
         LA    RF,ADRADD1                                                       
         LA    R1,X#SJAD1                                                       
GETNAM10 MVC   0(L'ADRADD1,R1),0(RF)                                            
         AHI   R1,L'ADRADD1                                                     
         AHI   RF,L'ADRADD1                                                     
         JCT   R0,GETNAM10                                                      
         J     GETNAM4                                                          
                                                                                
         USING RSTELD,R2                                                        
GETNAM12 CLI   RSTLN,RSTLN3Q                                                    
         JL    GETNAM4                                                          
         MVC   X#SJLKF,RSTLSTAT                                                 
         J     GETNAM4                                                          
                                                                                
GETNAMX  L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  R2                                                               
                                                                                
         EJECT                                                                  
***********************************************************************         
* Estimate List/Reconcile - module to validate SJ account             *         
***********************************************************************         
                                                                                
ELMCPJ   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ELMCPJ*'                                                      
                                                                                
         MVI   X#CPJJL,NOQ                                                      
         MVC   X#CPJLI(3),SPACES                                                
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),PRODUL                                                
         MVC   ACTKACT(L'X#CLIC),X#CLIC                                         
                                                                                
         MVC   CSVKEY3,ACTKEY                                                   
                                                                                
         LA    R3,X#CPJLI+0                                                     
         GOTOR GETACT                                                           
         JNE   ELMCPJN                                                          
                                                                                
         CLC   X#PROC,SPACES                                                    
         JNH   ELMCPJ2                                                          
                                                                                
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,CSVKEY3                                                   
         LLC   RE,PCLILEN                                                       
         LA    RE,ACTKACT(RE)                                                   
*&&UK*&& MVC   0(2,RE),X#PROC                                                   
*&&US*&& MVC   0(L'X#PROC,RE),X#PROC                                            
                                                                                
         MVC   CSVKEY3,ACTKEY                                                   
                                                                                
         LA    R3,X#CPJLI+1                                                     
         GOTOR GETACT                                                           
         JNE   ELMCPJN                                                          
                                                                                
         CLC   X#JOBC,SPACES                                                    
         JNH   ELMCPJ2                                                          
                                                                                
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,CSVKEY3                                                   
         LLC   RE,PPROLEN                                                       
         LA    RF,L'ACTKACT-1                                                   
         LA    RE,ACTKACT(RE)                                                   
         MVC   0(6,RE),X#JOBC                                                   
                                                                                
         MVC   CSVKEY3,ACTKEY                                                   
                                                                                
         LA    R3,X#CPJLI+2                                                     
         GOTOR GETACT                                                           
         JNE   ELMCPJN                                                          
                                                                                
         MVI   X#CPJJL,YESQ                                                     
                                                                                
ELMCPJ2  MVI   BYTE1,NOQ           C/P/J validated - check for data             
         CLI   X#CPJLI+2,YESQ                                                   
         JE    ELMCPJ4                                                          
         CLI   X#CPJLI+2,NOQ                                                    
         JE    ELMCPJY                                                          
         CLI   X#CPJLI+1,YESQ                                                   
         JE    ELMCPJ4                                                          
         CLI   X#CPJLI+1,NOQ                                                    
         JE    ELMCPJY                                                          
         CLI   X#CPJLI+0,YESQ                                                   
         JE    ELMCPJ4                                                          
         J     ELMCPJY                                                          
                                                                                
ELMCPJ4  MVI   BYTE4,YESQ                                                       
                                                                                
ELMCPJY  J     EXITY                                                            
                                                                                
ELMCPJN  J     EXITN                                                            
                                                                                
                                                                                
GETACT   NTR1                                                                   
                                                                                
         MVI   0(R3),NOQ                                                        
         MVC   ROUERRV,=AL2(AE$ACTNF)                                           
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   EXITN                                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   EXITN                                                            
                                                                                
         USING RSTELD,RF                                                        
         L     R2,AIO3                                                          
         LA    RF,ACTRFST                                                       
GETACT2  CLI   RSTEL,0                                                          
         JE    EXITY                                                            
         CLI   RSTEL,RSTELQ                                                     
         JE    GETACT8                                                          
         CLI   RSTEL,PPRELQ                                                     
         JE    GETACT6                                                          
GETACT4  LLC   R0,RSTLN                                                         
         AR    RF,R0                                                            
         J     GETACT2                                                          
                                                                                
         USING PPRELD,RF                                                        
GETACT6  CLC   PPRGAOFF,SPACES                                                  
         JNH   GETACT4                                                          
         MVC   X#CUROF,PPRGAOFF        Save production office                   
         J     GETACT4                                                          
                                                                                
         USING RSTELD,RF                                                        
GETACT8  CLI   RSTLN,RSTLN3Q                                                    
         JL    EXITY                                                            
         TM    RSTSTAT6,RSTSMCSE   any estimates existing?                      
         JZ    EXITY                                                            
         MVI   0(R3),YESQ                                                       
         J     EXITY                                                            
         DROP  R2,RF                                                            
                                                                                
         EJECT                                                                  
                                                                                
***********************************************************************         
* Estimate List - module to valid status                              *         
***********************************************************************         
                                                                                
ELMSTA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ELMSTA*'                                                      
                                                                                
         USING LW_D,R3                                                          
         XR    R3,R3               Point to list in WMP                         
         ICM   R3,7,RQ_ELSAD                                                    
         XR    R4,R4                                                            
         TM    LW_TYPE,LW_TLSTQ    Test list of values                          
         JNZ   ELMSTA00                                                         
         TM    LW_TYPE,LW_TSINQ    Test single value (GAOV call)                
         JZ    *+2                 What else?                                   
         LA    R3,LW_DATA1                                                      
         LA    R4,1                                                             
         J     ELMSTA01                                                         
ELMSTA00 ICM   R4,3,LW_NUMN        Number of status entries                     
         LA    R3,LW_DATA2         Start of list                                
ELMSTA01 STC   R4,X#NOSTA                                                       
         LTR   R4,R4               Any entries                                  
         JZ    ELMSTA06                                                         
         LA    R2,X#SSTAT                                                       
         USING STATABD,RF                                                       
ELMSTA02 LA    RF,STATAB                                                        
ELMSTA04 CLI   0(RF),C'*'                                                       
         JE    ELMSTA06                                                         
         CLC   0(L'STACHAR,R3),STACHAR                                          
         JE    ELMSTA08                                                         
         AHI   RF,STATABL                                                       
         J     ELMSTA04                                                         
                                                                                
ELMSTA06 MVC   ROUERRV,=AL2(AE$STAIN)                                           
         J     ELMSTAN                                                          
                                                                                
ELMSTA08 MVC   0(STATABL,R2),STASTA1                                            
         MVC   L'STASTA1+L'STASTA2(L'STAAPPV,R2),RQ_ELAPP                       
         LA    R3,L'STACHAR(R3)    Bump to next data entry                      
         LA    R2,STATABL(R2)                                                   
         JCT   R4,ELMSTA02                                                      
         LLC   R4,X#NOSTA          R4=number of entries                         
* Sort status table by status byte 1                                            
         GOTO1 VXSORT,DMCB,(X'00',X#SSTAT),(R4),STATABL,L'STASTA1,0             
                                                                                
ELMSTAY  J     EXITY                                                            
                                                                                
ELMSTAN  J     EXITN                                                            
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
* Estimate Search - validate MEDIA                                    *         
***********************************************************************         
                                                                                
ESVMED   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVMED*'                                                      
                                                                                
         STC   R1,BYTE1                                                         
                                                                                
         USING PMDRECD,R2                                                       
         LA    R2,IOKEY            read media code record                       
         MVC   PMDKEY,SPACES                                                    
         MVI   PMDKTYP,PMDKTYPQ                                                 
         MVC   PMDKCPY,CUXCPY                                                   
         MVC   PMDKMED,TEMP2                                                    
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    ESVMED00                                                         
         MVC   ROUERRV,=AL2(AE$MCINV)                                           
         J     ESVMEDN                                                          
                                                                                
ESVMED00 CLI   BYTE1,0                                                          
         JE    ESVMEDY                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   ESVMEDY                                                          
         L     R2,AIO3                                                          
         LA    RF,PMDRFST                                                       
         USING PMDELD,RF                                                        
ESVMED02 CLI   PMDEL,PMDELQ                                                     
         JE    ESVMED04                                                         
         CLI   PMDEL,0                                                          
         JE    ESVMEDY                                                          
         LLC   R0,PMDLN                                                         
         AR    RF,R0                                                            
         J     ESVMED02                                                         
                                                                                
ESVMED04 MVC   X#TEMP(L'PMDDESC),PMDDESC                                        
                                                                                
ESVMEDY  J     EXITY                                                            
                                                                                
ESVMEDN  J     EXITN                                                            
                                                                                
         DROP  R2                                                               
                                                                                
         EJECT                                                                  
***********************************************************************         
* GET APPROVERS                                                       *         
***********************************************************************         
                                                                                
GETAPP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETAPP*'                                                      
                                                                                
         LM    R3,R4,0(R1)                                                      
         MVI   X#BYTE1,0                                                        
         MVI   X#BYTE2,0                                                        
P        USING ACTKACT,R3                                                       
                                                                                
GETAPP00 LA    R2,APRTABL                                                       
         USING APRTABD,R2                                                       
SJ       USING JOBPASD,IOKEY                                                    
GETAPP02 XC    SJ.JOBPAS,SJ.JOBPAS Look for Cli/Pro job appr passive            
         MVI   SJ.JOBPTYP,JOBPTYPQ                                              
         MVI   SJ.JOBPSUB,JOBPSUBQ                                              
         MVC   SJ.JOBPCPY,CUXCPY                                                
         MVI   SJ.JOBPAPPL,JOBPAEST                                             
         CLI   X#BYTE1,1                                                        
         JNE   *+8                                                              
         MVI   SJ.JOBPAPPL,JOBPAESI                                             
         MVI   SJ.JOBPVIEW,JOBPVOFF                                             
         MVC   SJ.JOBPCPJ,SPACES                                                
         MVC   SJ.JOBPCOFF,SPACES                                               
         MVC   SJ.JOBPCMED,SPACES                                               
         OC    APRSTAT,APRSTAT                                                  
         JNZ   GETAPP03                                                         
         MVI   SJ.JOBPCODE,X'FF'                                                
         MVC   SJ.JOBPCODE+1(L'JOBPCODE-1),SJ.JOBPCODE                          
         J     GETAPP12                                                         
                                                                                
GETAPP03 TM    APRSTAT,APRJOB                                                   
         JZ    GETAPP04                                                         
         LLC   RF,PPROLEN                                                       
         LA    RF,P.ACTKACT(RF)                                                 
         CLI   0(RF),X'40'         Have we got a product                        
         JNH   GETAPP20            No                                           
         LLC   RF,PJOBLEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJ.JOBPCPJ(0),P.ACTKACT                                          
         EX    RF,0(RE)                                                         
         J     GETAPP08                                                         
                                                                                
GETAPP04 TM    APRSTAT,APRPRO                                                   
         JZ    GETAPP06                                                         
         LLC   RF,PCLILEN                                                       
         LA    RF,P.ACTKACT(RF)                                                 
         CLI   0(RF),X'40'         Have we got a product                        
         JNH   GETAPP20            No                                           
         LLC   RF,PPROLEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJ.JOBPCPJ(0),P.ACTKACT                                          
         EX    RF,0(RE)                                                         
         J     GETAPP08                                                         
                                                                                
GETAPP06 TM    APRSTAT,APRCLI                                                   
         JZ    GETAPP08                                                         
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJ.JOBPCPJ(0),P.ACTKACT                                          
         EX    RF,0(RE)                                                         
                                                                                
GETAPP08 TM    APRSTAT,APRMED                                                   
         JZ    GETAPP10                                                         
         CLC   X#MEDC,SPACES                                                    
         JNH   GETAPP20                                                         
         MVC   SJ.JOBPCMED,X#MEDC                                               
                                                                                
GETAPP10 TM    APRSTAT,APROFF                                                   
         JZ    GETAPP12                                                         
         CLC   0(L'TRNOFFC,R4),SPACES                                           
         JNH   GETAPP20                                                         
         MVC   SJ.JOBPCOFF,0(R4)                                                
                                                                                
GETAPP12 OC    SJ.JOBPCODE,SPACES                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     GETAPP16                                                         
                                                                                
GETAPP14 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
GETAPP16 CLC   SJ.JOBPAS(JOBPPIDB-JOBPASD),IOKEYSAV                             
         JE    GETAPP22                                                         
                                                                                
GETAPP20 LA    R2,APRTABLQ(R2)                                                  
         CLI   0(R2),X'FF'                                                      
         JNE   GETAPP02                                                         
         CLI   X#BYTE1,1                                                        
         JE    GETAPPX                                                          
         MVI   X#BYTE1,1                                                        
         J     GETAPP00                                                         
                                                                                
GETAPP22 CLI   X#BYTE1,1                                                        
         JNE   *+12                                                             
         OI    X#BYTE2,X'80'       mark internal approver found                 
         J     GETAPP24                                                         
         OI    X#BYTE2,X'08'       mark client approver found                   
                                                                                
GETAPP24 CLC   SJ.JOBPPIDB,CCTPID  Is this approver the correct one             
         JNE   GETAPP14                                                         
         CLI   X#BYTE1,1                                                        
         JNE   *+12                                                             
         OI    X#BYTE2,X'40'       connected user is valid internal app         
         J     GETAPPX                                                          
         OI    X#BYTE2,X'04'       connected user is valid client app           
         MVI   X#BYTE1,1                                                        
         J     GETAPP02                                                         
                                                                                
GETAPPX  J     EXITY                                                            
         DROP  P,SJ,R2                                                          
***********************************************************************         
* Currency conversion on revaluation                                  *         
***********************************************************************         
                                                                                
CURCON   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CURCON*'                                                      
                                                                                
         USING EURKBLKD,R4                                                      
         ZAP   DUB1,PZERO          return new amount in DUB1                    
         ZAP   DUB2,0(6,R1)        and save incomming amount                    
                                                                                
         CP    DUB2,PZERO          skip if zero                                 
         JE    CURCONX                                                          
                                                                                
         LAY   R4,X#EURBLK                                                      
                                                                                
         GOTO1 VEUREKA,DMCB,('APPLYQ',EURKBLKD),DUB2,DUB1                       
         CLI   0(R1),0                                                          
         JE    CURCON2             DUMP AS RATE NOT APPLIED                     
         ZAP   DUB1,PZERO                                                       
                                                                                
CURCON2  DS    0H                                                               
                                                                                
CURCONX  J     EXITY                                                            
         DROP  R4                                                               
                                                                                
         EJECT                                                                  
***********************************************************************         
* Check current item for status and price                             *         
***********************************************************************         
                                                                                
CHKITM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CHKITM*'                                                      
                                                                                
         MVC   X#IRSTA,ASTERS                                                   
         XC    FULL1,FULL1                                                      
         XC    FULL2,FULL2                                                      
         XC    X#UNIT(L'X#UNIT+L'X#UNLA),X#UNIT                                 
                                                                                
         USING ERDELD,R1                                                        
         MVC   BYTE1,ERDIIND                                                    
         CLC   ERDICOD,SPACES                                                   
         JE    CHKITMX                                                          
                                                                                
         USING PASRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    PASKEY,PASKEY                                                    
         MVI   PASKTYP,PASKTYPQ                                                 
         MVI   PASKSUB,PASKSQ                                                   
         MVC   PASKCPY,CUXCPY                                                   
         MVC   PASKSEQ,ERDISEQ                                                  
         DROP  R1                                                               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    CHKITM05                                                         
         MVI   X#IRSTA,C'X'        not existing                                 
         J     CHKITMX                                                          
                                                                                
CHKITM05 TM    X#DISTYP,X#DISRVQ   checks on revalue only                       
         JZ    CHKITM20                                                         
         TM    PASKSTAT,ARTKLOCK                                                
         JZ    CHKITM10                                                         
         MVI   X#IRSTA,C'L'        locked                                       
         J     CHKITMX                                                          
                                                                                
CHKITM10 TM    PASKSTAT,ARTKFLXQ+ARTKNOPQ                                       
         JZ    CHKITM15                                                         
         MVI   X#IRSTA,C'N'        no fixed price anymore                       
         J     CHKITMX                                                          
                                                                                
CHKITM15 CLC   PASKSWC,SPACES                                                   
         JNH   CHKITM20                                                         
         CLC   X#CURWC,PASKSWC                                                  
         JE    CHKITM20                                                         
         MVI   X#IRSTA,C'W'        different work code                          
         J     CHKITMX                                                          
                                                                                
CHKITM20 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         USING ARTRECD,R2                                                       
         L     R2,AIO3                                                          
         USING SCMELD,R3                                                        
         LA    R3,ARTRFST                                                       
CHKITM22 CLI   SCMEL,0             Look for text entries                        
         JE    CHKITM28                                                         
         CLI   SCMEL,SCMELQ                                                     
         JNE   CHKITM24                                                         
         LA    RE,FULL1                                                         
         TM    SCMSEQ,SCMSEQLQ     Language entry?                              
         JZ    CHKITM23                                                         
         LA    RE,FULL2                                                         
                                                                                
CHKITM23 ST    R3,0(RE)                                                         
         J     CHKITM26                                                         
                                                                                
         USING AFDELD,R3                                                        
CHKITM24 CLI   AFDEL,AFDELQ                                                     
         JNE   CHKITM26                                                         
         CLI   AFDLN,AFDLNXQ                                                    
         JL    CHKITM26                                                         
         MVC   X#UNIT,AFDUNIT                                                   
         MVC   X#UNLA,AFDUNLA                                                   
                                                                                
         USING SCMELD,R3                                                        
CHKITM26 LLC   R0,SCMLN                                                         
         AR    R3,R0                                                            
         J     CHKITM22                                                         
                                                                                
         USING PRIELD,R3                                                        
CHKITM28 TM    BYTE1,ERDIIFQ+ERDIIPQ+ERDIIOQ                                    
         JNZ   CHKITMX                                                          
         TM    X#DISTYP,X#DISRVQ   skip if not revalue                          
         JZ    CHKITMX                                                          
         LA    R3,ARTRFST                                                       
         XC    TEMP2(9),TEMP2                                                   
                                                                                
CHKITM30 CLI   PRIEL,0                                                          
         JE    CHKITM40                                                         
         CLI   PRIEL,PRIELQ                                                     
         JNE   CHKITM35                                                         
         CLC   PRIDAT,XL#TODP                                                   
         JH    CHKITM35                                                         
         ZAP   TEMP2(6),PRIAMT     check for right date                         
         MVC   TEMP2+6(3),PRICURR                                               
                                                                                
CHKITM35 LLC   R0,PRILN                                                         
         AR    R3,R0                                                            
         J     CHKITM30                                                         
                                                                                
CHKITM40 OC    TEMP2(9),TEMP2      any match?                                   
         JNZ   CHKITM45                                                         
         MVI   X#IRSTA+1,C'N'      no price found                               
         J     CHKITMX                                                          
                                                                                
CHKITM45 CLC   TEMP2+6(3),AGYCURR  item in agency currency                      
         JE    CHKITM50                                                         
         CLC   TEMP2+6(3),X#ESTCC  item in foreign currency                     
         JE    CHKITM60                                                         
         MVI   X#IRSTA+1,C'C'      different currencies - assume                
         J     CHKITMX             other price                                  
                                                                                
CHKITM50 MVI   X#IRSTA+1,C'A'      agency price found                           
         MVI   X#IRSTA+2,C'Y'      same price                                   
         CP    ED_IAPRI,TEMP2(6)                                                
         JE    CHKITMX                                                          
         MVI   X#IRSTA+2,C'N'      different price                              
         J     CHKITMX                                                          
                                                                                
CHKITM60 MVI   X#IRSTA+1,C'F'      foreign price found                          
         MVI   X#IRSTA+2,C'Y'      same price                                   
         CP    ED_IFPRI,TEMP2(6)                                                
         JE    CHKITMX                                                          
         MVI   X#IRSTA+2,C'N'      different price                              
                                                                                
CHKITMX  J     EXITY                                                            
         DROP  R2,R3                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
* Estimate Search - validate CLI/PRO/JOB                              *         
***********************************************************************         
                                                                                
ESVCPJ   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVCPJ*'                                                      
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES       check client                                 
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),PRODUL                                                
         MVC   ACTKACT(L'RQ_ESCLI),RQ_ESCLI                                     
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    ESVCPJ05                                                         
         MVC   ROUERRV,=AL2(AE$INCLI)                                           
         J     ESVCPJL                                                          
                                                                                
ESVCPJ05 MVC   X#CPMJ(L'RQ_ESCLI),RQ_ESCLI                                      
         MVC   X#CPJL,PCLILEN                                                   
         GOTOR GETOFF                                                           
                                                                                
         CLC   RQ_ESPRO,SPACES     check product                                
         JE    ESVCPJ50                                                         
                                                                                
         MVI   X#CPMJ+CPLQ,C' '                                                 
                                                                                
         LLC   R1,PCLILEN                                                       
         LA    R1,ACTKACT(R1)                                                   
         MVC   0(L'RQ_ESPRO,R1),RQ_ESPRO                                        
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    ESVCPJ10                                                         
         MVC   ROUERRV,=AL2(AE$INPRO)                                           
         J     ESVCPJL                                                          
                                                                                
ESVCPJ10 GOTOR GETOFF                                                           
         MVC   X#CPMJ+CLLQ(L'RQ_ESPRO),RQ_ESPRO                                 
         MVC   X#CPJL,PPROLEN                                                   
                                                                                
         CLC   RQ_ESJOB,SPACES     check job                                    
         JNE   ESVCPJ15                                                         
         CLI   X#MEDNO,1           Don't set media code if more than            
         JNE   ESVCPJ50                                           one           
         MVC   X#CPMJ+CPLQ(1),X#MEDLS Set media code                            
         J     ESVCPJ50                                                         
                                                                                
ESVCPJ15 LLC   R1,PPROLEN                                                       
         LA    R1,ACTKACT(R1)                                                   
         MVC   0(6,R1),RQ_ESJOB                                                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    ESVCPJ20                                                         
         MVC   ROUERRV,=AL2(AE$INJOB)                                           
         J     ESVCPJL                                                          
                                                                                
ESVCPJ20 MVC   X#CPMJ+CPLQ(6),RQ_ESJOB                                          
         MVC   X#CPJL,PJOBLEN                                                   
                                                                                
         CLI   X#MEDLS,C' '                                                     
         JNH   ESVCPJ25                                                         
         CLC   X#MEDLS(L'PMDKMED),RQ_ESJOB                                      
         JE    ESVCPJ25                                                         
         MVC   ROUERRV,=AL2(AE$DIOPT)                                           
         J     ESVCPJL                                                          
                                                                                
ESVCPJ25 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         USING RSTELD,R3                                                        
         L     R2,AIO3             if job passed check for data                 
         LA    R3,ACTRFST                                                       
ESVCPJ30 CLI   RSTEL,RSTELQ                                                     
         JE    ESVCPJ45                                                         
         CLI   RSTEL,PPRELQ                                                     
         JNE   ESVCPJ32                                                         
         CLC   PPRGAOFF-PPRELD(L'PPRGAOFF,R3),SPACES                            
         JNH   ESVCPJ32                                                         
         MVC   X#SJOFF,PPRGAOFF-PPRELD(R3) extract office if it exists          
*                                                                               
ESVCPJ32 CLI   RSTEL,0                                                          
         JNE   ESVCPJ40                                                         
                                                                                
ESVCPJ35 XR    RF,RF               If aura don't error just exit                
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JE    ESVCPJH                                                          
         MVC   ROUERRV,=AL2(AE$NEOFJ) no estimate on file for this job          
         J     ESVCPJL                                                          
                                                                                
ESVCPJ40 LLC   R0,RSTLN                                                         
         AR    R3,R0                                                            
         J     ESVCPJ30                                                         
                                                                                
ESVCPJ45 CLI   RSTLN,RSTLN3Q                                                    
         JL    ESVCPJ35                                                         
         TM    RSTSTAT6,RSTSMCSE                                                
         JZ    ESVCPJ35                                                         
                                                                                
ESVCPJ50 CLI   X#KTYPE,C' '        type already set?                            
         JH    ESVCPJ55                                                         
         MVI   X#KTYPE,C'C'        read by C/P/J                                
*                                  Check limlist security                       
GAP      USING GAPTABD,GAPAREA                                                  
ESVCPJ55 CLI   RQ_ESOVR,YESQ       Override LimList?                            
         JE    ESVCPJ90                                                         
         TM    X#LLUIND,X#LLUICQ+X#LLUIMQ Any limlist in use?                   
         JZ    ESVCPJ90                                                         
*                                  Read back from TSAR check security           
         MVI   X#BYTE1,0                                                        
*                                                                               
         XC    GAPAREA,GAPAREA                                                  
         XC    ATSRERRS,ATSRERRS                                                
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         J     ESVCPJ65                                                         
*                                                                               
ESVCPJ60 GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
*                                                                               
ESVCPJ65 TM    ATSRERRS,TSEEOF      Hit the end?                                
         JZ    ESVCPJ70                                                         
         TM    X#BYTE1,X#LCPJQ+X#LMEDQ Passed CPJ and media filtering?          
         JO    ESVCPJY                                                          
         J     ESVCPSL                                                          
*                                                                               
ESVCPJ70 CLI   GAP.GAPTDAT1,GAPTT2Q SJ entry                                    
         JNE   ESVCPJ85                                                         
         TM    X#LLUIND,X#LLUICQ   SJ limlist in use?                           
         JZ    ESVCPJ82            if not set limlist filtering pass            
         CLC   GAP.GAPTCODE,SPACES All access entry then ok                     
         JH    *+14                                                             
         CLC   GAP.GAPTCOFF,SPACES Any office?                                  
         JNH   ESVCPJ80                                                         
*                                                                               
         LA    R4,GAP.GAPTACC                                                   
         LLC   R1,PCLILEN          Determine limlist entry level                
         LR    RF,R1                                                            
         AR    RF,R4                                                            
         CLI   0(RF),C' '                                                       
         JNH   ESVCPJ75                                                         
         LLC   R1,PPROLEN                                                       
         LR    RF,R1                                                            
         AR    RF,R4                                                            
         CLI   0(RF),C' '                                                       
         JNH   ESVCPJ75                                                         
         LLC   R1,PJOBLEN                                                       
*                                                                               
ESVCPJ75 LLC   RF,X#CPJL                                                        
         CR    R1,RF                                                            
         JNH   *+6                                                              
         LR    R1,RF                                                            
         BCTR  R1,0                                                             
         BASR  RF,0                                                             
         CLC   GAP.GAPTACC(0),ACTKACT  Match on SJ account code                 
         EX    R1,0(RF)                                                         
         JNE   ESVCPJ60                                                         
*                                                                               
ESVCPJ80 CLC   GAP.GAPTCOFF,SPACES  Check office code                           
         JNH   *+14                                                             
         CLC   GAP.GAPTCOFF,X#SJOFF                                             
         JNE   ESVCPJ60                                                         
ESVCPJ82 OI    X#BYTE1,X#LCPJQ      Set CPJ limlist found                       
         J     ESVCPJ60                                                         
*                                                                               
ESVCPJ85 CLI   GAP.GAPTDAT1,GAPTT5Q media entry                                 
         JNE   ESVCPJ60                                                         
         TM    X#LLUIND,X#LLUIMQ    media limlist in use?                       
         JZ    ESVCPJ88                                                         
         CLC   GAP.GAPTCODE,SPACES  All access entry then ok                    
         JNH   ESVCPJ88                                                         
         CLC   RQ_ESJOB,SPACES      Any job code?                               
         JNH   ESVCPJ88                                                         
         CLC   GAP.GAPTMEDI,RQ_ESJOB                                            
         JNE   ESVCPJ60                                                         
ESVCPJ88 OI    X#BYTE1,X#LMEDQ                                                  
         J     ESVCPJ60                                                         
*                                   Media filtering                             
ESVCPJ90 DS    0H                                                               
         J     EXITY                                                            
                                                                                
ESVCPSL  MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     ESVCPJL                                                          
                                                                                
ESVCPJY  J     EXITY                                                            
                                                                                
ESVCPJL  J     EXITL               error and exit with error                    
                                                                                
ESVCPJH  J     EXITH               error but return                             
         DROP  R2,R3,GAP                                                        
         EJECT                                                                  
X#LCPJQ  EQU   X'80'               CPJ limlist passed                           
X#LMEDQ  EQU   X'40'               job media limlist passed                     
         SPACE 1                                                                
***********************************************************************         
* Extract the SJ office code                                          *         
***********************************************************************         
         SPACE  1                                                               
GETOFF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETOFF*'                                                      
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
         USING PPRELD,R3                                                        
         L     R2,AIO3                                                          
         LR    R3,R2                                                            
         AHI   R3,ACTRFST-ACTRECD                                               
                                                                                
GETOFF02 CLI   PPREL,0                                                          
         JE    EXITY                                                            
         CLI   PPREL,PPRELQ                                                     
         JE    GETOFF04                                                         
         LLC   R0,PPRLN                                                         
         AR    R3,R0                                                            
         J     GETOFF02                                                         
                                                                                
GETOFF04 CLC   PPRGAOFF,SPACES                                                  
         JNH   EXITY                                                            
         MVC   X#SJOFF,PPRGAOFF                                                 
         OC    X#SJOFF,SPACES                                                   
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Estimate Search - validate DESCRIPTION                              *         
***********************************************************************         
                                                                                
ESVDES   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVDES*'                                                      
                                                                                
         OC    RQ_ESDES,SPACES                                                  
                                                                                
         LA    RE,RQ_ESDES+L'RQ_ESDES-1                                         
         LA    RF,L'RQ_ESDES                                                    
                                                                                
ESVDES1  CLI   0(RE),C' '                                                       
         JH    ESVDES3                                                          
         SHI   RE,1                                                             
         JCT   RF,ESVDES1                                                       
         DC    H'0'                                                             
                                                                                
ESVDES3  SHI   RF,1                                                             
         STC   RF,X#DESCL                                                       
                                                                                
ESVDESX  J     EXITY                                                            
                                                                                
***********************************************************************         
* Estimate Search - Aura name search validation                       *         
***********************************************************************         
                                                                                
ESVANS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVANS*'                                                      
                                                                                
         XC    X#ESNAMS,X#ESNAMS   initialise internal list                     
                                                                                
         OC    RQ_ESNAD,RQ_ESNAD                                                
         JZ    ESVANSY                                                          
                                                                                
         ICM   RF,B'0011',CUXPNUM                                               
         CHI   RF,XPRODIKQ                                                      
         JNE   ESVANSY                                                          
                                                                                
         LARL  R1,UINGER                                                        
         LARL  RE,TRTSPEC                                                       
         CLI   CUCTRY,CTRYGER                                                   
         JE    ESVANS0                                                          
         LARL  R1,UINUKUS                                                       
         LARL  RE,TRTSGER                                                       
                                                                                
ESVANS0  ST    R1,AUINTAB                                                       
         ST    RE,ASRCTAB                                                       
                                                                                
         USING LW_D,R1                                                          
         XR    R1,R1               point to list in WMP                         
         ICM   R1,7,RQ_ESNAD                                                    
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        number of entries                            
         STC   R0,X#ESNAM#                                                      
         LA    R5,LW_DATA2         start of list                                
         LA    R4,X#ESNAL1                                                      
         DROP  R1                                                               
                                                                                
ESVANS2  MVC   L'X#ESNAL1(L'X#ESNAM1,R4),0(R5)                                  
         L     R1,AUINTAB          translate to upper case                      
         TR    L'X#ESNAL1(L'X#ESNAM1,R4),0(R1)                                  
                                                                                
         LA    R1,L'X#ESNAL1+L'X#ESNAM1-1(R4)                                   
         LHI   R2,L'X#ESNAM1       save name and its length                     
ESVANS4  CLI   0(R1),C' '                                                       
         JH    ESVANS6                                                          
         SHI   R1,1                                                             
         JCT   R2,ESVANS4                                                       
         DC    H'0'                                                             
ESVANS6  STC   R2,0(R4)                                                         
         AHI   R5,L'X#ESNAM1                                                    
         AHI   R4,L'X#ESNAL1+L'X#ESNAM1                                         
         JCT   R0,ESVANS2                                                       
                                                                                
         GOTOR TRANS4S             translate for search                         
         CLI   X#ESNAL,0                                                        
         JH    ESVANS8                                                          
         MVC   LP_ERROR,=AL2(AE$RQNPC)                                          
         J     ESVANSN                                                          
                                                                                
ESVANS8  CLI   X#KTYPE,C'N'                                                     
         JE    ESVANSY                                                          
         MVI   X#KTYPE,C'S'        set to name search                           
                                                                                
ESVANSY  J     EXITY                                                            
                                                                                
ESVANSN  J     EXITN                                                            
                                                                                
* Apply GESRCHPARS.TRTSPEC and .TRTSGER character handling                      
                                                                                
TRANS4S  NTR1                                                                   
                                                                                
         MVC   ELEMENT(L'X#ESNAM1),X#ESNAM1                                     
         L     R3,ASRCTAB                                                       
         TR    ELEMENT(L'X#ESNAM),0(R3)                                         
                                                                                
         LHI   R0,L'X#ESNAM        now squash out any unknowns (X'00')          
         LA    RE,ELEMENT                                                       
         LA    R1,X#ESNAM                                                       
         MVC   X#ESNAM,SPACES                                                   
                                                                                
TRANS4S1 CLI   0(RE),X'40'                                                      
         JE    TRANS4S3            exit on first space                          
         JL    TRANS4S2            skip zeroes                                  
         MVC   0(1,R1),0(RE)                                                    
         AHI   R1,1                                                             
                                                                                
TRANS4S2 AHI   RE,1                                                             
         JCT   R0,TRANS4S1                                                      
                                                                                
TRANS4S3 LA    R1,X#ESNAM+L'X#ESNAM-1                                           
         LHI   R0,L'X#ESNAM                                                     
                                                                                
TRANS4S4 CLI   0(R1),X'40'                                                      
         JH    TRANS4S5                                                         
         SHI   R1,1                                                             
         JCT   R0,TRANS4S4                                                      
                                                                                
TRANS4S5 STC   R0,X#ESNAL          length + name value for SRCKWRD1 set         
         J     EXIT                                                             
                                                                                
         DS    0H                                                               
       ++INCLUDE FACTRYXLAT                                                     
                                                                                
         DS    0H                                                               
TRTSPEC  DC    256AL1(0)           TRANSLATED VALUE IS X'00', EXCEPT            
*                                                                               
         ORG   TRTSPEC+C'A'        UPPER CASE LETTERS                           
         DC    C'ABCDEFGHI'                                                     
         ORG   TRTSPEC+C'J'                                                     
         DC    C'JKLMNOPQR'                                                     
         ORG   TRTSPEC+C'S'                                                     
         DC    C'STUVWXYZ'                                                      
*                                                                               
         ORG   TRTSPEC+C'0'        UPPER CASE NUMBERS                           
         DC    C'0123456789'                                                    
*                                                                               
         ORG   TRTSPEC+C' '        SPACES STAY SAME                             
         DC    X'40'                                                            
*                                                                               
         ORG   TRTSPEC+C'*'        '*' STAYS SAME, IN CASE PARTIAL FLAG         
         DC    C'*'                                                             
*                                                                               
         ORG   TRTSPEC+C'.'        THESE SPECIAL CHARS BECOME SPACES            
         DC    X'40'               AND ARE TREATED AS WORD SEPARATORS           
         ORG   TRTSPEC+C'<'        ALL OTHERS BECOME NULLS AND ARE              
         DC    X'40'               IGNORED AS IF COMPRESSED OUT.                
         ORG   TRTSPEC+C'('                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'+'                                                     
         DC    C'+'                                                             
         ORG   TRTSPEC+C'&&'                                                    
         DC    X'40'                                                            
         ORG   TRTSPEC+C')'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C';'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'-'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'/'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C','                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'_'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'>'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C':'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'='                                                     
         DC    X'40'                                                            
*                                                                               
         ORG   ,                                                                
*                                                                               
TRTSGER  DC    256AL1(0)           TRANSLATED VALUE IS X'00', EXCEPT            
*                                                                               
         ORG   TRTSGER+C'A'        UPPER CASE LETTERS                           
         DC    C'ABCDEFGHI'                                                     
         ORG   TRTSGER+C'J'                                                     
         DC    C'JKLMNOPQR'                                                     
         ORG   TRTSGER+C'S'                                                     
         DC    C'STUVWXYZ'                                                      
*                                                                               
         ORG   TRTSGER+X'4A'       4A=U/C A UMLAUT                              
         DC    X'4A'                                                            
         ORG   TRTSGER+X'5A'       5A=U/C U UMLAUT (! IN ENGLISH)               
         DC    X'5A'                                                            
         ORG   TRTSGER+X'A1'       A1=SS                                        
         DC    X'A1'                                                            
         ORG   TRTSGER+X'E0'       E0=U/C O UMLAUT                              
         DC    X'E0'                                                            
*                                                                               
         ORG   TRTSGER+C'0'        UPPER CASE NUMBERS                           
         DC    C'0123456789'                                                    
*                                                                               
         ORG   TRTSGER+C' '        SPACES STAY SAME                             
         DC    X'40'                                                            
*                                                                               
         ORG   TRTSGER+C'*'        '*' STAYS SAME, IN CASE PARTIAL FLAG         
         DC    C'*'                                                             
*                                                                               
         ORG   TRTSGER+C'.'        THESE SPECIAL CHARS BECOME SPACES            
         DC    X'40'               AND ARE TREATED AS WORD SEPARATORS           
         ORG   TRTSGER+C'<'        ALL OTHERS BECOME NULLS AND ARE              
         DC    X'40'               IGNORED AS IF COMPRESSED OUT.                
         ORG   TRTSGER+C'('                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'+'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'&&'                                                    
         DC    X'40'                                                            
         ORG   TRTSGER+C')'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C';'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'-'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'/'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C','                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'_'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'>'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C':'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'='                                                     
         DC    X'40'                                                            
*                                                                               
         ORG   ,                                                                
                                                                                
                                                                                
***********************************************************************         
* Estimate Search - validate OWNER or created by                      *         
***********************************************************************         
                                                                                
ESVOWN   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVOWN*'                                                      
                                                                                
         LA    R2,RQ_ESOWN                                                      
         LA    R3,X#OWNER                                                       
         LHI   R4,C'O'                                                          
         CHI   R1,C'O'                                                          
         JE    ESVOWN1                                                          
         LA    R2,RQ_ESCRB                                                      
         LA    R3,X#CREBY                                                       
         LHI   R4,C'þ'                                                          
         CHI   R1,C'C'                                                          
         JNE   *+2                                                              
                                                                                
ESVOWN1  MVC   TEMP2(8),0(R2)                                                   
         GOTOR (#GETPIN,AGETPIN)                                                
         JE    ESVOWN2                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$INPID)                                           
         J     ESVOWNN                                                          
                                                                                
ESVOWN2  MVC   0(L'X#OWNER,R3),TEMP2+50                                         
                                                                                
         CLI   X#KTYPE,C'N'        unless set to number                         
         JE    ESVOWN3                                                          
                                                                                
         STC   R4,X#KTYPE          set to owner                                 
                                                                                
ESVOWN3  DS    0H                                                               
                                                                                
ESVOWNY  J     EXITY                                                            
                                                                                
ESVOWNN  J     EXITN                                                            
         EJECT                                                                  
                                                                                
***********************************************************************         
* Estimate Search - validate INTERNAL CLIENT APPROVER                 *         
***********************************************************************         
                                                                                
ESVICA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVICA*'                                                      
                                                                                
         MVC   TEMP2(8),RQ_ESICA                                                
         GOTOR (#GETPIN,AGETPIN)                                                
         JE    ESVICA1                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$INPID)                                           
         J     ESVICAN                                                          
                                                                                
ESVICA1  MVC   X#ICAPP,TEMP2+50                                                 
                                                                                
         CLI   X#KTYPE,C'N'        unless set to number                         
         JE    ESVICA3                                                          
         CLI   X#KTYPE,C'þ'        or created by                                
         JE    ESVICA3                                                          
         CLI   X#KTYPE,C'O'        or owner                                     
         JE    ESVICA3                                                          
         CLI   X#KTYPE,C'S'        or name search                               
         JE    ESVICA3                                                          
                                                                                
         MVI   X#KTYPE,C'A'        set to approver                              
                                                                                
ESVICA3  DS    0H                                                               
                                                                                
ESVICAY  J     EXITY                                                            
                                                                                
ESVICAN  J     EXITN                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
* Estimate Search - validate INTERNAL APPROVER                        *         
***********************************************************************         
                                                                                
ESVIAP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVIAP*'                                                      
                                                                                
         MVC   TEMP2(8),RQ_ESIAA                                                
         GOTOR (#GETPIN,AGETPIN)                                                
         JE    ESVIAP1                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$INPID)                                           
         J     ESVIAPN                                                          
                                                                                
ESVIAP1  MVC   X#INAPP,TEMP2+50                                                 
                                                                                
         CLI   X#KTYPE,C'N'        unless set to number                         
         JE    ESVIAP3                                                          
         CLI   X#KTYPE,C'þ'        or created by                                
         JE    ESVIAP3                                                          
         CLI   X#KTYPE,C'O'        or owner                                     
         JE    ESVIAP3                                                          
         CLI   X#KTYPE,C'A'        or approver                                  
         JE    ESVIAP3                                                          
         CLI   X#KTYPE,C'S'        or name search                               
         JE    ESVICA3                                                          
                                                                                
         MVI   X#KTYPE,C'I'        set to internal approver                     
                                                                                
ESVIAP3  DS    0H                                                               
                                                                                
ESVIAPY  J     EXITY                                                            
                                                                                
ESVIAPN  J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Estimate Search - validate CLIENT APPROVER                          *         
***********************************************************************         
                                                                                
ESVACA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVACA*'                                                      
                                                                                
         LA    RE,RQ_ESACA+L'RQ_ESACA-1                                         
         LA    RF,L'RQ_ESACA                                                    
                                                                                
ESVACA1  CLI   0(RE),C' '                                                       
         JH    ESVACA3                                                          
         SHI   RE,1                                                             
         JCT   RF,ESVACA1                                                       
         DC    H'0'                                                             
                                                                                
ESVACA3  SHI   RF,1                                                             
         STC   RF,X#ACAPL                                                       
                                                                                
ESVACAX  J     EXITY                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
* Estimate Search - validate APPROVAL COMMENT                         *         
***********************************************************************         
                                                                                
ESVACO   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVACO*'                                                      
                                                                                
         OC    RQ_ESACO,SPACES                                                  
                                                                                
         LA    RE,RQ_ESACO+L'RQ_ESACO-1                                         
         LA    RF,L'RQ_ESACO                                                    
                                                                                
ESVACO1  CLI   0(RE),C' '                                                       
         JH    ESVACO3                                                          
         SHI   RE,1                                                             
         JCT   RF,ESVACO1                                                       
         DC    H'0'                                                             
                                                                                
ESVACO3  SHI   RF,1                                                             
         STC   RF,X#COMML                                                       
                                                                                
ESVACOX  J     EXITY                                                            
         EJECT                                                                  
                                                                                
***********************************************************************         
* Estimate Search - validate STATUS                                   *         
***********************************************************************         
                                                                                
ESVSTA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVSTA*'                                                      
                                                                                
         MVI   X#SSTAT,FF          Default is all statuses                      
         MVI   X#SSTAT+L'STASTA1+L'STASTA2,NOQ and approval view                
         MVI   X#NOSTA,1           With one entry                               
         USING LW_D,R3                                                          
         XR    R3,R3               Point to list in WMP                         
         ICM   R3,7,RQ_ESSAD                                                    
         XR    R4,R4                                                            
         ICM   R4,3,LW_NUMN        Number of status entries                     
         STC   R4,X#NOSTA                                                       
         LTR   R4,R4               Any entries                                  
         JZ    ESVSTAY                                                          
         LA    R3,LW_DATA2         Start of list                                
         LA    R2,X#SSTAT                                                       
         USING STATABD,RF                                                       
ESVSTA02 LA    RF,STATAB                                                        
ESVSTA04 CLI   0(RF),C'*'                                                       
         JE    ESVSTA06                                                         
         CLC   0(L'STACHAR,R3),STACHAR                                          
         JE    ESVSTA08                                                         
         AHI   RF,STATABL                                                       
         J     ESVSTA04                                                         
                                                                                
ESVSTA06 MVC   ROUERRV,=AL2(AE$STAIN)                                           
         J     ESVSTAN                                                          
                                                                                
ESVSTA08 MVC   0(STATABL,R2),STASTA1                                            
         LA    R3,L'STACHAR(R3)    Bump to next data entry                      
         LA    R2,STATABL(R2)                                                   
         JCT   R4,ESVSTA02                                                      
         LLC   R4,X#NOSTA          R4=number of entries                         
* Sort status table by status byte 1                                            
         GOTO1 VXSORT,DMCB,(X'00',X#SSTAT),(R4),STATABL,L'STASTA1,0             
                                                                                
ESVSTAY  J     EXITY                                                            
                                                                                
ESVSTAN  J     EXITN                                                            
         DROP  R3,RF                                                            
         EJECT                                                                  
***********************************************************************         
* Estimate Search - cross validation ALL                              *         
***********************************************************************         
                                                                                
ESVALL   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ESVALL*'                                                      
                                                                                
         TM    X#LLUIND,X#LLUICQ+X#LLUIMQ+X#LLUISQ Limit list in use?           
         JZ    ESVALL2                                                          
                                                                                
         CLI   X#KTYPE,C' '        key type set?                                
         JNE   ESVALL2                                                          
                                                                                
         MVI   X#KTYPE,C'L'        read by LimList                              
         J     ESVALL4                                                          
                                                                                
ESVALL2  CLI   X#KTYPE,C' '         key type set?                               
         JNE   ESVALL4                                                          
                                                                                
         MVI   X#KTYPE,C'N'        read by number                               
                                                                                
ESVALL4  DS    0H                                                               
                                                                                
ESVALLY  J     EXITY                                                            
                                                                                
ESVALLN  J     EXITN                                                            
                                                                                
                                                                                
***********************************************************************         
* Estimate Search - set limit list values                             *         
***********************************************************************         
                                                                                
SETLLS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SETLLS*'                                                      
                                                                                
         MVI   X#LLUIND,0          limit list use indicator                     
                                                                                
         OC    CCTPID,CCTPID       check connected PID code                     
         JZ    SETLLS40                                                         
*                                                                               
         CLI   RQ_ESOVR,C'N'       Override LimList?                            
         JE    SETLLS20                                                         
*                                  (still filter by Scheme codes)               
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT4Q',TSARABUF),            +        
               ('GAPLLIML',SPACES),('GAPLTACC',GAPLPARM),('QEST',0)             
         JE    SETLLS10                                                         
         OI    X#LLUIND,X#LLUISQ   Schemes Limlist in use...                    
         J     SETLLS40            but no entries + default access=no           
                                                                                
SETLLS10 GOTOR LLSUSE                                                           
         J     SETLLS40                                                         
*                                                                               
SETLLS20 GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT21Q',TSARABUF),           +        
               ('GAPLLIML',SPACES),('GAPLTACC',GAPLPARM),('QEST',0)             
         JE    SETLLS30                                                         
         OI    X#LLUIND,X#LLUICQ   C/P/J Limlist in use...                      
         J     SETLLS40            but no entries + default access=no           
                                                                                
SETLLS30 GOTOR LLSUSE                                                           
                                                                                
SETLLS40 DS    0H                                                               
                                                                                
SETLLSY  J     EXITY                                                            
                                                                                
SETLLSN  J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Read estimates by account                                           *         
***********************************************************************         
                                                                                
RESTBA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*RESTBA*'                                                      
                                                                                
         USING ESTRECD,R2                                                       
         LA    R2,IOKEY                                                         
                                                                                
         OC    ESTKEY,ESTKEY       First time?                                  
         JNZ   RESTBA10                                                         
                                                                                
         MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CUXCPY                                                   
         MVC   ESTKCLI,RQ_ELCLI                                                 
         MVC   ESTKPRO,SPACES                                                   
         MVC   ESTKJOB,SPACES                                                   
         CLC   RQ_ELPRO,SPACES                                                  
         JNH   RESTBA05                                                         
         MVC   ESTKPRO,RQ_ELPRO                                                 
         CLC   RQ_ELJOB,SPACES                                                  
         JNH   RESTBA05                                                         
         MVC   ESTKJOB,RQ_ELJOB                                                 
                                                                                
RESTBA05 MVC   CSVKEY1,ESTKEY                                                   
         J     RESTBA15                                                         
                                                                                
RESTBA10 MVC   ESTKEY,CSVKEY2                                                   
         MVI   ESTKSEQ,FF                                                       
                                                                                
RESTBA15 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    RESTBA22                                                         
         J     RESTBAN                                                          
                                                                                
RESTBA20 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   RESTBAN                                                          
                                                                                
RESTBA22 CLC   ESTKEY(ESTKLNO-ESTRECD),CSVKEY1                                  
         JNE   RESTBAN             look for match of C/P/J                      
                                                                                
         CLI   ESTKSEQ,ESTKSMQ     only interested in main records              
         JE    RESTBA24                                                         
                                                                                
         MVI   ESTKSEQ,FF                                                       
         J     RESTBA15                                                         
                                                                                
RESTBA24 XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   RESTBA26                                                         
         CLI   ESTKJOB,ESTKBPQ                                                  
         JE    RESTBA20                                                         
                                                                                
RESTBA26 CLI   RQ_ELAPP,RQ_AWBTQ   awaiting both approvals                      
         JE    RESTBA28                                                         
         CLI   RQ_ELAPP,YESQ       awaiting approval view?                      
         JNE   RESTBA33                                                         
                                                                                
         TM    G#OFSTA2,OFFSIAEQ             internal approvals in use?         
         JNZ   RESTBA30                      yes                                
RESTBA28 TM    ESTKSTA1,ESTKSUBM             submitted only                     
         JNZ   RESTBA36                                                         
         MVI   ESTKSEQ,FF                                                       
         J     RESTBA15                                                         
                                                                                
RESTBA30 TM    ESTKSTA1,ESTKSUBM   submitted?                                   
         JZ    RESTBA32                                                         
         TM    ESTKSTA2,ESTKSINA   submitted to internal approver?              
         JZ    RESTBA36            no, submitted to client approver             
RESTBA32 MVI   ESTKSEQ,FF                                                       
         J     RESTBA15                                                         
                                                                                
RESTBA33 CLI   RQ_ELAPP,RQ_AWIAQ   awaiting internal approval view?             
         JE    *+12                                                             
         CLI   RQ_ELAPP,RQ_AWOTQ   awaiting other prior to me                   
         JNE   RESTBA35                                                         
         TM    ESTKSTA1,ESTKSUBM   submitted only                               
         JZ    RESTBA34                                                         
         TM    ESTKSTA2,ESTKSINA   submitted to internal approver?              
         JNZ   RESTBA36            yes                                          
RESTBA34 MVI   ESTKSEQ,FF                                                       
         J     RESTBA15                                                         
                                                                                
K        USING ELFD,X#TEMP                                                      
RESTBA35 MVC   K.ELFCLI(ELFDLQ),SPACES                                          
         MVC   K.ELFCLI(ELFDL2Q),ESTKCLI                                        
         MVC   K.ELFOFFC,ESTKSOFF                                               
         GOTOR ELFBLL,X#TEMP     (don't need for 'awaiting' folders)            
         MVC   ESTKCLI(ELFDL2Q),K.ELFCLI                                        
         JNE   RESTBA15                                                         
         DROP  K                                                                
                                                                                
RESTBA36 CLC   ESTKSOFF,SPACES                                                  
         JNH   RESTBA37                                                         
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,ESTKSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JE    RESTBA37                                                         
         MVI   ESTKSEQ,FF                                                       
         J     RESTBA15                                                         
         DROP  R1                                                               
                                                                                
RESTBA37 MVC   CSVKEY2,ESTKEY      save for return                              
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING EMDELD,R3                                                        
RESTBA40 MVC   X#CUROF,ESTRSOFF                                                 
         L     R3,AIO2                                                          
         AHI   R3,ESTRFST-ESTRECD                                               
         CLI   EMDEL,EMDELQ                                                     
         JNE   RESTBA20                                                         
                                                                                
         TM    X#LLUIND,X#LLUISQ   Schemes in use                               
         JZ    RESTBA42                                                         
         MVC   WORK(L'EMDSCH),EMDSCH                                            
         GOTOR FLTSCH                                                           
         JNE   RESTBA20                                                         
*                                                                               
RESTBA42 TM    X#LLUIND,X#LLUIMQ   media LimList is use?                        
         JZ    RESTBA46                                                         
         CLI   EMDBMC,C' '                                                      
         JNH   RESTBA46                                                         
*                                                                               
         LA    R1,X#MEDLL                                                       
RESTBA44 CLI   0(R1),C' '          end of list?                                 
         JNH   RESTBA20                                                         
         CLC   EMDBMC,0(R1)                                                     
         JE    RESTBA46                                                         
         AHI   R1,1                                                             
         J     RESTBA44                                                         
*                                                                               
RESTBA46 CLI   RQ_ELAPP,RQ_AWOTQ                                                
         JE    RESTBA48                                                         
         CLI   RQ_ELAPP,YESQ                                                    
         JE    RESTBA48                                                         
         CLI   RQ_ELAPP,RQ_AWBTQ   Am I approving both internal and cli         
         JNE   RESTBA56            No                                           
         TM    ESTKSTA2,ESTKSINA   Yes - check if submitted to internal         
         JNZ   RESTBA58            as can't approve client level                
                                                                                
RESTBA48 TM    X#ISUAPP,X#ISESTQ   Is connected user a client approver          
         JZ    RESTBA20            No                                           
         CLC   CCTPID,EMDSCA       Is the connected user the cli apprvr         
         JE    RESTBA60                                                         
         J     RESTBA20                                                         
                                                                                
RESTBA56 CLI   RQ_ELAPP,RQ_AWIAQ   awaiting internal approval view?             
         JNE   RESTBA60                                                         
RESTBA58 CLC   CCTPID,EMDSIA       Is the connected user the internal           
         JNE   RESTBA20             approver                                    
         TM    X#ISUAPP,X#ISINTQ     and are they still able to                 
         JZ    RESTBA20               approve internally                        
                                                                                
RESTBA60 DS    0H                  return with record in AIO2                   
                                                                                
RESTBAY  J     EXITY                                                            
                                                                                
RESTBAN  J     EXITN                                                            
         DROP  R2,R3                                                            
                                                                                
         EJECT                                                                  
                                                                                
***********************************************************************         
* Read estimates by status/owner                                      *         
***********************************************************************         
                                                                                
         USING ERAPASD,R2                                                       
RESTOS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*RESTOS*'                                                      
                                                                                
         LA    R2,IOKEY                                                         
         L     R4,ASTALST                                                       
         USING STATABD,R4                                                       
         CLI   STACHAR,RQ_NEWEQ    New (recently actioned) status               
         JNE   RESTO026                                                         
         OC    ERAPAS,ERAPAS       First time?                                  
         JNZ   RESTO005            No                                           
         L     R0,AGENAREA                                                      
         LHI   R1,L'GENAREA        Clear genarea so we can hold                 
         XR    RF,RF                estimates already put out                   
         XR    RE,RE                                                            
         MVCL  R0,RE                                                            
         XC    ERAPAS,ERAPAS                                                    
         MVI   ERAPTYP,ERAPTYPQ                                                 
         MVI   ERAPSUB,ERAPSUBQ                                                 
         MVC   ERAPCPY,CUXCPY                                                   
         MVC   ERAPPID,CCTPID                                                   
         MVC   CSVKEY2,ERAPAS                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JNE   RESTOSN                                                          
         J     RESTO015                                                         
*                                                                               
RESTO005 LA    R2,IOKEY                                                         
         MVC   IOKEY,CSVKEY2                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
*                                                                               
RESTO010 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   RESTOSN                                                          
*                                                                               
RESTO015 CLC   ERAPAS(ERAPCDA-ERAPASD),CSVKEY2                                  
         JNE   RESTOSN                                                          
         XR    RF,RF                                                            
         ICM   RF,7,ERAPCDA        Only for last 3 months                       
         LNR   RF,RF                                                            
         CLM   RF,7,XL#TODP3                                                    
         JL    RESTOSN                                                          
*                                                                               
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   RESTO016                                                         
         LLC   RF,PPROLEN                                                       
         LA    RF,ERAPCPJ(RF)                                                   
         CLI   0(RF),ESTKBPQ                                                    
         JE    RESTO010                                                         
*                                                                               
RESTO016 L     R3,AGENAREA         Check to see if estimate already             
RESTO020 OC    0(L'ERAPCPJ+L'ERAPLNO,R3),0(R3) No entry present                 
         JZ    RESTO022                          then add                       
         CLC   0(L'ERAPCPJ+L'ERAPLNO,R3),ERAPCPJ Is it the same est             
         JE    RESTO010                           Yes skip it                   
         LA    R3,L'ERAPCPJ+L'ERAPLNO(R3)  Keep checking                        
         J     RESTO020                                                         
                                                                                
RESTO022 MVC   0(L'ERAPCPJ+L'ERAPLNO,R3),ERAPCPJ   Save the estimate            
         MVC   CSVKEY2,ERAPASD     Now read estimate record                     
*                                                                               
         USING ESTRECD,IOKEY                                                    
         XC    ESTKEY,ESTKEY                                                    
         MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CUXCPY                                                   
         LA    R1,CSVKEY2+(ERAPCPJ-ERAPASD)                                     
*                                                                               
         LLC   RF,PCLILEN                                                       
         BCTR  RF,0                                                             
         BASR  R3,0                                                             
         MVC   ESTKCLI(0),0(R1)                                                 
         EX    RF,0(R3)                                                         
         OC    ESTKCLI,SPACES                                                   
         AHI   RF,1                                                             
         AR    R1,RF                                                            
         LLC   RE,PPROLEN                                                       
         SR    RE,RF                                                            
         BCTR  RE,0                                                             
         BASR  R3,0                                                             
         MVC   ESTKPRO(0),0(R1)                                                 
         OC    ESTKPRO,SPACES                                                   
         EX    RE,0(R3)                                                         
         AHI   RE,1                                                             
         AR    R1,RE               R1=A(Job code on ERAPASD key)                
                                                                                
         LLC   RE,PPROLEN          Work out job length remembering it           
         LHI   RF,L'ACTKACT         can never exceed 6 bytes                    
         SR    RF,RE                                                            
         CHI   RF,L'ESTKJOB        Does it exceed 6 bytes                       
         JNH   *+8                                                              
         LHI   RF,L'ESTKJOB        Yes - set to max of 6                        
         AHI   RF,-1               Subtract 1 for execute                       
         BASR  R3,0                                                             
         MVC   ESTKJOB(0),0(R1)                                                 
         EX    RF,0(R3)                                                         
         OC    ESTKJOB,SPACES                                                   
                                                                                
         MVC   ESTKLNO,CSVKEY2+(ERAPLNO-ERAPASD)                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   RESTO005            always skip if not found                     
***      L     R1,=AL4(IORDD+IODIR+IO2)                                         
***      GOTOR (#IOEXEC,AIOEXEC)                                                
***      JE    RESTO024                                                         
***      TM    IOERR,IOEDEL        Skip if deleted ...                          
***      JNZ   RESTO005                                                         
***      DC    H'0'                                                             
                                                                                
RESTO024 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    RESTOSY             Read estimate record                         
         DC    H'0'                                                             
                                                                                
         USING PIDRECD,R2                                                       
RESTO026 OC    PIDKEY,PIDKEY       First time?                                  
         JNZ   RESTO028                                                         
                                                                                
         MVI   PIDKTYP,PIDKTYPQ                                                 
         MVI   PIDKSUB,PIDKSUBQ                                                 
         MVC   PIDKCPY,CUXCPY                                                   
         MVC   PIDKPID,CCTPID                                                   
         MVI   PIDKSTYP,PIDKESTQ                                                
         CLI   RQ_ELFLA,RQ_ELFAQ   actioned by me?                              
         JE    *+10                 if so read all records                      
         MVC   PIDKESTA,STASTA1      that have my PID attached                  
                                                                                
         MVC   CSVKEY1,PIDKEY                                                   
         J     RESTO030                                                         
                                                                                
RESTO028 MVC   PIDKEY,CSVKEY2                                                   
         CLI   PIDKELNO,FF                                                      
         LLC   R1,PIDKELNO                                                      
         AHI   R1,1                                                             
         STC   R1,PIDKELNO                                                      
                                                                                
RESTO030 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    RESTO034                                                         
         J     RESTOSN                                                          
                                                                                
RESTO032 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   RESTOSN                                                          
                                                                                
RESTO034 CLI   RQ_ELFLA,RQ_ELFAQ   actioned by me?                              
         JNE   RESTO036                                                         
         CLC   PIDKEY(PIDKESTA-PIDRECD),CSVKEY1                                 
         JE    RESTO040                                                         
         J     RESTOSN                                                          
RESTO036 CLC   PIDKEY(PIDKECLI-PIDRECD),CSVKEY1                                 
         JE    RESTO040                                                         
         LA    R4,STATABL(R4)      Bump to next status                          
         ST    R4,ASTALST          Store address                                
         XC    PIDKEY,PIDKEY       Clear key area                               
         OC    STASTA1,STASTA1     Have we got a status entry here              
         JNZ   RESTO026            Yes - read for next set of recs              
         J     RESTOSN             No - exit and finish                         
                                                                                
RESTO040 XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   RESTO042                                                         
         CLI   PIDKEJOB,ESTKBPQ                                                 
         JE    RESTO032                                                         
                                                                                
RESTO042 CLI   RQ_ELAPP,YESQ       awaiting approval view?                      
         JE    RESTO050                                                         
         CLI   RQ_ELAPP,RQ_AWIAQ   awaiting internal approval view?             
         JE    RESTO050                                                         
         CLI   RQ_ELAPP,RQ_AWBTQ   awaiting internal or client approval         
         JE    RESTO050                                                         
         CLI   RQ_ELAPP,RQ_AWOTQ   awaiting others to approve                   
         JE    RESTO050                                                         
                                                                                
         XC    X#TEMP,X#TEMP                                                    
K        USING ELFD,X#TEMP                                                      
         MVC   K.ELFOFFC,PIDKSTA+ESTRSOFF-ESTRSTA                               
         MVC   K.ELFCLI(ELFDLQ),SPACES                                          
*&&UK*&& MVC   K.ELFCLI(ELFDL2Q),PIDKECLI                                       
*&&US                                                                           
         MVC   K.ELFCLI,PIDKECLI                                                
         MVC   K.ELFPRO,PIDKEPRO                                                
         MVC   K.ELFJOB,PIDKEJOB                                                
         MVC   K.ELFLNO,PIDKELNO                                                
*&&                                                                             
         GOTOR ELFBLL,X#TEMP                                                    
*&&UK*&& MVC   PIDKECLI(ELFDL2Q),K.ELFCLI                                       
*&&US                                                                           
         MVC   PIDKECLI,K.ELFCLI                                                
         MVC   PIDKEPRO,K.ELFPRO                                                
         MVC   PIDKEJOB,K.ELFJOB                                                
         MVC   PIDKELNO,K.ELFLNO                                                
*&&                                                                             
         DROP  K                                                                
         JNE   RESTO030                                                         
                                                                                
RESTO050 XC    WORK(2),WORK                                                     
         TM    PIDKESTA,ESTKLOGD                                                
         JZ    RESTO055                                                         
         CLI   STACHAR,RQ_ELSMQ                                                 
         JNE   *+8                                                              
         MVI   WORK,X'01'                                                       
         TM    PIDKSTA2,PIDSMERG                                                
         JZ    *+8                                                              
         MVI   WORK+1,X'01'                                                     
         CLC   WORK(1),WORK+1                                                   
         JNE   RESTO032            NOT OK                                       
                                                                                
RESTO055 CLI   RQ_ELFLA,RQ_ELFAQ   actioned by me?                              
         JE    RESTO075                                                         
         TM    G#OFSTA2,OFFSIAEQ   Internal approvals in use?                   
         JZ    RESTO075                                                         
         TM    PIDKESTA,ESTKSUBM                                                
         JZ    RESTO075                                                         
         CLI   RQ_ELAPP,YESQ                                                    
         JE    RESTO065                                                         
         CLI   RQ_ELAPP,RQ_AWIAQ                                                
         JE    RESTO070                                                         
         CLI   RQ_ELAPP,RQ_AWOTQ                                                
         JE    RESTO070                                                         
         CLI   RQ_ELAPP,RQ_AWBTQ                                                
         JE    RESTO075                                                         
         CLI   STACHAR,RQ_ELSSQ    submitted to client                          
         JNE   RESTO060                                                         
         TM    PIDKSTA2,PIDSSINA                                                
         JZ    RESTO075                                                         
         J     RESTO032                                                         
RESTO060 CLI   STACHAR,RQ_ELSBQ    submitted to internal approver               
         JNE   RESTO075                                                         
         TM    PIDKSTA2,PIDSSINA                                                
         JNZ   RESTO075                                                         
         J     RESTO032                                                         
                                                                                
RESTO065 TM    PIDKSTA2,PIDSSINA                                                
         JZ    RESTO075                                                         
         J     RESTO032                                                         
                                                                                
RESTO070 TM    PIDKSTA2,PIDSSINA                                                
         JZ    RESTO032                                                         
                                                                                
RESTO075 CLC   PIDKSTA+ESTRSOFF-ESTRSTA,SPACES                                  
         JNH   RESTO080                                                         
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,PIDKSTA+ESTRSOFF-ESTRSTA                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   RESTO032                                                         
         DROP  R1                                                               
*                                                                               
RESTO080 MVC   CSVKEY2,PIDKEY      save for return                              
*                                                                               
RESTO085 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING EMDELD,R3                                                        
RESTO090 L     R3,AIO2                                                          
         AHI   R3,ESTRFST-ESTRECD                                               
         CLI   EMDEL,EMDELQ                                                     
         JNE   RESTO032                                                         
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Is Aura the connected app?                   
         CHI   RF,XPRODIKQ                                                      
         JNE   RESTO092            No                                           
         CLI   RQ_ELAPP,YESQ       Awaiting approval view                       
         JE    RESTO092            Yes - skip date checks                       
         CLI   RQ_ELAPP,RQ_AWBTQ                                                
         JE    RESTO092                                                         
         CLI   RQ_ELAPP,RQ_AWOTQ                                                
         JE    RESTO092                                                         
         CLC   EMDLDT,XL#TDP13     Yes - ignore prior to 13 mths                
         JL    RESTO032                                                         
                                                                                
RESTO092 TM    X#LLUIND,X#LLUISQ   Schemes in use                               
         JZ    RESTO095                                                         
         MVC   WORK(L'EMDSCH),EMDSCH                                            
         GOTOR FLTSCH                                                           
         JNE   RESTO032                                                         
RESTO095 TM    X#LLUIND,X#LLUIMQ   media LimList is use?                        
         JZ    RESTO102                                                         
         CLI   EMDBMC,C' '                                                      
         JNH   RESTO102                                                         
*                                                                               
         LA    R1,X#MEDLL                                                       
RESTO100 CLI   0(R1),C' '          end of list?                                 
         JNH   RESTO032                                                         
         CLC   EMDBMC,0(R1)                                                     
         JE    RESTO102                                                         
         AHI   R1,1                                                             
         J     RESTO100                                                         
*                                                                               
RESTO102 CLI   RQ_ELFLA,C' '       any flavour passed?                          
         JNH   RESTO108                                                         
         CLI   RQ_ELFLA,RQ_ELFCQ   created by me?                               
         JNE   RESTO104                                                         
         CLC   EMDAPI,CCTPID       then only those                              
         JNE   RESTO032                                                         
         J     RESTO140            no other test required                       
                                                                                
RESTO104 CLI   RQ_ELFLA,RQ_ELFAQ   actioned by me?                              
         JNE   *+2                 (unknown flavour)                            
                                                                                
         GOTOR AUDVALS             get audit record values                      
                                                                                
RESTO105 LA    RE,X#FPROG                                                       
         CLI   STACHAR,RQ_ELSCQ    created                                      
         JE    RESTO106                                                         
         LA    RE,X#FSUBI                                                       
         CLI   STACHAR,RQ_ELSBQ    submitted to internal approver               
         JE    RESTO106                                                         
         LA    RE,X#FIAPP                                                       
         CLI   STACHAR,RQ_ELSIQ    internally approved                          
         JE    RESTO106                                                         
         LA    RE,X#FSUBC                                                       
         CLI   STACHAR,RQ_ELSSQ    submitted (to client)                        
         JE    RESTO106                                                         
         LA    RE,X#FCAPP                                                       
         CLI   STACHAR,RQ_ELSAQ    (client) approved                            
         JE    RESTO106                                                         
         LA    RE,X#FMRGD                                                       
         CLI   STACHAR,RQ_ELSMQ    merged                                       
         JE    RESTO106                                                         
         LA    RE,X#FREJT                                                       
         CLI   STACHAR,RQ_ELSRQ    rejected                                     
         JE    RESTO106                                                         
         LA    RE,X#FDELT                                                       
         CLI   STACHAR,RQ_ELSDQ    deleted                                      
         JNE   *+2                                                              
                                                                                
RESTO106 CLC   CCTPID,0(RE)        required action 'by me'                      
         JNE   RESTO107                                                         
         CLC   L'X#FPROG(L'X#FPROGD,RE),XL#TODP3 Only for last 3 months         
         JL    RESTO107                                                         
         J     RESTO140            no other test required                       
                                                                                
RESTO107 LA    R4,STATABL(R4)      Bump to next status                          
         OC    STASTA1,STASTA1     Have we got a status                         
         JNZ   RESTO105             yes check estimate                          
         L     R4,ASTALST          reset status back to beginning               
         J     RESTO032            Read for next record                         
                                                                                
RESTO108 CLI   RQ_ELAPP,RQ_AWOTQ   awaiting others                              
         JE    RESTO109                                                         
         CLI   RQ_ELAPP,YESQ       awaiting client approval                     
         JE    RESTO109                                                         
         CLI   RQ_ELAPP,RQ_AWBTQ   awaiting approval client or internal         
         JNE   RESTO120                                                         
         TM    PIDKSTA2,PIDSSINA   Is estimate awaiting internal?               
         JNZ   RESTO122            Yes - only check internal                    
RESTO109 TM    X#ISUAPP,X#ISESTQ   Is the connected user a cli approver         
         JZ    RESTO032            No                                           
         CLC   CCTPID,EMDSCA       Is the connected user the cli apprvr         
         JE    RESTO140            Yes                                          
         J     RESTO032            No                                           
                                                                                
RESTO120 CLI   RQ_ELAPP,RQ_AWIAQ   awaiting internal approval view?             
         JNE   RESTO124                                                         
RESTO122 CLC   CCTPID,EMDSIA       Is the connected user the internal           
         JNE   RESTO032                                     approver            
         TM    X#ISUAPP,X#ISINTQ   Is the connected user an internal            
         JZ    RESTO032                                      approver           
         J     RESTO140                                                         
                                                                                
RESTO124 DS    0H                  return with record in AIO2                   
*&&US                                                                           
         CLI   STASTA1,ESTKSUBM  Submitted ?                                    
         JE    RESTO126                                                         
         CLI   STASTA1,ESTKREJE  Rejected  ?                                    
         JNE   RESTO140                                                         
RESTO126 CLC   CCTPID,EMDAPI     connected user id same as added prsn?          
         JE    RESTO140                                                         
         CLC   CCTPID,EMDLPI     connected user = last amended user ?           
         JNE   RESTO032                                                         
                                                                                
*&&                                                                             
                                                                                
RESTO140 DS    0H                                                               
                                                                                
RESTOSY  J     EXITY                                                            
                                                                                
RESTOSN  J     EXITN                                                            
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* Read estimates for search                                           *         
***********************************************************************         
                                                                                
RESTSR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*RESTSR*'                                                      
                                                                                
         USING ESTRECD,R2                                                       
         LA    R2,IOKEY                                                         
                                                                                
         OC    IOKEY,IOKEY         First time?                                  
         JNZ   RESTSR10                                                         
                                                                                
         GOTOR SETKEY                                                           
         MVI   X#ACVTY,0                                                        
                                                                                
         J     RESTSR15                                                         
                                                                                
RESTSR10 MVC   IOKEY,CSVKEY2       read for next estimate                       
         MVI   X#ACVTY,FF                                                       
         CLI   X#KTYPE,C'S'        read by name search?                         
         JE    RESTSR13                                                         
         CLI   X#KTYPE,C'þ'        read by created by?                          
         JE    RESTSR11                                                         
         CLI   X#KTYPE,C'O'        read by owner?                               
         JE    RESTSR11                                                         
         CLI   X#KTYPE,C'A'        read by client approver?                     
         JE    RESTSR11                                                         
         CLI   X#KTYPE,C'I'        read by internal approver?                   
         JE    RESTSR11                                                         
         MVI   ESTKSEQ,FF                                                       
         J     RESTSR15                                                         
                                                                                
RESTSR11 LLC   RE,PIDKELNO-PIDRECD(R2)                                          
         AHI   RE,1                                                             
         STC   RE,PIDKELNO-PIDRECD(R2)                                          
         CHI   RE,FF                                                            
         JNH   RESTSR15                                                         
         LLC   RE,PIDKEJOB+L'PIDKEJOB-1-PIDRECD(R2)                             
         AHI   RE,1                                                             
         STC   RE,PIDKEJOB+L'PIDKEJOB-1-PIDRECD(R2)                             
         J     RESTSR15                                                         
                                                                                
RESTSR13 LLC   RE,SENKEGN+L'SENKEGN-1-SENRECD(R2)                               
         AHI   RE,1                                                             
         STC   RE,SENKEGN+L'SENKEGN-1-SENRECD(R2)                               
                                                                                
RESTSR15 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    RESTSR40                                                         
         J     RESTSRN                                                          
                                                                                
RESTSR20 LA    R2,IOKEY                                                         
         CLC   ESTKEY,CSVKEY2      Has our key been amended                     
         JE    RESTSR25            No                                           
         MVC   ESTKEY,CSVKEY2      Yes - reread to get sequence correct         
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JNE   RESTSRN                                                          
RESTSR25 LA    R2,IOKEY            Read next record                             
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   RESTSRN                                                          
         J     RESTSR40                                                         
                                                                                
RESTSR40 MVC   CSVKEY2,ESTKEY      save for return                              
         GOTOR CHKKEY              check within range                           
         JH    RESTSRN                                                          
         JNL   RESTSR42                                                         
         CLI   X#KTYPE,X#ESOFF     For office search                            
         JNE   RESTSR20            build the next key for read                  
         GOTOR SETKEY                                                           
         J     RESTSR15                                                         
                                                                                
RESTSR42 GOTOR FLTKEY              filter on key values                         
         JE    RESTSR45                                                         
         CLI   X#IOHI,FF                                                        
         JE    RESTSRN                                                          
         CLI   X#IOHI,YESQ                                                      
         JE    RESTSR15                                                         
         J     RESTSR20                                                         
                                                                                
RESTSR45 MVC   CSVKEY2,ESTKEY      save for return                              
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
RESTSR50 L     R2,AIO2             filter on record values                      
                                                                                
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   RESTSR52                                                         
         CLI   ESTKJOB-ESTRECD(R2),ESTKBPQ                                      
         JE    RESTSR20                                                         
                                                                                
RESTSR52 CLI   RQ_ESOVR,C'N'                                                    
         JNE   RESTSR54                                                         
         CLI   X#KTYPE,C'S'                                                     
         JE    RESTSR54                                                         
         GOTOR MEDLLF                                                           
         JNE   RESTSR20                                                         
                                                                                
RESTSR54 GOTOR FLTREC              (include filter by Scheme)                   
         JNE   RESTSR20                                                         
                                                                                
         DS    0H                  return with record in AIO2                   
                                                                                
RESTSRY  J     EXITY                                                            
                                                                                
RESTSRN  J     EXITN                                                            
                                                                                
SETKEY   NTR1  LABEL=NO            Set key module                               
         J     *+12                                                             
         DC    C'*SETKEY*'                                                      
                                                                                
         CLI   X#KTYPE,C'N'        read by number?                              
         JE    SETKEY2                                                          
         CLI   X#KTYPE,C'S'        read by name search?                         
         JE    SETKEY16                                                         
         CLI   X#KTYPE,C'C'        read by C/P/J?                               
         JE    SETKEY4                                                          
         LA    RF,X#CREBY                                                       
         CLI   X#KTYPE,C'þ'        read by created by?                          
         JE    SETKEY6                                                          
         LA    RF,X#OWNER                                                       
         CLI   X#KTYPE,C'O'        read by owner?                               
         JE    SETKEY6                                                          
         LA    RF,X#ICAPP                                                       
         CLI   X#KTYPE,C'A'        read by approver?                            
         JE    SETKEY6                                                          
         LA    RF,X#INAPP                                                       
         CLI   X#KTYPE,C'I'        read by internal approver?                   
         JE    SETKEY6                                                          
         CLI   X#KTYPE,C'L'        read by C/P/J and LimList?                   
         JE    SETKEY8                                                          
         CLI   X#KTYPE,X#ESOFF     Office search                                
         JE    SETKEY18                                                         
         DC    H'0'                                                             
                                                                                
         USING EGNPASD,R2                                                       
SETKEY2  MVI   EGNPTYP,EGNPTYPQ                                                 
         MVI   EGNPSUB,EGNPSUBQ                                                 
         MVC   EGNPCPY,CUXCPY                                                   
         MVC   EGNPNUM,RQ_ESGLO                                                 
         J     SETKEYX                                                          
                                                                                
         USING ESTRECD,R2                                                       
SETKEY4  MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CUXCPY                                                   
         MVC   ESTKCLI(CPLQ),X#CPMJ                                             
         MVC   ESTKJOB(CPLQ),X#CPMJ+CPLQ                                        
         J     SETKEYX                                                          
                                                                                
         USING PIDRECD,R2                                                       
SETKEY6  MVI   PIDKTYP,PIDKTYPQ                                                 
         MVI   PIDKSUB,PIDKSUBQ                                                 
         MVC   PIDKCPY,CUXCPY                                                   
         MVC   PIDKPID,0(RF)                                                    
         MVI   PIDKSTYP,PIDKESTQ                                                
         CLI   X#SSTAT,FF                                                       
         JE    SETKEYX                                                          
         MVC   PIDKESTA,X#SSTAT                                                 
         J     SETKEYX                                                          
                                                                                
SETKEY8  OC    X#CPMJ,X#CPMJ                                                    
         JNZ   SETKEY4                                                          
         TM    X#LLUIND,X#LLUICQ                                                
         JZ    SETKEY4                                                          
         USING GAPTABD,R3                                                       
         LA    R3,GAPAREA                                                       
         MVC   GAPAREA,GAPAREA2                                                 
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
SETKEY10 TM    ATSRERRS,TSEEOF                                                  
         JNZ   SETKEY4             End of buffer                                
         CLI   GAPTDAT1,GAPTT2Q    C/P/J?                                       
         JE    SETKEY12                                                         
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         J     SETKEY10                                                         
                                                                                
         USING ESTRECD,R2                                                       
SETKEY12 MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CUXCPY                                                   
         MVC   ESTKCLI,GAPTACC                                                  
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         LLC   RF,PCLILEN                                                       
         LA    RF,GAPTACC(RF)                                                   
         MVC   ESTKPRO,0(RF)       set product from next entry                  
         J     SETKEYX                                                          
                                                                                
SETKEY14 MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CUXCPY                                                   
         J     SETKEYX                                                          
                                                                                
         USING SENRECD,R2                                                       
SETKEY16 MVI   SENKTYP,SENKTYPQ                                                 
         MVC   SENKCPY,CUXCPY                                                   
         MVI   SENKSRC,SENKSRCQ                                                 
         MVI   SENKSUB,SENKWDSQ                                                 
         LLC   RF,X#ESNAL                                                       
         SHI   RF,1                                                             
         STC   RF,X#SRCL                                                        
         MVC   SENKWRD1,SPACES                                                  
         BASR  R1,0                                                             
         MVC   SENKWRD1(0),X#ESNAM                                              
         EX    RF,0(R1)                                                         
         J     SETKEYX                                                          
                                                                                
         USING EADPASD,R2                                                       
SETKEY18 XC    IOKEY,IOKEY                                                      
         MVI   EADPTYP,EADPTYPQ                                                 
         MVI   EADPSUB,EADPSUBQ                                                 
         MVC   EADPCPY,CUXCPY                                                   
         XR    RF,RF                                                            
         ICM   RF,7,X#AOFFL                                                     
         MVC   EADPOFF,0(RF)                                                    
*                                                                               
SETKEYX  MVC   CSVKEY1,IOKEY                                                    
         J     EXITY                                                            
         DROP  R2,R3                                                            
                                                                                
CHKKEY   ST    RE,SAVERE           Check key module                             
                                                                                
         CLI   X#KTYPE,C'S'        read by name search?                         
         JE    CHKKEY10                                                         
         CLI   X#KTYPE,C'N'        read by number?                              
         JE    CHKKEY20                                                         
         CLI   X#KTYPE,C'L'        read by limlist?                             
         JE    CHKKEY30                                                         
         CLI   X#KTYPE,C'C'        read by C/P/J?                               
         JE    CHKKEY40                                                         
         CLI   X#KTYPE,C'þ'        read by craeted by?                          
         JE    CHKKEY60                                                         
         CLI   X#KTYPE,C'O'        read by owner?                               
         JE    CHKKEY60                                                         
         CLI   X#KTYPE,C'A'        read by approver?                            
         JE    CHKKEY60                                                         
         CLI   X#KTYPE,C'I'        read by internal approver?                   
         JE    CHKKEY60                                                         
         CLI   X#KTYPE,X#ESOFF     read by office?                              
         JE    CHKKEY70                                                         
         DC    H'0'                                                             
                                                                                
         USING SENRECD,R2                                                       
CHKKEY10 CLC   SENKEY(SENKWRD1-SENRECD),CSVKEY1                                 
         JNE   CHKKEYH                                                          
         LLC   RF,X#SRCL                                                        
         BASR  R1,0                                                             
         CLC   SENKWRD1(0),X#ESNAM                                              
         EX    RF,0(R1)                                                         
         JNE   CHKKEYH                                                          
         MVC   X#SJOFF,SENKSTA+ESTKSOFF-ESTKSTA                                 
         J     CHKKEYY                                                          
                                                                                
         USING EGNPASD,R2                                                       
CHKKEY20 CLC   EGNPAS(EGNPNUM-EGNPASD),CSVKEY1                                  
         JNE   CHKKEYH                                                          
*                                                                               
         MVC   X#SJACT,SPACES                                                   
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   X#SJACT(0),EGNPCLI                                               
         EX    RF,0(R1)                                                         
         AHI   RF,1                                                             
         LA    R3,X#SJACT                                                       
         AR    R3,RF                                                            
         LLC   R4,PPROLEN                                                       
         SR    R4,RF                                                            
         SHI   R4,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,R3),EGNPPRO                                                  
         EX    R4,0(R1)                                                         
         AHI   R4,1                                                             
         AR    R3,R4               R3=A(Job entry in SJ account code)           
         AR    R4,RF               R4=Product length                            
         LLC   RF,PJOBLEN                                                       
         SR    RF,R4                                                            
         CHI   RF,6                                                             
         JNH   *+8                                                              
         LA    RF,6                                                             
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,R3),EGNPJOB                                                  
         EX    RF,0(R1)                                                         
                                                                                
         MVC   X#SJOFF,EGNPSOFF                                                 
                                                                                
         CLC   RQ_ESGLO,SPACES                                                  
         JNH   CHKKEYY                                                          
         CLC   EGNPNUM,RQ_ESGLO                                                 
         JNE   CHKKEYH                                                          
         J     CHKKEYY                                                          
                                                                                
         USING ESTRECD,R2                                                       
CHKKEY30 DS    0H                                                               
         CLC   X#CPMJ(CLLQ),SPACES                                              
         JH    CHKKEY40                                                         
         CLC   ESTKEY(ESTKCLI-ESTRECD),CSVKEY1                                  
         JNE   CHKKEYH                                                          
         GOTOR EXTSJAC                                                          
         J     CHKKEYY                                                          
                                                                                
CHKKEY40 CLC   ESTKEY(ESTKPRO-ESTRECD),CSVKEY1                                  
         JNE   CHKKEYH                                                          
         GOTOR EXTSJAC                                                          
         CLC   X#CPMJ+CLLQ(PRLQ),SPACES                                         
         JE    CHKKEYY                                                          
         CLC   ESTKPRO,X#CPMJ+CLLQ                                              
         JNE   CHKKEYH                                                          
         CLI   X#CPMJ+CPLQ,C' '                                                 
         JNH   CHKKEYY                                                          
         CLC   ESTKJOB(L'PMDKMED),X#CPMJ+CPLQ MATCH ON MEDIA                    
         JNE   CHKKEYH                                                          
         CLC   X#CPMJ+CPLQ+L'PMDKMED(L'ESTKJOB-L'PMDKMED),SPACES                
         JNH   CHKKEYY                      IS JOB CODE W/O MEDIA AVLBL         
         CLC   ESTKJOB,X#CPMJ+CPLQ                                              
         JNE   CHKKEYH                                                          
         J     CHKKEYY                                                          
                                                                                
         USING PIDRECD,R2                                                       
CHKKEY60 CLC   PIDKEY(PIDKESTA-PIDRECD),CSVKEY1                                 
         JNE   CHKKEYH                                                          
         MVC   X#SJACT,SPACES                                                   
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   X#SJACT(0),PIDKECLI                                              
         EX    RF,0(R1)                                                         
         AHI   RF,1                                                             
         LA    R3,X#SJACT                                                       
         AR    R3,RF                                                            
         LLC   R4,PPROLEN                                                       
         SR    R4,RF                                                            
         SHI   R4,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,R3),PIDKEPRO                                                 
         EX    R4,0(R1)                                                         
         AHI   R4,1                                                             
         AR    R3,R4               R3=A(Job entry in SJ account code)           
         AR    R4,RF               R4=Product length                            
         LLC   RF,PJOBLEN                                                       
         SR    RF,R4                                                            
         CHI   RF,6                                                             
         JNH   *+8                                                              
         LA    RF,6                                                             
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,R3),PIDKEJOB                                                 
         EX    RF,0(R1)                                                         
                                                                                
         MVC   X#SJOFF,EGNPSOFF-EGNPASD(R2)                                     
         CLI   X#SSTAT,FF                                                       
         JE    CHKKEYY                                                          
                                                                                
         LA    RF,X#SSTAT                                                       
         LLC   RE,X#NOSTA          RE=Number of status entries                  
         USING STATABD,RF                                                       
CHKKEY62 MVC   BYTE1,PIDKESTA      Check status byte 1                          
         NC    BYTE1,STASTA1       Any match?                                   
         JZ    CHKKEY66            No                                           
         OC    STASTA2,STASTA2     Do we have any status 2 to check             
         JNZ   CHKKEY64            Yes                                          
         MVC   BYTE1,PIDKSTA2      No - check we have nothing                   
         NI    BYTE1,ESTKMERG+ESTKSINA                                          
         JZ    CHKKEYY             Yes - match                                  
         J     CHKKEY66            No - check next status entry in list         
                                                                                
CHKKEY64 MVC   BYTE1,PIDKSTA2      Check status byte 2 matches                  
         NC    BYTE1,STASTA2                                                    
         JNZ   CHKKEYY             Matches entry                                
CHKKEY66 LA    RF,STATABL(RF)      RF=A(next entry of status list)              
         JCT   RE,CHKKEY62                                                      
         J     CHKKEYL                                                          
*                                  Check still reading same office              
         USING EADPASD,R2                                                       
CHKKEY70 CLC   CSVKEY1(EADPDAT-EADPASD),EADPAS                                  
         JE    CHKKEYY                                                          
         LLC   RE,X#OFFNO          Bump to next office code                     
         XR    RF,RF                                                            
         ICM   RF,7,X#AOFFL                                                     
         AHI   RF,L'OFFKOFF                                                     
         JCT   RE,CHKKEY72                                                      
         J     CHKKEYH             No more office entries.                      
*                                                                               
CHKKEY72 STC   RE,X#OFFNO                                                       
         STCM  RF,7,X#AOFFL                                                     
         J     CHKKEYL                                                          
         DROP  RF                                                               
                                                                                
CHKKEYY  MVI   BYTE4,1             SET CC EQUAL                                 
         J     CHKKEYX                                                          
CHKKEYH  MVI   BYTE4,2             SET CC HIGH                                  
         J     CHKKEYX                                                          
CHKKEYL  MVI   BYTE4,0             SET CC LOW                                   
CHKKEYX  L     RE,SAVERE                                                        
         CLI   BYTE4,1                                                          
         BR    RE                                                               
                                                                                
         USING ESTRECD,R2                                                       
EXTSJAC  DS    0H                                                               
         MVC   X#SJACT,SPACES                                                   
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   X#SJACT(0),ESTKCLI                                               
         EX    RF,0(R1)                                                         
         AHI   RF,1                                                             
         LA    R3,X#SJACT                                                       
         AR    R3,RF                                                            
         LLC   R4,PPROLEN                                                       
         SR    R4,RF                                                            
         SHI   R4,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,R3),ESTKPRO                                                  
         EX    R4,0(R1)                                                         
         AHI   R4,1                                                             
         AR    R3,R4               R3=A(Job entry in SJ account code)           
         AR    R4,RF               R4=Product length                            
         LLC   RF,PJOBLEN                                                       
         SR    RF,R4                                                            
         CHI   RF,6                                                             
         JNH   *+8                                                              
         LA    RF,6                                                             
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,R3),ESTKJOB                                                  
         EX    RF,0(R1)                                                         
                                                                                
         MVC   X#SJOFF,ESTKSOFF                                                 
         BR    RE                                                               
                                                                                
FLTKEY   ST    RE,SAVERE           Filter key values module                     
                                                                                
         MVI   X#IOHI,NOQ          default to sequential read                   
                                                                                
         CLI   X#KTYPE,C'S'        read by name search?                         
         JE    FLTKEY10                                                         
         CLI   X#KTYPE,C'N'        read by number?                              
         JE    FLTKEY20                                                         
         CLI   X#KTYPE,C'C'        read by C/P/J?                               
         JE    FLTKEY40                                                         
         CLI   X#KTYPE,C'L'        read by limlist?                             
         JE    FLTKEY40                                                         
         CLI   X#KTYPE,C'þ'        read by created by?                          
         JE    FLTKEY60                                                         
         CLI   X#KTYPE,C'O'        read by owner?                               
         JE    FLTKEY60                                                         
         CLI   X#KTYPE,C'A'        read by approver?                            
         JE    FLTKEY60                                                         
         CLI   X#KTYPE,C'I'        read by internal approver?                   
         JE    FLTKEY60                                                         
         CLI   X#KTYPE,X#ESOFF     read by office?                              
         JE    FLTKEY80                                                         
         DC    H'0'                                                             
                                                                                
         USING SENRECD,R2                                                       
FLTKEY10 DS    0H                                                               
         J     FLTKEY80                                                         
                                                                                
         USING EGNPASD,R2                                                       
FLTKEY20 CLC   X#CPMJ(CLLQ),SPACES                                              
         JE    FLTKEY22                                                         
         CLC   EGNPCLI,X#CPMJ                                                   
         JNE   FLTKEYN                                                          
                                                                                
FLTKEY22 CLC   X#CPMJ+CLLQ(PRLQ),SPACES                                         
         JE    FLTKEY24                                                         
         CLC   EGNPPRO,X#CPMJ+CLLQ                                              
         JNE   FLTKEYN                                                          
                                                                                
FLTKEY24 CLI   X#CPMJ+7,C' '                                                    
         JE    FLTKEY26                                                         
         CLC   EGNPJOB(1),X#CPMJ+CPLQ                                           
         JNE   FLTKEYN                                                          
                                                                                
FLTKEY26 CLC   X#CPMJ+CPLQ(6),SPACES                                            
         JE    FLTKEY28                                                         
         CLC   EGNPJOB,X#CPMJ+CPLQ                                              
         JNE   FLTKEYN                                                          
                                                                                
FLTKEY28 CLI   X#MEDLS,C' '                                                     
         JNH   FLTKEY30                                                         
         CLI   EGNPJOB,C' '                                                     
         JNH   FLTKEY30                                                         
         LA    R3,X#MEDLS                                                       
         LLC   RF,X#MEDNO                                                       
FLTKEY29 CLC   0(L'PMDKMED,R3),EGNPJOB                                          
         JE    FLTKEY30                                                         
         LA    R3,L'PMDKMED(R3)                                                 
         JCT   RF,FLTKEY29                                                      
         J     FLTKEYN                                                          
                                                                                
FLTKEY30 MVC   X#MEDC,EGNPJOB                                                   
         LA    R3,EGNPCLI                                                       
         J     FLTKEY80                                                         
                                                                                
         USING ESTRECD,R2                                                       
FLTKEY40 CLI   ESTKSEQ,ESTKSMQ                                                  
         JNE   FLTKEY58                                                         
                                                                                
         CLC   X#CPMJ+CLLQ(PRLQ),SPACES                                         
         JE    FLTKEY42                                                         
         CLC   ESTKPRO,X#CPMJ+CLLQ                                              
         JE    FLTKEY42                                                         
         MVI   X#IOHI,FF                                                        
         J     FLTKEYN                                                          
                                                                                
FLTKEY42 DS    0H                                                               
         CLI   X#CPMJ+CPLQ,C' '                                                 
         JE    FLTKEY46                                                         
         CLC   ESTKJOB(1),X#CPMJ+CPLQ                                           
         JE    FLTKEY46                                                         
         JNH   FLTKEY44                                                         
         LLC   R1,ESTKPRO+1                                                     
         AHI   R1,1                                                             
         STC   R1,ESTKPRO+1                                                     
         MVC   ESTKJOB,SPACES                                                   
         MVC   ESTKJOB(1),X#CPMJ+CPLQ                                           
         MVI   X#IOHI,YESQ                                                      
         J     FLTKEYN                                                          
                                                                                
FLTKEY44 LLC   R1,ESTKJOB                                                       
         AHI   R1,1                                                             
         MVC   ESTKJOB,SPACES                                                   
         STC   R1,ESTKJOB                                                       
         MVI   X#IOHI,YESQ                                                      
         J     FLTKEYN                                                          
                                                                                
FLTKEY46 CLC   X#CPMJ+CPLQ(6),SPACES                                            
         JE    FLTKEY47                                                         
         CLC   RQ_ESJOB,SPACES                                                  
         JNH   FLTKEY47                                                         
         CLC   ESTKJOB,X#CPMJ+CPLQ                                              
         JNE   FLTKEY58                                                         
                                                                                
FLTKEY47 CLI   X#MEDLS,C' '                                                     
         JNH   FLTKEY50                                                         
         CLI   ESTKJOB,C' '                                                     
         JH    FLTKEY48                                                         
         CLI   X#KTYPE,C'L'                                                     
         JE    FLTKEYN                                                          
         J     FLTKEY50                                                         
FLTKEY48 LA    R3,X#MEDLS                                                       
         LLC   RF,X#MEDNO                                                       
FLTKEY49 CLC   0(L'PMDKMED,R3),ESTKJOB                                          
         JE    FLTKEY50                                                         
         LA    R3,L'PMDKMED(R3)                                                 
         JCT   RF,FLTKEY49                                                      
         J     FLTKEYN                                                          
                                                                                
FLTKEY50 MVC   X#MEDC,ESTKJOB                                                   
         LA    R3,ESTKCLI                                                       
         J     FLTKEY80                                                         
                                                                                
FLTKEY58 MVI   ESTKSEQ,FF                                                       
         MVI   X#IOHI,YESQ                                                      
         J     FLTKEYN                                                          
                                                                                
         USING PIDRECD,R2                                                       
FLTKEY60 CLC   X#CPMJ(CLLQ),SPACES                                              
         JE    FLTKEY64                                                         
         CLC   PIDKECLI,X#CPMJ                                                  
         JE    FLTKEY64                                                         
         JL    FLTKEY62                                                         
         LLC   R1,PIDKESTA                                                      
         AHI   R1,1                                                             
         STC   R1,PIDKESTA                                                      
         XC    PIDKECLI,PIDKECLI                                                
         MVI   X#IOHI,YESQ                                                      
         J     FLTKEYN                                                          
                                                                                
FLTKEY62 MVC   PIDKECLI,X#CPMJ                                                  
         XC    PIDKEPRO,PIDKEPRO                                                
         MVI   X#IOHI,YESQ                                                      
         CLC   X#CPMJ+CLLQ(PRLQ),SPACES                                         
         JE    FLTKEYN                                                          
         MVC   PIDKEPRO,X#CPMJ+CLLQ                                             
         XC    PIDKEJOB,PIDKEJOB                                                
         CLI   X#CPMJ+7,C' '                                                    
         JE    FLTKEYN                                                          
         MVC   PIDKEJOB,X#CPMJ+CPLQ                                             
         MVI   PIDKELNO,0                                                       
         J     FLTKEYN                                                          
                                                                                
FLTKEY64 CLC   X#CPMJ+CLLQ(PRLQ),SPACES                                         
         JE    FLTKEY68                                                         
         CLC   PIDKEPRO,X#CPMJ+CLLQ                                             
         JE    FLTKEY68                                                         
         JL    FLTKEY66                                                         
         MVI   X#IOHI,YESQ                                                      
         XC    PIDKEPRO,PIDKEPRO                                                
         LLC   R1,PIDKECLI+L'PIDKECLI-1                                         
         AHI   R1,1                                                             
         STC   R1,PIDKECLI+L'PIDKECLI-1                                         
         J     FLTKEYN                                                          
                                                                                
FLTKEY66 MVI   X#IOHI,YESQ                                                      
         MVC   PIDKEPRO,X#CPMJ+CLLQ                                             
         XC    PIDKEJOB,PIDKEJOB                                                
         CLI   X#CPMJ+CPLQ,C' '                                                 
         JE    FLTKEYN                                                          
         MVC   PIDKEJOB,X#CPMJ+CPLQ                                             
         MVI   PIDKELNO,0                                                       
         J     FLTKEYN                                                          
                                                                                
FLTKEY68 CLI   X#CPMJ+CPLQ,C' '                                                 
         JE    FLTKEY72                                                         
         CLC   PIDKEJOB(1),X#CPMJ+CPLQ                                          
         JE    FLTKEY72                                                         
         MVI   X#IOHI,YESQ                                                      
         JL    FLTKEY70                                                         
         LLC   R1,PIDKEPRO+L'PIDKEPRO-1                                         
         AHI   R1,1                                                             
         STC   R1,PIDKEPRO+L'PIDKEPRO-1                                         
         MVC   PIDKEJOB,X#CPMJ+CPLQ                                             
         MVI   PIDKELNO,0                                                       
         J     FLTKEYN                                                          
                                                                                
FLTKEY70 MVC   PIDKEJOB,X#CPMJ+CPLQ                                             
         MVI   PIDKELNO,0                                                       
         J     FLTKEYN                                                          
                                                                                
FLTKEY72 CLC   X#CPMJ+CPLQ(6),SPACES                                            
         JE    FLTKEY76                                                         
         CLC   PIDKEJOB,X#CPMJ+CPLQ                                             
         JE    FLTKEY76                                                         
         MVI   X#IOHI,YESQ                                                      
         JL    FLTKEY74                                                         
         LLC   R1,PIDKESTA                                                      
         AHI   R1,1                                                             
         STC   R1,PIDKESTA                                                      
         MVC   PIDKECLI,X#CPMJ                                                  
         MVI   PIDKELNO,0                                                       
         J     FLTKEYN                                                          
                                                                                
FLTKEY74 MVC   PIDKEJOB,X#CPMJ+CPLQ                                             
         MVI   PIDKELNO,0                                                       
         J     FLTKEYN                                                          
                                                                                
FLTKEY76 CLI   X#MEDLS,C' '        Any media codes in the request               
         JNH   FLTKEY78            No                                           
         CLI   PIDKEJOB,C' '       Do we have a job level estimate              
         JNH   FLTKEY78            No                                           
         LA    R3,X#MEDLS          Check media code list matches                
         LLC   RF,X#MEDNO           first character of job                      
FLTKEY77 CLC   0(L'PMDKMED,R3),PIDKEJOB                                         
         JE    FLTKEY78                                                         
         LA    R3,L'PMDKMED(R3)                                                 
         JCT   RF,FLTKEY77                                                      
         J     FLTKEYN             If it doesn't reject estimate                
                                                                                
FLTKEY78 MVC   X#MEDC,PIDKEJOB                                                  
         LA    R3,PIDKECLI                                                      
                                                                                
FLTKEY80 XR    R1,R1               Only filter closed locked jobs for           
         ICM   R1,3,CUXPNUM                              Aura                   
         CHI   R1,XPRODIKQ                                                      
         JNE   FLTKEY87                                                         
         LA    R1,X#SJACT                                                       
         LLC   RF,PPROLEN                                                       
         AR    R1,RF                                                            
         CLI   0(R1),C' '          Have we got a job                            
         JNH   FLTKEY87            No skip job look up                          
         CLI   X#KTYPE,C'C'        read by C/P/J?                               
         JNE   FLTKEY87                                                         
                                                                                
         CLC   X#SVSJA,X#SJACT     same as before?                              
         JE    FLTKEY87                                                         
                                                                                
         MVC   X#SVSJA,X#SJACT                                                  
                                                                                
         CLI   RQ_ESCLS,YESQ       Ignore close/lock checks?                    
         JNE   *+12                                                             
         CLI   RQ_ESLKD,YESQ                                                    
         JE    FLTKEY87            No as we've said to include all              
                                                                                
         USING ACTRECD,RE                                                       
         LA    RE,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),SJUL                                                  
         MVC   ACTKACT,X#SJACT                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   FLTKEY86                                                         
                                                                                
         LA    RE,IOKEY                                                         
                                                                                
         CLI   RQ_ESLKD,C'O'       Do we only want locked jobs                  
         JNE   *+12                                                             
         TM    ACTKSTAT,ACTSLOCK                                                
         JZ    FLTKEY86                                                         
                                                                                
         CLI   RQ_ESLKD,NOQ        Do we want no locked jobs                    
         JNE   *+12                                                             
         TM    ACTKSTAT,ACTSLOCK   If job is locked skip this estimate          
         JNZ   FLTKEY86                                                         
                                                                                
         CLI   RQ_ESCLS,C'O'       Do we only want closed jobs                  
         JNE   *+12                                                             
         TM    ACTKSTAT,ACTSCLOS   If job if not closed skip this               
         JZ    FLTKEY86                                       estimate          
                                                                                
         CLI   RQ_ESCLS,NOQ        Do we want no closed jobs                    
         JNE   *+12                                                             
         TM    ACTKSTAT,ACTSCLOS   If job is closed skip this estimate          
         JNZ   FLTKEY86                                                         
         DROP  RE                                                               
                                                                                
FLTKEY84 MVC   IOKEY,CSVKEY2       job=estimate is good                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         J     FLTKEY87                                                         
                                                                                
         USING ESTRECD,R2                                                       
FLTKEY86 MVC   ESTKEY,CSVKEY2      skip this job and its estimates              
         MVI   ESTKLNO,FF                                                       
         MVI   ESTKSEQ,FF                                                       
         MVI   X#IOHI,YESQ                                                      
         J     FLTKEYN                                                          
                                                                                
* Filter estimates on status area                                               
                                                                                
FLTKEY87 CLI   X#SSTAT,FF                                                       
         JE    FLTKEY92                                                         
         LA    RF,X#SSTAT                                                       
         LLC   RE,X#NOSTA          RE=Number of status entries                  
         USING STATABD,RF                                                       
         USING EGNPASD,R2                                                       
FLTKEY88 MVC   BYTE1,EGNPSTA1      Check status byte 1                          
         NC    BYTE1,STASTA1       Any match?                                   
         JZ    FLTKEY90            No                                           
         OC    STASTA2,STASTA2     Do we have any status 2 to check             
         JNZ   FLTKEY89            Yes                                          
         MVC   BYTE1,EGNPSTA2      No - check we have nothing                   
         NI    BYTE1,ESTKMERG+ESTKSINA                                          
         JZ    FLTKEY92            Yes - match                                  
         J     FLTKEY90            No - check next status entry in list         
                                                                                
FLTKEY89 MVC   BYTE1,EGNPSTA2      Check status byte 2 matches                  
         NC    BYTE1,STASTA2                                                    
         JNZ   FLTKEY92            Matches entry                                
FLTKEY90 LA    RF,STATABL(RF)      RF=A(next entry of status list)              
         JCT   RE,FLTKEY88                                                      
         J     FLTKEYN                                                          
         DROP  RF                                                               
                                                                                
FLTKEY92 CLC   RQ_ESCUR,SPACES                                                  
         JNH   FLTKEY94                                                         
         CLC   RQ_ESCUR,AGYCURR                                                 
         JE    FLTKEY94                                                         
         TM    EGNPSTA2,EGNPFCUR                                                
         JZ    FLTKEYN                                                          
                                                                                
         USING OFFALD,R1                                                        
FLTKEY94 L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,EGNPSOFF   move in office and validate                  
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   FLTKEYN                                                          
         DROP  R1                                                               
*                                                                               
         USING LW_D,R1                                                          
         OC    RQ_ESOFA,RQ_ESOFA   Any office filtering?                        
         JZ    FLTKEY98                                                         
         XR    R1,R1               point to list in WMP                         
         ICM   R1,7,RQ_ESOFA                                                    
         XR    RE,RE                                                            
         ICM   RE,3,LW_NUMN                                                     
         LTR   RE,RE                                                            
         JZ    FLTKEY98            No entries?                                  
         LA    RF,LW_DATA2         start of lis                                 
*                                                                               
FLTKEY96 CLC   EGNPSOFF,0(RF)      Filter office based on list passed           
         JE    FLTKEY98                                                         
         AHI   RF,L'OFFKOFF                                                     
         JCT   RE,FLTKEY96                                                      
         J     FLTKEYN             Office not valid                             
                                                                                
FLTKEY98 CLI   X#KTYPE,C'S'        skip for serach pointers                     
         JE    FLTKEYY                                                          
                                                                                
         TM    X#LLUIND,X#LLUIMQ   media LimList is use?                        
         JZ    FLTKY102                                                         
         CLI   X#MEDC,C' '                                                      
         JNH   FLTKY102                                                         
                                                                                
         LA    R1,X#MEDLL                                                       
                                                                                
FLTKY100 CLI   0(R1),C' '          end of list?                                 
         JNH   FLTKEYN                                                          
         CLC   X#MEDC,0(R1)                                                     
         JE    FLTKY102                                                         
         AHI   R1,1                                                             
         J     FLTKY100                                                         
                                                                                
FLTKY102 TM    X#LLUIND,X#LLUICQ   R3 points to Cli/Pro/Job                     
         JZ    FLTKEYY             no limit list then OK                        
                                                                                
         USING GAPTABD,R4                                                       
         LA    R4,GAPAREA         check against limit list                      
         MVC   GAPAREA,GAPAREA2                                                 
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         LA    R3,X#SJACT                                                       
         MVC   BYTE3,PCLILEN                                                    
         LLC   R1,PCLILEN                                                       
         AR    R1,R3                                                            
         CLC   0(PRLQ,R1),SPACES                                                
         JE    FLTKY104                                                         
         MVC   BYTE3,PPROLEN                                                    
         LLC   R1,PPROLEN                                                       
         AR    R1,R3                                                            
         CLC   0(1,R1),SPACES                                                   
         JE    FLTKY104                                                         
         MVC   BYTE3,PJOBLEN                                                    
                                                                                
FLTKY104 TM    ATSRERRS,TSEEOF                                                  
         JZ    FLTKY106                                                         
         J     FLTKEYN                                                          
                                                                                
FLTKY106 CLI   GAPTDAT1,GAPTT2Q                                                 
         JE    FLTKY110                                                         
                                                                                
FLTKY108 GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF           skip all other types                          
         J     FLTKY104                                                         
                                                                                
FLTKY110 LLC   RF,BYTE3                                                         
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         CLC   X#SJACT(0),GAPTACC                                               
         EX    RF,0(R1)                                                         
         JE    FLTKEYY                                                          
         CLC   BYTE3,PJOBLEN                                                    
         JNE   FLTKY120                                                         
         MVC   BYTE3,PPROLEN                                                    
         J     FLTKY110                                                         
FLTKY120 CLC   BYTE3,PPROLEN                                                    
         JNE   FLTKY108                                                         
         MVC   BYTE3,PCLILEN                                                    
         J     FLTKY110                                                         
                                                                                
FLTKEYY  L     RE,SAVERE                                                        
         CR    RE,RE                                                            
         BR    RE                                                               
FLTKEYN  L     RE,SAVERE                                                        
         LTR   RE,RE                                                            
         BR    RE                                                               
         DROP  R2,R4                                                            
                                                                                
         USING ESTRECD,R2                                                       
         USING EMDELD,R3                                                        
FLTREC   ST    RE,FULL1            Filter record values module                  
                                                                                
         MVC   TEMP2,SPACES                                                     
         CLI   X#KTYPE,X#ESOFF     read by office?                              
         JNE   FLTREC00                                                         
         GOTOR EXTSJAC                                                          
                                                                                
FLTREC00 LA    R3,ESTRFST                                                       
         CLI   EMDEL,EMDELQ                                                     
         JNE   *+2                                                              
                                                                                
         OC    X#CREBY,X#CREBY                                                  
         JZ    FLTREC01                                                         
         CLC   EMDAPI,X#CREBY                                                   
         JNE   FLTRECN                                                          
                                                                                
FLTREC01 CLI   RQ_ESOVR,C'N'                                                    
         JNE   FLTREC02                                                         
         TM    X#LLUIND,X#LLUISQ   Schemes in use                               
         JZ    FLTREC02                                                         
         MVC   WORK(L'EMDSCH),EMDSCH                                            
         GOTOR FLTSCH                                                           
         JNE   FLTRECN                                                          
                                                                                
FLTREC02 DS    0H                                                               
         ST    R2,FULL2                                                         
         CLI   X#ESNAM#,0          skip if no name                              
         JE    FLTREC10                                                         
         LA    R2,EMDEL                                                         
         USING ENMELD,R2                                                        
                                                                                
FLTREC03 LLC   R1,ENMLN                                                         
         AR    R2,R1                                                            
         CLI   ENMEL,0                                                          
         JE    FLTRECN                                                          
         CLI   ENMEL,ENMELQ                                                     
         JNE   FLTREC03                                                         
                                                                                
         LA    R3,X#ESNAL1         point to names                               
         LLC   R4,X#ESNAM#                                                      
         MVC   X#TEMP,ENMNAME      (RD009235: avoid name to be set to           
         LLC   RE,ENMLN             upper case)                                 
         SHI   RE,ENMLNQ                                                        
         L     R1,AUINTAB                                                       
         LARL  RF,FLTREC09                                                      
         EX    RE,0(RF)                                                         
                                                                                
FLTREC04 LLC   R0,ENMLN            disregard L'NAMEREC as 99,99% OK             
         SHI   R0,ENMLNQ                                                        
         LA    RE,X#TEMP                                                        
         LLC   RF,0(R3)                                                         
         SHI   RF,1                                                             
FLTREC05 LARL  R1,FLTREC08                                                      
         EX    RF,0(R1)                                                         
         JE    FLTREC06                                                         
         AHI   RE,1                                                             
         JCT   R0,FLTREC05                                                      
         J     FLTRECN             extra name (filter) not on record            
                                                                                
FLTREC06 AHI   R3,L'X#ESNAL1+L'X#ESNAM1  extra name (filter) matches            
         JCT   R4,FLTREC04                                                      
         J     FLTREC10            all OK                                       
                                                                                
FLTREC08 CLC   0(0,RE),L'X#ESNAL2(R3)                                           
FLTREC09 TR    X#TEMP(0),0(R1)                                                  
         DROP  R2                                                               
                                                                                
         USING ESTRECD,R2                                                       
         USING ENMELD,R4                                                        
FLTREC10 L     R2,FULL2                                                         
                                                                                
*&&UK                                                                           
         CLC   RQ_ESCUR,SPACES     currency filter                              
         JNH   FLTREC12                                                         
         CLC   EMDCUR,RQ_ESCUR                                                  
         JNE   FLTRECN                                                          
*&&                                                                             
                                                                                
FLTREC12 CLI   X#MEDLS,C' '                                                     
         JNH   FLTREC16                                                         
         CLI   EMDBMC,C' '                                                      
         JNH   FLTREC20                                                         
         LA    R4,X#MEDLS                                                       
         LLC   RF,X#MEDNO                                                       
FLTREC14 CLC   0(L'PMDKMED,R4),EMDBMC                                           
         JE    FLTREC20                                                         
         LA    R4,L'PMDKMED(R4)                                                 
         JCT   RF,FLTREC14                                                      
         J     FLTRECN                                                          
                                                                                
FLTREC16 TM    X#LLUIND,X#LLUIMQ   media LimList is use?                        
         JZ    FLTREC20                                                         
         CLI   RQ_ESOVR,C'N'                                                    
         JNE   FLTREC20                                                         
         CLI   EMDBMC,C' '                                                      
         JNH   FLTREC20                                                         
                                                                                
         LA    R1,X#MEDLL                                                       
                                                                                
FLTREC18 CLI   0(R1),C' '          end of list?                                 
         JNH   FLTRECN                                                          
         CLC   EMDBMC,0(R1)                                                     
         JE    FLTREC20                                                         
         AHI   R1,1                                                             
         J     FLTREC18                                                         
                                                                                
FLTREC20 CLI   X#SSTAT,FF                                                       
         JE    FLTREC50                                                         
         LA    RF,X#SSTAT                                                       
         LLC   RE,X#NOSTA          RE=Number of status entries                  
         USING STATABD,RF                                                       
FLTREC22 MVC   BYTE1,ESTRSTA1      Check status byte 1                          
         NC    BYTE1,STASTA1       Any match?                                   
         JZ    FLTREC30            No                                           
         OC    STASTA2,STASTA2     Do we have any status 2 to check             
         JNZ   FLTREC24            Yes                                          
         MVC   BYTE1,ESTRSTA2      No - check we have nothing                   
         NI    BYTE1,ESTKMERG+ESTKSINA                                          
         JZ    FLTREC26            Yes - match                                  
         J     FLTREC30            No - check next status entry in list         
                                                                                
FLTREC24 MVC   BYTE1,ESTRSTA2      Check status byte 2 matches                  
         NC    BYTE1,STASTA2                                                    
         JZ    FLTREC30                                                         
FLTREC26 CLI   STAAPPV,NOQ         Do we need to match approver                 
         JE    FLTREC32            No                                           
         CLI   STAAPPV,YESQ        Yes - check client approver                  
         JNE   FLTREC28                                                         
         CLC   CCTPID,EMDSCA       Does client approver match connected         
         JE    FLTREC32             user                                        
FLTREC28 CLI   STAAPPV,RQ_AWIAQ    Yes - check internal approver                
         JNE   FLTREC30                                                         
         CLC   CCTPID,EMDSIA       Does internal approver match                 
         JE    FLTREC32             connected user                              
FLTREC30 LA    RF,STATABL(RF)      RF=A(next entry of status list)              
         JCT   RE,FLTREC22                                                      
         J     FLTRECN                                                          
                                                                                
FLTREC32 ST    RF,ASTALST                                                       
         DROP  RF                                                               
                                                                                
FLTREC50 CLC   EMDADT,RQ_ESADS     added date filter                            
         JL    FLTRECN                                                          
         OC    RQ_ESADE,RQ_ESADE   Do we have an added end date                 
         JZ    *+14                                                             
         CLC   EMDADT,RQ_ESADE                                                  
         JH    FLTRECN                                                          
                                                                                
         CLC   EMDDAT,RQ_ESSTR     estimate date filter                         
         JL    FLTRECN                                                          
         OC    RQ_ESEND,RQ_ESEND   Do we have an estimate end date              
         JZ    *+14                                                             
         CLC   EMDDAT,RQ_ESEND                                                  
         JH    FLTRECN                                                          
                                                                                
         CLC   EMDLDT,RQ_ESLDS     activity date filter                         
         JL    FLTRECN                                                          
         OC    RQ_ESLDE,RQ_ESLDE   Do we have an activity end date              
         JZ    *+14                No                                           
         CLC   EMDLDT,RQ_ESLDE     Yes                                          
         JH    FLTRECN                                                          
                                                                                
         CLI   X#DESCL,FF          description filter                           
         JE    FLTREC56                                                         
         LA    R4,EMDEL                                                         
         LLC   R0,EMDLN                                                         
         AR    R4,R0                                                            
         CLI   ENMEL,ENMELQ                                                     
         JNE   FLTRECN                                                          
         MVC   X#TEMP,ENMNAME      (RD009235: avoid name to be set to           
         LLC   R1,ENMLN             upper case)                                 
         SHI   R1,ENMLNQ+1                                                      
         BASR  RF,0                                                             
         OC    X#TEMP(0),SPACES                                                 
         EX    R1,0(RF)                                                         
         AHI   R1,1                                                             
         LLC   RF,X#DESCL                                                       
         LR    RE,R1                                                            
         SR    RE,RF                                                            
         LTR   RE,RE                                                            
         JM    FLTRECN                                                          
         JP    *+8                                                              
         LA    RE,1                                                             
         LA    R1,X#TEMP                                                        
                                                                                
FLTREC54 BASR  R6,0                                                             
                                                                                
         CLC   0(0,R1),RQ_ESDES                                                 
         EX    RF,0(R6)                                                         
         JE    FLTREC56                                                         
         AHI   R1,1                                                             
         JCT   RE,FLTREC54                                                      
         J     FLTRECN                                                          
                                                                                
         USING PIDELD,R4                                                        
FLTREC56 XR    R0,R0                                                            
         LR    R4,R3                                                            
         MVI   BYTE2,0                                                          
                                                                                
FLTREC58 LLC   R0,PIDLN                                                         
         AR    R4,R0                                                            
                                                                                
         CLI   PIDEL,0                                                          
         JE    FLTREC90                                                         
         CLI   PIDEL,STCELQ                                                     
         JE    FLTREC62                                                         
         CLI   PIDEL,PIDELQ                                                     
         JNE   FLTREC58                                                         
                                                                                
         CLI   PIDTYPE,PIDTOWN     check owner if set                           
         JNE   FLTREC58                                                         
         OC    X#OWNER,X#OWNER                                                  
         JZ    FLTREC60                                                         
                                                                                
         LLC   R1,PIDNTR#                                                       
         LA    RF,PIDOWNR                                                       
                                                                                
FLTREC59 CLC   X#OWNER,0(RF)                                                    
         JE    FLTREC58                                                         
         AHI   RF,2                                                             
         JCT   R1,FLTREC59                                                      
         J     FLTRECN                                                          
                                                                                
FLTREC60 OC    X#CREBY,X#CREBY                                                  
         JZ    FLTREC58                                                         
                                                                                
         LLC   R1,PIDNTR#                                                       
         LA    RF,PIDOWNR                                                       
                                                                                
FLTREC61 CLC   X#CREBY,0(RF)                                                    
         JE    FLTREC58                                                         
         AHI   RF,2                                                             
         JCT   R1,FLTREC61                                                      
         J     FLTRECN                                                          
                                                                                
         USING STCELD,R4                                                        
FLTREC62 CLI   STCIND,STCIEST      BrandOcean estimate status changes           
         JNE   FLTREC68                                                         
         CLI   STCDTO,OCLIAPP      look for client approved                     
         JNE   FLTREC64                                                         
         OI    BYTE2,X'80'                                                      
         OC    X#ICAPP,X#ICAPP                                                  
         JZ    FLTREC66                                                         
         CLC   X#ICAPP,STCPERS                                                  
         JNE   FLTRECN                                                          
         J     FLTREC66                                                         
                                                                                
FLTREC64 CLI   STCDTO,OINTAPP      look for internally approved                 
         JNE   FLTREC58                                                         
         OI    BYTE2,X'08'                                                      
         CLC   STCDATE,RQ_ESIAS    internal approved date filter                
         JL    FLTRECN                                                          
         OC    RQ_ESIAE,RQ_ESIAE   Is there an end date                         
         JZ    *+14                No                                           
         CLC   STCDATE,RQ_ESIAE    Yes check it's not after this end            
         JH    FLTRECN                                       date               
         OC    X#INAPP,X#INAPP                                                  
         JZ    FLTREC58                                                         
         CLC   X#INAPP,STCPERS                                                  
         JNE   FLTRECN                                                          
         J     FLTREC58                                                         
                                                                                
FLTREC66 CLI   X#COMML,FF          look for approval comment                    
         JE    FLTREC58                                                         
         LLC   R1,X#COMML                                                       
         LLC   RF,STCLN                                                         
         SHI   RF,STCLN1Q+1                                                     
         LTR   RF,RF                                                            
         JM    FLTREC58                                                         
         BASR  R6,0                                                             
         OC    STCESCO(0),SPACES                                                
         EX    RF,0(R6)                                                         
         CR    R1,RF                                                            
         JH    FLTREC58                                                         
                                                                                
         BASR  R6,0                                                             
         CLC   STCESCO(0),RQ_ESACO                                              
         EX    R1,0(R6)                                                         
         JNE   FLTRECN                                                          
         J     FLTREC58                                                         
                                                                                
FLTREC68 CLI   STCIND,STCIECD                                                   
         JNE   FLTREC70                                                         
         MVC   TEMP2(3),STCDATE                                                 
         CLI   STCLN,STCLNSQ                                                    
         JNH   FLTREC58                                                         
         LLC   R1,STCLN                                                         
         SHI   R1,STCLNSQ+1                                                     
         LTR   R1,R1                                                            
         JM    FLTREC58                                                         
         BASR  R6,0                                                             
         MVC   TEMP2+3(0),STCCLNAM                                              
         EX    R1,0(R6)                                                         
         OC    TEMP2+3(36),SPACES                                               
         J     FLTREC58                                                         
                                                                                
FLTREC70 CLI   STCIND,STCIEST2     Aura estimate status changes                 
         JNE   FLTREC58                                                         
         CLI   STCETY2,STCECCN     Client authoriser                            
         JNE   FLTREC72                                                         
         LLC   R1,STCLN                                                         
         SHI   R1,STCELN1Q+1                                                    
         LTR   R1,R1                                                            
         JM    FLTREC58                                                         
         BASR  R6,0                                                             
         MVC   TEMP2+3(0),STCECNAM Extract client name                          
         EX    R1,0(R6)                                                         
         OC    TEMP2+3(36),SPACES                                               
         J     FLTREC58                                                         
                                                                                
FLTREC72 CLI   STCETY2,STCAPDTE    Client approver date                         
         JNE   FLTREC74                                                         
         MVC   TEMP2(3),STCECAPD                                                
         OI    BYTE2,X'80'                                                      
         OC    X#ICAPP,X#ICAPP                                                  
         JZ    FLTREC58                                                         
         CLC   X#ICAPP,STCPERS                                                  
         JNE   FLTRECN                                                          
         J     FLTREC58                                                         
                                                                                
FLTREC74 CLI   STCETY2,STCAPCMT    Client approver comment                      
         JE    *+12                                                             
         CLI   STCETY2,STCAPCMI    Internal approver comment                    
         JNE   FLTREC58                                                         
         CLI   X#COMML,FF          Look for approval comment                    
         JE    FLTREC58                                                         
         LLC   R1,X#COMML                                                       
         LLC   RF,STCLN                                                         
         SHI   RF,STCELN2Q+1                                                    
         LTR   RF,RF                                                            
         JM    FLTREC58                                                         
         BASR  R6,0                                                             
         OC    STCECOMM(0),SPACES                                               
         EX    RF,0(R6)                                                         
         CR    R1,RF                                                            
         JH    FLTREC58                                                         
                                                                                
         BASR  R6,0                                                             
         CLC   STCECOMM(0),RQ_ESACO                                             
         EX    R1,0(R6)                                                         
         JNE   FLTRECN                                                          
         J     FLTREC58                                                         
                                                                                
FLTREC90 TM    BYTE2,X'80'         ensure STC check 'int cli app'               
         JNZ   FLTREC92                                                         
         CLI   X#COMML,FF                                                       
         JNE   FLTRECN                                                          
         OC    X#ICAPP,X#ICAPP                                                  
         JNZ   FLTRECN                                                          
         OC    RQ_ESAAS,RQ_ESAAS                                                
         JNZ   FLTRECN                                                          
         OC    RQ_ESAAE,RQ_ESAAE                                                
         JNZ   FLTRECN                                                          
                                                                                
FLTREC92 TM    BYTE2,X'08'         ensure STC check 'int app'                   
         JNZ   FLTREC94                                                         
         OC    X#INAPP,X#INAPP                                                  
         JNZ   FLTRECN                                                          
         OC    RQ_ESIAS,RQ_ESIAS                                                
         JNZ   FLTRECN                                                          
         OC    RQ_ESIAE,RQ_ESIAE                                                
         JNZ   FLTRECN                                                          
                                                                                
FLTREC94 CLI   X#ACAPL,FF          client approver filtering                    
         JE    FLTREC96                                                         
         CLC   TEMP2+3(36),SPACES                                               
         JNH   FLTRECN                                                          
         LLC   R1,X#ACAPL                                                       
         BASR  R6,0                                                             
         CLC   TEMP2+3(0),RQ_ESACA                                              
         EX    R1,0(R6)                                                         
         JNE   FLTRECN                                                          
         J     FLTREC96                                                         
                                                                                
FLTREC96 CLC   TEMP2(3),RQ_ESAAS   client approved date filter                  
         JL    FLTRECN                                                          
         OC    RQ_ESAAE,RQ_ESAAE                                                
         JZ    *+14                                                             
         CLC   TEMP2(3),RQ_ESAAE                                                
         JH    FLTRECN                                                          
                                                                                
         XR    R1,R1                                                            
         ICM   R1,3,CUXPNUM       Only filter closed locked jobs for            
         CHI   R1,XPRODIKQ                               Aura                   
         JNE   FLTREC98                                                         
         LA    R4,X#SJACT                                                       
         LLC   RF,PPROLEN                                                       
         AR    R4,RF                                                            
         CLI   0(R4),C' '          Have we got a job                            
         JNH   FLTREC98            No skip job look up                          
                                                                                
         CLI   X#KTYPE,C'C'        read by C/P/J?                               
         JE    FLTREC98                                                         
                                                                                
         MVC   X#TEMP,SPACES       look for job                                 
         MVC   X#TEMP(L'ACTKUNT+L'ACTKLDG),SJUL                                 
         MVC   X#TEMP+L'ACTKUNT+L'ACTKLDG(L'ACTKACT),X#SJACT                    
         GOTOR VALACT              get from buffer                              
                                                                                
         CLI   RQ_ESCLS,YESQ       Do we care whether the job is locked         
         JNE   *+12                                       or closed             
         CLI   RQ_ESLKD,YESQ                                                    
         JE    FLTREC98            No as we've said to include all              
                                                                                
         CLI   RQ_ESLKD,C'O'       Do we only want locked jobs                  
         JNE   *+12                                                             
         CLI   X#TEMP+37,YESQ                                                   
         JNE   FLTRECN                                                          
                                                                                
         CLI   RQ_ESLKD,NOQ        Do we want no locked jobs                    
         JNE   *+12                                                             
         CLI   X#TEMP+37,YESQ      If job is locked skip this estimate          
         JE    FLTRECN                                                          
                                                                                
         CLI   RQ_ESCLS,C'O'       Do we only want closed jobs                  
         JNE   *+12                                                             
         CLI   X#TEMP+38,YESQ      If job if not closed skip this               
         JNE   FLTRECN                                        estimate          
                                                                                
         CLI   RQ_ESCLS,NOQ        Do we want no closed jobs                    
         JNE   *+12                                                             
         CLI   X#TEMP+38,YESQ      If job is closed skip this estimate          
         JE    FLTRECN                                                          
                                                                                
FLTREC98 CLI   X#MEDLS,C' '                                                     
         JNH   FLTRE110                                                         
         CLI   ESTKJOB,C' '                                                     
         JH    FLTRE100                                                         
         CLI   X#KTYPE,C'L'                                                     
         JE    FLTRECN                                                          
         J     FLTRE110                                                         
FLTRE100 LA    R3,X#MEDLS                                                       
         LLC   RF,X#MEDNO                                                       
FLTRE102 CLC   0(L'PMDKMED,R3),ESTKJOB                                          
         JE    FLTRE110                                                         
         LA    R3,L'PMDKMED(R3)                                                 
         JCT   RF,FLTRE102                                                      
         J     FLTKEYN                                                          
                                                                                
FLTRE110 DS    0H                  More filtering?                              
                                                                                
FLTRECY  L     RE,FULL1                                                         
         CR    RE,RE                                                            
         BR    RE                                                               
FLTRECN  L     RE,FULL1                                                         
         LTR   RE,RE                                                            
         BR    RE                                                               
         DROP  R2,R3,R4                                                         
***********************************************************************         
* Get Audit record values                                             *         
* (on entry AIO2 contains estimate record, reestablish IO sequence    *         
*  via CSVKEY2)                                                       *         
***********************************************************************         
         SPACE 1                                                                
         USING AUDRECD,R2                                                       
         USING ESTRECD,R3                                                       
AUDVALS  NTR1  BASE=*                                                           
         J     *+12                                                             
         DC    C'**AUDV**'                                                      
         L     R3,AIO2                                                          
         LA    R2,IOKEY                                                         
         XC    X#FPROG(X#PDDTQ),X#FPROG                                         
                                                                                
         XC    IOKEY,IOKEY                                                      
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,ESTKCPY                                                  
         MVI   AUDKAUDT,AUDKEST                                                 
                                                                                
         LA    R4,AUDKECPJ         Adapt for type of key                        
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,R4),ESTKCLI                                                  
         EX    RF,0(R1)                                                         
         AHI   RF,1                                                             
         AR    R4,RF                                                            
         LLC   RE,PPROLEN                                                       
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         MVC   0(0,R4),ESTKPRO                                                  
         EX    RE,0(R1)                                                         
         AHI   RE,1                                                             
         AR    R4,RE                                                            
         LHI   RF,L'ESTKJOB-1                                                   
         BASR  R1,0                                                             
         MVC   0(0,R4),ESTKJOB                                                  
         EX    RF,0(R1)                                                         
         OC    AUDKECPJ,SPACES                                                  
         MVC   AUDKELNO,ESTKLNO                                                 
         MVI   AUDKSEQ,0                                                        
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
***      JNE   *+2                 error audit doesn't exist                    
         JNE   AUDVALSX                                                         
                                                                                
         MVC   CSVKEY3,IOKEY                                                    
         J     AUDVALS2                                                         
                                                                                
AUDVALS1 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         JNE   *+2                                                              
                                                                                
         CLC   CSVKEY3(AUDKSEQ-AUDRECD),IOKEY                                   
         JNE   AUDVALSX                                                         
                                                                                
AUDVALS2 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                 error audit doesn't exist                    
                                                                                
         L     R2,AIO1                                                          
         LA    R4,AUDRFST                                                       
                                                                                
         USING STCELD,R4                                                        
AUDVALS3 CLI   STCEL,0                                                          
         JE    AUDVALS1                                                         
         CLI   STCEL,STCELQ                                                     
         JE    AUDVALS5                                                         
                                                                                
AUDVALS4 LLC   R0,STCLN                                                         
         AR    R4,R0                                                            
         J     AUDVALS3                                                         
                                                                                
AUDVALS5 CLI   STCIND,STCIEST2     Aura estimates status changes                
         JNE   AUDVAL5A                                                         
         CLI   STCETY2,STCESTA     Check for status change                      
         JNE   AUDVALS4                                                         
         LA    RE,X#FPROG                                                       
         CLI   STCECES,OINPROG                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FSUBI                                                       
         CLI   STCECES,OSUBINT                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FIAPP                                                       
         CLI   STCECES,OINTAPP                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FSUBC                                                       
         CLI   STCECES,OSUBCLI                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FCAPP                                                       
         CLI   STCECES,OCLIAPP                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FMRGD                                                       
         CLI   STCECES,STCEMRGD                                                 
         JE    AUDVALS6                                                         
         LA    RE,X#FREJT                                                       
         CLI   STCECES,OREJECT                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FDELT                                                       
         CLI   STCECES,OLOGDEL                                                  
         JNE   AUDVALS4                                                         
         J     AUDVALS6                                                         
*                                                                               
AUDVAL5A CLI   STCIND,STCIEST      BrandOcean estimates status changes          
         JNE   AUDVALS4                                                         
         LA    RE,X#FPROG                                                       
         CLI   STCDTO,STCEPROG                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FSUBI                                                       
         CLI   STCDTO,STCESUBI                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FIAPP                                                       
         CLI   STCDTO,STCEIAPP                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FSUBC                                                       
         CLI   STCDTO,STCESUBC                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FCAPP                                                       
         CLI   STCDTO,STCECAPP                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FMRGD                                                       
         CLI   STCDTO,STCEMRGD                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FREJT                                                       
         CLI   STCDTO,STCEREJT                                                  
         JE    AUDVALS6                                                         
         LA    RE,X#FDELT                                                       
         CLI   STCDTO,STCEDELT                                                  
         JNE   AUDVALS4                                                         
*                                                                               
AUDVALS6 MVC   0(L'X#FCAPP,RE),STCPERS                                          
         MVC   L'X#FCAPP(L'X#FCAPPD,RE),STCDATE                                 
         J     AUDVALS4                                                         
                                                                                
AUDVALSX DS    0H                                                               
         OC    X#FREJT,X#FREJT     Did we get a rejected person                 
         JZ    AUDVALX2                                                         
         XC    X#FCAPP,X#FCAPP     yes - clear any approvals                    
         XC    X#FIAPP,X#FIAPP                                                  
AUDVALX2 MVC   IOKEY,CSVKEY2                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
***********************************************************************         
* LOOK THROUGH USER'S LIMIT LIST TO SEE WHAT IS IN USE                *         
***********************************************************************         
K        USING GAPTABD,GAPAREA                                                  
LLSUSE   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*LLSUSE*'                                                      
                                                                                
         XC    GAPAREA,GAPAREA                                                  
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
*                                                                               
LLSUSE10 CLI   K.GAPTDAT1,GAPTT2Q                                               
         JNE   LLSUSE20                                                         
         CLC   K.GAPTACT,SPACES    if 1st entry is spaces                       
         JNH   LLSUSE15            means default access=y                       
         MVC   GAPAREA2,GAPAREA                                                 
         OI    X#LLUIND,X#LLUICQ   C/P/J in use                                 
LLSUSE15 GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         TM    ATSRERRS,TSEEOF                                                  
         JNZ   LLSUSEY             End of buffer                                
         CLI   K.GAPTDAT1,GAPTT2Q                                               
         JE    LLSUSE15                                                         
                                                                                
LLSUSE20 CLI   K.GAPTDAT1,GAPTT4Q                                               
         JNE   LLSUSE30                                                         
         CLC   K.GAPTACT,SPACES    if 1st entry is spaces                       
         JNH   LLSUSE25            means default access=y                       
         MVC   GAPAREA3,GAPAREA                                                 
         OI    X#LLUIND,X#LLUISQ   Schemes in use                               
LLSUSE25 GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         TM    ATSRERRS,TSEEOF                                                  
         JNZ   LLSUSEY             End of buffer                                
         CLI   K.GAPTDAT1,GAPTT4Q                                               
         JE    LLSUSE25                                                         
                                                                                
LLSUSE30 CLI   K.GAPTDAT1,GAPTT5Q                                               
         JNE   LLSUSE10                                                         
         CLC   K.GAPTACT,SPACES    if 1st entry is spaces                       
         JNH   LLSUSE40            means default access=y + no limlist          
         OI    X#LLUIND,X#LLUIMQ   media in use                                 
         LA    R2,X#MEDLL                                                       
LLSUSE35 MVC   0(L'GAPTMEDI,R2),K.GAPTMEDI                                      
         AHI   R2,L'GAPTMEDI                                                    
LLSUSE40 GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         TM    ATSRERRS,TSEEOF                                                  
         JNZ   LLSUSEY             End of buffer                                
         CLI   K.GAPTDAT1,GAPTT5Q                                               
         JE    LLSUSE35                                                         
         J     LLSUSE10                                                         
                                                                                
LLSUSEY  J     EXIT                                                             
         DROP  K                                                                
                                                                                
K        USING GAPTABD,GAPAREA                                                  
FLTSCH   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*FLTSCH*'                                                      
                                                                                
         MVC   GAPAREA,GAPAREA3                                                 
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
FLTSCH02 TM    ATSRERRS,TSEEOF                                                  
         JNZ   FLTSCHN             End of buffer                                
FLTSCH03 CLI   K.GAPTDAT1,GAPTT4Q                                               
         JNE   FLTSCH04                                                         
         CLC   K.GAPTSCH,WORK                                                   
         JE    FLTSCHY                                                          
FLTSCH04 GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         J     FLTSCH02                                                         
                                                                                
FLTSCHY  J     EXITY                                                            
                                                                                
FLTSCHN  J     EXITN                                                            
         DROP  K                                                                
                                                                                
***********************************************************************         
* Output estimate (record received in IO2) for list and search        *         
***********************************************************************         
                                                                                
OUTEST   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*OUTEST*'                                                      
                                                                                
         LA    R0,EL_VALS          clear output area                            
         LA    R1,EL_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         USING ESTRECD,R2                                                       
         L     R2,AIO2                                                          
         LA    R3,ESTRFST                                                       
         USING EMDELD,R3                                                        
         CLI   EMDEL,EMDELQ                                                     
         JNE   *+2                                                              
                                                                                
         MVC   EL_LONO,ESTKLNO                                                  
         MVC   EL_GAPST,EMDGSTAT                                                
         MVI   EL_WCTM,NOQ                                                      
         MVI   EL_ITTM,NOQ                                                      
         MVI   EL_ITMS,NOQ                                                      
         TM    ESTRSTA3,ESTSWCTM   Do we have wc time                           
         JZ    *+8                                                              
         MVI   EL_WCTM,YESQ        Yes                                          
         TM    ESTRSTA3,ESTSITTM   Do we have item level time                   
         JZ    *+8                                                              
         MVI   EL_ITTM,YESQ        Yes                                          
         TM    ESTRSTA3,ESTSITMS   Do we have items                             
         JZ    *+8                                                              
         MVI   EL_ITMS,YESQ        Yes                                          
                                                                                
         LA    RE,STATAB                                                        
         USING STATABD,RE                                                       
OUTEST02 MVC   BYTE1,ESTRSTA1      Check status byte 1                          
         NC    BYTE1,STASTA1       Any match?                                   
         JZ    OUTEST06            No                                           
         OC    STASTA2,STASTA2     Do we have any status 2 to check             
         JNZ   OUTEST04            Yes                                          
         MVC   BYTE1,ESTRSTA2      No - check we have nothing                   
         NI    BYTE1,ESTKMERG+ESTKSINA                                          
         JZ    OUTEST10            Yes - match                                  
         J     OUTEST06            No - check next status entry in list         
                                                                                
OUTEST04 MVC   BYTE1,ESTRSTA2      Check status byte 2 matches                  
         NC    BYTE1,STASTA2                                                    
         JNZ   OUTEST10            Matches entry                                
OUTEST06 LA    RE,STATABL(RE)      RF=A(next entry of status list)              
         CLI   STACHAR,C'*'        Have we reached end of table                 
         JNE   OUTEST02            No                                           
         DC    H'0'                Yes - die as we should find                  
*                                   something                                   
OUTEST10 MVC   EL_STAT,STACHAR                                                  
         XR    R1,R1                                                            
         ICM   R1,B'0011',CUXPNUM  For Aura never set merge                     
         CHI   R1,XPRODIKQ                                                      
         JNE   OUTEST12                                                         
         CLI   EL_STAT,RQ_ELSMQ    Merged?                                      
         JNE   OUTEST12                                                         
         MVI   EL_STAT,RQ_ELSDQ    No, must be logically deleted                
         DROP  RE                                                               
                                                                                
OUTEST12 MVI   EL_ASTA,NOQ         supposed approver status                     
         TM    X#ISUAPP,X#ISESTQ                                                
         JZ    OUTEST14                                                         
         CLC   CCTPID,EMDSCA      checked user is supposed approver             
         JNE   OUTEST14                                                         
         MVI   EL_ASTA,YESQ                                                     
                                                                                
OUTEST14 MVC   EL_CLIC(L'ESTKCLI),ESTKCLI                                       
         MVC   EL_PROC(L'ESTKPRO),ESTKPRO                                       
         MVC   EL_JOBC(L'ESTKJOB),ESTKJOB                                       
         MVC   EL_OFFC,ESTRSOFF                                                 
                                                                                
         MVC   TEMP2,SPACES                                                     
         MVC   TEMP2(L'PRODUL),PRODUL                                           
         LA    RF,TEMP2+L'PRODUL                                                
         LA    RE,ESTKCLI                                                       
         LLC   R1,PCLILEN                                                       
         SHI   R1,1                                                             
         BASR  R4,0                                                             
         MVC   0(0,RF),0(RE)       move in Client code                          
         EX    R1,0(R4)                                                         
                                                                                
         LA    RE,ESTKPRO                                                       
         LA    RF,1(R1,RF)                                                      
         LLC   R0,PCLILEN                                                       
         LLC   R1,PPROLEN                                                       
         SR    R1,R0                                                            
         SHI   R1,1                                                             
         BASR  R4,0                                                             
         MVC   0(0,RF),0(RE)       move in Product code                         
         EX    R1,0(R4)                                                         
                                                                                
         LA    RE,ESTKJOB                                                       
         LA    RF,1(R1,RF)                                                      
         LLC   R0,PPROLEN                                                       
         LLC   R1,PJOBLEN                                                       
         SR    R1,R0                                                            
         CHI   R1,6                                                             
         JNH   *+8                                                              
         LA    R1,6                                                             
         SHI   R1,1                                                             
         BASR  R4,0                                                             
         MVC   0(0,RF),0(RE)       move in Job code                             
         EX    R1,0(R4)                                                         
         MVC   X#SJACT,TEMP2+L'PRODUL  Save SJ account code                     
                                                                                
         CLI   X#GAOV,YESQ                                                      
         JE    OUTEST16                                                         
         MVC   EL_MEDC,ESTKJOB                                                  
         MVC   EL_SCAP(2),EMDSCA                                                
         MVC   EL_SIAP(2),EMDSIA                                                
         MVI   EL_PRRAT,YESQ       init to print rates                          
         TM    EMDSTA,EMDSRQ       test suppressing rates                       
         JZ    *+8                                                              
         MVI   EL_PRRAT,NOQ        don't print rates                            
         CLI   ESTKJOB,C' '                                                     
         JH    OUTEST16                                                         
         MVC   EL_MEDC,EMDBMC                                                   
                                                                                
OUTEST16 MVC   X#MEDC,EL_MEDC      Set element data                             
         MVC   EL_GLNO,EMDGNO                                                   
         MVC   EL_ADDD,EMDADT                                                   
         MVC   EL_EDAT,EMDDAT                                                   
         ZAP   EL_TAMT,EMDAMT                                                   
         ZAP   EL_IWCT,PZERO                                                    
         ZAP   EL_XWCT,PZERO                                                    
*                                                                               
         CLI   EMDLN,EMDLNQ        Check element is long enough                 
         JNH   OUTEST17                                                         
         ZAP   EL_IWCT,EMDTIWT                                                  
         ZAP   EL_XWCT,EMDTXWT                                                  
*                                                                               
OUTEST17 MVC   EL_ADDP(2),EMDAPI                                                
         CLI   X#GAOV,YESQ                                                      
         JE    OUTEST34                                                         
         MVC   EL_ACTD,EMDLDT                                                   
         XC    WORK(L'EMDLTI+1),WORK                                            
         XC    WORK2(L'EL_ACTT+1),WORK2                                         
         MVC   WORK(L'EMDLTI),EMDLTI                                            
                                                                                
* Protect against bad time as causes FACXML to fail                             
* remove printable characters                                                   
                                                                                
         CLI   WORK,X'23'          Can't be higher than 11pm                    
         JL    *+10                                                             
         XC    WORK(1),WORK                                                     
         CLI   WORK+1,X'60'        Can't have more than 60 minutes              
         JL    *+10                                                             
         XC    WORK+1(1),WORK+1                                                 
         CLI   WORK+2,X'60'        Can't have more than 60 seconds              
         JL    *+10                                                             
         XC    WORK+2(1),WORK+2                                                 
         LHI   RF,3                                                             
         LA    R1,WORK                                                          
OUTEST18 MVC   BYTE1,0(R1)         ensure second nibble can't higher            
         NI    BYTE1,X'0F'            than nine for hours mins secs             
         CLI   BYTE1,9                                                          
         JNH   OUTEST20                                                         
         NI    0(R1),X'F0'         remove if it is and make zero                
OUTEST20 LA    R1,1(R1)                                                         
         JCT   RF,OUTEST18                                                      
                                                                                
         MVI   WORK+L'EMDLTI,X'0D'  trick into being packed decimal             
         UNPK  WORK2(L'EL_ACTT+1),WORK(L'EMDLTI+1)                              
         MVC   EL_ACTT,WORK2                                                    
         MVC   EL_ACTP(2),EMDLPI                                                
         MVC   EL_CURR,EMDCUR                                                   
         MVC   EL_NODP,EMDNDP                                                   
         ZAP   EL_FAMT,EMDFCA                                                   
         MVC   EL_SCHC,EMDSCH                                                   
         MVC   EL_ACUR,AGYCURR                                                  
         MVI   EL_CONI,NOQ                                                      
         MVI   EL_CONC,NOQ                                                      
         GOTOR GETAPP,DMCB,X#SJACT,ESTRSOFF                                     
         TM    X#BYTE2,X'40'                                                    
         JZ    *+8                                                              
         MVI   EL_CONI,YESQ      user is valid internal approver                
         TM    X#BYTE2,X'04'                                                    
         JZ    *+8                                                              
         MVI   EL_CONC,YESQ      user is valid client approver                  
                                                                                
         L     RF,ASTALST        Double check user is an approver               
         USING STATABD,RF                                                       
         CLI   STAAPPV,YESQ      Are we looking for those est awaiting          
         JE    OUTEST22           my client approval                            
         CLI   STAAPPV,RQ_AWOTQ  Or awaiting others                             
         JE    OUTEST22                                                         
         CLI   STAAPPV,RQ_AWBTQ  Or awaiting either client or internal          
         JNE   OUTEST28                       approval                          
         CLI   EL_STAT,RQ_ELSBQ  Is this estimate submitted internally          
         JE    OUTEST30          Yes                                            
OUTEST22 CLI   EL_CONC,YESQ      Check connect user can client approve          
         JNE   OUTESTX           No - don't return this estimate                
         CLI   STAAPPV,RQ_AWOTQ  If awaiting others                             
         JNE   OUTEST28                                                         
         CLC   EMDSCA,CCTPID     check connected user is the selected           
         JNE   OUTESTX            client approver otherwise ignore              
         MVI   EL_CONI,NOQ       Set they aren't the internal approver          
                                                                                
OUTEST28 CLI   STAAPPV,RQ_AWIAQ                                                 
         JNE   OUTEST32                                                         
OUTEST30 CLI   EL_CONI,YESQ      Check connect user can int approve             
         JNE   OUTESTX           No - don't return this estimate                
         DROP  RF                                                               
                                                                                
OUTEST32 MVC   EL_INTU,SPACES                                                   
         TM    G#OFSTA2,OFFSIAEQ   Internal approvals in use?                   
         JZ    OUTEST34                                                         
         MVC   EL_INTU,EMDIUS                                                   
                                                                                
OUTEST34 MVC   EL_IDNO,EMDIDN                                                   
                                                                                
         LLC   R0,EMDLN                                                         
         AR    R3,R0                                                            
         USING ENMELD,R3                                                        
OUTEST35 CLI   ENMEL,0                                                          
         JE    OUTEST36                                                         
         CLI   ENMEL,ENMELQ                                                     
         JE    OUTEST3B                                                         
         CLI   ENMEL,GDAELQ                                                     
         JE    OUTEST3C                                                         
OUTEST3A LLC   R0,ENMLN                                                         
         AR    R3,R0                                                            
         J     OUTEST35                                                         
                                                                                
OUTEST3B LLC   RE,ENMLN            Set name                                     
         SHI   RE,ENMLNQ+1                                                      
         LTR   RE,RE                                                            
         JM    OUTEST3A                                                         
         BASR  R4,0                                                             
         MVC   EL_NAME(0),ENMNAME                                               
         EX    RE,0(R4)                                                         
         J     OUTEST3A                                                         
                                                                                
         USING GDAELD,R3                                                        
OUTEST3C LA    RF,EL_GAPSD                                                      
         CLI   GDATYPE,GDAGAPST    Red for GAP sent date                        
         JE    OUTEST3D                                                         
         LA    RF,EL_GAPED                                                      
         CLI   GDATYPE,GDAGAPEX    Read for GAP expiry date                     
         JNE   OUTEST3A                                                         
OUTEST3D MVC   0(L'GDADATE,RF),GDADATE                                          
         J     OUTEST3A                                                         
                                                                                
OUTEST36 MVC   X#TEMP,SPACES       look for client                              
         MVC   X#TEMP(L'ACTKUNT+L'ACTKLDG),SJUL                                 
         LLC   R1,PCLILEN                                                       
         SHI   R1,1                                                             
         BASR  R4,0                                                             
         MVC   X#TEMP+L'ACTKUNT+L'ACTKLDG(0),X#SJACT                            
         EX    R1,0(R4)            Move in client code                          
                                                                                
         GOTOR VALACT              get from buffer                              
         MVC   EL_CLIN,X#TEMP                                                   
                                                                                
         CLC   EL_PROC,SPACES                                                   
         JNH   OUTEST40                                                         
         MVC   X#TEMP,SPACES       look for product                             
         MVC   X#TEMP(L'ACTKUNT+L'ACTKLDG),SJUL                                 
         LLC   R1,PPROLEN                                                       
         SHI   R1,1                                                             
         BASR  R4,0                                                             
         MVC   X#TEMP+L'ACTKUNT+L'ACTKLDG(0),X#SJACT                            
         EX    R1,0(R4)            Move in Product code                         
         GOTOR VALACT              get from buffer                              
         MVC   EL_PRON,X#TEMP                                                   
                                                                                
         CLC   EL_JOBC,SPACES                                                   
         JNH   OUTEST40                                                         
         MVC   X#TEMP,SPACES       look for job                                 
         MVC   X#TEMP(L'ACTKUNT+L'ACTKLDG),SJUL                                 
         LLC   R1,PJOBLEN                                                       
         SHI   R1,1                                                             
         BASR  R4,0                                                             
         MVC   X#TEMP+L'ACTKUNT+L'ACTKLDG(0),X#SJACT                            
         EX    R1,0(R4)            Move in Job code                             
         GOTOR VALACT              get from buffer                              
         MVC   EL_JOBN,X#TEMP                                                   
         MVC   EL_JOBS,X#TEMP+36                                                
         MVC   EL_JOBL,X#TEMP+37                                                
         MVC   EL_JOBCL,X#TEMP+38                                               
         MVC   EL_FLT1(L'ACTKSAF1*5),X#TEMP+42                                  
                                                                                
OUTEST38 DS    0H                                                               
*&&US                                                                           
         MVC   EL_AEHR,X#TEMP+39   JOBAEHR#                                     
         MVC   EL_AEOE,X#TEMP+40   JOBAEOE#                                     
         MVC   EL_AECE,X#TEMP+41   JOBAECE#                                     
*&&                                                                             
                                                                                
OUTEST40 CLI   X#GAOV,YESQ         set indirect values (unless GAOV)            
         JE    OUTEST42                                                         
         MVC   X#TEMP,SPACES       look for media                               
         MVC   X#TEMP(L'EL_MEDC),EL_MEDC                                        
         GOTOR VALMED              get from buffer                              
         MVC   EL_MEDN,X#TEMP                                                   
                                                                                
OUTEST42 MVC   X#TEMP,SPACES       look for person                              
         MVC   X#TEMP(L'PIDKPID),EL_ADDP                                        
         GOTOR VALPRC              get from buffer                              
         JNE   OUTEST44                                                         
         MVC   EL_ADDP,X#TEMP                                                   
         MVC   EL_ADDF,X#TEMP+8                                                 
         MVC   EL_ADDL,X#TEMP+24                                                
                                                                                
OUTEST44 CLI   X#GAOV,YESQ                                                      
         JE    OUTEST50                                                         
         MVC   X#TEMP,SPACES       look for person                              
         MVC   X#TEMP(L'PIDKPID),EL_ACTP                                        
         GOTOR VALPRC              get from buffer                              
         JNE   OUTEST46                                                         
         MVC   EL_ACTP,X#TEMP                                                   
         MVC   EL_ACTF,X#TEMP+8                                                 
         MVC   EL_ACTL,X#TEMP+24                                                
                                                                                
OUTEST46 OC    EL_SCAP(2),EL_SCAP                                               
         JZ    OUTEST48                                                         
         MVC   X#TEMP,SPACES       look for approver (same as person)           
         MVC   X#TEMP(L'PIDKPID),EL_SCAP                                        
         GOTOR VALPRC              get from buffer                              
         JNE   OUTEST48                                                         
         MVC   EL_SCAP,X#TEMP                                                   
         MVC   EL_SCAF,X#TEMP+8                                                 
         MVC   EL_SCAL,X#TEMP+24                                                
                                                                                
OUTEST48 OC    EL_SIAP(2),EL_SIAP                                               
         JZ    OUTEST50                                                         
         MVC   X#TEMP,SPACES       look for approver (same as person)           
         MVC   X#TEMP(L'PIDKPID),EL_SIAP                                        
         GOTOR VALPRC              get from buffer                              
         JNE   OUTEST50                                                         
         MVC   EL_SIAP,X#TEMP                                                   
                                                                                
OUTEST50 CLI   EL_STAT,RQ_ELSAQ    only show approved date for                  
         JNE   OUTEST80             client approved estimates                   
                                                                                
         LA    R3,ESTRFST                                                       
         USING STCELD,R3                                                        
OUTEST56 CLI   STCEL,0             End of record                                
         JE    OUTEST80            Yes                                          
         CLI   STCEL,STCELQ        Look for status element to get               
         JE    OUTEST60              approval date                              
OUTEST58 LLC   R0,STCLN                                                         
         AR    R3,R0                                                            
         J     OUTEST56                                                         
                                                                                
OUTEST60 CLI   STCIND,STCIECD      Check for old style brandocean               
         JNE   OUTEST70             element                                     
         MVC   EL_APDT,STCDATE                                                  
         J     OUTEST80                                                         
                                                                                
OUTEST70 CLI   STCIND,STCIEST2     Otherwise look at new Aura element           
         JNE   OUTEST58                                                         
         CLI   STCETY2,STCAPDTE    Look for approval date                       
         JNE   OUTEST58                                                         
         MVC   EL_APDT,STCECAPD                                                 
                                                                                
OUTEST80 GOTOR LP_APUTO,LP_D                                                    
         LH    RF,X#ESTCNT                                                      
         AHI   RF,1                                                             
         STH   RF,X#ESTCNT                                                      
                                                                                
OUTESTX  J     EXIT                                                             
         DROP  R2,R3                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
* List of Estimates for Summary                                       *         
***********************************************************************         
                                                                                
SUMLST   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SUMLST*'                                                      
                                                                                
         MVI   X#SUMCNT,100        set counter to 100 estimates                 
                                                                                
         USING EADPASD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    EADPAS,EADPAS                                                    
         MVI   EADPTYP,EADPTYPQ                                                 
         MVI   EADPSUB,EADPSUBQ                                                 
         MVC   EADPCPY,CUXCPY                                                   
         MVC   EADPOFF,SPACES                                                   
                                                                                
         CLI   CUACCS,C'*'         single limit access?                         
         JNE   SUMLST05                                                         
         TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   SUMLST05                                                         
         MVC   EADPOFF,SPACES                                                   
         MVC   EADPOFF(1),CUACCS+1 set office                                   
                                                                                
SUMLST05 MVC   CSVKEY1,EADPAS                                                   
                                                                                
SUMLST10 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    SUMLST20                                                         
         DC    H'0'                                                             
                                                                                
SUMLST15 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
SUMLST20 CLC   CSVKEY1(EADPDAT-EADPASD),EADPAS                                  
         JNE   SUMLSTX                                                          
                                                                                
         CLI   CUACCS,0            any limit access?                            
         JNE   SUMLST25                                                         
         CLC   EADPOFF,SPACES                                                   
         JNH   SUMLST35                                                         
         J     SUMLSTX                                                          
                                                                                
         USING OFFALD,R1                                                        
SUMLST25 L     R1,AOFFAREA                                                      
         MVI   OFFAACT,OFFAVAL                                                  
         CLI   CUACCS,C'*'         single limit access?                         
         JNE   SUMLST30                                                         
         TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   SUMLST30                                                         
         MVC   OFFAOFFC,EADPOFF                                                 
         GOTO1 VOFFAL                                                           
         JE    SUMLST35                                                         
         J     SUMLSTX                                                          
                                                                                
SUMLST30 MVC   OFFAOFFC,EADPSOFF   use office in status                         
         GOTO1 VOFFAL                                                           
         JE    SUMLST35                                                         
         J     SUMLST15                                                         
         DROP  R1                                                               
                                                                                
SUMLST35 MVC   CSVKEY2,EADPAS                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING ESTRECD,R2                                                       
         L     R2,AIO2                                                          
                                                                                
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM  Aura?                                        
         CHI   RF,XPRODIKQ                                                      
         JNE   SUMLST36                                                         
         CLI   ESTKJOB,ESTKBPQ                                                  
         JE    SUMLST15                                                         
                                                                                
SUMLST36 GOTOR MEDLLF                                                           
         JNE   SUMLST40                                                         
         LA    RF,ESTRFST                                                       
                                                                                
         USING EMDELD,RF                                                        
         CLI   EMDEL,EMDELQ                                                     
         JNE   *+2                                                              
         MVC   WORK(L'EMDSCH),EMDSCH                                            
         DROP  RF                                                               
                                                                                
         TM    X#LLUIND,X#LLUISQ   Schemes in use                               
         JZ    SUMLST37                                                         
         GOTOR FLTSCH                                                           
         JNE   SUMLST40                                                         
                                                                                
SUMLST37 LA    R4,X#SSTAT                                                       
         MVC   L'STASTA1+L'STASTA2(L'STAAPPV,R4),RQ_ELAPP                       
         ST    R4,ASTALST                                                       
                                                                                
         GOTOR OUTEST              output estimate record                       
                                                                                
         LLC   R1,X#SUMCNT         decrement counter                            
         SHI   R1,1                                                             
         STC   R1,X#SUMCNT                                                      
         CLI   X#SUMCNT,0                                                       
         JE    SUMLSTX                                                          
                                                                                
         USING EADPASD,R2                                                       
SUMLST40 LA    R2,IOKEY                                                         
         MVC   EADPAS,CSVKEY2                                                   
         LLC   RE,EADPNUM+L'EADPNUM-1                                           
         AHI   RE,1                                                             
         STC   RE,EADPNUM+L'EADPNUM-1                                           
         J     SUMLST10                                                         
                                                                                
SUMLSTX  J     EXIT                                                             
         DROP  R2                                                               
***********************************************************************         
* Estimate list - filter 0(R1) against LimList tables                 *         
***********************************************************************         
                                                                                
ELFBLL   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ELFBLL*'                                                      
*                                                                               
         LR    R2,R1                                                            
         USING GAPTABD,R3                                                       
         USING ELFD,R2                                                          
*                                                                               
         LA    R1,X#MEDLL                                                       
         CLI   ELFJOB,C' '                                                      
         JNH   ELFBLL15                                                         
         TM    X#LLUIND,X#LLUIMQ                                                
         JZ    ELFBLL15                                                         
*                                                                               
ELFBLL05 CLI   0(R1),C' '                                                       
         JNH   ELFBLL10                                                         
         CLC   0(1,R1),ELFJOB     (first byte of job is media code)             
         JE    ELFBLL15                                                         
         AHI   R1,1                                                             
         J     ELFBLL05                                                         
*                                                                               
ELFBLL10 LLC   R1,ELFJOB                                                        
         AHI   R1,1                                                             
         MVC   ELFJOB,SPACES                                                    
         STC   R1,ELFJOB                                                        
         XC    ELFLNO,ELFLNO                                                    
         J     ELFBLLN                                                          
*                                                                               
ELFBLL15 TM    X#LLUIND,X#LLUICQ   C/P/J in use                                 
         JZ    ELFBLLY                                                          
*                                                                               
         XC    BYTE2,BYTE2                                                      
         LA    R3,GAPAREA          point to table                               
         MVC   GAPAREA,GAPAREA2                                                 
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
ELFBLL16 TM    ATSRERRS,TSEEOF                                                  
         JNZ   *+2                 Buffer is NOT empty                          
*                                  there should be a C/P/J in the table         
         CLI   GAPTDAT1,GAPTT2Q                                                 
         JE    ELFBLL18                                                         
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF            skip all other types                         
         J     ELFBLL16                                                         
*                                                                               
ELFBLL18 XC    WORK(L'GAPTACC),WORK                                             
         MVI   BYTE3,1             client                                       
         CLC   ELFPRO,SPACES                                                    
         JNH   ELFBLL20                                                         
         MVI   BYTE3,2             product                                      
         CLC   ELFJOB,SPACES                                                    
         JNH   ELFBLL20                                                         
         MVI   BYTE3,3             job                                          
*                                                                               
ELFBLL20 CLI   GAPTLVL,GAPTSL0                                                  
         JE    ELFBLL25                                                         
         MVC   WORK(L'GAPTACC),GAPTACC                                          
         LA    R6,GAPTACC                                                       
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         CLC   0(0,R6),ELFCLI      match on entry?                              
         EX    RF,0(R1)                                                         
         JNE   ELFBLL25                                                         
         CLI   GAPTLVL,GAPTSL2     client level?                                
         JNE   ELFBLL22                                                         
         CLC   GAPTCOFF,ELFOFFC                                                 
         JE    ELFBLLY                                                          
         OI    BYTE2,X'20'         'soft' client match (to cope with            
         J     ELFBLL25            mixed offices at product level)              
*                                                                               
ELFBLL22 CLI   BYTE3,1             client?                                      
         JE    ELFBLL25                                                         
         OI    BYTE2,X'80'         matched at client level                      
         AHI   RF,1                                                             
         AR    R6,RF                                                            
         LLC   RE,PPROLEN                                                       
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         CLC   0(0,R6),ELFPRO                                                   
         EX    RE,0(R1)                                                         
         JNE   ELFBLL25                                                         
         CLI   GAPTLVL,GAPTSL3     product level?                               
         JNE   ELFBLL24                                                         
         CLC   GAPTCOFF,ELFOFFC                                                 
         JE    ELFBLLY                                                          
         J     ELFBLL25                                                         
ELFBLL24 CLI   BYTE3,2             product?                                     
         JE    ELFBLL25                                                         
         OI    BYTE2,X'40'         matched at product level                     
         AHI   RE,1                                                             
         AR    R6,RE                                                            
         LLC   RF,PPROLEN                                                       
         LLC   RE,PJOBLEN                                                       
         SR    RE,RF                                                            
         CHI   RE,L'ESTKJOB                                                     
         JNH   *+8                                                              
         LHI   RE,L'ESTKJOB                                                     
*                                                                               
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         CLC   0(0,R6),ELFJOB                                                   
         EX    RE,0(R1)                                                         
         JE    ELFBLLY                                                          
*                                                                               
ELFBLL25 GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF            look for match on product/job                
         TM    ATSRERRS,TSEEOF                                                  
         JNZ   ELFBLL30                                                         
         CLI   GAPTDAT1,GAPTT2Q                                                 
         JE    ELFBLL20                                                         
         J     ELFBLL30                                                         
*                                                                               
ELFBLL30 TM    BYTE2,X'80'+X'40' Did we find a client or product match          
         JZ    ELFBLL35       No - so go to next client                         
         TM    BYTE2,X'40'    Did we find a product match                       
         JNZ   ELFBLL45       Yes - go to next job                              
         TM    BYTE2,X'80'    Did we find a client match                        
         JNZ   ELFBLL40       Yes - go to next product                          
         DC    H'0'           (should be impossible to get here)                
*                                                                               
E        USING ELFD,X#TEMP                                                      
ELFBLL35 TM    BYTE2,X'20'                                                      
         JNZ   ELFBLL40                                                         
         LLC   RE,E.ELFCLI+L'ELFCLI-1 ADVANCE TO NEXT CLIENT                    
         AHI   RE,1                                                             
         STC   RE,E.ELFCLI+L'ELFCLI-1                                           
         XC    E.ELFPRO,E.ELFPRO                                                
         XC    E.ELFJOB,E.ELFJOB                                                
         XC    E.ELFLNO,E.ELFLNO                                                
         J     ELFBLLN                                                          
*                                                                               
ELFBLL40 LLC   RE,E.ELFPRO+L'ELFPRO-1 ADVANCE TO NEXT PRODUCT                   
         AHI   RE,1                                                             
         STC   RE,E.ELFPRO+L'ELFPRO-1                                           
         XC    E.ELFJOB,E.ELFJOB                                                
         XC    E.ELFLNO,E.ELFLNO                                                
         J     ELFBLLN                                                          
*                                                                               
ELFBLL45 LLC   RE,E.ELFJOB+L'ELFJOB-1 ADVANCE TO NEXT JOB                       
         AHI   RE,1                                                             
         STC   RE,E.ELFJOB+L'ELFJOB-1                                           
         XC    E.ELFLNO,E.ELFLNO                                                
         J     ELFBLLN                                                          
         DROP  E                                                                
*                                                                               
ELFBLLY  J     EXITY                                                            
                                                                                
ELFBLLN  J     EXITN                                                            
         DROP  R2,R3                                                            
                                                                                
***********************************************************************         
* C/P/J LimList - filter on media LimList                             *         
***********************************************************************         
                                                                                
MEDLLF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*MEDLLF*'                                                      
                                                                                
         USING ESTRECD,R2                                                       
         LA    R1,X#MEDLL                                                       
         CLI   ESTKJOB,C' '                                                     
         JNH   MEDLLF4                                                          
         CLI   X#MEDLS,C' '                                                     
         JNH   MEDLLF1                                                          
         LA    R3,X#MEDLS                                                       
         LLC   RF,X#MEDNO                                                       
MEDLLF0  CLC   0(L'PMDKMED,R3),ESTKJOB                                          
         JE    MEDLLF1                                                          
         LA    R3,L'PMDKMED(R3)                                                 
         JCT   RF,MEDLLF0                                                       
         J     MEDLLFN                                                          
                                                                                
MEDLLF1  TM    X#LLUIND,X#LLUIMQ   Is media limit list in use                   
         JZ    MEDLLFY             No                                           
                                                                                
MEDLLF2  CLI   0(R1),C' '          Yes - check media matches                    
         JNH   MEDLLFN                                                          
         CLC   0(1,R1),ESTKJOB                                                  
         JE    MEDLLFY                                                          
         AHI   R1,1                                                             
         J     MEDLLF2                                                          
                                                                                
MEDLLF4  LA    RF,ESTRFST                                                       
                                                                                
         USING EMDELD,RF                                                        
         CLI   EMDEL,EMDELQ                                                     
         JNE   *+2                                                              
         CLI   EMDBMC,C' '                                                      
         JNH   MEDLLFY                                                          
         CLI   X#MEDLS,C' '                                                     
         JNH   MEDLLF6                                                          
         LA    R3,X#MEDLS                                                       
         LLC   R4,X#MEDNO                                                       
MEDLLF5  CLC   0(L'PMDKMED,R3),EMDBMC                                           
         JE    MEDLLF6                                                          
         LA    R3,L'PMDKMED(R3)                                                 
         JCT   R4,MEDLLF5                                                       
         J     MEDLLFN                                                          
                                                                                
MEDLLF6  TM    X#LLUIND,X#LLUIMQ   Is media limit list in use                   
         JZ    MEDLLFY             No                                           
                                                                                
         LA    R1,X#MEDLL                                                       
                                                                                
MEDLLF8  CLI   0(R1),C' '          end of list?                                 
         JNH   MEDLLFN                                                          
         CLC   EMDBMC,0(R1)                                                     
         JE    MEDLLFY                                                          
         AHI   R1,1                                                             
         J     MEDLLF8                                                          
                                                                                
MEDLLFY  J     EXITY                                                            
                                                                                
MEDLLFN  J     EXITN                                                            
         DROP  R2,RF                                                            
                                                                                
         EJECT                                                                  
**********************************************************************          
* Check if the connected user can view the timesheet                 *          
**********************************************************************          
         SPACE 1                                                                
         USING ESTRECD,R2                                                       
         USING EMDELD,R3                                                        
         USING GAPTABD,R4                                                       
CHKVIEW  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CHKVIE*'                                                      
         L     R2,AIO2                                                          
*                                                                               
         MVC   SJACCNT,SPACES                                                   
         LA    R1,SJACCNT          Extract cli/pro/job                          
         LLC   RE,PCLILEN                                                       
         BCTR  RE,0                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),ESTKCLI                                                  
         EX    RE,0(RF)                                                         
         LA    R1,1(RE,R1)                                                      
                                                                                
         LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RF,RE                                                            
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),ESTKPRO                                                  
         EX    RF,0(RE)                                                         
         LA    R1,1(RF,R1)                                                      
                                                                                
         LLC   RE,PPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         SR    RF,RE                                                            
         CHI   RF,6                                                             
         JNH   *+8                                                              
         LA    RF,6                                                             
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),ESTKJOB                                                  
         EX    RF,0(RE)                                                         
                                                                                
         MVI   X#LLUIND,0          Clear limit list indicators                  
         LA    R3,ESTRFST                                                       
*                                                                               
CHKVW00  CLI   EMDEL,0                                                          
         JE    *+2                                                              
         CLI   EMDEL,EMDELQ                                                     
         JE    CHKVW01                                                          
         LLC   R0,EMDLN                                                         
         AR    R3,R0                                                            
         J     CHKVW00                                                          
*                                                                               
CHKVW01  LA    R4,GAPAREA          loop through elements                        
         XC    GAPAREA,GAPAREA                                                  
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         J     CHKVW04                                                          
*                                                                               
CHKVW02  GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
*                                                                               
CHKVW04  TM    ATSRERRS,TSEEOF     LOOK FOR A MAIN ENTRY MATCH                  
         JNZ   CHKVW10                                                          
         CLI   GAPTDAT1,GAPTT4Q    SCHEME ENTRY                                 
         JNE   CHKVW06                                                          
         CLC   GAPTSCH,SPACES      if 1st entry is spaces, means...             
         JNH   *+14                no entries + default access=yes              
         CLC   GAPTSCH,EMDSCH                                                   
         JNE   CHKVW02                                                          
         OI    X#LLUIND,X#LLUISQ                                                
         J     CHKVW02                                                          
*                                                                               
CHKVW06  CLI   GAPTDAT1,GAPTT2Q    SJ ENTRY                                     
         JNE   CHKVW08                                                          
         CLC   GAPTACC,SPACES      if 1st entry is spaces, means...             
         JNH   CHKVW07             no entries + default access=yes              
         LLC   RF,GAPTLEN                                                       
         SHI   RF,1+L'GAPTCOFF                                                  
         BASR  R7,0                                                             
         CLC   GAPTACC(0),SJACCNT                                               
         EX    RF,0(R7)                                                         
         JNE   CHKVW02                                                          
         CLC   GAPTCOFF,ESTRSOFF                                                
         JNE   CHKVW02                                                          
CHKVW07  TM    GAPTSTA,GAPTSMQ     NEXT MAIN ENTRY, WE'RE OK                    
         JZ    *+12                                                             
         OI    X#LLUIND,X#LLUICQ                                                
         J     CHKVW02                                                          
         NI    X#LLUIND,X'FF'-X#LLUICQ                                          
         J     CHKVW02                                                          
*                                                                               
CHKVW08  CLI   GAPTDAT1,GAPTT5Q    Media entry                                  
         JNE   *+2                                                              
         CLC   GAPTACT,SPACES      if 1st entry is spaces                       
         JNH   *+14                means default access=y + no limlist          
         CLC   GAPTMEDI,ESTKJOB                                                 
         JNE   CHKVW02                                                          
         OI    X#LLUIND,X#LLUIMQ                                                
         J     CHKVW02                                                          
*                                                                               
CHKVW10  TM    X#LLUIND,X#LLUISQ+X#LLUICQ+X#LLUIMQ                              
         JO    EXITY                                                            
*                                                                               
CHKVIEWN J     EXITN                                                            
                                                                                
***********************************************************************         
* Add a record to optimisation buffer                                 *         
*                                                                     *         
* Ntry:- R1 points to caller's OB_D                                   *         
***********************************************************************         
                                                                                
ADDBUF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDBUF*'                                                      
                                                                                
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSAADD     Set action to 'Add'                          
         ST    R1,T.TSAREC                                                      
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  T                                                                
         EJECT                                                                  
***********************************************************************         
* Get a record from optimisation buffer                               *         
*                                                                     *         
* Ntry:- R1 points to caller's OB_D                                   *         
* Exit:- CC=Low if record not found in buffer                         *         
*        CC=Equal if record found and is not posted with an error     *         
*           - record is returned in caller's OB_D                     *         
*        CC=High if record found and is posted with an error (set in  *         
*           ROUERRV)                                                  *         
***********************************************************************         
                                                                                
GETBUF   NTR1  LABEL=NO,WORK=(RC,OB_LNQ)                                        
         J     *+12                                                             
         DC    C'*GETBUF*'                                                      
                                                                                
W        USING OB_D,RC                                                          
         LR    R2,R1                                                            
P        USING OB_D,R2             R2=A(caller's OB_D)                          
         MVC   W.OB_KEY,P.OB_KEY                                                
                                                                                
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSARDH     Set action to 'Read High'                    
         LA    R0,W.OB_D                                                        
         ST    R0,T.TSAREC         Read into acquired storage                   
         GOTOR VTSAR,T.TSARD                                                    
         JNE   EXITL               Not found/EOF                                
                                                                                
         MVC   P.OB_D(OB_LNQ),W.OB_D                                            
                                                                                
         MVC   ROUERRV,P.OB_ERROR  Set/test record in error                     
         OC    ROUERRV,ROUERRV                                                  
         JNZ   EXITH                                                            
         J     EXITY                                                            
         DROP  W,P,T                                                            
                                                                                
SVRDEF   CSECT ,                                                                
         EJECT                                                                  
***********************************************************************         
* Validate account code                                               *         
*                                                                     *         
* Ntry:- X#TEMP=U/L+acc code                                          *         
***********************************************************************         
                                                                                
VALACT   NTR1  LABEL=NO,WORK=(RC,VAWORKL)                                       
         J     *+12                                                             
         DC    C'*VALACT*'                                                      
                                                                                
         USING VAWORKD,RC          RC=A(local working storage)                  
         GOTOR CLRWRK,VAWORKL      Clear work area                              
         USING OB_D,VARBAREA                                                    
         MVI   OB_TYPE,OB_ACCC     Account code type                            
         MVC   OB_ACCD,X#TEMP                                                   
         GOTOR GETBUF,OB_D                                                      
         JL    VALACT02                                                         
         JH    VALACTN                                                          
         MVC   X#TEMP(L'OB_NAME),OB_NAME                                        
         MVC   X#TEMP+36(1),VA_DRFT   Draft status                              
         MVC   X#TEMP+37(1),VA_LCKD   Locked status                             
         MVC   X#TEMP+38(1),VA_CLSD   Closed status                             
*&&US                                                                           
         MVC   X#TEMP+39(1),VA_EHR#   JOBAEHR#                                  
         MVC   X#TEMP+40(1),VA_EOE#   JOBAEOE#                                  
         MVC   X#TEMP+41(1),VA_ECE#   JOBAECE#                                  
*&&                                                                             
         MVC   X#TEMP+42(L'ACTKSAF1*5),VA_FLT1                                  
         J     VALACTY                                                          
                                                                                
VALACT02 MVC   TEMP2(L'ACTKULA),SPACES                                          
         MVC   TEMP2(L'ACTKULA),X#TEMP                                          
         GOTOR (#GETACN,AGETACN)                                                
         MVC   X#TEMP(36),TEMP2                                                 
         MVI   X#TEMP+36,NOQ       not draft                                    
         MVI   X#TEMP+37,NOQ       not locked                                   
         MVI   X#TEMP+38,NOQ       not closed                                   
         MVI   X#TEMP+39,0                                                      
         MVI   X#TEMP+40,0                                                      
         MVI   X#TEMP+41,0                                                      
         L     R1,AIO3                                                          
         MVC   X#TEMP+42(L'ACTKSAF1*5),ACTRSAF1-ACTKEY(R1)                      
         TM    ACTRSTAT-ACTKEY(R1),ACTSLOCK                                     
         JZ    *+8                                                              
         MVI   X#TEMP+37,YESQ      locked                                       
         TM    ACTRSTAT-ACTKEY(R1),ACTSDRFT                                     
         JZ    *+8                                                              
         MVI   X#TEMP+36,YESQ      draft                                        
         TM    ACTRSTAT-ACTRECD(R1),ACTSCLOS                                    
         JZ    *+8                                                              
         MVI   X#TEMP+38,YESQ      closed                                       
*&&US                                                                           
         USING JOBELD,RF                                                        
         LA    RF,ACTRFST-ACTRECD(R1)                                           
VALACT04 CLI   JOBEL,JOBELQ                                                     
         JNE   VALACT06                                                         
         CLI   JOBLN,JOBLN4Q                                                    
         JL    VALACT08                                                         
         MVC   X#TEMP+39(1),JOBAEHR#                                            
         MVC   X#TEMP+40(1),JOBAEOE#                                            
         MVC   X#TEMP+41(1),JOBAECE#                                            
         J     VALACT08                                                         
VALACT06 CLI   JOBEL,0                                                          
         JE    VALACT08                                                         
         LLC   RE,JOBLN                                                         
         AR    RF,RE                                                            
         J     VALACT04                                                         
VALACT08 DS    0H                                                               
         DROP  RF                                                               
*&&                                                                             
         MVC   OB_NAME,TEMP2                                                    
         MVC   OB_OTHER(VA_LENQ),X#TEMP+36                                      
         GOTOR ADDBUF,OB_D         add new entry to buffer                      
                                                                                
VALACTY  J     EXITY                                                            
                                                                                
VALACTN  J     EXITN                                                            
         DROP  RC                                                               
                                                                                
VAWORKD  DSECT                     ** VALACT local w/s **                       
VARBAREA DS    XL(OB_LNQ)          Buffer area                                  
         ORG   VARBAREA+(OB_OTHER-OB_D)                                         
VA_DRFT  DS    CL1                 Draft status                                 
VA_LCKD  DS    CL1                 Locked status                                
VA_CLSD  DS    CL1                 Closed status                                
VA_EHR#  DS    CL1                 JOBAEHR#                                     
VA_EOE#  DS    CL1                 JOBAEOE#                                     
VA_ECE#  DS    CL1                 JOBAECE#                                     
VA_FLT1  DS    CL1                 Filter 1                                     
VA_FLT2  DS    CL1                 Filter 2                                     
VA_FLT3  DS    CL1                 Filter 3                                     
VA_FLT4  DS    CL1                 Filter 4                                     
VA_FLT5  DS    CL1                 Filter 5                                     
VA_LENQ  EQU   *-VA_DRFT           Length of other data                         
         ORG                                                                    
VAWORKL  EQU   *-VAWORKD                                                        
                                                                                
SVRDEF   CSECT ,                                                                
         EJECT                                                                  
                                                                                
***********************************************************************         
* Validate media code                                                 *         
*                                                                     *         
* Ntry:- X#TEMP=media code                                            *         
***********************************************************************         
                                                                                
VALMED   NTR1  LABEL=NO,WORK=(RC,VMWORKL)                                       
         J     *+12                                                             
         DC    C'*VALMED*'                                                      
                                                                                
         USING VMWORKD,RC          RC=A(local working storage)                  
         GOTOR CLRWRK,VMWORKL      Clear work area                              
         USING OB_D,VMRBAREA                                                    
         MVI   OB_TYPE,OB_MEDC                                                  
         MVC   OB_ACCD(L'PMDKMED),X#TEMP                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALMED2                                                          
         JH    VALMEDN                                                          
         MVC   X#TEMP(L'PMDDESC),OB_NAME                                        
         J     VALMEDY                                                          
                                                                                
         USING PMDRECD,RF                                                       
VALMED2  LA    RF,IOKEY            read media code record                       
         MVC   PMDKEY,SPACES                                                    
         MVI   PMDKTYP,PMDKTYPQ                                                 
         MVC   PMDKCPY,CUXCPY                                                   
         MVC   PMDKMED,X#TEMP                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   VALMED8                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   VALMED8                                                          
                                                                                
         L     RF,AIO3                                                          
         LA    RF,PMDRFST                                                       
         USING PMDELD,RF                                                        
VALMED4  CLI   PMDEL,PMDELQ                                                     
         JE    VALMED6                                                          
         CLI   PMDEL,0                                                          
         JE    VALMED8                                                          
         LLC   R0,PMDLN                                                         
         AR    RF,R0                                                            
         J     VALMED4                                                          
                                                                                
VALMED6  MVC   X#TEMP(L'PMDDESC),PMDDESC                                        
         MVC   OB_NAME(L'PMDDESC),PMDDESC                                       
VALMED8  GOTOR ADDBUF,OB_D         add new entry to buffer                      
                                                                                
VALMEDY  J     EXITY                                                            
                                                                                
VALMEDN  J     EXITN                                                            
         DROP  RC,RF                                                            
VMWORKD  DSECT                     ** VALMED local w/s **                       
VMRBAREA DS    XL(OB_LNQ)          Buffer area                                  
VMWORKL  EQU   *-VMWORKD                                                        
                                                                                
SVRDEF   CSECT ,                                                                
         EJECT                                                                  
                                                                                
***********************************************************************         
* Validate person code                                                *         
*                                                                     *         
* Ntry:- X#TEMP=person code                                           *         
***********************************************************************         
                                                                                
VALPRC   NTR1  LABEL=NO,WORK=(RC,VPWORKL)                                       
         J     *+12                                                             
         DC    C'*VALPRC*'                                                      
                                                                                
         USING VPWORKD,RC          RC=A(local working storage)                  
         GOTOR CLRWRK,VPWORKL      Clear work area                              
         USING OB_D,VPRBAREA                                                    
         OC    X#TEMP(L'PIDKPID),X#TEMP                                         
         JZ    VALPRCN             Any PID?  Then don't do anything             
         MVI   OB_TYPE,OB_PERC                                                  
         MVC   OB_ACCD(L'PIDKPID),X#TEMP                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALPRC2                                                          
         JH    VALPRCN                                                          
         MVC   X#TEMP(L'VPPIDCHA),VPPIDCHA                                      
         MVC   X#TEMP+8(L'VPFSTNAM),VPFSTNAM                                    
         MVC   X#TEMP+24(L'VPLSTNAM),VPLSTNAM                                   
         J     VALPRCY                                                          
                                                                                
VALPRC2  MVC   TEMP2(L'PIDKPID),X#TEMP                                          
         GOTOR (#GETPID,AGETPID)                                                
         JNE   VALPRC4                                                          
         MVC   X#TEMP(8),TEMP2                                                  
         MVC   VPPIDCHA,TEMP2                                                   
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   VALPRC4                                                          
         MVC   X#TEMP+8(16),TEMP2                                               
         MVC   VPFSTNAM,TEMP2                                                   
         MVC   X#TEMP+24(16),TEMP2+16                                           
         MVC   VPLSTNAM,TEMP2+16                                                
         MVC   OB_NAME(16),TEMP2                                                
                                                                                
VALPRC4  GOTOR ADDBUF,OB_D         add new entry to buffer                      
                                                                                
VALPRCY  J     EXITY                                                            
                                                                                
VALPRCN  J     EXITN                                                            
         DROP  RC                                                               
VPWORKD  DSECT                     ** VALPRC local w/s **                       
VPRBAREA DS    XL(OB_LNQ)          Buffer area                                  
         ORG   VPRBAREA+(OB_OTHER-OB_D)                                         
VPPIDCHA DS    CL8                 Person 8 char PID                            
VPFSTNAM DS    CL16                Person first name                            
VPLSTNAM DS    CL16                Person last name                             
         ORG                                                                    
VPWORKL  EQU   *-VPWORKD                                                        
                                                                                
SVRDEF   CSECT ,                                                                
         EJECT                                                                  
***********************************************************************         
* LITERAL POOL                                                        *         
***********************************************************************         
GLOBALS  DS    0D                                                               
         LTORG                                                                  
DMKEY    DC    CL8'DMKEY'                                                       
ACCDIR   DC    CL8'ACCDIR'                                                      
ACCMST   DC    CL8'ACCMST'                                                      
ACCARC   DC    CL8'ACCARC'                                                      
PZERO    DC    PL1'0'                                                           
FFS      DC    XL4'FFFFFFFF'                                                    
ORDWC    DC    CL2'**'                                                          
ASTERS   DC    CL5'*****'                                                       
ZEROES   DC    CL4'0000'                                                        
WORKLEN  DC    AL2(WORKL)                                                       
SJUL     DC    C'SJ'                                                            
LEDGER1R DC    C'1R'                                                            
*&&US                                                                           
X#MHRSQ  DC    AL2(ED_MHRSQ)       C'HR'                                        
X#MOESQ  DC    AL2(ED_MOESQ)       C'OE'                                        
X#MCESQ  DC    AL2(ED_MCESQ)       C'CE'                                        
*&&                                                                             
EDTTAB   DS    0X                                                               
         DC    CL1'D',AL1(OLOGDEL)                                              
EDTTABQ  EQU   *-EDTTAB                                                         
         DC    CL1'R',AL1(OREJECT)                                              
         DC    CL1'I',AL1(OINTAPP)                                              
         DC    CL1'A',AL1(OCLIAPP)                                              
         DC    CL1'S',AL1(OSUBINT)                                              
         DC    CL1'S',AL1(OSUBCLI)                                              
         DC    CL1'C',AL1(OINPROG)                                              
         DC    X'FF'                                                            
*                                                                               
OLOGDEL  EQU   5                   Logically deleted                            
OREJECT  EQU   4                   Rejected                                     
OINTAPP  EQU   7                   Internally approved                          
OCLIAPP  EQU   3                   Client approved                              
OSUBINT  EQU   6                   Submitted for internal                       
OSUBCLI  EQU   2                   Submitted for client approval                
OINPROG  EQU   1                   In progress                                  
*                                                                               
R#XDFL   EQU   08                                                               
MAXEML   EQU   10                  Max no of email addresses for GAP            
*                                                                               
DXCOLIT  DC    C'Display extra columns'                                         
XCOLLIT  DC    C'Extra columns'                                                 
MWCRLIT  DC    C'Merge WC rows'                                                 
ADDRWLIT DC    C'Estimate add row security'                                     
PDFLIT   DC    C'PDF request'                                                   
SRCOLIT  DC    C'Srch Ovr'                                                      
LCKDLIT  DC    C'Include locked jobs'                                           
CLSDLIT  DC    C'include closed jobs'                                           
FLAVLIT  DC    C'Flavour (Created/Actioned)'                                    
VIEWSEV  DC    C'View several request, extra columns: '                         
VSEVSRC  DC    C'Number of source estimate numbers: '                           
STRTLIT  DC    C'Estimate start date'                                           
ENDLIT   DC    C'Estimate end date'                                             
         EJECT                                                                  
                                                                                
***********************************************************************         
* Key drivers                                                         *         
***********************************************************************         
                                                                                
AEXKEYT  LKKEY H,AEXKEY,SAVED        ** ACCOUNT EXTENSION DRIVER **             
         LKKEY LIT,AEXKTYP,AEXKTYPQ                                             
         LKKEY LIT,AEXKSUB,AEXKSUBQ                                             
         LKKEY SIN,AEXKCPY,AGENCY                                               
         LKKEY LIT,AEXKREM,0                                                    
         LKKEY SIN,AEXKULA,SVSJACT                                              
         LKKEY ALL,AEXKSEQ                                                      
         LKKEY E                                                                
                                                                                
DCDICTL  DS    0X                                                               
         DCDDL AC#TIME,L'AC@TIME                                                
         DCDDL AC#MAT,L'AC@MAT                                                  
         DCDDL AC#EST,L'AC@EST                                                  
DCDICTLX DC    X'FF'                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
* LIST OF ACCOUNT FILES TO OPEN IN ALL SYSTEMS                        *         
***********************************************************************         
                                                                                
FILES    DS    0X                  ** FILE INFO **                              
         DC    C'ACCOUNT'          SYSTEM NAME FOR OPEN                         
                                                                                
         DC    C'nCTFILE '         FILE LIST                                    
         DC    C'NGENFIL '                                                      
         DC    C'NGENDIR '                                                      
         DC    C'UACCDIR '                                                      
         DC    C'UACCMST '                                                      
         DC    C'UACCARC '                                                      
         DC    C'X'                                                             
         EJECT                                                                  
***********************************************************************         
* LIST OF CORE RESIDENT FACILITIES (MAPS TO SYSADDR IN WORKD)         *         
***********************************************************************         
                                                                                
FACS     DS    0X                                                               
                                                                                
         EJECT                                                                  
***********************************************************************         
* TABLES                                                              *         
***********************************************************************         
                                                                                
COGOTAB  DS    0X                                                               
         DC    AL1(COSAVED,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COSAVED,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COSAVED,GOINPR,NOQ,0,0,0)                                    
         DC    AL1(COSAVED,GOSUB,NOQ,0,0,0)                                     
         DC    AL1(COSAVED,GOMANPAP,NOQ,0,0,0)                                  
         DC    AL1(COSAVED,GOCLIPAP,NOQ,0,0,0)                                  
         DC    AL1(COSUBMD,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COSUBMD,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COSUBMD,GOINPR,YESQ,0,0,0)                                   
         DC    AL1(COSUBMD,GOSUB,NOQ,0,0,0)                                     
         DC    AL1(COSUBMD,GOCLIPAP,NOQ,0,0,0)                                  
         DC    AL1(COSUBMD,GOMANPAP,NOQ,0,0,0)                                  
         DC    AL1(COCLAPR,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COCLAPR,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COCLAPR,GOINPR,YESQ,TIMSSUBM+TIMSREJE+TIMSPAPP)              
         DC    AL1(0,TIMSAWAP)                                                  
         DC    AL1(COCLAPR,GOSUB,NOQ,TIMSSUBM+TIMSPAPP,0,TIMSAWAP)              
         DC    AL1(COCLAPR,GOMANPAP,NOQ,TIMSMAAP,0,TIMSAWAP)                    
         DC    AL1(COCLAPR,GOCLIPAP,NOQ,0,0,0)                                  
         DC    AL1(COLMAPR,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COLMAPR,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COLMAPR,GOINPR,YESQ,TIMSSUBM+TIMSREJE+TIMSPAPP)              
         DC    AL1(TIMSMAAP,0)                                                  
         DC    AL1(COLMAPR,GOSUB,NOQ,TIMSSUBM+TIMSPAPP,TIMSMAAP,0)              
         DC    AL1(COLMAPR,GOMANPAP,NOQ,0,0,0)                                  
         DC    AL1(COLMAPR,GOCLIPAP,NOQ,TIMSPAPP,0,TIMSAWAP)                    
         DC    AL1(COFUAPR,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COFUAPR,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COFUAPR,GOINPR,YESQ,TIMSSUBM+TIMSREJE+TIMSPAPP,0,0)          
         DC    AL1(COFUAPR,GOSUB,NOQ,TIMSSUBM+TIMSPAPP,0,0)                     
         DC    AL1(COFUAPR,GOMANPAP,NOQ,TIMSMAAP,0,0)                           
         DC    AL1(COFUAPR,GOCLIPAP,NOQ,TIMSPAPP,0,TIMSFAPP)                    
         DC    X'FF'                                                            
                                                                                
STATAB   DS    0X                                                               
         DC    AL1(ESTKCREA,0,NOQ),AL1(RQ_ELSCQ)                                
         DC    AL1(ESTKSUBM,ESTKSINA,NOQ),AL1(RQ_ELSBQ)                         
         DC    AL1(ESTKSUBM,ESTKSINA,RQ_AWIAQ),AL1(RQ_ESSXQ)                    
         DC    AL1(ESTKINTA,0,NOQ),AL1(RQ_ELSIQ)                                
         DC    AL1(ESTKSUBM,0,NOQ),AL1(RQ_ELSSQ)                                
         DC    AL1(ESTKSUBM,0,YESQ),AL1(RQ_ESSWQ)                               
         DC    AL1(ESTKCAPP,0,NOQ),AL1(RQ_ELSAQ)                                
         DC    AL1(ESTKLOGD,ESTKMERG,NOQ),AL1(RQ_ELSMQ)                         
         DC    AL1(ESTKREJE,0,NOQ),AL1(RQ_ELSRQ)                                
         DC    AL1(ESTKLOGD,0,NOQ),AL1(RQ_ELSDQ)                                
         DC    AL1(ESTKINTA,0,NOQ),AL1(RQ_ELAAQ)                                
         DC    AL1(FF,0,NOQ),AL1(RQ_NEWEQ)                                      
         DC    CL4'****'                   End of table                         
                                                                                
XCOLTAB  DS    0X                                                               
         DC    AL1(MAPPO),AL1(CWITPO)                                           
         DC    AL1(MAPAC),AL1(CWITAC)                                           
         DC    AL1(MAPAH),AL1(CWITAH)                                           
         DC    AL1(MAPBA),AL1(CWITBA)                                           
         DC    AL1(MAPUN),AL1(CWITUN)                                           
         DC    AL1(MAPCE),AL1(CWITCE)                                           
         DC    AL1(MAPCEH),AL1(CWITCEH)                                         
         DC    AL1(MAPOE),AL1(CWITOE)                                           
         DC    XL1'FD',CL1'*'                                                   
*                                                                               
         DC    AL1(MAPOEH),AL1(CWITOEH)                                         
*&&US*&& DC    AL1(MAPHR),AL1(CWITHR)                                           
         DC    AL1(MAPHEH),AL1(CWITHEH)                                         
         DC    AL1(MAPOECE),AL1(CWITOECE)                                       
         DC    AL1(MAPOEAC),AL1(CWITOEAC)                                       
         DC    AL1(MAPCEOE),AL1(CWITCEOE)                                       
*&&US*&& DC    AL1(MAPHRCE),AL1(CWITHRCE)                                       
*&&US*&& DC    AL1(MAPHRAC),AL1(CWITHRAC)                                       
         DC    AL1(FE),CL1'*'                                                   
                                                                                
*&&US*&& DC    AL1(MAPHROE),AL1(CWITHROE)                                       
         DC    AL1(FF),CL1'*'                                                   
                                                                                
APRTABL  DS    0X                                                               
         DC    B'11111000'         Office/client/product/job/media              
         DC    AL1(JBMEOFQ)                                                     
         DC    B'11011000'         Office/client/product/media                  
         DC    AL1(PRMEOFQ)                                                     
         DC    B'10011000'         Office/client/media                          
         DC    AL1(CLMEOFQ)                                                     
         DC    B'10010000'         Client/media                                 
         DC    AL1(CLIMEDQ)                                                     
         DC    B'00011000'         Office/media                                 
         DC    AL1(MEDOFFQ)                                                     
         DC    B'00010000'         Media                                        
         DC    AL1(MEDIAQ)                                                      
         DC    B'11001000'         Office/client/product                        
         DC    AL1(PROOFFQ)                                                     
         DC    B'10001000'         Office/client                                
         DC    AL1(CLIOFFQ)                                                     
         DC    B'10000000'         Client                                       
         DC    AL1(CLIENTQ)                                                     
         DC    B'00001000'         Office                                       
         DC    AL1(OFFICEQ)                                                     
         DC    B'00000000'         Agency                                       
         DC    AL1(AGENCYQ)                                                     
         DC    X'FF'                                                            
                                                                                
JBMEOFQ  EQU   X'01'                                                            
PRMEOFQ  EQU   X'02'                                                            
CLMEOFQ  EQU   X'03'                                                            
CLIMEDQ  EQU   X'04'                                                            
MEDOFFQ  EQU   X'05'                                                            
MEDIAQ   EQU   X'06'                                                            
PROOFFQ  EQU   X'07'                                                            
CLIOFFQ  EQU   X'08'                                                            
CLIENTQ  EQU   X'09'                                                            
OFFICEQ  EQU   X'10'                                                            
AGENCYQ  EQU   X'11'                                                            
                                                                                
EXPTYTAB DS    0X                                                               
         DC    AL1(EXJPCLI1)                                                    
         DC    AL1(EXJPCBL1)                                                    
         DC    AL1(EXJPCNB1)                                                    
         DC    X'FF'                                                            
                                                                                
APLTAB   DS    0X                                                               
         DC    AL1(RQ_EAORD,APPPORD,APPPORDF,APPPAEO,APPPUEO,0)                 
APLTABL  EQU   *-APLTAB                                                         
         DC    AL1(RQ_EAINV,APPPINV,0,0,0,0)                                    
         DC    C'FF'                                                            
                                                                                
                                                                                
TIMSTAB  DS    0XL1                                                             
         DC    AL1(TIMSFAPP,TIMSFAPP,0,0,0,0)                                   
TIMSTABL EQU   *-TIMSTAB                                                        
         DC    AL1(TIMSPAPP,TIMSPAPP,TIMSFAPP,0,0,0)                            
         DC    AL1(TIMSMAAP,TIMSMAAP,TIMSFAPP,0,0,0)                            
         DC    AL1(TIMSSUBM,TIMSSUBM,TIMSPAPP,TIMSFAPP,0,0)                     
         DC    X'FF'                                                            
                                                                                
VWSVTAB  DS    0X                                                               
         DC    X'01',CL24'Purchase Orders'                                      
         DC    X'02',CL24'Actuals (Act)'                                        
         DC    X'03',CL24'Actual Hours (ActH)'                                  
         DC    X'04',CL24'Balance (CE-Actuals)'                                 
         DC    X'05',CL24'Uncomitted (UnCo)'                                    
         DC    X'06',CL24'Current Est. (CE)'                                    
         DC    X'07',CL24'Current Est. Hours(CEH)'                              
         DC    X'08',CL24'Original Estimate(OE)'                                
         DC    X'09',CL24'Orig. Est. Hours(OEH)'                                
         DC    X'0A',CL24'Highest Revision(HR)'                                 
         DC    X'0B',CL24'High. Est. Hours(HEH)'                                
         DC    X'0C',CL24'OE-CE'                                                
         DC    X'0D',CL24'OE Actuals'                                           
         DC    X'0E',CL24'CE-OE'                                                
         DC    X'0F',CL24'HR-CE'                                                
         DC    X'10',CL24'HR-Actuals'                                           
         DC    X'11',CL24'HR-OE'                                                
         DC    X'12',CL24'Rate%'                                                
         DC    X'FF'                                                            
B#ACEX   EQU   6                       IO5 Account extension record             
EOR      EQU   0                                                                
***********************************************************************         
         SPACE 1                                                                
SAVED    DSECT                                                                  
AMASTC   DS    A                   A(MASTC)                                     
VACCEMU  DS    A                   A(BUFFERIN)                                  
ARUNFACS DS    A                                                                
RUNMODE  DS    XL(L'RUNPMODE)      RUNNER/DDLINK MODE                           
TSAREBUF DS    XL(TSPXTNL)         TSAR block for estimate buffer               
TSARABUF DS    XL(TSPXTNL)         TSAR block for approval buffer               
TSAROBUF DS    XL(TSPXTNL)         TSAR block for optimisation buffer           
AGENCY   DS    XL(L'CUXCPY)        Saved agency code for key reading            
SVSJACT  DS    CL(L'ACTKULA)       Saved SJ account for key reading             
APRINTER DS    A                   A(PRINTER) - offline                         
ARCPRINT DS    A                   A(RCPRINT)                                   
AUINTAB  DS    A                   A(upper case translate table)                
ASRCTAB  DS    A                   A(search translate table)                    
ASTALST  DS    A                   A(Status entry in list)                      
LIOTRACE DS    F                                                                
*&&US                                                                           
CLLQ     EQU   3                   CLIENT CODE LENGTH                           
PRLQ     EQU   3                   PRODCT CODE LENGTH                           
*&&                                                                             
*&&UK                                                                           
CLLQ     EQU   5                   CLIENT CODE LENGTH                           
PRLQ     EQU   2                   PRODCT CODE LENGTH                           
*&&                                                                             
CPLQ     EQU   CLLQ+PRLQ           CLIENT AND PRODUCT                           
*                                                                               
***********************************************************************         
* REQUEST IN/OUT DEFINITION IN STORAGE                                *         
***********************************************************************         
                                                                                
SAVEVAR  DS    0X                                                               
X#TEMP   DS    CL64                                                             
QVALUES  DS    0X                  ** REQUEST VALUES                            
RQ_TYPE  DS    XL1                 - Request type                               
RQ_DATA  DS    0XL1                - Request data                               
                                                                                
* Initial for Add                                                               
RQ_IACLI DS    CL6                 - client code                                
RQ_IAPRO DS    CL6                 - product code                               
RQ_IAJOB DS    CL6                 - job code                                   
RQ_IASCH DS    CL8                 - scheme code                                
RQ_IAMED DS    CL1                 - media code (ballpark)                      
RQ_IALAN DS    CL1                 - language chosen on estimate y/n            
RQ_IAARW DS    CL1                 - estimate add row security (Y/N)            
RQ_IALNQ EQU   *-RQ_IACLI                                                       
         ORG   RQ_DATA                                                          
                                                                                
* Estimate approvers                                                            
RQ_EACLI DS    CL6                 - client code                                
RQ_EAPRO DS    CL6                 - product code                               
RQ_EAJOB DS    CL6                 - job code                                   
RQ_EANUM DS    CL6                 - estimate global number                     
RQ_EAALL DS    CL1                 - all Con/Sec persons request                
RQ_EAPID DS    CL8                 - PID to validate person code                
RQ_EAINT DS    CL1                 - internal approver Y/N/B                    
RQ_EAAPL DS    CL1                 - application module                         
RQ_EAESC EQU   1                   - Estimate client approvers                  
RQ_EAESI EQU   2                   - Estimate internal approvers                
RQ_EAINV EQU   3                   - Invoices                                   
RQ_EARES EQU   4                   - Resources                                  
RQ_EAORD EQU   5                   - Orders                                     
RQ_EAAPR DS    CL1                 - Approver look up                           
RQ_EALNQ EQU   *-RQ_EACLI                                                       
         ORG   RQ_DATA                                                          
                                                                                
* Estimate List                                                                 
RQ_ELTYP DS    CL1                 - type                                       
RQ_ELTSQ EQU   C'S'                  * by status                                
RQ_ELTAQ EQU   C'A'                  * by account                               
RQ_ELTLQ EQU   C'L'                  * list for summary (recent ests)           
RQ_ELCLI DS    CL6                 - client code                                
RQ_ELPRO DS    CL6                 - product code                               
RQ_ELJOB DS    CL6                 - job code                                   
RQ_ELSIN DS    X                   - status array                               
RQ_ELSAD DS    AL3                                                              
RQ_ELSCQ EQU   C'C'                  * created                                  
RQ_ELSBQ EQU   C'B'                  * submitted to internal approver           
RQ_ELSIQ EQU   C'I'                  * internally approved                      
RQ_ELSSQ EQU   C'S'                  * submitted (to client)                    
RQ_ELSAQ EQU   C'A'                  * (client) approved                        
RQ_ELSMQ EQU   C'M'                  * merged                                   
RQ_ELSRQ EQU   C'R'                  * rejected                                 
RQ_ELSDQ EQU   C'D'                  * deleted                                  
RQ_NEWEQ EQU   C'N'                  * new (recently actioned)                  
RQ_ELAAQ EQU   C'Y'                  * approved internal or client              
RQ_ELAPP DS    CL1                 - awaiting approval view (Y/N/I/B/O)         
RQ_AWIAQ EQU   C'I'                Internal only                                
RQ_AWBTQ EQU   C'B'                Both internal and client approval            
RQ_AWOTQ EQU   C'O'                Awaiting others approval                     
RQ_ELGAO DS    CL1                 - GOAV call Y/N                              
RQ_ELOVL DS    CL1                 - override limit list Y/N                    
RQ_ELFLA DS    CL1                 - Status flavour                             
RQ_ELFCQ EQU   C'C'                  * created by me                            
RQ_ELFAQ EQU   C'A'                  * actioned by me                           
         ORG   RQ_DATA                                                          
                                                                                
* Estimate Search                                                               
RQ_ESCLI DS    CL6                 - client code                                
RQ_ESPRO DS    CL6                 - product code                               
RQ_ESJOB DS    CL6                 - job code                                   
RQ_ESL1Q EQU   *-RQ_ESCLI                                                       
RQ_ESMIN DS    X                   - media code array                           
RQ_ESMAD DS    AL3                                                              
RQ_ESGLO DS    CL6                 - global number                              
RQ_ESDES DS    CL50                - description                                
RQ_ESOWN DS    CL8                 - owner                                      
RQ_ESCUR DS    CL3                 - currency                                   
RQ_ESADS DS    XL3                 - added date: start                          
RQ_ESADE DS    XL3                 - added date: end                            
RQ_ESLDS DS    XL3                 - activity date: start                       
RQ_ESLDE DS    XL3                 - activity date: end                         
RQ_ESICA DS    CL8                 - internal client approver                   
RQ_ESACA DS    CL36                - actual client approver                     
RQ_ESAAE DS    XL3                 - client approval date: end                  
RQ_ESAAS DS    XL3                 - client approval date: start                
RQ_ESACO DS    CL50                - approval comment                           
RQ_ESSIN DS    X                   - status array                               
RQ_ESSAD DS    AL3                                                              
RQ_ESSCQ EQU   C'C'                  * created                                  
RQ_ESSBQ EQU   C'B'                  * submitted to internal approver           
RQ_ESSIQ EQU   C'I'                  * internally approved                      
RQ_ESSSQ EQU   C'S'                  * submitted (to client)                    
RQ_ESSAQ EQU   C'A'                  * (client) approved                        
RQ_ESSMQ EQU   C'M'                  * merged                                   
RQ_ESSRQ EQU   C'R'                  * rejected                                 
RQ_ESSDQ EQU   C'D'                  * deleted                                  
RQ_ESSWQ EQU   C'W'                  * awaiting my client approval              
RQ_ESSXQ EQU   C'X'                  * awaiting my internal approval            
RQ_ESIAA DS    CL8                 - internal approver                          
RQ_ESIAS DS    XL3                 - internal approval date: start              
RQ_ESIAE DS    XL3                 - internal approval date: end                
RQ_ESOVR DS    CL1                 - override LimList settings Y/N              
RQ_ESLKD DS    CL1                 - include locked jobs Y/N/O                  
RQ_ESCLS DS    CL1                 - include closed jobs Y/N/O                  
RQ_ESSTR DS    XL3                 - estimate date: start                       
RQ_ESEND DS    XL3                 - estiamte date: end                         
RQ_ESCRB DS    CL8                 - created by                                 
RQ_ESNIN DS    X                   - Aura name search                           
RQ_ESNAD DS    AL3                                                              
RQ_ESOVA DS    CL1                 - override LimList for add Y/N               
RQ_ESOFI DS    X                   Estimate office search array                 
RQ_ESOFA DS    AL3                                                              
                                                                                
RQMAXQ   EQU   *-RQ_DATA+64        <--- adjust for big RQ entries               
                                                                                
         ORG   RQ_DATA                                                          
                                                                                
* Estimate Display                                                              
RQ_EDEST DS    CL6                 - estimate global number                     
RQ_EDCOP DS    CL1                 - copy Y/N                                   
RQ_EDCLI DS    CL6                 - client code                                
RQ_EDPRO DS    CL6                 - product code                               
RQ_EDJOB DS    CL6                 - job code                                   
RQ_EDCCC DS    CL3                 - copy currency code                         
RQ_EDCEX DS    CL14                - copy exchange rate                         
RQ_EDCPJ DS    CL12                - display via cli/pro/job(/local#)           
RQ_EDLNO DS    XL1                 - display via (cli/pro/job/)local#           
RQ_EDOVL DS    CL1                 - override limit list (Y/N)                  
RQ_EDARW DS    CL1                 - estimate add row security (Y/N)            
RQ_EDPDF DS    CL1                 - estimate PDF request (Y/N)                 
RQ_EDOLA DS    CL1                 - override limist when adding (Y/N)          
         ORG                                                                    
QVALUESL EQU   *-QVALUES                                                        
                                                                                
         EJECT                                                                  
OVALUES  DS    0X                                                               
                                                                                
* Estimate approvers                                                            
EA_VALS  DS    0X                                                               
EA_CODE  DS    CL8                 Person code PID character                    
EA_FNAM  DS    CL16                Person first name                            
EA_LNAM  DS    CL58                Person last name                             
EA_IDEF  DS    CL1                 Default Y/N                                  
EA_APTY  DS    CL1                 Client (C) or Internal (I) approver          
EA_ALEV  DS    XL1                 Level (see APRTABL/APRLVL)                   
EA_MNAM  DS    CL16                Person middle name                           
EA_BPID  DS    XL2                 Person security PIN/binary PID               
EA_LNQ   EQU   *-EA_VALS                                                        
         ORG   OVALUES                                                          
                                                                                
* Estimate List and Search                                                      
EL_VALS  DS    0X                                                               
EL_GLNO  DS    CL6                 global number                                
EL_LONO  DS    XL1                 local number                                 
EL_NAME  DS    CL50                name                                         
EL_ADDD  DS    PL3                 added date                                   
EL_ACTD  DS    PL3                 last activity date                           
EL_ACTT  DS    CL6                 last activity time                           
EL_STAT  DS    CL1                 status                                       
EL_ASTA  DS    CL1                 approve status                               
EL_MEDC  DS    CL1                 media code                                   
EL_MEDN  DS    CL12                media name                                   
EL_CLIC  DS    CL6                 client code                                  
EL_CLIN  DS    CL36                client name                                  
EL_PROC  DS    CL6                 product code                                 
EL_PRON  DS    CL36                product name                                 
EL_JOBC  DS    CL6                 job code                                     
EL_JOBN  DS    CL36                job name                                     
EL_JOBS  DS    CL1                 job draft status                             
EL_JOBL  DS    CL1                 job locked status                            
EL_TAMT  DS    PL6                 total agency amount                          
EL_FAMT  DS    PL6                 total FC amount                              
EL_ADDP  DS    CL8                 added person code                            
EL_ADDF  DS    CL16                added person first name                      
EL_ADDL  DS    CL16                added person last name                       
EL_ACTP  DS    CL8                 last activity person code                    
EL_ACTF  DS    CL16                last activity person first name              
EL_ACTL  DS    CL16                last activity person last name               
EL_SCAP  DS    CL8                 supposed appr. person code                   
EL_SCAF  DS    CL16                supposed appr. person first name             
EL_SCAL  DS    CL16                supposed appr. person last name              
EL_CURR  DS    CL3                 currency code                                
EL_ACUR  DS    CL3                 agency currency code                         
EL_NODP  DS    CL1                 number decimal places                        
EL_IDNO  DS    XL2                 ID number                                    
*&&US                                                                           
EL_AEHR  DS    XL1                                                              
EL_AEOE  DS    XL1                                                              
EL_AECE  DS    XL1                                                              
*&&                                                                             
EL_SCHC  DS    CL8                 scheme code                                  
EL_CONI  DS    CL1                 connected user is an internal appr           
EL_CONC  DS    CL1                 connected user is a client approver          
EL_INTU  DS    CL1                 internal use only (Y/N)                      
EL_SIAP  DS    CL8                 supposed internal approver code              
EL_PRRAT DS    CL1                 print rates on estimates                     
EL_JOBCL DS    CL1                 Job closed status                            
EL_EDAT  DS    PL3                 Estimate date                                
EL_WCTM  DS    CL1                 Workcode level time on estimate              
EL_ITTM  DS    CL1                 Item level time on estimate                  
EL_ITMS  DS    CL1                 Items on estimate                            
EL_FLT1  DS    CL1                 Filter 1                                     
EL_FLT2  DS    CL1                 Filter 2                                     
EL_FLT3  DS    CL1                 Filter 3                                     
EL_FLT4  DS    CL1                 Filter 4                                     
EL_FLT5  DS    CL1                 Filter 5                                     
EL_APDT  DS    XL3                 Approved date                                
EL_GAPST DS    CL1                 - GAP Status                                 
EL_GAPSD DS    PL3                 - GAP sent date                              
EL_GAPED DS    PL3                 - GAP expiry date                            
EL_OFFC  DS    CL2                 Office code                                  
EL_IWCT  DS    PL6                 Internal workcode total                      
EL_XWCT  DS    PL6                 External workcode total                      
EL_LNQ   EQU   *-EL_VALS                                                        
         ORG   OVALUES                                                          
                                                                                
* Estimate Display                                                              
ED_VALS  DS    0X                                                               
ED_SBSSQ DS    CL1                 Side by side sequential indicator            
ED_RTYPE DS    CL1                 return data type                             
ED_RTMLQ EQU   C'M'                * main data                                  
ED_MCLIC DS    CL6                   client code                                
ED_MCLIN DS    CL36                  client name                                
ED_MCLIP DS    CL36                  client printing (original) name            
ED_MPROC DS    CL6                   product code                               
ED_MPRON DS    CL36                  product name                               
ED_MPROP DS    CL36                  product printing (original) name           
ED_MJOBC DS    CL6                   job code                                   
ED_MJOBN DS    CL36                  job name                                   
ED_MJOBS DS    CL1                   job draft status                           
ED_MJOBL DS    CL1                   job locked/closed status                   
ED_MORLK DS    CL1                   job order lock status                      
ED_MTILK DS    CL1                   job t/s lock status                        
ED_XDTCP DS    CL1                   Copy Extra data to new estimate            
ED_TXTCP DS    CL1                   Copy text from estimate to order           
ED_UNCOM DS    CL1                   Auto copy from uncommitted amount          
ED_ORIPR DS    CL1                   Create order from in progress est          
ED_ORSUI DS    CL1                   Create order from internally sub           
ED_ORIAP DS    CL1                   Create order from internally appr          
ED_ORSUC DS    CL1                   Create order from client submitted         
ED_ORCAP DS    CL1                   Create order from client approved          
ED_SWPD  DS    XL1                   Suppress W/C detail                        
ED_ORBIL DS    CL1                   Billable order only                        
ED_ORNJB DS    CL1                   No job allowed for expense jobs            
ED_MGLNO DS    CL6                   global number                              
ED_MLONO DS    XL1                   local number                               
ED_MADAT DS    PL3                   added date                                 
ED_MACTY DS    PL3                   last activity date                         
ED_MCURC DS    CL3                   currency code                              
ED_MACUR DS    CL3                   agency currency code                       
ED_MEXCH DS    XL7                   exchange rate                              
ED_MSCHC DS    CL8                   scheme code                                
ED_MLANG DS    CL1                   language                                   
ED_MSTAT DS    CL1                   status                                     
ED_MIDNO DS    XL2                   ID number                                  
*&&US                                                                           
ED_MHOCS DS    CL2                   HR/CE/OE estimate status                   
ED_MHRSQ EQU   C'HR'                                                            
ED_MOESQ EQU   C'OE'                                                            
ED_MCESQ EQU   C'CE'                                                            
*&&                                                                             
ED_MOFFC DS    CL2                   office code                                
ED_MNAME DS    CL50                  name                                       
ED_MAPPC DS    CL8                   supposed approver code                     
ED_MAPPF DS    CL16                  supposed approver first name               
ED_MAPPL DS    CL16                  supposed approver last name                
ED_MIAPC DS    CL8                   supposed int. approver code                
ED_MIAPF DS    CL16                  supposed int. approver first name          
ED_MIAPL DS    CL16                  supposed int. approver last name           
ED_MTVRT DS    PL6                   TVR total                                  
ED_MFRMT DS    CL8                   Format code                                
ED_MLOCK DS    CL1                   Lock flag                                  
ED_MDCDA DS    XL3                   client contact date                        
ED_MDCLN DS    CL36                  client contact name                        
ED_MSELP DS    CL1                   suppress empty lines form print            
ED_MSELD DS    CL1                   suppress descr. lines from print           
ED_MJAD1 DS    CL(L'ADRADD1)         client/product/job address                 
ED_MJAD2 DS    CL(L'ADRADD1)         (line 1 - 5)                               
ED_MJAD3 DS    CL(L'ADRADD1)                                                    
ED_MJAD4 DS    CL(L'ADRADD1)                                                    
ED_MJAD5 DS    CL(L'ADRADD1)                                                    
ED_INTUS DS    CL1                   internal use only                          
ED_MRAIC DS    CL8                   order raiser - code                        
ED_MRAIF DS    CL16                               - first name                  
ED_MRAIL DS    CL16                               - last name                   
ED_MRAIE DS    CL52                               - email address               
ED_MRAIT DS    CL5                                - phone extension             
ED_MMEDC DS    CL1                                                              
ED_MMEDN DS    CL12                                                             
ED_MCONI DS    CL1                   connected user is an internal appr         
ED_MCONC DS    CL1                   connected user is a client appr            
ED_PRRAT DS    CL1                   print rates on estimates                   
ED_RTWCQ EQU   C'W'                * w/c data                                   
ED_WCATC DS    CL2                   category                                   
ED_WCODE DS    CL2                   w/c                                        
ED_WNAME DS    CL36                  name                                       
ED_WXNAM DS    CL36                  Extra name                                 
ED_WAMNT DS    PL6                   amount                                     
ED_WAMNC DS    PL6                   amount non commissionable                  
ED_WFCAM DS    PL6                   FC amount                                  
ED_WCAMT DS    PL6                   commission amount                          
ED_WCFCA DS    PL6                   FC commission amount                       
ED_WCRAT DS    PL6                   commission rate                            
ED_WCVRA DS    XL2                   VAT rate                                   
ED_WCVAM DS    PL6                   VAT amount                                 
ED_WCVFC DS    PL6                   VAT amount FC                              
ED_WCVCO DS    CL1                   VAT code used                              
ED_WCNIC DS    PL6                   NIC amount                                 
ED_WCNFC DS    PL6                   NIC amount FC                              
ED_WCCWC DS    CL2                   Contingency work code                      
ED_WCESP DS    PL6                   Opt/Maint estimate %                       
ED_WCOTH DS    CL1                   Other Work Code flag Y/N                   
ED_WINDS DS    CL8                   indicators                                 
ED_RTIDQ EQU   C'I'                * item data                                  
ED_RTIRQ EQU   C'R'                * item data (hours/rate)                     
ED_ITYPE DS    CL1                   item type                                  
ED_IMAT  EQU   C'1'                  material                                   
ED_IHRS  EQU   C'2'                  hours                                      
ED_ICODE DS    CL4                   code                                       
ED_ISEQN DS    XL3                   seq. number                                
ED_IDESC DS    CL36                  description                                
ED_IAPRI DS    PL6                   price in agency currency                   
ED_IFPRI DS    PL6                   price in foreign currency                  
ED_IMULT DS    PL6                   multiplier                                 
ED_ITNIC DS    PL6                   NIC amount                                 
ED_ITNFC DS    PL6                   NIC amount FC                              
ED_IINDS DS    CL7                   indicators                                 
ED_ICIND DS    CL1                   copy indicator                             
ED_IRIND DS    CL3                   revaluation status                         
ED_IUNIT DS    CL15                  units                                      
ED_IUNLA DS    CL15                  units (language)                           
ED_IETX1 DS    CL180                 extra text (1)                             
ED_IETX2 DS    CL180                 extra text (2/language)                    
ED_1RULA DS    0CL14                 1R unit ledger account code                
ED_1RUNT DS    CL1                   1R unit                                    
ED_1RLDG DS    CL1                   1R ledger                                  
ED_1RACT DS    CL12                  1R account code                            
ED_RTWTQ EQU   C'T'                * w/c text                                   
ED_WTXT1 DS    CL250                 text box                                   
ED_RTITQ EQU   C'B'                * item text                                  
ED_ITXT1 DS    CL250                 text box                                   
ED_RTVTQ EQU   C'V'                * category text                              
ED_VTXT1 DS    CL250                 text box                                   
ED_RTHTQ EQU   C'H'                * header text                                
ED_RTETQ EQU   C'E'                * Estimate additional text                   
ED_HTXT1 DS    CL250                 text box                                   
ED_RTFTQ EQU   C'F'                * footer text                                
ED_FTXT1 DS    CL250                 text box                                   
ED_RTXDQ EQU   C'X'                * xtra data                                  
ED_XDCOD DS    XL3                   field code                                 
ED_XDTYP DS    CL1                   field type                                 
ED_XDDAT DS    CL90                  edited data                                
ED_XDNAM DS    CL30                  field name                                 
ED_XDCDE DS    CL(L'XDFCODE)         extra data field code                      
ED_RTAUQ EQU   C'A'                * audit trail                                
ED_AUFRS DS    CL1                   from status                                
ED_AUTOS DS    CL1                   to status                                  
ED_AUDTE DS    XL3                   date                                       
ED_AUTIM DS    CL6                   time                                       
ED_AUUSR DS    CL10                  user ID                                    
ED_AUPID DS    CL8                   person code                                
ED_AUPER DS    CL16                  person first name                          
ED_AUPEL DS    CL16                  person last name                           
ED_AUTXT DS    CL200                 change comment                             
ED_RTCAQ EQU   C'C'                * category layout                            
ED_CACOD DS    CL2                   code                                       
ED_CANAM DS    CL20                  name                                       
ED_CATNA DS    CL20                  total name                                 
ED_CAINS DS    CL26                  instruction                                
ED_CATYP DS    CL1                   type                                       
ED_CAELS DS    CL16                  'else'                                     
ED_RTSMQ EQU   C'S'                * merge source info                          
ED_SMEST DS    CL6                   estimate number                            
ED_SMBAS DS    CL1                   base Y/N                                   
ED_WIAC  DS    CL1                   Use actuals for w/c calc                   
ED_EMSRT DS    XL24                  (Check sort for estimate merge)            
ED_WTYPE DS    CL1                   workcode type ('C' cost, 'T' time)         
ED_WCOST EQU   C'C'                  cost                                       
ED_WTIME EQU   C'T'                  time                                       
ED_WESCK DS    CL1                   Estimate check setting                     
ED_CCWC  DS    CL1                   Colour coded work codes                    
ED_WCF   DS    CL1                   Workcode estimate check flag               
ED_MEDAT DS    PL3                   Added date                                 
ED_WCSEQ DS    XL3                   Workcode sequence                          
ED_MWCTM DS    CL1                   Workcode level time on estimate            
ED_MITTM DS    CL1                   Item level time on estimate                
ED_SJOF  DS    CL1                   Use SJ offices for rate look up            
ED_EEDT  DS    CL1                   Estimate date in last fiscal year          
ED_ITSEQ DS    XL3                   Item sequence                              
ED_MITMS DS    CL1                   Items on estimate                          
ED_GAPYN DS    CL1                 - GAP in use, from GETOPT                    
ED_GAPDE DS    CL1                 - GAP default expiration period              
*                                                                               
ED_GAPST DS    CL1                 - GAP Status                                 
ED_GAPSD DS    PL3                 - GAP sent date                              
ED_GAPED DS    PL3                 - GAP expiry date                            
ED_GAPEM DS    CL50                - GAP email address                          
         DS    (MAXEML-1)CL(L'ED_GAPEM)                                         
ED_LNQ   EQU   *-ED_VALS                                                        
                                                                                
* Initial for Add                                                               
IA_VALS  DS    0X                                                               
IA_RTYPE DS    CL1                 Return type                                  
IA_RTGVQ EQU   C'G'                - global values                              
IA_RTCVQ EQU   C'C'                - category values                            
IA_RTWVQ EQU   C'W'                - work code values                           
IA_SCHNA DS    CL20                Scheme name                                  
IA_FRMTC DS    CL8                 Format code                                  
IA_OFFCD DS    CL2                 Office code                                  
IA_JBIFL DS    CL1                 Is foreign language?                         
IA_JOBST DS    CL1                 Job draft status                             
IA_CLIPN DS    CL36                Client printing (original) name              
IA_PROPN DS    CL36                Product printing (original) name             
IA_SJAD1 DS    CL(L'ADRADD1)       Client/product/job address                   
IA_SJAD2 DS    CL(L'ADRADD1)       (line 1 - 5)                                 
IA_SJAD3 DS    CL(L'ADRADD1)                                                    
IA_SJAD4 DS    CL(L'ADRADD1)                                                    
IA_SJAD5 DS    CL(L'ADRADD1)                                                    
IA_INTUS DS    CL1                 Estimate internal use only                   
IA_TXTCP DS    CL1                 Copy text from estimate to order             
IA_UNCOM DS    CL1                 Auto copy from uncommitted amount            
IA_ORIPR DS    CL1                 Create order from in progress est            
IA_ORSUI DS    CL1                 Create order from internally sub             
IA_ORIAP DS    CL1                 Create order from internally appr            
IA_ORSUC DS    CL1                 Create order from client submitted           
IA_ORCAP DS    CL1                 Create order from client approved            
IA_CACOD DS    CL2                 Category code                                
IA_CANAM DS    CL20                Category name                                
IA_CATNA DS    CL20                Category total name                          
IA_CAINS DS    CL26                Category instruction                         
IA_CASTA DS    CL5                 Status                                       
IA_CATYP DS    CL1                 Type                                         
IA_WCTYP DS    CL1                 W/C type                                     
IA_WCOST EQU   ED_WCOST            C cost                                       
IA_WTIME EQU   ED_WTIME            T time                                       
IA_WCCOD DS    CL2                 W/C code                                     
IA_WCCAT DS    CL2                 W/C calc category                            
IA_WCDES DS    CL36                W/C override description                     
IA_WCART DS    CL1                 W/C is artist Y/N                            
IA_WCACR DS    PL6                 W/C agency commission rate                   
IA_WCOVR DS    XL2                 W/C output VAT rate                          
IA_WCOVC DS    CL1                 W/C output VAT code                          
IA_WCESP DS    PL6                 W/C estimate percentage                      
IA_WIAC  DS    CL1                 Use actuals for w/c calculation              
IA_PRRAT DS    CL1                 Print rates on estimates                     
IA_CCWC  DS    CL1                 Colour coded work codes                      
IA_WCF   DS    CL1                 Workcode estimate check flag                 
IA_WESCK DS    CL1                 Workcode estimate check setting              
         DS    XL1                 n/d                                          
IA_WCSEQ DS    XL2                 Workcode sequence                            
IA_LNQ   EQU   *-IA_VALS                                                        
                                                                                
* Work code list values                                                         
                                                                                
WL_VALS  DS    0X                                                               
WL_WC    DS    CL(L'WCOKWRK)       Work code                                    
WL_DESC  DS    CL(L'WCODESC)       Description                                  
WL_GRP   DS    CL(L'WCOGRP)        Work code group                              
WL_STAT  DS    CL1                 Status - time or cost work code              
WL_ART   DS    CL1                 Artist work code                             
WL_COMM  DS    PL6                 Commission rate                              
WL_VATR  DS    CL4                 VAT rate                                     
WL_VATC  DS    CL1                 VAT code                                     
WL_VATN  DS    CL36                VAT account name                             
WL_FDES  DS    CL36                Foreign description                          
WL_EST   DS    CL1                 Estimate check include or exclude            
WL_CCW   DS    CL(L'GOCCW)         Colour coded work code - indicator           
WL_WCF   DS    CL(L'GOWCF)         Work code is flagged for checking            
WL_VALQ  EQU   *-WL_VALS                                                        
                                                                                
* extra data values                                                             
                                                                                
XD_VALS  DS    0X                                                               
XD_PTRS  DS    XL(L'XDFRPTR+L'XDFSEQ)                                           
XD_CODE  DS    CL(L'XDFCODE)                                                    
XD_EDIT  DS    CL(L'XDFEDIT)                                                    
XD_MXLN  DS    XL(L'XDFMXLN)                                                    
XD_REQD  DS    CL1                                                              
XD_ACTV  DS    CL1                                                              
XD_NAME  DS    CL(L'XDFNAME)                                                    
XD_LIST  DS    0X                                                               
XD_STAT  DS    CL1                                                              
XD_LDAT  DS    CL(L'XDFLDATA)                                                   
XD_ACTL  DS    CL1                                                              
XD_VALQ  EQU   *-XD_VALS                                                        
XD_LISTQ EQU   *-XD_LIST                                                        
                                                                                
         ORG                                                                    
                                                                                
OVALUESL EQU   *-OVALUES                                                        
                                                                                
DVALUES  DS    0D                  Local storage                                
X#ALGEN  DS    A                   Address of end of genarea                    
X#LNTRY  DS    A                                                                
X#NLSTN  DS    A                                                                
X#WCSNT  DS    A                                                                
X#XDFEA  DS    A                                                                
X#SCHLI  DS    A                   Address of scheme list elements              
                                                                                
X#HALF   DS    H                                                                
X#CLAPJ  DS    H                   Client approver from job                     
X#INAPJ  DS    H                   Internal approver from job                   
X#CLAP   DS    H                   Client approver previously chosen            
X#INAP   DS    H                   Internal approver previously chosen          
X#ESTCNT DS    H                                                                
X#CRETR  DS    XL2                 Estimate creator                             
X#BYTE1  DS    XL1                                                              
X#BYTE2  DS    XL1                                                              
X#BYTE3  DS    XL1                                                              
X#WCRAT  DS    PL6                 Workcode rate                                
X#PL16   DS    PL16                                                             
X#FPROG  DS    XL2                 STCEPROG PID                                 
X#FPROGD DS    XL3                 STCEPROG DATE                                
X#FSUBI  DS    XL2                 STCESUBI PID                                 
X#FSUBID DS    XL3                 STCESUBI DATE                                
X#FIAPP  DS    XL2                 STCEIAPP PID                                 
X#FIAPPD DS    XL3                 STCEIAPP DATE                                
X#FSUBC  DS    XL2                 STCESUBC PID                                 
X#FSUBCD DS    XL3                 STCESUBC DATE                                
X#FCAPP  DS    XL2                 STCECAPP PID                                 
X#FCAPPD DS    XL3                 STCECAPP DATE                                
X#FMRGD  DS    XL2                 STCEMRGD PID                                 
X#FMRGDD DS    XL3                 STCEMRGD DATE                                
X#FREJT  DS    XL2                 STCEREJT PID                                 
X#FREJTD DS    XL3                 STCEREJT DATE                                
X#FDELT  DS    XL2                 STCEDELT PID                                 
X#FDELTD DS    XL3                 STCEDELT DATE                                
X#PDDTQ  EQU   *-X#FPROG                                                        
                                                                                
XL#TODP  DS    XL3                 Today's date packed                          
XL#TODC  DS    XL2                 Today's date compressed                      
XL#TODPR DS    CL6                 Today's date printable                       
XL#TODM3 DS    CL6                 TODAY MINUS 3 MONTHS                         
XL#TODP3 DS    XL3                 TODAY MINUS 3 MONTHS PACKED                  
XL#TDM13 DS    CL6                 TODAY MINUS 13 MONTHS                        
XL#TDP13 DS    XL3                 TODAY MINUS 13 MONTHS PACKED                 
                                                                                
         DS    0H                                                               
X#WCSEQ  DS    XL2                 Workcode sequence                            
X#ITSEQ  DS    XL2                 Item sequence                                
X#SVCAT  DS    CL2                 Saved category code                          
X#SVWC   DS    CL2                 Saved work code                              
X#CCMODE DS    CL1                                                              
X#DDS    DS    XL1                                                              
X#SBSMAX EQU   6                   (max # of ests for 'side by side')           
                                                                                
*&&UK                                                                           
X#MAXIOQ EQU   3000                                                             
*&&                                                                             
*&&US                                                                           
X#MAXIOQ EQU   4000                                                             
*&&                                                                             
X#MAXGAO EQU   300                 MAX N'ESTS RETURNED FOR GAOV REQUEST         
*                                  (ELSE OTHER OVLS RUNPARMS CLOBBERED)         
                                                                                
                                                                                
X#TINUM  DS    XL4                 TSAR item #                                  
X#TSAR   DS    XL1                 TSAR type                                    
                                                                                
X#MRGIND DS    XL1                 Merge indicator                              
X#MRGIBQ EQU   X'08'               - base etimate set                           
X#MRGIDQ EQU   X'04'               - different schemes                          
X#MRGIFQ EQU   X'02'               - foreign currency                           
X#MRGIXQ EQU   X'01'               - different exchange rates                   
X#MRGINQ EQU   X'80'               - not first time                             
X#MRGIIQ EQU   X'40'               - items on present wc                        
X#MRGIGQ EQU   X'20'               - wc from global estimate                    
                                                                                
X#MSRTV  DS    0XL20               TSAR sort key                                
* any key length change - adjust MTSAR04 in ACBRA03                             
         DS    0X                  estimate merge                               
X#MSRTQ  DS    0XL15                                                            
X#MSRT0  DS    XL1                 - type                                       
X#MSRT1  DS    XL1                 - not same scheme as base (X'01')            
X#MSRT2  DS    XL6                 - global estimate number                     
X#MSRT3  DS    XL2                 - category seq no                            
X#MSRT4  DS    XL2                 - work code seq no                           
X#MSRT5  DS    XL1                 - wc has items (0), wc no items (1)          
X#MSRT6  DS    XL2                 - item code seq no                           
*                                                                               
X#MSRT7  DS    XL5                 - n/d                                        
         ORG   X#MSRTV                                                          
X#PSRTV  DS    0XL20                                                            
         DS    0X                  print side by side                           
X#PSRT0  DS    XL1                 - type                                       
X#PSRT1  DS    XL2                 - category seq no                            
X#PSRT2  DS    XL2                 - work code seq no                           
X#PSRT3  DS    XL2                 - item seq no                                
X#PSRT4  DS    XL1                 - row type                                   
X#PSRTQ  EQU   *-X#PSRT0                                                        
X#PSRT5  DS    XL1                 - local estimate number inverted             
X#PSRT6  DS    XL1                 - extra column number inverted               
X#PSRT7  DS    XL10                - n/d                                        
                                                                                
X#CWIEST DS    XL1                                                              
X#CWISCH DS    CL8                                                              
*                                                                               
X#CWICAT DS    CL2        (must not disrupt this block - see CWITABD)           
X#CWIWCD DS    CL2                                                              
X#CWIITM DS    CL4                                                              
X#CWICAX DS    XL2                                                              
X#CWIWCX DS    XL2                                                              
X#CWIITX DS    XL2                                                              
         ORG   X#CWIITX                                                         
X#CWIWSB DS    XL2                                                              
*                                                                               
X#CWIND1 DS    XL1                                                              
X#CWIND2 DS    XL1                                                              
X#CWIND3 DS    XL1                                                              
                                                                                
X#USEST  DS    CL6                                                              
X#LSTCA  DS    CL2                                                              
X#LSTWC  DS    CL2                                                              
X#LSTIT  DS    CL4                                                              
X#ESTINV DS    XL1                                                              
X#ISUAPP DS    CL1                 What type of approver                        
X#ISESTQ EQU   X'80'               client estimate approver                     
X#ISINTQ EQU   X'08'               internal estimate approver                   
X#LLUIND DS    XL1                                                              
X#LLUIMQ EQU   X'08'               MEDIA                                        
X#LLUICQ EQU   X'80'               C/P/J                                        
X#LLUISQ EQU   X'04'               SCHEMES                                      
X#IOHI   DS    CL1                                                              
X#ETYP   DS    CL1                                                              
X#DISTYP DS    XL1                                                              
X#DISCOQ EQU   X'80'               Copy call                                    
X#DISRVQ EQU   X'40'               Revaluation call                             
X#DISFCQ EQU   X'20'               Foreign currency                             
X#DISMDQ EQU   X'10'               Merge call                                   
X#DISSJQ EQU   X'08'               Same job                                     
X#DISPSQ EQU   X'04'                                                            
X#CSJLVL DS    XL1                                                              
X#ACVTY  DS    XL1                                                              
X#KTYPE  DS    CL1                 Search type                                  
X#ESOFF  EQU   X'01'               Office                                       
X#CPJL   DS    CL1                 c/p/j length                                 
         DS    XL1                                                              
X#CPMJ   DS    CL13                                                             
X#OWNER  DS    XL2                                                              
X#CREBY  DS    XL2                                                              
X#ICAPP  DS    XL2                                                              
X#INAPP  DS    XL2                                                              
X#ESTCC  DS    CL3                                                              
X#DESCL  DS    XL1                                                              
X#ACAPL  DS    XL1                                                              
X#IRSTA  DS    CL3                                                              
X#COMML  DS    XL1                                                              
X#SSTAT  DS    10XL4               Estimate srch/lst - list of statuses         
X#NOSTA  DS    XL1                 Number of status entries                     
X#MSTAT  DS    XL1                 Saved status from estimate display           
X#MEDNO  DS    XL1                 Number of media code entries                 
X#MEDLS  DS    CL41                Media code list                              
         DS    0D                                                               
X#OFFNO  DS    XL1                 Number of offices                            
X#AOFFL  DS    AL3                 Address of current office in list            
X#OMETY  DS    CL1                                                              
GAPLRUNL DS    CL2                 UNIT AND LEDGER                              
GAPLRACT DS    CL12                                                             
GAPLPARM DS    XL1                 Additonal parameter for GAPLST calls         
                                                                                
X#RTTRX  DS    XL(TMSTTABL)        R time settings                              
X#BTTRX  DS    XL(TMSTTABL)        B time settings                              
X#NTTRX  DS    XL(TMSTTABL)        N time settings                              
TMSTNUM  EQU   (*-X#RTTRX)/TMSTTABL                                             
                                                                                
X#EMSCH  DS    CL8                                                              
X#EMCEN  DS    CL6                                                              
X#EMCUR  DS    CL3                                                              
X#EMRAT  DS    XL7                                                              
X#EMCPJ  DS    XL(L'ESTKCLI+L'ESTKPRO+L'ESTKJOB)                                
X#SCHNM  DS    CL20                                                             
X#CPJLI  DS    XL3                                                              
X#CPJJL  DS    CL1                                                              
X#MEDLL  DS    CL50                                                             
X#SPECS  DS    XL10                                                             
X#SBSEL  DS    XL9                                                              
X#SBSNO  DS    XL1                                                              
X#SBSIND DS    XL1                                                              
X#SBSCAD EQU   X'80'      Category added                                        
X#SBSSEQ EQU   X'40'      Sequential entry                                      
X#SBSITA EQU   X'20'      Item data added                                       
X#SBSOTH EQU   X'10'      Other Work Code                                       
X#EDITNO DS    XL1                                                              
X#BASENO DS    XL1                                                              
X#XCOSEL DS    XL6                                                              
X#XCOLNO DS    XL1                                                              
X#XCOIND DS    XL1                                                              
X#XCOSEQ EQU   X'80'                                                            
X#XCOBLA EQU   X'40'                                                            
X#XCOOTH EQU   X'20'                                                            
X#CWIAOH DS    PL6                                                              
X#CWIANC DS    PL6                                                              
X#XCCWI1 DS    XL1                                                              
X#XCCWI2 DS    XL1                                                              
X#XCCWI3 DS    XL1                                                              
X#WCSBN  DS    XL2                                                              
X#MWCAMT DS    PL6                                                              
X#SUMCNT DS    XL1                                                              
X#SRCCNT DS    XL1                                                              
X#SGOPOS DS    XL1                                                              
X#GAOV   DS    CL1                                                              
X#CURCAT DS    CL(L'X#CWICAT)                                                   
X#CURWC  DS    CL2                                                              
X#CUROF  DS    CL2                                                              
X#XCBLA  DS    CL1                                                              
X#RVEXB  DS    0XL7                                                             
         DS    XL1                                                              
X#RVEXR  DS    XL5                                                              
         DS    XL1                                                              
                                                                                
X#CPCUR  DS    CL3                                                              
X#CPEXB  DS    0XL7                                                             
         DS    XL1                                                              
X#CPEXR  DS    XL5                                                              
         DS    XL1                                                              
                                                                                
X#NICST  DS    PL3                                                              
X#NICEN  DS    PL3                                                              
X#TVRST  DS    PL3                                                              
X#TVREN  DS    PL3                                                              
                                                                                
X#SVPID  DS    XL2                                                              
X#SVPCD  DS    CL8                                                              
X#SVPFN  DS    CL16                                                             
X#SVPLN  DS    CL16                                                             
X#SVPLQ  EQU   *-X#SVPID                                                        
                                                                                
X#SVUID  DS    XL2                                                              
X#SVUSR  DS    CL10                                                             
X#SVULQ  EQU   *-X#SVUID                                                        
                                                                                
X#SJVAL  DS    0X                  Saved SJ values from estimate key            
X#SJOFF  DS    CL2                 Saved office                                 
X#SJACT  DS    CL(L'ACTKACT)       Client/product/job of estimate               
X#SJVALL EQU   *-X#SJVAL                                                        
X#CLIC   DS    CL6                 Saved client code                            
X#PROC   DS    CL6                 Saved product code                           
X#JOBC   DS    CL6                 Saved job code                               
X#MEDC   DS    CL1                 Saved media code                             
X#SCHC   DS    CL8                 Saved scheme code                            
X#LNQ    EQU   *-X#CLIC                                                         
X#CLINM  DS    CL36                                                             
X#CLIPN  DS    CL36                                                             
X#PRONM  DS    CL36                                                             
X#PROPN  DS    CL36                                                             
X#JOBNM  DS    CL36                                                             
X#WCESP  DS    PL6                 Work-Code Est % for Contingency              
X#AMT    DS    PL6                 saved trnamnt                                
X#SVSJA  DS    CL12                                                             
         DS    CL12                Spare                                        
X#SJLKF  DS    CL1                 Jobs lock flag  (RSTLSTAT)                   
X#JOBDS  DS    CL1                 Job draft status                             
X#JOBDL  DS    CL1                 Job lock status                              
X#SJAD1  DS    CL(L'ADRADD1)                                                    
X#SJAD2  DS    CL(L'ADRADD1)                                                    
X#SJAD3  DS    CL(L'ADRADD1)                                                    
X#SJAD4  DS    CL(L'ADRADD1)                                                    
X#SJAD5  DS    CL(L'ADRADD1)                                                    
                                                                                
DSDICTL  DS    0C                                                               
AC@TIME  DS    CL20                                                             
AC@MAT   DS    CL20                                                             
AC@EST   DS    CL20                                                             
                                                                                
X#UNIT   DS    CL15                UNIT                                         
X#UNLA   DS    CL15                UNIT/LANGUAGE                                
                                                                                
GAPAREA  DS    XL(GAPTLNQ)         Area to use for buffer rec                   
GAPAREA2 DS    XL(GAPTLNQ)         Area to use for buffer rec                   
GAPAREA3 DS    XL(GAPTLNQ)         Area to use for buffer rec                   
ATSRERRS DS    XL1                 Error area for buffer                        
                                                                                
X#ESNAMS DS    0XL((5*(10+1))+1)   Aura name search                             
X#ESNAL  DS    XL1                                                              
X#ESNAM  DS    CL10                                                             
X#ESNAM# DS    XL1                                                              
X#ESNAL1 DS    XL1                                                              
X#ESNAM1 DS    CL10                                                             
X#ESNAL2 DS    XL1                                                              
X#ESNAM2 DS    CL10                                                             
X#ESNAL3 DS    XL1                                                              
X#ESNAM3 DS    CL10                                                             
X#ESNAL4 DS    XL1                                                              
X#ESNAM4 DS    CL10                                                             
X#SRCL   DS    XL1                                                              
         ORG   X#ESNAMS                                                         
X#VTCBL  DS    (VTCLNQ)X           Or VATICAN BLOCK                             
                                                                                
X#EURBLK DS    (EURKBLKL)X         EUREKA BLOCK                                 
                                                                                
PROBLOCK DS    XL(PR$LNQ)          uses also for A#XDFA at EstDis               
DVALUESL EQU   *-DVALUES                                                        
*                                                                               
SAVEVARL EQU   *-SAVEVAR                                                        
         ORG   SAVED+(L'SVSERVER-(*-SAVED))  Online SAVED overflow trap         
         EJECT                                                                  
***********************************************************************         
* included books and DSECTS                                           *         
***********************************************************************         
                                                                                
SCHCATD  DSECT                                                                  
SCHCELE  DS    XL1                 element                                      
SCHCEOT  EQU   FF                                                               
SCHCLEN  DS    XL1                 length                                       
         ORG   SCHCLEN+L'SCHCLEN   category:                                    
SCHCELQ  EQU   C'C'                                                             
SCHCACO  DS    CL2                 - code                                       
SCHCANA  DS    CL20                - name                                       
SCHCATN  DS    CL20                - total name                                 
SCHCAST  DS    XL1                 - status                                     
SCHCATY  DS    XL1                 - type                                       
SCHCAIN  DS    CL26                - instructions                               
SCHCFNA  DS    CL20                - foreign name                               
SCHCFNT  DS    CL20                - foreign total name                         
SCHCLNQ  EQU   *-SCHCATD                                                        
         ORG   SCHCLEN+L'SCHCLEN   work code:                                   
SCHWELQ  EQU   C'W'                                                             
SCHWTYP  DS    XL1                 - type                                       
SCHWCOD  DS    CL2                 - work code                                  
SCHWCAT  DS    CL2                 - cal category                               
SCHWESP  DS    PL4                 - SCHWCOD ESP percentage                     
SCHWDES  DS    CL36                - override description                       
SCHWLNQ  EQU   *-SCHCATD                                                        
                                                                                
WCSTABD  DSECT                     Work code summary table                      
WCSTWC   DS    CL2                 - w/c                                        
WCSTEOT  EQU   FF                  - end of table                               
WCSTEA   DS    PL6                 - estimate amount                            
WCSTAC   DS    PL6                 - actual charges                             
WCSTPO   DS    PL6                 - purchase orders                            
WCSTHR   DS    PL6                 - all hours                                  
WCSETI   DS    PL6                 - estimated time via items                   
WCSTLNQ  EQU   *-WCSTABD                                                        
                                                                                
WCDTABD  DSECT                     Work code details table                      
WCDTWC   DS    CL2                 - w/c                                        
WCDTEOT  EQU   FF                  - end of table                               
WCDTWN   DS    CL36                - w/c name                                   
WCDTEA   DS    PL6                 - estimate amount                            
WCDTEN   DS    XL1                 - estimate local number                      
WCDTIS   DS    CL1                 - item status Y/N                            
WCDTLNQ  EQU   *-WCDTABD                                                        
                                                                                
CWITABD  DSECT                     Category/Work code/Item table                
CWITCAT  DS    CL2                 - category code                              
CWITWCD  DS    CL2                 - work code                                  
CWITITM  DS    CL4                 - item code                                  
CWITCSN  DS    XL2                 - category sequence no.                      
CWITWSN  DS    XL2                 - work code sequence no.                     
CWITISN  DS    XL2                 - item sequence no.                          
         ORG   CWITISN                                                          
CWITWSB  DS    XL2                 - wc subsequence no.                         
CWITLN1  EQU   *-CWITABD                                                        
CWITIND1 DS    XL1                 - indicator 1                                
CWITI1Q  EQU   X'01'                 (used for est 1)                           
CWITI2Q  EQU   X'02'                 (used for est 2)                           
CWITI3Q  EQU   X'04'                 (used for est 3)                           
CWITI4Q  EQU   X'08'                 (used for est 4)                           
CWITI5Q  EQU   X'10'                 (used for est 5)                           
CWITI6Q  EQU   X'20'                 (used for est 6)                           
*                                                                               
CWITIND2 DS    XL1                 - indicator 2 (other/extra columns)          
CWITPO   EQU   X'01'                 Purchase Orders (POs)                      
MAPPO    EQU   1                                                                
CWITAC   EQU   X'02'                 Actuals (total postings for job)           
MAPAC    EQU   2                                                                
CWITAH   EQU   X'04'                 Actual Hours                               
MAPAH    EQU   3                                                                
CWITBA   EQU   X'08'                 Balance (CE-Actuals)                       
MAPBA    EQU   4                                                                
CWITUN   EQU   X'10'                 Uncommitted (CE-[POs+Actuals])             
MAPUN    EQU   5                                                                
CWITCE   EQU   X'20'                 Current Estimate (CE)                      
MAPCE    EQU   6                                                                
CWITCEH  EQU   X'40'                 Current Estimated Hours (CEH)              
MAPCEH   EQU   7                                                                
CWITOE   EQU   X'80'                 Original Estimate (OE)                     
MAPOE    EQU   8                                                                
*                                                                               
CWITIND3 DS    XL1                 - indicator 3 (other/extra columns)          
CWITOEH  EQU   X'01'                 Original Estimated Hours (OEH)             
MAPOEH   EQU   9                                                                
*&&US                                                                           
CWITHR   EQU   X'02'                 Highest Revision (HR) US only              
MAPHR    EQU   10                                                               
*&&                                                                             
CWITHEH  EQU   X'04'                 Highest Estimated Hours (HEH)              
MAPHEH   EQU   11                                                               
CWITOECE EQU   X'08'                 OE - CE                                    
MAPOECE  EQU   12                                                               
CWITOEAC EQU   X'10'                 OE - Actuals                               
MAPOEAC  EQU   13                                                               
CWITCEOE EQU   X'20'                 CE - OE                                    
MAPCEOE  EQU   14                                                               
*&&US                                                                           
CWITHRCE EQU   X'40'                 Highest revision - CE                      
MAPHRCE  EQU   15                                                               
CWITHRAC EQU   X'80'                 Highest revision - Actuals                 
MAPHRAC  EQU   16                                                               
CWITIND4 DS    XL1                 - indicator 4 (other/extra columns)          
CWITHROE EQU   X'01'                 Highest revision - OE                      
MAPHROE  EQU   17                                                               
*&&                                                                             
CWITLNQ  EQU   *-CWITABD                                                        
                                                                                
MRGTABD  DSECT                     Scheme/Category/Work code/Item table         
MRGTSCH  DS    CL8                 - scheme code                                
MRGTCAT  DS    CL2                 - category code                              
MRGTWCD  DS    CL2                 - work code                                  
*RGTITM  DS    CL4                 - item code                                  
MRGTCSN  DS    XL2                 - category sequence no.                      
MRGTWSN  DS    XL2                 - work code sequence no.                     
MRGTWSB  DS    XL2                 - wc subsequence no.                         
MRGTLNQ  EQU   *-MRGTABD                                                        
                                                                                
ACTD     DSECT                     Actuals / Actual Hours table                 
ACTWCD   DS    CL2                 - work code                                  
ACTDR    DS    PL6                 - amount (debits)  Charges total             
ACTDRNC  DS    PL6                 - amount (debits)  Charges non comm          
ACTCR    DS    PL6                 - amount (credits) Billing                   
ACTOR    DS    PL6                 - amount of orders                           
ACTHRS   DS    PL6                 - hours                                      
ACTLNQ   EQU   *-ACTD                                                           
                                                                                
LAPPRTD  DSECT                     Approver table                               
LAPPRPID DS    XL2                 - approver PID                               
LAPPRDEF DS    CL1                 - default Y/N                                
LAPPRCOI DS    CL1                 - client or internal approver C/I            
LAPPRLEV DS    XL1                 - level (see APRTABL/APRLVL)                 
LAPPRLQ  EQU   *-LAPPRTD                                                        
                                                                                
APRTABD  DSECT                                                                  
APRSTAT  DS    XL1                 Levels to include                            
APRCLI   EQU   X'80'               Client                                       
APRPRO   EQU   X'40'               Product                                      
APRJOB   EQU   X'20'               Job                                          
APRMED   EQU   X'10'               Media                                        
APROFF   EQU   X'08'               Office                                       
APRLVL   DS    CL1                 Approval level                               
APRTABLQ EQU   *-APRTABD                                                        
                                                                                
OMVD     DSECT                                                                  
OMVCLI   DS    CL(L'RQ_IACLI)                                                   
OMVPRO   DS    CL(L'RQ_IAPRO)                                                   
OMVJOB   DS    CL(L'RQ_IAJOB)                                                   
OMVMED   DS    CL(L'RQ_IAMED)                                                   
                                                                                
ELFD     DSECT                    MUST MIMIC KEY OF ESTIMATE                    
ELFCLI   DS    CL(L'ESTKCLI)                                                    
ELFPRO   DS    CL(L'ESTKPRO)                                                    
*&&US*&& DS    XL1                                                              
ELFJOB   DS    CL(L'ESTKJOB)                                                    
ELFDLQ   EQU   *-ELFD                                                           
ELFLNO   DS    CL1                                                              
ELFDL2Q  EQU   *-ELFD                                                           
ELFOFFC  DS    CL2                                                              
                                                                                
VWSVTABD DSECT                                                                  
VWSVFLDN DS    XL1                 Field number                                 
VWSVTEXT DS    CL24                Text description                             
VWSVTABL EQU   *-VWSVTABD                                                       
                                                                                
ZTSARECD DSECT                                                                  
ZTRLEN   DS    XL2                 length of TSAR record                        
ZTRKEY   DS    0X                  key data                                     
ZTRKSRT  DS    XL(L'X#MSRTV)       - sort area                                  
ZTRKSEQ  DS    XL4                 - sequence number                            
ZTRKEYL  EQU   *-ZTRKEY                                                         
* any key length change - adjust MTSAR04 in ACBRA02                             
ZTRDATA  DS    0X                  buffer data                                  
ZTRDELM  DS    XL256               - element                                    
ZTRDGYN  DS    XL1                 - wc entry from global estimate Y/N          
         ORG   ZTRDATA                                                          
ZTRDAOH  DS    PL6                 - 'extra column' amount                      
ZTRDANC  DS    PL6                 - 'extra column' non commissionable          
ZTRLENQ  EQU   *-ZTSARECD                                                       
                                                                                
STATABD  DSECT                     Status table changes                         
STASTA1  DS    XL1                 Status byte 1                                
STASTA2  DS    XL1                 Status byte 2                                
STAAPPV  DS    CL1                 Approver connected y/n                       
STALSTL  EQU   *-STATABD           Length of each entry in X#SSTAT              
STACHAR  DS    CL1                 Character equivalent for status              
STATABL  EQU   *-STATABD           Length of status table entries               
                                                                                
PTRACED  DSECT                                                                  
PTTWHO   DS    CL6                                                              
         DS    CL2                                                              
PTTIO    DS    0C                                                               
PTTTIME  DS    CL(L'TTIMED)                                                     
         DS    CL1                                                              
PTHH     DS    CL2                                                              
PTCO1    DS    CL1                                                              
PTMM     DS    CL2                                                              
PTCO2    DS    CL1                                                              
PTSS     DS    CL2                                                              
         DS    CL2                                                              
PTTALPH  DS    CL(L'TALPHAID)                                                   
         DS    CL1                                                              
PTALPH   DS    CL(L'CUAALF)                                                     
         DS    CL2                                                              
PTTUSER  DS    CL(L'TUSERPID)                                                   
         DS    CL1                                                              
PTUSER   DS    CL(2*L'CUPASS)                                                   
         DS    CL2                                                              
PTFIELD  DS    CL80                                                             
                                                                                
***********************************************************************         
* Optimisation buffer record layout                                   *         
***********************************************************************         
         SPACE 1                                                                
OB_D     DSECT                                                                  
                                                                                
OB_KEY   DS    0XL15                Record key                                  
OB_TYPE  DS    CL1                 Type of data                                 
OB_ACCC  EQU   C'A'                Account code                                 
OB_MEDC  EQU   C'M'                Media code                                   
OB_PERC  EQU   C'X'                Person code                                  
OB_ACCD  DS    CL14                Account/media code/person code               
OB_ERROR DS    XL2                 Error number (Zero=OK)                       
                                                                                
OB_DATA  DS    0X                  Data starts here                             
OB_NAME  DS    CL(L'NAMEREC)       Record name                                  
OB_OTHER DS    0X                  Other data                                   
         ORG   OB_D+256                                                         
OB_DATAL EQU   *-OB_ERROR                                                       
OB_LNQ   EQU   *-OB_D                                                           
* maximum record length = 300 - MTSAR04 in ACBRA02                              
         PRINT OFF                                                              
*PREFIX=X_                                                                      
       ++INCLUDE DDDPRINTL                                                      
*PREFIX=                                                                        
         ORG   X_P                                                              
PLINEL   DS    0CL(L'X_P)           ** DATAMGR trace line **                    
PDESC    DS    CL50                                                             
         PRINT OFF                                                              
*        PRINT OFF                                                              
       ++INCLUDE ACBRAWRKD                                                      
       ++INCLUDE ACVATICAND                                                     
       ++INCLUDE GEGENGEN                                                       
       ++INCLUDE GEGENFEE                                                       
*        PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'135ACBRA17   07/07/20'                                      
         END                                                                    
