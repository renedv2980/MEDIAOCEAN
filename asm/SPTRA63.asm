*          DATA SET SPTRA63    AT LEVEL 175 AS OF 02/22/10                      
*PHASE T21663C                                                                  
*INCLUDE TIMCON                                                                 
*INCLUDE PQPROF                                                                 
*INCLUDE BINSRCH2                                                               
*                                                                               
***********************************************************************         
*                                                                     *         
*  TITLE: T21663 - TRAFFIC NETWORK CABLE INSTRUCTION GENERATION       *         
*  COMMENTS: THIS PROGRAM GENERATES NETWORK CABLE INSTRUCTIONS        *         
*  OUTPUTS: UPDATED REVISION AND UNIT RECS, PRINTED INSTR.            *         
*  LOCALS: REGISTER USAGE                                             *         
*          R2 - POINTER TO SCREEN FLDH, ERREX WILL POSITION CUSOR     *         
*          R3 - POINTER TO NETBLCKD                                   *         
*          R4 - WORK REG & KEY DSECT POINTER                          *         
*          R5 - WORK REG & POINTER TO PROGRAM/UNIT TABLES             *         
*          R6 - USED FOR GETEL ELEMENT DSECT POINTER                  *         
*          R7 - SECOND BASE                                           *         
*          R8 - POINTER TO SPOOLD                                     *         
*          R9 - POINTER TO SYSD                                       *         
*          RA - POINTER TO ATWA                                       *         
*          RB - FIRST BASE                                            *         
*          RC - POINTER TO GEND                                       *         
*                                                                     *         
* AIO USAGE - AIO1 - VALI RTNS IN CONTROLLER (SPTRA00-T21600)         *         
*                  - IN AIO FROM HYPER CONTROLLER (T00A30)            *         
*                  - NETIO                                            *         
*                  - BLIN RTN PATTERNS                                *         
*             AIO2 - CKEST READ ESTHDRS (1ST 1000) TABLE (LAST 1000)  *         
*                  - CKEST STORED EST CKS FOR COPY CODE N (BYPASS)    *         
*                  - BLIN RTN CMMLS                                   *         
*                  - SPEC TEXT, CLT, PRD, PRG COPIES TO LISTS         *         
*                  - RDPAT RTN TO GET PATTERN DATES                   *         
*             AIO3 - SVPRDLST (1ST 480)                               *         
*                  - NETBLOCK (AIO3+976 (1024 BYTES))                 *         
*                  - LAST 2000 FOR BRAND LEVEL SECURITY               *         
*                                                                     *         
* FOR EASYLINK, AGENCY COPY PRODUCED 1ST, THEN EASYLINK CLASS G ENTRY *         
*                                                                     *         
* TSPFUSER AREA  0 -  7 ID                                            *         
*                8 -135 DCB                                           *         
*              136 -139 CT TO FORCE CHANGE IN REMOTKEY                *         
*              140      EASY PRINT SW Y = ANY CLASS G EASY ENTRY      *         
*                                                                     *         
* TSAR USES ELEM AS AN I/O AREA                                       *         
*      0 - 1  LENGTH OF RECORD                                        *         
*      2 - 3  KEY - BINARY NUMBER 1 TO N                              *         
*      4      FORCEHED OR, IF BINARY, SPACE BEFORE                    *         
*      5      SPACING                                                 *         
*      6 - N  PRINT LINE (OR HEADING OR MIDLINE)                      *         
*                                                                     *         
***********************************************************************         
*                                                                     *         
* 18JAN06 01 EFJ -- LEVEL RESET (OLD HISTORY MOVED TO BOTTOM)         *         
*                -- MORE BRANDS                                       *         
*                -- USE DEFAULT TIME FOR PQ RETAINS                   *         
* 15FEB06 151 SMUR  FIX REVISION RECORD UPDATE FOR PGRP               *         
* 15MAY07 152 SMUR  FIX PRODUCT/COMMERCIAL CHECK FOR COPY SPLITS      *         
* 10JAN08 153 MNAS  INCREASE PROD GROUP TABLE TO 150 PRODUCTS         *         
* 28FEB08 153 SMUR  ALLOW SWITCHING PERIODS BROA/CAL/WEEKLY           *         
* 04NOV08 161 SMUR  NEW HEADING LAYOUT                                *         
* 20NOV08 162 SMUR  BUG FIXES - PT TO SPOT FILE FOR PROG REC READ     *         
* 08JAN09 163 MNAS  ADD ARCHIVING CODE                                *         
* 29JAN09 164 SMUR  FIX TBA BUG/MISSING PROD BUG/'*' INDICATION BUG   *         
* 10JUN09 167 MNAS  ARCHIVE                                           *         
*   JUN09 168 SMUR  NEW BODY LAYOUT                                   *         
* 18JUN09 170 SMUR  FULL AD-ID SUPPORT                                *         
* 28JUL09 171 SMUR  FIX WHERE DUB GETS CREAMED IN HDHK SOMETIMES      *         
* 28OCT09 172 SMUR  PRINTING OF PATTERNS AND TBA PHASE 2A             *         
*   NOV09 173 SMUR  PGROUP FOR CLIENT CONTACT & DISTRIBUTION LIST     *         
*                                                                     *         
*            ************** TERMINUS *******************              *         
***********************************************************************         
         TITLE 'T21663 - NETWORK TRAFFIC CABLE INSTRUCTION GENERATION'          
T21663   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,T21663**,R7,RR=R3                                              
         L     RC,0(R1)                                                         
         USING GEND,RC                                                          
         L     R8,ASPOOLD          GENERAL PRINT AREAS                          
         USING SPOOLD,R8                                                        
         L     RA,ATWA                                                          
         USING CONHEADH-64,RA      BASE SCREEN FOR SYSTEM + THIS PROG           
         L     R9,ASYSD                                                         
         USING SYSD,R9                                                          
         ST    R3,SPTR63RR                                                      
                                                                                
         L     RE,=A(OPTPGRL)                                                   
         AR    RE,R3                                                            
         ST    RE,AOPTPGRL                                                      
                                                                                
         L     RE,=V(PQPROF)                                                    
         AR    RE,R3                                                            
         ST    RE,APQPROF                                                       
                                                                                
         L     R3,AIO3                                                          
         LA    R3,976(,R3)         NETBLOCK IN LAST 1024 OF AIO3                
         USING NETBLCKD,R3                                                      
         LA    RF,PTTNCTR                                                       
         ST    RF,ASVSTOR                                                       
         AHI   RF,6144             END OF SAVED AREA                            
         LR    R1,R9                                                            
         A     R1,LSYSD                                                         
         CR    RF,R1                                                            
         BNH   *+6                                                              
         DC    H'0'                USED MORE THAN SYSD                          
*                                                                               
         LAY   R1,PRGTABLE                                                      
         LHI   R0,PRGTBLX-PRGTABLE                                              
*                                                                               
         LAY   RE,PATABLE                                                       
         LHI   RF,ENDPATBL-PATABLE                                              
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   INIT10                                                           
*                                                                               
         L     R1,VADUMMY                                                       
         MVC   0(8,R1),=C'*ALLPRG*'                                             
         LA    R1,8(R1)                                                         
         ST    R1,ALLPRTAB         ADDRESS OF ALL PROGRAM TABLE                 
         L     R0,=F'20000'                                                     
         AR    R1,R0                                                            
         ST    R1,MAXPRTAB         END OF ALL PROG TABLE                        
*                                                                               
         L     R0,=F'40000'                                                     
         LR    RE,R1                                                            
         AR    RE,R0                                                            
         L     RF,=F'10000'                                                     
*                                                                               
INIT10   ST    R1,APRGTBLE                                                      
         AR    R1,R0                                                            
         ST    R1,MXPRGTBL                                                      
         ST    RE,APATABLE                                                      
         AR    RE,RF                                                            
         ST    RE,MAXPATBL                                                      
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BE    INIT15                                                           
*                                                                               
         LR    RE,R9               FIND ENTRY IN ALL PROG REF LIST              
         AH    RE,=AL2(ALLPRGLS-SYSD)                                           
         ST    RE,ALLPRTAB         START OF ALL PROG TABLE ONLINE               
         LR    RF,R9                                                            
         A     RF,LSYSD                                                         
         ST    RF,MAXPRTAB         END OF ALL PROG TABLE ONLINE                 
*                                                                               
INIT15   TM    WHEN,X'40'          IS THIS RUNNING NOW                          
         BO    NOWERR                                                           
*                                                                               
INIT20   XC    DMCB(7),DMCB                                                     
         MVC   DMCB+4(4),=X'D9000A1D'  GETBROAD                                 
         GOTO1 CALLOV,DMCB                                                      
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   VGTBROAD,0(R1)                                                   
*                                                                               
         MVC   DMCB+4(4),=X'D9000AFE'    GET ADDRESS OF TRPACK                  
         GOTO1 CALLOV,DMCB                                                      
         MVC   VTRPACK,0(R1)                                                    
*                                                                               
* INITIALIZE BINTABLE                                                           
*                                                                               
         GOTO1 CALLOV,DMCB,X'59000000',0,0   T21659                             
         CLI   4(R1),0                  COMMERCIAL TABLE SAVE AREA              
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R1,DMCB                                                          
         LA    R1,8(R1)            BUMP OVER T21659                             
         ST    R1,ACMLTAB                                                       
*                                                                               
         BRAS  RE,IACML            INIT ADDITIONAL CML INFO TABLE               
*                                                                               
         EJECT                                                                  
         CLI   MODE,VALKEY         VALIDATE RECORD KEY                          
         BE    VK                                                               
         CLI   MODE,PRINTREP       OFFLINE INSTRUCTIONS                         
         BE    LRR                                                              
         CLI   MODE,RUNFRST                                                     
         BE    GENAUTO                                                          
         CLI   MODE,RUNLAST                                                     
         BE    GENFIN                                                           
*                                                                               
EXIT     XIT1                                                                   
         SPACE 3                                                                
*---------------------------------*                                             
* SET UP FOR OFFLINE REQUIREMENTS *                                             
* MODE RUNFRST                    *                                             
*---------------------------------*                                             
*                                                                               
GENAUTO  CLI   OFFLINE,C'Y'                                                     
         BNE   EXIT                                                             
         TM    WHEN,X'C0'          TEST IMMED/NOW                               
         BZ    *+6                                                              
         DC    H'0'                                                             
         MVC   SEQNUM,=H'1'                                                     
         MVI   29(RA),X'02'        SET RUNLAST HOOK REQUIRED                    
*                                                                               
         L     RE,TWAMASTC                                                      
         L     RF,MCSSB-MCBLOCK(RE)                                             
         OI    SSBSTAT2-SSBD(RF),SSBSROLC                                       
*                                                                               
         B     EXIT                                                             
         SPACE 3                                                                
* CK IF ANY EASYLINK STUFF THAT MIGHT GET LOST *                                
*                                                                               
GENFIN   CLI   OFFLINE,C'Y'                                                     
         BNE   EXIT                                                             
         TM    WHEN,X'C0'          TEST IMMED/NOW                               
         BZ    *+6                                                              
         DC    H'0'                                                             
         ICM   RE,15,TWAMASTC                                                   
         BZ    EXIT                                                             
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BNZ   EXIT                                                             
         L     RE,TWADCONS                                                      
         L     RE,TSPFUSER-TWADCOND(RE)                                         
         CLI   140(RE),C'Y'        SEE IF ANY EASYLINK STUFF PRINTED            
         BNE   EXIT                 NO                                          
*                                                                               
* OPEN DIRECT ENTRY (WHICH WILL BE LOST)  TO PRESERVE REAL QUE ENTRY *          
*                                                                               
         L     RE,TWAMASTC                                                      
         L     R4,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,R4                                                       
*                                                                               
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVC   REMOTJID,=C'STB'                                                 
*AR                                                                             
         MVC   REMOTTY1,SVQLTYP1                                                
*AR                                                                             
         MVC   REMOTDST,TWAORIG                                                 
         MVI   REMOTCLS,C'A'                                                    
         MVI   REMOTCPY,1                                                       
*                                                                               
         GOTO1 OPENPQ                                                           
         MVC   P(5),=C'DUMMY'                                                   
         GOTO1 SPOOL,DMCB,(R8)    TRY THIS BEFORE XC REMOTKEY                   
         MVI   SPMODE,X'FE'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
         XC    REMOTKEY,REMOTKEY                                                
         B     EXIT                                                             
         DROP  R4                                                               
         SPACE 2                                                                
*     VALIDATE KEY ROUTINE                                                      
         SPACE 2                                                                
* IF NO CHANGES TO KEY FIELDS, THEN CHECK FOR SELECTS *                         
         SPACE 2                                                                
VK       MVI   PQSW,1              SUPPRESS AUTO PRTQUE OPEN                    
*AR                                                                             
         MVI   SVFAXARC,0          CLEAR FAX ARCHIVE BYTE                       
         MVI   SVQLTYP1,0          CLEAR FAX ARCHIVE BYTE                       
         XC    ELEM,ELEM                                                        
         XC    PROFKEY,PROFKEY                                                  
         MVI   PROFKEY,C'S'                                                     
         MVC   PROFKEY+1(2),=C'TB'                                              
         MVC   PROFKEY+3(2),TWAORIG                                             
         GOTO1 APQPROF,DMCB,(X'80',PROFKEY),(0,ELEM),ACOMFACS                   
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R4,ELEM                                                          
         USING REMOTED,R4                                                       
         MVC   SVQLTYP1,REMOTTY1                                                
                                                                                
         CLI   REMOTSUB,C'#'                                                    
         BNE   VK03                                                             
         CLI   REMOTSUB+1,C'N'                                                  
         BE    VK05                                                             
         CLI   REMOTSUB+1,C'A'                                                  
         BNE   VK03                                                             
         OI    SVFAXARC,REMOTARQ                                                
         B     VK05                                                             
VK03     OI    SVFAXARC,REMOTAEQ                                                
VK05     DS    0H                                                               
         DROP  R4                                                               
         TM    WHEN,X'20'              IF SOON SKIP                             
         BO    VK08                                                             
         CLI   TRAFAX,C'N'             IF NOT FAX=2 SKIP                        
         BE    VK08                                                             
         CLI   TRAFAX,C'C'             IF NOT FAX=2 SKIP                        
         BE    VK08                                                             
         OI    GENSTAT3,NOCLRSPK                                                
         MVI   PQSW,1                                                           
         LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         USING PQPLD,R1                                                         
         XC    ELEM(128),ELEM                                                   
         MVC   QLTYP1,SVQLTYP1                                                  
         MVC   QLDESC(3),=C'NTB'                                                
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
         GOTO1 OPENPQ                                                           
VK08     DS    0H                                                               
         DROP  R1                                                               
*AR                                                                             
         CLI   OFFLINE,C'Y'        ONLINE ?                                     
         BE    VK09                YES, DONE (MULTI-FAX NOT SUPPORTED)          
         CLI   TMPSTSW,C'Y'                                                     
         BNE   VK09                                                             
         LA    R1,=C'DMREAD'                                                    
         XC    DMCB(24),DMCB                                                    
         ST    R1,DMCB                                                          
         L     RE,ATWA                                                          
         MVC   DMCB+10(2),2(RE)                                                 
         MVI   DMCB+8,4                                                         
         ICM   RF,12,=C'L='                                                     
         ICM   RF,3,=Y(TABSAVL)                                                 
         GOTO1 DATAMGR,DMCB,,=C'TEMPSTR',,AOPTPGRL,,(RF)                        
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
VK09     DS    0H                                                               
*                                                                               
         XC    SVNET,SVNET         INIT CURRENT NETWORK (FOR NET=ALL)           
*                                                                               
         TM    TRACLTH+4,X'20'     CLIENT CHANGED                               
         BZ    VK10                  YES REVALIDATE                             
         TM    TRANETH+4,X'20'     NETWORK CHANGED                              
         BZ    VK10                  YES REVALIDATE                             
         TM    TRAPRGH+4,X'20'     PROGRAM CHANGED                              
         BZ    VK10                  YES REVALIDATE                             
         TM    TRAPERH+4,X'20'     PERIOD CHANGED                               
         BZ    VK10                  YES REVALIDATE                             
         TM    TRAFAXH+4,X'20'     FAX CHANGED                                  
         BZ    VK10                  YES REVALIDATE                             
         TM    TRAOPTH+4,X'20'     OPTIONS CHANGED                              
         BZ    VK10                  YES REVALIDATE                             
         TM    ANYFLAG,TABLESW     WAS TABLE BUILT                              
         BZ    VK10                NO                                           
         EJECT                                                                  
CSEL     BAS   RE,RDTWA            RESTORE UNIT TABLE, ETC                      
*                                                                               
* CHECK FOR UNPROTECTED SELECT FIELDS                                           
*                                                                               
         LA    R2,TRASEL1H                                                      
         L     R5,APRGTBLE                                                      
         USING PRGTABLD,R5                                                      
         MVI   FRSTPGSW,C'Y'       SET 1ST PAGE SW                              
         NI    UPDSW,X'FF'-X'10'   SET OFF RETRANSMIT THIS SCREEN               
*                                                                               
* FIND HIGHEST NETWORK REVISION #                                               
*                                                                               
         MVI   SVNETREV,0                                                       
CSEL05   CLC   SVNETREV,PRGNREVN                                                
         BNL   *+10                                                             
         MVC   SVNETREV,PRGNREVN   SAVE HIGHEST NETWORK REV #                   
         LA    R5,PRGNEXT                                                       
         OC    0(4,R5),0(R5)       END OF THE TABLE                             
         BNZ   CSEL05               NO                                          
*                                                                               
         L     R5,APRGTBLE                                                      
*                                                                               
CSEL10   TM    1(R2),X'20'         PROTECTED                                    
         BO    CSEL14              YES, DONE THIS BEFORE                        
         CLI   5(R2),0             ANY ENTRY                                    
         BE    MISSELER                                                         
         CLI   8(R2),C'S'          SELECT (PRINT INSTR)                         
         BNE   CSEL14              NO                                           
         OI    UPDSW,X'10'         SET TO RETRANSMIT THIS SCREEN                
*                                                                               
* SEE IF WE ARE LOCKED OUT BY UNIT ALLOCATION                                   
*                                                                               
         XC    DUB,DUB                                                          
         MVI   BYTE,0                                                           
         MVC   DUB(4),=C'TNET'                                                  
         GOTO1 VALILOC,0                                                        
*                                                                               
* IF RUNNING FOR ALL PRODUCTS, SEE THAT NONE OF THE PRODS ARE LOCKED            
*                                                                               
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   TLOCK30             NOT AN ALL PRODUCT RUN                       
*                                                                               
* GET PRODUCTS FOR THIS CLIENT                                                  
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         XC    SVCPROD,SVCPROD     INIT PROD                                    
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0DF1'      PROD REC                                    
         MVC   KEY+2(3),BAGYMD    & BCLT                                        
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
TLOCK15  CLC   KEY(5),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   KEY+5,X'FF'         LAST REC FOR THIS CLT                        
         BNE   *+14                                                             
         XC    SVCPROD,SVCPROD     CLEAR PROD                                   
         B     CSEL12               YES, DONE                                   
*                                                                               
         MVC   SVCPROD,KEY+6       SAVE 3 CHAR PROD                             
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         GOTO1 VALILOC,SVCPROD                                                  
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         GOTO1 VALILOC,SVCPROD                                                  
         GOTO1 SEQ                 GET NEXT PROD REC                            
         B     TLOCK15                                                          
*                                                                               
* IF RUNNING BY PRODUCT, SEE THAT THIS PRD IS NOT LOCKED                        
*                                                                               
TLOCK30  CLI   SVTN2PRO+00,C'*'                                                 
         BNE   TLOCK50                                                          
         MVC   BYTE,SVTN2PRO+00                                                 
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   SVCPROD,OPTPROD                                                  
         GOTO1 VALILOC,SVCPROD                                                  
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         GOTO1 VALILOC,SVCPROD                                                  
         B     CSEL12                                                           
*                                                                               
* IF RUNNING BY PGROUP, SEE THAT THIS PGROUP IS NOT LOCKED                      
*                                                                               
TLOCK50  OC    OPTPRGR,OPTPRGR     PROD GROUP                                   
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVC   BYTE,SVTN2PRO+00                                                 
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   DUB+6(2),OPTPRGR    THIS PGROUP LOCKED?                          
         GOTO1 VALILOC,0                                                        
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         MVC   DUB+6(2),OPTPRGR    THIS PGROUP LOCKED?                          
         GOTO1 VALILOC,0                                                        
CSEL12   DS    0H                                                               
*                                                                               
         BAS   RE,GEN              GO MARK OR GENERATE INSTRUCTIONS             
*                                                                               
CSEL14   LA    R2,NEXTLINE(,R2)                                                 
         LLC   RE,0(R2)                                                         
         LA    RF,0(RE,R2)                                                      
         OC    8(L'TRADSP1,RF),8(RF) ANYTHING HERE                              
         BZ    CSEL16              NO, NO SEL CODE NEEDED                       
         CLI   0(R2),9                                                          
         BH    CSEL10                                                           
CSEL16   A     R5,ASVNEXT          GET STARTING POINT IN TABLE                  
         OC    0(4,R5),0(R5)       AT END OF TABLE                              
         BZ    CSEL20                                                           
         TM    UPDSW,X'10'         SET TO RETRANSMIT THIS SCREEN                
         BZ    LRL                 GO ON TO NEXT SCREEN, IF ANY                 
*                                                                               
         MVC   GERROR,=Y(SELMSG2)                                               
         MVI   GMSGTYPE,C'I'                                                    
         OI    TRATAGH+1,X'01'     SET MODIFIED BIT                             
         OI    TRATAGH+6,X'80'     AND TRANSMIT                                 
         B     COMXIT                                                           
*                                                                               
CSEL20   TM    SVOPTSW1,OPT1EACH   EACH PROG ON SEP LETTER                      
         BO    DONEALL                                                          
*                                                                               
         TM    UPDSW,X'01'         ANY PROG SELECTED FOR INSTR                  
         BZ    DONENOSL                                                         
*                                                                               
         BRAS  RE,PRT                GO PRINT ALL SELECTED                      
*                                                                               
         LA    R2,TRASEL1H                                                      
         LLC   R6,0(R2)                                                         
         AR    R6,R2                                                            
         USING LSTLINE,R6                                                       
*                                                                               
         OI    6(R6),X'80'         DISPLAY SPOOL ID FOR USER                    
         XC    LPRTID,LPRTID                                                    
         MVC   LPRTID(3),=C'ID='                                                
         MVC   LPRTID+3(3),REMUSER                                              
         MVI   LPRTID+6,C','                                                    
         SR    R0,R0                                                            
         ICM   R0,3,SPOOLRPN                                                    
         BAS   RE,LRLEDITA                                                      
         MVC   LPRTID+7(5),ELEM                                                 
*        EDIT  (R0),(5,LPRTID+7),ALIGN=LEFT                                     
         B     DONEALL                                                          
         DROP  R6                                                               
         EJECT                                                                  
* CLEAR WORKING STORAGE *                                                       
*                                                                               
VK10     CLI   1(RA),C'*'          THIS A DDS TERMINAL                          
         BE    *+12                 YES                                         
         TM    WHEN,X'40'          THIS NOW                                     
         BO    NOTDDSER                                                         
*                                                                               
         LA    RE,ASVFTNT                                                       
*NOP     LA    RF,EQVPTBL-ASVFTNT                                               
         LA    RF,BINDMCB-ASVFTNT                                               
         XCEF                                                                   
         XC    AERRFILE,AERRFILE         STORED DCB ADDRESS                     
         BAS   RE,CLRSCR           GO CLEAR SCREEN                              
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BZ    VK14                                                             
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BZ    *+8                                                              
         MVI   DIRPRTSW,C'Y'                                                    
*                                                                               
VK14     L     RE,APRGTBLE         CLEAR PROGRAM TABLE                          
         L     RF,MXPRGTBL                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
         L     RE,APATABLE         CLEAR PATTERN TABLE                          
         L     RF,MAXPATBL                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
         L     RE,ALLPRTAB         CLEAR ALL PROGRAM TABLE                      
         L     RF,MAXPRTAB                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
* VALIDATE KEY FIELDS                                                           
*                                                                               
         LA    R2,ELEM             FAKE VALIMED                                 
         MVC   ELEM,=X'0A01000184010001'                                        
         MVI   ELEM+8,C'N'                                                      
         GOTO1 VALIMED                                                          
*                                                                               
         LA    R2,TRACLTH          CLIENT                                       
*                                                                               
         GOTO1 VALICLT                                                          
*                                                                               
         OI    4(R2),X'20'         SET ON VALIDATED                             
*                                                                               
* READ & CHECK OUT TW PROFILE 6 VALUES                                          
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'S0TW'                                                 
         MVC   WORK+4(2),AGENCY                                                 
         MVI   WORK+6,C'N'                                                      
         MVC   WORK+7(3),QCLT                                                   
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),SVCLTOFF CLIENT OFFICE                                
*                                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VK16                                                             
*                                                                               
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQ                          
         BO    VK16                                                             
*                                                                               
         MVC   WORK+11(1),SVPRDOFF USE PROD OFFICE                              
*                                                                               
VK16     GOTO1 GETPROF,DMCB,WORK,SVTWPROF,DATAMGR                               
*                                                                               
         CLI   SVTWPR06,C'Y'       SEND AS EASYLINK                             
         BE    VK20                                                             
         CLI   SVTWPR06,C'2'       SEND AS EASYLINK + AGENCY COPY               
         BE    VK20                                                             
         MVI   SVTWPR06,C'N'       DEFAULT IS N                                 
*                                                                               
* READ TN PROFILE                                                               
*                                                                               
VK20     MVI   WORK+3,C'N'                                                      
         GOTO1 (RF),(R1),,SVPROF                                                
*                                                                               
         MVC   MYTN2PR6,SVPROF+1                                                
*                                                                               
* READ TN3 PROFILE *                                                            
*                                                                               
         MVI   WORK,X'A2'                                                       
         MVC   WORK+1(3),=C'TN3'                                                
         GOTO1 (RF),(R1),,SVT1PROF                                              
*                                                                               
         MVC   SVTN3PR3,SVT1PROF+2                                              
*                                                                               
* READ TN1 PROFILE *                                                            
*                                                                               
         MVI   WORK,X'A2'                                                       
         MVC   WORK+1(3),=C'TN1'                                                
         GOTO1 (RF),(R1),,SVT1PROF                                              
*                                                                               
         CLI   TRANETH+5,3                                                      
         BNE   VK45                                                             
         CLC   =C'ALL',TRANETH+8                                                
         BNE   VK45                                                             
*                                                                               
         NI    ANYFLAG,X'FF'-NETFOUND   INIT NETWORK FOUND                      
         TM    WHEN,X'38'          TEST SOON/OVERNIGHT/DDS                      
         BZ    OFFLNERR             NO, ERROR                                   
         B     VK23                                                             
*                                                                               
VK22     NTR1                                                                   
         L     RE,APRGTBLE         CLEAR PROGRAM TABLE                          
         L     RF,MXPRGTBL                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
         L     RE,APATABLE         CLEAR PATTERN TABLE                          
         L     RF,MAXPATBL                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
         XC    PTTNCTR,PTTNCTR     INIT UNIT COUNT                              
*                                                                               
         L     RE,ALLPRTAB         CLEAR ALL PROGRAM TABLE                      
         L     RF,MAXPRTAB                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
VK23     BAS   RE,VOPTP            VALIDATE OPTIONS (PARTIALLY)                 
*                                                                               
         TM    WHEN,X'20'          TEST SOON                                    
         BZ    *+12                                                             
         TM    SVOPTSW,OPTTEST                                                  
         BZ    OFFLNERR            ONLY TEST RUNS FOR SOON                      
*                                                                               
VK40     DS    0H                                                               
         NI    ANYFLAG,X'FF'-TRIFOUND  RESET TRI-BACK SWITCH                    
         NI    ANYFLAG,X'FF'-COPYSSW+PIGGBSW INIT C/S, P/B SWITCH               
*                                                                               
         BRAS  RE,GNET               GET NETWORK (FILLS IN SVNET)               
         CLC   SVNET,=X'FFFFFFFF'                                               
         BNE   VK45                                                             
         TM    ANYFLAG,NETFOUND    AT LEAST ONE NETWORK FOUND                   
         BZ    VKERR                                                            
         B     VK77                                                             
*                                                                               
VK45     MVI   UPDSW,0                                                          
         BRAS  RE,VNET                                                          
         BNE   VK40                                                             
*                                                                               
         OC    SVNET,SVNET         ALL NET REQUEST                              
         BNZ   VK60                YES, GET GOOD N/W THEN DO VOPT               
*                                                                               
* VALIDATE FAX AND OPTIONS FIELDS (MUST BE DONE AFTER VNET)                     
*                                                                               
         BRAS  RE,VOPT              GO VALIDATE OPTIONS                         
*                                                                               
* VALIDATE PERIOD BEFORE PROGRAM *                                              
*                                                                               
VK60     BRAS  RE,VPER              VALIDATE PERIOD - MONTH/YEAR                
*                                                                               
         OC    SVNET,SVNET         ALL NETWORK REQUEST                          
         BZ    VK65                                                             
*                                                                               
         BRAS  RE,VMYNET              VALIDATE MY NETWORK                       
         BNE   VK40                                                             
*                                                                               
         BRAS  RE,VOPT              GO VALIDATE OPTIONS                         
*                                                                               
* VALIDATE PROGRAM AND OPEN ERROR FILE FOR OFFLINE ERROR REPORT *               
*                                                                               
VK65     LA    R2,TRAPRGH          PROGRAM                                      
*                                                                               
         BRAS  RE,VPROG                                                         
*                                                                               
         OC    SVNET,SVNET         ALL NETWORK REQUEST                          
         BZ    VK70                 NO                                          
         CLI   UPDSW,X'FF'         ANY UNITS FOUND                              
         BNE   VK70                 YES, GO PROCESS                             
         CLC   SVNET,=X'FFFFFFFF'                                               
         BE    VKERR                                                            
         B     VK40                                                             
         EJECT                                                                  
* READ UNITS FOR THIS PERIOD AND PROGRAM(S), AND BUILD PROGRAM TABLE *          
*                                                                               
VK70     DS   0H                                                                
*                                                                               
* OPEN ERROR FILE FOR OFFLINE ERROR REPORT *                                    
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   VK76                                                             
*                                                                               
         OC    AERRFILE,AERRFILE   IS FILE OPEN                                 
         BNZ   VK76                                                             
*                                                                               
         L     RE,TWADCONS         MAKE SURE OUTPUT DCB ADDRESS SET             
         USING TWADCOND,RE          FOR OFFLINE JOBS                            
         L     RE,TSPFUSER                                                      
         MVC   0(8,RE),=C'*ERRFIL*'                                             
         LA    R4,8(,RE)                                                        
         ST    R4,AERRFILE                                                      
         DROP  RE                                                               
         L     RF,=A(ERRFILE)      DCB ADDRESS                                  
*                                                                               
         TM    WHEN,X'20'          THIS A SOON REQUEST                          
         BZ    VK74                 NO                                          
*                                                                               
         MVC   40(8,RF),=CL8'TALWRK'                                            
*                                                                               
VK74     MVC   0(128,R4),0(RF)                                                  
*                                                                               
         OPEN  ((R4),OUTPUT)                                                    
*                                                                               
         LTR   RF,RF               CHECK OPEN WAS OK                            
         BZ    VK76                                                             
         DC    H'0'                                                             
VK76     DS    0H                                                               
         BAS   RE,BLPRG                                                         
         BE    VK80                                                             
         OC    SVNET,SVNET         DOING ALL NETWORKS?                          
         BZ    VK78                 NO                                          
         CLC   SVNET,=X'FFFFFFFF'  DONE ALL NETS ?                              
         BNE   VK40                                                             
         TM    ANYFLAG,NETFOUND    WERE ANY NETWORKS FOUND                      
         BZ    VKERR                                                            
*                                                                               
VK77     DS    0H                                                               
         OC    AERRFILE,AERRFILE         STORED DCB ADDRESS                     
         BZ    EXIT                                                             
*                                                                               
         L     R3,AERRFILE         STORED DCB ADDRESS                           
         CLOSE ((R3),)                                                          
         FREEPOOL (R3)                                                          
*                                                                               
         B     EXIT                                                             
*                                                                               
VK78     DS    0H                                                               
         TM    SVFLAG,SVPRGERR+SVTSERR  ANY ERRORS?                             
         BZ    *+14                                                             
         MVC   GERROR,=Y(BDTSUPP) TRAFFIC SUPPLIER ERROR                        
         B     *+10                                                             
         MVC   GERROR,=Y(NOUNTSEL) IF NONE FOUND, ERROR                         
         LA    R2,TRACLTH                                                       
         B     COMERR                                                           
*                                                                               
VK80     OI    TRAPERH+4,X'20'     SET ON VALIDATED                             
         OI    ANYFLAG,NETFOUND    AT LEAST ONE GOOD NETWORK FOUND              
*                                                                               
* BLANK THE HEADLINES NOW *                                                     
*                                                                               
         LA    R0,14                                                            
         LA    R1,H1                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         L     R5,APRGTBLE                                                      
*                                                                               
         OI    ANYFLAG,TABLESW     SET TABLE BUILT, READY FOR INSTR             
*                                                                               
         CLI   SVTWPR06,C'N'       NO FAX                                       
         BE    VK84                                                             
*                                                                               
         CLI   SVTWPR11,C'Y'       TRAFFIC RECS FOR FAX #                       
         BE    VK82                                                             
*                                                                               
         OC    SVSFAX,SVSFAX       ANY FAX ?                                    
         BZ    FAXERR              MISSING FAX #                                
*                                                                               
VK82     BAS   RE,GTRAFAX          GET TRAFFIC FAX                              
         OC    SVSFAX,SVSFAX       ANY FAX ?                                    
         BZ    FAXERR              MISSING FAX #                                
*                                                                               
VK84     TM    WHEN,X'38'          TEST SOON/OVERNIGHT/DDS                      
         BZ    LRL                 GO BUILD SCREEN                              
         NI    TRACLTH+4,X'FF'-X'20' FORCE CLIENT CHANGED                       
*                                                                               
* SEE IF ANY PROGRAMS WITHOUT COMMERCIALS OR UNALLOCATED *                      
*                                                                               
         USING PRGTABLD,R5                                                      
VK90     TM    SVOPTSW,OPTUNAS     UNASSIGNED UNITS OK                          
         BO    VK94                                                             
         TM    SVOPTSW,OPTSEED     OPER SAYS SEED WILL BE RUN                   
         BO    VK94                                                             
         OC    PRGUNAS,PRGUNAS     THIS PROGRAM HAVE ALL COMMERCIALS            
         BNZ   NOCMLER              NO                                          
VK94     TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    VK96                                                             
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    VK96                                                             
         OC    PRGUNAL,PRGUNAL     THIS PROGRAM HAVE ALL PROD ALLOC             
         BZ    VK96                 YES                                         
         MVC   GERROR,=Y(UNALPRD)   NO                                          
         B     COMERR                                                           
*                                                                               
VK96     LA    R5,PRGNEXT                                                       
         OC    0(4,R5),0(R5)       EOL                                          
         BNZ   VK90                 NO                                          
*                                                                               
         BAS   RE,CLRSCR                                                        
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   *+8                                                              
*                                                                               
         BAS   RE,INITSROF         INIT TSAROFF                                 
*                                                                               
         OC    SVNET,SVNET         ALL NET REQUEST                              
         BZ    *+4                                                              
         BRAS  RE,IACML            YES, RE-INIT ADDITIONAL CML INFO             
*                                                                               
         TM    WHEN,X'20'          THIS SOON PROCESSING                         
         BZ    EXIT                 NO                                          
*                                                                               
         CLI   SVTWPR06,C'N'       NO FAX                                       
         BE    VK100                                                            
*                                                                               
         MVC   REMUSER,=C'CWX'                                                  
*AR                                                                             
         MVC   SPOOLKEY+QLTYP1-PQPLD(1),SVFAXARC     SOON PROCESSING            
*AR                                                                             
         MVI   SPOOLKEY+PLCLASS-PQPLD,C'G'                                      
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BZ    VK100                                                            
         MVI   MCREQREP-MASTD(RE),C'N' SUPPRESS REQUEST PAGE                    
*                                                                               
VK100    TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    EXIT                 NO UPDATE, NO NEED TO LOCK                  
*                                                                               
* SEE IF WE ARE LOCKED OUT BY UNIT ALLOCATION                                   
*                                                                               
         XC    DUB,DUB                                                          
         MVI   BYTE,0                                                           
         MVC   DUB(4),=C'TNET'                                                  
         GOTO1 VALILOC,0                                                        
*                                                                               
* IF RUNNING FOR ALL PRODUCTS, SEE THAT NONE OF THE PRODS ARE LOCKED            
*                                                                               
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   VK130               NOT AN ALL PRODUCT RUN                       
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         XC    SVCPROD,SVCPROD     INIT PROD                                    
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0DF1'      PROD REC                                    
         MVC   KEY+2(3),BAGYMD    & BCLT                                        
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
VK110    CLC   KEY(5),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   KEY+5,X'FF'         LAST REC FOR THIS CLT                        
         BNE   *+14                                                             
         XC    SVCPROD,SVCPROD     CLEAR PROD                                   
         B     VK120                YES, DONE                                   
*                                                                               
         MVC   SVCPROD,KEY+6       SAVE 3 CHAR PROD                             
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         GOTO1 VALILOC,SVCPROD                                                  
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         MVC   DUB+6(1),3(R4)      THIS PRD LOCKED?                             
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         GOTO1 SEQ                 GET NEXT PROD REC                            
         B     VK110                                                            
*                                                                               
* LOCK OUT FOR SOON UPDATES (FOR ALL PRODUCTS)                                  
*                                                                               
VK120    XC    DUB,DUB                                                          
         MVI   DUB,C'L'            LOCK                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   VK125                                                            
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   VK125                                                            
         MVI   DUB+2,X'FF'                                                      
         MVC   DUB+3(1),SVMEDIA    THEN LOCK BY MEDIA                           
         XC    DUB+4(2),DUB+4                                                   
VK125    MVI   DUB+6,X'FF'         ALL PRODS                                    
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    VK200                                                            
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
         B     VK200                                                            
*                                                                               
* IF RUNNING BY PRODUCT, SEE THAT THIS PRD IS NOT LOCKED                        
*                                                                               
VK130    CLI   SVTN2PRO+00,C'*'                                                 
         BNE   VK150                                                            
         XC    DUB,DUB                                                          
         MVC   BYTE,SVTN2PRO+00                                                 
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   SVCPROD,OPTPROD     THIS PRD LOCKED?                             
         GOTO1 VALILOC,SVCPROD                                                  
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'L'            LOCK                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   VK135                                                            
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   VK135                                                            
         MVI   DUB+2,X'FF'                                                      
         MVC   DUB+3(1),SVMEDIA    THEN LOCK BY MEDIA                           
         XC    DUB+4(2),DUB+4                                                   
*                                                                               
VK135    CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    VK200                                                            
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
         B     VK200                                                            
*                                                                               
* IF RUNNING BY PGROUP, SEE THAT THIS PGROUP IS NOT LOCKED                      
*                                                                               
VK150    OC    OPTPRGR,OPTPRGR     PROD GROUP                                   
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVC   BYTE,SVTN2PRO+00                                                 
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   DUB+6(2),OPTPRGR    THIS PGROUP LOCKED?                          
         GOTO1 VALILOC,0                                                        
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         MVC   DUB+6(2),OPTPRGR    THIS PGROUP LOCKED?                          
         GOTO1 VALILOC,0                                                        
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'L'            LOCK                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   VK155                                                            
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   VK155                                                            
         MVI   DUB+2,X'FF'                                                      
         MVC   DUB+3(1),SVMEDIA    THEN LOCK BY MEDIA                           
         XC    DUB+4(2),DUB+4                                                   
VK155    MVC   DUB+6(2),OPTPRGR    PGROUP                                       
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    VK200                                                            
*                                                                               
         GOTO1 VALILOC,0                                                        
*                                                                               
VK200    MVC   SVLOCK,DUB          SAVE LOCK INFO FOR UNLOCK                    
         MVC   SVSVPROD,SVCPROD    SAVE PROD LOCK INFO FOR UNLOCK               
*                                                                               
         MVI   TWAWHEN,5           SET AS UPDATIVE SOON FOR FRED                
*                                  ALSO SETS SINGLE THREAD                      
         B     EXIT                                                             
*                                                                               
* VALIDATE OPTIONS (PARTIALLY)                                                  
*                                                                               
VOPTP    NTR1                                                                   
*                                                                               
         XC    SVOPTMED,SVOPTMED   INIT MEDIA FOR NET=ALL REQUEST               
         NI    SVOPTSW,X'FF'-OPTTEST  TEST                                      
*                                                                               
         LA    R2,TRAOPTH                                                       
         CLI   5(R2),0             ANY ENTRY                                    
         BE    NETALLER            NO, MUST ENTER MEDIA                         
*                                                                               
         LA    R4,BLOCK+240        ADDRESS OF FIRST BLOCK                       
         GOTO1 SCANNER,DMCB,TRAOPTH,(7,(R4))                                    
         LLC   R3,DMCB+4           GET NUMBER OF BLOCKS                         
         LTR   R3,R3               SEE IF SCANNER FOUND ANYTHING                
         BZ    MISSERR             NO                                           
*                                                                               
VOPTP10  LLC   R1,0(R4)            GET LENGTH                                   
         BCTR  R1,0                                                             
         EX    R1,TESTCLC                                                       
         BNE   *+12                                                             
         OI    SVOPTSW,OPTTEST     TEST RUN                                     
         B     VOPTP30                                                          
*                                                                               
         EX    R1,BRDCLC                                                        
         BNE   *+16                                                             
         MVI   MYTN2PR6,C'B'                                                    
         OI    SVOPTSW1,OPTPER                                                  
         B     VOPTP30                                                          
*                                                                               
         EX    R1,CALCLC                                                        
         BNE   *+16                                                             
         MVI   MYTN2PR6,C'C'                                                    
         OI    SVOPTSW1,OPTPER                                                  
         B     VOPTP30                                                          
*                                                                               
         EX    R1,WEEKCLC                                                       
         BNE   *+16                                                             
         MVI   MYTN2PR6,C'W'                                                    
         OI    SVOPTSW1,OPTPER                                                  
         B     VOPTP30                                                          
*                                                                               
         EX    R1,ALLCLC                                                        
         BNE   VOPTP30                                                          
         OI    SVOPTSW1,OPTNETS    ALL NETWORK REQUEST                          
         CLI   1(R4),0                                                          
         BE    NETALLER            MUST ENTER MEDIA                             
         MVC   SVOPTMED,22(R4)     SAVE MEDIA                                   
*                                                                               
VOPTP30  LA    R4,32(,R4)          POINT TO NEXT BLOCK                          
         BCT   R3,VOPTP10                                                       
         OC    SVOPTMED,SVOPTMED                                                
         BZ    NETALLER            MUST ENTER MEDIA                             
*                                                                               
VOPTPX   XIT1                                                                   
         SPACE 3                                                                
BRDCLC   CLC   12(0,R4),=C'BROADCAST'                                           
CALCLC   CLC   12(0,R4),=C'CALENDAR'                                            
WEEKCLC  CLC   12(0,R4),=C'WEEKLY'                                              
TESTCLC  CLC   12(0,R4),=C'TEST'                                                
ALLCLC   CLC   12(0,R4),=C'ALL'                                                 
         SPACE 3                                                                
* NO FAX FOUND                                                                  
*                                                                               
FAXERR   LA    R2,TRANETH                                                       
         MVC   GERROR,=Y(NOFAX)                                                 
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,8              L'SUBST TEXT+1                               
         MVC   ELEM+1(7),=C'NETWORK'                                            
         CLI   SVTWPR11,C'Y'       TRAFFIC RECS FOR FAX #                       
         BNE   *+10                                                             
         MVC   ELEM+1(7),=C'TRAFFIC'                                            
*                                                                               
         NI    TRANETH+4,X'FF'-X'20' SET OFF VALIDATED                          
         GOTO1 VTRAERR                                                          
         SPACE 3                                                                
VKERR    MVC   GERROR,=Y(NOUNTPER) NO UNITS                                     
         B     COMERR                                                           
         DROP  R5                                                               
         SPACE 3                                                                
OFFLNERR XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'OFFLINMS),OFFLINMS                                     
         B     ERREXIT                                                          
         SPACE 3                                                                
NETALLER XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'NETMSG),NETMSG                                         
ERREXIT  GOTO1 ERREX2                                                           
*                                                                               
OFFLINMS DC    C'* ERROR * RUN OV, OR RUN SOON OPTION TEST *'                   
NETMSG   DC    C'* ERROR * MISSING MEDIA EG. ALL=CABLE *'                       
         EJECT                                                                  
* ONLINE INSTRUCTIONS - GENERATE 1 LETTER PER PROGRAM FROM TABLE *              
*                                                                               
         USING PRGTABLD,R5                                                      
LRL      BAS   RE,CLRSCR                                                        
         LA    R2,TRASEL1H         1ST DISPLAY LINE                             
*                                                                               
* DISPLAY 1 LINE FOR EACH PROGRAM *                                             
*                                                                               
LRL10    NI    1(R2),X'FF'-X'20'   SET UNP                                      
         OI    6(R2),X'80'         SET XMT                                      
         LLC   R0,0(R2)                                                         
         AR    R2,R0                                                            
         USING LSTLINE,R2                                                       
         MVC   LPROG,PRGPRG                                                     
*                                                                               
         LH    R0,PRGUNITS                                                      
*        EDIT  (R0),(4,LUNITS),ZERO=NOBLANK                                     
         BAS   RE,EDT              GO EDIT FIELD                                
         MVC   LUNITS,ELEM                                                      
*                                                                               
         LH    R0,PRGFEEDS                                                      
*        EDIT  (R0),(4,LFEEDS),ZERO=NOBLANK                                     
         BAS   RE,EDT              GO EDIT FIELD                                
         MVC   LFEEDS,ELEM+1                                                    
*                                                                               
* IF PROGRAM REVISION NUMBER AND DATE ZERO, NET ASSIGN NEVER RUN *              
*                                                                               
         OC    PRGCREVN(4),PRGCREVN                                             
         BNZ   *+14                                                             
         MVC   LCUREVNO(16),=C'NO CMLS ASSIGNED'                                
         B     LRL14                                                            
*                                                                               
         LLC   R0,PRGCREVN                                                      
         BAS   RE,LRLEDITA                                                      
*        EDIT  (R0),(3,LCUREVNO),ZERO=NOBLANK,ALIGN=LEFT                        
         MVC   LCUREVNO,ELEM                                                    
         GOTO1 DATCON,DMCB,(2,PRGCREVD),(8,LCUREVDT)                            
         MVI   LCUREVDT+8,C'-'                                                  
*                                                                               
LRL14    OC    PRGUNAS,PRGUNAS    ANY UNITS WITHOUT COMMERCIALS                 
         BZ    LRL16                                                            
         LH    R0,PRGUNAS                                                       
*        EDIT  (B2,PRGUNAS),(3,LUNASUNT)                                        
         BAS   RE,EDT              GO EDIT FIELD                                
         MVC   LUNASUNT,ELEM                                                    
*                                                                               
LRL16    OC    PRGUNAL,PRGUNAL    ANY UNITS-NO PRODUCT (UNALLOCATED)            
         BZ    LRL20                                                            
         LH    R0,PRGUNAL                                                       
*        EDIT  (B2,PRGUNAL),(3,LUNALUNT)                                        
         BAS   RE,EDT              GO EDIT FIELD                                
         MVC   LUNALUNT,ELEM+1                                                  
*                                                                               
LRL20    TM    PRGFLG,X'07'        POS FOUND                                    
         BZ    LRL30                                                            
         MVC   LPRTID+16(3),=C'ERR'                                             
         TM    PRGFLG,X'04'        POS FOUND                                    
         BZ    *+10                                                             
         MVC   LPRTID(3),=C'POS'                                                
         TM    PRGFLG,X'02'        BILLBOARD FOUND                              
         BZ    *+10                                                             
         MVC   LPRTID+4(2),=C'BB'                                               
         TM    PRGFLG,X'01'        NET ASSIGN LAST RUN                          
         BZ    *+10                                                             
         MVC   LPRTID+7(9),=C'NET ASSGN'                                        
*                                                                               
LRL30    DS    0H                                                               
         LLC   R0,PRGNREVN                                                      
         BAS   RE,LRLEDITA                                                      
         MVC   LNREVNO,ELEM        NET REV #                                    
         OI    6(R2),X'80'                                                      
         LA    R5,PRGNEXT                                                       
         OC    0(4,R5),0(R5)       END OF TABLE                                 
         BZ    LRL50               YES                                          
         LLC   R0,0(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),9             END OF SCREEN                                
         BH    LRL10               YES                                          
LRL40    MVC   GERROR,=Y(MOREMSG)                                               
         B     *+10                                                             
LRL50    MVC   GERROR,=Y(DONEMSG)                                               
         MVI   GMSGTYPE,C'I'                                                    
         S     R5,APRGTBLE         SAVE                                         
         ST    R5,ASVNEXT          SO CSEL WILL END/SAVE 1ST PGM                
         LA    R2,TRASEL1H                                                      
         B     COMXIT                                                           
         DROP  R2,R5                                                            
LRLEDITA EDIT  (R0),(5,ELEM),ZERO=NOBLANK,ALIGN=LEFT                            
         BR    RE                                                               
*                                                                               
* COMMON EDIT RTN *                                                             
*                                                                               
         DS   0H                                                                
EDT      NTR1                                                                   
         EDIT  (R0),(4,ELEM),ZERO=NOBLANK                                       
         B     EXIT                                                             
         EJECT                                                                  
* GENERATE OFFLINE INSTRUCTIONS HERE                                            
*                                                                               
LRR      L     R5,APRGTBLE         START OF UNIT TABLE                          
         MVI   FRSTPGSW,C'Y'       SET 1ST PAGE SW                              
         USING PRGTABLD,R5                                                      
*                                                                               
*AR                                                                             
         MVI   SVFAXARC,0          CLEAR FAX ARCHIVE BYTE                       
         MVI   SVQLTYP1,0                                                       
         XC    ELEM,ELEM                                                        
         XC    PROFKEY,PROFKEY                                                  
         MVI   PROFKEY,C'S'                                                     
         MVC   PROFKEY+1(2),=C'TB'                                              
         MVC   PROFKEY+3(2),TWAORIG                                             
         GOTO1 APQPROF,DMCB,(X'80',PROFKEY),(0,ELEM),ACOMFACS                   
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R4,ELEM                                                          
         USING REMOTED,R4                                                       
         MVC   SVQLTYP1,REMOTTY1                                                
                                                                                
         CLI   REMOTSUB,C'#'                                                    
         BNE   LRR01                                                            
         CLI   REMOTSUB+1,C'N'                                                  
         BE    LRR02                                                            
         CLI   REMOTSUB+1,C'A'                                                  
         BNE   LRR01                                                            
         OI    SVFAXARC,REMOTARQ                                                
         B     LRR02                                                            
LRR01    OI    SVFAXARC,REMOTAEQ                                                
LRR02    DS    0H                                                               
         DROP  R4                                                               
*AR                                                                             
         MVI   SVNETREV,0          INIT NET REV #                               
*                                                                               
LRR10    OC    PRGCREVN(4),PRGCREVN ANY ASSIGNMENTS DONE                        
         BZ    ERPTNOAS              NO, CAN'T PRINT INSTRUCTIONS               
*                                                                               
         TM    PRGFLG,X'07'        BB/POS/NET ASSIGN ERRS                       
         BNZ   ERPTERRS                                                         
*                                                                               
         TM    ANYFLAG,TRIFOUND    TRI-BACK FOUND FLAG                          
         BO    ERPTRIBK             YES ERROR                                   
*                                                                               
         CLC   PRGUNITS,PRGUNAL    IF ALL UNALLOCATED, BYPASS                   
         BE    ERPTUNAL                                                         
         LH    R1,PRGUNITS                                                      
         AH    R1,PRGFEEDS                                                      
         CH    R1,PRGUNAS          IF ALL UNASSIGNED, BYPASS                    
         BE    LRR20               **PER RAMUNE 10/09                           
         LH    RE,PRGUNAS                                                       
         AH    RE,PRGUNAL                                                       
         CR    R1,RE               IF ALL UNASSIGN/UNALLOCATED, BYPASS          
         BE    ERPTNONE                                                         
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROG?                           
         BZ    LRR12                                                            
         TM    SVOPTSW1,OPTNTS     NON-TRAFFIC SUPPLIER FILTER?                 
         BO    LRR12                                                            
         TM    SVOPTSW1,OPTTS      TRAFFIC SUPPLIER FILTER?                     
         BZ    LRR20                NO, BYPASS                                  
*                                                                               
LRR12    TM    SVOPTSW,OPTUNAL     PRD=UNAL - UNALLOCATED PRODUCT               
         BO    LRR14                                                            
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    LRR14                                                            
         OC    PRGUNAL,PRGUNAL     ANY UNITS UNALLOCATED PRODUCT                
         BNZ   LRR20                BYPASS                                      
*        BNZ   ERPTUNL1             BYPASS                                      
*                                                                               
LRR14    TM    SVOPTSW,OPTUNAS       UNASSIGNED UNITS OK                        
         BO    LRR16                                                            
         OC    PRGUNAS,PRGUNAS     ANY UNITS WITHOUT CML ASSIGNED               
         BNZ   LRR20                BYPASS                                      
*        BNZ   ERPTUNA1             BYPASS                                      
*                                                                               
* PRINT INSTRUCTIONS FOR THIS PROGRAM *                                         
*                                                                               
LRR16    OI    PRGFLG,X'10'        PRINT INSTR                                  
         OI    UPDSW,X'01'         SET ON PROG OK FOR INSTR                     
*                                                                               
         CLC   SVNETREV,PRGNREVN                                                
         BNL   *+10                                                             
         MVC   SVNETREV,PRGNREVN   SAVE HIGHEST NETWORK REV #                   
*                                                                               
LRR20    LA    R5,PRGNEXT          LOOK FOR NEXT PRG                            
         OC    0(4,R5),0(R5)       END                                          
         BNZ   LRR10                                                            
         L     R5,APRGTBLE         START OF UNIT TABLE                          
         TM    UPDSW,X'01'         ANY PROG SELECTED FOR INSTR                  
         BZ    LRR30                                                            
*                                                                               
         TM    ANYFLAG,TRIFOUND    TRI-BACKS FOUND PRINT ERROR REPORT           
         BO    LRR30                                                            
*                                                                               
* PRINT INSTRUCTIONS FOR ALL PROGRAMS *                                         
*                                                                               
         BRAS  RE,PRT                PRINT INSTR                                
*                                                                               
* PRINT OPTIONAL FAX AND ANY ERROR REPORT FOR ERRORS *                          
*                                                                               
LRR30    BRAS  RE,PER               PRINT ERROR REPORT                          
*                                                                               
         ICM   R0,15,TSARBUFL                                                   
         BZ    LRR40                                                            
*                                                                               
         L     R1,TSARBUFF                                                      
         FREEMAIN RC,LV=(0),A=(1)                                               
         LTR   RF,RF                                                            
         BZ    LRR40                                                            
         DC    H'0'                                                             
*                                                                               
LRR40    CLI   SVNET,0             NETWORK = ALL ?                              
         BE    EXIT                 NO, ONLY ONE NETWORK                        
         BAS   RE,VK22                                                          
         CLC   SVNET,=X'FFFFFFFF'                                               
         BE    EXIT                                                             
         B     LRR                                                              
         EJECT                                                                  
* GET TRAFFIC FAX FROM DAYPART RECORD (IF ANY)                                  
*                                                                               
GTRAFAX  NTR1                                                                   
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         MVI   KEY,X'26'           RECORD ID                                    
         MVC   KEY+1(1),BAGYMD     AGY/MED                                      
         MVC   KEY+2(4),NETWORK                                                 
         MVC   KEY+13(2),BCLT      CLIENT                                       
*                                                                               
         MVC   KEYSAVE,KEY                                                      
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK/CLT                           
         BE    GTRA10                                                           
*                                                                               
* OR USE NETWORK SPECIFIC FAX NUMBER FROM DAYPART RECORD (IF ANY)               
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    KEY+13(2),KEY+13    CLEAR CLIENT                                 
*                                                                               
         MVC   KEYSAVE,KEY                                                      
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BNE   GTRAX                                                            
*                                                                               
GTRA10   L     R6,AIO3                                                          
         GOTO1 (RF),(R1),=C'GETREC',=C'UNTFIL',KEY+21,(R6),DMWORK               
         CLC   KEY(7),0(R6)                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         NI    UPDSW,X'FF'-MULTIFAX CLEAR MULTI-FAX SWITCH                      
*                                                                               
         LA    R6,27(R6)           DISP TO THE ELEM                             
         MVI   ELCODE,X'30'        FAX NUMBER                                   
         BRAS  RE,FIRSTEL                                                       
         BNE   GTRAX                                                            
*                                                                               
         XC    SVSFAX(48),SVSFAX                                                
*                                                                               
         LA    R1,SVSFAX           SAVE FAX IN TABLE                            
*                                                                               
GTRA20   MVC   0(3,R1),2(R6)       AREA CODE                                    
         MVC   3(3,R1),6(R6)       EXCHANGE                                     
         MVC   6(4,R1),10(R6)      NUMBER                                       
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   GTRAX                                                            
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   *+16                                                             
         TM    UPDSW,MULTIFAX                                                   
         BO    *+8                                                              
         OI    UPDSW,MULTIFAX      TURN ON MULTI-FAX SWITCH                     
*                                                                               
         LA    R1,L'SVSFAX(R1)                                                  
         B     GTRA20                                                           
*                                                                               
GTRAX    XIT1                                                                   
         EJECT                                                                  
**********************************************************                      
* PRINT INSTRUCTIONS FOR THIS NETWORK, USER HAS SELECTED *                      
* INSTRUCTIONS, NOW GO WITH FIRST TABLE ENTRY            *                      
* THEN BUILD UNIT TABLE AND PRINT INSTRUCTIONS           *                      
**********************************************************                      
*                                                                               
         DS   0H                                                                
         USING PRGTABLD,R5                                                      
GEN      NTR1                                                                   
         LLC   R6,0(R2)                                                         
         AR    R6,R2                                                            
         USING LSTLINE,R6                                                       
GEN10    CLC   PRGPRG,LPROG                                                     
         BE    GEN14                                                            
         LA    R5,PRGNEXT                                                       
         CLI   0(R5),0             AT END OF TABLE                              
         BNE   GEN10                                                            
         DC    H'0'                                                             
GEN14    CLC   PRGUNITS,PRGUNAL    IF ALL UNALLOCATED, BYPASS                   
         BNE   *+14                                                             
         MVC   GERROR,=Y(UNALERR)                                               
         B     COMERR                                                           
*                                                                               
         LH    R1,PRGUNITS                                                      
         AH    R1,PRGFEEDS                                                      
         CH    R1,PRGUNAS          IF ALL UNASSIGNED, BYPASS                    
         BNE   *+14                                                             
         MVC   GERROR,=Y(UNASERR)                                               
         B     COMERR                                                           
*                                                                               
         LH    RE,PRGUNAS                                                       
         AH    RE,PRGUNAL                                                       
         CR    R1,RE               IF ALL UNASSIGN/UNALLOCATED, BYPASS          
         BNE   GEN16                                                            
         MVC   GERROR,=Y(UNALASER)                                              
         B     COMERR                                                           
*                                                                               
GEN16    TM    SVOPTSW,OPTUNAL     PRD=UNAL - UNALLOCATED PRODUCT               
         BO    GEN20                                                            
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    GEN20                                                            
         OC    PRGUNAL,PRGUNAL     ANY UNITS UNALLOCATED PRODUCT                
         BZ    GEN20                NO, PRINT INSTRUCTIONS                      
         MVC   GERROR,=Y(UNALPRD)   NO                                          
         B     COMERR                                                           
*                                                                               
GEN20    TM    SVOPTSW,OPTUNAS       UNASSIGNED UNITS OK                        
         BO    GEN24                                                            
         OC    PRGUNAS,PRGUNAS     ANY UNITS WITHOUT CML ASSIGNED               
         BNZ   NOCMLER              YES, CAN'T PRINT INSTRUCTIONS               
GEN24    OC    PRGCREVN(4),PRGCREVN ANY ASSIGNMENTS DONE                        
         BZ    NOCMLER              YES, CAN'T PRINT INSTRUCTIONS               
*                                                                               
         OI    PRGFLG,X'10'        SET ON RUN INSTR                             
         OI    UPDSW,X'01'         SET ON AT LEAST 1 PROG SEL FOR INSTR         
         TM    SVOPTSW1,OPT1EACH   RUN EACH ON SEP LETTER                       
         BZ    GEN30                                                            
*                                                                               
* PRINT INSTRUCTIONS FOR ALL PROGRAMS *                                         
*                                                                               
         BRAS  RE,PRT                                                           
*                                                                               
         BAS   RE,SVTWA           SAVE UPDATED INFO                             
         EJECT                                                                  
* DISPLAY SPOOL ID FOR USER *                                                   
*                                                                               
         OI    6(R6),X'80'         SET XMT                                      
         XC    LPRTID,LPRTID                                                    
         MVC   LPRTID(3),=C'ID='                                                
         MVC   LPRTID+3(3),REMUSER                                              
         MVI   LPRTID+6,C','                                                    
         SR    R0,R0                                                            
         ICM   R0,3,SPOOLRPN                                                    
         BAS   RE,LRLEDITA                                                      
         MVC   LPRTID+7(5),ELEM                                                 
*        EDIT  (R0),(5,LPRTID+7),ALIGN=LEFT                                     
         CLI   INSPRTSW,C'N'       DID WE GENERATE INSTRUCTIONS                 
         BNE   GEN30                                                            
         MVC   LPRTID(17),=CL17'NO DATA GENERATED'                              
         B     GEN40                                                            
*                                                                               
GEN30    CLI   SVTWPR06,C'2'       THIS A FAX RUN & AGENCY COPY REQUEST         
         BNE   GEN40                                                            
*                                                                               
         CLI   REQSW,C'Y'          ALREADY DONE REQUEST                         
         BE    GEN40                                                            
*                                                                               
         MVI   REQSW,C'Y'          SET DONE REQUEST                             
         BRAS  RE,REQ              GO GEN REQ FOR OFFLINE AGENCY COPY           
*                                                                               
* MODIFY SELECT FIELD *                                                         
*                                                                               
GEN40    XC    8(3,R2),8(R2)       BLANK IT                                     
         MVI   8(R2),C'*'          MARK DONE                                    
         OI    6(R2),X'80'+X'20'   TRANSMIT AND CHANGE TO PROTECTED             
         B     EXIT                                                             
         DROP  R6                                                               
         EJECT                                                                  
* WRITE ERROR REPORT FILE TO BE PRINTED LATER *                                 
*                                                                               
ERPTNOAS LA    R1,XTYPE1           NET SEED/ASSGN NEVER RUN                     
         B     ERPT10                                                           
ERPTUNAL LA    R1,XTYPE2           ALL UNITS UNALLOCATED                        
         B     ERPT10                                                           
ERPTNONE LA    R1,XTYPE4           ALL UNITS UNASSIGNED OR UNALLOCATED          
         B     ERPT10                                                           
ERPTUNL1 LA    R1,XTYPE5           SOME UNITS UNALLOCATED                       
         B     ERPT10                                                           
ERPTSUPP LA    R1,XTYPEB           TRAFFIC SUPPLIER ERROR                       
         B     ERPT10                                                           
ERPTRIBK LA    R1,XTYPEC           TRI-BACK ERROR                               
         B     ERPT10                                                           
ERPTUNA1 LA    R1,XTYPE6           SOME UNITS UNASSIGNED                        
         B     ERPT10                                                           
ERPTERRS LA    R1,XTYPE7                                                        
         TM    PRGFLG,X'04'        POSITIONS ASSIGNED THIS PROGRAM              
         BO    ERPT10                                                           
         LA    R1,XTYPE8                                                        
         TM    PRGFLG,X'02'        BILLBOARDS THIS PROGRAM                      
         BO    ERPT10                                                           
         LA    R1,XTYPE9                                                        
         TM    PRGFLG,X'01'        NET ASSIGN RUN FOR THIS PROGRAM              
         BO    ERPT10                                                           
         DC    H'0'                                                             
*                                                                               
ERPT10   DS    0H                                                               
*RPT10   TM    WHEN,X'20'          IS THIS SOON                                 
*        BZ    *+12                                                             
*        CLI   SVTWPR06,C'N'       UNLESS NO FAX, CAN'T PRINT REPORT            
*        BNE   LRR20                                                            
*                                                                               
         BAS   RE,XPUTT            GO PUT TO ERROR REPORT                       
         B     LRR20                                                            
         EJECT                                                                  
* INITIALIZE TSAROFF                                                            
*                                                                               
INITSROF NTR1                                                                   
         XC    PRTCT,PRTCT                                                      
         XC    TSAROFF,TSAROFF                                                  
         XC    TSARBYTE,TSARBYTE                                                
*                                                                               
         L     R0,=A(L'ELEM*5000)                                               
         ST    R0,TSARBUFL                                                      
         GETMAIN RC,LV=(0),LOC=(ANY,ANY)                                        
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,TSARBUFF                                                      
*                                                                               
         LHI   RE,TSARBLK-SYSD                                                  
         AR    RE,R9                                                            
         LR    R2,RE                                                            
         LA    RF,TSARDL2                                                       
         XCEF                                                                   
         USING TSARD,R2                                                         
*                                                                               
         MVC   TSACOM,ACOMFACS                                                  
         MVI   TSKEYL,2                                                         
         MVI   TSRECL+1,138                                                     
         OI    TSRECI,TSRVAR                                                    
         MVC   TSABUF,TSARBUFF                                                  
         MVC   TSAREC,TSARBUFL                                                  
*                                                                               
* TSAR CALLOV HERE                                                              
*                                                                               
         GOTO1 CALLOV,DMCB,0,(C'R',X'00000A7D')                                 
         ICM   RF,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    RF,TSAROFF                                                       
*                                                                               
         MVI   TSOFFACT,TSAINI      SET 1ST TSAROFF FOR INIT                    
         GOTO1 TSAROFF,(R2)                                                     
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         XIT1                                                                   
         EJECT                                                                  
* COMMON ERROR REPORT FORMAT AND PUT                                            
*                                                                               
         DS   0H                                                                
         USING PRGTABLD,R5                                                      
XPUTT    NTR1                                                                   
         XC    ELEM,ELEM                                                        
         LA    R2,ELEM                                                          
         USING XRECD,R2                                                         
         MVC   XBAGYMD,BAGYMD                                                   
         MVC   XCLT,QCLT                                                        
         MVC   XNET,NETWORK                                                     
         MVC   XNETMKT,NETMKT                                                   
         MVC   XPROG,PRGPRG                                                     
         MVC   XTUNT,PRGUNITS                                                   
         MVC   XFEEDS,PRGFEEDS                                                  
         MVC   XUNAS,PRGUNAS                                                    
         MVC   XUNAL,PRGUNAL                                                    
         MVC   XPERST,STDATE                                                    
         MVC   XPERND,ENDATE                                                    
         MVC   XPERST,PSTDATE                                                   
         MVC   XPERND,PENDATE                                                   
         STC   R1,XTYPE                                                         
*                                                                               
         L     R1,AERRFILE                                                      
         LA    R0,ELEM                                                          
         PUT   (1),(0)                                                          
         B     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
* RTN TO WRITE TWA2 WITH EXTENDED LIST BEFORE EXIT *                            
*                                                                               
SVTWA    LA    RF,=C'DMWRT'                                                     
         B     CTWA                                                             
*                                                                               
* RESTORE PRGTABLE AND UNIT TABLE *                                             
*                                                                               
RDTWA    LA    RF,=C'DMREAD'                                                    
*                                                                               
         DS   0H                                                                
CTWA     NTR1                                                                   
         XC    DMCB(24),DMCB                                                    
         ST    RF,DMCB                                                          
         MVC   DMCB+10(2),2(RA)    MOVE TERMINAL NUMBER                         
         MVI   DMCB+8,2            SET PAGE 2                                   
         GOTO1 DATAMGR,DMCB,,=C'TEMPSTR',,ASVSTOR                               
         CLI   8(R1),0                                                          
         BE    EXIT                                                             
         DC    H'0'                                                             
*                                                                               
* CLEAR DISPLAY AREA OF SCREEN *                                                
*                                                                               
CLRSCR   LA    RF,TRASEL1H                                                      
*                                                                               
CLRSCR10 OC    8(L'TRASEL1,RF),8(RF)                                            
         BZ    CLRSCR20                                                         
         CLC   8(L'TRASEL1,RF),SPACES                                           
         BE    CLRSCR20                                                         
         XC    8(L'TRASEL1,RF),8(RF)                                            
         OI    6(RF),X'80'                                                      
         OI    1(RF),X'20'         SET PROTECT BIT                              
CLRSCR20 LLC   R0,0(RF)                                                         
         AR    RF,R0                                                            
*                                                                               
         OC    8(L'TRADSP1,RF),8(RF)                                            
         BZ    CLRSCR30                                                         
         CLC   8(L'TRADSP1,RF),SPACES                                           
         BE    CLRSCR30                                                         
         XC    8(L'TRADSP1,RF),8(RF)                                            
         OI    6(RF),X'80'                                                      
*                                                                               
CLRSCR30 IC    R0,0(RF)                                                         
         AR    RF,R0                                                            
         CLI   0(RF),9                                                          
         BH    CLRSCR10                                                         
         BR    RE                                                               
         EJECT                                                                  
*        ERROR ROUTINES                                                         
*                                                                               
NOCMLER  MVC   GERROR,=Y(UNTNOCML)                                              
         B     COMERR                                                           
DONENOSL MVC   GERROR,=Y(NORECSEL)                                              
         B     DONEALLA                                                         
DONEALL  MVC   GERROR,=Y(ENDMSG2)                                               
DONEALLA MVI   GMSGTYPE,C'I'                                                    
         LA    R2,TRACLTH                                                       
         NI    TRACLTH+4,X'FF'-X'20' SET OFF VALIDATED                          
         B     COMERR                                                           
COMXIT   BAS   RE,SVTWA                                                         
COMERR   OC    AERRFILE,AERRFILE         STORED DCB ADDRESS                     
         BZ    COMERR10                                                         
         L     R3,AERRFILE         STORED DCB ADDRESS                           
         CLOSE ((R3),)                                                          
         FREEPOOL (R3)                                                          
*                                                                               
         XC    AERRFILE,AERRFILE   SET FILE NOT OPEN                            
*                                                                               
COMERR10 DS    0H                                                               
         TM    WHEN,X'20'          IS THIS SOON                                 
         BZ    TRAPERR2                                                         
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   TRAPERR2                                                         
*                                                                               
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    TRAPERR2                                                         
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    TRAPERR2                                                         
*                                                                               
* BUILD UNLOCK KEY FOR SOON UPDATES                                             
*                                                                               
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   UN20                NOT AN ALL PRODUCT RUN                       
*                                                                               
         XC    SVLOCK,SVLOCK                                                    
         MVI   SVLOCK,C'U'         UNLOCK                                       
         MVI   SVLOCK+1,X'FF'      NET (TRAFFIC)                                
         MVC   SVLOCK+2(4),TRANET  NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   UN10                                                             
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   UN10                                                             
         MVI   SVLOCK+2,X'FF'                                                   
         MVC   SVLOCK+3(1),SVMEDIA THEN UNLOCK BY MEDIA                         
         XC    SVLOCK+4(2),SVLOCK+4                                             
UN10     MVI   SVLOCK+6,X'FF'      ALL PRODS                                    
         B     UN100                                                            
*                                                                               
* IF RUNNING BY PRODUCT, SEE THAT THIS PRD IS NOT LOCKED                        
*                                                                               
UN20     CLI   SVTN2PRO+00,C'*'                                                 
         BNE   UN40                                                             
         XC    SVLOCK,SVLOCK                                                    
         MVI   SVLOCK,C'U'         UNLOCK                                       
         MVI   SVLOCK+1,X'FF'      NET (TRAFFIC)                                
         MVC   SVLOCK+2(4),TRANET  NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   UN30                                                             
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   UN30                                                             
         MVI   SVLOCK+2,X'FF'                                                   
         MVC   SVLOCK+3(1),SVMEDIA THEN UNLOCK BY MEDIA                         
         XC    SVLOCK+4(2),SVLOCK+4                                             
*N30     MVC   SVLOCK+6(1),OPTPRD  THIS PRD LOCKED?                             
UN30     MVC   SVSVPROD,OPTPROD    SAVE THIS PROD TO UNLOCK                     
*                                                                               
         B     UN100                                                            
*                                                                               
UN40     OC    OPTPRGR,OPTPRGR     PROD GROUP                                   
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         XC    SVLOCK,SVLOCK                                                    
         MVI   SVLOCK,C'U'         UNLOCK                                       
         MVI   SVLOCK+1,X'FF'      NET (TRAFFIC)                                
         MVC   SVLOCK+2(4),TRANET  NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   UN60                                                             
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   UN60                                                             
         MVI   SVLOCK+2,X'FF'                                                   
         MVC   SVLOCK+3(1),SVMEDIA THEN UNLOCK BY MEDIA                         
         XC    SVLOCK+4(2),SVLOCK+4                                             
UN60     MVC   SVLOCK+6(2),OPTPRGR PGROUP                                       
*                                                                               
UN100    BRAS  RE,UNLOCK                                                        
*                                                                               
TRAPERR2 GOTO1 VTRAERR                                                          
*                                                                               
MISSELER TM    UPDSW,X'10'         ANY UPDATES DONE                             
         BZ    MISSERR             NO                                           
         BAS   RE,SVTWA            SAVE UPDATED UNIT TABLE                      
MISSERR  MVI   ERROR,MISSING                                                    
         B     TRAPERR                                                          
*                                                                               
NOWERR   MVI   ERROR,INVPRINT                                                   
         LA    R2,CONWHENH                                                      
         B     TRAPERR                                                          
*                                                                               
NOTDDSER MVI   ERROR,POPTNTOK      CAN'T DO NOW UNLESS DDS                      
         LA    R2,CONWHENH                                                      
         B     TRAPERR                                                          
NUMERR   MVI   ERROR,NOTNUM                                                     
TRAPERR  GOTO1 ERREX                                                            
*                                                                               
         DROP  RB,R7                                                            
         LTORG                                                                  
         EJECT                                                                  
**********************************************************                      
* INITIALIZE ADDITIONAL COMMERCIAL INFORMATION TABLE     *                      
**********************************************************                      
*                                                                               
         DS   0H                                                                
IACML    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RE,ACMLTAB         CLEAR ADDRESS OF BINTABLE                     
         L     RF,=F'900'         MAXIMUM RECORDS IN BINTBL                     
         XCEFL                                                                  
*                                                                               
         SR    R0,R0               ADDRESS OF REC TO BE ADDED                   
         L     R1,ACMLTAB          ADDRESS OF BINTABLE                          
         SR    R2,R2               NUMBER OF RECS IN TABLE                      
         LA    R3,CMLNXT           LENGTH OF BIN RECORD                         
         LA    R4,L'CMLCML         LENGTH OF BIN KEY                            
         L     R5,=F'900'         MAXIMUM RECORDS IN BINTBL                     
         STM   R0,R5,BINDMCB                                                    
         XIT1                                                                   
*                                                                               
*                                                                               
**********************************************************                      
* READ THROUGH UNITS AND BUILD PROGRAM TABLE FOR SELECTS *                      
**********************************************************                      
*                                                                               
         DS   0H                                                                
BLPRG    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RE,AIO2             CLEAR FOR EST HDRS, EST TABLE                
         LA    RF,2000                                                          
         XCEF                                                                   
         NI    UPDSW,X'FF'-X'40'   SET OFF END OF UNITS SW                      
         L     R5,APRGTBLE                                                      
         USING PRGTABLD,R5                                                      
         XC    0(256,R5),0(R5)                                                  
         SR    R1,R1                                                            
         ST    R1,ASVNEXT                                                       
*                                                                               
         MVC   BASEPRG,PROGRAM                                                  
         MVC   BASEDTS,STDATEP                                                  
         MVI   BASECT,0                                                         
*                                                                               
         XC    SVTS(6),SVTS                                                     
         MVI   SVFLAG,0                                                         
*                                                                               
         BRAS  RE,NETI              INITIALIZE NETIO                            
*                                                                               
         MVC   NBSELPRG,PROGRAM                                                 
         OC    PROGRAM,PROGRAM     WAS PROGRAM 'ALL'                            
         BNZ   BLPRG02             NO                                           
         MVI   NBSEQ,C'Q'          GET UNITS IN PROGRAM SEQ                     
*                                                                               
BLPRG02  GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   NBMODE,NBREQLST                                                  
         BNE   BLPRG06                                                          
         OC    PROGRAM,PROGRAM                                                  
         BZ    BLPRG90                                                          
         MVC   NBACTPRG,PROGRAM                                                 
         B     BLPRG90                                                          
*                                                                               
BLPRG06  CLI   NBMODE,NBPROCUN                                                  
         BNE   BLPRG02                                                          
*                                                                               
*                                                                               
* GET REVISION INFO *                                                           
*                                                                               
*=>SM    GOTO1 =A(FREV),RR=SPTR63RR                                             
*                                                                               
         CLI   NBMODE,NBREQLST     IF NO UNITS, GET OUT                         
         BE    BLPRG62                                                          
         EJECT                                                                  
BLPRG10  L     R6,NBAIO                                                         
*                                                                               
         BAS   RE,FPRGC            FIND BASE IF EQUIV PROGRAM                   
         BNE   BLPRG60             EQUIV BUT NO BASE                            
*                                                                               
         CLI   SVTNPR9,C'B'        BOTH MEDIA AND SKED                          
         BE    BLPRG16                                                          
         CLI   SVTNPR9,C'S'        MEDIA ONLY (DEFAULT)                         
         BNE   BLPRG14                                                          
         CLI   NBACTSUB,C'A'       SKED ONLY                                    
         BL    BLPRG60                                                          
         B     BLPRG16                                                          
*                                                                               
BLPRG14  CLI   NBACTSUB,C'A'                                                    
         BNL   BLPRG60                                                          
*                                                                               
BLPRG16  TM    NBUNITST,X'42'     PREEMPTED OR MISSED                           
         BNZ   BLPRG60             TREAT AS DELETED                             
         TM    22(R6),X'80'       DELETED UNIT                                  
         BO    BLPRG60                                                          
*                                                                               
         CLI   NBACTSUB,C'A'       THIS A SKED UNIT                             
         BNL   BLPRG18              YES, NO CKEST                               
*                                                                               
         BRAS  RE,CKEST                                                         
         BE    BLPRG60                                                          
*                                                                               
BLPRG18  CLI   NBPR1CL3,0          UNALLOCATED                                  
         BNE   BLPRG20                                                          
         CLI   SVCSPRD,0                                                        
         BNE   BLPRG20                                                          
         LH    R1,PRGUNAL                                                       
         LA    R1,1(,R1)                                                        
         STH   R1,PRGUNAL                                                       
         B     BLPRG23                                                          
*                                                                               
* CK PRODUCT OR PRODUCT GROUP FILTER *                                          
*                                                                               
BLPRG20  CLC   OPTPROD,SPACES                                                   
         BNH   BLPRG22G                                                         
         CLC   NBPR1CL3,OPTPROD                                                 
         BE    BLPRG22G                                                         
*                                                                               
         LHI   RE,SVCSPRDQ                                                      
         LA    RF,SVCSPRD                                                       
BLPRG22E CLI   0(RF),0                                                          
         BE    BLPRG60                                                          
         CLC   OPTPROD,0(RF)                                                    
         BE    BLPRG22G                                                         
         LA    RF,L'SVCSPRD(RF)                                                 
         BCT   RE,BLPRG22E                                                      
         B     BLPRG60                                                          
*                                                                               
BLPRG22G OC    OPTPRGR,OPTPRGR    ANY PRODUCT GROUP                             
         BZ    BLPRG23              NO                                          
         BAS   RE,FPG              FILTER ON PRODUCT GROUP                      
         BNE   BLPRG60                                                          
*                                                                               
BLPRG23  DS    0H                                                               
*** BRAND LEVEL SECURITY NOT USED                                               
*&&DO                                                                           
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLPRG24                                                          
*                                                                               
         LA    R0,NCLSTSIZ         FIND PROD                                    
         L     R1,ASVNCLST                                                      
*                                                                               
         LA    RF,NBPRD                                                         
         CLI   NBPRD,0             ANY PROD                                     
         BNE   BLPRG23H                                                         
*                                                                               
         LA    RF,SVCSPRD                                                       
         CLI   SVCSPRD,0                                                        
         BE    BLPRG24             UNALLOCATED                                  
*                                                                               
BLPRG23H CLC   0(1,RF),3(R1)                                                    
         BE    BLPRG24                                                          
         LA    R1,4(R1)                                                         
         CLI   0(R1),C' '                                                       
         BNH   *+8                                                              
         BCT   R0,BLPRG23H                                                      
         B     BLPRG60             GET NEXT UNIT                                
*&&                                                                             
*                                                                               
* LOOK FOR TRAFFIC SUPPLIER                                                     
*                                                                               
BLPRG24  L     R6,NBAIO                                                         
         LA    R6,27(R6)                                                        
         MVI   ELCODE,X'60'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   BLPRG24A                                                         
*                                                                               
         USING NUOTH,R6                                                         
         CLI   NUOTTYP,C'H'        TRAFFIC SUPPLIER                             
         BE    BLPRG24B                                                         
         BRAS  RE,NEXTEL                                                        
         BE    *-12                                                             
*                                                                               
BLPRG24A TM    SVFLAG,SVFLGTS      WAS TSUPP FOUND IN PREV UNITS?               
         BZ    *+12                 NO                                          
         OI    SVFLAG,SVTSERR      TRAFFIC SUPPLIER ERROR                       
         OI    PRGFLG,PRGXCLUD     EXCLUDE THIS PROGRAM                         
         OI    SVFLAG,SVFLGNTS     NON-TSUPP FOUND                              
         TM    SVOPTSW1,OPTTS      FILTER ON TSUPP?                             
         BO    BLPRG25             YES, GET NEXT PROG                           
         B     BLPRG28                                                          
*                                                                               
BLPRG24B DS    0H                                                               
         LLC   R1,NUOTLEN                                                       
         AHI   R1,-3               TSUPP LENGTH                                 
*                                                                               
         TM    SVOPTSW1,OPTTS      OPTION TSUPP ENTERED ?                       
         BO    *+20                 YES                                         
         TM    SVOPTSW1,OPTNTS     NON-TSUPP ENTERED ?                          
         BO    BLPRG24C             YES                                         
         OI    SVOPTSW1,OPTTS      OPTION TSUPP                                 
         B     BLPRG24C                                                         
*                                                                               
         OC    SVOPTTS,SVOPTTS     SPECIFIC TSUPP?                              
         BZ    BLPRG24C             NO                                          
*                                                                               
         CLM   R1,1,SVOTSLEN       SAME TRAFFIC SUPPLIER ENTRY LENGTH?          
         BNE   BLPRG25              NO,SKIP                                     
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   3(0,R6),SVOPTTS     SAME TSUPP?                                  
         BNE   BLPRG25              NO SKIP                                     
         LA    R1,1(R1)            ADJ LENGTH                                   
*                                                                               
BLPRG24C TM    SVFLAG,SVFLGNTS     WAS PREV UNIT A NON-TSUPP                    
         BZ    *+12                                                             
         OI    SVFLAG,SVTSERR      YES, TRAFFIC SUPPLIER ERROR                  
         OI    PRGFLG,PRGXCLUD     EXCLUDE THIS PROGRAM                         
         TM    SVOPTSW1,OPTNTS     ARE WE DOING NON-TRAFFIC SUPPLIERS           
         BO    BLPRG25              YES, GET NEXT PROG                          
*                                                                               
         OI    SVFLAG,SVFLGTS      TSUPP FOUND                                  
*                                                                               
         OC    SVTS,SVTS                                                        
         BZ    BLPRG24D                                                         
*                                                                               
         CLM   R1,1,SVTSLEN        SAME TRAFFIC SUPPLIER ENTRY LENGTH?          
         BE    *+12                 YES                                         
         OI    SVFLAG,SVTSERR      TRAFFIC SUPPLIER ERROR                       
         B     BLPRG25              GET NEXT PROG                               
*                                                                               
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   3(0,R6),SVTS        SAME TSUPP?                                  
         BE    BLPRG28                                                          
         OI    SVFLAG,SVTSERR      TRAFFIC SUPPLIER ERROR                       
         B     BLPRG25             NO, GET NEXT PROG                            
*                                                                               
BLPRG24D STC   R1,SVTSLEN          SAVE LENGTH                                  
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SVTS(0),NUOTHER                                                  
         OC    SVTS(L'SVTS),SPACES                                              
*                                                                               
         OC    SVOPTTS,SVOPTTS     SPECIFIC TSUPP OPTION ENTERED?               
         BNZ   BLPRG24E             YES                                         
         XC    WORK(6),WORK                                                     
         MVC   WORK(6),NBACTPRG  PROGRAM                                        
         BRAS  RE,GETTSUPP                                                      
         BNE   NOTSERR                                                          
         MVC   KEYSAVE,NBKEY                                                    
         GOTO1 DATAMGR,DMCB,(X'08',=C'DMRDHI'),=C'UNTDIR',KEYSAVE,KEY           
         CLC   KEY(20),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         B     BLPRG28              NO                                          
*                                                                               
BLPRG24E CLC   SVOPTTS(6),SVTS     IS THIS IT?                                  
         BNE   BLPRG24F             NO                                          
         XC    WORK(6),WORK                                                     
         MVC   WORK(6),NBACTPRG  PROGRAM                                        
         BRAS  RE,GETTSUPP              GET TRAFFIC SUPPLIER RECORD             
         BNE   NOTSERR                                                          
         MVC   KEYSAVE,NBKEY                                                    
         GOTO1 DATAMGR,DMCB,(X'08',=C'DMRDHI'),=C'UNTDIR',KEYSAVE,KEY           
         CLC   KEY(20),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         B     BLPRG28                                                          
*                                                                               
BLPRG24F XC    SVTS(6),SVTS                                                     
*                                                                               
BLPRG25  TM    SVFLAG,SVTSERR      IF ERROR                                     
         BO    BLPRG150             THEN DONE                                   
         OI    PRGFLG,PRGXCLUD     EXCLUDE THIS PROGRAM                         
         B     BLPRG60                                                          
*                                                                               
BLPRG28  L     R6,NBAIO                                                         
         LA    R6,27(R6)                                                        
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   BLPRG36                                                          
         EJECT                                                                  
         USING NUCMLEL,R6                                                       
         CLI   SVTNPR5,C'Y'       TRAFFIC DELETES ALLOWED                       
         BNE   BLPRG30            NO                                            
         TM    NUCMLFLG,X'08'                                                   
         BO    BLPRG60                                                          
*                                                                               
BLPRG30  CLC   PRGHIDTE,NBACTDAT   SAVE HIGHEST UNIT DATE                       
         BNL   *+10                                                             
         MVC   PRGHIDTE,NBACTDAT                                                
*                                                                               
         OC    NUCMLPOS,NUCMLPOS                                                
         BZ    *+8                                                              
         OI    PRGFLG,X'04'                                                     
*                                                                               
         CLI   NUCMLBSL,0                                                       
         BE    *+8                                                              
         OI    PRGFLG,X'02'                                                     
*                                                                               
         OC    NUCMLREF,NUCMLREF                                                
         BNZ   BLPRG34                                                          
         OC    NUCML1,NUCML1       IF COMML ASSIGNED                            
         BZ    BLPRG34              JUST UNASSIGNED UNIT                        
         OI    PRGFLG,X'01'        MUST BE FROM NET ASSIGN                      
*                                                                               
BLPRG34  TM    NUCMLFLG,X'E0'      ANY CHANGES (MADE CML INVALID)               
         BNZ   BLPRG36                                                          
         OC    NUCML1,NUCML1       CML ASSIGNED                                 
         BNZ   *+16                                                             
         TM    NUCMLFL2,NUCMLFFD   FEED NO NATIONAL?                            
         BO    BLPRG38              YES                                         
         B     BLPRG36                                                          
*                                                                               
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BO    BLPRG38              YES                                         
*                                                                               
         CLI   NBPR2CL3,0                                                       
         BE    BLPRG38                                                          
         OC    NUCML2,NUCML2       CML ASSIGNED                                 
         BNZ   BLPRG38                                                          
BLPRG36  CLI   NBPR1CL3,0                                                       
         BNE   *+12                                                             
         CLI   SVCSPRD,0                                                        
         BE    BLPRG38                                                          
         LH    R1,PRGUNAS                                                       
         AHI   R1,1                                                             
         STH   R1,PRGUNAS                                                       
*                                                                               
BLPRG38  LH    R1,PRGUNITS                                                      
         AHI   R1,1                                                             
         STH   R1,PRGUNITS                                                      
         MVC   BYTE,NUCMLFLG       SAVE TO TEST IF FEEDS                        
*                                                                               
         TM    NBUNITST,X'20'      ANY ACTUAL COST?                             
         BZ    BLPRG40                                                          
         ICM   RE,15,NBACTUAL                                                   
         ICM   RF,15,PRGCOST                                                    
         AR    RE,RF                                                            
         STCM  RE,15,PRGCOST       SAVE TOTAL COST IN TABLE                     
         EJECT                                                                  
* COUNT FEEDS *                                                                 
*                                                                               
BLPRG40  L     R6,NBAIO                                                         
         LA    R6,27(,R6)                                                       
         MVI   ELCODE,X'23'                                                     
BLPRG50  BRAS  RE,NEXTEL                                                        
         BNE   BLPRG60                                                          
         USING NUFDCEL,R6                                                       
         TM    NUFDCFL2,X'80'      DELETED FEED                                 
         BO    BLPRG50              YES                                         
*                                                                               
         OC    NUFDCPOS,NUFDCPOS   FEED POSITION                                
         BZ    *+8                                                              
         OI    PRGFLG,X'04'                                                     
*                                                                               
         CLI   NUFDCBSL,0          FEED BILLBOARD                               
         BE    *+8                                                              
         OI    PRGFLG,X'02'                                                     
*                                                                               
         OC    NUFDCREF,NUFDCREF                                                
         BNZ   BLPRG52                                                          
         OC    NUFDCML1,NUFDCML1   IF COMML ASSIGNED                            
         BZ    BLPRG52              MUST BE FROM NET ASSIGN                     
         OI    PRGFLG,X'01'        MUST BE FROM NET ASSIGN                      
*                                                                               
BLPRG52  LH    R1,PRGFEEDS                                                      
         AHI   R1,1                                                             
         STH   R1,PRGFEEDS                                                      
         TM    BYTE,X'E0'          (SAVED NUCMLFLG FROM 21 ELEM)                
         BNZ   BLPRG56                                                          
*                                                                               
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BZ    *+12                                                             
         OI    ANYFLAG,COPYSSW     YES, TURN ON FLAG                            
         B     BLPRG50                                                          
*                                                                               
         CLI   NBPR2CL3,0          P/B PROD                                     
         BE    BLPRG54              NO                                          
         OC    NUFDCML2,NUFDCML2   CML ASSIGNED                                 
         BZ    BLPRG56                                                          
*                                                                               
BLPRG54  OC    NUFDCML1,NUFDCML1   CML ASSIGNED                                 
         BNZ   BLPRG50                                                          
BLPRG56  LH    R1,PRGUNAS                                                       
         AHI   R1,1                                                             
         STH   R1,PRGUNAS                                                       
*                                                                               
         B     BLPRG50                                                          
         DROP  R6                                                               
         EJECT                                                                  
BLPRG60  GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   NBMODE,NBREQLST                                                  
         BE    BLPRG62                                                          
         CLI   NBMODE,NBPROCUN                                                  
         BNE   BLPRG60                                                          
         TM    NBSUBMSK,NBSBMCLI+NBSBMNET                                       
         BNZ   BLPRG62                                                          
         TM    NBSUBMSK,NBSBMPRG                                                
         BZ    BLPRG10                                                          
         TM    SVFLAG,SVTSERR      ANY ERRORS                                   
         BZ    *+8                                                              
         OI    SVFLAG,SVPRGERR     AT LEAST ONE ERROR FOUND                     
         NI    SVFLAG,X'FF'-(SVTSERR+SVFLGTS+SVFLGNTS)                          
         OC    PROGRAM,PROGRAM     WAS PROGRAM = ALL                            
         BZ    BLPRG64                                                          
*                                                                               
BLPRG62  OC    PROGRAM,PROGRAM     WAS PROGRAM = ALL                            
         BZ    BLPRG63                                                          
*                                                                               
         BAS   RE,NXTEQV           GET NEXT EQUIVALENT PROGRAM IF ANY           
         BNE   BLPRG10                                                          
*                                                                               
BLPRG63  OI    UPDSW,X'40'         END OF UNITS SWITCH                          
*                                                                               
BLPRG64  OC    PRGUNITS,PRGUNITS   ANY UNITS FOUND?                             
         BZ    BLPRG86                                                          
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   BLPRG70                                                          
*                                                                               
         TM    SVFLAG,SVTSERR      ANY TRAFFIC SUPPLIER ERRORS?                 
         BO    NOTSUPER                                                         
*                                                                               
         CLC   PRGUNITS,PRGUNAS    ALL UNASSIGNED                               
         BE    PNOASIGN                                                         
*                                                                               
         TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    BLPRG66                                                          
         CLI   SVTNPR3,C'Y'        ALLOW UNALLOCATED UNITS                      
         BE    BLPRG66                                                          
         OC    PRGUNAL,PRGUNAL     ANY UNALLOCATED UNITS                        
         BNZ   PUNALOC                                                          
*                                                                               
BLPRG66  TM    SVOPTSW,OPTUNAS     ALLOW UNASSIGNED                             
         BO    BLPRG68              YES                                         
         OC    PRGUNAS,PRGUNAS     ANY UNASSIGNED UNITS                         
         BNZ   PUNASIGN                                                         
*                                                                               
* GET PROGRAM INFO                                                              
*                                                                               
BLPRG68  TM    SVFLAG,SVTSERR      ANY ERRORS                                   
         MVI   SVFLAG,0            THIS DOES NOT CHANGE COND CODE               
         BZ    *+8                                                              
         OI    SVFLAG,SVPRGERR     AT LEAST ONE ERROR FOUND                     
*                                                                               
         BRAS  RE,INITSPT          SET FROM NET TO SPOT                         
*                                                                               
         XC    KEY,KEY                                                          
         LA    R1,KEY                                                           
         USING NPGKEY,R1                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,PRGPRG                                                  
         MVC   NPGKEND,PRGHIDTE                                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BNE   PROGDTER                                                         
         B     BLPRG80                                                          
*                                                                               
* THIS IS FOR OVERNITE INSTRUCTIONS, SEE IF ANY ERRORS *                        
* IF AT LEAST 1 GOOD PROGRAM, SUBMIT REQUEST           *                        
*                                                                               
BLPRG70  TM    WHEN,X'40'          IF NOW, GO AHEAD                             
         BO    BLPRG80              YES                                         
*                                                                               
         TM    SVFLAG,SVPRGERR     ANY TRAFFIC SUPPLIER ERRORS?                 
         BO    BLPRG86              YES                                         
*                                                                               
         TM    SVOPTSW,OPTSEED     OPER SAYS SEED WILL BE RUN                   
         BO    BLPRG94                                                          
*                                                                               
         CLC   PRGUNITS,PRGUNAS    ALL UNASSIGNED                               
         BE    BLPRG86A             YES                                         
*                                                                               
         TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    BLPRG76                                                          
         CLI   SVTNPR3,C'Y'        ALLOW UNALLOCATED UNITS                      
         BE    BLPRG76                                                          
         OC    PRGUNAL,PRGUNAL     ANY UNALLOCATED UNITS                        
         BNZ   BLPRG86A                                                         
*                                                                               
BLPRG76  TM    SVOPTSW,OPTUNAS     ALLOW UNASSIGNED                             
         BO    BLPRG78             YES                                          
         OC    PRGUNAS,PRGUNAS     ANY UNASSIGNED UNITS                         
         BNZ   BLPRG86A                                                         
BLPRG78  B     BLPRG94             ONLY NEED 1 PROG FOR OFFLINE                 
         EJECT                                                                  
* CHECK FOR NEW/REV ONLY OR ALL *                                               
*                                                                               
BLPRG80  TM    SVOPTSW,OPTNEW                                                   
         BZ    *+14                                                             
         OC    PRGCREVN(4),PRGCREVN THIS ORIGINAL                               
         BZ    BLPRG86               NO, BYPASS                                 
*                                                                               
         TM    SVOPTSW,OPTREV      REVISIONS ONLY?                              
         BZ    BLPRG82                                                          
         TM    PRGFLG,X'20'        HAVE INSTRUCTIONS BEEN RUN?                  
         BZ    BLPRG82              NO, PROCESS                                 
*                                                                               
         CLI   PRGCREVN,0          THIS ORIGINAL                                
         BE    BLPRG86              YES, BYPASS                                 
*                                                                               
BLPRG82  CLI   OFFLINE,C'Y'        IF OFFLINE TABLE BUILD                       
         BE    BLPRG84                                                          
         TM    WHEN,X'40'          IF NOW, ALSO BUILD TABLE                     
         BZ    BLPRG86              IF ONLINE VALIDATE, NO TABLE                
BLPRG84  LA    R5,PRGNEXT                                                       
         C     R5,MXPRGTBL           AT END OF TABLE                            
         BNL   PRGSIZER                                                         
BLPRG86  XC    PRGENT(L'PRGENT+2),PRGENT                                        
BLPRG86A TM    UPDSW,X'40'         END OF UNITS                                 
         BZ    BLPRG10              NO, PROCESS NEXT                            
*                                                                               
BLPRG90  TM    SVFLAG,SVPRGERR+SVTSERR  ANY ERRORS?                             
         BNZ   BLPRG150             YES                                         
         C     R5,APRGTBLE         ANY PROGRAMS FOUND                           
         BNE   BLPRG94                                                          
*                                                                               
         OC    0(6,R5),0(R5)                                                    
         BZ    BLPRG96                                                          
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROG?                           
         BO    BLPRG150             YES, ERROR                                  
*                                                                               
* FIND AT LEAST ONE NON-PRGXCLUD ENTRY                                          
*                                                                               
BLPRG94  DS    0H                                                               
         L     R5,APRGTBLE                                                      
BLPRG94C OC    0(6,R5),0(R5)       DONE?                                        
         BZ    BLPRG150             YES, NO PROGRAMS TO PROCESS                 
         TM    PRGFLG,PRGXCLUD     EXLUDE THIS PROG?                            
         BZ    BLPRG94X             NO, OK TO PROCESS                           
         LA    R5,PRGNEXT                                                       
         C     R5,MXPRGTBL         REACHED END?                                 
         BNL   BLPRG150            YES, NO PROGS TO PROCESS                     
         B     BLPRG94C                                                         
*                                                                               
BLPRG94X CR    RB,RB                                                            
         B     BLPRGX                                                           
BLPRG96  TM    WHEN,X'40'          IF NOT NOW, ERROR                            
*                                                                               
BLPRG150 CR    RB,RC                                                            
         B     BLPRGX              SET UP TEST AND EXIT HERE                    
*                                                                               
* FILTER ON PRODUCT GROUP *                                                     
*                                                                               
FPG      NTR1                                                                   
         LHI   R0,OPTPGRLQ                                                      
         L     R1,AOPTPGRL                                                      
*                                                                               
FPG10    CLC   NBPR1CL3,0(R1)                                                   
         BE    FPGEQ                                                            
*                                                                               
         CLI   NBPR1CL3,0                                                       
         BNE   FPG30                                                            
*                                                                               
         LHI   RE,SVCSPRDQ                                                      
         LA    RF,SVCSPRD                                                       
FPG20    CLI   0(RF),0                                                          
         BE    FPG30                                                            
         CLC   0(3,R1),0(RF)                                                    
         BE    FPGEQ                                                            
         LA    RF,L'SVCSPRD(RF)                                                 
         BCT   RE,FPG20                                                         
*                                                                               
FPG30    LA    R1,L'OPTPGRL(R1)                                                 
         CLI   0(R1),0                                                          
         BNH   *+8                                                              
         BCT   R0,FPG10                                                         
         CR    RD,RB                                                            
         B     FPGX                                                             
FPGEQ    CR    RB,RB                                                            
FPGX     XIT1                                                                   
         EJECT                                                                  
* GENERATE COMML INSTR ERROR REPORT *                                           
*                                                                               
PUNASIGN LA    R1,XTYPE6          SOME UNASSIGNED UNITS                         
         B     BLPRG200                                                         
PUNALOC  LA    R1,XTYPE5          SOME UNALLOCATED UNITS                        
         B     BLPRG200                                                         
PNOASIGN LA    R1,XTYPE3          ALL UNITS UNASSIGNED                          
         B     BLPRG200                                                         
NOTSUPER LA    R1,XTYPEB          MUST HAVE SAME TRAFFIC SUPPLIER               
*                                                                               
BLPRG200 CLI   OFFLINE,C'Y'                                                     
         BNE   BLPRG86A                                                         
*                                                                               
*        TM    WHEN,X'20'          IS THIS SOON                                 
*        BZ    *+12                                                             
*        CLI   SVTWPR06,C'N'       UNLESS NO FAX, CAN'T PRINT REPORT            
*        BNE   BLPRG86A                                                         
*                                                                               
         BAS   RE,XPUT             GO PUT TO ERROR REPORT                       
         B     BLPRG86A                                                         
BLPRGX   XIT1                                                                   
         EJECT                                                                  
PRGSIZER MVC   GERROR,=Y(MANYPGM)                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,3              L'SUBST TEXT + 1                             
         MVC   ELEM+1(2),=C'85'                                                 
         LA    R2,TRACLTH                                                       
         B     COMERRS                                                          
*                                                                               
PROGDTER MVC   GERROR,=Y(BDPGMDAT)                                              
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,7              L'SUBST TEXT + 1                             
         MVC   ELEM+1(6),PRGPRG                                                 
         MVI   ELEM+7,9            L'SUBST TEXT + 1                             
         GOTO1 DATCON,DMCB,(2,KEYSAVE+11),(8,ELEM+8)                            
*                                                                               
COMERRS  OC    AERRFILE,AERRFILE         STORED DCB ADDRESS                     
         BZ    COMERS10                                                         
         L     R3,AERRFILE         STORED DCB ADDRESS                           
         CLOSE ((R3),)                                                          
         FREEPOOL (R3)                                                          
*                                                                               
         XC    AERRFILE,AERRFILE   SET FILE NOT OPEN                            
*                                                                               
COMERS10 DS    0H                                                               
         TM    WHEN,X'20'          IS THIS SOON                                 
         BZ    TRAPERS2                                                         
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   TRAPERS2                                                         
*                                                                               
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    TRAPERS2                                                         
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    TRAPERS2                                                         
*                                                                               
* BUILD UNLOCK KEY FOR SOON UPDATES                                             
*                                                                               
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   UNL20               NOT AN ALL PRODUCT RUN                       
*                                                                               
         XC    SVLOCK,SVLOCK                                                    
         MVI   SVLOCK,C'U'         UNLOCK                                       
         MVI   SVLOCK+1,X'FF'      NET (TRAFFIC)                                
         MVC   SVLOCK+2(4),TRANET  NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   UNL10                                                            
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   UNL10                                                            
         MVI   SVLOCK+2,X'FF'                                                   
         MVC   SVLOCK+3(1),SVMEDIA THEN UNLOCK BY MEDIA                         
         XC    SVLOCK+4(2),SVLOCK+4                                             
UNL10    MVI   SVLOCK+6,X'FF'      ALL PRODS                                    
         B     UNL100                                                           
*                                                                               
* IF RUNNING BY PRODUCT, SEE THAT THIS PRD IS NOT LOCKED                        
*                                                                               
UNL20    CLI   SVTN2PRO+00,C'*'                                                 
         BNE   UNL40                                                            
         XC    SVLOCK,SVLOCK                                                    
         MVI   SVLOCK,C'U'         UNLOCK                                       
         MVI   SVLOCK+1,X'FF'      NET (TRAFFIC)                                
         MVC   SVLOCK+2(4),TRANET  NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   UNL30                                                            
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   UNL30                                                            
         MVI   SVLOCK+2,X'FF'                                                   
         MVC   SVLOCK+3(1),SVMEDIA THEN UNLOCK BY MEDIA                         
         XC    SVLOCK+4(2),SVLOCK+4                                             
UNL30    MVC   SVSVPROD,OPTPROD    SAVE THIS PROD TO UNLOCK                     
*                                                                               
         B     UNL100                                                           
*                                                                               
UNL40    OC    OPTPRGR,OPTPRGR     PROD GROUP                                   
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         XC    SVLOCK,SVLOCK                                                    
         MVI   SVLOCK,C'U'         UNLOCK                                       
         MVI   SVLOCK+1,X'FF'      NET (TRAFFIC)                                
         MVC   SVLOCK+2(4),TRANET  NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   UNL60                                                            
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   UNL60                                                            
         MVI   SVLOCK+2,X'FF'                                                   
         MVC   SVLOCK+3(1),SVMEDIA THEN UNLOCK BY MEDIA                         
         XC    SVLOCK+4(2),SVLOCK+4                                             
UNL60    MVC   SVLOCK+6(2),OPTPRGR PGROUP                                       
*                                                                               
UNL100   MVC   FLD,ELEM             SAVE ERROR MSG INFO                         
         BRAS  RE,UNLOCK                                                        
         MVC   ELEM(L'FLD),FLD      RESTORE ERROR MSG INFO                      
TRAPERS2 GOTO1 VTRAERR                                                          
*                                                                               
TRIBKER  XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(35),=C'* ERROR * TRI-BACKS, USE NINS GEN *'              
         LA    R2,TRACLTH                                                       
         GOTO1 ERREX2                                                           
NOTSERR  DS    0H                                                               
         LA    R2,TRAOPTH                                                       
         MVC   GERROR,=Y(BDTSOPT)                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         LLC   RE,SVTSLEN          TEXT LENGTH                                  
         LA    RE,3(RE)            PLUS 3 (2 FOR () PLUS 1)                     
         STC   RE,ELEM             L'SUBST TEXT+1                               
         BCTR  RE,0                BACK TO ACTUAL TEXT LENGTH                   
         MVI   ELEM+1,C'('                                                      
         MVC   ELEM+2(L'SVTS),SVTS                                              
         LA    RE,ELEM(RE)                                                      
         MVI   0(RE),C')'                                                       
         MVI   1(RE),17                                                         
         MVC   2(16,RE),=C'RECORD NOT FOUND'                                    
*                                                                               
         GOTO1 VTRAERR                                                          
         EJECT                                                                  
*----------------------------------------------------                           
* GET BASE PROGRAM CODE FOR EQUIVALENT PROGRAM CODE                             
*----------------------------------------------------                           
*                                                                               
FPRGC    NTR1                                                                   
*                                                                               
         MVI   BYTE,0              INIT FOR ERROR                               
*                                                                               
         L     R6,NBAIO                                                         
         LA    R6,27(R6)                                                        
         MVI   ELCODE,X'19'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   FPRGC03                                                          
         USING NUPDED,R6                                                        
         XR    R0,R0                                                            
         LLC   R1,1(R6)                                                         
         D     R0,=F'7'                                                         
         CHI   R0,3                MUST BE A REMAINDER OF 3                     
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    NUPDEIND,X'40'      COPYSPLIT?                                   
         BZ    FPRGC06              NO                                          
         LTR   R0,R1                                                            
         BNZ   *+6                 MUST BE MORE THAN 1 PRODUCT                  
         DC    H'0'                                                             
         CHI   R0,3                DON'T BUILD SVCSPRD IF LESS THAN 3           
         BL    FPRGC06                                                          
*                                                                               
         LA    R1,NUPDEPR                                                       
         LA    RF,SVCSPRD                                                       
*                                                                               
         MVC   0(3,RF),0(R1)                                                    
         LA    R1,7(R1)                                                         
         LA    RF,L'SVCSPRD(RF)                                                 
         BCT   R0,*-14                                                          
         B     FPRGC05                                                          
         DROP  R6                                                               
*                                                                               
FPRGC03  L     R6,NBAIO                                                         
         LA    R6,27(R6)                                                        
         MVI   ELCODE,X'14'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   FPRGC06                                                          
         USING NUPRDD,R6                                                        
         SR    R0,R0                                                            
         LLC   R1,1(R6)                                                         
         D     R0,=F'6'                                                         
         CHI   R0,3                MUST BE A REMAINDER OF 3                     
         BE    *+6                                                              
         DC    H'0'                                                             
         LR    R2,R1                                                            
         CHI   R2,1                MUST BE MORE THAN 1 PRODUCT                  
         BH    *+6                                                              
         DC    H'0'                                                             
         LA    RF,NUPRDPR                                                       
         LA    R4,SVCSPRD                                                       
*                                                                               
FPRGC04  BRAS  RE,FPROD            SVCSPRD NOW 3 CHAR PRD ALWAYS                
         MVC   0(3,R4),QPRD                                                     
         LA    RF,6(RF)                                                         
         LA    R4,L'SVCSPRD(R4)                                                 
         BCT   R2,FPRGC04                                                       
         DROP  R6                                                               
*                                                                               
FPRGC05  CLI   SVCSPRD,0                                                        
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
* FOLLOWING FOR READABILITY - BOTH ARE SAME DISPLACEMENT OFF R6                 
         LA    RF,NUPRDIND-NUPRDD(R6)                                           
         CLI   0(R6),X'19'                                                      
         BNE   *+8                                                              
         LA    RF,NUPDEIND-NUPDED(R6)                                           
*                                                                               
         TM    0(RF),X'80'         IS THIS A TRI-BACK                           
         BZ    *+16                                                             
         MVI   BYTE,XTYPEC         YES, ERROR TYPE 7 (NO TRI-BACKS)             
         OI    ANYFLAG,TRIFOUND    TRI-BACK FOUND FLAG                          
         B     FPRGC64                                                          
*                                                                               
         TM    NBUNST3,X'40'       IS THIS A COPY SPLIT                         
         BO    FPRGC06              YES                                         
         DC    H'0'                                                             
*                                                                               
FPRGC06  DS    0H                                                               
         MVC   BASEPRG,NBACTPRG                                                 
         XC    BASEDTS,BASEDTS                                                  
         MVI   BASECT,0                                                         
*                                                                               
         LA    R2,EQVPTBL                                                       
         LA    R4,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         SR    R6,R6                                                            
*                                                                               
         USING EQVPTBLD,R2                                                      
FPRGC10  OC    EQVEPRG,EQVEPRG     END OF ENTRIES                               
         BZ    FPRGC16              YES                                         
*                                                                               
         CLC   NBACTPRG,EQVEPRG                                                 
         BNE   FPRGC14                                                          
*                                                                               
         BCTR  R6,0                SET PROG CODE FOUND                          
*                                                                               
         CLC   NBACTDAT,EQVSDT     WITHIN DATES                                 
         BL    FPRGC14                                                          
         CLC   NBACTDAT,EQVEDT                                                  
         BNH   FPRGC20                                                          
*                                                                               
FPRGC14  LA    R2,EQVNEXT                                                       
         BCT   R4,FPRGC10                                                       
*                                                                               
FPRGC16  LTR   R6,R6               WAS PROGRAM CODE FOUND                       
         BZ    FPRGC26                                                          
         MVI   BYTE,XTYPEA                                                      
         B     FPRGC60              YES, PARTIAL PERIOD                         
*                                                                               
FPRGC20  MVC   BASEPRG,EQVBPRG     SET FOR USE                                  
*                                                                               
         MVC   BASEDTS,EQVSDT                                                   
         MVC   BASECT,EQVCT                                                     
         MVI   EQVUSED,C'Y'                                                     
*                                                                               
FPRGC26  CLC   PRGPRG,BASEPRG                                                   
         BE    FPRGC50                                                          
*                                                                               
         L     R5,APRGTBLE                                                      
         USING EQVPTBLD,R2                                                      
FPRGC30  OC    PRGENT,PRGENT       END OF ENTRIES                               
         BZ    FPRGC40              YES                                         
         CLC   PRGPRG,BASEPRG                                                   
         BE    FPRGC50                                                          
*                                                                               
         LA    R5,PRGNEXT                                                       
         C     R5,MXPRGTBL                                                      
         BL    FPRGC30                                                          
         CLI   MODE,VALKEY         MODE VALIDATE KEY                            
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   =C'OV',CONWHEN      FOR OVERNIGHT REQUEST                        
         BE    FPRGC54             ALLOW TABLE OVERFLOW                         
         DC    H'0'                                                             
*                                                                               
FPRGC40  MVC   PRGPRG,BASEPRG                                                   
*                                                                               
FPRGC50  OC    PRGCREVN(4),PRGCREVN   GOT REVISION INFO YET                     
         BNZ   FPRGC54                                                          
*                                                                               
* GET REVISION INFO *                                                           
*                                                                               
         BRAS  RE,FREV                                                          
*                                                                               
FPRGC54  CR    RB,RB               SET CONDITION CODE TO OK                     
*                                                                               
FPRGCX   XIT1  REGS=(R5)                                                        
*                                                                               
* PROGRAM CODE WAS EQUIVALENT FOR PART OF PERIOD, ERROR, BYPASS *               
*                                                                               
FPRGC60  CLI   OFFLINE,C'Y'                                                     
         BNE   FPRGC64                                                          
*                                                                               
*        TM    WHEN,X'20'          IS THIS SOON                                 
*        BZ    *+12                                                             
*        CLI   SVTWPR06,C'N'       UNLESS NO FAX, CAN'T PRINT REPORT            
*        BNE   FPRGC64                                                          
*                                                                               
         LA    R1,XTYPEA                                                        
         BAS   RE,XPUT             GO PUT TO ERROR REPORT                       
         B     FPRGC70                                                          
*                                                                               
FPRGC64  DS    0H                                                               
         TM    WHEN,X'40'          IS THIS NOW                                  
         BZ    FPRGC70              NO, DO ERROR REPORT LATER                   
         CLI   BYTE,XTYPEC         TRI-BACK UNIT                                
         BE    TRIBKER              YES, STOP IT                                
*                                                                               
FPRGC70  LTR   RB,RB               SET CONDITION CODE TO NG                     
         B     FPRGCX                                                           
         DROP  R5                                                               
         EJECT                                                                  
* COMMON ERROR REPORT FORMAT AND PUT                                            
*                                                                               
         DS   0H                                                                
         USING PRGTABLD,R5                                                      
XPUT     NTR1                                                                   
         XC    ELEM,ELEM                                                        
         LA    R2,ELEM                                                          
         USING XRECD,R2                                                         
         MVC   XBAGYMD,BAGYMD                                                   
         MVC   XCLT,QCLT                                                        
         MVC   XNET,NETWORK                                                     
         MVC   XNETMKT,NETMKT                                                   
         MVC   XPROG,PRGPRG                                                     
         MVC   XTUNT,PRGUNITS                                                   
         MVC   XFEEDS,PRGFEEDS                                                  
         MVC   XUNAS,PRGUNAS                                                    
         MVC   XUNAL,PRGUNAL                                                    
         MVC   XPERST,STDATE                                                    
         MVC   XPERND,ENDATE                                                    
         MVC   XPERST,PSTDATE                                                   
         MVC   XPERND,PENDATE                                                   
         STC   R1,XTYPE                                                         
*                                                                               
         L     R1,AERRFILE                                                      
         LA    R0,ELEM                                                          
         PUT   (1),(0)                                                          
         B     BLPRGX                                                           
         DROP  R2                                                               
         EJECT                                                                  
* GET BASE PROGRAM CODE FOR EQUIVALENT PROGRAM CODE *                           
*                                                                               
         DS   0H                                                                
NXTEQV   NTR1                                                                   
*                                                                               
         MVC   BASEPRG,NBACTPRG                                                 
         XC    BASEDTS,BASEDTS                                                  
*                                                                               
         LA    R2,EQVPTBL                                                       
         LA    R4,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         SR    R5,R5                                                            
*                                                                               
         USING EQVPTBLD,R2                                                      
NXTEQV10 OC    EQVEPRG,EQVEPRG     END OF ENTRIES                               
         BZ    NXTEQVX              YES                                         
         CLI   EQVUSED,C'Y'                                                     
         BNE   NXTEQV20                                                         
*                                                                               
         LA    R2,EQVNEXT                                                       
         BCT   R4,NXTEQV10                                                      
         B     NXTEQVX                                                          
*                                                                               
NXTEQV20 MVC   BASEPRG,EQVEPRG     SET FOR USE                                  
*                                                                               
         MVC   BASEDTS,EQVSDT                                                   
*                                                                               
         CLC   BASEEND,ENDATEP     IS END DATE PAST PERIOD END                  
         BNH   *+10                                                             
         MVC   BASEEND,ENDATEP     CUTAIL END DATE                              
*                                                                               
         MVC   BASECT,EQVCT                                                     
*                                                                               
         MVI   EQVUSED,C'Y'                                                     
*                                                                               
         BRAS  RE,NETI                  INITIALIZE NETIO                        
*                                                                               
NXTEQV30 GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   NBMODE,NBREQLST                                                  
         BE    NXTEQV34                                                         
         CLI   NBMODE,NBPROCUN                                                  
         BNE   NXTEQV30                                                         
*                                                                               
NXTEQV34 BCTR  R5,0                                                             
*                                                                               
NXTEQVX  LTR   R5,R5                                                            
         B     BLPRGX                                                           
         DROP  R2                                                               
         EJECT                                                                  
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
* UNLOCK FOR SOON UPDATES                                                       
*                                                                               
         DS    0H                                                               
UNLOCK   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
* IF RUNNING FOR ALL PRODUCTS, UNLOCK ALL PRODS                                 
*                                                                               
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   ULOCK30             NOT AN ALL PRODUCT RUN                       
*                                                                               
         MVI   BYTE,0                                                           
         B     ULOCK100                                                         
*                                                                               
* IF RUNNING BY PRODUCT, UNLOCK THIS PRD                                        
*                                                                               
ULOCK30  CLI   SVTN2PRO+00,C'*'                                                 
         BNE   ULOCK50                                                          
*                                                                               
         MVC   BYTE,SVTN2PRO+00                                                 
         B     ULOCK100                                                         
*                                                                               
* IF RUNNING BY PGROUP, UNLOCK THIS PGROUP                                      
*                                                                               
ULOCK50  OC    OPTPRGR,OPTPRGR     PRGOUP                                       
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
         MVC   BYTE,SVTN2PRO+00                                                 
*                                                                               
ULOCK100 MVC   DUB,SVLOCK          LOCK INFO                                    
         MVC   SVCPROD,SVSVPROD    PROD LOCK INFO                               
         MVI   DUB,C'U'                                                         
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    ULOCKX                                                           
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
ULOCKX   XIT1                                                                   
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
* GET NETWORK                                                                   
*                                                                               
         DS    0H                                                               
GNET     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITNET                                                       
*                                                                               
         XC    KEY,KEY                                                          
         XC    KEYSAVE,KEYSAVE                                                  
*                                                                               
         LA    R4,KEY                                                           
         USING NURECD,R4                                                        
*                                                                               
         MVI   NUKPTYPE,X'84'      UNIT PASSIVE KEY                             
         MVC   NUKPAM,BAGYMD       AGENCY                                       
         MVC   NUKPCLT,BCLT        CLIENT                                       
         MVC   NUKPNET,SVNET       CURRENT NETWORK                              
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
GNET10   CLC   KEY(4),KEYSAVE      SAME AGY/CLT                                 
         BNE   GNETDONE             NO, DONE                                    
*                                                                               
         CLI   SVNET,0             FIRST NETWORK                                
         BE    *+14                                                             
         CLC   SVNET,NUKPNET                                                    
         BNL   GNET20              DONE THIS NETWORK BEFORE                     
         MVC   SVNET,NUKPNET                                                    
         B     GNETX                                                            
*                                                                               
* FORCE NEXT NETWORK                                                            
*                                                                               
GNET20   MVC   NUKPPROG,=X'FFFFFFFFFFFF'  FORCE NEXT NET                        
         XC    NUKPDATE,NUKPDATE                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         B     GNET10                                                           
*                                                                               
GNETDONE MVC   SVNET,=X'FFFFFFFF'                                               
*                                                                               
GNETX    BRAS  RE,INITSPT          SET FROM NET TO SPOT                         
         XIT1                                                                   
         DROP  RB,R4                                                            
         EJECT                                                                  
* VALIDATE MY NETWORK (FOR NET=ALL REQUEST)                                     
*                                                                               
         DS    0H                                                               
VMYNET   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITNET                                                       
*                                                                               
         XC    KEY,KEY                                                          
         XC    KEYSAVE,KEYSAVE                                                  
*                                                                               
         LA    R4,KEY                                                           
         USING NURECD,R4                                                        
*                                                                               
         MVI   NUKPTYPE,X'84'      UNIT PASSIVE KEY                             
         MVC   NUKPAM,BAGYMD       AGENCY                                       
         MVC   NUKPCLT,BCLT        CLIENT                                       
         MVC   NUKPNET,SVNET       CURRENT NETWORK                              
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
VMYNET10 CLC   KEY(8),KEYSAVE      SAME AGY/CLT/NET                             
         BNE   VMYNETX              NO, DONE                                    
*                                                                               
         CLC   ENDATEP,NUKPDATE    IF AIR DATE                                  
         BL    VMYNET20                                                         
         CLC   STDATEP,NUKPDATE     IS WITHIN PERIOD DATES                      
         BNH   VMYNETX                THEN PROCESS THIS NETWORK                 
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         B     VMYNET10                                                         
*                                                                               
VMYNET20 MVC   NUKPDATE,=X'FFFF'   ELSE, FORCE NEXT PROG                        
         XC    NUKPEST(4),NUKPEST        CLEAR THE REST OF KEY                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         B     VMYNET10                                                         
*                                                                               
VMYNETX  BRAS  RE,INITSPT          SET FROM NET TO SPOT                         
*                                                                               
         CLC   SVNET,NUKPNET       SET CC CODE                                  
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         DROP  RB,R4                                                            
         EJECT                                                                  
* GET TRAFFIC SUPPLIER RECORD (IF ANY)                                          
* (EXPECTS PROGRAM IN WORK)                                                     
*                                                                               
GETTSUPP NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING TSUPNRECD,R4        NETWORK FAX RECORD                           
         MVI   TSUPKID,X'27'       RECORD ID                                    
         MVC   TSUPKAM,BAGYMD      AGY/MED                                      
         MVC   TSUPKCLT,BCLT       CLIENT                                       
         MVC   TSUPKNET,NETWORK    NETWORK                                      
         MVC   TSUPKPRG,WORK       PROGRAM                                      
         MVC   TSUPKTS,SVTS        TRAFFIC SUPPLIER                             
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEY,KEYSAVE                   
*                                                                               
         CLC   KEY(19),KEYSAVE                                                  
         BE    GETSUPX                                                          
*                                                                               
         XC    TSUPKPRG,TSUPKPRG   MAYBE CLT/NET/TSUPP                          
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEY,KEYSAVE                   
*                                                                               
         CLC   KEY(19),KEYSAVE                                                  
         BE    GETSUPX                                                          
*                                                                               
         XC    TSUPKNET,TSUPKNET   NO NETWORK & NO PROGRAM (CLT/TSUPP)          
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEY,KEYSAVE                   
*                                                                               
         CLC   KEY(19),KEYSAVE                                                  
         BE    GETSUPX                                                          
*                                                                               
         MVC   TSUPKNET,NETWORK    MOVE BACK NETWORK                            
         MVC   TSUPKPRG,WORK             AND PROGRAM                            
         XC    TSUPKCLT,TSUPKCLT   NO CLIENT (NET/PROG/TSUPP)                   
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEY,KEYSAVE                   
*                                                                               
         CLC   KEY(19),KEYSAVE                                                  
         BE    GETSUPX                                                          
*                                                                               
         XC    TSUPKPRG,TSUPKPRG   MAYBE NET/TSUPP                              
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEY,KEYSAVE                   
*                                                                               
         CLC   KEY(19),KEYSAVE                                                  
         BE    GETSUPX                                                          
*                                                                               
         XC    TSUPKNET,TSUPKNET   TSUPP AT AGENCY LEVEL                        
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEY,KEYSAVE                   
*                                                                               
         CLC   KEY(19),KEYSAVE                                                  
         BE    GETSUPX                                                          
*                                                                               
         CR    RB,RC               SET UNEQUAL CC                               
         B     *+6                                                              
*                                                                               
GETSUPX  CR    RB,RB               SET EQUAL CC                                 
         XIT1                                                                   
         LTORG                                                                  
         DROP  R4,RB,RC                                                         
         EJECT                                                                  
******************************************************************              
*                                                                *              
* SUBROUTINE TO PRINT INSTRUCTIONS FOR 1 NETWORK/PROGRAM ENTRY   *              
*                                                                *              
******************************************************************              
*                                                                               
         DS   0H                                                                
PRT      NMOD1 0,**+PRT**,R7                                                    
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         MVC   NEXTADDR,AIO2       ALL QUEUES BUILT IN AIO2                     
*                                                                               
         TM    SVOPTSW,OPTNEW      TEST NEW INST ONLY                           
         BZ    PRT04                                                            
         CLI   PRGCREVN,0         TEST REV=0 (NEW INSTR)                        
         BE    PRT04                                                            
*                                                                               
         MVI   INSPRTSW,C'N'      DO NOT PRINT INSTRUCTIONS                     
         B     PRTXIT                                                           
*                                                                               
PRT04    TM    SVOPTSW1,OPT1EACH                                                
         BO    *+8                                                              
         L     R5,APRGTBLE                                                      
*                                                                               
* BUILD PATTERN TABLE FOR THIS PROGRAM TO FIND PATTERNS USED *                  
*                                                                               
         BRAS  RE,BLPAT                                                         
*                                                                               
         CLI   SVTN2PRO+10,C'Y'    GEN INSTR FOR ENTIRE PERIOD                  
         BNE   *+8                  NO, JUST FOR BUY DATES                      
         BRAS  RE,ADDPATS              ADD MORE PAT ENTRIES IF ANY              
*                                                                               
*SORT ALL PROGRAM TABLE                                                         
*                                                                               
         L     RE,ALLPRTAB         START OF ALL PROGRAM TABLE                   
         USING ALLPRGD,RE                                                       
*                                                                               
         L     RF,MAXPRTAB         END OF ALL PROG TABLE                        
*                                                                               
         LR    R2,RE               SAVE ADDRESS OF ALL PROG TABLE               
         SR    R0,R0                                                            
PRT04C   OC    ALLPGENT,ALLPGENT   EMPTY ENTRY                                  
         BZ    PRT04F                                                           
         BCTR  R0,0                                                             
         CR    RE,RF                                                            
         BNL   PRT04H                                                           
         LA    RE,ALLPGNXT                                                      
         B     PRT04C                                                           
*                                                                               
PRT04F   LTR   R0,R0                                                            
         BZ    PRT04H                                                           
         LPR   R0,R0                                                            
*                                                                               
* SORT ON PROGRAM                                                               
         GOTO1 XSORT,DMCB,(R2),(R0),L'ALLPGENT,6,ALLPGPRG-ALLPGP1               
* SORT ON PRODUCT                                                               
         GOTO1 (RF),(R1),(R2),(R0),L'ALLPGENT,L'ALLPGSRT,0                      
*                                                                               
PRT04H   CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANS                       
         BNE   *+12                 YES                                         
*                                                                               
         CLI   PQSW,1              TEST PRTQUE OPENED                           
         BNE   PRT14                YES                                         
*                                                                               
         CLI   OFFLINE,C'Y'        THIS AN OFFLINE REQUEST                      
         BNE   PRT04K               NO                                          
*                                                                               
         TM    WHEN,X'20'          THIS SOON                                    
         BO    PRT04K               YES, SEND FAX NOW                           
*                                                                               
         CLI   SVTWPR06,C'2'       THIS AN EASYLINK AGENCY COPY REQUEST         
         BE    PRT05                YES, DO AGENCY COPY FIRST                   
*                                                                               
PRT04K   CLI   PQSW,1              TEST PRTQUE OPENED                           
         BE    PRT05                NO                                          
*                                                                               
         MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
*                                                                               
PRT05    LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
*                                                                               
         CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANS                       
         BE    PRT10                NO, JUST OPEN                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    PRT10                YES, JUST OPEN                              
*                                                                               
         TM    WHEN,X'20'          SOON REQUEST                                 
         BO    PRT05C                                                           
*                                                                               
         CLI   OFFLINE,C'Y'        THIS AN OFFLINE REQUEST                      
         BE    PRT06                YES, NO MORE QL STUFF                       
*                                                                               
PRT05C   MVC   QLDESC(3),QCLT                                                   
         MVC   QLDESC+3(4),NETWORK                                              
         MVC   QLDESC+7(4),PSTDATE YEAR AND MONTH                               
         MVI   QLCLASS,C'G'        EASYLINK                                     
         MVC   REMUSER,=C'CWX'                                                  
*AR                                                                             
         MVC   QLTYP1,SVFAXARC                                                  
*AR                                                                             
         TM    WHEN,X'20'          SOON REQUEST                                 
         BZ    PRT10                NO                                          
         B     PRT08                                                            
         DROP  R1                                                               
*                                                                               
PRT06    CLI   SVTWPR06,C'2'       THIS AN EASYLINK AGENCY COPY REQUEST         
         BE    PRT10                YES, DO AGENCY COPY FIRST                   
*                                                                               
PRT08    ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
*                                                                               
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   PRT09                                                            
*                                                                               
         L     RE,TWADCONS                                                      
         L     RE,TSPFUSER-TWADCOND(,RE)                                        
*                                                                               
         MVI   140(RE),C'Y'        SET EASYLINK STUFF PRINTED SW                
*                                                                               
         L     R1,136(,RE)         PAST SAVED DCB                               
         LA    R1,1(,R1)                                                        
         ST    R1,136(,RE)         FORCE NEW PRINT QUEUE ENTRY                  
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  REMOTSUB,DUB        FORCE NEW PRINT QUEUE ENTRY                  
*                                                                               
PRT09    MVC   REMOTJID,=C'CWX'                                                 
*AR                                                                             
         MVI   REMOTFLG,X'FA'                                                   
         MVC   REMOTSYS(3),=C'NCG'                                              
         MVC   REMOTSUB,SPACES                                                  
         MVI   REMOTCPY,1                                                       
         MVC   REMOTTY1,SVFAXARC                                                
*AR                                                                             
         MVC   REMOTDST,TWAORIG                                                 
         OC    TWADEST,TWADEST                                                  
         BZ    *+10                                                             
         MVC   REMOTDST,TWADEST                                                 
         MVI   REMOTCLS,C'G'                                                    
         MVI   REMOTCPY,1                                                       
*                                                                               
PRT10    GOTO1 OPENPQ                                                           
*                                                                               
PRT14    CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANS                       
         BE    PRT16                NO, BYPASS                                  
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    PRT16                YES                                         
*                                                                               
         OC    SVTS,SVTS           ARE WE FAXING TO TSUPP?                      
         BNZ   PRT14X               YES                                         
*                                                                               
         LA    R1,SVSFAX           POINT TO THE FIRST FAX NUMBER                
         ST    R1,SVFAXNXT         SAVE ADDRESS OF THIS FAX                     
*                                                                               
PRT14X   CLI   OFFLINE,C'Y'                                                     
         BNE   PRT15                                                            
         TM    WHEN,X'20'                                                       
         BO    PRT15                                                            
         CLI   SVTWPR06,C'2'       THIS AN EASYLINK AGENCY COPY REQUEST         
         BE    PRT16                NO                                          
*                                                                               
PRT15    OC    SVTS,SVTS                                                        
         BZ    *+10                                                             
         MVC   SVPRGPRG,PRGPRG                                                  
         BRAS  RE,EASILN                                                        
         EJECT                                                                  
* SET UP PRINTING ADDRESSABILITY (AFTER PRTQUE OPEN) *                          
*                                                                               
PRT16    LM    RF,R1,=A(HEADING,HDHK,FTHK)  HEADING, SSPECS, FOOTHOOK           
         L     RE,SPTR63RR                                                      
         AR    RF,RE                                                            
         ST    RF,SPECS            STORE SPECS FOR CONTROLLER                   
         AR    R0,RE                                                            
         ST    R0,HEADHOOK         STORE HEADHOOK FOR CONTROLLER                
         AR    R1,RE                                                            
         ST    R1,FOOTHOOK         STORE FOOTHOOK FOR CONTROLLER                
*                                                                               
         MVI   MAXLINES,60         SET PAGE SIZE                                
         MVI   FOOTLNS,2           ALLOW 2 LINES OF FOOTLINES                   
         MVI   FOOTSW,0            RESET SWITCH                                 
         MVI   CLEARHED,C'N'       DO NOT CLEAR HEADLINES                       
         MVI   CONTINUE,C'Y'                                                    
*                                                                               
         CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANS                       
         BE    PRT18                NO, BYPASS                                  
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    PRT18                NO, JUST EASYLINK                           
*                                                                               
         MVI   MAXLINES,52         SET PAGE SIZE                                
*                                  CAN ONLY DO 52 ON FIRST PAGE                 
*                                  WILL THERAFTER BE SET TO 58                  
*                                  IN HEADHOOK (HDHK)                           
*                                                                               
* BLANK THE HEADLINES NOW *                                                     
*                                                                               
PRT18    LA    R0,14                                                            
         LA    R1,H1                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         MVI   LINE,99             FORCE NEW PAGE WITHOUT FORCEHED              
         MVC   PAGE,=H'1'          WHICH CAUSES FOOTLINES TO REPRINT            
*                                                                               
* READ HEADLINE TEXT RECORD *                                                   
*                                                                               
         L     RE,NEXTADDR                                                      
         MVC   AIO,AIO1                                                         
         XC    0(24,RE),0(RE)      PRECLEAR                                     
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A23'                                                  
         MVC   KEY+2(3),BAGYMD AND BCLT                                         
         MVI   KEY+8,C'H'                                                       
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST TEXT FOUND                              
         BNE   PRT20                                                            
*                                                                               
* PRINT COMMENTS (08 = DO GETREC THERE, CK FOR BOXES)                           
*                                                                               
         OI    UPDSW,X'08'                                                      
*                                                                               
         GOTO1 =A(PCMT),DMCB,(60,NEXTADDR),RR=SPTR63RR                          
*                                                                               
*-----------------------------------------------------                          
* FIND PGROUP LIST REC, CONTACT NAME AND TEL #                                  
*-----------------------------------------------------                          
*                                                                               
PRT20    XC    SVISNMTE,SVISNMTE                                                
         XC    SVFAXTL,SVFAXTL                                                  
         XC    SVDLDSK,SVDLDSK     INIT DISTRIBUTION LIST DISK ADDRESS          
         XC    KEY,KEY                                                          
*                                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PROD GROUP                        
         BZ    PRT22                                                            
*                                                                               
         BAS   RE,GPGRLIST         GET PROD GROUP RECORD IF ANY                 
         BNE   PRT24                                                            
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING PGRCONEL,R6                                                      
         MVC   SVISNMTE,PGRCONNM  SAVE CONTACT NAME AND TEL                     
         CLC   PGRFAXTL,SPACES                                                  
         BNH   *+10                                                             
         MVC   SVFAXTL,PGRFAXTL  SAVE CONTACT FAX TEL                           
*                                                                               
         MVC   SVEMAIL,SPACES    CLEAR E-MAIL ADDRESS                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT30                                                            
*                                                                               
         USING PGREMLEL,R6                                                      
         MVC   SVEMAIL,PGREMLAD  SAVE E-MAIL ADDRESS                            
         B     PRT30                                                            
*                                                                               
*-----------------------------------------------------                          
* FIND PRODUCT LIST REC, CONTACT NAME AND TEL #                                 
*-----------------------------------------------------                          
*                                                                               
PRT22    CLC   OPTPROD,SPACES      RUNNING BY PRODUCT                           
         BNH   PRT24                                                            
                                                                                
         BAS   RE,RPRDLIST         READ PRODUCT LIST RECORD                     
         BNE   PRT24                                                            
                                                                                
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING PRDCONEL,R6                                                      
         MVC   SVISNMTE,PRDCONNM  SAVE CONTACT NAME AND TEL                     
         CLC   PRDFAXTL,SPACES                                                  
         BNH   *+10                                                             
         MVC   SVFAXTL,PRDFAXTL  SAVE CONTACT FAX TEL                           
*                                                                               
         MVC   SVEMAIL,SPACES    CLEAR E-MAIL ADDRESS                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT26                                                            
*                                                                               
         USING PRDEMLEL,R6                                                      
         MVC   SVEMAIL,PRDEMLAD  SAVE E-MAIL ADDRESS                            
         B     PRT26                                                            
*                                                                               
PRT24    BAS   RE,GCLTLIST         GET CLIENT LIST DIST RECORD                  
         BNE   PRT26                                                            
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING CLTCONEL,R6                                                      
         MVC   SVISNMTE,CLTCONNM  SAVE CONTACT NAME AND TEL                     
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'14'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT25                                                            
*                                                                               
         USING CLTFAXEL,R6                                                      
         MVC   SVFAXTL,CLTFAXTL  SAVE CONTACT FAX TEL                           
*                                                                               
PRT25    MVC   SVEMAIL,SPACES    CLEAR E-MAIL ADDRESS                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT26                                                            
*                                                                               
         USING CLTEMLEL,R6                                                      
         MVC   SVEMAIL,CLTEMLAD  SAVE E-MAIL ADDRESS                            
         EJECT                                                                  
PRT26    DS    0H                                                               
         XC    APCPY,APCPY         PRINT LOCATION FOR COPIES TO                 
*RT26    BAS   RE,GPRDLIST         GET PROD LIST RECORD                         
*                                                                               
* GET OPTIONAL NETWORK ADDRESS FROM PROGRAM COPY LIST REC *                     
*                                                                               
PRT30    XC    SVNETADR,SVNETADR                                                
*                                                                               
         CLI   SVTNPR10,C'Y'       BLK NET ADDRESS FROM PROGLIST                
         BE    PRT33                                                            
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A43'    PROGRAM LIST REC                              
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(4),NETWORK                                                 
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    PRT32                                                            
         MVC   KEY(7),KEYSAVE                                                   
         XC    KEY+7(6),KEY+7                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   PRT33                                                            
*                                                                               
PRT32    DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT33                                                            
         USING PRGADREL,R6                                                      
         MVC   SVNETADR,PRGADRAD                                                
         DROP  R6                                                               
*                                                                               
* READ PROGRAM RECORD FOR POSSIBLE DAYPART *                                    
*                                                                               
PRT33    XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,PRGPRG                                                  
         MVC   NPGKEND,PRGHIDTE                                                 
         MVC   SVPRGPRG,PRGPRG                                                  
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   SVDPC,0             INIT DPC                                     
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'93'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT34              NO DAYPART                                    
*                                                                               
         USING NPGEL93,R6                                                       
         CLI   NPG2DYP,0           IS THERE A DAYPART                           
         BZ    PRT34               NO                                           
*                                                                               
         MVC   SVDPC,NPG2DYP       SAVE DAYPART                                 
*                                                                               
         DROP  R6                                                               
*                                                                               
* PRINT THE HEADLINES *                                                         
*                                                                               
PRT34    MVI   SPACING,1                                                        
         MVC   TSRKEYF,PRTCT       SAVE 1ST TSAR KEY NUMBER-1                   
         BRAS  RE,GOSPL                                                         
*                                                                               
         CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANS                       
         BE    PRT36                NO, BYPASS                                  
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    PRT36                NO, JUST EASYLINK                           
*                                                                               
         MVI   MAXLINES,52         SET PAGE SIZE                                
*                                  CAN ONLY DO 52 ON FIRST PAGE                 
*                                  WILL THERAFTER BE SET TO 58                  
*                                  IN HEADHOOK (HDHK)                           
PRT36    DS    0H                                                               
         MVI   FRSTPGSW,C'N'          SET 1ST PAGE SW OFF                       
         CLI   SVNETREV,0         TEST REV=0 (ORIGINAL/OLD REV REC)             
         BNE   *+14                                                             
         MVC   P1+92(8),=C'ORIGINAL'                                            
         B     PRT37                                                            
*                                                                               
         MVC   P1+92(11),=C'NETWORK REV'                                        
         EDIT  (B1,SVNETREV),(3,P1+104)                                         
*                                                                               
PRT37    MVC   P1+3(6),=C'CLIENT'                                               
         MVC   P1+14(3),QCLT                                                    
         MVC   P1+19(20),CLTNM                                                  
         MVC   P1+60(11),=C'DATE ISSUED'                                        
         GOTO1 DATCON,DMCB,(5,0),(5,P1+79)                                      
*                                                                               
         MVC   P2+3(7),=C'PRODUCT'                                              
         CLC   OPTPROD,SPACES                                                   
         BNH   PRT37C                                                           
         MVC   P2+14(3),OPTPROD                                                 
         MVC   P2+19(20),SVPRDNAM                                               
         B     PRT37F               NO                                          
*                                                                               
PRT37C   DS    0H                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PGROUP                            
         BZ    PRT37E               NO                                          
         MVC   P2+14(4),=C'PGR '                                                
         MVC   P2+19(4),QPGR                                                    
         MVC   P2+24(24),SVPRGNAM                                               
         B     PRT37F                                                           
PRT37E   MVC   P2+14(7),=C'VARIOUS'                                             
*                                                                               
PRT37F   MVC   P2+60(16),=C'AGENCY OF RECORD'                                   
         CLI   SVTNPR7,C'Y'       BLANK AGENCY OF RECORD N & A                  
         BE    PRT40                                                            
         TM    SVOPTSW,OPTNOAOR   BLANK AGENCY OF RECORD N & A                  
         BO    PRT40                                                            
                                                                                
         CLC   USERNAME,SPACES                                                  
         BH    *+10                                                             
         MVC   USERNAME(L'USERNAME+L'USERADDR),SVUSER                           
                                                                                
         MVC   P2+79(33),USERNAME                                               
PRT40    DS   0H                                                                
         MVC   P3+3(7),=C'NETWORK'                                              
         MVC   P3+14(L'NETWORK),NETWORK                                         
         MVC   P3+19(30),SVNETADR                                               
         MVC   P3+60(9),=C'ISSUED BY'                                           
         MVC   P3+79(30),SVISNAME                                               
*                                                                               
         MVC   P4+79(L'SVEMAIL),SVEMAIL                                         
*                                                                               
         LA    R1,P1                                                            
         BRAS  RE,GOSPL                                                         
         MVC   60(9,R1),=C'TELEPHONE'                                           
         MVC   79(24,R1),SVISTEL                                                
*                                                                               
         OC    SVFAXTL,SVFAXTL     ANY CONTACT FAX NUMBER                       
         BZ    PRT46                YES                                         
         BRAS  RE,GOSPL                                                         
         MVC   60(11,R1),=C'CONTACT FAX'                                        
         MVC   79(24,R1),SVFAXTL                                                
         LA    R1,132(R1)                                                       
*                                                                               
PRT46    OC    SVTS,SVTS                                                        
         BZ    PRT50                                                            
         BRAS  RE,GOSPL                                                         
         MVC   60(16,R1),=C'TRAFFIC SUPPLIER'                                   
         MVC   79(5,R1),SVTS       PRINT TRAFFIC SUPPLIER                       
         LA    R1,132(R1)                                                       
         OC    SVCNAME,SVCNAME     CONTACT NAME                                 
         BZ    PRT50                                                            
         MVC   60(7,R1),=C'CONTACT'                                             
         MVC   79(L'SVCNAME,R1),SVCNAME                                         
         LA    R1,132(R1)                                                       
*                                                                               
PRT50    BRAS  RE,GOSPL                                                         
         TM    ANYFLAG,PIGGBSW+COPYSSW                                          
         BZ    PRT55                                                            
         BM    *+14                                                             
         MVC   P2+67(41),=C'*** PIGGYBACKS AND COPYSPLITS PRESENT ***'          
         B     PRT52                                                            
         MVC   P2+67(26),=C'*** PIGGYBACKS PRESENT ***'                         
         TM    ANYFLAG,PIGGBSW     ANY PIGGYBACKS                               
         BO    PRT52                                                            
         MVC   P2+67(26),=C'*** COPYSPLITS PRESENT ***'                         
         TM    ANYFLAG,COPYSSW     ANY COPYSPLITS                               
         BO    PRT52                                                            
         DS    H'0'                BUG CATCHER                                  
PRT52    MVI   P1,0                                                             
         BRAS  RE,GOSPL                                                         
*                                                                               
*------------------------------                                                 
* PRINT TEXT COMMENT HERE                                                       
*------------------------------                                                 
*                                                                               
PRT55    MVI   P1,0                                                             
         BRAS  RE,GOSPL                                                         
*                                                                               
         L     R4,NEXTADDR         FORMATTED COMMENTS ARE HERE                  
*                                                                               
PRT60    LA    R0,9                                                             
         LA    R1,P1                                                            
*                                                                               
PRT64    CLI   0(R4),0             TEST REACHED END OF COMMENTS                 
         BE    PRT66                                                            
         MVC   3(60,R1),0(R4)                                                   
         BRAS  RE,GOSPL                                                         
         LA    R4,60(R4)                                                        
         BCT   R0,PRT64                                                         
*                                                                               
PRT66    CLI   0(R4),0             TEST DONE                                    
         BNE   PRT60                NO                                          
*                                                                               
* PRINT MIDLINES HERE FOR PAGE 1 ONLY AS PRINT LINES *                          
*                                                                               
         MVI   P,0                                                              
*                                                                               
         L     RE,=A(MIDLINE)                                                   
         A     RE,SPTR63RR                                                      
         MVC   P2+2(L'MIDLINE),0(RE)                                            
         CLI   SVTN3PR3,C'N'       PRINT CMML RUN TIMES?                        
         BNE   PRT70                                                            
                                                                                
         LA    R1,P2+2+L'MIDLINE                                                
         SHI   R1,19                                                            
         MVC   0(19,R1),SPACES     CLEAR CMML RUN TIMES HEADING                 
                                                                                
PRT70    MVI   P3,0                FORCE SPACE                                  
*                                                                               
         BRAS  RE,GOSPL                                                         
*                                                                               
         DROP  R5                                                               
*                                                                               
         L     R5,APATABLE                                                      
         USING PATABLED,R5                                                      
         SPACE 3                                                                
*---------------------------------*                                             
* PRINT ALL UNITS ON INSTRUCTIONS *                                             
*---------------------------------*                                             
         BRAS  RE,BLIN              GO BUILD PRINT LINE(S)                      
         BRAS  RE,PCOM              GO PRINT COMMENTS                           
         EJECT                                                                  
* PRINT CLIENT, PRODUCT, AND PROGRAM LISTS *                                    
*                                                                               
PRT85    CLI   SVTNPR11,C'Y'       DO NOT PRINT DISTRIBUTION LIST               
         BE    PRT105D                                                          
*                                                                               
         L     R2,NEXTADDR         LIST BUILD AREA                              
         MVC   0(8,R2),=CL8'*CPYLST*'                                           
         LA    R2,8(,R2)                                                        
         ST    R2,ASVCPYLS                                                      
         LR    R1,R2                                                            
         L     RE,AIO3                                                          
         AHI   RE,-8                                                            
         SR    RE,R1                                                            
         CHI   RE,250                                                           
         BNL   *+6                                                              
         DC    H'0'                                                             
PRT88    XC    0(250,R1),0(R1)     CLEAR                                        
         LA    R1,250(,R1)                                                      
         AHI   RE,-250                                                          
         BZ    PRT94                                                            
         CHI   RE,250                                                           
         BNL   PRT88                                                            
         EX    RE,*+8                                                           
         B     *+10                                                             
         XC    0(0,R1),0(R1)                                                    
*                                                                               
* PRINT DISTRIBUTION LIST IF ANY                                                
*                                                                               
PRT94    BRAS  RE,INITSPT          SET FROM NET TO SPOT                         
         XC    KEY,KEY                                                          
*                                                                               
         OC    SVDLDSK,SVDLDSK     ANY DISK ADDRESS                             
         BZ    PRT105              NO, DIST LIST TO PRINT                       
*                                                                               
         MVC   KEY+14(4),SVDLDSK                                                
*                                                                               
         L     R6,AIO1             USE IO1 FOR DISTR LIST RECORD                
         ST    R6,AIO                                                           
         GOTO1 GETREC                                                           
*                                                                               
         XC    SVDLDSK,SVDLDSK     CLEAR DISK ADDRESS                           
*                                                                               
* DISTRIBUTION LIST *                                                           
*                                                                               
PRT98    DS    0H                                                               
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT104                                                           
PRT99    SR    R4,R4                                                            
         B     *+8                                                              
PRT101   BRAS  RE,NEXTEL                                                        
         BNE   PRT104                                                           
         XC    0(30,R2),0(R2)                                                   
         CLI   1(R6),4             EMPTY DISTRIB NAME ELEM                      
         BE    PRT102                                                           
         MVC   0(30,R2),3(R6)                                                   
*                                                                               
PRT102   LA    R2,30(,R2)                                                       
         LA    R4,1(,R4)                                                        
         B     PRT101                                                           
*                                                                               
* FORCE EVEN ALIGNMENT OF LISTS *                                               
*                                                                               
PRT104   STC   R4,WORK             FORCE EVEN LIST                              
         TM    WORK,1              IF ODD, FORCE EXTRA ENTRY                    
         BZ    *+14                                                             
         XC    0(30,R2),0(R2)      BLANK ENTRY                                  
         LA    R2,30(,R2)                                                       
*                                                                               
         XC    0(60,R2),0(R2)      FORCE BLANK LINE BETWEEN LISTS               
         LA    R2,60(,R2)                                                       
*                                                                               
* PRODUCT LISTS - FOR ALL PRODUCTS IN INSTRUCTIONS *                            
*                                                                               
PRT105   ST    R2,APCPY           SAVE TO SEE IF ANY LIST FOUND                 
*                                                                               
PRT105D  L     R4,AIO3                                                          
         LR    R5,R4                                                            
         SR    R6,R6                                                            
         LA    R0,SVPRDLEN                                                      
PRT105K  CLI   0(R4),0                                                          
         BE    PRT108                                                           
         LA    R4,SVPRDENT(,R4)                                                 
         LA    R6,1(,R6)                                                        
         BCT   R0,PRT105K                                                       
*                                                                               
PRT108   LTR   R6,R6                                                            
         BNZ   PRT110                                                           
         DC    H'0'                                                             
PRT110   GOTO1 XSORT,DMCB,AIO3,(R6),SVPRDENT,3,0                                
*                                                                               
         BAS   RE,PTX                                                           
         CLI   SVTNPR11,C'Y'       DO NOT PRINT DISTRIBUTION LIST               
         BE    PRT150                                                           
*                                                                               
         SR    R4,R4                                                            
*                                                                               
         XC    KEY,KEY                                                          
         OC    SVDLDSK,SVDLDSK     ANY DISK ADDRESS                             
         BZ    PRT130              NO DIST LIST TO PRINT                        
*                                                                               
         MVC   KEY+14(4),SVDLDSK                                                
         L     R6,AIO1             USE IO1 FOR DISTRIBUTION LIST REC            
         ST    R6,AIO                                                           
         GOTO1 GETREC                                                           
*                                                                               
         XC    SVDLDSK,SVDLDSK     CLEAR DISK ADDRESS                           
*                                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PROD GROUP                        
         BZ    PRT126                                                           
*                                                                               
PRT126   MVC   0(4,R5),SVDLDSK     SAVE DISK ADDR                               
*                                                                               
* CHECK ANY OTHER EQUAL PRD LISTS *                                             
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,FEQ                                                           
         BE    PRT132                                                           
*                                                                               
         BRAS  RE,GETEL                                                         
         BE    *+10                                                             
         DC    H'0'                                                             
PRT128   BRAS  RE,NEXTEL                                                        
         BNE   PRT130                                                           
         XC    0(30,R2),0(R2)                                                   
         CLI   1(R6),4             EMPTY DISTRIB NAME ELEM                      
         BE    PRT129                                                           
         MVC   0(30,R2),3(R6)                                                   
*                                                                               
PRT129   LA    R2,30(,R2)                                                       
         LA    R4,1(,R4)                                                        
         B     PRT128                                                           
*                                                                               
PRT130   STC   R4,WORK             FORCE EVEN LIST                              
         TM    WORK,1              IF ODD, FORCE EXTRA ENTRY                    
         BZ    PRT131                                                           
         XC    0(30,R2),0(R2)      BLANK ENTRY                                  
         LA    R2,30(,R2)                                                       
         LA    R4,1(,R4)                                                        
PRT131   OC    OPTPRGR,OPTPRGR     RUNNING BY PROD GROUP                        
         BNZ   PRT134X              YES                                         
         B     *+10                                                             
*                                                                               
PRT132   XC    0(SVPRDENT,R5),0(R5)        CLEAR PRD NO (OR EQ) LIST            
         LA    R5,SVPRDENT(,R5)             NEXT PRODUCT                        
         L     R1,AIO3            SVPRDLST                                      
         LA    R1,480(,R1)                                                      
         CR    R5,R1                                                            
         BNL   PRT134                                                           
         OC    0(SVPRDENT,R5),0(R5)                                             
         BNZ   PRT132                                                           
*                                                                               
* SEE IF ANY PRODUCT LIST FOUND *                                               
*                                                                               
PRT134   C     R2,APCPY                                                         
         BE    *+14                                                             
         XC    0(60,R2),0(R2)      FORCE BLANK LINE BETWEEN LISTS               
         LA    R2,60(,R2)                                                       
*                                                                               
* PROGRAM LIST *                                                                
*                                                                               
PRT134X  XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A43'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(4),NETWORK                                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     ANY PROGRAM LIST                             
         BE    PRT136                                                           
         MVC   KEY(7),KEYSAVE                                                   
         XC    KEY+7(6),KEY+7                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   PRT140                                                           
PRT136   L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,GETEL                                                         
PRT137   B     *+8                                                              
PRT138   BRAS  RE,NEXTEL                                                        
         BNE   PRT140                                                           
         XC    0(30,R2),0(R2)                                                   
         CLI   1(R6),4             EMPTY DISTRIB NAME ELEM                      
*        BE    *+14                                                             
         BE    *+10                                                             
         MVC   0(30,R2),3(R6)                                                   
*                                                                               
         LA    R2,30(,R2)                                                       
         LA    R4,1(,R4)                                                        
         B     PRT138                                                           
         EJECT                                                                  
* CHECK IF ANY LIST TO PRINT *                                                  
*                                                                               
PRT140   STC   R4,WORK             FORCE EVEN LIST                              
         TM    WORK,1              IF ODD, FORCE EXTRA ENTRY                    
         BZ    *+18                                                             
         XC    0(30,R2),0(R2)      BLANK ENTRY                                  
         LA    R2,30(,R2)                                                       
         LA    R4,1(,R4)                                                        
         CLI   KEY,X'26'           SEE IF DOING DAYPART REC                     
         BE    *+8                  YES                                         
         B     PRT149              GO DO DAYPART                                
*                                                                               
PRT143   C     R2,ASVCPYLS         ANY LIST  TO PRINT                           
         BE    PRT150               NO                                          
         L     RE,ASVCPYLS         DBL CK IF LIST EMPTY                         
         OC    0(30,RE),0(RE)                                                   
         BNZ   PRT145                                                           
         LA    RE,30(,RE)                                                       
         CR    RE,R2                                                            
         BL    *-16                                                             
         B     PRT150                                                           
*                                                                               
PRT145   MVC   P+2(10),=CL10'COPIES TO:'                                        
         L     R4,ASVCPYLS                                                      
*                                                                               
* COUNT LINES REQUIRED FOR COPY LIST *                                          
*                                                                               
         LR    R1,R4                                                            
         SR    R0,R0                                                            
         CR    R1,R2               AT END?                                      
         BNL   *+12                                                             
         LA    R1,30(,R1)                                                       
         BCT   R0,*-10                                                          
         BCTR  R0,0                ADD ONE FOR ODD LINE                         
         LPR   R0,R0                                                            
         SRL   R0,1                DIVIDE BY 2 (PER LINE)                       
         STC   R0,ALLOWLIN                                                      
*                                                                               
         LA    R6,P+50                                                          
         LA    R5,P+14                                                          
PRT146   CLC   0(30,R4),=CL30'@ '                                               
         BE    *+10                                                             
         MVC   0(30,R5),0(R4)                                                   
         LA    R5,35(,R5)                                                       
         CR    R5,R6                                                            
         BL    PRT148                                                           
         LA    R5,P+14                                                          
         BRAS  RE,GOSPL                                                         
PRT148   LA    R4,30(,R4)                                                       
         CR    R4,R2                                                            
         BL    PRT146                                                           
         CLC   P,SPACES                                                         
         BE    PRT150                                                           
         BRAS  RE,GOSPL                                                         
         B     PRT150                                                           
*                                                                               
* GET NAME LIST FROM DAYPART RECORD *                                           
*                                                                               
PRT149   DS   0H                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         MVI   KEY,X'26'           RECORD ID                                    
         MVC   KEY+1(1),BAGYMD     AGY/MED                                      
         MVC   KEY+2(4),NETWORK                                                 
         MVC   KEY+6(1),SVDPC                                                   
         MVC   KEY+7(6),SVPRGPRG                                                
*                                                                               
         MVC   KEYSAVE,KEY                                                      
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(13),KEYSAVE      ID/AM/NETWORK/DPC/PROGRAM                   
         BE    PRT149A              YES                                         
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    KEY+6(1),KEY+6        NO DAYPART                                 
         MVC   KEYSAVE,KEY                                                      
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(13),KEYSAVE      ID/AM/NETWORK/PROGRAM                       
         BE    PRT149A                                                          
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    KEY+7(6),KEY+7        NO PROGRAM                                 
         MVC   KEY+6(1),SVDPC        PUT BACK DAYPART                           
         MVC   KEYSAVE,KEY                                                      
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(13),KEYSAVE      ID/AM/NETWORK/DPC                           
         BE    PRT149A                                                          
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    KEY+6(7),KEY+6        NO DAYPART AND NO PROGRAM                  
         MVC   KEYSAVE,KEY                                                      
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(13),KEYSAVE      ID/AM/NETWORK                               
         BNE   PRT143                                                           
*                                                                               
* NAME LIST *                                                                   
*                                                                               
PRT149A  C     R2,APCPY                                                         
         BE    *+14                                                             
         XC    0(60,R2),0(R2)                                                   
         LA    R2,60(R2)           FORCE BLANK LINE                             
*                                                                               
         L     R6,AIO3                                                          
         GOTO1 (RF),(R1),=C'GETREC',=C'UNTFIL',KEY+21,(R6),DMWORK               
         CLC   KEY(7),0(R6)                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R6,27(R6)           DISP TO THE ELEM                             
         MVI   ELCODE,X'20'        NAME LIST                                    
         BRAS  RE,FIRSTEL                                                       
         B     PRT137              GET ELEMENT                                  
*                                                                               
         TM    SVOPTSW1,OPT1EACH   EACH PROG ON SEP LETTER                      
         BO    PRT160                                                           
*                                                                               
PRT150   DS    0H                                                               
*****************************************************                           
* NOPPED PRT150 - PRT160                       ******                           
* PROGRAMS COVERED BY SCHEDULE FOR NOW         ******                           
* LETS SEE IF ANYONE WANTS IT BACK             ******                           
*****************************************************                           
*                                                                               
*&&DO                                                                           
*                                                                               
* PRINT PROGRAMS COVERED BY THIS LETTER *                                       
*                                                                               
PRT150   CLI   SVTN1PRG,C'Y'       PRINT SCHEDULE SUMMARY                       
*TEMP    BE    *+12                 YES                                         
         CLI   SVTN1PR3,C'Y'       SUPPRESS PROGRAMS COVERED BY                 
*NOP     BE    PRT160               YES                                         
         B     PRT160               *TEMP (REMOVE COVERED BY SCHEDULE)          
         SR    R0,R0                                                            
         L     R5,APRGTBLE                                                      
         USING PRGTABLD,R5                                                      
PRT154   TM    PRGFLG,X'10'        WERE INSTR SEL FOR THIS PROG                 
         BZ    *+6                                                              
         BCTR  R0,0                                                             
         LA    R5,PRGNEXT                                                       
         OC    0(4,R5),0(R5)       EOL                                          
         BNZ   PRT154               NO                                          
         LA    R1,1                                                             
         LPR   R0,R0                                                            
         CR    R1,R0                                                            
         BE    PRT160                                                           
         BRAS  RE,GOSPL                                                         
         LA    R2,P                                                             
         USING PRTLINE,R2                                                       
*                                                                               
         CLI   SVTN1PRG,C'Y'       PRINT SCHEDULE SUMMARY                       
         B     PRT155               *TEMP                                       
         BNE   PRT155               NO                                          
         MVC   PFEED(22),=C'***SCHEDULE SUMMARY***'                             
         MVC   PFEED+132(7),=C'PROGRAM'                                         
         MVC   PFEED+132+7(20),=C'--------------------'                         
         MVC   PFEED+132+27(4),=C'DATE'                                         
         MVC   PFEED+132+31(3),=C'---'                                          
         MVC   PFEED+132+34(7),=C'PRODUCT'                                      
         MVC   PFEED+132+41(20),=C'--------------------'                        
         MVC   PFEED+132+62(3),=C'LEN'                                          
         MVC   PFEED+132+65(6),=C'------'                                       
         MVC   PFEED+132+71(4),=C'COST'                                         
         MVC   PFEED+132+75(6),=C'------'                                       
         MVC   PFEED+132+81(15),=C'NUMBER OF UNITS'                             
         B     PRT155C                                                          
*                                                                               
PRT155   MVC   PPROG(16),=C'PROGRAMS COVERED'                                   
         MVC   PPROG+17(11),=C'BY SCHEDULE'                                     
         MVC   PPROG+132(16),=C'----------------'                               
         MVC   PPROG+132+16(12),=C'------------'                                
PRT155C  BRAS  RE,GOSPL                                                         
         L     R5,APRGTBLE                                                      
PRT156   TM    PRGFLG,X'10'        WERE INSTR SEL FOR THIS PROG                 
         BZ    PRT158                                                           
*                                                                               
         BRAS  RE,INITSPT          SET FROM NET TO SPOT                         
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,PRGPRG                                                  
         MVC   NPGKEND,PRGHIDTE                                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'92'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPGEL92,R6                                                       
         CLI   SVTN1PRG,C'Y'       PRINT SCHEDULE SUMMARY                       
         B     PRT157               *TEMP                                       
         BNE   PRT157               NO, PRINT PROG COVERED BY                   
*                                                                               
         MVC   PFEED(L'NPGNAME),NPGNAME                                         
         MVC   PFEED+L'NPGNAME+2(6),PRGPRG                                      
*                                                                               
         LH    R0,PRGUNITS         UNITS                                        
         AH    R0,PRGFEEDS         PLUS FEEDS                                   
         LH    RE,PRGUNAS          UNASSIGNED                                   
         AH    RE,PRGUNAL          PLUS UNALLOCATED                             
         SR    R0,RE               GET TOTAL UNITS FOR THIS PROGRAM             
         EDIT  (R0),(4,PFEED+82),ZERO=NOBLANK                                   
*                                                                               
         B     PRT157C                                                          
*                                                                               
PRT157   MVC   PPROG,NPGNAME                                                    
         MVI   PFEED,C'('                                                       
         MVC   PFEED+1(6),PRGPRG                                                
         LA    R1,PFEED+6                                                       
         CLI   0(R1),C' '                                                       
         BH    *+8                                                              
         BCT   R1,*-8                                                           
         MVI   1(R1),C')'                                                       
PRT157C  BRAS  RE,GOSPL                                                         
*                                                                               
PRT158   LA    R5,PRGNEXT                                                       
         OC    0(4,R5),0(R5)       EOL                                          
         BNZ   PRT156               NO                                          
*                                                                               
         DROP  R2,R4,R6                                                         
*                                                                               
*&&                                                                             
*                                                                               
*--------------------------------------------------                             
*    PRINT ADDITIONAL COMMERCIAL INFORMATION HERE                               
*--------------------------------------------------                             
                                                                                
PRT160   L     R4,ACMLTAB                                                       
         USING CMLCMLD,R4                                                       
         CLI   0(R4),0                                                          
         BE    *+8                  NOTHING TO PRINT                            
         BRAS  RE,PACML                 PRINT ADDITIONAL CML INFO               
*                                                                               
         TM    SVFLAG,SVTAG        THERE ARE TAGS ON INSTR                      
         BZ    PRT167                                                           
         NI    SVFLAG,X'FF'-SVTAG                                               
         MVI   P,0                                                              
         MVC   P2+2(39),=C'***THERE ARE TAG(S) ON INSTRUCTIONS ***'             
         BRAS  RE,GOSPL                                                         
*                                                                               
PRT167   BRAS  RE,PSTEXT              GO PRINT SPECIAL TEXT                     
*                                                                               
         BRAS  RE,INITNET          SET FROM SPOT TO NET                         
                                                                                
* IF EVER NEED TO PRINT FOOTLINES AT END OF REPORT *                            
*        MVI   CONTINUE,C'N'                                                    
*        MVI   FORCEFUT,C'Y'                                                    
*        MVC   P,SPACES                                                         
*        GOTO1 =A(GOSPL),RR=SPTR63RR                                            
*                                                                               
         MVC   TSRKEYL,PRTCT       SAVE LAST TSAR KEY NUMBER                    
*                                                                               
*---------------------------*                                                   
* UPDATE REVISION RECORD(S) *                                                   
*---------------------------*                                                   
*                                                                               
         BRAS  RE,UPDR                                                          
*                                                                               
         CLI   SVTWPR06,C'N'       EASYLINK TRANSMISSION                        
         BE    PRTXIT               NO                                          
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    PRTXIT                                                           
*                                                                               
         CLI   OFFLINE,C'Y'        ONLINE ?                                     
         BNE   PRTXIT              YES, DONE (MULTI-FAX NOT SUPPORTED)          
*                                                                               
         TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BZ    PRTXIT               NO                                          
*                                                                               
         CLI   SVTWPR06,C'Y'       EASYLINK TRANSMISSION                        
         BE    PRT168               YES                                         
*                                                                               
         TM    WHEN,X'20'          THIS A SOON RUN                              
         BZ    PRTXIT               NO                                          
*                                                                               
PRT168   MVC   P1(26),=C'*** END OF DDS MESSAGE ***'                            
         MVI   LINE,2                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
* BLANK THE HEADLINES NOW *                                                     
*                                                                               
         LA    R0,14                                                            
         LA    R1,H1                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
         MVC   MID1,SPACES                                                      
*                                                                               
PRT170   TM    UPDSW,MULTIFAX                                                   
         BZ    PRTXIT                                                           
*                                                                               
         BRAS  RE,GTSPL                                                         
         B     PRT170                                                           
*                                                                               
PRTXIT   XIT1                                                                   
         EJECT                                                                  
*                                                                               
* GET CLIENT DISTRIBUTION RECORD IF ANY                                         
*                                                                               
GCLTLIST NTR1                                                                   
*                                                                               
         MVC   KEY(2),=X'0A41'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(3),QCLT                                                    
         MVC   KEY+6(4),NETWORK                                                 
*                                                                               
GCLT10   MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    GCLT20                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         OC    KEY+6(4),KEY+6      DID WE LOOK FOR NON-NET RECORD               
         BZ    GCLTNE               YES, DONE                                   
*                                                                               
         XC    KEY+6(4),KEY+6      LOOK FOR NON-NETWORK SPECIFIC                
         B     GCLT10                                                           
*                                                                               
GCLT20   MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVC   SVDLDSK,KEY+14      SAVE DISTRIBUTION LIST DISK ADDRESS          
*                                                                               
         CR    RB,RB               SET QE CC                                    
         J     EXIT                                                             
*                                                                               
GCLTNE   CR    RB,RC               SET NE CC                                    
         J     EXIT                                                             
*                                                                               
         DROP  R4                                                               
*                                                                               
* GET PGROUP RECORD IF ANY                                                      
*                                                                               
GPGRLIST NTR1                                                                   
*                                                                               
         LA    R4,KEY                                                           
         USING PGRKEY,R4                                                        
         MVC   PGRKID,=XL2'0A45'   PGROUP NAME LIST RECORD                      
         MVC   PGRKAM,BAGYMD                                                    
         MVC   PGRKCLT,BCLT                                                     
         MVC   PGRKGRP,PGROUP                                                   
         MVC   PGRKNET,NETWORK                                                  
*                                                                               
GPGR10   MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     PROD GROUP LIST RECORD?                      
         BE    GPGR30                                                           
         MVC   KEY(13),KEYSAVE                                                  
         CLC   PGRKNET,NETWORK     ARE WE DOING NETWORK                         
         BNE   GPGR20                                                           
         XC    PGRKNET,PGRKNET                                                  
         MVC   PGRKNET+1(1),SVMEDIA    NOW DO BY MEDIA                          
         MVI   PGRKNET+2,X'FF'                                                  
         B     GPGR10                                                           
*                                                                               
GPGR20   CLI   PGRKNET+2,X'FF'     ARE WE DOING MEDIA                           
         BNE   GPGR25                                                           
         CLC   PGRKNET+1(1),SVMEDIA                                             
         BNE   GPGR25                                                           
*                                                                               
         XC    PGRKNET,PGRKNET     LOOK FOR NON-NETWORK SPECIFIC                
         B     GPGR10                                                           
*                                                                               
GPGR25   OC    PGRKNET,PGRKNET     ARE WE DOING ALL PGRLIST                     
         BZ    *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         CR    RB,RC               SET CC NE                                    
         J     EXIT                                                             
*                                                                               
GPGR30   MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVC   SVDLDSK,KEY+14      SAVE DISTRIBUTION LIST DISK ADDRESS          
*                                                                               
         CR    RB,RB               SET CC EQ                                    
*                                                                               
         J     EXIT                                                             
*                                                                               
         DROP  R4                                                               
*                                                                               
* READ  PRODUCT LIST RECORD IF ANY                                              
*                                                                               
RPRDLIST NTR1                                                                   
*                                                                               
         LA    R4,KEY                                                           
         USING PRDKEY,R4                                                        
         MVC   PRDKID,=XL2'0A42'   PRODUCT NAME LIST RECORD                     
         MVC   PRDKAM,BAGYMD                                                    
         MVC   PRDKCLT,BCLT                                                     
         MVC   PRDKPRD,OPTPROD                                                  
         MVC   PRDKNET,NETWORK                                                  
*                                                                               
RPRD10   MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST PROD GROUP LIST FOUND                   
         BE    RPRD30                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         CLC   PRDKNET,NETWORK     ARE WE DOING NETWORK                         
         BNE   RPRD20                                                           
         XC    PRDKNET,PRDKNET                                                  
         MVC   PRDKNET+1(1),SVMEDIA    NOW DO BY MEDIA                          
         MVI   PRDKNET+2,X'FF'                                                  
         B     RPRD10                                                           
*                                                                               
RPRD20   CLI   PRDKNET+2,X'FF'                                                  
         BNE   RPRD25                                                           
         CLC   PRDKNET+1(1),SVMEDIA    BY MEDIA                                 
         BNE   RPRD25                                                           
*                                                                               
         XC    PRDKNET,PRDKNET     LOOK FOR NON-NETWORK SPECIFIC                
         B     RPRD10                                                           
*                                                                               
RPRD25   OC    PRDKNET,PRDKNET     ARE WE DOING ALL PGRLIST                     
         BZ    *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         CR    RB,RC               SET CC NE                                    
         J     EXIT                                                             
*                                                                               
RPRD30   MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVC   SVDLDSK,KEY+14      SAVE DISTRIBUTION LIST DISK ADDRESS          
*                                                                               
         CR    RB,RB               SET CC EQ                                    
         J     EXIT                                                             
*                                                                               
         DROP  R4                                                               
*                                                                               
* SEE IF PRODUCT LIST REC, HAS CONTACT NAME AND TEL # *                         
* IF SO THEN OVERRIDE THE ONE GOTTEN FROM THE CLTLIST                           
*                                                                               
GPRDLIST NTR1                                                                   
*                                                                               
         L     R5,APATABLE                                                      
         USING PATABLED,R5                                                      
*                                                                               
         L     R1,AIO3             CLEAR SVPRDLST                               
         XC    0(240,R1),0(R1)                                                  
         XC    240(240,R1),240(R1)                                              
*                                                                               
         XC    WORK(L'SVISNAME),WORK SAVE AREA FOR CONTACT NAME                 
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A42'                                                  
         MVC   KEY+2(3),BAGYMD  AND BCLT                                        
         B     GPRD15                                                           
*                                                                               
GPRD10   LA    R5,PATNEXT                                                       
         C     R5,MAXPATBL         AT END OF TABLE                              
         BNL   GPRDX                                                            
*                                                                               
GPRD15   OC    PATENT,PATENT       EMPTY ENTRY                                  
         BZ    GPRDX                YES, DONE                                   
*                                                                               
         CLI   PATPROD1,0          ANY PROD ?                                   
         BE    GPRD10               NO                                          
*                                                                               
         MVC   QPRD,PATPROD1                                                    
*                                                                               
* SEE IF PROCESSED THIS PRODUCT BEFORE                                          
*                                                                               
GPRD20   L     R1,AIO3                                                          
*                                                                               
GPRD22   CLI   0(R1),0                                                          
         BE    GPRD24                                                           
         CLC   QPRD,0(R1)          SAME PRDS ?                                  
         BNE   GPRD23               NO                                          
         CLC   QPRD,PATPROD2                                                    
         BNE   GPRD40                                                           
         B     GPRD10                                                           
*                                                                               
GPRD23   LA    R1,3(R1)                                                         
         B     GPRD22                                                           
*                                                                               
GPRD24   MVC   0(3,R1),QPRD                                                     
*                                                                               
         MVC   KEY+5(3),QPRD                                                    
         MVC   KEY+8(4),NETWORK                                                 
*                                                                               
GPRD26   DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     PRODUCT LIST RECORD?                         
         BE    GPRD26F                                                          
         MVC   KEY(13),KEYSAVE                                                  
         CLC   KEY+8(4),NETWORK    ARE WE DOING NETWORK                         
         BNE   GPRD26C                                                          
*                                                                               
         XC    KEY+8(4),KEY+8                                                   
         MVC   KEY+9(1),SVMEDIA    NOW DO BY MEDIA                              
         MVI   KEY+10,X'FF'                                                     
         B     GPRD26                                                           
*                                                                               
GPRD26C  DS    0H                                                               
         CLI   KEY+10,X'FF'        ARE WE DOING MEDIA                           
         BNE   GPRD26D                                                          
         CLC   KEY+9(1),SVMEDIA                                                 
         BNE   GPRD26D                                                          
         XC    KEY+8(4),KEY+8      NOW DO ALL PRDLIST                           
         B     GPRD26                                                           
*                                                                               
GPRD26D  OC    KEY+8(4),KEY+8      ARE WE DOING ALL PRDLIST                     
         BZ    GPRD10               YES, DONE ALL                               
         DC    H'0'                WHAT ARE WE DOING ???                        
*                                                                               
GPRD26F  DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
*                                                                               
         MVI   ELCODE,X'10'        CONTACT ELEMENT                              
         BRAS  RE,GETEL                                                         
         BNE   GPRD40                                                           
*                                                                               
         USING PRDCONEL,R6                                                      
*                                                                               
         CLC   PRDCONNM,SPACES                                                  
         BH    *+6                                                              
         DC    H'0'                MUST HAVE CONTACT NAME                       
*                                                                               
         OC    WORK(L'SVISNAME),WORK 1ST TIME AROUND ?                          
         BZ    GPRD30               YES                                         
*                                                                               
         CLC   PRDCONNM,WORK       SAME CONTACT NAME?                           
         BNE   CONTERR              NO ERROR                                    
         B     GPRD40                                                           
*                                                                               
GPRD30   MVC   WORK(L'SVISNAME),PRDCONNM                                        
         CLC   PRDCONTL(L'PRDCONTL+L'PRDFAXTL),SPACES                           
         BH    *+6                                                              
         DC    H'0'                MUST HAVE EITHER FAX OR TEL #                
*                                                                               
         MVC   SVISTEL,PRDCONTL                                                 
         MVC   SVFAXTL,PRDFAXTL                                                 
         XC    USERNAME,USERNAME                                                
         XC    USERADDR,USERADDR                                                
*                                                                               
         MVC   QPRD2,QPRD          SAVE PROD IN CASE OF ERROR                   
*                                                                               
GPRD40   CLI   PATPROD2,0                                                       
         BE    GPRD10                                                           
         MVC   QPRD,PATPROD2                                                    
         B     GPRD20                                                           
*                                                                               
GPRDX    OC    WORK(L'SVISNAME),WORK ANY CONTACT NAME?                          
         BZ    *+10                 NO                                          
         MVC   SVISNAME,WORK       MOVE IN CONTACT NAME                         
*                                                                               
         L     R1,AIO3                                                          
         XC    0(240,R1),0(R1)                                                  
         XC    240(240,R1),240(R1)                                              
*                                                                               
         XIT1                                                                   
*                                                                               
         DROP  R5,R6                                                            
         SPACE 3                                                                
CONTERR  MVC   GERROR,=Y(BDCONTC)                                               
         XC    ELEM,ELEM                                                        
         LA    R4,ELEM                                                          
         STCM  R4,7,GASUBST        A(SUBST TEXT)                                
         MVI   0(R4),4             L'SUBST TEXT + 1                             
         MVC   1(3,R4),QPRD                                                     
         MVI   4(R4),4             L'SUBST TEXT + 1                             
         MVC   5(3,R4),QPRD2                                                    
         LA    R2,TRACLTH                                                       
         GOTO1 VTRAERR                                                          
         EJECT                                                                  
* PRINT ANY TEXT BY PRODUCT *                                                   
*                                                                               
         DS   0H                                                                
PTX      NTR1                                                                   
*                                                                               
         LR    R4,R6               COUNT OF PRODUCTS                            
         L     R5,AIO3                                                          
*                                                                               
* READ PRODUCT TEXT RECORD *                                                    
*                                                                               
PTX10    XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A23'                                                  
         MVC   KEY+2(3),BAGYMD AND BCLT                                         
         MVC   KEY+5(3),0(R5)  AND PRODUCT                                      
         MVI   KEY+8,C'H'                                                       
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST TEXT FOUND                              
         BNE   PTX40                                                            
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   BYTE,0                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         MVI   ELCODE,X'40'                                                     
         BNE   PTX14                                                            
         MVC   BYTE,2(R6)                                                       
         SR    R2,R2                                                            
         SR    R3,R3                                                            
         BRAS  RE,NEXTEL                                                        
         BE    PTX12                                                            
         DC    H'0'                                                             
PTX12    LLC   RE,1(R6)                                                         
         CR    R2,RE                                                            
         BNL   *+6                                                              
         LR    R2,RE                                                            
         BCTR  R3,0                                                             
         BRAS  RE,NEXTEL                                                        
         BE    PTX12                                                            
         LCR   R3,R3                                                            
         STC   R3,ALLOWLIN                                                      
         TM    BYTE,X'80'         PUT IN BOXES                                  
         BZ    PTX14                                                            
         LA    R3,2(,R3)          2 MORE FOR 2 LINES OF ASTERISKS               
         STC   R3,ALLOWLIN                                                      
         MVI   P+PPROG-PRTLINE,C'*'                                             
         BCTR  R2,0                                                             
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   P+PPROG-PRTLINE+1(0),P+PPROG-PRTLINE                             
         BRAS  RE,GOSPL                                                         
*                                                                               
PTX14    L     R6,AIO1                                                          
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
PTX20    LLC   RE,1(R6)                                                         
         AHI   RE,-4                                                            
         TM    BYTE,X'80'          PUT IN BOXES                                 
         BO    PTX24                                                            
         EX    RE,*+8                                                           
         B     PTX28                                                            
         MVC   P+PPROG-PRTLINE(0),3(R6) *EXECUTED*                              
PTX24    MVI   P+PPROG-PRTLINE,C'*'                                             
         EX    RE,PTX26                                                         
         LA    R1,P+PPROG-PRTLINE+1(R2)                                         
         MVI   0(R1),C'*'                                                       
         B     PTX28                                                            
PTX26    MVC   P+PPROG-PRTLINE+2(0),3(R6)                                       
*                                                                               
PTX28    BRAS  RE,GOSPL                                                         
         BRAS  RE,NEXTEL                                                        
         BE    PTX20                                                            
*                                                                               
         TM    BYTE,X'80'          PUT IN BOXES                                 
         BZ    PTX30                                                            
         MVI   P+PPROG-PRTLINE,C'*'                                             
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   P+PPROG-PRTLINE+1(0),P+PPROG-PRTLINE                             
         BRAS  RE,GOSPL                                                         
*                                                                               
PTX30    MVI   SPACING,2                                                        
         BRAS  RE,GOSPL                                                         
*                                                                               
PTX40    LA    R5,SVPRDENT(,R5)           NEXT PRODUCT                          
         BCT   R4,PTX10                                                         
         B     PRTXIT                                                           
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
HEADING  SSPEC H1,3,AGYNAME                                                     
         SSPEC H2,3,AGYADD                                                      
*                                                                               
         SSPEC H1,39,C'NETWORK COMMERCIAL SCHEDULE'                             
         SSPEC H2,39,C'---------------------------'                             
         SSPEC H3,40,C'PERIOD'                                                  
*                                                                               
         SSPEC H1,85,REPORT                                                     
         SSPEC H2,85,RUN                                                        
         SSPEC H3,85,PAGE                                                       
         SSPEC H3,93,REQUESTOR                                                  
         DC    X'00'               END MARKER FOR SSPECS                        
         EJECT                                                                  
* MODEL DCB FOR AUTO REQUEST FILE-MOVED TO CORE RESIDENT AREA FOR USE           
         DS    0D                                                               
ERRFILE  DCB   BLKSIZE=3800,                                           X        
               DDNAME=ERRFILE,                                         X        
               DSORG=PS,                                               X        
               LRECL=38,                                               X        
               MACRF=PM,                                               X        
               RECFM=FB                                                         
*                                                                               
* DCB FOR OFF-LINE PRINT FILE, PRINT ONCE TO EASYLINK, ONCE TO                  
* NORMAL SPOOL FROM PRTFILE                                                     
*                                                                               
         DROP  RB,R7                                                            
         EJECT                                                                  
*------------------------------------------------------------------             
*  EASYLINK GETS A PRINT LINE WITH SOME FIXED INFO, AND FAX NUMBER *            
*------------------------------------------------------------------             
*                                                                               
EASILN   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVI   FORCEHED,C'N'       PREVENT HEADLINES                            
         MVI   LINE,2                                                           
         MVC   EDIORIG,AGYORIG                                                  
         MVC   EDIHDR,=CL5'*HDR*'                                               
*                                                                               
         MVC   EDIDESID(4),=C'FAXW'                                             
*                                                                               
         OC    SVTS,SVTS           TRAFFIC SUPPLIER?                            
         BZ    EASI10               NO                                          
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(6),SVPRGPRG    MOVE PROGRAM TO WORK                         
         BRAS  RE,GETTSUPP                                                      
         BE    *+6                                                              
         DC    H'0'                                                             
         BAS   RE,GETTSFAX           GET TRAFFIC SUPPLIER FAX NUMBER            
         MVC   EDIDESID+5(12),WORK+6 TSUPP FAX NUMBER                           
         MVC   EDIFDEST(12),WORK+6 TSUPP FAX NUMBER                             
         B     EASI12                                                           
*                                                                               
EASI10   L     R1,SVFAXNXT         GET NEXT FAX NUMBER                          
         MVC   EDIDESID+5(L'SVSFAX),0(R1)  PRODUCTION HOUSE FAX NUMBER          
         MVC   EDIFDEST(L'SVSFAX),0(R1)                                         
*                                                                               
         LA    R1,L'SVSFAX(R1)     BUMP TO NEXT FAX IN TABLE                    
         ST    R1,SVFAXNXT         SAVE NEXT FAX ADDRESS                        
*                                                                               
EASI12   MVC   EDIBILL(1),QMED    MEDIA                                         
         MVC   EDIBILL+1(3),QCLT    CLIENT                                      
         MVC   EDIBILL+4(4),NETWORK                                             
*                                                                               
         CLC   OPTPROD,SPACES      TN2: BY PRODUCT?                             
         BNH   *+18                 NO - CK BY PDT GP                           
         MVC   EDIBILL+4(3),OPTPROD                                             
         MVI   EDIBILL+7,C' '                                                   
         B     EASI15                                                           
*                                                                               
         OC    OPTPRGR,OPTPRGR    ANY PRODUCT GROUP                             
         BZ    EASI15               NO - BILL BY NET                            
         MVC   EDIBILL+4(1),SVTN2PRO+00                                         
         MVC   DUB(2),OPTPRGR                                                   
         MVI   DUB+2,X'0F'                                                      
         UNPK  DUB+3(5),DUB(3)                                                  
         MVC   EDIBILL+5(4),DUB+3                                               
*                                                                               
EASI15   GOTO1 SPOOL,DMCB,(R8)    SEND SPECIAL PRINT LINE                       
*                                                                               
         MVC   EDIDDSID(14),=C'++DDS NECRATRN'                                  
         MVC   EDINTCMD,QMED        MEDIA                                       
         MVC   EDINTCCL,QCLT        CLIENT                                      
         MVC   EDINTCNT,NETWORK                                                 
         MVC   EDINTCDT,PERDTS                                                  
*                                                                               
         GOTO1 SPOOL,DMCB,(R8)    SEND SPECIAL PRINT LINE                       
*                                                                               
         XIT1                                                                   
         EJECT                                                                  
* GET TRAFFIC SUPPLIER FAX NUMBER                                               
* (RETURNS FAX# IN WORK+6)                                                      
*                                                                               
GETTSFAX NTR1                                                                   
*                                                                               
*                                  DUMMY READ HIGH FOR GETREC                   
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
*                                                                               
         L     R6,AIO                                                           
         GOTO1 DATAMGR,DMCB,=C'GETREC',=C'UNTFIL',KEY+21,(R6),DMWORK            
         CLC   KEY(7),0(R6)                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R6,27(R6)           DISP TO THE ELEM                             
         MVI   ELCODE,X'20'        FAX # ELEM                                   
         BRAS  RE,FIRSTEL                                                       
         BNE   NOFAXERR            MUST HAVE A FAX #                            
*                                                                               
         USING TSUPNOEL,R6                                                      
*                                                                               
         LA    R1,WORK+6                                                        
         CLI   TSUPNO1,0                                                        
         BE    *+14                                                             
         MVC   0(1,R1),TSUPNO1     PREFIX                                       
         LA    R1,1(R1)                                                         
*                                                                               
         MVC   0(L'TSUPNOA,R1),TSUPNOA  AREA CODE                               
         LA    R1,L'TSUPNOA(R1)                                                 
         MVC   0(L'TSUPNOE,R1),TSUPNOE  EXCHANGE                                
         LA    R1,L'TSUPNOE(R1)                                                 
         MVC   0(L'TSUPNON,R1),TSUPNON  NUMBER                                  
*                                                                               
         L     R6,AIO                                                           
         LA    R6,27(R6)           DISP TO THE ELEM                             
         MVI   ELCODE,X'10'        CONTACT NAME ELEM                            
         BRAS  RE,FIRSTEL                                                       
         BNE   *+10                                                             
         MVC   SVCNAME,2(R6)       SAVE CONTACT NAME                            
         XIT1                                                                   
         EJECT                                                                  
NOFAXERR DS    0H                                                               
         LA    R2,TRAOPTH                                                       
         MVC   GERROR,=Y(BDTSOPT)                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         LLC   RE,SVTSLEN          TEXT LENGTH                                  
         LA    RE,3(RE)            PLUS 3 (2 FOR () PLUS 1)                     
         STC   RE,ELEM             L'SUBST TEXT+1                               
         BCTR  RE,0                BACK TO ACTUAL TEXT LENGTH                   
         MVI   ELEM+1,C'('                                                      
         MVC   ELEM+2(L'SVTS),SVTS                                              
         LA    RE,ELEM(RE)                                                      
         MVI   0(RE),C')'                                                       
         MVI   1(RE),16                                                         
         MVC   2(16,RE),=C'FAX # NOT FOUND'                                     
*                                                                               
         GOTO1 VTRAERR                                                          
*                                                                               
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
*--------------------------------------------------------------------           
* PRINT AGY COPY TO TSAROFF OFFLINE, TSAR ONLINE. FAX IS PRODUCED 1ST           
*--------------------------------------------------------------------           
         DS    0H                                                               
GOSPL    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         TM    ANYFLAG,BLNKLN      JUST PRINTED BLANK LINE                      
         BZ    GOSPL03                                                          
*                                                                               
         LA    RE,P1               SEE IF ANY PRINT LINES ARE NON BLANK         
         LA    R0,4                                                             
GOSPL02  CLC   0(130,RE),SPACES                                                 
         BH    GOSPL03                                                          
         LA    RE,132(RE)                                                       
         BCT   R0,GOSPL02                                                       
                                                                                
         NI    ANYFLAG,X'FF'-BLNKLN TURN OFF PRINTED BLANK LINE                 
         B     GOSPLX              SKIP PRINTING                                
*                                                                               
GOSPL03  TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BO    *+12                                                             
         TM    WHEN,X'20'          IS THIS SOON                                 
         BO    GOSPL60              YES                                         
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   GOSPL60                                                          
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    GOSPL60                                                          
         CLI   SVTWPR06,C'2'       AGY HARD COPY                                
         BE    *+20                                                             
         CLI   SVTWPR06,C'Y'       FAX                                          
         BNE   GOSPL60                                                          
         TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BZ    GOSPL60                                                          
                                                                                
         LA    RE,P                                                             
         LA    RF,528                                                           
         LR    R1,RF                                                            
         L     R0,AIO1                                                          
         AHI   R0,1472                                                          
         LR    R3,R0                                                            
         MVCL  R0,RE                                                            
         LLC   R0,SPACING                                                       
*                                                                               
* TSAROFF - WRITE TO HIGH STORAGE HERE                                          
*                                                                               
         LHI   R2,TSARBLK-SYSD                                                  
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
         LA    R4,4                                                             
         SR    R5,R5                                                            
*                                                                               
* FIND ADDRESS OF LAST LINE TO PRINT                                            
*                                                                               
         LR    R1,R4                                                            
         LA    R6,396(,R3)                                                      
GOSPL24  OC    0(132,R6),0(R6)                                                  
         BZ    GOSPL26                                                          
         CLC   0(132,R6),SPACES                                                 
         BNE   GOSPL30                                                          
GOSPL26  AHI   R6,-132                                                          
         BCT   R1,GOSPL24                                                       
*                                                                               
GOSPL30  XC    ELEM(256),ELEM                                                   
*                                                                               
         LA    RE,132              MAX PRINT POSITIONS                          
         LA    RF,131(,R3)         POINT TO END OF PRINT LINE                   
GOSPL34  CLI   0(RF),C' '                                                       
         BH    GOSPL40                                                          
         CLI   0(RF),0             FORCE LINE                                   
         BE    GOSPL40              YES                                         
         BCTR  RF,0                                                             
         BCT   RE,GOSPL34                                                       
*                                                                               
         LA    R5,1(,R5)           ADD TO SKIPPED LINE CT                       
*                                                                               
         OC    ELEM+4(2),ELEM+4    IS FORCE HEAD OR SPACING ON                  
         BNZ   GOSPL44              YES                                         
         B     GOSPL50             BYPASS EMPTY LINE                            
*                                                                               
GOSPL40  LTR   RE,RE                                                            
         BZ    *+6                                                              
         BCTR  RE,0                                                             
         EX    RE,GOSPLMVC                                                      
*                                                                               
         STC   R5,ELEM+4           SAVE ANY SKIPPED LINE CT                     
         SR    R5,R5               SET TO ZERO                                  
*                                                                               
GOSPL44  LA    RE,7(,RE)                                                        
         STCM  RE,3,ELEM           REC LENGTH                                   
*                                                                               
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE                                                      
*                                                                               
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2         KEY                                          
         LA    R1,ELEM                                                          
         ST    R1,TSAREC                                                        
*                                                                               
         CR    R3,R6               THIS LAST LINE TO PRINT                      
         BL    GOSPL46              NO                                          
         STC   R0,ELEM+5           SAVE SPACING                                 
*                                                                               
GOSPL46  DS   0H                                                                
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,(R2)                                                     
*                                                                               
         CLI   TSERRS,0                                                         
         BE    GOSPL50                                                          
         DC    H'0'                                                             
*                                                                               
GOSPL50  LA    R3,132(,R3)                                                      
         BCT   R4,GOSPL30                                                       
         DROP  R2                                                               
*                                                                               
GOSPL60  GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
GOSPLX   XIT1                                                                   
GOSPLMVC MVC   ELEM+6(0),0(R3)                                                  
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
*----------------------------------------                                       
* PRINT MULTI-FAX RECORD FROM TSAROFF                                           
*----------------------------------------                                       
         DS    0H                                                               
GTSPL    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         SR    R0,R0                                                            
         ST    R0,SPECS            NO HEADING SPECS                             
         ST    R0,HEADHOOK            HDHK                                      
         ST    R0,FOOTHOOK            FTHK                                      
*                                                                               
GTSPL02  BRAS  RE,EASILN                                                        
*                                                                               
         OC    SVTS,SVTS           FAX TO TRAFFIC SUPPLIER                      
         BNZ   GTSPL04                                                          
*                                                                               
         L     R5,SVFAXNXT                                                      
         OC    0(L'SVSFAX,R5),0(R5)                                             
         BNZ   *+12                                                             
         NI    UPDSW,X'FF'-MULTIFAX                                             
         B     GTSPL04                                                          
*                                                                               
         LA    R1,SVSFAX                                                        
         LA    R1,4*L'SVSFAX(R1)   BUMP TO THE LAST ENTRY                       
         CR    R5,R1               ARE WE AT THE END                            
         BL    *+8                                                              
         NI    UPDSW,X'FF'-MULTIFAX                                             
*                                                                               
GTSPL04  LHI   R2,TSARBLK-SYSD                                                  
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
*                                                                               
         XC    ELEM(256),ELEM                                                   
         LA    R0,ELEM                                                          
         ST    R0,TSAREC           SET ADDRESS OF THE RECORD                    
*                                                                               
         LH    R1,TSRKEYF                                                       
         LA    R1,1(R1)                                                         
         STCM  R1,3,ELEM+2         KEY                                          
         SR    R5,R5               PAGE #                                       
*                                                                               
         MVI   TSOFFACT,TSARDH      SET GET BY KEY                              
*                                                                               
GTSPL10  GOTO1 TSAROFF,(R2)                                                     
*                                                                               
GTSPL15  TM    TSERRS,X'90'        END OF FILE                                  
         BNZ   GTSPL40                                                          
         CLI   TSERRS,0                                                         
         BE    GTSPL20                                                          
         DC    H'0'                                                             
GTSPL20  DS    0H                                                               
         CLI   ELEM+4,C'Y'         IS THERE ANY FORCEHED                        
         BE    GTSPL28              YES                                         
         CLI   ELEM+4,0            IS THERE ANY SPACING BEFORE                  
         BE    GTSPL30              NO                                          
         MVC   SPACING,ELEM+4                                                   
         MVI   ELEM+4,0            SET OFF FOR LATER                            
         MVI   P1,0                                                             
*                                                                               
         GOTO1 SPOOL,DMCB,(R8)                                                  
         B     GTSPL30                                                          
*                                                                               
GTSPL28  LA    R5,1(R5)            INCREMENT PAGE #                             
         CH    R5,=H'1'            FORCE /PAGE ON ALL PAGES BUT PAGE 1.         
         BNH   GTSPL30                                                          
         MVC   P1(5),=C'/PAGE'                                                  
         MVI   FORCEHED,C'Y'                                                    
         MVI   ELEM+4,0             RESET FOR LATER                             
         MVI   LINE,1               I MUST RESET LINE                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
GTSPL30  SR    R1,R1                                                            
         ICM   R1,3,ELEM           RECORD LENGTH                                
         SH    R1,=H'7'                                                         
         EX    R1,GTSPMVC                                                       
         CLI   ELEM+4,0            IS THERE ANY FORCEHED                        
         BE    *+10                                                             
         MVC   FORCEHED,ELEM+4                                                  
*                                                                               
         CLI   ELEM+5,0            IS THERE ANY SPACING                         
         BE    *+10                                                             
         MVC   SPACING,ELEM+5                                                   
*                                                                               
         CLC   P1,SPACES                                                        
         BNE   *+6                                                              
         DC    H'0'                                                             
         OC    P1,P1                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
* KILL IMFAMOUS AND SPURIOUS FAKE STUFF *                                       
*                                                                               
         CLC   P1+7(17),=C'** AGENCY COPY **'                                   
         BNE   *+10                                                             
         MVC   P1+7(17),SPACES                                                  
*                                                                               
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
         ZICM  R1,ELEM+2,2                                                      
         CH    R1,TSRKEYL          CHECK FOR LAST PRT LINE                      
         BE    GTSPL40                                                          
*                                                                               
         MVI   TSOFFACT,TSANXT            SET GET NEXT RECORD                   
         B     GTSPL10                                                          
*                                                                               
GTSPL40  DS    0H                                                               
         MVI   P1,0                                                             
         MVC   P2(26),=C'*** END OF DDS MESSAGE ***'                            
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
         XIT1                                                                   
GTSPMVC  MVC   P1(0),ELEM+6                                                     
         DROP  R2,RB                                                            
         EJECT                                                                  
*--------------------------------                                               
* VALIDATE NETWORK                                                              
*--------------------------------                                               
         DS    0H                                                               
VNET     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R2,TRANETH          NETWORK                                      
*                                                                               
         CLI   5(R2),3                                                          
         BNE   VNET25                                                           
         CLC   =C'ALL',8(R2)                                                    
         BNE   VNET25                                                           
*                                                                               
         MVC   WORK(L'SVNET),SVNET                                              
         B     VNET30                                                           
*                                                                               
VNET25   GOTO1 ANY                                                              
*                                                                               
VNET30   MVI   KEY,C'0'                                                         
         MVC   KEY+1(16),KEY       PRE-FILL THE KEY WITH ZEROES                 
         LA    R4,KEY                                                           
         USING STARECD,R4                                                       
         MVI   STAKTYPE,C'S'                                                    
         MVI   STAKMED,C'N'                                                     
         MVC   STAKCALL(4),WORK                                                 
         MVI   STAKCALL+4,C'N'                                                  
         MVC   STAKAGY,AGENCY                                                   
         MVC   STAKCLT,BCLT                                                     
         GOTO1 DATAMGR,DMCB,=C'DMREAD',=C'STATION',KEY,AIO                      
         CLI   8(R1),0                                                          
         BNE   NETERR                                                           
         MVC   NETWORK,WORK                                                     
         L     R4,AIO                                                           
         MVC   SVSMKT,SMKT         SAVE MARKET CODE                             
         PACK  DUB,SMKT                                                         
         CVB   R0,DUB                                                           
         STH   R0,NETMKT                                                        
         MVC   SVSFAX,SFAX                                                      
* PER MTG 7/16/08 DECIDED TO DUMP IF NEW TRFTYPE IS NOT SET                     
         CLI   STRTYPE,C' '                                                     
         BH    *+6                                                              
         DC    H'0'                                                             
         MVC   SVMEDIA,STRTYPE                                                  
         CLI   STRTYPE,C'N'                                                     
         BE    VNET40                                                           
         CLI   STRTYPE,C'C'                                                     
         BE    VNET40                                                           
         CLI   STRTYPE,C'S'                                                     
         BE    VNET40                                                           
         CLI   STRTYPE,C'O'                                                     
         BE    VNET40                                                           
         MVI   SVMEDIA,C'N'                                                     
*                                                                               
VNET40   OC    SVOPTMED,SVOPTMED   WAS SPECIFIC MEDIA ENTERED?                  
         BZ    VNET42               NO                                          
         CLC   SVMEDIA,SVOPTMED    SAME MEDIA?                                  
         BNE   VNETX                                                            
*                                                                               
* MUST READ TN2 PROFILE AFTER VNET USING MEDIA FROM NETWORK!                    
*                                                                               
VNET42   OI    4(R2),X'20'         SET ON VALIDATED                             
         XC    WORK,WORK                                                        
         MVI   WORK,X'A2'                                                       
         MVC   WORK+1(3),=C'TN2'   READ TN2                                     
         MVC   WORK+4(2),AGENCY                                                 
         MVC   WORK+6(1),SVMEDIA   USE MEDIA FROM NETWORK REC                   
         MVC   WORK+7(3),QCLT                                                   
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),SVCLTOFF CLIENT OFFICE                                
*                                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VNET43                                                           
*                                                                               
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQ                          
         BO    VNET43                                                           
*                                                                               
         MVC   WORK+11(1),SVPRDOFF USE PROD OFFICE                              
*                                                                               
VNET43   GOTO1 GETPROF,DMCB,WORK,SVTN2PRO,DATAMGR                               
*                                                                               
         MVC   MYTN2PRE,SVTN2PRO+13 PRINT CLT CML#                              
*                                                                               
         CLI   SVTN2PRO+5,0                                                     
         BE    VNET45                                                           
         CLI   SVTN2PRO+5,C'0'                                                  
         BE    VNET45                                                           
         TM    SVOPTSW1,OPTPER     WAS PERIOD ENTERED IN OPTION FIELD           
         BNZ   *+10                 YES, DO NOT OVERRIDE IT                     
         MVC   MYTN2PR6,SVTN2PRO+5                                              
*                                                                               
         DROP  R4                                                               
*                                                                               
* GET MARKET NAME                                                               
*                                                                               
VNET45   MVI   KEY,C'0'                                                         
         MVC   KEY+1(MKTKEYLN),KEY   PRE-FILL THE KEY WITH ZEROES               
         MVI   KEY,C'M'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),SVSMKT                                                  
         MVC   KEY+6(2),AGENCY                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'STATION',KEY,AIO                      
         L     R6,AIO                                                           
         CLC   KEY(MKTKEYLN),0(R6)                                              
         BNE   VNET50              RECORD NOT FOUND                             
         USING MKTRECD,R6                                                       
         MVC   SVMKTNM,MKTNAME                                                  
         B     VNETEQ                                                           
*                                                                               
VNET50   MVC   SVMKTNM(19),=C'**MKT NOT ON FILE**'                              
*                                                                               
VNETEQ   CR    RB,RB               SET EQ CC                                    
VNETX    XIT1                                                                   
*                                                                               
NETERR   MVC   GERROR,=Y(NONET)                                                 
         GOTO1 VTRAERR                                                          
         DROP  R6,RB                                                            
         EJECT                                                                  
*---------------------------                                                    
* VALIDATE PROGRAM                                                              
*---------------------------                                                    
*                                                                               
VPROG    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         GOTO1 ANY                                                              
         CLC   =CL6'ALL   ',WORK                                                
         BE    *+10                                                             
         MVC   PROGRAM,WORK                                                     
*                                                                               
         BAS   RE,GTEQV            GO GET ANY EQUIVALENT PROGRAMS               
*                                                                               
         OC    PROGRAM,PROGRAM                                                  
         BZ    VPROG26                                                          
*                                                                               
         MVC   BASEPRG,PROGRAM                                                  
         MVC   BASEDTS,STDATEP                                                  
         MVI   BASECT,0                                                         
*                                                                               
         BRAS  RE,NETI              INITIALIZE NETIO                            
*                                                                               
VPROG10  GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    VPROG20                                                          
         DC    H'0'                                                             
VPROG20  CLI   NBMODE,NBREQLST                                                  
         BNE   VPROG20F                                                         
*                                                                               
         LA    R2,TRANETH          IF NET=ALL THEN BYPASS                       
         CLI   5(R2),3                                                          
         BNE   *+22                                                             
         CLC   =C'ALL',8(R2)                                                    
         BNE   *+12                                                             
         MVI   UPDSW,X'FF'         NO UNIT FOUND, BYPASS THIS NET               
         B     VPROGX                                                           
*                                                                               
         MVC   GERROR,=Y(NOUNTPER) NO UNITS                                     
         B     VPROGERX                                                         
*                                                                               
VPROG20F CLI   NBMODE,NBPROCUN                                                  
         BNE   VPROG10                                                          
*                                                                               
         CLI   SVTNPR9,C'B'        BOTH MEDIA AND SKED                          
         BE    VPROG24                                                          
         CLI   SVTNPR9,C'S'        IF NOT SKED, MUST BE MEDIA                   
         BNE   VPROG22                                                          
         CLI   NBACTSUB,C'A'       SKED ONLY                                    
         BL    VPROG10                                                          
         B     VPROG24                                                          
VPROG22  CLI   NBACTSUB,C'A'                                                    
         BNL   VPROG10                                                          
VPROG24  CLC   NBACTPRG,NBSELPRG                                                
         BE    *+14                                                             
         MVC   GERROR,=Y(NOPROG)                                                
         B     VPROGERX                                                         
*                                                                               
         OI    SVOPTSW1,OPT1EACH                                                
VPROG26  OI    4(R2),X'20'         SET ON VALIDATED                             
VPROGX   XIT1                                                                   
         EJECT                                                                  
* GET EQUIVALENT PROGRAM RECORDS FOR CLIENT *                                   
*                                                                               
         DS    0H                                                               
GTEQV    NTR1                                                                   
*                                                                               
         BRAS  RE,INITNET                                                       
         LA    RE,EQVPTBL                                                       
         LA    RF,L'EQVPTBL                                                     
         XCEFL                                                                  
*                                                                               
         LA    R2,EQVPTBL                                                       
         LA    R3,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         LA    R5,1                INITIALIZE COUNTER                           
         USING EQVPTBLD,R2                                                      
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING PGEKEY,R4                                                        
         MVI   PGEKID,X'24'                                                     
         MVC   PGEKAM(3),BAGYMD    & BCLT                                       
         MVC   PGEKNET,NETWORK                                                  
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
GTEQV10  CLC   KEY(8),KEYSAVE                                                   
         BNE   GTEQVX                                                           
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    GTEQV24                                                          
         DC    H'0'                                                             
         USING PGEDTAEL,R6                                                      
*                                                                               
GTEQV20  BRAS  RE,NEXTEL                                                        
         BNE   GTEQV60                                                          
*                                                                               
GTEQV24  GOTO1 DATCON,DMCB,(3,PGESTR),(2,WORK)                                  
         GOTO1 (RF),(R1),(3,PGEEND),(2,WORK+2)                                  
         CLC   WORK(2),ENDATEP     SEE IF WITHIN DATES                          
         BH    GTEQV20                                                          
         CLC   WORK+2(2),STDATEP                                                
         BL    GTEQV20                                                          
*                                                                               
         OC    PROGRAM,PROGRAM                                                  
         BZ    GTEQV26                                                          
         CLI   1(RA),C'*'          THIS A DDS TERMINAL                          
         BNE   *+12                                                             
         TM    SVOPTSW,OPTTEST     AND IN TEST MODE                             
         BO    GTEQV26                                                          
*                                                                               
         CLC   PROGRAM,PGEKPRG     THIS AN EQV PROG                             
         BNE   GTEQV26                                                          
         MVC   GERROR,=Y(NOEQUIV)                                               
         LA    R2,TRAPRGH          PROGRAM                                      
         B     VPROGERX                                                         
*                                                                               
GTEQV26  OC    PROGRAM,PROGRAM                                                  
         BZ    GTEQV28                                                          
         CLC   PROGRAM,PGEPROG     SAME BASE PROG                               
         BNE   GTEQV20                                                          
*                                                                               
GTEQV28  CLC   WORK(2),STDATEP                                                  
         BNL   *+10                                                             
         MVC   WORK(2),STDATEP     FORCE DATES TO BE WITHIN PERIOD              
*                                                                               
         CLC   WORK+2(2),ENDATEP                                                
         BNH   *+10                                                             
         MVC   WORK+2(2),ENDATEP                                                
*                                                                               
         MVC   EQVSDT(4),WORK                                                   
*                                                                               
         MVC   EQVEPRG,PGEKPRG                                                  
         MVC   EQVBPRG,PGEPROG                                                  
         STC   R5,EQVCT                                                         
         LA    R5,1(,R5)           ADD 1 TO ENTRY COUNT                         
*                                                                               
         GOTO1 (RF),(R1),(3,PGESTR),(0,WORK)                                    
         CLI   MYTN2PR6,C'B'       TRAFFIC OVERRIDE BROADCAST MONTH             
         BE    GTEQV34                                                          
         CLI   MYTN2PR6,C'C'       TRAFFIC OVERRIDE CALENDAR MONTH              
         BE    GTEQV30                                                          
         CLI   NBUSER+3,C'B'       BROADCAST MONTH                              
         BE    GTEQV34                                                          
*                                                                               
GTEQV30  MVC   WORK+4(2),=C'01'                                                 
         B     GTEQV36                                                          
*                                                                               
GTEQV34  GOTO1 VGTBROAD,(R1),(1,WORK),WORK+6,GETDAY,ADDAY                       
         MVC   WORK(6),WORK+6                                                   
GTEQV36  GOTO1 DATCON,(R1),(0,WORK),(2,EQVSMODT)                                
*                                                                               
GTEQV40  MVC   EQVEDT,=F'-1'       ONLY USES 1ST 2                              
         MVC   EQVEMODT,=F'-1'     SAME                                         
         CLC   PGEEND,=F'-1'                                                    
         BE    GTEQV50                                                          
         GOTO1 (RF),(R1),(3,PGEEND),(2,EQVEDT)                                  
         GOTO1 (RF),(R1),,(0,WORK)                                              
         CLI   MYTN2PR6,C'B'       TRAFFIC OVERRIDE BROADCAST MONTH             
         BE    GTEQV46                                                          
         CLI   MYTN2PR6,C'C'       TRAFFIC OVERRIDE CALENDAR MONTH              
         BE    GTEQV42                                                          
         CLI   NBUSER+3,C'B'       BROADCAST MONTH                              
         BE    GTEQV46                                                          
*                                                                               
GTEQV42  MVC   WORK+6(4),WORK                                                   
         GOTO1 ADDAY,(R1),WORK,WORK,F'31'                                       
GTEQV44  GOTO1 (RF),(R1),,,F'-1'                                                
         CLC   WORK(4),WORK+6                                                   
         BNE   GTEQV44                                                          
         B     GTEQV48                                                          
*                                                                               
GTEQV46  GOTO1 VGTBROAD,(R1),(1,WORK),WORK+6,GETDAY,ADDAY                       
         MVC   WORK(6),WORK+12                                                  
GTEQV48  GOTO1 DATCON,(R1),(0,WORK),(2,EQVEMODT)                                
*                                                                               
GTEQV50  LA    R2,EQVNEXT                                                       
         BCT   R3,GTEQV20                                                       
         DC    H'0'                                                             
*                                                                               
GTEQV60  DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         B     GTEQV10                                                          
*                                                                               
GTEQVX   DS    0H                                                               
         CLI   KEYSAVE+2,0         DID WE LOOK ACROSS ALL CLIENT                
         BE    GTEQVX10             YES WE ARE DONE                             
         XC    KEY,KEY                          LIENTS?                         
         MVC   KEY(2),KEYSAVE       ID/A/M                                      
         MVC   KEY+4(4),NETWORK     NETWORK                                     
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         B     GTEQV10                                                          
*                                                                               
GTEQVX10 BRAS  RE,INITSPT                                                       
         B     VPROGX                                                           
         DROP  R2,R4,R6                                                         
VPROGERX GOTO1 VTRAERR                                                          
         DROP  RB                                                               
         EJECT                                                                  
*-------------------------------------------------------------*                 
* SUBROUTINE VALIDATES PERIOD AND CALCULATES START/END DATES  *                 
*-------------------------------------------------------------*                 
*                                                                               
VPER     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R2,TRAPERH          PERIOD                                       
         NI    ANYFLAG,X'FF'-TABLESW  RESET TABLE BUILT                         
         CLI   5(R2),0             ANY ENTRY                                    
         BE    MISSERRA            NO, ERROR                                    
*                                                                               
         OC    NBUSER,NBUSER       CK IF NBUSER ALREADY FILLED                  
         BNZ   VPER02                                                           
*                                                                               
         XC    KEY,KEY             GET USER PROFILE INTO NBUSER                 
         MVC   KEY(4),=C'S0N0'                                                  
         MVC   KEY+4(2),AGENCY                                                  
         MVI   KEY+6,C'N'                                                       
         MVC   KEY+7(3),QCLT                                                    
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),SVCLTOFF CLIENT OFFICE                                
*                                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VPER01                                                           
*                                                                               
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQ                          
         BO    VPER01                                                           
*                                                                               
         MVC   WORK+11(1),SVPRDOFF USE PROD OFFICE                              
*                                                                               
VPER01   GOTO1 GETPROF,DMCB,KEY,NBUSER,DATAMGR PUT PROFILE IN NBUSER            
*                                                                               
VPER02   LA    R4,TRAPER                                                        
         CLI   0(R4),C'?'          QUESTION MARK HELP                           
         BNE   VPER04                                                           
         LA    R4,1(,R4)                                                        
*                                                                               
VPER04   GOTO1 DATVAL,DMCB,(0,0(R4)),STDATE                                     
         OC    DMCB(4),DMCB                                                     
         BZ    VPER06                                                           
         CLI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         BNE   PERDATER                                                         
*                                                                               
         GOTO1 GETDAY,(R1),(0,STDATE),WORK                                      
         CLI   0(R1),1             MUST BE MONDAY                               
         BNE   DAYDATER                                                         
         GOTO1 ADDAY,(R1),STDATE,ENDATE,F'6'                                    
         GOTO1 DATCON,(R1),(0,STDATE),(3,PERIOD)                                
         B     VPER30                                                           
*                                                                               
VPER06   GOTO1 DATVAL,DMCB,(2,(R4)),STDATE                                      
         OC    DMCB(4),DMCB                                                     
         BZ    PERDATER                                                         
*                                                                               
         CLI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         BE    WKDATER                                                          
*                                                                               
         GOTO1 DATCON,(R1),(0,STDATE),(3,PERIOD)                                
         CLI   MYTN2PR6,C'B'       TRAFFIC BROADCAST MONTH                      
         BE    VPER20                                                           
         CLI   MYTN2PR6,C'C'       TRAFFIC CALENDAR MONTH                       
         BE    VPER10                                                           
         CLI   NBUSER+3,C'B'       BROADCAST MONTH                              
         BE    VPER20                                                           
*                                                                               
* GET START AND END OF CALENDAR MONTH *                                         
*                                                                               
VPER10   MVC   STDATE+4(2),=C'01'                                               
         GOTO1 ADDAY,(R1),STDATE,ENDATE,F'31'                                   
*                                                                               
VPER14   GOTO1 (RF),(R1),ENDATE,ENDATE,F'-1'                                    
         CLC   STDATE(4),ENDATE                                                 
         BNE   VPER14                                                           
         B     VPER30                                                           
         EJECT                                                                  
* GET BROADCAST MONTH *                                                         
*                                                                               
VPER20   MVC   STDATE+4(2),=C'15'                                               
         MVC   WORK(6),STDATE                                                   
         GOTO1 VGTBROAD,DMCB,(1,WORK),STDATE,GETDAY,ADDAY                       
VPER30   GOTO1 DATCON,(R1),(0,STDATE),(2,STDATEP)                               
         MVC   WKDATEP,STDATEP                                                  
         GOTO1 (RF),(R1),(0,ENDATE),(2,ENDATEP)                                 
*                                                                               
         CLI   TRAPER,C'?'         QUESTION MARK HELP                           
         BNE   VPERX                                                            
*                                                                               
         XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(31),=CL31'PERIOD IS CALENDAR  MONTH FROM'                
         CLI   MYTN2PR6,C'W'       TRAFFIC WEEKLY PERIOD                        
         BE    VPER44                                                           
         CLI   MYTN2PR6,C'B'       TRAFFIC BROADCAST MONTH                      
         BE    VPER42                                                           
         CLI   MYTN2PR6,C'C'       TRAFFIC CALENDAR MONTH                       
         BE    VPER46                                                           
         CLI   NBUSER+3,C'B'       BROADCAST MONTH                              
         BNE   VPER46                                                           
VPER42   MVC   CONHEAD+10(9),=CL9'BROADCAST'                                    
         B     VPER46                                                           
VPER44   MVC   CONHEAD+20(5),=CL5'WEEK'                                         
VPER46   GOTO1 DATCON,DMCB,(2,STDATEP),(5,CONHEAD+32)                           
         MVC   CONHEAD+41(2),=C'TO'                                             
         GOTO1 (RF),(R1),(2,ENDATEP),(5,CONHEAD+44)                             
         B     VPERERX                                                          
VPERX    OC    OPTDATE,OPTDATE     DOING PARTIAL PERIOD                         
         BZ    VPERX10                                                          
*                                                                               
         CLC   OPTDATE,STDATEP                                                  
         BL    BADPARER                                                         
         CLC   OPTDATE,ENDATEP                                                  
         BH    BADPARER                                                         
         GOTO1 DATCON,DMCB,(2,OPTDATE),(0,STDATE)                               
         MVC   STDATEP,OPTDATE                                                  
*                                                                               
VPERX10  GOTO1 DATCON,DMCB,(0,STDATE),(X'20',PSTDATE) PRINTABLE DATES           
         GOTO1 DATCON,DMCB,(0,ENDATE),(X'20',PENDATE)                           
         XIT1                                                                   
*                                                                               
MISSERRA MVI   ERROR,MISSING                                                    
         GOTO1 ERREX                                                            
PERDATER MVC   GERROR,=Y(ONLYMMYY)                                              
         CLI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         BE    WKDATER                                                          
         B     VPERERX                                                          
DAYDATER MVC   GERROR,=Y(MONSTDT)                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,4              L'SUBST TEXT + 1                             
         MVC   ELEM+1(3),WORK                                                   
         B     VPERERX                                                          
BADPARER MVC   GERROR,=Y(BDPARPER)                                              
         B     VPERERX                                                          
WKDATER  MVC   GERROR,=Y(WKDTER)                                                
         B     VPERERX                                                          
VPERERX  GOTO1 VTRAERR                                                          
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
*--------------------                                                           
* VALIDATE OPTIONS                                                              
*--------------------                                                           
*                                                                               
* VALID OPTIONS = 'TEST'      OPTTEST  (X80)                                    
*                 'SEED'      OPTSEED  (X40) ALLOW INSTR EVEN WITH ERR          
*                 'REV'       OPTREV   (X20) (REVISIONS ONLY)                   
*                 'NEW'       OPTNEW   (X10) (ONLY STA WITH NO INST)            
*                 'UNASSIGN   OPTUNAS  (X08) UNASSIGNED UNITS = TBA             
*                 'PRD=UNAL'  OPTUNAL  (X04) UNALLOCATED UNITS = TBA            
*                                            FOR PROG WITH REVISION             
*                 'NOAGY'     OPTNAGY  (X02) BLANK AGENCY NAME/ADDR             
*                 'NOAOR'     OPTNOAOR (X01) BLANK AGY OF RECORD N&A            
*                                                                               
VOPT     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    OPTIONS,OPTIONS     ZERO OPTIONS NOW                             
         XC    PGROUP,PGROUP                                                    
*                                                                               
         LA    R2,TRAFAXH                                                       
         CLI   5(R2),0             ANY ENTRY                                    
         BE    VFAX30                                                           
         CLI   8(R2),C'Y'                                                       
         BE    VFAX10                                                           
         CLI   8(R2),C'2'                                                       
         BNE   VFAX20                                                           
VFAX10   CLI   SVTWPR06,C'Y'       ALREADY SET TO Y                             
         BE    VFAX14                                                           
         CLI   SVTWPR06,C'2'       ALREADY SET TO 2                             
         BE    VFAX14                                                           
         CLI   SVTWPR06,C'N'       IF NO, NONE ALLOWED                          
         BNE   *+14                                                             
         MVC   GERROR,=Y(NOTWAUTH)                                              
         B     VOPTTRAP                                                         
*                                                                               
         CLI   SVTWPR06,0          IF NO PROFILE SET UP, NONE ALLOWED           
         BE    *-14                                                             
VFAX14   MVC   SVTWPR06(1),8(R2)                                                
         B     VFAX40                                                           
*                                                                               
VFAX20   CLI   8(R2),C'C'                                                       
         BE    VFAX24                                                           
         CLI   8(R2),C'N'                                                       
         BE    VFAX26                                                           
         MVC   GERROR,=Y(BADFAX)                                                
         B     VOPTTRAP                                                         
*                                                                               
VFAX24   OI    SVOPTSW1,OPTHDCPY                                                
*                                                                               
VFAX26   MVI   SVTWPR06,C'N'                                                    
         B     VFAX40                                                           
*                                                                               
VFAX30   MVC   BYTE,SVTWPR06                                                    
         CLI   SVTWPR06,C'N'                                                    
         BE    VFAX34                                                           
         CLI   SVTWPR06,C'Y'                                                    
         BE    VFAX34                                                           
         CLI   SVTWPR06,C'2'                                                    
         BE    VFAX34                                                           
         MVI   BYTE,C'N'                                                        
VFAX34   CLC   8(1,R2),BYTE                                                     
         BE    VFAX40                                                           
         MVC   8(1,R2),BYTE                                                     
         OI    6(R2),X'80'         FORCE TRANSMIT                               
         MVI   5(R2),1                                                          
*                                                                               
VFAX40   OI    TRAFAXH+4,X'20'                                                  
         CLI   SVTWPR06,C'N'                                                    
         BE    VOPT00                                                           
         OI    GENSTAT1,MLTPQOK                                                 
*                                                                               
VOPT00   LA    R2,TRAOPTH                                                       
         CLI   5(R2),0             ANY ENTRY                                    
         BE    VOPT92              NO                                           
         CLI   8(R2),C'?'          HELP                                         
         BE    VOPTHLP             YES                                          
*                                                                               
         LA    R4,BLOCK+240        ADDRESS OF FIRST BLOCK                       
         GOTO1 SCANNER,DMCB,TRAOPTH,(7,(R4))                                    
         LLC   R3,DMCB+4           GET NUMBER OF BLOCKS                         
         LTR   R3,R3               SEE IF SCANNER FOUND ANYTHING                
         BZ    MISSERRB            NO                                           
VOPT10   LLC   R1,0(R4)            GET LENGTH                                   
         BCTR  R1,0                                                             
*                                                                               
* GET ADDRESS OF OPTION VALIDATION RTN                                          
         LA    RF,OPTTABLE                                                      
         EX    R1,VOPTCLC                                                       
         BE    VOPTGO                                                           
         LA    RF,L'OPTTABLE(RF)                                                
         CLI   0(RF),X'FF'                                                      
         BNE   *-16                                                             
         B     VOPTHLP                                                          
*                                                                               
VOPTCLC  CLC   12(0,R4),0(RF)                                                   
VOPTGO   L     RE,10(RF)                                                        
         A     RE,SPTR63RR                                                      
         BR    RE                                                               
         EJECT                                                                  
VOPTTEST DS    0H                                                               
         L     R1,ATWA                                                          
         CLI   1(R1),C'*'          THIS A DDS TERMINAL                          
         BE    VOPTEST2             YES                                         
         LA    R2,TRAFAXH                                                       
         CLI   8(R2),C'N'                                                       
         BNE   TSTFAXER                                                         
         LA    R2,TRAOPTH                                                       
VOPTEST2 OI    SVOPTSW,OPTTEST     TEST                                         
         B     VOPT90                                                           
*                                                                               
* TS - FILTER ON TRAFFIC SUPPLIER                                               
*                                                                               
VOPTTS   XC    SVOPTTS(6),SVOPTTS  CLEAR TRAFFIC SUPPLIER FIELD                 
         OI    SVOPTSW1,OPTTS      FILTER ON TRAFFIC SUPPLIER                   
         CLI   1(R4),0             FILTER ON TRAFFIC SUPPLIER                   
         BE    VOPT90                                                           
*                                                                               
         CLI   1(R4),5                                                          
         BH    TSUPERR                                                          
         MVC   SVOTSLEN,1(R4)      SAVE LEN AND                                 
         MVC   SVOPTTS,22(R4)      TRAFFIC SUPPLIER                             
         B     VOPT90                                                           
         SPACE 3                                                                
TSUPERR  XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'TSMSG),TSMSG                                           
         GOTO1 ERREX2                                                           
*                                                                               
* -TS -- FILTER ON NON-TRAFFIC SUPPLIER                                         
*                                                                               
VOPTNTS  DS    0H                                                               
         CLI   1(R4),0             -TS=XXXXX IS ILLIGAL                         
         BNE   VOPTHLP             SHOW OPTION                                  
         OI    SVOPTSW1,OPTNTS     NON-TRAFFIC SUPPLIER                         
         B     VOPT90                                                           
*                                                                               
VOPTSEED OI    SVOPTSW,OPTSEED                                                  
         B     VOPT90                                                           
*                                                                               
VOPTREV  TM    SVOPTSW,OPTNEW      NOT ALLOWED WITH NEW                         
         BNZ   BDKYWDER                                                         
         OI    SVOPTSW,OPTREV                                                   
         B     VOPT90                                                           
*                                                                               
VOPTNEW  TM    SVOPTSW,OPTREV      NOT ALLOWED WITH REV                         
         BNZ   BDKYWDER                                                         
         OI    SVOPTSW,OPTNEW                                                   
         B     VOPT90                                                           
VOPTUNAS OI    SVOPTSW,OPTUNAS                                                  
         B     VOPT90                                                           
*                                                                               
VOPTPRDU CLI   1(R4),4             PRD=UNAL (ALLOW UNALLOCATED)                 
         BNE   VOPTPRD2                                                         
         CLC   22(4,R4),=CL4'UNAL'                                              
         BNE   VOPTHLP                                                          
         OI    SVOPTSW,OPTUNAL                                                  
         B     VOPT90                                                           
*                                                                               
VOPTDTE  GOTO1 DATVAL,DMCB,(0,22(R4)),WORK  DO PARTIAL PERIOD                   
         OC    DMCB,DMCB                                                        
         BZ    INVDATER                                                         
*                                                                               
         GOTO1 DATCON,(R1),(0,WORK),(2,OPTDATE)                                 
         B     VOPT90                                                           
*                                                                               
VOPTPRD2 CLI   SVTN2PRO+00,C'*'    TRAFFIC BY PRODUCT                           
         BNE   VOPTHLP                                                          
         CLC   =C'POL',22(R4)      IS PRD=POL                                   
         BE    INVPRER              YES, ERROR                                  
         CLC   =C'ALL',22(R4)      IS PRD=ALL                                   
         BE    INVPRER              YES, ERROR                                  
         CLI   1(R4),2             MIN 2 CHAR                                   
         BL    PRLENERR                                                         
         CLI   1(R4),3             MAX 3 CHAR                                   
         BH    PRLENERR                                                         
         BE    *+8                                                              
         MVI   24(R4),C' '                                                      
*&&DO                                                                           
         LA    R0,NCLSTSIZ         MAX COUNT BUG CATCHER                        
         L     R1,ASVNCLST         TABLE OF CLIENT PROD CODES                   
VOPT34   CLI   0(R1),C' '          AT END OF TABLE?                             
         BNH   VOPTX20              YES, ERROR                                  
         CLC   0(3,R1),22(R4)      THIS A VALID PROD CODE                       
         BE    VOPT36                                                           
         LA    R1,4(,R1)           BUMP PROD PTR                                
         BCT   R0,VOPT34                                                        
         B     INVPRER                                                          
VOPT36   MVC   OPTPROD(4),0(R1)    PROD AND BPRD                                
         B     VOPT90                                                           
*&&                                                                             
         XC    FLDH,FLDH                                                        
         XC    FLD,FLD                                                          
         MVI   FLDH+5,3            DATA LEN                                     
         MVC   FLD(3),22(R4)       PROD                                         
         LA    R2,FLDH                                                          
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
         BRAS  RE,INITSPT                                                       
         GOTO1 VALIPRD                                                          
         MVI   ERROPT,0                                                         
*                                                                               
         CLI   ERROR,0             ANY ERRORS                                   
         BNE   INVPRER                                                          
*                                                                               
         MVC   OPTPROD,WORK        PROD                                         
         MVC   SVPRDNAM,WORK+5     PROD NAME                                    
         B     VOPT90                                                           
         EJECT                                                                  
VOPTPGRP CLI   SVTN2PRO+00,C'A'    TRAFFIC BY PRODUCT GROUP                     
         BL    VOPTHLP                                                          
         CLI   SVTN2PRO+00,C'Z'    TRAFFIC BY PRODUCT GROUP                     
         BH    VOPTHLP                                                          
*                                                                               
* VALIDATE PRODUCT GROUP *                                                      
*                                                                               
         BRAS  RE,VPGR                                                          
*                                                                               
         CLI   OFFLINE,C'Y'        ONLINE ?                                     
         BE    VOPT90              YES, DONE (MULTI-FAX NOT SUPPORTED)          
         MVI   TMPSTSW,C'Y'                                                     
         LA    R1,=C'DMWRT '                                                    
         XC    DMCB(24),DMCB                                                    
         ST    R1,DMCB                                                          
         L     RE,ATWA                                                          
         MVC   DMCB+10(2),2(RE)                                                 
         MVI   DMCB+8,4                                                         
         ICM   RF,12,=C'L='                                                     
         ICM   RF,3,=Y(TABSAVL)                                                 
         GOTO1 DATAMGR,DMCB,,=C'TEMPSTR',,AOPTPGRL,,(RF)                        
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         B     VOPT90                                                           
*                                                                               
VOPTNAGY OI    SVOPTSW,OPTNAGY     NOAGY - DON'T PRINT AGENCY N/A               
         B     VOPT90                                                           
*                                                                               
VOPTEASY CLI   OFFLINE,C'Y'        AGY COPY BACKUP/ONLY VALID OFFLINE           
         BNE   VOPTHLP                                                          
         OI    SVOPTSW1,OPTHDCPY                                                
         B     VOPT90                                                           
*                                                                               
VOPTNAOR OI    SVOPTSW,OPTNOAOR    NOAOR-DON'T PRT AGENCY OF REC N/A            
         B     VOPT90                                                           
*                                                                               
VOPTSKED MVI   SVTNPR9,C'S'        SKED-ONLY USE TRAFFIC SKEDED UNITS           
         B     VOPT90                                                           
*                                                                               
VOPTMED  MVI   SVTNPR9,C'M'        MEDIA-ONLY USE MEDIA UNITS                   
         B     VOPT90                                                           
*                                                                               
VOPTBOTH MVI   SVTNPR9,C'B'        BOTH-USE MEDIA & SKED UNITS                  
         B     VOPT90                                                           
*                                                                               
VOPTEACH OI    SVOPTSW1,OPT1EACH   EACH-DO EACH PROGRAM SEPARATELY              
         B     VOPT90                                                           
*                                                                               
VOPTCAL  MVI   MYTN2PR6,C'C'       CALENDAR - MONTHLY PERIOD                    
         B     VOPT90                                                           
*                                                                               
VOPTBRD  MVI   MYTN2PR6,C'B'       BROADCAST - MONTHLY PERIOD                   
         B     VOPT90                                                           
*                                                                               
VOPTWEEK MVI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         B     VOPT90                                                           
*                                                                               
VOPTISCI DS    0H                                                               
         CLI   TWAOFFC,C'*'        ONLY DDS TERMINALS                           
         BNE   VOPTHLP                                                          
         MVI   MYTN2PRE,C'N'       PRINT CML ISCII NOT CLT CML #                
         B     VOPT90                                                           
*                                                                               
VOPT90   LA    R4,32(,R4)          POINT TO NEXT BLOCK                          
         BCT   R3,VOPT10           FOR NUMBER OF BLOCKS FOUND                   
*                                                                               
VOPT92   DS    0H                                                               
         CLI   OFFLINE,C'Y'        BYPASS FOR OFFLINE                           
         BE    VOPT93                                                           
*                                                                               
         TM    SOXSW,SOXOKFLG      IF DDS, AND FACTEST, OKAY TO GO              
         BO    VOPT93                                                           
*                                                                               
         TM    SOXSW,SOXERFLG      IF RD ONLY/RD ONLY MODE/WRONG ADV            
         BZ    VOPT93                                                           
*                                                                               
         TM    SVOPTSW,OPTTEST     TEST                                         
         BO    VOPT93                                                           
*                                                                               
         GOTO1 VSOXERR             FORCE OPTION TEST                            
*                                                                               
VOPT93   DS   0H                                                                
         CLI   SVTN2PRO+00,0       ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPT96               NO                                          
         CLI   SVTN2PRO+00,C'0'    ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPT96               NO                                          
         CLI   SVTN2PRO+00,C'*'    EXPECTING PRODUCT                            
         BNE   VOPT94                                                           
         CLC   OPTPROD,SPACES      ANY PROD ENTERED                             
         BH    VOPT96                                                           
         MVC   GERROR,=Y(PRDREQD)                                               
         B     VOPTTRAP                                                         
*                                                                               
VOPT94   DS    0H                                                               
         OC    OPTPRGR,OPTPRGR    ANY PRODUCT GROUP                             
         BNZ   VOPT96                                                           
         MVC   GERROR,=Y(PGRPREQD)                                              
         B     VOPTTRAP                                                         
*                                                                               
VOPT96   OI    4(R2),X'20'         SET VALIDATED                                
*                                                                               
VOPTX    TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VOPTXX                                                           
*                                                                               
         OC    OPTPROD,OPTPROD   WAS PRODUCT OPTION ENTERED                     
         BZ    VOPTXX                                                           
*                                                                               
         LA    R0,NCLSTSIZ         FIND PROD                                    
         L     R1,ASVNCLST                                                      
*                                                                               
VOPTX10  CLC   OPTPROD,0(R1)                                                    
         BE    VOPTXX                                                           
         LA    R1,4(R1)                                                         
         CLI   0(R1),C' '                                                       
         BNH   *+8                                                              
         BCT   R0,VOPTX10                                                       
         B     VOPTX30                                                          
*                                                                               
VOPTX20  TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    INVPRER              NO, ERROR                                   
*                                                                               
VOPTX30  LA    R2,TRAOPTH                                                       
         MVI   ERROR,SECLOCK       SECURITY LOCK-OUT                            
         B     VOPTERX                                                          
*                                                                               
VOPTXX   XIT1                                                                   
*                                                                               
TSTFAXER XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(32),=CL32'* USE FAX=NO WITH TEST REQUEST *'              
         GOTO1 ERREX2                                                           
         EJECT                                                                  
* VALIDATE PRODUCT GROUP *                                                      
*                                                                               
VPGR     NTR1                                                                   
         GOTO1 VALIPGR                                                          
         MVC   OPTPRGR,SVPGRP      MOVE TO LOCAL STORAGE                        
*                                                                               
         MVC   QPGR,SPACES                                                      
         MVC   QPGR(1),SVTN2PRO+00                                              
         LLC   RF,1(R4)                                                         
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   QPGR+1(0),22(R4)    PRINTABLE PGRP                               
*                                                                               
         MVC   PGROUP(1),QPGR      PGROUP ALPHA                                 
         MVC   PGROUP+1(2),OPTPRGR                                              
*                                                                               
         MVI   RDUPDATE,C'N'       KEY HAS 0D81 KEY ON RETURN                   
         GOTO1 HIGH                                                             
*                                                                               
* GET PRODUCT GROUP NAME *                                                      
*                                                                               
VPGR20   MVC   SVKEY,KEY                                                        
         NI    KEY+1,X'7F'                                                      
         XC    KEY+8(5),KEY+8                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   SVPRGNAM,2(R6)                                                   
*                                                                               
         MVC   KEY,SVKEY                                                        
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LHI  R0,OPTPGRLQ                                                       
         L    R5,AOPTPGRL                                                       
*                                                                               
VPGR40   MVC   0(L'OPTPGRL,R5),KEY+8                                            
         LA    R5,L'OPTPGRL(R5)                                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         CLC   KEY(8),KEYSAVE                                                   
         BNE   VOPTX                                                            
         BCT   R0,VPGR40                                                        
         B     MAXPGER             MAX PRODS FOR TABLE EXCEEDED                 
*                                                                               
MAXPGER  MVC   GERROR,=Y(MAXPGRP)                                               
         B     VOPTTRAP                                                         
*                                                                               
PRLENERR MVC   GERROR,=Y(PRDLENER)                                              
VOPTTRAP GOTO1 VTRAERR                                                          
*                                                                               
VOPTHLP  XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'OPTHLPMS),OPTHLPMS                                     
         CLI   SVTN2PRO+00,0       ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPTERX2             NO                                          
         CLI   SVTN2PRO+00,C'0'    ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPTERX2             NO                                          
         MVC   CONHEAD+L'OPTHLPMS-2(7),=CL7'/PRD= *'                            
         CLI   SVTN2PRO+00,C'*'    EXPECTING PRODUCT                            
         BE    VOPTERX2                                                         
         MVC   CONHEAD+L'OPTHLPMS-2+2(3),=C'GRP'                                
*                                                                               
VOPTERX2 GOTO1 ERREX2                                                           
*                                                                               
INVPRER  MVI   ERROR,INVPROD                                                    
         B     VOPTERX                                                          
INVDATER MVI   ERROR,INVDATE                                                    
         B     VOPTERX                                                          
BDKYWDER MVI   ERROR,BADKEYWD      KEY WORDS USED IN BAD COMBINATION            
         B     VOPTERX                                                          
MISSERRB MVI   ERROR,MISSING                                                    
*                                                                               
VOPTERX  GOTO1 ERREX                                                            
*                                                                               
OPTTABLE DS    0CL14                                                            
         DC    CL10'TEST      ',AL4(VOPTTEST)                                   
         DC    CL10'ALL       ',AL4(VOPT90)     ALL NETWORKS                    
         DC    CL10'TSUPP     ',AL4(VOPTTS)                                     
         DC    CL10'-TSUPP    ',AL4(VOPTNTS)                                    
         DC    CL10'SEED      ',AL4(VOPTSEED)                                   
         DC    CL10'REV       ',AL4(VOPTREV)                                    
*NOP     DC    CL10'NEW       ',AL4(VOPTNEW)                                    
         DC    CL10'UNASGGND  ',AL4(VOPTUNAS)                                   
         DC    CL10'PRD       ',AL4(VOPTPRDU)                                   
         DC    CL10'DATE      ',AL4(VOPTDTE)                                    
         DC    CL10'NOAGY     ',AL4(VOPTNAGY)                                   
         DC    CL10'NOAOR     ',AL4(VOPTNAOR)                                   
         DC    CL10'HELP      ',AL4(VOPTHLP)                                    
         DC    CL10'SKED      ',AL4(VOPTSKED)                                   
         DC    CL10'MEDIA     ',AL4(VOPTMED)                                    
         DC    CL10'BOTH      ',AL4(VOPTBOTH)                                   
         DC    CL10'EACH      ',AL4(VOPTEACH)                                   
         DC    CL10'CALENDAR  ',AL4(VOPTCAL)                                    
         DC    CL10'BROADCAST ',AL4(VOPTBRD)                                    
         DC    CL10'PGRP      ',AL4(VOPTPGRP)                                   
         DC    CL10'ISCII     ',AL4(VOPTISCI) PRINT ISCII - DDS ONLY            
         DC    CL10'WEEKLY    ',AL4(VOPTWEEK)                                   
         DC    CL10'#         ',AL4(VOPTEASY)                                   
         DC    X'FF'                                                            
*                                                                               
OPTHLPMS DC    C'OPT=DATE/NOAGY/PRD=UNAL/REV/SEED/TEST/UNAS/TS/-TS'             
TSMSG    DC    C'* ERROR * INVALID TRAFFIC SUPPLIER ENTERED *'                  
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
*---------------------------------------------------------------------          
* LOOK FOR PATTERN RECORDS THAT ARE SIMILAR TO THE PATTERN ENTRIES IN           
* TABLE.  IF ENTRY IS IN THE TABLE SHRINK/EXPAND THE DATES AS NEEDED            
* IF NOT ADD IT TO THE TABLE.  WHEN DONE RESORT THE TABLE.                      
*---------------------------------------------------------------------          
*                                                                               
ADDPATS  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R5,APATABLE                                                      
         USING PATABLED,R5                                                      
*                                                                               
         OC    PATENT,PATENT       EMPTY ENTRY                                  
         BZ    ADPATX               THERE IS NOTHING TO DO                      
*                                                                               
         L     R1,PTTNCTR          NUMBER OF ENTRIIES IN THE TABLE              
         MH    R1,=AL2(PATNEXT-PATENT)  MULTIPLY BY ENTRY LENGTH                
         ST    R1,FULL             KEEP TABLE SIZE                              
*                                                                               
         NI    SVFLAG,X'FF'-ENTDEL INIT ENTRY DELETED                           
*                                                                               
         XC    WORK+56(8),WORK+56  CLEAR TO SAVE TBA DATES                      
*                                                                               
ADPAT10  DS    0H                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPTXKEY,R4                                                       
         MVC   NPTXKID,=X'0A61'                                                 
         MVC   NPTXAM(3),BAGYMD                                                 
         MVI   NPTXREF,X'E0'        BYPASS ANY SAVED PATTERNS                   
*                                                                               
         BRAS  RE,INITXSP                                                       
*                                                                               
*        MVI   RDUPDATE,C'N'                                                    
*        GOTO1 HIGH                                                             
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
*                                                                               
         CLC   KEY(5),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
ADPAT12  DS    0H                                                               
**                                                                              
** COMPARE ALL OF KEY BUT FIRST 5 BYTES                                         
**       OC    KEY+4(16),KEY+4     THIS A PTN SEQ REC                           
         OC    NPTXNET(L'NPTXKEY-5),NPTXNET   THIS A PTN SEQ REC                
         BZ    ADPAT100                        GET NEXT PATTERN                 
*                                                                               
         CLC   NPTXREF,=X'E000'    THIS SAVED PTN                               
         BL    ADPAT100             GET NEXT PATTERN                            
*                                                                               
* DOES THE PRODUCT IN PATTERN RECORD MATCH THE PRODUCT IN BUYS                  
*                                                                               
         L     R1,APATABLE                                                      
*                                                                               
ADPAT15  OC    0(L'PATENT,R1),0(R1) ANY ENTRY?                                  
         BZ    ADPAT100             GET NEXT PATTERN                            
*                                                                               
         CLC   NPTXPRD,PATPROD1-PATENT(R1) SAME PROD                            
         BNE   ADPAT15C                                                         
         CLC   NPTXPRD2,PATPROD2-PATENT(R1) AND PRD PARTNER                     
         BE    ADPAT16                                                          
*                                                                               
ADPAT15C LA    R1,PATNEXT-PATENT(R1)                                            
         C     R1,MAXPATBL         AT END OF TABLE                              
         BNL   ADPAT100                                                         
         B     ADPAT15                                                          
*                                                                               
ADPAT16  OC    NETWORK,NETWORK     NETWORK SPECIFIC REQUEST?                    
         BZ    ADPAT18              NO                                          
         OC    NPTXNET,NPTXNET                                                  
         BZ    ADPAT18                                                          
         CLC   NPTXNET,NETWORK                                                  
         BE    ADPAT18                                                          
         CLI   NPTXNET+2,X'FF'     IS IT MEDIA SPECIFIC?                        
         BNE   *+18                                                             
         CLC   NPTXNET+1(1),SVMEDIA    THIS MEDIA?                              
         BNE   ADPAT100                                                         
         BE    ADPAT18                                                          
*                                                                               
* I THINK THIS CODE DOES NOTHING SINCE ADPAT100 DOES A SEQ                      
         MVC   NPTXPROG,=X'FFFFFFFFFFFF'  GET TO NEXT NETWORK                   
**       XC    NPTKPRD(NPTKREF-NPTKPRD),NPTKPRD                                 
         B     ADPAT100                                                         
*                                                                               
ADPAT18  CLI   NPTXPROG,X'FF'      IF 1ST BYTE IS FF                            
         BE    ADPAT28             THEN DAYPART/FEED PATTERN                    
         OC    NPTXPROG,NPTXPROG                                                
         BZ    ADPAT28                                                          
         OC    PROGRAM,PROGRAM     IS THIS PROGRAM SPECIFIC REQUEST?            
         BZ    *+14                                                             
         CLC   PROGRAM,NPTXPROG                                                 
         BNE   ADPAT100                                                         
*                                                                               
* IS THIS PROGRAM IN PROGRAM TABLE                                              
*                                                                               
         L     R1,APRGTBLE                                                      
         USING PRGTABLD,R1                                                      
*                                                                               
ADPAT20  OC    PRGENT,PRGENT       EMPTY?                                       
         BZ    ADPAT25              YES,DONE                                    
         CLC   PRGPRG,NPTXPROG                                                  
         BE    ADPAT28                                                          
         LA    R1,PRGNEXT                                                       
         B     ADPAT20                                                          
         DROP  R1                                                               
*                                                                               
* I THINK THIS CODE DOES NOTHING SINCE ADPAT100 DOES A SEQ                      
ADPAT25  MVC   NPTXPRD,=X'FFFFFF'  GET TO NEXT PROGRAM                          
**       XC    NPTKSLN(NPTKREF-NPTKSLN),NPTKSLN                                 
         B     ADPAT100                                                         
*                                                                               
B        USING PATABLED,BLPATENT                                                
*                                                                               
* BUILD PATTERN ENTRY IN BLPATENT                                               
*                                                                               
ADPAT28  XC    B.PATENT(L'PATENT),B.PATENT                                      
*                                                                               
         CLI   NPTXPROG,X'FF'      IF 1ST BYTE IS FF                            
         BE    *+10                                                             
         MVC   B.PATPROG,NPTXPROG                                               
         MVC   B.PATPROD1,NPTXPRD    PRODUCT                                    
         MVC   B.PATSLN,NPTXSLN                                                 
         MVC   B.PATPROD2,NPTXPRD2  PARTNER PRODUCT                             
         MVC   B.PATSLN2,NPTXSLN2                                               
         MVC   B.PATREF,NPTXREF    PATTERN REFERENCE NUMBER                     
*                                                                               
         CLI   NPTXPROG,X'FF'      IF 1ST BYTE IS FF                            
         BNE   *+16                                                             
         MVC   B.PATDP,NPTXPROG+1   THEN NEXT BYTE IS DAYPART CODE              
         MVC   B.PATFEED,NPTXPROG+2  NEXT 4 BYTES ARE FEED                      
*                                                                               
**       LA    RF,NPTKPRD                                                       
**       CLI   NPTKPRD,0                                                        
**       BNE   *+6                                                              
**       DC    H'0'                 NO PROD???                                  
**       BAS   RE,FPROD1                                                        
**       MVC   B.PATPROD1,QPRD                                                  
         MVC   B.PATPROD1,NPTXPRD                                               
*                                                                               
**       LA    RF,NPTKPRD2                                                      
**       CLI   NPTKPRD2,0                                                       
**       BE    *+14                                                             
**       BAS   RE,FPROD1                                                        
**       MVC   B.PATPROD2,QPRD                                                  
         MVC   B.PATPROD2,NPTXPRD2                                              
*                                                                               
         CLI   NPTXNET+2,X'FF'     IF 3RD BYTE IS FF                            
         BNE   *+12                                                             
         OI    B.PATKEY,PATKMED    THEN MUST BE MEDIA SPECIFIC                  
         B     *+18                                                             
         OC    NPTXNET,NPTXNET     ANY NETWORK ?                                
         BNZ   *+8                                                              
         OI    B.PATKEY,PATKALL    ALL NETWORK PATTERN                          
*                                                                               
         CLI   NPTXPROG,X'FF'                                                   
         BNE   ADPAT30                                                          
         CLI   NPTXPROG+1,0        ANY DAYPART?                                 
         BE    *+8                                                              
         OI    B.PATKEY,PATKDP     DAYPART SPEC                                 
*                                                                               
         OC    NPTXPROG+2(4),NPTXPROG+2 ANY FEED?                               
         BZ    ADPAT30                                                          
         OI    B.PATKEY,PATKFD     FEED SPEC                                    
         B     ADPAT40                                                          
*                                                                               
ADPAT30  OC    NPTXPROG,NPTXPROG   ANY PROGRAM ?                                
         BZ    ADPAT40                                                          
*                                                                               
         CLI   NPTXPROG,X'FF'      DAYPART/FEED?                                
         BE    ADPAT40                                                          
*                                                                               
         OI    B.PATKEY,PATKPRG    PROG SPEC                                    
*                                                                               
ADPAT40  L     R6,AIO1                                                          
         ST    R6,AIO                                                           
**       MVI   RDUPDATE,C'N'                                                    
**       GOTO1 GETREC                                                           
         GOTO1 AIOCALL,DMCB,GETQ+FILQ+XSPQ,0                                    
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPTDTAEL,R6                                                      
*                                                                               
         TM    NPTSTAT,X'80'       TEST STATUS = DELETED                        
         BO    ADPAT100                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,NPTSTART),(2,B.PATSTR)                            
*                                                                               
         CLC   NPTEND,=X'FFFFFF'   IF END DATE UFN                              
         BNE   ADPAT42                                                          
         CLC   B.PATSTR,ENDATEP    IS PAT START DATE AFTER EOP                  
         BH    ADPAT100             YES, THIS PAT IS OUT OF RANGE               
         MVC   B.PATEND,ENDATEP    THEN USE PERIOD END DATE                     
         B     ADPAT45                                                          
*                                                                               
ADPAT42  GOTO1 (RF),(R1),(3,NPTEND),(2,B.PATEND)                                
*                                                                               
* SEE THAT PATTERN DATES FALL WITH/N PERIOD DATES                               
*                                                                               
ADPAT45  CLC   B.PATSTR,ENDATEP                                                 
         BH    ADPAT100            GET NEXT RECORD                              
         CLC   B.PATEND,STDATEP                                                 
         BL    ADPAT100                                                         
*                                                                               
         CLC   B.PATSTR,STDATEP                                                 
         BNL   *+10                                                             
         MVC   B.PATSTR,STDATEP                                                 
*                                                                               
         CLC   B.PATEND,ENDATEP                                                 
         BNH   *+10                                                             
         MVC   B.PATEND,ENDATEP                                                 
*                                                                               
         MVC   B.PATSEQ,NPTSEQNO     NOTE THIS                                  
*                                                                               
         XC    WPATENT,WPATENT                                                  
         MVC   WPATENT,B.PATENT                                                 
*                                                                               
         L     R5,APATABLE                                                      
         B     ADPAT51                                                          
*                                                                               
ADPAT50  LA    R5,PATNEXT                                                       
*                                                                               
ADPAT51  OC    PATENT,PATENT       EMPTY ?                                      
         BNZ   ADPAT52                                                          
         TM    B.PATFLG2,NOPAT     DO NOT ADD TO PATTERN TABLE?                 
         BO    ADPAT100                                                         
*                                                                               
W        USING PATABLED,WPATENT                                                 
*                                                                               
         XC    WPATENT,WPATENT                                                  
         MVC   WPATENT,B.PATENT                                                 
         MVC   W.PATFLG2,B.PATFLG2                                              
         MVC   W.PATUNTCT,B.PATUNTCT                                            
*NOP*    OI    W.PATFLG2,OOPS      NO BUYS FOR THIS PATTERN                     
         BAS   RE,ADDNEW                                                        
         B     ADPAT100                                                         
*                                                                               
ADPAT52  DS    0H                                                               
         CLC   PATENT(PATFLG-PATENT),B.PATENT SAME PAT ENTRY                    
         BNE   *+20                                                             
         OI    PATFLG2,PATUSED     TURN ON                                      
         OI    B.PATFLG2,PATUSED      PATTERN USED                              
         OI    B.PATFLG2,NOPAT     DO NOT ADD TO PATTERN TABLE                  
         B     ADPAT50                                                          
*                                                                               
         CLC   PATENT(L'PATCOM),B.PATENT SIMILAR PAT ENTRY                      
         BE    ADPAT60                                                          
         OC    PATREF,PATREF       ANY PATTERN REFERENCE NUMBER                 
         BNZ   ADPAT50              YES, DIFFERENT PAT, GET NEXT                
         MVC   WPATENT,B.PATENT                                                 
         BAS   RE,SMLRENT          FIND SIMILAR ENTRY                           
         BE    ADPAT70                                                          
         OI    PATFLG2,PATUSED     PRINT AS TBA ON INSTR                        
         B     ADPAT50                                                          
*                                                                               
* THE PATTERN SEQUENCE NUMBER IS SAME MIGHT NEED TO ADJUST THE DATES            
ADPAT60  CLC   B.PATSTR,PATEND     IS PAT START OUT OF DTE RANGE                
         BNH   *+14                                                             
*NOP*    OI    PATFLG2,OOPS        BUYS NO LONGER COVERED BY PAT                
         XC    PATKEY(3),PATKEY    CLEAR PAT KEY AND REF NUMBER                 
         B     ADPAT50             GET NEXT ENTRY                               
*                                                                               
         CLC   B.PATEND,PATSTR     IS PAT END OUT OF DTE RANGE                  
         BNL   *+14                                                             
*NOP*    OI    PATFLG2,OOPS        BUYS NO LONGER COVERED BY PAT                
         XC    PATKEY(3),PATKEY    CLEAR PAT KEY AND REF NUMBER                 
         B     ADPAT50             GET NEXT ENTRY                               
*                                                                               
         OI    PATFLG2,PATUSED                                                  
         CLC   B.PATSTR,PATSTR     SAME START DATE                              
         BE    ADPAT62              YES, KEEP IT                                
         BL    ADPAT61C                                                         
*                                                                               
* SAVE THE DATES THAT ARE NOT COVERED BY PATTERN (TBA)                          
*                                                                               
         MVC   WORK+56(L'PATSTR),PATSTR START DATE                              
*                                                                               
         GOTO1 DATCON,DMCB,(2,B.PATSTR),(0,WORK) START DATE                     
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'-1' START DATE -1 AS END DATE           
         GOTO1 DATCON,(R1),(0,WORK+6),(2,WORK+58)  END DATE                     
*                                                                               
ADPAT61C MVC   PATSTR,B.PATSTR      THEN MOVE IN NEW DATE                       
*                                                                               
ADPAT62  CLC   B.PATEND,PATEND     SAME END DATE                                
         BE    ADPAT62C             YES, KEEP IT                                
         BH    ADPAT62B                                                         
*                                                                               
* SAVE THE DATES THAT ARE NOT COVERED BY PATTERN (TBA)                          
*                                                                               
         GOTO1 DATCON,DMCB,(2,B.PATEND),(0,WORK) START DATE                     
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'1' END DATE +1 AS START DATE            
         GOTO1 DATCON,(R1),(0,WORK+6),(2,WORK+60)  START DATE                   
*                                                                               
         MVC   WORK+62(L'PATEND),PATEND END DATE                                
*                                                                               
ADPAT62B MVC   PATEND,B.PATEND      THEN MOVE NEW DATE                          
*                                                                               
ADPAT62C OI    PATFLG2,PATUSED                                                  
*                                                                               
         TM    PATFLG2,TAGFLG      IS TAG FLAG TURNED ON                        
         BZ    *+8                                                              
         OI    B.PATFLG2,TAGFLG                                                 
                                                                                
         BRAS  RE,DELENT           DEL THIS ENTRY FROM THE TABLE                
*                                                                               
         XC    DUB,DUB                                                          
         MVC   WPATENT,B.PATENT    ADD THIS ENTRY                               
         MVC   W.PATFLG2,B.PATFLG2                                              
         MVC   W.PATUNTCT,B.PATUNTCT                                            
         BAS   RE,ADDNEW           ADD NEW ENTRY TO TABLE                       
         OC    DUB,DUB             ANY TBA DATES                                
         BZ    ADPAT83              NO                                          
         BAS   RE,ADDTBA           ADD TBA DATES TO TABLE                       
         B     ADPAT83                                                          
*                                                                               
* WE GOT HERE BECAUSE ENTRY IS SAME BUT PAT REF=0                               
* ADJUST DATES AND ASSIGN NEW REF#                                              
*                                                                               
ADPAT70  CLC   B.PATSTR,PATEND     IS PAT START OUT OF DTE RANGE                
         BNH   *+12                                                             
         OI    PATFLG2,PATUSED                                                  
         B     ADPAT50              YES, GET NEXT ENTRY                         
*                                                                               
         CLC   B.PATEND,PATSTR     IS PAT END OUT OF DTE RANGE                  
         BNL   *+12                                                             
         OI    PATFLG2,PATUSED                                                  
         B     ADPAT50              YES                                         
*                                                                               
         CLC   B.PATSTR,PATSTR     SAME START DATE                              
         BE    ADPAT75              YES, KEEP IT                                
         BL    ADPAT73                                                          
*                                                                               
* SAVE THE DATES THAT ARE NOT COVERED BY PATTERN (TBA)                          
*                                                                               
         MVC   WORK+56(L'PATSTR),PATSTR  START DATE                             
*                                                                               
         GOTO1 DATCON,DMCB,(2,B.PATSTR),(0,WORK) START DATE                     
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'-1' START DATE -1 AS END DATE           
         GOTO1 DATCON,(R1),(0,WORK+6),(2,WORK+58)   END DATE                    
*                                                                               
ADPAT73  MVC   PATSTR,B.PATSTR      THEN MOVE IN NEW DATE                       
*                                                                               
ADPAT75  CLC   B.PATEND,PATEND     SAME END DATE                                
         BE    ADPAT80              YES, KEEP IT                                
         BH    ADPAT77                                                          
*                                                                               
* SAVE THE DATES THAT ARE NOT COVERED BY PATTERN (TBA)                          
*                                                                               
         GOTO1 DATCON,DMCB,(2,B.PATEND),(0,WORK) START DATE                     
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'1' END DATE +1 AS START DATE            
         GOTO1 DATCON,(R1),(0,WORK+6),(2,WORK+60)   START DATE                  
*                                                                               
         MVC   WORK+62(L'PATEND),PATEND  END DATE                               
*                                                                               
ADPAT77  MVC   PATEND,B.PATEND      THEN MOVE NEW DATE                          
*                                                                               
ADPAT80  CLC   PATREF,B.PATREF     SAME PATTERN REFERENCE #                     
         BE    ADPAT82                                                          
         MVC   PATREF,B.PATREF      NO, SAVE NEW REF#                           
         MVC   PATKEY,B.PATKEY                                                  
         OI    PATFLG2,PATUSED     TURN ON PATUSED                              
         TM    PATFLG2,TAGFLG      IS TAG FLAG TURNED ON                        
         BZ    *+8                                                              
         OI    B.PATFLG2,TAGFLG                                                 
                                                                                
         BRAS  RE,DELENT           DEL THIS ENTRY FROM THE TABLE                
*                                                                               
         XC    DUB,DUB                                                          
         MVC   WPATENT,B.PATENT    ADD THIS ENTRY                               
         MVC   W.PATFLG2,B.PATFLG2                                              
         MVC   W.PATUNTCT,B.PATUNTCT                                            
         BAS   RE,ADDNEW           ADD NEW ENTRY TO TABLE                       
         OC    DUB,DUB             ANY TBA DATES                                
         BZ    ADPAT82C             NO                                          
         BAS   RE,ADDTBA           ADD TBA DATES TO TABLE                       
         B     ADPAT82C                                                         
*                                                                               
ADPAT82  OI    PATFLG2,PATUSED     TURN ON PATTERN USED                         
         OC    WORK+56(8),WORK+56  ANY DATES ADJUSTED                           
         BZ    ADPAT82C                                                         
         TM    PATFLG2,TAGFLG      IS TAG FLAG TURNED ON                        
         BZ    *+8                                                              
         OI    B.PATFLG2,TAGFLG                                                 
                                                                                
         BRAS  RE,DELENT           DEL THIS ENTRY FROM THE TABLE                
                                                                                
         XC    DUB,DUB                                                          
         MVC   WPATENT,B.PATENT    ADD THIS ENTRY                               
         MVC   W.PATFLG2,B.PATFLG2                                              
         MVC   W.PATUNTCT,B.PATUNTCT                                            
         BAS   RE,ADDNEW           ADD NEW ENTRY TO TABLE                       
*                                                                               
         OC    DUB,DUB             ANY TBA DATES                                
         BZ    ADPAT82C             NO                                          
         BAS   RE,ADDTBA           ADD TBA DATES TO TABLE                       
*                                                                               
ADPAT82C OI    B.PATFLG2,PATUSED      PATTERN USED                              
         XC    WPATENT,WPATENT                                                  
         MVC   WPATENT,PATENT                                                   
         BAS   RE,ALLPGADD         ADD AN ENTRY TO ALL PROGRAM TABLE            
*                                                                               
ADPAT83  OC    WORK+56(8),WORK+56  NEW DATES?                                   
         BZ    ADPAT85              NO                                          
*                                                                               
* ADD NEW ENTRIES W/REF ZERO                                                    
*                                                                               
         XC    WPATENT,WPATENT                                                  
*                                                                               
         MVC   WPATENT,B.PATENT                                                 
         MVC   W.PATFLG2,B.PATFLG2                                              
         XC    W.PATREF,W.PATREF   REF NUMBER = 0                               
         XC    W.PATSEQ,W.PATSEQ   CLEAR PAT SEQUENCE                           
         MVI   W.PATKEY,0          CLEAR PATTERN KEY  ??WAS NOPPED??            
*                                                                               
         OC    WORK+56(4),WORK+56  ANY DATES?                                   
         BZ    ADPAT84              NO                                          
         MVC   W.PATSTR(4),WORK+56                                              
*NOP*    OI    W.PATFLG2,OOPS                                                   
         XC    WORK+56(4),WORK+56                                               
         XC    DUB,DUB                                                          
         BAS   RE,ADDNEW           ADD NEW ENTRY TO TABLE                       
         OC    DUB,DUB             ANY TBA DATES                                
         BZ    ADPAT84              NO                                          
         BAS   RE,ADDTBA           ADD TBA DATES TO TABLE                       
*                                                                               
ADPAT84  OC    WORK+60(4),WORK+60  ANY DATES?                                   
         BZ    ADPAT85              NO                                          
         MVC   W.PATSTR(4),WORK+60                                              
*NOP*    OI    W.PATFLG2,OOPS                                                   
         XC    WORK+60(4),WORK+60                                               
         XC    DUB,DUB                                                          
         BAS   RE,ADDNEW           ADD NEW ENTRY TO TABLE                       
         OC    DUB,DUB             ANY TBA DATES                                
         BZ    ADPAT85              NO                                          
         BAS   RE,ADDTBA           ADD TBA DATES TO TABLE                       
*                                                                               
ADPAT85  OI    B.PATFLG2,NOPAT     DO NOT ADD TO PATTERN TABLE                  
         TM    SVFLAG,ENTDEL       ENTRY DELETED?                               
         BZ    ADPAT50              NO, BUMP TO NEXT ENTRY                      
*                                                                               
         NI    SVFLAG,X'FF'-ENTDEL RESET ENTRY DELETED                          
         B     ADPAT51                                                          
*                                                                               
ADPAT100 DS    0H                                                               
**       MVI   RDUPDATE,C'N'                                                    
**       GOTO1 SEQ                                                              
         GOTO1 AIOCALL,DMCB,SEQQ+DIRQ+XSPQ,0                                    
*                                                                               
         CLC   KEY(5),KEYSAVE                                                   
         BE    ADPAT12                                                          
*                                                                               
* COUNT NUMBER OF ENTRIES IN PATTERN TABLE AND RESORT THE TABLE                 
*                                                                               
         L     R2,APATABLE                                                      
         SR    R0,R0               PAT COUNTER                                  
*                                                                               
ADPAT160 OC    0(L'PATENT,R2),0(R2) EMPTY ENTRY?                                
         BZ    ADPAT170                                                         
*                                                                               
         LA    R2,PATNEXT-PATENT(R2)  GET NEXT ENTRY                            
         BCTR  R0,0                                                             
         C     R2,MAXPATBL         AT END OF TABLE                              
         BL    ADPAT160                                                         
         DC    H'0'                THIS SHOULD NEVER HAPPEN                     
*                                                                               
ADPAT170 LPR   R0,R0               PAT COUNTER                                  
                                                                                
* SORT ON PAT SEQ                                                               
         GOTO1 XSORT,DMCB,APATABLE,(R0),L'PATENT,2,PATSEQ-PATENT                
                                                                                
* SORT ON PATKEY                                                                
         GOTO1 (RF),(R1),APATABLE,(R0),L'PATENT,1,PATKEY-PATENT                 
                                                                                
* SORT ON PROD/LEN                                                              
         GOTO1 (RF),(R1),APATABLE,(R0),L'PATENT,8,PATPROD1-PATENT               
                                                                                
         BRAS  RE,PATSEL        SELECT MOST SPECIFIC PATS THAT APPLY            
                                                                                
         L     R2,APATABLE                                                      
         SR    R0,R0               PAT COUNTER                                  
*                                                                               
ADPAT180 OC    0(L'PATENT,R2),0(R2) EMPTY ENTRY?                                
         BZ    ADPAT190                                                         
*                                                                               
         LA    R2,PATNEXT-PATENT(R2)  GET NEXT ENTRY                            
         BCTR  R0,0                                                             
         C     R2,MAXPATBL         AT END OF TABLE                              
         BL    ADPAT180                                                         
         DC    H'0'                THIS SHOULD NEVER HAPPEN                     
*                                                                               
ADPAT190 LPR   R0,R0               PAT COUNTER                                  
                                                                                
* SORT ON PAT START AND END DATES                                               
         GOTO1 (RF),(R1),APATABLE,(R0),L'PATENT,4,PATSTR-PATENT                 
                                                                                
*                                                                               
ADPATX   DS    0H                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         XIT1                                                                   
         EJECT                                                                  
* COMPARE FOR SIMILAR ENTRY (IF ANY)                                            
*                                                                               
SMLRENT  NTR1                                                                   
*                            SAME PROG/PROD/FEED/DP/PATKEY?                     
         CLC   PATCOM(L'PATCOM-L'PATREF),W.PATCOM                               
         BE    SMLRX                                                            
*                                                                               
         CLC   W.PATSTR,PATEND     IS PAT START OUT OF DTE RANGE                
         BH    SMLRX                                                            
*                                                                               
         CLC   W.PATEND,PATSTR     IS PAT END OUT OF DTE RANGE                  
         BL    SMLRX                                                            
*                                                                               
         OC    PATSEQ,PATSEQ       ANY PAT ASSIGNED TO THIS                     
         BZ    *+14                                                             
         CLC   PATKEY,W.PATKEY      SAME PATTERN FLAVOR                         
         BNE   SMLRX                NO                                          
*                                                                               
*                            MAYBE JUST THE PROGRAM IS DIFFERENT                
         OC    PATPROG,PATPROG     ANY PROGRAM                                  
         BNZ   SMLRX                YES, DONE                                   
         CLC   PATPROD1(PATKEY-PATPROD1),W.PATPROD1                             
         BNE   *+14                                                             
         MVC   PATPROG,W.PATPROG                                                
         B     SMLRX                                                            
*                                                                               
*                            MAYBE JUST THE DAYPART IS DIFFERENT                
         CLI   PATDP,0             ANY DAYPART                                  
         BNE   SMLRX               YES, DONE                                    
         OC    PATENT(PATDP-PATENT),PATENT                                      
         BNE   *+14                                                             
         MVC   PATENT,W.PATDP                                                   
         B     SMLRX                                                            
*                                                                               
*                            MAYBE JUST THE FEED IS DIFFERENT                   
         OC    PATFEED,PATFEED     ANY FEED ?                                   
         BNZ   SMLRX                YES,DONE                                    
         CLC   PATENT(PATFEED-PATENT),W.PATENT                                  
         BNE   SMLRX                                                            
         CLC   PATFEED,W.PATFEED                                                
         BNE   SMLRX                                                            
         MVC   PATFEED,W.PATFEED                                                
*                                                                               
SMLRX    XIT1                                                                   
         SPACE 3                                                                
         EJECT                                                                  
* ADD NEW ENTRY TO THE TABLE                                                    
*                                                                               
ADDNEW   NTR1                                                                   
*                                                                               
         TM    W.PATFLG2,NOPAT     DO NOT ADD THIS ONE                          
         BO    ADNEWX              YES,DONE                                     
*                                                                               
         L     R5,APATABLE                                                      
*                                                                               
ADNEW10  OC    PATENT,PATENT       EMPTY ENTRY?                                 
         BZ    ADNEW40                                                          
*                                                                               
         CLC   PATCOM,W.PATCOM                                                  
         BNE   ADNEW20                                                          
*                                                                               
         CLC   W.PATSTR,PATEND     IS PAT START OUT OF DTE RANGE                
         BNH   *+12                                                             
         OI    PATFLG2,PATUSED                                                  
         B     ADNEW20              YES, GET NEXT ENTRY                         
*                                                                               
         CLC   W.PATEND,PATSTR     IS PAT END OUT OF DTE RANGE                  
         BNL   *+12                                                             
         OI    PATFLG2,PATUSED                                                  
         B     ADNEW20              YES                                         
*                                                                               
         CLC   PATENT(PATUNTCT-PATENT),WPATENT  SAME ENTRY?                     
         BE    ADNEWX               YES, DONE                                   
*                                                                               
*        OC    PATREF,PATREF        REF=0 ?                                     
         OC    PATSEQ,PATSEQ        REF=0 ?                                     
         BZ    ADNEW18                                                          
*                                                                               
* SAME PROG/PRD/SLN/FEED/DP/REF - DATES MUST HAVE CHANGED                       
*                                                                               
         CLC   W.PATSTR,PATEND     IS PAT START OUT OF DTE RANGE                
         BNH   *+14                                                             
*NOP*    OI    PATFLG2,OOPS        BUYS NO LONGER COVERED BY PAT                
         XC    PATKEY(3),PATKEY    CLEAR PAT KEY AND REF NUMBER                 
         B     ADNEW20             GET NEXT ENTRY                               
*                                                                               
         CLC   W.PATEND,PATSTR     IS PAT END OUT OF DTE RANGE                  
         BNL   *+14                                                             
*NOP*    OI    PATFLG2,OOPS        BUYS NO LONGER COVERED BY PAT                
         XC    PATKEY(3),PATKEY    CLEAR PAT KEY AND REF NUMBER                 
         B     ADNEW20             GET NEXT ENTRY                               
*                                                                               
         CLC   W.PATSTR,PATSTR     IS PAT START DATE EARLIER                    
         BNH   ADNEW12              YES, KEEP IT                                
*                                                                               
* SAVE THE DATES THAT ARE NOT COVERED BY PATTERN (TBA)                          
*                                                                               
         MVC   DUB(L'PATSTR),PATSTR  START DATE                                 
*                                                                               
         GOTO1 DATCON,DMCB,(2,W.PATSTR),(0,WORK) START DATE                     
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'-1' START DATE -1 AS END DATE           
         GOTO1 DATCON,(R1),(0,WORK+6),(2,DUB+2)   END DATE                      
*                                                                               
         MVC   PATSTR,W.PATSTR      THEN MOVE IN NEW DATE                       
*                                                                               
ADNEW12  CLC   W.PATEND,PATEND     IS PAT END DATE LATER                        
         BNL   ADNEW16              YES, KEEP IT                                
*                                                                               
* SAVE THE DATES THAT ARE NOT COVERED BY PATTERN (TBA)                          
*                                                                               
         GOTO1 DATCON,DMCB,(2,W.PATEND),(0,WORK) START DATE                     
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'1' END DATE +1 AS START DATE            
         GOTO1 DATCON,(R1),(0,WORK+6),(2,DUB+4)   START DATE                    
*                                                                               
         MVC   DUB+6(L'PATEND),PATEND  END DATE                                 
*                                                                               
         MVC   PATEND,W.PATEND      THEN MOVE NEW DATE                          
*                                                                               
ADNEW16  OC    DUB,DUB             ANY TBA DATES                                
         BZ    ADNEW18                                                          
         BAS   RE,TBADATES         MERGE TBA DATES IF POSSIBLE                  
         B     ADNEWX                                                           
*                                                                               
ADNEW18  BAS   RE,SMLRENT          SIMILAR ENTRY ?                              
         BE    ADNEW30                                                          
*                                                                               
ADNEW20  LA    R5,PATNEXT          GET NEXT ENTRY                               
         C     R5,MAXPATBL         AT END OF TABLE                              
         BNL   PATSIZR             TABLE TOO SMALL                              
         B     ADNEW10                                                          
*                                                                               
* SIMILAR ENTRY JUST MOVE IN PATKEY AND REF #                                   
*                                                                               
ADNEW30  MVC   PATKEY,W.PATKEY                                                  
         MVC   PATREF,W.PATREF                                                  
         MVC   PATSEQ,W.PATSEQ     NOTE THIS                                    
         MVC   PATSTR,W.PATSTR      THEN MOVE IN PAT START                      
         MVC   PATEND,W.PATEND      AND END DATES                               
         OI    PATFLG2,PATUSED                                                  
         NI    SVFLAG,X'FF'-ENTDEL RESET ENTRY DELETED                          
         B     ADNEWX                                                           
*                                                                               
ADNEW40  DS    0H                                                               
         MVC   0(L'PATENT,R5),WPATENT  ADD ENTRY TO THE END OF TABLE            
*                                                                               
         NI    SVFLAG,X'FF'-ENTDEL RESET ENTRY DELETED                          
*                                                                               
         L     R1,FULL                                                          
         AH    R1,=AL2(PATNEXT-PATENT)                                          
         ST    R1,FULL                                                          
*                                                                               
         OI    PATFLG2,PATUSED     PAT USED                                     
*                                                                               
         OC    PATPROG,PATPROG     ALL DONE UNLESS ALL PROG                     
         BNZ   ADNEWX                                                           
*                                                                               
         BAS   RE,ALLPGADD                                                      
*                                                                               
ADNEWX   XIT1                                                                   
*                                                                               
* ADD TBA DATES TO TABLE                                                        
*                                                                               
ADDTBA   NTR1                                                                   
         OC    DUB(4),DUB                                                       
         BZ    ADDTBA10                                                         
         MVC   W.PATSTR(4),DUB                                                  
         XC    DUB(4),DUB                                                       
         XC    W.PATKEY(3),W.PATKEY CLEAR PAT KEY AND REF                       
         BAS   RE,ADDNEW                                                        
*                                                                               
ADDTBA10 OC    DUB+4(4),DUB+4                                                   
         BZ    ADDTBAX                                                          
         MVC   W.PATSTR(4),DUB+4                                                
         XC    DUB+4(4),DUB+4                                                   
         XC    W.PATKEY(3),W.PATKEY CLEAR PAT KEY AND REF                       
         BAS   RE,ADDNEW                                                        
*                                                                               
ADDTBAX  XIT1                                                                   
         SPACE 3                                                                
* MERGE TBA DATES IF POSSIBLE                                                   
*                                                                               
TBADATES OC    DUB,DUB             ANY TBA DATES                                
         BZ    TBAX                 NO, DONE                                    
         OC    WORK+56(8),WORK+56                                               
         BZ    TBA60                THERE IS ONLY ONE SET OF TBA DATES          
*                                                                               
         OC    DUB(4),DUB                                                       
         BZ    TBA30                                                            
         CLC   DUB+2(2),WORK+56    END DATE BEFORE START                        
         BL    TBA20                YES                                         
         CLC   DUB(2),WORK+58      START AFTER END                              
         BH    TBA20                YES                                         
         XC    DUB(4),DUB          THE DATES ALREADY THERE                      
*                                                                               
TBA20    CLC   DUB+2(2),WORK+60    END DATE BEFORE START                        
         BL    TBA30                YES                                         
         CLC   DUB(2),WORK+62      START AFTER END                              
         BH    TBA30                YES                                         
         XC    DUB(4),DUB          THE DATES ALREADY THERE                      
*                                                                               
TBA30    OC    DUB+4(4),DUB+4                                                   
         BZ    TBAX                                                             
         CLC   DUB+6(2),WORK+60    END DATE BEFORE START                        
         BL    TBA50                YES                                         
         CLC   DUB+4(2),WORK+62    START AFTER END                              
         BH    TBA50                YES                                         
         XC    DUB+4(4),DUB+4      THE DATES ALREADY THERE                      
*                                                                               
TBA50    CLC   DUB+6(2),WORK+56    END DATE BEFORE START                        
         BL    TBAX                 YES                                         
         CLC   DUB+4(2),WORK+58    START AFTER END                              
         BH    TBAX                 YES                                         
         XC    DUB+4(4),DUB+4      THE DATES ALREADY THERE                      
         B     TBAX                                                             
*                                                                               
TBA60    MVC   WORK+56(8),DUB       MOVE TBA DATES TO WORK                      
         XC    DUB,DUB                                                          
*                                                                               
TBAX     BR    RE                                                               
         SPACE 3                                                                
* ADD AN ENTRY TO ALL PROGRAM TABLE                                             
*                                                                               
ALLPGADD NTR1                                                                   
*                                                                               
         LA    RE,ELEM                                                          
         USING ALLPRGD,RE                                                       
         XC    ELEM,ELEM                                                        
         MVC   ALLPGP1,W.PATPROD1                                               
         MVC   ALLPGP2,W.PATPROD2                                               
         MVC   ALLPGS1,W.PATSLN                                                 
         MVC   ALLPGS2,W.PATSLN2                                                
*        MVC   ALLPGREF,W.PATREF                                                
*                                                                               
         MVC   ALLPGSEQ,W.PATSEQ                                                
*                                                                               
         MVC   ALLPGKEY,W.PATKEY                                                
         MVC   ALLPGFD,W.PATFEED                                                
         MVC   ALLPGDP,W.PATDP                                                  
         OC    W.PATPROG,W.PATPROG                                              
         BZ    *+18                                                             
         CLI   W.PATPROG,X'FF' IF 1ST BYTE IS FF                                
         BE    *+10                THEN NOT PROG SPECIFIC                       
         MVC   ALLPGPRG,W.PATPROG                                               
*                                                                               
         L     RE,ALLPRTAB         START OF ALL PROGRAM TABLE                   
         L     RF,MAXPRTAB         END OF ALL PROG TABLE                        
*                                                                               
ADDPG10  OC    ALLPGENT,ALLPGENT   EMPTY ENTRY                                  
         BZ    ADDPG20                                                          
         CLC   ALLPGCMP,ELEM       ALREADY IN TABLE                             
         BE    ADNEWX                                                           
         LA    RE,ALLPGNXT                                                      
         CR    RE,RF                                                            
         BNH   ADDPG10                                                          
         DC    H'0'                                                             
ADDPG20  MVC   ALLPGENT,ELEM       ADD ENTRY TO TABLE                           
         B     ADNEWX                                                           
         SPACE 3                                                                
PATSIZR  MVC   GERROR,=Y(MANYPAT)                                               
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,3              L'SUBST TEXT + 1                             
         MVC   ELEM+1(2),=C'70'                                                 
         LA    R2,TRACLTH                                                       
         OC    AERRFILE,AERRFILE         STORED DCB ADDRESS                     
         BZ    PATSZRA                                                          
*                                                                               
         L     R3,AERRFILE         STORED DCB ADDRESS                           
         CLOSE ((R3),)                                                          
         FREEPOOL (R3)                                                          
*                                                                               
         XC    AERRFILE,AERRFILE   SET FILE NOT OPEN                            
*                                                                               
PATSZRA  GOTO1 VTRAERR                                                          
         EJECT                                                                  
         LTORG                                                                  
         DROP  W,B,RB                                                           
*                                                                               
*--------------------------------------                                         
* DELETE AN ENTRY FROM PAT TABLE                                                
*--------------------------------------                                         
*                                                                               
DELENT   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    WPATENT,WPATENT                                                  
         MVC   WPATENT,PATENT      MOVE ENTRY TO WORK                           
*                                                                               
         LR    R0,R5               CURRENT ENTRY IN TABLE                       
         L     R1,APATABLE                                                      
         A     R1,FULL             END OF TABLE                                 
         LR    RF,R1               NEED TO CALC FROM LENGTH                     
         SR    R1,R5               LENGTH TO MOVE TO                            
         LA    RE,PATNEXT          MOVE FROM                                    
         SR    RF,RE               LENGTH TO MOVE FROM                          
         MVCL  R0,RE                                                            
         L     R1,FULL                                                          
         SH    R1,=AL2(PATNEXT-PATENT)                                          
         ST    R1,FULL                                                          
*                                                                               
         OI    SVFLAG,ENTDEL       ENTRY DELETED                                
*                                                                               
         XIT1                                                                   
*                                                                               
         DROP  R5                                                               
         EJECT                                                                  
*                                                                               
*------------------------------------------------------------------*            
* READ THROUGH BUYS AND BUILD UNIT TABLE OF PATTERNS FOR 1 PROGRAM *            
*------------------------------------------------------------------*            
*                                                                               
BLPAT    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PRGTABLD,R5                                                      
         TM    SVOPTSW1,OPT1EACH                                                
         BO    BLPAT04                                                          
*                                                                               
BLPAT02  LA    R1,PRGNEXT          SAVE NEXT PRG ENTRY FOR NEXT ROUND           
         ST    R1,NXTPRG                                                        
         TM    PRGFLG,X'10'        WAS THIS PROGRAM SELECTED                    
         BZ    BLPAT84                                                          
*                                                                               
* CK ANY ERRORS FROM TABLE *                                                    
*                                                                               
BLPAT04  TM    PRGFLG,X'01'        NET ASSIGN LAST RUN-MUST BE NET SEED         
         BO    NETASSER                                                         
         TM    PRGFLG,X'04'        POSITION FOUND                               
         BO    POSER                                                            
         TM    PRGFLG,X'02'        BILLBOARD FOUND                              
         BO    BILBDER                                                          
*                                                                               
         OI    UPDSW,X'02'         SET ON ONLY SKED UNITS SW                    
*                                                                               
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROG?                           
         BO    BLPAT84                                                          
*                                                                               
         MVC   SVPROG,PRGPRG                                                    
         MVC   SVPROGDT,PRGHIDTE                                                
         MVC   BASEPRG,PRGPRG                                                   
         MVC   BASEDTS,STDATEP                                                  
         MVI   BASECT,0                                                         
*                                                                               
         BRAS  RE,NETI              INITIALIZE NETIO                            
*                                                                               
         MVC   NBSELPRG,PRGPRG                                                  
*                                                                               
         LA    R5,BLPATENT                                                      
         USING PATABLED,R5                                                      
*                                                                               
* FIRST READ - MUST IGNORE BAD NBSUBMSK SETTINGS *                              
*                                                                               
BLPAT06  GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    BLPAT08                                                          
         DC    H'0'                                                             
BLPAT08  DS    0H                                                               
         CLI   NBMODE,NBREQLST                                                  
         BE    BLPAT70                                                          
         CLI   NBMODE,NBPROCUN                                                  
         BNE   BLPAT06                                                          
         EJECT                                                                  
* PROCESS UNITS *                                                               
*                                                                               
BLPAT10  L     R6,NBAIO                                                         
         MVI   DATADISP+1,27       SET FROM SPOT TO NET                         
*                                                                               
         CLC   STDATEP,NBACTDAT                                                 
         BH    BLPAT12                                                          
         CLC   ENDATEP,NBACTDAT                                                 
         BNL   *+6                                                              
BLPAT12  DC    H'0'                                                             
*                                                                               
* SEE IF MEDIA OR TRAFFIC SKED UNIT *                                           
*                                                                               
         CLI   SVTNPR9,C'B'        BOTH MEDIA AND SKED                          
         BE    BLPAT20                                                          
         CLI   SVTNPR9,C'S'        IF NOT SKED, MEDIA DEFAULT                   
         BNE   *+16                                                             
         CLI   NBACTSUB,C'A'       SKED ONLY                                    
         BL    BLPAT60                                                          
         B     BLPAT20                                                          
*                                                                               
         CLI   NBACTSUB,C'A'                                                    
         BNL   BLPAT60                                                          
*                                                                               
BLPAT20  TM    NBUNITST,X'42'     PREEMPTED OR MISSED                           
         BNZ   BLPAT60             TREAT AS DELETED                             
         TM    22(R6),X'80'       DELETED UNIT                                  
         BO    BLPAT60                                                          
         CLI   NBPR1CL3,0          UNALLOCATED                                  
         BNE   *+12                                                             
         CLI   SVCSPRD,0                                                        
         BE    BLPAT60              BYPASS                                      
*                                                                               
         CLI   NBACTSUB,C'A'       THIS A SKED UNIT                             
         BNL   BLPAT24              YES, NO CKEST                               
*                                                                               
         BRAS  RE,CKEST                                                         
         BE    BLPAT60                                                          
*                                                                               
* CK PRODUCT OR PRODUCT GROUP FILTER *                                          
*                                                                               
BLPAT24  CLC   OPTPROD,SPACES                                                   
         BNH   BLPAT26                                                          
         CLC   NBPR1CL3,OPTPROD                                                 
         BE    BLPAT26                                                          
*                                                                               
         CLI   NBPR1CL3,0                                                       
         BE    BLPAT60                                                          
*                                                                               
         LHI   RE,SVCSPRDQ                                                      
         LA    RF,SVCSPRD                                                       
BLPAT25  CLI   0(RF),0                                                          
         BE    BLPAT60                                                          
         CLC   OPTPROD,0(RF)                                                    
         BE    BLPAT26                                                          
         LA    RF,L'SVCSPRD(RF)                                                 
         BCT   RE,BLPAT25                                                       
         B     BLPAT60                                                          
*                                                                               
BLPAT26  DS    0H                                                               
*** BRAND LEVEL SECURITY NOT USED                                               
*&&DO                                                                           
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLPAT27                                                          
*                                                                               
         LA    R0,NCLSTSIZ         FIND PROD                                    
         L     R1,ASVNCLST                                                      
*                                                                               
         LA    RF,NBPRD                                                         
         CLI   NBPRD,0             ANY PROD                                     
         BNE   BLPAT26H                                                         
*                                                                               
         LA    RF,SVCSPRD                                                       
         CLI   SVCSPRD,0                                                        
         BE    BLPAT27             UNALLOCATED                                  
*                                                                               
BLPAT26H CLC   0(1,RF),3(R1)                                                    
         BE    BLPAT27                                                          
         LA    R1,4(R1)                                                         
         CLI   0(R1),C' '                                                       
         BNH   *+8                                                              
         BCT   R0,BLPAT26H                                                      
         B     BLPAT60                                                          
*&&                                                                             
*                                                                               
BLPAT27  OC    OPTPRGR,OPTPRGR    ANY PRODUCT GROUP                             
         BZ    *+12                 NO                                          
         BAS   RE,FPGR             FILTER ON PRODUCT GROUP                      
         BNE   BLPAT60                                                          
*                                                                               
* SEE IF EQV UNIT, IF SO FORCE TO BASE PROG CODE, PUT IN BASEPRG                
*                                                                               
         BAS   RE,CEQV                                                          
         BNE   BLPAT60                                                          
*                                                                               
         XC    PATENT(L'PATENT),PATENT                                          
         EJECT                                                                  
* SAVE UNIT INFO IN TABLE *                                                     
*                                                                               
         CLI   NBPR1CL3,0                                                       
         BNE   BLPAT28                                                          
*                                                                               
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BO    BLPAT29              YES                                         
         DC    H'0'                                                             
*                                                                               
BLPAT28  MVC   PATPROD1,NBPR1CL3                                                
*                                                                               
BLPAT29  MVC   PATSLN,NBLEN                                                     
*                                                                               
*SEE IF THIS UNIT HAS 5 SECONDS TAG                                             
* (IF SO FIX UNIT LENGTH)                                                       
*                                                                               
         MVI   ELCODE,X'60'                                                     
         LA    R6,27(R6)                                                        
BLPATG10 BRAS  RE,NEXTEL                                                        
         BNE   BLPATGX                                                          
*                                                                               
         CLI   2(R6),C'Q'          IS THIS A TAG ELEMENT                        
         BNE   BLPATG10                                                         
         CLI   3(R6),C'T'          T=TAG                                        
         BNE   BLPATG10                                                         
*                                                                               
         PACK  DUB,4(1,R6)                                                      
         CVB   R0,DUB              TAGS IN BINARY                               
         MHI   R0,5                TIMES 5 (5 SECONDS PER TAG)                  
         LLC   R1,PATSLN           TOTAL UNIT LEN                               
         SR    R1,R0               MINUS TAG LEN                                
         STC   R1,PATSLN           = ACTUAL UNIT LENGTH                         
*                                                                               
         OI    PATFLG2,TAGFLG      TURN ON TAG FLAG                             
*                                                                               
BLPATGX  DS    0H                                                               
*                                                                               
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BO    BLPAT30              YES                                         
         CLI   NBPR2CL3,0                                                       
         BE    BLPAT30                                                          
         MVC   PATPROD2,NBPR2CL3                                                
         OI    ANYFLAG,PIGGBSW     PIGGY BACKS PRESENT                          
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         ICM   R1,3,NBP1SHR                                                     
         LLC   RF,PATSLN                                                        
         MR    R0,RF                                                            
         AH    R1,=H'5000'                                                      
         D     R0,=F'10000'                                                     
         STC   R1,PATSLN                                                        
         SR    RF,R1                                                            
         STC   RF,PATSLN2                                                       
         CLC   PATPROD1,PATPROD2    ENSURE SEQUENCE                             
         BL    BLPAT30                                                          
         BH    *+6                                                              
         DC    H'0'                                                             
         XC    PATPROD1,PATPROD2   SWAP PRODS AND SLN'S IN PLACE                
         XC    PATPROD2,PATPROD1                                                
         XC    PATPROD1,PATPROD2                                                
         XC    PATSLN,PATSLN2                                                   
         XC    PATSLN2,PATSLN                                                   
         XC    PATSLN,PATSLN2                                                   
*                                                                               
* GET TRAFFIC INFO *                                                            
*                                                                               
BLPAT30  NI    SVFLAG,X'FF'-SVFLGFDD  INIT FEED NO NATIONAL FLAG                
         L     R6,NBAIO                                                         
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BLPAT40                                                          
         USING NUCMLEL,R6                                                       
         CLI   SVTNPR5,C'Y'       TRAFFIC DELETES ALLOWED                       
         BNE   BLPAT32             NO                                           
         TM    NUCMLFLG,X'08'                                                   
         BO    BLPAT60            BYPASS                                        
*                                                                               
BLPAT32  TM    NBUNST3,X'40'       COPY SPLIT                                   
         BZ    BLPAT34              NO                                          
         OI    ANYFLAG,COPYSSW     COPY SPLITS PRESENT                          
         CLC   NUCMPROD,SPACES                                                  
         BNH   BLPAT31                                                          
         CLC   NUCMPROD,NBPR1CL3                                                
         BE    BLPAT34                                                          
         MVC   PATPROD1,NUCMPROD                                                
         B     BLPAT34                                                          
*                                                                               
BLPAT31  CLC   NUCMLPRD,NBPRD                                                   
         BE    BLPAT34                                                          
         LA    RF,NUCMLPRD                                                      
         BRAS  RE,FPROD                                                         
         MVC   PATPROD1,QPRD                                                    
**       MVC   PATPRD,NUCMLPRD                                                  
BLPAT34  TM    NUCMLFL2,NUCMLFFD   FEED NO NATIONAL                             
         BZ    *+12                                                             
         OI    SVFLAG,SVFLGFDD      YES, TURN ON FLAG                           
         B     BLPAT45                                                          
*                                                                               
         TM    NUCMLFLG,X'E0'      NEED REASSIGN                                
         BNZ   BLPAT38              YES, TREAT AS UNASSIGNED                    
*                                                                               
         OC    NUCMLPOS,NUCMLPOS   NO POSITION ALLOWED                          
         BZ    *+6                                                              
         DC    H'0'                                                             
         CLI   NUCMLBSL,0          BILLBOARD NG                                 
         BE    *+6                                                              
         DC    H'0'                                                             
*        MVC   PATREF,NUCMLREF                                                  
         MVC   PATSEQ,NUCMLREF     IS NOW PTN SEQ NO                            
         OC    PATSEQ,PATSEQ       IF NO PAT ASSIGNED                           
         BNZ   *+10                                                             
         MVC   PATDP,NBACTDP       THEN SAVE UNIT DAYPART                       
                                                                                
         MVC   PATKEY,NUCMLKEY                                                  
                                                                                
* CHANGE SOME PATKEY VALUES FOR SORTING PURPOSES                                
         TM    PATKEY,X'80'        PROG SPECIFIC PATTERN                        
         BZ    *+12                                                             
         NI    PATKEY,X'FF'-X'80'                                               
         OI    PATKEY,PATKPRG                                                   
                                                                                
         TM    PATKEY,X'40'        FEED SPECIFIC PATTER                         
         BZ    *+12                                                             
         NI    PATKEY,X'FF'-X'40'                                               
         OI    PATKEY,PATKFD                                                    
                                                                                
         TM    PATKEY,X'20'        DAYPART SPECIFIC PATTERN                     
         BZ    *+12                                                             
         NI    PATKEY,X'FF'-X'20'                                               
         OI    PATKEY,PATKDP                                                    
                                                                                
         TM    PATKEY,PATKDP       THIS DAYPART SPECIFIC                        
         BZ    *+10                                                             
         MVC   PATDP,NBACTDP                                                    
*                                                                               
*        OC    PATREF,PATREF       IF ZERO REF (UNASSIGNED)                     
         OC    PATSEQ,PATSEQ       IF ZERO SEQ (UNASSIGNED)                     
         BNZ   BLPAT36              FORCE PROGRAM SPECIFIC                      
*                                                                               
         OC    NUCML1,NUCML1       IF COMML ASSIGNED                            
         BNZ   NETASSER             MUST BE FROM NET ASSIGN                     
*                                                                               
BLPAT36  TM    PATKEY,PATKPRG      PROGRAM SPECIFIC                             
         BZ    BLPAT38                                                          
         MVC   PATPROG,NBACTPRG                                                 
*                                                                               
BLPAT38  TM    NUCMLFL2,NUCMLFFD   FEED NO NATIONAL     *TEMP                   
         BO    BLPAT45              YES                                         
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BZ    BLPAT40              NO                                          
         CLC   NUCMPROD,SPACES                                                  
         BNH   *+14                                                             
         MVC   PATPROD1,NUCMPROD                                                
         B     BLPAT40                                                          
*                                                                               
         LA    RF,NUCMLPRD                                                      
         BRAS  RE,FPROD                                                         
         MVC   PATPROD1,QPRD                                                    
**       MVC   PATPRD,NUCMLPRD                                                  
*                                                                               
         DROP  R6                                                               
*                                                                               
* IS THIS A FEED ? *                                                            
*                                                                               
BLPAT40  MVI   ELCODE,X'22'                                                     
         L     R6,NBAIO                                                         
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   PATFEED,2(R6)                                                    
*                                                                               
         BAS   RE,BPTBL            BUILD PATTERN TABLE                          
*                                                                               
         EJECT                                                                  
* GET ANY POSSIBLE FEEDS *                                                      
*                                                                               
BLPAT45  L     R6,NBAIO                                                         
         MVI   ELCODE,X'23'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BLPAT60                                                          
         USING NUFDCEL,R6                                                       
BLPAT50  TM    NUFDCFL2,X'80'      FEED DELETED                                 
         BO    BLPAT56              YES, BYPASS                                 
*                                                                               
         CLI   NUFDCBSL,0          FEED BILLBOARD                               
         BE    *+6                                                              
         DC    H'0'                                                             
         OC    NUFDCPOS,NUFDCPOS   FEED POSITION                                
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BZ    BLPAT52              NO                                          
*                                                                               
         CLC   NUFDPROD,SPACES                                                  
         BNH   *+14                                                             
         MVC   PATPROD1,NUFDPROD                                                
         B     BLPAT52                                                          
*                                                                               
         LA    RF,NUFDCPRD                                                      
         BRAS  RE,FPROD                                                         
         MVC   PATPROD1,QPRD                                                    
**       MVC   PATPRD,NUFDCPRD                                                  
*                                                                               
BLPAT52  TM    PATFLG,X'80'        NEED REASSIGN                                
         BO    BLPAT54             YES, TREAT AS UNASSIGNED                     
*        MVC   PATREF,NUFDCREF                                                  
         MVC   PATSEQ,NUFDCREF                                                  
         MVC   PATKEY,NUFDCKEY                                                  
         TM    PATKEY,PATKDP       THIS DAYPART SPECIFIC                        
         BZ    *+10                                                             
         MVC   PATDP,NBACTDP                                                    
BLPAT54  MVC   PATFEED,NUFDCFED                                                 
*                                                                               
         BAS   RE,BPTBL            BUILD PATTERN TABLE                          
*                                                                               
BLPAT56  BRAS  RE,NEXTEL                                                        
         BE    BLPAT50                                                          
*                                                                               
BLPAT60  GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    BLPAT64                                                          
         DC    H'0'                                                             
BLPAT64  DS    0H                                                               
         TM    NBSUBMSK,NBSBMCLI+NBSBMNET+NBSBMPRG                              
         BNZ   BLPAT70                                                          
         CLI   NBMODE,NBREQLST                                                  
         BE    BLPAT70                                                          
         CLI   NBMODE,NBPROCUN                                                  
         BNE   BLPAT60                                                          
         B     BLPAT10                                                          
*                                                                               
BLPAT70  DS   0H                                                                
         LA    RE,EQVPTBL                                                       
         LA    RF,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         USING EQVPTBLD,RE                                                      
BLPAT72  OC    EQVENT,EQVENT       EMPTY ENTRY IS END                           
         BZ    BLPAT80                                                          
         CLC   EQVBPRG,SVPROG      THIS SAME AS CURRENT                         
         BNE   BLPAT74                                                          
         CLI   EQVUSED,C'Y'        ENTRY HAVE UNITS & NOT BEEN USED             
         BE    BLPAT76                                                          
BLPAT74  LA    RE,EQVNEXT                                                       
         BCT   RF,BLPAT72                                                       
*                                                                               
         B     BLPAT80                                                          
*                                                                               
BLPAT76  MVI   EQVUSED,C'U'        SET TO USED                                  
         MVC   BASEPRG,EQVEPRG                                                  
         MVC   BASEDTS,EQVSDT                                                   
*                                                                               
         CLC   BASEEND,ENDATEP     IS END DATE PAST PERIOD END                  
         BNH   *+10                                                             
         MVC   BASEEND,ENDATEP     CUTAIL END DATE                              
*                                                                               
         MVC   BASECT,EQVCT                                                     
         DROP  RE                                                               
         BRAS  RE,NETI                                                          
*                                                                               
BLPAT78  GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   NBMODE,NBREQLST                                                  
         BE    BLPAT72                                                          
         CLI   NBMODE,NBPROCUN                                                  
         BNE   BLPAT78                                                          
         CLC   NBACTPRG,NBSELPRG                                                
         BNE   BLPAT72                                                          
         B     BLPAT10                                                          
*                                                                               
BLPAT80  MVI   DATADISP+1,24       SET FROM NET TO SPOT                         
*                                                                               
         TM    SVOPTSW1,OPT1EACH   DO EACH PROGRAM SEPARATELY                   
         BO    BLPAT90                                                          
BLPAT84  L     R5,NXTPRG           GET NEXT PROG ENTRY                          
         OC    0(6,R5),0(R5)       CK END OF ENTRIES                            
         BNZ   BLPAT02                                                          
*                                                                               
BLPAT90  ICM   R0,15,PTTNCTR       ANY UNITS FOUND                              
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
*NOP     GOTO1 XSORT,DMCB,APATABLE,(R0),L'PATENT,4,24                           
******   GOTO1 (RF),(R1),APATABLE,(R0),L'PATENT,L'PATSORT,0                     
                                                                                
* SORT ON PAT SEQ                                                               
         GOTO1 XSORT,DMCB,APATABLE,(R0),L'PATENT,2,PATSEQ-PATENT                
                                                                                
* SORT ON PROD/LEN                                                              
         GOTO1 (RF),(R1),APATABLE,(R0),L'PATENT,8,PATPROD1-PATENT               
                                                                                
* SORT ON PAT START AND END DATES                                               
         GOTO1 (RF),(R1),APATABLE,(R0),L'PATENT,4,PATPSTR-PATENT                
                                                                                
*                                                                               
* LEAVE R0 ALONE - USED LATER IN RDPAT FOR SORT                                 
*                                                                               
         BAS   RE,RDPAT            GO READ ALL PATTERNS                         
*                                                                               
BLPATX   XIT1                                                                   
*                                                                               
BILBDER  MVC   GERROR,=Y(BBASGND)                                               
         B     *+20                                                             
POSER    MVC   GERROR,=Y(POSASGND)                                              
         B     *+10                                                             
NETASSER MVC   GERROR,=Y(NASSRUN)                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,7              L'SUBST TEXT + 1                             
         MVC   ELEM+1(6),NBACTPRG                                               
         B     BLPATERX                                                         
*                                                                               
BLPATERX OC    AERRFILE,AERRFILE         STORED DCB ADDRESS                     
         BZ    BLPATERY                                                         
*                                                                               
         L     R3,AERRFILE         STORED DCB ADDRESS                           
         CLOSE ((R3),)                                                          
         FREEPOOL (R3)                                                          
*                                                                               
         XC    AERRFILE,AERRFILE   SET FILE NOT OPEN                            
*                                                                               
BLPATERY GOTO1 VTRAERR                                                          
         DROP  R5                                                               
         EJECT                                                                  
* FILTER ON PRODUCT GROUP *                                                     
*                                                                               
FPGR     NTR1                                                                   
         LHI   R0,OPTPGRLQ                                                      
         L     R1,AOPTPGRL                                                      
FPGR10   CLC   NBPR1CL3,0(R1)                                                   
         BE    FPGREQ                                                           
*                                                                               
         CLI   NBPR1CL3,0                                                       
         BNE   FPGR30                                                           
*                                                                               
         LHI   RE,SVCSPRDQ                                                      
         LA    RF,SVCSPRD                                                       
FPGR20   CLI   0(RF),0                                                          
         BE    FPGR30                                                           
         CLC   0(L'OPTPGRL,R1),0(RF)                                            
         BE    FPGREQ                                                           
         LA    RF,L'SVCSPRD(RF)                                                 
         BCT   RE,FPGR20                                                        
*                                                                               
FPGR30   LA    R1,L'OPTPGRL(R1)                                                 
         CLI   0(R1),0                                                          
         BNH   *+8                                                              
         BCT   R0,FPGR10                                                        
         CR    RD,RB                                                            
         B     *+6                                                              
FPGREQ   CR    RB,RB                                                            
         XIT1                                                                   
         EJECT                                                                  
* BUILD PATTERN TABLE *                                                         
*                                                                               
         DS   0H                                                                
BPTBL    NTR1                                                                   
         L     R5,APATABLE                                                      
         USING PATABLED,R5                                                      
B        USING PATABLED,BLPATENT                                                
BPTBL10  OC    PATENT,PATENT       EMPTY ENTRY                                  
         BZ    BPTBL20                                                          
         CLC   PATCOM,BLPATCOM     EQUAL ENTRY                                  
         BE    BPTBL30                                                          
BPTBL12  LA    R5,PATNEXT                                                       
         C     R5,MAXPATBL         AT END OF TABLE                              
         BL    BPTBL10                                                          
         B     PATSIZER                                                         
*                                                                               
BPTBL20  MVC   PATENT,BLPATENT                                                  
*                                                                               
         MVC   PATSTR,=X'FFFF'                                                  
         XC    PATEND,PATEND                                                    
*                                                                               
         L     R1,PTTNCTR                                                       
         LA    R1,1(,R1)                                                        
         ST    R1,PTTNCTR                                                       
*                                                                               
BPTBL30  TM    SVFLAG,SVFLGFDD      FEED NO NATIONAL                            
         BZ    *+8                                                              
         OI    PATFLG,PATFLFDD      YES, TURN IT ON IN PAT TABLE                
*                                                                               
* CALCULATE NUMBER OF DAYS IN DAY SPREAD *                                      
*                                                                               
         GOTO1 DATCON,DMCB,(2,NBACTDAT),(0,WORK)                                
         GOTO1 GETDAY,DMCB,WORK,WORK+6                                          
         LLC   RF,0(R1)            GET DAY OF WEEK                              
*                                                                               
         XC    WORK,WORK                                                        
         LLC   R0,NBSDROT                                                       
         SLL   R0,25                                                            
         SR    R1,R1               CLEAR COUNTER                                
*                                                                               
BPTBL34  LTR   RF,RF                                                            
         BZ    BPTBL36                                                          
         SLL   R0,1                                                             
         BCT   RF,*-4                                                           
*                                                                               
BPTBL36  DS    0H                                                               
         LTR   R0,R0               SHIFT TILL NO MORE BITS ON                   
         BZ    BPTBL36E                                                         
         SLL   R0,1                                                             
         BCT   R1,BPTBL36                                                       
*                                                                               
BPTBL36E LPR   R0,R1                                                            
*                                                                               
         GOTO1 DATCON,DMCB,(2,NBACTDAT),(0,WORK)                                
         GOTO1 ADDAY,(R1),WORK,WORK+6,(R0)                                      
         GOTO1 DATCON,(R1),(0,WORK+6),(2,WORK+12)                               
*                                                                               
         CLC   ENDATEP,WORK+12     PAST END OF PERIOD                           
         BNL   *+10                 NO                                          
         MVC   WORK+12(2),ENDATEP  FORCE TO PERIOD END DATE                     
*                                                                               
         CLC   NBACTDAT,PATSTR                                                  
         BNL   BPTBL37C                                                         
*                                                                               
         CLC   PATSTR,=X'FFFF'     NEED REAL START DATE                         
         BE    BPTBL37              YES, SAVE IT                                
                                                                                
         OC    B.PATSEQ,B.PATSEQ   ANY PAT SEQ                                  
         BNZ   BPTBL37              YES                                         
                                                                                
* COMBINE TBA DATES ONLY IF THEY ARE CONTIGUOUS                                 
         GOTO1 DATCON,DMCB,(2,NBACTDAT),(0,WORK+20)                             
         GOTO1 ADDAY,(R1),WORK+20,WORK+26,F'+1'                                 
         GOTO1 DATCON,(R1),(0,WORK+26),(2,WORK+32)                              
         CLC   PATSTR,WORK+32                                                   
         BNE   BPTBL12                                                          
*                                                                               
BPTBL37  MVC   PATSTR,NBACTDAT                                                  
*                                                                               
BPTBL37C CLC   WORK+12(2),PATEND                                                
         BNH   BPTBL37F                                                         
*                                                                               
         OC    PATEND,PATEND       NEED REAL END DATE                           
         BZ    BPTBL37E             YES, SAVE IT                                
*                                                                               
         OC    B.PATSEQ,B.PATSEQ   ANY PAT SEQ                                  
         BNZ   BPTBL37E             YES                                         
                                                                                
* COMBINE TBA DATES ONLY IF THEY ARE CONTIGUOUS                                 
         GOTO1 DATCON,DMCB,(2,PATEND),(0,WORK+20)                               
         GOTO1 ADDAY,(R1),WORK+20,WORK+26,F'+1'                                 
         GOTO1 DATCON,(R1),(0,WORK+26),(2,WORK+32)                              
         CLC   WORK+12(2),WORK+32                                               
         BNE   BPTBL12                                                          
*                                                                               
BPTBL37E MVC   PATEND,WORK+12                                                   
*                                                                               
BPTBL37F ICM   R1,3,PATUNTCT                                                    
         LA    R1,1(,R1)                                                        
         STCM  R1,3,PATUNTCT                                                    
*                                                                               
         OC    PATPROG,PATPROG     ALL DONE UNLESS ALL PROG                     
         BNZ   BLPATX                                                           
*                                                                               
         LA    RE,WORK                                                          
         USING ALLPRGD,RE                                                       
         XC    WORK,WORK                                                        
         MVC   ALLPGP1,PATPROD1                                                 
         MVC   ALLPGP2,PATPROD2                                                 
         MVC   ALLPGS1,PATSLN                                                   
         MVC   ALLPGS2,PATSLN2                                                  
         MVC   ALLPGSEQ,PATSEQ                                                  
         MVC   ALLPGKEY,PATKEY                                                  
         MVC   ALLPGFD,PATFEED                                                  
         MVC   ALLPGDP,PATDP                                                    
         MVC   ALLPGPRG,NBACTPRG                                                
         MVC   ALLPGLDT,NBACTDAT   SAVE AS LOW AND                              
         MVC   ALLPGHDT,NBACTDAT   AND HIGH DATES                               
         MVI   ALLPGCNT+1,1        SET COUNT AT 1                               
*                                                                               
         L     RE,ALLPRTAB         START OF ALL PROGRAM TABLE                   
         L     RF,MAXPRTAB         END OF ALL PROG TABLE                        
*                                                                               
BPTBL40  OC    ALLPGENT,ALLPGENT   EMPTY ENTRY                                  
         BZ    BPTBL44                                                          
         CLC   ALLPGCMP,WORK       ALREADY IN TABLE                             
         BNE   BPTBL42                                                          
         CLC   ALLPGLDT,WORK+ALLPGLDT-ALLPGENT SAME START DTE                   
         BE    BPTBL46                                                          
BPTBL42  LA    RE,ALLPGNXT                                                      
         CR    RE,RF                                                            
         BNH   BPTBL40                                                          
         DC    H'0'                                                             
BPTBL44  MVC   ALLPGENT,WORK       ADD ENTRY TO TABLE                           
         B     BLPATX                                                           
                                                                                
BPTBL46  LH    R1,ALLPGCNT                                                      
         AHI   R1,1                INCREMENT UNIT COUNT                         
         STH   R1,ALLPGCNT                                                      
                                                                                
         CLC   WORK+ALLPGLDT-ALLPGENT(2),ALLPGLDT                               
         BH    *+10                                                             
         MVC   ALLPGLDT,WORK+ALLPGLDT-ALLPGENT                                  
                                                                                
         CLC   WORK+ALLPGHDT-ALLPGENT(2),ALLPGHDT                               
         BL    *+10                                                             
         MVC   ALLPGHDT,WORK+ALLPGHDT-ALLPGENT                                  
         B     BLPATX                                                           
         DROP  RE,B                                                             
         EJECT                                                                  
* SEE IF EQUIVALENT UNIT, AND IF SO CK DATES *                                  
*                                                                               
CEQV     LA    R1,EQVPTBL                                                       
         LA    R0,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         MVI   BYTE,0                                                           
         USING EQVPTBLD,R1                                                      
CEQV10   OC    EQVENT,EQVENT       END OF ENTRIES                               
         BZ    CEQV26                                                           
         CLC   EQVEPRG,NBACTPRG    THIS AN EQUIVALENT PROG                      
         BNE   CEQV20                                                           
         MVI   BYTE,1                                                           
         CLC   NBACTDAT,EQVSDT     EQUIV FOR THIS DATE                          
         BL    CEQV20                                                           
         CLC   NBACTDAT,EQVEDT                                                  
         BH    CEQV20                                                           
         MVI   EQVUSED,C'Y'        SET ENTRY USED                               
         MVC   NBACTPRG,EQVBPRG    SUBSTITUTE BASE CODE                         
         MVC   BASECT,EQVCT                                                     
*                                                                               
         CR    RB,RB               SET EQ CC                                    
         BR    RE                                                               
*                                                                               
CEQV20   LA    R1,EQVNEXT                                                       
         BCT   R0,CEQV10                                                        
         DROP  R1                                                               
CEQV26   CLI   BYTE,1              WAS PROGRAM CODE FOUND                       
         BE    CEQV30                                                           
*                                                                               
         CR    RB,RB               SET EQUAL CC                                 
         BR    RE                                                               
*                                                                               
* PROGRAM CODE WAS EQUIVALENT FOR PART OF PERIOD, ERROR, BYPASS *               
*                                                                               
CEQV30   LTR   RB,RB                                                            
         BR    RE                                                               
         SPACE 3                                                                
* READ ALL NEEDED PATTERN RECS TO GET REAL PATTERN DATES                        
*                                                                               
RDPAT    NTR1                                                                   
         BRAS  RE,INITXSP                                                       
         L     R5,APATABLE                                                      
         USING PATABLED,R5                                                      
*                                                                               
RDPAT10  OC    PATENT,PATENT       EMPTY ENTRY                                  
         BZ    RDPAT30                                                          
*                                                                               
         OC    PATREF,PATREF       NO PAT ENTRY                                 
         BZ    RDPAT28                                                          
*                                                                               
         C     R5,MAXPATBL         AT END OF TABLE                              
         BNL   RDPAT30                                                          
*                                                                               
         USING NPTPXID,R4                                                       
         LA    R4,KEY                                                           
         XC    KEY,KEY                                                          
         MVC   NPTPXID,=X'0AE1'                                                 
         MVC   NPTPXAM(3),BAGYMD                                                
         MVC   NPTPXSEQ,PATSEQ                                                  
*                                                                               
*                                                                               
RDPAT26  DS    0H                                                               
**       MVI   RDUPDATE,C'N'                                                    
**       GOTO1 HIGH                                                             
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(7),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R6,AIO2                                                          
         ST    R6,AIO                                                           
**       MVI   RDUPDATE,C'N'                                                    
**       GOTO1 GETREC                                                           
         GOTO1 AIOCALL,DMCB,GETQ+FILQ+XSPQ,0                                    
*                                                                               
         CLC   NPTXREF-NPTXKEY(L'NPTXREF,R6),=X'E000'  THIS SAVED PTN           
         BL    RDPAT28                                                          
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPTDTAEL,R6                                                      
*                                                                               
* PATSTR/PATEND/WERE DEVELOPED FROM UNIT DATES -                                
* NEED TO RETRIEVE ACTUAL PATTERN DATES                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,NPTSTART),(2,PATPSTR)                             
         GOTO1 (RF),(R1),(3,NPTEND),(2,PATPEND)                                 
*                                                                               
*        MVC   PATREF,NPTKREF       SAVE REF                                    
         MVC   PATSEQ,NPTSEQNO      REPLACE REF WITH SEQ NO                     
*                                                                               
RDPAT28  DS    0H                                                               
         LA    R5,PATNEXT                                                       
         B     RDPAT10                                                          
*                                                                               
RDPAT30  DS    0H                                                               
*NOP     GOTO1 XSORT,DMCB,APATABLE,(R0),L'PATENT,4,28                           
*****    GOTO1 (RF),(R1),APATABLE,(R0),L'PATENT,L'PATSORT,0                     
*                                                                               
*SORT ON PAT SEQ                                                                
         GOTO1 XSORT,DMCB,APATABLE,(R0),L'PATENT,2,PATSEQ-PATENT                
                                                                                
* SORT ON PROD/LEN                                                              
         GOTO1 (RF),(R1),APATABLE,(R0),L'PATENT,8,PATPROD1-PATENT               
                                                                                
* SORT ON PAT START AND END DATES                                               
         GOTO1 (RF),(R1),APATABLE,(R0),L'PATENT,4,PATSTR-PATENT                 
                                                                                
*                                                                               
         L     R5,APATABLE                                                      
*                                                                               
RDPAT40  OC    PATENT,PATENT       EMPTY ENTRY                                  
         BZ    RDPATX                                                           
         C     R5,MAXPATBL         AT END OF TABLE                              
         BNL   RDPATX                                                           
*                                                                               
         OC    PATPSTR,PATPSTR     WE HAVE DATES FOR ENTRY                      
         BNZ   RDPAT41                                                          
         OC    PATREF,PATREF       ONLY REASON IS NO PATTERN                    
         BZ    RDPAT50                                                          
         DC    H'0'                                                             
*                                                                               
RDPAT41  DS   0H                                                                
         LR    R4,R5                                                            
         SHI   R4,PATNEXT-PATENT                                                
W        USING PATABLED,R4                                                      
         C     R5,APATABLE                                                      
         BE    RDPAT42                                                          
*                                                                               
* HOPE THIS TBA IS CAUGHT LATER IN BLIN - NEED EXTRA CODE THERE *               
*                                                                               
         CLC   PATSTR,PATPSTR                                                   
         BL    RDPAT42                                                          
*        DC    H'0'                                                             
*                                                                               
         CLC   PATCOM,W.PATCOM     NEXT ENTRY DIFF PAT                          
         BNE   RDPAT42             DON'T TOUCH                                  
*                                                                               
         MVC   PATSTR,PATPSTR                                                   
*                                                                               
         CLC   STDATEP,PATSTR      BUT NOT BEFORE PERIOD START DATE             
         BNH   RDPAT42                                                          
         MVC   PATSTR,STDATEP                                                   
*                                                                               
RDPAT42  DS    0H                                                               
         C     R5,APATABLE                                                      
         BE    RDPAT44                                                          
*                                                                               
         CLC   PATCOM,W.PATCOM     NEXT ENTRY DIFF PAT                          
         BNE   RDPAT44             DON'T TOUCH                                  
*                                                                               
         CLC   W.PATEND,PATSTR                                                  
         BL    RDPAT44                                                          
*                                                                               
         GOTO1 DATCON,DMCB,(2,W.PATEND),(0,WORK) LAST PAT END DATE              
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'1'       +1 AS END DATE                 
         GOTO1 DATCON,(R1),(0,WORK+6),(2,PATSTR)  END DATE                      
*                                                                               
         DROP  R4                                                               
RDPAT44  DS   0H                                                                
*        CLC   PATEND,PATPEND                                                   
*        BNH   *+6                                                              
*        DC    H'0'                                                             
         LR    R4,R5                                                            
         AHI   R4,PATNEXT-PATENT                                                
W        USING PATABLED,R4                                                      
*                                                                               
         OC    W.PATENT,W.PATENT       NEXT ENTRY END OF TABLE                  
         BZ    RDPATX                                                           
         C     R5,MAXPATBL         AT END OF TABLE                              
         BNL   RDPATX                                                           
*                                                                               
         CLC   PATCOM,W.PATCOM     NEXT ENTRY DIFF PAT                          
         BNE   RDPAT50             DON'T TOUCH                                  
*                                                                               
         MVC   PATEND,PATPEND                                                   
*                                                                               
         CLC   ENDATEP,PATEND      BUT NOT AFTER PERIOD END DATE                
         BNL   RDPAT46                                                          
         MVC   PATEND,ENDATEP                                                   
*                                                                               
RDPAT46  DS   0H                                                                
         OC    W.PATPSTR,W.PATPSTR   IS THERE A PAT DATE IN NEXT                
         BZ    RDPAT50                NO, DON'T CHECK IT                        
*                                                                               
         CLC   PATEND,W.PATPSTR                                                 
         BL    *+6                                                              
         DC    H'0'                                                             
RDPAT50  DS   0H                                                                
         LA    R5,PATNEXT                                                       
         B     RDPAT40                                                          
*                                                                               
RDPATX   BRAS  RE,INITNET                                                       
         XIT1                                                                   
PATSIZER MVC   GERROR,=Y(MANYPAT)                                               
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,3              L'SUBST TEXT + 1                             
         MVC   ELEM+1(2),=C'70'                                                 
         LA    R2,TRACLTH                                                       
         OC    AERRFILE,AERRFILE         STORED DCB ADDRESS                     
         BZ    PATSIZRA                                                         
*                                                                               
         L     R3,AERRFILE         STORED DCB ADDRESS                           
         CLOSE ((R3),)                                                          
         FREEPOOL (R3)                                                          
*                                                                               
         XC    AERRFILE,AERRFILE   SET FILE NOT OPEN                            
*                                                                               
PATSIZRA GOTO1 VTRAERR                                                          
*                                                                               
         LTORG                                                                  
         DROP  R5,RB,RC                                                         
         EJECT                                                                  
* BUILD PRINT LINE(S) FOR ALL UNITS FOR 1 INSTRUCTION *                         
*                                                                               
         DS    0H                                                               
BLIN     NMOD1 0,**+BLI**,R7                                                    
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         L     R1,AIO3             CLEAR SVPRDLST                               
         XC    0(240,R1),0(R1)                                                  
         XC    240(240,R1),240(R1)                                              
*                                                                               
         L     R5,APATABLE                                                      
         USING PATABLED,R5                                                      
*                                                                               
         OI    UPDSW,X'20'         SET ON PRINT UNITS SW                        
*                                                                               
         CLI   SVTN2PRO+10,C'Y'    GEN INSTR FOR ENTIRE PERIOD                  
         BNE   BLIN05               NO, JUST FOR BUY DATES                      
*                                                                               
         TM    PATFLG2,PATUSED                                                  
         BO    BLIN05                                                           
         LA    R5,PATNEXT                                                       
         CLI   PATPROD1,0          ANY UNITS?                                   
         BNE   *-16                 YES                                         
         DC    H'0'                                                             
*                                                                               
BLIN05   CLI   PATPROD1,0          ANY UNITS?                                   
         BNE   BLIN10                                                           
         DC    H'0'                                                             
*                                                                               
BLIN10   LA    R1,2                MINIMUM LINES TO PRINT                       
         LA    R2,P                                                             
         USING PRTLINE,R2                                                       
*                                                                               
         ST    R2,ASVPRINT         SAVE PRINT LOCATION                          
*                                                                               
         XC    WORK+52(12),WORK+52 WILL SAVE TBA DATES LATER                    
*                                                                               
         CLI   PATPROD2,0          P/B PROD                                     
         BE    *+8                                                              
         LA    R1,2(,R1)                                                        
         STC   R1,ALLOWLIN                                                      
*                                                                               
         BAS   RE,PROTMSG          PRINT ROTATION MESSAGE                       
*                                                                               
         CLC   PATSTR,PATEND       IF START DATE AFTER END DATE                 
         BNH   *+22                                                             
         XC    PATSTR,PATEND       THEN SWAP DATES                              
         XC    PATEND,PATSTR                                                    
         XC    PATSTR,PATEND                                                    
*                                                                               
*        OC    PATREF,PATREF                                                    
         OC    PATSEQ,PATSEQ                                                    
         BNZ   BLIN14                                                           
*                                                                               
         L     R4,ASVPRINT                                                      
         LR    R1,R4                                                            
         LA    R1,6(R1)                                                         
         ST    R1,ASVNOBP          SAVE FOR NO BUY OR PAT INDICATOR             
*                                                                               
         MVC   0(6,R4),=C' FROM '                                               
         GOTO1 DATCON,DMCB,(2,PATSTR),(5,7(R4))   PDATES                        
         MVI   15(R4),C'-'                                                      
         GOTO1 (RF),(R1),(2,PATEND),(5,16(R4))                                  
         LA    R1,23(R4)                                                        
         ST    R1,ASVPRINT                                                      
*                                                                               
         TM    PATFLG2,OOPS        BUYS NO LONGER COVERED BY PATS?              
         BZ    BLIN12                                                           
         CLI   SVTN2PRO+10,C'Y'                                                 
         BNE   BLIN12                                                           
         L     R4,ASVNOBP         ADDR TO PRT NO BUY/PAT INDICATOR              
         MVI   0(R4),C'*'                                                       
*                                                                               
BLIN12   BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0                                                       
         LA    R2,P                                                             
*                                                                               
         MVC   PCML+2(15),=CL15'TO BE ANNOUNCED'                                
*                                                                               
         CLI   SVTN2PRO+10,C'Y'    GEN INSTR FOR ENTIRE PERIOD                  
         BE    BLIN13               YES, DO PRINT UNIT COUNT                    
*                                                                               
         OC    SVPROG,SVPROG       ONLY FOR 1 PROGRAM                           
         BZ    BLIN13               NO, BYPASS                                  
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,PATUNTCT                                                    
         EDIT  (R0),(3,PCML+19)                                                 
         MVC   PCML+23(5),=C'UNITS'                                             
         CHI   R0,1                IS IT ONE UNIT                               
         BNE   BLIN13                                                           
         MVI   PCML+27,X'40'       BLANK OUT 'S'                                
                                                                                
BLIN13   MVC   PSLN(5),=C'LEN= '                                                
         LLC   R0,PATSLN           PRD LEN                                      
         LLC   RE,PATSLN2          PRD2 LEN                                     
         AR    R0,RE               TOTAL LEN                                    
         EDIT  (R0),(3,PSLN+5)                                                  
                                                                                
         BAS   R4,CHKTAG           CHK FOR TAG                                  
         BAS   RE,NXL                                                           
         BAS   RE,NXL                                                           
*NOP1    B     BLIN60               <<< WANT TO SEE PROGS COVERED:              
         B     BLIN46               NO                                          
*                                                                               
*-------------------------------*                                               
* READ AND PRINT PATTERN RECORD *                                               
*-------------------------------*                                               
*                                                                               
BLIN14   XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPTPXID,R4                                                       
         MVC   NPTPXID,=X'0AE1'                                                 
         MVC   NPTPXAM(3),BAGYMD                                                
*                                                                               
         MVC   NPTPXSEQ,PATSEQ                                                  
*                                                                               
         BRAS  RE,INITXSP                                                       
**IN26   DS    0H                                                               
**       MVI   RDUPDATE,C'N'                                                    
**       GOTO1 HIGH                                                             
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(7),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
**       MVI   RDUPDATE,C'N'                                                    
**       GOTO1 GETREC                                                           
         GOTO1 AIOCALL,DMCB,GETQ+FILQ+XSPQ,0                                    
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPTDTAEL,R6                                                      
*                                                                               
* PATSTR/PATEND/WERE DEVELOPED FROM UNIT DATES -                                
* NEED TO BE OVERRIDEN BY ACTUAL PATTERN DATES                                  
*                                                                               
         GOTO1 DATCON,DMCB,(2,PATSTR),(3,DUB)                                   
         GOTO1 (RF),(R1),(2,PATEND),(3,DUB+3)                                   
*                                                                               
         CLC   NPTSTART,DUB+3      IS PAT START OUT OF DTE RANGE                
         BNH   *+14                                                             
         MVC   PCML+2(15),=CL15'TO BE ANNOUNCED'                                
         B     BLIN22                                                           
*                                                                               
         CLC   NPTEND,DUB          IS PAT END OUT OF DTE RANGE                  
         BNL   *+14                                                             
         MVC   PCML+2(15),=CL15'TO BE ANNOUNCED'                                
         B     BLIN22                                                           
*                                                                               
         CLC   NPTSTART,DUB                                                     
         BNH   BLIN18                                                           
*                                                                               
* SAVE DATES THAT ARE NOT COVERED BY PATTERN (TBA)                              
*                                                                               
         MVC   WORK+52(3),DUB       START DATE                                  
*                                                                               
         GOTO1 DATCON,DMCB,(3,NPTSTART),(0,WORK+40) START DATE                  
         GOTO1 ADDAY,(R1),WORK+40,WORK+46,F'-1'   -1 AS END DATE                
         GOTO1 DATCON,(R1),(0,WORK+46),(3,WORK+55)   END DATE                   
*                                                                               
         MVC   DUB(3),NPTSTART                                                  
*                                                                               
BLIN18   CLC   NPTEND,DUB+3                                                     
         BNL   BLIN20                                                           
*                                                                               
* SAVE DATES THAT ARE NO LONGER COVERED BY PATTERN (TBA)                        
*                                                                               
         GOTO1 DATCON,DMCB,(3,NPTEND),(0,WORK+40) START DATE                    
         GOTO1 ADDAY,(R1),WORK+40,WORK+46,F'1'      +1 AS START DATE            
         GOTO1 DATCON,(R1),(0,WORK+46),(3,WORK+58)   START DATE                 
*                                                                               
         MVC   WORK+61(3),DUB+3     END DATE                                    
*                                                                               
         MVC   DUB+3(3),NPTEND                                                  
*                                                                               
BLIN20   CLC   DUB(3),DUB+3        IF START DATE AFTER END DATE                 
         BNH   *+22                                                             
         XC    DUB(3),DUB+3        THEN SWAP DATES                              
         XC    DUB+3(3),DUB                                                     
         XC    DUB(3),DUB+3                                                     
*                                                                               
BLIN22   L     R4,ASVPRINT                                                      
         LR    R1,R4                                                            
         LA    R1,6(R1)                                                         
         ST    R1,ASVNOBP          SAVE FOR NO BUY OR PAT INDICATOR             
*                                                                               
         MVC   0(6,R4),=C' FROM '                                               
         GOTO1 DATCON,DMCB,(3,DUB),(5,7(R4))  PDATES                            
         MVI   15(R4),C'-'                                                      
         GOTO1 (RF),(R1),(3,DUB+3),(5,16(R4))                                   
         LA    R1,23(R4)                                                        
         ST    R1,ASVPRINT                                                      
*                                                                               
         TM    PATFLG2,TAGFLG      CHK FOR TAG                                  
         BZ    *+8                                                              
         OI    SVFLAG,SVTAG        THERE ARE TAGS ON INSTR                      
*                                                                               
         CLC   PCML+2(15),=CL15'TO BE ANNOUNCED'                                
         BNE   BLIN24                                                           
         CLI   SVTN2PRO+10,C'Y'                                                 
         BNE   BLIN25                                                           
         L     R1,ASVNOBP                                                       
         MVI   0(R1),C'*'          BUY IS NO LONGER COVERED BY PAT              
         B     BLIN25                                                           
*                                                                               
BLIN24   TM    PATFLG2,OOPS        WERE THERE BUYS FOR THIS PATTERN             
         BZ    BLIN25                                                           
         CLI   SVTN2PRO+10,C'Y'                                                 
         BNE   BLIN25                                                           
         L     R1,ASVNOBP                                                       
         MVI   0(R1),C'*'          NO, FLAG THIS ENTRY                          
                                                                                
BLIN25   OC    PATFEED,PATFEED     ANY FEED                                     
         BZ    BLIN25C                                                          
                                                                                
         MVC   PFEED(6),=C'FEED= '                                              
         MVC   PFEED+6(4),PATFEED                                               
         BRAS  RE,RFEED                                                         
*                                                                               
BLIN25C  CLC   PCML+2(15),=CL15'TO BE ANNOUNCED'                                
*NOP1    BE    BLIN60             <<< WANT TO SEE PROGS COVERED:                
         BE    BLIN46                                                           
*                                                                               
BLIN26   MVI   NXTALPHA,0          INIT ALPHA TO PRINT                          
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,NEXTEL                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPTCMLEL,R6                                                      
         LLC   R3,NPTCMLLN                                                      
         SRL   R3,4                DIVIDE BY 16                                 
         MVC   BLOCK(192),NPTCML   SAVE OFF COMML LIST                          
         LA    R4,BLOCK                                                         
*                                                                               
         LA    RF,1                PRESET TO PRINT FIRST ALPHA                  
         CR    R3,RF               ONLY ONE CML                                 
         BH    *+6                                                              
         SR    RF,RF               YES, NO NEED TO PRINT ALPHA                  
         STC   RF,NXTALPHA         SAVE NEXT ALPHA                              
*                                                                               
         CLI   SVTN2PRO+6,C'Y'     PRINT PERCENTAGES IF AVAILABLE               
         BNE   BLIN27                                                           
*                                                                               
* GET ACTUAL NUMBER OF COMMERCIAL ROTATION (DELETES DONT COUNT)                 
*                                                                               
         LR    R1,R3               NUMBER OF CML ENTRIES                        
*                                                                               
BLIN26F  CLC   =XL16'5C000000000000000000000000000000',0(R4)                    
         BNE   *+6                                                              
         BCTR  R3,0                DECREMENT COUNTER                            
         LA    R4,16(R4)                                                        
         BCT   R1,BLIN26F                                                       
         LA    R4,BLOCK                                                         
*                                                                               
         MVI   PBYTE,1                                                          
         MVI   ELCODE,X'34'        GET PATTERN PERCENT ELEMENT                  
         L     R6,AIO1                                                          
         BRAS  RE,GETEL                                                         
         BE    BLIN27C                                                          
*                                                                               
BLIN27   MVI   ELCODE,X'32'        GET PATTERN ELEMENT                          
         MVI   PBYTE,0                                                          
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         XC    BLOCK+200(100),BLOCK+200                                         
         LLC   R1,1(R6)                                                         
         SHI   R1,3                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   BLOCK+200(0),2(R6)  SAVE ROTATION LIST                           
         STC   R1,BLOCK+199        SAVE LENGTH OF ENTRY                         
*                                                                               
         LA    RE,BLOCK+200+1(R1)  POINT PAST END OF LIST                       
         MVI   0(RE),X'FF'         PRINT 'ONLY'                                 
         LTR   R1,R1               WAS LENGTH 1 (NOW ZERO)                      
         BZ    *+8                                                              
         MVI   0(RE),X'EE'         PRINT 'REPEAT'                               
         LA    R6,BLOCK+200                                                     
         B     BLIN30                                                           
*                                                                               
BLIN27C  LLC   R0,1(R6)                                                         
         BCTR  R0,0                                                             
         BCTR  R0,0                                                             
         LA    R6,2(,R6)                                                        
*                                                                               
         CLI   PBYTE,0             DOING PERCENTS                               
         BE    BLIN30               NO                                          
*                                                                               
         CLI   2(R6),100           ROTATION OF 1 LETTER  (100%)                 
         BNE   *+14                 NO                                          
         MVC   WORK(7),=C'100 PCT'                                              
         B     BLIN28                                                           
*                                                                               
         LR    R1,R0                                                            
         SR    R0,R0                                                            
         D     R0,=F'3'                                                         
         LTR   R0,R0                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         LR    R0,R1                                                            
*                                                                               
BLIN27F  CLI   PBYTE,0             DOING PERCENTS                               
         BE    BLIN30               NO                                          
*                                                                               
         CLI   4(R6),100           ROTATION OF 1 LETTER (100%)                  
         BNE   *+14                 NO                                          
         MVC   WORK(7),=C'100 PCT'                                              
         B     BLIN28                                                           
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,3,1(R6)                                                       
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(2),DUB+6(2)                                                 
         MVI   WORK+2,C' '                                                      
         MVC   WORK+3(3),=C'PCT'                                                
         MVI   WORK+6,C' '                                                      
*                                                                               
BLIN28   LLC   RE,0(R6)            GET COMMERCIAL LETTER                        
         AHI   RE,-193             CONVERT A (=193) TO 0                        
         CHI   RE,10                                                            
         BL    *+8                                                              
         AHI   RE,-7               CONVERT J (=209) TO 9                        
*                                                                               
* INDEX INTO SAVED ELEMENT TO FIND COMMERCIAL CODE *                            
*                                                                               
         SLL   RE,4                X 16                                         
         LA    R4,BLOCK(RE)                                                     
         MVC   PPCT,SPACES                                                      
         MVC   PPCT,WORK                                                        
BLIN30   CLC   =XL16'5C000000000000000000000000000000',0(R4)                    
         BE    BLIN41                                                           
         MVC   SVCMLCOD,0(R4)                                                   
         MVC   SVPRD,PATPROD1                                                   
         NI    ANYFLAG,X'FF'-CLTCMLNO    TURN OFF GET CLT CML #                 
         BRAS  RE,FCML                                                          
*                                                                               
         CLI   PBYTE,1             DOING PERCENTAGES                            
         BE    BLIN30C             YES, DO NOT PRINT ROTATION                   
*                                                                               
         CLI   NXTALPHA,0          ONLY ONE COMMERCIAL                          
         BNE   *+14                                                             
         MVC   PPCT,=C'100 PCT'                                                 
         B     BLIN30C              YES                                         
*                                                                               
         LLC   RF,NXTALPHA         GET DISPLACEMENT INTO ALPHA TABLE            
         LLC   RE,ALPHATAB-1(RF)                                                
         MVC   PLROT,=C'( )'                                                    
         STC   RE,PLROT+1          PRINT ALPHA (A)                              
*                                                                               
BLIN30C  CLC   SVCMLCOD,=CL8'NO COMML'                                          
         BNE   BLIN30E                                                          
         MVC   0(8,R4),=CL8'NO COMML'                                           
         MVC   PLROT,SPACES                                                     
*                                                                               
BLIN30E  CLC   PATSLN,SVCMLLEN     IF UNIT LEN NOT = CML LEN                    
         BE    BLIN32                                                           
         CLI   PATPROD2,0          AND THERE IS A P/B PRD                       
         BE    BLIN32                                                           
         CLI   PATSLN2,0           AND UNIT LEN 2 ZERO                          
         BNE   BLIN32                                                           
         LLC   RE,PATSLN           ADJUST LENGTHS                               
         LLC   RF,SVCMLLEN                                                      
         SR    RE,RF                                                            
         STC   RF,PATSLN                                                        
         STC   RE,PATSLN2                                                       
*                                                                               
BLIN32   NI    ANYFLAG,X'FF'-PBCMLSW INIT P/B CML SWITCH                        
         SR    R1,R1                                                            
         CLI   PATPROD2,0          CK P/B PROD                                  
         BE    BLIN36               NO                                          
*                                                                               
         OC    8(8,R4),8(R4)       ONLY ONE COMML                               
         BNZ   *+12                                                             
         OI    ANYFLAG,PBCMLSW     COVERS BOTH PRODUCTS                         
         B     BLIN34                                                           
*                                                                               
         CLC   0(8,R4),8(R4)       BOTH COMMLS EQUAL                            
         BE    BLIN34                                                           
*                                                                               
         MVI   PCML-1,C'('                                                      
         LA    RF,PCML+8                                                        
         CLI   0(RF),X'40'         SPACE                                        
         BE    *+12                                                             
         LA    RF,1(RF)                                                         
         B     *-12                                                             
         MVI   0(RF),C'-'                                                       
*                                                                               
         MVC   PSLN(6),=C'LEN= ('                                               
         LA    R1,PSLN+6                                                        
                                                                                
         EDIT  (B1,PATSLN),(3,0(R1)),ALIGN=LEFT                                 
         AR    R1,R0                                                            
         MVI   0(R1),C'-'                                                       
*                                                                               
         OC    SVCMLOVR,SVCMLOVR   ANY PRINT OVERRIDE?                          
         BZ    BLIN38                                                           
*                                  PRINT LENGTH OVERRIDE                        
         LA    RF,SVCMLOVR                                                      
         XC    PCMLTL,PCMLTL       CLEAR CML TITLE (PRT ON NXT LINE)            
         LA    R1,PCMLTL                                                        
         MVC   0(9,R1),=C'LEN OVRD='                                            
         LA    R1,9(R1)                                                         
         MVI   0(R1),C'('                                                       
         EDIT  (1,(RF)),(3,1(R1)),ALIGN=LEFT,ZERO=NOBLANK                       
         AR    R1,R0                                                            
         MVI   1(R1),C'/'                                                       
         EDIT  (1,1(RF)),(3,2(R1)),ALIGN=LEFT,ZERO=NOBLANK                      
         AR    R1,R0                                                            
         MVI   2(R1),C')'                                                       
         B     BLIN38                                                           
*                                                                               
BLIN34   LLC   R1,PATSLN2                                                       
*                                                                               
BLIN36   LLC   R0,PATSLN                                                        
         AR    R0,R1                                                            
*                                                                               
         CLC   PSLN,SPACES                                                      
         BNH   *+8                                                              
         BAS   RE,NXL              GET NEXT PRINT LINE OR PRINT                 
         MVC   PSLN(5),=C'LEN= '                                                
         LA    R1,PSLN+5                                                        
         EDIT  (R0),(3,PSLN+5),ALIGN=LEFT                                       
*                                                                               
         OC    SVCMLOVR,SVCMLOVR   ANY PRINT OVERRIDE?                          
         BZ    BLIN38                                                           
*                                  PRINT LENGTH OVERRIDE                        
         LA    RF,SVCMLOVR                                                      
         XC    PCMLTL,PCMLTL       CLEAR CML TITLE (PRT ON NXT LINE)            
         LA    R1,PCMLTL                                                        
         MVC   0(9,R1),=C'LEN OVRD='                                            
         LA    R1,9(R1)                                                         
         MVI   0(R1),C'('                                                       
         EDIT  (1,(RF)),(3,1(R1)),ALIGN=LEFT,ZERO=NOBLANK                       
         AR    R1,R0                                                            
         MVI   1(R1),C'/'                                                       
         EDIT  (1,1(RF)),(3,2(R1)),ALIGN=LEFT,ZERO=NOBLANK                      
         AR    R1,R0                                                            
         MVI   2(R1),C')'                                                       
*                                                                               
BLIN38   BAS   RE,POTHR                                                         
         TM    PATFLG2,TAGFLG      CHK FOR TAG                                  
         BZ    BLIN38D                                                          
         CLC   PSLN(6),SPACES                                                   
         BNH   *+8                                                              
         BAS   RE,NXL                                                           
         MVC   PSLN(6),=C'TAG(S)'                                               
                                                                                
BLIN38D  OC    SVCMLOVR,SVCMLOVR   WAS THERE LEN OVERRIDE?                      
         BZ    BLIN38E                                                          
         CLC   PCMLTL,SPACES                                                    
         BNH   *+8                                                              
         BAS   RE,NXL                                                           
         MVC   PCMLTL,SVCMLDS      YES, PRINT CML TITLE                         
         BAS   RE,POTHR            PRINT OTHER INFO IF ANY                      
*                                                                               
BLIN38E  CLC   SVCMLDS2,SPACES                                                  
         BNH   BLIN39                                                           
*                                                                               
BLIN38F  CLC   PCMLTL,SPACES                                                    
         BNH   *+8                                                              
         BAS   RE,NXL                                                           
         MVC   PCMLTL,SVCMLDS2                                                  
         BAS   RE,POTHR            PRINT OTHER INFO IF ANY                      
*                                                                               
         CLC   SVCMLDS3,SPACES                                                  
         BNH   BLIN39                                                           
*                                                                               
BLIN38I  MVC   PCMLTL,SVCMLDS3                                                  
         BAS   RE,POTHR            PRINT OTHER INFO IF ANY                      
*                                                                               
*------------------------------*                                                
* ANY "OTHER" INFO TO PRINT    *                                                
*------------------------------*                                                
*                                                                               
BLIN39   DS    0H                                                               
         TM    ANYFLAG,PBCMLSW     1 CML COVERS BOTH PRODUCTS                   
         BZ    BLIN39A                                                          
         MVC   PCMLTL(5),=C'P/B (' PRINT P/B  MESSAGE                           
         LA    R1,PCMLTL+5                                                      
         LLC   RE,PATSLN                                                        
         LLC   RF,PATSLN2                                                       
         AR    RF,RE                                                            
         SRL   RF,1                DIV BY 2                                     
         EDIT  (RF),(3,0(R1)),ALIGN=LEFT,ZERO=NOBLANK                           
         AR    R1,R0                                                            
         MVI   0(R1),C'/'                                                       
         LA    R1,1(R1)                                                         
         EDIT  (RF),(3,0(R1)),ALIGN=LEFT,ZERO=NOBLANK                           
         AR    R1,R0                                                            
         MVI   0(R1),C')'                                                       
                                                                                
BLIN39A  CLC   FLD,SPACES          ANY CML RUN TIME TO PRINT                    
         BH    BLIN039                                                          
         OC    SVHIDEF,SVHIDEF                                                  
         BNZ   BLIN039                                                          
         OC    SVCNTRC,SVCNTRC                                                  
         BNZ   BLIN039                                                          
         OC    SVCMCLTN,SVCMCLTN                                                
         BNZ   BLIN039                                                          
         TM    ANYFLAG,PBCMLSW     DID WE JUST PUT OUT P/B MESSAGE              
         BZ    BLIN039A                                                         
         BAS   RE,NXL                                                           
         B     *+8                                                              
BLIN039  BAS   RE,POTHR            PRINT OTHER INFO IF ANY                      
         NI    ANYFLAG,X'FF'-PBCMLSW                                            
*                                                                               
BLIN039A CLI   PATSLN2,0           UNIT LEN 2 ZERO                              
         BE    BLIN41                                                           
*                                                                               
         OC    8(8,R4),8(R4)       ONLY ONE COMML                               
         BZ    BLIN41                                                           
*                                                                               
         CLC   0(8,R4),8(R4)       BOTH COMMLS EQUAL                            
         BE    BLIN41                                                           
*                                                                               
         BAS   RE,NXL                                                           
*                                                                               
         MVC   SVCMLCOD,8(R4)                                                   
         OC    PATPROD2,PATPROD2                                                
         BZ    *+10                                                             
         MVC   SVPRD,PATPROD2                                                   
         OC    SVCMLCOD,SVCMLCOD                                                
         BZ    BLIN41                                                           
         NI    ANYFLAG,X'FF'-CLTCMLNO    TURN OFF GET CLT CML #                 
         BRAS  RE,FCML                                                          
         CLC   SVCMLCOD,=CL8'NO COMML'                                          
         BE    BLIN39C                                                          
*                                                                               
         MVC   PSLN(5),=C'LEN= '                                                
         LA    R1,PSLN+5                                                        
                                                                                
         EDIT  (B1,PATSLN2),(3,0(R1)),ALIGN=LEFT                                
         AR    R1,R0                                                            
         MVI   0(R1),C')'                                                       
*                                                                               
         OC    SVCMLOVR,SVCMLOVR   ANY PRINT OVERRIDE?                          
         BZ    BLIN39B                                                          
*                                  PRINT LENGTH OVERRIDE                        
         LA    RF,SVCMLOVR                                                      
         XC    PCMLTL,PCMLTL       CLEAR CML TITLE (PRT ON NXT LINE)            
         LA    R1,PCMLTL                                                        
         MVC   0(9,R1),=C'LEN OVRD='                                            
         LA    R1,9(R1)                                                         
         MVI   0(R1),C'('                                                       
         EDIT  (1,(RF)),(3,1(R1)),ALIGN=LEFT,ZERO=NOBLANK                       
         AR    R1,R0                                                            
         MVI   1(R1),C'/'                                                       
         EDIT  (1,1(RF)),(3,2(R1)),ALIGN=LEFT,ZERO=NOBLANK                      
         AR    R1,R0                                                            
         MVI   2(R1),C')'                                                       
*                                                                               
BLIN39B  DS   0H                                                                
         LA    RE,PCML+8                                                        
         CLI   0(RE),X'40'         SPACE                                        
         BNH   *+12                                                             
         LA    RE,1(RE)                                                         
         B     *-12                                                             
         MVI   0(RE),C')'                                                       
                                                                                
         B     *+10                                                             
BLIN39C  MVC   8(8,R4),=CL8'NO COMML'                                           
*                                                                               
         BAS   RE,POTHR                                                         
                                                                                
         OC    SVCMLOVR,SVCMLOVR   WAS THERE LEN OVERRIDE?                      
         BZ    BLIN39E                                                          
         CLC   PCMLTL,SPACES                                                    
         BNH   *+8                                                              
         BAS   RE,NXL                                                           
         MVC   PCMLTL,SVCMLDS      YES, PRINT CML TITLE                         
         BAS   RE,POTHR            PRINT OTHER INFO IF ANY                      
*                                                                               
BLIN39E  CLC   SVCMLDS2,SPACES                                                  
         BNH   BLIN39K                                                          
*                                                                               
         CLC   PCMLTL,SPACES       ANY DESCRIPTION?                             
         BNH   BLIN39F              NO                                          
         BAS   RE,NXL                                                           
BLIN39F  MVC   PCMLTL,SVCMLDS2                                                  
         BAS   RE,POTHR            PRINT OTHER INFO IF ANY                      
*                                                                               
         CLC   SVCMLDS3,SPACES                                                  
         BNH   BLIN39K                                                          
         CLC   PCMLTL,SPACES       ANY DESCRIPTION?                             
         BNH   BLIN39I              NO                                          
*                                                                               
         BAS   RE,NXL                                                           
BLIN39I  MVC   PCMLTL,SVCMLDS3                                                  
         BAS   RE,POTHR            PRINT OTHER INFO IF ANY                      
*                                                                               
*------------------------------*                                                
* ANY "OTHER" INFO TO PRINT    *                                                
*------------------------------*                                                
*                                                                               
BLIN39K  OC    SVHIDEF,SVHIDEF                                                  
         BNZ   BLIN39X                                                          
         OC    SVCNTRC,SVCNTRC                                                  
         BNZ   BLIN39X                                                          
         OC    SVCMCLTN,SVCMCLTN                                                
         BZ    *+8                                                              
BLIN39X  BAS   RE,POTHR            PRINT OTHER INFO IF ANY                      
*                                                                               
BLIN40   DS    0H                                                               
         CLC   PCMLTL,SPACES       ANY DESCRIPTION?                             
         BE    BLIN41                                                           
         BAS   RE,NXL                                                           
*                                                                               
BLIN41   CLI   PBYTE,0             DOING PERCENTS                               
         BE    BLIN41E              NO                                          
         LA    R6,3(,R6)           GET NEXT CODE                                
         BAS   RE,NXL                                                           
         BCT   R3,BLIN27F                                                       
         B     BLIN44                                                           
*                                                                               
BLIN41E  LA    R4,16(,R4)                                                       
         CLI   NXTALPHA,0          PRINTING ALPHA                               
         BE    BLIN41F              NO                                          
         LLC   RF,NXTALPHA                                                      
         LA    RF,1(RF)            BUMP TO NEXT ALPHA                           
         STC   RF,NXTALPHA         AND SAVE                                     
*                                                                               
BLIN41F  BCTR  R3,0                DECREMENT COUNT                              
         LTR   R3,R3               ARE WE DONE YET                              
         BZ    *+12                                                             
         BAS   RE,NXL              NO, GET NEXT PRINT LINE                      
         B     BLIN30              PROCESS NEXT CML                             
*                                                                               
         CLI   NXTALPHA,0          ONLY ONE COMMERCIAL                          
         BNE   *+12                                                             
         BAS   RE,NXL              NO, GET NEXT PRINT LINE                      
         B     BLIN44              YES, DO NOT PRINT LETTER ROTATION            
*                                                                               
*--------------------------------*                                              
* PRINT COMMERCIAL ROTATION      *                                              
*--------------------------------*                                              
*                                                                               
         MVC   2(L'ROTCMSG,R2),ROTCMSG                                          
         LA    R1,L'ROTCMSG+3(R2)                                               
         LA    RF,BLOCK+200        ROTATION LIST                                
         LLC   R0,BLOCK+199        GET LENGTH                                   
         LA    RE,2                ONE SPACE BETWEEN LETTERS                    
         CHI   R0,36               IF MORE THAN 36 ENTRIES                      
         BNH   BLIN41H                                                          
         EX    R0,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(RF)       THEN PRINT ROTATION W/O SPACES               
         B     BLIN41K                                                          
*                                                                               
BLIN41H  AHI   R0,1                ADJUST TO REAL LENGTH                        
BLIN41J  MVC   0(1,R1),0(RF)                                                    
         AR    R1,RE                                                            
         LA    RF,1(RF)                                                         
         BCT   R0,BLIN41J                                                       
BLIN41K  BAS   RE,NXL              GET NEXT PRINT LINE                          
         BAS   RE,NXL                                                           
*                                                                               
*------------------------------------*                                          
* IF ANY PATTERN TEXT, PRINT IT HERE *                                          
*------------------------------------*                                          
*                                                                               
BLIN44   TM    SVFLAG,SEEMORFL     PRINT SEE ADDITIONAL CML MSG                 
         BZ    BLIN45                                                           
*                                                                               
         NI    SVFLAG,X'FF'-SEEMORFL                                            
         MVC   0(SEEMOREX-SEEMORE,R2),SEEMORE                                   
         BRAS  RE,GOSPL                                                         
         NI    ANYFLAG,X'FF'-BLNKLN                                             
         MVI   ALLOWLIN,0                                                       
         LA    R2,P                                                             
         BAS   RE,NXL                                                           
*                                                                               
BLIN45   L     R6,AIO1                                                          
         MVI   ELCODE,X'40'                                                     
         BRAS  RE,INITXSP                                                       
         BRAS  RE,GETEL                                                         
         BNE   *+8                                                              
         BAS   RE,PTXT                                                          
*****                                                                           
* PRINT PATTERN KEY FOR TESTING SO I KNOW WHAT PATTERN IS BEING USED            
*****                                                                           
*         L     R6,AIO1                                                         
*         GOTO1 HEXOUT,DMCB,(R6),PFEED,27,=C'TOG'                               
*         BAS   RE,NXL                                                          
*****                                                                           
*                                                                               
         OC    WORK+52(12),WORK+52  NEW DATES?                                  
         BZ    BLIN46               NO                                          
*                                                                               
         OC    WORK+52(6),WORK+52                                               
         BZ    *+14                                                             
         MVC   SVDATES,WORK+52                                                  
         BAS   R4,BLIN200                                                       
*                                                                               
         OC    WORK+58(6),WORK+58                                               
         BZ    *+14                                                             
         MVC   SVDATES,WORK+58                                                  
         BAS   R4,BLIN200                                                       
*                                                                               
         XC    WORK+52(12),WORK+52  DONE PRINTING, CLEAR ALL                    
*                                                                               
BLIN46   BRAS  RE,INITSPT                                                       
         OC    PATPROG,PATPROG     WAS THIS ALL PROG PATTERN                    
         BNZ   BLIN60               NO                                          
*                                                                               
         CLI   SVTN1PRG,C'Y'       PRINT SCHEDULE SUMMARY                       
*TEMP    BE    *+12                 YES                                         
         CLI   SVTN1PR3,C'Y'       SUPPRESS PROGRAMS COVERED BY                 
         BE    BLIN60               YES                                         
*                                                                               
         BRAS  RE,CTP              GO COUNT PROGRAMS COVERED                    
*NOP11   BZ    BLIN60              ONLY ONE                                     
*                                                                               
         XC    FULL,FULL                                                        
*                                                                               
         L     R4,ALLPRTAB         START OF ALL PROGRAM TABLE                   
         ST    R4,FULL             SAVE START OF PROG/PAT TABLE                 
*                                                                               
BLIN47   OC    0(L'ALLPGENT,R4),0(R4)      EMPTY ENTRY                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
         CLC   WORK(ALLPGPRG-ALLPRGD),0(R4)  FOUND IN TABLE                     
         BE    BLIN47C                                                          
         LA    R4,L'ALLPGENT(,R4)                                               
         B     BLIN47                                                           
*                                                                               
* MAKE SURE DATES FALL W/N RANGE                                                
BLIN47C  DS    0H                                                               
         CLC   WORK+ALLPGLDT-ALLPGENT(2),ALLPGHDT-ALLPGENT(R4)                  
         BH    BLIN47D                                                          
         CLC   WORK+ALLPGHDT-ALLPGENT(2),ALLPGLDT-ALLPGENT(R4)                  
         BL    BLIN47D                                                          
*                                                                               
         OC    ALLPGPRG-ALLPGENT(6,R4),ALLPGPRG-ALLPGENT(R4) ANY PROG?          
         BNZ   BLIN49C              YES                                         
BLIN47D  LA    R4,L'ALLPGENT(,R4)                                               
BLIN47F  OC    0(L'ALLPGENT,R4),0(R4) EMPTY ENTRY                               
         BZ    BLIN60                  YES                                      
*                                                                               
         CLC   WORK(ALLPGPRG-ALLPRGD),0(R4)  FOUND IN TABLE                     
         BE    BLIN47C                                                          
         LA    R4,L'ALLPGENT(,R4)                                               
         B     BLIN47F                                                          
*                                                                               
BLIN49C  CLI   SVTN1PRG,C'Y'       PRINT SCHEDULE SUMMARY                       
         B     BLIN49F              *TEMP                                       
         BNE   BLIN49F              NO                                          
*                                                                               
         MVI   ALLOWLIN,3                                                       
*                                                                               
         MVC   PPROG(22),=C'***SCHEDULE SUMMARY***'                             
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         MVC   PPROG+(7),=C'PROGRAM'                                            
         MVC   PPROG+7(20),=C'--------------------'                             
         MVC   PPROG+27(4),=C'DATE'                                             
         MVC   PPROG+31(3),=C'---'                                              
         MVC   PPROG+34(7),=C'PRODUCT'                                          
         MVC   PPROG+41(20),=C'--------------------'                            
         MVC   PPROG+62(3),=C'LEN'                                              
         MVC   PPROG+65(6),=C'------'                                           
         MVC   PPROG+71(4),=C'COST'                                             
         MVC   PPROG+75(6),=C'------'                                           
         MVC   PPROG+81(15),=C'NUMBER OF UNITS'                                 
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         B     BLIN50                                                           
*                                                                               
*-----------------------------------*                                           
* LIST PROGRAMS IN TWO COLUMNS      *                                           
*-----------------------------------*                                           
*                                                                               
BLIN49F  MVC   PPROG(17),=C'PROGRAMS COVERED:'                                  
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
*                                                                               
         XC    SVPROG,SVPROG                                                    
         XC    TUCOUNT,TUCOUNT                                                  
*                                                                               
BLIN50   L     R4,FULL             START OF PROG/PAT TABLE                      
*                                                                               
         LR    R1,R2                                                            
C        USING PRTLINE,R1                                                       
                                                                                
         OC    0(L'ALLPGENT,R4),0(R4)      EMPTY ENTRY                          
         BNZ   BLIN52                                                           
         DC    H'0'                                                             
*                                                                               
BLIN51   OC    0(L'ALLPGENT,R4),0(R4) EMPTY ENTRY                               
         BNZ   BLIN52                                                           
         CR    R1,R2               1ST COLUMN                                   
         BNE   BLIN51C                                                          
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         B     BLIN60                                                           
*                                                                               
BLIN51C  BAS   RE,NXL              GO PRINT                                     
         BAS   RE,NXL              SKIP A LINE                                  
         B     BLIN60                                                           
*                                                                               
BLIN52   CLC   WORK(ALLPGPRG-ALLPRGD),0(R4)  FOUND IN TABLE                     
         BNE   BLIN53X                                                          
         OC    ALLPGPRG-ALLPGENT(6,R4),ALLPGPRG-ALLPGENT(R4) ANY PROG?          
         BZ    BLIN53X                                                          
         CLC   WORK+ALLPGLDT-ALLPGENT(2),ALLPGHDT-ALLPGENT(R4) DATES?           
         BH    BLIN53X                                                          
         CLC   WORK+ALLPGHDT-ALLPGENT(2),ALLPGLDT-ALLPGENT(R4)                  
         BNL   BLIN55                                                           
BLIN53X  LA    R4,L'ALLPGENT(,R4)                                               
         B     BLIN51                                                           
*                                                                               
BLIN55   LH    RF,ALLPGCNT-ALLPGENT(R4) UNIT COUNT                              
         AH    RF,TUCOUNT                                                       
         STH   RF,TUCOUNT                                                       
                                                                                
         OC    SVPROG,SVPROG       FIRST TIME                                   
         BNZ   *+10                                                             
         MVC   SVPROG,ALLPGPRG-ALLPGENT(R4) PROG CODE                           
                                                                                
         CLC   SVPROG,ALLPGPRG-ALLPGENT(R4)    SAME PROGRAM                     
         BNE   BLIN56                                                           
                                                                                
         LA    RF,L'ALLPGENT(,R4)  NEXT ENTRY                                   
         OC    0(L'ALLPGENT,RF),0(RF) EMPTY ENTRY                               
         BZ    BLIN56                                                           
         CLC   SVPROG,ALLPGPRG-ALLPGENT(RF)    SAME PROGRAM                     
         BNE   BLIN56                                                           
                                                                                
         CLC   WORK(ALLPGPRG-ALLPRGD),0(RF)  FOUND IN TABLE                     
         BNE   BLIN56                                                           
         CLC   WORK+ALLPGLDT-ALLPGENT(2),ALLPGHDT-ALLPGENT(RF) DATES?           
         BH    BLIN56                                                           
         CLC   WORK+ALLPGHDT-ALLPGENT(2),ALLPGLDT-ALLPGENT(RF)                  
         BL    BLIN56                                                           
                                                                                
         LA    R4,L'ALLPGENT(,R4)  NEXT ENTRY                                   
         B     BLIN55                                                           
                                                                                
BLIN56   MVC   C.PCPROG,ALLPGPRG-ALLPGENT(R4)  PRNT PROGRAM CODE                
*                                                                               
* FIND PROG NAME                                                                
*                                                                               
         MVC   SVPROG,ALLPGPRG-ALLPGENT(R4) PROG CODE                           
*                                                                               
         L     RF,APRGTBLE                                                      
         USING PRGTABLD,RF                                                      
*                                                                               
         CLC   PRGPRG,SVPROG                                                    
         BE    *+18                                                             
         LA    RF,PRGNEXT                                                       
         OC    0(4,RF),0(RF)       EOL                                          
         BNZ   *-20                 NO                                          
         MVC   SVPROGDT,PRGHIDTE                                                
*                                                                               
*NOP     LH    R0,ALLPGCNT-ALLPGENT(R4) UNIT COUNT                              
         LH    R0,TUCOUNT                                                       
         DROP  RF                                                               
*                                                                               
         EDIT  (R0),(4,C.PCUNT+1),ZERO=NOBLANK,WRK=FLD                          
         XC    TUCOUNT,TUCOUNT                                                  
*                                                                               
* LOOK FOR SPACE TO PRINT "("                                                   
*                                                                               
         LA    RF,C.PCUNT+3                                                     
         CLI   0(RF),X'40'                                                      
         BE    *+10                                                             
         BCTR  RF,0                BACK UP ONE                                  
         B     *-10                                                             
         MVI   0(RF),C'('                                                       
*                                                                               
         LA    RF,C.PCUNT+4                                                     
         CLI   0(RF),X'40'                                                      
         BE    *+12                                                             
         LA    RF,1(RF)                                                         
         B     *-12                                                             
         MVC   1(6,RF),=C'UNITS)'                                               
*                                                                               
         CLC   C.PCUNT+3(2),=X'4DF1' IS THIS "(1" JUST ONE UNIT                 
         BNE   *+10                                                             
         MVC   5(2,RF),=C') '    YES, NO 'S' NEEDED                             
*                                                                               
         BRAS  RE,FPN              GO FIND PROGRAM NAME                         
*                                                                               
         MVI   C.PCPROGN,C'"'                                                   
         MVC   C.PCPROGN+1(L'SVPROGNM),SVPROGNM  PRNT PROGRAM NAME              
*                                                                               
         LA    RF,C.PCPROGN                                                     
         LA    RF,L'SVPROGNM+1(RF) LOOK FOR END OF PROG NAME                    
         CLI   0(RF),X'40'                                                      
         BH    *+10                                                             
         BCTR  RF,0                                                             
         B     *-10                                                             
*                                                                               
         MVI   1(RF),C'"'                                                       
*                                                                               
         CR    R1,R2               1ST COLUMN                                   
         BE    *+14                                                             
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         LR    R1,R2                                                            
         B     *+8                                                              
         LA    R1,PCPROGN1-PCPROGN(R1) POINT TO SECOND COLUMN                   
*                                                                               
         LA    R4,L'ALLPGENT(,R4)                                               
         B     BLIN51                                                           
*                                                                               
         DROP  C                                                                
*                                                                               
BLIN60   DS    0H                                                               
         TM    PATFLG2,TAGFLG      TURN ON TAG FLAG                             
         BZ    *+8                                                              
         OI    SVFLAG,SVTAG        THERE ARE TAGS ON INSTR                      
*                                                                               
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0                                                       
         LA    R2,P                                                             
*                                                                               
         DROP  R4                                                               
*                                                                               
BLIN80   OC    WORK+52(12),WORK+52  NEW DATES?                                  
         BZ    BLIN90               NO                                          
*                                                                               
         OC    WORK+52(6),WORK+52                                               
         BZ    *+14                                                             
         MVC   SVDATES,WORK+52                                                  
         BAS   R4,BLIN200                                                       
*                                                                               
         OC    WORK+58(6),WORK+58                                               
         BZ    *+14                                                             
         MVC   SVDATES,WORK+58                                                  
         BAS   R4,BLIN200                                                       
*                                                                               
         XC    WORK+52(12),WORK+52  DONE PRINTING, CLEAR ALL                    
*                                                                               
BLIN90   LA    R5,PATNEXT          NEXT UNIT                                    
         CLI   PATPROD1,0          ANY MORE                                     
         BZ    BLIN100              NO, DONE                                    
         CLI   SVTN2PRO+10,C'Y'    GEN INSTR FOR ENTIRE PERIOD                  
         BNE   BLIN10               NO, JUST FOR BUY DATES                      
         TM    PATFLG2,PATUSED     WAS THIS PATTERN USED                        
         BZ    BLIN80               NO                                          
         B     BLIN10                                                           
*                                                                               
BLIN100  NI    UPDSW,X'FF'-X'20'   SET OFF PRINT UNITS SW                       
         BRAS  RE,GOSPL                                                         
BLINX    XIT1                                                                   
                                                                                
CHKTAG   TM    PATFLG2,TAGFLG      CHK FOR TAG                                  
         BZR   R4                                                               
         CLC   PSLN(6),SPACES                                                   
         BNH   *+8                                                              
         BAS   RE,NXL                                                           
         MVC   PSLN(6),=C'TAG(S)'                                               
         BR    R4                                                               
                                                                                
BLIN200  DS    0H                                                               
         LA    RF,P2                                                            
         CR    R2,RF                                                            
         BNH   BLIN210                                                          
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,3                                                       
         LA    R2,P                                                             
*                                                                               
BLIN210  DS   0H                                                                
         BAS   RE,CKPAT            SEE IF ANOTHER PATTERN COVERS THIS           
         BER   R4                   YES, ALL OKAY                               
*                                                                               
         BAS   RE,PROTMSG                                                       
*                                                                               
         L     R2,ASVPRINT                                                      
         MVC   0(6,R2),=C' FROM '                                               
*                                                                               
         LA    R2,6(R2)            BUMP BEYOND " FROM "                         
         ST    R2,ASVNOBP          SAVE FOR NO BUY OR PAT INDICATOR             
         GOTO1 DATCON,DMCB,(3,SVDATES),(5,1(R2))     PDATES                     
         MVI   9(R2),C'-'                                                       
         GOTO1 (RF),(R1),(3,SVDATES+3),(5,10(R2))                               
         LA    R1,17(R2)                                                        
         ST    R1,ASVPRINT                                                      
*                                                                               
         L     R1,ASVNOBP          PRINT NO BUY OR PAT INDICATOR HERE           
         CLI   SVTN2PRO+10,C'Y'    GEN INSTR FOR ENTIRE PERIOD                  
         BNE   *+8                  NO                                          
         MVI   0(R1),C'*'          BUY IS NO LONGER COVERED BY PAT              
*                                                                               
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0                                                       
         LA    R2,P                                                             
*                                                                               
         MVC   PSLN(5),=C'LEN= '                                                
         LLC   R0,PATSLN                                                        
         EDIT  (R0),(3,PSLN+5)                                                  
*                                                                               
         CLI   PATPROD2,0          SECOND PROD                                  
         BE    BLIN212              NO                                          
         CLI   PATSLN2,0           SECOND LEN                                   
         BE    BLIN212              NO                                          
         MVI   PSLN+8,C'/'                                                      
         EDIT  (B1,PATSLN2),(3,PSLN+9)                                          
*                                                                               
BLIN212  MVC   PCML+2(15),=CL15'TO BE ANNOUNCED'                                
*                                                                               
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         BAS   RE,NXL                                                           
*                                                                               
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0                                                       
         LA    R2,P                                                             
         BR    R4                                                               
*                                                                               
ALPHATAB DC    C'ABCDEFGHIJKL'                                                  
         EJECT                                                                  
*------------------------------------------                                     
* PRINT "ROTATE THE FOLLOWING" MESSAGE                                          
*------------------------------------------                                     
PROTMSG  NTR1                                                                   
         MVC   2(L'ROTMSG,R2),ROTMSG  PRINT ROTATION MESSAGE                    
         LA    R1,2+L'ROTMSG(R2)                                                
         ST    R1,ASVPRINT         SAVE PRINT LOCATION                          
*                                                                               
         CLI   PATPROG,X'FF'       THIS FEED/DAYPART                            
         BE    PROT20               YES                                         
         MVC   0(L'ALLPMSG,R1),ALLPMSG  FOR ALL PROGS MSG                       
         LA    R1,L'ALLPMSG(R1)                                                 
         ST    R1,ASVPRINT         SAVE PRINT LOCATION                          
*                                                                               
         MVC   SVPROG,PATPROG                                                   
*                                                                               
         OC    PATPROG,PATPROG     PROGRAM SPECIFIC                             
         BNZ   PROT10                                                           
         CLI   SVTN1PRG,C'Y'       PRINT SCHEDULE SUMMARY                       
*TEMP    BE    *+12                 YES                                         
         CLI   SVTN1PR3,C'Y'       SUPPRESS PROGRAMS COVERED BY                 
         BE    PROT20                                                           
*NOP*******************************************                                 
*** DO WE NEED THIS CTP CALL  **NOP LATER ***                                   
*NOP*******************************************                                 
         BRAS  RE,CTP              GO COUNT PROGRAMS COVERED                    
         B     PROT20              IF PATTERN IS NOT PROG SPEC                  
*                                  PRINT "ALL PROGRAMS" MESSAGE                 
*NOP     BNE   PROT20               MORE THAN 1                                 
*                                                                               
         MVC   SVPROG,WORK+ALLPGPRG-ALLPGENT                                    
*                                                                               
         L     RF,APRGTBLE                                                      
         USING PRGTABLD,RF                                                      
*                                                                               
         CLC   PRGPRG,SVPROG                                                    
         BE    *+18                                                             
         LA    RF,PRGNEXT                                                       
         OC    0(4,RF),0(RF)       EOL                                          
         BNZ   *-20                 NO                                          
         MVC   SVPROGDT,PRGHIDTE                                                
*                                                                               
         DROP  RF                                                               
*                                                                               
PROT10   BRAS  RE,FPN              GO FIND PROGRAM NAME                         
*                                                                               
         L     R1,ASVPRINT         GET ADDRES OF PRINT LOCATION                 
         SHI   R1,L'ALLPMSG        BACK UP TO REPLACE ALL PROGS MESSAGE         
         MVC   0(9,R1),=C'PROGRAM "'  WITH PROGRAM SPECIFIC MESSAGE             
         MVC   9(16,R1),SVPROGNM   PRINT PROGRAM NAME                           
*                                                                               
         LA    R1,25(R1)           LOOK FOR END OF PROG NAME                    
         CLI   0(R1),X'40'                                                      
         BH    *+10                                                             
         BCTR  R1,0                                                             
         B     *-10                                                             
*                                                                               
         MVI   1(R1),C'"'                                                       
         MVC   3(6,R1),SVPROG     AND PROGRAM CODE                              
         LA    R1,9(R1)                                                         
         ST    R1,ASVPRINT         SAVE ADDRESS OF PRINT LOCATION               
*                                                                               
PROT20   DS    0H                                                               
*                                                                               
         LA    R2,132(R2)                                                       
*                                                                               
* FOR PRODUCT SPECIFIC REQUEST IF THERE IS P/B                                  
* PRINT PRD/PRD2 IN THE BODY OF THE REPORT                                      
* OTHERWISE SKIP PRODUCT PRINTING                                               
*                                                                               
PROT30   CLC   OPTPROD,SPACES      BY PRODUCT REQUEST                           
         BNH   PROT40                NO, GO PRINT PRD                           
*                                                                               
         CLI   PATPROD2,0          P/B PROD                                     
         BE    PROT50               NO, NO NEED TO PRINT PROD                   
*                                                                               
PROT40   MVC   PPROD(5),=C'PRD= '                                               
         MVC   PPROD+5(3),PATPROD1                                              
PROT50   MVC   QPRD,PATPROD1                                                    
         BRAS  RE,FPRD                                                          
         CLC   OPTPROD,SPACES      BY PRODUCT REQUEST                           
         BNH   *+12                 NO, PRINT PROD NAME                         
         CLI   PATPROD2,0          P/B PROD                                     
         BE    PROT60                                                           
         MVC   PPRDNM,PRDNM                                                     
*                                                                               
         LA    R2,132(R2)                                                       
*                                                                               
         CLI   PATPROD2,0          P/B PROD                                     
         BE    PROT60                                                           
         MVC   PPROD(5),=C'P/B= '                                               
         MVC   PPROD+5(3),PATPROD2                                              
         MVC   QPRD,PATPROD2                                                    
         BRAS  RE,FPRD                                                          
         MVC   PPRDNM,PRDNM                                                     
         LA    R2,132(R2)                                                       
*                                                                               
PROT60   DS   0H                                                                
         CLI   PATDP,0             ANY DAYPART                                  
         BE    PROT80                                                           
         OC    PATSEQ,PATSEQ       ANY PATTERN ASSIGNED                         
         BZ    PROT80                                                           
*                                                                               
         XC    GERROR,GERROR                                                    
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
*                                                                               
         GOTO1 VALIDPT,DMCB,(X'01',PATDP)  GET 2 CHAR DAYPART                   
*                                                                               
         L     R1,ASVPRINT         GET ADDRES OF PRINT LOCATION                 
         MVC   0(11,R1),=C'IN DAYPART '                                         
*                                                                               
         MVI   ERROPT,0                                                         
         OC    GERROR,GERROR                                                    
         BZ    PROT70                                                           
*                                                                               
         MVC   11(2,R1),=C'??'     BAD DAYPART CODE PRINT '??'                  
         B     *+10                                                             
PROT70   MVC   11(2,R1),QDPT2                                                   
         LA    R1,13(R1)                                                        
         ST    R1,ASVPRINT                                                      
*                                                                               
PROT80   XIT1  REGS=(R2)                                                        
         EJECT                                                                  
ROTMSG   DC    C'=====> ROTATE THE FOLLOWING FOR '                              
ALLPMSG  DC    C'ALL PROGRAMS '                                                 
ROTCMSG  DC    C'***** ROTATE COMMERCIALS AS FOLLOWS:'                          
*                                                                               
SEEMORE  DC    C'+++++'                                                         
         DC    C' SEE ADDITIONAL COMMERCIAL INFORMATION BELOW '                 
         DC    C'+++++'                                                         
SEEMOREX EQU   *                                                                
***********************************************************                     
*                                                                               
* SEE IF ANOTHER PATTERN IN TABLE COVERS THES MISSING DATES                     
*                                                                               
* PARAS HOLDS                                                                   
*                                                                               
***********************************************************                     
*                                                                               
CKPAT    NTR1                                                                   
         XC    PARAS(12),PARAS                                                  
         XC    ELEM,ELEM                                                        
         L     R3,APATABLE                                                      
L        USING PATABLED,R3                                                      
         GOTO1 DATCON,DMCB,(3,SVDATES),(2,PARAS)                                
         GOTO1 (RF),(R1),(3,SVDATES+3),(2,PARAS+2)                              
*                                                                               
CKPAT10  DS    0H                                                               
         CR    R3,R5               THIS ORIG PAT                                
         BE    CKPAT30              YES, CK OTHERS                              
*                                                                               
         CLC   PATSORT(19),L.PATSORT   SAME TYPE                                
         BNE   CKPAT30                                                          
*                                                                               
* SEE IF OUTSIDE THIS PATTERN DATES                                             
*                                                                               
         CLC   PARAS(2),L.PATPEND  CK START TO PAT END                          
         BH    CKPAT30              OUT OF RANGE                                
*                                                                               
         CLC   PARAS+2(2),L.PATPSTR CK END TO PAT START                         
         BL    CKPAT30              OUT OF RANGE                                
*                                                                               
* SEE IF FULLY COVERED BY THIS PATTERN DATES                                    
*                                                                               
         CLC   PARAS(2),L.PATPSTR  CK START TO PAT STR                          
         BNL   CKPAT14              BEFORE PAT START                            
*                                                                               
* GET UNCOVERED DATES BEFORE PAT                                                
*                                                                               
         MVC   PARAS+4(2),PARAS                                                 
         GOTO1 DATCON,DMCB,(2,L.PATPSTR),(0,PARAS+12)                           
         GOTO1 ADDAY,(R1),PARAS+12,PARAS+12,F'-1' SUBTR 1                       
         GOTO1 DATCON,(R1),(0,PARAS+12),(2,PARAS+6)                             
*                                                                               
CKPAT14  DS    0H                                                               
         CLC   PARAS+2(2),L.PATPEND CK END TO PAT END                           
         BNH   CKPAT20              FULLY COVERED                               
*                                                                               
* GET UNCOVERED DATES AFTER PAT                                                 
*                                                                               
         MVC   PARAS+10(2),PARAS+2                                              
         GOTO1 DATCON,DMCB,(2,L.PATPEND),(0,PARAS+12)                           
         GOTO1 ADDAY,(R1),PARAS+12,PARAS+12,F'1' ADD 1                          
         GOTO1 DATCON,(R1),(0,PARAS+12),(2,PARAS+8)                             
*                                                                               
CKPAT20  DS    0H                                                               
         OC    PARAS+4(4),PARAS+4    MISSED START                               
         BZ    CKPAT24                                                          
         MVC   PARAS(4),PARAS+4                                                 
         XC    PARAS+4(4),PARAS+4    CLEAR BEFORE START                         
         B     CKPAT10                                                          
*                                                                               
CKPAT24  DS    0H                                                               
         OC    PARAS+8(4),PARAS+8  MISSED END                                   
         BZ    CKPATEQX                                                         
         MVC   PARAS(4),PARAS+8                                                 
         XC    PARAS+8(4),PARAS+8                                               
         B     CKPAT10                                                          
*                                                                               
CKPAT30  LA    R3,L.PATNEXT        NEXT UNIT                                    
         CLI   L.PATPROD1,0        ANY MORE                                     
         BNE   CKPAT10              YES                                         
         OC    ELEM,ELEM           DONE SECOND PASS                             
         BNZ   CKPAT40              YES                                         
*                                                                               
         OC    PATPROG,PATPROG     WAS THIS SPECIFIC                            
         BNZ   CKPAT34              YES                                         
         OC    PATFEED,PATFEED                                                  
         BNZ   CKPAT34              YES                                         
         CLI   PATDP,0                                                          
         BE    CKPAT40              NOT SPECIFIC, ALL DONE                      
*                                                                               
CKPAT34  DS    0H                                                               
         MVC   ELEM(L'PATENT),PATENT                                            
         LA    R5,ELEM                                                          
         XC    PATPROG,PATPROG                                                  
         XC    PATFEED,PATFEED                                                  
         MVI   PATDP,0                                                          
         L     R2,APATABLE                                                      
         B     CKPAT10                                                          
*                                                                               
CKPAT40  DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,PARAS),(3,SVDATES)                                
         GOTO1 (RF),(R1),(2,PARAS+2),(3,SVDATES+3)                              
*                                                                               
         LTR   RB,RB               SET TO NO PATTERN FOUND                      
         B     *+6                                                              
CKPATEQX CR    R0,R0               SET TO FOUND PATTERN COVERING                
         XIT1                                                                   
         DROP  R3,L                                                             
         EJECT                                                                  
* PRINT OTHER INFORMATION                                                       
*                                                                               
POTHR    NTR1                                                                   
                                                                                
         CLC   FLD,SPACES          ANY CML RUN TIME TO PRINT                    
         BNH   POTHR05                                                          
*                                                                               
         CLC   PCMLRUN,SPACES      DID WE PRINT "FROM" DATES                    
         BH    POTHR05                                                          
*                                                                               
         LA    R3,PCMLRUN                                                       
         LA    R3,3(R3)            LINE UP TEXT                                 
*                                                                               
         MVC   0(L'PCMLRUN-3,R3),FLD  PRINT "UNTIL" MESSAGE HERE                
         XC    FLD,FLD                                                          
*                                                                               
POTHR05  OC    SVHIDEF,SVHIDEF     ANY HIDEF                                    
         BZ    POTH10                                                           
         CLC   PHIDEF(9),SPACES                                                 
         BNH   *+8                                                              
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         MVC   PHIDEF(9),=C'HIDEF  = '                                          
         MVC   PHIDEF+9(L'SVHIDEF),SVHIDEF                                      
         XC    SVHIDEF,SVHIDEF                                                  
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         B     POTHX                                                            
*                                                                               
POTH10   DS    0H                                                               
         OC    SVCNTRC,SVCNTRC     ANY CENTRCUT                                 
         BZ    POTH20                                                           
         CLC   PCNTRC(9),SPACES                                                 
         BNH   *+8                                                              
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         MVC   PCNTRC(9),=C'CTRCUT = '                                          
         MVC   PCNTRC+9(L'SVCNTRC),SVCNTRC                                      
         XC    SVCNTRC,SVCNTRC     ANY CENTRCUT                                 
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         B     POTHX                                                            
*                                                                               
POTH20   DS    0H                                                               
         OC    SVCMCLTN,SVCMCLTN   ANY CLIENT CML NUMBER                        
         BZ    POTHX                                                            
         MVC   PCLTCML(9),=C'ALT#   = '  CHGD LABEL FROM CLT->ALT !!            
         MVC   PCLTCML+9(L'SVCMCLTN),SVCMCLTN                                   
         XC    SVCMCLTN,SVCMCLTN                                                
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         B     POTHX                                                            
*                                                                               
POTHX    CLC   0(130,R2),SPACES                                                 
         BE    *+8                                                              
         BAS   RE,NXL                                                           
         XIT1  REGS=(R2)                                                        
         EJECT                                                                  
*-------------------------------------------------                              
* SUBROUTINE TO PRINT PATTERN TEXT IN BOXES                                     
*-------------------------------------------------                              
PTXT     NTR1                                                                   
*                                                                               
* FIRST - FIND LENGTH OF LONGEST COMMENT *                                      
*                                                                               
         SR    R5,R5                                                            
         LR    R4,R6                                                            
*                                                                               
PTXT10   LLC   RE,1(R6)                                                         
         CR    R5,RE                                                            
         BH    *+6                                                              
         LR    R5,RE                                                            
         BRAS  RE,NEXTEL                                                        
         BE    PTXT10                                                           
*                                                                               
* LENGTH IN R5 INCLUDES 3 FOR ELCODE/LEN/SEQ - NOW ADJUST FOR                   
* '*/SP' AND 'SP/*' AT EITHER END                                               
*                                                                               
         LA    R5,1(R5)                                                         
*                                                                               
* CREATE ROW OF *'S THIS LENGTH                                                 
*                                                                               
         MVI   PFEED,C'*'                                                       
         BCTR  R5,0                ADJUST FOR FIRST *                           
         BCTR  R5,0                SET FOR EX                                   
         EX    R5,PTXTAST                                                       
         LA    R5,2(R5)            RESTORE LENGTH                               
*                                                                               
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
*                                                                               
         LR    R6,R4                                                            
         EJECT                                                                  
PTXT20   LLC   RE,1(R6)                                                         
*                                                                               
         MVI   PFEED,C'*'                                                       
         AHI   RE,-4               SET FOR EX                                   
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   PFEED+2(0),3(R6) *EXECUTED*                                      
*                                                                               
         LA    RE,PFEED-1(R5)      POINT TO END OF LINE                         
         MVI   0(RE),C'*'                                                       
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         BRAS  RE,NEXTEL                                                        
         BE    PTXT20                                                           
*                                                                               
         MVI   PFEED,C'*'                                                       
         BCTR  R5,0                ADJUST FOR FIRST *                           
         BCTR  R5,0                SET FOR EX                                   
         EX    R5,PTXTAST                                                       
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
PTXTX    XIT1  REGS=(R2)                                                        
*                                                                               
PTXTAST  MVC   PFEED+1(0),PFEED  *EXECUTED*                                     
         EJECT                                                                  
* INCREMENT TO NEXT LINE AND PRINT IF ALL USED *                                
*                                                                               
         DS   0H                                                                
NXL      NTR1                                                                   
         MVI   131(R2),0                                                        
         LA    R2,132(,R2)                                                      
         LA    R0,P4                                                            
         CR    R2,R0                                                            
         BNH   NXLX                                                             
         NI    ANYFLAG,X'FF'-BLNKLN                                             
         CLC   P4(130),SPACES                                                   
         BH    *+8                                                              
         OI    ANYFLAG,BLNKLN                                                   
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0                                                       
         LA    R2,P                                                             
NXLX     XIT1  REGS=(R2)                                                        
         EJECT                                                                  
         LTORG                                                                  
         DROP  R6,RB                                                            
         EJECT                                                                  
*------------------------                                                       
* GET PROGRAM NAME                                                              
*------------------------                                                       
*                                                                               
FPN      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,SVPROG                                                  
         MVC   NPGKEND,SVPROGDT                                                 
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R6,AIO2                                                          
         ST    R6,AIO                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         XC    FILENAME,FILENAME                                                
*                                                                               
         MVI   ELCODE,X'92'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPGEL92,R6                                                       
         MVC   SVPROGNM,NPGNAME                                                 
         XIT1                                                                   
         EJECT                                                                  
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
*-------------------------                                                      
* FIND FEED DESCRIPTION                                                         
*-------------------------                                                      
*                                                                               
RFEED    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A2B'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(4),NETWORK                                                 
         MVC   KEY+7(2),BCLT                                                    
         MVC   KEY+9(4),PATFEED                                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    RFEED10                                                          
*                                                                               
         MVC   KEY(13),KEYSAVE                                                  
         XC    KEY+7(2),KEYSAVE+7  CLEAR CLIENT                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   RFEEDX                                                           
*                                                                               
RFEED10  L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'20'        FEED DESCR ELEM                              
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   PFEEDNM,3(R6)                                                    
         CLI   1(R6),63            NEW ELEM                                     
         BE    *+10                YES                                          
         MVC   PFEEDNM,2(R6)                                                    
*                                                                               
         TM    PATFLG,PATFLFDD     FEED NO NATIONAL                             
         BZ    RFEED15              NO                                          
*                                                                               
* LOOK FOR THE END OF THE FEED DESCRIPTION                                      
*                                                                               
         LA    RE,PFEEDNM                                                       
         LA    R1,PFEEDNM+60                                                    
RFEED13  CR    R1,RE               REACHED START OF FEED DESC FIELD?            
         BNH   RFEED14              YES                                         
         CLC   0(1,R1),SPACES                                                   
         BH    RFEED14                                                          
         BCT   R1,RFEED13                                                       
*                                                                               
RFEED14  MVC   5(19,R1),=C'*** NO NATIONAL ***'                                 
*                                                                               
RFEED15  BAS   RE,NXL1             GO TO NEXT PRINT LINE OR PRINT               
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BE    *+18                                                             
         BRAS  RE,INITXSP                                                       
         MVC   AIO,AIO1                                                         
         B     NXLX1                                                            
                                                                                
         MVC   PFEEDNM,3(R6)                                                    
         CLI   1(R6),63                                                         
         BE    *+10                                                             
         MVC   PFEEDNM,2(R6)                                                    
         B     RFEED15                                                          
*                                                                               
RFEEDX   BRAS  RE,INITXSP                                                       
         MVC   AIO,AIO1                                                         
         XIT1                                                                   
         SPACE 3                                                                
* INCREMENT TO NEXT LINE AND PRINT IF ALL USED *                                
*                                                                               
         DS   0H                                                                
NXL1     NTR1                                                                   
         NI    ANYFLAG,X'FF'-BLNKLN                                             
         MVI   131(R2),0                                                        
         LA    R2,132(,R2)                                                      
         LA    R0,P4                                                            
         CLI   MYTN2PRE,C'Y'       PRINT CLT CML#                               
         BNE   *+8                                                              
         LA    R0,P3                                                            
         CR    R2,R0                                                            
         BNH   NXLX1                                                            
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0                                                       
         LA    R2,P                                                             
NXLX1    XIT1  REGS=(R2)                                                        
         SPACE 3                                                                
         EJECT                                                                  
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
*-------------------------                                                      
* FIND PRODUCT NAME                                                             
*-------------------------                                                      
*                                                                               
FPRD     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),BAGYMD                                                  
         MVC   KEY+2(2),BCLT                                                    
         MVC   KEY+4(3),QPRD                                                    
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         USING PRDHDRD,R6                                                       
*                                                                               
         MVC   PRDNM(20),PNAME       AND PRODUCT NAME                           
         LA    R0,SVPRDLEN                                                      
         L     R1,AIO3            SVPRDLST                                      
FPRD10   CLC   QPRD,0(R1)                                                       
         BE    FPRD20                                                           
         OC    0(4,R1),0(R1)                                                    
         BZ    FPRD14                                                           
         LA    R1,SVPRDENT(,R1)                                                 
         BCT   R0,FPRD10                                                        
         DC    H'0'                                                             
FPRD14   MVC   0(3,R1),QPRD                                                     
FPRD20   B     FPRDX                                                            
*                                                                               
FPRD30   MVC   QPRD,=C'---'                                                     
         MVC   PRDNM,=CL20'TO BE ALLOCATED'                                     
         TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    FPRDX                                                            
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    FPRDX                                                            
         TM    PATFLG,X'52'       DELETED/MISSED/TRAFFIC DELETE                 
         BNZ   FPRDX                                                            
         DC    H'0'                                                             
*                                                                               
FPRDX    BRAS  RE,INITNET                                                       
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         DROP  R6,RB                                                            
         EJECT                                                                  
*------------------------------------------------------------                   
* COUNT PROGRAMS COVERED, AND IF ONLY 1, PRINT PROGRAM NAME                     
*------------------------------------------------------------                   
*                                                                               
CTP      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PATABLED,R5                                                      
*                                                                               
         MVI   BYTE,0                                                           
         MVC   HALF(1),PATFLG2     SAVE OOPS FLAG FOR LATER                     
*                                                                               
AP       USING ALLPRGD,R4                                                       
W        USING ALLPRGD,WORK                                                     
         XC    WORK(L'ALLPGENT),WORK                                            
         MVC   W.ALLPGP1,PATPROD1                                               
         MVC   W.ALLPGP2,PATPROD2                                               
         MVC   W.ALLPGS1,PATSLN                                                 
         MVC   W.ALLPGS2,PATSLN2                                                
         MVC   W.ALLPGSEQ,PATSEQ                                                
         MVC   W.ALLPGKEY,PATKEY                                                
         MVC   W.ALLPGFD,PATFEED                                                
         MVC   W.ALLPGDP,PATDP                                                  
         MVC   W.ALLPGLDT,PATSTR                                                
         MVC   W.ALLPGHDT,PATEND                                                
*                                                                               
         L     R4,ALLPRTAB         START OF ALL PROGRAM TABLE                   
*                                                                               
         SR    R5,R5                                                            
CTP10    OC    0(L'ALLPGENT,R4),0(R4)      EMPTY ENTRY                          
         BZ    CTP50                                                            
*                                                                               
         CLC   WORK(ALLPGPRG-ALLPRGD),0(R4)  FOUND IN TABLE                     
         BNE   CTP14                                                            
                                                                                
* MAKE SURE DATES FALL W/N RANGE                                                
         CLC   W.ALLPGLDT,AP.ALLPGHDT                                           
         BH    CTP14                                                            
         CLC   W.ALLPGHDT,AP.ALLPGLDT                                           
         BL    CTP14                                                            
                                                                                
         OC    AP.ALLPGPRG,AP.ALLPGPRG         ANY PROGRAM?                     
         BNZ   CTP20                                                            
CTP14    LA    R4,L'ALLPGENT(,R4)                                               
         B     CTP10                                                            
*                                                                               
CTP20    MVC   W.ALLPGPRG,AP.ALLPGPRG     SAVE PROGRAM FROM TABLE               
*                                                                               
CTP30    CLC   WORK(ALLPGPRG-ALLPRGD),0(R4)  FOUND IN TABLE                     
         BNE   CTP40                                                            
         OC    AP.ALLPGPRG,AP.ALLPGPRG         ANY PROGRAM?                     
         BZ    CTP40                NO, BYPASS                                  
                                                                                
* MAKE SURE DATES FALL W/N RANGE                                                
         CLC   W.ALLPGLDT,AP.ALLPGHDT                                           
         BH    CTP40                                                            
         CLC   W.ALLPGHDT,AP.ALLPGLDT                                           
         BL    CTP40                                                            
                                                                                
         LA    R5,1(,R5)                                                        
CTP40    LA    R4,L'ALLPGENT(,R4)                                               
         OC    0(L'ALLPGENT,R4),0(R4) EMPTY ENTRY                               
         BNZ   CTP30                                                            
*                                                                               
CTP50    BCTR  R5,0                SUBT 1                                       
         LTR   R5,R5               IF MORE THAN 1, DONE                         
         STC   R5,BYTE                                                          
         XIT1                                                                   
         DROP  AP,W                                                             
*                                                                               
PATTNERR MVC   CONHEAD,PATTNERM                                                 
         LA    R2,TRACLTH                                                       
         GOTO1 ERREX2                                                           
         LTORG                                                                  
PATTNERM DC    CL60'* ERROR * CHANGED PATTERN DATES, RERUN SEED *'              
         DROP  R5,RB                                                            
         EJECT                                                                  
*---------------------------------                                              
* FIND COMMERCIAL INFORMATION                                                   
*---------------------------------                                              
*                                                                               
FCML     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    SVHIDEF,SVHIDEF                                                  
         XC    SVCNTRC,SVCNTRC                                                  
         XC    SVCMCLTN,SVCMCLTN                                                
         XC    SVCMLDS(72),SVCMLDS                                              
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING CMLKEY,R4                                                        
         MVC   CMLKID,=X'0A21'                                                  
         MVC   CMLKAM(3),BAGYMD AND BCLT                                        
         MVC   CMLKCML,SVCMLCOD                                                 
*                                                                               
         BRAS  RE,INITSPT                                                       
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    FCML03                                                           
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE KEY                                  
         MVI   KEY+1,X'C1'         READ 0AC1 KEY                                
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* IF 8 CHAR ISCII THEN UNPACK AND USE IT                                        
*                                                                               
         XC    SVADISCI,SVADISCI                                                
         GOTO1 VTRPACK,DMCB,(C'U',SVCMLCOD),SVADISCI                            
         CLI   SVADISCI+8,C' '                                                  
         BH    FCML03                                                           
         MVC   SVCMLCOD,SVADISCI   USE 8 CHAR ISCII                             
*                                                                               
FCML03   L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         XC    SVCMLADI,SVCMLADI                                                
         XC    SVCMLADR,SVCMLADR                                                
*                                                                               
         MVI   ELCODE,X'A0'        ADID ELEMENT                                 
         BRAS  RE,GETEL                                                         
         BNE   FCML06                                                           
*                                                                               
         TM    ANYFLAG,CLTCMLNO    JUST GET CLT CML #                           
         BZ    *+14                                                             
         MVC   SVCMLADR,2(R6)                                                   
         B     FCML06                                                           
*                                                                               
         MVC   SVCMLADI,2(R6)      SAVE PRINTABLE ADID                          
*                                                                               
FCML06   DS    0H                                                               
         XC    FLD,FLD             SAVE ADDITIONAL CML INFO                     
         LA    R1,FLD                                                           
         USING CMLCMLD,R1                                                       
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'24'                                                     
         BRAS  RE,GETEL                                                         
         BNE   FCML06F                                                          
         USING CMLXDTEL,R6                                                      
         CLC   CMLXHDEF,SPACES                                                  
         BNH   *+10                                                             
         MVC   SVHIDEF,CMLXHDEF    SAVE HIDEF                                   
         CLC   CMLXCNTR,SPACES                                                  
         BNH   *+10                                                             
         MVC   SVCNTRC,CMLXCNTR    SAVE CENTRCUT                                
*                                                                               
         CLI   CMLXSWAP,C'Y'       SWAP HIDEF AND CNTRCUT                       
         BNE   FCML06C                                                          
         XC    SVCNTRC,SVHIDEF                                                  
         XC    SVHIDEF,SVCNTRC                                                  
         XC    SVCNTRC,SVHIDEF                                                  
*                                                                               
FCML06C  DS    0H                                                               
         MVC   CMLDDT,CMLXDSDT     SAVE CML DESTROY TIME                        
         MVC   CMLDTM,CMLXDSTM     AND DATE                                     
         DROP  R6                                                               
*                                                                               
FCML06F  L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING CMLDTAEL,R6                                                      
*                                                                               
         TM    CMLSTAT,X'40'    ANY COMTEXT                                     
         BZ    *+8                                                              
         MVI   CMLTXT,C'Y'         COMTEXT PRESENT                              
*                                                                               
         CLI   SVTN1PR6,C'S'       SUPPRESS TYPE                                
         BE    FCML06J                                                          
                                                                                
         CLI   SVTN1PR6,C'Y'       SUPPRESS TYPE                                
         BE    *+10                                                             
         MVC   CMLTYP,CMLTYPE      SAVE CML TYPE                                
         DROP  R1                                                               
*                                                                               
FCML06J  MVC   SVCMCLTN,CMLCLTNO                                                
         MVC   SVCMLLEN,CMLSLN                                                  
         MVC   SVCMLOVR,CMLOVRD1   SAVE CMLOVRD1 & CMLOVRD2                     
         TM    CMLSTAT,X'80'       TEST DELETED COMMERCIAL                      
         BO    FCML30                                                           
*                                                                               
         USING PATABLED,R5                                                      
*                                                                               
         GOTO1 DATCON,DMCB,(2,PATSTR),(3,DUB)                                   
         GOTO1 (RF),(R1),(2,PATEND),(3,DUB+3)                                   
         CLC   CMLRLSE,DUB+3       SEE IF CML COVERS PATTERN                    
         BH    FCML30                                                           
         CLC   CMLRCL,DUB                                                       
         BL    FCML30                                                           
*                                                                               
         MVC   SVCMLDS(15),CMLTITLE                                             
*                                                                               
         OC    SVCMLADI,SVCMLADI   IS THERE AN AD-ID                            
         BNZ   FCML07               YES                                         
         CLI   MYTN2PRE,C'Y'       PRINT CLT CML#                               
         BNE   FCML07               NO                                          
         OC    SVCMCLTN,SVCMCLTN   ANY CLT CML #                                
         BNZ   FCML07               YES                                         
         MVC   PCMLTL(15),CMLTITLE                                              
*                                                                               
FCML07   DS    0H                                                               
         LA    R0,TYPTABCT                                                      
         LA    R1,TYPTABLE                                                      
FCML10   CLC   CMLTYPE,0(R1)                                                    
         BE    FCML20                                                           
         LA    R1,15(,R1)                                                       
         BCT   R0,FCML10                                                        
*                                                                               
FCML20   MVI   ELCODE,X'30'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   FCML24                                                           
         MVC   SVCMLDS,3(R6)       DESCRIPTION 1                                
*                                                                               
         OC    SVCMLADI,SVCMLADI   IS THERE AN AD-ID                            
         BNZ   FCML22                                                           
         CLI   MYTN2PRE,C'Y'       PRINT CLT CML#                               
         BNE   FCML21                                                           
         OC    SVCMCLTN,SVCMCLTN   ANY CLT CML #                                
         BNZ   FCML22               YES                                         
*                                                                               
FCML21   DS    0H                                                               
         MVC   PCMLTL,3(R6)                                                     
*                                                                               
FCML22   DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   FCML24                                                           
         MVC   SVCMLDS2,3(R6)                                                   
         BRAS  RE,NEXTEL                                                        
         BNE   FCML24                                                           
         MVC   SVCMLDS3,3(R6)                                                   
FCML24   DS    0H                                                               
         MVC   PCML(L'SVCMLCOD),SVCMLCOD                                        
*                                                                               
         OC    SVCMLADI,SVCMLADI                                                
         BZ    FCML25                                                           
         MVC   PCML(12),SVCMLADI                                                
         MVC   PCMLTL(L'SVCMLDS),SVCMLDS                                        
*                                                                               
FCML25   DS    0H                                                               
         CLI   MYTN2PRE,C'Y'       PRINT CLT CML#                               
         BNE   FCML25C              NO                                          
         OC    SVCMCLTN,SVCMCLTN   ANY CLT CML #                                
         BZ    FCML25C                                                          
         MVC   PCMLTL(L'SVCMLDS),SVCMLDS                                        
         B     FCMLX                                                            
*                                                                               
FCML25C  DS    0H                                                               
         OC    SVCMLADI,SVCMLADI                                                
         BNZ   FCMLX                                                            
*                                                                               
FCML28   MVC   PCMLTL,SVCMLDS                                                   
         B     FCMLX                                                            
*                                                                               
FCML30   MVC   SVCMLCOD,=CL8'NO COMML'                                          
         MVC   PCMLTL(8),=CL8'NO COMML'                                         
         XC    SVHIDEF,SVHIDEF     CLEAR HIDEF                                  
         XC    SVCNTRC,SVCNTRC      CENTRCUT                                    
         XC    SVCMCLTN,SVCMCLTN    CLIENT CML NUMBER                           
         B     FCMLXIT                                                          
*                                                                               
FCMLX    DS    0H                                                               
         OC    FLD,FLD             ANY CML ADDITIONAL INFO                      
         BZ    FCMLX1                                                           
*                                                                               
         OI    SVFLAG,SEEMORFL     PRINT SEE ADDITIONAL CML MSG                 
*                                                                               
         LA    R3,FLD                                                           
         USING CMLCMLD,R3                                                       
*                                                                               
         MVC   CMLCML8,SVCMLCOD    SAVE 8 CHAR ISCII                            
         MVC   CMLCML,SVCMLADI     PRESET TO ADID                               
         OC    SVCMLADI,SVCMLADI   ANY ADID                                     
         BNZ   *+10                                                             
         MVC   CMLCML,SVCMLCOD     ELSE SAVE 8 CHAR ISCII                       
*                                                                               
         MVC   CMLPRD,SVPRD                                                     
*                                                                               
         GOTO1 =V(BINSRCH),BINDMCB,(1,(R3)),RR=SPTR63RR                         
         L     R3,0(R1)                                                         
         LTR   R3,R3                                                            
         BNZ   *+6                                                              
         DC    H'0'            *TABLE FULL                                      
*                                                                               
         DROP  R3                                                               
*                                                                               
FCMLX1   DS    0H                                                               
         MVC   FLD,SPACES          CLEAR SAVE AREA                              
                                                                                
         CLI   SVTN3PR3,C'N'       PRINT CMML RUN TIMES?                        
         BE    FCMLXIT              NO                                          
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'B0'        COMMERCIAL RUN TIMES                         
         BRAS  RE,GETEL                                                         
         BNE   FCMLXIT                                                          
         USING CMLMATEL,R6                                                      
*                                                                               
         CLC   =X'0000FFFF',CMLMSTIM  IF NO START OR END TIME                   
         BE    FCMLXIT             THEN DONE                                    
*                                                                               
         CLC   =X'0000',CMLMSTIM   START TIME ?                                 
         BE    FCMLXIT              NO, DONE                                    
*                                                                               
         TM    CMLMFLAG,X'80'      CHECK TIMES DAILY ?                          
         BZ    FCMLX2               NO                                          
                                                                                
         XC    DUB,DUB                                                          
                                                                                
         CLC   CMLMETIM,=X'FFFF'   NO END TIME ?                                
         BNE   *+14                 END TIME IS SET                             
         MVC   DUB(2),CMLMSTIM                                                  
         B     *+10                                                             
         MVC   DUB(4),CMLMSTIM                                                  
                                                                                
         LA    R3,DUB                                                           
         ST    R3,DMCB                                                          
         GOTO1 UNTIME,DMCB,,PCMLRUN                                             
                                                                                
         LA    R3,PCMLRUN                                                       
         CLI   0(R3),X'40'                                                      
         BNH   *+12                                                             
         LA    R3,1(R3)                                                         
         B     *-12                                                             
                                                                                
         MVC   1(5,R3),=C'DAILY'                                                
         B     FCMLXIT                                                          
*                                                                               
FCMLX2   LA    R3,PCMLRUN                                                       
         MVC   0(8,R3),=C'RUN FROM'                                             
         LA    R3,9(R3)                                                         
                                                                                
         GOTO1 DATCON,DMCB,(2,PATSTR),(4,0(R3))                                 
                                                                                
         LA    R3,5(R3)                                                         
         CLI   0(R3),X'40'                                                      
         BH    *+6                                                              
         BCTR  R3,0                                                             
         MVI   1(R3),C'-'                                                       
                                                                                
         XC    WORK,WORK                                                        
         MVC   WORK(2),CMLMSTIM                                                 
         GOTO1 UNTIME,DMCB,WORK,2(R3)                                           
*                                                                               
         CLC   =X'FFFF',CMLMSTIM+2 END TIME ?                                   
         BE    FCMLXIT             NONE                                         
*                                                                               
         LA    R3,FLD              RUN "UNTIL" WILL PRINT LATER                 
         MVC   0(5,R3),=C'UNTIL'                                                
                                                                                
         LA    R3,6(R3)                                                         
         GOTO1 DATCON,DMCB,(2,PATEND),(4,0(R3))                                 
         LA    R3,5(R3)                                                         
         CLI   0(R3),X'40'                                                      
         BH    *+6                                                              
         BCTR  R3,0                                                             
         MVI   1(R3),C'-'                                                       
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(2),CMLMSTIM+2                                               
         GOTO1 UNTIME,DMCB,WORK,2(R3)                                           
*                                                                               
FCMLXIT  XIT1                                                                   
*                                                                               
* CONVERSION OF CML TYPE TO PRINTABLE TYPE *                                    
*                                                                               
TYPTABLE DC    CL4'CLR ',CL11'CLR/VTR    '                                      
         DC    CL4'SC  ',CL11'SLIDE COPY '                                      
         DC    CL4'CPY ',CL11'COPY       '                                      
         DC    CL4'ABB ',CL11'AUDIO BB   '                                      
         DC    CL4'SSL ',CL11'SUPER SLIDE'                                      
         DC    CL4'CSL ',CL11'COLOR SLIDE'                                      
         DC    CL4'FBB ',CL11'FILM BB    '                                      
TYPTABCT EQU   (*-TYPTABLE)/20                                                  
         DC    CL4'XXXX',CL16'UNKNOWN TYPE'                                     
*                                                                               
         DROP  R5,RB                                                            
         LTORG                                                                  
         EJECT                                                                  
*----------------------------------                                             
* PRINT COMMENTS FOR THIS PROGRAM                                               
*----------------------------------                                             
*                                                                               
* EXPECTS:  AIO3 - SVPRDLST                                                     
*           SVCLIST                                                             
*                                                                               
* USES:     AIO1 - COMMENT REC (DTXRECD)                                        
*                - PRODUCT REC                                                  
*           R4   - KEY, COMMENT REC POINTER                                     
*           R5   - AIO3 (SVPRDLST)                                              
*                                                                               
PCOM     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITXSP                                                       
*                                                                               
         NI    SVOPTSW1,X'FF'-(USEDEF+PRNTDCMT)  RSET OPTS USED IN PCOM         
*                                                                               
         MVC   AIO,AIO1                                                         
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING DT2RECD,R4                                                       
*                                                                               
         L     R5,AIO3             SVPRDLST                                     
PCOM10   OC    0(3,R5),0(R5)       ANY MORE PRODUCTS?                           
         BZ    PCOM90               NO                                          
*                                                                               
         MVC   DT2KID,=X'0A2D'                                                  
         MVC   DT2KAM,BAGYMD                                                    
         MVC   DT2KCLT,BCLT                                                     
         MVC   DT2KMED,SVMEDIA                                                  
         MVC   DT2KNET,NETWORK                                                  
         MVC   DT2KPRD,0(R5)                                                    
*                                                                               
**       MVI   RDUPDATE,C'N'                                                    
**       GOTO1 HIGH                                                             
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(13),KEYSAVE     DID WE FIND NET/PRD REC?                     
         BE    PCOM20               YES - USE IT                                
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE KEY                                  
         XC    DT2KNET,DT2KNET                                                  
**       MVI   RDUPDATE,C'N'                                                    
**       GOTO1 HIGH                                                             
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(13),KEYSAVE     DID WE FIND MEDIA/PRD REC?                   
         BE    PCOM20               YES - USE IT                                
         OI    SVOPTSW1,USEDEF     SET FLAG TO PRINT A DEFAULT COMMENT          
         B     PCOM80                                                           
*                                                                               
PCOM20   DS    0H                                                               
         TM    SVOPTSW1,PRNTDCMT   ALREADY PRINTED COMMENTS?                    
         BNZ   PCOM30               YES                                         
         MVI   P,C'*'                                                           
         MVC   P+1(79),P           PRE-FILL PRINT LINE WITH *'S                 
         MVC   P+4(19),=C' START OF COMMENTS '                                  
         OI    SVOPTSW1,PRNTDCMT                                                
         BRAS  RE,GOSPL                                                         
*                                                                               
PCOM30   DS    0H                                                               
         LA    R1,P+3                                                           
         MVC   0(13,R1),=C'*COMMENT FOR '                                       
         LA    R1,13(R1)                                                        
         OC    DT2KNET,DT2KNET     WAS THIS MEDIA OR NET SPECIFIC?              
         BZ    PCOM40               MEDIA OR CLIENT                             
         MVC   0(4,R1),DT2KNET                                                  
         CLI   3(R1),C' '                                                       
         BNE   *+12                                                             
         LA    R1,3(R1)                                                         
         B     *+8                                                              
         LA    R1,4(R1)                                                         
         MVC   0(2,R1),=C', '                                                   
         LA    R1,2(R1)                                                         
         B     PCOM60                                                           
*                                                                               
PCOM40   DS    0H                                                               
         CLI   DT2KMED,0           WAS THIS MEDIA SPEC OR CLIENT?               
         BZ    PCOM50                                                           
         CLI   DT2KMED,C'C'                                                     
         BNE   *+18                                                             
         MVC   0(7,R1),=C'CABLE, '                                              
         LA    R1,7(R1)                                                         
         B     PCOM60                                                           
         CLI   DT2KMED,C'S'                                                     
         BNE   *+18                                                             
         MVC   0(13,R1),=C'SYNDICATION, '                                       
         LA    R1,13(R1)                                                        
         B     PCOM60                                                           
         CLI   DT2KMED,C'N'                                                     
         BNE   *+18                                                             
         MVC   0(9,R1),=C'NETWORK, '                                            
         LA    R1,9(R1)                                                         
         B     PCOM60                                                           
         CLI   DT2KMED,C'O'                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   0(7,R1),=C'OTHER, '                                              
         LA    R1,7(R1)                                                         
         B     PCOM60                                                           
*                                                                               
PCOM50   DS    0H                                                               
         MVC   0(07,R1),=C'CLIENT '                                             
         MVC   7(03,R1),QCLT                                                    
         LA    R1,11(R1)                                                        
         B     PCOM70              CAN'T BE PRD FOR CLT LEVEL COMMENT           
*                                                                               
PCOM60   DS    0H                                                               
         CLI   DT2KPRD,0           PRD SPECIFIC?                                
         BNE   *+16                 YES                                         
         BCTR  R1,0                                                             
         BCTR  R1,0                                                             
         MVI   0(R1),C' '          CLEAR ','                                    
         B     PCOM70                                                           
*                                                                               
         BAS   RE,PCFPRD           GET PRD NAME                                 
         MVC   0(8,R1),=C'PRODUCT '                                             
         LA    R1,8(R1)                                                         
         L     RF,AIO1                                                          
         MVC   0(L'PNAME,R1),PNAME-PRDHDRD(RF)                                  
         OC    0(L'PNAME,R1),SPACES                                             
         LA    R1,L'PNAME(R1)                                                   
         CLI   0(R1),C' '          FIND LAST PRINTED CHAR                       
         BNE   *+10                                                             
         BCTR  R1,0                                                             
         B     *-10                                                             
         MVC   1(2,R1),=C' ('                                                   
         MVC   3(3,R1),0(R5)       PRD CODE                                     
         CLI   5(R1),C' '                                                       
         BNE   *+12                                                             
         MVI   5(R1),C')'                                                       
         B     *+8                                                              
         MVI   6(R1),C')'                                                       
PCOM70   BRAS  RE,GOSPL                                                         
         BRAS  RE,PRNCMT              NOW GO PRINT COMMENTS                     
         CLI   DT2KPRD,0           DID WE JUST PRINT A DEFAULT COMMENT?         
         BE    PCOMX                YES - WE'RE DONE                            
*                                                                               
PCOM80   LA    R5,SVPRDENT(R5)     NEXT ENTRY IN PRD LST                        
         OC    0(3,R5),0(R5)       ANY MORE PRODUCTS?                           
         BNZ   PCOM10                                                           
*                                                                               
PCOM90   DS    0H                                                               
         CLI   SVTN1PR7,C'Y'       PRINT DEFAULT COMMENTS AS WELL               
         BE    PCOM94                                                           
*                                                                               
         TM    SVOPTSW1,USEDEF     DO WE NEED A DEFAULT COMMENT?                
         BZ    PCOMX                NO                                          
*                                                                               
PCOM94   DS    0H                                                               
         XC    KEY,KEY                                                          
         MVC   DT2KID,=X'0A2D'                                                  
         MVC   DT2KAM,BAGYMD                                                    
         MVC   DT2KCLT,BCLT                                                     
         MVC   DT2KMED,SVMEDIA                                                  
         MVC   DT2KNET,NETWORK                                                  
**       MVI   DTXKPRD,0                                                        
**       MVI   RDUPDATE,C'N'                                                    
**       GOTO1 HIGH                                                             
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(13),KEYSAVE     DO WE HAVE A NET SPEC?                       
         BE    PCOM20               YES                                         
         MVC   KEY,KEYSAVE                                                      
         XC    DT2KNET,DT2KNET                                                  
*        MVI   RDUPDATE,C'N'                                                    
*        GOTO1 HIGH                                                             
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(13),KEYSAVE     DO WE HAVE A MEDIA SPEC?                     
         BE    PCOM20               YES                                         
         MVC   KEY,KEYSAVE                                                      
         MVI   DT2KMED,0                                                        
*        MVI   RDUPDATE,C'N'                                                    
*        GOTO1 HIGH                                                             
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(13),KEYSAVE     DO WE HAVE A CLIENT SPEC?                    
         BE    PCOM20                                                           
*                                                                               
PCOMX    DS    0H                                                               
         TM    SVOPTSW1,PRNTDCMT   ANY CMTS PRINTED?                            
         BZ    PCOMXIT              NO                                          
         MVI   P,C'*'                                                           
         MVC   P+1(79),P           PRE-FILL PRINT LINE WITH *'S                 
         MVC   P+4(17),=C' END OF COMMENTS '                                    
         MVI   P2,0               FORCE BLANK LINE                              
         BRAS  RE,GOSPL                                                         
PCOMXIT  XIT1                                                                   
         EJECT                                                                  
*-----------------------                                                        
* FIND PRODUCT NAME                                                             
*-----------------------                                                        
*                                                                               
* EXPECTS R5 - A(PRD CODE)                                                      
* RETURNS PRD REC IN AIO (S.B. AIO1 IF CALLED FROM PCOM)                        
* NOTE: KEY IS RESTORED FOR SEQ                                                 
*                                                                               
*                                                                               
         DS    0H                                                               
PCFPRD   NTR1                                                                   
         MVC   SVLGKEY,KEY                                                      
         BRAS  RE,INITSPT          SET FROM NET TO SPOT                         
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),BAGYMD                                                  
         MVC   KEY+2(2),BCLT                                                    
         MVC   KEY+4(3),0(R5)                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         BRAS  RE,INITXSP                                                       
         MVC   KEY,SVLGKEY         RESTORE KEY                                  
**       MVI   RDUPDATE,C'N'                                                    
**       GOTO1 HIGH                RESTORE SEQ                                  
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         B     PCOMXIT                                                          
         SPACE 3                                                                
         LTORG                                                                  
         DROP  R4,RB                                                            
         EJECT                                                                  
*-----------------------------------                                            
* PRINT COMMENT REC & ANY PAGES                                                 
*-----------------------------------                                            
*                                                                               
PRNCMT   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   SVLGKEY,KEY         SAVE KEY                                     
PRNCMT10 CLC   =C'SPT',SYSFIL                                                   
         BNE   PRNCMT12                                                         
         GOTO1 GETREC                                                           
         B     PRNCMT14                                                         
*                                                                               
PRNCMT12 GOTO1 AIOCALL,DMCB,GETQ+FILQ+XSPQ,0                                    
*                                                                               
PRNCMT14 L     R6,AIO                                                           
         MVI   ELCODE,X'40'                                                     
         BRAS  RE,GETEL                                                         
         USING DTXTXTEL,R6                                                      
         BE    *+6                                                              
         DC    H'0'                                                             
PRNCMT20 LA    R0,4                                                             
         LA    R1,P+7                                                           
PRNCMT30 LLC   RF,DTXTXTLN                                                      
         SH    RF,=H'4'            GET TEXT LEN-1                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),DTXTXT                                                   
         CLC   0(132,R1),SPACES    IF STILL BLANK LINE                          
         BNE   *+8                                                              
         MVI   0(R1),0             FORCE LINE TO PRINT                          
         BRAS  RE,NEXTEL                                                        
         BNE   PRNCMT40                                                         
         LA    R1,132(R1)                                                       
         BCT   R0,PRNCMT30                                                      
         BRAS  RE,GOSPL                                                         
         B     PRNCMT20                                                         
PRNCMT40 BRAS  RE,GOSPL                                                         
*                                                                               
         CLC   =C'SPT',SYSFIL                                                   
         BNE   PRNCMT42                                                         
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         CLC   KEY(11),KEYSAVE                                                  
         BE    PRNCMT10                                                         
         B     PCX                                                              
*                                                                               
PRNCMT42 DS    0H                                                               
         MVC   MYKEYSV,KEY                                                      
         GOTO1 AIOCALL,DMCB,SEQQ+DIRQ+XSPQ,0                                    
         MVC   KEYSAVE,MYKEYSV                                                  
         CLC   KEY(13),KEYSAVE                                                  
         BE    PRNCMT10                                                         
*                                                                               
PCX      MVC   KEY,SVLGKEY         RESTORE KEY                                  
         XIT1                                                                   
         DROP  R6                                                               
         SPACE 3                                                                
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
*-------------------------------------------------------                        
* PRINT SPECIAL COMMENT AT THE END OF THE REPORT                                
*-------------------------------------------------------                        
*                                                                               
PSTEXT   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         MVC   AIO,AIO1                                                         
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING DTXRECD,R4                                                       
         MVC   DTXKID,=X'0A2D'                                                  
         MVC   DTXKAM,BAGYMD                                                    
         MVI   DTXKCLT,C'*'        CLT=OFFICE                                   
         MVC   DTXKCLT+1(1),SVCLTOFF                                            
         MVI   DTXKTYP,C'L'        LIVE TEXT (BODY)                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     ANY STEXT FOR THIS OFFICE                    
         BNE   PSTEXTX              NO, DONE                                    
*                                                                               
         MVI   P,0                                                              
         BRAS  RE,GOSPL                                                         
         BRAS  RE,PRNCMT              NOW GO PRINT COMMENTS                     
*                                                                               
PSTEXTX  XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
PACML    NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         MVI   P+131,0                                                          
         BRAS  RE,GOSPL                                                         
*                                                                               
         MVI   ALLOWLIN,3                                                       
         MVC   P+2(33),=C'ADDITIONAL COMMERCIAL INFORMATION'                    
         MVC   P2+2(33),=C'---------------------------------'                   
         BRAS  RE,GOSPL                                                         
*                                                                               
         LA    R1,900            MAX OF 900 ADDITIONAL CML INFO RECORDS         
PACML05  LA    R2,P                                                             
         USING PRTLINE,R2                                                       
*                                                                               
         USING CMLCMLD,R4                                                       
         MVC   PACMML,CMLCML       PRINT COMMERCIAL                             
                                                                                
         LA    R3,PATYPE                                                        
         OC    CMLTYP,CMLTYP                                                    
         BZ    PACML07                                                          
         MVC   0(6,R3),=C'TYPE= '                                               
         MVC   6(L'CMLTYP,R3),CMLTYP                                            
         LA    R3,6+5+L'CMLTYP(R3)                                              
*                                                                               
PACML07  OC    CMLDDT,CMLDDT                                                    
         BZ    PACML10                                                          
         MVC   0(18,R3),=C'DESTROY DATE/TIME='                                  
                                                                                
         GOTO1 DATCON,DMCB,(3,CMLDDT),(5,23(R3))                                
         XC    WORK,WORK                                                        
         MVC   WORK(2),CMLDTM                                                   
         GOTO1 UNTIME,DMCB,WORK,36(R3)                                          
         BRAS  RE,GOSPL                                                         
         B     PACML12                                                          
*                                                                               
PACML10  DS    0H                                                               
         OC    CMLTYP,CMLTYP       DID WE PRT CML TYPE                          
         BZ    PACML12                                                          
         BRAS  RE,GOSPL            YES GET NEXT PRINT LINE                      
*                                                                               
PACML12  CLI   CMLTXT,C'Y'         ANY TEXT FOR THIS CML                        
         BNE   PACML50             NO, GET NEXT CML IF ANY                      
*                                                                               
         LA    R5,KEY                                                           
         USING CMXKEY,R5                                                        
         XC    KEY,KEY                                                          
         MVC   CMXKID,=X'0A35'                                                  
         MVC   CMXKAM(3),BAGYMD    MEDIA/CLIENT                                 
         MVC   CMXKPROD,CMLPRD     PROD                                         
         MVC   CMXKNET,NETWORK     NETWORK                                      
         MVC   CMXKCML,CMLCML8     8 CHAR ISCII                                 
         MVC   KEYSAVE,KEY                                                      
         BAS   R3,RDHI                                                          
         BE    PACML20                                                          
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    CMXKNET,CMXKNET     CLEAR NETWORK                                
         MVC   KEYSAVE,KEY         MED/CLT/PROD/CML                             
         BAS   R3,RDHI                                                          
         BE    PACML20                                                          
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    CMXKPROD,CMXKPROD   CLEAR PROD                                   
         MVC   CMXKNET,NETWORK     PUT BACK NETWORK                             
         MVC   KEYSAVE,KEY         MED/CLT/NETWORK/CML                          
         BAS   R3,RDHI                                                          
         BE    PACML20                                                          
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    CMXKPROD,CMXKPROD   CLEAR PROD                                   
         XC    CMXKNET,CMXKNET     AND NETWORK                                  
         MVC   KEYSAVE,KEY         MED/CLT/CML                                  
         BAS   R3,RDHI                                                          
         BNE   PACML50                                                          
*                                                                               
PACML20  GOTO1 DATAMGR,DMCB,=C'GETREC',=C'XSPFILE ',KEY+36,AIO1,DMWORK          
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO1                                                          
         LA    R6,42(R6)                                                        
PACML23  CLI   0(R6),X'40'                                                      
         BE    PACML30                                                          
         BH    PACML50                                                          
PACML25  LLC   R1,1(R6)                                                         
         LTR   R1,R1                                                            
         BZ    PACML50                                                          
         AR    R6,R1                                                            
         B     PACML23                                                          
PACML30  LLC   R1,1(R6)            GET LENGTH OF TEXT                           
         SHI   R1,4                ID/LEN/LINE#/MVC                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   PACMTXT(0),3(R6)    PRINT TEXT                                   
         BRAS  RE,GOSPL                                                         
         B     PACML25             MORE TEXT LINES ?                            
*                                                                               
PACML50  LA    R4,CMLNXT(R4)                                                    
         OC    CMLCML,CMLCML                                                    
         BZ    PACMLX                                                           
         BCT   R1,PACML05                                                       
*                                                                               
PACMLX   XIT1                                                                   
*                                                                               
RDHI     GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'XSPDIR  ',KEY,KEY,0                   
         CLC   KEY(32),KEYSAVE                                                  
         BR    R3                                                               
         DROP  R4                                                               
*                                                                               
*----------------------------------------------                                 
* GENERATE OFFLINE REQUEST FOR HARD COPY                                        
* PUT OUT PROGRAM BY PROGRAM ONLY ONLINE                                        
*----------------------------------------------                                 
*                                                                               
REQ      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   CONWHEN(2),=C'OV'                                                
         MVC   CONWHEN+2(L'CONWHEN-3),CONWHEN+3                                 
         MVI   CONWHEN+L'CONWHEN-1,C' '                                         
*                                                                               
         LLC   R2,TRAOPTH+5                                                     
         LA    R3,TRAOPT(R2)                                                    
         LR    R6,R3                                                            
         SR    R4,R4                                                            
*                                                                               
         LTR   R2,R2                                                            
         BZ    REQ10                                                            
         MVI   0(R6),C','                                                       
         LA    R6,1(,R6)                                                        
         LA    R4,1                                                             
*                                                                               
REQ10    MVI   0(R6),C'#'                                                       
         LA    R4,1(,R4)                                                        
         LA    RF,0(R2,R4)                                                      
         STC   RF,TRAOPTH+5                                                     
         MVI   TRAFAX,C'Y'                                                      
*                                                                               
         MVI   GCMODE,C'S'                                                      
         GOTO1 BLDREQST                                                         
         MVI   GCMODE,0                                                         
*                                                                               
         MVC   WORK(L'CONWHEN-3),CONWHEN+2                                      
         MVC   CONWHEN+3(L'CONWHEN-3),WORK                                      
         MVC   CONWHEN(3),=C'NOW'                                               
         XC    CONHEAD,CONHEAD                                                  
*                                                                               
         EX    R4,REQCLR                                                        
         STC   R2,TRAOPTH+5                                                     
         MVI   TRAFAX,C'2'                                                      
         XIT1                                                                   
*                                                                               
REQCLR   MVC   0(0,R3),SPACES                                                   
         DROP  RB                                                               
         EJECT                                                                  
*----------------------------------------------------------                     
* FIND IF THIS PROD DISTRIBUTION LIST EQUAL TO ANY PREV *                       
*----------------------------------------------------------                     
*                                                                               
FEQ      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,GETEL                                                         
         LLC   R4,1(R6)                                                         
*                                                                               
FEQ10    BRAS  RE,NEXTEL                                                        
         BNE   FEQ20                                                            
         LLC   R0,1(R6)                                                         
         AR    R4,R0                                                            
         B     FEQ10                                                            
*                                                                               
FEQ20    STC   R4,4(R5)            SAVE TOTAL DIST LIST LEN                     
         L     R6,AIO3            SVPRDLST                                      
*                                                                               
FEQ30    CR    R5,R6               END OF LIST                                  
         BE    FEQNE                                                            
         OC    0(SVPRDENT,R6),0(R6) ANY ENTRY                                   
         BZ    FEQ36                                                            
         CLM   R4,1,4(R6)          WAS THIS THE SAME LEN                        
         BNE   FEQ36               NOT SAME LIST THEN                           
         L     R1,AIO1                                                          
         LA    R1,1000(,R1)                                                     
         ST    R1,AIO                                                           
         MVC   KEY+14(4),0(R6)                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVC   AIO,AIO1                                                         
         LA    R0,24(,R1)                                                       
         LR    R1,R4                                                            
         LR    RF,R1                                                            
         L     RE,AIO1                                                          
         LA    RE,24(,RE)                                                       
         CLCL  R0,RE                                                            
         BE    FEQEQ                                                            
FEQ36    LA    R6,SVPRDENT(,R6)                                                 
         B     FEQ30                                                            
FEQEQ    CR    RB,RB                                                            
         B     FEQX                                                             
FEQNE    LTR   RB,RB                                                            
FEQX     XIT1                                                                   
         DROP  RB                                                               
         EJECT                                                                  
*-----------------------------                                                  
* INITIALIZE NETIO                                                              
*-----------------------------                                                  
*                                                                               
NETI     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING NETBLCKD,R3                                                      
*                                                                               
         XC    0(256,R3),0(R3)     CLEAR NETBLOCK                               
         XC    256(256,R3),256(R3)                                              
         XC    512(256,R3),512(R3)                                              
         XC    768(256,R3),768(R3)                                              
*                                                                               
         MVC   NBSELAGY,AGENCY                                                  
         MVC   NBEFFAGY,AGENCY                                                  
         MVC   NBSELMED,QMED                                                    
         MVC   NBSELAM,BAGYMD                                                   
         MVC   NBSELCLI,QCLT                                                    
         MVC   NBSELCL2,BCLT                                                    
         MVC   NBSELPRD,=C'ALL'                                                 
         GOTO1 DATCON,DMCB,(2,BASESTR),NBSELSTR                                 
         GOTO1 (RF),(R1),(2,BASEEND),NBSELEND                                   
         MVC   NBSELNET,NETWORK                                                 
         MVC   NBSELPRG,BASEPRG                                                 
         MVI   NBSELUOP,C'B'      GET MISSED (EST AND ACTUAL)                   
         MVI   NBDATA,C'U'                                                      
         MVI   NBSEQ,C'D'                                                       
         MVI   NBMODE,NBPROCUN                                                  
         MVC   NBAIO,AIO1                                                       
         MVI   NBSELTRF,C'B'       READ BOTH NETWORK AND TRAFFIC UNITS          
         OI    NBDMGOPT,X'08'     AND DELETED                                   
         L     R1,SYSPARMS                                                      
         L     RF,16(,R1)           COMFACS ADDRESS                             
         ST    RF,NBACOM                                                        
         GOTO1 CALLOV,DMCB,0,(C'R',X'00000A27')                                 
         L     RF,0(,R1)                                                        
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    RF,ANETIO                                                        
         XIT1                                                                   
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
*---------------------------------------------------                            
* CHECK ESTIMATES, BYPASS THOSE WITH COPY CODE N                                
* ESTIMATE TABLE ENTRY = 5 BYTES,                                               
*                        1 EST, 3 BPRD, 1 COPY CD                               
*---------------------------------------------------                            
*                                                                               
CKEST    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LHI   R0,600              ROOM FOR 600 ENTRIES IN 3000 BYTES           
         L     R1,AIO2                                                          
         LA    R1,1000(,R1)                                                     
CKEST10  CLI   0(R1),0             EMPTY ENTRY                                  
         BE    CKEST30                                                          
         CLC   NBACTEST,0(R1)      SAME EST                                     
         BNE   CKEST14                                                          
         CLC   NBPR1CL3,1(R1)      SAME PRODUCT                                 
         BE    CKEST20                                                          
*                                                                               
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BZ    CKEST14                                                          
         CLC   SVCSPRD,1(R1)                                                    
         BE    CKEST20                                                          
*                                                                               
CKEST14  LA    R1,5(,R1)                                                        
         BCT   R0,CKEST10                                                       
         DC    H'0'                                                             
CKEST20  CLI   4(R1),C'N'          BYPASS EST                                   
         XIT1                                                                   
*                                                                               
CKEST30  XC    KEY,KEY                                                          
         MVC   KEY+1(3),BAGYMD                                                  
         LA    RF,QPRD                                                          
         MVC   QPRD,NBPR1CL3                                                    
         CLI   QPRD,0                                                           
**       BNE   CKEST32                                                          
         BNE   CKEST38                                                          
*                                                                               
         CLI   SVCSPRD,0                                                        
         BE    CKEST36                                                          
         MVC   QPRD,SVCSPRD                                                     
*                                                                               
*&&DO                                                                           
CKEST32  LA    RE,NCLSTSIZ                                                      
         L     RF,ASVNCLST                                                      
CKEST34  CLC   BYTE,3(RF)                                                       
         BE    CKEST38                                                          
         LA    RF,4(,RF)                                                        
         CLI   0(RF),C' '                                                       
         BNH   *+8                                                              
         BCT   RE,CKEST34                                                       
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BO    *+6                                                              
         DC    H'0'                                                             
         CR    RB,RB               SET CC TO BYPASS                             
         XIT1                                                                   
*&&                                                                             
*                                                                               
CKEST36  LA    RF,=C'POL'                                                       
*                                                                               
CKEST38  MVC   KEY+4(3),0(RF)                                                   
         MVC   KEY+7(1),NBACTEST                                                
         MVI   RDUPDATE,C'N'                                                    
                                                                                
         BRAS  RE,INITSPT                                                       
                                                                                
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    CKEST40                                                          
         CLI   NBPR1CL3,0                                                       
         BNE   *+12                                                             
         CLI   SVCSPRD,0                                                        
         BE    CKEST50                                                          
         DC    H'0'                                                             
CKEST40  L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         USING ESTHDRD,R6                                                       
         MVC   0(1,R1),NBACTEST                                                 
         MVC   1(3,R1),QPRD                                                     
         MVC   4(1,R1),ECOPY                                                    
         B     CKEST20                                                          
*                                                                               
CKEST50  MVC   0(1,R1),NBACTEST    IF NO POL EST, SHOW                          
         XC    1(3,R1),1(R1)                                                    
         MVI   4(R1),0                                                          
         B     CKEST20                                                          
         DROP  RB                                                               
         EJECT                                                                  
*--------------------------------                                               
* GET REVISION INFO                                                             
*--------------------------------                                               
*                                                                               
FREV     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PRGTABLD,R5                                                      
*                                                                               
         MVI   OREVNN,0            INIT PROG REV NUM FOR OTHER RECS             
         MVI   OREVNUM,0                AND OTHER NET REV NUM                   
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING REVXKEY,R4                                                       
KS       USING REVXKEY,KEYSAVE                                                  
*                                                                               
         MVC   REVXKID,=X'0A1D'                                                 
         MVC   REVXKAM(3),BAGYMD AND BCLT                                       
         MVC   REVXKNET,NETWORK                                                 
         MVC   REVXKPRG,PRGPRG                                                  
         MVC   REVXKPER,PERIOD                                                  
         CLI   MYTN2PR6,C'W'       USING WEEKLY PERIOD                          
         BNE   *+10                                                             
         MVC   REVXKPER,WKDATEP                                                 
*                                                                               
         CLC   OPTPROD,SPACES      RUNNING BY PRODUCT                           
         BNH   *+14                                                             
         MVC   REVXKPRD,OPTPROD                                                 
         B     FREV01                                                           
*                                                                               
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    FREV01                                                           
         MVC   REVXKPGR,OPTPRGR                                                 
*                                                                               
FREV01   GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
*                                                                               
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    FREV10                                                           
*                                                                               
FREV02   CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE   REC MATCH THRU PERIOD?           
         BNE   FREV30                                                           
*                                                                               
         OC    OPTPROD,OPTPROD     RUNNING BY PRODUCT                           
         BZ    FREV02C                                                          
         CLC   REVXKPRD,OPTPROD                                                 
         BNE   FREV04                                                           
         BE    FREV10                                                           
*                                                                               
FREV02C  OC    OPTPRGR,OPTPRGR     BY PRODUCT GROUP                             
         BZ    FREV02F                                                          
         CLC   REVXKPGR,OPTPRGR                                                 
         BNE   FREV04                                                           
         BE    FREV10                                                           
*                                                                               
FREV02F  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PG               
         BZ    FREV10                                                           
*                                                                               
FREV04   MVC   MYKEYSV,KEY                                                      
         GOTO1 AIOCALL,DMCB,SEQQ+DIRQ+XSPQ,0                                    
         MVC   KEYSAVE,MYKEYSV                                                  
         B     FREV02                                                           
*                                                                               
* TEST REVISED/ORIGINAL HERE *                                                  
*                                                                               
FREV10   L     R6,AIO3                                                          
         GOTO1 AIOCALL,DMCB,GETQ+FILQ+XSPQ,AIO3                                 
         CLC   REVXKEY,0(R6)                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   PRGCREVN,REVXKNUM                                                
         LA    R6,42(R6)                                                        
         CLI   0(R6),X'10'         REVREVEL                                     
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREV,R6                                                        
*                                                                               
         GOTO1 DATCON,DMCB,(3,REVADATE),(2,PRGCREVD)                            
         NI    PRGFLG,X'FF'-X'20' SET OFF INSTR RUN THIS REV                    
*                                                                               
         MVC   PRGIDTE,REVIDATE                                                 
*                                                                               
         TM    REVFLAG,X'80'      INSTR RUN FOR THIS REV                        
         BZ    *+8                                                              
         OI    PRGFLG,X'20'       SET ON INSTR RUN THIS REV                     
*                                                                               
         CLI   REVDTALN,12         OLD REVISION RECORD                          
         BE    FREV20               YES                                         
*                                                                               
         MVC   PRGNREVN,REVNNUM    NETWORK REVISION NUMBER                      
*                                                                               
FREV20   DS    0H                                                               
         MVC   MYKEYSV,KEY                                                      
         GOTO1 AIOCALL,DMCB,SEQQ+DIRQ+XSPQ,0                                    
         MVC   KEYSAVE,MYKEYSV                                                  
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREVX                                                            
*                                                                               
         CLI   SVTN2PRO+00,C'*'    TRAFFIC BY PRODUCT                           
         BNE   FREV25                                                           
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    FREV25                                                           
         CLC   REVXKPRD,OPTPROD                                                 
         BNE   FREV20                                                           
*                                                                               
FREV25   DS   0H                                                                
         OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    FREV10                                                           
         CLC   REVXKPGR(2),OPTPRGR                                              
         BNE   FREV20                                                           
         BE    FREV10                                                           
*                                                                               
         SPACE 3                                                                
* NO REV REC FOUND, CK IF OTHER FORMAT EXISTS *                                 
* IF OPTION WEEKLY, CK FOR MONTHLY REC        *                                 
*    OPTION MONTHLY, CK FOR WEEKLY REC        *                                 
*                                                                               
FREV30   MVC   KEY,KEYSAVE                                                      
         MVI   REVXKNUM,0          SET REVISION TO ZERO                         
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    *+10                                                             
         MVC   REVXKPRD,OPTPROD                                                 
*                                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    *+10                                                             
         MVC   REVXKPGR(2),OPTPRGR                                              
*                                                                               
         CLI   MYTN2PR6,C'W'                                                    
         BE    FREV40                                                           
*                                                                               
         MVC   WORK(6),STDATE                                                   
         GOTO1 GETDAY,DMCB,(0,STDATE),WORK+6                                    
         CLC   WORK+6(3),SPACES                                                 
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R1),1             MUST BE MONDAY                               
         BE    FREV34                                                           
         LLC   R6,DMCB                                                          
         BCTR  R6,0                                                             
         LNR   R6,R6                                                            
         GOTO1 ADDAY,(R1),STDATE,WORK,(R6)                                      
*                                                                               
FREV34   GOTO1 DATCON,(R1),(0,WORK),(2,WORK+6)                                  
         MVC   REVXKPER,WORK+6                                                  
         XC    SVLGKEY,SVLGKEY     SAVE LAST GOOD KEY                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
*                                                                               
FREV34B  CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV38               LOOK UP NEXT WEEK                           
*                                                                               
         OC    OPTPROD,OPTPROD     RUNNING BY PRODUCT                           
         BZ    FREV34C                                                          
         CLC   REVXKPRD,OPTPROD                                                 
         BNE   FREV34G                                                          
         BE    FREV35                                                           
*                                                                               
FREV34C  OC    OPTPRGR,OPTPRGR     BY PRODUCT GROUP                             
         BZ    FREV34F                                                          
         CLC   REVXKPGR,OPTPRGR                                                 
         BNE   FREV34G                                                          
         BE    FREV35                                                           
*                                                                               
FREV34F  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PG               
         BZ    FREV35                                                           
*                                                                               
FREV34G  MVC   MYKEYSV,KEY                                                      
         GOTO1 AIOCALL,DMCB,SEQQ+DIRQ+XSPQ,0                                    
         MVC   KEYSAVE,MYKEYSV                                                  
         B     FREV34B                                                          
*------------------------------------------------                               
* READ ALL REVISION RECORDS FOR THIS PERIOD                                     
* AND GET HIGHEST REVISION NUMBER USED                                          
*------------------------------------------------                               
FREV35   CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BNL   *+10                                                             
         MVC   OREVNUM,REVXKNUM    SAVE THIS REV#                               
*                                                                               
         MVC   SVLGKEY,KEY            SAVE LAST GOOD KEY                        
*                                                                               
FREV35F  MVC   MYKEYSV,KEY                                                      
         GOTO1 AIOCALL,DMCB,SEQQ+DIRQ+XSPQ,0                                    
         MVC   KEYSAVE,MYKEYSV                                                  
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV37               LOOK UP NEXT WEEK                           
*                                                                               
FREV36   CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    FREV36B                                                          
         CLC   REVXKPRD,OPTPROD                                                 
         BE    FREV35                                                           
         BNE   FREV35F             GET NEXT RECORD                              
FREV36B  OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    FREV36C                                                          
         CLC   REVXKPGR(2),OPTPRGR                                              
         BNE   FREV35F             GET NEXT RECORD                              
         BE    FREV35                                                           
FREV36C  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PGR              
         BZ    FREV35                                                           
         B     FREV35F             GET NEXT RECORD                              
*-----------------------------                                                  
* RE-READ LAST GOOD RECORD                                                      
*-----------------------------                                                  
FREV37   OC    SVLGKEY,SVLGKEY     ANY GOOD RECORDS                             
         BZ    FREV38                                                           
         MVC   KEY,SVLGKEY                                                      
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                 MUST BE THERE                               
*                                                                               
         CLC   OREVNUM,REVXKNUM    IS OTHER REV# HIGHER                         
         BH    FREV38               YES, DONE                                   
         BE    *+6                                                              
         DC    H'0'                OTHER REV# IS LOWER ?  BUG???                
*                                                                               
         L     R6,AIO3                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
*        GOTO1 GETREC                                                           
         GOTO1 AIOCALL,DMCB,GETQ+FILQ+XSPQ,AIO3                                 
         MVI   ELCODE,X'10'                                                     
                                                                                
         BRAS  RE,INITXSP                                                       
                                                                                
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
*                                                                               
         CLI   REVDTALN,12         OLD REV REC                                  
         BE    *+20                                                             
         CLC   OREVNN,REVNNUM                                                   
         BNL   *+10                                                             
         MVC   OREVNN,REVNNUM      SAVE NET REV NUM FOR OTHER PERIOD            
*                                                                               
         TM    REVFLAG,X'80'       HAVE INSTRUCTIONS BEEN RUN                   
         BZ    FREV38              NO,LOOK UP NEXT WEEK                         
*                                                                               
         LLC   RF,OREVNUM          YES, UP REVISION NUMBER                      
         LA    RF,1(,RF)                                                        
         STC   RF,OREVNUM                                                       
*                                                                               
* LOOK UP NEXT WEEK IF NOT DONE WITH THIS MONTH                                 
*                                                                               
FREV38   MVC   KEY,KEYSAVE                                                      
         MVI   REVXKNUM,0          SET REVISION TO ZERO                         
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    *+10                                                             
         MVC   REVXKPRD,OPTPROD                                                 
*                                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    *+10                                                             
         MVC   REVXKPGR(2),OPTPRGR                                              
*                                                                               
         GOTO1 ADDAY,(R1),WORK,WORK,F'7' GET MONDAY OF NEXT WEEK                
*                                                                               
         CLC   STDATE+2(2),WORK+2  SAME MONTH?                                  
         BE    FREV34               YES                                         
*                                                                               
         CLI   MYTN2PR6,C'B'                                                    
         BNE   FREVX                                                            
*                                                                               
                                                                                
         CLC   ENDATE+2(2),=C'12'   FIX END OF YEAR ISSUE                       
         BNE   *+14                                                             
         CLC   WORK+2(2),=C'01'                                                 
         BE    FREVX                                                            
                                                                                
*                                                                               
         CLC   ENDATE+2(2),WORK+2  SAME MONTH?                                  
         BNL   FREV34               YES                                         
         B     FREVX                                                            
*                                                                               
* CK FOR MONTHLY REV REC *                                                      
*                                                                               
FREV40   DS    0H                                                               
         GOTO1 DATCON,DMCB,(0,STDATE),(3,WORK)                                  
         MVC   REVXKPER,WORK                                                    
         XC    SVLGKEY,SVLGKEY     INIT LAST GOOD KEY                           
         MVI   RDUPDATE,C'N'                                                    
*        GOTO1 HIGH                                                             
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
*                                                                               
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    FREV42                                                           
*                                                                               
FREV40B  CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV50                                                           
*                                                                               
         OC    OPTPROD,OPTPROD     RUNNING BY PRODUCT                           
         BZ    FREV40C                                                          
         CLC   REVXKPRD,OPTPROD                                                 
         BNE   FREV40G                                                          
         BE    FREV42                                                           
*                                                                               
FREV40C  OC    OPTPRGR,OPTPRGR     BY PRODUCT GROUP                             
         BZ    FREV40F                                                          
         CLC   REVXKPGR,OPTPRGR                                                 
         BNE   FREV40G                                                          
         BE    FREV42                                                           
*                                                                               
FREV40F  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PG               
         BZ    FREV42                                                           
*                                                                               
FREV40G  MVC   MYKEYSV,KEY                                                      
         GOTO1 AIOCALL,DMCB,SEQQ+DIRQ+XSPQ,0                                    
         MVC   KEYSAVE,MYKEYSV                                                  
         B     FREV40B                                                          
*------------------------------------------------                               
* READ ALL REVISION RECORDS FOR THIS PERIOD                                     
* AND GET HIGHEST REVISION NUMBER USED                                          
*------------------------------------------------                               
FREV42   CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BNL   *+10                                                             
         MVC   OREVNUM,REVXKNUM    SAVE THIS REV#                               
*                                                                               
         MVC   MYKEYSV,KEY                                                      
         GOTO1 AIOCALL,DMCB,SEQQ+DIRQ+XSPQ,0                                    
         MVC   KEYSAVE,MYKEYSV                                                  
*                                                                               
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV45               LOOK UP NEXT WEEK                           
*                                                                               
         CLC   REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&GRP              
         BE    FREV42                                                           
*--------------------------                                                     
* RE-READ LAST GOOD RECORD                                                      
*--------------------------                                                     
FREV45   OC    SVLGKEY,SVLGKEY     ANY GOOD RECORD                              
         BZ    FREV50                                                           
         MVC   KEY,SVLGKEY                                                      
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                 MUST BE THERE                               
*                                                                               
         L     R6,AIO3                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
*        GOTO1 GETREC                                                           
         GOTO1 AIOCALL,DMCB,GETQ+FILQ+XSPQ,AIO3                                 
         MVI   ELCODE,X'10'                                                     
                                                                                
         BRAS  RE,INITXSP                                                       
                                                                                
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
*                                                                               
         CLI   REVDTALN,12         OLD REV REC                                  
         BE    *+20                                                             
         CLC   OREVNN,REVNNUM                                                   
         BNL   *+10                                                             
         MVC   OREVNN,REVNNUM      SAVE NET REV NUM FOR OTHER PERIOD            
*                                                                               
*                                                                               
         TM    REVFLAG,X'80'       HAVE INSTRUCTIONS BEEN RUN                   
         BZ    FREV50                                                           
*                                                                               
         LLC   RF,OREVNUM          YES, UP REVISION NUMBER                      
         LA    RF,1(,RF)                                                        
         STC   RF,OREVNUM                                                       
*                                                                               
FREV50   DS    0H                                                               
         MVC   KEY,KEYSAVE                                                      
         MVI   REVXKNUM,0          SET REVISION TO ZERO                         
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    *+10                                                             
         MVC   REVXKPRD,OPTPROD                                                 
*                                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    *+10                                                             
         MVC   REVXKPGR(2),OPTPRGR                                              
*                                                                               
         MVC   WORK(6),STDATE                                                   
         GOTO1 VGTBROAD,DMCB,(1,WORK),WORK+6,GETDAY,ADDAY                       
         CLC   WORK+8(2),WORK+14   START AND END MONTH SAME                     
         BE    FREV55                                                           
*                                                                               
* ONLY INCREMENT MONTH IF DAY IS OVER 21 *                                      
*                                                                               
         CLC   =C'20',WORK+2                                                    
         BL    FREV55                                                           
         GOTO1 ADDAY,(R1),WORK+6,WORK+6,F'15'                                   
FREV55   GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK)                                  
*                                                                               
         CLC   REVXKPER,WORK                                                    
         BE    FREVX               DONE THIS PERIOD BEFORE                      
*                                                                               
         MVC   REVXKPER,WORK                                                    
*                                                                               
FREV60   MVI   RDUPDATE,C'N'                                                    
         BRAS  RE,INITXSP          SET TO XSPOT                                 
         XC    SVLGKEY,SVLGKEY                                                  
*        GOTO1 HIGH                                                             
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    FREV62                                                           
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREVX                                                            
*                                                                               
FREV60B  OC    OPTPROD,OPTPROD     RUNNING BY PRODUCT                           
         BZ    FREV60C                                                          
         CLC   REVXKPRD,OPTPROD                                                 
         BNE   FREV60G                                                          
         BE    FREV62                                                           
*                                                                               
FREV60C  OC    OPTPRGR,OPTPRGR     BY PRODUCT GROUP                             
         BZ    FREV60F                                                          
         CLC   REVXKPGR,OPTPRGR                                                 
         BNE   FREV60G                                                          
         BE    FREV62                                                           
*                                                                               
FREV60F  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PG               
         BZ    FREV62                                                           
*                                                                               
FREV60G  MVC   MYKEYSV,KEY                                                      
         GOTO1 AIOCALL,DMCB,SEQQ+DIRQ+XSPQ,0                                    
         MVC   KEYSAVE,MYKEYSV                                                  
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV65                                                           
         B     FREV60B                                                          
*                                                                               
FREV62   CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BNL   *+10                                                             
         MVC   OREVNUM,REVXKNUM    SAVE THIS REV#                               
*                                                                               
         MVC   SVLGKEY,KEY            SAVE LAST GOOD KEY                        
         MVC   MYKEYSV,KEY                                                      
         GOTO1 AIOCALL,DMCB,SEQQ+DIRQ+XSPQ,0                                    
         MVC   KEYSAVE,MYKEYSV                                                  
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BE    FREV60B                                                          
*------------------------------                                                 
* RE-READ LAST GOOD RECORD                                                      
*------------------------------                                                 
*                                                                               
FREV65   OC    SVLGKEY,SVLGKEY     WERE THERE ANY GOOD RECORDS                  
         BZ    FREVX                NO, DONE                                    
         MVC   KEY,SVLGKEY                                                      
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ,0                                   
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                 MUST BE THERE                               
*                                                                               
         CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BH    FREVX                                                            
         BE    *+6                                                              
         DC    H'0'                OTHER REV IS LOWER ? BUG??                   
*                                                                               
         L     R6,AIO3                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
*        GOTO1 GETREC                                                           
         GOTO1 AIOCALL,DMCB,GETQ+FILQ+XSPQ,AIO3                                 
         MVI   ELCODE,X'10'                                                     
                                                                                
         BRAS  RE,INITXSP                                                       
                                                                                
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
*                                                                               
         TM    REVFLAG,X'80'       HAVE INSTRUCTIONS BEEN RUN                   
         BZ    FREVX                                                            
*                                                                               
         LLC   RF,OREVNUM          YES, UP REVISION NUMBER                      
         LA    RF,1(,RF)                                                        
         STC   RF,OREVNUM                                                       
*                                                                               
FREVX    CLC   OREVNUM,PRGCREVN    COMPARE OTHER  REVISION #                    
         BNH   *+10                TO THIS REVISION                             
         MVC   PRGCREVN,OREVNUM    USE THE HIGHER NUMBER OF THE TWO             
*                                                                               
         CLC   OREVNN,PRGNREVN     AND NETWORK REVISION #                       
         BNH   *+10                                                             
         MVC   PRGNREVN,OREVNN                                                  
*                                                                               
         CLI   NBMODE,NBREQLST     IF NO UNITS, GET OUT                         
         BE    FREVX10                                                          
*                                                                               
         MVC   KEYSAVE,NBKEY                                                    
         GOTO1 DATAMGR,DMCB,(X'08',=C'DMRDHI'),=C'UNTDIR',KEYSAVE,KEY           
         CLC   KEY(20),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
FREVX10  XIT1                                                                   
*                                                                               
PRGRPERR DS    0H                  ERROR, NO SWITCHING TO PRODUCT               
         XC    ELEM,ELEM                                                        
         MVI   ELEM,10             L'SUBST TEXT + 1                             
         MVI   ELEM+10,8           2ND L'SUBST TEXT + 1                         
         MVC   ELEM+1(9),=C'BY PGROUP'                                          
         MVC   ELEM+11(7),=C'BY PROD'                                           
         B     PRDGRPER                                                         
*                                                                               
PGRALLER DS    0H                  ERROR, NO SWITCHING TO ALL                   
         XC    ELEM,ELEM                                                        
         MVI   ELEM,10             L'SUBST TEXT + 1                             
         MVI   ELEM+10,8           2ND L'SUBST TEXT + 1                         
         MVC   ELEM+1(9),=C'BY PGROUP'                                          
         MVC   ELEM+11(7),=C'FOR ALL'                                           
         B     PRDGRPER                                                         
*                                                                               
PRDALLER DS    0H                  ERROR, NO SWITCHING TO ALL                   
         XC    ELEM,ELEM                                                        
         MVI   ELEM,8              L'SUBST TEXT + 1                             
         MVI   ELEM+8,8            2ND L'SUBST TEXT + 1                         
         MVC   ELEM+1(7),=C'BY PROD'                                            
         MVC   ELEM+9(7),=C'FOR ALL'                                            
         B     PRDGRPER                                                         
*                                                                               
PRODERR  DS    0H                                                               
         XC    ELEM,ELEM                                                        
         MVI   ELEM,8              L'SUBST TEXT + 1                             
         MVI   ELEM+8,10           2ND L'SUBST TEXT + 1                         
         MVC   ELEM+1(7),=C'BY PROD'                                            
         MVC   ELEM+9(9),=C'BY PGROUP'                                          
         B     PRDGRPER                                                         
*                                                                               
PRDPRGER DS    0H                                                               
         XC    ELEM,ELEM                                                        
         MVI   ELEM,8              L'SUBST TEXT + 1                             
         MVI   ELEM+8,18           2ND L'SUBST TEXT + 1                         
         MVC   ELEM+1(7),=C'FOR ALL'                                            
         MVC   ELEM+9(17),=C'BY PROD OR PGROUP'                                 
*                                                                               
PRDGRPER LA    R2,TRAOPTH                                                       
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVC   GERROR,=Y(PRDGRPSW)                                              
*                                                                               
FREVERR  OC    AERRFILE,AERRFILE         STORED DCB ADDRESS                     
         BZ    FREVERX                                                          
*                                                                               
         L     R3,AERRFILE         STORED DCB ADDRESS                           
         CLOSE ((R3),)                                                          
         FREEPOOL (R3)                                                          
*                                                                               
         XC    AERRFILE,AERRFILE   SET FILE NOT OPEN                            
*                                                                               
FREVERX  GOTO1 VTRAERR                                                          
*                                                                               
         DROP  KS                                                               
         DROP  R4,R6,RB                                                         
         EJECT                                                                  
*----------------------------------                                             
* UPDATE REVISION RECORD                                                        
*----------------------------------                                             
         DS    0H                                                               
UPDR     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R5,APRGTBLE                                                      
         USING PRGTABLD,R5                                                      
*                                                                               
UPDR10   TM    PRGFLG,X'10'        WERE INSTR RUN FOR THIS PROGRAM              
         BZ    UPDR20                                                           
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING REVXKEY,R4                                                       
         MVC   REVXKID,=X'0A1D'                                                 
         MVC   REVXKAM(3),BAGYMD AND BCLT                                       
         MVC   REVXKNET,NETWORK                                                 
         MVC   REVXKPRG,PRGPRG                                                  
         MVC   REVXKPER,PERIOD                                                  
*                                                                               
         CLI   MYTN2PR6,C'W'       USING WEEKLY PERIOD                          
         BNE   *+10                                                             
         MVC   REVXKPER,WKDATEP                                                 
*                                                                               
         MVC   REVXKNUM,PRGCREVN                                                
*                                                                               
         CLC   OPTPROD,SPACES      RUNNING BY PRODUCT                           
         BNH   *+14                                                             
         MVC   REVXKPRD,OPTPROD                                                 
         B     UPDR12                                                           
*                                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PGROUP                            
         BZ    *+10                 NO                                          
         MVC   REVXKPGR,OPTPRGR                                                 
*                                                                               
*                                                                               
UPDR12   GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ+UPDATEQ,0                           
**       GOTO1 DATAMGR,DMCB,(X'80',=C'DMRDHI'),=C'UNTDIR',KEYSAVE,KEY           
         CLC   REVXKEY,KEYSAVE                                                  
         BE    UPDR14                                                           
*                                                                               
* LOOK FOR NETWORK REVISION RECORD CREATED BY PATTERN GEN                       
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    REVXKPRG,REVXKPRG   CLEAR PROGRAM                                
         GOTO1 AIOCALL,DMCB,HIGHQ+DIRQ+XSPQ+UPDATEQ,0                           
**       GOTO1 DATAMGR,DMCB,(X'80',=C'DMRDHI'),=C'UNTDIR',KEYSAVE,KEY           
         CLC   REVXKEY,KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
UPDR14   GOTO1 AIOCALL,DMCB,GETQ+FILQ+XSPQ+UPDATEQ,AIO                          
**DR14   GOTO1 (RF),(R1),(X'80',=C'GETREC'),=C'UNTFIL',KEY+21,(R6),    C        
               DMWORK                                                           
         CLC   REVXKEY,0(R6)                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R4                                                               
*                                                                               
         LA    R6,42(R6)                                                        
         CLI   0(R6),X'10'                                                      
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREV,R6                                                        
*                                                                               
         GOTO1 DATCON,(R1),(5,0),(3,REVIDATE)                                   
*                                                                               
         OI    REVFLAG,REVINS+REVCAB SET ON CABLE INSTRUCTIONS RUN              
*                                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PGROUP                            
         BZ    *+8                                                              
         OI    REVFLAG,REVPRGRP                                                 
*                                                                               
         CLI   SVTWPR06,C'N'       NO FAX                                       
         BE    *+8                                                              
         OI    REVFLAG,REVFAX                                                   
*                                                                               
         DROP  R6                                                               
*                                                                               
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    UPDR20              NO UPDATE                                    
*                                                                               
* IF TSUPP/NON-TSUPP (OR ALL) RUN THEN UPDATE TSUPP ELEM                        
*                                                                               
         TM    SVOPTSW1,OPTTS+OPTNTS                                            
         BZ    UPDR18                                                           
*                                                                               
         L     R6,AIO                                                           
         LA    R6,42(R6)                                                        
         USING REVTSEL,R6                                                       
         MVI   ELCODE,X'20'        LOOK FOR TSUPP ELEMENT                       
*                                                                               
         BRAS  RE,FIRSTEL                                                       
         BNE   UPDR16              GO ADD ELEMENT                               
*                                                                               
         CLC   REVTSUPP,SVTS       SAME TRAFFIC SUPPLIER?                       
         BNE   *+12                                                             
         BAS   RE,UPDR100          YES TURN ON FLAGS IF NECESSARY               
         B     UPDR18               YES, DONE                                   
         BRAS  RE,NEXTEL                                                        
         BE    *-22                                                             
*                                                                               
* ADD NEW TRAFFIC SUPPLIER ELEMENT                                              
*                                                                               
UPDR16   DS    0H                                                               
         BRAS  RE,INITXSP                                                       
*                                                                               
         LA    R6,ELEM                                                          
         MVI   REVTSEL,X'20'                                                    
         MVI   REVTSLN,(REVTSEQ-REVTSEL)  ELEM LENGTH                           
         GOTO1 DATCON,DMCB,(5,0),(3,REVIDTE)  TODAY'S DATE                      
         MVC   REVTSUPP,SVTS       TRAFFIC SUPPLIER                             
*                                                                               
         BAS   RE,UPDR100          GO TURN ON FLAGS                             
*                                                                               
         GOTO1 ADDELEM                                                          
*                                                                               
UPDR18   DS    0H                                                               
         CLI   OFFLINE,C'Y'        IF ONLINE                                    
         BNE   *+12                 ALWAYS UPDATE                               
         CLI   TWAWRITE,C'Y'                                                    
         BNE   UPDR20                                                           
*                                                                               
**       GOTO1 DATAMGR,(R1),=C'PUTREC',=C'UNTFIL',KEY+21,AIO,DMWORK             
         GOTO1 AIOCALL,DMCB,PUTQ+FILQ,0                                         
*                                                                               
UPDR20   LA    R5,PRGNEXT                                                       
         OC    0(4,R5),0(R5)       EOL                                          
         BNZ   UPDR10               NO                                          
*                                                                               
         BRAS  RE,INITSPT                                                       
         B     UPDRX                                                            
*                                                                               
* TURN ON APPROPRIATE FLAGS (TSUPP/NON TSUPP OR ALL RUN)                        
*                                                                               
UPDR100  TM    SVOPTSW1,OPTTS                                                   
         BZ    *+8                                                              
         OI    REVTSFLG,REVITS     TSUPP INSTRUCTIONS GENERATED                 
*                                                                               
         TM    SVOPTSW1,OPTNTS                                                  
         BZ    *+8                                                              
         OI    REVTSFLG,REVINTS     NON-TSUPP INSTR GENERATED                   
         BR    RE                                                               
*                                                                               
UPDRX    XIT1                                                                   
*                                                                               
         LTORG                                                                  
         DROP  R6,RB                                                            
         EJECT                                                                  
*-------------------------------------                                          
* PRINT COMMENTS, BOXED OR NOT                                                  
*-------------------------------------                                          
*                                                                               
PCMT     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,0(R1)            OUTPUT AREA ADDR                             
         LLC   R7,0(R1)            LENGTH OF OUTPUT AREA                        
         SR    R2,R2               ZERO LINE CT                                 
         L     R6,AIO                                                           
         TM    UPDSW,X'08'         NEED TO GETREC/CK FOR BOX                    
         BZ    PCMT04              NO, DONE                                     
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
PCMT04   MVI   HALF,0                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   HALF,2(R6)          SAVE IND BYTE                                
*                                                                               
PCMT06   L     R6,AIO                                                           
         MVI   ELCODE,X'40'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   =C'NONE ',3(R6)     TEST SUPPRESS COMMENT                        
         BE    PCMT40                                                           
         CLC   =C'ID=',3(R6)                                                    
         BNE   PCMT08                                                           
         BRAS  RE,NEXTEL                                                        
PCMT08   TM    HALF,X'80'          TEST TO BOX COMMENT                          
         BZ    PCMT10              NO                                           
         GOTO1 BOXER,DMCB,((R7),(R4))                                           
         B     PCMT40                                                           
*                                                                               
* FORMAT UNBOXED COMMENT *                                                      
*                                                                               
PCMT10   L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
PCMT12   BAS   RE,CEP              GO CK FOR END OF PAGE                        
         MVC   0(132,R4),SPACES                                                 
         MVI   60(R4),0            FORCE BLANK COMMENTS TO PRINT                
         LLC   RE,1(R6)                                                         
         SH    RE,=H'4'                                                         
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),3(R6) *EXECUTED*                                         
PCMT34   LA    R4,0(R4,R7)                                                      
         LA    R2,1(,R2)                                                        
         BRAS  RE,NEXTEL                                                        
         BE    PCMT12                                                           
         MVI   0(R4),0             SET EOL FLAG                                 
PCMT40   NI    UPDSW,X'FF'-X'08'                                                
         XC    FILENAME,FILENAME                                                
         B     EXIT2                                                            
*                                                                               
         DS   0H                                                                
CEP      NTR1                                                                   
         CH    R7,=H'132'          PRINTING                                     
         BNE   CEP10                                                            
         CH    R2,=H'4'                                                         
         BL    CEP10                                                            
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0          RESET                                        
         SR    R2,R2                                                            
         LR    R1,R7                                                            
         SLL   R1,2                                                             
         SR    R4,R1                                                            
CEP10    XIT1  REGS=(R2,R4)                                                     
         DROP  R3                                                               
         EJECT                                                                  
*********************************************                                   
* SUBROUTINE TO PRINT BOXES AROUND TEXT     *                                   
* AIO MUST HAVE RECORD ADDRESS              *                                   
* ELCODE MUST CONTAIN COMMENT ELEM CODE     *                                   
* P1  (1) = MAXIMUM LEN OF EXPANDED COMMENT *                                   
* P1+1(3) = EXPANDED COMMENT OUTPUT AREA    *                                   
*********************************************                                   
         SPACE 2                                                                
         DS   0H                                                                
BOXER    NTR1                                                                   
*                                                                               
* FIRST - FIND LENGTH OF LONGEST COMMENT *                                      
*                                                                               
         L     R3,0(R1)            GET OUTPUT AREA ADDRESS                      
         LLC   R4,0(R1)            GET OUTPUT RECORD SIZE                       
*                                                                               
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         SR    R5,R5                                                            
*                                                                               
BOX2     LLC   RE,1(R6)                                                         
         CLC   =C'BOX=',3(R6)                                                   
         BNE   *+8                                                              
         SH    RE,=H'4'                                                         
         CR    R5,RE                                                            
         BH    *+6                                                              
         LR    R5,RE                                                            
         BRAS  RE,NEXTEL                                                        
         BE    BOX2                                                             
*                                                                               
* LENGTH IN R5 INCLUDES 3 FOR ELCODE/LEN/SEQ - NOW ADJUST FOR                   
* '*/SP' AND 'SP/*' AT EITHER END                                               
*                                                                               
         LA    R5,1(R5)                                                         
*                                                                               
* CREATE ROW OF *'S THIS LENGTH                                                 
*                                                                               
         EX    R4,BOXSPC                                                        
         MVI   0(R3),C'*'                                                       
         BCTR  R5,0                ADJUST FOR FIRST *                           
         BCTR  R5,0                SET FOR EX                                   
         EX    R5,BOXR7                                                         
         AR    R3,R4               POINT TO NEXT OUTPUT LINE                    
         LA    R5,2(R5)            RESTORE LENGTH                               
*                                                                               
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         EJECT                                                                  
BOX4     EX    R4,BOXSPC                                                        
*                                                                               
         LLC   RE,1(R6)                                                         
         LA    RF,3(R6)                                                         
*                                                                               
         CLC   =C'BOX=',0(RF)                                                   
         BNE   *+12                                                             
         SH    RE,=H'4'                                                         
         LA    RF,4(RF)                                                         
*                                                                               
         MVI   0(R3),C'*'                                                       
         SH    RE,=H'4'            SET FOR EX                                   
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   2(0,R3),0(RF) *EXECUTED*                                         
*                                                                               
         LA    RE,0(R3,R5)         POINT TO END OF LINE                         
         BCTR  RE,0                BACK UP                                      
         MVI   0(RE),C'*'                                                       
         AR    R3,R4               POINT TO NEXT LINE                           
         BRAS  RE,NEXTEL                                                        
         BE    BOX4                                                             
*                                                                               
         EX    R4,BOXSPC                                                        
         MVI   0(R3),C'*'                                                       
         BCTR  R5,0                ADJUST FOR FIRST *                           
         BCTR  R5,0                SET FOR EX                                   
         EX    R5,BOXR7                                                         
         AR    R3,R4                                                            
         MVI   0(R3),0             SET END OF BUFFER FLAG                       
EXIT2    XIT1                                                                   
*                                                                               
BOXR7    MVC   1(0,R3),0(R3)  *EXECUTED*                                        
BOXSPC   MVC   0(0,R3),SPACES *EXECUTED*                                        
         DROP  RB                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*---------------------------                                                    
* HEAD HOOK ROUTINE                                                             
*---------------------------                                                    
*                                                                               
HDHK     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   MID1,SPACES                                                      
*                                                                               
         CLC   USERNAME,SPACES                                                  
         BH    *+10                                                             
         MVC   USERNAME(L'USERNAME+L'USERADDR),SVUSER                           
         MVC   H1+2(L'USERNAME),USERNAME                                        
         MVC   H2+2(L'USERADDR),USERADDR                                        
                                                                                
         CLI   SVTWPR06,C'N'       SEE IF FAXING                                
         BE    HDHK06               NO                                          
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    HDHK06                                                           
         CLI   FRSTPGSW,C'Y'       THIS 1ST PAGE                                
         BE    HDHK06                YES -NO NEED TO SEND /PAGE                 
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   HDHK04                                                           
*                                                                               
         TM    WHEN,X'20'          THIS RUNNING SOON                            
         BO    HDHK04               YES, DO FAX                                 
*                                                                               
         CLI   SVTWPR06,C'2'         SEE IF FAXING, BUT AGENCY COPY RUN         
         BE    HDHK06                                                           
*                                    (SPECIAL FAX LINE FOR NEW PAGE)            
HDHK04   LA    RE,P                                                             
         LA    RF,528                                                           
         LR    R1,RF                                                            
         L     R0,AIO1                                                          
         AH    R0,=H'1472'         PUT IN LAST OF I/O1                          
         MVCL  R0,RE                                                            
         MVC   P1,SPACES                                                        
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
         MVC   P4,SPACES                                                        
         LLC   R2,SPACING            SAVE SPACING                               
         MVI   SPACING,1                                                        
         MVC   P1(5),=C'/PAGE'                                                  
         MVI   FORCEHED,C'N'                                                    
         IC    R6,FORCEMID                                                      
         MVI   FORCEMID,C'N'                                                    
         MVI   MAXLINES,99                                                      
         MVI   LINE,1               I MUST RESET LINE                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
         LA    RE,P                                                             
         LA    RF,528                                                           
         LR    R1,RF                                                            
         L     R0,AIO1                                                          
         AH    R0,=H'1472'         GET FROM LAST OF I/O1                        
         MVCL  RE,R0                                                            
         STC   R2,SPACING             RESTORE SPACING                           
         STC   R6,FORCEMID                                                      
         MVI   MAXLINES,58                                                      
*                                                                               
HDHK06   CLI   OFFLINE,C'Y'                                                     
         BNE   HDHK10                                                           
         LH    RE,SEQNUM          PRINT SEQUENCE NUMBER                         
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  H1+104(4),DUB                                                    
         LA    RE,1(RE)                                                         
         STH   RE,SEQNUM                                                        
*                                                                               
HDHK10   CLI   SVTNPR6,C'Y'       BLANK AGENCY NAME & ADDRESS                   
         BE    HDHK12                                                           
         TM    SVOPTSW,OPTNAGY    BLANK AGENCY NAME & ADDRESS                   
         BZ    HDHK14                                                           
HDHK12   MVC   H1+2(33),SPACES                                                  
         MVC   H2+2(33),SPACES                                                  
*                                                                               
HDHK14   GOTO1 DATCON,DMCB,(2,STDATEP),(5,H3+47)                                
         MVI   H3+55,C'-'                                                       
         GOTO1 (RF),(R1),(2,ENDATEP),(5,H3+56)                                  
*                                                                               
         TM    SVOPTSW1,OPTNTS     NON-TRAFFIC SUPPLIER FILTER?                 
         BZ    *+14                                                             
         MVC   H4+42(18),=C'(OPTION=NON-TSUPP)'                                 
         B     HDHK14K                                                          
*                                                                               
         TM    SVOPTSW1,OPTTS      TRAFFIC SUPPLIER FILTER?                     
         BZ    HDHK14K                                                          
         MVC   H4+44(14),=C'(OPTION=TSUPP)'                                     
         OC    SVOPTTS,SVOPTTS     SPECIFIC TSUPP?                              
         BZ    HDHK14K                                                          
         XC    H4+44(14),H4+44                                                  
         MVC   H4+47(6),=C'TSUPP='                                              
         MVC   H4+53(L'SVOPTTS),SVOPTTS                                         
*                                                                               
HDHK14K  TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BZ    *+10                                                             
         MVC   H3+6(16),=C'*** TEST RUN ***'                                    
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   AGENCY COPY RUN                              
         BO    HDHK14S              YES                                         
*                                                                               
         TM    WHEN,X'20'          IF SOON                                      
         BO    HDHK14X             THEN SKIP AGY COPY (REQUESTED OV)            
         CLI   OFFLINE,C'Y'        IF OFFLINE                                   
         BNE   HDHK14X                                                          
         CLI   SVTWPR06,C'2'       AND AGY COPY REQUEST                         
         BNE   HDHK14X                                                          
HDHK14S  MVC   H4+7(17),=C'** AGENCY COPY **'                                   
*                                                                               
HDHK14X  TM    SVOPTSW,OPTREV      IF REVISONS ONLY                             
         BZ    *+10                                                             
         MVC   H4+84(14),=C'** REVISION **'                                     
*                                                                               
HDHK18   CLC   PAGE,=H'1'                                                       
         BNE   HDHK40                                                           
*                                                                               
* BLANK OUT ANY PREVIOUS STUFF *                                                
*                                                                               
         LA    R0,9                                                             
         LA    R1,H5                                                            
*                                                                               
HDHK20   MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,HDHK20                                                        
*                                                                               
         BAS   RE,CKFIL            GO CK IF DISK HARD COPY NEEDED               
         B     HDHKX               DO NOT PRINT MIDLINES FOR PAGE 1             
*                                                                               
* BLANK HEADLINES AFTER PAGE 1 *                                                
*                                                                               
HDHK40   LA    R0,9                                                             
         LA    R1,H5                                                            
*                                                                               
HDHK42   MVC   3(60,R1),SPACES                                                  
         LA    R1,132(R1)                                                       
         BCT   R0,HDHK42                                                        
*                                                                               
         CLC   PAGE,=H'1'                                                       
         BE    *+10                                                             
         MVC   H4+85(21),=C'***** CONTINUED *****'                              
*                                                                               
         MVC   H6+60(11),=C'DATE ISSUED'                                        
         GOTO1 DATCON,DMCB,(5,0),(5,H6+79)                                      
         MVC   H6+3(6),=C'CLIENT'                                               
         MVC   H6+14(3),QCLT                                                    
         MVC   H6+19(20),CLTNM                                                  
         MVC   H7+3(7),=C'PRODUCT'                                              
*                                                                               
         CLC   OPTPROD,SPACES                                                   
         BNH   HDHK44                                                           
         MVC   H7+14(3),OPTPROD                                                 
         MVC   H7+19(20),SVPRDNAM                                               
         B     HDHK45               NO                                          
*                                                                               
HDHK44   DS    0H                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PGROUP                            
         BZ    HDHK44E              NO                                          
         MVC   H7+14(4),=C'PGR '                                                
         MVC   H7+19(4),QPGR                                                    
         MVC   H7+24(24),SVPRGNAM                                               
         B     HDHK45                                                           
HDHK44E  MVC   H7+14(7),=C'VARIOUS'                                             
*                                                                               
HDHK45   DS    0H                                                               
         MVC   H7+60(16),=C'AGENCY OF RECORD'                                   
         CLI   SVTNPR7,C'Y'       BLANK AGENCY OF RECORD N & A                  
         BE    HDHK48                                                           
         TM    SVOPTSW,OPTNOAOR   BLANK AGENCY OF RECORD N & A                  
         BO    HDHK48                                                           
                                                                                
         CLC   USERNAME,SPACES                                                  
         BH    *+10                                                             
         MVC   USERNAME(L'USERNAME+L'USERADDR),SVUSER                           
                                                                                
         MVC   H7+79(33),USERNAME                                               
HDHK48   DS    0H                                                               
         MVC   H8+3(7),=C'NETWORK'                                              
         MVC   H8+14(L'NETWORK),NETWORK                                         
         MVC   H8+19(30),SVNETADR                                               
         MVC   H8+60(9),=C'ISSUED BY'                                           
         MVC   H8+79(30),SVISNAME                                               
         MVC   H9+79(L'SVEMAIL),SVEMAIL                                         
*                                                                               
         MVC   H10+60(9),=C'TELEPHONE'                                          
         MVC   H10+79(24),SVISTEL                                               
*                                                                               
         OC    SVFAXTL,SVFAXTL     ANY CONTACT FAX NUMBER                       
         BZ    HDHK50               YES                                         
         MVC   H11+60(11),=C'CONTACT FAX'                                       
         MVC   H11+79(24),SVFAXTL                                               
*                                                                               
HDHK50   DS    0H                                                               
         LA    R1,H12                                                           
**********************************************************                      
* PER RAMUNE TSUPP IS NO LONGER USED 2/18/09                                    
* WILL REMOVE TSUPP CODE AT A LATER DATE JUST IN CASE....                       
         B     HDHK55                                                           
**********************************************************                      
         OC    SVTS,SVTS                                                        
         BZ    HDHK55                                                           
         MVC   60(16,R1),=C'TRAFFIC SUPPLIER'                                   
         MVC   79(5,R1),SVTS       PRINT TRAFFIC SUPPLIER                       
         LA    R1,132(R1)                                                       
*                                                                               
         OC    SVCNAME,SVCNAME     CONTACT NAME                                 
         BZ    HDHK55                                                           
         MVC   60(7,R1),=C'CONTACT'                                             
         MVC   79(L'SVCNAME,R1),SVCNAME                                         
         LA    R1,132(R1)                                                       
*                                                                               
HDHK55   TM    ANYFLAG,PIGGBSW+COPYSSW                                          
         BZ    HDHK60                                                           
         BM    *+14                                                             
         MVC   67(41,R1),=C'*** PIGGYBACKS AND COPYSPLITS PRESENT ***'          
         B     HDHK60                                                           
         MVC   67(26,R1),=C'*** PIGGYBACKS PRESENT ***'                         
         TM    ANYFLAG,PIGGBSW     ANY PIGGYBACKS                               
         BO    HDHK60                                                           
         MVC   67(26,R1),=C'*** COPYSPLITS PRESENT ***'                         
         TM    ANYFLAG,COPYSSW     ANY COPYSPLITS                               
         BO    HDHK60                                                           
         DS    H'0'                BUG CATCHER                                  
*                                                                               
HDHK60   LA    R1,132(R1)                                                       
         MVI   0(R1),0                                                          
         BAS   RE,CKFIL            GO CK IF DISK HARD COPY NEEDED               
*                                                                               
* PRINT TITLES *                                                                
*                                                                               
         TM    UPDSW,X'20'         PRINTING UNITS                               
         BZ    HDHKX                NO, NO MIDLINES                             
         MVC   MID1+2(L'MIDLINE),MIDLINE                                        
                                                                                
         CLI   SVTN3PR3,C'N'       PRINT CMML RUN TIMES?                        
         BNE   HDHK62                                                           
                                                                                
         LA    R1,MID1+2+L'MIDLINE                                              
         SHI   R1,19                                                            
         MVC   0(19,R1),SPACES     CLEAR CMML RUN TIMES HEADING                 
*                                                                               
HDHK62   CLI   OFFLINE,C'Y'        ONLY OFFLINE                                 
         BNE   HDHKX                                                            
*                                                                               
         CLI   SVTWPR06,C'2'       FAXING AND AGENCY COPY                       
         BE    HDHK64                                                           
*                                                                               
         CLI   SVTWPR06,C'N'       IF NOT FAXING                                
         BE    HDHKX                                                            
*                                                                               
         TM    UPDSW,MULTIFAX                                                   
         BZ    HDHKX                                                            
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    HDHKX                                                            
*                                                                               
HDHK64   BAS   RE,CKMID                                                         
*                                                                               
HDHKX    XIT1                                                                   
*                                                                               
CKFIL    TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BO    CKF                                                              
*                                                                               
         CLI   OFFLINE,C'Y'        ONLY OFFLINE                                 
         BNER  RE                                                               
         CLI   SVTWPR06,C'2'       IS AGENCY COPY REQUIRED                      
         BNER  RE                                                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BOR   RE                                                               
*                                                                               
         TM    WHEN,X'20'          IS THIS SOON                                 
         BOR   RE                                                               
*                                                                               
CKF      NTR1                                                                   
*                                                                               
         LH    R2,=AL2(TSARBLK-SYSD)                                            
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
*                                                                               
         ICM   R5,15,H1+104        GET SEQNUM                                   
         MVC   H1+104(4),SPACES    BLK SEQ                                      
         LA    R6,14                                                            
         LA    R1,H14                                                           
CKFIL24  CLC   SPACES,0(R1)                                                     
         BNE   CKFIL26                                                          
         SH    R1,=H'132'                                                       
         BCT   R6,CKFIL24                                                       
         DC    H'0'                                                             
*                                                                               
CKFIL26  XC    ELEM(256),ELEM                                                   
         MVI   ELEM+4,C'Y'         SET FORCEHED                                 
*                                                                               
         LA    R3,H1                                                            
         LH    R2,=AL2(TSARBLK-SYSD)                                            
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
         SR    R5,R5                                                            
         B     CKFIL32                                                          
*                                                                               
CKFIL30  XC    ELEM(256),ELEM                                                   
*                                                                               
CKFIL32  LA    RE,132                                                           
         LA    RF,131(,R3)                                                      
CKFIL34  CLI   0(RF),C' '                                                       
         BH    CKFIL36                                                          
         BCTR  RF,0                                                             
         BCT   RE,CKFIL34                                                       
*                                                                               
         LA    R5,1(,R5)           ADD TO SKIPPED LINE                          
         B     CKFIL38                                                          
*                                                                               
CKFIL36  BCTR  RE,0                                                             
         EX    RE,CKFILMVC                                                      
         LA    RE,7(,RE)                                                        
         STCM  RE,3,ELEM                                                        
*                                                                               
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE                                                      
*                                                                               
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2                                                      
*                                                                               
         CLI   ELEM+4,C'Y'         WAS THIS A FORCE HEAD                        
         BE    CKFIL37                                                          
*                                                                               
         LTR   R5,R5                                                            
         BZ    CKFIL37                                                          
         LA    R5,1(,R5)           ADD 1 TO SPACING                             
         STC   R5,ELEM+4                                                        
         SR    R5,R5               RESET                                        
*                                                                               
CKFIL37  LA    R1,ELEM                                                          
         ST    R1,TSAREC                                                        
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,TSARD                                                    
*                                                                               
         CLI   TSERRS,0                                                         
         BE    CKFIL38                                                          
         DC    H'0'                                                             
CKFIL38  LA    R3,132(,R3)                                                      
         BCT   R6,CKFIL30                                                       
*                                                                               
         CLC   PAGE,=H'1'                                                       
         BE    CKFIL40                                                          
*                                                                               
* FORCE SPACE AFTER LAST LINE OF HEADING *                                      
*                                                                               
         XC    ELEM(256),ELEM                                                   
         MVI   ELEM+1,7                                                         
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2         KEY                                          
*                                                                               
         MVI   ELEM+5,2            FORCE 2 LINES OF SPACING                     
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,TSARD                                                    
*                                                                               
         CLI   TSERRS,0                                                         
         BE    CKFIL40                                                          
         DC    H'0'                                                             
*                                                                               
CKFIL40  DS   0H                                                                
         MVI   H1+131,C' '                                                      
         STCM  R5,15,H1+104        RESTORE SEQNUM                               
         CLI   SVTWPR06,C'2'       REQUIRE AGENCY COPY                          
         BNE   HDHKX                                                            
*                                                                               
         TM    WHEN,X'20'                                                       
         BO    HDHKX                                                            
*                                                                               
         MVC   H4+7(17),=C'** AGENCY COPY **'                                   
*                                                                               
         B     HDHKX                                                            
*                                                                               
CKMID    NTR1                                                                   
*                                                                               
         LA    R3,MID1                                                          
         XC    ELEM(256),ELEM                                                   
*                                                                               
         LH    R2,=AL2(TSARBLK-SYSD)                                            
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
         SR    R5,R5                                                            
         B     CKFIL62                                                          
*                                                                               
         XC    ELEM(256),ELEM                                                   
*                                                                               
CKFIL62  LA    RE,132                                                           
         LA    RF,131(,R3)                                                      
CKFIL64  CLI   0(RF),C' '                                                       
         BH    CKFIL66                                                          
         BCTR  RF,0                                                             
         BCT   RE,CKFIL64                                                       
*                                                                               
         LA    R5,1(,R5)           ADD TO SKIPPED LINE COUNT                    
         B     CKFIL68                                                          
*                                                                               
CKFIL66  BCTR  RE,0                                                             
         EX    RE,CKFILMVC                                                      
         LA    RE,7(,RE)                                                        
         STCM  RE,3,ELEM                                                        
*                                                                               
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE                                                      
*                                                                               
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2                                                      
*                                                                               
         CLI   ELEM+4,C'Y'         WAS THIS A FORCE HEAD                        
         BE    CKFIL67                                                          
*                                                                               
         LTR   R5,R5                                                            
         BZ    CKFIL67                                                          
         LA    R5,1(,R5)           ADD 1 TO SPACING                             
         STC   R5,ELEM+4                                                        
         SR    R5,R5               RESET                                        
*                                                                               
CKFIL67  LA    R1,ELEM                                                          
         ST    R1,TSAREC                                                        
*                                                                               
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,TSARD                                                    
*                                                                               
         CLI   TSERRS,0                                                         
         BE    CKFIL68                                                          
         DC    H'0'                                                             
CKFIL68  LA    R3,132(,R3)                                                      
*                                                                               
* FORCE SPACE AFTER LAST LINE OF HEADING *                                      
*                                                                               
         XC    ELEM(256),ELEM                                                   
         MVI   ELEM+1,7            REC LENGTH                                   
*                                                                               
         LA    RE,7                                                             
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE                                                      
*                                                                               
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2         KEY                                          
*                                                                               
         MVI   ELEM+5,2            FORCE 2 LINES OF SPACING                     
*                                                                               
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,TSARD                                                    
*                                                                               
         CLI   TSERRS,0                                                         
         BE    HDHKX                                                            
         DC    H'0'                                                             
CKFILMVC MVC   ELEM+6(0),0(R3)                                                  
         DROP  R2                                                               
*                                                                               
MIDLINE  DC    CL112'--------- ROTATION ------- --- COMMERCIAL --- COMMC        
               ERCIAL TITLE --- --- OTHER --------------- --- CMML RUN C        
               TIMES'                                                           
         DROP  RB                                                               
         EJECT                                                                  
*-------------------------                                                      
* FOOT HOOK ROUTINE                                                             
*-------------------------                                                      
*                                                                               
FTHK     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   FOOTSW,5            TEST DONE 5 LINES YET                        
         BE    FTHK20              YES - DONE                                   
         LLC   RE,FOOTSW                                                        
         LA    RE,1(RE)                                                         
         STC   RE,FOOTSW                                                        
*                                                                               
         MVC   P,SPACES            FTHK DOES NOT CLEAR P                        
         MVI   P,0                 FORCE RETURN                                 
*                                                                               
         CLI   FOOTSW,1            TEST FIRST LINE                              
         BNE   FTHK10                                                           
*                                                                               
         CLI   CONTINUE,C'N'       TEST FINISHED                                
         BE    FTHK10              YES                                          
*                                                                               
         MVC   P+2(40),=C'** INSTRUCTIONS CONTINUE ON NEXT PAGE **'             
*                                                                               
         CLI   OFFLINE,C'Y'        WE OFFLINE                                   
         BNE   FTHKX                                                            
*                                                                               
         CLI   SVTWPR06,C'N'       NOT A FAX                                    
         BE    FTHKX                                                            
*                                                                               
         CLI   SVTWPR06,C'2'       FAXING AND AGENCY COPY                       
         BE    FTHK02                                                           
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    FTHKX                YES                                         
*                                                                               
         TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BZ    FTHKX                                                            
*                                                                               
* FOR MULTI FAX TRANSMISSION SAVE FOOT HOOK IN TSAROFF                          
*                                                                               
FTHK02   LH    R2,=AL2(TSARBLK-SYSD)                                            
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
*                                                                               
         XC    ELEM(256),ELEM                                                   
         LA    RE,132                                                           
         LA    RF,P+131                                                         
FTHK04   CLI   0(RF),C' '                                                       
         BH    FTHK06                                                           
         BCTR  RF,0                                                             
         BCT   RE,FTHK04                                                        
         DC    H'0'                                                             
*                                                                               
FTHK06   BCTR  RE,0                                                             
         EX    RE,FTHKMVC                                                       
         LA    RE,7(,RE)                                                        
         STCM  RE,3,ELEM                                                        
*                                                                               
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE                                                      
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2                                                      
*                                                                               
         LA    R1,ELEM                                                          
         ST    R1,TSAREC                                                        
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,TSARD                                                    
         CLI   TSERRS,0                                                         
         BE    FTHKX                                                            
         DC    H'0'                                                             
FTHKMVC  MVC   ELEM+6(0),P                                                      
*                                                                               
         DROP  R2                                                               
FTHK10   CLI   FOOTSW,3            REACHED LINE 3 YET                           
         BL    FTHKX                                                            
*                                                                               
* CHECK FOR FOOTNOTE LINE *                                                     
*                                                                               
         CLI   CONTINUE,C'N'       TEST FINISHED                                
         BNE   FTHK20              YES                                          
         L     R2,ASVFTNT                                                       
         LLC   R0,FOOTSW                                                        
         SH    R0,=H'2'                                                         
         B     FTHK14                                                           
FTHK12   CLI   0(R2),0             TEST MORE DATA                               
         BE    FTHK20                                                           
         LA    R2,60(R2)                                                        
FTHK14   BCT   R0,FTHK12                                                        
         CLI   0(R2),0                                                          
         BE    FTHK20                                                           
         MVC   P+2(60),0(R2)                                                    
         B     FTHKX                                                            
*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!                   
* WE FILL IN P1-P4 WITH DATA AND GO TO SPOOL                                    
* AFTER SPOOL PRINTS P1,P2 AND DOES FTHK                                        
* IT DOES NOT CHECK TO SEE THAT WE HAVE MORE TO                                 
* PRINT IN P3 AND P4 - IT FINDS SPACES IN P1 AND THINKS ITS DONE                
* TO GET AROUND THIS I'M MOVING DATA UP TO P2...                                
* (P1 MUST BE SPACES THAT IS HOW SPOOL KNOWS WE ARE DONE W/FTHK)                
*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!                   
*                                                                               
FTHK20   MVI   FOOTSW,0                                                         
         MVC   P,SPACES                                                         
*                                                                               
         CLC   P2,SPACES                                                        
         BNE   FTHKX               DATA IN P2, DONE                             
*                                                                               
         LA    R0,2                CHK LAST 2 P-LINES                           
         LA    R1,P2               MOVE DATA TO                                 
         LA    R2,P3               MOVE DATA FROM IF ANY                        
FTHK21   CLC   0(132,R2),SPACES                                                 
         BE    FTHK22                                                           
         MVC   0(132,R1),0(R2)     MOVE UP DATA IN P                            
         MVC   0(132,R2),SPACES    CLEAR SO NO DUPS                             
         LA    R1,132(R1)                                                       
*                                                                               
FTHK22   LA    R2,132(R2)                                                       
         BCT   R0,FTHK21                                                        
*                                                                               
FTHKX    XIT1                                                                   
         DROP  RB                                                               
         SPACE 5                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*-----------------------------------------------------                          
* SELECT MOST SPECIFIC PATTERNS THAT WOULD APPLY                                
* ENTRIES ARE SORTED ON PRODUCT/PATKEY                                          
* PATKEYS ARE:                                                                  
* 00 NET SPECIFIC  (NOT IN ORDER BUT WILL KEEP IT THAT WAY)                     
* 01 FEED SPECIFIC (WILL ALWAYS PRINT)                                          
* 02 DAYPART SPECIFIC (WILL ALWAYS PRINT)                                       
* 04 PROG SPECIFIC                                                              
* 08 MEDIA SPECIFIC                                                             
* 10 ALL NETWORK PATTERN                                                        
*-----------------------------------------------------                          
*                                                                               
PATSEL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    ELEM,ELEM                                                        
*                                                                               
         L     R2,APATABLE                                                      
         USING PATABLED,R2                                                      
         LA    R5,PATNEXT-PATENT(R2) POINT TO NEXT ENTRY                        
N        USING PATABLED,R5                                                      
                                                                                
         B     PATS15                                                           
*                                                                               
PATS05   LA    R2,PATNEXT-PATENT(R2) BUMP TO NEXT                               
*                                                                               
PATS06   TM    PATFLG2,PATDONE     DONE THIS PATTERN                            
         BZ    PATS08                                                           
         OC    PATENT,PATENT       ANY ENTRY                                    
         BZ    PATS80                                                           
         C     R2,MAXPATBL         AT END OF TABLE                              
         BL    PATS05                                                           
         B     PATS80                                                           
*                                                                               
PATS08   LA    R5,PATNEXT-PATENT(R2)                                            
         B     *+8                                                              
PATS10   LA    R5,PATNEXT-PATENT(R5)                                            
         C     R5,MAXPATBL         AT END OF TABLE                              
         BNL   PATS80                                                           
                                                                                
PATS15   TM    N.PATFLG2,PATDONE   DONE THIS PATTERN                            
         BO    PATS10                                                           
         OC    N.PATENT,N.PATENT   ANY ENTRY                                    
         BZ    PATS80                                                           
*                                                                               
         CLC   PATPROD1(PATFEED-PATPROD1),N.PATPROD1 PRD/LEN/PRD2/LEN2          
         BNE   PATS80                                                           
*                                                                               
         TM    PATKEY,PATKFD       FEED PATTERN                                 
         BO    PATS80               YES, ALWAYS PRINT                           
         TM    PATKEY,PATKDP       DAYPART PATTERN                              
         BO    PATS80               YES, ALWAYS PRINT                           
         TM    PATKEY,PATKPRG      PROGRAM SPECIFIC PAT                         
         BO    PATS80               YES                                         
*                                                                               
         TM    N.PATKEY,PATKFD     NEXT PAT FEED SPEC                           
         BO    PATS10               YES, BYPASS                                 
         TM    N.PATKEY,PATKDP     NEXT PAT DAYPART SPEC                        
         BO    PATS10               YES, BYPASS                                 
         TM    N.PATKEY,PATKPRG    PROGRAM SPECIFIC PAT                         
         BO    PATS10               YES, BYPASS                                 
*                                                                               
         TM    PATFLG2,PATUSED     WERE THESE PATTERNS USED                     
         BZ    PATS05                                                           
         TM    N.PATFLG2,PATUSED                                                
         BZ    PATS10                                                           
*                                                                               
         OC    PATSEQ,PATSEQ       ANY PATTERN                                  
         BZ    PATS05                                                           
         OC    N.PATSEQ,N.PATSEQ                                                
         BZ    PATS10                                                           
*NOPPING THIS FIXES FOG/10/05 MAY NEED TO NOP ABOVE 4 INSTR AS WELL             
*NOP     OC    PATREF,PATREF       ANY PATTERN                                  
*        BZ    PATS05                                                           
*        OC    N.PATREF,N.PATREF                                                
******   BZ    PATS10                                                           
*                                                                               
* MAKE SURE PROG SPECIFIC ENTRY COMES BEFORE NET SPEC                           
         CLI   PATKEY,0            NETWORK SPECIFIC PAT                         
         BNE   PATS20                                                           
         TM    N.PATKEY,PATKPRG    PROGRAM SPECIFIC PAT                         
         BZ    PATS20                                                           
*                                                                               
         XC    PATENT,N.PATENT     SWAP  ENTRIES                                
         XC    N.PATENT,PATENT       SO THAT THE MOST                           
         XC    PATENT,N.PATENT         SPECIFIC PAT IS FIRST                    
         B     PATS80              PRINT DATES AS IS                            
*                                                                               
PATS20   CLC   PATSTR(L'PATSTR+L'PATEND),N.PATSTR                               
         BNE   PATS30                                                           
*                                                                               
* SAME DATES                                                                    
* DELETE GENERAL PATTERN ONLY IF NETWORK SPECIFIC PATTER EXISTS                 
         CLI   PATKEY,PATKPRG      IF PROGRAM SPECIFIC PAT                      
         BNE   PATS70               NO, DELETE                                  
         B     PATS10                                                           
*                                                                               
PATS30   DS    0H                                                               
         CLC   N.PATSTR,PATEND     START AFTER END                              
         BH    PATS10                                                           
         CLC   N.PATEND,PATSTR     END BEFORE START                             
         BL    PATS10                                                           
*                                                                               
* OVERLAPPING DATES                                                             
         CLC   PATSTR,N.PATSTR                                                  
         BH    PATS32                                                           
         CLC   PATEND,N.PATEND                                                  
         BL    PATS32                                                           
         CLI   PATKEY,PATKPRG       PROGRAM SPECIFIC PAT                        
         BNE   PATS70               NO, DATES FALL W/N, DELETE                  
*                                                                               
PATS32   LR    R3,R2                                                            
         BAS   RE,SVDTES           SAVE OFF THE DATES                           
         LR    R3,R5                                                            
         BAS   RE,SVDTES                                                        
         B     PATS10                                                           
*                                                                               
PATS70   BRAS  RE,DELENT           R5 POINTS TO PAT ENTRY TO BE DELETED         
         B     PATS15                                                           
*                                                                               
PATS80   DS    0H                                                               
         OC    ELEM(7),ELEM        ANY DATES TO MERGE                           
         BZ    *+8                                                              
         BAS   RE,MDATES                                                        
                                                                                
PATS85   LA    R2,PATNEXT-PATENT(R2) NO BUMP TO NEXT                            
         C     R2,MAXPATBL         AT END OF TABLE                              
         BNL   PATSX                                                            
                                                                                
         OC    PATENT,PATENT       EMPTY ENTRY                                  
         BZ    PATSX                DONE                                        
                                                                                
         TM    PATFLG2,PATDONE     DONE THIS PATTERN                            
         BO    PATS85                                                           
                                                                                
         LA    R5,PATNEXT-PATENT(R2)                                            
         C     R5,MAXPATBL         AT END OF TABLE                              
         BL    PATS15                                                           
*                                                                               
PATSX    XIT1                                                                   
         DROP  R2,N                                                             
*                                                                               
* SAVE DATES IN ELEM                                                            
*                                                                               
SVDTES   NTR1  BASE=*,LABEL=*                                                   
         LA    R1,ELEM                                                          
W        USING PATABLED,R3                                                      
*                                                                               
SVDT05   OC    0(7,R1),0(R1)       EMPTY                                        
         BZ    SVDT10                                                           
         CLC   0(2,R1),W.PATSEQ    SAME PAT SEQ                                 
         BNE   *+14                                                             
         CLC   2(4,R1),W.PATSTR    SAME STAR AND END DATES                      
         BE    SVDTX                                                            
         LA    R1,7(R1)            BUMP TO NEXT                                 
         B     SVDT05                                                           
*                                                                               
SVDT10   MVC   0(2,R1),W.PATSEQ    SAVE PAT SEQ                                 
         MVC   2(4,R1),W.PATSTR    SAVE PAT START AND END DATES                 
SVDTX    XIT1                                                                   
         DROP  W                                                                
*                                                                               
*---------------------------------------------------------------------          
* MERGE DATES WHERE POSSIBLE AND ADD NEW PAT ENTRIES WHERE NEEDED               
* SORTED FROM MORE SPECIFIC TO LEAST SPECIFIC PATTERN                           
* INPUT IN ELEM= (2-PAT SEQ, 2-PAT START DATE, 2-PAT END DATE, 1- FLAG          
* OUTPUT IN ELEM+100 SAME FORMAT AS ABOVE FOR NEWLY DEVELOPED DATES             
*---------------------------------------------------------------------          
* ON ENTRY IN PATTERN LIST R2 = FIRST PATTERN FOR A PRODUCT                     
*          R5 = END OF PATTERN FOR THE SAME PRODUCT                             
*------------------------------------------------------------------             
*                                                                               
MDATES   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PATABLED,R2                                                      
*                                                                               
         XC    WORK,WORK                                                        
*                                                                               
* COUNT ENTRIES                                                                 
         LA    R3,ELEM                                                          
         SR    R0,R0                                                            
MDAT02   OC    0(7,R3),0(R3)                                                    
         BZ    MDAT04                                                           
         BCTR  R0,0                                                             
         LA    R3,7(R3)                                                         
         B     MDAT02                                                           
                                                                                
MDAT04   LPR   R0,R0                                                            
         BCTR  R0,0                COUNT -1                                     
         LTR   R0,R0               ONLY ONE ENTRY                               
         BZ    MDATX                YES, DONE                                   
         STC   R0,BYTE             SAVE COUNT                                   
                                                                                
         LA    R3,ELEM                                                          
         LA    R4,7(R3)                                                         
*                                                                               
MDAT05   OC    0(7,R3),0(R3)                                                    
         BZ    MDAT100             END OF LIST                                  
         B     MDAT20                                                           
*                                                                               
MDAT10   LA    R4,7(R4)                                                         
         BCTR  R0,0                                                             
         LTR   R0,R0               DONE WITH ORIGINAL LIST                      
         BNZ   MDAT20               YES                                         
         LLC   R0,BYTE                                                          
         BCTR  R0,0                DECREASE COUNT BY 1                          
         LTR   R0,R0                                                            
         BZ    MDAT100             DONE WITH THE LIST                           
         STC   R0,BYTE                                                          
         B     MDAT25                                                           
*                                                                               
MDAT20   CLI   6(R3),X'FF'         MARKED FOR DELETION                          
         BE    MDAT25                                                           
         CLI   6(R4),X'FF'         MARKED FOR DELETION                          
         BE    MDAT10                                                           
                                                                                
         OC    0(7,R4),0(R4)                                                    
         BNZ   MDAT30                                                           
                                                                                
         LR    R4,R3               PT TO ENTRY FOR ADD                          
         MVC   WORK+12(4),2(R4)    AND MOVE DATES                               
         BAS   R1,MDAT70           ADD THIS ENTRY                               
                                                                                
MDAT25   LA    R3,7(R3)                                                         
         LA    R4,7(R3)                                                         
         B     MDAT05                                                           
                                                                                
* SEE IF DATES OVERLAP                                                          
MDAT30   CLC   2(2,R3),4(R4)       1ST START AFTER 2ND END                      
         BH    MDAT10                                                           
*                                                                               
         CLC   4(2,R3),2(R4)       1ST END BEFORE 2ND START                     
         BL    MDAT10                                                           
*                                                                               
         MVC   DUB(4),2(R3)        MOVE START/END DATES OF BOTH PAT             
         MVC   DUB+4(4),2(R4)      FOR DATE MANIPULATION                        
*                                                                               
         CLC   DUB(2),DUB+4        COMPARE START DATES                          
         BH    MDAT35                                                           
         CLC   DUB+2(2),DUB+6      AND END DATES                                
         BL    MDAT35                                                           
         MVI   6(R4),X'FF'         DATES FALL W/N MARK FOR DELETION             
         B     MDAT10                                                           
*                                                                               
MDAT35   CLC   DUB(2),DUB+4        COMPARE START DATES                          
         BNH   MDAT40                                                           
*                                                                               
         GOTO1 DATCON,DMCB,(2,DUB),(0,WORK) START DATE (MORE SPEC)              
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'-1' STR DATE -1 AS END DATE             
         GOTO1 DATCON,(R1),(0,WORK+6),(2,WORK+14) END DTE ( < SPEC)             
         MVC   WORK+12(2),DUB+4    START DATE FOR NEW ENTRY                     
         BAS   R1,MDAT70                                                        
                                                                                
         CLC   DUB+2(2),DUB+6      COMPARE END DATES                            
         BL    MDAT65                                                           
         B     MDAT10                                                           
*                                                                               
MDAT40   CLC   DUB(2),DUB+4        SEE IF START DATES EQUAL                     
         BE    MDAT45               YES, DONE WITH START DATES                  
                                                                                
         GOTO1 DATCON,DMCB,(2,DUB+2),(0,WORK) END DATE (MORE SPEC)              
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'+1' END DATE +1 AS STR DATE             
         GOTO1 DATCON,(R1),(0,WORK+6),(2,WORK+12) STR DTE ( < SPEC)             
         MVC   WORK+14(2),DUB+6    END DATE FOR NEW ENTRY                       
         BAS   R1,MDAT70                                                        
         B     MDAT10                                                           
                                                                                
MDAT45   CLC   DUB+2(2),DUB+6      1ST END DTE AFTER 2ND END DTE                
         BL    MDAT65                                                           
                                                                                
         MVI   6(R4),X'FF'         YES, MARK 2ND ENTRY FOR DEL                  
         B     MDAT10                                                           
*                                                                               
MDAT65   GOTO1 DATCON,DMCB,(2,DUB+2),(0,WORK) END DATE (MORE SPEC)              
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'+1' END DATE +1 AS STR DATE             
         GOTO1 DATCON,(R1),(0,WORK+6),(2,WORK+12) AS STR DTE (<SPEC)            
         MVC   WORK+14(2),DUB+6    END DATE FOR NEW ENTRY                       
         BAS   R1,MDAT70                                                        
         B     MDAT10                                                           
*                                                                               
MDAT70   LA    RE,ELEM                                                          
         LA    RF,L'ELEM(RE)       END OF ELEM                                  
*                                                                               
MDAT75   OC    0(7,RE),0(RE)                                                    
         BZ    MDAT80                                                           
         CR    RE,RF                                                            
         BL    *+6                                                              
         DC    H'0'                OVERFLOW TO ELEM+100                         
                                                                                
         CLC   0(2,RE),0(R4)       SAME SEQ                                     
         BNE   MDAT78                                                           
         CLC   2(4,RE),WORK+12     SAME DATES                                   
         BE    MDAT84                                                           
*                                                                               
* SEE IF DATES OVERLAP                                                          
         CLC   2(2,RE),WORK+14     START AFTER END                              
         BH    MDAT78                                                           
         CLC   4(4,RE),WORK+12    END BEFORE START                              
         BL    MDAT78                                                           
         MVC   2(4,RE),WORK+12     MOVE IN NEW DATES                            
         B     MDAT84                                                           
*                                                                               
MDAT78   LA    RE,7(RE)            BUMP TO NEXT                                 
         B     MDAT75                                                           
*                                                                               
MDAT80   MVC   0(2,RE),0(R4)                                                    
         MVC   2(4,RE),WORK+12     MOVE IN NEW DATES                            
MDAT84   XC    WORK,WORK                                                        
         BR    R1                                                               
*                                                                               
* MODIFY DATES AND ADD ENTRIES TO PAT TABLE                                     
* (R2=START OF PATS FOR THIS PROD                                               
*  R5=END OF PATS FOR THIS PROD)                                                
*                                                                               
MDAT100  XC    WPATENT,WPATENT     CLEAR BUILD ENTRY BUFFER                     
         LR    RF,R2               SAVE START OF PATS FOR THIS PROD             
         MVI   BYTE,0              INIT NEED TO ADD ENTRY                       
         LA    R4,ELEM                                                          
                                                                                
* FIND END OF PATTERN TABLE                                                     
         LR    R3,R5               LAST PAT ENTRY FOR THIS PRODUCT              
MDAT105  OC    0(L'PATENT,R3),0(R3)                                             
         BZ    MDAT108                                                          
         LA    R3,L'PATENT(R3)                                                  
         C     R3,MAXPATBL                                                      
         BL    MDAT105                                                          
         DC    H'0'                PAT TABLE TOO SMALL                          
                                                                                
W        USING PATABLED,WPATENT                                                 
N        USING PATABLED,R3                                                      
                                                                                
MDAT108  LA    R1,ELEM+256         END OF ELEM                                  
         B     MDAT115                                                          
                                                                                
MDAT110  LA    R4,7(R4)            PT TO NEXT ENTRY                             
         LR    R2,RF               START OF PATS FOR THIS PROD                  
         CR    R4,R1               END OF LIST                                  
         BNL   MDATX                YES, DONE                                   
         OC    0(7,R4),0(R4)                                                    
         BZ    MDATX               DONE                                         
                                                                                
MDAT115  CLI   6(R4),X'FF'         ENTRY MARKED FOR DELETION                    
         BNE   MDAT125                                                          
         LA    R4,7(R4)                                                         
         OC    0(7,R4),0(R4)       ANY ENTRY                                    
         BZ    MDATX                                                            
         CR    R1,R4               END OF LIST                                  
         BL    MDAT115                                                          
         B     MDATX                YES, DONE                                   
                                                                                
MDAT125  CLC   PATSEQ,0(R4)        R4=ELEM                                      
         BNE   MDAT130                                                          
                                                                                
MDAT126  DS    0H                                                               
         TM    PATFLG2,PATDONE     DONE NEW DATES?                              
         BO    MDAT130              YES, BYPASS                                 
                                                                                
         CLC   W.PATSEQ,0(R4)      SAME PAT SEQ                                 
         BE    MDAT127                                                          
                                                                                
         MVC   WPATENT,PATENT      MOVE PATTERN ENTRY                           
                                                                                
         MVC   PATSTR(4),2(R4)     OVERRIDE W/NEW DATES                         
         OI    PATFLG2,PATDONE                                                  
         B     MDAT110                                                          
                                                                                
MDAT127  MVC   W.PATSTR(4),2(R4)   MOVE IN NEW DATES                            
         MVC   0(L'WPATENT,R3),WPATENT ADD ENTRY TO END OF PAT TABLE            
*                                                                               
         L     R1,FULL                                                          
         AH    R1,=AL2(PATNEXT-PATENT)                                          
         ST    R1,FULL                                                          
*                                                                               
         LA    R3,L'PATENT(R3)                                                  
         C     R3,MAXPATBL                                                      
         BL    MDAT110                                                          
         DC    H'0'                PATTERN TABLE TOO SMALL                      
*                                                                               
MDAT130  LA    R2,PATNEXT-PATENT(R2)  GET NEXT ENTRY                            
         CR    R2,R5                                                            
         BL    MDAT125                                                          
         B     MDAT127                                                          
                                                                                
MDATX    XC    ELEM,ELEM                                                        
*                                                                               
         XIT1                                                                   
*                                                                               
*-------------------------------------------                                    
* PRINT ERROR REPORT - ONLY IF OFFLINE                                          
*-------------------------------------------                                    
*                                                                               
PER      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   PERX                                                             
*                                                                               
         SR    R7,R7               FLAG FOR ERROR REPORT ONLY                   
*                                                                               
         CLI   PQSW,1              PRINT QUE EVER OPENED                        
         BE    PER04                NO, SOME FUNNY ERROR ONLY                   
*                                                                               
         BCTR  R7,0                FORCE NEGATIVE                               
*                                                                               
         CLI   SVTWPR06,C'N'       IF N, NO NEED TO SWITCH                      
         BE    PER06                YES                                         
*                                                                               
         TM    WHEN,X'20'          IF SOON, CAN'T SWITCH                        
         BO    PER100                                                           
*                                                                               
         CLI   SVTWPR06,C'2'       IF 2, NO NEED TO SWITCH                      
         BE    PER06                YES                                         
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   AGENCY COPY                                  
         BO    PER06                YES, NO SW                                  
*                                                                               
* IF WE JUST DID FAX ONLY, NEED TO SWITCH BACK TO  *                            
* ORIGINAL SETTINGS FOR ANY ERROR REPORT AND LOGOS *                            
*                                                                               
         MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
*                                                                               
PER00    LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
*                                                                               
* SEE IF ORIGINALLY PRINTING DDS SHOP                                           
*                                                                               
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BZ    PER02               YES                                          
         CLI   DIRPRTSW,C'Y'                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*        MVC   REMOTKEY,MCREMOTE-MASTD(RE) RESTORE ORIGINAL DIRECT              
         LA    R1,MCREMOTE-MASTD(,RE)                                           
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVC   REMOTPRG,REMOTPRG-REMOTED(R1)                                    
         MVC   REMOTFRM,REMOTFRM-REMOTED(R1)                                    
         MVC   REMOTJID,REMOTJID-REMOTED(R1)                                    
         MVC   REMOTDST,REMOTDST-REMOTED(R1)                                    
         MVC   REMOTCLS,REMOTCLS-REMOTED(R1)                                    
         MVC   REMOTCPY,REMOTCPY-REMOTED(R1)                                    
*AR                                                                             
         TM    WHEN,X'10'                                                       
         BZ    PER01                                                            
         MVI   REMOTFLG,X'FA'                                                   
         MVC   REMOTSYS(3),=C'NTB'                                              
         MVC   REMOTSUB,SPACES                                                  
         MVI   REMOTCPY,1                                                       
         MVC   REMOTTY1,SVQLTYP1                                                
         L     RE,TWAMASTC                                                      
         XC    MCARC-MASTD(L'MCARC,RE),MCARC-MASTD(RE)                          
         MVC   REMOTTY1,SVQLTYP1                                                
PER01    DS    0H                                                               
*AR                                                                             
         L     RE,TWADCONS         MAKE SURE OUTPUT DCB ADDRESS SET             
         L     RE,TSPFUSER-TWADCOND(RE)                                         
         L     R1,136(,RE)         PAST SAVED DCB                               
         LA    R1,1(,R1)                                                        
         ST    R1,136(,RE)         FORCE NEW PRINT QUEUE ENTRY                  
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  REMOTSUB,DUB        FORCE NE PRINT QUEUE ENTRY                   
*                                                                               
         B     PER04                                                            
*                                                                               
PER02    XC    REMOTKEY,REMOTKEY                                                
         DROP  RF                                                               
         MVC   QLDESC,SPACES                                                    
         MVC   QLDESC(4),RCPROG                                                 
         MVC   QLCLASS,PLCLASS                                                  
         MVC   REMUSER,=C'STB'                                                  
*AR                                                                             
         MVC   QLTYP1,SVQLTYP1                                                  
*AR                                                                             
         MVI   MCOUTPUT-MASTD(RE),C'P'                                          
         DROP  R1                                                               
*                                                                               
PER04    GOTO1 OPENPQ                                                           
*                                                                               
PER06    DS   0H                                                                
*                                                                               
         L     R2,AERRFILE         STORED DCB ADDRESS                           
         CLOSE ((R2),)                                                          
         FREEPOOL (R2)                                                          
*                                                                               
         XC    AERRFILE,AERRFILE   SET FILE NOT OPEN                            
*                                                                               
         LA    R2,ERREPT                                                        
*                                                                               
         TM    WHEN,X'20'          THIS A SOON REQUEST                          
         BZ    *+10                 NO                                          
         MVC   40(8,R2),=CL8'TALWRK'                                            
*                                                                               
         OPEN  ((R2),INPUT)                                                     
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    RE,PEREOF                                                        
         STCM  RE,7,ERREPT+33                                                   
*                                                                               
* CLEAR HEAD AND MIDLINES FROM INST *                                           
*                                                                               
         LA    R0,14                                                            
         LA    R1,H1                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         MVC   MID1,SPACES                                                      
*                                                                               
         LA    RE,PHDG                                                          
         ST    RE,SPECS                                                         
         LA    RE,PHDHK                                                         
         ST    RE,HEADHOOK                                                      
         XC    FOOTHOOK,FOOTHOOK                                                
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         EJECT                                                                  
PER10    LA    R2,ERREPT                                                        
         LA    R3,ELEMENT                                                       
         USING XRECD,R3                                                         
         GET   (R2),(R3)                                                        
*                                                                               
         MVC   P,SPACES                                                         
         MVC   XPPROG,XPROG                                                     
*                                                                               
* READ PROGRAM RECORD FOR STANDARD PROGRAM INFORMATION *                        
*                                                                               
         BRAS  RE,INITSPT          SET FROM NET TO SPOT                         
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,XBAGYMD                                                   
         MVC   NPGKNET,XNETMKT                                                  
         MVC   NPGKPROG,XPROG                                                   
         MVC   NPGKEND,XPERND                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    PER12                                                            
         MVC   KEY,KEYSAVE                                                      
         MVC   NPGKEND,XPERST                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    PER12                                                            
         MVC   KEY,KEYSAVE                                                      
         XC    NPGKEND,NPGKEND                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R4                                                               
PER12    L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         AH    R6,DATADISP                                                      
         LR    R5,R6                                                            
PER14    CLI   0(R6),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R6),X'92'                                                      
         BE    PER16                                                            
         SR    RF,RF                                                            
         ICM   RF,1,1(R6)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R6,RF                                                            
         B     PER14                                                            
         USING NPGEL92,R6                                                       
PER16    MVC   XPPROGNM,NPGNAME                                                 
         EJECT                                                                  
* GET PROGRAM DAY, 1ST FROM NPGDAY, NPGROT OVERRIDES IF PRESENT,                
* THEN NPGTDAY (OPTIONAL TRAFFIC ELEM) OVERRIDES THAT.                          
*                                                                               
         MVC   BYTE,NPGDAY                                                      
         CLI   NPGROT,0            IF NPGROT PRESENT, USE IT                    
         BE    *+10                                                             
         MVC   BYTE,NPGROT                                                      
*                                                                               
PER20    CLI   0(R5),0                                                          
         BE    PER26                                                            
         CLI   0(R5),X'E3'                                                      
         BE    PER24                                                            
         SR    RF,RF                                                            
         ICM   RF,1,1(R5)                                                       
         BZ    PER26                                                            
         AR    R5,RF                                                            
         B     PER20                                                            
         USING NPGELE3,R5                                                       
PER24    MVC   BYTE,NPGTDAY                                                     
         DROP  R5                                                               
*                                                                               
PER26    GOTO1 UNDAY,(R1),BYTE,XPPROGDA                                         
*                                                                               
         GOTO1 UNTIME,(R1),NPGTIME,XPPROGTM                                     
         DROP  R6                                                               
         EDIT  XTUNT,(4,XPUNITS)                                                
         EDIT  XFEEDS,(4,XPFEEDS)                                               
         GOTO1 DATCON,(R1),(0,XPERST),(5,XPPERIOD)                              
         MVI   XPPERIOD+8,C'-'                                                  
         GOTO1 (RF),(R1),(0,XPERND),(5,XPPERIOD+9)                              
         CLI   XTYPE,XTYPE5        SOME UNALLOCATED UNITS                       
         BE    PER30                                                            
         CLI   XTYPE,XTYPE6        SOME UNASSIGNED UNITS                        
         BE    PER30                                                            
         LLC   R1,XTYPE                                                         
         BCTR  R1,0                                                             
         MH    R1,=AL2(L'PERTBLE)                                               
         LA    R1,PERTBLE(R1)                                                   
         MVC   XPEXPLAN(L'PERTBLE),0(R1)                                        
         LA    R7,132(,R7)                                                      
         B     PER50                                                            
*                                                                               
PER30    LA    R2,XPEXPLAN         ANY UNALLOCATED                              
         OC    XUNAS,XUNAS         ANY UNALLOCATED                              
         BZ    PER40                                                            
         EDIT  XUNAS,(4,(R2)),ALIGN=LEFT                                        
         LR    RF,R0                                                            
         LA    R1,1(R2,RF)                                                      
         MVC   0(16,R1),=CL16'UNASSIGNED UNITS'                                 
         LA    R2,132(,R2)                                                      
PER40    OC    XUNAL,XUNAL         ANY UNALLOCATED                              
         BZ    PER50                                                            
         EDIT  XUNAL,(4,(R2)),ALIGN=LEFT                                        
         LR    RF,R0                                                            
         LA    R1,1(R2,RF)                                                      
         MVC   0(17,R1),=CL17'UNALLOCATED UNITS'                                
         LA    R2,132(,R2)                                                      
         DROP  R3                                                               
*                                                                               
PER50    GOTO1 SPOOL,DMCB,(R8)                                                  
         B     PER10                                                            
*                                                                               
PEREOF   DS    0H                                                               
         CLOSE ((2),)                                                           
         FREEPOOL (R2)                                                          
*                                                                               
         TM    WHEN,X'20'          THIS A SOON RUN                              
         BO    PER100                                                           
*                                                                               
         CLI   SVTWPR06,C'2'       WAS HARD COPY REQUESTED                      
         BNE   PERX                 NO                                          
         TM    UPDSW,X'01'         ANY PROG SELECTED FOR INSTR                  
         BZ    PERX                 NO                                          
         TM    SVOPTSW1,OPTHDCPY   THIS AGENCY COPY ONLY                        
         BO    PERX                 YES                                         
*                                                                               
         MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
*                                                                               
* RE-OPEN OR OPEN DIRECT TO AGENCY PRINT QUE ENTRY *                            
*                                                                               
         LA    R1,ELEM                                                          
         XC    ELEM,ELEM                                                        
         ST    R1,SPOOLQLK                                                      
         USING PQPLD,R1                                                         
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
         DROP  R1                                                               
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
*                                                                               
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   PEREOF10                                                         
         L     RE,TWADCONS         MAKE SURE OUTPUT DCB ADDRESS SET             
         L     RE,TSPFUSER-TWADCOND(RE)                                         
*                                                                               
         MVI   140(RE),C'Y'        SET EASYLINK STUFF PRINTED                   
*                                                                               
         LA    R1,136(,RE)        PAST SAVED DCB                                
         L     RE,0(,R1)                                                        
         LA    RE,1(,RE)                                                        
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  REMOTSUB,DUB        FORCE NE PRINT QUEUE ENTRY                   
         ST    RE,0(,R1)                                                        
*                                                                               
PEREOF10 MVC   REMOTJID,=C'CWX'                                                 
*AR                                                                             
         MVI   REMOTFLG,X'FA'                                                   
         MVC   REMOTTY1,SVFAXARC                                                
         MVC   REMOTSYS(3),=C'NCG'                                              
         MVC   REMOTSUB,SPACES                                                  
         MVI   REMOTCPY,1                                                       
*        DROP  RF                                                               
         MVC   REMOTTY1,SVFAXARC                                                
*AR                                                                             
         MVC   REMOTDST,TWAORIG                                                 
         OC    TWADEST,TWADEST                                                  
         BZ    *+10                                                             
         MVC   REMOTDST,TWADEST                                                 
         MVI   REMOTCPY,1                                                       
         MVI   REMOTCLS,C'G'                                                    
*                                                                               
         GOTO1 OPENPQ                                                           
*AR                                                                             
         TM    WHEN,X'10'                                                       
         BZ    PRTEZ30                                                          
         L     RE,TWAMASTC                                                      
         XC    MCARC-MASTD(L'MCARC,RE),MCARC-MASTD(RE)                          
PRTEZ30  DS    0H                                                               
*AR                                                                             
         SR    R1,R1                                                            
         ST    R1,HEADHOOK         NO HEADHOOK                                  
         ST    R1,FOOTHOOK         OR FOOTHOOK                                  
         ST    R1,SPECS            OR SPECS                                     
*                                                                               
         MVI   LINE,99             FORCE NEW PAGE WITHOUT FORCEHED              
         MVC   PAGE,=H'1'          WHICH CAUSES FOOTLINES TO REPRINT            
*                                                                               
         CLI   SVTWPR06,C'2'       AGENCY COPY?                                 
         BE    *+12                 YES                                         
PRTEZ10  TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BZ    PRTEZ20              NO                                          
*                                                                               
* PRINT EASY COPY OF CABLE INTSTRUCTION                                         
*                                                                               
         BRAS  RE,GTSPL                                                         
         B     PRTEZ10                                                          
*                                                                               
PRTEZ20  MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
*                                                                               
         LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         DROP  R1                                                               
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
*                                                                               
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BZ    ENDPRT10                                                         
         CLI   DIRPRTSW,C'Y'                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*        MVC   REMOTKEY,MCREMOTE-MASTD(RE)                                      
         LA    R1,MCREMOTE-MASTD(,RE)                                           
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVC   REMOTJID,REMOTJID-REMOTED(R1)                                    
         MVC   REMOTDST,REMOTDST-REMOTED(R1)                                    
         MVC   REMOTCLS,REMOTCLS-REMOTED(R1)                                    
         MVC   REMOTCPY,REMOTCPY-REMOTED(R1)                                    
*AR                                                                             
         L     RE,TWAMASTC                                                      
         XC    MCARC-MASTD(L'MCARC,RE),MCARC-MASTD(RE)                          
         OC    REMOTKEY,REMOTKEY                                                
         BZ    ENDEZP30                                                         
         MVC   REMOTSYS(3),=C'NTB'                                              
         MVC   REMOTTY1,SVQLTYP1                                                
ENDEZP30 DS    0H                                                               
*AR                                                                             
         B     ENDPRT20                                                         
*                                                                               
* GO BACK TO LOCAL PRINT *                                                      
*                                                                               
ENDPRT10 XC    REMOTKEY,REMOTKEY FORCE BACK TO LOCAL PRINT                      
         DROP  RF                                                               
*                                                                               
ENDPRT20 GOTO1 OPENPQ                                                           
         B     PERX                                                             
*                                                                               
PER100   CLI   SVTWPR06,C'2'       WAS HARD COPY REQUESTED                      
         BNE   PER200               NO                                          
*                                                                               
         LTR   R7,R7               ONLY ERRORS - NO REAL REPORT                 
         BZ    PER200               YES, DON'T PUT OUT REQUEST                  
*                                                                               
         BAS   RE,AREQ             ADD REQUEST FOR AGENCY COPY                  
*                                                                               
PER200   TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    PERX                                                             
*                                                                               
* UNLOCK FOR SOON UPDATES                                                       
*                                                                               
         BRAS  RE,UNLOCK                                                        
*                                                                               
PERX     XIT1                                                                   
         EJECT                                                                  
* GENERATE OFFLINE OV REQUEST FOR HARD COPY *                                   
* PUT OUT FOR SOON REQUESTS WITH COPY ONLY  *                                   
*                                                                               
         DS    0H                                                               
AREQ     NTR1                                                                   
*                                                                               
         MVC   CONWHEN(2),=C'OV'                                                
         MVC   CONWHEN+2(L'CONWHEN-4),CONWHEN+4                                 
         MVI   CONWHEN+L'CONWHEN-1,C' '                                         
*                                                                               
         LLC   R2,TRAOPTH+5                                                     
         LA    R3,TRAOPT(R2)                                                    
         LR    R6,R3                                                            
         SR    R4,R4                                                            
*                                                                               
         LTR   R2,R2                                                            
         BZ    AREQ10                                                           
         MVI   0(R6),C','                                                       
         LA    R6,1(,R6)                                                        
         LA    R4,1                                                             
*                                                                               
AREQ10   MVI   0(R6),C'#'                                                       
         LA    R4,1(,R4)                                                        
         LA    RF,0(R2,R4)                                                      
         STC   RF,TRAOPTH+5                                                     
*                                                                               
         XC    REQHDR,REQHDR                                                    
         MVC   REQUEST,SPACES                                                   
         MVI   REQHDR+15,X'01'     GENERATE LINKED REQUESTS                     
         MVC   REQUEST(2),=C'TB'                                                
         MVC   REQUEST+2(2),AGENCY                                              
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   REQUEST+5(6),MCREQREC+5-MASTD(RE)                                
*                                                                               
         XC    REQSPOOK,REQSPOOK   NEED TO PASS A SPOOK                         
         GOTO1 REQTWA,DMCB,(0,ATWA),REQHDR,DATAMGR,RCCOMFAC,REQSPOOK            
*                                                                               
         MVC   WORK(L'CONWHEN-4),CONWHEN+2                                      
         MVC   CONWHEN+4(L'CONWHEN-4),WORK                                      
         MVC   CONWHEN(4),=C'SOON'                                              
         XC    CONHEAD,CONHEAD                                                  
*                                                                               
         EX    R4,NREQCLR                                                       
         STC   R2,TRAOPTH+5                                                     
         B     PERX                                                             
*                                                                               
NREQCLR  MVC   0(0,R3),SPACES                                                   
         EJECT                                                                  
* HEAD HOOK ROUTINE                                                             
*                                                                               
PERTBLE  DC    CL36'NET SEED NEVER RUN'                   1                     
         DC    CL36'NO PRODUCTS ALLOCATED TO UNITS      ' 2                     
         DC    CL36'NO COMMERCIALS ASSIGNED TO ANY UNITS' 3                     
         DC    CL36'ALL UNITS UNASSIGNED OR UNALLOCATED ' 4                     
         DC    CL36'SOME UNITS UNALLOCATED FOR PROGRAM  ' 5                     
         DC    CL36'SOME UNITS UNASSIGNED FOR PROGRAM   ' 6                     
         DC    CL36'POSITIONS ASSIGNED TO THIS PROGRAM'   7                     
         DC    CL36'BILLBOARDS THIS PROGRAM'              8                     
         DC    CL36'NET ASSIGN RUN FOR THIS PROGRAM'      9                     
         DC    CL36'EQUIV PROG-NO BASE COVERS THIS UNIT'  A                     
         DC    CL36'ALL UNITS MUST HAVE SAME TSUPP     '  B                     
         DC    CL36'TRI-BACK UNIT FOUND                '  B                     
XTYPE1   EQU   1                   NET SEED NEVER RUN                           
XTYPE2   EQU   2                   ALL UNITS UNALLOCATED                        
XTYPE3   EQU   3                   ALL UNITS UNASSIGNED                         
XTYPE4   EQU   4                   ALL UNITS UNASSIGNED/UNALLOCATED             
XTYPE5   EQU   5                   SOME UNITS UNALLOCATED                       
XTYPE6   EQU   6                   SOME UNITS UNASSIGNED                        
XTYPE7   EQU   7                   POSITIONS ASSIGNED TO THIS PROGRAM           
XTYPE8   EQU   8                   BILLBOARDS FOR THIS PROGRAM                  
XTYPE9   EQU   9                   NET ASSIGN RUN FOR THIS PROGRAM              
XTYPEA   EQU   10                  EQUIV PROG-THIS UNIT NOT COVERED             
XTYPEB   EQU   11                  TRAFFIC SUPPLIER ERROR                       
XTYPEC   EQU   12                  TRI-BACK UNITS FOUND ERROR                   
         EJECT                                                                  
         SPACE 2                                                                
*--------------------------                                                     
* HEAD HOOK ROUTINE                                                             
*--------------------------                                                     
*                                                                               
PHDHK    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LH    RE,SEQNUM          PRINT SEQUENCE NUMBER                         
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  H1+104(4),DUB                                                    
         LA    RE,1(RE)                                                         
         STH   RE,SEQNUM                                                        
*                                                                               
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BZ    *+10                                                             
         MVC   H4+85(16),=C'*** TEST RUN ***'                                   
*                                                                               
         MVC   H3+10(3),QCLT                                                    
         MVC   H3+15(20),CLTNM                                                  
*                                                                               
         MVC   H4+10(4),NETWORK                                                 
*                                                                               
         OC    SVTS,SVTS                                                        
         BZ    PHDHKX                                                           
         MVC   H5+2(16),=C'TRAFFIC SUPPLIER'                                    
         MVC   H5+20(L'SVTS),SVTS                                               
*                                                                               
         OC    SVCNAME,SVCNAME     CONTACT NAME                                 
         BZ    PHDHKX                                                           
         MVC   H6+2(7),=C'CONTACT'                                              
         MVC   H6+20(L'SVCNAME),SVCNAME                                         
*                                                                               
PHDHKX   XIT1                                                                   
         EJECT                                                                  
PHDG     SSPEC H1,3,AGYNAME                                                     
         SSPEC H2,3,AGYADD                                                      
         SSPEC H3,3,C'CLIENT'                                                   
         SSPEC H4,3,C'NETWORK'                                                  
         SSPEC H1,45,C'CABLE INSTRUCTIONS ERROR LISTING'                        
         SSPEC H2,45,C'--------------------------------'                        
         SSPEC H1,85,REPORT                                                     
         SSPEC H2,85,RUN                                                        
         SSPEC H3,85,PAGE                                                       
         SSPEC H6,03,C'PROGRAM-NAME'                                            
         SSPEC H7,03,C'-------------'                                           
         SSPEC H6,32,C'DAY      TIME'                                           
         SSPEC H7,32,C'----     -----'                                          
         SSPEC H6,52,C'UNITS  FEEDS'                                            
         SSPEC H7,52,C'-----  -----'                                            
         SSPEC H6,66,C'PERIOD              REASON'                              
         SSPEC H7,66,C'-----------------   ------------------'                  
         DC    X'00'                                                            
         EJECT                                                                  
ERREPT   DCB   BLKSIZE=3800,                                           X        
               DDNAME=ERRFILE,                                         X        
               DSORG=PS,                                               X        
               EODAD=PEREOF,                                           X        
               LRECL=38,                                               X        
               MACRF=GM,                                               X        
               RECFM=FB                                                         
         LTORG                                                                  
         EJECT                                                                  
*** BASELESS CODE                                                               
         SPACE 2                                                                
* FIND PRODUCT NAME *                                                           
*                                                                               
FPROD    CLI   0(RF),0             UNALLOCATED                                  
         JNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R0,NCLSTSIZ         MAX COUNT BUG CATCHER                        
         L     R1,ASVNCLST         TABLE OF CLIENT PROD CODES                   
FPROD02  CLC   0(1,RF),3(R1)       THIS A VALID PROD CODE                       
         JE    FPROD06                                                          
         LA    R1,4(,R1)           BUMP PROD PTR                                
         CLI   0(R1),C' '          AT END OF TABLE?                             
         JNH   FPROD04             YES                                          
         JCT   R0,FPROD02                                                       
FPROD04  DC    H'0'                SEE IF BRAND LEVEL SEC PROBLEM ??            
FPROD06  MVC   QPRD,0(R1)                                                       
         BR    RE                                                               
         EJECT                                                                  
*                                                                               
         GETEL R6,DATADISP,ELCODE                                               
*                                                                               
INITNET  MVI   LKEY+1,20                                                        
         MVI   DATADISP+1,27                                                    
         MVI   LSTATUS+1,1                                                      
*                                                                               
*NOTE MVC  SYSDIR(3),=C'UNT'       FUN WITH BRAS                                
         BRAS  RF,*+8                                                           
         DC    CL4'UNT '           4 CHARS TO KEEP ALIGNMENT!                   
         MVC   SYSDIR(3),0(RF)                                                  
         MVC   SYSFIL(3),0(RF)                                                  
         BR    RE                                                               
*                                                                               
INITSPT  MVI   LKEY+1,13                                                        
         MVI   DATADISP+1,24                                                    
         MVI   LSTATUS+1,1                                                      
         BRAS  RF,*+8                                                           
         DC    CL4'SPT '                                                        
         MVC   SYSDIR(3),0(RF)                                                  
         MVC   SYSFIL(3),0(RF)                                                  
         BR    RE                                                               
*                                                                               
* RESET FILES TO XFILE *                                                        
*                                                                               
INITXSP  MVI   DATADISP+1,42       SET FROM SPOT TO XSP                         
         MVI   LKEY+1,32                                                        
         MVI   LSTATUS+1,4                                                      
         BRAS  RF,*+8                                                           
         DC    CL4'XSP '                                                        
         MVC   SYSDIR(3),0(RF)                                                  
         MVC   SYSFIL(3),0(RF)                                                  
         BR    RE                                                               
         EJECT                                                                  
         LTORG                                                                  
TABSAV   DS    0H                                                               
OPTPGRL  DS    500CL3                                                           
OPTPGRLQ EQU   (*-OPTPGRL)/3                                                    
TABSAVL  EQU   *-TABSAV                                                         
         TITLE 'T21663 - NETWORK CABLE TRAFFIC INST - RECORD DSECTS'            
         PRINT OFF                                                              
         EJECT                                                                  
       ++INCLUDE NEGENUNIT                                                      
         EJECT                                                                  
       ++INCLUDE SPTRNREV                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNPGRP                                                      
         EJECT                                                                  
       ++INCLUDE SPTRNTSUPP                                                     
         EJECT                                                                  
       ++INCLUDE SPTRNPAT                                                       
       ++INCLUDE SPTRCMLTXT                                                     
         EJECT                                                                  
CLTHDRD  DSECT                                                                  
       ++INCLUDE SPGENCLT                                                       
         EJECT                                                                  
ESTHDRD  DSECT                                                                  
       ++INCLUDE SPGENEST                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNCLT                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNPRD                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNPRG                                                       
         EJECT                                                                  
STARECD  DSECT                                                                  
       ++INCLUDE SPGENSTA                                                       
         EJECT                                                                  
MKTRECD  DSECT                                                                  
       ++INCLUDE SPGENMKT                                                       
         EJECT                                                                  
PRDHDRD  DSECT                                                                  
       ++INCLUDE SPGENPRD                                                       
         EJECT                                                                  
       ++INCLUDE SPGENPROG                                                      
         EJECT                                                                  
       ++INCLUDE SPTRCMML                                                       
         EJECT                                                                  
       ++INCLUDE SPTRDTXT                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNCMT                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNEQPRG                                                     
         TITLE 'T21663 - NETWORK CABLE TRAFFIC INST - WORK DSECTS'              
       ++INCLUDE DDSPOOLD                                                       
       ++INCLUDE DMPRTQL                                                        
       ++INCLUDE DDREPMASTD                                                     
       ++INCLUDE DDREMOTED                                                      
       ++INCLUDE DDCOMFACS                                                      
       ++INCLUDE FAFACTS                                                        
       ++INCLUDE DDTSARD                                                        
       ++INCLUDE FASSB                                                          
         EJECT                                                                  
       ++INCLUDE DDSPLWORKD                                                     
         EJECT                                                                  
NETBLCKD   DSECT                                                                
       ++INCLUDE NETBLOCKN                                                      
TWADCOND DSECT                                                                  
       ++INCLUDE DDTWADCONS                                                     
       ++INCLUDE SPTRAFFD                                                       
         ORG   CONTAGH                                                          
         PRINT ON                                                               
         EJECT                                                                  
       ++INCLUDE SPTRA73D                                                       
         PRINT OFF                                                              
         EJECT                                                                  
       ++INCLUDE DDGENTWA                                                       
         EJECT                                                                  
       ++INCLUDE SPTRAWORKD                                                     
         PRINT ON                                                               
         EJECT                                                                  
NEXTLINE EQU   TRASEL2H-TRASEL1H                                                
*                                                                               
* SVPRDLST ENTRY IS 3 BYTE PRD CODE, THEN WHEN LIST PROCESSED,                  
* 4 BYTE DISK ADDR, 1 BYTE LEN OF COPY NAMES IN EACH REC                        
*                                                                               
SVPRDLEN EQU   480/5                                                            
SVPRDENT EQU   5                                                                
*                                                                               
SYSD     DSECT                                                                  
         ORG   SVSPAREX                                                         
AOPTPGRL DS    A                                                                
SPTR63RR DS    A                                                                
APQPROF  DS    A                                                                
AERRFILE DS    A                                                                
ASVSTOR  DS    A                                                                
VGTBROAD DS    A                                                                
VTRPACK  DS    A                                                                
APRGTBLE DS    A                                                                
NXTPRG   DS    A                                                                
MXPRGTBL DS    A                                                                
APATABLE DS    A                                                                
MAXPATBL DS    A                                                                
ALLPRTAB DS    A                   ALL PROGRAM TABLE                            
MAXPRTAB DS    A                   END OF ALL PROGRAM TABLE                     
ANETIO   DS    A                                                                
ACMLTAB  DS    A                   A(COMMERCIAL) TABLE FOR BINSRCH              
ASVFTNT  DS    A                                                                
NEXTADDR DS    A                                                                
ASVPRINT DS    A                                                                
ASVNOBP  DS    A                                                                
ASVCPYLS DS    A                                                                
ASVNEXT  DS    A                   1ST TABLE ENTRY ON NEXT SCREEN               
TSAROFF  DS    A                   TSAROFF CORE RESIDENT T00A7D                 
APCPY    DS    A                   ADDRESS OF PRINT LINES FOR COPIES TO         
*                                                                               
TSARBUFL DS    A(L'ELEM*5000)     BUFFER LENGTH FOR 600 RECORDS                 
TSARBUFF DS    A                   ADDRESS OF GETMAIN BUFFER                    
TSARBYTE DS    F                   CT OF TSAR BYTE SENT                         
TSARLAST DS    H                   LAST TSAR RECORD NUMBER                      
TSRKEYF  DS    H                   SAVE FIRST TSAR KEY NUMBER                   
TSRKEYL  DS    H                     AND LAST                                   
PRTCT    DS    H                   CT OF PRINT LINES SAVED                      
TUCOUNT  DS    H                   TOTAL UNIT COUNT                             
PBYTE    DS    CL1                 DOING PERCENTAGES                            
NXTALPHA DS    XL1                 SAVE DISPLACEMENT INTO ALPHA TABLE           
*                                                                               
* SAVED STORAGE (TWA 2) STARTS HERE *                                           
*                                                                               
PTTNCTR  DS    F                                                                
SVTHIS   DS    F                                                                
SVTWPROF DS    CL16                                                             
SVTWPR06 EQU   SVTWPROF+5                                                       
SVTWPR11 EQU   SVTWPROF+10                                                      
*                                                                               
*AR                                                                             
PROFKEY  DS    CL5                 READ PROGRAM PROFLIE RECORD                  
SVQLTYP1 DS    CL1                 STORE ARCHIVE SETTING FOR SOON               
SVFAXARC DS    CL1                 ARCHIVE FOR FAX COPIES                       
SVMCARC  DS    CL(L'MCARC)                                                      
*AR                                                                             
SEQNUM   DS    H                                                                
SVMEDIA  DS    C                   SAVE MEDIA                                   
SVNET    DS    CL4                 SAVE THIS NETWORK (FOR NET=ALL)              
SVCMCLTN DS    CL20                SAVE CLIENT CMML NO.                         
MYTN2PRE DS    CL1                 PRINT CLT CML #                              
MYTN2PR6 DS    CL1                 SAVE CAL/BROAD/WEEKLY                        
SVTN3PR3 DS    CL1                 TN3 PROF 3 CML RUN TIME                      
SVPROG   DS    CL6                                                              
SVPROGNM DS    CL16                                                             
SVPROGDT DS    XL2                                                              
SVCMLCOD DS    CL8                                                              
SVCMLADI DS    CL12                                                             
SVCMLADR DS    CL12                                                             
SVHIDEF  DS    CL12                HIDEF                                        
SVCNTRC  DS    CL12                CENTER CUT                                   
SVADISCI DS    CL12                UNPACKED 8-12 CHAR ADID-ISCII                
SVCMLLEN DS    XL1                                                              
SVCMLOVR DS    XL2                 SAVE CMLOVRD1 & CMLOVRD2                     
SVCTCMLR DS    CL20                SAVE CLIENT CMML NO. ROTATION                
SVPRD    DS    CL3                 SAVE PROD                                    
*                                                                               
* KEEP DESC LINES TOGETHER AND IN ORDER                                         
SVCMLDS  DS    CL24                COMMERCIAL EXT DESC 1                        
SVCMLDS2 DS    CL24                COMMERCIAL EXT DESC 2                        
SVCMLDS3 DS    CL24                COMMERCIAL EXT DESC 3                        
SVFAXTL  DS    CL24                CONTACT FAX FORM CLIENT LIST REC             
SVISNMTE DS   0CL54                                                             
SVISNAME DS    CL30                                                             
SVISTEL  DS    CL24                                                             
SVEMAIL  DS    CL40                E-MAIL ADDRESS                               
*                                                                               
SVNETREV DS    CL1                 SAVE HIGHEST NETWORK REV #                   
OREVNUM  DS    XL1                 REVISION FOR THE OTHER PERIOD                
OREVNN   DS    XL1                 NET REV FOR THE OTHER PERIOD                 
*                                                                               
SVLOCK   DS    CL8                 SAVE LOCK INFO FOR UNLOCK                    
SVSVPROD DS    CL3                 SAVE PROD LOCK INFO FOR UNLOCK               
SVCPROD  DS    CL3                 3 CHAR PROD FOR LOCKING                      
*                                                                               
FLDH     DS    CL8                                                              
FLD      DS    CL40                                                             
*                                                                               
SVSFAX   DS   4CL12                NETWORK FAX - FROM STATION RECORD            
*                                          OR DAYPART RECORD (MAX 4)            
SVFAXNXT DS    F                   SAVE ADDRESS OF THIS FAX                     
*                                                                               
SVSMKT   DS    CL4                 MARKET CODE                                  
SVMKTNM  DS    CL24                MARKET NAME FROM MARKET RECORD               
SVPRGPRG DS    CL6                                                              
SVDPC    DS    CL1                                                              
SVNETADR DS    CL30                                                             
SVPATDTE DS    XL2                                                              
BLPATCOM DS   0CL(L'PATCOM)                                                     
BLPATENT DS    CL(L'PATENT)        BUILD PATTERN ENTRY AREA                     
WPATENT  DS    CL(L'PATENT)        WORK PATTERN ENTRY AREA                      
SVPRGNAM DS    CL24                SAVED PRODUCT GROUP NAME                     
SVPRDNAM DS    CL20                SAVED PRODUCT NAME                           
SVCSPRD  DS    6CL3                SAVED PRODS FOR COPY SPLIT                   
SVCSPRDQ EQU   (*-SVCSPRD)/3                                                    
*                                                                               
BASEPRG  DS    CL6                                                              
BASEDTS  DS   0XL4                                                              
BASESTR  DS    XL2                                                              
BASEEND  DS    XL2                                                              
BASECT   DS    XL1                                                              
*                                                                               
STDATE   DS    CL6                                                              
ENDATE   DS    CL6                                                              
PERDTS   DS    0CL12                                                            
PSTDATE  DS    CL6                 PRINTABLE START DATE (YR2000)                
PENDATE  DS    CL6                           END DATE                           
FOOTSW   DS    C                                                                
FRSTPGSW DS    C                                                                
CONTINUE DS    C                                                                
HEADSW   DS    C                                                                
REQSW    DS    C                                                                
DIRPRTSW DS    C                   Y IF PRINTING DIRECT                         
*                                                                               
* FROM VPER RTN - PERIOD FIELD IN HEADING ON SCREEN                             
*                                                                               
WKDATEP  DS    XL2                 SAVED START DATE FOR WEEKLY INSTR            
STDATEP  DS    XL2                                                              
ENDATEP  DS    XL2                                                              
PERIOD   DS    XL3                                                              
         EJECT                                                                  
NETMKT   DS    H                                                                
NETWORK  DS    CL4                 KEEP NETWORK/PROGRAM TOGETHER                
PROGRAM  DS    CL6                     AND IN ORDER                             
INSPRTSW DS    CL1                                                              
PGROUP   DS    XL3                                                              
*                                                                               
ANYFLAG  DS    XL1                                                              
TABLESW  EQU   X'80'               TABLE IS BUILT                               
NETFOUND EQU   X'40'               AN LEAST ONE NETWORK FOUND                   
TRIFOUND EQU   X'20'               TRI-BACK UNIT FOUND                          
COPYSSW  EQU   X'10'               COPY SPLIT PRESENT                           
CLTCMLNO EQU   X'08'               JUST GET CLT CML #                           
PBCMLSW  EQU   X'04'               1 CML COVERS BOTH PROD                       
BLNKLN   EQU   X'02'               BLANK LINE PRINTED                           
PIGGBSW  EQU   X'01'               PIGGYBACKS PRESENT                           
*                                                                               
UPDSW    DS    CL1               80 PRINTED ORG/REV # FOR CMTS                  
*                                40 END OF UNITS IN BLPRG                       
*                                20 PRINTING UNITS, PRT MIDLNS IN HDHK          
*                                10 INSTR PRINTED FOR PROGRAM SEND DIP          
*                                08 DO GETREC IN PCMT RTN                       
MULTIFAX EQU   X'04'             04 MULTI-FAX PROGRAM SWITCH                    
*                                02 ONLY SKED UNITS FOUND IN BLUNT              
*                                   RTN - NO SORT OF UNITS                      
*                                01 AT LEAST ONE PROGRAM SELECTED FOR           
*                                   INSTRUCTIONS                                
*                    X'FF' NO UNTS FOUND BYPASS THIS NET (FOR NET=ALL)          
         DS   0D                                                                
QUESTOR  DS    CL16                                                             
QPGR     DS    CL4                                                              
MYKEYSV  DS    CL(L'KEYSAVE)                                                    
SVLGKEY  DS    CL(L'KEYSAVE)                                                    
*                                                                               
OPTIONS  DS    0CL(OPTX-SVOPTSW)                                                
*                                                                               
SVOPTSW  DS    XL1                                                              
*                                                                               
OPTTEST  EQU   X'80'              NO UPDATES TO DISK FILES                      
OPTSEED  EQU   X'40'              ALLOW REQ SINCE SEED IS REQUESTED             
OPTREV   EQU   X'20'              RUN ANY REVISIONS NOT YET RUN                 
OPTNEW   EQU   X'10'              RUN ONLY ORIGINALS                            
OPTUNAS  EQU   X'08'              ALLOW FOR UNASSIGNED                          
OPTUNAL  EQU   X'04'              ALLOW FOR UNALLOCATED                         
OPTNAGY  EQU   X'02'              DON'T PRINT AGENCY NAME & ADDRESS             
OPTNOAOR EQU   X'01'              DON'T PRINT AGENCY OF RECORD N & A            
*                                                                               
SVOPTSW1 DS    XL1                                                              
*                                                                               
OPT1EACH EQU   X'80'                                                            
OPTHDCPY EQU   X'40'                                                            
USEDEF   EQU   X'20'               PRINT A DEFAULT COMMENT                      
PRNTDCMT EQU   X'10'               COMMENTS HAVE BEEN PRINTED                   
OPTTS    EQU   X'08'               TRAFFIC SUPPLIER                             
OPTNTS   EQU   X'04'               NON-TRAFFIC SUPPLIER                         
OPTNETS  EQU   X'02'               ALL NETWORKS REQUEST                         
OPTPER   EQU   X'01'               OVERRRIDE PERIOD (TN2PR6)                    
*                                                                               
OPTDATE  DS    XL2                                                              
OPTPROD  DS    CL3                                                              
OPTPRD   DS    XL1                                                              
OPTPRGR  DS    XL2                                                              
OPTIONE  EQU   *                                                                
TMPSTSW  DS    CL1                                                              
*                                                                               
*                                                                               
*                                                                               
SVCNAME  DS    CL30                SAVE TRAFFIC SUPPLIER CONTACT NAME           
SVTS     DS    CL5                 SAVE TRAFFIC SUPPLIER                        
SVTSLEN  DS    CL1                 TSUPP ENTRY LEN                              
SVOPTTS  DS    CL5                 SAVE TSUPP ENTERED IN OPTION FIELD           
SVOTSLEN DS    CL1                 AND ITS LENGTH                               
*                                                                               
SVOPTMED DS    CL3                 MEDIA (FOR ALL NETWORKS REQUEST)             
*                                                                               
SVFLAG   DS    XL1                                                              
*                                                                               
SVFLGTS  EQU   X'80'               OUTSIDE TRAFFIC SUPPLIER FOUND               
SVFLGNTS EQU   X'40'               NON-TRAFFIC SUPPLIER FOUND                   
SVTSERR  EQU   X'20'               TRAFFIC SUPPLIER ERROR                       
SVPRGERR EQU   X'10'               AT LEAST ONE ERROR FOUND                     
SVFLGFDD EQU   X'08'               FEED NO NATIONAL                             
ENTDEL   EQU   X'04'               ENTRY DELETED                                
SVTAG    EQU   X'02'               THERE ARE TAGS ON INSTR                      
SEEMORFL EQU   X'01'               SEE ADDITIONAL CML INFO MESSAGE              
*                                                                               
OPTX     EQU   *                   END OF OPTIONS                               
*                                                                               
SVDATES DS     XL6                 SAVE UNCOVERED DATES                         
SVDLDSK DS     XL4                 SAVE DIST LIST DISK ADDR                     
*                                                                               
BINDMCB  DS    6F                                                               
*                                                                               
         DS    0D                                                               
EQVPTBL  DS    XL(30*L'EQVENT)     EQUIVALENT PROGRAM TABLE                     
*                                                                               
* PATTERN TABLE                                                                 
*                                                                               
         DS    0D                                                               
PATABLE  DS    XL(130*L'PATENT)    ROOM FOR 130 ENTRIES                         
*                                                                               
ENDPATBL EQU   *                                                                
         DS    0D                                                               
TSARBLK  DS    CL(TSARDL2)                                                      
*                                                                               
         DS    0D                                                               
PRGTABLE DS    XL(85*L'PRGENT)     PROGRAM TABLE  !!! BE CAREFUL !!!            
PRGTBLX  EQU   *                   !!!! MUST BE @ END OF SYSD !!!               
*                                                                               
ENDSYSD  EQU   *       IF THIS ADDRESS MORE THAN 2F08, PAST END OF SYSD         
*                                                                               
* LIST OF ALL PROG PATTERNS SEE ALLPRGD FOR ENTRY LAYOUT *                      
*                                                                               
ALLPRGLS DS    0D                                                               
         EJECT                                                                  
* DSECT FOR PROGRAM TABLE LIST ENTRIES *                                        
*                                                                               
PRGTABLD DSECT                                                                  
PRGENT   DS    0CL28                                                            
PRGPRG   DS    CL6                PROGRAM                                       
PRGUNITS DS    XL2                TOTAL UNITS                                   
PRGFEEDS DS    XL2                TOTAL FEEDS                                   
PRGUNAS  DS    XL2                TOTAL UNITS UNASSIGNED (NO CMLS)              
PRGUNAL  DS    XL2                TOTAL UNITS UNALLOCATED (NO PRD)              
PRGIDTE  DS    XL3                LAST INSTR DATE                               
PRGCREVN DS    XL1                CURRENT REVISION NUMBER                       
PRGCREVD DS    XL2                CURRENT REVISION DATE                         
PRGHIDTE DS    XL2                HIGHEST DATE FOR PROGRAM                      
PRGFLG   DS    XL1                80 - NO PROGRAM FOR THIS PERIOD               
PRGXCLUD EQU   X'40'              40 -                                          
*                                 20 - INSTR WERE PRINTED FOR THIS              
*                                       REVISION NUMBER                         
*                                 10 - PROG SELECTED, RUN INSTR                 
*                                 08 - NET ASSIGN RUN FOR THIS PROG             
*                                      SINCE NET SEED                           
*                                 04 - POSITIONS ASSIGNED THIS PROG             
*                                 02 - BILLBOARDS ASSIGNED THIS PROG            
*                                 01 - NET ASSIGN LAST RUN                      
PRGNREVN DS    XL1                NETWORK REVISION NUMBER                       
PRGCOST  DS    XL4                TOTAL COST FOR ALL UNITS THIS PROGRAM         
PRGNEXT  EQU   *                                                                
         SPACE 3                                                                
* DSECT FOR EQUIVALENT PROGRAM CODE ENTRIES                                     
*                                                                               
EQVPTBLD DSECT                                                                  
EQVENT   DS   0CL(EQVNEXT-EQVEPRG)                                              
EQVEPRG  DS    CL6                EQUIVALENT                                    
EQVBPRG  DS    CL6                BASE PROGRAM CODE                             
EQVSDT   DS    XL2                START DATE                                    
EQVEDT   DS    XL2                END                                           
EQVSMODT DS    XL2                START PERIOD DATE                             
EQVEMODT DS    XL2                END                                           
EQVUSED  DS    XL1                                                              
EQVCT    DS    XL1                ENTRY COUNTER                                 
EQVNEXT  EQU   *                                                                
         EJECT                                                                  
* DSECT FOR UNIT ACTIVITY LIST ENTRIES *                                        
*                                                                               
PATABLED DSECT                                                                  
PATENT   DS    0CL(PATNEXT-PATPROG)  WAS 36                                     
PATCOM   DS    0CL(PATSTR-PATPROG)   WAS 22                                     
PATSORT  DS    0CL(PATSEQ-PATPROG)   WAS 20                                     
PATPROG  DS    CL6                PROGRAM (BLANK IF ALL)                        
PATPROD1 DS    XL3                PRODUCT                                       
PATSLN   DS    XL1                UNIT LENGTH                                   
PATPROD2 DS    XL3                PARTNER PRODUCT                               
PATSLN2  DS    XL1                UNIT LENGTH                                   
PATFEED  DS    CL4                FEED                                          
PATDP    DS    CL1                DAYPART                                       
PATKEY   DS    XL1                SAME AS NUCMLKEY (CHGED VALUES BELOW)         
PATKFD   EQU   X'01'               01 = FEED SPEC                               
PATKDP   EQU   X'02'               02 = D/P SPEC                                
PATKPRG  EQU   X'04'               04 = PROG SPEC                               
PATKMED  EQU   X'08'               08 = MEDIA SPEC                              
PATKALL  EQU   X'10'               10 = ALL NETWORKS PATTERN                    
*                END OF PATSORT                                                 
PATSEQ   DS    XL2                 WAS REF, NOW SEQ NO                          
*                END OF PATCOM                                                  
PATSTR   DS    XL2                 START/END FROM UNITS (WITH ROTATION)         
PATEND   DS    XL2                                                              
PATPSTR  DS    XL2                 PATTERN ACTUAL START/END DATES               
PATPEND  DS    XL2                                                              
PATFLG   DS    XL1                80 - 80/40/20 ON IN NUCMLFLG                  
*                                 40 - DELETED UNIT                             
*                                 20 - INSTR RUN ON DELETED UNIT                
*                                 10 - TRAFFIC DELETED UNIT                     
*                                 08 - FEED TO NATIONAL UNIT                    
PATFLFDD EQU   X'04'              04 - FEED NO NATIONAL                         
*                                 02 - MISSED                                   
*                                 01 - MEDIA ORIGINATED FEED                    
PATUNTCT DS    XL2                                                              
*                                  PRGLS ONLY USED FOR ALL PROG PTTNS           
PATFLG2  DS    XL1                                                              
PATUSED  EQU   X'80'               PATTERN USED                                 
TAGFLG   EQU   X'40'               THERE ARE TAGS                               
PATDONE  EQU   X'20'               DONE THIS PATTERN                            
NOPAT    EQU   X'02'               DO NOT ADD TO PATTERN TABLE                  
OOPS     EQU   X'01'               ETHER PAT NO BUYS                            
*                                  OR BUYS NO LONGER COVERED BY PAT             
PATREF   DS    XL2                 FIRST REF, USED TO GET SEQ                   
PATNEXT  EQU   *                                                                
         EJECT                                                                  
* DSECT FOR ALL PROGRAM LIST (PROGRAMS  COVERED BY A PATTERN) *                 
*                                                                               
ALLPRGD  DSECT                                                                  
ALLPGENT DS   0XL(ALLPGNXT-ALLPGP1)                                             
ALLPGCMP DS   0XL(ALLPGLDT-ALLPGP1) COMMON                                      
ALLPGSRT DS   0XL(ALLPGKEY-ALLPGP1) SORT KEY LENGTH                             
ALLPGP1  DS    XL3                 PROD                                         
ALLPGP2  DS    XL3                 PARTNER                                      
ALLPGS1  DS    XL1                 LEN                                          
ALLPGS2  DS    XL1                 PTR LEN                                      
ALLPGSEQ DS    XL2                 PAT REF - NOW SEQ #                          
ALLPGKEY DS    XL1                 FROM PATKEY TO DIFFERENTIATE                 
ALLPGFD  DS    CL4                 FEED                                         
ALLPGDP  DS    CL1                 DAYPART CODE                                 
ALLPGPRG DS    CL6                 PROGRAM                                      
ALLPGLDT DS    XL2                 LOW AND                                      
ALLPGHDT DS    XL2                 HIGH DATES FOR THIS PROG                     
ALLPGCNT DS    XL2                 UNIT COUNT                                   
ALLPGNXT EQU   *                                                                
         EJECT                                                                  
* ADDITION COMMERCIAL INFORMATION DSECT                                         
*                                                                               
CMLCMLD  DSECT                                                                  
CMLCML   DS    CL12                COMMERCIAL                                   
CMLTYP   DS    CL4                 TYPE                                         
CMLDDT   DS    XL3                 DESTROY DATE                                 
CMLDTM   DS    XL2                 DESTROY TIME                                 
CMLPRD   DS    CL3                 PRODUCT                                      
CMLTXT   DS    XL1                 COMTEXT FLAG                                 
CMLCML8  DS    CL8                 COMMERCIAL 8 CHAR ISCII                      
CMLNXT   EQU   *-CMLCML                                                         
         EJECT                                                                  
* DSECT FOR NETWORK COMMERCIAL INSTRUCTIONS ERROR LIST *                        
*                                                                               
XRECD    DSECT                                                                  
XREC     DS    0XL38                                                            
*                                                                               
XBAGYMD  DS    XL1                                                              
XCLT     DS    CL2                 CLIENT                                       
XNET     DS    CL4                 NETWORK                                      
XNETMKT  DS    XL2                 NETWORK MARKET                               
XPROG    DS    CL6                 PROGRAM                                      
XTUNT    DS    XL2                 TOTAL UNITS                                  
XFEEDS   DS    XL2                 FEEDS                                        
XUNAS    DS    XL2                 UNASSIGNED UNITS                             
XUNAL    DS    XL2                 UNALLOCATED UNITS                            
XPERST   DS    CL6                                                              
XPERND   DS    CL6                                                              
XREVN    DS    XL2                                                              
XTYPE    DS    CL1                 1=NET SEED/ASSIGN NEVER RUN                  
*                                  2=ALL UNALLOCATED UNITS                      
*                                  3=NO COMMERCIALS ASSIGNED                    
*                                  4=ALL UNITS UNASSIGNED/UNALLOCATED           
*                                  5=SOME UNALLOCATED UNITS                     
*                                  6=SOME UNASSIGNED UNITS                      
*                                  7=EQUIVALENT PROG CODE NOT COVERED           
*                                                                               
GEND     DSECT                                                                  
         ORG   ELEM                                                             
REQHDR   DS    CL26                                                             
REQUEST  DS    CL80                                                             
REQUEST2 DS    CL80                                                             
REQSPOOK DS    CL64                                                             
         EJECT                                                                  
* ONLINE LIST                                                                   
*                                                                               
LSTLINE  DSECT                                                                  
         DS    CL8                 FIELD HEADER                                 
LPROG    DS    CL6                                                              
         DS    CL3                                                              
LCUREVDT DS    CL8                                                              
         DS    C                                                                
LCUREVNO DS    CL3                                                              
         DS    C                                                                
LPREVDT  DS    CL8                                                              
         DS    C                                                                
LPREVNO  DS    CL3                                                              
         DS    CL2                                                              
LUNITS   DS    CL4                                                              
         DS    CL1                                                              
LFEEDS   DS    CL3                                                              
         DS    CL2                                                              
LUNASUNT DS    CL4                                                              
         DS    CL1                                                              
LUNALUNT DS    CL3                                                              
         DS    CL1                                                              
LPRTID   DS   0CL20                                                             
         DS    CL4                                                              
LNREVNO  DS    CL3                                                              
         SPACE 2                                                                
* DSECT FOR PRINT LINE DATA *                                                   
*                                                                               
PRTLINE  DSECT                                                                  
         ORG   PRTLINE                                                          
         DS    CL2    1 -  2      *NEW LAYOUT                                   
PPROG    DS   0CL16                                                             
PFEED    DS    CL10   3 - 12      FEED= AAAA                                    
         DS    CL1   13                                                         
PFEEDNM  DS    CL60  14 - 73      FEED NAME                                     
         ORG   PRTLINE                                                          
         DS    CL2    1 -  2                                                    
PPROD    DS    CL8    3 - 10      PRD= AAA                                      
         DS    CL1   11                                                         
PPRDNM   DS    CL20  12 - 31      PROD NAME                                     
         ORG   PRTLINE                                                          
         DS    CL2    1 -  2                                                    
PSLN     DS    CL15   3 -  12     LEN= 30 (13/17)                               
         DS    CL3   13 - 15                                                    
PPCT     DS    CL7   16 - 22      '100 PCT'                                     
         ORG   PPCT+4                                                           
PLROT    DS    CL3   20 - 22       LETTER ROTATION (A)                          
         DS    CL2   23 - 24                                                    
PCML     DS    CL12  25 - 36                                                    
         DS    CL3   37 - 39                                                    
PCMLTL   DS    CL24  40 - 63                                                    
         DS    CL1   64                                                         
PCLTCML  DS   0CL29  65                                                         
PHIDEF   DS   0CL21  65                                                         
PCNTRC   DS   0CL21  65                                                         
POTHER   DS    CL29  65 - 93                                                    
         DS    CL1   94                                                         
PCMLRUN  DS    CL21  95 - 115                                                   
                                                                                
*---------------------------                                                    
* PRINT ADDITIONAL CML INFO                                                     
*---------------------------                                                    
         ORG   PRTLINE                                                          
*                                                                               
         DS    CL2    1 -  2                                                    
PACMML   DS    CL12   3 -                                                       
         DS    CL5   19                                                         
PACMTXT  DS   0CL61  20                                                         
PATYPE   DS    CL9   20 - 23                                                    
         DS    CL5   24                                                         
PADDTE   DS    CL41  25 - 33     DESTROY DATE AND TIME                          
*        DS    CL3   34 - 36                                                    
*PROD    DS    CL3   37 - 39                                                    
*                                                                               
*---------------------------------------                                        
* PRINT PROGRAMS COVERED IN 2 COLUMNS                                           
*---------------------------------------                                        
         ORG   PRTLINE                                                          
*                                                                               
         DS    CL2    1 -  2                                                    
PCPROGN  DS    CL18   3 - 20       PROGRAM NAME                                 
         DS    CL2   21 - 22                                                    
PCPROG   DS    CL6   23 - 28       PROPGRAM CODE                                
         DS    CL1   29                                                         
PCUNT    DS    CL13  30 - 42       UNIT COUNT INFO                              
         DS    CL6   43 - 48                                                    
PCPROGN1 DS    CL18  49 - 66       SAME AS ABOVE BUT COLUMN 2                   
         DS    CL2   67 - 68                                                    
         DS    CL6   69 - 74                                                    
         DS    CL1   75                                                         
         DS    CL13  76 - 88                                                    
         EJECT                                                                  
* DSECT FOR EDI                                                                 
*                                                                               
SPOOLD   DSECT                                                                  
* LABELS FOR NETWORK COMMERCIAL INSTRUCTIONS ERROR LIST *                       
*                                                                               
         ORG   P                                                                
         DS    CL2                                                              
XPPROG   DS    CL6                 PROGRAM                                      
         DS    CL2                                                              
XPPROGNM DS    CL16                PROGRAM NAME                                 
         DS    CL5                                                              
XPPROGDA DS    CL8                 PROGRAM DAY                                  
         DS    CL1                                                              
XPPROGTM DS    CL11                PROGRAM TIME                                 
         DS    CL1                                                              
XPUNITS  DS    CL5                 PROGRAM UNITS                                
         DS    CL1                                                              
XPFEEDS  DS    CL5                 PROGRAM FEEDS                                
         DS    CL2                                                              
XPPERIOD DS    CL17                PRINT PERIOD                                 
         DS    CL3                                                              
XPEXPLAN DS    CL1                 PRINT REASON                                 
*                                                                               
         ORG   P                                                                
*                                                                               
       ++INCLUDE EDIDESTD                                                       
*                                                                               
         ORG   P                                                                
*                                                                               
       ++INCLUDE EDIDDSHD                                                       
       ++INCLUDE EDILINKD                                                       
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'175SPTRA63   02/22/10'                                      
         END                                                                    
