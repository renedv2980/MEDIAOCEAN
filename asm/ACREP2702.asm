*          DATA SET ACREP2702  AT LEVEL 072 AS OF 04/20/16                      
*$PANAPT01S$ *******  FIRST LINE TO DELETE  *****************                   
*                                                           *                   
*  ATTN: THE LEVEL STAMPS ARE *LEGITIMATELY* OUT-OF-SYNC!   *                   
*        DELETE THIS COMMENT BLOCK ON THE NEXT PROMOTION!   *                   
*                                                           *                   
*  THIS SOURCE MODULE IS AT A HIGHER LEVEL NUMBER THAN ITS  *                   
*  CORRESPONDING LOAD OR OBJECT MODULE, BECAUSE THE MEMBER  *                   
*  WAS PROMOTED USING THE SRCE LIBCODE VIA MR# 046722.      *                   
*                                                           *                   
*  THIS COMMENT BLOCK WAS INSERTED *PROGRAMMATICALLY* BY    *                   
*  PANAPT, TO EXPLAIN WHY THE LEVEL STAMPS ARE OUT-OF-SYNC. *                   
*  BEFORE THIS MEMBER CAN BE PROMOTED AGAIN, THIS ENTIRE    *                   
*  COMMENT BLOCK *MUST* BE MANUALLY DELETED.                *                   
*                                                           *                   
*$PANAPT01X$ *******  LAST LINE TO DELETE  ******************                   
*PHASE AC2702C                                                                  
*INCLUDE SQUASHER                                                               
*INCLUDE ACCEDIT                                                                
*INCLUDE UNDERLIN                                                               
*INCLUDE SORTER                                                                 
*INCLUDE HELLO                                                                  
*INCLUDE HELEN                                                                  
*INCLUDE CASHVAL                                                                
*INCLUDE RIGHT                                                                  
*INCLUDE ACTRACK                                                                
*                                                                               
         TITLE 'AC27 - PROFESSIONAL BILLING  - MAIN PROCESSOR'                  
A27BASE  CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,*A27BASE,RA,R9,R6                                              
         L     RC,0(R1)                                                         
         USING ACWORKD,RC                                                       
         LA    R7,SPACEND                                                       
         USING BILLD,R7                                                         
         LA    R8,4095(R7)                                                      
         LA    R8,1(R8)                                                         
         USING BILLD2,R8                                                        
         EJECT                                                                  
***********************************************************************         
*              FIRST TIME ROUTINES                                    *         
***********************************************************************         
*                                                                               
RUNFST   DC    0H'0'                                                            
         CLI   MODE,RUNFRST                                                     
         BNE   REQFST                                                           
*                                                                               
         L     RF,AMONACC                                                       
         USING ACMD,RF                                                          
         LA    R0,DICI                                                          
         LA    R1,DICO                                                          
         STM   R0,R1,ACMALCDI                                                   
*                                                                               
         MVC   VATICAN,ACMAVTCN    SAVE VATICAN ADDRESS                         
         DROP  RF                                                               
*                                                                               
         MVC   FILNME,=C'ACCFIL '                                               
         XC    RUNCNT,RUNCNT       CLEAR INVOICE COUNTER                        
         MVI   BILLOPT,0                                                        
         MVI   RUNOPT,0                                                         
         MVI   BILLMODE,0                                                       
         OI    BILLMODE,ORIG                                                    
         CLI   RCRERUN,C'Y'                                                     
         BNE   *+12                                                             
         NI    BILLMODE,ALL-ORIG                                                
         OI    BILLMODE,RERUN                                                   
*                                                                               
         MVI   RCFLAG1,RCFREPLC    SET SPECS FOR LOWER CASE                     
*                                                                               
         RELOC RELO                                                             
         LA    RE,RELOTAB          RELOCATE MY A TYPES                          
         LA    R1,ATYPES                                                        
RELOOP   L     RF,0(RE)                                                         
         LA    RF,0(RF)                                                         
         A     RF,RELO                                                          
         ST    RF,0(R1)                                                         
         LA    RE,4(RE)                                                         
         LA    R1,4(R1)                                                         
         CLI   0(RE),X'FF'                                                      
         BNE   RELOOP                                                           
*                                                                               
         L     R2,ADMASTC                                                       
         USING MASTD,R2                                                         
         LA    R3,PHASES           R3=A(LOADABLE PHASE LIST)                    
         LHI   R0,PHASEN                                                        
         LA    R4,APHASES             R4=A(PHASE ADDRESSES)                     
         MVC   MCDUB,=CL8'T00AXX'                                               
                                                                                
RUNF00   GOTOR HEXOUT,DMCB,0(R3),MCDUB+4,1                                      
         GOTOR MCVLOADM,DMCB,0                                                  
         BE    *+6                 MUSTTEST PHASE NOT FOUND                     
         DC    H'0'                                                             
         MVC   0(L'APHASES,R4),4(R1)                                            
         AHI   R3,L'PHASES                                                      
         AHI   R4,L'APHASES                                                     
         BCT   R0,RUNF00                                                        
                                                                                
         L     RF,VEXTRAS                                                       
         USING RUNXTRAD,RF                                                      
         MVC   ORIGNME,ORIGINAM    SAVE ORIGIN NAME                             
         MVC   ORIGADD,ORIGINAD      AND ADDRESS                                
*                                                                               
         TM    MCAGCTRY,CTRYCAN    IS THIS A CANADIAN COMPANY?                  
         BZ    *+8                 NO                                           
         OI    RUNOPT,CANAGY       YES, INDICATE SO                             
*                                                                               
         OC    MCREMPQK,MCREMPQK   IS THIS A SOON RUN?                          
         BZ    RUNF02              NO                                           
         OI    RUNOPT,SOON         YES                                          
         MVC   USID,MCUSERID       GET USER ID                                  
         MVC   PQID,MCREMPQK       PQ ID                                        
         MVC   VSSB,MCSSB          AND ADDRESS OF SSB                           
*                                                                               
RUNF02   TM    MCTSTRUN,X'FF'      TEST RUN?                                    
         BZ    *+8                 NO                                           
         OI    RUNOPT,TESTRUN      YES                                          
         DROP  R2                                                               
*                                                                               
         USING CPYELD,RF                                                        
         L     RF,ADCMPEL                                                       
         MVC   TAXUL,CPYTAX        GET UNIT/LEDGER FOR TAX POSTINGS             
         MVC   PRODUL,CPYPROD      GET UNIT/LEDGER FOR CLIENT/PROD/JOB          
         DROP  RF                                                               
*                                                                               
         MVC   NARR(L'SPACES),SPACES                                            
         MVC   NARR+L'SPACES(L'NARR-L'SPACES),SPACES                            
*                                                                               
         USING ACPROFSD,RF                                                      
         L     RF,APROFILE         GET COMPANY LEVEL PROFILE                    
         MVC   PROFS,ACPPFCPY                                                   
*                                                                               
         XC    ALSORT,ALSORT       CLEAR A(LAST SORT)                           
         GOTO1 SORTER,DMCB,SORTCARD,RECCARD,0                                   
         GOTO1 BUFFALO,DMCB,=C'SET',ABUFF                                       
*                                                                               
         LA    R0,JOBBKCNT                                                      
         LA    R2,ZEROS                                                         
         ZAP   0(L'JOBNET,R2),=P'0'  INITIALIZE ZEROS                           
         LA    R2,L'JOBNET(R2)                                                  
         BCT   R0,*-10                                                          
*                                                                               
         XC    WKID,WKID                                                        
         SP    RCSPECNO+1(3),=P'1'                                              
         MVI   MAXLINES,54         HANDLE U.S. BILLING PAPER                    
*                                                                               
         ZAP   TOTBL,=P'0'                                                      
         ZAP   TOTCOMM,=P'0'                                                    
         ZAP   TAPECASH,=P'0'                                                   
         ZAP   TAPECNT,=P'0'                                                    
         ZAP   MARKED,=P'0'                                                     
         GOTO1 DATCON,DMCB,(4,RCDATE),(2,TODAY2)                                
         GOTO1 DATCON,DMCB,(4,RCDATE),(3,TODAY3)                                
         GOTO1 DATCON,DMCB,(4,RCDATE),(1,TODAYP)                                
*                                                                               
         MVC   MY+1(1),RCDATE+7      RCDATE IS MM/DD/YY                         
         MVC   MY(1),RCDATE+1        SET MONTH/YEAR                             
         CLI   RCDATE,C'1'                                                      
         BNE   RUNF03                                                           
         MVI   MY,C'A'                                                          
         CLI   RCDATE+1,C'0'                                                    
         BE    RUNF03                                                           
         MVI   MY,C'B'                                                          
         CLI   RCDATE+1,C'1'                                                    
         BE    RUNF03                                                           
         MVI   MY,C'C'                                                          
*                                                                               
RUNF03   MVC   YM+1(1),MY            SET YEAR/MONTH                             
         MVC   YM(1),MY+1                                                       
*                                                                               
         L     R4,ADCMPEL                                                       
         USING CPYELD,R4                                                        
         MVI   CMPOPT,0                                                         
         TM    CPYSTAT1,X'10'      WANT COSTING POSTING?                        
         BZ    *+8                 NO                                           
         OI    CMPOPT,POSTCOST     YES                                          
*                                                                               
         USING LOGOD,R5                                                         
         L     R5,LOGOC                                                         
         MVI   LOGOEND,C'X'                                                     
         CLC   LOGO1,SPACES                                                     
         BNE   *+10                                                             
         MVC   LOGO1,CPYLOGO                                                    
         GOTO1 LOGO,DMCB,(R5)                                                   
         EJECT                                                                  
***********************************************************************         
*              BUILD TABLE OF MEDIA CODES AND NAMES                   *         
***********************************************************************         
*                                                                               
         USING MESD,R5                                                          
         LA    R5,MESWK                                                         
         XC    MESWK(MESKLEN),MESWK                                             
         MVC   MESACCUM(JOBLNQ),ZEROS                                           
         L     R2,ADCOMP                                                        
         AH    R2,DATADISP                                                      
*                                                                               
RUNF04   CLI   0(R2),0                                                          
         BE    RUNF10                                                           
         CLI   0(R2),X'11'                                                      
         BE    RUNF08                                                           
*                                                                               
RUNF06   ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     RUNF04                                                           
*                                                                               
         USING PMDELD,R2                                                        
RUNF08   MVC   MESCDE,PMDCODE     MOVE CODE AND DESCRIPTION TO TABLE            
         MVC   MESNME,PMDDESC                                                   
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AMEDTAB                           
         B     RUNF06                                                           
*                                                                               
RUNF10   MVI   MESCDE,X'FF'        MARK END OF TABLE                            
         MVC   MESNME,SPACES                                                    
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AMEDTAB                           
         B     BASEXIT                                                          
         EJECT                                                                  
***********************************************************************         
*               FIRST FOR REQUEST                                     *         
***********************************************************************         
*                                                                               
REQFST   CLI   MODE,REQFRST                                                     
         BNE   LEDGFST                                                          
*                                                                               
         USING MASTD,RF                                                         
         L     RF,ADMASTC                                                       
         MVC   USERPID,MCRHPSWD       SAVE PID                                  
         DROP  RF                                                               
*                                                                               
         MVI   PRINTED,C'N'                                                     
         NI    BILLOPT,X'FF'-OLDNUM           RESET OLDNUM SWITCH               
         GOTO1 BUFFALO,DMCB,=C'RESET',ABUFF                                     
         MVI   REQOPT,0                                                         
*                                                                               
         CLI   QOPT1,C'P'                                                       
         BNE   *+8                                                              
         OI    REQOPT,REQPRDO      PRODUCTION ONLY                              
*                                                                               
         CLI   QOPT1,C'M'                                                       
         BNE   *+8                                                              
         OI    REQOPT,REQMEDO      MEDIA ONLY                                   
*                                                                               
         CLC   QPROG,=C'27'                                                     
         BNE   *+8                                                              
         OI    BILLMODE,BILL       LIVE BILLING                                 
*                                                                               
         CLC   QPROG,=C'28'                                                     
         BNE   *+8                                                              
         OI    BILLMODE,DRAFT      DRAFT BILLING                                
*                                                                               
         CLC   QPROG,=C'29'                                                     
         BNE   *+8                                                              
         OI    BILLMODE,UNBILL     UNBILLING                                    
*                                                                               
         CLC   QPROG,=C'30'        DRAFT UNBILLING                              
         BNE   *+12                                                             
         OI    BILLMODE,UNBILL     UNBILLING                                    
         OI    BILLMODE,DRAFT      DRAFT                                        
*                                                                               
         TM    BILLMODE,BILL+DRAFT+UNBILL                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    BILLMODE,DRAFT           IS THIS A DRAFT?                        
         BZ    *+8                      NO                                      
         NI    RUNOPT,X'FF'-SOON        YES, TURN SOON OFF                      
*                                                                               
         TM    RUNOPT,CANAGY            IS THIS A CANADIAN AGENCY?              
         BZ    *+8                      NO                                      
         OI    RUNOPT,NEEDGST+NEEDPST   YES, BOTH TAXES NEEDED                  
*                                                                               
         CLI   QOPT2,C'Y'               SUPPRESS BOTH TAXES?                    
         BNE   *+8                      NO                                      
         NI    RUNOPT,X'FF'-NEEDGST-NEEDPST                                     
*                                                                               
         CLI   QOPT2,C'P'               SUPPRESS PST ONLY?                      
         BNE   *+8                      NO                                      
         NI    RUNOPT,X'FF'-NEEDPST                                             
*                                                                               
         OC    WKID,WKID                                                        
         BNZ   REQF02              ALREADY HAVE ID                              
         GOTO1 POST,DMCB,('POSTOPEN',(RC))       OPEN FILE                      
*                                                                               
REQF02   MVC   MNTH,RCDATE         THIS MONTH (MM)                              
         MVC   MOS,THISMNTH                                                     
         MVC   BILLDTE,RCDATE                                                   
         XC    TODAT2,TODAT2                                                    
         XC    TODATE,TODATE                                                    
         XC    FRDATE,FRDATE                                                    
*                                                                               
         CLC   QSTART,SPACES                                                    
         BE    REQF04                                                           
         GOTO1 DATCON,DMCB,(0,QSTART),(10,BILLDTE)                              
*                                                                               
         MVC   MOS(1),QSTART+1     BUILD MONTH OF SERVICE                       
         MVC   MOS+1(1),QSTART+3     FROM BILL DATE                             
         CLI   QSTART+2,C'1'                                                    
         BNE   REQF04                                                           
         MVI   MOS+1,C'A'                                                       
         CLI   QSTART+3,C'0'                                                    
         BE    REQF04                                                           
         MVI   MOS+1,C'B'                                                       
         CLI   QSTART+3,C'1'                                                    
         BE    REQF04                                                           
         MVI   MOS+1,C'C'                                                       
*                                                                               
REQF04   MVI   ENDATE,ALL                                                       
         CLC   QEND,SPACES                                                      
         BE    REQF06                                                           
         GOTO1 DATCON,DMCB,(0,QEND),(1,ENDATE)                                  
         GOTO1 DATCON,DMCB,(0,QEND),(2,END2)                                    
         GOTO1 DATCON,DMCB,(0,QEND),(1,CALLDATE)                                
*                                                                               
REQF06   GOTO1 DATCON,DMCB,(4,BILLDTE),(2,RCDAY2)                               
         GOTO1 DATCON,DMCB,(4,BILLDTE),(0,DUB)                                  
         GOTO1 (RF),(R1),,(1,DATE3)                                             
*                                                                               
         LA    R4,10               DEFAULT DUEDATE IS TODAY +10                 
         GOTO1 ADDAY,DMCB,DUB,WORK,(R4)                                         
         GOTO1 DATCON,DMCB,(0,WORK),(8,DUEDAT)                                  
         GOTO1 DATCON,DMCB,(0,WORK),(2,DUE2)                                    
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BO    *+10                YES, LEAVE CALLDATE AS END                   
         MVC   CALLDATE,DATE3      NO, REPLACE WITH INVOICE DATE                
*                                                                               
         MVI   MYSPACE,2           DOUBLE SPACING IS DEFAULT                    
*                                                                               
         TM    BILLMODE,DRAFT      IS THIS A DRAFT?                             
         BNO   REQF12              NO, DETAILS NOT ALLOWED THEN                 
         CLI   PROF20,C'Y'         DO YOU WANT REQUEST DETAILS?                 
         BNE   REQF12              NO                                           
*                                                                               
REQF08   CLI   SPECSW,C'Y'         YES, HAVE I FIXED MY SPECS?                  
         BE    REQF12              YES                                          
         MVI   SPECSW,C'Y'         NO, DO IT                                    
         L     R4,ACSPECS                                                       
*                                                                               
REQF10   ZIC   R3,1(R4)            GET LENGTH                                   
         AR    R4,R3                                                            
         CLI   0(R4),0             ARE WE AT THE END?                           
         BNE   REQF10              NO, KEEP LOOKING                             
         L     R3,AMYSPECS         YES, ADD SPECS FOR REQDETS                   
         MVC   0(100,R4),0(R3)                                                  
*                                                                               
         USING ACQD,R3                                                          
REQF12   L     R3,ADQSTACK                                                      
         LA    R4,ACQTYP1                                                       
         USING ACQTYP1,R4                                                       
         CLC   ACQDTSTR,SPACES     NO START, USE TODAY                          
         BE    REQF14                                                           
         GOTO1 DATCON,DMCB,(0,ACQDTSTR),(2,FRDAT2)                              
         GOTO1 DATCON,DMCB,(0,ACQDTSTR),(8,FRDATE)                              
*                                                                               
         CLC   ACQDTEND,SPACES                                                  
         BE    REQF16                                                           
*                                                                               
         GOTO1 DATCON,DMCB,(0,ACQDTEND),(2,TODAT2)                              
         GOTO1 DATCON,DMCB,(0,ACQDTEND),(8,TODATE)                              
         B     REQF16                                                           
*                                                                               
REQF14   GOTO1 DATCON,DMCB,(4,BILLDTE),(8,FRDATE)                               
         GOTO1 DATCON,DMCB,(4,BILLDTE),(2,FRDAT2)                               
*                                                                               
REQF16   BRAS  RE,GETPRO           SET IF ARCHIVING IS SET                      
*                                                                               
REQFXIT  B     BASEXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              FIRST FOR LEDGER                                       *         
***********************************************************************         
*                                                                               
LEDGFST  CLI   MODE,LEDGFRST                                                    
         BNE   PROCLVA                                                          
         USING ACPROFSD,RF                                                      
         L     RF,APROFILE                                                      
         MVC   PROFS,ACPPFLDG      GET LEDGER LEVEL PROFILE                     
         TM    RUNOPT,SOON         RUNNING SOON?                                
         BZ    BASEXIT             NO                                           
*                                                                               
         L     R2,ADLEDGER         YES, LEDGER MUST BE LOCKED                   
         MVI   ELCODE,LGLELQ                                                    
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING LGLELD,R2                                                        
         TM    LGLSTAT,LGLSLOCK    MAKE SURE LEDGER IS LOCKED                   
         BO    *+6                                                              
         DC    H'0'                                                             
         CLC   LGLDATE,TODAY3      AND THAT IT WAS LOCKED TODAY                 
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   LUID,LGLLUID        OK, SAVE LUID                                
*                                                                               
LEGFX    B     BASEXIT                                                          
         DROP  R2,RF                                                            
         EJECT                                                                  
***********************************************************************         
*              FIRST FOR CLIENT                                       *         
***********************************************************************         
*                                                                               
         USING OPTTABD,R3                                                       
         USING ACPROFSD,RE                                                      
PROCLVA  CLI   MODE,PROCLEVA                                                    
         BNE   PROCLVB                                                          
         ZAP   GRANDTOT,=P'0'                                                   
         ZAP   SUBTOT2,=P'0'                                                    
         ZAP   TOTCOM,=P'0'                                                     
         ZAP   TOTGST,=P'0'                                                     
         ZAP   TOTPST,=P'0'                                                     
         ZAP   TOTCD,=P'0'                                                      
*                                                                               
         ZAP   TOTOOP,=P'0'        RECAP TOTALS                                 
         ZAP   TOTTIME,=P'0'                                                    
         ZAP   TOTPREB,=P'0'                                                    
         ZAP   TOTGRS,=P'0'                                                     
         ZAP   TOTNET,=P'0'                                                     
*                                                                               
         MVI   CLIOPT,0            CLEAR CLIENT OPTIONS                         
         MVC   BILLINFO,SPACES                                                  
*                                                                               
         MVI   FCRDACC,C'Y'        RESET IN CASE PREVIOUS REQUEST               
         MVI   FCRDTRNS,C'Y'        WAS IN ERROR                                
*                                                                               
         TM    RUNOPT,SOON         RUNNING SOON?                                
         BZ    LVAF00              NO                                           
*                                                                               
         L     R2,ADHEIRA          YES, CLIENT MUST BE LOCKED                   
         MVI   ELCODE,LOKELQ                                                    
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING LOKELD,R2                                                        
         CLC   LOKDATE,TODAY3                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
LVAF00   L     RE,APROFILE                                                      
         MVC   PROFS,ACPPFACC      GET CLIENT LEVEL PROFILE                     
         MVC   FORMTYP,QAPPL+4     INITIALIZE FORMAT AND GROUP LEVEL            
         MVC   GRPTYPE,QAPPL+5                                                  
         CLI   FORMTYP,C' '        WAS A FORMAT SPECIFIED?                      
         BNE   *+10                YES                                          
         MVC   FORMTYP,PROF17      NO, GET IT FROM PROFILE                      
*                                                                               
LVAF02   L     R3,AOPTTAB          FIND FORMAT IN TABLE                         
*                                                                               
LVAF04   CLI   OPTFORM,X'FF'       END OF TABLE                                 
         BNE   LVAF06              YES, WE HAVE AN ERROR CONDITION              
         MVI   FCRDACC,C'N'        YES, BYPASS REQUEST                          
         MVI   FCRDTRNS,C'N'                                                    
         B     BASEXIT                                                          
*                                                                               
LVAF06   CLC   OPTFORM,FORMTYP     NO, HAVE WE REACHED THE RIGHT FORMAT         
         BE    LVAF08              YES                                          
         LA    R3,L'OPTLEN(R3)     NO, KEEP LOOKING                             
         B     LVAF04                                                           
*                                                                               
LVAF08   MVC   READALL,OPTALL                                                   
         MVC   READTYPM,OPTTYPM                                                 
         MVC   READTYPO,OPTTYPO                                                 
         MVC   READTYPP,OPTTYPP                                                 
         MVC   READTYPT,OPTTYPT                                                 
         MVC   READTYPR,OPTTYPR                                                 
*                                                                               
         CLI   GRPTYPE,C' '        HAS TYPE ALREADY BEEN SET?                   
         BNE   LVAF10              YES                                          
         MVC   GRPTYPE,PROF18      NO, GET FROM PROFILE                         
*                                                                               
LVAF10   MVC   FORMHOLD,FORMTYP    SET FORMHOLD WITH TYPE & GROUP               
         CLI   GRPTYPE,C'0'        DOING GROUP BILLING?                         
         BNE   LVAF12              YES                                          
         CLI   FORMTYP,C'3'        NO, FORMAT 4 OR 5?                           
         BNH   LVAF12              NO                                           
         CLI   FORMTYP,C'6'                                                     
         BNL   LVAF12                                                           
         MVI   FCRDACC,C'N'        YES, BYPASS REQUEST                          
         MVI   FCRDTRNS,C'N'                                                    
         B     BASEXIT                                                          
*                                                                               
LVAF12   MVI   GRPOPT,0            CLEAR THE OPTION                             
         CLI   GRPTYPE,C'C'        ARE WE DOING A CLIENT GROUP BILL?            
         BNE   LVAF14              NO                                           
*                                                                               
         L     RE,AGRPTAB           CLEAR GRPTAB                                
         LA    RF,(SUBTABL*GRPTABM)                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         MVI   GRPTABN,0           CLEAR GRPTAB COUNTER                         
                                                                                
         OI    GRPOPT,GRPBILL      YES INDICATE IT                              
         MVC   GRPTOT(JOBLNQ),ZEROS  CLEAR PRODUCT LEVEL GROUP TOTALS           
         ZAP   GRPINT,=P'0'                                                     
         ZAP   GRPCD,=P'0'                                                      
         ZAP   GRP11,=P'0'                                                      
         ZAP   GRP12,=P'0'                                                      
         ZAP   GRPSJ,=P'0'                                                      
         ZAP   GRPSR,=P'0'                                                      
         ZAP   GRPGST,=P'0'                                                     
         ZAP   GRPPST,=P'0'                                                     
         MVI   BILDATA,C'N'        INDICATE NO CLIENT LEVEL BILL DATA           
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVC   PRENAME,SPACES                                                   
*                                                                               
         L     RF,AUSRPOOL                                                      
         MVI   0(RF),X'00'         INDICATE NO USER FIELDS                      
*                                                                               
         USING PPRELD,R2                                                        
         L     R2,ADLVASUP         GET CLIENT LEVEL PROFILE                     
         MVC   RECEIVBL,PPRRECV   GET RECEIVABLE, OFFICE AND BILLING            
         MVC   RECOFF,PPRGAOFF     INFO FROM CORRECT LEVEL PROFILE              
         MVC   BILLINFO,PPRBILLP                                                
*                                                                               
         USING ACMD,R3                                                          
         L     R3,AMONACC                                                       
         L     R3,ACMAGOX                                                       
*                                                                               
         USING GOXBLKD,R3                                                       
         OC    GOBDB,GOBDB         ANY IDR ACCOUNT?                             
         BZ    *+10                NO                                           
         MVC   RECEIVBL,GOBDB      YES, USE IT AS RECEIVABLE                    
*                                                                               
         GOTO1 SHR,DMCB,('SUBRDATE',(RC))   GET THE DUE DATE                    
*                                                                               
LVAF14   CLI   GRPTYPE,C'P'        ARE WE DOING A PRODUCT GROUP BILL?           
         BNE   *+8                 NO                                           
         OI    GRPOPT,GRPBILL      YES, INDICATE IT                             
*                                                                               
         LA    R3,CLINAME          SET UP CLIENT NAME                           
         L     R2,ADHEIRA              AND ACCOUNT CODE                         
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
         MVC   CLICODE,0(R2)                                                    
         B     BASEXIT                                                          
         DROP  R2,R3,RE                                                         
         EJECT                                                                  
***********************************************************************         
*              FIRST FOR PRODUCT                                      *         
***********************************************************************         
*                                                                               
PROCLVB  CLI   MODE,PROCLEVB                                                    
         BNE   ACCFST                                                           
         MVI   LEVEL,0             SET UP START FOR FORMATTED BILL              
         CLI   GRPTYPE,C'P'                                                     
         BNE   LVBF02                                                           
*                                                                               
         L     RE,AGRPTAB           CLEAR GRPTAB                                
         LA    RF,(SUBTABL*GRPTABM)                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         MVI   GRPTABN,0           CLEAR GRPTAB COUNTER                         
                                                                                
         MVC   GRPTOT(JOBLNQ),ZEROS  CLEAR PRODUCT LEVEL GROUP TOTALS           
         ZAP   GRPINT,=P'0'                                                     
         ZAP   GRPCD,=P'0'                                                      
         ZAP   GRP11,=P'0'                                                      
         ZAP   GRP12,=P'0'                                                      
         ZAP   GRPSJ,=P'0'                                                      
         ZAP   GRPSR,=P'0'                                                      
         ZAP   GRPGST,=P'0'                                                     
         ZAP   GRPPST,=P'0'                                                     
         MVI   BILDATA,C'N'        INDICATE NO PRODUCT LEVEL BILL DATA          
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVC   PRENAME,SPACES                                                   
*                                                                               
         L     RF,AUSRPOOL                                                      
         MVI   0(RF),X'00'         INDICATE NO USER FIELDS                      
*                                                                               
         USING PPRELD,RF                                                        
         L     RF,ACOMPRF                                                       
         L     RE,ADLVASUP         GET CLIENT LEVEL PROFILE                     
         MVC   0(256,RF),0(RE)                                                  
         ICM   R1,15,ADLVBSUP                                                   
         BZ    *+8                                                              
         BAS   RE,OVERPROF                                                      
         MVC   RECEIVBL,PPRRECV   GET RECEIVABLE, OFFICE AND BILLING            
         MVC   RECOFF,PPRGAOFF     INFO FROM CORRECT LEVEL PROFILE              
         MVC   BILLINFO,PPRBILLP                                                
*                                                                               
         USING ACMD,R3                                                          
         L     R3,AMONACC                                                       
         L     R3,ACMAGOX                                                       
*                                                                               
         USING GOXBLKD,R3                                                       
         OC    GOBDB,GOBDB         ANY IDR ACCOUNT?                             
         BZ    *+10                NO                                           
         MVC   RECEIVBL,GOBDB      YES, USE IT AS RECEIVABLE                    
*                                                                               
         GOTO1 SHR,DMCB,('SUBRDATE',(RC))   GET THE DUEDATE                     
*                                                                               
LVBF02   LA    R3,PRDNAME          GET PRODUCT CODE AND NAME                    
         L     R2,ADHEIRB             FOR INCOME ACCOUNT                        
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
         MVC   PRDCODE,0(R2)                                                    
         MVC   PRODNAM,PRDNAME                                                  
         MVC   PRODNUM,PRDCODE                                                  
*                                  GET SALES ANALYSIS ACCOUNT                   
*                                     FOR OVERRIDES                             
         MVI   ELCODE,X'3D'                                                     
         BAS   RE,GETEL                                                         
         BNE   BASEXIT                                                          
*                                                                               
         USING SANELD,R2                                                        
         MVC   PRODNUM,SANCODE                                                  
         MVC   PRODNAM,SANNAME                                                  
         B     BASEXIT                                                          
         DROP  R2,R3,RF                                                         
         EJECT                                                                  
***********************************************************************         
*              FIRST FOR ACCOUNT                                      *         
***********************************************************************         
*                                                                               
ACCFST   CLI   MODE,PROCACC                                                     
         BNE   ANALFST                                                          
*                                                                               
         MVC   UNIT,SPACES                                                      
*                                                                               
         ZAP   TOTTTYP,=P'0'       CLEAR RETAINER BUCKETS                       
         ZAP   TOTRET,=P'0'                                                     
         ZAP   SVASAMT,=P'0'                                                    
*                                                                               
         ZAP   SCIUNET,=P'0'       CLEAR BUCKETS FOR SCIEL'S                    
         ZAP   SCIUCOM,=P'0'                                                    
*                                                                               
         XC    SVVEND,SVVEND       CLEAR STUDIO FIELDS                          
         XC    SVAGKEY,SVAGKEY                                                  
         XC    SVSTUD,SVSTUD                                                    
         XC    SVICR,SVICR                                                      
         XC    SVAGHOLD,SVAGHOLD                                                
         XC    SVELEM,SVELEM                                                    
         XC    SVDBELM,SVDBELM                                                  
         XC    SVDBELM2,SVDBELM2                                                
         XC    SVAGXJOB,SVAGXJOB                                                
         MVC   SVVENDN,SPACES                                                   
         MVC   SVAGACN,SPACES                                                   
         MVC   SVAGOFF,SPACES                                                   
         XC    WARNRSNS,WARNRSNS                                                
*                                                                               
         USING BIND,R5                                                          
         L     R5,AWRKTAB                                                       
         XC    BININ,BININ         CLEAR COUNTER                                
         DROP  R5                                                               
*                                                                               
         USING PPRELD,RF                                                        
         L     RF,ACOMPRF                                                       
         L     RE,ADLVASUP         GET CLIENT LEVEL PROFILE                     
         MVC   0(256,RF),0(RE)                                                  
         ICM   R1,15,ADLVBSUP                                                   
         BZ    *+8                                                              
         BAS   RE,OVERPROF                                                      
         ICM   R1,15,ADLVCSUP                                                   
         BZ    *+8                                                              
         BAS   RE,OVERPROF                                                      
         MVC   COSTING,PPRCOST    GET COSTING ACCOUNT                           
         MVC   UNIT,PPRGAOFF       SAVE OFFICE                                  
         ZAP   JOBINT,=P'0'                                                     
*                                                                               
         TM    GRPOPT,GRPBILL      GROUP BILLING?                               
         BO    ACCF02              YES, ALREADY HAVE THE REST                   
         MVC   RECOFF,PPRGAOFF     NO, GET OFFICE FOR RECEIVABLE                
         MVC   RECEIVBL,PPRRECV   GET RECEIVABLE ACCT AND BILLINFO              
         MVC   BILLINFO,PPRBILLP                                                
         MVI   BILDATA,C'N'                                                     
         MVC   PRENAME,SPACES                                                   
*                                                                               
         USING ACMD,R3                                                          
         L     R3,AMONACC                                                       
         L     R3,ACMAGOX                                                       
*                                                                               
         USING GOXBLKD,R3                                                       
         OC    GOBDB,GOBDB         ANY IDR ACCOUNT?                             
         BZ    *+10                NO                                           
         MVC   RECEIVBL,GOBDB      YES, USE IT AS RECEIVABLE                    
*                                                                               
         L     RF,AUSRPOOL                                                      
         MVI   0(RF),X'00'         INDICATE NO USER FIELDS                      
*                                                                               
         GOTO1 SHR,DMCB,('SUBRDATE',(RC))   GET THE DUEDATE                     
         DROP  R3,RF                                                            
*                                                                               
ACCF02   CLI   FORMTYP,C'0'        FORMATTED BILL?                              
         BH    *+14                YES, DON'T START NEW PAGE                    
         MVC   PAGE,=H'1'                                                       
         MVI   FORCEHED,C'Y'                                                    
         L     R2,ADACC                                                         
*                                                                               
         TM    GRPOPT,GRPBILL      GROUP BILLING?                               
         BO    *+14                YES, PAGE BREAK AT LEVEL                     
         MVI   FORCEHED,C'Y'       NO, DO IT NOW                                
         MVC   PAGE,=H'1'                                                       
*                                                                               
         ZAP   SAVCD,=P'0'                                                      
         ZAP   SAVEPN,=P'0'                                                     
         ZAP   SAVEPC,=P'0'                                                     
         MVC   SVANAL,SPACES                                                    
         MVC   SVANWGP,SPACES                                                   
         MVC   SVANALN,SPACES                                                   
         MVC   SVANALNS,SPACES                                                  
         MVI   SVWCTYP,C' '                                                     
         ZAP   REBILLNO,=P'0'      CLEAR RERUN BILL NUMBER                      
         MVI   JOBOPT,0                                                         
*                                                                               
         LA    R3,JOBNAME          SET UP JOB NAME                              
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
         MVC   JOBCODE,0(R2)          AND ACCOUNT CODE                          
         MVC   JOBLET,9(R2)                                                     
*                                                                               
         USING GOBLOCKD,R4                                                      
         L     R4,ADGOBLOC         GET THE JOB GROUP                            
         MVC   JGROUP,GOJG                                                      
         OC    JGROUP,SPACES                                                    
*                                                                               
         NI    BILLOPT,LEDNUM+OLDNUM     DON'T TURN OFF AGENCY NUMBER           
         MVC   JOBDTL(JOBLNQ),ZEROS      CLEAR CURRENT DETAIL LINE              
         MVC   JOBWKC(JOBLNQ),ZEROS            WORKCODE TOTAL                   
         MVC   JOBCHG(JOBLNQ),ZEROS            CHARGES TOTAL                    
         MVC   JOBTOT(JOBLNQ),ZEROS            ACCOUNT TOTAL                    
         MVC   JOBPOS(JOBLNQ),ZEROS            POSTING TOTAL                    
         MVC   JOBMED(JOBLNQ),ZEROS            MEDIA TOTAL                      
*                                                                               
         GOTO1 FILT,DMCB,(RC)      DO FILTERING AND DATA EXTRACTION             
         CLI   BILLTYPE,NOTBILL    IS JOB BILLABLE?                             
         BNE   ACCF04              YES                                          
         CLC   P,SPACES            NO, ARE WE PRINTING REASONS?                 
         BE    ACCF26              NO                                           
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))        YES                            
         B     ACCF26                                                           
*                                                                               
ACCF04   TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    ACCF06              NO                                           
*                                                                               
         L     RE,ASVTABLE          CLEAR SVTABLE                               
         LA    RF,(SVTABLNQ*TAXNUM)                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         USING VTCD,R2                                                          
         L     R2,AVATBUFF                DO CALL TO VATICAN                    
         XC    VTCACTN(VTCLNQ),VTCACTN    CLEAR VATICAN BUFFER                  
         MVI   VTCACTN,VTCALOOK           LOOK FOR RATES                        
         MVC   VTCCOMF,ADCOMFAC           A(COMFACS)                            
         MVC   VTCCPY,CLICODE             COMPANY CODE                          
         MVC   VTCOFFC,UNIT               OFFICE                                
         MVC   VTCINVD,CALLDATE           INVOICE/UNBILL DATE                   
         MVI   VTCTYPE,C'S'               ALWAYS NEED A TYPE                    
         GOTO1 VATICAN,(R2)                                                     
         TM    VTCINDS,VTCINA             IS TAX APPLICABLE?                    
         BZ    *+8                        YES                                   
         NI    RUNOPT,X'FF'-NEEDGST       NO, TURN OFF OPTION THEN              
         MVC   SVGSTREG,VTCREG            GET REGISTRATION NUMBER               
*                                                                               
         MVC   VTCPRV,SVPSTPRV            MOVE IN PROVINCE CODE                 
         XC    VTCINDS,VTCINDS            CLEAR ERROR CODE                      
         GOTO1 VATICAN,(R2)                                                     
         TM    VTCINDS,VTCINA             IS TAX APPLICABLE?                    
         BZ    *+8                        NO                                    
         NI    RUNOPT,X'FF'-NEEDPST                                             
         MVC   SVPSTREG,VTCREG            SAVE REGISTRATION NUMBER              
         DROP  R2                                                               
*                                                                               
ACCF06   TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    ACCF16              NO                                           
*                                                                               
         USING ACTRECD,R2                                                       
         L     R2,AIO2             YES, READ AGENCY CLIENT                      
         MVC   ACTKEY(42),SPACES                                                
         MVC   ACTKCULA(L'SVAGCUL),SVAGCUL                                      
         MVC   ACTKCULA+L'SVAGCUL(L'SVAGCLI),SVAGCLI                            
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0            FIND IT?                                     
         BE    ACCF10              YES                                          
*                                                                               
         USING NOBD,R5                                                          
ACCF08   L     R5,ANOBWK                                                        
         LA    R1,NOBLNQ                                                        
         SLL   R1,16                                                            
         ST    R1,NOBLEN                                                        
         MVI   NOBTYP,NOBEQU           RECORD TYPE                              
         L     R2,ADACC                                                         
         MVC   NOBCLI(12),3(R2)         CLI/PRD/JOB                             
*                                                                               
         MVC   NOBDATA,SPACES                                                   
         MVI   NOBRSN,99           REASON CODE                                  
         MVC   NOBDATA(37),=C'CAN''T BILL - LINK INFORMATION MISSING'           
         GOTO1 SORTER,DMCB,=C'PUT',ANOBWK                                       
         MVI   ALSORT,1                                                         
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         MVI   BILLTYPE,NOTBILL                                                 
         MVI   FCRDTRNS,C'N'                                                    
         MVI   FCRDEST,C'N'                                                     
         B     ACCF28                                                           
*                                                                               
ACCF10   LA    R3,SVAGCLIN         SAVE CLIENT NAME                             
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
         USING ACTRECD,R2                                                       
         L     R2,AIO2             YES, READ AGENCY JOB RECORD                  
         MVC   ACTKEY(42),SPACES                                                
         MVC   ACTKCULA,SVAGKEY                                                 
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0            FIND IT?                                     
         BNE   ACCF08              NO                                           
*                                                                               
         LA    R3,SVAGACN                                                       
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
         USING JOBELD,R2                                                        
         MVI   ELCODE,JOBELQ                                                    
         BAS   RE,GETEL                                                         
         BNE   ACCF12                                                           
         TM    JOBSTA1,JOBSXJOB   IS THIS AN X-JOB ?                            
         BZ    *+8                 NO                                           
         OI    SVAGXJOB,JOBX       YES, INDICATE SO                             
*                                                                               
ACCF12   L     RE,ACOMBUF                                                       
         LH    RF,=YL2(GOBLOCKX-GOBLOCK)                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         USING GOBLOCKD,R4                                                      
         L     R4,ACOMBUF                                                       
         MVC   GOADM,DATAMGR                                                    
         LA    RE,GOBLOCKX-GOBLOCK(R4)                                          
         ST    RE,GOAEXT                                                        
         LH    RF,=YL2(GOXBLKX-GOXBLKD)                                         
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         MVC   GOSELCUL,JOBCODE                                                 
         MVC   GOSELCLI,SPACES                                                  
         MVC   GOSELCLI(L'SVAGCLI),SVAGCLI                                      
         MVC   GOSELPRO,SPACES                                                  
         MVC   GOSELPRO(L'SVAGPRO),SVAGPRO                                      
         MVC   GOSELJOB,SVAGJOB                                                 
         MVC   GOAJOB,AIO2                                                      
         GOTO1 GETOPT,DMCB,ACOMBUF                                              
*                                                                               
         MVC   SVAGOFF,GOEFFOFC    SAVE THE OFFICE CODE                         
*                                                                               
         L     R4,GOAEXT                                                        
         USING GOXBLKD,R4                                                       
         CLI   GOINTPST,C'Y'       ARE WE MAKING POSTINGS?                      
         BNE   ACCF16              NO                                           
         TM    SVAGXJOB,JOBX       IS THE AGENCY AN XJOB?                       
         BZ    ACCF14              NO                                           
         MVI   WARNRSN,WARN01      YES, CAN'T MAKE INTERCOMPANY THEN            
         BAS   RE,FILTNOW                                                       
         B     ACCF16                                                           
*                                                                               
ACCF14   OI    JOBOPT,POSTAGY      YES, SET THE BIT                             
         MVC   SVAGHOLD,GOHOLD     AND SAVE THE HOLD OPTION                     
*                                                                               
         USING STURECD,R2                                                       
         L     R2,AIO2             READ THE STUDIO FOR VENDOR                   
         XC    STUKEY,STUKEY                                                    
         MVI   STUKTYP,STUKTYPQ                                                 
         MVI   STUKSUB,STUKSUBQ                                                 
         MVC   STUKCPY,CLICODE                                                  
         MVC   STUKCODE,SVSTUD                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0            FIND IT?                                     
         BNE   ACCF08              NO                                           
*                                                                               
         USING STUELD,R2                                                        
         MVI   ELCODE,STUELQ                                                    
         BAS   RE,GETEL                                                         
         BNE   ACCF08                                                           
         MVC   SVVEND,STUVEND                                                   
*                                                                               
         USING ACTRECD,R2                                                       
         L     R2,AIO2             YES, GET VENDOR NAME                         
         MVC   ACTKEY(42),SPACES                                                
         MVC   ACTKCULA,SVVEND                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0            FIND IT?                                     
         BNE   ACCF08              NO                                           
*                                                                               
         USING NAMELD,R2                                                        
         MVI   ELCODE,NAMELQ                                                    
         BAS   RE,GETEL                                                         
         BNE   ACCF08                                                           
*                                                                               
         SR    R1,R1                                                            
         IC    R1,NAMLN                                                         
         SH    R1,=Y(NAMEREC-NAMELD+1)                                          
         BM    ACCF16                                                           
         EX    R1,*+8                                                           
         B     ACCF16                                                           
         MVC   SVVENDN(0),NAMEREC                                               
*                                                                               
ACCF16   TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    ACCF18              NO                                           
         GOTO1 BILLNUM,DMCB,(RC)   YES, FIND JOB                                
         OC    USEBILL,USEBILL     CAN WE UNBILL IT?                            
         BNZ   ACCF18              YES                                          
         MVI   BILLTYPE,NOTBILL    NO, MAKE IT NON-BILLABLE THEN                
         MVI   FCRDTRNS,C'N'                                                    
         B     ACCF26                                                           
*                                                                               
ACCF18   GOTO1 SHR,DMCB,('SUBRCOST',(RC))                                       
         TM    BILLMODE,DRAFT      ARE WE DRAFTING?                             
         BO    ACCF20              YES                                          
         TM    BILLOPT,OLDNUM      NO, USE OLD BILL NUMBER?                     
         BO    ACCF22              YES                                          
         CP    REBILLNO,=P'0'      NO, DO WE HAVE A RERUN BILL NUMBER?          
         BE    *+14                NO                                           
         ZAP   BILLNO,REBILLNO     YES, USE IT                                  
         B     ACCF22                                                           
*                                                                               
         TM    RUNOPT,BILNUM       DO WE HAVE ABILL NUMBER?                     
         BO    ACCF22              YES                                          
*                                                                               
         BAS   RE,CLIBILL          TRY CLIENT LEVEL FIRST                       
         TM    BILLOPT,CLINUM      DID WE FIND ONE?                             
         BO    ACCF20              YES                                          
*                                                                               
         BAS   RE,LEDBILL          NO, GET THE LEDGER LEVEL ONE                 
         TM    BILLOPT,LEDNUM      DID WE FIND ONE?                             
         BO    ACCF20              YES                                          
*                                                                               
         AP    RCSPECNO+1(3),=P'1' NO, USE NEXT NUMBER                          
         MVC   BILLNO,RCSPECNO                                                  
*                                                                               
ACCF20   OI    RUNOPT,BILNUM        INDICATE WE HAVE A BILL NUMBER              
*                                                                               
ACCF22   MVC   LNGBILNO,SPACES     SETUP HEADINGS                               
         MVI   WORK,C'*'                                                        
         MVC   WORK+1(L'AC@DRAFT),AC@DRAFT                                      
         MVI   WORK+1+L'AC@DRAFT,C'*'                                           
*                                                                               
         MVC   LNGBILNO(7),WORK                                                 
         MVC   SHTBILNO,SPACES                                                  
         MVC   SHTBILNO,WORK                                                    
         TM    BILLMODE,DRAFT                                                   
         BO    ACCF26                                                           
*                                                                               
         UNPK  WORK(6),BILLNO                                                   
         OI    WORK+5,X'F0'                                                     
         MVC   BILLREF,WORK                                                     
         CLI   PROF36,0            TEST MM OPTION                               
         BE    ACCF23                                                           
         MVC   BILLREF(2),YM       BILL NUMBER YMNNN                            
         CLI   PROF36,2            TEST YM OPTION                               
         BE    ACCF23                                                           
         MVC   BILLREF(2),MY       BILL MYNNNN                                  
*                                                                               
ACCF23   MVC   SHTBILNO(2),BILLREF   MM-NNNN                                    
         MVI   SHTBILNO+2,C'-'                                                  
         MVC   SHTBILNO+3(4),BILLREF+2                                          
*                                                                               
         OC    USERMC,USERMC       ANY SPECIAL USER MEDIA CODE?                 
         BZ    ACCF24              NO                                           
         MVC   LNGBILNO(2),BILLREF FORMAT IS MM-MC-NNNN                         
         MVI   LNGBILNO+2,C'-'                                                  
         MVC   LNGBILNO+3(2),USERMC                                             
         MVI   LNGBILNO+5,C'-'                                                  
         MVC   LNGBILNO+6(4),BILLREF+2                                          
         B     ACCF26                                                           
*                                                                               
ACCF24   MVC   LNGBILNO(1),JOBLET  MEDIA-MM-NNNN                                
         MVI   LNGBILNO+1,C'-'                                                  
         MVC   LNGBILNO+2(2),BILLREF                                            
         MVI   LNGBILNO+4,C'-'                                                  
         MVC   LNGBILNO+5(4),BILLREF+2                                          
*                                                                               
ACCF26   MVI   JOBDATA,C'N'        ALWAYS RESET THIS                            
         OC    WARNRSNS,WARNRSNS   ANY WARNING MESSAGES?                        
         BZ    ACCF28              NO                                           
         LA    R3,WARNRSN          YES PRINT THEM                               
         LA    R4,WRN01                                                         
         GOTO1 WARNMSG,DMCB,(RC),(R3),(R4)                                      
*                                                                               
ACCF28   L     R2,AIO2             READ ACCOUNT RECORD                          
         L     RF,ADACC               TO RE-ESTABLISH SEQUENCE                  
         MVC   0(42,R2),0(RF)                                                   
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0                                                         
         BE    BASEXIT                                                          
         DC    H'0'                CAN'T READ ACCOUNT RECORD                    
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              FIRST FOR WORK CODE                                    *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
ANALFST  CLI   MODE,ANALFRST                                                    
         BNE   TRANREC                                                          
         CLI   BILLTYPE,NOTBILL    EXIT IF NON-BILLABLE                         
         BE    BASEXIT                                                          
         ZAP   WCODECD,=P'0'       CLEAR WORKCODE CASH DISCOUNT                 
         XC    SVAGWC,SVAGWC                                                    
         OI    WKCOPT,WKCDTL                                                    
         NI    WKCOPT,X'FF'-WKCMT  TURN MEDIA TRANSFER BIT OFF                  
*                                                                               
         L     R2,ADTRANS          SETUP DEFAULT NAME                           
         MVC   SVANAL,TRNANAL                                                   
         MVC   SVANALN,SPACES                                                   
         MVC   SVANALN(L'AC@OTHRS),AC@OTHRS                                     
         MVC   SVANALNS,SVANALN                                                 
         MVC   SVAGWC,SVANAL                                                    
*                                                                               
         L     R4,ADGOBLOC         CALL GETOPT FOR OPTIONS                      
         USING GOBLOCKD,R4                                                      
         L     R3,AMONACC                                                       
         USING ACMD,R3                                                          
         MVC   GOAKEY,ACMALTN       A(LAST RECORD READ)                         
         OC    SVASWRK,SVASWRK     DO WE HAVE AN ASP WORKCODE?                  
         BZ    ANLF02              NO                                           
         CLC   SVASWRKN,SPACES     DO WE HAVE A NAME?                           
         BNE   ANLF02              YES, SKIP THE GETOPT CALL                    
*                                                                               
         MVC   GOSELWC,SVASWRK     GET WORKCODE TYPE FOR ASP                    
         GOTO1 GETOPT,DMCB,ADGOBLOC                                             
         MVC   SVASWTYP,GOWRKTY    SAVE THE TYPE, IF ANY                        
*                                                                               
ANLF02   MVC   GOSELWC,SVANAL      READ FOR TRANSACTION WORKCODE NOW            
         L     R3,AMONACC                                                       
         USING ACMD,R3                                                          
         MVC   GOAKEY,ACMALTN       A(LAST RECORD READ)                         
         GOTO1 GETOPT,DMCB,ADGOBLOC                                             
         MVC   SVWCTYP,GOWRKTY     SAVE THE TYPE, IF ANY                        
         XC    GOAKEY,GOAKEY                                                    
         XC    GOSELWC,GOSELWC                                                  
         MVC   SVGSTCOD,GOTAXCOD   SAVE THE GST CODE                            
         MVC   SVPSTCOD,GOPSTCOD   SAVE THE PST CODE                            
         MVC   SVPSTPRV,GOPSTPRV   SAVE PROVINCE CODE                           
*                                                                               
         CLC   QTRNSFLT(2),SPACES  FILTERING BY WORKCODE?                       
         BE    ANLF04              NO                                           
         CLC   SVANAL,=C'99'       YES, ALWAYS EXCLUDE BILLING                  
         BE    BASEXIT                                                          
*                                                                               
ANLF04   L     R2,ADLEDGER         LOOK FOR DESCRIPTION                         
         MVI   ELCODE,X'12'                                                     
         BAS   RE,GETEL                                                         
         B     ANLF06+4                                                         
*                                                                               
         USING WCOELD,R2                                                        
ANLF06   BAS   RE,NEXTEL                                                        
         BNE   ANLF10                                                           
         CLC   SVANAL,WCOCODE                                                   
         BNE   ANLF08                                                           
         MVC   SVANALN(L'WCODESC),WCODESC                                       
         MVC   SVANALNS,SVANALN                                                 
         MVC   SVANWGP,WCOGRP                                                   
*                                                                               
         CLI   SVWCTYP,C' '        DID WE GET A TYPE?                           
         BH    *+10                YES                                          
         MVC   SVWCTYP,WCOTYPE    NO, GET FROM WORKCODE RECORD                  
         CLI   SVWCTYP,C' '        DO WE HAVE A TYPE?                           
         BH    *+8                 YES                                          
         MVI   SVWCTYP,C'O'        NO, DEFAULT IS OUT-OF=POCKET                 
*                                                                               
         CLI   GO1LINBL,C'Y'       IS IT ONE-LINE FOR WORKCODE?                 
         BNE   *+8                 NO                                           
         NI    WKCOPT,ALL-WKCDTL   YES, NO WORKCODE DETAILS THEN                
*                                                                               
         TM    WCOSTAT,X'01'      IS THIS A MEDIA TRANSFER CODE?                
         BZ    ANLF08              NO                                           
         OI    WKCOPT,WKCMT        YES, TURN BIT ON                             
*                                                                               
ANLF08   CLC   SVASWRK,WCOCODE                                                  
         BNE   ANLF06                                                           
         MVC   SVASWRKN(L'WCODESC),WCODESC                                      
         MVC   SVASWGRP,WCOGRP                                                  
         CLI   SVASWTYP,C' '       DID WE GET A TYPE?                           
         BH    *+10                YES                                          
         MVC   SVASWTYP,WCOTYPE   NO, GET FROM WORKCODE RECORD                  
         CLI   SVASWTYP,C' '       DO WE HAVE A TYPE?                           
         BH    *+8                 YES                                          
         MVI   SVASWTYP,C'O'       NO, DEFAULT IS OUT-OF=POCKET                 
         B     ANLF06                                                           
*                                                                               
ANLF10   TM    CLIOPT,USELONG      SHOULD WE LOOK FOR LONG NAMES?               
         BZ    ANLF14              NO                                           
*                                                                               
         USING WCNTABD,R4                                                       
         L     R4,ACMWCNMA         YES                                          
         LH    R2,ACMWCNMN                                                      
         LTR   R2,R2                                                            
         BZ    ANLF14                                                           
*                                                                               
ANLF12   CLC   SVANAL,WCNCODE                                                   
         BNE   *+10                                                             
         MVC   SVANALN,WCNNAME                                                  
         CLC   SVASWRK,WCNCODE                                                  
         BNE   *+10                                                             
         MVC   SVASWRKN,WCNNAME                                                 
         LA    R4,WCNTABL(R4)                                                   
         BCT   R2,ANLF12                                                        
*                                                                               
         USING GOXBLKD,R4                                                       
ANLF14   L     R4,ACMAGOX                                                       
         OC    GOAGWC,GOAGWC       IF WE HAVE OVERRIDE, USE IT                  
         BZ    *+10                                                             
         MVC   SVAGWC,GOAGWC                                                    
*                                                                               
         CLC   SVANAL,=C'99'                                                    
         BNE   BASEXIT                                                          
         CLI   JOBDATA,C'Y'        DOES JOB HAVE ANY DATA?                      
         BNE   BASEXIT             NO                                           
*                                  POST RETAINER                                
         GOTO1 SHR,DMCB,('SUBRRET',(RC))                                        
*                                  HANDLE CASH DISCOUNT                         
         GOTO1 CDFORM,DMCB,(RC)                                                 
*                                                                               
         GOTO1 POST,DMCB,('POSTBILL',(RC))                                      
*                                                                               
*                                  ADD TO CLIENT AND PRODUCT SUMMARIES          
         GOTO1 ADD2SUM,DMCB,(RC)                                                
*                                                                               
*                                  UPDATE/CLEAR BUFFALO                         
         TM    GRPOPT,GRPBILL                                                   
         BNO   ANLF16              NOT A GROUP BILL                             
         MVI   BYTE,TRATYPE3       ADD PRODUCTION CHARGES TO GROUP              
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,TRATYPE4       ADD MEDIA CHARGES TO GROUP                   
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,MRCTYPE5       ADD RECAP TO GROUP                           
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
*                                                                               
ANLF16   MVI   BYTE,GSTTYPE5       ADD GST TO GROUP                             
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,PSTTYPE7       ADD PST TO GROUP                             
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
*                                                                               
         MVC   SVANALN(L'AC@PRVBS),AC@PRVBS                                     
         B     BASEXIT                                                          
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
*              PROCESS A TRANSACTION                                  *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
TRANREC  CLI   MODE,PROCTRNS                                                    
         BNE   ANALLST                                                          
         L     R2,ADTRANS                                                       
         CLI   TRNEL,X'44'                                                      
         BNE   BASEXIT                                                          
         CLI   BILLTYPE,NOTBILL    EXIT IF NON-BILLABLE                         
         BE    BASEXIT                                                          
         NI    BILLOPT,ALL-WRITE                                                
         CLC   TRNANAL,=C'**'     IGNORE ORDERS                                 
         BE    BASEXIT                                                          
*                                                                               
         XC    CONTRA,CONTRA       CLEAR CONTRA SAVE AREA                       
*                                                                               
         MVC   HGSTCOD,SVGSTCOD    SAVE GST CODE                                
         MVC   HPSTCOD,SVPSTCOD    SAVE PST CODE                                
         MVC   HPSTPRV,SVPSTPRV    SAVE PROVINCE CODE                           
*                                                                               
         MVI   BUFFTYPE,FRMTYPEA   INITIALIZE TO 'ALL'                          
*                                                                               
         LR    R3,R2                                                            
         SH    R3,DATADISP                                                      
         USING TRNRECD,R3                                                       
*                                                                               
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    TRAN04              NO                                           
         CLC   TRNANAL,=C'99'      YES, IS THIS PREVIOUS BILLING?               
         BE    BASEXIT             YES, GET OUT                                 
*                                                                               
TRAN02   GOTO1 SHR,DMCB,('SUBRCHK',(RC))    NO, GET 77 INFORMATION              
         CLI   MODE,WRITRANS       WRITRANS ONLY IF DELETING ALLOCATION         
         BNE   *+8                 NO                                           
         BAS   RE,UPTRXEL          YES, MUST UPDATE THE EXTRA STATUS            
*                                                                               
         TM    BILLMODE,RERUN      ARE WE RERUNNING UNBILLING?                  
         BZ    *+12                NO                                           
         CLI   CANRERUN,C'Y'       YES, CAN WE RERUN IT?                        
         B     *+8                                                              
         CLI   CANUNBIL,C'Y'       CAN WE UNBILL IT?                            
         BNE   BASEXIT             NO                                           
         B     TRAN12              GO SET FORMTYPE                              
*                                                                               
TRAN04   CLC   TRNANAL,=C'99'     NO, IS THIS PREVIOUS BILLING?                 
         BNE   TRAN06              NO                                           
*                                                                               
         CLC   QTRNSFLT(2),SPACES  YES, FILTERING BY WORKCODE?                  
         BNE   BASEXIT             YES, EXCLUDE BILLING                         
         CLI   QAPPL+3,C' '        NO,  FILTERING BY TYPE?                      
         BNE   BASEXIT             YES, EXCLUDE BILLING                         
         CLI   JOBDATA,C'Y'        DOES JOB HAVE ANY OTHER DATA?                
         BNE   BASEXIT             NO, EXCLUDE BILLING THEN                     
*                                                                               
         BAS   RE,ADDABILL                                                      
         CLI   PREVOPT,C'Y'        SUPPRESS PREVIOUS DETAIL?                    
         BE    TRAN52              YES                                          
         MVI   BUFFTYPE,FRMTYPEB   YES, SET TYPE                                
         BAS   RE,POSTFORM         AND ADD TO BUFFALO                           
         B     TRAN52                                                           
*                                                                               
TRAN06   TM    BILLMODE,RERUN      ARE WE RERUNNING?                            
         BO    TRAN02              YES, SET TYPE FROM ORGINAL                   
         CLC   TRNDATE,ENDATE      IS TRANSACTION PAST END DATE?                
         BH    BASEXIT             YES                                          
         CLI   TRNTYPE,50          NO, IS THIS TALENT INTERFACE?                
         BNE   TRAN07              NO                                           
         CLI   PROF34,C'Y'         YES, ARE WE INCLUDING TALENT?                
         BNE   BASEXIT             NO                                           
*                                                                               
TRAN07   TM    REQOPT,REQPRDO      IS REQUEST FOR PRODUCTION ONLY?              
         BZ    TRAN08              NO                                           
         TM    WKCOPT,WKCMT        YES, IS THIS A MEDIA CHARGE?                 
         BO    BASEXIT             YES                                          
         B     TRAN10                                                           
*                                                                               
TRAN08   TM    REQOPT,REQMEDO      IS REQUEST FOR MEDIA ONLY?                   
         BZ    TRAN10              NO                                           
         TM    WKCOPT,WKCMT        YES, IS THIS A MEDIA CHARGE?                 
         BZ    BASEXIT             NO                                           
*                                                                               
TRAN10   CLC   QAPPL(3),SPACES     ANY PARTICULAR JOB GROUP?                    
         BE    TRAN12              NO                                           
*                                                                               
         TM    QAPPL,X'40'                                                      
         BO    TRAN11                                                           
*                                                                               
         MVC   WORK(3),QAPPL                                                    
         OI    WORK,X'40'                                                       
         CLC   JGROUP,WORK                                                      
         BE    BASEXIT                                                          
         B     TRAN12                                                           
*                                                                               
TRAN11   CLC   JGROUP,QAPPL        YES, DOES THIS MATCH?                        
         BNE   BASEXIT             NO, SKIP IT                                  
*                                                                               
TRAN12   CLI   QAPPL+3,C' '        ANY PARTICULAR WORKCODE TYPE?                
         BE    TRAN14              NO                                           
         CLC   SVWCTYP,QAPPL+3     YES, DOES THIS MATCH?                        
         BNE   BASEXIT             NO                                           
*                                                                               
TRAN14   CLI   READALL,C'Y'        ARE WE READING ALL TRANSACTIONS?             
         BE    TRAN28              YES, SEE IF ANYTHING ALLOCATED               
*                                                                               
         CLI   SVWCTYP,C'P'        IS THIS PREBILLING?                          
         BE    TRAN24              YES, SEE IF WE NEED IT                       
         CLI   SVWCTYP,C'M'        NO, IS THIS MEDIA TRANSFER?                  
         BE    TRAN22              YES, SEE IF WE NEED IT                       
         CLI   SVWCTYP,C'T'        NO, IS THIS TIME?                            
         BE    TRAN20              YES, SEE IF WE NEED IT                       
         CLI   SVWCTYP,C'O'        NO, IS IT OUT-OF-POCKET?                     
         BE    TRAN16              YES, SEE IF WE NEED IT                       
         CLI   SVWCTYP,C'R'        NO, IS IT RETAINER?                          
         BE    TRAN18              YES, SEE IF WE NEED IT                       
         CLI   SVWCTYP,C' '        BLANK IS ALSO OUT-OF-POCKET                  
         BNE   BASEXIT             NOT VALID TYPE                               
*                                                                               
TRAN16   CLI   READTYPO,C'Y'       ARE WE READING OUT-OF-POCKET?                
         BNE   BASEXIT             NO, EXIT                                     
         MVI   BUFFTYPE,FRMTYPEO   YES, SET TYPE FOR BUFFALO                    
         B     TRAN28              SEE IF ANYTHING IS ALLOCATED                 
*                                                                               
TRAN18   CLI   READTYPR,C'Y'       DO WE NEED RETAINERS?                        
         BNE   BASEXIT             NO                                           
         MVI   BUFFTYPE,FRMTYPER   YES, SET TYPE FOR BUFFALO                    
         CLI   TRNTYPE,EPTYPE      IS THIS A TYPE 47?                           
         BE    TRAN28              YES, CONTINUE                                
         MVI   BUFFTYPE,FRMTYPET   NO, MAKE IT TIME THEN                        
         B     TRAN28                                                           
*                                                                               
TRAN20   CLI   READTYPT,C'Y'       DO WE NEED TIME?                             
         BNE   BASEXIT             NO, EXIT                                     
         MVI   BUFFTYPE,FRMTYPET   YES, SET TYPE FOR BUFFALO                    
         B     TRAN28              SEE IF ANYTHING IS ALLOCATED                 
*                                                                               
TRAN22   CLI   READTYPM,C'Y'       DO WE NEED MEDIA?                            
         BNE   BASEXIT             NO, EXIT                                     
         MVI   BUFFTYPE,FRMTYPEM   YES, SET TYPE FOR BUFFALO                    
         B     TRAN28              SEE IF ANYTHING IS ALLOCATED                 
*                                                                               
TRAN24   CLI   READTYPP,C'Y'       DO WE NEED PRE-BILL?                         
         BNE   BASEXIT             NO, EXIT                                     
         CLI   FORMTYP,C'1'        IS THIS FORMAT #1?                           
         BE    TRAN26              YES                                          
         CLI   TRNTYPE,EPRTYPE     NO, IS THIS A TYPE 48?                       
         BNE   BASEXIT             NO, MUST BE FOR FORMAT #2,#3,#4              
         MVI   BUFFTYPE,FRMTYPEL   YES, SET TYPE FOR BUFFALO                    
         B     TRAN28              SEE IF ANYTHING ALLOCATED                    
*                                                                               
TRAN26   MVI   BUFFTYPE,FRMTYPEP   YES, SET TYPE FOR BUFFALO                    
*                                                                               
TRAN28   TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    TRAN30              NO                                           
*                                  YES, CLEAR DATE IF SET                       
         XC    TRNRECD+ACCOUSED(2),TRNRECD+ACCOUSED                             
         B     TRAN34                                                           
*                                                                               
TRAN30   TM    BILLMODE,RERUN      ARE WE RERUNNING?                            
         BO    TRAN34              YES, ALREADY CHECKED THIS                    
         GOTO1 SHR,DMCB,('SUBRCHK',(RC))    GET 77 INFORMATION                  
*                                                                               
TRAN32   DS    0H                  IS JOB FULLY BILLED?                         
         OC    TRNRECD+ACCOUSED(2),TRNRECD+ACCOUSED                             
         BNZ   BASEXIT             YES, EXIT                                    
         CLI   ALLOCATE,C'Y'       NO, ANYTHING ALLOCATED?                      
         BNE   BASEXIT             NO, EXIT                                     
*                                                                               
TRAN34   OI    BILLOPT,WRITE       YES                                          
         MVC   PRENAME,SVANALN     SAVE WORKCODE NAME FOR FORMAT#1              
         BAS   RE,ESTRATES         GET COMMISSION RATE                          
         BAS   RE,GETRATE                                                       
         BAS   RE,POSTRANS         GET DETAILS AND POST                         
         BAS   RE,POSTFORM         FORMATTED POSTINGS ARE DIFFERENT             
         B     TRAN50                                                           
         EJECT                                                                  
***********************************************************************         
*              BILL/UNBILL TRANSACTION LOGIC                          *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
TRAN50   BAS   RE,POSTGST          MAKE GST POSTINGS                            
         BAS   RE,POSTPST          MAKE PST POSTINGS                            
         MVC   SVGSTCOD,HGSTCOD    RESTORE GST CODE FROM GETOPT                 
         MVC   SVPSTCOD,HPSTCOD    RESTORE PST CODE FROM GETOPT                 
         MVC   SVPSTPRV,HPSTPRV    RESTORE PROVINCE CODE FROM GETOPT            
*                                                                               
TRAN52   L     R2,ADTRANS                                                       
         TM    BILLMODE,DRAFT                                                   
         BO    BASEXIT                                                          
         TM    BILLOPT,WRITE                                                    
         BZ    BASEXIT                                                          
         AP    MARKED,AMOUNT       ADD AMOUNT MARKED                            
*                                                                               
         USING CACELD,R4                                                        
         L     R4,ADSUBAC                                                       
         GOTO1 POST,DMCB,('POSTSK',(RC))                                        
*                                                                               
         CLI   TRNTYPE,EPTYPE     ESTIMATED PRODUCTION?                         
         BNE   TRAN56              NO                                           
         GOTO1 POST,DMCB,('POSTEST',(RC))        YES, POST REVERSAL             
         CLI   EPRFILT2,0          AUTO FILTER2 FOR EP REVERSAL?                
         BE    TRAN56              NO                                           
         L     R2,ADACC            YES, GET JOB ELEMENT                         
         MVI   ELCODE,X'26'                                                     
         BAS   RE,GETEL                                                         
         L     RF,ADACCSTA                                                      
         USING RSTELD,RF                                                        
         BNE   TRAN54                                                           
         USING JOBELD,R2                                                        
         CLI   JOBLN,JOBLN3Q    IS THIS IN OLD FORMAT?                          
         BL    TRAN54              YES                                          
         MVC   JOBF2BLB,RSTFILT1+1 NO,SAVE FOR FILTER 2                         
*                                                                               
TRAN54   MVC   RSTFILT1+1(1),EPRFILT2   ADD FILTER 2 FOR EP REVERSE             
*                                                                               
TRAN56   BAS   RE,UPTRXEL          UPDATE EXTRA STATUS ELEMENT                  
*                                                                               
TRAN58   MVI   MODE,WRITRANS                                                    
         B     BASEXIT                                                          
         DROP  R2,R3,R4,RF                                                      
         EJECT                                                                  
***********************************************************************         
*              LAST FOR WORKCODE                                      *         
***********************************************************************         
*                                                                               
ANALLST  CLI   MODE,ANALLAST                                                    
         BNE   ACCLST                                                           
         CLI   BILLTYPE,NOTBILL    EXIT IF NON-BILLABLE                         
         BE    BASEXIT                                                          
         CLC   SVANAL,=C'**'       IGNORE ORDERS                                
         BE    BASEXIT                                                          
         MVC   TEMPWK,JOBWKC                                                    
         MVC   JOBWKC(JOBLNQ),ZEROS                                             
         B     BASEXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              LAST FOR ACCOUNT                                       *         
***********************************************************************         
*                                                                               
ACCLST   CLI   MODE,ACCLAST                                                     
         BNE   LEVBLST                                                          
         CLI   BILLTYPE,NOTBILL    EXIT IF NON-BILLABLE                         
         BE    BASEXIT                                                          
         CLI   JOBDATA,C'Y'        DID JOB HAVE ANY DATA?                       
         BNE   ACCL22              NO                                           
         MVC   BILDATA,JOBDATA     YES, INDICATE WE HAVE BILLING                
*                                                                               
         CLC   SVANAL,=C'99'       BILLING?                                     
         BNE   ACCL00              NO                                           
         CLC   QTRNSFLT(2),SPACES  YES, FILTERING BY WORKCODE?                  
         BE    ACCL04              NO                                           
*                                                                               
*                                  POST RETAINER                                
ACCL00   GOTO1 SHR,DMCB,('SUBRRET',(RC))                                        
*                                                                               
*                                  HANDLE CASH DISCOUNT                         
         GOTO1 CDFORM,DMCB,(RC)                                                 
*                                                                               
*                                  MAKE REGULAR POSTINGS                        
         GOTO1 POST,DMCB,('POSTBILL',(RC))                                      
*                                                                               
*                                  ADD TO CLIENT AND PRODUCT SUMMARIES          
         GOTO1 ADD2SUM,DMCB,(RC)                                                
*                                                                               
*                                  UPDATE/CLEAR BUFFALO                         
         TM    GRPOPT,GRPBILL                                                   
         BNO   ACCL02              NOT A GROUP BILL                             
         MVI   BYTE,TRATYPE3       ADD PRODUCTION CHARGES TO GROUP              
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,TRATYPE4       ADD MEDIA CHARGES TO GROUP                   
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,MRCTYPE5       ADD RECAP TO GROUP                           
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
*                                                                               
ACCL02   MVI   BYTE,GSTTYPE5       ADD GST TO GROUP                             
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,PSTTYPE7       ADD PST TO GROUP                             
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
*                                                                               
ACCL04   TM    BILLMODE,DRAFT      IS THIS A DRAFT?                             
         BO    ACCL14              YES                                          
         L     RF,ADACCSTA         NO, GET STATUS ELEMENT                       
         USING RSTELD,RF                                                        
         MVC   RSTPBILL,TODAY2     UPDATE WITH TODAYS DATE                      
         MVI   MODE,WRITACC                                                     
*                                                                               
         L     R2,ADACC            YES, GET X'50' ELEMENT                       
         MVI   ELCODE,SCIELQ                                                    
         BAS   RE,GETEL                                                         
         B     *+8                                                              
*                                                                               
ACCL06   BAS   RE,NEXTEL                                                        
         BNE   ACCL12              CAN'T FIND IT                                
         USING SCIELD,R2                                                        
         CLI   SCITYPE,SCITCBAP    FIND ALLOCATED TYPE                          
         BE    ACCL08                                                           
         CLI   SCITYPE,SCITT99S    AND TODAY'S 99 TYPE                          
         BNE   ACCL06                                                           
         AP    SCIAMNT,AMOUNTSJ                                                 
         B     ACCL14                                                           
*                                                                               
ACCL08   LA    R3,SCIAMNT          GET NET BUCKET                               
         LA    R4,SCIUNET          GET AMOUNT CALCULATED                        
         LA    R5,SUBSCI           ADDRESS BILL INSTRUCTION                     
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    ACCL10              NO                                           
         CLI   QOPT3,C'Y'          YES, ARE WE REALLOCATING?                    
         BNE   ACCL06              NO, DON'T UPDATE THIS TYPE                   
         LA    R5,ZAPSCI           YES, CHANGE INSTRUCTION                      
ACCL10   EX    0,0(R5)                                                          
*                                                                               
         CLI   SCILN,SCILN2Q       CHECK THE LENGTH                             
         BL    ACCL06                                                           
         LA    R3,SCIADMN                                                       
         LA    R4,SCIUCOM                                                       
         EX    0,0(R5)                                                          
         B     ACCL06                                                           
*                                                                               
ZAPSCI   ZAP   0(6,R3),0(6,R4)                                                  
SUBSCI   SP    0(6,R3),0(6,R4)                                                  
*                                                                               
ACCL12   LA    R2,WORK             ADD SCIEL FOR TODAY'S 99'S                   
         XC    WORK,WORK                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,SCITT99S                                                 
         ZAP   SCIAMNT,AMOUNTSJ                                                 
*                                                                               
         L     R4,ADACC                                                         
         GOTO1 ADDEL,DMCB,(RC)                                                  
*                                                                               
ACCL14   GOTO1 POST,DMCB,('POSTINTR',(RC))                                      
*                                                                               
ACCL16   TM    GRPOPT,GRPBILL      IS THIS A GROUP BILLING?                     
         BZ    ACCL18              NO                                           
         CLI   FORMTYP,C'4'        IF FORMAT 4,5 OR 6, SHOW DETAIL              
         BE    ACCL18                                                           
         CLI   FORMTYP,C'5'                                                     
         BE    ACCL18                                                           
         CLI   FORMTYP,C'6'                                                     
         BNE   BASEXIT                                                          
*                                                                               
ACCL18   GOTO1 FORM,DMCB,(RC)      YES, PRINT IT                                
         CLI   JOBDATA,C'Y'        DO WE HAVE ANY DATA TO PRINT?                
         BNE   ACCL20              NO                                           
         TM    GRPOPT,GRPBILL      IS THIS A GROUP BILLING?                     
         BO    ACCL20              YES, COMMENTS ARE DONE LATER                 
         GOTO1 PRNT,DMCB,('PRNTCOM',(RC))   PRINT JOB COMMENTS NOW              
*                                                                               
ACCL20   MVI   BYTE,FRMTYPEP       AND CLEAR BUFFALO                            
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPET                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEO                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
*                                                                               
         TM    GRPOPT,GRPBILL      IS THIS A GROUP BILLING?                     
         BO    BASEXIT             YES, EXIT HERE                               
*                                                                               
         MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',2)                    
         MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',2)                    
         MVI   BYTE,FRMTYPEL                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEB                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEM                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEA                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
*                                                                               
         MVI   BYTE,TRATYPE3       CLEAR BUFFALO                                
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,TRATYPE4                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,MRCTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         TM    BILLOPT,OLDNUM      ARE WE USING THE OLD NUMBERS?                
         BO    BASEXIT             YES, DON'T UPDATE THE RECORD THEM            
         NI    RUNOPT,X'FF'-(BILNUM)                                            
         CLI   JOBDATA,C'Y'        DID THIS JOB HAVE DATA?                      
         BNE   BASEXIT             NO, DON'T UPDATE THE BILL NUMBER             
         BAS   RE,UPBIL            YES, UPDATE IT                               
         B     BASEXIT                                                          
*                                                                               
         USING NOBD,RF                                                          
ACCL22   CLC   QUESTOR(7),=C'SUMMARY'    SPECIAL I.D.?                          
         BE    ACCL24              YES                                          
         CLC   QPROG,=C'28'        IS THIS A DRAFT?                             
         BNE   ACCL26              NO                                           
         CLI   PROF21,C'Y'         WANT NON-BILLABLE DETAILS?                   
         BNE   ACCL26              NO                                           
*                                                                               
ACCL24   L     RF,ANOBWK           YES, ADD TO UNBILLABLE JOB TABLE             
         LA    R1,NOBLNQ                                                        
         SLL   R1,16                                                            
         ST    R1,NOBLEN                                                        
         MVI   NOBTYP,NOBEQU                                                    
*                                                                               
         L     R2,ADACC                                                         
         MVC   NOBCLI(12),3(R2)                                                 
         MVC   NOBDATA,SPACES                                                   
         MVC   NOBDATA(L'NOBMESS),NOBMESS                                       
         GOTO1 SORTER,DMCB,=C'PUT',ANOBWK                                       
         MVI   ALSORT,1                                                         
*                                                                               
ACCL26   TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    ACCL16              NO                                           
         TM    BILLMODE,DRAFT      YES, IS IT A DRAFT?                          
         BO    ACCL16              YES, DON'T BOTHER UNMARKING                  
         GOTO1 UNMARK,DMCB,(RC)    NO, UNMARK THE 99 TRANSACTION                
         B     ACCL16                                                           
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
*              LAST FOR PRODUCT                                       *         
***********************************************************************         
*                                                                               
LEVBLST  CLI   MODE,LEVBLAST                                                    
         BNE   LEVALST                                                          
         TM    GRPOPT,GRPBILL      YES, ARE WE GROUP BILLING?                   
         BZ    LEVBL04             NO                                           
*                                                                               
         CLI   FORMTYP,C'4'        YES, FORMAT 4?                               
         BL    LEVBL06             NO                                           
         CLI   FORMTYP,C'6'        5, OR 6?                                     
         BH    LEVBL06             NO                                           
*                                                                               
LEVBL02  CLI   GRPTYPE,C'P'        IS THIS A PRODUCT GROUP LEVEL?               
         BE    LEVBL08             YES, PRINT IT AND POST RECEIVABLE            
         GOTO1 FORM,DMCB,(RC)      NO, JUST PRINT IT                            
         B     BASEXIT                                                          
*                                                                               
LEVBL04  GOTO1 PPROSUM,DMCB,(RC)   PRINT PRODUCT SUMMARY                        
         TM    GRPOPT,GRPBILL      IS THIS A GROUP BILLING?                     
         BZ    BASEXIT             NO                                           
*                                                                               
LEVBL06  CLI   GRPTYPE,C'P'        YES, IS IT A PRODUCT GROUP BILL?             
         BNE   BASEXIT             NO                                           
*                                                                               
LEVBL08  GOTO1 PRNT,DMCB,('PRNTFGP',(RC))  YES, PRINT GROUP SUMMARY             
         MVI   BYTE,TRATYPE3       CLEAR BUFFALO                                
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,TRATYPE4                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,MRCTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,FRMTYPEP                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPET                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEO                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEL                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEB                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEM                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',2)                    
         MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',2)                    
         CLI   BILDATA,C'Y'        WAS THERE ANY BILLING?                       
         BNE   *+8                 NO                                           
         BAS   RE,UPBIL            YES, UPDATE BILL NUMBER                      
         B     BASEXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              LAST FOR CLIENT                                        *         
***********************************************************************         
*                                                                               
LEVALST  CLI   MODE,LEVALAST                                                    
         BNE   REQLST                                                           
         TM    GRPOPT,GRPBILL      YES, ARE WE GROUP BILLING ALSO?              
         BO    LEVAL04             YES                                          
*                                                                               
LEVAL02  GOTO1 PCLISUM,DMCB,(RC)   PRINT CLIENT SUMMARY                         
         TM    GRPOPT,GRPBILL      IS THIS A GROUP BILLING?                     
         BZ    LEVAL10             NO                                           
         CLI   GRPTYPE,C'C'        YES, IS IT A CLIENT GROUP BILL?              
         BNE   LEVAL10             NO                                           
         GOTO1 PRNT,DMCB,('PRNTFGP',(RC))    YES, PRINT GROUP SUMMARY           
         B     LEVAL08                                                          
*                                                                               
LEVAL04  CLI   GRPTYPE,C'C'        IS THIS A CLIENT GROUP BILL?                 
         BNE   LEVAL06             NO, ALREADY PRINTED BILL                     
         GOTO1 PRNT,DMCB,('PRNTFGP',(RC))    YES, PRINT GROUP BILLS             
         CLI   BILDATA,C'Y'        WAS THERE ANY BILLING?                       
         BNE   *+8                 NO                                           
         BAS   RE,UPBIL            YES, UPDATE BILL NUMBER                      
*                                                                               
LEVAL06  GOTO1 PPROSUM,DMCB,(RC)   PRINT BOTH SUMMARIES NOW                     
         GOTO1 PCLISUM,DMCB,(RC)                                                
*                                                                               
LEVAL08  MVI   BYTE,TRATYPE3       CLEAR BUFFALO                                
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,TRATYPE4                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,MRCTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,FRMTYPEP                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPET                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEO                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEL                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEB                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,FRMTYPEM                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',1)                  
         MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',2)                    
         MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',2)                    
*                                                                               
LEVAL10  TM    BILLMODE,DRAFT                                                   
         BO    BASEXIT                                                          
         TM    RUNOPT,SOON         IS THIS A SOON BILL?                         
         BO    BASEXIT             YES, CAN'T WRITE BACK CLIENT YET             
*                                                                               
         TM    RUNOPT,WRITLVA      BILL# BY CLIENT?                             
         BZ    BASEXIT             NO                                           
         NI    RUNOPT,ALL-WRITLVA                                               
         MVI   MODE,WRITLEVA       YES, WRITE BACK THE CLIENT                   
         B     BASEXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              LAST FOR REQUEST, LEDGER AND RUN                       *         
***********************************************************************         
*                                                                               
REQLST   CLI   MODE,REQLAST                                                     
         BNE   LEDGLST                                                          
         CLI   PRINTED,C'Y'        DID WE PRINT ANYTHING?                       
         BE    REQLX               YES                                          
         CLI   ARCHIVE,C'Y'        ARCHIVING?                                   
         BNE   REQLX               NO, SKIP THE BLANK PAGE                      
         MVI   FORCEHED,C'Y'                                                    
         MVI   RCSUBPRG,21                                                      
         MVC   P,SPACES                                                         
         MVC   PSECOND,SPACES                                                   
         MVC   PTHIRD,SPACES                                                    
         MVC   P(L'AC@REQDE),AC@REQDE                                           
         GOTO1 HEXOUT,DMCB,QCOMPANY,PSECOND,1,=C'TOG',2                         
         MVC   PSECOND+3(L'QRECORD),QRECORD                                     
         MVI   PSECOND+3+(QCOMPANY-QRECORD),C' '                                
         MVC   PTHIRD(L'QRECORD2),QRECORD2                                      
         GOTO1 ACREPORT                                                         
         MVC   P(22),=C'**NO BILLING GENERATED'                                 
         GOTO1 ACREPORT                                                         
         MVI   RCSUBPRG,0                                                       
*                                                                               
REQLX    B     BASEXIT                                                          
         SPACE 3                                                                
LEDGLST  CLI   MODE,LEDGLAST                                                    
         BNE   RUNLST                                                           
         TM    BILLMODE,DRAFT                                                   
         BO    BASEXIT                                                          
         TM    RUNOPT,SOON         RUNNING SOON?                                
         BO    LEDGL02             YES, WRITE CLIENT RECORD BACK HERE           
         TM    RUNOPT,WRITLG       BILL# BY LEDGER?                             
         BZ    BASEXIT             NO                                           
         MVI   MODE,WRITLEDG       YES, WRITE BACK THE LEDGER                   
         B     BASEXIT                                                          
*                                                                               
* THE CLIENT IS UNLOCKED HERE BECAUSE IT CANNOT BE UNLOCKED AT LEVALAST         
* OR LEVEBLAST SINCE THOSE MODES ARE NOT PASSED IF THERE IS NO DATA FOR         
* A CLIENT.                                                                     
* THE LEDGER IS UNLOCKED AT RUNLAST BECAUSE MODE CAN ONLY INDICATE ONE          
* RECORD FOR UPDATE.                                                            
*                                                                               
LEDGL02  L     R2,ADHEIRA          UNLOCK THE CLIENT HERE ALSO                  
         MVI   ELCODE,LOKELQ                                                    
         BAS   RE,GETEL                                                         
         BNE   LEDGL04                                                          
*                                                                               
         USING LOKELD,R2                                                        
         XC    LOKDATE,LOKDATE                                                  
         NI    LOKSTAT,X'FF'-LOKSLOCK                                           
*                                                                               
LEDGL04  MVI   MODE,WRITLEVA        UPDATE THE CLIENT                           
         B     BASEXIT                                                          
*                                                                               
*                                                                               
RUNLST   CLI   MODE,RUNLAST                                                     
         BNE   BASEXIT                                                          
         CP    TAPECNT,=P'0'       ANY RECORDS POSTED?                          
         BE    RUNL02              NO                                           
         GOTO1 POST,DMCB,('POSTCLSE',(RC))       YES                            
*                                                                               
RUNL02   GOTO1 END,DMCB,(RC)                                                    
         GOTO1 SORTER,DMCB,=C'END'                                              
*                                                                               
         TM    RUNOPT,SOON         ARE WE RUNNING SOON?                         
         BZ    BASEXIT             NO                                           
*                                                                               
* THE LEDGER IS UNLOCKED HERE BECAUSE THE CLIENT IS BEING UNLOCKED AT           
* LEDGLAST AND MODE CAN ONLY INDICATE ONE RCORD FOR UPDATE.                     
*                                                                               
         L     R2,ADLEDGER                                                      
         MVI   ELCODE,LGLELQ       YES, UNLOCK THE LEDGER                       
         BAS   RE,GETEL                                                         
         BNE   RUNL04                                                           
*                                                                               
         USING LGLELD,R2                                                        
         XC    LGLDATE,LGLDATE                                                  
         NI    LGLSTAT,X'FF'-LGLSLOCK                                           
*                                                                               
RUNL04   MVI   MODE,WRITLEDG       WRITE THE LEDGER BACK                        
*                                                                               
         CP    TAPECNT,=P'0'       ANY RECORDS POSTED?                          
         BNE   *+10                YES                                          
         XC    WKID,WKID           NO, CLEAR THE WORKER FILE KEY                
         BAS   RE,SETFWRK          CALL FACWRK WITH THE DATA                    
         B     BASEXIT                                                          
         DROP  R2                                                               
         EJECT                                                                  
*                                                                               
*              ESTABLISH TAX RATES OR GET THEM FROM TABLE                       
*                                                                               
         USING VTCD,R2                                                          
         USING SVTABD,R4                                                        
GETRATE  NTR1                                                                   
         L     R2,AVATBUFF                                                      
         L     R4,ASVTABLE                                                      
         LA    R5,TAXNUM                                                        
         XC    SVGSTRAT,SVGSTRAT                                                
         XC    SVGSTIND,SVGSTIND                                                
         MVC   SVGSTACC,SPACES                                                  
         XC    SVPSTRAT,SVPSTRAT                                                
         XC    SVPSTIND,SVPSTIND                                                
         MVC   SVPSTACC,SPACES                                                  
         MVC   SVPSTNME,SPACES                                                  
*                                                                               
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    GETRX               NO, EXIT                                     
         OC    SVGSTCOD,SVGSTCOD   DO WE HAVE A GST CODE?                       
         BZ    GETR10              NO, LOOK FOR PST                             
*                                                                               
GETR02   CLI   SVCODE,X'00'        NOTHING IN TABLE OR END                      
         BE    GETR06                                                           
         CLI   SVTYPE,C'G' '       IS THIS A GST ENTRY?                         
         BNE   GETR04              NO, GET NEXT                                 
         CLC   SVGSTCOD,SVCODE     YES, DOES CODE MATCH?                        
         BNE   GETR04              NO, TRY NEXT                                 
         CLC   SVGSTDAT,SVDATE     YES, DOES DATE MATCH?                        
         BE    GETR08              YES                                          
*                                                                               
GETR04   LA    R4,SVTABLNQ(R4)                                                  
         BCT   R5,GETR02                                                        
         DC    H'0'                SHOULD NOT HAVE MORE THAN 30 CODES           
         DC    C'MORE THAN 30 GST/PST CODES'                                    
*                                                                               
GETR06   MVC   VTCTYPE,SVGSTCOD    PASS GST TYPE CODE                           
         XC    VTCPRV,VTCPRV       CLEAR PROVINCE CODE                          
         XC    VTCINDS,VTCINDS     CLEAR ERROR CODE                             
         GOTO1 VATICAN,(R2)                                                     
         TM    VTCINDS,VTCINA      IS TAX APPLICABLE?                           
         BO    GETR10              NO                                           
         CLI   VTCERR,X'00'        YES, FIND TYPE?                              
         BNE   GETR10              NO                                           
         MVC   SVRATE,VTCRATE      YES, PUT RATE,                               
         MVC   SVINDS,VTCINDS        DECIMALS                                   
         MVC   SVACCT,VTCACT           ACCOUNT,                                 
         MVC   SVCODE,SVGSTCOD           CODE                                   
         MVC   SVDATE,VTCEFFD             AND EFFECTIVE DATE IN TABLE           
         MVI   SVTYPE,C'G'         INDICATE GST CODE                            
*                                                                               
GETR08   MVC   SVGSTRAT,SVRATE     SAVE RATE/DECIMALS/ACCOUNT/DATE              
         MVC   SVGSTIND,SVINDS        FOR POSTFORM                              
         MVC   SVGSTACC,SVACCT                                                  
         MVC   SVGSTDAT,SVDATE                                                  
*                                                                               
GETR10   TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC?                      
         BZ    GETRX               NO, EXIT                                     
         OC    SVPSTCOD,SVPSTCOD   DO WE HAVE A PST CODE?                       
         BZ    GETRX               NO, EXIT                                     
         L     R4,ASVTABLE                                                      
         LA    R5,TAXNUM                                                        
*                                                                               
GETR12   CLI   SVCODE,X'00'        NOTHING IN TABLE OR END                      
         BE    GETR16                                                           
         CLI   SVTYPE,C'P'         IS THIS A PST ENTRY?                         
         BNE   GETR14              NO, GET NEXT                                 
         CLC   SVPSTCOD,SVCODE     YES, DOES THE CODE MATCH?                    
         BNE   GETR14              NO, TRY NEXT                                 
         CLC   SVPSTDAT,SVDATE     YES, DOES DATE MATCH?                        
         BNE   GETR14              NO, TRY NEXT                                 
         CLC   SVPSTPRV,SVPROV     YES, DOES PROVINCE MATCH?                    
         BE    GETR18              YES                                          
*                                                                               
GETR14   LA    R4,SVTABLNQ(R4)                                                  
         BCT   R5,GETR12                                                        
         DC    H'0'                SHOULD NOT HAVE MORE THAN 30 CODES           
         DC    C'MORE THAN 30 GST/PST CODES'                                    
*                                                                               
GETR16   MVC   VTCTYPE,SVPSTCOD    PASS PST TYPE CODE                           
         MVC   VTCPRV,SVPSTPRV     PASS PROVINCE CODE                           
         XC    VTCINDS,VTCINDS     CLEAR ERROR CODE                             
         XC    VTCPRVD,VTCPRVD     CLEAR PROVINCE DESCRIPTION                   
         GOTO1 VATICAN,(R2)                                                     
         TM    VTCINDS,VTCINA      IS TAX APPLICABLE?                           
         BO    GETRX               NO                                           
         CLI   VTCERR,X'00'        YES, FIND TYPE?                              
         BNE   GETRX               NO                                           
         MVC   SVNAME,VTCPRVD      YES, PUT NAME                                
         MVC   SVRATE,VTCRATE       RATE,                                       
         MVC   SVINDS,VTCINDS        DECIMALS                                   
         MVC   SVACCT,VTCACT          ACCOUNT,                                  
         MVC   SVCODE,SVPSTCOD         CODE                                     
         MVC   SVPROV,SVPSTPRV          PROVINCE                                
         MVC   SVDATE,VTCEFFD            AND EFFECTIVE DATE IN TABLE            
         MVI   SVTYPE,C'P'         INDICATE PST CODE                            
*                                                                               
GETR18   MVC   SVPSTRAT,SVRATE     SAVE RATE/DECIMALS/ACCOUNT/DATE/NAME         
         MVC   SVPSTIND,SVINDS                                                  
         MVC   SVPSTACC,SVACCT        FOR POSTFORM                              
         MVC   SVPSTDAT,SVDATE                                                  
         MVC   SVPSTNME,SVNAME                                                  
         MVC   SVPSTREG,VTCREG     REGISTRATION NUMBER                          
*                                                                               
GETRX    B     BASEXIT                                                          
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              GET COMMISSION RATE FROM GOBLOCK                       *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
ESTRATES L     R4,ADGOBLOC                                                      
         USING GOBLOCKD,R4                                                      
         ZAP   COMMRATE,=P'0'      ASSUME ZERO COMMISSION RATE                  
         TM    WKCOPT,WKCMT        YES, IS THIS A MEDIA TRANSFER?               
         BOR   RE                  YES, RETURN                                  
         ZAP   COMMRATE,GOAGYCOM                                                
         BR    RE                                                               
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              SET WARNING MESSAGE NUMBER                             *         
***********************************************************************         
*                                                                               
FILTNOW  SR    R1,R1                                                            
         IC    R1,WARNRSN                                                       
         BCTR  R1,0                                                             
         LA    R1,WARNRSNS(R1)                                                  
         MVC   0(1,R1),WARNRSN                                                  
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*              POST A TRANSACTION TO ACCUMULATORS                     *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
POSTRANS NTR1                                                                   
         L     R2,ADTRANS                                                       
         LR    R3,R2                                                            
         NI    BILLOPT,ALL-CASHD                                                
         ZAP   TOTAL,=P'0'         TOTAL BILLED AND ALLOCATED                   
         ZAP   AMOUNT,=P'0'        ALLOCATED AMOUNT                             
         ZAP   CASH,=P'0'          ALLOCATED CASH DISCOUNT                      
         ZAP   HOURS,=P'0'         ALLOCATED HOURS                              
         ZAP   RATE,=P'0'                                                       
         CLI   TRNEL,TRNELQ                                                     
         BNE   BASEXIT                                                          
*                                                                               
         ZAP   PL13,COMMRATE                                                    
         TM    TRNSTAT,X'01'       YES, IS IT NON-COMMISSIONABLE ITEM?          
         BNO   *+10                NO                                           
         ZAP   PL13,=P'0'          YES, CLEAR COMMISSION RATE                   
*                                                                               
         USING PRTELD,R2                                                        
         MVI   ELCODE,X'40'        GET THE RATE                                 
         BAS   RE,NEXTEL                                                        
         BNE   POSTT02                                                          
         ZAP   RATE,PRTRATE                                                     
*                                                                               
POSTT02  TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BO    POSTT30             YES, USE DIFFERENT ROUTINE                   
         TM    BILLMODE,RERUN      NO, ARE WE RERUNNING?                        
         BO    POSTT22             YES, USER DIFFERENT ROUTINE                  
*                                                                               
*                                                                               
***********************************************************************         
*                                  POST BILLING                       *         
***********************************************************************         
*                                                                               
         USING ACMD,R2                                                          
POSTT04  L     R2,AMONACC                                                       
         L     R2,ACMAPRO2                                                      
         CLI   0(R2),PTAELQ                                                     
         B     POSTT06+8                                                        
*                                                                               
         USING PTAELD,R2                                                        
POSTT06  MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BNE   POSTT14                                                          
*                                                                               
POSTT08  CLI   PTATYPE,PTATRAL     IS THIS ALLOCATED TO BILL?                   
         BNE   POSTT06             NO, GET NEXT ONE                             
         TM    PTASTAT1,PTASPEND   IS THIS PENDING?                             
         BO    POSTT12             YES, IT MEANS ALLOCATED                      
         AP    TOTAL,PTANET        NO, MEANS IT'S ALREADY BILLED                
         B     POSTT06                                                          
*                                                                               
POSTT12  AP    AMOUNT,PTANET       ALLOCATED AMOUNT                             
         AP    CASH,PTACDSC        CASH DISCOUNT                                
         ZAP   COMMISH,PTARCOM     COMMISSION AMOUNT                            
         AP    SCIUNET,AMOUNT                                                   
         AP    SCIUCOM,COMMISH                                                  
*                                                                               
         LH    RF,PTAHOURS         HOURS                                        
         CVD   RF,DUB                                                           
         AP    HOURS,DUB                                                        
*                                                                               
         TM    BILLMODE,RERUN      ARE WE RERUNING?                             
         BO    POSTT14             YES, SKIP OVER THIS                          
*                                                                               
         ZAP   PTARCORT,PL13       SAVE CURRENT COMMISSION RATE                 
*                                                                               
         ZAP   DUB,AMOUNT          RECALCULATE COMMISSION AMOUNT                
         AP    DUB,CASH                                                         
         MP    PL13,DUB                                                         
         SRP   PL13,64-6,5                                                      
         ZAP   COMMISH,PL13                                                     
         ZAP   PTARCOM,COMMISH                                                  
*                                                                               
         MVC   PTARDATE,TODAY2     TODAY'S DATE (RUN DATE)                      
         NI    PTASTAT1,X'FF'-PTASPEND                                          
*                                                                               
         MVC   PTARBLDT,RCDAY2     BILL DATE OR TODAY'S DATE                    
         MVC   PTAMOA,DATE3        MOA DATE                                     
         MVC   PTARBLNO,BILLREF                                                 
         MVC   PTARCODE,BILLCODE   SAVE THE BILLING TYPE                        
*                                                                               
         MVC   PTARFORM,FORMHOLD   SAVE FORMAT/GROUP LEVEL                      
         MVC   PTARTYPE,SVWCTYP    SAVE WORKCODE TYPE                           
         TM    RUNOPT,NEEDGST      ARE WE CALCULATING GST?                      
         BZ    POSTT06             NO                                           
         MVC   PTARGSTC,SVGSTCOD   YES, SAVE IT                                 
         MVC   PTARPSTC,SVPSTCOD   AND PST DATA AS WELL                         
         MVC   PTARPRVC,SVPSTPRV                                                
         B     POSTT06             GET NEXT ELEMENT                             
*                                                                               
         USING JOBD,R4                                                          
POSTT14  AP    TOTAL,AMOUNT        GET TOTAL BILLED AND ALLOCATED               
         CP    TOTAL,TRNAMNT-TRNELD(L'TRNAMNT,R3)                               
         BNE   POSTT16             NO                                           
*                                                                               
         USING TRNRECD,R3                                                       
         SH    R3,DATADISP         YES, MARK IT SO                              
         MVC   TRNRECD+ACCOUSED(2),TODAY2                                       
         AH    R3,DATADISP         GET BACK TO 44 ELEMENT                       
         DROP  R3                                                               
*                                                                               
         USING TRNELD,R3                                                        
POSTT16  CLI   TRNTYPE,EPTYPE                                                   
         BNE   *+16                                                             
         AP    SAVEPN,AMOUNT                                                    
         AP    SAVEPC,COMMISH                                                   
         DROP  R3                                                               
*                                                                               
         ZAP   CASH,CASH           ANY DISCOUNT?                                
         BZ    POSTT18             NO                                           
         OI    BILLOPT,CASHD       YES, INDICATE IT                             
         AP    SAVCD,CASH                                                       
         AP    WCODECD,CASH                                                     
*                                                                               
POSTT18  LA    R4,JOBDTL                                                        
         MVC   JOBBK(JOBLNQ),ZEROS CLEAR DETAIL LINE                            
         AP    JOBNET,AMOUNT       NET TO NET                                   
         AP    JOBGRS,AMOUNT              AMOUNT                                
*                                                                               
         AP    JOBVGRS,AMOUNT             GST GROSS                             
         AP    JOBVNET,AMOUNT             GST NET                               
         AP    JOBVBAS,AMOUNT             GST BASIS                             
*                                                                               
         AP    JOBPGRS,AMOUNT             PST GROSS                             
         AP    JOBPNET,AMOUNT             PST NET                               
         AP    JOBPBAS,AMOUNT             PST BASIS                             
*                                                                               
         AP    JOBCD,CASH          CD TO  CD                                    
         AP    JOBNET,CASH                  NET                                 
         AP    JOBGRS,CASH                  AMOUNT                              
*                                                                               
         AP    JOBHRS,HOURS        HOURS TO HOURS                               
*                                                                               
         AP    JOBCOM,COMMISH      COMMISSION TO COMMISSION                     
*                                                                               
         CLI   BUFFTYPE,FRMTYPEP   IS THIS PREBILLING?                          
         BNE   *+14                NO                                           
         AP    JOBPRE,AMOUNT       YES                                          
         B     POSTT20                                                          
*                                                                               
         CLI   BUFFTYPE,FRMTYPEO   IS THIS OUT-OF-POCKET?                       
         BNE   *+14                NO                                           
         AP    JOBOOP,AMOUNT       YES                                          
         B     POSTT20                                                          
*                                                                               
         CLI   BUFFTYPE,FRMTYPET   IS THIS TIME?                                
         BNE   *+20                NO                                           
         AP    JOBTME,AMOUNT       YES                                          
         AP    TOTTTYP,AMOUNT                                                   
         B     POSTT20                                                          
*                                                                               
         CLI   BUFFTYPE,FRMTYPER   IS THIS RETAINER?                            
         BNE   *+20                                                             
         AP    JOBRET,AMOUNT       YES                                          
         AP    TOTTTYP,AMOUNT                                                   
         B     POSTT20                                                          
*                                                                               
         CLI   BUFFTYPE,FRMTYPEM   IS THIS PRINT?                               
         BNE   *+10                                                             
         AP    JOBPRT,AMOUNT       YES                                          
         B     POSTT20                                                          
*                                                                               
         CLI   BUFFTYPE,FRMTYPEL   IS THIS PREVIOUSLY BILLED?                   
         BNE   *+10                NO                                           
         AP    JOBPRV,AMOUNT       YES                                          
*                                                                               
POSTT20  TM    WKCOPT,WKCMT        IS THIS A MEDIA TRANSFER?                    
*        BO    POSTTX              YES, EXIT                                    
*                                                                               
         AP    JOBGRS,COMMISH      COMMISSION TO GROSS                          
         AP    JOBVGRS,COMMISH                   GST GROSS                      
         AP    JOBPGRS,COMMISH                   PST GROSS                      
*                                                                               
         TM    CLIOPT,PAYNET                                                    
         BO    *+10                                                             
         AP    JOBVBAS,COMMISH                                                  
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,3,SVGSTRAT                                                    
         CVD   RE,DUB                                                           
*                                                                               
         ZAP   PL13,JOBVBAS        CALCULATE GST AMOUNT                         
         MP    PL13,DUB                                                         
         TM    SVGSTIND,VBIIDC3    DOES RATE HAVE 3 DECIMALS?                   
         BZ    *+14                NO                                           
         SRP   PL13,64-5,5         YES, SHIFT ONE MORE DIGIT                    
         B     *+10                                                             
         SRP   PL13,64-4,5                                                      
         ZAP   JOBGST,PL13          SAVE IT                                     
*                                                                               
         AP    JOBVNET,JOBGST                                                   
         AP    JOBVGRS,JOBGST                                                   
*                                                                               
         ZAP   JOBPBAS,JOBVBAS                                                  
         AP    JOBPBAS,JOBGST                                                   
*                                                                               
         CLC   SVPSTPRV,=C'PQ'     IS PROVINCE PQ?                              
         BNE   POSTT21             NO, BASIS INCLUDES GST                       
*                                                                               
         LA    R1,DATE3                                                         
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    *+8                 NO                                           
         LA    R1,CALLDATE         YES, USE THAT DATE                           
         CLC   0(3,R1),=X'B30101'  YES, IS BILL PRIOR TO 1/01/13?               
         BL    POSTT21             YES, INCLUDE THE GST IN THE BASIS            
         SP    JOBPBAS,JOBGST      NO, PST BASIS IS LESS GST THEN               
*                                                                               
POSTT21  SR    RE,RE                                                            
         ICM   RE,3,SVPSTRAT                                                    
         CVD   RE,DUB                                                           
*                                                                               
         ZAP   PL13,JOBPBAS        CALCULATE PST AMOUNT                         
         MP    PL13,DUB                                                         
         TM    SVPSTIND,PBIIDC3    DOES RATE HAVE 3 DECIMALS?                   
         BZ    *+14                NO                                           
         SRP   PL13,64-5,5         YES, SHIFT ONE MORE DIGIT                    
         B     *+10                                                             
         SRP   PL13,64-4,5                                                      
         ZAP   JOBPST,PL13          SAVE IT                                     
*                                                                               
         ZAP   JOBPNET,JOBVNET                                                  
         AP    JOBPNET,JOBPST                                                   
*                                                                               
         ZAP   JOBPGRS,JOBVGRS                                                  
         AP    JOBPGRS,JOBPST                                                   
*                                                                               
         GOTO1 SHR,DMCB,('SUBRSUML',(RC))   ADD DETAIL LINE TOTALS              
*                                                                               
POSTTX   B     BASEXIT                                                          
         DROP  R2                                                               
*                                                                               
*                                                                               
***********************************************************************         
*                                  POST BILLING RERUN                 *         
***********************************************************************         
*                                                                               
         USING ACMD,R2                                                          
POSTT22  L     R2,AMONACC                                                       
         L     R2,ACMAPRO2                                                      
         CLI   0(R2),PTAELQ                                                     
         B     POSTT24+8                                                        
*                                                                               
         USING PTAELD,R2                                                        
POSTT24  MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BE    *+6                                                              
         DC    H'0'                MUST BE THERE- SHR SAID SO                   
*                                                                               
         CLI   PTATYPE,PTATRAL     IS THIS ALLOCATED?                           
         BNE   POSTT24             NO, GET NEXT                                 
         TM    PTASTAT1,PTASPEND   YES, IS IT PENDING?                          
         BO    POSTT24             YES, ALLOCATED NOT BILLED YET                
         CLC   PTARDATE,TODAY2     NO, IS IT ONE WE WANT?                       
         BNE   POSTT24             NO                                           
         TM    PTASTAT1,PTASREVS   YES, IS THIS A REVERSE ELEMENT?              
         BO    POSTT24             YES, DON'T WANT IT                           
         B     POSTT12             YES, JOIN THE OTHER CODE                     
         DROP  R2                                                               
*                                                                               
*                                                                               
***********************************************************************         
*                                  POST UNBILLING                     *         
***********************************************************************         
*                                                                               
POSTT30  TM    BILLMODE,RERUN      ARE WE RERUNNING UNBILLING?                  
         BO    POSTT40             YES                                          
*                                                                               
         USING ACMD,R2                                                          
POSTT32  L     R2,AMONACC          LOOK FOR ITEM TO UNBILL                      
         L     R2,ACMAPRO2                                                      
         CLI   0(R2),PTAELQ                                                     
         B     POSTT34+8                                                        
*                                                                               
         USING PTAELD,R2                                                        
POSTT34  MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BE    *+6                 MUST HAVE THE ONE WE ARE UNBILLING           
         DC    H'0'                                                             
*                                                                               
         CLI   PTATYPE,PTATRAL     IS THIS ALLOCATED?                           
         BNE   POSTT34             NO, GET NEXT                                 
         TM    PTASTAT1,PTASPEND   YES, IS IT STILL PENDING?                    
         BO    POSTT34             YES, GET NEXT                                
*                                                                               
         CLC   PTARBLDT,USEBILL    DOES BILL DATE MATCH?                        
         BNE   POSTT34             NO                                           
         CLC   PTARBLNO,QSELECT    YES, IS BILL NUMBER CORRECT?                 
         BNE   POSTT34             NO                                           
         CLC   PTARDATE,USEDATE    YES, IS RUN DATE CORRECT?                    
         BNE   POSTT34             NO                                           
         CLC   PTARFORM,FORMHOLD   YES, CORRECT FORMAT/LEVEL?                   
         BNE   POSTT34             NO                                           
*                                                                               
         AP    AMOUNT,PTANET       YES, GET AMOUNT                              
         AP    CASH,PTACDSC        CASH DISCOUNT                                
         ZAP   COMMISH,PTARCOM     COMMISSION                                   
*                                                                               
         LH    RF,PTAHOURS         HOURS                                        
         CVD   RF,DUB                                                           
         MP    DUB,=P'-1'                                                       
         AP    HOURS,DUB                                                        
*                                                                               
         MP    AMOUNT,=P'-1'       REVERSE SIGNS                                
         MP    CASH,=P'-1'                                                      
         MP    COMMISH,=P'-1'                                                   
*                                                                               
         OI    PTASTAT1,PTASREVU   INDICATE REVERSED                            
         MVC   PTARUNBD,TODAY2     SAVE DATE UNBILLED                           
         MVC   PTARUNBB,BILLREF    SAVE UNBILLED BILL NUMBER                    
*                                                                               
         XC    ELEM,ELEM           CLEAR AREA FOR NEW ELEMENT                   
         SR    R1,R1                                                            
         IC    R1,PTALN                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELEM(0),PTAEL                                                    
*                                                                               
         BAS   RE,NEXTEL           LOOK FOR END OF ELEMENTS                     
         BE    *-4                                                              
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),ELEM        MOVE IT IN OFF R2                            
*                                                                               
         MVI   PTASTAT1,PTASREVS   UPDATE ELEMENT IN PLACE                      
*                                                                               
         MVC   PTARORGB,PTARBLNO   SAVE ORIGINAL BILL NUMBER                    
         MVC   PTARORGD,PTARBLDT   SAVE ORIGINAL BILL DATE                      
*                                                                               
         MVC   PTARDATE,TODAY2     UPDATE DATES                                 
         MVC   PTARBLDT,RCDAY2                                                  
         MVC   PTAMOA,DATE3                                                     
*                                                                               
         MVC   PTARBLNO,BILLREF    SAVE NEW BILL NUMBER                         
         MVC   PTARCODE,BILLCODE   SAVE THE BILLING TYPE                        
*                                                                               
         MP    PTANET,=P'-1'       REVERSE THE AMOUNTS                          
         MP    PTANETF,=P'-1'                                                   
         MP    PTACDSC,=P'-1'                                                   
         MP    PTARCOM,=P'-1'                                                   
         LH    RF,PTAHOURS                                                      
         LCR   RF,RF                                                            
         STH   RF,PTAHOURS                                                      
         LA    R2,1(R2,R1)         GET TO END OF ELEMENT                        
*                                                                               
         CLI   QOPT3,C'Y'          ARE WE REALLOCATING?                         
         BE    POSTT36             YES                                          
         MVI   0(R2),0             NO, MARK END OF RECORD                       
         B     POSTT16                                                          
*                                                                               
POSTT36  EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),ELEM        MOVE ELEMENT TO RECORD A 2ND TIME            
*                                                                               
         MVC   PTADATE,TODAY2      UPDATE ALLOCATE ELEMENT IN PLACE             
         MVI   PTASTAT1,PTASPEND                                                
         OI    PTASTAT1,PTASCASH                                                
*                                                                               
         XC    PTARDATE(PTARFCOM-PTARDATE),PTARDATE                             
*                                                                               
         ZAP   DUB,PTANET          RECALCULATE COMMISSION AMOUNT                
         AP    DUB,PTACDSC                                                      
         MP    PL13,DUB                                                         
         SRP   PL13,64-6,5                                                      
         ZAP   PTARCOM,PL13                                                     
*                                                                               
         AP    SCIUNET,PTANET      UPDATE SCIEL BUCKET                          
         AP    SCIUCOM,PTARCOM                                                  
*                                                                               
         LA    R2,1(R2,R1)         GET TO END                                   
         MVI   0(R2),0             MARK IT                                      
         B     POSTT16             JOIN REST OF CODE                            
         DROP  R2,R4                                                            
*                                                                               
*                                                                               
***********************************************************************         
*                                  POST UNBILLING RERUN               *         
***********************************************************************         
*                                                                               
         USING ACMD,R2                                                          
POSTT40  L     R2,AMONACC                                                       
         L     R2,ACMAPRO2                                                      
         CLI   0(R2),PTAELQ                                                     
         B     POSTT42+8                                                        
*                                                                               
         USING PTAELD,R2                                                        
POSTT42  MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BE    *+6                                                              
         DC    H'0'                MUST HAVE                                    
         CLI   PTATYPE,PTATRAL     IS THIS ALLOCATED?                           
         BNE   POSTT42             NO                                           
         TM    PTASTAT1,PTASREVS   YES, IS THIS A REVERSE ELEMENT?              
         BZ    POSTT42             NO                                           
*                                                                               
         CLC   PTARORGD,USEBILL    DOES THE ORGINAL DATE MATCH?                 
         BNE   POSTT42             NO                                           
         CLC   PTARORGB,QSELECT    YES, DOES ORIGINAL BILL# MATCH?              
         BNE   POSTT42             NO                                           
         CLC   PTARDATE,TODAY2     YES, DOES UNBILL DATE MATCH?                 
         BNE   POSTT42             NO                                           
         CLC   PTARFORM,FORMHOLD   YES, DOES FORMAT/LEVEL MATCH?                
         BNE   POSTT42             NO                                           
*                                                                               
         AP    AMOUNT,PTANET       YES, GET AMOUNTS                             
         AP    CASH,PTACDSC                                                     
         ZAP   COMMISH,PTARCOM                                                  
*                                                                               
         LH    RF,PTAHOURS         CONVERT HOURS                                
         CVD   RF,DUB                                                           
         AP    HOURS,DUB                                                        
         B     POSTT16                                                          
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
*              POST FORMATTED CHARGES TO BUFFALO                      *         
***********************************************************************         
*                                                                               
         USING CACELD,R4                                                        
POSTFORM NTR1                                                                   
         L     R4,ADSUBAC                                                       
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   JOBDATA,C'Y'        INDICATE WE HAVE SOME DATA                   
*                                                                               
         PACK  DUB,FORMTYP         GET INDEX INTO FORMAT ROUTINE TABLE          
         CVB   RF,DUB                                                           
         SLL   RF,2                                                             
         B     FORMRTE(RF)                                                      
*                                                                               
         DS    0D                                                               
FORMRTE  EQU   *                                                                
         B     POSTFRM0            FORMAT 0                                     
         B     POSTFRM1            FORMAT 1                                     
         B     POSTFRM2            FORMAT 2                                     
         B     POSTFRM3            FORMAT 3                                     
         B     POSTFRM2            FORMAT 4 IS POSTED AS FORMAT 2               
         B     POSTFRM3            FORMAT 5 IS POSTED AS FORMAT 3               
         B     POSTFRM6            FORMAT 6                                     
         B     POSTFRM7            FORMAT 7                                     
         B     POSTFRM8            FORMAT 8                                     
         DC    H'0'                                                             
         DC    C'INVALID FORMAT'                                                
         EJECT                                                                  
***********************************************************************         
*              POST FORMAT 0 CHARGES                                  *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
         USING FRMD,R5                                                          
POSTFRM0 L     R2,ADTRANS                                                       
         MVC   FRMACCUM(JOBLNQ),JOBDTL                                          
         MVC   FRMTYPE,BUFFTYPE                                                 
*                                                                               
         CLI   FRMTYPE,FRMTYPEB         IS THIS BILLING?                        
         BNE   POSTF002                 NO                                      
         MVI   FRMDAT0,X'FF'            YES,TOTAL FOR LEVEL                     
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         MVC   FRMDAT0,TRNDATE                                                  
         MVC   FRMNARR(15),TRNNARR                                              
         MVC   FRMREFL,SPACES                                                   
         MVC   FRMREF0,TRNREF                                                   
         BASR  RE,RF                                                            
         B     POSTF008                                                         
*                                                                               
POSTF002 MVI   FRMWKC0,X'FF'            YES,TOTAL FOR LEVEL                     
         MVI   FRMVND0,X'FF'                                                    
         MVI   FRMRTE0,X'FF'                                                    
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         MVC   FRMWKC0,SVANAL           YES, TOTAL FOR WC W/I VENDOR            
         MVC   FRMWNME,SVANALN                                                  
         CLI   PROF1,C'L'          PRINTING LONG INVOICE?                       
         BNE   *+16                NO                                           
         MVC   FRMWNME,SPACES                                                   
         MVC   FRMWNME(L'SVANALNS),SVANALNS                                     
         BASR  RE,RF                                                            
*                                                                               
         MVC   FRMNARR,SPACES                                                   
         CLI   PROF14,C'N'              PRINT THE NARRATIVE?                    
         BE    POSTF004                 NO                                      
         CLC   TRNNARR(2),=C'**'                                                
         BE    POSTF004                                                         
*                                                                               
         SR    R3,R3                                                            
         IC    R3,TRNLN                                                         
         SH    R3,=H'29'                                                        
         BM    POSTF004                                                         
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FRMNARR(0),TRNNARR                                               
*                                                                               
         CLI   PROF2,C'N'               PRINTING VENDOR DATA ALSO?              
         BE    POSTF008                 NO                                      
         TM    WKCOPT,WKCDTL+WKCDTLC    ONE LINE PER WORKCODE?                  
         BNO   POSTF008                 YES                                     
*                                                                               
POSTF004 CLI   PROF2,C'N'               PRINT VENDOR DATA?                      
         BE    POSTF008                 NO                                      
         TM    WKCOPT,WKCDTL+WKCDTLC    ONE LINE PER WORKCODE?                  
         BNO   POSTF008                 YES                                     
         MVC   FRMVNME,SPACES                                                   
         SR    R3,R3                                                            
         IC    R3,CACLN                                                         
         SH    R3,=H'18'                                                        
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FRMVNME(0),CACNAME                                               
         MVC   FRMVND0,CACCNT+3                                                 
         MVC   FRMRTE0,RATE                                                     
*                                                                               
         CLI   PROF1,C'Y'          PRINT REGULAR INVOICE NUMBER?                
         BE    POSTF05A            YES                                          
                                                                                
         CLI   PROF1,C'L'          NO, PRINT LONG INVOICE NUMBER?               
         BNE   POSTF006            NO                                           
                                                                                
         L     R2,ADTRANS                                                       
         USING FFTELD,R2                                                        
POSTF005 MVI   ELCODE,FFTELQ       LOOK FOR LONG INVOICE NUMBER                 
         BAS   RE,NEXTEL                                                        
         BNE   POSTF05A                                                         
         CLI   FFTTYPE,FFTTINVN    44 - SUPPLIER INVOICE NUMBER                 
         BNE   POSTF005                                                         
         SR    R1,R1                                                            
         ICM   R1,1,FFTDLEN        NO DATA, SKIP IT                             
         BZ    POSTF05A                                                         
         BCTR  R1,0                SUBTRACT 1 FOR MVC                           
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   FRMREFL(0),FFTDATA  MAX LENGTH IS 20                             
         OC    FRMREFL,SPACES                                                   
         B     POSTF006                                                         
         DROP  R2                                                               
                                                                                
         USING TRNELD,R2                                                        
POSTF05A L     R2,ADTRANS                                                       
         MVC   FRMREFL,SPACES                                                   
         MVC   FRMREF0,TRNREF                                                   
*                                                                               
POSTF006 GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
POSTF008 B     POSTALL                                                          
         DROP  R2,R5                                                            
         EJECT                                                                  
***********************************************************************         
*              POST FORMAT 1 CHARGES (PREBILLING)                     *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
POSTFRM1 MVC   FRMACCUM(JOBLNQ),JOBDTL                                          
         MVC   FRMTYPE,BUFFTYPE                                                 
*                                  PREBILLING OR PREVIOUS BILLING               
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
         B     POSTALL                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              POST FORMAT 2 CHARGES (TIME AND OOP)                   *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
POSTFRM2 MVC   FRMACCUM(JOBLNQ),JOBDTL                                          
         MVC   FRMTYPE,BUFFTYPE                                                 
*                                                                               
         CLI   BUFFTYPE,FRMTYPEO   YES, IS THIS OUT-OF-POCKET?                  
         BNE   POSTF204            NO                                           
*                                                                               
         MVI   FRMVND2,X'FF'       YES, TOTAL FOR LEVEL                         
         MVI   FRMWKC2,X'FF'                                                    
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         CLI   PROF2,C'N'          PRINT VENDOR DATA?                           
         BE    POSTF202            NO                                           
         MVC   FRMVNME,SPACES      YES                                          
         SR    R3,R3                                                            
         IC    R3,CACLN                                                         
         SH    R3,=H'18'                                                        
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FRMVNME(0),CACNAME                                               
         MVC   FRMVND2,CACCNT+3                                                 
         BASR  RE,RF                                                            
*                                                                               
         CLI   PROF3,C'N'          PRINT WORKCODE DATA ALSO?                    
         BE    POSTF206            NO                                           
         MVC   FRMWKC2,SVANAL      YES, TOTAL FOR WORKCODE W/I VENDOR           
         MVC   FRMWNME,SVANALN                                                  
         BASR  RE,RF                                                            
         B     POSTF206                                                         
*                                                                               
POSTF202 CLI   PROF3,C'N'          PRINT WORKCODE DATA ONLY                     
         BE    POSTF206            NO                                           
         MVC   FRMWKC2,SVANAL      YES, TOTAL FOR WORKCODE W/I LEVEL            
         MVC   FRMWNME,SVANALN                                                  
         BASR  RE,RF                                                            
         B     POSTF206                                                         
*                                                                               
*                                  MUST BE TIME OR PREVIOUS BILLING             
POSTF204 GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
POSTF206 B     POSTALL                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              POST FORMAT 3 CHARGES (TIME AND OOP)                   *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
         USING JOBD,RF                                                          
POSTFRM3 LA    RF,JOBDTL                                                        
         ZAP   JOBFUDGE,=P'1'                                                   
         DROP  RF                                                               
*                                                                               
         MVC   FRMACCUM(JOBLNQ),JOBDTL                                          
         MVC   FRMTYPE,BUFFTYPE                                                 
*                                                                               
         CLI   BUFFTYPE,FRMTYPEO   YES, IS THIS OUT-OF-POCKET?                  
         BNE   POSTF304            NO                                           
*                                                                               
         MVI   FRMWKC3,X'FF'       YES,TOTAL FOR LEVEL                          
         MVI   FRMVND3,X'FF'                                                    
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         CLI   PROF3,C'N'          PRINT WORKCODE DATA?                         
         BE    POSTF302            NO                                           
         MVC   FRMWKC3,SVANAL      YES, TOTAL FOR WORKCODE W/I VENDOR           
         MVC   FRMWNME,SVANALN                                                  
         BASR  RE,RF                                                            
*                                                                               
         CLI   PROF2,C'N'          PRINT VENDOR DATA ALSO?                      
         BE    POSTF306            NO                                           
         TM    WKCOPT,WKCDTL       YES, ONE LINE PER WORKCODE?                  
         BZ    POSTF306            YES                                          
         MVC   FRMVNME,SPACES                                                   
         SR    R3,R3                                                            
         IC    R3,CACLN                                                         
         SH    R3,=H'18'                                                        
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FRMVNME(0),CACNAME                                               
         MVC   FRMVND3,CACCNT+3                                                 
         BASR  RE,RF                                                            
         B     POSTF306                                                         
*                                                                               
POSTF302 CLI   PROF2,C'N'          PRINT VENDOR DATA ONLY                       
         BE    POSTF306            NO                                           
         MVC   FRMVNME,SPACES      YES                                          
         SR    R3,R3                                                            
         IC    R3,CACLN                                                         
         SH    R3,=H'18'                                                        
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FRMVNME(0),CACNAME                                               
         MVC   FRMVND3,CACCNT+3                                                 
         BASR  RE,RF                                                            
         B     POSTF306                                                         
*                                                                               
*                                  MUST BE TIME OR PREVIOUS BILLING             
POSTF304 GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
POSTF306 B     POSTALL                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              POST FORMAT 6 CHARGES (TIME AND OOP)                   *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
         USING FRMD,R5                                                          
POSTFRM6 L     R2,ADTRANS                                                       
         MVC   FRMACCUM(JOBLNQ),JOBDTL                                          
         MVC   FRMTYPE,BUFFTYPE                                                 
*                                                                               
* -------------------------------------------------------------------           
*                            OUT-OF-POCKET                           *          
* -------------------------------------------------------------------           
*                                                                               
         CLI   BUFFTYPE,FRMTYPEO   YES, IS THIS OUT-OF-POCKET?                  
         BNE   POSTF610            NO                                           
*                                                                               
         MVI   FRMOWRK6,X'FF'      YES, TOTAL FOR LEVEL                         
         MVI   FRMOVNM6,X'FF'                                                   
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         CLI   PROF2,C'N'          PRINTING VENDOR DATA?                        
         BE    POSTF608            NO                                           
         TM    WKCOPT,WKCDTL       YES, ONE LINE PER WORKCODE?                  
         BZ    POSTF608            YES                                          
         MVC   FRMOVNM6,SPACES     YES                                          
         SR    R3,R3                                                            
         IC    R3,CACLN                                                         
         SH    R3,=H'18'                                                        
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FRMOVNM6(0),CACNAME                                              
         CLI   PROF1,C'Y'          PRINTING REGULAR INVOICE NUMBER?             
         BE    POSTF604            YES                                          
         CLI   PROF1,C'L'          NO, PRINTING LONG INVOICE NUMBER?            
         BNE   POSTF606            NO                                           
                                                                                
         L     R2,ADTRANS                                                       
         USING FFTELD,R2                                                        
POSTF602 MVI   ELCODE,FFTELQ       LOOK FOR LONG INVOICE NUMBER                 
         BAS   RE,NEXTEL                                                        
         BNE   POSTF604                                                         
         CLI   FFTTYPE,FFTTINVN    44 - SUPPLIER INVOICE NUMBER                 
         BNE   POSTF602                                                         
         SR    R1,R1                                                            
         ICM   R1,1,FFTDLEN        NO DATA, SKIP IT                             
         BZ    POSTF604                                                         
         BCTR  R1,0                SUBTRACT 1 FOR MVC                           
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   FRMOREFL(0),FFTDATA MAX LENGTH IS 20                             
         OC    FRMOREFL,SPACES                                                  
         B     POSTF606                                                         
         DROP  R2                                                               
                                                                                
         USING TRNELD,R2                                                        
POSTF604 L     R2,ADTRANS                                                       
         MVC   FRMOREFL,SPACES                                                  
         MVC   FRMOREF6,TRNREF                                                  
*                                                                               
POSTF606 CLI   PROF3,C'N'          WORKCODE ALSO?                               
         BE    POSTF616            NO, PUT THE VENDOR TO BUFFALO                
*                                                                               
POSTF608 CLI   PROF3,C'N'          PRINTING WORKCODE DATA?                      
         BE    POSTF620            NO, ALL DONE                                 
         MVC   FRMOWRK6,SVANAL     YES                                          
         MVC   FRMWNME,SVANALN                                                  
         CLI   PROF1,C'L'          PRINTING LONG INVOICE NUMBER?                
         BNE   *+16                NO                                           
         MVC   FRMWNME,SPACES                                                   
         MVC   FRMWNME(L'SVANALNS),SVANALNS                                     
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
         B     POSTF620                                                         
*                                                                               
* -------------------------------------------------------------------           
*                            TIME                                    *          
* -------------------------------------------------------------------           
*                                                                               
POSTF610 CLI   BUFFTYPE,FRMTYPET   YES, IS THIS TIME?                           
         BNE   POSTF618            NO                                           
*                                                                               
POSTF612 MVI   FRMTUNT6,X'FF'      YES, TOTAL FOR LEVEL                         
         MVI   FRMTPNM6,X'FF'                                                   
         MVI   FRMTWRK6,X'FF'                                                   
         MVI   FRMTRTE6,X'FF'                                                   
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         CLI   PROF26,C'N'         PRINT TIME DETAILS?                          
         BE    *+10                NO                                           
         MVC   FRMTRTE6,RATE                                                    
*                                                                               
         CLI   PROF31,C'Y'         PRINT DATA BY PERSON?                        
         BNE   POSTF614            NO, CHECK FOR WORKCODE                       
*                                                                               
         MVC   FRMTUNT6,CACCNT+1 GET UNIT                                       
         MVC   FRMTPNM6,SPACES     YES                                          
         SR    R3,R3                                                            
         IC    R3,CACLN                                                         
         SH    R3,=H'18'                                                        
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FRMTPNM6(0),CACNAME                                              
         CLI   PROF30,C'Y'         PRINT DATA BY WORKCODE ALSO?                 
         BNE   POSTF616            NO                                           
*                                                                               
POSTF614 CLI   PROF30,C'Y'         PRINT DATA BY WORKCODE?                      
         BNE   POSTF620            NO, NO DETAIL                                
         MVC   FRMTUNT6,SPACES     YES, CLEAR UNIT CODE                         
         MVC   FRMTWRK6,SVANAL                                                  
         MVC   FRMWNME,SVANALN                                                  
         CLI   PROF1,C'L'          PRINTING LONG INVOICE NUMBER?                
         BNE   *+16                NO                                           
         MVC   FRMWNME,SPACES                                                   
         MVC   FRMWNME(L'SVANALNS),SVANALNS                                     
*                                                                               
POSTF616 GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
         B     POSTF620                                                         
*                                                                               
* -------------------------------------------------------------------           
*                           RETAINER                                 *          
* -------------------------------------------------------------------           
*                                                                               
POSTF618 CLI   BUFFTYPE,FRMTYPER   IS THIS A RETAINER?                          
         BNE   POSTF616            NO                                           
         MVI   BUFFTYPE,FRMTYPET   YES, CHANGE TO TIME                          
         MVC   FRMTYPE,BUFFTYPE                                                 
         B     POSTF612                                                         
*                                                                               
POSTF620 B     POSTALL                                                          
         DROP  R2,R5                                                            
         EJECT                                                                  
***********************************************************************         
*              POST FORMAT 7 CHARGES (TIME AND OOP)                   *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
POSTFRM7 MVC   FRMACCUM(JOBLNQ),JOBDTL                                          
         MVC   FRMTYPE,BUFFTYPE                                                 
*                                                                               
         CLI   BUFFTYPE,FRMTYPEO   YES, IS THIS OUT-OF-POCKET?                  
         BNE   POSTF704            NO                                           
*                                                                               
         MVI   FRMWKC3,X'FF'       YES,TOTAL FOR LEVEL                          
         MVI   FRMVND3,X'FF'                                                    
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         CLI   PROF3,C'N'          PRINT WORKCODE DATA?                         
         BE    POSTF702            NO                                           
         MVC   FRMWKC3,SVANAL      YES, TOTAL FOR WORKCODE W/I VENDOR           
         MVC   FRMWNME,SVANALN                                                  
         BASR  RE,RF                                                            
*                                                                               
         CLI   PROF2,C'N'          PRINT VENDOR DATA ALSO?                      
         BE    POSTF708            NO                                           
         TM    WKCOPT,WKCDTL       YES, ONE LINE PER WORKCODE?                  
         BZ    POSTF708            YES                                          
         MVC   FRMVNME,SPACES                                                   
         SR    R3,R3                                                            
         IC    R3,CACLN                                                         
         SH    R3,=H'18'                                                        
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FRMVNME(0),CACNAME                                               
         MVC   FRMVND3,CACCNT+3                                                 
         BASR  RE,RF                                                            
         B     POSTF708                                                         
*                                                                               
POSTF702 CLI   PROF2,C'N'          PRINT VENDOR DATA ONLY                       
         BE    POSTF708            NO                                           
         MVC   FRMVNME,SPACES      YES                                          
         SR    R3,R3                                                            
         IC    R3,CACLN                                                         
         SH    R3,=H'18'                                                        
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FRMVNME(0),CACNAME                                               
         MVC   FRMVND3,CACCNT+3                                                 
         BASR  RE,RF                                                            
         B     POSTF708                                                         
*                                                                               
POSTF704 CLI   BUFFTYPE,FRMTYPET   IS THIS TIME?                                
         BNE   *+10                NO                                           
         MVC   FRMTWGR7,SVANWGP    YES                                          
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
         MVI   FRMTWGR7,X'FF'                                                   
         BASR  RE,RF                                                            
         B     POSTF708                                                         
*                                                                               
POSTF708 B     POSTALL                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              POST FORMAT 8                                          *         
***********************************************************************         
         USING FRMD,R5                                                          
POSTFRM8 MVI   FRMTYPE,FRMTYPE8                                                 
         MVC   FRMACCUM(JOBLNQ),JOBDTL                                          
*       -  -  -  -  -  -  -  -  -                                               
         CLI   BUFFTYPE,FRMTYPEB   SKIP PREVIOS BILLING                         
         BE    POSTFX                                                           
         CLI   BUFFTYPE,FRMTYPEL                                                
         BE    POSTFX                                                           
*       -  -  -  -  -  -  -  -  -                                               
         MVI   FRMUSF8,X'FF'       TOTAL OF ALL LEVELS                          
         MVI   FRMPRD8,X'FF'                                                    
         MVI   FRMJBC8,X'FF'                                                    
         MVI   FRMWRK8,X'FF'                                                    
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*       -  -  -  -  -  -  -  -  -                                               
         MVC   FRMJNME,JOBNAME                                                  
         MVC   FRMPNME,PRDNAME                                                  
         MVC   FRMWNME,SVANALN                                                  
         MVC   FRMUSF8,SPACES                                                   
*                                                                               
         L     R4,AUSRPOOL         GET USER FIELD TABLE                         
         USING UFSELD,R4                                                        
POSTF802 CLI   0(R4),0                                                          
         BE    POSTF810            END OF RECORD                                
         CLI   0(R4),X'A2'                                                      
         BNE   POSTF804                                                         
         CLC   UFSCODE,=C'TC'                                                   
         BE    POSTF806                                                         
POSTF804 ZIC   RF,1(R4)                                                         
         AR    R4,RF                                                            
         B     POSTF802                                                         
POSTF806 LA    R2,UFSDATA-UFSELD    LENGTH UP TO DATA                           
         ZIC   R3,UFSLN           ELEMENT LENGTH                                
         SR    R3,R2                R3=LENGTH OF UFSDATA                        
         BZ    POSTF810             NO DATA                                     
         CH    R3,=H'12'                                                        
         BH    POSTF810                                                         
         BCTR  R3,0                                                             
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FRMUSF8(0),UFSDATA  DATA TO SOFT FIELD                           
         DROP  R4                                                               
*                                                                               
POSTF810 DS    0H                                                               
*       -  -  -  -  -  -  -  -  -                                               
**NOP    MVI   FRMPRD8,X'FF'       TOTAL AT USER FIELD LEVEL                    
*        MVI   FRMJBC8,X'FF'                                                    
*        MVI   FRMWRK8,X'FF'                                                    
*        GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*       -  -  -  -  -  -  -  -  -                                               
         MVC   FRMPRD8,PRDCODE+6   TOTAL AT PRODUCT LEVEL                       
         MVI   FRMJBC8,X'FF'                                                    
         MVI   FRMWRK8,X'FF'                                                    
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*       -  -  -  -  -  -  -  -  -                                               
         MVC   FRMPRD8,PRDCODE+6   TOTAL AT JOB LEVEL                           
         MVC   FRMJBC8,JOBCODE+9                                                
         MVI   FRMWRK8,X'FF'                                                    
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*       -  -  -  -  -  -  -  -  -                                               
         MVI   FRMTYPE,FRMTYPE8                                                 
         MVC   FRMJBC8,JOBCODE+9                                                
         MVC   FRMPRD8,PRDCODE+6                                                
         MVC   FRMWRK8,SVANAL                                                   
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         B     POSTALL                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
         USING MRCD,R5                                                          
POSTALL  GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVC   MRCACCUM(JOBLNQ),JOBDTL                                          
         MVI   MRCTYPE,MRCTYPE5                                                 
         MVI   MRCMED,X'FF'                                                     
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         MVC   MRCMED(12),MEDNAME+3                                             
         TM    WKCOPT,WKCMT                                                     
         BZ    POSTA02                                                          
         MVC   MRCMED,SVANALN                                                   
         OI    JOBOPT,JOBMEDT                                                   
*                                                                               
POSTA02  BASR  RE,RF                                                            
         TM    JOBOPT,POSTAGY      MAKING STUDI/INTER POSTINGS?                 
         BZ    POSTFX              NO                                           
*                                                                               
         CLC   SVAGWC,=C'99'       IS THIS BILLING?                             
         BE    POSTFX              YES, DON'T ADD TO WRKTAB                     
*                                                                               
         USING WRKD,R5                                                          
         LA    R5,WRKWK            ADD DATA TO BINSRCH                          
         XC    WRKWK,WRKWK                                                      
         MVC   WRKCDE,SVAGWC            AGENCY WORKCODE                         
         MVC   WRKACCUM(JOBLNQ),JOBDTL  ACCUMULATORS                            
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AWRKTAB                           
         MVC   WRKCDE,=XL2'FFFF'                                                
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AWRKTAB                           
*                                                                               
POSTFX   B     BASEXIT                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              POST CHARGES TO GST TABLE                              *         
***********************************************************************         
*                                                                               
         USING GSTD,R5                                                          
POSTGST  NTR1                                                                   
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    POSTGX              NO, EXIT                                     
         OC    SVGSTCOD,SVGSTCOD   DO WE HAVE ANY GST DATA?                     
         BZ    POSTGX              NO, EXIT                                     
*                                                                               
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   GSTTYPE,GSTTYPE5                                                 
         MVC   GSTACCUM(JOBLNQ),JOBDTL    ACCUMS                                
         MVC   GSTCODE,SVGSTCOD                                                 
         MVC   GSTRATE,SVGSTRAT                                                 
         MVC   GSTINDS,SVGSTIND                                                 
         MVC   GSTACCT,SVGSTACC                                                 
         MVC   GSTDATE,SVGSTDAT                                                 
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
         MVC   GSTCODE,FOXES                                                    
         MVC   GSTRATE,FOXES                                                    
         MVC   GSTACCT,FOXES                                                    
         BASR  RE,RF                                                            
*                                                                               
POSTGX   B     BASEXIT                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              POST CHARGES TO PST TABLE                              *         
***********************************************************************         
*                                                                               
         USING PSTD,R5                                                          
POSTPST  NTR1                                                                   
         TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC?                      
         BZ    POSTPX              NO, EXIT                                     
         OC    SVPSTCOD,SVPSTCOD   DO WE HAVE ANY PST DATA?                     
         BZ    POSTPX              NO, EXIT                                     
*                                                                               
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   PSTTYPE,PSTTYPE7                                                 
         MVC   PSTACCUM(JOBLNQ),JOBDTL    ACCUMS                                
         MVC   PSTCODE,SVPSTCOD                                                 
         MVC   PSTPROV,SVPSTPRV                                                 
         MVC   PSTRATE,SVPSTRAT                                                 
         MVC   PSTINDS,SVPSTIND                                                 
         MVC   PSTACCT,SVPSTACC                                                 
         MVC   PSTDATE,SVPSTDAT                                                 
         MVC   PSTNAME,SVPSTNME                                                 
         MVC   PSTREG,SVPSTREG                                                  
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
         MVC   PSTCODE,FOXES                                                    
         MVC   PSTRATE,FOXES                                                    
         MVC   PSTACCT,FOXES                                                    
         BASR  RE,RF                                                            
*                                                                               
POSTPX   B     BASEXIT                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              ADD A BILLING RECORD (99) TO ACCUMULATORS              *         
***********************************************************************         
*                                                                               
ADDABILL NTR1                                                                   
         LA    R4,JOBDTL                                                        
         USING JOBD,R4                                                          
         MVC   JOBBK(JOBLNQ),ZEROS     INITIALIZE DETAIL                        
         L     R2,ADTRANS                                                       
         USING TRNELD,R2                                                        
         ZAP   DUB,TRNAMNT                                                      
*                                                                               
         AP    JOBNET,DUB              ADD NET TO NET                           
         AP    JOBGRS,DUB                         GROSS                         
*                                                                               
         AP    JOBVNET,DUB                        GST NET                       
         AP    JOBVGRS,DUB                        GST GROSS                     
*                                                                               
         AP    JOBPNET,DUB                        PST NET                       
         AP    JOBPGRS,DUB                        PST GROSS                     
*                                                                               
         CLI   TRNLN,121                                                        
         BNE   ADDAB2                                                           
         ZAP   DUB,TRNBLCOM                                                     
         AP    JOBCOM,DUB          COMMISSION TO COMMISSION                     
         AP    JOBGRS,DUB                         GROSS                         
         AP    JOBVGRS,DUB                        GST GROSS                     
         AP    JOBPGRS,DUB                        PST GROSS                     
*                                                                               
ADDAB2   GOTO1 SHR,DMCB,('SUBRSUML',(RC))           DOWNCAST TABLE              
         B     BASEXIT                                                          
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              LOOK FOR LEDGER LEVEL BILL NUMBER                      *         
***********************************************************************         
*                                                                               
LEDBILL  NTR1                                                                   
         L     R2,ADLEDGER                                                      
         MVI   ELCODE,X'11'                                                     
         BAS   RE,GETEL                                                         
         BNE   BASEXIT                                                          
*                                                                               
         TM    BILLOPT,LEDNUM      HAVE WE BEEN HERE BEFORE?                    
         BO    LEDB02              YES                                          
         BAS   RE,SETSTRT          NO, SET THE START NUMBER                     
*                                                                               
LEDB02   OI    BILLOPT,LEDNUM                                                   
         OI    RUNOPT,WRITLG                                                    
         BAS   RE,GETNUMB          GET BILL NUMBER                              
         B     BASEXIT                                                          
*                                                                               
         USING PMDELD,R2                                                        
SETSTRT  TM    BILLMODE,RERUN                                                   
         BZ    *+12                                                             
         MVC   PMDLBILL,PMDFBILL   USE FIRST BILL FOR RERUN                     
         BR    RE                                                               
         MVC   PMDFBILL,PMDLBILL   FIX START FOR NEXT TIME                      
         BR    RE                                                               
*                                                                               
GETNUMB  MVC   WORK(L'PMDLBILL),PMDLBILL                                        
         CLC   MNTH,PMDLBILL                                                    
         BE    *+16                                                             
         MVC   WORK(2),MNTH                                                     
         MVC   WORK+2(4),PMDRBILL                                               
         PACK  BILLNO,WORK(L'PMDLBILL)                                          
         BR    RE                                                               
*                                                                               
SETNUMB  ZAP   FULL,BILLNO                                                      
         AP    FULL,=P'1'                                                       
         UNPK  PMDLBILL,FULL                                                    
         OI    PMDLBILL+5,X'F0'                                                 
         BR    RE                                                               
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
*              LOOK FOR CLIENT LEVEL BILL NUMBER                      *         
***********************************************************************         
*                                                                               
CLIBILL  NTR1                                                                   
         L     R2,ADHEIRA                                                       
         MVI   ELCODE,X'11'                                                     
         BAS   RE,GETEL                                                         
         BNE   BASEXIT                                                          
*                                                                               
         TM    BILLOPT,CLINUM      HAVE WE BEEN HERE BEFORE?                    
         BO    CLIB02              YES                                          
         BAS   RE,SETSTRT          NO, SET THE START NUMBER                     
*                                                                               
CLIB02   OI    BILLOPT,CLINUM      TURN ON CLIENT, OFF LEDGER                   
         NI    BILLOPT,X'FF'-LEDNUM                                             
         OI    RUNOPT,WRITLVA                                                   
         BAS   RE,GETNUMB                                                       
*                                                                               
BASEXIT  XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*              UPDATE THE BILL NUMBER WHEN BILLING IS FOUND           *         
***********************************************************************         
*                                                                               
UPBIL    NTR1                                                                   
         TM    BILLOPT,OLDNUM      ARE WE USING THE OLD NUMBERS?                
         BO    UPBILX              YES, DON'T UPDATE THE RECORD THEM            
*                                                                               
         L     R2,ADLEDGER         NO, ASSUME BY LEDGER THEN                    
         TM    BILLOPT,LEDNUM      IS IT?                                       
         BO    *+8                 YES, GET ELEMENT                             
         L     R2,ADHEIRA          NO, GET CLIENT RECORD                        
*                                                                               
         MVI   ELCODE,X'11'                                                     
         BAS   RE,GETEL                                                         
         BNE   UPBILX                                                           
*                                                                               
         BAS   RE,SETNUMB          UPDATE THE RECORD                            
         NI    RUNOPT,X'FF'-BILNUM                                              
*                                                                               
UPBILX   B     BASEXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              PASS SOON INFO TO FACWK                                *         
***********************************************************************         
*                                                                               
SETFWRK  NTR1                                                                   
         USING FWRECD,R3                                                        
         LA    R3,CHOPWRK          USE ANY BUFFER                               
         XC    CHOPWRK,CHOPWRK                                                  
         MVC   FWRLEN,=Y(FWRLNQ)   SET UP USER INFO FOR SRUPD00                 
         MVC   FWRUSER,=C'USER='                                                
         MVC   FWRUSID,USID                                                     
         MVC   FWRLUID,LUID                                                     
         MVC   FWRPQID,PQID                                                     
         MVC   FWRWKID,WKID                                                     
*                                                                               
         USING SSOOFF,RF                                                        
         L     RF,VSSB                                                          
         L     R2,SSOFWNDX         INDEX                                        
         L     R0,SSOFWBUF         BUFFER                                       
         GOTO1 DATAMGR,DMCB,(0,FACADD),(0,FACWRK),(R2),(R3),(R0)                
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         B     BASEXIT                                                          
         DROP  R3,RF                                                            
         EJECT                                                                  
***********************************************************************         
*              UPDATE EXTRA STATUS ELEMEMT                            *         
***********************************************************************         
*                                                                               
UPTRXEL  NTR1                                                                   
         L     R2,ADTRANS                                                       
         MVI   ELCODE,TRXELQ                                                    
         BAS   RE,NEXTEL                                                        
         BNE   UPTRXX                                                           
*                                                                               
         USING TRXELD,R2                                                        
         NI    TRXSTA2,X'FF'-TRXSBILP                                           
*                                                                               
         USING ACMD,R3                                                          
         L     R3,AMONACC                                                       
         L     R3,ACMAPRO2                                                      
*                                                                               
         USING PTAELD,R3                                                        
UPTR02   CLI   0(R3),0             LOOK FOR PTAEL'S                             
         BE    UPTRXX                                                           
         CLI   0(R3),PTAELQ                                                     
         BNE   UPTR04                                                           
         CLI   PTATYPE,PTATRAL     BILLING?                                     
         BNE   UPTR04              NO                                           
         TM    PTASTAT1,PTASPEND   YES, PENDING?                                
         BNO   *+8                 NO                                           
         OI    TRXSTA2,TRXSBILP    YES, TURN ON ALLOCATED BIT                   
*                                                                               
UPTR04   IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     UPTR02                                                           
*                                                                               
UPTRXX   B     BASEXIT                                                          
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* ROUTINE TO ESTABLISH COMPOSITE PRODUCTION PROFILE                   *         
***********************************************************************         
         SPACE 1                                                                
         USING PPRELD,R1                                                        
OVERPROF L     RF,ACOMPRF                                                       
         CLI   PPRLN,PPRNARRP-PPRELD TEST FOR NO NARRATION                      
         BE    *+10                YES-DO NOT REPLACE ELEMENT LENGTH            
         MVC   PPRLN-PPRELD(L'PPRLN,RF),PPRLN                                   
         OC    PPRRECV,PPRRECV                                                  
         BZ    *+10                                                             
         MVC   PPRRECV-PPRELD(L'PPRRECV,RF),PPRRECV                             
         OC    PPRCOST,PPRCOST                                                  
         BZ    *+10                                                             
         MVC   PPRCOST-PPRELD(L'PPRCOST,RF),PPRCOST                             
         CLC   PPRGAOFF,SPACES                                                  
         BNH   *+10                                                             
         MVC   PPRGAOFF-PPRELD(L'PPRGAOFF,RF),PPRGAOFF                          
         CLC   PPRBILLP,SPACES                                                  
         BNH   *+10                                                             
         MVC   PPRBILLP-PPRELD(L'PPRBILLP,RF),PPRBILLP                          
         BR    RE                                                               
*                                                                               
         GETEL R2,DATADISP,ELCODE                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
CNTNAME  DC    CL33'******** INTERNAL CONTROL ******'                           
CNTADDR  DC    CL33'******** DO NOT  SEND OUT ******'                           
NOBMESS  DC    CL28'NO DATA ALLOCATED FOR FORMAT'                               
*                                                                               
SORTCARD DC    CL80'SORT FIELDS=(5,15,A),FORMAT=BI,WORK=1'                      
RECCARD  DC    CL80'RECORD TYPE=V,LENGTH=(235,,,,)'                             
*                                                                               
WARNRSN  DS    CL1                 CURRENT WARNING                              
WARNRSNS DS    CL(WARN01-WARN01+1) LIST OF WARNINGS                             
*                                                                               
*              TABLE OF WARNING MESSAGES                                        
*                                                                               
WARN01   EQU   1                                                                
WRN01    DC    AL1(WARN01),AL1(L'WRN01M)                                        
WRN01M   DC    CL60'NO INTERCOMPANY POSTINGS MADE - AGENCY JOB IS AN EXX        
               PENSE JOB'                                                       
         DC    X'FF'                                                            
         EJECT                                                                  
FOXES    DC    15X'FF'                                                          
FACADD   DC    C'ADD '                                                          
FACWRK   DC    C'FACWRK '                                                       
*              LOCAL ROUTINES                                                   
*                                                                               
RELOTAB  DS    0A                                                               
         DC    A(CDFORMR)          HANDLE CASH DISCOUNT                         
         DC    A(ADD2SUMR)         ADD TO CLIENT AND PRODUCT SUMMARY            
         DC    A(PCLISUMR)         CLIENT SUMMARY BILL                          
         DC    A(PPROSUMR)         PRODUCT SUMMARY BILL                         
         DC    A(UNMARKR)          UNMARK THE 99 TRANSACTION                    
         DC    A(BILLR)            BILL NUMBER ROUTINE                          
         DC    A(WARNR)            WARNING ROUTINE                              
         DC    A(FILTR)            FILTERING ROUTINES                           
         DC    A(POSTR)            POSTING ROUTINES                             
         DC    A(PRNTR)            PRINT ROUTINE                                
         DC    A(SHRR)             SHARED ROUTINES                              
         DC    A(FORMR)            FORMAT ROUTINES                              
         DC    A(ADDELR)           ADD AN ELEMENT                               
         DC    A(REMELR)           DELETE AN ELEMENT                            
         DC    A(ENDR)             END OF JOB ROUTINES                          
*                                                                               
*              LOCAL STORAGE AREAS                                              
*                                                                               
         DC    A(OPTTAB)                                                        
         DC    A(MEDTAB)                                                        
         DC    A(GRECTAB)                                                       
         DC    A(COMBUF)                                                        
         DC    A(IO2)                                                           
         DC    A(POSTBUF)                                                       
         DC    A(MYSPECS)                                                       
         DC    A(BUFFALOC)                                                      
         DC    A(COMPRF)                                                        
         DC    A(VATBUFF)                                                       
         DC    A(SVTABLE)                                                       
         DC    A(USRPOOL)                                                       
         DC    A(NOBWK)                                                         
         DC    A(INTRWK)                                                        
         DC    A(EXCRWK)                                                        
         DC    A(WRKTAB)                                                        
         DC    A(SUBTAB)                                                        
         DC    A(GRPTAB)                                                        
*                                                                               
*              EXTERNALS                                                        
*                                                                               
         DC    V(SQUASHER)                                                      
         DC    V(ACCEDIT)                                                       
         DC    V(UNDERLIN)                                                      
         DC    V(SORTER)                                                        
         DC    V(HELLO)                                                         
         DC    V(RIGHT)                                                         
         DC    V(ACTRACK)                                                       
         DC    X'FF'                                                            
*                                                                               
PHASES   DS    0AL1                LOADABLE PHASES                              
         DC    AL1(QPOSTWRK)                                                    
PHASEN   EQU   (*-PHASES)/L'PHASES                                              
         EJECT                                                                  
*              TABLES / BUFFERS                                                 
*                                                                               
*              FORMAT/OPTION TABLE                                              
*                                                                               
         DS    0D                                                               
OPTTAB   DS    0CL15                                                            
         DC    CL1'0',C'Y',C'N',C'N',C'N',C'N',9X'00'                           
         DC    CL1'1',C'N',C'N',C'N',C'Y',C'N',9X'00'                           
         DC    CL1'2',C'N',C'N',C'Y',C'Y',C'Y',9X'00'                           
         DC    CL1'3',C'N',C'N',C'Y',C'Y',C'Y',9X'00'                           
         DC    CL1'4',C'N',C'N',C'Y',C'Y',C'Y',9X'00'                           
         DC    CL1'5',C'N',C'N',C'Y',C'Y',C'Y',9X'00'                           
         DC    CL1'6',C'N',C'N',C'Y',C'Y',C'Y',C'Y',8X'00'                      
         DC    CL1'7',C'N',C'N',C'Y',C'Y',C'Y',9X'00'                           
         DC    CL1'8',C'Y',C'N',C'N',C'N',C'N',9X'00'                           
         DC    X'FF'                                                            
         EJECT                                                                  
DICI     DCDDL AC#ABTAX,19,L                                                    
         DCDDL AC#ACC#,13,R                                                     
         DCDDL AC#ACC#,13,RU                                                    
         DCDDL AC#AMT,7,R                                                       
         DCDDL AC#AMT,7,RU                                                      
         DCDDL AC#APREV,27,L                                                    
         DCDDL AC#BASIS,6,R                                                     
         DCDDL AC#BASIS,6,RU                                                    
*        DCDDL AC#BILC,11,L                                                     
         DCDDL AC#BILDT,15,L                                                    
         DCDDL AC#BLDIO,17,L                                                    
         DCDDL AC#BPER,14,L                                                     
         DCDDL AC#CLINT,6,L                                                     
         DCDDL AC#CMN,10,L                                                      
*        DCDDL AC#CODE,4,R                                                      
*        DCDDL AC#CODE,4,RU                                                     
         DCDDL AC#CRAM,17,L                                                     
         DCDDL AC#CSHDS,13,L                                                    
         DCDDL AC#CSHDS,13,LU                                                   
         DCDDL AC#DRAFT,5,L                                                     
         DCDDL AC#DUEDT,13,L                                                    
         DCDDL AC#DUER,21,L                                                     
         DCDDL AC#FEE,10,L                                                      
*        DCDDL AC#FOR,3,L                                                       
*        DCDDL AC#GSTAM,11,L                                                    
         DCDDL AC#HAND,17,L                                                     
*        DCDDL AC#IFDED,27,L                                                    
         DCDDL AC#INV,7,R                                                       
         DCDDL AC#INV,7,RU                                                      
         DCDDL AC#INVC,17,L                                                     
         DCDDL AC#INVDE,14,L                                                    
         DCDDL AC#INVDE,14,LU                                                   
         DCDDL AC#INVSU,15,L                                                    
         DCDDL AC#INVSU,15,LU                                                   
         DCDDL AC#INVTO,13,R                                                    
*        DCDDL AC#JOB,3,L                                                       
*        DCDDL AC#JOBNU,10,L                                                    
         DCDDL AC#MMPS,38,L                                                     
*        DCDDL AC#NIL,3,R                                                       
         DCDDL AC#OOP,22,L                                                      
         DCDDL AC#OOP,22,LU                                                     
         DCDDL AC#OTHRS,6,L                                                     
*        DCDDL AC#PAA,16,L                                                      
*        DCDDL AC#PLCD,27,L                                                     
         DCDDL AC#PPTA,26,L                                                     
         DCDDL AC#PPTA,26,LU                                                    
         DCDDL AC#PRD,10,L                                                      
         DCDDL AC#PRD,10,LU                                                     
         DCDDL AC#PRDBL,18,C                                                    
         DCDDL AC#PRO,7,L                                                       
         DCDDL AC#PROFS,12,L                                                    
*        DCDDL AC#PRVDE,27,L                                                    
         DCDDL AC#PRVBL,20,L                                                    
         DCDDL AC#PRVBL,20,LU                                                   
         DCDDL AC#PRVBS,14,L                                                    
*        DCDDL AC#PSSF,31,L                                                     
         DCDDL AC#RATE,4,R                                                      
         DCDDL AC#RATE,4,RU                                                     
*        DCDDL AC#RECAP,15,L                                                    
*        DCDDL AC#RECAP,15,LU                                                   
         DCDDL AC#REQDE,15,L                                                    
         DCDDL AC#SERVE,8,L                                                     
         DCDDL AC#STAFF,5,L                                                     
         DCDDL AC#STDIO,6,L                                                     
         DCDDL AC#SUBT,10,L                                                     
*        DCDDL AC#TAMTD,20,L                                                    
         DCDDL AC#TAX,3,R                                                       
         DCDDL AC#TAX,3,RU                                                      
         DCDDL AC#TAXAN,17,C                                                    
         DCDDL AC#TAXAN,17,CU                                                   
*        DCDDL AC#TBLNG,13,L                                                    
*        DCDDL AC#TCRGS,15,L                                                    
         DCDDL AC#TFOR,9,L                                                      
         DCDDL AC#TJOB,13,L                                                     
         DCDDL AC#TMED,19,L                                                     
*        DCDDL AC#TMEDC,19,L                                                    
         DCDDL AC#TO,2,L                                                        
         DCDDL AC#TOTAL,5,L                                                     
         DCDDL AC#TOTCL,17,L                                                    
         DCDDL AC#TOTPR,18,L                                                    
         DCDDL AC#TOTRN,17,L                                                    
*        DCDDL AC#TOREV,18,L                                                    
*        DCDDL AC#TPRCG,24,L                                                    
*        DCDDL AC#TPRCG,16,L,LABEL=AC@TPRD                                      
         DCDDL AC#TPRVB,24,L                                                    
*        DCDDL AC#TPSTS,14,L                                                    
         DCDDL AC#TREP,16,L                                                     
         DCDDL AC#TTAX,11,L                                                     
         DCDDL AC#TYPE,4,L                                                      
         DCDDL AC#TWC,19,R                                                      
         DCDDL AC#UNBIO,19,L                                                    
         DCDDL AC#VAT1,3,L                                                      
         DC    X'00'                                                            
         DROP  R6,R9,RA,RB                                                      
         TITLE 'AC27 - HANDLE CASH DISCOUNT'                                    
CDFORMR  DS    0D                                                               
         NMOD1 0,*CDFORM*                                                       
         L     RC,0(R1)                                                         
         USING JOBD,R5                                                          
         CP    SAVCD,=P'0'                                                      
         BE    CDFORMX                                                          
         CLI   PROF8,C'G'          BILL GROSS DEDUCT CD(MEMO)                   
         BE    CDFORMX                                                          
*                                                                               
         LA    R5,JOBCHG           SHOW TOTAL DUE                               
         SP    JOBGRS,JOBCD                                                     
         SP    JOBNET,JOBCD                                                     
         LA    R5,JOBTOT           AND TOTAL JOB                                
         SP    JOBGRS,JOBCD        MINUS THE CD                                 
         SP    JOBNET,JOBCD                                                     
*                                                                               
CDFORMX  XIT1                                                                   
         DROP  R5                                                               
         TITLE 'AC27 - ADD A BILL TO PRODUCT AND CLIENT SUMMARIES'              
ADD2SUMR DS    0D                                                               
         NMOD1 0,*ADDSUM*                                                       
         L     RC,0(R1)                                                         
         USING SUMD,R5                                                          
         USING JOBD,R6                                                          
         LA    R6,JOBCHG                                                        
         ZAP   SAVECOMM,JOBCOM    SAVE THE COMMISSION                           
         TM    CLIOPT,NOCOMM+PAYNET                                             
         BZ    ADDSUM1                                                          
         SP    JOBGRS,JOBCOM       PAY=NET AND SUPPRESS                         
         SP    JOBVGRS,JOBCOM                                                   
         SP    JOBPGRS,JOBCOM                                                   
         TM    CLIOPT,NOCOMM                                                    
         BNO   ADDSUM1                                                          
         ZAP   JOBCOM,=P'0'                                                     
*                                                                               
ADDSUM1  LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVC   SUMBILNO,SPACES                                                  
         MVC   SUMBILNO(7),SHTBILNO      BILL NUMBER MM-NNNN                    
         OC    USERMC,USERMC                                                    
         BZ    *+10                                                             
         MVC   SUMBILNO,LNGBILNO         OR MM-MC-1234                          
*                                                                               
ADDSUM2  DS     0H                                                              
         L     R2,ADACC                                                         
         MVI   SUMTYPE,SUMTYPE1                                                 
         MVC   SUMMED1,JOBLET      MEDIA                                        
         MVC   SUMCLI1(6),3(R2)    CLI/PRD                                      
         MVC   SUMJOB1,9(R2)       JOB                                          
         MVC   SUMNAME,PRDNAME                                                  
         MVC   SUMOTH,SAVOTH                                                    
         OC    BILLNO,BILLNO            DRAFT BILLING                           
         BNZ   *+10                                                             
         ZAP   BILLNO,=P'1'                                                     
         ZAP   DUB,BILLNO                                                       
         CVB   R1,DUB                                                           
         STCM  R1,7,SUMBILB             BINARY BILL NUMBER                      
*                                                                               
ADDSUM3  MVC   SUMACCUM(JOBLNQ),JOBBK   ACCUMULATORS                            
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         XC    SUMJOB1,SUMJOB1                                                  
         XC    SUMOTH,SUMOTH                                                    
         XC    SUMBILB,SUMBILB                                                  
         MVI   SUMJOB1,X'FF'                                                    
         BASR  RE,RF               TOTAL EACH MEDIA W/I PRODUCT                 
*                                                                               
         MVI   SUMMED1,X'FF'                                                    
         BASR  RE,RF               TOTAL ALL MEDIA W/I PRODUCT                  
*                                                                               
         XC    SUMPRD1,SUMPRD1                                                  
         MVI   SUMPRD1,X'FF'                                                    
         MVC   SUMMED1,JOBLET                                                   
         BASR  RE,RF               TOTAL EACH MEDIA W/I CLIENT                  
*                                                                               
         MVI   SUMMED1,X'FF'                                                    
         BASR  RE,RF               TOTAL ALL MEDIA W/I CLIENT                   
*                                                                               
*                                  ADD RECORDS FOR CLIENT SUMMARY               
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVC   SUMBILNO(7),SHTBILNO        BILL NUMBER MM-NNNN                  
         OC    USERMC,USERMC                                                    
         BZ    *+10                                                             
         MVC   SUMBILNO,LNGBILNO         OR MM-MC-1234                          
*                                                                               
         L     R2,ADACC                                                         
         MVI   SUMTYPE,SUMTYPE2                                                 
         MVC   SUMMED2,JOBLET      MEDIA                                        
         MVC   SUMCLI2(12),3(R2)   CLI/PRD/JOB                                  
         MVC   SUMOTH,SAVOTH                                                    
         OC    BILLNO,BILLNO            DRAFT BILLING                           
         BNZ   *+10                                                             
         ZAP   BILLNO,=P'1'                                                     
         ZAP   DUB,BILLNO                                                       
         CVB   R1,DUB                                                           
         STCM  R1,7,SUMBILB             BINARY BILL NUMBER                      
*                                                                               
         MVC   SUMACCUM(JOBLNQ),JOBBK   ACCUMULATORS                            
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         XC    SUMJOB2,SUMJOB2     TOTAL MEDIA W/I CLIENT                       
         XC    SUMOTH,SUMOTH                                                    
         XC    SUMBILB,SUMBILB                                                  
         XC    SUMPRD2,SUMPRD2                                                  
*                                                                               
         MVI   SUMJOB2,X'FF'                                                    
         MVI   SUMPRD2,X'FF'                                                    
         BASR  RE,RF                                                            
*                                                                               
         MVI   SUMMED2,X'FF'       TOTAL CLIENT                                 
         BASR  RE,RF                                                            
         EJECT                                                                  
*              BUILD RECORD FOR PROD. BILLING INVOICE REGISTER                  
*                                                                               
         USING PBRD,R5                                                          
ADDSUM4  LA    R5,PBRWK                                                         
         LA    R1,PBRLNQ                                                        
         SLL   R1,16                                                            
         ST    R1,PBRLEN                                                        
         MVI   PBRTYP,PBREQU       RECORD TYPE                                  
         SR    R1,R1                                                            
         ICM   R1,3,RUNCNT           COUNT NUMBER OF INVOICES                   
         AH    R1,=H'1'                                                         
         STCM  R1,3,RUNCNT         KEEP REPORT IN ORDER CREATED                 
         MVC   PBRCNT,RUNCNT                                                    
         L     R2,ADACC                                                         
         MVC   PBRCLI(3),3(R2)          CLI                                     
         MVC   PBRMED,JOBLET            MEDIA                                   
         MVC   PBRPRD(9),6(R2)          PRD/JOB                                 
         MVC   PBROTH,SAVOTH            OTHER                                   
         GOTO1 DATCON,DMCB,(4,BILLDTE),(1,PBRDTE)                               
         MVC   PBRBILL,SPACES                                                   
         MVC   PBRBILL(7),SHTBILNO          BILL NUMBER                         
         OC    USERMC,USERMC                                                    
         BZ    *+10                                                             
         MVC   PBRBILL,LNGBILNO           OR THE LING FORM                      
         MVC   PBRACCUM(JOBLNQ),JOBBK   ACCUMULATORS                            
         GOTO1 SORTER,DMCB,=C'PUT',(R5)                                         
         MVI   ALSORT,1            SO ADDRESS IS NOT ZERO                       
         EJECT                                                                  
*              BUILD RECORD FOR REGISTER OF TARGET ACCOUNTS                     
*                                                                               
         USING RTAD,R5                                                          
         LA    R5,RTAWK                                                         
         LA    R1,RTALNQ                                                        
         SLL   R1,16                                                            
         ST    R1,RTALEN                                                        
         MVI   RTATYP,RTAEQU           RECORD TYPE                              
         L     R2,ADACC                                                         
         MVC   RTACLI(12),3(R2)         CLI/PRD/JOB                             
         MVC   RTAOTH,SAVOTH            OTHER                                   
         MVC   RTAACCUM(JOBLNQ),JOBBK   ACCUMULATORS                            
         GOTO1 DATCON,DMCB,(4,RCDATE),(1,RTADTE)                                
         MVC   RTABILL,SPACES                                                   
         MVC   RTABILL(7),SHTBILNO       BILL NUMBER                            
         OC    USERMC,USERMC                                                    
         BZ    *+10                                                             
         MVC   RTABILL,LNGBILNO          LONG BILL NUMBER                       
         MVC   RTAREC,RECEIVBL+3        RECEIVABLE ACCOUNT                      
         MVC   RTACOST,COSTING+3        COSTING ACCOUNT                         
         MVC   RTASALES,PRODNUM+3       SALES ACCOUNT                           
         CLI   PROF6,C'Y'          PRINT TARGET REGISTER?                       
         BNE   ADDSUM5             NO                                           
         GOTO1 SORTER,DMCB,=C'PUT',(R5)                                         
         MVI   ALSORT,1            SO ADDRESS IS NOT ZERO                       
         EJECT                                                                  
*              BUILD RECORD FOR MEDIA SUMMARY PAGE                              
*                                                                               
         USING MESD,R5                                                          
ADDSUM5  LA    R5,MESWK                                                         
         XC    MESWK(MESLNQ),MESWK                                              
         MVC   MESCDE,JOBLET            MEDIA                                   
         MVC   MESACCUM(JOBLNQ),JOBBK   ACCUMULATORS                            
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AMEDTAB                           
         MVI   MESCDE,X'FF'                                                     
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AMEDTAB                           
*                                                                               
         TM    CLIOPT,NOCOMM+PAYNET                                             
         BZ    ADDSUMX                                                          
         AP    JOBGRS,SAVECOMM     IF PAY = NET                                 
         AP    JOBVGRS,SAVECOMM                                                 
         AP    JOBPGRS,SAVECOMM                                                 
         TM    CLIOPT,PAYNET                                                    
         BNO   ADDSUMX                                                          
         ZAP   JOBCOM,SAVECOMM                                                  
*                                                                               
ADDSUMX  XIT1                                                                   
         DROP  R5,R6                                                            
         TITLE 'AC27 - PRINT A CLIENT SUMMARY BILL'                             
PCLISUMR DS    0D                                                               
         NMOD1 0,*PCLIS**                                                       
         L     RC,0(R1)                                                         
         TM    CLIOPT,CLISUM       DO WE WANT A SUMMARY?                        
         BZ    CLIS14              NO                                           
         MVC   PAGE,=H'1'                                                       
         MVI   FORCEHED,C'Y'                                                    
         MVI   RCSUBPRG,1                                                       
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    *+8                 NO                                           
         MVI   RCSUBPRG,14         YES, CHANGE HEADING                          
*                                                                               
         USING SUMD,R5                                                          
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         LA    R5,BUFWK                                                         
         MVI   SUMTYPE,SUMTYPE2                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    CLIS14                                                           
         CLI   SUMTYPE,SUMTYPE2                                                 
         BNE   CLIS14                                                           
*                                                                               
CLIS02   MVC   MEDIA,SUMMED2                                                    
         MVC   LASTMED,MEDIA                                                    
         GOTO1 SHR,DMCB,('SUBRMED',(RC))                                        
         L     R2,AMEL             ADDRESS OF MEDIA ELEMENT                     
*                                                                               
         USING PMDELD,R2                                                        
         MVC   MID1+1(12),PMDDESC  MEDIA NAME                                   
         GOTO1 UNDERLIN,DMCB,(12,MID1+1),MID2+1                                 
         MVI   FORCEMID,C'Y'                                                    
*                                                                               
CLIS04   MVC   P+1(3),SUMPRD2                                                   
         MVC   P+4(6),SUMJOB2                                                   
         MVC   P+11(9),SUMOTH                                                   
         MVC   P+28(10),SUMBILNO                                                
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         BAS   RE,CLIPRT                                                        
*                                                                               
CLIS06   MVI   BYTE,SUMTYPE2                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    CLIS14                                                           
         CLI   SUMTYPE,SUMTYPE2                                                 
         BNE   CLIS14                                                           
         CLI   SUMPRD2,X'FF'       IS THIS A CLIENT LEVEL TOTAL?                
         BNE   CLIS08              NO                                           
         CLI   SUMMED2,X'FF'       YES, IS IT CLIENT TOTAL?                     
         BE    CLIS12              YES                                          
         B     CLIS10              NO, MUST BE MEDIA                            
*                                                                               
CLIS08   CLC   LASTMED,SUMMED2     NO, MUST BE DETAIL                           
         BNE   CLIS02                                                           
         B     CLIS04                                                           
*                                                                               
CLIS10   BAS   RE,CLIPRT                                                        
         MVC   P+1(L'AC@TFOR),AC@TFOR   MEDIA                                   
         MVC   P+1+L'AC@TFOR+1(12),PMDDESC                                      
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         MVI   SPACING,1                                                        
         BAS   RE,CLIPRT                                                        
         B     CLIS06                                                           
*                                                                               
CLIS12   DS    0H                                                               
         MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
         MVI   FORCEMID,C'N'                                                    
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         MVC   P+1(L'AC@TOTCL),AC@TOTCL                                         
         BAS   RE,CLIPRT                                                        
*                                                                               
CLIS14   MVI   FORCEMID,C'N'                                                    
         MVI   RCSUBPRG,0                                                       
         MVI   BYTE,SUMTYPE2                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,SUMTYPE1                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
*                                                                               
PCLISX   XIT1                                                                   
*                                                                               
CLIPRT   ST    RE,SAVERE                                                        
         MVC   HEAD4+8(3),CLICODE+3                                             
         MVC   HEAD4+1(L'AC@CLINT),AC@CLINT                                     
         MVC   HEAD4+15(36),CLINAME                                             
         GOTO1 ACREPORT                                                         
         L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  R2,R5                                                            
         LTORG                                                                  
         TITLE 'AC27 - PRINT A PRODUCT SUMMARY BILL'                            
PPROSUMR DS    0D                                                               
         NMOD1 0,*PPROS**                                                       
         L     RC,0(R1)                                                         
         TM    CLIOPT,PROSUM                                                    
         BZ    PROS12                                                           
         MVC   PAGE,=H'1'                                                       
         MVI   FORCEHED,C'Y'                                                    
         MVI   RCSUBPRG,1                                                       
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    *+8                 NO                                           
         MVI   RCSUBPRG,14         YES, CHANGE HEADING                          
*                                                                               
         USING SUMD,R5                                                          
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   SUMTYPE,SUMTYPE1                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    PROS12                                                           
         CLI   SUMTYPE,SUMTYPE1                                                 
         BNE   PROS12                                                           
*                                                                               
PROS02   MVC   MEDIA,SUMMED1                                                    
         MVC   LASTMED,MEDIA                                                    
         GOTO1 SHR,DMCB,('SUBRMED',(RC))                                        
         L     R2,AMEL             ADDRESS OF MEDIA ELEMENT                     
         USING PMDELD,R2                                                        
*                                                                               
         MVC   MID1+1(12),PMDDESC  MEDIA NAME                                   
         GOTO1 UNDERLIN,DMCB,(12,MID1+1),MID2+1                                 
         MVI   FORCEMID,C'Y'                                                    
*                                                                               
PROS04   MVC   P+1(6),SUMJOB1                                                   
         MVC   P+8(9),SUMOTH                                                    
         MVC   P+28(10),SUMBILNO                                                
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         BAS   RE,PRODPRT                                                       
*                                                                               
PROS06   MVI   BYTE,SUMTYPE1                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    PROS12                                                           
         CLI   SUMTYPE,SUMTYPE1                                                 
         BNE   PROS12                                                           
         CLI   SUMPRD1,X'FF'       IS THIS A CLIENT TOTAL?                      
         BE    PROS06              YES, SKIP IT                                 
         CLI   SUMMED1,X'FF'       IS THIS A PRODUCT TOTAL?                     
         BE    PROS08              YES                                          
         CLI   SUMJOB1,X'FF'       IS THIS A MEDIA TOTAL?                       
         BE    PROS10              YES                                          
         CLC   LASTMED,SUMMED1                                                  
         BNE   PROS02              CHANGE OF PRODUCT PRINT TOTALS               
         B     PROS04                                                           
*                                                                               
PROS08   DS    0H                                                               
         MVC   MID1,SPACES         PRODUCT TOTAL                                
         MVC   MID2,SPACES                                                      
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         MVC   P+1(L'AC@TOTPR),AC@TOTPR                                         
         BAS   RE,PRODPRT                                                       
         MVI   FORCEHED,C'Y'                                                    
         B     PROS06                                                           
*                                                                               
PROS10   BAS   RE,PRODPRT                                                       
         MVC   P+1(L'AC@TFOR),AC@TFOR           MEDIA                           
         MVC   P+1+L'AC@TFOR+1(12),PMDDESC                                      
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         MVI   SPACING,2                                                        
         BAS   RE,PRODPRT                                                       
         B     PROS06                                                           
*                                                                               
PROS12   MVI   FORCEMID,C'N'                                                    
         MVI   RCSUBPRG,0                                                       
         MVI   BYTE,SUMTYPE1                                                    
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
*                                                                               
PPROSX   XIT1                                                                   
*                                                                               
PRODPRT  ST    RE,SAVERE                                                        
         MVC   HEAD4+55(L'AC@PRO),AC@PRO                                        
         MVC   HEAD4+63(3),SUMPRD1                                              
         MVC   HEAD4+69(19),SPACES                                              
         MVC   HEAD5+69(17),SPACES                                              
         LA    R3,HEAD4+69                                                      
         GOTO1 CHOPPER,DMCB,(36,SUMNAME),(19,(R3)),(C'P',2)                     
         MVC   HEAD4+8(3),CLICODE+3                                             
         MVC   HEAD4+1(L'AC@CLINT),AC@CLINT                                     
         MVC   HEAD4+15(36),CLINAME                                             
         GOTO1 ACREPORT                                                         
         L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  R2,R5                                                            
         LTORG                                                                  
         TITLE 'AC27 - UNMARK THE 99 TRANSACTION FOR UNBILLING'                 
         USING TRNRECD,R3                                                       
UNMARKR  DS    0D                                                               
         NMOD1 0,**UNMK**                                                       
         L     RC,0(R1)                                                         
         TM    BILLMODE,RERUN              IS THIS A RERUN?                     
         BO    UNMARKX                     YES                                  
         L     R3,AIO2                                                          
         L     R4,ADACC                                                         
         MVC   TRNKEY(42),SPACES                                                
         MVC   TRNKCULA,0(R4)                                                   
         MVC   TRNKWORK,=C'99'                                                  
*                                                                               
         MVC   SAVEKEY,TRNKCULA                                                 
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R3),(R3)                             
*                                                                               
UNMARK02 CLC   TRNKCULA(L'TRNKCULA+L'TRNKWORK),SAVEKEY                          
         BNE   UNMARKX             CAN'T UNBILL WHAT I CAN'T FIND               
         CLC   TRNKREF,QSELECT                                                  
         BNE   UNMARK04                                                         
         GOTO1 DATCON,DMCB,(1,TRNKDATE),(2,WORK)                                
         CLC   WORK(2),END2                                                     
         BNE   UNMARK04                                                         
         B     UNMARK06                                                         
*                                                                               
UNMARK04 GOTO1 DATAMGR,DMCB,DMRSEQ,FILNME,(R3),(R3)                             
         B     UNMARK02                                                         
*                                                                               
UNMARK06 LR    R2,R3                                                            
         AH    R2,DATADISP                                                      
         CLI   0(R2),TRNELQ        X'44' ELEMENT                                
         BE    *+6                 MUST HAVE IT                                 
         DC    H'0'                                                             
*                                                                               
         USING TRNELD,R2                                                        
         MVC   BILLNAME,=CL15'ALLOCATED BILL'                                   
         MVI   BILLTYPE,CLIENT                                                  
         CLI   TRNNARR,C'A'                                                     
         BNE   UNMARK04                                                         
*                                                                               
         XC    TRNUNBIL,TRNUNBIL     CLEAR UNBILL DATE                          
         CLI   RCWRITE,C'N'                                                     
         BE    UNMARKX                                                          
         GOTO1 DATAMGR,DMCB,DMWRT,FILNME,(R3),(R3)                              
*                                                                               
UNMARKX  XIT1                                                                   
         DROP  R2,R3                                                            
         LTORG                                                                  
         TITLE 'AC27 - GET BILL NUMBER AND DATE FOR UNBILLING'                  
         USING TRNRECD,R3                                                       
BILLR    DS    0D                                                               
         NMOD1 0,*BILL*                                                         
         L     RC,0(R1)                                                         
         L     R3,AIO2                                                          
         L     R4,ADACC                                                         
         MVC   TRNKEY(42),SPACES                                                
         MVC   TRNKCULA,0(R4)                                                   
         MVC   TRNKWORK,=C'99'                                                  
*                                                                               
         MVC   SAVEKEY,TRNKCULA                                                 
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R3),(R3)                             
*                                                                               
BILL02   CLC   TRNKCULA(L'TRNKCULA+L'TRNKWORK),SAVEKEY                          
         BNE   BILLXNO             CAN'T UNBILL WHAT I CAN'T FIND               
         CLC   TRNKREF,QSELECT                                                  
         BNE   BILL04                                                           
         GOTO1 DATCON,DMCB,(1,TRNKDATE),(2,WORK)                                
         CLC   WORK(2),END2                                                     
         BNE   BILL04                                                           
         B     BILL06                                                           
*                                                                               
BILL04   GOTO1 DATAMGR,DMCB,DMRSEQ,FILNME,(R3),(R3)                             
         B     BILL02                                                           
*                                                                               
BILL06   LR    R2,R3                                                            
         AH    R2,DATADISP                                                      
         CLI   0(R2),X'44'                                                      
         BNE   BILLXNO                                                          
*                                                                               
         USING TRNELD,R2                                                        
         MVC   BILLNAME,=CL15'ALLOCATED BILL'                                   
         MVI   BILLTYPE,CLIENT                                                  
         CLI   TRNNARR,C'A'                                                     
         BNE   BILL04                                                           
*                                                                               
         OC    TRN2DAY,TRN2DAY     NO, IS THERE A RUN DATE?                     
         BZ    BILLXNO             NO, CAN'T UNBILL THEN                        
*                                                                               
         TM    BILLMODE,RERUN      IS THIS A RERUN?                             
         BO    BILL14              YES                                          
*                                                                               
         OC    TRNUNBIL,TRNUNBIL   NO, WAS IT ALREADY UNBILLED?                 
         BNZ   BILLXNO             YES, CAN'T UNBILL AGAIN                      
         LR    R4,R2               SAVE WHERE WE ARE                            
*                                                                               
         USING ACMD,R5                                                          
         L     R5,AMONACC                                                       
         GOTO1 ACMAPRAT,DMCB,(X'C0',(R3)),ADGOBLOC,ADCOMFAC,0,         X        
               ACMAPROB,ACMAPRO2                                                
*                                                                               
         L     R5,ACMAPRO2                                                      
BILL08   CLI   0(R5),PTAELQ                                                     
         BE    BILL10                                                           
         CLI   0(R5),0                                                          
         BE    BILL12                                                           
         SR    RF,RF                                                            
         IC    RF,1(R5)                                                         
         AR    R5,RF                                                            
         B     BILL08                                                           
*                                                                               
         USING PTAELD,R5                                                        
BILL10   CLC   PTARFORM,FORMHOLD   IS FORMAT SAME AS SPECIFIED?                 
         BNE   BILLXNO             NO, CAN'T UNBILL IT                          
         TM    PTASTAT1,PTASREVS   IS THIS FROM AN UNBILLING?                   
         BO    BILLXNO             YES, CAN'T UNBILL AN UNBILLING               
*                                                                               
BILL12   LR    R2,R4               RESET REGISTER                               
         USING TRNELD,R2                                                        
         MVC   TRNUNBIL,TODAY2      YES, PUT UNBILL DATE OF TODAY               
         OI    PTASTAT1,PTASREVU    MARK 77 UNBILLED.                           
         CLI   RCWRITE,C'N'                                                     
         BE    BILL16                                                           
         GOTO1 DATAMGR,DMCB,DMWRT,FILNME,(R3),(R3)                              
         B     BILL16                                                           
*                                                                               
BILL14   CLC   TRNUNBIL,TODAY2       WAS IT UNBILLED TODAY?                     
         BNE   BILLXNO               NO, CAN'T RERUN IT THEN                    
*                                                                               
BILL16   MVC   USEBILL,WORK                                                     
         MVC   USEDATE,TRN2DAY                                                  
         OC    TRNQTFLT,TRNQTFLT                                                
         BZ    *+10                                                             
         MVC   QTRNSFLT,TRNQTFLT        USE SAME FILTER FOR WORKCODE            
         CLI   QOPT1,C'Y'                  USE ORIGINAL BILL NUMBER?            
         BNE   BILLXYES                    NO                                   
         PACK  BILLNO,QSELECT              YES                                  
         OI    BILLOPT,OLDNUM                                                   
         B     BILLXYES                                                         
*                                                                               
BILLXNO  XC    USEBILL,USEBILL                                                  
*                                                                               
BILLXYES XIT1                                                                   
         DROP  R2,R3,R5                                                         
         LTORG                                                                  
         TITLE 'AC27 - WARNING MESSAGES'                                        
***********************************************************************         
*              ADD WARNING MESSAGE TO SORT                            *         
*              R3=A(WARNRSNS)                                                   
*              R4=A(REASON EQUATES)                                   *         
***********************************************************************         
*                                                                               
         USING EXCD,R5                                                          
WARNR    DS    0D                                                               
         NMOD1 0,*WARNR                                                         
         L     RC,0(R1)                                                         
         L     R3,4(R1)                                                         
         L     R4,8(R1)                                                         
         L     R5,AEXCRWK          GENERATE SORT RECORD FOR REPORT              
         LA    R1,EXCRLNQ                                                       
         SLL   R1,16                                                            
         ST    R1,EXCRLN                                                        
*                                                                               
         MVI   EXCRTYP,EXCREQU                                                  
         MVC   EXCRSTUD,SVSTUD     STUDIO TYPE                                  
         MVC   EXCRSACC,JOBCODE+3  STUDIO JOB                                   
*                                                                               
         MVC   EXCRDATE,DATE3      DATE                                         
         MVC   EXCRAJOB,SVAGACC    AGENCY JOB                                   
         MVC   EXCRMSG,SPACES                                                   
         MVC   EXCRBILL(7),SHTBILNO                                             
         OC    USERMC,USERMC       BILL NUMBER                                  
         BZ    *+10                                                             
         MVC   EXCRBILL,LNGBILNO                                                
*                                                                               
         LA    R0,L'WARNRSNS                                                    
WARN02   CLI   0(R3),0             WARNING MESSAGE ASSIGNED?                    
         BNE   WARN06              YES FIND IT                                  
*                                                                               
WARN04   LA    R3,1(R3)            CHECK NEXT BYTE                              
         BCT   R0,WARN02                                                        
         B     WARN12                                                           
*                                                                               
WARN06   LR    R1,R4                                                            
*                                                                               
WARN08   CLC   0(1,R1),0(R3)       GET THE REASON                               
         BE    WARN10                                                           
         CLI   0(R1),X'FF'         END OF TABLE?                                
         BE    WARN12              NO MESSAGE                                   
         SR    R2,R2                                                            
         IC    R2,1(R1)                                                         
         LA    R1,2(R2,R1)                                                      
         B     WARN08                                                           
*                                                                               
WARN10   SR    R2,R2                                                            
         IC    R2,1(R1)                                                         
         BCTR  R2,0                                                             
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   EXCRMSG(0),2(R1)                                                 
*                                                                               
WARN12   GOTO1 SORTER,DMCB,=C'PUT',(R5)                                         
         MVI   ALSORT,1                                                         
*                                                                               
WARNX    XIT1                                                                   
         DROP  RB                                                               
         LTORG                                                                  
         TITLE 'AC27 - PROFESSIONAL BILLING - FILTERING ROUTINES'               
FILTR    DS    0D                                                               
         NMOD1 0,**FILTR*,RA                                                    
         L     RC,0(R1)                                                         
         L     R6,ADGOBLOC                                                      
         USING GOBLOCKD,R6                                                      
         MVC   SAVOTH,SPACES            CLEAR SAVE AREAS                        
         MVC   SVEA,SPACES                                                      
         MVC   SVAC,SPACES                                                      
         MVC   SVBI,SPACES                                                      
         MVC   SVBU,SPACES                                                      
         MVC   SV12ACC,SPACES                                                   
         MVC   SV12NAM,SPACES                                                   
         MVC   SVASNAM,SPACES                                                   
         MVC   SVASWTYP,SPACES                                                  
*                                                                               
         MVC   SVGSTCOD,GOTAXCOD                                                
         MVC   SVPSTCOD,GOPSTCOD                                                
         MVC   SVPSTPRV,GOPSTPRV                                                
         MVC   SVAGYCOM,GOAGYCOM   SAVE COMMISSION BEFORE JOBBER                
         XC    SVZERO,SVZERO       REMOVE WEHN READY TO TEST OPTION             
         MVC   SVZERO,GOZERO       SAVE OPTION TO ZERO BILLINGS                 
*                                                                               
*                                                                               
         MVC   SVASPCT,GOASPCT     SAVE RETAINER OPTIONS                        
         MVC   SVASACC,GOASACC                                                  
         MVC   SVASBIL,GOASBIL                                                  
         MVC   SVASOBIL,GOASBIL    SAVE FOR UNBILLING                           
         MVC   SVASWRK,GOASWRK                                                  
         MVC   SVASWRKN,SPACES     CLEAR NAME OF AS WORKCODE                    
*                                                                               
         MVC   COMMKEY,SPACES      YES, GET THE NAME                            
         MVC   COMMKEY(L'SVASACC),SVASACC                                       
         MVC   KEYSAVE,COMMKEY                                                  
         L     R2,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)       FIND IT?                                     
         BE    FILTR02             YES                                          
*                                                                               
FILTR00  XC    SVASACC,SVASACC     CLEAR ACCOUNT IF CAN'T BE FOUND              
         B     FILTR16                                                          
*                                                                               
FILTR02  LA    R3,SVASNAM                                                       
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
         CLI   SVASACC+2,C'B'                                                   
         BE    FILTR16             NOTHING ELSE NEEDED FOR SB                   
         TM    CMPOPT,POSTCOST     MAKING COST POSTINGS?                        
         BZ    FILTR16             NO, NOTHING ELSE NEEDED                      
         CLI   SVASACC++2,C'I'                                                  
         BE    FILTR04             READ FOR 12 ACCOUNT IF SI                    
*                                                                               
         CLI   SVASBIL,C'N'        ARE WE BILLING THIS MONTH?                   
         BE    FILTR16             NO, DONE FOR NOW                             
*                                                                               
         MVC   COMMKEY,SPACES      SK ACCOUNT, READ FOR SI                      
         MVC   COMMKEY(L'SVASACC),SVASACC                                       
         MVI   COMMKEY+2,C'I'                                                   
         MVC   KEYSAVE,COMMKEY                                                  
         L     R2,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)       FIND IT?                                     
         BNE   FILTR00             NO, CLEAR ACCOUNT                            
*                                                                               
FILTR04  AH    R2,DATADISP                                                      
         MVC   WORK,SPACES                                                      
*                                                                               
FILTR06  CLI   0(R2),0                                                          
         BE    FILTR00                                                          
         CLI   0(R2),SPAELQ                                                     
         BE    FILTR12                                                          
         CLI   0(R2),RSTELQ                                                     
         BE    FILTR10                                                          
*                                                                               
FILTR08  SR    R1,R1                                                            
         IC    R1,1(R2)                                                         
         AR    R2,R1                                                            
         B     FILTR06                                                          
*                                                                               
         USING RSTELD,R2                                                        
FILTR10  MVC   WORK(L'RSTCOSTG),RSTCOSTG                                        
         B     FILTR14                                                          
*                                                                               
         USING SPAELD,R2                                                        
FILTR12  CLI   SPATYPE,SPATANAL     LOOK FOR ANALYSIS ACCOUNT                   
         BNE   FILTR08                                                          
         MVC   WORK(L'SIAC),SPAAULA                                             
*                                                                               
FILTR14  MVC   COMMKEY,SPACES      READ THE 12 ACCOUNT                          
         MVC   COMMKEY(1),QCOMPANY                                              
         MVC   COMMKEY+1(2),=C'12'                                              
         MVC   COMMKEY+3(L'SIAC),WORK                                           
         MVC   KEYSAVE,COMMKEY                                                  
         L     R2,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)       FIND IT?                                     
         BNE   FILTR00             NO, CLEAR ACCOUNT                            
         MVC   SV12ACC,0(R2)                                                    
         LA    R3,SV12NAM                                                       
*                                                                               
FILTR16  L     R2,ADACC                                                         
         AH    R2,DATADISP                                                      
*                                                                               
         USING OTHELD,R2                                                        
EXTR02   CLI   0(R2),X'23'         NUMBER ELEMENT                               
         BNE   EXTR04                                                           
         MVC   SAVOTH,OTHNUM                                                    
         B     EXTRNXT                                                          
*                                                                               
         USING JOBELD,R2                                                        
EXTR04   CLI   0(R2),X'26'                                                      
         BNE   EXTR06                                                           
         TM    JOBSTA1,X'80'      IS ESTIMATE UNAPPROVED?                       
         BZ    *+8                 NO                                           
         OI    ESTOPT,UNAPP        YES                                          
         TM    JOBSTA1,JOBSXJOB   IS THIS AN X-JOB?                             
         BZ    *+8                 NO                                           
         OI    JOBOPT,JOBX         YES, INDICATE SO                             
         B     EXTRNXT                                                          
*                                                                               
         USING ABIELD,R2                                                        
EXTR06   CLI   0(R2),X'27'         BILLING INFORMATION ELEMENT                  
         BNE   EXTR08                                                           
         MVC   SVEA,ABIEANO                                                     
         MVC   SVAC,ABIACNO                                                     
         CLI   ABILN,X'48'       ANY SPECIAL BILL NUMBER?                       
         BL    EXTRNXT             NO                                           
         MVC   SVBI,ABIBINO       YES, SAVE IT                                  
         CLI   ABILN,X'57'       ANY BUDGET MEMO?                               
         BL    EXTRNXT             NO                                           
         MVC   SVBU,ABIBMEM       YES, SAVE IT                                  
         B     EXTRNXT                                                          
*                                                                               
         USING LNKELD,R2                                                        
EXTR08   CLI   0(R2),LNKELQ                                                     
         BNE   EXTRNXT                                                          
         OC    LNKAGJB,LNKAGJB     DO WE HAVE AN AGENCY JOB?                    
         BNZ   EXTR10              YES                                          
         MVI   SPECRSN,ESSN01                                                   
         BAS   RE,FILTNOS                                                       
         B     EXTRNXT                                                          
*                                                                               
EXTR10   MVC   SVSTUD,LNKSTUD      SAVE THE TYPE AND THE AGENCY JOB             
         MVC   SVAGCUL,JOBCODE                                                  
         MVC   SVAGACC,LNKAGJB                                                  
         MVC   SVELEM,LNKEL        SAVE THE WHOLE ELEMENT                       
         OI    JOBOPT,JBSTUDIO                                                  
         B     EXTRNXT                                                          
*                                                                               
EXTRNXT  ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BNE   EXTR02                                                           
         DROP  R2,R6                                                            
         EJECT                                                                  
*              ROUTINE TO EXTRACT EXTRA PROFILE INFO                            
*                                                                               
PROF     MVI   CLIOPT,CLISUM+PROSUM+ESTREQ                                      
         MVI   EPRFILT2,0                                                       
         MVI   WKCOPT,WKCDTLC+WKCDTL                                            
         L     R6,ADGOBLOC                                                      
         USING GOBLOCKD,R6                                                      
*                                                                               
         CLI   GOCLISUM,C'N'       CLIENT SUMMARY                               
         BNE   *+8                                                              
         NI    CLIOPT,ALL-CLISUM                                                
*                                                                               
         CLI   GOBILDET,C'Y'       DETAIL LINES ON BILLS                        
         BE    *+8                                                              
         NI    WKCOPT,ALL-WKCDTLC                                               
*                                                                               
         CLI   GOFILT2,0           FILTER2 WHEN TYPE 47 BILLED                  
         BE    *+10                                                             
         MVC   EPRFILT2,GOFILT2                                                 
*                                                                               
         CLI   GOPROSUM,C'N'       PRODUCT SUMMARY                              
         BNE   *+8                                                              
         NI    CLIOPT,ALL-PROSUM                                                
*                                                                               
         ZAP   DUB,=P'0'                                                        
         OC    GOOVRPER,GOOVRPER   MAXIMUM OVER PERCENT                         
         BZ    *+10                                                             
         ZAP   DUB,GOOVRPER                                                     
*                                                                               
         CVB   R3,DUB                                                           
         ST    R3,OVEREST                                                       
         ZAP   OVERAMT,=P'0'                                                    
         CP    GOOVRAMT,=P'0'      MAXIMUM OVER AMOUNT                          
         BE    *+10                                                             
         ZAP   OVERAMT,GOOVRAMT                                                 
*                                                                               
         MVC   PREVOPT,GOSUP99S    SAVE OPTION TO SUPPRESS 99'S                 
         OC    PREVOPT,PREVOPT     DO WE HAVE ONE?                              
         BNZ   *+10                YES, USE IT                                  
         MVC   PREVOPT,PROF7       NO, SET IT FROM PROFILE                      
*                                                                               
         CLI   GONEEDES,C'N'       NEED ESTIMATE TO BILL                        
         BNE   *+8                                                              
         NI    CLIOPT,ALL-ESTREQ                                                
*                                                                               
         MVC   INCACC,GOTBC        SAVE INCOME ACCOUNT                          
         CLI   GOSUPAGY,C'Y'       NET PAYMENTS, NO COMMISSION?                 
         BNE   *+8                 NO                                           
         OI    CLIOPT,NOCOMM                                                    
*        OI    CLIOPT,PAYNET                                                    
*                                                                               
*        CLI   GOPAYNET,C'Y'       NET PAYMENTS?                                
*        BNE   *+8                 NO                                           
*        OI    CLIOPT,PAYNET                                                    
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    PROFXIT             NO                                           
*                                                                               
         USING ACMD,R3                                                          
         L     R3,AMONACC                                                       
         USING GOXBLKD,R6                                                       
         L     R6,ACMAGOX                                                       
         MVC   SVICR,GOICR         GET INTERCOMPANY CREDIT ACCOUNT              
*                                                                               
PROFXIT  DS    0H                                                               
         DROP  R3,R6                                                            
         EJECT                                                                  
*              APPLY FILTERS TO JOB                                             
*                                                                               
FILTER   ZAP   ESTIMATE,=P'0'                                                   
         XC    REASONS,REASONS                                                  
         XC    SPECRSNS,SPECRSNS                                                
*                                                                               
         L     R3,AMONACC                                                       
         USING ACMD,R3                                                          
         L     R4,ACMACOL                                                       
         L     R5,ACMAJOBB                                                      
         USING JBLOCKD,R5                                                       
         L     R6,ADGOBLOC                                                      
         USING GOBLOCKD,R6                                                      
         DROP  R3                                                               
*                                                                               
         BAS   RE,BLDSOFT          BUILD SOFT HEADLINES                         
*                                                                               
         MVI   RCSUBPRG,0                                                       
*                                                                               
         CLI   PROF27,C'Y'         PRINT LONG NAMES?                            
         BNE   *+8                 NO                                           
         OI    CLIOPT,USELONG      YES                                          
*                                                                               
         MVI   REASON,ERSN08                                                    
         TM    JOBOPT,JOBX         IS THIS AN X-JOB?                            
         BZ    *+8                 NO                                           
         BAS   RE,FILTNO           YES, CAN'T BILL                              
*                                                                               
         OC    SVASPCT,SVASPCT     ANY CONTINGENCY PERCENT?                     
         BZ    FILT00              NO                                           
         CP    SVASPCT,=P'0'       YES, IS IT ZERO?                             
         BE    FILT00              YES                                          
*                                                                               
         MVI   REASON,ERSN09                                                    
         OC    SVASACC,SVASACC     NO, MUST HAVE AN ASP ACCOUNT?                
         BNZ   *+8                 YES                                          
         BAS   RE,FILTNO           NO, CAN'T BILL                               
*                                                                               
         MVI   REASON,ERSN10                                                    
         OC    GOASWRK,GOASWRK     YES, DO WE HAVE A WORKCODE?                  
         BNZ   *+8                 YES                                          
         BAS   RE,FILTNO           NO, CAN'T BILL                               
*                                                                               
FILT00   L     R2,ADACCBAL                                                      
         USING ABLELD,R2                                                        
         ZAP   DEBITS,ABLDR                                                     
         LA    R3,BILLTAB          GET TABLE OF BILLTYPES                       
*                                                                               
         USING BILLTD,R3                                                        
         MVI   REASON,ERSN05                                                    
FILT02   CLI   BILLNME,X'FF'       END OF TABLE?                                
         BNE   FILT04              NO                                           
         BAS   RE,FILTNO           YES, ERROR                                   
         B     FILT22                                                           
*                                                                               
FILT04   CLC   GOBILTYP,BILLCDE    DO WE HAVE A MATCH?                          
         BE    FILT06              YES                                          
         LA    R3,L'BILLEN(R3)     NO, KEEP LOOKING                             
         B     FILT02                                                           
*                                                                               
FILT06   MVC   BILLNAME,BILLNME                                                 
         MVC   FCRDTRNS,BILLTRNS                                                
         MVC   BILLTYPE,BILLTYP                                                 
         MVC   BILLCODE,BILLCOD                                                 
*                                                                               
         MVI   REASON,ERSN04                                                    
         CLI   GONEEDES,C'Y'       DO WE NEED AN ESTIMATE?                      
         BNE   FILT10              NO                                           
*                                                                               
         CLI   JBNEWEST,C'Y'       YES, IS THIS A NEW ESTIMATE?                 
         BE    FILT07              YES                                          
         CLI   JBNEWEST,JBMCSQ     NO, IS IT MSC?                               
         BNE   FILT08              NO                                           
*                                                                               
FILT07   CLI   GONEEDAE,C'Y'       NEED APPROVAL TO BILL?                       
         BNE   FILT10              NO                                           
         OC    JBHIAPP,JBHIAPP     YES, ANY APPROVED ESTIMATES?                 
         BNZ   FILT10              YES                                          
         B     *+12                NO                                           
*                                                                               
FILT08   TM    ESTOPT,UNAPP        IS ESTIMATE APPROVED?                        
         BZ    *+8                 YES                                          
         BAS   RE,FILTNO           NO, ERROR                                    
*                                                                               
FILT10   TM    WKCOPT,WKCDTLC      PRINT DETAIL?                                
         BO    FILT12              YES                                          
         MVI   RCSUBPRG,6          NO, CHANGE FORMAT                            
*                                                                               
FILT12   TM    BILLMODE,BILL+DRAFT                                              
         BZ    FILT16              GET BILL # FOR RERUN/TOTAL FOR WC            
         BAS   RE,LOOKAHD                                                       
*                                                                               
FILT16   L     RF,ADACCSTA                                                      
         USING RSTELD,RF                                                        
         MVI   REASON,ERSN06                                                    
         TM    RSTSTAT,X'40'      IS JOB CLOSED?                                
         BZ    *+8                 NO                                           
         BAS   RE,FILTNO           YES, ERROR                                   
*                                                                               
         CLI   JBNEWEST,JBMCSQ     FOR MCS ESTIMATES SKIP                       
         BNE   FILTR17                                                          
         USING MJETABD,R4                                                       
         ZAP   ESTIMATE,MJETVAL                                                 
         B     *+10                                                             
         DROP  R4                                                               
*                                                                               
         USING JBCOLD,R4                                                        
FILTR17  ZAP   ESTIMATE,JBCOLVAL   GET TOTAL CURRENT NET                        
         DROP  R4                                                               
*                                                                               
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BO    FILT22              YES                                          
         ZAP   DUB,ESTIMATE        NO                                           
         CP    ESTIMATE,=P'0'      IS THERE AN ESTIMATE?                        
         BNE   FILT18              YES                                          
         MVI   REASON,ERSN03                                                    
         TM    CLIOPT,ESTREQ       NO, IS ONE REQUIRED?                         
         BZ    *+8                 NO                                           
         BAS   RE,FILTNO           YES, ERROR                                   
         ZAP   DUB,DEBITS                                                       
         B     FILT22                                                           
*                                                                               
FILT18   L     RF,OVEREST                                                       
         CVD   RF,DUB                                                           
         ZAP   PL13,DUB                                                         
         ZAP   DUB,DEBITS                                                       
         TM    BILLMODE,RERUN      IS IT A RERUN?                               
         BO    FILT20              YES, DEBITS IS THE RIGHT FIELD               
         ZAP   DUB,ALLDRS          OTHERWISE USE BILLED AND ALLOCATED           
*                                                                               
FILT20   MP    PL13,ESTIMATE       PERCENT OVER ESTIMATE                        
         DP    PL13,=PL3'10000'                                                 
         CLI   GONEEDES,C'Y'       DO WE NEED AN ESTIMATE?                      
         BNE   FILT22              NO                                           
         MVI   REASON,ERSN01                                                    
         CP    DUB,PL13(10)        YES, IS AMOUNT TOO HIGH?                     
         BNH   *+8                 NO                                           
         BAS   RE,FILTNO           YES, ERROR                                   
*                                                                               
         CP    OVERAMT,=P'0'       AMOUNT OVER ESTIMATE                         
         BE    FILT22                                                           
         ZAP   PL13,ESTIMATE       ESTIMATE                                     
         AP    PL13,OVERAMT        + AMOUNT ALLOWED TO GO OVER                  
         CP    DUB,PL13            IS AMOUNT TOO HIGH?                          
         BNH   FILT22              NO                                           
         MVI   REASON,ERSN02       YES, ERROR                                   
         BAS   RE,FILTNO                                                        
*                                                                               
FILT22   MVI   BILFLTSW,C'Y'       CHECK BILLING FILTER STATUS                  
         L     RF,ADLVASTA         FOR CLIENT                                   
         BAS   RE,FILTRBL                                                       
         L     RF,ADLVBSTA             PRODUCT                                  
         BAS   RE,FILTRBL                                                       
         L     RF,ADACCSTA             AND JOB                                  
         BAS   RE,FILTRBL                                                       
         B     FILT24                                                           
*                                                                               
         USING RSTELD,RF                                                        
FILTRBL  CLI   RSTLN,RSTLN2Q    IS THIS AN OLD ELEMENT?.                        
         BLR   RE                  YES                                          
         TM    RSTSTAT2,X'80'      NO, IS IT BILLABLE?                          
         BZ    *+10                                                             
         MVI   BILFLTSW,C'Y'       YES                                          
         BR    RE                                                               
         TM    RSTSTAT2,X'40'      NO, IS IT UNBILLABLE?                        
         BZR   RE                  NO, LEAVE IT BILLABLE                        
         MVI   BILFLTSW,C'N'       YES, MAKE IT UNBILLABLE                      
         BR    RE                                                               
*                                                                               
FILT24   MVI   REASON,ERSN07                                                    
         CLI   BILFLTSW,C'Y'       IS THIS JOB BILLABLE?                        
         BE    *+8                 YES                                          
         BAS   RE,FILTNO           NO, ERROR                                    
*                                                                               
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BO    FILTX               YES, RUN ANYWAY                              
         OC    REASONS,REASONS     ANY REASONS TO NOT BILL?                     
         BNZ   NOTOBILL            YES                                          
         OC    SOFTRSN,SOFTRSN     NO, ANY USER FIELD ERRORS?                   
         BNZ   NOTOBILL            YES                                          
         OC    SPECRSNS,SPECRSNS   ANY SPECIAL REASONS TO NOT BILL?             
         BZ    FILTX               NO, OKAY TO BILL                             
*                                                                               
NOTOBILL MVI   BILLTYPE,NOTBILL                                                 
         MVI   FCRDTRNS,C'N'                                                    
         MVI   FCRDEST,C'N'                                                     
*                                                                               
         LA    R0,L'SPECRSNS       PRINT SPECIAL REASONS (IF ANY)               
         LA    R3,SPECRSNS                                                      
         LA    R4,SSN01                                                         
         BAS   RE,NOBILMSG                                                      
*                                                                               
         CLC   QUESTOR(7),=C'SUMMARY'                                           
         BE    NOTOBIL2                                                         
         CLC   QPROG,=C'28'        IS THIS A DRAFT?                             
         BNE   FILTX               NO                                           
         CLI   PROF21,C'Y'         WANT NON-BILLABLE DETAILS?                   
         BNE   FILTX               NO                                           
*                                                                               
NOTOBIL2 LA    R0,L'REASONS        PRINT REGULAR REASONS (IF ANY)               
         LA    R3,REASONS                                                       
         LA    R4,RSN01                                                         
         BAS   RE,NOBILMSG                                                      
*                                                                               
SOFTBIL  LA    R3,SOFTRSN          NOW DO SOFT REASONS                          
         LA    R0,7                                                             
*                                                                               
         USING NOBD,RF                                                          
SOFTB02  OC    0(12,R3),0(R3)                                                   
         BZ    FILTX               NO MORE REASONS                              
         L     RF,ANOBWK                                                        
         MVC   NOBDATA,SPACES                                                   
         MVI   NOBRSN,40           REASON CODE                                  
         MVC   NOBDATA(10),=C'MISSING - '                                       
         MVC   NOBDATA+11(12),0(R3)      SOFT REASON                            
         GOTO1 SORTER,DMCB,=C'PUT',ANOBWK                                       
         MVI   ALSORT,1            SO ADDRESS IS NOT ZERO                       
         LA    R3,12(R3)                                                        
         BCT   R0,SOFTB02                                                       
         B     FILTX                                                            
         DROP  RF                                                               
*                                                                               
*              SET ERROR REASON NUMBER                                          
FILTNO   ZIC   R1,REASON                                                        
         BCTR  R1,0                                                             
         LA    R1,REASONS(R1)                                                   
         MVC   0(1,R1),REASON                                                   
         BR    RE                                                               
*                                                                               
*              SET SPECIAL ERROR REASON NUMBER                                  
FILTNOS  ZIC   R1,SPECRSN                                                       
         BCTR  R1,0                                                             
         LA    R1,SPECRSNS(R1)                                                  
         MVC   0(1,R1),SPECRSN                                                  
         BR    RE                                                               
*                                                                               
FILTX    TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    *+8                 NO                                           
         MVI   SVASBIL,C'N'        YES, FORCE OPTION TO NOT BILL                
         XIT1                                                                   
         DROP  R3,R5,R6                                                         
         EJECT                                                                  
***********************************************************************         
*              PRINT SPECIAL MESSAGE OR, OPTIONALLY, REGULAR MESSAGE  *         
*              FOR NO BILLING GENERATED                               *         
*              R0=L'SPECRSNS/REASONS                                  *         
*              R3=A(SPECRSNS/REASONS)                                 *         
*              R4=A(REASON EQUATES)                                   *         
***********************************************************************         
*                                                                               
         USING NOBD,RF                                                          
NOBILMSG NTR1                                                                   
         L     RF,ANOBWK                                                        
         LA    R1,NOBLNQ                                                        
         SLL   R1,16                                                            
         ST    R1,NOBLEN                                                        
         MVI   NOBTYP,NOBEQU           RECORD TYPE                              
         L     R2,ADACC                                                         
         MVC   NOBCLI(12),3(R2)    CLI/PRD/JOB                                  
*                                                                               
NOBIL02  CLI   0(R3),0             IS REASON BIT SET                            
         BNE   NOBIL06             IF IT IS - MUST FIND REASON                  
*                                                                               
NOBIL04  LA    R3,1(R3)            BUMP TO NEXT REASON BYTE                     
         BCT   R0,NOBIL02                                                       
         B     NOBILX              ALL REASONS PRINTED                          
*                                                                               
NOBIL06  LR    R1,R4               GET REASON FROM TABLE                        
*                                                                               
NOBIL08  CLC   0(1,R1),0(R3)       REASON TABLE VS REASON VALUE                 
         BE    NOBIL10                                                          
         CLI   0(R1),X'FF'                                                      
         BE    NOBIL04             UNDEFINED REASON                             
         ZIC   R2,1(R1)                                                         
         LA    R1,2(R2,R1)         BUMP TO NEXT REASON                          
         B     NOBIL08                                                          
*                                                                               
NOBIL10  L     RF,ANOBWK                                                        
         MVC   NOBDATA,SPACES                                                   
         MVC   NOBRSN,0(R1)        REASON CODE                                  
         ZIC   R2,1(R1)                                                         
         BCTR  R2,0                GET LENGTH OF REASON                         
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   NOBDATA(0),2(R1)                                                 
         GOTO1 SORTER,DMCB,=C'PUT',ANOBWK                                       
         MVI   ALSORT,1            SO ADDRESS IS NOT ZERO                       
         B     NOBIL04                                                          
*                                                                               
NOBILX   B     FILTX                                                            
         DROP  RF                                                               
         EJECT                                                                  
*              BUILD SOFT HEADLINES                                             
*                                                                               
BLDSOFT  NTR1                                                                   
         XC    USERMC,USERMC       SPECIAL USER MEDIA CODE                      
         XC    SOFTRSN(10*12),SOFTRSN                                           
         LA    RE,SOFTRSN                                                       
         LA    R0,10                                                            
         LA    R1,SOFTH1                                                        
         MVC   0(L'SOFTH1,R1),SPACES   CLEAR SOFT HEADS                         
         LA    R1,L'SOFTH1(R1)                                                  
         BCT   R0,*-10                                                          
*                                                                               
         LA    R1,SOFTH1                                                        
         LA    R0,10                                                            
         L     R3,ADACC                                                         
         USING TRNRECD,R3                                                       
         LA    R4,TRNRECD+ACCORFST                                              
         L     R5,AUSRPOOL         GET USER FIELD TABLE                         
         LA    R9,USRNUM           GET MAXIMUM NUMBER OF ENTRIES                
*                                                                               
         USING UFSELD,R4                                                        
BLDS02   CLI   0(R4),0                                                          
         BE    FILTX               END OF RECORD                                
         CLI   0(R4),X'A2'                                                      
         BE    BLDS06                                                           
*                                                                               
BLDS04   ZIC   RF,1(R4)                                                         
         AR    R4,RF                                                            
         B     BLDS02                                                           
*                                                                               
BLDS06   LA    R2,UFSDATA-UFSELD    LENGTH UP TO DATA                           
         ZIC   R3,UFSLN           ELEMENT LENGTH                                
         SR    R3,R2                R3=LENGTH OF UFSDATA                        
         BZ    BLDS08               NO DATA                                     
         BCTR  R3,0                                                             
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   13(0,R1),UFSDATA    DATA TO SOFT FIELD                           
         MVC   0(12,R1),UFSDESC    FIELD DESCRIPTION                            
         CLC   UFSCODE,=C'MC'                                                   
         BNE   *+10                                                             
         MVC   USERMC,UFSDATA     SAVE FOR BILL NUMBER                          
*                                                                               
BLDS08   TM    UFSSTAT,X'40'      NEEDED FOR BILLING                            
         BZ    BLDS10                                                           
         CLC   13(10,R1),SPACES                                                 
         BNE   BLDS10              DATA IS PRESENT                              
         MVC   0(12,RE),UFSDESC   DESCRIPTION TO SOFTRSN FIELD                  
         LA    RE,12(RE)                                                        
*                                                                               
BLDS10   TM    UFSSTAT,X'10'      SHOW ON BILLS                                 
         BO    *+10                                                             
         MVC   0(L'SOFTH1,R1),SPACES  NOT NEEDED FOR PRINTING                   
*                                                                               
         TM    UFSSTAT,X'08'      NEED FOR RECEIVABLES?                         
         BZ    BLDS12              NO                                           
*                                                                               
         LTR   R9,R9               ANY ROOM LEFT?                               
         BZ    BLDS12              NO                                           
*                                                                               
         SR    R6,R6                                                            
         IC    R6,UFSLN                                                         
         BCTR  R6,0                                                             
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R5),UFSEL      SAVE IN USRPOOL                               
         LA    R5,1(R5,R6)                                                      
         MVI   0(R5),X'00'                                                      
         BCTR  R9,0                                                             
*                                                                               
BLDS12   CLC   0(L'SOFTH1,R1),SPACES                                            
         BE    BLDS04                GET NEXT                                   
         LA    R1,L'SOFTH1(R1)      IF NEEDED BUMP TO NEXT AREA                 
         BCT   R0,BLDS04                                                        
         B     FILTX                                                            
         DROP  R3,R4                                                            
         EJECT ,                                                                
*              ROUTINE TO LOOK FORWARD THROUGH JOB POSTINGS                     
*                                                                               
         USING TRNRECD,R3                                                       
         USING TRNELD,R2                                                        
LOOKAHD  NTR1                                                                   
         L     R3,ADACC                                                         
         MVC   SAVEKEY,0(R3)                                                    
         L     R3,ACOMBUF                                                       
         MVC   0(42,R3),SAVEKEY                                                 
         ZAP   DEBITS,=P'0'                                                     
         ZAP   ALLDRS,=P'0'                                                     
         ZAP   DUB,=P'0'                                                        
         ZAP   DOUBLE,=P'0'                                                     
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R3),(R3)                             
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
LOOK02   GOTO1 DATAMGR,DMCB,DMRSEQ,FILNME,(R3),(R3)                             
         CLC   0(15,R3),SAVEKEY                                                 
         BNE   LOOKXIT                                                          
         LA    R2,TRNRECD+ACCORFST                                              
         CLI   0(R2),TRNELQ        X'44'                                        
         BNE   LOOK02                                                           
         CLC   TRNKWORK,=C'99'     SKIP BILLING                                 
         BE    LOOK02                                                           
         CLC   TRNKWORK,=C'**'     SKIP ORDERS                                  
         BE    LOOK02                                                           
         TM    TRNSTAT,TRNSDR      IS IT A DEBIT (X'80') ?                      
         BZ    LOOK02              NO                                           
         TM    TRNRSTAT,TRNSDRFT   IS IT A DRAFT TRANSACTION?                   
         BO    LOOK02              YES, SKIP IT                                 
         LR    R4,R2                                                            
         TM    BILLMODE,RERUN      IS IT A RERUN?                               
         BZ    LOOK06              NO                                           
*                                                                               
         USING ACMD,R4                                                          
         L     R4,AMONACC                                                       
         GOTO1 ACMAPRAT,DMCB,(X'C0',(R3)),ADGOBLOC,ADCOMFAC,0,         X        
               ACMAPROB,ACMAPRO2                                                
*                                                                               
         L     R4,ACMAPRO2                                                      
         CLI   0(R4),PTAELQ                                                     
         B     LOOK04+8                                                         
*                                                                               
         USING PTAELD,R4                                                        
LOOK04   MVI   ELCODE,PTAELQ       READ X'77' ELEMENTS                          
         BAS   RE,NEXTEL2                                                       
         BNE   LOOK02              GET NEXT TRANSACTION                         
*                                                                               
         CLI   PTATYPE,PTATRAL     IS THIS ALLOCATED?                           
         BNE   LOOK04              NO                                           
         TM    PTASTAT1,PTASPEND   YES, IS IT PENDING?                          
         BO    LOOK04              YES, NOT BILLED YET                          
         CLC   PTARDATE,TODAY2     NO, WAS IT BILLED TODAY?                     
         BNE   LOOK04              NO                                           
         ZAP   DUB,PTANET          YES, GET AMOUNT                              
*                                                                               
         CP    REBILLNO,=P'0'      DO WE ALREADY HAVE A BILL#?                  
         BNE   LOOK16              YES                                          
         PACK  REBILLNO,PTARBLNO   NO, USE BILL NUMBER FROM 77                  
         B     LOOK16                                                           
*                                                                               
LOOK06   CLC   TRNDATE,ENDATE     YES, IS IT WITHIN DATE RANGE?                 
         BH    LOOK02              NO                                           
*                                                                               
LOOK08   TM    REQOPT,REQPRDO      REQUEST FOR PRODUCTION ONLY?                 
         BZ    LOOK10              NO                                           
         TM    WKCOPT,WKCMT        YES, IS THIS A MEDIA CHARGE?                 
         BO    LOOK02              YES, SKIP IT                                 
         B     LOOK12                                                           
*                                                                               
LOOK10   TM    REQOPT,REQMEDO      REQUEST FOR MEDIA ONLY?                      
         BZ    LOOK12              NO                                           
         TM    WKCOPT,WKCMT        YES, IS THIS MEDIA CHARGE?                   
         BZ    LOOK02              NO, SKIP IT                                  
*                                                                               
         USING ACMD,R4                                                          
LOOK12   L     R4,AMONACC                                                       
         GOTO1 ACMAPRAT,DMCB,(X'C0',(R3)),ADGOBLOC,ADCOMFAC,0,         X        
               ACMAPROB,ACMAPRO2                                                
*                                                                               
         L     R4,ACMAPRO2                                                      
         CLI   0(R4),PTAELQ                                                     
         B     LOOK14+8                                                         
*                                                                               
         USING PTAELD,R4                                                        
LOOK14   MVI   ELCODE,PTAELQ       READ X'77' ELEMENTS                          
         BAS   RE,NEXTEL2                                                       
         BNE   LOOK02              GET NEXT TRANSACTION                         
         CLI   PTATYPE,PTATRAL     ALLOCATED?                                   
         BNE   LOOK14              NO                                           
         ZAP   DOUBLE,PTANET       ADD BILLED AND/OR PENDING HERE               
         ZAP   DUB,=P'0'           CLEAR PENDING IN CASE NOT NEEDED             
         TM    PTASTAT1,PTASPEND   YES, PENDING?                                
         BZ    LOOK16              NO, ALREADY BILLED                           
         ZAP   DUB,PTANET          YES, GET AMOUNT                              
*                                                                               
LOOK16   AP    DEBITS,DUB          ADD AMOUNT TO BUCKET                         
         AP    ALLDRS,DOUBLE                                                    
         B     LOOK14              GET NEXT ELEMENT                             
*                                                                               
LOOKXIT  XIT1                                                                   
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
GETEL2   AH    R4,DATADISP                                                      
FRSTEL2  CLI   0(R4),0                                                          
         BNE   *+10                                                             
         CLI   0(R4),1                                                          
         BR    RE                                                               
         CLI   ELCODE,0                                                         
         BCR   8,RE                                                             
         CLC   ELCODE,0(R4)                                                     
         BCR   8,RE                                                             
*                                                                               
NEXTEL2  SR    RF,RF                                                            
         IC    RF,1(R4)                                                         
         LTR   RF,RF                                                            
         BNZ   *+10                                                             
         CLI   1(R4),1                                                          
         BR    RE                                                               
         AR    R4,RF                                                            
         B     FRSTEL2                                                          
*                                                                               
BILLTAB  DS    0CL20                                                            
         DC    C'ALLOCATED BILL ',C'CY',AL1(TRNBTALL),X'00',AL1(CLIENT)         
         DC    X'FF'                                                            
         EJECT                                                                  
DEBITS   DS    PL6                 TOTAL OF ALL WORKCODES                       
ALLDRS   DS    PL6                 BILLED AND ALLOCATED TOTAL                   
OVEREST  DS    F                   OVEREST PERCENT                              
OVERAMT  DS    PL4                 OVEREST AMOUNT                               
*                                                                               
BILFLTSW DS    CL1                 SPECIAL BILLING FILTER SWITCH                
SVAGYCOM DS    PL4                                                              
*                                                                               
REASON   DS    CL1                 CURRENT REASON FOR NO BILLING                
REASONS  DS    CL(ERSN10-ERSN01+1) LIST OF REASONS FOR NO BILLING               
*                                                                               
SPECRSN  DS    CL1                 CURRENT SPECIAL REASON                       
SPECRSNS DS    CL(ESSN01-ESSN01+1) LIST OF CURRECT REASONS                      
*                                                                               
SOFTRSN  DS    10CL12              SOFT REASONS                                 
*                                                                               
ERSN01   EQU   1                                                                
ERSN02   EQU   2                                                                
ERSN03   EQU   3                                                                
ERSN04   EQU   4                                                                
ERSN05   EQU   5                                                                
ERSN06   EQU   6                                                                
ERSN07   EQU   7                                                                
ERSN08   EQU   8                                                                
ERSN09   EQU   9                                                                
ERSN10   EQU   10                                                               
*                                                                               
*              TABLE OF REASONS FOR NO BILLING                                  
*                                                                               
RSN01    DC    AL1(ERSN01),AL1(L'RSN01M)                                        
RSN01M   DC    C'CAN''T BILL - ESTIMATE PERCENT OVERSPENT.'                     
RSN02    DC    AL1(ERSN02),AL1(L'RSN02M)                                        
RSN02M   DC    C'CAN''T BILL - ESTIMATE AMOUNT OVERSPENT.'                      
RSN03    DC    AL1(ERSN03),AL1(L'RSN03M)                                        
RSN03M   DC    C'CAN''T BILL - JOB DOES NOT HAVE AN ESTIMATE.'                  
RSN04    DC    AL1(ERSN04),AL1(L'RSN04M)                                        
RSN04M   DC    C'CAN''T BILL - JOB HAS UNAPPROVED ESTIMATE.'                    
RSN05    DC    AL1(ERSN05),AL1(L'RSN05M)                                        
RSN05M   DC    C'CAN''T BILL - BILLTYPE NOT CLIENT'                             
RSN06    DC    AL1(ERSN06),AL1(L'RSN06M)                                        
RSN06M   DC    C'CAN''T BILL - JOB IS CLOSED.'                                  
RSN07    DC    AL1(ERSN07),AL1(L'RSN07M)                                        
RSN07M   DC    C'CAN''T BILL - BILLING FILTERS USED TO EXCLUDE.'                
RSN08    DC    AL1(ERSN08),AL1(L'RSN08M)                                        
RSN08M   DC    C'CAN''T BILL - JOB IS DEFINED AS AN ''X-JOB''.'                 
RSN09    DC    AL1(ERSN09),AL1(L'RSN09M)                                        
RSN09M   DC    C'CAN''T BILL - MISSING ACCOUNT(S) FOR ADMINISTRATIVE SUX        
               RCHARGE'                                                         
RSN10    DC    AL1(ERSN10),AL1(L'RSN10M)                                        
RSN10M   DC    C'CAN''T BILL - MISSING WORKCODE FOR ADMINISTRATIVE SURCX        
               HARGE'                                                           
         DC    X'FF'                                                            
         EJECT                                                                  
ESSN01   EQU   1                                                                
*                                                                               
*              TABLE OF SPECIAL REASONS FOR NO BILLING                          
*                                                                               
SSN01    DC    AL1(ESSN01),AL1(L'SSN01M)                                        
SSN01M   DC    C'CAN''T BILL - STUDIO JOB IS MISSING LINK'                      
         DROP  RA,RB                                                            
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'AC27 - PROFESSIONAL BILLING - FORMATTING ROUTINES'              
FORMR    DS    0D                                                               
         NMOD1 0,**FORMR*,RA,R9,R6                                              
         L     RC,0(R1)                                                         
         USING FRMD,R5                                                          
         CLI   BILDATA,C'Y'        ANY DATA TO BILL?                            
         BNE   FORMXIT             NO                                           
         ZAP   TOTTYPO,=P'0'       CLEAR OOP                                    
         ZAP   SUBTOT1,=P'0'             AND SUBTOTAL                           
*                                                                               
         PACK  DUB,FORMTYP         GET INDEX INTO PRINT ROUTINE TABLE           
         CVB   RF,DUB                                                           
         SLL   RF,2                                                             
         B     PRNTRTE(RF)                                                      
*                                                                               
         DS    0D                                                               
PRNTRTE  EQU   *                                                                
         B     FORM0                                                            
         B     FORM1                                                            
         B     FORM2                                                            
         B     FORM3                                                            
         B     FORM4                                                            
         B     FORM5                                                            
         B     FORM6                                                            
         B     FORM7                                                            
         B     FORM8                                                            
         B     FORMXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              FORMAT 0 REGULAR BILLING                               *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
FORM0    MVI   FORCEHED,C'Y'       FORCE NEW PAGE                               
         MVI   RCSUBPRG,19                                                      
         CLI   PROF2,C'D'          PRINTING VENDOR DESCRIPTION?                 
         BE    FORM000             YES                                          
         CLI   PROF2,C'B'                                                       
         BE    *+8                                                              
         MVI   RCSUBPRG,20                                                      
*                                                                               
FORM000  LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPEA                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM032             YES, RETURN                                  
         CLI   FRMTYPE,FRMTYPEA    ANY DETAILS?                                 
         BNE   FORM032             NO, DONE                                     
*                                                                               
         MVI   OUTMODE,OUTNONE                                                  
         CLI   FRMWKC0,X'FF'       IF NO DETAIL, PRINT ON SAME LINE             
         BNE   FORM002                                                          
         CLI   FRMVND0,X'FF'                                                    
         BE    FORM022                                                          
*                                                                               
FORM002  CLI   FRMWKC0,X'FF'       ANY WORKCODE DATA?                           
         BE    FORM006             NO                                           
         MVI   OUTMODE,OUTWKC      YES, SET MODE                                
*                                                                               
FORM004  LA    R3,P+1                                                           
         MVC   0(L'FRMWKC0,R3),FRMWKC0                                          
         LA    R3,1+L'FRMWKC0(R3)                                               
         MVC   0(L'FRMWNME,R3),FRMWNME                                          
*                                                                               
         CLI   FRMVND0,X'FF'       VENDOR DATA ALSO?                            
         BE    FORM010             NO                                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   OUTMODE,OUTVNW                                                   
         B     FORM008                                                          
*                                                                               
FORM006  CLI   FRMVND0,X'FF'       ANY VENDOR DATA?                             
         BE    FORM026             NO, JUST TOTAL                               
         MVI   OUTMODE,OUTVND                                                   
*                                                                               
FORM008  LA    R3,P+22                                                          
         CLI   PROF2,C'D'          PRINT VENDOR DESCRIPTION?                    
         BE    FORM007             YES                                          
         CLI   PROF2,C'B'                                                       
         BNE   FORM010                                                          
*                                                                               
FORM007  MVC   0(15,R3),FRMVNME  GET VENDOR NAME                                
*                                                                               
FORM010  LA    R3,P+1                                                           
         BAS   RE,GETAMT                                                        
*                                                                               
         CLI   PROF2,C'N'          PRINTING VENDOR DETAIL?                      
         BE    FORM014             NO                                           
         TM    WKCOPT,WKCDTL+WKCDTLC                                            
         BNO   FORM014                                                          
         CP    THOURS,=P'0'        ANY HOURS?                                   
         BE    FORM012             NO                                           
*                                                                               
         XC    FORMWRK,FORMWRK                                                  
         CURED THOURS,(8,FORMWRK),2,MINUS=YES                                   
         MVC   FORMWRK+8(3),=C'HRS'                                             
         GOTO1 SQUASHER,DMCB,FORMWRK,L'FORMWRK                                  
         MVC   0(L'FORMWRK,R3),FORMWRK                                          
         LA    R3,L'FORMWRK+1(R3)                                               
*                                                                               
         XC    FORMWRK,FORMWRK                                                  
         CURED FRMRTE0,(7,FORMWRK+10),2                                         
         MVC   FORMWRK+17(3),=C'/HR'                                            
         GOTO1 SQUASHER,DMCB,FORMWRK,L'FORMWRK                                  
         MVC   0(L'FORMWRK,R3),FORMWRK                                          
         B     FORM014                                                          
*                                                                               
FORM012  CLI   PROF1,C'Y'          PRINT VENDOR REFERENCE?                      
         BE    FORM013                                                          
         CLI   PROF1,C'L'                                                       
         BNE   FORM014             NO                                           
*                                                                               
FORM013  MVC   0(L'FRMREFL,R3),FRMREF0                                          
*                                                                               
FORM014  LA    R3,P+41                                                          
         LA    R4,NETAMT                                                        
         BAS   RE,FORMAMT                                                       
         LA    R3,P+57                                                          
         LA    R4,COMAMT                                                        
         BAS   RE,FORMAMT                                                       
         LA    R3,P+72                                                          
         LA    R4,GRSAMT                                                        
         BAS   RE,FORMAMT                                                       
*                                                                               
         CP    CDAMT,=P'0'         ANY DISCOUNT?                                
         BE    FORM016             NO                                           
         CLI   PROF8,C'G'                                                       
         BE    FORM016                                                          
         MVC   P+38(4),=C'*CD*'                                                 
*                                                                               
FORM016  CLC   FRMNARR,SPACES      ANY NARRATIVE?                               
         BE    FORM020             NO                                           
*                                                                               
         LA    R0,5                MAXIMUM LINES OF NARRATIVE                   
         LA    R4,FRMNARR                                                       
*                                                                               
FORM018  GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVC   P+1(20),0(R4)                                                    
         LA    R4,20(R4)                                                        
         CLC   0(20,R4),SPACES                                                  
         BNH   FORM020                                                          
         BCT   R0,FORM018                                                       
*                                                                               
FORM020  MVI   BYTE,FRMTYPEA                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM028             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEA    ANY MORE?                                    
         BNE   FORM028             NO, PRINT LAST LINE                          
*                                                                               
         CLI   OUTMODE,OUTWKC      ONLY PRINTING WORKCODE?                      
         BNE   FORM024             NO                                           
         CLI   FRMWKC0,X'FF'       YES, FINAL TOTAL?                            
         BE    FORM022             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM004                                                          
*                                                                               
         USING JOBD,R4                                                          
FORM022  BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTNET,NETAMT                                                    
         AP    TOTGRS,GRSAMT                                                    
         B     FORM028                                                          
*                                                                               
FORM024  CLI   FRMVND0,X'FF'       VENDOR TOTAL?                                
         BE    FORM026             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM008                                                          
*                                                                               
FORM026  CLI   OUTMODE,OUTVNW                                                   
         BNE   FORM022                                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         BAS   RE,GETAMT                                                        
         LA    R3,P+41                                                          
         LA    R4,NETAMT                                                        
         BAS   RE,FORMAMT                                                       
         LA    R3,P+57                                                          
         LA    R4,COMAMT                                                        
         BAS   RE,FORMAMT                                                       
         LA    R3,P+72                                                          
         LA    R4,GRSAMT                                                        
         BAS   RE,FORMAMT                                                       
*                                                                               
         MVC   P+2(L'AC@TWC),AC@TWC                                             
         MVC   P+2+L'AC@TWC+1(L'FRMWKC0),FRMWKC0                                
*                                                                               
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM028             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEA    ANY MORE?                                    
         BNE   FORM028             NO                                           
         CLI   FRMWKC0,X'FF'       YES, IS IT FINAL TOTAL?                      
         BNE   FORM002             NO                                           
*                                                                               
         BAS   RE,GETAMT           YES                                          
         AP    TOTGST,GSTAMT       ADD GST                                      
         AP    TOTPST,PSTAMT       ADD PST                                      
         AP    TOTCD,CDAMT         ADD CD                                       
         AP    TOTGRS,GRSAMT                                                    
         AP    TOTNET,NETAMT                                                    
         AP    TOTCOM,COMAMT                                                    
*                                                                               
FORM028  GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         ZAP   TOTCD,TOTCD                                                      
         BZ    FORM030                                                          
         LA    R3,P+41                                                          
         BAS   RE,FORMCD                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM030  ZAP   TOTGRS,TOTGRS                                                    
         BZ    FORM032                                                          
         ZAP   SUBTOT1,TOTGRS                                                   
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         LA    R3,P+41                                                          
         LA    R4,TOTNET                                                        
         BAS   RE,FORMAMT                                                       
         LA    R3,P+57                                                          
         LA    R4,TOTCOM                                                        
         BAS   RE,FORMAMT                                                       
         LA    R3,P+72                                                          
         LA    R4,TOTGRS                                                        
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2           DOUBLE SPACE TOTAL                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   SPACING,1                                                        
*                                                                               
FORM032  ZAP   GRANDTOT,SUBTOT1                                                 
         BAS   RE,FORMLST                                                       
         BAS   RE,FORMTAX                                                       
         BAS   RE,FORMEND                                                       
*                                                                               
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   BYTE,FRMTYPEB                                                    
         GOTO1 BUFFALO,DMCB,=C'HIGH',(BYTE,ABUFF),(R5),1                        
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM0XIT            YES, EXIT                                    
         CLI   FRMTYPE,FRMTYPEB    ANY BILLING?                                 
         BNE   FORM0XIT            NO, EXIT                                     
*                                                                               
         MVI   FORCEHED,C'Y'       START A NEW PAGE                             
         MVC   P+1(L'AC@PRVBL),AC@PRVBL                                         
         MVC   PSECOND+1(L'AC$PRVBL),AC$PRVBL                                   
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM034  CLI   FRMDAT0,X'FF'       TOTAL?                                       
         BE    FORM036             YES                                          
*                                                                               
         BAS   RE,GETAMT                                                        
         LA    R3,P+41                                                          
         LA    R4,NETAMT                                                        
         BAS   RE,FORMAMT                                                       
         LA    R3,P+57                                                          
         LA    R4,COMAMT                                                        
         BAS   RE,FORMAMT                                                       
         LA    R3,P+72                                                          
         LA    R4,GRSAMT                                                        
         BAS   RE,FORMAMT                                                       
*                                                                               
         MVC   P+1(15),FRMNARR                                                  
         MVC   PSECOND+12(L'FRMREFL),FRMREF0                                    
         GOTO1 DATCON,DMCB,(1,FRMDAT0),(8,PSECOND+1)                            
*                                                                               
         MVI   SPACING,1                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM0XIT            YES, WE SHOULD HAVE A TOTAL                  
         CLI   FRMTYPE,FRMTYPEB    ANY MORE?                                    
         BE    FORM034             YES, CHECK IF TOTAL                          
*                                                                               
FORM036  MVC   P+1(L'AC@TPRVB),AC@TPRVB                                         
         BAS   RE,GETAMT                                                        
         LA    R3,P+41                                                          
         LA    R4,NETAMT                                                        
         BAS   RE,FORMAMT                                                       
         LA    R3,P+57                                                          
         LA    R4,COMAMT                                                        
         BAS   RE,FORMAMT                                                       
         LA    R3,P+72                                                          
         LA    R4,GRSAMT                                                        
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2           DOUBLE SPACE TOTAL                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM0XIT BAS   RE,FORMCLR          CLEAR THE TOTALS                             
         B     FORMXIT                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT 1 PREBILLING  (TYPE P)                          *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
FORM1    MVI   FORCEHED,C'Y'       FORCE NEW PAGE                               
         MVI   RCSUBPRG,8                                                       
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPEP                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM1XIT            YES, RETURN                                  
         CLI   FRMTYPE,FRMTYPEP    ANY PRE-BILLING?                             
         BNE   FORM1XIT            NO, RETURN                                   
*                                                                               
         LA    R3,P+1                                                           
         CLI   PROF33,C'Y'         USING W/C DESCRIPTION?                       
         BNE   FORM104             NO, USE STANDARD                             
*                                                                               
         CLC   PRENAME,SPACES                                                   
         BE    FORM104             NO NAME, USE STANDARD                        
         MVC   0(L'PRENAME,R3),PRENAME                                          
         LA    R3,L'PRENAME(0,R3)  GET TO END                                   
         CLI   0(R3),C' '                                                       
         BH    FORM102                                                          
         BCT   R3,*-8                                                           
         B     FORM104                                                          
*                                                                               
FORM102  LA    R3,2(0,R3)                                                       
         B     FORM106                                                          
*                                                                               
FORM104  MVC   0(L'AC@MMPS,R3),AC@MMPS                                          
         LA    R3,1+L'AC@MMPS(R3)                                               
*                                                                               
FORM106  BAS   RE,FORMTIT          FORMAT THE TITLE                             
*                                                                               
         BAS   RE,GETAMT            GET AMOUNTS                                 
         AP    TOTCOM,COMAMT        ADD COMMISSION                              
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         ZAP   SUBTOT1,EDITAMT      ADD TO TOTAL                                
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         ZAP   GRANDTOT,SUBTOT1                                                 
         BAS   RE,FORMCD                                                        
         BAS   RE,FORMCOM                                                       
         BAS   RE,FORMTAX                                                       
         BAS   RE,FORMEND                                                       
         ZAP   TOTCOM,=P'0'        CLEAR FOR PREVIOUS BILLING USE               
         ZAP   TOTCD,=P'0'         CLEAR FOR NEXT USE                           
         B     FORMXIT                                                          
*                                                                               
FORM1XIT EQU   *                                                                
         BAS   RE,FORMEND                                                       
         B     FORMXIT                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT 2 TIME AND OOP  (TYPE T AND TYPE O)             *         
*              WORKCODE WITHIN VENDOR                                 *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
FORM2    MVI   FORCEHED,C'Y'       FORCE NEW PAGE                               
         MVI   RCSUBPRG,8                                                       
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPET                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM202             YES, GET OOP                                 
*                                                                               
         CLI   FRMTYPE,FRMTYPET    ANY TIME CHARGES?                            
         BNE   FORM202             NO, GET OOP                                  
*                                                                               
         LA    R3,P+1                                                           
         MVC   0(L'AC@PROFS,R3),AC@PROFS                                        
         LA    R3,1+L'AC@PROFS(R3)                                              
         CLI   PROF29,C'Y'         SUPPRESS 'STAFF'?                            
         BE    FORM200             YES                                          
         MVC   0(L'AC@STAFF,R3),AC@STAFF                                        
         LA    R3,1+L'AC@STAFF(R3)                                              
*                                                                               
FORM200  MVC   0(L'AC@SERVE,R3),AC@SERVE                                        
         LA    R3,1+L'AC@SERVE(R3)                                              
         BAS   RE,FORMTIT          FORMAT TITLE                                 
*                                                                               
         BAS   RE,GETAMT           GET AMOUNTS                                  
         AP    TOTCOM,COMAMT        ADD COMMISSION                              
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         ZAP   SUBTOT1,EDITAMT      ADD TOT TOTAL                               
         AP    TOTTIME,EDITAMT                                                  
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM202  LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPEO                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM226             YES, DO TOTAL                                
*                                                                               
         CLI   FRMTYPE,FRMTYPEO    ANY OUT-OF=POCKET?                           
         BNE   FORM226             NO, DO TOTAL                                 
         MVC   P+1(L'AC@OOP),AC@OOP                                             
         MVI   OUTMODE,OUTNONE                                                  
         CLI   FRMVND2,X'FF'       IF NO DETAIL, PRINT ON SAME LINE             
         BNE   FORM204                                                          
         CLI   FRMWKC2,X'FF'                                                    
         BE    FORM218                                                          
*                                                                               
FORM204  MVC   PSECOND+1(L'AC$OOP),AC$OOP                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM206  CLI   FRMVND2,X'FF'       ANY VENDOR DATA?                             
         BE    FORM212             NO                                           
         MVI   OUTMODE,OUTVND      YES,SET MODE                                 
*                                                                               
FORM208  LA    R3,P+1                                                           
         MVC   0(L'FRMVND2,R3),FRMVND2                                          
         CLI   PROF2,C'C'          PRINT VENDOR ONLY?                           
         BE    FORM210             YES                                          
         CLI   PROF2,C'B'          PRINT BOTH?                                  
         BNE   *+8                 NO                                           
         LA    R3,1+L'FRMVND2(R3)  YES, MAKE ROOM                               
         MVC   0(L'FRMVNME,R3),FRMVNME  GET VENDOR NAME                         
*                                                                               
FORM210  CLI   FRMWKC2,X'FF'       WORKCODE DATA ALSO?                          
         BE    FORM216             NO                                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   OUTMODE,OUTVNW                                                   
         B     FORM214                                                          
*                                                                               
FORM212  CLI   FRMWKC2,X'FF'       ANY WORKCODE DATA?                           
         BE    FORM222             NO, JUST TOTAL                               
         MVI   OUTMODE,OUTWKC                                                   
*                                                                               
FORM214  LA    R3,P+8                                                           
         MVC   0(L'FRMWKC2,R3),FRMWKC2                                          
         CLI   PROF3,C'C'          PRINT WORKCODE ONLY?                         
         BE    FORM216             YES                                          
         CLI   PROF3,C'B'          PRINT BOTH?                                  
         BNE   *+8                 NO                                           
         LA    R3,1+L'FRMWKC2(R3)  YES, MAKE ROOM                               
         MVC   0(L'FRMWNME,R3),FRMWNME  GET W/C NAME                            
*                                                                               
FORM216  BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
         MVI   BYTE,FRMTYPEO                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM224             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM224             NO, PRINT LAST LINE                          
*                                                                               
         CLI   OUTMODE,OUTVND      ONLY PRINTING VENDOR?                        
         BNE   FORM220             NO                                           
         CLI   FRMVND2,X'FF'       YES, FINAL TOTAL?                            
         BE    FORM218             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM208                                                          
*                                                                               
         USING JOBD,R4                                                          
FORM218  BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         B     FORM224                                                          
*                                                                               
FORM220  CLI   FRMWKC2,X'FF'       WORKCODE TOTAL?                              
         BE    FORM222             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM214                                                          
*                                                                               
FORM222  CLI   OUTMODE,OUTVNW                                                   
         BNE   FORM218                                                          
         GOTO1 UNDERLIN,DMCB,(12,P+52),PSECOND+52                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM224             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM224             NO                                           
         CLI   FRMVND2,X'FF'       YES, IS IT FINAL TOTAL?                      
         BNE   FORM206             NO                                           
         BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
FORM224  GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM226  ZAP   TOTTYPO,TOTTYPO                                                  
         BZ    FORM2XIT                                                         
         AP    SUBTOT1,TOTTYPO                                                  
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         LA    R3,P+72                                                          
         LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2           DOUBLE SPACE TOTAL                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   SPACING,1                                                        
*                                                                               
FORM2XIT ZAP   GRANDTOT,SUBTOT1                                                 
         B     FORMALL                                                          
         DROP  R5,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              FORMAT 3 TIME AND OOP  (TYPE T AND TYPE O)             *         
*              VENDOR WITHIN WORKCODE                                 *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
FORM3    MVI   FORCEHED,C'Y'       FORCE NEW PAGE                               
         MVI   RCSUBPRG,8                                                       
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPET                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM302             YES, GET OOP                                 
*                                                                               
         CLI   FRMTYPE,FRMTYPET    ANY TIME CHARGES?                            
         BNE   FORM302             NO, GET OOP                                  
*                                                                               
         LA    R3,P+1                                                           
         MVC   0(L'AC@PROFS,R3),AC@PROFS                                        
         LA    R3,1+L'AC@PROFS(R3)                                              
         CLI   PROF29,C'Y'         SUPPRESS 'STAFF'?                            
         BE    FORM300             YES                                          
         MVC   0(L'AC@STAFF,R3),AC@STAFF                                        
         LA    R3,1+L'AC@STAFF(R3)                                              
*                                                                               
FORM300  MVC   0(L'AC@SERVE,R3),AC@SERVE                                        
         LA    R3,1+L'AC@SERVE(R3)                                              
         BAS   RE,FORMTIT                                                       
*                                                                               
         BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         ZAP   SUBTOT1,EDITAMT     KEEP A TOTAL                                 
         AP    TOTTIME,EDITAMT                                                  
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM302  LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPEO                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM326             YES, DO TOTAL                                
*                                                                               
         CLI   FRMTYPE,FRMTYPEO    ANY OUT-OF=POCKET?                           
         BNE   FORM326             NO, DO TOTAL                                 
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVC   P+1(L'AC@OOP),AC@OOP                                             
         MVI   OUTMODE,OUTNONE                                                  
         CLI   FRMWKC3,X'FF'       IF NO DETAIL, PRINT ON SAME LINE             
         BNE   FORM304                                                          
         CLI   FRMVND3,X'FF'                                                    
         BE    FORM318                                                          
*                                                                               
FORM304  MVC   PSECOND+1(L'AC$OOP),AC$OOP                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM306  CLI   FRMWKC3,X'FF'       ANY WORKCODE DATA?                           
         BE    FORM312             NO                                           
         MVI   OUTMODE,OUTWKC      YES,SET MODE                                 
*                                                                               
FORM308  LA    R3,P+1                                                           
         MVC   0(L'FRMWKC3,R3),FRMWKC3                                          
         CLI   PROF3,C'C'          PRINT WORKCODE ONLY?                         
         BE    FORM310             YES                                          
         CLI   PROF3,C'B'          PRINT BOTH?                                  
         BNE   *+8                 NO                                           
         LA    R3,1+L'FRMWKC3(R3)  YES, MAKE ROOM                               
         MVC   0(L'FRMWNME,R3),FRMWNME  GET DESCRIPTION                         
*                                                                               
FORM310  CLI   FRMVND3,X'FF'       VENDOR DATA ALSO?                            
         BE    FORM316             NO                                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   OUTMODE,OUTVNW                                                   
         B     FORM314                                                          
*                                                                               
FORM312  CLI   FRMVND3,X'FF'       ANY VENDOR DATA?                             
         BE    FORM322             NO, JUST TOTAL                               
         MVI   OUTMODE,OUTVND                                                   
*                                                                               
FORM314  LA    R3,P+8                                                           
         MVC   0(L'FRMVND3,R3),FRMVND3                                          
         CLI   PROF2,C'C'          PRINT VENDOR ONLY?                           
         BE    FORM316             YES                                          
         CLI   PROF2,C'B'          PRINT BOTH?                                  
         BNE   *+8                 NO                                           
         LA    R3,1+L'FRMVND3(R3)  YES, MAKE ROOM                               
         MVC   0(L'FRMVNME,R3),FRMVNME  GET VENDOR NAME                         
*                                                                               
FORM316  BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
         MVI   BYTE,FRMTYPEO                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM324             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM324             NO, PRINT LAST LINE                          
*                                                                               
         CLI   OUTMODE,OUTWKC      ONLY PRINTING WORKCODE?                      
         BNE   FORM320             NO                                           
         CLI   FRMWKC3,X'FF'       YES, FINAL TOTAL?                            
         BE    FORM318             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM308                                                          
*                                                                               
         USING JOBD,R4                                                          
FORM318  BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         B     FORM324                                                          
*                                                                               
FORM320  CLI   FRMVND3,X'FF'       VENDOR TOTAL?                                
         BE    FORM322             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM314                                                          
*                                                                               
FORM322  CLI   OUTMODE,OUTVNW                                                   
         BNE   FORM318                                                          
         GOTO1 UNDERLIN,DMCB,(12,P+52),PSECOND+52                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM324             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM324             NO                                           
         CLI   FRMWKC3,X'FF'       YES, IS IT FINAL TOTAL?                      
         BNE   FORM306             NO                                           
         BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
FORM324  GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM326  ZAP   TOTTYPO,TOTTYPO                                                  
         BZ    FORM3XIT                                                         
         AP    SUBTOT1,TOTTYPO                                                  
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         LA    R3,P+72                                                          
         LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2           DOUBLE SPACE TOTAL                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   SPACING,1                                                        
*                                                                               
FORM3XIT ZAP   GRANDTOT,SUBTOT1                                                 
         B     FORMALL                                                          
         DROP  R5,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              FORMAT 4 TIME AND OOP  (TYPE T AND TYPE O)             *         
*              WORKCODE WITHIN VENDOR WITHIN JOB/PRODUCT              *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
FORM4    MVI   RCSUBPRG,8                                                       
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
*                                                                               
         CLI   MODE,LEVALAST       END OF CLIENT?                               
         BE    FORM460             YES                                          
         CLI   MODE,LEVBLAST       NO, END OF PRODUCT?                          
         BE    FORM440             YES                                          
*                                                                               
         CLI   LEVEL,0             NO, MUST BE ACCT- 1ST TIME?                  
         BNE   FORM402             NO                                           
         CLI   JOBDATA,C'Y'        YES, DO WE HAVE ANY DATA?                    
         BNE   FORMXIT             NO, DON'T BOTHER                             
         MVI   LEVEL,1             CHANGE FOR NEXT TIME                         
         CLI   GRPTYPE,C'C'        DO WE NEED PRODUCT CODE?                     
         BNE   FORM402             NO                                           
         MVC   P+1(3),PRDCODE+6                                                 
         MVC   P+6(36),PRDNAME                                                  
         GOTO1 UNDERLIN,DMCB,(41,P+1),PSECOND+1                                 
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM402  CLI   LEVEL,1             AT DETAIL STAGE?                             
         BNE   FORM440             NO, SEE IF A TOTAL LEVEL                     
         CLI   JOBDATA,C'Y'                                                     
         BNE   FORMXIT                                                          
         MVC   P+1(6),JOBCODE+9                                                 
         MVC   P+10(36),JOBNAME                                                 
         GOTO1 UNDERLIN,DMCB,(45,P+1),PSECOND+1                                 
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         MVI   FRMTYPE,FRMTYPET                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM404             YES, GET OOP                                 
*                                                                               
         CLI   FRMTYPE,FRMTYPET    ANY TIME CHARGES?                            
         BNE   FORM404             NO, GET OOP                                  
*                                                                               
         LA    R3,P+5                                                           
         MVC   0(L'AC@PROFS,R3),AC@PROFS                                        
         LA    R3,1+L'AC@PROFS(R3)                                              
         CLI   PROF29,C'Y'         SUPPRESS 'STAFF'?                            
         BE    FORM403             YES                                          
         MVC   0(L'AC@STAFF,R3),AC@STAFF                                        
         LA    R3,1+L'AC@STAFF(R3)                                              
*                                                                               
FORM403  MVC   0(L'AC@SERVE,R3),AC@SERVE                                        
         LA    R3,1+L'AC@SERVE(R3)                                              
         BAS   RE,FORMTIT          FORMAT TITLE                                 
*                                                                               
         BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         ZAP   SUBTOT1,EDITAMT     ADD TO TOTAL                                 
         AP    TOTTIME,EDITAMT                                                  
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))                                        
         MVI   FRMTYPE,FRMTYPEO                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM432             YES, DO TOTAL                                
*                                                                               
         CLI   FRMTYPE,FRMTYPEO    ANY OUT-OF=POCKET?                           
         BNE   FORM432             NO, DO TOTAL                                 
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM406                                                          
*                                                                               
FORM404  GOTO1 SHR,DMCB,('SUBRCLR',(RC))                                        
         MVI   FRMTYPE,FRMTYPEO                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM432             YES, DO TOTAL                                
         CLI   FRMTYPE,FRMTYPEO    ANY OUT-OF=POCKET?                           
         BNE   FORM432             NO, DO TOTAL                                 
*                                                                               
FORM406  MVC   P+5(L'AC@OOP),AC@OOP                                             
         MVI   OUTMODE,OUTNONE                                                  
         CLI   FRMVND2,X'FF'       IF NO DETAIL, PRINT ON SAME LINE             
         BNE   FORM408                                                          
         CLI   FRMWKC2,X'FF'                                                    
         BNE   FORM408                                                          
         BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         B     FORM424                                                          
*                                                                               
FORM408  MVC   PSECOND+1(L'AC$OOP),AC$OOP                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM410  CLI   FRMVND2,X'FF'       ANY VENDOR DATA?                             
         BE    FORM416             NO                                           
         MVI   OUTMODE,OUTVND      YES,SET MODE                                 
*                                                                               
FORM412  LA    R3,P+5                                                           
         MVC   0(L'FRMVND2,R3),FRMVND2                                          
         CLI   PROF2,C'C'          PRINT VENDOR ONLY?                           
         BE    FORM414             YES                                          
         CLI   PROF2,C'B'          PRINT BOTH?                                  
         BNE   *+8                 NO                                           
         LA    R3,1+L'FRMVND2(R3)  YES, MAKE ROOM                               
         MVC   0(L'FRMVNME,R3),FRMVNME  GET VENDOR NAME                         
*                                                                               
FORM414  CLI   FRMWKC2,X'FF'       WORKCODE DATA ALSO?                          
         BE    FORM420             NO                                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   OUTMODE,OUTVNW                                                   
         B     FORM418                                                          
*                                                                               
FORM416  CLI   FRMWKC2,X'FF'       ANY WORKCODE DATA?                           
         BE    FORM428             NO, JUST TOTAL                               
         MVI   OUTMODE,OUTWKC                                                   
*                                                                               
FORM418  LA    R3,P+8                                                           
         MVC   0(L'FRMWKC2,R3),FRMWKC2                                          
         CLI   PROF3,C'C'          PRINT WORKCODE ONLY?                         
         BE    FORM420             YES                                          
         CLI   PROF3,C'B'          PRINT BOTH?                                  
         BNE   *+8                 NO                                           
         LA    R3,1+L'FRMWKC2(R3)  YES, MAKE ROOM                               
         MVC   0(L'FRMWNME,R3),FRMWNME  GET W/C NAME                            
*                                                                               
FORM420  BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
         MVI   BYTE,FRMTYPEO                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM432             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM432             NO, PRINT LAST LINE                          
*                                                                               
         CLI   OUTMODE,OUTVND      ONLY PRINTING VENDOR?                        
         BNE   FORM426             NO                                           
         CLI   FRMVND2,X'FF'       YES, FINAL TOTAL?                            
         BE    FORM422             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM412                                                          
*                                                                               
         USING JOBD,R4                                                          
FORM422  BAS   RE,GETAMT                                                        
*                                                                               
FORM424  AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
         B     FORM432                                                          
*                                                                               
FORM426  CLI   FRMWKC2,X'FF'       WORKCODE TOTAL?                              
         BE    FORM428             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM418                                                          
*                                                                               
FORM428  CLI   OUTMODE,OUTVNW                                                   
         BNE   FORM422                                                          
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM432             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM432             NO                                           
         CLI   FRMVND2,X'FF'       YES, IS IT FINAL TOTAL?                      
         BE    FORM430             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM410                                                          
*                                                                               
FORM430  BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
*                                                                               
FORM432  AP    SUBTOT1,TOTTYPO                                                  
         BZ    FORM436                                                          
         GOTO1 UNDERLIN,DMCB,(12,P+52),PSECOND+52                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVC   P+1(L'AC@TJOB),AC@TJOB                                           
         LA    R3,P+72                                                          
         CLI   GRPTYPE,C'C'        PRINTING PRODUCT DETAIL?                     
         BNE   FORM434             NO                                           
         LA    R3,P+52                                                          
*                                                                               
FORM434  LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM436  AP    SUBTOT2,SUBTOT1                                                  
         AP    GRANDTOT,SUBTOT1                                                 
         B     FORMXIT                                                          
*                                                                               
FORM440  CLI   LEVEL,0             DID WE PRINT ANY DATA?                       
         BE    FORMXIT             NO                                           
         CLI   GRPTYPE,C'C'        YES, DO WE NEED PRODUCT TOTAL?               
         BNE   FORM460             NO, JUST GRAND TOTAL                         
         MVC   P,SPACES            PRINT BLANK LINE                             
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVC   P+1(L'AC@TFOR),AC@TFOR                                           
         MVC   P+1+L'AC@TFOR+1(3),PRDCODE+6                                     
         MVC   P+16(L'PRDNAME),PRDNAME                                          
         LA    R3,P+72                                                          
         LA    R4,SUBTOT2                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         ZAP   SUBTOT2,=P'0'                                                    
         B     FORMXIT                                                          
*                                                                               
FORM460  ZAP   SUBTOT1,GRANDTOT    DO SUB AND FINAL TOTALS                      
         ZAP   SUBTOT2,=P'0'                                                    
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         LA    R3,P+72                                                          
         LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM4XIT B     FORMALL                                                          
         DROP  R5,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              FORMAT 5 TIME AND OOP  (TYPE T AND TYPE O)             *         
*              VENDOR WITHIN WORKCODE WITHIN JOB/PRODUCT              *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
FORM5    MVI   RCSUBPRG,8                                                       
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
*                                                                               
         CLI   MODE,LEVALAST       END OF CLIENT?                               
         BE    FORM560             YES                                          
         CLI   MODE,LEVBLAST       NO, END OF PRODUCT?                          
         BE    FORM540             YES                                          
*                                                                               
         CLI   LEVEL,0             NO, MUST BE ACCT- 1ST TIME?                  
         BNE   FORM502             NO                                           
         CLI   JOBDATA,C'Y'        YES, DO WE HAVE ANY DATA?                    
         BNE   FORMXIT             NO, DON'T BOTHER                             
         MVI   LEVEL,1             CHANGE FOR NEXT TIME                         
         CLI   GRPTYPE,C'C'        DO WE NEED PRODUCT CODE?                     
         BNE   FORM502             NO                                           
         MVC   P+1(3),PRDCODE+6                                                 
         MVC   P+6(36),PRDNAME                                                  
         GOTO1 UNDERLIN,DMCB,(41,P+1),PSECOND+1                                 
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM502  CLI   LEVEL,1             AT DETAIL STAGE?                             
         BNE   FORM540             NO, SEE IF A TOTAL LEVEL                     
         CLI   JOBDATA,C'Y'                                                     
         BNE   FORMXIT                                                          
         MVC   P+1(6),JOBCODE+9                                                 
         MVC   P+10(36),JOBNAME                                                 
         GOTO1 UNDERLIN,DMCB,(45,P+1),PSECOND+1                                 
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         MVI   FRMTYPE,FRMTYPET                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM504             YES, GET OOP                                 
*                                                                               
         CLI   FRMTYPE,FRMTYPET    ANY TIME CHARGES?                            
         BNE   FORM504             NO, GET OOP                                  
*                                                                               
         LA    R3,P+5                                                           
         MVC   0(L'AC@PROFS,R3),AC@PROFS                                        
         LA    R3,1+L'AC@PROFS(R3)                                              
         CLI   PROF29,C'Y'         SUPPRESS 'STAFF'?                            
         BE    FORM503             YES                                          
         MVC   0(L'AC@STAFF,R3),AC@STAFF                                        
         LA    R3,1+L'AC@STAFF(R3)                                              
*                                                                               
FORM503  MVC   0(L'AC@SERVE,R3),AC@SERVE                                        
         LA    R3,1+L'AC@SERVE(R3)                                              
         BAS   RE,FORMTIT          FORMAT TITLE                                 
*                                                                               
         BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         ZAP   SUBTOT1,EDITAMT      ADD TO TOTAL                                
         AP    TOTTIME,EDITAMT                                                  
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))                                        
         MVI   FRMTYPE,FRMTYPEO                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM532             YES, DO TOTAL                                
*                                                                               
         CLI   FRMTYPE,FRMTYPEO    ANY OUT-OF=POCKET?                           
         BNE   FORM532             NO, DO TOTAL                                 
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM506                                                          
*                                                                               
FORM504  GOTO1 SHR,DMCB,('SUBRCLR',(RC))                                        
         MVI   FRMTYPE,FRMTYPEO                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM532             YES, DO TOTAL                                
*                                                                               
         CLI   FRMTYPE,FRMTYPEO    ANY OUT-OF=POCKET?                           
         BNE   FORM532             NO, DO TOTAL                                 
*                                                                               
FORM506  MVC   P+5(L'AC@OOP),AC@OOP                                             
         MVI   OUTMODE,OUTNONE                                                  
         CLI   FRMWKC3,X'FF'       IF NO DETAIL, PRINT ON SAME LINE             
         BNE   FORM508                                                          
         CLI   FRMVND3,X'FF'                                                    
         BNE   FORM508                                                          
         BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         B     FORM524                                                          
*                                                                               
FORM508  MVC   PSECOND+1(L'AC$OOP),AC$OOP                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM510  CLI   FRMWKC3,X'FF'       ANY WORKCODE DATA?                           
         BE    FORM516             NO                                           
         MVI   OUTMODE,OUTWKC      YES,SET MODE                                 
*                                                                               
FORM512  LA    R3,P+5                                                           
         MVC   0(L'FRMWKC3,R3),FRMWKC3                                          
         CLI   PROF3,C'C'          PRINT WORKCODE ONLY?                         
         BE    FORM514             YES                                          
         CLI   PROF3,C'B'          PRINT BOTH?                                  
         BNE   *+8                 NO                                           
         LA    R3,1+L'FRMWKC3(R3)  YES, MAKE ROOM                               
         MVC   0(L'FRMWNME,R3),FRMWNME  GET WORKCODE NAME                       
*                                                                               
FORM514  CLI   FRMVND3,X'FF'       VENDOR DATA ALSO?                            
         BE    FORM520             NO                                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   OUTMODE,OUTVNW                                                   
         B     FORM518                                                          
*                                                                               
FORM516  CLI   FRMVND3,X'FF'       ANY VENDOR DATA?                             
         BE    FORM528             NO, JUST TOTAL                               
         MVI   OUTMODE,OUTVND                                                   
*                                                                               
FORM518  LA    R3,P+8                                                           
         MVC   0(L'FRMVND3,R3),FRMVND3                                          
         CLI   PROF2,C'C'          PRINT VENDOR CODE ONLY?                      
         BE    FORM520             YES                                          
         CLI   PROF2,C'B'          PRINT BOTH?                                  
         BNE   *+8                 NO                                           
         LA    R3,1+L'FRMVND3(R3)  YES, MAKE ROOM                               
         MVC   0(L'FRMVNME,R3),FRMVNME  GET VENDOR NAME                         
*                                                                               
FORM520  BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
         MVI   BYTE,FRMTYPEO                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM532             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM532             NO, PRINT LAST LINE                          
*                                                                               
         CLI   OUTMODE,OUTWKC      ONLY PRINTING WORKCODE?                      
         BNE   FORM526             NO                                           
         CLI   FRMWKC3,X'FF'       YES, FINAL TOTAL?                            
         BE    FORM522             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM512                                                          
*                                                                               
         USING JOBD,R4                                                          
FORM522  BAS   RE,GETAMT                                                        
*                                                                               
FORM524  AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
         B     FORM532                                                          
*                                                                               
FORM526  CLI   FRMVND3,X'FF'       VENDOR TOTAL?                                
         BE    FORM528             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM518                                                          
*                                                                               
FORM528  CLI   OUTMODE,OUTVNW                                                   
         BNE   FORM522                                                          
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM532             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM532             NO                                           
         CLI   FRMWKC3,X'FF'       YES, IS IT FINAL TOTAL?                      
         BE    FORM530             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM510                                                          
*                                                                               
FORM530  BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
*                                                                               
FORM532  AP    SUBTOT1,TOTTYPO                                                  
         BZ    FORM536                                                          
         GOTO1 UNDERLIN,DMCB,(12,P+52),PSECOND+52                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVC   P+1(L'AC@TJOB),AC@TJOB                                           
         LA    R3,P+72                                                          
         CLI   GRPTYPE,C'C'        PRINTING PRODUCT DETAIL?                     
         BNE   FORM534             NO                                           
         LA    R3,P+52                                                          
*                                                                               
FORM534  LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM536  AP    SUBTOT2,SUBTOT1                                                  
         AP    GRANDTOT,SUBTOT1                                                 
         B     FORMXIT                                                          
*                                                                               
FORM540  CLI   LEVEL,0             DID WE PRINT ANY DATA?                       
         BE    FORMXIT             NO                                           
         CLI   GRPTYPE,C'C'        YES, DO WE NEED PRODUCT TOTAL?               
         BNE   FORM560             NO, JUST GRAND TOTAL                         
         MVC   P,SPACES            PRINT BLANK LINE                             
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVC   P+1(L'AC@TFOR),AC@TFOR                                           
         MVC   P+1+L'AC@TFOR+1(3),PRDCODE+6                                     
         MVC   P+16(L'PRDNAME),PRDNAME                                          
         LA    R3,P+72                                                          
         LA    R4,SUBTOT2                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         ZAP   SUBTOT2,=P'0'                                                    
         B     FORMXIT                                                          
*                                                                               
FORM560  ZAP   SUBTOT1,GRANDTOT    DO SUB AND FINAL TOTALS                      
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         LA    R3,P+72                                                          
         LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM5XIT B     FORMALL                                                          
         DROP  R5,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              FORMAT 6 TIME AND OOP  (TYPE T AND TYPE O)             *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
FORM6    MVI   RCSUBPRG,8                                                       
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVC   LASTNAME,SPACES     CLEAR THIS ALSO                              
         MVI   PRTDATA,C'N'        NOTHING PRINTED YET                          
*                                                                               
         CLI   MODE,LEVALAST       END OF CLIENT?                               
         BE    FORM680             YES                                          
         CLI   MODE,LEVBLAST       NO, END OF PRODUCT?                          
         BE    FORM660             YES                                          
*                                                                               
         USING PPRELD,R1                                                        
         MVC   POBJOB,SPACES       GET JOB LEVEL PRINT ON BILLS                 
         ICM   R1,15,ADLVCSUP                                                   
         BZ    *+10                                                             
         MVC   POBJOB,PPRBILLP                                                  
*                                                                               
         MVC   POBPRO,SPACES       GET PRODUCT LEVEL PRINT ON BILLS             
         ICM   R1,15,ADLVBSUP                                                   
         BZ    *+10                                                             
         MVC   POBPRO,PPRBILLP                                                  
         DROP  R1                                                               
*                                                                               
         CLI   JOBDATA,C'Y'        NO, DO WE HAVE ANY DATA?                     
         BNE   FORMXIT             NO, DON'T BOTHER                             
         CLI   LEVEL,0             YES,  MUST BE ACCT- 1ST TIME?                
         BNE   FORM602             NO                                           
         MVI   LEVEL,1             CHANGE FOR NEXT TIME                         
         CLI   GRPTYPE,C'C'        DO WE NEED PRODUCT CODE?                     
         BNE   FORM602             NO                                           
         MVC   P+1(3),PRDCODE+6                                                 
         MVC   P+6(L'PRDNAME),PRDNAME                                           
         GOTO1 UNDERLIN,DMCB,(41,P+1),PSECOND+1                                 
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         CLC   POBPRO,SPACES       DO WE HAVE A POBS?                           
         BNH   FORM602             NO                                           
         MVC   P+6(L'POBPRO),POBPRO                                             
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM602  MVC   P+1(6),JOBCODE+9                                                 
         MVC   P+10(L'JOBNAME),JOBNAME                                          
         GOTO1 UNDERLIN,DMCB,(45,P+1),PSECOND+1                                 
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         CLC   POBJOB,SPACES       DO WE HAVE A POBS?                           
         BNH   FORM604             NO                                           
         MVC   P+6(L'POBJOB),POBJOB                                             
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM604  MVI   FRMTYPE,FRMTYPET                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM624             YES, GET OOP                                 
         CLI   FRMTYPE,FRMTYPET    ANY TIME CHARGES?                            
         BNE   FORM624             NO, GET OOP                                  
         MVC   SVWNME,SPACES       CLEARE WORKCODE NAME SAVEAREA                
*                                                                               
         LA    R3,P+5                                                           
         MVC   SVTMEHED,SPACES                                                  
         MVC   0(L'AC@PROFS,R3),AC@PROFS                                        
         LA    R3,1+L'AC@PROFS(R3)                                              
         CLI   PROF29,C'Y'         SUPPRESS 'STAFF'?                            
         BE    FORM606             YES                                          
         MVC   0(L'AC@STAFF,R3),AC@STAFF                                        
         LA    R3,1+L'AC@STAFF(R3)                                              
*                                                                               
FORM606  MVC   0(L'AC@SERVE,R3),AC@SERVE                                        
         LA    R3,1+L'AC@SERVE(R3)                                              
*                                                                               
         CLI   FRMTPNM6,X'FF'      ANY DETAIL?                                  
         BNE   FORM608             YES                                          
         CLI   FRMTWRK6,X'FF'                                                   
         BNE   FORM608                                                          
*                                                                               
         BAS   RE,GETAMT           NO, PRINT TOTAL                              
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
*                                                                               
         AP    TOTTIME,EDITAMT     SAVE TOTAL FOR RECAP PAGE                    
*                                                                               
         ZAP   SUBTOT1,EDITAMT      ADD TO TOTAL                                
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         B     FORM622                                                          
*                                                                               
FORM608  LA    R0,P+5                                                           
         LR    RF,R3                                                            
         SR    RF,R0                                                            
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   SVTMEHED(0),P+5     SAVE THE HEADING                             
         BAS   RE,FORMTIT          FORMAT TITLE                                 
*                                                                               
         GOTO1 UNDERLIN,DMCB,((RF),P+5),PSECOND+5                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM610  LA    R3,P+5                                                           
         CLI   FRMTWRK6,X'FF'      PRINTING WORKCODE?                           
         BE    FORM614             NO, MUST BE PERSON                           
*                                                                               
         CLC   SVWNME,FRMWNME      DID WE PRINT THIS WORKCODE ALREADY?          
         BE    FORM611             YES                                          
         MVC   0(L'FRMWNME,R3),FRMWNME                                          
         LA    R3,L'FRMWNME+1(R3)                                               
*                                                                               
FORM611  CLI   FRMTPNM6,X'FF'      PRINTING CONTRA ALSO?                        
         BE    FORM616             NO, GET AMOUNT                               
*                                                                               
         LA    R3,P+7                                                           
         CLC   SVWNME,FRMWNME      DID WE PRINT THIS WORKCODE ALREADY?          
         MVC   SVWNME,FRMWNME                                                   
         BNE   FORM612             NO, PRINT IT THEN VENDOR                     
         B     FORM614             PRINT VENDOR                                 
*                                                                               
FORM612  GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM614  MVC   0(L'FRMTPNM6,R3),FRMTPNM6                                        
         LA    R3,L'FRMTPNM6+1(R3)                                              
*                                                                               
FORM616  BAS   RE,GETAMT           NO, PRINT TOTAL                              
*                                                                               
         CLI   FRMTRTE6,X'FF'      PRINTING DETAILS?                            
         BE    FORM618             NO                                           
         CP    THOURS,=P'0'        YES, ANY HOURS?                              
         BE    FORM618             NO, SKIP THIS                                
*                                                                               
         XC    FORMWRK,FORMWRK                                                  
         MVC   FORMWRK+8(3),=C'HRS'                                             
         CURED THOURS,(8,FORMWRK),2,MINUS=YES                                   
         GOTO1 SQUASHER,DMCB,FORMWRK,L'FORMWRK                                  
         MVC   0(L'FORMWRK,R3),FORMWRK                                          
         GOTO1 RIGHT,DMCB,(R3),L'FORMWRK                                        
         LA    R3,L'FORMWRK+1(R3)                                               
*                                                                               
         XC    FORMWRK,FORMWRK                                                  
         MVC   FORMWRK+7(3),=C'/HR'                                             
         CURED FRMTRTE6,(7,FORMWRK),2                                           
         GOTO1 SQUASHER,DMCB,FORMWRK,L'FORMWRK                                  
         MVC   0(L'FORMWRK,R3),FORMWRK                                          
         GOTO1 RIGHT,DMCB,(R3),L'FORMWRK                                        
*                                                                               
FORM618  LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
         MVI   BYTE,FRMTYPET                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM622             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPET    ANY MORE TIME?                               
         BNE   FORM622             NO, PRINT LAST LINE                          
*                                                                               
         CLI   FRMTPNM6,X'FF'      ANY MORE DETAILS?                            
         BNE   *+12                YES                                          
         CLI   FRMTWRK6,X'FF'                                                   
         BE    FORM620             NO, PRINT TOTAL ONLY                         
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM610                                                          
*                                                                               
FORM620  BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         ZAP   SUBTOT1,EDITAMT      ADD TO TOTAL                                
         AP    TOTTIME,EDITAMT                                                  
*                                                                               
         GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         LA    RF,P+9              MOVE IN TOTAL HEADING                        
         MVC   0(L'AC@TFOR,RF),AC@TFOR                                          
         LA    RF,1+L'AC@TFOR(RF)                                               
         MVC   0(L'SVTMEHED,RF),SVTMEHED                                        
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM622  GOTO1 SHR,DMCB,('SUBRCLR',(RC))                                        
         MVI   FRMTYPE,FRMTYPEO                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM650             YES, DO TOTAL                                
         CLI   FRMTYPE,FRMTYPEO    ANY OUT-OF=POCKET?                           
         BNE   FORM650             NO, DO TOTAL                                 
         MVI   SPACING,3                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM626                                                          
*                                                                               
FORM624  GOTO1 SHR,DMCB,('SUBRCLR',(RC))                                        
         MVI   FRMTYPE,FRMTYPEO                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM650             YES, DO TOTAL                                
*                                                                               
         CLI   FRMTYPE,FRMTYPEO    ANY OUT-OF=POCKET?                           
         BNE   FORM650             NO, DO TOTAL                                 
*                                                                               
FORM626  MVC   P+5(L'AC@OOP),AC@OOP                                             
         MVI   OUTMODE,OUTNONE                                                  
         CLI   FRMOWRK6,X'FF'      IF NO DETAIL, PRINT ON SAME LINE             
         BNE   FORM628                                                          
         CLI   FRMOVNM6,X'FF'                                                   
         BNE   FORM628                                                          
         BAS   RE,GETAMT                                                        
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         B     FORM644                                                          
*                                                                               
FORM628  MVC   PSECOND+5(L'AC$OOP),AC$OOP                                       
         MVC   SVOOPHED,AC@OOP                                                  
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM630  CLI   FRMOWRK6,X'FF'      ANY WORKCODE DATA?                           
         BE    FORM634             NO                                           
         MVI   OUTMODE,OUTWKC      YES,SET MODE                                 
*                                                                               
FORM632  LA    R3,P+5                                                           
         CLC   LASTNAME,FRMWNME    SAME AS LAST ONE?                            
         MVC   LASTNAME,FRMWNME                                                 
         BE    *+10                                                             
         MVC   0(L'FRMWNME,R3),FRMWNME                                          
         LA    R3,L'WCODESC+1(R3)  BUMP SHORT LENGTH                            
         CLI   PROF1,C'L'          PRINTING LONG INVOICE?                       
         BE    FORM633             YES, LEAVE SHORT LENGTH                      
         CLI   PROF27,C'Y'         PRINTING LONG NAMES?                         
         BNE   *+8                 NO                                           
         LA    R3,L'FRMWNME-L'WCODESC(R3)                                       
*                                                                               
FORM633  CLI   FRMOVNM6,X'FF'       VENDOR DATA ALSO?                           
         BE    FORM638              NO                                          
         MVI   OUTMODE,OUTVNW                                                   
         B     FORM636                                                          
*                                                                               
FORM634  CLI   FRMOVNM6,X'FF'       ANY VENDOR DATA?                            
         BE    FORM646              NO, JUST TOTAL                              
         MVI   OUTMODE,OUTVND                                                   
         LA    R3,P+5                                                           
         CLC   LASTNAME,FRMOVNM6    SAME AS LAST ONE?                           
         MVC   LASTNAME,FRMOVNM6                                                
         BE    *+10                                                             
*                                                                               
FORM636  MVC   0(L'FRMOVNM6,R3),FRMOVNM6                                        
         CLI   PROF1,C'Y'          PRINTING REFERENCE?                          
         BE    FORM637                                                          
         CLI   PROF1,C'L'                                                       
         BNE   FORM638             NO                                           
*                                                                               
FORM637  LA    R3,22+1(R3)         YES, BUMP SHORT LENGTH                       
         CLI   FRMOWRK6,X'FF'      ARE WE PRINTING THE WORKCODE ALSO?           
         BNE   *+8                 YES, LEAVE ROOM                              
         LA    R3,L'FRMOVNM6-21(R3)                                             
*                                                                               
         MVI   0(R3),C' '          CLEAR LAST CHARACTER                         
         MVC   1(L'FRMOREFL,R3),FRMOREF6                                        
*                                                                               
FORM638  BAS   RE,GETAMT                                                        
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         MVI   BYTE,FRMTYPEO                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM650             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM650             NO, PRINT LAST LINE                          
         CLI   FRMOWRK6,X'FF'      YES, FINAL TOTAL?                            
         BNE   FORM640                                                          
         CLI   FRMOVNM6,X'FF'                                                   
         BE    FORM642             YES                                          
*                                                                               
FORM640  GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM630                                                          
*                                                                               
         USING JOBD,R4                                                          
FORM642  BAS   RE,GETAMT                                                        
         GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         LA    RF,P+9              MOVE IN HEADING                              
         MVC   0(L'AC@TFOR,RF),AC@TFOR                                          
         LA    RF,1+L'AC@TFOR(RF)                                               
         MVC   0(L'SVOOPHED,RF),SVOOPHED                                        
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM644  AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
         B     FORM650                                                          
*                                                                               
FORM646  CLI   OUTMODE,OUTVNW                                                   
         BNE   FORM642                                                          
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM650             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM650             NO                                           
         CLI   FRMOWRK6,X'FF'      YES, IS IT FINAL TOTAL?                      
         BE    FORM648             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM630                                                          
*                                                                               
FORM648  BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
*                                                                               
FORM650  AP    SUBTOT1,TOTTYPO                                                  
*        BZ    FORM652                                                          
         CLI   PRTDATA,C'Y'        DID WE PRINT ANYTHING?                       
         BNE   FORM652             NO                                           
         GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         MVI   SPACING,3                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVC   P+1(L'AC@TJOB),AC@TJOB                                           
         MVC   P+1+L'AC@TJOB+1(6),JOBCODE+9                                     
         MVC   P+1+L'AC@TJOB+1+6+1(L'JOBNAME),JOBNAME                           
         LA    R3,P+72                                                          
         LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,3                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM652  AP    SUBTOT2,SUBTOT1                                                  
         AP    GRANDTOT,SUBTOT1                                                 
         CLI   GRPTYPE,C'0'                                                     
         BE    FORMALL                                                          
         B     FORMXIT                                                          
*                                                                               
FORM660  CLI   LEVEL,0             DID WE PRINT ANY DATA?                       
         BE    FORMXIT             NO                                           
         CLI   GRPTYPE,C'C'        YES, DO WE NEED PRODUCT TOTAL?               
         BNE   FORM680             NO, JUST GRAND TOTAL                         
         MVC   P,SPACES            PRINT BLANK LINE                             
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVC   P+1(L'AC@TFOR),AC@TFOR                                           
         MVC   P+1+L'AC@TFOR+1(3),PRDCODE+6                                     
         MVC   P+16(L'PRDNAME),PRDNAME                                          
         LA    R3,P+72                                                          
         LA    R4,SUBTOT2                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         ZAP   SUBTOT2,=P'0'                                                    
         B     FORMXIT                                                          
*                                                                               
FORM680  ZAP   SUBTOT1,GRANDTOT    DO SUB AND FINAL TOTALS                      
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         LA    R3,P+72                                                          
         LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM6XIT B     FORMALL                                                          
         DROP  R5,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              FORMAT 7 TIME AND OOP  (TYPE T AND TYPE O)             *         
*              TIME WITHIN WORKCODE GROUP                             *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
FORM7    MVI   FORCEHED,C'Y'       FORCE NEW PAGE                               
         MVI   RCSUBPRG,8                                                       
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPET                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM706             YES, GET OOP                                 
*                                                                               
         CLI   FRMTYPE,FRMTYPET    ANY TIME CHARGES?                            
         BNE   FORM706             NO, GET OOP                                  
*                                                                               
         LA    R3,P+1                                                           
         MVC   0(L'AC@PROFS,R3),AC@PROFS                                        
         LA    R3,1+L'AC@PROFS(R3)                                              
         CLI   PROF29,C'Y'         SUPPRESS 'STAFF'?                            
         BE    FORM700             YES                                          
         MVC   0(L'AC@STAFF,R3),AC@STAFF                                        
         LA    R3,1+L'AC@STAFF(R3)                                              
*                                                                               
FORM700  MVC   0(L'AC@SERVE,R3),AC@SERVE                                        
         LA    R3,1+L'AC@SERVE(R3)                                              
         BAS   RE,FORMTIT                                                       
         CLI   FRMTWGR7,0                                                       
         BE    FORM704                                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM702  LA    R3,P+5                                                           
         XC    COMMKEY,COMMKEY     READ THE WORKCODE GROUP                      
         MVI   COMMKEY,WGRKTYPQ                                                 
         MVI   COMMKEY+1,WGRKSUBQ                                               
         MVC   COMMKEY+2(L'QCOMPANY),QCOMPANY                                   
         MVC   COMMKEY+3(L'PRODUL),PRODUL                                       
         MVC   COMMKEY+5(L'FRMTWGR7),FRMTWGR7                                   
         MVC   KEYSAVE,COMMKEY                                                  
         L     R2,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)       FIND IT?                                     
         BNE   FORM704             NO                                           
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
FORM704  BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTIME,EDITAMT                                                  
         AP    SUBTOT1,EDITAMT                                                  
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
         MVI   BYTE,FRMTYPET                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM705             YES, PRINT WHAT WE HAVE                      
*                                                                               
         CLI   FRMTYPE,FRMTYPET    ANY MORE TIME CHARGES?                       
         BNE   FORM705             NO, PRINT WHAT WE HAVE                       
*                                                                               
         CLI   FRMTWGR7,X'FF'      YES, IS IT A TOTAL?                          
         BE    FORM704A            YES                                          
         MVI   SPACING,1                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM702             PRINT NEXT                                   
*                                                                               
FORM704A GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         BAS   RE,GETAMT                                                        
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
FORM705  MVI   SPACING,1                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM706  LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPEO                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM730             YES, DO TOTAL                                
*                                                                               
         CLI   FRMTYPE,FRMTYPEO    ANY OUT-OF=POCKET?                           
         BNE   FORM730             NO, DO TOTAL                                 
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVC   P+1(L'AC@OOP),AC@OOP                                             
         MVI   OUTMODE,OUTNONE                                                  
         CLI   FRMWKC3,X'FF'       IF NO DETAIL, PRINT ON SAME LINE             
         BNE   FORM708                                                          
         CLI   FRMVND3,X'FF'                                                    
         BE    FORM722                                                          
*                                                                               
FORM708  MVC   PSECOND+1(L'AC$OOP),AC$OOP                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM710  CLI   FRMWKC3,X'FF'       ANY WORKCODE DATA?                           
         BE    FORM716             NO                                           
         MVI   OUTMODE,OUTWKC      YES,SET MODE                                 
*                                                                               
FORM712  LA    R3,P+1                                                           
         MVC   0(L'FRMWKC3,R3),FRMWKC3                                          
         CLI   PROF3,C'C'          PRINT WORKCODE ONLY?                         
         BE    FORM714             YES                                          
         CLI   PROF3,C'B'          PRINT BOTH?                                  
         BNE   *+8                 NO                                           
         LA    R3,1+L'FRMWKC3(R3)  YES, MAKE ROOM                               
         MVC   0(L'FRMWNME,R3),FRMWNME  GET DESCRIPTION                         
*                                                                               
FORM714  CLI   FRMVND3,X'FF'       VENDOR DATA ALSO?                            
         BE    FORM720             NO                                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   OUTMODE,OUTVNW                                                   
         B     FORM718                                                          
*                                                                               
FORM716  CLI   FRMVND3,X'FF'       ANY VENDOR DATA?                             
         BE    FORM726             NO, JUST TOTAL                               
         MVI   OUTMODE,OUTVND                                                   
*                                                                               
FORM718  LA    R3,P+8                                                           
         MVC   0(L'FRMVND3,R3),FRMVND3                                          
         CLI   PROF2,C'C'          PRINT VENDOR ONLY?                           
         BE    FORM720             YES                                          
         CLI   PROF2,C'B'          PRINT BOTH?                                  
         BNE   *+8                 NO                                           
         LA    R3,1+L'FRMVND3(R3)  YES, MAKE ROOM                               
         MVC   0(L'FRMVNME,R3),FRMVNME  GET VENDOR NAME                         
*                                                                               
FORM720  BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
         MVI   BYTE,FRMTYPEO                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM728             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM728             NO, PRINT LAST LINE                          
*                                                                               
         CLI   OUTMODE,OUTWKC      ONLY PRINTING WORKCODE?                      
         BNE   FORM724             NO                                           
         CLI   FRMWKC3,X'FF'       YES, FINAL TOTAL?                            
         BE    FORM722             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM712                                                          
*                                                                               
         USING JOBD,R4                                                          
FORM722  BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         B     FORM728                                                          
*                                                                               
FORM724  CLI   FRMVND3,X'FF'       VENDOR TOTAL?                                
         BE    FORM726             YES                                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORM718                                                          
*                                                                               
FORM726  CLI   OUTMODE,OUTVNW                                                   
         BNE   FORM722                                                          
         GOTO1 UNDERLIN,DMCB,(12,P+52),PSECOND+52                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORM728             YES, PRINT LAST LINE                         
         CLI   FRMTYPE,FRMTYPEO    ANY MORE?                                    
         BNE   FORM728             NO                                           
         CLI   FRMWKC3,X'FF'       YES, IS IT FINAL TOTAL?                      
         BNE   FORM710             NO                                           
         BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
FORM728  GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM730  ZAP   TOTTYPO,TOTTYPO                                                  
         BZ    FORM7XIT                                                         
         AP    SUBTOT1,TOTTYPO                                                  
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         LA    R3,P+72                                                          
         LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2           DOUBLE SPACE TOTAL                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   SPACING,1                                                        
*                                                                               
FORM7XIT ZAP   GRANDTOT,SUBTOT1                                                 
         B     FORMALL                                                          
         DROP  R5,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              FORMAT 8                                               *         
***********************************************************************         
         USING FRMD,R5                                                          
FORM8    MVI   FORCEHED,C'Y'       FORCE NEW PAGE                               
         MVI   BYTE,0                                                           
         MVI   RCSUBPRG,8                                                       
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPE8                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM8XIT            YES                                          
*                                                                               
         MVC   P+1(L'FRMUSF8),FRMUSF8        USER FIELD                         
         MVC   P+15(L'FRMJNME),FRMJNME       JOB NAME                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         MVC   USF8PRV,FRMUSF8        USER FIELD                                
*                                                                               
         B     FORM802                                                          
*    - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -                
FORM801  MVI   BYTE,FRMTYPE8                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM820             NO                                           
*                                                                               
FORM802  CLI   FRMWRK8,X'FF'       JOB TOTAL?                                   
         BNE   *+20                                                             
         MVC   SVTMEHED,SPACES                                                  
         MVC   SVTMEHED(L'FRMJNME),FRMJNME        JOB NAME                      
         BAS   RE,FORM810                                                       
*                                                                               
         CLI   FRMJBC8,X'FF'       PRODUCT TOTAL?                               
         BNE   *+20                                                             
         MVC   SVTMEHED,SPACES                                                  
         MVC   SVTMEHED(L'FRMPNME),FRMPNME        PRODUCT NAME                  
         BAS   RE,FORM810                                                       
*                                                                               
         CLI   FRMUSF8,X'FF'       LAST TOTAL?                                  
         BE    FORM820                                                          
*                                                                               
         TM    BYTE,X'80'          ANY TOTALS?                                  
         BZ    FORM804                                                          
         NI    BYTE,X'FF'-X'80'                                                 
*       - - - - - - - - - - - - - - - - - -                                     
         CLC   USF8PRV,FRMUSF8                                                  
         BE    *+16                                                             
         MVC   USF8PRV,FRMUSF8        USER FIELD                                
*       - - - - - - - - - - - - - - - - - -                                     
         MVC   P+1(L'FRMUSF8),FRMUSF8        USER FIELD                         
         MVC   P+15(L'FRMVNME),FRMVNME       JOB NAME                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM804  MVC   P+15(L'FRMWNME),FRMWNME       WORK CODE DESCRIPTION              
         BAS   RE,GETAMT                                                        
         LA    R3,P+52                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM805  B     FORM801                                                          
*    - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -                
FORM810  ST    RE,SAVERE2                                                       
         BAS   RE,GETAMT                                                        
         LA    RF,P+15             MOVE IN TOTAL HEADING                        
         MVC   0(L'AC@TFOR,RF),AC@TFOR                                          
         LA    RF,1+L'AC@TFOR(RF)                                               
         MVC   0(L'SVTMEHED,RF),SVTMEHED                                        
*                                                                               
         CLI   FRMJBC8,X'FF'       PRODUCT TOTAL?                               
         BNE   *+12                                                             
         LA    R3,P+72             YES, TOTAL OUT TO THE RIGHT                  
         B     *+8                                                              
         LA    R3,P+52             NO, LINE TOTAL UP                            
*                                                                               
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM819  MVI   BYTE,FRMTYPE8                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORM820             NO                                           
*                                                                               
         OI    BYTE,X'80'                                                       
         L     RE,SAVERE2                                                       
         BR    RE                                                               
*    - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -                
FORM820  GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         BAS   RE,GETAMT                                                        
         AP    TOTCOM,COMAMT                                                    
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         AP    TOTCD,CDAMT          ADD CD                                      
         AP    TOTTYPO,EDITAMT                                                  
         AP    TOTOOP,EDITAMT                                                   
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
*                                                                               
         AP    SUBTOT1,TOTTYPO                                                  
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         LA    R3,P+72                                                          
         LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2           DOUBLE SPACE TOTAL                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   SPACING,1                                                        
*                                                                               
         GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORM8XIT ZAP   GRANDTOT,SUBTOT1                                                 
         B     FORMALL                                                          
         DROP  R5                                                               
USF8PRV  DC    CL12' '                                                          
         EJECT                                                                  
***********************************************************************         
*             FORMAT PREVIOUS BILLING (WORKCODE 99)                   *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
FORMPRV  NTR1                                                                   
         CLI   PREVOPT,C'Y'        SUPPRESS PREVIOUS BILLING?                   
         BE    FORMPRVX            YES, RETURN                                  
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPEB                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         CLI   DMCB+8,X'80'        END OF FILE?                                 
         BE    FORMPRVX            YES, RETURN                                  
*                                                                               
         CLI   FRMTYPE,FRMTYPEB    ANY PREVIOUS BILLING?                        
         BNE   FORMPRVX            NO, RETURN                                   
         MVC   P+1(L'AC@PRVBL),AC@PRVBL                                         
         BAS   RE,GETAMT                                                        
         LA    R3,P+72                                                          
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         SP    GRANDTOT,EDITAMT    SUBTRACT FROM TOTAL                          
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORMPRVX B     FORMXIT                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              GET NET/GROSS AMOUNT                                   *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
         USING JOBD,R4                                                          
GETAMT   NTR1                                                                   
         LA    R5,BUFWK                                                         
         LA    R4,FRMACCUM                                                      
         ZAP   COMAMT,=P'0'                                                     
         ZAP   CDAMT,=P'0'                                                      
*                                                                               
         ZAP   NETAMT,JOBNET       GET NET AMOUNT                               
         ZAP   GRSAMT,JOBGRS       GROSS                                        
         ZAP   GSTAMT,JOBGST           GST                                      
         ZAP   PSTAMT,JOBPST           PST                                      
         ZAP   THOURS,JOBHRS           HOURS                                    
*                                                                               
         ZAP   EDITAMT,JOBGRS      PRINT THE GROSS AMOUNT                       
*                                                                               
*        CLI   FRMTYPE,FRMTYPEB    IS THIS PREVIOUS BILLING?                    
*        BE    GETAMT2             YES, INCLUDE COMMISSION                      
         CLI   FRMTYPE,FRMTYPEL    NO, IS IS LASTED BILLED DATA?                
         BE    GETAMT2             YES, INCLUDE COMMISSION                      
*                                                                               
         CLI   PROF15,C'W'         NO, SHOW COMMISSION BY WORKCODE              
         BE    GETAMT2             YES                                          
         ZAP   EDITAMT,JOBNET      NO, PRINT THE NET                            
         ZAP   COMAMT,JOBCOM       GET COMMISSION ALSO                          
*                                                                               
GETAMT2  SP    EDITAMT,JOBCD       TAKE OUT DISCOUNT                            
         SP    NETAMT,JOBCD                                                     
         SP    GRSAMT,JOBCD                                                     
         CLI   PROF8,C'Y'          INCLUDE CD IN WORKCODE?                      
         BE    GETAMTX             YES                                          
         AP    EDITAMT,JOBCD       NO, PUT IT BACK                              
         AP    NETAMT,JOBCD                                                     
         AP    GRSAMT,JOBCD                                                     
         ZAP   CDAMT,JOBCD                                                      
         MP    CDAMT,=P'-1'        MAKE NEGATIVE                                
*                                                                               
GETAM4   NI    BILLOPT,ALL-CREDIT                                               
         TM    CLIOPT,PAYNET       INDICATE IF WE HAVE CREDIT AMOUNT            
         BZ    GETAMTX                                                          
         CP    NETAMT,=P'0'                                                     
         BNL   GETAMTX                                                          
         OI    BILLOPT,CREDIT                                                   
*                                                                               
GETAMTX  B     FORMXIT                                                          
         DROP  R5,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              COMMON FORMAT ROUTINE FOR AMOUNTS                      *         
*              R3=PRINT POSITION    R4=AMOUNT                                   
***********************************************************************         
FORMAMT  ST    RE,SAVERE                                                        
         CURED (P8,(R4)),(12,(R3)),2,MINUS=YES                                  
         ORG   *-2                                                              
         CP    0(8,R4),=P'-99999999'                                            
         BL    FORMA02             NO COMMAS IF A MILLION OR MORE               
         CP    0(8,R4),=P'99999999'                                             
         BH    FORMA02                                                          
         CLI   PROF32,C'Y'         PRINTING COMMAS?                             
         BNE   *+8                 NO                                           
         OI    CURPEDT1-CURPARMD(R1),CURPCOMY                                   
*                                                                               
FORMA02  BASR  RE,RF                                                            
         L     RE,SAVERE                                                        
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*              COMMON FORMAT ROUTINE FOR TITLE                        *         
*              R3=PRINT POSITION                                                
***********************************************************************         
FORMTIT  CLI   PROF35,C'Y'         SUPPRESS THIS DATE?                          
         BER   RE                                                               
FORMTIT2 NTR1                                                                   
         MVC   0(L'FRDATE,R3),FRDATE                                            
         LA    R3,1+L'FRDATE(R3)                                                
         OC    TODATE,TODATE                                                    
         BZ    *+16                                                             
         MVC   0(L'AC@TO,R3),AC@TO                                              
         MVC   1+L'AC@TO(L'TODATE,R3),TODATE                                    
         LA    R3,P+1                                                           
         CLI   FORMTYP,C'6'                                                     
         BNE   *+8                                                              
         LA    R3,P+5                                                           
         GOTO1 SQUASHER,DMCB,(R3),L'P                                           
         B     FORMXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              COMMON FORMAT ROUTINES FOR FORMATS 2-5                 *         
***********************************************************************         
*                                                                               
FORMALL  LA    R3,P+72             FORMATS 2-7 USE THIS                         
         BAS   RE,FORMCD                                                        
         BAS   RE,FORMCOM                                                       
         BAS   RE,FORMLST                                                       
         BAS   RE,FORMTAX                                                       
         BAS   RE,FORMEND                                                       
         CLI   PROF28,C'Y'         PRINT RECAP?                                 
         BNE   FORMAX              NO, ALL DONE                                 
         BAS   RE,FORMREC          YES, DO RECAP PAGE                           
*                                                                               
FORMAX   XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*              FORMAT CASH DISCOUNT IF BY TOTAL                       *         
***********************************************************************         
*                                                                               
FORMCD   NTR1                                                                   
         CLI   PROF8,C'Y'          DISCOUNT BY WORKCODE?                        
         BE    FORMCDX             YES                                          
*                                                                               
         CP    TOTCD,=P'0'         NO, IS THERE ANYTHING TO PRINT?              
         BE    FORMCDX             NO, GET OUT                                  
*                                                                               
         LA    R4,TOTCD                                                         
         BAS   RE,FORMAMT                                                       
         MVC   P+1(L'AC@CSHDS),AC@CSHDS                                         
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORMCDX  AP    TOTNET,TOTCD        SUBTRACT FROM TOTALS                         
         AP    TOTGRS,TOTCD                                                     
         AP    SUBTOT1,TOTCD                                                    
         AP    GRANDTOT,TOTCD                                                   
         B     FORMXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              FORMAT COMMISSION AMOUNT IF PRINTING SEPARATELY        *         
***********************************************************************         
*                                                                               
FORMCOM  NTR1                                                                   
         CLI   PROF15,C'W'         DID WE INCLUDE COMMISSION IN TOTAL?          
         BE    FORMC04             YES                                          
         ZAP   DUB,TOTCOM          GET COMMISSION AMOUNT, IF ANY                
         BZ    FORMC04                                                          
*                                                                               
         MVC   P+1(L'AC@FEE),AC@FEE                                             
         CLI   PROF16,C'F'         SET CORRECT HEADING                          
         BE    FORMC00                                                          
         MVC   P+1(L'AC@CMN),AC@CMN                                             
         CLI   PROF16,C'C'                                                      
         BE    FORMC00                                                          
         MVC   P+1(L'AC@HAND),AC@HAND                                           
*                                                                               
FORMC00  LA    R4,DUB                                                           
         BAS   RE,FORMAMT                                                       
*                                                                               
FORMC02  GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         AP    SUBTOT1,TOTCOM                                                   
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2           DOUBLE SPACE TOTAL                           
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORMC06                                                          
*                                                                               
FORMC04  CP    TOTCD,=P'0'         DID WE HAVE ANY CD?                          
         BNE   FORMC02             YES, PRINT TOTAL                             
*                                                                               
FORMC06  AP    GRANDTOT,TOTCOM     ADD TO FINAL TOTAL                           
         CLI   PROF28,C'Y'         PRINTING RECAP?                              
         BE    FORMCX              YES, LEAVE TOTALS FOR LATER                  
         ZAP   TOTCOM,=P'0'        CLEAR FOR PREVIOUS BILLING USE               
         ZAP   TOTCD,=P'0'         CLEAR FOR NEXT USE                           
*                                                                               
FORMCX   B     FORMXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              FORMATS 2,3 4 5 AND 6 LAST PREBILLING (TYPE P, 48)     *         
***********************************************************************         
*                                                                               
         USING FRMD,R5                                                          
FORMLST  NTR1                                                                   
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   FRMTYPE,FRMTYPEL                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'        END OF FILE?                                 
         BO    FORMLSTX            YES, RETURN                                  
*                                                                               
         CLI   FRMTYPE,FRMTYPEL    ANY PREVIOUS PRE-BILLING                     
         BNE   FORMLSTX            NO, RETURN                                   
*                                                                               
         MVC   P+1(L'AC@APREV),AC@APREV                                         
         BAS   RE,GETAMT                                                        
         AP    TOTGST,GSTAMT        ADD GST                                     
         AP    TOTPST,PSTAMT        ADD PST                                     
         LA    R4,EDITAMT                                                       
         BAS   RE,FORMAMT                                                       
         AP    GRANDTOT,EDITAMT    ADD TO FINAL TOTALS                          
         AP    SUBTOT1,EDITAMT                                                  
         AP    TOTPREB,EDITAMT                                                  
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORMLSTX B     FORMXIT                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT TAX AMOUNTS                                     *         
***********************************************************************         
*                                                                               
FORMTAX  NTR1                                                                   
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    FORMT18             NO                                           
         ZAP   DUB,TOTGST          GET GST, IF ANY                              
         BNZ   FORMT02                                                          
*                                                                               
         TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC?                      
         BZ    FORMT18             NO                                           
         ZAP   DUB,TOTPST          GET PST, IF ANY                              
         BZ    FORMT18                                                          
*                                                                               
FORMT02  GOTO1 UNDERLIN,DMCB,(12,P+72),PSECOND+72                               
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVC   P+1(L'AC@ABTAX),AC@ABTAX                                         
         LA    R4,SUBTOT1                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         USING GSTD,R5                                                          
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),2                           
         TM    DMCB+8,X'80'                                                     
         BO    FORMT10                                                          
*                                                                               
FORMT04  CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   FORMT10             NOT A GST RECORD                             
*                                                                               
         USING JOBD,R4                                                          
         CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BNE   FORMT06             NO, SKIP IT                                  
         LA    R4,GSTACCUM                                                      
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST?                          
         BNE   FORMT08             YES                                          
*                                                                               
FORMT06  MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),2                         
         TM    DMCB+8,X'80'                                                     
         BO    FORMT10                                                          
         B     FORMT04                                                          
*                                                                               
FORMT08  MVI   MYSPACE,1                                                        
         MVC   P+1(L'AC@VAT1),AC@VAT1                                           
         LA    R4,JOBGST                                                        
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORMT06                                                          
*                                                                               
FORMT10  TM    RUNOPT,NEEDPST      DOING PST LOGIC?                             
         BZ    FORMT18             NO                                           
*                                                                               
         USING PSTD,R5                                                          
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),2                           
         TM    DMCB+8,X'80'                                                     
         BO    FORMT18                                                          
*                                                                               
FORMT12  CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   FORMT18             NOT A PST RECORD                             
*                                                                               
         USING JOBD,R4                                                          
         CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BNE   FORMT14             NO, SKIP IT                                  
         LA    R4,PSTACCUM                                                      
         CP    JOBPST,=P'0'        DO WE HAVE ANY PST?                          
         BNE   FORMT16             YES                                          
*                                  ELSE GET NEXT RECORD                         
FORMT14  MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),2                         
         TM    DMCB+8,X'80'                                                     
         BO    FORMT18                                                          
         B     FORMT12                                                          
*                                                                               
FORMT16  MVI   MYSPACE,1                                                        
         MVC   P+1(L'PSTNAME),PSTNAME                                           
         LA    R4,JOBPST                                                        
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     FORMT14                                                          
*                                                                               
FORMT18  GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         AP    SUBTOT1,TOTGST                                                   
         AP    SUBTOT1,TOTPST                                                   
         AP    GRANDTOT,TOTGST     ADD TO FINAL TOTAL                           
         AP    GRANDTOT,TOTPST                                                  
         CLI   PROF28,C'Y'         PRINTING RECAP?                              
         BE    FORMTX              YES, DON'T CLEAR THESE FIELDS YET            
         ZAP   TOTGST,=P'0'        CLEAR FOR PREVIOUS BILLING USE               
         ZAP   TOTPST,=P'0'        CLEAR FOR PREVIOUS BILLING USE               
*                                                                               
FORMTX   B     FORMXIT                                                          
         DROP  R5,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              FORMAT GRAND TOTAL                                     *         
***********************************************************************         
*                                                                               
FORMEND  NTR1                                                                   
         MVI   P+58,C'-'                                                        
         MVC   P+59(25),P+58                                                    
         MVI   SPACING,1                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         MVC   P+58(L'AC@INVTO),AC@INVTO                                        
         CURED (P8,GRANDTOT),(12,P+72),2,MINUS=YES,FLOAT=$                      
         ORG   *-2                                                              
         CP    GRANDTOT,=P'-99999999'                                           
         BL    FORME02             NO COMMAS IF A MILLION OR MORE               
         CP    GRANDTOT,=P'99999999'                                            
         BH    FORME02                                                          
         CLI   PROF32,C'Y'         PRINTING COMMAS?                             
         BNE   *+8                 NO                                           
         OI    CURPEDT1-CURPARMD(R1),CURPCOMY                                   
*                                                                               
FORME02  BASR  RE,RF                                                            
         MVI   SPACING,1                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         MVC   P+58(L'AC@CRAM),AC@CRAM                                          
         ZAP   GRANDTOT,GRANDTOT                                                
         BM    FORME04                                                          
         MVC   P+58(L'AC@PPTA),AC@PPTA                                          
*                                                                               
FORME04  GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   P+58,C'-'                                                        
         MVC   P+59(25),P+58                                                    
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         ZAP   GRANDTOT,=P'0'                                                   
*                                                                               
         LA    R3,2                SET LEVEL                                    
         GOTO1 SHR,DMCB,('SUBRTAX',(RC)),(R3)  TAX ANALYSIS                     
*                                                                               
FORMXIT  XIT1                      AND EXIT                                     
         EJECT                                                                  
***********************************************************************         
*              FORMAT RECAP PAGE                                      *         
***********************************************************************         
*                                                                               
FORMREC  NTR1                                                                   
         MVI   RCSUBPRG,16         USE DUMMY FORMAT                             
         ZAP   DUB,=P'0'           CLEAR TOTAL BUCKET                           
         LA    R3,P+1                                                           
         MVC   0(L'AC@BPER,R3),AC@BPER                                          
         LA    R3,1+L'AC@BPER(R3)                                               
         BAS   RE,FORMTIT2         FORMAT TITLE                                 
*                                                                               
         MVI   FORCEHED,C'Y'       NEW PAGE                                     
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         LA    R3,P+1                                                           
         MVC   0(L'AC@INVSU,R3),AC@INVSU                                        
         LA    R3,1+L'AC@INVSU(R3)                                              
         MVC   PSECOND+1(L'AC$INVSU),AC$INVSU                                   
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         CP    TOTTIME,=P'0'       DID WE HAVE ANY TIME?                        
         BE    FORMRE02            NO                                           
         LA    R3,P+5                                                           
         MVC   0(L'AC@PROFS,R3),AC@PROFS                                        
         LA    R3,1+L'AC@PROFS(R3)                                              
         CLI   PROF29,C'Y'         SUPPRESS 'STAFF'?                            
         BE    FORMRE00            YES                                          
         MVC   0(L'AC@STAFF,R3),AC@STAFF                                        
         LA    R3,1+L'AC@STAFF(R3)                                              
*                                                                               
FORMRE00 MVC   0(L'AC@SERVE,R3),AC@SERVE                                        
         LA    R3,P+72                                                          
         LA    R4,TOTTIME                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         AP    DUB,TOTTIME                                                      
*                                                                               
FORMRE02 CP    TOTOOP,=P'0'        ANY OOP?                                     
         BE    FORMRE04            NO                                           
         MVC   P+5(L'AC@OOP),AC@OOP                                             
         LA    R3,P+72                                                          
         LA    R4,TOTOOP                                                        
         BAS   RE,FORMAMT                                                       
         MVI   SPACING,2                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         AP    DUB,TOTOOP                                                       
*                                                                               
FORMRE04 CP    DUB,=P'0'           DO WE HAVE ANYTHING SO FAR?                  
         BE    FORMRE06            NO                                           
         MVC   P+1(L'AC@TOTAL),AC@TOTAL                                         
         MVI   SPACING,2                                                        
         LA    R3,P+72                                                          
         LA    R4,DUB                                                           
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORMRE06 CLI   PROF8,C'Y'          DISCOUNT BY WORKCODE?                        
         BE    FORMRE08            YES                                          
         CP    TOTCD,=P'0'         NO, DO WE HAVE ANY?                          
         BE    FORMRE08            NO                                           
         MVC   P+1(L'AC@CSHDS),AC@CSHDS                                         
         LA    R3,P+72                                                          
         LA    R4,TOTCD                                                         
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         AP    DUB,TOTCD                                                        
*                                                                               
FORMRE08 CLI   PROF15,C'W'         DID WE INCLUDE COMMISSION IN TOTAL?          
         BE    FORMRE12            YES                                          
         CP    TOTCOM,=P'0'        NO, DO WE HAVE ANY?                          
         BZ    FORMRE12            NO                                           
         MVC   P+1(L'AC@FEE),AC@FEE                                             
         CLI   PROF16,C'F'         YES, SET CORRECT HEADINGS                    
         BE    FORMRE10                                                         
         MVC   P+1(L'AC@CMN),AC@CMN                                             
         CLI   PROF16,C'C'                                                      
         BE    FORMRE10                                                         
         MVC   P+1(L'AC@HAND),AC@HAND                                           
*                                                                               
FORMRE10 LA    R3,P+72                                                          
         LA    R4,TOTCOM                                                        
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         AP    DUB,TOTCOM                                                       
*                                                                               
FORMRE12 CP    DUB,=P'0'           DO WE HAVE ANYTHING SO FAR?                  
         BE    FORMRE14            NO                                           
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         MVI   SPACING,2                                                        
         LA    R3,P+72                                                          
         LA    R4,DUB                                                           
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORMRE14 ZAP   DUB1,TOTGST         SEE WE HAVE ANY TAXES                        
         AP    DUB1,TOTPST                                                      
         BZ    FORMRE16                                                         
         MVC   P+1(L'AC@TTAX),AC@TTAX                                           
         LA    R3,P+72                                                          
         LA    R4,DUB1                                                          
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         AP    DUB,DUB1                                                         
*                                                                               
         MVC   P+1(L'AC@SUBT),AC@SUBT                                           
         MVI   SPACING,2                                                        
         LA    R3,P+72                                                          
         LA    R4,DUB                                                           
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
FORMRE16 CP    TOTPREB,=P'0'       ANY PREBILLING?                              
         BE    FORMRE18            NO                                           
         MVC   P+1(L'AC@APREV),AC@APREV                                         
         LA    R3,P+72                                                          
         LA    R4,TOTPREB                                                       
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         AP    DUB,TOTPREB                                                      
*                                                                               
FORMRE18 MVI   P+58,C'-'                                                        
         MVC   P+59(25),P+58                                                    
         MVI   SPACING,1                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         MVC   P+58(L'AC@INVTO),AC@INVTO                                        
         LA    R3,P+72                                                          
         LA    R4,DUB                                                           
         BAS   RE,FORMAMT                                                       
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         MVC   P+58(L'AC@CRAM),AC@CRAM                                          
         ZAP   DUB,DUB                                                          
         BM    FORMRE20                                                         
         MVC   P+58(L'AC@PPTA),AC@PPTA                                          
*                                                                               
FORMRE20 GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         MVI   P+58,C'-'                                                        
         MVC   P+59(25),P+58                                                    
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
         BAS   RE,FORMCLR          CLEAR TOTALS                                 
*                                                                               
FORMREX  B     FORMXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              CLEAR FORMAT TOTALS                                    *         
***********************************************************************         
*                                                                               
FORMCLR  NTR1                                                                   
         ZAP   TOTCOM,=P'0'                                                     
         ZAP   TOTCD,=P'0'                                                      
         ZAP   TOTGST,=P'0'                                                     
         ZAP   TOTPST,=P'0'                                                     
*                                                                               
         ZAP   TOTOOP,=P'0'                                                     
         ZAP   TOTTIME,=P'0'                                                    
         ZAP   TOTPREB,=P'0'                                                    
         ZAP   TOTGRS,=P'0'                                                     
         ZAP   TOTNET,=P'0'                                                     
*                                                                               
FORMCLX  B     FORMXIT                                                          
         EJECT                                                                  
EDITAMT  DS    PL8                                                              
COMAMT   DS    PL8                                                              
GRSAMT   DS    PL8                                                              
NETAMT   DS    PL8                                                              
GSTAMT   DS    PL8                                                              
PSTAMT   DS    PL8                                                              
CDAMT    DS    PL8                                                              
THOURS   DS    PL5                                                              
DUB1     DS    PL8                                                              
         DROP  R6,R9,RA,RB                                                      
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'AC27 - PROFESSIONAL BILLING - POSTING ROUTINES'                 
POSTR    DS    0D                                                               
         NMOD1 0,**POSTR*,RA,R9                                                 
         L     RC,0(R1)                                                         
         MVC   POSTMODE,0(R1)                                                   
         CLI   POSTMODE,POSTBILL                                                
         BE    WRITPOST            REGULAR POSTINGS                             
         CLI   POSTMODE,POSTCLSE                                                
         BE    WRITOTAL            TOTAL AND CLOSE                              
         CLI   POSTMODE,POSTSK                                                  
         BE    REVERSIT            REVERSE SK POSTINGS                          
         CLI   POSTMODE,POSTOPEN                                                
         BE    OPENPOST            OPEN WORKER FILE                             
         CLI   POSTMODE,POSTGRP                                                 
         BE    PSTGBIL             POST GROUP BILL                              
         CLI   POSTMODE,POSTEST                                                 
         BE    REVEP               REVERSE EST. PRODUCTION                      
         CLI   POSTMODE,POSTINTR                                                
         BE    PSTINTER            MAKE INTERCOMPANY POSTINGS                   
         DC    H'0'                                                             
POSTXIT  XIT1                                                                   
         EJECT                                                                  
*              WRITE POSTING FILE DETAILS FOR A BILL                            
*                                                                               
***********************************************************************         
*              POSTING HEADER                                         *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
         USING PSHEADD,R3                                                       
WRITPOST DS    0H                                                               
         LR    R4,R3                                                            
         LA    RE,AREA             CLEAR TAPE AREA                              
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         MVC   PSHDEL(2),=X'5046'                                               
         SR    R2,R2                                                            
         IC    R2,PSHDLEN                                                       
         LA    R2,0(R2,R3)                                                      
         EJECT                                                                  
         LA    R5,10                                                            
         LA    R1,TRN2DAY                                                       
         ZAP   0(6,R1),=P'0'       FORM GST FIELDS IN BILL NARRATIVE            
         LA    R1,6(R1)                                                         
         BCT   R5,*-10                                                          
         ZAP   POSTCD,SAVCD                                                     
         TM    GRPOPT,GRPBILL      GROUP BILLING?                               
         BZ    *+10                NO                                           
         AP    GRPCD,POSTCD                                                     
*                                                                               
         USING JOBD,R6                                                          
         LA    R6,JOBCHG           FILL IN TRANSACTION                          
         MVC   JOBPOS(JOBLNQ),0(R6) SAVE POSTING TOTALS                         
         LA    R6,JOBPOS                                                        
         EJECT                                                                  
***********************************************************************         
*              GENERATE POSTING AMOUNTS                               *         
***********************************************************************         
*                                  12 POSTING AMOUNT                            
         ZAP   AMOUNT12,JOBCOM                                                  
         LA    RE,JOBMED+(JOBCOM-JOBD) SUBTRACT MEDIA COSTS                     
         SP    AMOUNT12,0(L'JOBCOM,RE) FROM COSTING POSTING                     
         TM    GRPOPT,GRPBILL      ARE WE GROUP BILLING?                        
         BZ    *+10                NO                                           
         AP    GRP12,AMOUNT12                                                   
*                                                                               
*                                  11 POSTING AMOUNT                            
         ZAP   AMOUNT11,AMOUNT12                                                
         AP    AMOUNT11,JOBPNET    COMMISSION + NET + GST + PST                 
*                                                                               
         CLI   PROF25,C'Y'         EXCLUDE TAXES?                               
         BNE   *+16                NO                                           
         ZAP   AMOUNT11,AMOUNT12   YES, USE JOBNET                              
         AP    AMOUNT11,JOBNET                                                  
*                                                                               
         CLI   PROF8,C'G'          FOR NET CD                                   
         BNE   *+10                                                             
         SP    AMOUNT11,JOBCD      DEDUCT FROM BILLING POSTING                  
*                                                                               
         LA    RE,JOBMED+(JOBGRS-JOBD) SUBTRACT MEDIA COSTS                     
         SP    AMOUNT11,0(L'JOBGRS,RE) FROM COSTING POSTING                     
         CLI   PROF8,C'G'          IF GROSS OPTION MEDIA CD                     
         BNE   *+14                HAS BEEN SUBTRACTED TWICE                    
         LA    RE,JOBMED+(JOBCD-JOBD)                                           
         AP    AMOUNT11,0(L'JOBCD,RE) SO ADD IT BACK                            
*                                                                               
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         SP    AMOUNT11,JOBCOM                                                  
         TM    GRPOPT,GRPBILL      GROUP BILLING?                               
         BZ    *+10                NO                                           
         AP    GRP11,AMOUNT11                                                   
*                                                                               
*                                  SJ POSTING AMOUNT                            
         ZAP   AMOUNTSJ,JOBNET                                                  
         CLI   PROF8,C'G'          FOR GROSS CD OPTION                          
         BNE   *+10                                                             
         SP    AMOUNTSJ,JOBCD      SUBTRACT CD AMOUNT                           
         TM    GRPOPT,GRPBILL      ARE WE GROUP BILLING?                        
         BZ    *+10                NO                                           
         AP    GRPSJ,AMOUNTSJ                                                   
*                                                                               
*                                  SR POSTING AMOUNT                            
         ZAP   AMOUNTSR,JOBPGRS                                                 
         TM    CLIOPT,PAYNET       PAY=NET?                                     
         BZ    *+10                NO                                           
         ZAP   AMOUNTSR,JOBPNET                                                 
         TM    GRPOPT,GRPBILL      ARE WE GROUP BILLING?                        
         BZ    *+10                NO                                           
         AP    GRPSR,AMOUNTSR                                                   
*                                                                               
*                                  GST POSTING AMOUNT                           
         ZAP   AMOUNTGS,JOBGST                                                  
         LA    RE,JOBMED+(JOBGST-JOBD)   SUBTRACT MEDIA GST                     
         SP    AMOUNTGS,0(L'JOBGST,RE)   FROM GST POSTINGS                      
         TM    GRPOPT,GRPBILL      GROUP BILLING?                               
         BZ    *+10                NO                                           
         AP    GRPGST,AMOUNTGS                                                  
*                                                                               
*                                  PST POSTING AMOUNT                           
         ZAP   AMOUNTPS,JOBPST                                                  
         LA    RE,JOBMED+(JOBPST-JOBD)   SUBTRACT MEDIA PST                     
         SP    AMOUNTPS,0(L'JOBPST,RE)   FROM PST POSTINGS                      
         TM    GRPOPT,GRPBILL      GROUP BILLING?                               
         BZ    *+10                NO                                           
         AP    GRPPST,AMOUNTPS                                                  
                                                                                
         BAS   RE,ADD2SUB          ADD POSTING ACCOUNTS TO SUBTAB               
         BRAS  RE,BUILDDB          BUILD THE WORKCODE ELEMENT                   
         BRAS  RE,BUILDDB2         BUILD THE LONG INVOICE ELEMENT               
         EJECT                                                                  
***********************************************************************         
*              POSTING FOR CREDIT TO SJ                               *         
***********************************************************************         
*                                                                               
         MVI   TRNEL,TRNELQ                                                     
         MVI   TRNLN,121                                                        
         MVC   TRNDATE,DATE3                                                    
         MVC   TRNREF,BILLREF                                                   
         MVI   TRNTYPE,6                                                        
         ZAP   TRNAMNT,AMOUNTSJ                                                 
         MVC   TRNANAL,=C'99'                                                   
         MVC   TRNBTCH(2),MOS                                                   
         MVC   TRNNARR(15),BILLNAME                                             
         MVC   TRNQTFLT,QTRNSFLT                                                
*                                                                               
         ZAP   TRNBLCOM,JOBCOM                                                  
         ZAP   TRNBLCD,POSTCD                                                   
         ZAP   TRNBLPAY,TRNAMNT                                                 
         LA    RF,JOBMED+(JOBNET-JOBD)          POST MEMO OF MEDIA              
         ZAP   TRNMDCST,0(L'JOBNET,RF)    COSTS TO NARRATIVE                    
         TM    CLIOPT,PAYNET       PAY=NET?                                     
         BO    *+10                NO                                           
         AP    TRNBLPAY,JOBCOM                                                  
         MVC   TRN2DAY,TODAY2                                                   
         MVC   TRNSK2SI,RECOFF      SAVE OFFICE CODE                            
         AP    TOTBL,TRNAMNT                                                    
         ZAP   TRNRTPCT,=P'0'                                                   
         MVC   TRNBTYPE,BILLCODE                                                
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         BAS   RE,BUILD48                                                       
*                                                                               
         USING PTAELD,RF                                                        
         MVI   PTAEL,PTAELQ        CREATE 77 ELEMENT TO HOLD FORM               
         MVI   PTALN,PTARLN1Q                                                   
         MVC   PTADATE,TODAY2                                                   
         MVI   PTATYPE,PTATRAL                                                  
         MVI   PTASTAT1,PTASCASH                                                
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    *+8                 NO                                           
         OI    PTASTAT1,PTASREVS   YES, MARK THE 77 ACCORDINGLY                 
*                                                                               
         MVC   PTARDATE,TODAY2                                                  
         MVC   PTARBLDT,RCDAY2                                                  
         MVC   PTAMOA,DATE3                                                     
*                                                                               
         MVC   PTARBLNO,BILLREF                                                 
         MVC   PTARCODE,BILLCODE                                                
         MVC   PTARFORM,FORMHOLD                                                
         ZAP   PTANET,AMOUNTSJ                                                  
*                                                                               
         ZAP   PTANETF,=P'0'       THESE FIELDS NOT USED                        
         ZAP   PTACDSC,=P'0'                                                    
         ZAP   PTARCORT,=P'0'                                                   
         ZAP   PTARCOM,=P'0'                                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,PTALN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING DUEELD,RF                                                        
         MVI   DUEEL,DUEELQ      DUE DATE TO JOB POSTING                        
         MVI   DUELN,DUELNQ                                                     
         MVC   DUEDATE,DUE2                                                     
         SR    RE,RE                                                            
         IC    RE,DUELN                                                         
         AR    RF,RE                                                            
*                                                                               
         BAS   RE,BUILD7D                                                       
*                                                                               
         USING PIDELD,RF                                                        
         MVI   PIDEL,PIDELQ        BUILD PID ELEMENT                            
         MVI   PIDLN,PIDLNQ                                                     
         MVC   PIDNO,USERPID                                                    
         SR    RE,RE                                                            
         IC    RE,PIDLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
         CP    SAVEPN,=P'0'                                                     
         BE    POSTSJ02                                                         
*                                                                               
         USING FFTELD,RF                                                        
         MVI   FFTEL,FFTELQ                                                     
         MVI   FFTLN,FFTLN1Q+L'FFTDLEN+L'FFTESTA                                
         MVI   FFTTYPE,FFTTESTP                                                 
         MVI   FFTSEQ,0                                                         
         MVI   FFTDLEN,L'FFTESTA                                                
         ZAP   FFTESTN,SAVEPN                                                   
         ZAP   FFTESTC,SAVEPC                                                   
         SR    RE,RE                                                            
         IC    RE,FFTLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         USING BSCELD,RF                                                        
POSTSJ02 MVI   BSCEL,BSCELQ      SAVE THE BILLING SOURCE                        
         MVI   BSCLN,BSCLNQ                                                     
         MVC   BSCBSRC,MEDNAME+3                                                
*                                                                               
         TM    REQOPT,REQMEDO      FOR MEDIA ONLY?                              
         BZ    *+10                NO                                           
         MVC   BSCBSRC,=CL12'PRINT MEDIA'                                       
         TM    GRPOPT,GRPBILL      IS THIS A GROUP BILLING?                     
         BZ    *+10                NO                                           
         MVC   BSCBSRC,=CL12'PRODUCTION '                                       
         OC    BSCBSRC,SPACES                                                   
         MVC   BSCBOFF,RECOFF                                                   
*                                                                               
         SR    RE,RE                                                            
         IC    RE,BSCLN                                                         
         AR    RF,RE                                                            
*                                                                               
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    POSTSJX             NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
POSTSJX  L     R5,ADACC            FILL IN HEADER FOR NET BILL TO JOB           
         MVC   PSHDACC,0(R5)                                                    
         MVC   PSHDANAL,=C'99'                                                  
         MVC   PSHDSBAC,RECEIVBL                                                
         MVC   PSHDSBNM,CLINAME                                                 
*                                                                               
         USING FFTELD,RE                                                        
         LA    RE,SVDBELM          UPDATE THE FFTEL                             
         MVC   FFTWORK,PSHDANAL                                                 
         ZAP   FFTWAMT,TRNAMNT                                                  
         DROP  RE                                                               
*                                                                               
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
         EJECT                                                                  
***********************************************************************         
*              CREDIT TO INCOME                                       *         
***********************************************************************         
*                                                                               
         ZAP   TRNAMNT,=P'0'                                                    
         TM    CLIOPT,PAYNET       PAY=NET?                                     
         BO    *+10                YES                                          
         ZAP   TRNAMNT,JOBCOM     NO, AMEND FOR THE COMMISSION POSTING          
         ZAP   INCOME,TRNAMNT     SAVE INCOME AMOUNT POSTING                    
         AP    TOTCOMM,TRNAMNT                                                  
         MVC   TRNANAL,UNIT                                                     
         MVI   TRNLN,X'2B'       (SHORTEN NARRATIVE)                            
         MVI   TRNBLCOM,0                                                       
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDACC,INCACC                                                   
         MVC   PSHDSBAC,PRODNUM                                                 
         MVC   PSHDSBNM,PRODNAM                                                 
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    POSTSI00            NO                                           
         MVC   PSHDSBAC,JOBCODE    YES, CONTRA IS STUDIO JOB                    
         MVC   PSHDSBNM,JOBNAME                                                 
*                                                                               
POSTSI00 LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'G'                                                     
*                                                                               
         CLI   PROF25,C'Y'         EXCLUDE TAXES?                               
         BNE   WRTP00              NO                                           
         ZAP   SCIAMNT,JOBGRS                                                   
         LA    RE,JOBMED+(JOBGRS-JOBD)    SUBTRACT MEDIA COSTS                  
         SP    SCIAMNT,0(L'JOBGRS,RE)    MEMO GROSS                             
         B     WRTP01                                                           
*                                                                               
WRTP00   ZAP   SCIAMNT,JOBPGRS                                                  
         LA    RE,JOBMED+(JOBPGRS-JOBD)    SUBTRACT MEDIA COSTS                 
         SP    SCIAMNT,0(L'JOBPGRS,RE)    MEMO GROSS                            
*                                                                               
WRTP01   CLI   PROF8,C'G'          IF GROSS CD OPTION                           
         BNE   WRTP02              MUST SUBTRACT PRODUCTION CD                  
         ZAP   DUB,JOBCD           WHICH IS TOTAL CD                            
         LA    RE,JOBMED+(JOBCD-JOBD)                                           
         SP    DUB,0(L'JOBCD,RE)   MINUS MEDIA CD                               
         SP    SCIAMNT,DUB                                                      
*                                                                               
WRTP02   MVI   SCIAMNT+6,0        MARK END OF RECORD                            
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         SP    SCIAMNT,JOBCOM     GROSS BECOMES NET IN MEMO ITEM                
         CLI   SVZERO,C'Y'         ZERO GROSS BILLINGS?                         
         BNE   WRTP03              NO                                           
         ZAP   SCIAMNT,=P'0'      YES                                           
*                                                                               
WRTP03   SR    RE,RE                                                            
         IC    RE,SCILN          CREATE MEDIA TRANSFER ELEMENT                  
         AR    RF,RE                                                            
*                                                                               
WRTP04   LA    R4,1                SET LEVEL #                                  
         BAS   RE,BUILD50          GST PST DETAILS                              
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            INITIALIZE MEDIA ELEMENT                     
*                                                                               
         ZAP   DUB,JOBINT          FILL IN AMOUNTS                              
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTINTL                                                    
*                                                                               
         ZAP   DUB,AMOUNTSJ                                                     
         CVB   R1,DUB                                                           
         SR    R1,RE                                                            
         STCM  R1,15,MDTNET                                                     
*                                                                               
         ZAP   DUB,AMOUNT12                                                     
         CVB   RE,DUB                                                           
         TM    CLIOPT,PAYNET       PAY = NET OR SNET ?                          
         BO    *+8                 YES, LEAVE INCOME AS ZERO                    
         STCM  RE,15,MDTCOM                                                     
*                                                                               
         ZAP   DUB,AMOUNT11                                                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTGRS                                                     
*                                                                               
         ZAP   DUB,JOBCD                                                        
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCD                                                      
*                                                                               
         ZAP   DUB,AMOUNTSR                                                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTRECV                                                    
*                                                                               
         ZAP   DUB,AMOUNTGS                                                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTVAT                                                     
*                                                                               
         SR    RE,RE                                                            
         IC    RE,MDTLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),X'00'         MARK END OF RECORD                           
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    POSTSI02            NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
POSTSI02 GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
         USING SCIELD,RF                                                        
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE               BYPASS IT FOR NEXT POSTING                   
         MVI   SCIAMNT+6,0                                                      
         EJECT                                                                  
***********************************************************************         
*              PRODUCTION CASH DISCOUNT                               *         
***********************************************************************         
*                                                                               
WRTP05   CLI   PROF8,C'G'                SHOW GROSS CD?                         
         BNE   WRTP08                    NO                                     
         MVC   PSHDACC,CDACCT            PROD CD ACCOUNT                        
         ZAP   TRNAMNT,JOBCD            CASH DISCOUNT                           
         LA    RE,JOBMED+(JOBCD-JOBD)    SUBTRACT MEDIA CD                      
         SP    TRNAMNT,0(L'JOBCD,RE)    FROM TOTAL CD                           
         CP    TRNAMNT,=P'0'                                                    
         BE    WRTP06                                                           
         ZAP   SCIAMNT,=P'0'            MEMO OF ZERO                            
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN          CREATE MEDIA TRANSFER ELEMENT                  
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
                                                                                
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
         EJECT                                                                  
***********************************************************************         
*              PRINT CASH DISCOUNT                                    *         
***********************************************************************         
*                                                                               
WRTP06   MVC   PSHDACC,PRCDACCT           PRINT CD ACCOUNT                      
         LA    RE,JOBMED+(JOBCD-JOBD)     MEDIA CD                              
         ZAP   TRNAMNT,0(L'JOBCD,RE)                                            
         CP    TRNAMNT,=P'0'                                                    
         BE    WRTP08                                                           
         ZAP   SCIAMNT,=P'0'           MEMO OF ZERO                             
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN          CREATE MEDIA TRANSFER ELEMENT                  
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
                                                                                
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
         EJECT                                                                  
***********************************************************************         
*              DEBIT RECEIVABLES                                      *         
***********************************************************************         
*                                                                               
WRTP08   MVC   PSHDSBNM,SPACES                                                  
         OI    TRNSTAT,X'80'      ADJUST FOR THE RECEIVABLE POSTING             
         ZAP   TRNAMNT,AMOUNTSR                                                 
         MVC   TRNANAL,RECOFF     GET RECEIVABLE OFFICE CODE                    
         MVC   PSHDACC,RECEIVBL                                                 
         CLI   PSHDACC,X'40'                                                    
         BH    *+6                                                              
         DC    H'0'                BAD RECEIVABLE CODE                          
*                                                                               
         MVC   PSHDSBAC,MEDNAME                                                 
         TM    REQOPT,REQMEDO      FOR MEDIA ONLY?                              
         BZ    *+10                NO                                           
         MVC   PSHDSBAC(15),=CL15'   PRINT MEDIA'                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING OTHELD,RF                                                        
         MVI   OTHEL,OTHELQ                                                     
         MVI   OTHLN,OTHLN1Q                                                    
         MVC   OTHNUM(13),SPACES                                                
         MVI   OTHPROF,C'J'                                                     
         L     RE,ADACC                                                         
         MVC   OTHNUM,6(RE)                                                     
         SR    RE,RE                                                            
         IC    RE,OTHLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING CPJELD,RF                                                        
         MVI   CPJEL,CPJELQ            TO RECEIVABLE POSTING                    
         MVI   CPJLN,X'17'                                                      
         MVI   CPJTYPE,C'J'                                                     
         MVC   CPJCLI(20),SPACES                                                
         L     RE,ADACC                                                         
         MVC   CPJCLI(3),3(RE)                                                  
         MVC   CPJPRO(3),6(RE)                                                  
         MVC   CPJJOB(6),9(RE)                                                  
         SR    RE,RE                                                            
         IC    RE,CPJLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'D'       CASH DISCOUNT ELEMENT                         
         ZAP   SCIAMNT,POSTCD                                                   
         CLI   PROF8,C'G'                                                       
         BNE   *+10                                                             
         MP    SCIAMNT,=P'-1'                                                   
         CP    SCIAMNT,=P'0'                                                    
         BE    WRTP09              NO 50 IF NO CD                               
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
WRTP09   MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'I'     ADD INCOME ELEMENT TO                           
         ZAP   SCIAMNT,INCOME   RECEIVABLE POSTING                              
         MVI   SCIAMNT+6,0                                                      
         ZIC   RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         LA    R4,1                SET LEVEL NUMBER                             
         BAS   RE,BUILD50          GST/PST DETAILS                              
*                                                                               
         USING DUEELD,RF                                                        
         MVI   DUEEL,DUEELQ                                                     
         MVI   DUELN,DUELNQ                                                     
         MVC   DUEDATE,DUE2                                                     
         SR    RE,RE                                                            
         IC    RE,DUELN                                                         
         AR    RF,RE                                                            
*                                                                               
         TM    GRPOPT,GRPBILL                                                   
         BZ    WRTP10              NOT A GROUP BILL POST RECEIVABLE             
         BAS   RE,ADDGRP           ADD TO GROUP ACCUMS                          
         BAS   RE,ADD2GRP          ADD SUBTAB TO GRPTAB                         
         B     WRTP14              HOLD RECEIVABLE TIL END                      
*                                                                               
         USING MDTELD,RF                                                        
WRTP10   BAS   RE,SET1A            INITIALIZE MEDIA ELEMENT                     
*                                                                               
         ZAP   GRPINT,JOBINT       FUDGE GROUP INTERNAL INCOME                  
         BAS   RE,GRPSUM           POST TO GROUP SUMMARY                        
*                                                                               
         ZAP   DUB,JOBINT          FILL IN AMOUNTS                              
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTINTL                                                    
*                                                                               
         ZAP   DUB,AMOUNTSJ                                                     
         CVB   R1,DUB                                                           
         SR    R1,RE                                                            
         STCM  R1,15,MDTNET                                                     
*                                                                               
         ZAP   DUB,AMOUNT12                                                     
         CVB   RE,DUB                                                           
         TM    CLIOPT,PAYNET       PAY = NET OR SNET ?                          
         BO    *+8                 YES, LEAVE INCOME AS ZERO                    
         STCM  RE,15,MDTCOM                                                     
*                                                                               
         ZAP   DUB,AMOUNT11                                                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTGRS                                                     
*                                                                               
         ZAP   DUB,JOBCD                                                        
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCD                                                      
*                                                                               
         ZAP   DUB,AMOUNTSR                                                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTRECV                                                    
*                                                                               
         ZAP   DUB,AMOUNTGS                                                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTVAT                                                     
*                                                                               
         SR    RE,RE                                                            
         IC    RE,MDTLN                                                         
         AR    RF,RE                                                            
         DROP  R6                                                               
*                                                                               
         USING UFSELD,R5                                                        
         L     R5,AUSRPOOL                                                      
         LA    R6,USRNUM           GET NUMBER OF ENTRIES                        
*                                                                               
WRTP11   CLI   0(R5),X'00'         ANY ENTRIES ?                                
         BE    WRTP13              NO                                           
*                                                                               
         SR    R1,R1                                                            
         IC    R1,UFSLN                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),UFSEL                                                    
         LA    RF,1(RF,R1)                                                      
         LA    R5,1(R5,R1)                                                      
         BCT   R6,WRTP11                                                        
*                                                                               
WRTP13   MVI   0(RF),X'00'         MARK END OF RECORD                           
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    POSTSR00            NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
POSTSR00 GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
         EJECT                                                                  
***********************************************************************         
*              CREDIT COSTING SYSTEM COMMISSION                       *         
***********************************************************************         
*                                                                               
WRTP14   TM    CMPOPT,POSTCOST                                                  
         BZ    WRTP22                                                           
         MVC   TRNANAL,UNIT       USE ACCOUNT LEVEL OFFICE                      
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN          KILL 50 AND 1A ELEMENTS                        
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
         ZAP   TRNAMNT,AMOUNT12                                                 
         MVI   TRNSTAT,0                                                        
         MVC   PSHDACC,SUSPAC                                                   
         MVC   PSHDSBAC,COSTING                                                 
         CLI   COSTING,X'40'                                                    
         BH    *+6                                                              
         DC    H'0'                BAD COSTING CODE                             
         MVC   PSHDSBNM,CLINAME                                                 
                                                                                
         TM    CLIOPT,PAYNET                                                    
         BO    WRTP18                                                           
                                                                                
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
         EJECT                                                                  
***********************************************************************         
*              CREDIT COSTING SYSTEM BILLING                          *         
***********************************************************************         
*                                                                               
WRTP18   MVI   PSHDACC+2,C'1'                                                   
         ZAP   TRNAMNT,AMOUNT11                                                 
         CLI   SVZERO,C'Y'         ZERO BILLINGS AMOUNT?                        
         BNE   *+10                NO                                           
         ZAP   TRNAMNT,=P'0'      YES                                           
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN            REMOVE OLD X'C0'                             
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
         EJECT                                                                  
***********************************************************************         
*              DEBIT COSTING CLIENT W/COMMISSION                      *         
***********************************************************************         
*                                                                               
         ZAP   TRNAMNT,AMOUNT12                                                 
         MVI   TRNSTAT,X'80'                                                    
         MVC   PSHDACC,COSTING                                                  
         MVC   PSHDSBAC,SUSPAC                                                  
         MVC   PSHDSBNM,SPACES                                                  
         MVC   PSHDSBNM(10),=C'PRODUCTION'                                      
         CLC   SUSPAC+3(12),=CL12'3'                                            
         BE    *+10                                                             
         MVC   PSHDSBNM(12),MEDNAME+3                                           
         TM    CLIOPT,PAYNET                                                    
         BO    WRTP20                                                           
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN            REMOVE OLD X'C0'                             
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
                                                                                
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
         EJECT                                                                  
***********************************************************************         
*              DEBIT COSTING CLIENT W/BILLING                         *         
***********************************************************************         
*                                                                               
WRTP20   MVI   PSHDSBAC+2,C'1'                                                  
         ZAP   TRNAMNT,AMOUNT11                                                 
         CLI   SVZERO,C'Y'         ZERO BILLINGS AMOUNT?                        
         BNE   *+10                NO                                           
         ZAP   TRNAMNT,=P'0'      YES                                           
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN            REMOVE OLD X'C0'                             
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
                                                                                
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
         EJECT                                                                  
***********************************************************************         
*              CREDIT TAX ACCOUNT(S)                                  *         
***********************************************************************         
*                                                                               
         USING GSTD,R5                                                          
WRTP22   LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    WRTP32                                                           
*                                                                               
         CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   WRTP32              NOT A GST RECORD                             
         B     WRTP28                                                           
*                                                                               
WRTP26   MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    WRTP32                                                           
*                                                                               
         USING JOBD,R6                                                          
WRTP28   CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    WRTP26              YES, SKIP IT                                 
         OC    GSTACCT,GSTACCT     DO WE HAVE AN ACCOUNT?                       
         BZ    WRTP26              NO, GET NEXT ONE                             
         MVC   PSHDACC,GSTACCT                                                  
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
         MVI   TRNSTAT,X'00'                                                    
         MVC   TRNLN,=YL1(TRNLN1Q+L'BILLNAME)                                   
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST?                          
         BNE   WRTP30              YES                                          
         CP    JOBVBAS,=P'0'       NO, DO WE HAVE ANY BASIS?                    
         BE    WRTP26              NO, GET THE NEXT ONE THEN                    
*                                                                               
WRTP30   ZAP   TRNAMNT,JOBGST                                                   
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'N'                                                     
         ZAP   SCIAMNT,JOBVBAS                                                  
         MVI   SCIAMNT+6,0        END OF RECORD                                 
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
         B     WRTP26                                                           
*                                                                               
         USING PSTD,R5                                                          
WRTP32   LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    WRTP42                                                           
*                                                                               
         CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   WRTP42              NOT A PST RECORD                             
         B     WRTP38                                                           
*                                                                               
WRTP36   MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    WRTP42                                                           
*                                                                               
         USING JOBD,R6                                                          
WRTP38   CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BE    WRTP36              YES, SKIP IT                                 
         OC    PSTACCT,PSTACCT     DO WE HAVE AN ACCOUNT?                       
         BZ    WRTP36              NO, GET NEXT ONE                             
         MVC   PSHDACC,PSTACCT                                                  
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
         MVI   TRNSTAT,X'00'                                                    
         MVC   TRNLN,=YL1(TRNLN1Q+L'BILLNAME)                                   
         LA    R6,PSTACCUM                                                      
         CP    JOBPST,=P'0'        DO WE HAVE ANY PST?                          
         BNE   WRTP40              YES                                          
         CP    JOBPBAS,=P'0'       NO, DO WE HAVE ANY BASIS?                    
         BE    WRTP36              NO, GET THE NEXT ONE THEN                    
*                                                                               
WRTP40   ZAP   TRNAMNT,JOBPST                                                   
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'N'                                                     
         ZAP   SCIAMNT,JOBPBAS                                                  
         MVI   SCIAMNT+6,0        END OF RECORD                                 
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
                                                                                
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
         B     WRTP36                                                           
         EJECT                                                                  
***********************************************************************         
*              ROUTINE TO PUT OUT RETAINER POSTINGS                   *         
***********************************************************************         
*                                                                               
WRTP42   CP    SVASAMT,=P'0'       ANYTHING TO POST?                            
         BE    WRTP52              NO                                           
*                                                                               
         MVI   TRNEL,TRNELQ        DEBIT THE JOB                                
         MVI   TRNLN,121                                                        
         OI    TRNSTAT,X'80'                                                    
         OI    TRNSTAT,X'01'       MAKE NON-COMMISSIONABLE                      
*                                                                               
         MVC   TRNDATE,DATE3                                                    
         ZAP   TRNAMNT,SVASAMT                                                  
*                                                                               
         MVC   TRNREF,BILLREF                                                   
*                                                                               
         MVI   TRNTYPE,8          CREATING TYPE 8'S                             
         MVC   TRNANAL,SVASWRK                                                  
         MVC   TRNBTCH(2),MOS                                                   
*                                                                               
         MVC   TRNNARR(L'RETNARR),RETNARR                                       
*                                                                               
         LA    RF,TRNNARR         GET LENGTH OF TRANSACTION                     
         SR    RF,R2                                                            
         AH    RF,=Y(L'RETNARR)                                                 
         STC   RF,TRNLN                                                         
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING PTAELD,RF                                                        
         XC    PTAEL(PTARLN1Q),PTAEL                                            
         MVI   PTAEL,PTAELQ                                                     
         MVI   PTALN,PTARLN1Q                                                   
         ZAP   PTANET,=P'0'                                                     
         ZAP   PTANETF,=P'0'                                                    
         ZAP   PTACDSC,=P'0'                                                    
         ZAP   PTARCORT,=P'0'                                                   
         ZAP   PTARCOM,=P'0'                                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,PTALN            GET LENGTH                                   
*                                                                               
         CLI   SVASBIL,C'N'        ARE WE BILLING THIS?                         
         BNE   WRTP43              YES                                          
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    WRTP44              NO                                           
         CLI   SVASOBIL,C'N'       WAS OPTION ORIGINALLY TO BILL ASP?           
         BE    WRTP44              NO, THEN LEAVE THIS ONE ALONE                
         CLI   QOPT3,C'Y'          YES, ARE WE REALLOCATING?                    
         BNE   WRTP44              NO                                           
*                                                                               
         MVI   PTATYPE,PTATRAL                                                  
         MVC   PTADATE,TODAY2      UPDATE ELEMENT AS ALLOCATED                  
         MVI   PTASTAT1,PTASPEND                                                
         OI    PTASTAT1,PTASCASH                                                
         ZAP   PTANET,SVASAMT                                                   
         AP    SCIUNET,SVASAMT     ADD TO ALLOCATED SCIEL ALSO                  
*                                                                               
         AR    RF,RE               GET PAST PTA                                 
*                                                                               
         USING TRXELD,RF                                                        
         XC    TRXEL(TRXLN1Q),TRXEL                                             
         MVI   TRXEL,TRXELQ        ADD EXTRA STATUS ELEMEMT                     
         MVI   TRXLN,TRXLN1Q                                                    
         OI    TRXSTA2,TRXSBILP    MARK PENDING ALLOCATION                      
*                                                                               
         SR    RE,RE                                                            
         IC    RE,TRXLN                                                         
*                                                                               
         B     WRTP44                                                           
*                                                                               
         USING PTAELD,RF                                                        
WRTP43   MVC   PTADATE,TODAY2                                                   
         MVI   PTATYPE,PTATRAL                                                  
         MVI   PTASTAT1,PTASCASH                                                
         ZAP   PTANET,SVASAMT                                                   
*                                                                               
         MVC   PTARDATE,TODAY2                                                  
         MVC   PTARBLDT,RCDAY2                                                  
*                                                                               
         MVC   PTARFORM,FORMHOLD                                                
         MVC   PTARTYPE,SVASWTYP   GET THE WORKCODE TYPE                        
*                                                                               
         MVC   PTARBLNO,BILLREF    YES, PUT IN BILL NUMBER AND                  
         MVC   PTARCODE,BILLCODE   BILLING TYPE                                 
         MVC   PTAMOA,DATE3                                                     
*                                                                               
         AR    RF,RE               GET PAST PTA                                 
*                                                                               
         USING TRSELD,RF                                                        
         XC    TRSEL(TRSLNQ),TRSEL                                              
         MVI   TRSEL,TRSELQ        FORMAT STATUS SO ACDTUSED IS SET             
         MVI   TRSLN,TRSLNQ                                                     
         MVC   TRSUDAT,TODAY2                                                   
         SR    RE,RE                                                            
         IC    RE,TRSLN                                                         
*                                                                               
WRTP44   AR    RF,RE                                                            
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         MVC   PSHDACC,JOBCODE                                                  
         MVC   PSHDANAL,SVASWRK                                                 
         MVC   PSHDSBAC,SVASACC                                                 
         MVC   PSHDSBNM,SVASNAM                                                 
                                                                                
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
         MVC   TRNANAL,UNIT                                                     
         NI    TRNSTAT,X'FF'-X'80'                                              
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A                                                         
*                                                                               
         ZAP   DUB,SVASAMT         FILL IN AMOUNTS                              
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTINTL                                                    
         STCM  RE,15,MDTNET                                                     
         STCM  RE,15,MDTGRS                                                     
*                                                                               
         SR    RE,RE                                                            
         IC    RE,MDTLN                                                         
         AR    RF,RE                                                            
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO?                            
         BZ    WRTP45              NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
*                                                                               
WRTP45   CLI   SVASACC+2,C'I'      ONLY DO IF SI                                
         BNE   WRTP46                                                           
         TM    CMPOPT,POSTCOST     MAKE COST POSTINGS?                          
         BZ    WRTP46              NO, SKIP THESE ELEMENTS                      
*                                                                               
         OI    POSTMODE,POSTRET                                                 
         BRAS  RE,BUILDC5                                                       
         NI    POSTMODE,X'FF'-POSTRET                                           
*                                                                               
WRTP46   MVI   0(RF),X'00'         MARK END OF RECORD                           
         MVC   PSHDACC,SVASACC                                                  
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
                                                                                
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
         CLI   SVASACC+2,C'B'      SB ACCOUNT?                                  
         BE    WRTP48              YES, ALL DONE                                
         CLI   SVASACC+2,C'I'      SI ACCOUNT?                                  
         BE    WRTP47              YES, SEE IF POSTING COST                     
         CLI   SVASBIL,C'N'        NO, MUST BE SK. ARE WE BILLING IT?           
         BE    WRTP48              NO, ALL DONE                                 
*                                                                               
         OI    TRNSTAT,X'80'      YES, DEBIT SK/SJ                              
                                                                                
*        BAS   RE,MOVEFFT                                                       
*        BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
         NI    TRNSTAT,X'FF'-X'80'                                              
         MVI   PSHDACC+2,C'I'      CREDIT SI/SJ                                 
                                                                                
*        BAS   RE,MOVEFFT                                                       
*        BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
WRTP47   TM    CMPOPT,POSTCOST     MAKE COST POSTINGS?                          
         BZ    WRTP48              NO, DONE                                     
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             CLEAR OUT ELEMENTS                           
*                                                                               
         MVI   TRNSTAT,0          CREDIT TO 12                                  
         MVC   PSHDACC,SV12ACC                                                  
         MVC   PSHDSBAC,COSTING                                                 
         MVC   PSHDSBNM,CLINAME                                                 
                                                                                
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
         MVI   TRNSTAT,X'80'      DEBIT TO 1C                                   
         MVC   PSHDACC,COSTING                                                  
         MVC   PSHDSBAC,SV12ACC                                                 
         MVC   PSHDSBNM,SV12NAM                                                 
                                                                                
*        BAS   RE,MOVEFFT                                                       
*        BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
         USING RRSD,R4                                                          
WRTP48   XC    RRSWK,RRSWK         CLEAR SORT RECORD                            
         LA    R4,RRSWK                                                         
         LA    R1,RRSLNQ                                                        
         SLL   R1,16                                                            
         ST    R1,RRSLEN                                                        
*                                                                               
         MVI   RRSTYP,RRSEQU                                                    
         L     RF,ADACC                                                         
         MVC   RRSCLI(12),3(RF)                                                 
         MVC   RRSSI,SVASACC+1                                                  
         MVC   RRSWC,SVASWRK                                                    
         ZAP   RRSAMT,SVASAMT                                                   
*                                                                               
         MVC   RRSBILL,SPACES                                                   
         CLI   SVASBIL,C'N'        ARE WE BILLING THIS ITEM?                    
         BE    WRTP50              NO, LEAVE RRSBIL AND RRSBILL ALONE           
         MVI   RRSBIL,C'Y'                                                      
         MVC   RRSBILL(7),SHTBILNO                                              
         OC    USERMC,USERMC                                                    
         BZ    *+10                                                             
         MVC   RRSBILL,LNGBILNO                                                 
*                                                                               
WRTP50   GOTO1 SORTER,DMCB,=C'PUT',RRSWK                                        
         MVI   ALSORT,1                                                         
*                                                                               
WRTP52   B     POSTXIT                                                          
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
*              POST GROUP BILLING                                     *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
         USING PSHEADD,R3                                                       
         USING JOBD,R6                                                          
         USING DUEELD,RF                                                        
PSTGBIL  DS    0H                                                               
         LA    R6,GRPTOT                                                        
         LR    R4,R3                                                            
         LA    RE,AREA             CLEAR TAPE AREA                              
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         MVC   PSHDEL(2),=X'5046'                                               
         SR    R2,R2                                                            
         IC    R2,PSHDLEN                                                       
         LA    R2,0(R2,R3)                                                      
*                                                                               
         MVC   PSHDACC,RECEIVBL                                                 
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDSBNM,SPACES                                                  
         MVC   PSHDSBAC,=CL15'   PRODUCTION'                                    
         TM    REQOPT,REQMEDO      FOR MEDIA ONLY                               
         BZ    *+10            USE SPECIAL CONTRA NAME ON RECEIVABLE            
         MVC   PSHDSBAC(15),=CL15'   PRINT MEDIA'                               
*                                                                               
         MVI   TRNEL,TRNELQ      FILL IN TRANSACTION                            
         MVI   TRNLN,TRNLN1Q                                                    
         MVI   TRNSTAT,X'80'                                                    
         MVC   TRNDATE,DATE3                                                    
         MVC   TRNREF,BILLREF                                                   
         MVI   TRNTYPE,6                                                        
         ZAP   TRNAMNT,GRPSR      TOTAL ALL JOBS                                
         MVC   TRNANAL,RECOFF                                                   
         MVC   TRNBTCH(2),MOS                                                   
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'D'       CASH DISCOUNT ELEMENT                         
         ZAP   SCIAMNT,GRPCD                                                    
         CP    SCIAMNT,=P'0'                                                    
         BE    PSTG02              NO 50 IF NO CD                               
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
PSTG02   MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'I'     ADD INCOME ELEMENT TO                           
         ZAP   SCIAMNT,JOBCOM   RECEIVABLE                                      
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   SCIAMNT,=P'0'    ZERO IF PAY=NET                                 
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         LA    R4,2                SET LEVEL NUMBER                             
         BAS   RE,BUILD50          BUILD GST/PST ELEMENTS                       
*                                                                               
         USING DUEELD,RF                                                        
         MVI   DUEEL,DUEELQ                                                     
         MVI   DUELN,DUELNQ                                                     
         MVC   DUEDATE,DUE2                                                     
         SR    RE,RE                                                            
         IC    RE,DUELN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            INITIALIZE MEDIA ELEMENT                     
         MVC   MDTJOB,=CL6'GROUP' SET NAME TO GROUP                             
         MVI   MDTMED,C' '        CLEAR MEDIA AND DESCRIPTION                   
         MVC   MDTDSCP,SPACES                                                   
         CLI   GRPTYPE,C'P'                                                     
         BE    *+10                IF PRODUCT LEVEL, LEAVE PRODUCT              
         MVC   MDTPRD,SPACES                                                    
*                                                                               
         ZAP   DUB,GRPINT          FILL IN AMOUNTS                              
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTINTL                                                    
*                                                                               
         ZAP   DUB,GRPSJ                                                        
         CVB   R1,DUB                                                           
         SR    R1,RE                                                            
         STCM  R1,15,MDTNET                                                     
*                                                                               
         ZAP   DUB,GRP12                                                        
         CVB   RE,DUB                                                           
         TM    CLIOPT,PAYNET       PAY = NET OR SNET ?                          
         BO    *+8                 YES, LEAVE INCOME AS ZERO                    
         STCM  RE,15,MDTCOM                                                     
*                                                                               
         ZAP   DUB,GRP11                                                        
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTGRS                                                     
*                                                                               
         ZAP   DUB,GRPCD                                                        
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCD                                                      
*                                                                               
         ZAP   DUB,GRPSR                                                        
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTRECV                                                    
*                                                                               
         ZAP   DUB,GRPGST                                                       
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTVAT                                                     
*                                                                               
         SR    RE,RE                                                            
         IC    RE,MDTLN                                                         
         AR    RF,RE                                                            
                                                                                
         GOTO1 BUILDC0,DMCB,(RF),(GRPTABN,AGRPTAB)                              
                                                                                
         BAS   RE,MOVEFFT                                                       
         BAS   RE,MOVEFFT2                                                      
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
         TM    BILLMODE,DRAFT      IS THIS A DRAFT?                             
         BO    PSTGX               YES, DON'T NEED GROUP BILL RECORD            
         BAS   RE,GRPSUM                                                        
*                                                                               
PSTGX    B     POSTXIT                                                          
         DROP  R2,R3,R6,RF                                                      
         EJECT                                                                  
***********************************************************************         
*              ADD GROUP BILL TO GROUP ACCUM                          *         
***********************************************************************         
*                                                                               
ADDGRP   NTR1                                                                   
         LA    R5,GRPTOT                                                        
         LA    R6,JOBPOS                                                        
         LA    R0,JOBBKCNT                                                      
*                                                                               
ADDG02   AP    0(8,R5),0(8,R6)                                                  
         LA    R5,8(R5)                                                         
         LA    R6,8(R6)                                                         
         BCT   R0,ADDG02                                                        
         B     POSTXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              WRITE LAST POSTING FILE RECORD AND CLOSE               *         
***********************************************************************         
*                                                                               
WRITOTAL DS    0H                                                               
         LA    RE,AREA             CLEAR TAPE AREA                              
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    R3,AREA                                                          
         MVC   0(4,R3),=X'00210000'                                             
*                                                                               
         USING PSSUBFD,R3                                                       
         LA    R3,4(R3)            GET PAST HEADER                              
         MVI   PSSBEL,PSSBELQ                                                   
         MVI   PSSBLEN,PSSUBFL                                                  
         MVC   PSSBDESC,=C'PROD. BILLING '                                      
         ZAP   PSSBRECS,TAPECNT+2(6)                                            
         ZAP   PSSBCASH,TAPECASH+2(6)                                           
         BAS   RE,ADDPOST                                                       
         BAS   RE,CLOSPOST                                                      
         CLI   RCFFPARM,C'T'       IS THIS A TEST RUN?                          
         BNE   *+8                 NO                                           
         BAS   RE,KEEPPOST         YES, PUT FILE ON KEEP                        
         B     POSTXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              POST SK/SI REVERSALS                                   *         
***********************************************************************         
*                                                                               
         USING CACELD,R4                                                        
REVERSIT L     R4,ADSUBAC                                                       
         USING CACELD,R4                                                        
         CLC   CACCNT+1(2),=C'SK'                                               
         BE    REVSI02             IF CONTRA SK SWITCH TO SI                    
         B     REVSK                                                            
*              IF ITEM IS FROM JV - DON'T MOVE SK TO SI                         
*                                                                               
REVSI02  L     R2,ADTRANS          GET STATUS                                   
         SH    R2,DATADISP                                                      
         MVI   ELCODE,X'60'                                                     
         BAS   RE,GETEL3                                                        
         BNE   REVSI04                                                          
         USING TRSELD,R2                                                        
         TM    TRSSTAT,X'40'      ITEM FROM JV SKIP IT                          
         BO    POSTXIT                                                          
*                                                                               
REVSI04  MVC   SIAC,SPACES                                                      
         MVC   COMMKEY,SPACES      FIND COSTING CATEGORY IN SI ACCOUNT          
         L     R4,ADSUBAC                                                       
         MVC   COMMKEY(15),CACCNT                                               
         MVI   COMMKEY+2,C'I'                                                   
         MVC   KEYSAVE,COMMKEY                                                  
         L     R2,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)                                                    
         BNE   REVSI10                                                          
         AH    R2,DATADISP                                                      
         LR    RF,R2                                                            
*                                                                               
REVSI06  CLI   0(RF),0                                                          
         BE    REVSI10                                                          
         CLI   0(RF),X'2C'                                                      
         BE    REVSI08A                                                         
         CLI   0(RF),X'30'                                                      
         BE    REVSI08                                                          
*                                                                               
REVSI07  ZIC   R1,1(RF)                                                         
         AR    RF,R1                                                            
         B     REVSI06                                                          
*                                                                               
         USING RSTELD,RF                                                        
REVSI08  MVC   SIAC(L'RSTCOSTG),RSTCOSTG                                        
         B     REVSI08B                                                         
*                                                                               
         USING SPAELD,RF                                                        
REVSI08A CLI   SPATYPE,SPATANAL     IS THIS AN ANALYSIS ACCOUNT?                
         BNE   REVSI07             NO, TRY AGAIN                                
         MVC   SIAC(L'SIAC),SPAAULA                                             
*                                                                               
REVSI08B MVC   COMMKEY+1(41),SPACES                                             
         MVC   COMMKEY+1(2),=C'11' READ ACCOUNT ON 11 FOR NAME                  
         MVC   COMMKEY+3(L'SIAC),SIAC                                           
         MVC   KEYSAVE,COMMKEY                                                  
         L     R2,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)                                                    
         BNE   REVSI10                                                          
         LA    R3,SINM                                                          
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
         USING TRNRECD,R3                                                       
         USING TRNELD,R2                                                        
REVSI10  L     RF,ACOMBUF                                                       
         L     R2,ADTRANS                                                       
         L     R4,ADSUBAC                                                       
         LA    R3,SAVEKEY          RE-BUILD KEY                                 
         XC    SAVEKEY,SAVEKEY                                                  
         MVC   TRNKWORK,TRNANAL                                                 
         MVC   TRNKCULC,CACCNT                                                  
         MVC   TRNKDATE,TRNDATE                                                 
         MVC   TRNKREF(L'TRNKREF+L'TRNKSBR),TRNREF                              
         L     R2,ADACC                                                         
         MVC   TRNKCULA,0(R2)                                                   
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,SAVEKEY,(RF)                          
*                                                                               
         USING PSHEADD,R3                                                       
         LA    RE,AREA             CLEAR TAPE AREA                              
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         LA    R2,74(RE)                                                        
*                                                                               
         L     R4,ADTRANS                                                       
         MVC   PSHDEL(2),=X'5046'                                               
         MVC   PSHDANAL,SPACES     FILL IN THE FIXED VALUES                     
         MVI   TRNEL,TRNELQ                                                     
         MVI   TRNLN,X'1D'                                                      
         MVC   TRNDATE,TRNDATE-TRNELD(R4)                                       
         MVC   TRNREF,TRNREF-TRNELD(R4)                                         
         MVI   TRNSUB,0                                                         
         MVI   TRNTYPE,6                                                        
         MVC   TRNBTCH,SPACES                                                   
         MVC   TRNBTCH(2),MOS                                                   
         ZAP   TRNAMNT,AMOUNT                                                   
         ZIC   RF,1(R4)            USE INCOME ELEMENT FOR REVERSAL              
         LR    R1,R4               POSTING (IF PRESENT)                         
         AR    RF,R1                                                            
         CLI   0(RF),X'50'                                                      
         BNE   REVSI12                                                          
         CLI   2(RF),C'C'                                                       
         BNE   REVSI12                                                          
         ZAP   TRNAMNT,3(6,RF)                                                  
*                                                                               
REVSI12  AP    JOBINT,TRNAMNT     ACUMULATE TOTAL INTERNAL INCOME               
         TM    GRPOPT,GRPBILL      GROUP BILLING?                               
         BZ    *+10                NO                                           
         AP    GRPINT,TRNAMNT     YES, ADD HERE ALSO                            
         MVC   TRNANAL,UNIT                                                     
         MVI   TRNNARR,C' '                                                     
         L     R4,ADSUBAC                                                       
*                                                                               
         MVC   PSHDACC,CACCNT    DEBIT SK ,CONTRA JOB                           
         L     R1,ADACC                                                         
         MVC   PSHDSBAC,0(R1)                                                   
         L     R1,ADACCNAM                                                      
         MVC   PSHDSBNM,SPACES                                                  
         SR    RE,RE                                                            
         IC    RE,1(R1)                                                         
         SH    RE,=H'3'                                                         
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   PSHDSBNM(0),2(R1)                                                
         MVI   TRNSTAT,X'80'                                                    
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
                                                                                
         BAS   RE,ADDSUB2                                                       
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTAPE                                                        
         EJECT                                                                  
***********************************************************************         
*              BUILD RECORD FOR INTERNAL INVOICE REGISTER             *         
***********************************************************************         
*                                                                               
         USING INVRD,R5                                                         
         LA    R5,INVRWK                                                        
         LA    R1,INVRLNQ                                                       
         SLL   R1,16                                                            
         ST    R1,INVRLEN                                                       
         MVI   INVRTYP,INVREQU                                                  
         MVC   INVRCLI(12),PSHDSBAC+3    JOB                                    
         MVC   INVROTH,SAVOTH                                                   
         MVC   INVRACC,PSHDACC+3      SK ACCOUNT                                
         MVC   INVRDTE,TRNDATE                                                  
         MVC   INVRREF,TRNREF                                                   
         ZAP   INVRAMT,TRNAMNT                                                  
         GOTO1 SORTER,DMCB,=C'PUT',(R5)                                         
         MVI   ALSORT,1                                                         
         EJECT                                                                  
***********************************************************************         
*              CREDIT SI ACCOUNT                                      *         
***********************************************************************         
*                                                                               
         MVI   PSHDACC+2,C'I'                                                   
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BO    REVSI14             YES                                          
         MVC   PSHDSBAC,PRODNUM    NO, CONTRA IS PRODUCT                        
         MVC   PSHDSBNM,PRODNAM                                                 
*                                                                               
REVSI14  MVI   TRNSTAT,0                                                        
         MVC   TRNDATE,DATE3      SAME DETAILS AS BILL POSTINGS                 
         MVC   TRNREF,BILLREF                                                   
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'G'                                                     
         ZAP   SCIAMNT,=P'0'                                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         BRAS  RE,BUILDC5          WORKCODE ELEMENT                             
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            INITIALIZE MEDIA ELEMENT                     
         ZAP   DUB,TRNAMNT        FILL IN COMMISSION AMOUNT ONLY                
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCOM                                                     
*                                                                               
         SR    RE,RE                                                            
         IC    RE,MDTLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),X'00'         MARK END OF RECORD                           
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    REVSI16             NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
REVSI16  GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTAPE                                                        
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
*              CREDIT COSTING COMMISSION                              *         
***********************************************************************         
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),X'00'         KILL MEMO AND MEDIA TRNSFER                  
*                                                                               
         TM    CMPOPT,POSTCOST                                                  
         BZ    POSTXIT                                                          
*                                                                               
         MVC   PSHDACC,SUSPAC                                                   
         CLI   SIAC,C' '                                                        
         BE    *+10                                                             
         MVC   PSHDACC+3(L'SIAC),SIAC                                           
         MVC   PSHDSBAC,COSTING    CONTRA A/C CLIENT                            
         MVC   PSHDSBNM,CLINAME                                                 
                                                                                
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
         MVC   PSHDSBAC,PSHDACC                                                 
         MVC   PSHDACC,COSTING                                                  
         MVC   PSHDSBNM,SPACES                                                  
         MVC   PSHDSBNM(10),=C'PRODUCTION'                                      
         CLI   SIAC,C' '                                                        
         BE    *+10                                                             
         MVC   PSHDSBNM,SINM                                                    
         MVI   TRNSTAT,X'80'                                                    
                                                                                
         BAS   RE,PUTAPE                                                        
         B     POSTXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              REVERSE SK POSTING FOR TYPE 49 AND TRANSFER            *         
***********************************************************************         
*                                                                               
REVSK    MVC   SAVEKEY,SPACES                                                   
         MVC   CONTRA,CACCNT     SAVE THE CONTRA FOR X'C0' POSTING              
         L     R2,ADTRANS                                                       
         SH    R2,DATADISP                                                      
         MVC   SAVEKEY,0(R2)       SAVE TRANASCATION KEY                        
         MVC   SKACCT,INCACC       CONTRA IS COMMISSION/INCOME ACCOUNT          
         MVC   SKACCTN,SPACES                                                   
         L     R2,ADTRANS                                                       
         LR    RF,R2                                                            
*                                                                               
REVSK02  ZIC   R0,1(RF)            GET SK ACCOUNT                               
         AR    RF,R0                                                            
         CLI   0(RF),0                                                          
         BE    REVSK04                                                          
         CLI   0(RF),X'4C'                                                      
         BNE   REVSK02                                                          
*                                                                               
         MVC   SKACCT+1(14),SPACES                                              
         ZIC   R1,1(RF)            FOUND SPDELD ELEMENT                         
         SH    R1,=H'3'                                                         
         EX    R1,*+8                                                           
         B     REVSK04                                                          
         MVC   SKACCT+1(0),SPDACCS-SPDELD(RF) REAL SK ACCOUNT                   
*                                                                               
REVSK04  CLC   SKACCT+1(2),=C'SK'                                               
         BNE   REVSKX              NO SK -  JUST GET OUT                        
         MVC   XTRACST,SPACES                                                   
         L     R2,ACOMBUF          GET SK ACCOUNT NAME                          
         MVC   0(42,R2),SPACES                                                  
         MVC   0(15,R2),SKACCT                                                  
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R2),(R2)                             
         CLC   0(15,R2),SKACCT                                                  
         BNE   REVSK06                                                          
         LA    R3,SKACCTN                                                       
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
REVSK06  MVC   SIACCT,SKACCT       GET SI ACCOUNT NAME                          
         MVI   SIACCT+2,C'I'                                                    
         MVC   SIACCTN,SPACES                                                   
         L     R2,ACOMBUF                                                       
         MVC   0(42,R2),SPACES                                                  
         MVC   0(15,R2),SIACCT                                                  
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R2),(R2)                             
         CLC   0(15,R2),SIACCT                                                  
         BNE   REVSK10                                                          
         LA    R3,SIACCTN                                                       
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
         LR    RF,R2                                                            
         AH    RF,DATADISP                                                      
*                                                                               
REVSK08  CLI   0(RF),0             GET COSTING BYTE                             
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(RF),X'2C'                                                      
         BE    REVSK11                                                          
         CLI   0(RF),X'30'                                                      
         BE    REVSK10                                                          
*                                                                               
REVSK09  ZIC   RE,1(RF)                                                         
         AR    RF,RE                                                            
         B     REVSK08                                                          
*                                                                               
         USING RSTELD,RF                                                        
REVSK10  MVC   XTRACST(L'RSTCOSTG),RSTCOSTG                                     
         B     REVSK11A                                                         
*                                                                               
         USING SPAELD,RF                                                        
REVSK11  CLI   SPATYPE,SPATANAL                                                 
         BNE   REVSK09                                                          
         MVC   XTRACST(L'XTRACST),SPAAULA                                       
*                                                                               
REVSK11A L     R2,ACOMBUF                                                       
         MVC   0(42,R2),SPACES                                                  
         MVC   0(1,R2),RCCOMPFL                                                 
         MVC   1(2,R2),=C'11'      READ ACCOUNTS IN 11/12 & SAVE NAMES          
         MVC   3(L'XTRACST,R2),XTRACST                                          
         MVC   XTRA1,0(R2)                                                      
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R2),(R2)                             
         CLC   0(15,R2),XTRA1                                                   
         BNE   REVSK12                                                          
*                                                                               
         LA    R3,XTRA1N                                                        
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
REVSK12  MVC   XTRA2,XTRA1                                                      
         MVI   XTRA2+2,C'2'                                                     
         MVC   0(42,R2),SPACES                                                  
         MVC   0(15,R2),XTRA2                                                   
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R2),(R2)                             
         CLC   0(15,R2),XTRA2                                                   
         BNE   REVSK14                                                          
         LA    R3,XTRA2N                                                        
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
REVSK14  LA    RE,AREA             CLEAR TAPE AREA                              
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         LA    R2,74(RE)                                                        
         USING PSHEADD,R3                                                       
         MVC   PSHDEL(2),=X'5046'                                               
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDACC,SIACCT      CREDIT SI                                    
         MVC   PSHDSBNM,SIACCTN                                                 
         MVC   PSHDSBAC,JOBCODE    CONTRA JOB                                   
         MVC   PSHDSBNM,JOBNAME                                                 
         USING TRNELD,R2                                                        
         MVI   TRNEL,TRNELQ                                                     
         MVI   TRNLN,TRNLN1Q                                                    
         MVC   TRNDATE,DATE3                                                    
         MVC   TRNREF,BILLREF                                                   
         MVI   TRNSUB,0                                                         
         MVI   TRNTYPE,6                                                        
         MVI   TRNSTAT,0          CREDIT                                        
         L     R4,ADTRANS                                                       
         TM    TRNSTAT-TRNELD(R4),X'01'       NON-COMMISSIONABLE                
         BZ    *+8                                                              
         OI    TRNSTAT,X'01'                                                    
         MVC   TRNBTCH,SPACES                                                   
         MVC   TRNBTCH(2),MOS                                                   
         MVC   TRNANAL,UNIT                                                     
         MVI   TRNNARR,C' '                                                     
         ZAP   TRNAMNT,AMOUNT                                                   
         AP    JOBINT,TRNAMNT                                                   
         TM    GRPOPT,GRPBILL      GROUP BILLING?                               
         BZ    *+10                NO                                           
         AP    GRPINT,TRNAMNT     YES, ADD HERE ALSO                            
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'G'                                                     
         ZAP   SCIAMNT,=P'0'                                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         BRAS  RE,BUILDC5          WORKCODE ELEMENT                             
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            INITIALIZE MEDIA ELEMENT                     
         ZAP   DUB,TRNAMNT        FILL IN COMMISSION AMOUNT ONLY                
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCOM                                                     
*                                                                               
         SR    RE,RE                                                            
         IC    RE,MDTLN                                                         
         AR    RF,RE                                                            
*                                                                               
         MVI   0(RF),X'00'         MARK END OF RECORD                           
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    REVSK16             NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
REVSK16  BAS   RE,ADDSUB3                                                       
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTAPE                                                        
         DROP  RF                                                               
*                                                                               
         LR    RF,R2               REMOVE 50 AND 1A ELEMENTS                    
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
         MVC   PSHDACC,SKACCT      DEBIT SK ACCOUNT                             
         MVC   PSHDSBNM,SKACCTN                                                 
         L     R4,ADTRANS                                                       
         MVC   TRNDATE,TRNDATE-TRNELD(R4)   SAVE DATE/REV/ETC                   
         MVC   TRNREF,TRNREF-TRNELD(R4)                                         
         OI    TRNSTAT,X'80'                                                    
                                                                                
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
*                                  COSTING POSTINGS                             
*                                                                               
         TM    CMPOPT,POSTCOST                                                  
         BZ    REVSK18             NO COSTING                                   
         MVC   TRNDATE,DATE3                                                    
         MVC   TRNREF,BILLREF                                                   
         MVI   TRNSTAT,X'80'      DEBIT 1C CONTRA 12                            
         MVC   PSHDACC,COSTING                                                  
         MVC   PSHDSBAC,XTRA2                                                   
         MVC   PSHDSBNM,XTRA2N                                                  
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
                                                                                
         GOTO1 BUILDC0,DMCB,(RF),(SUBTABN,ASUBTAB)                              
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
         MVI   TRNSTAT,X'00'      CREDIT 12 CONTRA 1C                           
         MVC   PSHDACC,XTRA2                                                    
         MVC   PSHDSBAC,COSTING                                                 
         MVC   PSHDSBNM,CLINAME                                                 
                                                                                
         BAS   RE,PUTAPE                                                        
*                                                                               
         USING ACTRECD,R3                                                       
REVSK18  L     R3,ACOMBUF                                                       
         MVC   ACTKEY(42),SAVEKEY  RESTORE KEY                                  
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R3),(R3)                             
*                                                                               
REVSKX   XC    CONTRA,CONTRA       CLEAR CONTRA                                 
         B     POSTXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              ROUTINE TO REVERSE ESTIMATED PRODUCTION                *         
***********************************************************************         
*                                                                               
REVEP    LA    RE,AREA             CLEAR TAPE AREA                              
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         LA    R2,74(RE)                                                        
         USING PSHEADD,R3                                                       
         MVC   PSHDEL(2),=X'5046'                                               
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDSBNM,SPACES                                                  
         MVC   PSHDACC,JOBCODE     DEBIT JOB                                    
         L     R4,ADSUBAC                                                       
         USING CACELD,R4                                                        
         MVC   PSHDSBAC,CACCNT   SAME CONTRA                                    
         ZIC   R1,CACLN                                                         
         SH    R1,=H'18'                                                        
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   PSHDSBNM(0),CACNAME                                              
*                                                                               
         USING TRNELD,R2                                                        
         MVI   TRNEL,TRNELQ                                                     
*                                                                               
         LA    R1,TRNNARR        MOVE IN STANDARD NARRATIVE                     
         MVC   0(L'EPRCMT,R1),EPRCMT                                            
         LA    R1,L'EPRCMT(R1)                                                  
         MVI   0(R1),C' '                                                       
*                                                                               
         L     R4,ADTRANS          NOW MOVE IN CUSTOM NARRATIVE                 
         SR    RF,RF                                                            
         IC    RF,1(R4)            GET ACTUAL TRANSACTION LENGTH                
         SH    RF,=YL2(TRNLN1Q)    LESS STANDARD TRANSACTION LENGTH             
         SH    RF,=YL2(L'EPCMT)    LESS STANDARD NARRATIVE                      
         BZ    REVEP00                                                          
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),TRNNARR-TRNELD+L'EPCMT(R4)                               
*                                                                               
REVEP00  AH    RF,=YL2(L'EPRCMT)                                                
         LA    R1,TRNLN1Q          TRANSACTION LENGTH                           
         LA    R1,1(R1,RF)          PLUS COMMENT, PLUS 1                        
         STC   R1,TRNLN            IS ELEMENT LENGTH                            
*                                                                               
         MVC   TRNDATE,TRNDATE-TRNELD(R4)   SAVE DATE/REV/ETC                   
         MVC   TRNREF,TRNREF-TRNELD(R4)                                         
         MVI   TRNSUB,0                                                         
         MVI   TRNTYPE,EPRTYPE    REVERSE TYPE                                  
         MVI   TRNSTAT,X'80'      DEBIT                                         
         TM    TRNSTAT-TRNELD(R4),X'01'       NON-COMMISSIONABLE                
         BZ    *+8                                                              
         OI    TRNSTAT,X'01'                                                    
         MVC   TRNBTCH,SPACES                                                   
         MVC   TRNBTCH(2),MOS                                                   
         MVC   TRNANAL,TRNANAL-TRNELD(R4)                                       
         MVC   PSHDANAL,TRNANAL                                                 
         ZAP   TRNAMNT,AMOUNT                                                   
         MP    TRNAMNT,=P'-1'     MINUS                                         
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         BAS   RE,PUTAPE                                                        
*                                                                               
         MVC   PSHDACC,PSHDSBAC    CREDIT THE CONTRA                            
         MVC   PSHDSBAC,PRDCODE                                                 
         MVC   PSHDSBNM,PRDNAME                                                 
         MVC   PSHDANAL,SPACES                                                  
         MVI   TRNSTAT,X'00'                                                    
         MVC   TRNANAL,UNIT                                                     
*                                                                               
*              CREDIT WAS TO CASH ACCOUNT                                       
*              REVERSAL MUST ALSO GO TO CASH                                    
*                                                                               
REVEP02  ZIC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         CLI   0(R4),X'4C'                                                      
         BE    REVEP04                                                          
         CLI   0(R4),0                                                          
         BE    REVEP06                                                          
         B     REVEP02                                                          
*                                                                               
         USING SPDELD,R4                                                        
REVEP04  MVC   PSHDACC+1(14),SPACES                                             
         ZIC   R1,SPDLN                                                         
         SH    R1,=H'3'                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   PSHDACC+1(0),SPDACCS                                             
*                                                                               
REVEP06  BAS   RE,PUTAPE                                                        
         B     POSTXIT                                                          
*                                                                               
EPRCMT   DC    C'**AUTO REVERSE E.P.'                                           
EPCMT    DC    C'**ESTIMATED PRODUCTION'                                        
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
*              MAKE INTERCOMPANY POSTINGS                                       
*              PUT RECORDS TO SORTER FOR END-OF-JOB REPORT                      
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
         USING BIND,R5                                                          
PSTINTER DS    0H                                                               
         L     R5,AWRKTAB                                                       
         L     R4,BININ                                                         
         LTR   R4,R4                                                            
         BZ    PSTINTX             NOTHING IN TABLE, NO POSTINGS                
         LA    R5,BINTABLE                                                      
*                                                                               
         LA    RE,AREA             CLEAR POSTING AREA                           
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         MVC   PSHDEL(2),=X'5046'                                               
         SR    R2,R2                                                            
         IC    R2,PSHDLEN                                                       
         LA    R2,0(R2,R3)                                                      
*                                                                               
         CLI   SVAGHOLD,C'Y'       ARE WE HOLDING POSTINGS?                     
         BNE   *+8                 NO                                           
         MVI   TRNSTAT,X'04'      YES                                           
*                                                                               
         USING WRKD,R5                                                          
         USING JOBD,R6                                                          
PSTI02   LA    R6,WRKACCUM                                                      
         CLI   WRKCDE,X'FF'                                                     
         BE    PSTI06              MAKE CREDIT POSTING/SEND TO SORT             
*                                                                               
         ZAP   TRNAMNT,JOBPGRS                                                  
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   TRNAMNT,JOBPNET                                                  
*                                                                               
         MVI   TRNEL,TRNELQ      DEBIT TO AGENCY JOB                            
         MVI   TRNLN,121                                                        
         OI    TRNSTAT,X'80'                                                    
         MVC   TRNDATE,DATE3                                                    
*                                                                               
         MVC   TRNREF,BILLREF                                                   
         MVI   TRNTYPE,63         NEW BATCH TYPE                                
         MVC   TRNANAL,WRKCDE     AGENCY WORKCODE                               
         MVC   TRNBTCH(2),MOS                                                   
*                                                                               
         MVC   TRNNARR,SPACES     NARRATIVE IS STUDIO JOB                       
         MVC   TRNNARR(2),=C'**'                                                
         MVC   TRNNARR+2(L'SVSTUD),SVSTUD                                       
         MVI   TRNNARR+2+L'SVSTUD,C'/'                                          
         MVC   TRNNARR+2+L'SVSTUD+1(L'JOBCODE-3),JOBCODE+3                      
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         OC    SVICR,SVICR         DO WE HAVE AN INTERCOMPANY CREDIT?           
         BZ    PSTI04              NO                                           
*                                                                               
         USING SPDELD,RF                                                        
         LR    R6,RF               SAVE RF                                      
         MVI   SPDEL,SPDELQ      YES, PASS IT ALONG                             
         MVC   SPDACCS(80),SPACES                                               
         MVC   SPDACCS(14),SVICR+1                                              
         GOTO1 SQUASHER,DMCB,SPDACCS,80                                         
         LR    RF,R6               RESTORE RF                                   
         SR    R1,R1                                                            
         IC    R1,DMCB+7                                                        
         LA    R1,2(R1)                                                         
         STC   R1,SPDLN                                                         
         AR    RF,R1                                                            
*                                                                               
PSTI04   TM    TRNSTAT,X'04'       IS THIS HELD?                                
         BZ    PSTI05              NO                                           
*                                                                               
         USING GDAELD,RF                                                        
         MVI   GDAEL,GDAELQ        YES, ADD ELEMENT WITH DATE                   
         MVI   GDALN,GDALNQ                                                     
         MVI   GDATYPE,GDATBHLD                                                 
         MVC   GDADATE,TODAYP                                                   
*                                                                               
         SR    RE,RE                                                            
         IC    RE,GDALN                                                         
         AR    RF,RE                                                            
*                                                                               
PSTI05   MVI   0(RF),0             MARK END OF RECORD                           
         MVC   PSHDACC,SVAGKEY                                                  
         MVC   PSHDANAL,WRKCDE                                                  
         MVC   PSHDSBAC,SVVEND                                                  
         MVC   PSHDSBNM,SVVENDN                                                 
*                                                                               
         BAS   RE,PUTAPE                                                        
*                                                                               
         LA    R5,WRKLNQ(R5)                                                    
         BCT   R4,PSTI02                                                        
         B     PSTINTX                                                          
*                                                                               
PSTI06   MVI   TRNLN,X'1D'       ELIMINATE THE NARRATIVE                        
         MVC   TRNNARR,SPACES                                                   
         MVC   TRNANAL,SVAGOFF                                                  
         NI    TRNSTAT,X'FF'-X'80'-X'04'   MAKE CREDIT AND UNHOLD               
*                                                                               
         ZAP   TRNAMNT,JOBPGRS                                                  
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   TRNAMNT,JOBPNET                                                  
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN            ADD LINK ELEMENT                             
         AR    RF,RE                                                            
*                                                                               
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         MVC   PSHDACC,SVICR                                                    
         OC    SVICR,SVICR         DO WE HAVE AN OVERRIDE?                      
         BNZ   *+10                YES                                          
         MVC   PSHDACC,SVVEND      NO, USE VENDOR THEN                          
*                                                                               
         MVC   PSHDANAL,SPACES                                                  
*                                                                               
         MVC   PSHDSBAC,JOBCODE    CONTRA IS STUDIO JOB FOR SB                  
         MVC   PSHDSBNM,JOBNAME                                                 
         CLC   PSHDACC+1(2),=C'SB'                                              
         BE    PSTI08                                                           
*                                                                               
         MVC   PSHDSBAC,SVAGKEY    CONTRA IS AGENCY JOB FOR SC                  
         MVC   PSHDSBNM,SVAGACN                                                 
         CLC   PSHDACC+1(2),=C'SC'                                              
         BE    PSTI10                                                           
*                                                                               
         MVC   PSHDSBAC,SPACES     CONTRA IS AGENCY CLIENT FOR                  
         MVC   PSHDSBAC(6),SVAGKEY   ALL OTHERS, EXCEPT SR                      
         MVC   PSHDSBNM,SVAGCLIN                                                
         CLC   PSHDACC+1(2),=C'SR'                                              
         BNE   PSTI10                                                           
*                                                                               
         MVC   PSHDSBAC,MEDNAME    CONTRA IS BILLING SOURCE FOR SR              
         MVC   PSHDSBNM,SPACES                                                  
*                                                                               
PSTI08   OI    TRNSTAT,X'80'       AMOUNT IS A MINUS DEBIT FOR SR/SB            
         MP    TRNAMNT,=P'-1'                                                   
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            INITIALIZE MEDIA ELEMENT                     
         ZAP   DUB,TRNAMNT        FILL IN COMMISSION AMOUNT                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTGRS                                                     
         STCM  RE,15,MDTNET                                                     
         STCM  RE,15,MDTRECV                                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,MDTLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
PSTI10   BAS   RE,PUTAPE                                                        
*                                                                               
         USING INTD,R5                                                          
         L     R5,AINTRWK          GENERATE SORT RECORD FOR REPORT              
         LA    R1,INTRLNQ                                                       
         SLL   R1,16                                                            
         ST    R1,INTRLN                                                        
*                                                                               
         MVI   INTRTYP,INTREQU                                                  
         MVC   INTRSTUD,SVSTUD     STUDIO TYPE                                  
         MVC   INTRMED,JOBLET      MEDIA CODE                                   
         MVC   INTRSACC,JOBCODE+3  STUDIO JOB                                   
*                                                                               
         MVC   INTRDATE,DATE3      DATE                                         
         MVC   INTRAJOB,SVAGACC    AGENCY JOB                                   
         MVC   INTRCACC,PSHDACC+1                                               
*                                                                               
         MVC   INTRBILL(7),SHTBILNO                                             
         OC    USERMC,USERMC       BILL NUMBER                                  
         BZ    *+10                                                             
         MVC   INTRBILL,LNGBILNO                                                
*                                                                               
         ZAP   INTRAMT,JOBPGRS     AMOUNT                                       
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   INTRAMT,JOBPNET                                                  
*                                                                               
         GOTO1 SORTER,DMCB,=C'PUT',(R5)                                         
         MVI   ALSORT,1                                                         
*                                                                               
PSTINTX  B     POSTXIT                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              ROUTINE TO WRITE WORKER RECORDS AND TRAILER            *         
***********************************************************************         
*                                                                               
PUTAPE   NTR1                                                                   
         CLC   PSHDACC+1(2),=C'SI' ALWAYS DO IT FOR INCOME                      
         BE    PUTA02                                                           
         CLC   PSHDACC+1(2),=C'SJ'  AND PRODUCTION                              
         BE    PUTA02                                                           
         CLC   PSHDACC+1(2),TAXUL   AND GST/PST                                 
         BE    PUTA02                                                           
         CLC   PSHDACC+1(2),=C'1C'  AND 1C                                      
         BE    PUTA02                                                           
         CLC   PSHDACC+1(2),=C'12'  AND 12                                      
         BE    PUTA02                                                           
         CLC   PSHDACC+1(2),=C'11'  AND 11                                      
         BE    PUTA02                                                           
         CLC   PSHDACC+1(2),=C'SR'  AND SR                                      
         BE    PUTA02                                                           
         CP    TRNAMNT,=P'0'      DONT WRITE ZERO POSTINGS                      
         BE    POSTXIT                                                          
                                                                                
PUTA02   TM    TRNSTAT,X'80'                                                    
         BZ    *+10                                                             
         AP    TAPECASH,TRNAMNT                                                 
         AP    TAPECNT,=P'1'                                                    
         SR    R3,R3                                                            
         IC    R3,1(R2)                                                         
*                                                                               
PUTA04   AR    R2,R3                                                            
         CLI   0(R2),0                                                          
         BE    PUTA06                                                           
         IC    R3,1(R2)                                                         
         LTR   R3,R3               CHECK ZERO LENGTH ELEMENT                    
         BNZ   PUTA04                                                           
         MVI   0(R2),0                                                          
*                                                                               
PUTA06   LA    R2,1(R2)                                                         
         LA    R3,AREA                                                          
         SR    R2,R3                                                            
         STH   R2,AREA                                                          
         BAS   RE,ADDPOST                                                       
         B     POSTXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              FORMAT THE MEDIA TRANSFER ELEMENT                      *         
***********************************************************************         
*                                                                               
         USING JOBD,R6                                                          
         USING MDTELD,RF                                                        
SET1A    XC    MDTEL(MDTLNQ),MDTEL                                              
         MVI   MDTEL,MDTELQ                                                     
         MVI   MDTLN,MDTLNQ                                                     
         MVI   MDTSYS,C'J'                                                      
         MVC   MDTMOS,DATE3                                                     
         MVC   MDTFDTE,FRDAT2                                                   
         MVC   MDTTDTE,TODAT2                                                   
         MVC   MDTCLI,CLICODE+3                                                 
         MVC   MDTPRD,PRDCODE+6                                                 
         MVC   MDTJOB,JOBCODE+9                                                 
         MVC   MDTMED,JOBCODE+9                                                 
         MVC   MDTDSCP,JOBNAME                                                  
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZR   RE                  NO, OK TO EXIT                               
         MVC   MDTCLI,SVAGCLI     YES, USE AGENCY DATA                          
         MVC   MDTPRD,SVAGPRO                                                   
         MVC   MDTJOB,SVAGJOB                                                   
         MVC   MDTMED,SVAGJOB                                                   
         MVC   MDTDSCP,SVAGACN                                                  
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*              ADD EACH POSTING ACCOUNT TO SUBTAB                     *         
***********************************************************************         
*                                                                               
ADD2SUB  NTR1                                                                   
         L     RE,ASUBTAB         CLEAR SUBTAB                                  
         LA    RF,(SUBTABL*SUBTABM)                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         MVI   SUBTABN,0           CLEAR SUBTAB COUNTER                         
                                                                                
         L     R1,ADACC            GET JOB FIRST                                
         MVI   BYTE,0                                                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
         LA    R1,INCACC           COMMISSION ACCOUNT                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVI   BYTE,X'80'                                                       
         LA    R1,RECEIVBL         RECEIVABLE                                   
         BRAS  RE,ADD2TAB                                                       
                                                                                
         LA    R1,COSTING          COSTING                                      
         TM    CMPOPT,POSTCOST                                                  
         BZ    ADD2SUB4                                                         
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVI   BYTE,0                                                           
         LA    R1,SUSPAC           SUSPENSE                                     
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVC   WORK,SPACES                                                      
         MVC   WORK(L'SUSPAC),SUSPAC                                            
         MVI   WORK+2,C'1'                                                      
         LA    R1,WORK                                                          
         BRAS  RE,ADD2TAB                                                       
                                                                                
ADD2SUB4 LA    R1,CDACCT                                                        
         CLI   PROF9,C'G'          GROSS CD OPTION ?                            
         BNE   ADD2SUB6            NO                                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
ADD2SUB6 BRAS  RE,ADDTAX           ADD GST/PST, IF ANY                          
                                                                                
ADD2SUBX XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*              ADD CONTRA SK FLIP TO SUB-ACCOUNT TABLE                *         
***********************************************************************         
*                                                                               
ADDSUB2  NTR1                                                                   
         L     RE,ASUBTAB          CLEAR SUBTAB                                 
         LA    RF,(SUBTABL*SUBTABM)                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         MVI   SUBTABN,0           CLEAR SUBTAB COUNTER                         
                                                                                
         LA    R1,PSHDACC          SK FIRST                                     
         MVI   BYTE,X'80'                                                       
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVC   WORK,SPACES         SI NEXT                                      
         MVC   WORK(L'ACTKULA),PSHDACC                                          
         MVI   WORK+2,C'I'                                                      
         MVI   BYTE,0                                                           
         LA    R1,WORK                                                          
         BRAS  RE,ADD2TAB                                                       
                                                                                
         TM    CMPOPT,POSTCOST                                                  
         BZ    ADDSUB2X                                                         
         LA    R1,COSTING          COSTING                                      
         MVI   BYTE,X'80'                                                       
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVC   WORK,SPACES         SUSPENSE                                     
         MVC   WORK(L'ACTKULA),SUSPAC                                           
         LA    R1,SUSPAC                                                        
         CLI   SIAC,C' '                                                        
         BE    *+10                                                             
         MVC   WORK+3(L'SIAC),SIAC                                              
         LA    R1,WORK                                                          
         MVI   BYTE,0                                                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
ADDSUB2X XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*              ADD TYPE 49 OR TRANSFER FILP TO SUB-ACCOUNT TABLE      *         
***********************************************************************         
*                                                                               
ADDSUB3  NTR1                                                                   
         L     RE,ASUBTAB          CLEAR SUBTAB                                 
         LA    RF,(SUBTABL*SUBTABM)                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         MVI   SUBTABN,0           CLEAR SUBTAB COUNTER                         
                                                                                
         LA    R1,SKACCT           SK FIRST                                     
         MVI   BYTE,X'80'                                                       
         BRAS  RE,ADD2TAB                                                       
                                                                                
         LA    R1,SIACCT           SI NEXT                                      
         MVI   BYTE,0                                                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
         TM    CMPOPT,POSTCOST                                                  
         BZ    ADDSUB3X                                                         
         LA    R1,COSTING          COSTING                                      
         MVI   BYTE,X'80'                                                       
         BRAS  RE,ADD2TAB                                                       
                                                                                
         LA    R1,XTRA2            SUSPENSE                                     
         MVI   BYTE,0                                                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
ADDSUB3X XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*              ADD SUBTAB ENTRIES TO GRPTAB                           *         
***********************************************************************         
*                                                                               
         USING SUBTABD,R1                                                       
ADD2GRP  NTR1                                                                   
         L     R1,ASUBTAB            R1=A(TABLE OF PRIMARY ACCOUNTS)            
         SR    R0,R0                                                            
         ICM   R0,1,SUBTABN          R0=NUMBER OF SUBTAB ENTRIES                
                                                                                
GTAB     USING SUBTABD,RF                                                       
ADD2GRP1 L     RF,AGRPTAB            RF=A(TABLE OF ACCOUNTS FOR GROUP)          
         LHI   R2,GRPTABM            R2=MAXIMUN # IF GRPTAB ENTRIES             
                                                                                
ADD2GRP2 CLC   GTAB.SUBSTA,SUBSTA    DO WE ALREADY HAVE THIS ENTRY?             
         BNE   ADD2GRP4              NO, CHECK NEXT GRPTAB                      
         CLC   GTAB.SUBACC,SUBACC                                               
         BE    ADD2GRP8              YES, GET NEXT SUBTAB                       
                                                                                
ADD2GRP4 AHI   RF,SUBTABL            GET NEXT GRPTAB                            
         BCT   R2,ADD2GRP2                                                      
                                                                                
         L     RF,AGRPTAB            NOT IN GRPTAB                              
         LHI   R2,GRPTABM            STARTING LOOKING FOR SPACE                 
                                                                                
ADD2GRP7 OC    0(SUBTABL,RF),0(RF)   DO WE HAVE A VACANT                        
         BZ    ADD2GRP6              YES                                        
         AHI   RF,SUBTABL                                                       
         BCT   R2,ADD2GRP7                                                      
         B     ADD2GRPX                                                         
                                                                                
ADD2GRP6 MVC   GTAB.SUBSTA,SUBSTA                                               
         MVC   GTAB.SUBACC,SUBACC                                               
         IC    RF,GRPTABN          INCREMENT NUMBER OF TABLE ENTRIES            
         AHI   RF,1                                                             
         STC   RF,GRPTABN                                                       
                                                                                
ADD2GRP8 AHI   R1,SUBTABL          GET NEXT SUBTAB ENTRY                        
         BCT   R0,ADD2GRP1                                                      
         B     ADD2GRPX                                                         
                                                                                
ADD2GRPX XIT1                                                                   
         DROP  R1,GTAB                                                          
         EJECT                                                                  
***********************************************************************         
*              MOVE THE WORKCODE/AMOUNT ELEMENT IN                    *         
***********************************************************************         
*                                                                               
MOVEFFT  MVC   0(L'SVDBELM,RF),SVDBELM                                          
         AHI   RF,L'SVDBELM                                                     
         BR    RE                                                               
*                                                                               
MOVEFFT2 MVC   0(L'SVDBELM2,RF),SVDBELM2                                        
         AHI   RF,L'SVDBELM2                                                    
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT THE GST ELEMENT                                 *         
***********************************************************************         
*                                                                               
*              BUILD X'48' ELEMENTS                                             
*                                                                               
         USING VBIEL,R2                                                         
         USING GSTD,R5                                                          
BUILD48  NTR1                                                                   
         LR    R2,RF                                                            
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    BUILDX                                                           
         B     BUILD04                                                          
*                                                                               
BUILD02  MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    BUILDX                                                           
*                                                                               
         USING JOBD,R6                                                          
BUILD04  CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   BUILDX              NOT A GST RECORD                             
         CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    BUILD02             YES, SKIP IT                                 
         XC    VBIEL(VBILNQ),VBIEL                                              
         MVI   VBIEL,VBIELQ                                                     
         MVI   VBILN,VBILNQ                                                     
         MVC   VBITYPE,GSTCODE                                                  
         MVC   VBIRATE,GSTRATE                                                  
         MVC   VBIINDS,GSTINDS                                                  
         MVC   VBIDATE,GSTDATE                                                  
         MVC   VBIACCT,GSTACCT                                                  
*                                                                               
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        ANY GST CALCULATED?                          
         BNE   BUILD06             YES                                          
         CP    JOBVBAS,=P'0'       NO, ANY BASIS USED?                          
         BE    BUILD02             NO, GET NEXT RECORD THEN                     
*                                                                               
BUILD06  ZAP   VBIVAT,JOBGST       SAVE GST                                     
         ZAP   VBIGROSS,JOBVGRS         GROSS                                   
         ZAP   VBICOMM,JOBCOM           AND COMMISSION                          
         TM    CLIOPT,PAYNET       IF PAY=NET                                   
         BZ    BUILD08                                                          
         ZAP   VBIGROSS,JOBVNET    GROSS NOW IS NET                             
         ZAP   VBICOMM,=P'0'       AND COMMISSION IS ZERO                       
*                                                                               
BUILD08  SR    RE,RE                                                            
         IC    RE,VBILN                                                         
         AR    R2,RE                                                            
         B     BUILD02                                                          
*                                                                               
BUILDX   LR    RF,R2                                                            
         XIT1  REGS=(RF)                                                        
         DROP  R2,R5,R6                                                         
         EJECT                                                                  
***********************************************************************         
*              BUILD X'50' ELEMENTS                                   *         
***********************************************************************         
*                                                                               
         USING SCIELD,R2                                                        
         USING GSTD,R5                                                          
BUILD50  NTR1                                                                   
         LR    R2,RF                                                            
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),(R4)                        
         TM    DMCB+8,X'80'                                                     
         BO    BLD5006                                                          
         B     BLD5004                                                          
*                                                                               
BLD5002  MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),(R4)                      
         TM    DMCB+8,X'80'                                                     
         BO    BLD5006                                                          
*                                                                               
         USING JOBD,R6                                                          
BLD5004  CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   BLD5006             NOT A GST RECORD                             
         CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    BLD5002             YES, SKIP IT                                 
         XC    SCIEL(SCILN3Q),SCIEL                                             
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN3Q                                                    
         MVI   SCITYPE,SCITTAXP                                                 
         MVC   SCISUBPT,GSTCODE                                                 
*                                                                               
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        ANY GST CALCULATED?                          
         BE    BLD5002             NO, GET NEXT RECORD THEN                     
         ZAP   SCIAMNT,JOBGST      YES, GET GST AMOUNT                          
         ZAP   SCIBASE,JOBVBAS      AND BASE                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    R2,RE                                                            
         B     BLD5002                                                          
*                                                                               
         USING PSTD,R5                                                          
BLD5006  LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),(R4)                        
         TM    DMCB+8,X'80'                                                     
         BO    BLD50X                                                           
         B     BLD5010                                                          
*                                                                               
BLD5008  MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),(R4)                      
         TM    DMCB+8,X'80'                                                     
         BO    BLD50X                                                           
*                                                                               
         USING JOBD,R6                                                          
BLD5010  CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   BLD50X              NOT A PST RECORD                             
         CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BE    BLD5008             YES, SKIP IT                                 
         XC    SCIEL(SCILN3Q),SCIEL                                             
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN3Q                                                    
         MVI   SCITYPE,SCITTQST                                                 
         MVC   SCISUBPT,PSTCODE                                                 
         MVC   SCISUBPR,PSTPROV                                                 
*                                                                               
         LA    R6,PSTACCUM                                                      
         CP    JOBPST,=P'0'        ANY PST CALCULATED?                          
         BE    BLD5008             NO, GET NEXT RECORD THEN                     
         ZAP   SCIAMNT,JOBPST      YES, GET PST AMOUNT                          
         ZAP   SCIBASE,JOBPBAS      AND BASE                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    R2,RE                                                            
         B     BLD5008                                                          
*                                                                               
BLD50X   LR    RF,R2                                                            
         XIT1  REGS=(RF)                                                        
         DROP  R2,R5,R6                                                         
         EJECT                                                                  
***********************************************************************         
*              FORMAT THE PST ELEMENT                                 *         
***********************************************************************         
*                                                                               
*              BUILD X'7D' ELEMENTS                                             
*                                                                               
         USING PBIEL,R2                                                         
         USING PSTD,R5                                                          
BUILD7D  NTR1                                                                   
         LR    R2,RF                                                            
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))                                        
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    BLD7DX                                                           
         B     BLD7D04                                                          
*                                                                               
BLD7D02  MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    BLD7DX                                                           
*                                                                               
         USING JOBD,R6                                                          
BLD7D04  CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   BLD7DX              NOT A PST RECORD                             
         CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BE    BLD7D02             YES, SKIP IT                                 
         XC    PBIEL(PBILNQ),PBIEL                                              
         MVI   PBIEL,PBIELQ                                                     
         MVI   PBILN,PBILNQ                                                     
         MVC   PBITYPE,PSTCODE                                                  
         MVC   PBIRATE,PSTRATE                                                  
         MVC   PBIINDS,PSTINDS                                                  
         MVC   PBIDATE,PSTDATE                                                  
         MVC   PBIACCT,PSTACCT                                                  
         MVC   PBIPRV,PSTPROV                                                   
*                                                                               
         LA    R6,PSTACCUM                                                      
         CP    JOBPST,=P'0'        ANY PST CALCULATED?                          
         BNE   BLD7D06             YES                                          
         CP    JOBPBAS,=P'0'       NO, ANY BASIS USED?                          
         BE    BLD7D02             NO, GET NEXT RECORD THEN                     
*                                                                               
BLD7D06  ZAP   PBIPST,JOBPST       SAVE PST                                     
         ZAP   PBIGROSS,JOBPGRS         GROSS                                   
         ZAP   PBICOMM,JOBCOM           AND COMMISSION                          
         TM    CLIOPT,PAYNET       IF PAY=NET                                   
         BZ    BLD7D08                                                          
         ZAP   PBIGROSS,JOBPNET    GROSS NOW IS NET                             
         ZAP   PBICOMM,=P'0'       AND COMMISSION IS ZERO                       
*                                                                               
BLD7D08  SR    RE,RE                                                            
         IC    RE,PBILN                                                         
         AR    R2,RE                                                            
         B     BLD7D02                                                          
*                                                                               
BLD7DX   LR    RF,R2                                                            
         XIT1  REGS=(RF)                                                        
         DROP  R2,R5,R6                                                         
         EJECT                                                                  
***********************************************************************         
*              BUILD X'C0' ELEMENT AND ADD IT                         *         
***********************************************************************         
*                                                                               
         USING APEELD,R2                                                        
BUILDC0  NTR1  ,                                                                
         LR    R4,R1                                                            
         L     RF,0(R4)            A(ADDRESS OF POSTING RECORD)                 
         LR    R2,RF               AND SAVE IT                                  
                                                                                
         L     R1,4(R4)            A(SUBTAB/GRPTAB)                             
         SR    R0,R0                                                            
         IC    R0,4(R4)            # SUBTAB/GRPTAB ENTRIES                      
                                                                                
         LTR   R0,R0                                                            
         BZ    BLDC0X              NO RECORDS, EXIT                             
                                                                                
BLDC00   MVI   APEEL,APEELQ                                                     
         MVI   APELN,APELN1Q                                                    
         MVI   APENUM,0                                                         
                                                                                
         USING SUBTABD,R1                                                       
BLDC02   CLC   SUBACC,PSHDACC+1                                                 
         BE    BLDC04                                                           
         CLC   SUBACC,PSHDSBAC+1                                                
         BE    BLDC04                                                           
                                                                                
         SR    RE,RE                                                            
         IC    RE,APELN                                                         
         LA    RE,APEELD(RE)                                                    
         USING APENTRY,RE          RE=A(APEEL ENTRY)                            
         MVC   APENSTAT,SUBSTA                                                  
         MVC   APENACT,SUBACC                                                   
         LA    RF,APENACT+L'APENACT-1                                           
         CLI   0(RF),C' '          LOCATE END OF ACCOUNT CODE                   
         BH    *+12                                                             
         MVI   0(RF),0             AND DROP TRAILING SPACES                     
         BCT   RF,*-12                                                          
         AHI   RF,1                                                             
         SR    RF,RE               RF=L'SUB-ELEMENT                             
         STC   RF,APENLEN                                                       
         DROP  RE                                                               
                                                                                
         SR    RE,RE               INCREMENT ELEMENT LENGTH                     
         IC    RE,APELN                                                         
         AR    RE,RF                                                            
         CHI   RE,254              CAN'T GO HIGHER THAN THIS                    
         BH    BLDC06              END THIS ONE AND START ANOTHER               
                                                                                
         STC   RE,APELN                                                         
         IC    RE,APENUM           INCREMENT NUMBER OF SUB-ELEMENTS             
         AHI   RE,1                                                             
         STC   RE,APENUM                                                        
                                                                                
BLDC04   AHI   R1,SUBTABL          BUMP TO NEXT TABLE ENTRY                     
         BCT   R0,BLDC02                                                        
                                                                                
         SR    RE,RE                                                            
         IC    RE,APELN                                                         
         AR    R2,RE                                                            
         B     BLDC0X                                                           
                                                                                
                                                                                
BLDC06   SR    RE,RE                                                            
         IC    RE,APELN                                                         
         AR    R2,RE               GET TO END OF RECORD                         
         B     BLDC00                                                           
                                                                                
BLDC0X   LR    RF,R2                                                            
         XIT1  REGS=(RF)                                                        
         DROP  R1,R2                                                            
         EJECT                                                                  
***********************************************************************         
*              ADD TO GROUP BILL RECORD TABLE                         *         
*              R6 = A(JOB TOTALS/GROUP TOTALS)                        *         
***********************************************************************         
*                                                                               
*                                                                               
         USING GRECD,R2                                                         
         USING JOBD,R6                                                          
GRPSUM   NTR1                                                                   
         LA    R2,GRECWK                                                        
         XC    GRECWK(GRECKLEN),GRECWK                                          
         ZAP   GRECPAY,=P'0'                                                    
         MVC   GRECREC(GRECBLNQ-L'GRECPAY),GRECPAY                              
*                                                                               
         MVC   GRECCLI,CLICODE+3                                                
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    GRPS04              NO                                           
*                                                                               
         MVC   GRECBILL,QSELECT    YES, USE ORIGINAL BILL# AND DATE             
         GOTO1 DATCON,DMCB,(0,QEND),(1,GRECBDTE)                                
         MVC   GRECUBIL,BILLREF                                                 
         GOTO1 DATCON,DMCB,(4,BILLDTE),(1,GRECUDTE)                             
         B     GRPS06                                                           
*                                                                               
GRPS04   MVC   GRECBILL,BILLREF                                                 
         GOTO1 DATCON,DMCB,(4,BILLDTE),(1,GRECBDTE)                             
*                                                                               
GRPS06   GOTO1 DATCON,DMCB,(2,FRDAT2),(1,GRECFDTE)                              
         GOTO1 DATCON,DMCB,(2,TODAT2),(1,GRECTDTE)                              
         GOTO1 DATCON,DMCB,(4,RCDATE),(1,GRECRDTE)                              
         GOTO1 DATCON,DMCB,(2,DUE2),(1,GRECDDTE)                                
*                                                                               
         MVC   GRECFORM,FORMTYP                                                 
         MVC   GRECLVL,GRPTYPE                                                  
         MVC   GRECRECA,RECEIVBL                                                
         MVC   GRECROFF,RECOFF                                                  
         MVI   GRECTYPE,C'C'                                                    
*                                                                               
         ZAP   GRECPAY,AMOUNTSJ                                                 
         ZAP   GRECREC,AMOUNTSR                                                 
         ZAP   GRECINC,AMOUNT12                                                 
         ZAP   GRECGRS,AMOUNT11                                                 
         ZAP   GRECCSH,JOBCD                                                    
         ZAP   GRECINT,GRPINT                                                   
         ZAP   GRECTME,JOBTME                                                   
         ZAP   GRECOOP,JOBOOP                                                   
         ZAP   GRECPRV,JOBPRV                                                   
         ZAP   GRECPRE,JOBPRE                                                   
         ZAP   GRECRET,JOBRET                                                   
         ZAP   GRECPRT,JOBPRT                                                   
*                                                                               
         SR    RF,RF               GET 2'S COMPLEMENT                           
         ICM   RF,7,GRECBDTE                                                    
         LNR   RF,RF                                                            
         STCM  RF,7,GRECBDTE                                                    
*                                                                               
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R2),AGRECTAB                          
*                                                                               
GRPSX    XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
*              OPEN POSTING FILE                                      *         
***********************************************************************         
*                                                                               
OPENPOST DC    0H'0'                                                            
         OI    WKID+13,X'01'       ALLOW DUP KEYS                               
         MVC   WKID(2),ORIGINUM                                                 
         PACK  DUB(2),RCDATE+3(3)                                               
         MVC   WKID+6(1),DUB                                                    
         MVI   WKID+7,C'P'                                                      
         MVC   WKID+2(3),=C'A27'                                                
         TM    BILLMODE,UNBILL                                                  
         BZ    *+10                                                             
         MVC   WKID+2(3),=C'A29'                                                
         MVC   COMMAND,=CL6'OPEN'                                               
         BAS   RE,FILE                                                          
         B     POSTXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              WORKER INTERFACE                                       *         
***********************************************************************         
*                                                                               
ADDPOST  MVC   COMMAND,=CL6'ADD'                                                
         B     FILE                                                             
*                                                                               
CLOSPOST MVC   COMMAND,=CL6'CLOSE'                                              
         B     FILE                                                             
*                                                                               
KEEPPOST MVC   COMMAND,=CL6'KEEP'                                               
         B     FILE                                                             
*                                                                               
FILE     NTR1                                                                   
         LA    R3,AREA                                                          
         L     R4,APOSTBUF                                                      
         TM    BILLMODE,DRAFT                                                   
         BO    FILEX                                                            
         CLI   RCPOSTNG,C'N'                                                    
         BE    FILEX                                                            
*                                                                               
         GOTO1 WORKER,DMCB,COMMAND,(R4),WKID,(R3)                               
         TM    DMCB+8,X'C0'                                                     
         BNZ   FILE02              ERROR                                        
*                                                                               
         CLC   COMMAND,=CL6'CLOSE'                                              
         BNE   FILEX                                                            
         TM    RUNOPT,SOON         IS THIS A SOON BILLING?                      
         BZ    FILEX               NO                                           
*                                                                               
         MVC   COMMAND,=CL6'KEEP'                                               
         GOTO1 WORKER,DMCB,COMMAND,(R4),WKID,(R3)                               
         TM    DMCB+8,X'C0'                                                     
         BZ    FILEX                                                            
*                                  ERROR ON ADD TO WORKER FILE                  
FILE02   MVC   P,SPACES                                                         
         MVC   P(42),=C'*WORKER FILE FULL - STOP ALL FILE MARKERS*'             
         TM    DMCB+8,X'80'                                                     
         BO    *+10                                                             
         MVC   P(42),=C'*WORKER FILE DISK ERROR - CANNOT ADD ID = '             
         L     R2,DMCB+8           ADDRESS OF KEY                               
         MVC   DOUBLE(2),0(R2)                                                  
         LH    R3,DOUBLE                                                        
         CVD   R3,DOUBLE                                                        
         UNPK  DOUBLE+2(6),DOUBLE                                               
         OI    DOUBLE+7,X'F0'                                                   
         MVC   P+42(3),DOUBLE+5                                                 
         MVC   P+45(23),=C', REPLY = ''OK'' FOR DUMP'                           
*                                                                               
WKERR    GOTO1 LOGIO,WORK,1,(68,P)                                              
         GOTO1 (RF),(R1),0,(2,DUB)                                              
         CLC   DUB(2),=C'OK'                                                    
         BNE   WKERR                                                            
         DC    H'0'                NOW DIE                                      
*                                                                               
FILEX    B     POSTXIT                                                          
         EJECT                                                                  
GETEL3   AH    R2,DATADISP                                                      
FRSTEL3  CLI   0(R2),0                                                          
         BNE   *+10                                                             
         CLI   0(R2),1                                                          
         BR    RE                                                               
         CLI   ELCODE,0                                                         
         BCR   8,RE                                                             
         CLC   ELCODE,0(R2)                                                     
         BCR   8,RE                                                             
*                                                                               
NEXTEL3  SR    RF,RF                                                            
         IC    RF,1(R2)                                                         
         LTR   RF,RF                                                            
         BNZ   *+10                                                             
         CLI   1(R2),1                                                          
         BR    RE                                                               
         AR    R2,RF                                                            
         B     FRSTEL3                                                          
*                                                                               
COMMAND  DS    CL6                 DATAMGR COMMAND                              
INCOME   DS    PL6                 INCOME/COMMISSION AMOUNT                     
POSTCD   DS    PL6                 CASH DISCOUNT AMOUNT                         
*                                                                               
SIAC     DS    CL12                ANALYSIS ACCOUNT AND NAME                    
SINM     DS    CL36                                                             
SKACCT   DS    CL15                SUSPENSE ACCOUNT AND NAME                    
SKACCTN  DS    CL36                                                             
SIACCT   DS    CL15                INCOME ACCOUNT AND NAME                      
SIACCTN  DS    CL36                                                             
XTRACST  DS    CL12                ANALYSIS ACCOUNT                             
XTRA1    DS    CL15                                                             
XTRA1N   DS    CL36                                                             
XTRA2    DS    CL15                                                             
XTRA2N   DS    CL36                                                             
*                                                                               
RETNARR  DC    CL35'** CURRENT MONTHS LABOR CONTINGENCY'                        
         DROP  R9,RA,RB                                                         
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*              LOOK FOR GST/PST AND ADD ACCOUNTS TO SUBTAB            *         
***********************************************************************         
*                                                                               
ADDTAX   NTR1  BASE=*,LABEL=*                                                   
         USING GSTD,R5                                                          
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    ADDTAX6             NO GST RECORDS                               
                                                                                
         CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   ADDTAX6             NOT A GST RECORD                             
         B     ADDTAX4                                                          
                                                                                
ADDTAX2  MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    ADDTAX6                                                          
*                                                                               
ADDTAX4  OC    GSTACCT,GSTACCT     DO WE HAVE AN ACCOUNT ?                      
         BZ    ADDTAX2             NO, GET NEXT ONE                             
         CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    ADDTAX2             YES, SKIP IT                                 
                                                                                
         MVI   BYTE,0                                                           
         LA    R1,GSTACCT          GST ACCOUNT                                  
         BRAS  RE,ADD2TAB                                                       
         B     ADDTAX2             LOOK FOR MORE                                
         DROP  R5                                                               
                                                                                
         USING PSTD,R5                                                          
ADDTAX6  LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    ADDTAXX                                                          
                                                                                
         CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   ADDTAXX             NOT A PST RECORD                             
         B     ADDTAX10                                                         
                                                                                
ADDTAX8  MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    ADDTAXX                                                          
*                                                                               
ADDTAX10 OC    PSTACCT,PSTACCT     DO WE HAVE AN ACCOUNT ?                      
         BZ    ADDTAX8             NO, GET NEXT ONE                             
         CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BE    ADDTAX8             YES, SKIP IT                                 
                                                                                
         MVI   BYTE,0                                                           
         LA    R1,PSTACCT          PST ACCOUNT                                  
         BRAS  RE,ADD2TAB                                                       
         B     ADDTAX8             LOOK FOR MORE                                
         DROP  R5                                                               
                                                                                
ADDTAXX  XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*              FIT ACCOUNT INTO NEXT SLOT                             *         
***********************************************************************         
*                                                                               
         USING SUBTABD,RF                                                       
ADD2TAB  NTR1  BASE=*,LABEL=*                                                   
         L     RF,ASUBTAB            RF=A(TABLE OF PRIMARY ACCOUNTS)            
         LHI   R0,SUBTABM            R0=MAX NUMBER OF ENTRIES IN TABLE          
                                                                                
ADD2TAB2 OC    0(SUBTABL,RF),0(RF)   VACANT SPOT?                               
         BZ    ADD2TAB6              YES                                        
         CLC   SUBSTA,BYTE                                                      
         BNE   ADD2TAB4                                                         
         CLC   SUBACC,1(R1)                                                     
         BE    ADD2TABX              YES, LEAVE IT                              
                                                                                
ADD2TAB4 AHI   RF,SUBTABL            BUMP TO NEXT TABLE ENTRY                   
         BCT   R0,ADD2TAB2                                                      
         B     ADD2TABX                                                         
                                                                                
ADD2TAB6 MVC   SUBSTA,BYTE                                                      
         MVC   SUBACC,1(R1)                                                     
         IC    RF,SUBTABN          INCREMENT NUMBER OF TABLE ENTRIES            
         AHI   RF,1                                                             
         STC   RF,SUBTABN                                                       
                                                                                
ADD2TABX XIT1                                                                   
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT ELEMENT TO CARRY WORKCODE                       *         
***********************************************************************         
*                                                                               
*              BUILD X'C5' ELEMENTS                                             
*                                                                               
         USING RFLELD,R2                                                        
BUILDC5  NTR1  BASE=*,LABEL=*                                                   
         LR    R2,RF                                                            
         XC    RFLEL(RFLLNQ),RFLEL                                              
         MVI   RFLEL,RFLELQ                                                     
         MVI   RFLLN,RFLLNQ+L'SVANAL                                            
         MVI   RFLTYPE,RFLWC                                                    
         MVC   RFLDATA(L'SVANAL),SVANAL                                         
*                                                                               
         SR    RE,RE                                                            
         IC    RE,RFLLN                                                         
         AR    R2,RE                                                            
*                                                                               
BLDC5X   LR    RF,R2                                                            
         XIT1  REGS=(RF)                                                        
         DROP  R2                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* GET THE PROFILE RECORD                                              *         
***********************************************************************         
*                                                                               
GETPRO   NTR1  BASE=*,LABEL=*                                                   
         MVI   ARCHIVE,C'N'        SET TO NOT ARCHIVING                         
         USING CTPREC,R2                                                        
         L     R2,AIO2             IO AREA                                      
         XC    CTPKEY,CTPKEY                                                    
         MVI   CTPKTYP,CTPKTYPQ    PROFILE RECORD "P"                           
         MVI   CTPKSYS,C'A'        SYSTEM=ACC                                   
         MVC   CTPKPROG,QPROG                                                   
         MVC   CTPKORIG,ORIGINUM                                                
         GOTO1 DATAMGR,DMCB,DMREAD,=C'CTFILE  ',(R2),(R2)                       
         CLI   DMCB+8,0                                                         
         BNE   GETPROX                                                          
*                                                                               
         SR    R0,R0                                                            
         LA    R2,CTPDATA          POINT TO FIRST ELEMENT                       
*                                                                               
GETPRO2  CLI   0(R2),0                                                          
         BE    GETPROX                                                          
         CLI   0(R2),CTARTELQ                                                   
         BE    GETPRO4                                                          
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     GETPRO2             NEXT ELEMENT                                 
         DROP  R2                                                               
*                                                                               
         USING CTARTD,R2                                                        
GETPRO4  CLI   CTARTCOD,C'A'                                                    
         BNE   GETPROX                                                          
         MVI   ARCHIVE,C'Y'                                                     
*                                                                               
GETPROX  XIT1                                                                   
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*              FORMAT ELEMENT TO CARRY WORKCODE AND AMOUNT            *         
***********************************************************************         
*                                                                               
*              BUILD X'DB' ELEMENT WITH WORKCODE AND SJ AMOUNT                  
*                                                                               
         USING FFTELD,R5                                                        
BUILDDB  NTR1                                                                   
         LA    R5,SVDBELM                                                       
         MVI   FFTEL,FFTELQ                                                     
         MVI   FFTLN,FFTLN1Q+L'FFTDLEN+L'FFTWORK+L'FFTWAMT                      
         MVI   FFTTYPE,FFTTWRKC                                                 
         MVI   FFTSEQ,0                                                         
         MVI   FFTDLEN,L'FFTWORK+L'FFTWAMT                                      
*                                                                               
BLDDBX   XIT1                                                                   
         DROP  R5                                                               
***********************************************************************         
*              FORMAT ELEMENT TO CARRY LONG INVOICE NUMBER            *         
***********************************************************************         
*                                                                               
         USING FFTELD,R5                                                        
BUILDDB2 NTR1                                                                   
         LA    R5,SVDBELM2                                                      
         MVI   FFTEL,FFTELQ                                                     
         MVI   FFTLN,FFTLN1Q+L'FFTDLEN+9                                        
         MVI   FFTTYPE,FFTTINVN                                                 
         MVI   FFTSEQ,0                                                         
         MVI   FFTDLEN,9                                                        
         MVC   FFTDATA(1),JOBLET       MEDIA                                    
         MVI   FFTDATA+1,C'-'                                                   
         MVC   FFTDATA+2(2),BILLREF    BILLNUM                                  
         MVI   FFTDATA+4,C'-'                                                   
         MVC   FFTDATA+5(4),BILLREF+2                                           
*                                                                               
BLDDBX2  XIT1                                                                   
         DROP  R5                                                               
         EJECT                                                                  
         TITLE 'AC27 - PROFESSIONAL BILLING - PRINTING ROUTINES'                
PRNTR    DS    0D                                                               
         NMOD1 0,**PRNTR*,RA                                                    
         L     RC,0(R1)                                                         
         MVC   PRNTMODE,0(R1)                                                   
         CLI   PRNTMODE,PRNTALL                                                 
         BE    PRT                                                              
         CLI   PRNTMODE,PRNTFGP                                                 
         BE    FORMBIL                                                          
         CLI   PRNTMODE,PRNTCOM                                                 
         BE    COMMPRT                                                          
         CLI   PRNTMODE,PRNTFRM                                                 
         BE    FORMPRT                                                          
PRNTXIT  XIT1                                                                   
         EJECT                                                                  
PRT      MVC   HEAD3+9(6),CLICODE+3     CLIENT                                  
         MVC   HEAD4+9(3),PRDCODE+6     PRODUCT                                 
         MVC   HEAD6+9(6),JOBCODE+9     JOB                                     
         MVC   HEAD5+9(1),JOBLET        MEDIA                                   
         MVC   HEAD5+16(12),MEDNAME+3                                           
         MVC   HEAD3+16(36),CLINAME                                             
         MVC   HEAD4+16(36),PRDNAME                                             
         MVC   HEAD6+16(36),JOBNAME                                             
*                                                                               
         LA    R4,HEAD3+55                                                      
         L     R2,ADLVCADD         LOOK FOR ADDRESSES                           
         LTR   R2,R2                                                            
         BNZ   PRT08                                                            
         L     R2,ADLVBADD                                                      
         LTR   R2,R2                                                            
         BNZ   PRT08                                                            
         L     R2,ADLVAADD                                                      
         LTR   R2,R2                                                            
         BZ    PRT12                                                            
*                                                                               
         USING ADRELD,R2                                                        
PRT08    DS    0H                  OUTPUT AN ADDRESS                            
         SR    R5,R5                                                            
         IC    R5,ADRNUM                                                        
         LA    R3,ADRADD1                                                       
*                                                                               
PRT10    MVC   0(26,R4),0(R3)                                                   
         LA    R3,26(R3)                                                        
         LA    R4,132(R4)                                                       
         BCT   R5,PRT10                                                         
*                                                                               
PRT12    MVC   HEAD1+67(10),LNGBILNO                                            
*                                                                               
PRT14    CLC   BILLINFO,SPACES                                                  
         BE    *+10                                                             
         MVC   HEAD7+16(50),BILLINFO                                            
         CLI   PROF4,C'N'         PRINT DUE DATE/RECEIPT?                       
         BE    PRT16              NO                                            
         MVC   HEAD2+55(L'AC@DUEDT),AC@DUEDT                                    
         MVC   HEAD2+64(8),DUEDAT                                               
         CLI   PROF4,C'R'          PRINT 'DUE UPON RECEIPT INSTEAD'?            
         BNE   PRT16                                                            
         MVC   HEAD2+55(L'AC@DUER),AC@DUER                                      
*                                                                               
PRT16    CLC   SVEA,SPACES                                                      
         BE    *+16                                                             
         MVC   HEAD8+16(3),=C'EA='                                              
         MVC   HEAD8+20(14),SVEA                                                
         MVC   HEAD8+56(14),SVAC                                                
         MVC   HEAD8+36(15),SVBI                                                
         CLC   SVBU,SPACES                                                      
         BE    PRT18                                                            
         MVC   HEAD8+71(3),=C'BG='                                              
         MVC   HEAD8+74(15),SVBU                                                
*                                                                               
PRT18    BAS   RE,PRTSOFT          PRINT SOFT HEADINGS                          
*                                                                               
         USING ACPROFSD,RE                                                      
PRT22    MVC   SPACING,MYSPACE                                                  
         L     RE,APROFILE                                                      
         LA    R2,1                FOR OPTION=LEFT                              
         CLI   ACPPFO13,C'L'                                                    
         BE    PRT24                                                            
         LA    R2,24               FOR OPTION=CENTER                            
         CLI   ACPPFO13,C'C'                                                    
         BE    PRT24                                                            
         LA    R2,52               MUST BE RIGHT                                
*                                                                               
         USING RUNXTRAD,RF                                                      
PRT24    L     RF,VEXTRAS                                                       
         LA    R3,UPPER1(R2)                                                    
         LA    R4,UPPER2(R2)                                                    
         CLI   ACPPFO12,C'N'       N PRINT NAME ONLY                            
         BE    *+12                                                             
         CLI   ACPPFO12,C'B'       B PRINT NAME AND ADDRESS                     
         BNE   *+10                                                             
         MVC   0(33,R3),ORIGNME    ORIGIN NAME TO HEADLINES                     
         CLI   ACPPFO12,C'A'       A PRINT ADDRESS ONLY                         
         BE    *+12                                                             
         CLI   ACPPFO12,C'B'       B PRINT NAME AND ADDRESS                     
         BNE   *+10                                                             
         MVC   0(33,R4),ORIGADD    ORIGIN ADDRESS TO HEADLINES                  
*                                                                               
         GOTO1 ACREPORT            ELSE, PRINT IT                               
         MVI   MYSPACE,2                                                        
*                                                                               
PRNTAX   B     PRNTXIT                                                          
         EJECT                                                                  
***********************************************************************         
*              FORMAT HEADINGS AND GOTO ACREPORT                      *         
***********************************************************************         
*                                                                               
FORMPRT  DS    0D                                                               
         MVI   PRINTED,C'Y'                                                     
         MVI   PRTDATA,C'Y'        INDICATE WE PRINTED SOMETHING                
         MVC   HEAD1+41(L'AC@INVDE),AC@INVDE                                    
         MVC   HEAD2+41(L'AC$INVDE),AC$INVDE                                    
         CLI   RCSUBPRG,8          ARE WE DOING DETAIL?                         
         BE    FORMP02             YES                                          
*                                                                               
         MVC   HEAD1+41(L'AC@INVDE),SPACES                                      
         MVC   HEAD2+41(L'AC@INVDE),SPACES                                      
*                                                                               
         MVC   HEAD1+41(L'AC@INV),AC@INV                                        
         MVC   HEAD2+41(L'AC$INV),AC$INV                                        
         CLI   RCSUBPRG,16         ARE WE DOING SUMMARY?                        
         BE    FORMP02             YES                                          
*                                                                               
         MVC   HEAD1+41(L'AC@PRD),AC@PRD                                        
         MVC   HEAD2+41(L'AC$PRD),AC$PRD                                        
*                                                                               
         TM    BILLOPT,MEDIANM                                                  
         BZ    FORMP02                                                          
*                                                                               
         MVC   HEAD1+41(L'AC@PRD),SPACES                                        
         MVC   HEAD2+41(L'AC@PRD),SPACES                                        
*                                                                               
         GOTO1 SHR,DMCB,('SUBRCOST',(RC))     MEDIA VALUE AND COSTING           
         LA    RF,HEAD1+41                                                      
         LA    RE,11                                                            
         LA    R1,MEDNAME+14                                                    
*                                                                               
FORMP00  CLI   0(R1),C' '                                                       
         BNE   *+14                                                             
         LA    RF,1(RF)                                                         
         BCTR  RE,0                                                             
         BCT   R1,FORMP00                                                       
*                                                                               
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),MEDNAME+3                                                
*                                                                               
         GOTO1 UNDERLIN,DMCB,(12,HEAD1+41),HEAD2+41                             
*                                                                               
FORMP02  MVC   HEAD5+60(L'AC@INVC),AC@INVC                                      
         MVI   HEAD5+76,C'*'                                                    
         MVC   HEAD5+76+1(L'AC@DRAFT),AC@DRAFT                                  
         MVI   HEAD5+76+1+L'AC@DRAFT,C'*'                                       
         TM    BILLMODE,DRAFT                                                   
         BO    FORMP04                                                          
         MVC   HEAD5+76(2),BILLREF                                              
         MVI   HEAD5+78,C'-'                                                    
         MVC   HEAD5+79(4),BILLREF+2                                            
*                                                                               
FORMP04  MVC   HEAD3+1(3),CLICODE+3       CLIENT CODE                           
         MVC   HEAD3+9(36),CLINAME                                              
*                                                                               
         CLI   GRPTYPE,C'C'        IS THIS CLIENT LEVEL GROUP?                  
         BE    FORMP08             YES, DON'T PRINT THE PRODUCT                 
         MVC   HEAD4+1(3),PRDCODE+6       PRODUCT CODE                          
         MVC   HEAD4+9(36),PRDNAME                                              
         CLI   GRPTYPE,C'0'        IF NOT GROUP LEVEL, DON'T PRINT              
         BE    FORMP06               THE JOB CODE                               
         CLI   GRPTYPE,C'J'                                                     
         BNE   FORMP08                                                          
*                                                                               
FORMP06  MVC   HEAD5+1(6),JOBCODE+9       JOB CODE                              
         MVC   HEAD5+9(36),JOBNAME                                              
*                                                                               
FORMP08  CLC   BILLINFO,SPACES     ANY BILLING INFO?                            
         BE    FORMP14             NO                                           
*                                                                               
         LA    R5,(HEAD10+L'HEAD10-HEAD4)/L'HEAD4                               
         LA    R4,HEAD4                                                         
*                                                                               
FORMP10  CLC   0(L'BILLINFO,R4),SPACES                                          
         BE    FORMP12                                                          
         LA    R4,L'HEAD4(R4)                                                   
         BCT   R5,FORMP10                                                       
         B     FORMP14                                                          
*                                                                               
FORMP12  MVC   9(L'BILLINFO,R4),BILLINFO                                        
*                                                                               
         USING ADRELD,R2                                                        
FORMP14  L     R2,ADLVAADD                                                      
         CLI   GRPTYPE,C'C'        IS THIS A CLIENT LEVEL GROUP?                
         BE    FORMP16             YES                                          
         CLC   ADLVBADD,=F'0'      NO, ANY PRODUCT ADDRESS?                     
         BE    *+8                 NO, LEAVE CLIENT                             
         L     R2,ADLVBADD         YES, USE IT                                  
         CLI   GRPTYPE,C'P'        IS THIS A PRODUCT LEVEL GROUP?               
         BE    FORMP16             YES                                          
         CLC   ADLVCADD,=F'0'      NO, ANY JOB ADDRESS?                         
         BE    *+8                 NO, LEAVE PREVIOUS                           
         L     R2,ADLVCADD         YES, USE IT                                  
*                                                                               
FORMP16  LTR   R2,R2                                                            
         BZ    FORMP20                                                          
         SR    R5,R5                                                            
         IC    R5,ADRNUM                                                        
         LA    R3,ADRADD1                                                       
         LA    R4,HEAD4+9                                                       
         CLC   0(36,R4),SPACES     ANY PRODUCT?                                 
         BE    FORMP18             NO                                           
         LA    R4,HEAD5+9          YES, TRY NEXT LINE                           
         CLC   0(36,R4),SPACES     ANY JOB?                                     
         BE    FORMP18             NO                                           
         LA    R4,HEAD6+9          YES, USE NEXT LINE                           
         CLC   0(36,R4),SPACES     ANY POB?                                     
         BE    FORMP18             NO                                           
         LA    R4,HEAD7+9          YES, USE NEXT LINE                           
*                                                                               
FORMP18  MVC   0(26,R4),0(R3)      ADDRESS TO HEADLINES                         
         LA    R3,26(R3)                                                        
         LA    R4,132(R4)                                                       
         BCT   R5,FORMP18                                                       
*                                                                               
FORMP20  CLI   PROF4,C'N'          PRINT DUE DATE/RECEIPT?                      
         BE    FORMP22             NO                                           
         MVC   HEAD3+60(L'AC@DUEDT),AC@DUEDT                                    
         MVC   HEAD3+70(8),DUEDAT                                               
*                                                                               
         CLI   PROF4,C'R'          PRINT "DUE ON RECEIPT" INSTEAD?              
         BNE   FORMP22             NO                                           
         MVC   HEAD3+60(L'AC@DUER),AC@DUER                                      
*                                                                               
FORMP22  MVC   HEAD4+60(L'AC@BILDT),AC@BILDT                                    
         GOTO1 DATCON,DMCB,(4,BILLDTE),(8,HEAD4+75)                             
*       - - - - - - - - - - - - - - - - - - - - - - - - - - -                   
         CLI   FORMTYP,C'8'                                                     
         BNE   FORMP23                                                          
         MVC   HEAD6+60(12),MEDNAME+3                                           
*       - - - - - - - - - - - - - - - - - - - - - - - - - - -                   
FORMP23  CLI   GRPTYPE,C'0'        IF JOB LEVEL, PRINT USER FIELDS              
         BE    *+12                                                             
         CLI   GRPTYPE,C'J'                                                     
         BNE   FORMP24                                                          
         BAS   RE,PRTSOFT                                                       
*                                                                               
FORMP24  MVI   HEAD11+1,C'-'                                                    
         MVC   HEAD11+2(84),HEAD11+1                                            
*                                                                               
         USING ACPROFSD,RE                                                      
         USING RUNXTRAD,RF                                                      
         L     RF,VEXTRAS                                                       
         L     RE,APROFILE                                                      
         LA    R2,1                OPTION=LEFT                                  
         CLI   ACPPFO13,C'L'                                                    
         BE    FORMP26                                                          
         LA    R2,24               OPTION=CENTER                                
         CLI   ACPPFO13,C'C'                                                    
         BE    FORMP26                                                          
         LA    R2,52               MUST BE RIGHT                                
*                                                                               
FORMP26  LA    R3,UPPER1(R2)                                                    
         LA    R4,UPPER2(R2)                                                    
         CLI   ACPPFO12,C'N'           N PRINT NAME ONLY                        
         BE    *+12                                                             
         CLI   ACPPFO12,C'B'           B PRINT NAME AND ADDRESS                 
         BNE   *+10                                                             
         MVC   0(33,R3),ORIGNME        ORIGIN NAME TO HEADLINES                 
         CLI   ACPPFO12,C'A'           A PRINT ADDRESS ONLY                     
         BE    *+12                                                             
         CLI   ACPPFO12,C'B'           B PRINT NAME AND ADDRESS                 
         BNE   *+10                                                             
         MVC   0(33,R4),ORIGADD        ORIGIN ADDRESS TO HEADLINES              
*                                                                               
         GOTO1 ACREPORT                                                         
         MVC   P,SPACES                                                         
*                                                                               
FORMPXIT B     PRNTXIT                                                          
         DROP  R2,RE,RF                                                         
         EJECT                                                                  
*              PRINT SOFT HEADINGS                                              
*                                                                               
PRTSOFT  NTR1                                                                   
         OC    SVAGACC,SVAGACC     DO WE HAVE AN AGENCY JOB?                    
         BZ    PRTS06              NO                                           
         LA    R3,SOFTAB           YES                                          
*                                                                               
PRTS02   SR    R5,R5                                                            
         ICM   R5,3,0(R3)          GET FIRST DISPLACEMENT                       
         AR    R5,RC               GET TO HEADLINE FIELD                        
         CLC   0(L'SOFTH1,R5),SPACES                                            
         BNE   PRTS04                                                           
         MVC   0(10,R5),=C'AGENCY JOB'                                          
         MVC   11(L'SVAGACC,R5),SVAGACC                                         
         B     PRTS06                                                           
*                                                                               
PRTS04   LA    R3,2(R3)                                                         
         CLI   0(R3),X'FF'                                                      
         BNE   PRTS02                                                           
*                                                                               
PRTS06   LA    R0,10                                                            
         LA    R1,SOFTH1                                                        
         LA    R3,SOFTAB                                                        
*                                                                               
PRTS08   CLC   0(L'SOFTH1,R1),SPACES                                            
         BE    PRTSX               NO MORE SOFT HEADLINES                       
         SR    R5,R5                                                            
         ICM   R5,3,0(R3)          DISPLACEMENT TO HEADLINE FIELD               
         AR    R5,RC               R5=TO HEADLINE FIELD                         
         CLC   0(L'SOFTH1,R5),SPACES                                            
         BNE   *+14                                                             
         MVC   0(L'SOFTH1,R5),0(R1) DATA TO HEADLINE                            
         LA    R1,L'SOFTH1(R1)                                                  
         LA    R3,2(R3)                                                         
         CLI   0(R3),X'FF'                                                      
         BNE   PRTS08                                                           
*                                                                               
PRTSX    XIT1                                                                   
         EJECT                                                                  
         USING FRMD,R5                                                          
FORMBIL  CLI   BILDATA,C'Y'        ANY DATA TO BILL?                            
         BNE   FORMBILX            NO                                           
         GOTO1 FORM,DMCB,(RC)      YES, FORMAT AND PRINT IT                     
*                                                                               
         GOTO1 POST,DMCB,('POSTGRP',(RC))  MAKE RECEIVABLE POSTING              
         NI    RUNOPT,ALL-BILNUM   TURN OFF NUMBER ASSIGNED                     
*                                                                               
         MVI   COMMENTS,AFTER      NO, PRINT PRODUCT LEVEL                      
*                                                                               
         CLI   GRPTYPE,C'C'        IS THIS CLIENT LEVEL GROUP?                  
         BE    FORMB02             YES, ONLY PRINT CLIENT LEVEL                 
         L     R2,ADHEIRB          NO, PRINT PRODUCT ALSO                       
         BAS   RE,CMM                                                           
*                                                                               
FORMB02  L     R2,ADHEIRA          PRINT CLIENT COMMENTS                        
         BAS   RE,CMM                                                           
         BAS   RE,CMMWPP                                                        
*                                                                               
FORMBILX B     PRNTXIT             AND EXIT                                     
         EJECT                                                                  
***********************************************************************         
*              PRINT JOB COMMENTS                                     *         
***********************************************************************         
*                                                                               
COMMPRT  MVI   COMMENTS,AFTER                                                   
         L     R2,ADACC                                                         
         BAS   RE,CMM                                                           
         L     R2,ADHEIRB                                                       
         BAS   RE,CMM                                                           
         L     R2,ADHEIRA                                                       
         BAS   RE,CMM                                                           
*                                  PRINT WPP COMMENTS                           
         BAS   RE,CMMWPP                                                        
         B     CMXT                                                             
*                                                                               
CMM      NTR1  0H                                                               
         CLI   PROF19,C'Y'         SUPPRESS STD COMMENTS?                       
         BE    CMXT                YES                                          
*                                                                               
         NI    COMMENTS,ALL-COMREAD                                             
         SR    R3,R3                                                            
         L     RF,ADACC                                                         
         MVC   SAVEKEY,0(RF)       SAVE JOB KEY                                 
         MVI   ELCODE,X'3E'                                                     
         BAS   RE,GETEL4                                                        
         BNE   CMXT                                                             
         B     CM04                                                             
*                                                                               
CM02     L     R2,SAVE3E           RESTORE ADDRESS OF LAST 3E                   
         MVI   ELCODE,X'3E'                                                     
         BAS   RE,NEXTEL4                                                       
         BNE   CMXT                                                             
*                                                                               
         USING SCMELD,R2                                                        
CM04     ST    R2,SAVE3E           SAVE ADDRESS OF THIS 3E                      
         CLI   SCMTYPE,C'M'       IGNORE OLD TYPE                               
         BE    CM02                                                             
         CLI   SCMTYPE,0          AND PURE DATA                                 
         BE    CM02                                                             
*                                                                               
         TM    SCMTYPE,X'80'      BILL COMMENT                                  
         BZ    CM02                                                             
         TM    COMMENTS,BEFORE                                                  
         BO    CM06                                                             
         TM    SCMTYPE,X'04'                                                    
         BZ    CM02                                                             
         B     CM08                                                             
*                                                                               
CM06     TM    SCMTYPE,X'08'                                                    
         BZ    CM02                                                             
*                                                                               
CM08     XC    COMMKEY,COMMKEY     NOW READ A STANDARD COMMENT                  
         MVI   COMMKEY,X'0C'                                                    
         MVC   COMMKEY+1(1),QCOMPANY                                            
         MVC   COMMKEY+2(6),SCMNARR                                             
         OI    COMMENTS,COMREAD                                                 
         L     R2,ACOMBUF                                                       
         MVC   KEYSAVE,COMMKEY                                                  
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)                                                    
         BNE   CM02                DIDNT FIND IT                                
         AH    R2,DATADISP                                                      
         LR    RE,R2                                                            
         SR    RF,RF               NOW COUNT THE NUMER OF LINES                 
*                                                                               
CM10     CLI   0(RE),0             IN THE COMMENT                               
         BE    CM12                                                             
         CLI   0(RE),X'3E'                                                      
         BNE   *+8                                                              
         LA    RF,1(RF)                                                         
         IC    R3,1(RE)                                                         
         AR    RE,R3                                                            
         B     CM10                                                             
*                                                                               
CM12     IC    R3,MAXLINES         SEE IF ALL THE COMMENT WILL FIT              
         SR    RE,RE                                                            
         IC    RE,LINE                                                          
         SR    R3,RE                                                            
         CR    RF,R3               NEEDED VS WHAT IS LEFT                       
         BNH   CM14                                                             
         MVI   FORCEHED,C'Y'                                                    
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
CM14     SR    R3,R3                                                            
         CLI   0(R2),0                                                          
         BE    CM02                                                             
         CLI   0(R2),X'3E'                                                      
         BE    CM18                                                             
*                                                                               
CM16     IC    R3,1(R2)                                                         
         AR    R2,R3                                                            
         B     CM14                                                             
*                                                                               
CM18     IC    R3,SCMLN                                                         
         SH    R3,=H'5'                                                         
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   P+1(0),SCMNARR                                                   
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     CM16                                                             
*                                                                               
CMXT     B     PRNTXIT                                                          
*                                                                               
CMMWPP   NTR1  0H                                                               
         LA    R2,CMMWPPT                                                       
*                                                                               
CMMWP02  CLI   0(R2),X'FF'                                                      
         BE    CMMWPX                                                           
         CLC   1(2,R2),ALPHAID                                                  
         BE    CMMWP04                                                          
         AHI   R2,L'CMMWPPT                                                     
         B     CMMWP02                                                          
*                                                                               
CMMWP04  SR    R3,R3                                                            
         XC    COMMKEY,COMMKEY                                                  
         MVI   COMMKEY,X'0C'                                                    
         MVC   COMMKEY+1(1),0(R2)                                               
         MVC   COMMKEY+2(6),3(R2)                                               
         OI    COMMENTS,COMREAD                                                 
         L     R2,ACOMBUF                                                       
         MVC   KEYSAVE,COMMKEY                                                  
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)                                                    
         BNE   CMMWPX              DIDNT FIND IT                                
         AH    R2,DATADISP                                                      
*                                                                               
         LR    RE,R2                                                            
         SR    RF,RF               NOW COUNT THE NUMER OF LINES                 
*                                                                               
CMMWP06  CLI   0(RE),0             IN THE COMMENT                               
         BE    CMMWP08                                                          
         CLI   0(RE),X'3E'                                                      
         BNE   *+8                                                              
         LA    RF,1(RF)                                                         
         IC    R3,1(RE)                                                         
         AR    RE,R3                                                            
         B     CMMWP06                                                          
*                                                                               
CMMWP08  IC    R3,MAXLINES         SEE IF ALL THE COMMENT WILL FIT              
         SR    RE,RE                                                            
         IC    RE,LINE                                                          
         SR    R3,RE                                                            
         CR    RF,R3               NEEDED VS WHAT IS LEFT                       
         BNH   CMMWP10                                                          
         MVI   FORCEHED,C'Y'                                                    
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
CMMWP10  SR    R3,R3                                                            
         CLI   0(R2),0                                                          
         BE    CMMWPX                                                           
         CLI   0(R2),X'3E'                                                      
         BE    CMMWP14                                                          
*                                                                               
CMMWP12  IC    R3,1(R2)                                                         
         AR    R2,R3                                                            
         B     CMMWP10                                                          
*                                                                               
CMMWP14  IC    R3,SCMLN                                                         
         SH    R3,=H'5'                                                         
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   P+1(0),SCMNARR                                                   
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     CMMWP12             GET NEXT ELEMENT                             
*                                                                               
CMMWPX   B     PRNTXIT                                                          
*                                                                               
CMMWPPT  DS    0CL9                                                             
         DC    XL1'B2',CL2'YP',CL6'WPPCOM'    YSHNY                             
         DC    XL1'4A',CL2'YN',CL6'WPPCOM'    YNRO                              
         DC    XL1'5A',CL2'JG',CL6'WPPCOM'    CWSFS                             
         DC    XL1'9E',CL2'WW',CL6'WPPCOM'    WWSFS                             
         DC    XL1'93',CL2'M2',CL6'WPPCOM'    MENYA                             
         DC    XL1'50',CL2'H7',CL6'WPPCOM'    MSNY                              
         DC    X'FF'                                                            
         EJECT                                                                  
GETEL4   AH    R2,DATADISP                                                      
FRSTEL4  CLI   0(R2),0                                                          
         BNE   *+10                                                             
         CLI   0(R2),1                                                          
         BR    RE                                                               
         CLI   ELCODE,0                                                         
         BCR   8,RE                                                             
         CLC   ELCODE,0(R2)                                                     
         BCR   8,RE                                                             
*                                                                               
NEXTEL4  SR    RF,RF                                                            
         IC    RF,1(R2)                                                         
         LTR   RF,RF                                                            
         BNZ   *+10                                                             
         CLI   1(R2),1                                                          
         BR    RE                                                               
         AR    R2,RF                                                            
         B     FRSTEL4                                                          
*                                                                               
SAVE3E   DS    F                   A(LAST 3E ELEMENT)                           
*                                                                               
*              TABLE OF DISPLACEMENTS FOR SOFTHEADS                             
*                                                                               
SOFTAB   DC    AL2(HEAD7-ACWORKD+1)                                             
         DC    AL2(HEAD7-ACWORKD+45)                                            
         DC    AL2(HEAD8-ACWORKD+1)                                             
         DC    AL2(HEAD8-ACWORKD+45)                                            
         DC    AL2(HEAD9-ACWORKD+1)                                             
         DC    AL2(HEAD9-ACWORKD+45)                                            
         DC    AL2(HEAD10-ACWORKD+1)                                            
         DC    AL2(HEAD10-ACWORKD+45)                                           
         DC    X'FF'                                                            
         DROP  RA,RB                                                            
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'AC27 - PROFESSIONAL BILLING - SHARED SUBROUTINES'               
SHRR     DS    0D                                                               
         NMOD1 0,**SHRR**,RA                                                    
         L     RC,0(R1)                                                         
         MVC   SUBRMODE,0(R1)                                                   
         CLI   SUBRMODE,SUBRMED                                                 
         BE    GETMEL                                                           
         CLI   SUBRMODE,SUBRCOST                                                
         BE    GTMDVAL                                                          
         CLI   SUBRMODE,SUBRSUML                                                
         BE    SUMLIN                                                           
         CLI   SUBRMODE,SUBRBIN                                                 
         BE    BINADD                                                           
         CLI   SUBRMODE,SUBRNAM                                                 
         BE    NAMEOUT                                                          
         CLI   SUBRMODE,SUBRCHK                                                 
         BE    CHKBILL                                                          
         CLI   SUBRMODE,SUBRDATE                                                
         BE    SETDATE                                                          
         CLI   SUBRMODE,SUBRSUM                                                 
         BE    FORMSUM                                                          
         CLI   SUBRMODE,SUBRREG                                                 
         BE    FORMREG                                                          
         CLI   SUBRMODE,SUBRCLR                                                 
         BE    CLRBUF                                                           
         CLI   SUBRMODE,SUBRTAX                                                 
         BE    TAXANL                                                           
         CLI   SUBRMODE,SUBRREC                                                 
         BE    RECAP                                                            
         CLI   SUBRMODE,SUBRRET                                                 
         BE    RETAIN                                                           
SHRXIT   XIT1                                                                   
         EJECT                                                                  
*                                                                               
*              ROUTINE TO FIND MEDIA ELEMENT                                    
GETMEL   L     R2,ADCOMP                                                        
         AH    R2,DATADISP                                                      
*                                                                               
GTME02   CLI   0(R2),0                                                          
         BNE   *+6                                                              
         DC    H'0'                MISSING MEDIA ELEMENT                        
         CLI   0(R2),X'11'                                                      
         BE    GTME06                                                           
*                                                                               
GTME04   ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     GTME02                                                           
*                                                                               
         USING PMDELD,R2                                                        
GTME06   CLC   PMDCODE,MEDIA                                                    
         BNE   GTME04              NO MATCH LOOK FOR NEXT                       
         ST    R2,AMEL             SAVE ADDRESS OF ELEMENT                      
         B     SHRXIT                                                           
         DROP  R2                                                               
         EJECT                                                                  
*              GET MEDIA ELEMENT - COSTING/INCOME ACCOUNTS                      
*                                                                               
GTMDVAL  DS    0D                                                               
         MVC   MEDIA,JOBLET                                                     
         GOTO1 SHR,DMCB,('SUBRMED',(RC))   GET MEDIA ELEMENT                    
         L     R2,AMEL                                                          
*                                                                               
         USING PMDELD,R2                                                        
GTMV02   MVC   MEDNAME,PMDSPACE    GETS PMDSPACE AND PMDDESC                    
         CLI   MODE,PROCACC                                                     
         BNE   GTMVXIT                                                          
         MVC   SUSPAC,SPACES                                                    
         MVC   SUSPAC(1),QCOMPANY                                               
         MVC   SUSPAC+1(3),=C'123' HARD-BUT CAN BE OVERRIDDEN                   
*                                                                               
         MVC   PRCDACCT,SPACES                                                  
         MVC   PRCDACCT(1),QCOMPANY                                             
         MVC   PRCDACCT+1(4),=C'SIMP'                                           
*                                                                               
         MVC   CDACCT,SPACES                                                    
         MVC   CDACCT(1),QCOMPANY                                               
         MVC   CDACCT+1(4),=C'SIMD'                                             
*                                                                               
         CLI   PMDANAL,X'41'      ANY OVERRIDE?                                 
         BL    *+10                NO                                           
         MVC   SUSPAC+3(1),PMDANAL                                              
         CLI   PMDLN,PMDLN2Q    IS THIS A NEW ELEMENT?                          
         BL    GTMV04              NO                                           
         CLI   PMDCOST,X'41'      YES, ANY COST ANALYSIS ACCOUNT?               
         BL    *+10                NO                                           
         MVC   SUSPAC+3(L'PMDCOST),PMDCOST                                      
*                                                                               
         CLI   PMDPRCD,X'41'      ANY PRINT CD ACCOUNT?                         
         BL    *+10                NO                                           
         MVC   PRCDACCT,PMDPRCD   YES, SAVE IT                                  
*                                                                               
GTMV04   CLI   PMDCSHD,X'41'      ANY PROD CD ACCOUNT?                          
         BL    *+10                NO                                           
         MVC   CDACCT,PMDCSHD     YES, SAVE IT                                  
*                                                                               
         OC    INCACC,INCACC       DID WE GET INCOME ACC FROM GETOPT?           
         BNZ   *+10                YES                                          
         MVC   INCACC,PMDCOM1     NO, GET IT FROM MEDIA                         
         NI    BILLOPT,ALL-MEDIANM                                              
         CLI   PMDLN,X'46'                                                      
         BL    GTMV06                                                           
         TM    PMDSTAT,X'80'                                                    
         BZ    GTMV06                                                           
         OI    BILLOPT,MEDIANM                                                  
*                                                                               
GTMV06   DS    0H                                                               
         L     R4,AIO2             READ INCOME ACCOUNT                          
         MVC   0(42,R4),SPACES                                                  
         MVC   0(15,R4),INCACC                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R4),(R4)                             
         CLC   0(15,R4),INCACC                                                  
         BNE   GTMV14                                                           
         LR    RF,R4                                                            
         AH    RF,DATADISP                                                      
*                                                                               
GTMV08   CLI   0(RF),0                                                          
         BE    GTMV14                                                           
         CLI   0(RF),RSTELQ       GET STATUS ELEMENT                            
         BE    GTMV10                                                           
         CLI   0(RF),SPAELQ       GET SPECIAL POSTING ACCOUNT ELEMENT           
         BE    GTMV13                                                           
*                                                                               
GTMV09   ZIC   R4,1(RF)                                                         
         AR    RF,R4                                                            
         B     GTMV08                                                           
*                                                                               
         USING RSTELD,RF                                                        
GTMV10   OC    RSTCCTR,SPACES                                                   
         CLI   RSTCCTRR,0          IF ZERO START AT COSTING+7                   
         BE    *+20                                                             
         LA    R4,COSTING+2                                                     
         ZIC   R0,RSTCCTRR         INSERT STARTING POINT NUMBER                 
         AR    R4,R0               POINT TO NEW STARTING POINT                  
         B     *+8                                                              
         LA    R4,COSTING+7        COSTING ACCOUNT                              
         LA    R3,3                                                             
         LA    R5,RSTCCTR                                                       
*                                                                               
GTMV12   CLI   0(R5),C' '                                                       
         BE    *+10                                                             
         MVC   0(1,R4),0(R5)       REPLACE OVERRIDES IN COSTING KEY             
         LA    R5,1(R5)                                                         
         LA    R4,1(R4)                                                         
         BCT   R3,GTMV12                                                        
         B     GTMV09                                                           
*                                                                               
         USING SPAELD,RF                                                        
GTMV13   CLI   SPATYPE,SPATANAL     LOOK FOR ANALYSIS POINTER                   
         BNE   GTMV09                                                           
         MVC   SUSPAC+3(L'SPAAULA-2),SPAAULA                                    
         B     GTMV09                                                           
*                                                                               
GTMV14   L     R4,AIO2             READ ACCOUNT KEY                             
         MVC   0(42,R4),SPACES                                                  
         L     R2,ADACC                                                         
         MVC   0(15,R4),0(R2)                                                   
*                                                                               
GTMVXIT  B     SHRXIT                                                           
         DROP  R2                                                               
         EJECT                                                                  
*              ADD DETAIL LINE TO HIGHER LEVELS                                 
*                                                                               
SUMLIN   DS    0D                                                               
         LA    R0,3                WORKCODE/CHARGES/ACCOUNT                     
         LA    R2,JOBWKC                                                        
*                                                                               
SUML02   LA    R1,JOBBKCNT                                                      
         LA    R6,JOBDTL                                                        
*                                                                               
SUML04   AP    0(L'JOBNET,R2),0(L'JOBNET,R6)                                    
         LA    R2,L'JOBNET(R2)                                                  
         LA    R6,L'JOBNET(R6)                                                  
         BCT   R1,SUML04           NUMBER OF BUCKETS                            
         BCT   R0,SUML02           NUMBER OF LEVELS                             
         B     SHRXIT                                                           
         EJECT                                                                  
*              ROUTINE TO ADD TO A BINSRCH TABLE                                
*              PARAM1              A(RECORD TO BE ADDED)                        
*              PARAM2              A(BINSRCH PARAMS)                            
         USING BIND,R5                                                          
BINADD   DS    0D                                                               
         L     R3,4(R1)            A(RECORD)                                    
         L     R5,8(R1)            BINSRCH PARAMETERS                           
         MVC   DMCB+8(16),BININ                                                 
         LA    R2,BINTABLE                                                      
         GOTO1 BINSRCH,DMCB,(1,(R3)),(R2)                                       
         OC    DMCB(4),DMCB                                                     
         BNZ   *+6                                                              
         DC    H'0'                TABLE IS FULL                                
         MVC   BININ,DMCB+8        UPDATE COUNT                                 
         CLI   DMCB,1                                                           
         BE    BINXIT              NOT FOUND - ADDED                            
         L     R4,DMCB             A(RECORD FOUND)                              
         ZIC   R6,BINFRST          DISP. TO FIRST BUCKET                        
         AR    R4,R6               RECORD FOUND                                 
         AR    R3,R6               NEW RECORD                                   
         ZIC   R0,BINNUMB          NUMBER OF BUCKETS                            
         TM    BINSTAT,X'80' BINARY DATA?                                       
         BO    BINBIN              YES                                          
         TM    BINSTAT,X'01'       NO, 6-BYTE PACKED?                           
         BO    BIN6PK              YES                                          
         AP    0(8,R4),0(8,R3)     NO, 8-BYTE PACKED                            
         LA    R4,8(R4)            ADD NEW TO OLD                               
         LA    R3,8(R3)                                                         
         BCT   R0,*-14                                                          
         B     BINXIT                                                           
*                                                                               
BIN6PK   AP    0(6,R4),0(6,R3)                                                  
         LA    R4,6(R4)            ADD NEW TO OLD                               
         LA    R3,6(R3)                                                         
         BCT   R0,*-14                                                          
         B     BINXIT                                                           
*                                                                               
BINBIN   L     RE,0(R3)                                                         
         L     RF,0(R4)                                                         
         AR    RF,RE                                                            
         ST    RF,0(R4)                                                         
         LA    R3,4(R3)                                                         
         LA    R4,4(R4)                                                         
         BCT   R0,BINBIN                                                        
*                                                                               
BINXIT   B     SHRXIT                                                           
         DROP  R5                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*              EXTRACT NAME                                                     
*                                                                               
         USING NAMELD,R2                                                        
NAMEOUT  DS    0D                                                               
         MVC   0(36,R3),SPACES                                                  
         AH    R2,DATADISP                                                      
         SR    RF,RF                                                            
*                                                                               
NAME02   CLI   0(R2),0                                                          
         BE    NAMEXIT                                                          
         CLI   0(R2),X'20'                                                      
         BE    NAME04                                                           
         IC    RF,1(R2)                                                         
         AR    R2,RF                                                            
         B     NAME02                                                           
*                                                                               
NAME04   IC    RF,NAMLN                                                         
         SH    RF,=H'3'                                                         
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),NAMEREC                                                  
*                                                                               
NAMEXIT  B     SHRXIT                                                           
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT A LINE OF DATA FOR SUMMARIES                    *         
***********************************************************************         
*                                                                               
FORMSUM  DS    0D                                                               
         USING JOBD,R6                                                          
         LA    R6,TEMPWK                                                        
         NI    BILLOPT,ALL-CREDIT                                               
         TM    CLIOPT,PAYNET                                                    
         BZ    FORMS02                                                          
         CP    0(L'JOBNET,R6),=P'0'                                             
         BNL   FORMS02                                                          
         OI    BILLOPT,CREDIT                                                   
*                                                                               
FORMS02  LA    R3,P+41                                                          
         LA    R4,JOBNET           NET AMOUNT (EXCLUDING GST)                   
         BAS   RE,FORMIT                                                        
*                                                                               
         LA    R3,P+57                                                          
         LA    R4,JOBCOM           COMMISSION AMOUNT                            
         BAS   RE,FORMIT                                                        
*                                                                               
         LA    R3,P+73                                                          
         LA    R4,JOBPGRS          GROSS AMOUNT (INCLUDING GST & PST)           
         TM    CLIOPT,PAYNET                                                    
         BO    FORMS04                                                          
         CP    JOBPGRS,=P'0'                                                    
         BNL   *+8                                                              
         OI    BILLOPT,CREDIT                                                   
*                                                                               
FORMS04  BAS   RE,FORMIT                                                        
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    FORMSX              NO                                           
         LA    R3,P+87                                                          
         LA    R4,JOBGST           GST AMOUNT                                   
         BAS   RE,FORMIT                                                        
*                                                                               
         TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC?                      
         BZ    FORMSX              NO                                           
         LA    R3,PSECOND+90                                                    
         LA    R4,JOBPST           PST AMOUNT                                   
         BAS   RE,FORMIT                                                        
*                                                                               
FORMSX   XIT1                                                                   
         DROP  R6                                                               
*                                                                               
FORMIT   ST    RE,SAVERE                                                        
         CP    0(L'JOBNET,R4),=P'0'                                             
         BER   RE                                                               
         CURED (P8,0(R4)),(11,0(R3)),2,MINUS=YES                                
         L     RE,SAVERE                                                        
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT A LINE FOR THE BILLING INVOICE REGISTER         *         
***********************************************************************         
*                                                                               
         USING JOBD,R6                                                          
         USING ACPROFSD,R5                                                      
FORMREG  DS    0D                                                               
         LA    R6,TEMPWK                                                        
         L     R5,APROFILE                                                      
         LA    R3,P+40                                                          
         LA    R4,JOBPGRS          GROSS AMOUNT (INCLUDING GST & PST)           
         BAS   RE,FORMIT                                                        
*                                                                               
         LA    R3,P+55                                                          
         LA    R4,JOBNET           NET AMOUNT (EXCLUDING GST)                   
         BAS   RE,FORMIT                                                        
*                                                                               
         LA    R3,P+71                                                          
         LA    R4,JOBCOM           COMMISSION                                   
         BAS   RE,FORMIT                                                        
*                                                                               
         ZAP   DOUBLE,JOBPGRS      GROSS                                        
         CLI   PROF8,C'Y'          C.D. ALREADY IN GROSS COLUMN                 
         BE    *+10                                                             
         AP    DOUBLE,JOBCD                                                     
         LA    R3,P+84                                                          
         LA    R4,DOUBLE                                                        
         CP    DOUBLE,=P'0'                                                     
         BNE   *+10                                                             
         MVC   P+89(3),=C'NIL'                                                  
         BAS   RE,FORMIT                                                        
*                                                                               
         CLI   ACPPFC23,C'Y'       PRINT GST INSTEAD OF CD?                     
         BNE   FORMR02             NO                                           
         LA    R3,P+97             YES                                          
         LA    R4,JOBGST           GST AMOUNT                                   
         BAS   RE,FORMIT                                                        
*                                                                               
         LA    R3,PSECOND+100      DP PST ALSO                                  
         LA    R4,JOBPST           PST AMOUNT                                   
         BAS   RE,FORMIT                                                        
         B     FORMR04                                                          
*                                                                               
FORMR02  LA    R3,P+97                                                          
         LA    R4,JOBCD            CASH DISCOUNT                                
         CP    JOBCD,=P'0'                                                      
         BE    *+8                                                              
         BAS   RE,FORMIT                                                        
*                                                                               
         CLI   ACPPFC24,C'Y'       PRINT GST AS SECOND LINE?                    
         BNE   FORMR04             NO                                           
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST?                          
         BE    FORMR04             NO, SKIP IT                                  
         MVC   PSECOND+70(4),=C'GST='                                           
         LA    R3,PSECOND+74       YES                                          
         LA    R4,JOBGST           GST AMOUNT                                   
         BAS   RE,FORMIT                                                        
*                                                                               
         CP    JOBPST,=P'0'        DO WE HAVE ANY PST?                          
         BE    FORMR04             NO, SKIP IT                                  
         MVC   PTHIRD+73(4),=C'PST='                                            
         LA    R3,PTHIRD+77        YES                                          
         LA    R4,JOBPST           PST AMOUNT                                   
         BAS   RE,FORMIT                                                        
*                                                                               
FORMR04  XIT1                                                                   
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
*              PRINT TAX ANALYSIS                                     *         
***********************************************************************         
*                                                                               
         USING GSTD,R5                                                          
TAXANL   DS    0D                                                               
         L     R3,4(R1)            GET LEVEL                                    
         MVC   LASTPRV,SPACES      CLEAR THE NAME                               
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),(R3)                        
         TM    DMCB+8,X'80'                                                     
         BO    TAXA20                                                           
*                                                                               
         CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   TAXA20              NOT A GST RECORD                             
*                                                                               
         USING JOBD,R6                                                          
TAXA02   CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    TAXA04              YES, SKIP IT                                 
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST?                          
         BNE   TAXA06              YES                                          
         CP    JOBVBAS,=P'0'       NO, DO WE HAVE A BASIS?                      
         BNE   TAXA06              YES                                          
*                                  ELSE GET NEXT RECORD                         
TAXA04   MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),(R3)                      
         TM    DMCB+8,X'80'                                                     
         BO    TAXA20                                                           
         B     TAXA02                                                           
*                                                                               
TAXA06   SR    R1,R1                                                            
         IC    R1,MAXLINES         SEE IF ENOUGH ROOM FOR 3                     
         SR    R2,R2                                                            
         IC    R2,LINE                                                          
         SR    R1,R2                                                            
         CH    R1,=H'7'                                                         
         BH    *+8                                                              
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
         MVI   SPACING,1                                                        
         MVC   P+48(L'AC@TAXAN),AC@TAXAN                                        
         MVC   PSECOND+48(L'AC$TAXAN),AC$TAXAN                                  
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
TAXA10   MVI   SPACING,1                                                        
         MVC   P+24(L'AC@TAX),AC@TAX                                            
         MVC   PSECOND+24(L'AC$TAX),=C'---'                                     
         MVC   P+30(L'AC@ACC#),AC@ACC#                                          
         MVC   PSECOND+30(L'AC$ACC#),AC$ACC#                                    
         MVC   P+51(L'AC@BASIS),AC@BASIS                                        
         MVC   PSECOND+51(L'AC$BASIS),AC$BASIS                                  
         MVC   P+63(L'AC@RATE),AC@RATE                                          
         MVC   PSECOND+63(L'AC$RATE),AC$RATE                                    
         MVC   P+76(L'AC@AMT),AC@AMT                                            
         MVC   PSECOND+76(L'AC$AMT),AC$AMT                                      
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
TAXA14   MVC   P+24(L'AC@VAT1),AC@VAT1                                          
         CLI   PROF22,C'Y'         PRINT REGISTRATION NUMBER?                   
         BNE   TAXA16              NO                                           
         CLC   SVGSTREG,SPACES     YES, DO WE HAVE ONE?                         
         BNH   TAXA16              NO                                           
         MVC   P+31(L'SVGSTREG),SVGSTREG                                        
         GOTO1 RIGHT,DMCB,P+31,L'SVGSTREG                                       
*                                                                               
TAXA16   CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    TAXA19              YES, SKIP IT                                 
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST?                          
         BNE   TAXA18              YES                                          
         CP    JOBVBAS,=P'0'       NO, DO WE HAVE A BASIS?                      
         BE    TAXA19              NO, GET NEXT RECORD                          
*                                                                               
TAXA18   CURED JOBVBAS,(11,P+47),2,MINUS=YES                                    
         TM    GSTINDS,VBIIDC3     ARE THERE 3 DECIMALS PLACES?                 
         BZ    TAXA18A                                                          
         CURED GSTRATE,(7,P+62),3,MINUS=YES,TRAIL=%                             
         B     TAXA18B                                                          
*                                                                               
TAXA18A  CURED GSTRATE,(7,P+62),2,MINUS=YES,TRAIL=%                             
*                                                                               
TAXA18B  CURED JOBGST,(11,P+73),2,MINUS=YES                                     
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
TAXA19   MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),(R3)                      
         TM    DMCB+8,X'80'                                                     
         BZ    TAXA16                                                           
*                                                                               
         USING PSTD,R5                                                          
TAXA20   LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),(R3)                        
         TM    DMCB+8,X'80'                                                     
         BO    TAXA38                                                           
*                                                                               
         CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   TAXA38              NOT A PST RECORD                             
*                                                                               
TAXA21   CLI   PROF22,C'Y'         PRINT REGISTRATION NUMBER?                   
         BNE   TAXA22              NO                                           
         CLC   PSTREG,SPACES       YES, DO WE HAVE A NUMBER?                    
         BE    TAXA22              NO                                           
         MVC   P+31(L'PSTREG),PSTREG                                            
         GOTO1 RIGHT,DMCB,P+31,L'PSTREG                                         
*                                                                               
         USING JOBD,R6                                                          
TAXA22   CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BE    TAXA24              YES, SKIP IT                                 
         LA    R6,PSTACCUM                                                      
         CP    JOBPST,=P'0'        DO WE HAVE ANY PST?                          
         BNE   TAXA26              YES                                          
         CP    JOBPBAS,=P'0'       NO, DO WE HAVE A BASIS?                      
         BNE   TAXA26              YES                                          
*                                  ELSE GET NEXT RECORD                         
TAXA24   MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),(R3)                      
         TM    DMCB+8,X'80'                                                     
         BO    TAXA36                                                           
         B     TAXA21                                                           
*                                                                               
TAXA26   SR    R1,R1                                                            
         IC    R1,MAXLINES         SEE IF ENOUGH ROOM FOR 3                     
         SR    R2,R2                                                            
         IC    R2,LINE                                                          
         SR    R1,R2                                                            
         CH    R1,=H'7'                                                         
         BH    *+8                                                              
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
TAXA28   CLC   LASTPRV,PSTNAME     SAME NAME AS BEFORE?                         
         BE    TAXA32              YES                                          
         MVC   P+24(L'PSTNAME),PSTNAME                                          
         MVC   LASTPRV,PSTNAME                                                  
*                                                                               
TAXA32   CURED JOBPBAS,(11,P+47),2,MINUS=YES                                    
         TM    PSTINDS,PBIIDC3     ARE THERE 3 DECIMALS?                        
         BZ    TAXA33                                                           
         CURED PSTRATE,(7,P+62),3,MINUS=YES,TRAIL=%                             
         B     TAXA34                                                           
*                                                                               
TAXA33   CURED PSTRATE,(7,P+62),2,MINUS=YES,TRAIL=%                             
*                                                                               
TAXA34   CURED JOBPST,(11,P+73),2,MINUS=YES                                     
         MVI   SPACING,1                                                        
         GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
         B     TAXA24                                                           
*                                                                               
TAXA36   MVI   P+24,C'-'           UNDERLINE TAX ANALYSIS                       
         MVC   P+25(60),P+24                                                    
*                                                                               
TAXA38   GOTO1 PRNT,DMCB,('PRNTFRM',(RC))                                       
*                                                                               
TAXAXIT  B     SHRXIT                                                           
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              PRINT TAX RECAP                                        *         
***********************************************************************         
*                                                                               
         USING GSTD,R5                                                          
RECAP    DS    0D                                                               
         L     R3,4(R1)                                                         
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),(R3)                        
         TM    DMCB+8,X'80'                                                     
         BO    RECAP08                                                          
*                                                                               
RECAP02  CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   RECAP08             NOT A GST RECORD                             
*                                                                               
         USING JOBD,R6                                                          
         CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BNE   RECAP04             NO, SKIP IT                                  
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST?                          
         BNE   RECAP06             YES                                          
*                                                                               
RECAP04  MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),(R3)                      
         TM    DMCB+8,X'80'                                                     
         BO    RECAP08                                                          
         B     RECAP02                                                          
*                                                                               
RECAP06  MVI   MYSPACE,1                                                        
         MVC   P+1(L'AC@VAT1),AC@VAT1                                           
         CURED JOBGST,(11,P+41),2,MINUS=YES                                     
         CURED JOBGST,(11,P+73),2,MINUS=YES                                     
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     RECAP04                                                          
*                                                                               
RECAP08  TM    RUNOPT,NEEDPST      DOING PST LOGIC?                             
         BZ    RECAPX              NO                                           
         MVC   LASTNAME,SPACES                                                  
*                                                                               
         USING PSTD,R5                                                          
         LA    R5,BUFWK                                                         
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))    BUFWK CLEAR BUFFWK                  
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),(R3)                        
         TM    DMCB+8,X'80'                                                     
         BO    RECAPX                                                           
*                                                                               
RECAP10  CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   RECAPX              NOT A PST RECORD                             
*                                                                               
         USING JOBD,R6                                                          
         CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BNE   RECAP12             NO, SKIP IT                                  
         LA    R6,PSTACCUM                                                      
         CP    JOBPST,=P'0'        DO WE HAVE ANY PST?                          
         BNE   RECAP14             YES                                          
*                                  ELSE GET NEXT RECORD                         
RECAP12  MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),(R3)                      
         TM    DMCB+8,X'80'                                                     
         BO    RECAPX                                                           
         B     RECAP10                                                          
*                                                                               
RECAP14  MVI   MYSPACE,1                                                        
         MVC   P+1(L'PSTNAME),PSTNAME                                           
         CURED JOBPST,(11,P+41),2,MINUS=YES                                     
         CURED JOBPST,(11,P+73),2,MINUS=YES                                     
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     RECAP12                                                          
*                                                                               
RECAPX   B     SHRXIT                                                           
         DROP  R5,R6                                                            
         EJECT                                                                  
***********************************************************************         
*              POST RETAINER/CONTINGENCY AMOUNT                       *         
***********************************************************************         
*                                                                               
         USING JOBD,R5                                                          
RETAIN   DS    0D                                                               
*                                                                               
         ZAP   TOTRET,TOTTTYP      NO DOLLARS?                                  
         BZ    RETAINX             DON'T CALCULATE                              
*                                                                               
         OC    SVASPCT,SVASPCT     ANY PERCENT?                                 
         BZ    RETAINX             NO                                           
         ZAP   PL13,SVASPCT        YES, IS IT ZERO?                             
         BZ    RETAINX             YES, DON'T CALCULATE                         
*                                                                               
         MP    PL13,TOTRET                                                      
         SRP   PL13,64-4,5                                                      
         ZAP   SVASAMT,PL13        SAVE CONTINGENCY AMOUNT                      
*                                                                               
         CLI   SVASBIL,C'N'        ARE WE BILLING THIS?                         
         BE    RETAINX             NO, EXIT                                     
*                                                                               
         LA    R5,JOBDTL           DO A POSTRANS                                
         MVC   JOBBK(JOBLNQ),ZEROS                                              
         ZAP   JOBNET,SVASAMT                                                   
         ZAP   JOBGRS,SVASAMT                                                   
*                                                                               
         ZAP   JOBVNET,SVASAMT                                                  
         ZAP   JOBVGRS,SVASAMT                                                  
         ZAP   JOBVBAS,SVASAMT                                                  
*                                                                               
         ZAP   JOBPNET,SVASAMT                                                  
         ZAP   JOBPGRS,SVASAMT                                                  
         ZAP   JOBPBAS,SVASAMT                                                  
*                                                                               
         ZAP   JOBOOP,SVASAMT                                                   
*                                                                               
         GOTO1 SHR,DMCB,('SUBRSUML',(RC))                                       
*                                                                               
         USING FRMD,R6                                                          
         LA    R6,BUFWK            DO A POSTFORM                                
         GOTO1 SHR,DMCB,('SUBRCLR',(RC))                                        
         MVC   FRMACCUM(JOBLNQ),JOBDTL                                          
         MVI   FRMTYPE,FRMTYPET                                                 
         CLI   SVASWTYP,C'T'       T AND R = TIME, ELSE OOP                     
         BE    RETA12                                                           
         CLI   SVASWTYP,C'R'                                                    
         BE    RETA12                                                           
         MVI   FRMTYPE,FRMTYPEO                                                 
*                                                                               
         CLI   FORMTYP,C'3'        NO, IS IT 3?                                 
         BE    RETA06              YES                                          
         BL    RETA02              NO, MUST BE 2                                
         CLI   FORMTYP,C'5'        IS THIS FORMAT 5?                            
         BE    RETA06              YES                                          
         BL    RETA02              NO, MUST BE 4                                
         CLI   FORMTYP,C'7'        NO, IS IT 7?                                 
         BE    RETA06              YES                                          
         BL    RETA10              NO, MUST BE FORMAT 6                         
*       - - - - - - - - - -                                                     
         CLI   FORMTYP,C'8'        IS IT 8?                                     
         BE    RETAINX             YES                                          
         DC    H'0'                CAN'T BE HIGHER THAN 8                       
*       - - - - - - - - - -                                                     
RETA02   MVI   FRMVND2,X'FF'       LOGIC FOR 2 AND 4                            
         MVI   FRMWKC2,X'FF'                                                    
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
*                                                                               
         CLI   PROF2,C'N'          PRINT VENDOR DATA?                           
         BE    RETA04              NO                                           
         MVC   FRMVNME,SPACES      YES                                          
         MVC   FRMVNME(L'SVASNAM),SVASNAM                                       
         MVC   FRMVND2,SVASACC+3                                                
         BASR  RE,RF                                                            
*                                                                               
RETA04   CLI   PROF3,C'N'          PRINT WORKCODE DATA ALSO?                    
         BE    RETA22              NO                                           
         MVC   FRMWKC2,SVASWRK                                                  
         MVC   FRMWNME,SVASWRKN                                                 
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
         B     RETA22                                                           
*                                                                               
RETA06   MVI   FRMVND3,X'FF'       LOGIC FOR 3, 5 AND 7                         
         MVI   FRMWKC3,X'FF'                                                    
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
*                                                                               
         CLI   PROF3,C'N'          PRINT WORKCODE DATA?                         
         BE    RETA08              NO                                           
         MVC   FRMWKC3,SVASWRK                                                  
         MVC   FRMWNME,SVASWRKN                                                 
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
*                                                                               
RETA08   CLI   PROF2,C'N'          PRINT VENDOR DATA ALSO?                      
         BE    RETA22              NO                                           
         TM    WKCOPT,WKCDTL       YES, ONE LINE PER WORKCODE?                  
         BZ    RETA22              YES                                          
         MVC   FRMVNME,SPACES                                                   
         MVC   FRMVNME(L'SVASNAM),SVASNAM                                       
         MVC   FRMVND3,SVASACC+3                                                
         BASR  RE,RF                                                            
         B     RETA22                                                           
*                                                                               
RETA10   MVI   FRMOWRK6,X'FF'      LOGIC FOR 6                                  
         MVI   FRMOVNM6,X'FF'                                                   
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
*                                                                               
         MVC   FRMOWRK6,SVASWRK                                                 
         MVC   FRMWNME,SVASWRKN                                                 
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
         B     RETA22                                                           
*                                                                               
RETA12   CLI   FORMTYP,C'6'                                                     
         BNL   RETA14                                                           
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
         B     RETA22                                                           
*                                                                               
RETA14   CLI   FORMTYP,C'7'                                                     
         BNE   RETA16                                                           
         MVC   FRMTWGR7,SVASWGRP                                                
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
         MVI   FRMTWGR7,X'FF'                                                   
         BASR  RE,RF                                                            
         B     RETA22                                                           
*       - - - - - - - - - - - -                                                 
RETA16   CLI   FORMTYP,C'6'                                                     
         BNE   RETAINX                                                          
*       - - - - - - - - - - - -                                                 
         MVI   FRMTUNT6,X'FF'                                                   
         MVI   FRMTWRK6,X'FF'                                                   
         MVI   FRMTPNM6,X'FF'                                                   
         MVI   FRMTRTE6,X'FF'                                                   
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
*                                                                               
         CLI   PROF31,C'Y'                                                      
         BNE   RETA18                                                           
         MVC   FRMTUNT6,SVASACC+1                                               
         MVC   FRMTPNM6,SPACES                                                  
         MVC   FRMTPNM6(L'SVASNAM),SVASNAM                                      
         CLI   PROF30,C'Y'                                                      
         BNE   RETA20                                                           
*                                                                               
RETA18   CLI   PROF30,C'Y'                                                      
         BNE   RETA22                                                           
         MVC   FRMTUNT6,SPACES                                                  
         MVC   FRMTWRK6,SVASWRK                                                 
         MVC   FRMWNME,SVASWRKN                                                 
*                                                                               
RETA20   GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
*                                                                               
         USING MRCD,R6                                                          
RETA22   GOTO1 SHR,DMCB,('SUBRCLR',(RC))                                        
         MVC   MRCACCUM(JOBLNQ),JOBDTL                                          
         MVI   MRCTYPE,MRCTYPE5                                                 
         MVI   MRCMED,X'FF'                                                     
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R6)                                  
*                                                                               
         MVC   MRCMED(12),MEDNAME+3                                             
         TM    WKCOPT,WKCMT                                                     
         BZ    *+14                                                             
         MVC   MRCMED,SVASWRKN                                                  
         OI    JOBOPT,JOBMEDT                                                   
         BASR  RE,RF                                                            
*                                                                               
         TM    JOBOPT,POSTAGY      MAKING STUDI/INTER POSTINGS?                 
         BZ    RETAINX             NO                                           
*                                                                               
         USING WRKD,R6                                                          
         LA    R6,WRKWK            ADD DATA TO BINSRCH                          
         XC    WRKWK,WRKWK                                                      
         MVC   WRKCDE,SVASWRK           AGENCY WORKCODE                         
         MVC   WRKACCUM(JOBLNQ),JOBDTL  ACCUMULATORS                            
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R6),AWRKTAB                           
         MVC   WRKCDE,=XL2'FFFF'                                                
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R6),AWRKTAB                           
*                                                                               
RETAINX  B     SHRXIT                                                           
         DROP  R5,R6                                                            
         EJECT                                                                  
***********************************************************************         
*     READ X'77' ELEMENTS AND DETERMINE WHETHER THERE IS ANY DATA     *         
*     TO BE BILLED, RERUN OR UNBILLED AND GET GST CODE USED.          *         
***********************************************************************         
*                                                                               
CHKBILL  DS    0D                                                               
         MVI   ALLOCATE,C'N'       THERE ARE NO ALLOCATIONS                     
         MVI   CANUNBIL,C'N'       TRANSACTION CANNOT BE UNBILLED               
         MVI   CANRERUN,C'N'       TRANSACTION CANNOT BE RERUN                  
*                                                                               
         USING TRNELD,R2                                                        
         L     R2,ADTRANS                                                       
         CLI   TRNEL,TRNELQ                                                     
         BNE   SHRXIT                                                           
*                                                                               
         USING ACMD,R2                                                          
         L     R2,AMONACC                                                       
         L     R2,ACMAPRO2                                                      
*                                                                               
         TM    BILLMODE,UNBILL                                                  
         BO    CHKUNBL                                                          
*                                                                               
         CLI   0(R2),PTAELQ                                                     
         B     CHKB02+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
CHKB02   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL5                                                       
         BNE   CHKBX               NO MORE, EXIT                                
         CLI   PTATYPE,PTATRAL     ALLOCATED?                                   
         BNE   CHKB02              NO                                           
         TM    PTASTAT1,PTASPEND   STILL PENDING?                               
         BZ    CHKB04              NO, IT'S BILLED                              
         MVI   ALLOCATE,C'Y'       INDICATE ALLOCATIONS EXIST                   
         B     CHKB02              GET NEXT                                     
*                                                                               
CHKB04   TM    PTASTAT1,PTASREVS   IS THIS A REVERSAL?                          
         BO    CHKB02              YES, SKIP IT FOR BILLING                     
         CLC   PTARDATE,TODAY2     WAS IT BILLED TODAY?                         
         BNE   CHKB02              NO                                           
         CLC   PTARFORM,FORMHOLD   YES, IS FORMAT CORRECT?                      
         BNE   CHKB02              NO                                           
         MVI   CANRERUN,C'Y'       YES, INDICATE WE CAN RERUN IT                
         MVC   SVGSTCOD,PTARGSTC   SAVE GST CODE USED                           
         MVC   SVPSTCOD,PTARPSTC   YES, SAVE CODE AND PROVINCE                  
         MVC   SVPSTPRV,PTARPRVC                                                
         B     CHKB02                                                           
*                                                                               
CHKUNBL  TM    BILLMODE,RERUN      RERUN UNBILLING?                             
         BO    CHKU04              YES, READ DIFFERENT RECORDS                  
*                                                                               
         CLI   0(R2),PTAELQ                                                     
         B     CHKU02+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
CHKU02   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL5                                                       
         BNE   CHKBX               NO MORE, EXIT                                
         CLI   PTATYPE,PTATRAL     ALLOCATED?                                   
         BNE   CHKU02              NO                                           
         TM    PTASTAT1,PTASPEND   YES, STILL PENDING?                          
         BZ    CHKU03              NO, BILLED ALREADY                           
         CLI   QOPT3,C'Y'          REALLOCATING?                                
         BNE   CHKU02              NO, CONTINUE                                 
         MVI   PTAEL,X'FF'         YES, DELETE THE ALLOCATION                   
         MVI   MODE,WRITRANS       AND WRITE THE TRANSACTION BACK               
         B     CHKU02              GET NEXT ONE                                 
*                                                                               
CHKU03   CLC   PTARBLDT,USEBILL    CORRECT BILL DATE?                           
         BNE   CHKU02              NO                                           
         CLC   PTARBLNO,QSELECT    YES, CORRECT BILL NUMBER?                    
         BNE   CHKU02              NO                                           
         CLC   PTARDATE,USEDATE    YES, CORRECT RUN DATE?                       
         BNE   CHKU02              NO                                           
         CLC   PTARFORM,FORMHOLD   YES, CORRECT FORMAT/LEVEL?                   
         BNE   CHKU02              NO                                           
         CLI   PTARTYPE,C' '       YES, DO WE HAVE A WORKCODE TYPE?             
         BNH   *+10                NO                                           
         MVC   SVWCTYP,PTARTYPE    YES, REPLACE SVWCTYP WITH IT                 
*                                                                               
         MVC   SVGSTCOD,PTARGSTC   SAVE GST CODE                                
         MVC   SVPSTCOD,PTARPSTC   SAVE PST CODE                                
         MVC   SVPSTPRV,PTARPRVC   SAVE PROVINCE CODE                           
         MVI   CANUNBIL,C'Y'       AND INDICATE UNBILLABLE                      
         B     CHKU02              GET NEXT                                     
*                                                                               
CHKU04   CLI   0(R2),PTAELQ                                                     
         B     CHKU06+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
CHKU06   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL5                                                       
         BNE   CHKBX               NO MORE, CHECK TOTAL                         
         CLI   PTATYPE,PTATRAL     IS THIS ALLOCATED?                           
         BNE   CHKU06              NO                                           
         TM    PTASTAT1,PTASREVS   YES, IS THIS A REVERSAL?                     
         BZ    CHKU06              NO                                           
*                                                                               
         CLC   PTARORGD,USEBILL    YES, DOES ORIGINAL DATE MATCH?               
         BNE   CHKU06              NO                                           
         CLC   PTARORGB,QSELECT    YES, DOES ORIGINAL BILL MATCH?               
         BNE   CHKU06              NO                                           
         CLC   PTARDATE,TODAY2     YES, DOES UNBILL DATE MATCH?                 
         BNE   CHKU06              NO                                           
         CLC   PTARFORM,FORMHOLD   YES, DOES FORMAT/LEVEL MATCH?                
         BNE   CHKU06              NO                                           
         MVI   CANRERUN,C'Y'       INDICATE CAN BE RERUN                        
         CLI   PTARTYPE,C' '       DO WE HAVE A WORKCODE TYPE?                  
         BNH   *+10                NO                                           
         MVC   SVWCTYP,PTARTYPE    YES, REPLACE SVWCTYP WITH IT                 
         MVC   SVGSTCOD,PTARGSTC   SAVE GST CODE, PST & PROVINCE                
         MVC   SVPSTCOD,PTARPSTC                                                
         MVC   SVPSTPRV,PTARPRVC                                                
*                                                                               
CHKBX    B     SHRXIT                                                           
         EJECT                                                                  
***********************************************************************         
*              SET THE DUEDATE FROM GOBLOCK                           *         
***********************************************************************         
*                                                                               
         USING GOBLOCKD,R3                                                      
SETDATE  L     R3,ADGOBLOC                                                      
         SR    R2,R2                                                            
         IC    R2,GODUEDAY                                                      
         LTR   R2,R2               ANY DUE DATE?                                
         BZ    SHRXIT              NO, KEEP FROM REQUEST LEVEL                  
*                                                                               
         CH    R2,=H'10'           IS IT 10 DAYS?                               
         BE    SHRXIT              YES, ALREADY IN DEFAULT                      
*                                                                               
         GOTO1 DATCON,DMCB,(4,BILLDTE),(0,DUB)                                  
         GOTO1 ADDAY,DMCB,DUB,WORK,(R2)                                         
         GOTO1 DATCON,DMCB,(0,WORK),(8,DUEDAT)                                  
         GOTO1 DATCON,DMCB,(0,WORK),(2,DUE2)                                    
         B     SHRXIT                                                           
         DROP  R3                                                               
         EJECT                                                                  
GETEL5   AH    R2,DATADISP                                                      
FRSTEL5  CLI   0(R2),0                                                          
         BNE   *+10                                                             
         CLI   0(R2),1                                                          
         BR    RE                                                               
         CLI   ELCODE,0                                                         
         BCR   8,RE                                                             
         CLC   ELCODE,0(R2)                                                     
         BCR   8,RE                                                             
*                                                                               
NEXTEL5  SR    RF,RF                                                            
         IC    RF,1(R2)                                                         
         LTR   RF,RF                                                            
         BNZ   *+10                                                             
         CLI   1(R2),1                                                          
         BR    RE                                                               
         AR    R2,RF                                                            
         B     FRSTEL5                                                          
*                                                                               
*                                                                               
CLRBUF   LA    RE,BUFWK                                                         
         LA    RF,FRMLNQ           ALL LENGTHS ARE THE SAME                     
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         B     SHRXIT                                                           
         DROP  RA,RB                                                            
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'AC27 - PROFESSIONAL BILLING - END OF JOB ROUTINES'              
ENDR     DS    0D                                                               
         NMOD1 0,**ENDR*,RA,R9                                                  
         L     RC,0(R1)                                                         
         B     CLIREG                                                           
***********************************************************************         
*              CLIENT GROUP BILLING INVOICE REGISTER                  *         
***********************************************************************         
*                                                                               
         USING ACPROFSD,RE                                                      
CLIREG   L     RE,APROFILE                                                      
         MVC   PAGE,=H'1'                                                       
         MVI   FORCEHED,C'Y'                                                    
         MVI   RCSUBPRG,3                                                       
*                                                                               
         CLI   ACPPFC23,C'Y'       ARE WE PRINTING GST INSTEAD OF CD?           
         BNE   *+8                 NO                                           
         MVI   RCSUBPRG,13         YES, CHANGE SPEC                             
         DROP  RE                                                               
*                                                                               
         ZAP   LINES,=P'0'                                                      
         MVC   LASTCLI,SPACES                                                   
         MVC   JOBDTL(JOBLNQ),ZEROS                                             
         OC    ALSORT,ALSORT       ANY SORT RECORDS?                            
         BZ    MEDREG              NO, DO MEDIA REGISTER                        
*                                                                               
CLIR02   GOTO1 SORTER,DMCB,=C'GET'                                              
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BNZ   CLIR04                                                           
         B     CLIR12                                                           
*                                                                               
         USING PBRD,R5                                                          
CLIR04   CLI   PBRTYP,PBREQU       BILLING RECORD?                              
         BNE   CLIR12              NO, DO LAST TOTAL                            
         CLC   LASTCLI,SPACES      THIS FIRST TIME?                             
         BE    CLIR06              YES                                          
         CLC   PBRCLI,LASTCLI      NO, IS IT THE SAME CLIENT?                   
         BNE   CLIR12              NO, DO TOTAL                                 
*                                                                               
*              FORMAT A DETAIL LINE                                             
*                                                                               
CLIR06   MVC   LASTCLI,PBRCLI                                                   
         AP    LINES,=P'1'                                                      
         CP    LINES,=P'1'                                                      
         BNE   CLIR08                                                           
         L     RE,APROFILE                                                      
         USING ACPROFSD,RE                                                      
         CLI   ACPPFC09,C'Y'       NEW PAGE PER CLIENT?                         
         BNE   CLIR08              NO                                           
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
CLIR08   GOTO1 ACREPORT                                                         
         MVC   P+1(1),PBRJOB                                                    
         MVC   P+3(3),PBRCLI                                                    
         MVC   P+7(3),PBRPRD                                                    
         MVC   P+11(6),PBRJOB                                                   
         GOTO1 DATCON,DMCB,(1,PBRDTE),(9,P+22)                                  
         MVC   P+29(10),PBRBILL                                                 
         MVC   TEMPWK,PBRACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRREG',(RC))                                        
         L     RE,APROFILE                                                      
         USING ACPROFSD,RE                                                      
         CLI   ACPPFC11,C'Y'       DOUBLE SPACE REGISTER?                       
         BNE   *+8                 NO                                           
         MVI   SPACING,2                                                        
         GOTO1 ACREPORT                                                         
*                                                                               
*              ADD ACCUMS TO CLIENT TOTAL                                       
*                                                                               
         LA    R2,JOBDTL           CLIENT TOTAL                                 
         LA    R1,JOBBKCNT                                                      
         LA    R4,PBRACCUM                                                      
CLIR10   AP    0(L'JOBNET,R2),0(L'JOBNET,R4)                                    
         LA    R2,L'JOBNET(R2)                                                  
         LA    R4,L'JOBNET(R4)                                                  
         BCT   R1,CLIR10           NUMBER OF BUCKETS                            
         B     CLIR02                                                           
*                                                                               
*              CLIENT TOTAL                                                     
*                                                                               
CLIR12   CP    LINES,=P'1'         MORE THAN 1 LINE FOR CLIENT?                 
         BNH   CLIR14              NO, NO TOTALS NEEDED                         
         MVC   P+1(L'AC@TOTCL),AC@TOTCL                                         
         MVC   P+1+1+L'AC@TOTCL(L'LASTCLI),LASTCLI                              
         MVC   TEMPWK,JOBDTL                                                    
         GOTO1 SHR,DMCB,('SUBRREG',(RC))                                        
         MVI   SPACING,2                                                        
         GOTO1 ACREPORT                                                         
         MVI   SPACING,1                                                        
*                                                                               
CLIR14   ZAP   LINES,=P'0'                                                      
         MVC   JOBDTL(JOBLNQ),ZEROS                                             
         OC    ALSORT,ALSORT       ANY MORE RECORDS?                            
         BZ    MEDREG              NO, DO MEDIA REGISTER                        
         CLI   PBRTYP,PBREQU       PRODUCTION BILLING RECORD?                   
         BE    CLIR06              YES                                          
*                                                                               
CLIRX    B     MEDREG                                                           
         DROP  R5,RE                                                            
         EJECT                                                                  
***********************************************************************         
*              INVOICE REGISTER (MEDIA AND RUN TOTALS)                *         
***********************************************************************         
*                                                                               
         USING BIND,R5                                                          
         USING ACPROFSD,RE                                                      
MEDREG   L     R5,AMEDTAB                                                       
         L     RE,APROFILE                                                      
         MVI   RCSUBPRG,2                                                       
         CLI   ACPPFC23,C'Y'       ARE WE PRINT GST INSTEAD OF CD?              
         BNE   *+8                 NO                                           
         MVI   RCSUBPRG,12         YES, CHANGE SPEC                             
         DROP  RE                                                               
*                                                                               
         OC    BININ,BININ         ANYTHING IN TABLE?                           
         BZ    MEDRX               NO, DO NEXT REGISTER                         
         LA    R5,BINTABLE                                                      
*                                                                               
         USING MESD,R5                                                          
         CLI   PROF9,C'Y'          NEW PAGE PER CLIENT?                         
         BNE   *+8                 NO                                           
         MVI   FORCEHED,C'Y'       YES                                          
         GOTO1 ACREPORT                                                         
         MVC   P+1(L'AC@TMED),AC@TMED                                           
         GOTO1 ACREPORT                                                         
         GOTO1 ACREPORT                                                         
*                                                                               
MEDR02   CLI   MESCDE,X'FF'        TOTAL TIME?                                  
         BE    MEDR06              YES                                          
         MVC   MEDIA,MESCDE        MEDIA CODE                                   
         MVC   P+1(12),MESNME      AND NAME                                     
         MVC   TEMPWK,MESACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRREG',(RC))                                        
         CLC   P+16(100),SPACES    ANYTHING TO PRINT?                           
         BE    MEDR04              NO                                           
         GOTO1 ACREPORT                                                         
*                                                                               
MEDR04   LA    R5,MESLNQ(R5)                                                    
         B     MEDR02                                                           
*                                                                               
MEDR06   GOTO1 ACREPORT            DO TOTALS                                    
         MVC   TEMPWK,MESACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRREG',(RC))                                        
         MVC   P+1(L'AC@TOTRN),AC@TOTRN                                         
         GOTO1 ACREPORT                                                         
*                                                                               
MEDRX    B     INTREG              DO NEXT REGISTER                             
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              INTERNAL INVOICE REGISTER                                        
***********************************************************************         
*                                                                               
         USING INVRD,R5                                                         
INTREG   L     R5,ALSORT                                                        
         LTR   R5,R5               ANY MORE RECORDS?                            
         BZ    INTRX               NO, DO TARGET REGISTER                       
         CLI   INVRTYP,INVREQU     INTERNAL REGISTER RECORD?                    
         BNE   INTRX               NO                                           
*                                                                               
         ZAP   GRDTOT,=P'0'                                                     
         ZAP   MIDTOT,=P'0'                                                     
         ZAP   ITMTOT,=P'0'                                                     
         MVI   RCSUBPRG,5                                                       
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
INTR02   MVC   LASTJOB,INVRCLI                                                  
         MVC   P+1(12),INVRCLI     JOB NO                                       
         MVC   P+27(12),INVRACC    INCOME ACCOUNT                               
         GOTO1 DATCON,DMCB,(1,INVRDTE),(8,P+40)                                 
         MVC   P+58(6),INVRREF                                                  
         CURED INVRAMT,(10,P+69),2,MINUS=YES                                    
         ZAP   ITMTOT,INVRAMT                                                   
         AP    MIDTOT,INVRAMT                                                   
         AP    GRDTOT,INVRAMT                                                   
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 SORTER,DMCB,=C'GET'                                              
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT                                                        
         LTR   R5,R5               ANY MORE RECORDS?                            
         BNZ   INTR04              YES                                          
         B     INTR06              NO, DO TOTAL                                 
*                                                                               
INTR04   CLI   INVRTYP,INVREQU                                                  
         BNE   INTR06              END OF INVOICE REGISTER                      
         CLC   LASTJOB,INVRCLI                                                  
         BE    INTR02                                                           
*                                                                               
INTR06   CP    MIDTOT,ITMTOT                                                    
         BE    INTR08                                                           
         MVI   P+1,C'*'                                                         
         MVC   P+1+1(L'AC@TJOB),AC@TJOB                                         
         MVI   P+1+1+L'AC@TJOB,C'*'                                             
         CURED MIDTOT,(10,P+69),2,MINUS=YES                                     
         MVI   SPACING,2                                                        
         GOTO1 ACREPORT                                                         
*                                                                               
INTR08   ZAP   MIDTOT,=P'0'                                                     
         OC    ALSORT,ALSORT       ANY MORE RECORDS?                            
         BZ    INTR10              NO, DO RUN TOTAL                             
         CLI   INVRTYP,INVREQU     YES, IS THIS AN INTERNAL INVOICE?            
         BNE   INTR10              NO                                           
         B     INTR02                                                           
*                                                                               
INTR10   CP    GRDTOT,=P'0'                                                     
         BE    INTRX                                                            
         GOTO1 ACREPORT                                                         
         MVC   P+1(L'AC@TOTRN),AC@TOTRN                                         
         CURED (P8,GRDTOT),(10,P+69),2,MINUS=YES                                
         GOTO1 ACREPORT                                                         
*                                                                               
INTRX    B     TARGET                                                           
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              REGISTER OF TARGET ACCOUNTS                            *         
***********************************************************************         
*                                                                               
         USING RTAD,R5                                                          
TARGET   L     R5,ALSORT                                                        
         LTR   R5,R5               ANY SORT RECORDS?                            
         BZ    TARGX               NO, LOOK FOR NEXT REGISTER                   
         CLI   RTATYP,RTAEQU       IS THIS A TARGET REGISTER RECORD?            
         BNE   TARGX               NO                                           
*                                                                               
         MVI   RCSUBPRG,7                                                       
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
*                                                                               
TARG02   MVC   P+1(1),RTAJOB                                                    
         MVC   P+3(3),RTACLI                                                    
         MVC   P+7(3),RTAPRD                                                    
         MVC   P+11(6),RTAJOB                                                   
         GOTO1 DATCON,DMCB,(1,RTADTE),(9,P+22)                                  
         MVC   P+29(10),RTABILL                                                 
         MVC   P+40(12),RTAREC                                                  
         MVC   P+55(12),RTACOST                                                 
         MVC   P+71(12),RTASALES                                                
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 SORTER,DMCB,=C'GET'                                              
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT                                                        
         LTR   R5,R5               ANY MORE SORT RECORDS?                       
         BZ    TARGX               NO                                           
*                                                                               
TARG04   CLI   RTATYP,RTAEQU       IS THIS A TARGET REGISTER RECORD?            
         BE    TARG02              YES                                          
*                                                                               
TARGX    B     INTEREG                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              INTERCOMPANY REGISTER                                  *         
***********************************************************************         
*                                                                               
         USING INTD,R5                                                          
INTEREG  L     R5,ALSORT                                                        
         LTR   R5,R5                                                            
         BZ    INTERX              IF NONE, DO TOTALS                           
         CLI   INTRTYP,INTREQU                                                  
         BNE   INTERX                                                           
*                                                                               
         MVI   RCSUBPRG,17                                                      
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         ZAP   MIDTOT,=P'0'        HOLD JOB TOTAL                               
         ZAP   GRDTOT,=P'0'        HOLD FINAL TOTAL                             
*                                                                               
INTER02  MVC   P+1(4),INTRSTUD                                                  
         MVC   LASTSTUD,INTRSTUD   SAVE STUDIO TYPE                             
         GOTO1 ACREPORT                                                         
*                                                                               
INTER03  MVC   P+3(1),INTRMED                                                   
         MVC   P+7(3),INTRSCLI                                                  
         MVC   P+11(3),INTRSPRO                                                 
         MVC   P+15(6),INTRSJOB                                                 
         GOTO1 DATCON,DMCB,(1,INTRDATE),(8,P+22)                                
         MVC   P+34(10),INTRBILL                                                
         CURED INTRAMT,(11,P+49),2,MINUS=YES                                    
         MVC   P+63(12),INTRAJOB                                                
         MVC   P+79(14),INTRCACC                                                
         AP    MIDTOT,INTRAMT                                                   
         AP    GRDTOT,INTRAMT                                                   
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 SORTER,DMCB,=C'GET'                                              
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BZ    INTER06                                                          
*                                                                               
INTER04  CLI   INTRTYP,INTREQU                                                  
         BNE   INTER06                                                          
         CLC   LASTSTUD,INTRSTUD                                                
         BE    INTER03                                                          
*                                                                               
INTER06  MVI   P+1,C'*'                                                         
         MVC   P+2(L'AC@STDIO),AC@STDIO                                         
         MVC   P+2+1+L'AC@STDIO(L'AC@TYPE),AC@TYPE                              
         MVC   P+2+1+1+L'AC@STDIO+L'AC@TYPE(L'INTRSTUD),LASTSTUD                
         MVI   P+2+1+1+1+L'AC@STDIO+L'AC@TYPE+L'INTRSTUD,C'*'                   
         CURED MIDTOT,(11,P+49),2,MINUS=YES                                     
         GOTO1 ACREPORT                                                         
*                                                                               
INTER08  ZAP   MIDTOT,=P'0'                                                     
         OC    ALSORT,ALSORT                                                    
         BZ    INTER10                                                          
         CLI   INTRTYP,INTREQU                                                  
         BNE   INTER10                                                          
         B     INTER02                                                          
*                                                                               
INTER10  MVI   P+1,C'*'                                                         
         MVC   P+2(L'AC@TOTRN),AC@TOTRN                                         
         MVI   P+2+L'AC@TOTRN,C'*'                                              
         CURED GRDTOT,(11,P+49),2,MINUS=YES                                     
         GOTO1 ACREPORT                                                         
*                                                                               
INTERX   B     EXCEREG                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              EXCEPTION REGISTER                                     *         
***********************************************************************         
*                                                                               
         USING EXCD,R5                                                          
EXCEREG  L     R5,ALSORT                                                        
         LTR   R5,R5                                                            
         BZ    EXCERX              IF NONE, DO TOTALS                           
         CLI   EXCRTYP,EXCREQU                                                  
         BNE   EXCERX                                                           
*                                                                               
         MVI   RCSUBPRG,18                                                      
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
*                                                                               
EXCER02  MVC   P+1(L'EXCRSCLI),EXCRSCLI                                         
         MVC   P+5(L'EXCRSPRO),EXCRSPRO                                         
         MVC   P+9(L'EXCRSJOB),EXCRSJOB                                         
         MVC   P+18(L'EXCRSTUD),EXCRSTUD                                        
         MVC   P+25(L'EXCRAJOB),EXCRAJOB                                        
         GOTO1 DATCON,DMCB,(1,EXCRDATE),(8,P+39)                                
         MVC   P+49(L'EXCRBILL),EXCRBILL                                        
         MVC   P+61(L'EXCRMSG),EXCRMSG                                          
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 SORTER,DMCB,=C'GET'                                              
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BZ    EXCERX                                                           
         CLI   EXCRTYP,EXCREQU                                                  
         BE    EXCER02                                                          
*                                                                               
EXCERX   B     NONBILL                                                          
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              SUMMARY OF NON-BILLABLE JOBS                           *         
***********************************************************************         
*                                                                               
         USING NOBD,R5                                                          
NONBILL  L     R5,ALSORT                                                        
         LTR   R5,R5               ANY SORT RECORDS?                            
         BZ    RETREG              NO, DO NEXT REGISTER                         
         CLI   NOBTYP,NOBEQU       IS THIS A NON-BILLABLE RECORD?               
         BNE   RETREG              NO                                           
*                                                                               
         MVI   RCSUBPRG,11                                                      
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
*                                                                               
NONB02   MVC   P+1(3),NOBCLI                                                    
         MVC   P+5(3),NOBPRD                                                    
         MVC   P+9(6),NOBJOB                                                    
         MVC   LASTJOB,NOBCLI                                                   
*                                                                               
NONB04   MVC   P+17(L'NOBDATA),NOBDATA                                          
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 SORTER,DMCB,=C'GET'                                              
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT                                                        
         LTR   R5,R5               ANY MORE SORT RECORDS?                       
         BZ    RETREG              NO                                           
*                                                                               
         CLI   NOBTYP,NOBEQU       IS THIS A NON-BILLABLE RECORD?               
         BNE   RETREG              NO                                           
         CLC   LASTJOB,NOBCLI                                                   
         BNE   NONB02                                                           
         B     NONB04                                                           
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              SUMMARY OF ASP POSTINGS                                *         
***********************************************************************         
*                                                                               
         USING RRSD,R5                                                          
RETREG   L     R5,ALSORT                                                        
         LTR   R5,R5               ANY SORT RECORDS?                            
         BZ    GRPREC              NO, DO NEXT REGISTER                         
         CLI   RRSTYP,RRSEQU       IS THIS A RETAINER RECORD?                   
         BNE   GRPREC              NO                                           
*                                                                               
         ZAP   ITMTOT,=P'0'                                                     
         ZAP   GRDTOT,=P'0'                                                     
         ZAP   MIDTOT,=P'0'                                                     
*                                                                               
         MVI   RCSUBPRG,15                                                      
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
*                                                                               
RETR02   MVC   LASTBIL,RRSBIL                                                   
         MVC   P+1(L'RRSCLI),RRSCLI                                             
         MVC   P+5(L'RRSPRD),RRSPRD                                             
         MVC   P+9(L'RRSJOB),RRSJOB                                             
         MVC   P+18(L'RRSSI),RRSSI                                              
         MVC   P+35(L'RRSWC),RRSWC                                              
         MVC   P+40(L'RRSBILL),RRSBILL                                          
         CURED (P8,RRSAMT),(11,P+53),2,MINUS=YES,ALIGN=RIGHT                    
         ZAP   ITMTOT,RRSAMT                                                    
         AP    MIDTOT,RRSAMT                                                    
         AP    GRDTOT,RRSAMT                                                    
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 SORTER,DMCB,=C'GET'                                              
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT                                                        
         LTR   R5,R5               ANY MORE SORT RECORDS?                       
         BZ    RETR04              NO                                           
*                                                                               
         CLI   RRSTYP,RRSEQU       IS THIS A RETAINER RECORD?                   
         BNE   RETR04              NO                                           
         CLC   LASTBIL,RRSBIL                                                   
         BE    RETR02                                                           
*                                                                               
RETR04   LA    RF,P+5                                                           
         MVC   0(L'AC@TFOR,RF),AC@TFOR                                          
         LA    RF,1+L'AC@TFOR(RF)                                               
         MVC   0(L'AC@BLDIO,RF),AC@BLDIO                                        
         CLI   LASTBIL,C'Y'         BILLED ITEMS?                               
         BE    *+10                                                             
         MVC   0(L'AC@UNBIO,RF),AC@UNBIO                                        
         CURED (P6,MIDTOT),(11,P+53),2,MINUS=YES,ALIGN=RIGHT                    
         MVI   SPACING,2                                                        
         GOTO1 ACREPORT                                                         
*                                                                               
RETR06   ZAP   MIDTOT,=P'0'                                                     
         OC    ALSORT,ALSORT       ANY MORE SORT RECORDS?                       
         BZ    RETR08              NO, DO FINAL TOTAL                           
         CLI   RRSTYP,RRSEQU       YES, IS THIS A RETAINER RECORD?              
         BE    RETR02              YES                                          
*                                                                               
RETR08   CP    GRDTOT,=P'0'                                                     
         BE    GRPREC                                                           
         GOTO1 ACREPORT                                                         
         MVC   P+5(L'AC@TREP),AC@TREP                                           
         CURED (P8,GRDTOT),(11,P+53),2,MINUS=YES,ALIGN=RIGHT                    
         GOTO1 ACREPORT                                                         
         B     GRPREC                                                           
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              GROUP BILLING TRACE RECORDS                            *         
***********************************************************************         
*                                                                               
GRPREC   L     R4,LOGOC                                                         
         USING LOGOD,R4                                                         
         MVI   LOGOTYPE,C'E'                                                    
         GOTO1 LOGO,DMCB,(R4)                                                   
*                                                                               
         TM    BILLMODE,DRAFT                                                   
         BO    ENDX                                                             
*                                                                               
         GOTO1 PRINT,DMCB,=C'CLOSE'                                             
*                                                                               
         USING BIND,R5                                                          
         L     R5,AGRECTAB                                                      
         L     R0,BININ                                                         
         LTR   R0,R0               ANYTHING IN TABLE?                           
         BZ    CONTROL             NO, ALL DONE                                 
*                                                                               
         LA    R5,BINTABLE                                                      
         USING GRECD,R5                                                         
         USING GRBKEY,R2                                                        
         USING BDAELD,R3                                                        
         MVI   FORCEHED,C'Y'                                                    
         MVI   RCSUBPRG,9                                                       
*                                                                               
GREC02   CLI   GRPTYPE,C'0'        GROUP BILLING?                               
         BE    GREC12              NO, JUST PRINT THE DATA                      
*                                                                               
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    GREC04              NO, FORMAT REST OF RECORD                    
*                                                                               
         L     R2,AIO2                                                          
         XC    GRBKEY,GRBKEY                                                    
         MVI   GRBKTYP,GRBKTYPQ                                                 
         MVI   GRBKSUB,GRBKSUBQ                                                 
         MVC   GRBKCPY,CLICODE     (JUST GET COMPANY)                           
         MVC   GRBKCLI(L'GRECCLI),GRECCLI                                       
         OC    GRBKCLI,SPACES                                                   
         MVC   GRBKBILN,GRECBILL                                                
         MVC   GRBKBILD,GRECBDTE                                                
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,X'10'        WAS RECORD FOUND?                            
         BE    GREC04              NO, TREAT AS BILLABLE THEN                   
         CLI   DMCB+8,X'00'        ANY ERRORS?                                  
         BNE   GREC08              YES                                          
*                                                                               
         OI    GRBRSTA,GRBSUNBQ    FOUND RECORD, INDICATE UNBILLED              
         LR    R3,R2                                                            
         AH    R3,DATADISP         UPDATE ELEMENT NOW                           
         MVC   BDAUNUM,GRECUBIL                                                 
         MVC   BDAUNDT,GRECUDTE                                                 
         CLI   RCWRITE,C'N'                                                     
         BE    GREC12                                                           
         GOTO1 DATAMGR,DMCB,DMWRT,FILNME,(R2),(R2)                              
         CLI   DMCB+8,X'00'                                                     
         BE    GREC12                                                           
         DC    H'0'                                                             
*                                                                               
GREC04   LA    R2,AREA                                                          
         XC    AREA(200),AREA                                                   
         MVI   GRBKTYP,GRBKTYPQ                                                 
         MVI   GRBKSUB,GRBKSUBQ                                                 
         MVC   GRBKCPY,CLICODE     (JUST GET COMPANY)                           
         MVC   GRBKCLI(L'GRECCLI),GRECCLI                                       
         OC    GRBKCLI,SPACES                                                   
         MVC   GRBKBILN,GRECBILL                                                
         MVC   GRBKBILD,GRECBDTE                                                
*                                                                               
         LR    R3,R2                                                            
         AH    R3,DATADISP                                                      
         MVI   BDAEL,BDAELQ                                                     
         MVI   BDALN,BDALNQ                                                     
         MVC   BDAFORM(GRECLNQ-GRECKLEN),GRECFORM                               
         OI    GRBRSTA,GRBSPTSQ                                                 
         LH    RF,=YL2(ACCORFST+1)                                              
         AH    RF,=YL2(BDALNQ)                                                  
         STH   RF,GRBRLEN                                                       
         TM    BILLMODE,UNBILL     ARE WE ADDING AN UNBILLING RECORD?           
         BZ    GREC06              NO                                           
         MVC   BDAUNUM,GRECUBIL    YES, SET THESE DATES                         
         MVC   BDAUNDT,GRECUDTE                                                 
         OI    GRBRSTA,GRBSUNBQ    AND MARKED UNBILLED                          
*                                                                               
GREC06   CLI   RCWRITE,C'N'                                                     
         BE    GREC12                                                           
         GOTO1 DATAMGR,DMCB,DMADD,FILNME,(R2),(R2)                              
         CLI   DMCB+8,X'00'        ANY ERRORS                                   
         BE    GREC12              NO                                           
         CLI   DMCB+8,X'20'        RECORD ALREADY THERE?                        
         BE    GREC10              YES, SEE IF RERUNNING                        
*                                                                               
*======================================================================         
*=================== WHOEVER IS IN HERE NEXT ==========================         
* SWAP THE NEXT TWO INSTRUCTIONS AROUND !!!                                     
* LABEL GREC08 SHOULD HAVE THE DC H'0' .                                        
* THE OTHER DC STATEMENT CAN GO RIGHT AFTER THAT.                               
*======================================================================         
GREC08   DC    C'DATA MANAGER ERROR OCCURRED'                                   
         DC    H'0'                                                             
*                                                                               
GREC10   TM    BILLMODE,RERUN      YES, IS THIS A RERUN?                        
         BO    GREC12              YES, OK THEN                                 
         DC    C'DUPLICATE RECORD FOUND'                                        
         DC    H'0'                                                             
*                                                                               
GREC12   MVC   HEAD6+8(3),GRECCLI  PRINT RECORD NOW                             
*                                                                               
         SR    RF,RF               GET 2'S COMPLEMENT                           
         ICM   RF,7,GRECBDTE                                                    
         LNR   RF,RF                                                            
         STCM  RF,7,GRECBDTE                                                    
         GOTO1 DATCON,DMCB,(1,GRECBDTE),(10,HEAD6+31)                           
         GOTO1 ACREPORT                                                         
*                                                                               
GREC14   MVC   P+1(6),GRECBILL                                                  
         BAS   RE,GRPPRNT                                                       
         GOTO1 ACREPORT                                                         
*                                                                               
GREC16   LA    R5,GRECLNQ(R5)                                                   
         BCT   R0,GREC02                                                        
         MVC   P+1(39),=C'ALL GROUP BILLING RECORDS ADDED/UPDATED'              
         MVI   SPACING,3                                                        
         GOTO1 ACREPORT                                                         
         B     CONTROL                                                          
         DROP  R4,R5                                                            
         EJECT                                                                  
***********************************************************************         
*              FORMAT A LINE FOR GROUP BILL PRINT                     *         
***********************************************************************         
*                                                                               
         USING GRECD,R5                                                         
GRPPRNT  NTR1                                                                   
         LA    R4,GRECPAY          SJ AMOUNT                                    
         LA    R3,P+8                                                           
         BAS   RE,GRPOUT                                                        
         LA    R4,GRECREC          SR AMOUNT                                    
         LA    R3,P+20                                                          
         BAS   RE,GRPOUT                                                        
         LA    R4,GRECINC          12 AMOUNT                                    
         LA    R3,P+32                                                          
         BAS   RE,GRPOUT                                                        
         LA    R4,GRECGRS          11 AMOUNT                                    
         LA    R3,P+44                                                          
         BAS   RE,GRPOUT                                                        
         LA    R4,GRECCSH          CD AMOUNT                                    
         LA    R3,P+56                                                          
         BAS   RE,GRPOUT                                                        
         LA    R4,GRECINT          INT AMOUNT                                   
         LA    R3,P+68                                                          
         BAS   RE,GRPOUT                                                        
         LA    R4,GRECTME          TIME AMOUNT                                  
         LA    R3,P+80                                                          
         BAS   RE,GRPOUT                                                        
         LA    R4,GRECOOP          OOP AMOUNT                                   
         LA    R3,P+92                                                          
         BAS   RE,GRPOUT                                                        
         LA    R4,GRECPRE          PRE-BILL AMOUNT                              
         LA    R3,P+104                                                         
         BAS   RE,GRPOUT                                                        
         LA    R4,GRECRET          RETAINER                                     
         LA    R3,P+116                                                         
         BAS   RE,GRPOUT                                                        
         B     ENDX                                                             
*                                                                               
GRPOUT   ST    RE,SAVERE                                                        
         CP    0(L'GRECPAY,R4),=P'0'                                            
         BER   RE                                                               
         CURED (P6,0(R4)),(11,0(R3)),2,MINUS=YES                                
         L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              PRINT LAST PAGE FOR CONTROL                            *         
***********************************************************************         
*                                                                               
CONTROL  DS    0D                                                               
         L     R4,LOGOC                                                         
         USING LOGOD,R4                                                         
         MVI   LOGOTYPE,C'E'                                                    
         GOTO1 LOGO,DMCB,(R4)                                                   
*                                                                               
         TM    BILLMODE,DRAFT                                                   
         BO    ENDX                                                             
         CLI   RCFFPARM,C'T'       IS THIS A TEST RUN?                          
         BE    ENDX                YES, SKIP THIS                               
*                                                                               
         L     RF,VEXTRAS                                                       
         USING RUNXTRAD,RF                                                      
*                                                                               
         GOTO1 TRACK,DMCB,ACWORKD,TAPECASH,MARKED,TAPECNT,WKID                  
         ORG   *-2                                                              
         TM    RUNOPT,TESTRUN      IS THIS A TEST RUN?                          
         BZ    *+8                 NO                                           
         OI    0(R1),X'40'         YES, TELL ACTRACK                            
         TM    RUNOPT,SOON         IS THIS A SOON RUN?                          
         BZ    *+8                 NO                                           
         OI    0(R1),X'20'         YES, TELL ACTRACK                            
         BASR  RE,RF                                                            
*                                                                               
         TM    RUNOPT,SOON                                                      
         BO    ENDX                                                             
         GOTO1 PRINT,DMCB,=C'CLOSE'                                             
*                                                                               
         GOTO1 POSTWRK,DMCB,ACWORKD,(C'R',WKID)                                 
*                                                                               
ENDX     XIT1                                                                   
         DROP  R4,RF                                                            
         DROP  RA,RB                                                            
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'COMMON ROUTINES'                                                
ADDELR   NMOD1 0,**ADDL**                                                       
         L     RC,0(R1)                                                         
         GOTO1 HELLO,DMCB,(C'P',FILNME),(R4),WORK,=C'ADD=CODE'                  
         CLI   DMCB+12,X'00'                                                    
         BE    ADDXIT                                                           
         DC    H'0'                CAN'T ADD THE ELEMENT                        
*                                                                               
ADDXIT   XIT1                                                                   
         DROP  RB                                                               
*                                                                               
REMELR   NMOD1 0,**REML**                                                       
         L     RC,0(R1)                                                         
         GOTO1 HELLO,DMCB,(C'D',FILNME),(X'FF',(R4)),0                          
         CLI   DMCB+12,X'00'                                                    
         BE    REMXIT                                                           
         DC    H'0'                CAN'T DELETE THE ELEMENT                     
*                                                                               
REMXIT   XIT1                                                                   
         DROP  RB                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*              MEDIA SUMMARY TABLE                                              
*                                                                               
MEDTAB   DS    0D                                                               
         DC    F'0'                NUMBER IN TABLE                              
         DC    AL4(MESLNQ)         RECORD LENGTH                                
         DC    AL4(MESKLEN)        DISP. TO KEY/ KEY LENGTH                     
         DC    F'100'              MAX. IN TABLE                                
         DC    AL1(JOBBKCNT)       NUMBER OF BUCKETS                            
         DC    AL1(MESBK-MESD)     DISP. TO BUCKETS                             
         DC    X'00'               PACKED                                       
         DC    AL1(0)                                                           
         DS    (100*MESLNQ)C       TABLE                                        
*                                                                               
*                                                                               
*              GROUP BILLING RECORD TABLE                                       
*                                                                               
GRECTAB  DS    0D                                                               
         DC    F'0'                NUMBER IN TABLE                              
         DC    AL4(GRECLNQ)        RECORD LENGTH                                
         DC    AL4(GRECKLEN)       DISP. TO KEY/ KEY LENGTH                     
         DC    F'250'              MAX. IN TABLE                                
         DC    AL1(GRECBLNQ/6)     NUMBER OF BUCKETS                            
         DC    AL1(GRECBK-GRECD)   DISP. TO BUCKETS                             
         DC    X'01'               PACKED (6-BYTES)                             
         DC    AL1(0)                                                           
         DS    (250*GRECLNQ)C      TABLE                                        
*                                                                               
COMBUF   DS    0D                                                               
         DS    2000C                                                            
*                                                                               
IO2      DS    0D                                                               
         DS    2000C                                                            
*                                                                               
VATBUFF  DS    0D                                                               
         DC    XL(VTCLNQ)'00'                                                   
*                                                                               
SVTABLE  DS    0D                                                               
         DS    CL(SVTABLNQ*TAXNUM)                                              
*                                                                               
USRPOOL  DS    0D                                                               
         DS    CL(USRREC*USRNUM)                                                
*                                                                               
*                                  TABLE OF DATA BY AGENCY WORKCODE             
WRKTAB   DS    0D                                                               
         DC    F'0'                NUMBER IN TABLE                              
         DC    AL4(WRKLNQ)         RECORD LENGTH                                
         DC    AL4(WRKKLEN)        DISP. TO KEY/ KEY LENGTH                     
         DC    F'100'              MAX. IN TABLE                                
         DC    AL1(JOBBKCNT)       NUMBER OF BUCKETS                            
         DC    AL1(WRKBK-WRKD)     DISP. TO BUCKETS                             
         DC    X'00'               PACKED                                       
         DC    AL1(0)                                                           
         DS    (100*WRKLNQ)C       TABLE                                        
*                                                                               
*                                  TABLE OF ACCOUNTS FOR X'C0' ELEMENT          
SUBTAB   DS    0D                                                               
         DS    CL(SUBTABL*SUBTABM)                                              
*                                                                               
*                                  SUBTAB ENTRIES FOR GROUP BILL                
GRPTAB   DS    0D                                                               
         DS    CL(SUBTABL*GRPTABM)                                              
*                                                                               
*                                  WORK FOR NON-BILLABLE RECORDS                
NOBWK    DS    0D                                                               
         DS    CL(NOBLNQ)                                                       
*                                                                               
*                                  INTERCOMPANY RECORDS                         
INTRWK   DS    0D                                                               
         DS    CL(INTRLNQ)                                                      
*                                                                               
*                                  STUDIO RECORDS                               
EXCRWK   DS    0D                                                               
         DS    CL(EXCRLNQ)                                                      
*                                                                               
*                                  POSTING BUFFER FOR WORKER FILE               
POSTBUF  DS    0D                                                               
         DC    4500X'00'                                                        
*                                                                               
*                                  MISCELLANEOUS BUFFER                         
COMPRF   DS    0D                                                               
         DC    256X'00'                                                         
*                                                                               
MYSPECS  DS    0D                                                               
         DC    100X'00'                                                         
         ORG   MYSPECS                                                          
         SPROG 0,1,2,3,4,5,6,7,8,9,12,13,14                                     
         ASPEC F1,2,REQDETS                                                     
         ORG                                                                    
*                                                                               
         BUFF  LINES=500,                                              X        
               ROWS=2,                                                 X        
               COLUMNS=20,                                             X        
               FLAVOR=PACKED,                                          X        
               COMMENT=180,                                            X        
               KEYLIST=(81,A)                                                   
         LTORG                                                                  
         TITLE 'DSECT FOR COMMON STORAGE ADDRESSABLE BY R7'                     
BILLD    DSECT                                                                  
BILLMODE DS    X                                                                
BILL     EQU   X'80'               AC27                                         
ORIG     EQU   X'40'                                                            
DRAFT    EQU   X'20'               AC28                                         
UNBILL   EQU   X'10'               AC29                                         
RERUN    EQU   X'08'                                                            
*                                                                               
BILLTYPE DS    X                                                                
CLIENT   EQU   X'80'                                                            
ALL      EQU   X'FF'                                                            
NOTBILL  EQU   X'00'                                                            
*                                                                               
CLIOPT   DS    X                                                                
CLISUM   EQU   X'80'               PRINT CLIENT SUMMARY                         
PROSUM   EQU   X'40'               PRINT PRODUCT SUMMARY                        
ESTREQ   EQU   X'08'               ESTIMATE REQUIRED                            
PAYNET   EQU   X'04'               PAY=NET OPTION NO LONGER USED                
NOCOMM   EQU   X'02'               PAY NET AND DON'T PRINT COMMISSION           
USELONG  EQU   X'01'               USE WORKCODE LONG NAMES                      
*                                                                               
GRPOPT   DS    X                                                                
GRPBILL  EQU   X'80'               GROUP BILLING                                
*                                                                               
ESTOPT   DS    X                                                                
UNAPP    EQU   X'20'               JOB HAS UNAPPROVED ESTIMATE                  
*                                                                               
RUNOPT   DS    X                                                                
BILNUM   EQU   X'80'               BILL NUMBER ASSIGNED                         
WRITLVA  EQU   X'40'               WRITE LEVEL A                                
WRITLG   EQU   X'20'               WRITE LEDGER                                 
CANAGY   EQU   X'10'               CANADIAN AGENCY                              
NEEDGST  EQU   X'08'               GST RULES APPLY                              
NEEDPST  EQU   X'04'               PST RULES APPLY                              
SOON     EQU   X'02'               RUNNING SOON                                 
TESTRUN  EQU   X'01'               TEST RUN                                     
*                                                                               
BILLOPT  DS    X                                                                
CLINUM   EQU   X'80'               CLIENT BILL NUMBER                           
MEDNUM   EQU   X'40'               MEDIA BILL NUMBER                            
OLDNUM   EQU   X'20'               USE OLD NUMBER                               
LEDNUM   EQU   X'10'               LEDGER BILL NUMBER                           
CREDIT   EQU   X'08'               CREDIT BILL                                  
CASHD    EQU   X'04'               CASH DISCOUNT ON ITEM                        
MEDIANM  EQU   X'02'               PRINT MEDIA NAME IN HEAD LINE                
WRITE    EQU   X'01'               WRITE TRANSACTION                            
*                                                                               
COMMENTS DS    X                                                                
BEFORE   EQU   X'08'               PRINT BEFORE DATA                            
AFTER    EQU   X'04'               PRINT AFTER DATA                             
COMREAD  EQU   X'80'               READ A STANDARD COMMENT                      
*                                                                               
CMPOPT   DS    X                                                                
POSTCOST EQU   X'80'               MAKE COSTING POSTINGS                        
*                                                                               
REQOPT   DS    X                                                                
REQPRDO  EQU   X'80'               PRODUCTION ONLY                              
REQMEDO  EQU   X'40'               MEDIA ONLY                                   
REQAPPO  EQU   X'20'               APPROVED ONLY                                
REQBILL  EQU   X'10'               HAVE STARTING BILL NUMBER                    
*                                                                               
JOBOPT   DS    X                                                                
JOBMEDT  EQU   X'80'               JOB HAS TRANSFER FROM MEDIA                  
JOBX     EQU   X'40'               JOB IS AN X-JOB                              
JBSTUDIO EQU   X'20'               JOB IS A STUDIO                              
POSTAGY  EQU   X'10'               MAKE AGENCY POSTINGS                         
*                                                                               
WKCOPT   DS    X                                                                
WKCDTLC  EQU   X'80'               PRINT WORK-CODE DETAILS/CLIENT LEVEL         
WKCDTL   EQU   X'40'               PRINT WC DETAILS/WORK-CODE LEVEL             
WKCMT    EQU   X'20'               TRANSFER FROM MEDIA                          
*                                                                               
TAXNUM   EQU   30                  MAXIMUM NUMBER OF TAX CODES                  
USRREC   EQU   62                                                               
USRNUM   EQU   6                   MAXIMUM NUMBER OF USER FIELDS                
         EJECT                                                                  
RELO     DS    F                                                                
*                                                                               
ATYPES   DS    0A                                                               
CDFORM   DS    A                   HANDLE CASH DISCOUNT                         
ADD2SUM  DS    A                   ADD TO CLIENT/PRODUCT SUMMARY                
PCLISUM  DS    A                   CLIENT SUMMARY BILL                          
PPROSUM  DS    A                   PRODUCT SUMMARY BILL                         
UNMARK   DS    A                   UNMARK THE 99 TRANSACTION                    
BILLNUM  DS    A                   GET BILL NUMBER AND DATE                     
WARNMSG  DS    A                   PRINT WARNING MESSAGES                       
FILT     DS    A                   EXTRACT SPECIAL VALUES AND FILTER            
POST     DS    A                   POSTING ROUTINES                             
PRNT     DS    A                   PRINTING ROUTINES                            
SHR      DS    A                   SHARED ROUTINES                              
FORM     DS    A                   FORMAT ROUTINES                              
ADDEL    DS    A                   ADD AN ELEMENT ROUTINE                       
REMEL    DS    A                   REMOVE AN ELEMENT ROUTINE                    
END      DS    A                   END OF JOB REPORTS                           
*                                                                               
AOPTTAB  DS    A                                                                
AMEDTAB  DS    A                                                                
AGRECTAB DS    A                                                                
ACOMBUF  DS    A                                                                
AIO2     DS    A                                                                
APOSTBUF DS    A                                                                
AMYSPECS DS    A                                                                
ABUFF    DS    A                                                                
ACOMPRF  DS    A                                                                
AVATBUFF DS    A                                                                
ASVTABLE DS    A                                                                
AUSRPOOL DS    A                                                                
ANOBWK   DS    A                                                                
AINTRWK  DS    A                                                                
AEXCRWK  DS    A                                                                
AWRKTAB  DS    A                                                                
ASUBTAB  DS    A                                                                
AGRPTAB  DS    A                                                                
*                                                                               
SQUASHER DS    V                                                                
ACCEDIT  DS    V                                                                
UNDERLIN DS    V                                                                
SORTER   DS    V                                                                
HELLO    DS    V                                                                
RIGHT    DS    V                                                                
TRACK    DS    V                                                                
*                                                                               
VATICAN  DS    V                                                                
VSSB     DS    V                                                                
*                                                                               
APHASES  DS    0A                  ** ADDRESSES OF LOADED PHASES **             
POSTWRK  DS    A                                                                
         EJECT                                                                  
*              MODES AND MODE EQUATES                                           
PRNTMODE DS    CL1                 PRINT ROUTINES                               
PRNTALL  EQU   1                   PRINT ALL LINES                              
PRNTCOM  EQU   2                   PRINT JOB COMMENTS                           
PRNTFRM  EQU   3                   PRINT FORMATTED DATA                         
PRNTFGP  EQU   4                   PRINT FORMATTED GROUP SUMMARY                
*                                                                               
POSTMODE DS    CL1                 POSTING ROUTINES                             
POSTOPEN EQU   1                   OPEN WORKER FILE                             
POSTBILL EQU   2                   POST A REGULAR BILL                          
POSTSK   EQU   3                   POST SK REVERSAL                             
POSTGRP  EQU   4                   POST GROUP BILL                              
POSTEST  EQU   5                   REVERSE ESTIMATES PRODUCTION                 
POSTCLSE EQU   6                   CLOSE WORKER FILE                            
POSTINTR EQU   7                   MAKE INTERCOMPANY POSTINGS                   
POSTRET  EQU   8                   POSTING A RETAINER                           
*                                                                               
SUBRMODE DS    CL1                 SUB-ROUTINES                                 
SUBRMED  EQU   1                   GET MEDIA CODE                               
SUBRCOST EQU   2                   GET COSTING ACCOUNT                          
SUBRSUML EQU   3                   ADD TO SUMMARY LINE                          
SUBRBIN  EQU   4                   ADD TO BIN TABLE                             
SUBRNAM  EQU   5                   NAME OUT                                     
SUBRCHK  EQU   7                   DETERMINE IF BILLABLE                        
SUBRDATE EQU   8                   GET THE DUEDATE                              
SUBRREG  EQU   10                  FORMAT DETAIL FOR INVOICE REG                
SUBRSUM  EQU   11                  FORMAT DETAIL FOR SUMMARY BILL               
SUBRCLR  EQU   12                  CLEAR BUFWK                                  
SUBRTAX  EQU   13                  FORMAT TAX ANALYSIS                          
SUBRREC  EQU   14                  FORMAT TAX RECAP                             
SUBRRET  EQU   15                  CREATE RETAINER DATA                         
*                                                                               
OUTMODE  DS    CL1                 OUT-OF-POCKET MODES                          
OUTNONE  EQU   0                   NO VENDOR OR WORKCODE DETAIL                 
OUTWKC   EQU   1                   WORKCODE DETAIL ONLY                         
OUTVND   EQU   2                   VENDOR DETAIL ONLY                           
OUTVNW   EQU   3                   VENDOR AND WORKCODE DETAIL                   
*                                                                               
EPTYPE   EQU   47                  ESTIMATED PRODUCTION                         
EPRTYPE  EQU   48                  REVERSAL OF ESTIMATED PROD.                  
         EJECT                                                                  
*              PROGRAM PROFILES                                                 
PROFS    DS    0CL48                                                            
PROF1    DS    CL1                 PRINT VENDOR INVOICE NUMBER                  
PROF2    DS    CL1                 PRINT VENDOR CODE/DESCRIPTION                
PROF3    DS    CL1                 PRINT WORKCODE/DESCRIPTION                   
PROF4    DS    CL1                 PRINT "DUE ON RECEIPT"                       
PROF5    DS    CL1                 SHOW NET/COM/GROSS AS COLUMNS                
PROF6    DS    CL1                 PRINT TARGET ACCOUNT REGISTER                
PROF7    DS    CL1                 SUPPRESS PREVIOUS BILLS                      
PROF8    DS    CL1                 CASH DISCOUNT BY WORK-CODE                   
PROF9    DS    CL1                 NEW PAGE PER CLIENT ON REGISTER              
PROF10   DS    CL1                 SORT REGISTER BY OFFICE                      
PROF11   DS    CL1                 DOUBLE SPACE REGISTER            (C)         
PROF12   DS    CL1                 SUPPRESS DUE DATE                (O)         
PROF13   DS    CL1                 PRINT NAME/ADDRESS IN HEADLINE   (O)         
PROF14   DS    CL1                 PRINT DETAIL NARRATIVE                       
PROF15   DS    CL1                 COMMISSION BY WORKCODE OR TOTAL              
PROF16   DS    CL1                 PRINT AS COMMISSION/HANDLING/FEE             
PROF17   DS    CL1                 BILLING FORMAT                               
PROF18   DS    CL1                    AND RELATED GROUP LEVEL                   
PROF19   DS    CL1                 SUPPRESS STANDARD COMMENTS                   
PROF20   DS    CL1                 PRINT REQUEST DETAILS(DRAFT BILLING)         
PROF21   DS    CL1                 PRINT NON-BILL DETAILS (DRAFT)               
PROF22   DS    CL1                 PRINT REGISTRATION NUMBER OF BIL (C)         
PROF23   DS    CL1                 PRINT TAX INSTEAD OF CD ON REG   (C)         
PROF24   DS    CL1                 PRINT TAX AS 2ND LINE ON REGISTER            
PROF25   DS    CL1                 EXCLUDE TAXES FROM BILLINGS AMOUNT           
PROF26   DS    CL1                 PRINT TIME DETAILS                           
PROF27   DS    CL1                 PRINT WORKCODE LONG NAMES                    
PROF28   DS    CL1                 PRINT INVOICE RECAP                          
PROF29   DS    CL1                 EXCLUDE STAFF FROM TITLE                     
PROF30   DS    CL1                 PRINT TIME BY WORKCODE                       
PROF31   DS    CL1                 PRINT TIME BY PERSON                         
PROF32   DS    CL1                 PRINT DOLLARS WITH COMMAS                    
PROF33   DS    CL1                 USE WORKCODE DESCRIPTION FOR PREBILL         
PROF34   DS    CL1                 EXCLUDE TALENT FOR 1 EXTRA DAY               
PROF35   DS    CL1                 SUPPRESS PROFESS'L SERVICES DATE             
PROF36   DS    CL1                 BILL# PREFIX (0=MM,1=MY,2=YM)                
         DS    CL12                SPARE                                        
         EJECT                                                                  
ZEROS    DS    CL(JOBLNQ)                                                       
JOBDTL   DS    CL(JOBLNQ)          ACCUMS FOR DETAIL                            
JOBWKC   DS    CL(JOBLNQ)          ACCUMS FOR WORK-CODE TOTAL                   
JOBCHG   DS    CL(JOBLNQ)          ACCUMS FOR TOTAL CHARGES                     
JOBTOT   DS    CL(JOBLNQ)          ACCUMS FOR ACCOUNT TOTAL                     
JOBPOS   DS    CL(JOBLNQ)          ACCUMS FOR ACCOUNT POSTINGS                  
JOBMED   DS    CL(JOBLNQ)          ACCUMS FOR ACCOUNT MEDIA TOTALS              
GRPTOT   DS    CL(JOBLNQ)          ACCUMS FOR GROUP BILL                        
TEMPWK   DS    CL(JOBLNQ)          TEMP ACCUMS FOR FORMAT ROUTINE               
*                                                                               
BUFWK    DS    CL(SUMLNQ)          WORK AREA FOR BUFFALO RECORDS                
*                                                                               
*                                                                               
*                                  SORTER WORK AREAS FOR SUMMARIES              
*                                                                               
PBRWK    DS    CL(PBRLNQ)          PROD BILL RECORDS                            
INVRWK   DS    CL(INVRLNQ)         INTERNAL INV. RECORDS                        
RTAWK    DS    CL(RTALNQ)          TARGET REGISTER RECORDS                      
RRSWK    DS    CL(RRSLNQ)          RETAINER RECORDS                             
*                                                                               
*                                                                               
*                                  BINADD WORK AREAS                            
*                                                                               
MESWK    DS    CL(MESLNQ)          WORK FOR MEDIA SUMMARY RECORDS               
WRKWK    DS    CL(WRKLNQ)          WORK FOR WORKCODE SUMMARY RECORDS            
GRECWK   DS    CL(GRECLNQ)         WORK FOR GROUP BILLING RECORDS               
*                                                                               
BUFFTYPE DS    CL1                 VALUES 1-12                                  
BILDATA  DS    CL1                 INDICATOR OF DATA ON BILL                    
JOBDATA  DS    CL1                 INDICATOR OF DATA ON JOB                     
PRTDATA  DS    CL1                 INDICATOR FOR DATA PRINTED                   
FORMHOLD DS    CL2                 HOLD AREA FORMAT #/GROUP TYPE                
*                                                                               
SAVECOMM DS    PL6                 SAVE AREA FOR COMMISSION                     
*                                                                               
SVWCTYP  DS    C                   WORKCODE TYPE                                
SVWNME   DS    CL(L'FRMWNME)       WORKCODE NAME                                
*                                                                               
SVASWRK  DS    CL2                 SAVE CONTINGENCY WORKCODE                    
SVASWRKN DS    CL36                SAVE CONTINGENCY WORKCODE NAME               
SVASWTYP DS    CL1                 SAVE CONTINGENCY WORKCODE TYPE               
SVASWGRP DS    CL1                 SAVE CONTINGENCY WORKCODE GROUP              
SVASPCT  DS    PL4                 SAVE CONTINGENCY PERCENTAGE                  
SVASACC  DS    CL15                SAVE CONTINGENCY ASP ACCOUNT                 
SVASNAM  DS    CL36                SAVE CONTINGENCY ASP ACCOUNT NAME            
SVASAMT  DS    PL8                 SAVE CONTINGENCY AMOUNT                      
SVASBIL  DS    CL1                 SAVE CONTINGENCY BILL OPTION                 
SVASOBIL DS    CL1                 SAVE CONTINGENCY BILL OPTION                 
*                                                                               
SV12ACC  DS    CL15                SAVE 12 ACCOUNT                              
SV12NAM  DS    CL36                SAVE 12 ACCOUNT NAME                         
*                                                                               
SVGSTCOD DS    CL1                 SAVE GOTAXCOD                                
SVGSTRAT DS    XL2                 SAVE GST RATE                                
SVGSTIND DS    X                   SAVE GST RATE DECIMALS                       
SVGSTDAT DS    PL3                 SAVE GST EFFECTIVE DATE                      
SVGSTACC DS    CL15                SAVE GST ACCOUNT CODE                        
SVGSTREG DS    CL12                SAVE GST REGISTRATION NUMBER                 
*                                                                               
SVPSTCOD DS    CL1                 SAVE GOPSTCOD                                
SVPSTPRV DS    CL2                 SAVE GOPSTPRV                                
SVPSTNME DS    CL6                 SAVE PST PROVINCE NAME                       
SVPSTRAT DS    XL2                 SAVE PST RATE                                
SVPSTIND DS    X                   SAVE PST RATE DECIMALS                       
SVPSTDAT DS    PL3                 SAVE PST EFFECTIVE DATE                      
SVPSTACC DS    CL15                SAVE PST ACCOUNT CODE                        
SVPSTREG DS    CL12                SAVE PST REGISTRATION NUMBER                 
*                                                                               
SVTMEHED DS    CL(L'AC@PROFS+L'AC@STAFF+L'AC@SERVE+2)                           
SVOOPHED DS    CL(L'AC@OOP)                                                     
*                                                                               
MOS      DS    CL2                 MONTH OF SERVICE                             
MY       DS    CL2                 MONTH/YEAR                                   
YM       DS    CL2                 YEAR/MONTH                                   
RCDAY2   DS    CL2                 TODAYS DATE OR QSTART                        
*                                                                               
FORMTYP  DS    CL1                 PRINTING FORMAT                              
GRPTYPE  DS    CL1                 P=PRODUCT, C=CLIENT, J=JOB LEVEL             
*                                                                               
CANRERUN DS    C                   RERUN INDICATOR                              
CANUNBIL DS    C                   UNBILLABLE INDICATOR                         
ALLOCATE DS    C                   ALLOCATION INDICATOR                         
*                                                                               
BILLREF  DS    CL6                 BILL NUMBER MM9999/YM9999/MY9999             
BILLNO   DS    PL4                                                              
ESTIMATE DS    PL6                                                              
AMOUNT   DS    PL6                                                              
*                                                                               
TOTBL    DS    PL8                 TOTAL NET                                    
TOTCOMM  DS    PL8                 TOTAL COMMISSION                             
TAPECNT  DS    PL8                 TOTAL NUMBER OF POSTINGS                     
TAPECASH DS    PL8                 TOTAL AMOUNT OF POSTINGS                     
MARKED   DS    PL8                 TOTAL TRANSACTIONS MARKED                    
*                                                                               
JOBINT   DS    PL6                 INTERNAL INCOME (PER JOB)                    
GRPINT   DS    PL6                 INTERNAL INCOME (PER LEVEL)                  
GRPCD    DS    PL6                 CASH DISCOUNT (PER LEVEL)                    
*                                                                               
GRP11    DS    PL6                 AMOUNT FOR 11 GROUP POSTING                  
GRP12    DS    PL6                 AMOUNT FOR 12 GROUP POSTING                  
GRPSJ    DS    PL6                 AMOUNT FOR SJ GROUP POSTING                  
GRPSR    DS    PL6                 AMOUNT FOR SR GROUP POSTING                  
GRPGST   DS    PL6                 AMOUNT FOR GST GROUP POSTING                 
GRPPST   DS    PL6                 AMOUNT FOR PST GROUP POSTING                 
*                                                                               
FRDATE   DS    CL8                 FROM MMM/YY OR MMMDD/YY                      
FRDAT2   DS    CL2                 FROM MONTH/YEAR COMPRESSED                   
TODATE   DS    CL8                 TO MMM/YY OR MMMDD/YY                        
TODAT2   DS    CL2                 TO MONTH/YEAR COMPRESSED                     
*                                                                               
ELCODE   DS    CL1                 ELEMENT CODE                                 
FILNME   DS    CL8                 ACCOUNT                                      
EPRFILT2 DS    CL1                 FILTER 2 VALUE AFTER REVERSING EP            
LEVEL    DS    CL1                 LEVEL OF DATA FOR FORMAT 4/5                 
SAVOTH   DS    CL9                 OTHER NUMBER FROM OTHNUM                     
LNGBILNO DS    CL10                LONG CHARACTER BILL NUMBER                   
SHTBILNO DS    CL7                 SHORT BILL NUMBER                            
JOBLET   DS    CL1                 JOB MEDIA                                    
PREVOPT  DS    CL1                 SUPPRESS PREVIOUS BILLING OPTION             
BILLNAME DS    CL15                                                             
MYSPACE  DS    CL1                                                              
RUNCNT   DS    CL2                 RELATIVE INVOICE NUMBER                      
UNIT     DS    CL2                 OFFICE/ANALYSIS CODE                         
TAXUL    DS    CL2                 UNIT/LEDGER FOR TAX POSTINGS                 
PRODUL   DS    CL2                 UNIT/LEDGER FOR CLIENT PROD/JOB              
RECOFF   DS    CL2                 CLIENT/PRODUCT LEVEL OFFICE                  
*                                                                               
SPECSW   DS    CL1                 INDICATOR FOR SPECS                          
*                                                                               
JGROUP   DS    CL3                 HOLD AREA JOB GROUP                          
HGSTCOD  DS    CL1                 HOLD AREA FOR SVGSTCOD                       
HPSTCOD  DS    CL1                 HOLD AREA FOR SVPSTCOD                       
HPSTPRV  DS    CL2                 HOLD AREA FOR SVPSTPRV                       
*                                                                               
SVANWGP  DS    CL1                 WORKCODE GROUP                               
SVANAL   DS    CL2                 WORK CODE                                    
SVANALN  DS    CL36                DESCRIPTION                                  
SVANALNS DS    CL(L'WCODESC)       SHORT DESCRIPTION                            
*                                                                               
FORMWRK  DS    CL11                WORKAREA FOR FORMATTED DISPLAY               
CHOPWRK  DS    CL120               WORK AREA FOR SQUASHER                       
*                                                                               
NARR     DS    CL(8*19)            HOLD AREA FOR NARRATIVE                      
LINES    DS    PL3                 LINE COUNTER FOR CLIENT REGISTER             
                                                                                
SUBTABM  EQU   32                  MAXIMUM # OF SUBTAB ENTRIES                  
SUBTABN  DS    X                   ACTUAL # OF SUBTAB ENTRIES                   
GRPTABM  EQU   32                  MAXIMUM # OF GRPTAB ENTRIES                  
GRPTABN  DS    X                   ACTUAL # OF GRPTAB ENTRIES                   
                                                                                
SVDBELM  DS    CL(FFTLN1Q+L'FFTDLEN+L'FFTWORK+L'FFTWAMT)                        
SVDBELM2 DS    CL(FFTLN1Q+L'FFTDLEN+9)                                          
                                                                                
PRINTED  DS    C                                                                
ARCHIVE  DS    C                                                                
                                                                                
MNTH     DS    CL2                 THIS MONTH                                   
END2     DS    CL2                 QEND                                         
                                                                                
*                                                                               
         TITLE 'DSECT FOR COMMON STORAGE ADDRESSABLE BY R8'                     
BILLD2   DSECT                                                                  
*                                                                               
LASTMED  DS    CL1                 FIELDS USED BY SUMMARIES                     
LASTCLI  DS    CL3                  AND REGISTERS                               
LASTJOB  DS    CL12                                                             
LASTPRV  DS    CL6                 LAST PROVINCE NAME PRINTED                   
LASTNAME DS    CL36                LAST WORKCODE OR VENDOR NAME PRINTED         
LASTBIL  DS    CL1                 BILLING STATUS                               
LASTSTUD DS    CL4                 LAST STUDIO                                  
*                                                                               
BILLCODE DS    C                   1=BYTE CODE REPRESENTING BILLTYPE            
*                                                                               
SAVEKEY  DS    CL49                                                             
COMMKEY  DS    CL49                                                             
*                                                                               
COMMRATE DS    PL4                 COMMISSION RATE                              
*                                                                               
TOTAL    DS    PL6                                                              
HOURS    DS    PL3                                                              
CASH     DS    PL6                                                              
RATE     DS    PL4                                                              
COMMISH  DS    PL6                                                              
*                                                                               
SCIUNET  DS    PL6                 NET FROM ALLOCATED ELEMENTS                  
SCIUCOM  DS    PL6                 COMMISSION FROM ALLOCATED ELEMENTS           
*                                                                               
READALL  DS    CL1                 READ ALL WORKCODE                            
READTYPM DS    CL1                 READ TYPE M WORKCODES (MEDIA)                
READTYPO DS    CL1                 READ TYPE O WORKCODES (OOP)                  
READTYPP DS    CL1                 READ TYPE P WORKCODES (PREBILL)              
READTYPT DS    CL1                 READ TYPE T WORKCODES (TIME)                 
READTYPR DS    CL1                 READ TYPE R WORKCODES (RETAINER)             
READLNQ  EQU   *-READALL                                                        
*                                                                               
SVAGKEY  DS    0CL15               AGENCY JOB FROM LINK ELEMENT                 
SVAGCUL  DS    CL3                                                              
SVAGACC  DS    0CL12                                                            
SVAGCLI  DS    CL3                                                              
SVAGPRO  DS    CL3                                                              
SVAGJOB  DS    CL6                                                              
*                                                                               
SVAGCLIN DS    CL36                CLIENT NAME                                  
SVAGACN  DS    CL36                AGENCY JOB NAME                              
SVAGOFF  DS    CL2                 AGENCY OFFICE CODE                           
SVAGHOLD DS    CL1                 AGENCY HOLD OPTION                           
SVAGXJOB DS    XL1                 X-JOB INDICATOR                              
*                                                                               
SVELEM   DS    CL(LNKLNQ)          LINK ELEMENT                                 
SVSTUD   DS    CL4                 STUDIO TYPE FROM LINK ELEMENT                
SVAGWC   DS    CL2                 AGENCY WORKCODE FROM OPTIONS                 
SVICR    DS    CL15                INTERCO CREDIT ACCOUNT FROM OPTIONS          
SVVEND   DS    CL15                VENDOR FROM STUDIO TYPE RECORD               
SVVENDN  DS    CL36                VENDOR NAME                                  
SVZERO   DS    C                   OPTION TO ZERO BLLINGS AMOUNT                
                                                                                
COSTING  DS    CL15                COSTING (1C) ACCOUNT                         
SUSPAC   DS    CL15                SUSPENSE (12) ACCOUNT                        
CONTRA   DS    CL15                TYPE 49 CONTRA (1R) ACCOUNT                  
*                                                                               
RECEIVBL DS    CL15                                                             
PRCDACCT DS    CL15                PRINT CASH DISCOUNT ACCOUNT                  
CDACCT   DS    CL15                PROD CASH DISCOUNT ACCOUNT                   
INCACC   DS    CL15                INCOME/COMMISSION ACCOUNT                    
SVEA     DS    CL14                                                             
SVAC     DS    CL14                                                             
SVBI     DS    CL15                                                             
SVBU     DS    CL15                                                             
*                                                                               
CLICODE  DS    CL15                                                             
CLINAME  DS    CL36                                                             
PRDCODE  DS    CL15                                                             
PRDNAME  DS    CL36                                                             
JOBCODE  DS    CL15                                                             
JOBNAME  DS    CL36                                                             
PRODNUM  DS    CL15                                                             
PRODNAM  DS    CL36                                                             
*                                                                               
PRENAME  DS    CL36                DESCRIPTION OF PREBILL WORKCODE              
*                                                                               
BILLINFO DS    CL50                REQUEST LEVEL (CLIENT,PROD,JOB) POB          
POBPRO   DS    CL50                PRODUCT LEVEL PRINT ON BILLS                 
POBJOB   DS    CL50                JOB LEVEL PRINT ON BILLS                     
SOFTH1   DS    10CL43               SOFT HEADLINES                              
ORIGNME  DS    CL33                ORIGIN NAME                                  
ORIGADD  DS    CL33                ORIGIN ADDRESS                               
*                                                                               
ENDATE   DS    CL3                                                              
*                                                                               
WKID     DS    CL(L'FWRWKID)                                                    
LUID     DS    CL(L'FWRLUID)                                                    
PQID     DS    XL(L'FWRPQID)                                                    
USID     DS    XL(L'FWRUSID)                                                    
*                                                                               
MEDIA    DS    CL1                                                              
REBILLNO DS    PL4                 RE-RUN BILL NUMBER                           
DUEDAT   DS    CL8                                                              
MEDNAME  DS    CL15                                                             
SAVCD    DS    PL6                 CASH DISCOUNT FOR ACCOUNT                    
DUESW    DS    CL1                                                              
USEDATE  DS    CL2                                                              
USEBILL  DS    CL2                                                              
USERMC   DS    CL2                                                              
DATE3    DS    CL3                                                              
TODAY2   DS    CL2                                                              
TODAY3   DS    XL3                                                              
TODAYP   DS    XL3                                                              
DUE2     DS    CL2                                                              
CALLDATE DS    CL3                 DATE USED FOR VATICAN CALL                   
BILLDTE  DS    CL8                 START DATE,DATE= OR TODAY'S DATE             
*                                                                               
ALSORT   DS    F                   A(LAST SORT RECORD)                          
AMEL     DS    F                   A(MEDIA ELEMENT)                             
SAVERE   DS    F                   SAVE AREA FOR REGISTER 14                    
SAVERE2  DS    F                   SECOND SAVE AREA FOR REGISTER 14             
*                                                                               
TOTCD    DS    PL8                                                              
TOTGST   DS    PL8                                                              
TOTPST   DS    PL8                                                              
TOTCOM   DS    PL8                                                              
TOTTYPO  DS    PL8                                                              
TOTPREB  DS    PL8                                                              
TOTGRS   DS    PL8                                                              
TOTNET   DS    PL8                                                              
*                                                                               
SUBTOT1  DS    PL8                                                              
SUBTOT2  DS    PL8                                                              
GRANDTOT DS    PL8                 "PLEASE PAY THIS AMOUNT"                     
*                                                                               
TOTOOP   DS    PL8                                                              
TOTTIME  DS    PL8                                                              
TOTTTYP  DS    PL8                                                              
TOTRET   DS    PL8                                                              
*                                                                               
WCODECD  DS    PL6                 CASH DISCOUNT BY WORKCODE                    
ITMTOT   DS    PL6                 ITEM TOTAL ACCUMULATOR                       
MIDTOT   DS    PL6                 MIDDLE TOTAL ACCUMULATOR                     
GRDTOT   DS    PL8                 GRAND TOTAL ACCUMULATOR                      
*                                                                               
AMOUNT11 DS    PL6                 AMOUNT FOR 11 POSTING                        
AMOUNT12 DS    PL6                 AMOUNT FOR 12 POSTING                        
AMOUNTSJ DS    PL6                 AMOUNT FOR SJ POSTING                        
AMOUNTSR DS    PL6                 AMOUNT FOR SR POSTING                        
AMOUNTGS DS    PL6                 AMOUNT FOR GST POSTING                       
AMOUNTPS DS    PL6                 AMOUNT FOR PST POSTING                       
*                                                                               
ELEM     DS    CL(PTARLN1Q)                                                     
*                                                                               
USERPID  DS    XL(L'MCRHPSWD)      USER PID                                     
*                                                                               
PL13     DS    PL13                                                             
SAVEPN   DS    PL6                 TYPE 47 NET                                  
SAVEPC   DS    PL6                 TYPE 47 COMMISSION                           
*                                                                               
         DS    D                                                                
AREA     DS    CL1000              AREA USED FOR POSTINGS                       
         TITLE 'DATA DICTIONARY ENTRIES'                                        
DICO     DS    0C                                                               
         DSDDL PRINT=YES                                                        
*                                                                               
         TITLE 'DSECT FOR JOB ACCUMULATORS'                                     
*                                                                               
JOBD     DSECT                                                                  
JOBBK    EQU   *                                                                
JOBNET   DS    PL8                 NET                                          
JOBCOM   DS    PL8                 COMMISSION                                   
JOBCD    DS    PL8                 CASH DISCOUNT                                
JOBGRS   DS    PL8                 GROSS                                        
*                                                                               
JOBVBAS  DS    PL8                 GST BASIS (JOBNET OR JOBGRS -CD)             
JOBGST   DS    PL8                 GST AMOUNT (JOBVBAS X RATE)                  
JOBVNET  DS    PL8                 JOBNET PLUS JOBGST                           
JOBVGRS  DS    PL8                 JOBGRS PLUS JOBGST                           
*                                                                               
JOBPBAS  DS    PL8                 PST BASIS (JOBVNET OR JOBVGRS -CD)           
JOBPST   DS    PL8                 PST AMOUNT (JOBPBAS X RATE)                  
JOBPNET  DS    PL8                 JOBVNET PLUS JOBPST                          
JOBPGRS  DS    PL8                 JOBVGRS PLUS JOBPST                          
*                                                                               
JOBHRS   DS    PL8                 HOURS                                        
JOBTME   DS    PL8                 TIME (TYPE=T)                                
JOBOOP   DS    PL8                 OUT-OF-POCKET (TYPE=O)                       
JOBPRV   DS    PL8                 PREVIOUSLY BILLED (TYPE=P)                   
JOBPRE   DS    PL8                 PRE-BILLING (TYPE=P/FORMAT 1)                
JOBRET   DS    PL8                 RETAINER (TYPE=R)                            
JOBPRT   DS    PL8                 PRINT WORKCODE (TYPE=M)                      
*                                                                               
JOBFUDGE DS    PL8                 I NEED THIS FOR ZERO TOTALS                  
*                                                                               
JOBBKCNT EQU   (*-JOBBK)/8         NUMBER OF BUCKETS                            
JOBLNQ   EQU   *-JOBD                                                           
         TITLE 'BUFFALO DSECTS'                                                 
*              DSECT TO COVER TYPE 1-2 BUFFALO RECORDS (SUMMARY)                
*                                                                               
SUMD     DSECT                                                                  
SUMKEY   DS    0C                                                               
SUMTYPE  DS    CL1                 TYPE                                         
SUMTYPE1 EQU   1                   TYPE 1 = PRODUCT SUMMARY                     
SUMTYPE2 EQU   2                   TYPE 2 = CLIENT SUMMARY                      
*                                                                               
SUMSORT  DS    0CL80                                                            
SUMCLI1  DS    CL3                 CLIENT                                       
SUMPRD1  DS    CL3                 PRODUCT                                      
SUMMED1  DS    CL1                 MEDIA                                        
SUMJOB1  DS    CL6                 JOB                                          
         DS    CL67                SPARE                                        
         ORG   SUMCLI1                                                          
SUMMED2  DS    CL1                 MEDIA                                        
SUMCLI2  DS    CL3                 CLIENT                                       
SUMPRD2  DS    CL3                 PRODUCT                                      
SUMJOB2  DS    CL6                 JOB                                          
SUMOTH   DS    CL9                 OTHER NUMBER                                 
SUMBILB  DS    CL3                 BINARY BILL NUMBER                           
         DS    CL55                SPARE                                        
SUMKLNQ  EQU   *-SUMKEY                                                         
SUMXTRA  DS    0CL180                                                           
SUMBILNO DS    CL10                BILL NUMBER                                  
SUMNAME  DS    CL36                PRODUCT NAME                                 
         DS    CL134               SPARE                                        
SUMXTLNQ EQU   *-SUMXTRA                                                        
SUMACCUM DS    (JOBLNQ)C                                                        
SUMLNQ   EQU   *-SUMD                                                           
*                                                                               
         EJECT                                                                  
*              DSECT TO COVER TYPE 3 & 4 BUFFALO RECORDS (WORKCODE)             
*                                                                               
TRAD     DSECT                                                                  
TRAKEY   DS    0C                                                               
TRATYPE  DS    CL1                 TYPE                                         
TRATYPE3 EQU   3                   TYPE 3 = PRODUCTION CHARGES                  
TRATYPE4 EQU   4                   TYPE 4 = MEDIA TRANSFER CHARGES              
*                                           LEVEL 1 JOB                         
*                                           LEVEL 2 GROUP                       
*                                                                               
TRASORT  DS    0CL80                                                            
TRAMED   DS    CL1                 MEDIA                                        
TRAPRD   DS    CL3                 PRODUCT                                      
TRAJOB   DS    CL6                 JOB                                          
TRAWKC   DS    CL2                 WORKCODE                                     
TRAREF   DS    CL6                 REFERENCE                                    
         DS    CL62                SPARE                                        
TRAKLNQ  EQU   *-TRAKEY                                                         
TRAXTRA  DS    0CL180                                                           
TRANAME  DS    CL36                JOB NAME                                     
TRABLPR  DS    CL50                PRINT ON BILLS                               
         DS    CL94                SPARE                                        
TRAXTLNQ EQU   *-TRAXTRA                                                        
TRAACCUM DS    CL(JOBLNQ)                                                       
TRALNQ   EQU   *-TRAD                                                           
         EJECT                                                                  
*              DSECT TO COVER TYPE 5 BUFFALO RECORDS (MEDIA RECAP)              
*                                                                               
MRCD     DSECT                                                                  
MRCKEY   DS    0C                                                               
MRCTYPE  DS    CL1                 TYPE                                         
MRCTYPE5 EQU   5                   TYPE 5 = MEDIA TYPE                          
*                                           LEVEL 1 JOB                         
*                                           LEVEL 2 GROUP                       
*                                                                               
MRCSORT  DS    0CL80                                                            
MRCMED   DS    CL15                MEDIA OR WORKCODE NAME                       
         DS    CL65                SPARE                                        
MRCKLNQ  EQU   *-MRCKEY                                                         
MRCXTRA  DS    0CL180                                                           
MRCNAME  DS    CL36                JOB NAME                                     
         DS    CL144               SPARE                                        
MRCXTLNQ EQU   *-MRCXTRA                                                        
MRCACCUM DS    CL(JOBLNQ)                                                       
MRCLNQ   EQU   *-MRCD                                                           
*                                                                               
*                                                                               
         EJECT                                                                  
*              DSECT TO COVER TYPES 6-12 BUFFALO RECORDS (FORMATTED)            
*                                                                               
FRMD     DSECT                                                                  
FRMKEY   DS    0CL1                                                             
FRMTYPE  DS    CL1                                                              
FRMTYPEP EQU   6                   TYPE P = PREBILL WORKCODES                   
FRMTYPET EQU   7                   TYPE T = TIME WORKCODES                      
FRMTYPER EQU   8                   TYPE R = RETAINERS                           
FRMTYPEO EQU   9                   TYPE O = OUT-OF-POCKET WORKCODES             
FRMTYPEL EQU   10                  TYPE P = LAST PREBILL (TYPE 48)              
FRMTYPEB EQU   11                  TYPE B = PREVIOUS BILLING                    
FRMTYPEM EQU   12                  TYPE M = MEDIA TRANSFERS WORKCODES           
FRMTYPE8 EQU   13                  TYPE 8 = ALL TYPES                           
FRMTYPEA EQU   14                  ALL TYPES, EXCEPT B                          
*                                                                               
FRMSORT  DS    0CL80                                                            
FRMWKC0  DS    CL2                 WORKCODE                                     
FRMVND0  DS    CL12                VENDOR ACCOUNT                               
FRMDAT0  DS    CL3                 DATE                                         
FRMREF0  DS    CL6                 REFERENCE                                    
         ORG   FRMREF0                                                          
FRMREFL  DS    CL20                LONG REFERENCE                               
FRMRTE0  DS    PL4                 HOURLY RATE                                  
         DS    CL39                SPARE                                        
         ORG   FRMWKC0                                                          
FRMVND2  DS    CL12                VENDOR ACCOUNT                               
FRMWKC2  DS    CL2                 WORKCODE                                     
         DS    CL66                SPARE                                        
         ORG   FRMWKC0                                                          
FRMWKC3  DS    CL2                 WORKCODE                                     
FRMVND3  DS    CL12                VENDOR ACCOUNT                               
         DS    CL66                SPARE                                        
         ORG   FRMWKC0                                                          
FRMTUNT6 DS    CL1                 UNIT CODE (TIME)                             
FRMTWRK6 DS    CL2                 WORKCODE                                     
FRMTPNM6 DS    CL36                PERSON NAME                                  
FRMTRTE6 DS    PL4                 HOURLY RATE                                  
         DS    CL37                SPARE                                        
         ORG   FRMWKC0                                                          
FRMOWRK6 DS    CL2                 WORKCODE (OOP)                               
FRMOVNM6 DS    CL36                VENDOR NAME                                  
FRMOREF6 DS    CL6                 REFERENCE                                    
         ORG   FRMOREF6                                                         
FRMOREFL DS    CL20                LONG REFERENCE                               
         DS    CL22                SPARE                                        
         ORG   FRMWKC0                                                          
FRMTWGR7 DS    CL1                 WORKCODE GROUP (TIME)                        
         DS    CL79                SPARE                                        
         ORG   FRMWKC0                                                          
FRMUSF8  DS    CL12                USER FIELD                                   
FRMPRD8  DS    CL3                 PRODUCT                                      
FRMJBC8  DS    CL6                 JOB CODE                                     
FRMWRK8  DS    CL2                                                              
         DS    CL57                SPARE                                        
         ORG   ,                                                                
FRMKLNQ  EQU   *-FRMKEY                                                         
FRMXTRA  DS    0CL180                                                           
FRMWNME  DS    CL36                WORKCODE NAME                                
FRMVNME  DS    CL36                VENDOR NAME                                  
FRMNARR  DS    CL100               NARRATIVE                                    
         DS    CL8                 SPARE                                        
         ORG   FRMVNME                                                          
FRMJNME  DS    CL36                JOBNAME                                      
FRMPNME  DS    CL36                PRODUCT NAME                                 
         ORG   ,                                                                
FRMXTLNQ EQU   *-FRMXTRA                                                        
FRMACCUM DS    CL(JOBLNQ)                                                       
FRMLNQ   EQU   *-FRMD                                                           
         EJECT                                                                  
*              DSECT TO COVER BUFFALO RECORDS FOR GST RECAP                     
*                                                                               
GSTD     DSECT                                                                  
GSTKEY   DS    0C                                                               
GSTTYPE  DS    CL1                 TYPE                                         
GSTTYPE5 EQU   15                  TYPE 15 = REGULAR TRANSACTIONS               
*                                                                               
GSTSORT  DS    0CL80                                                            
GSTCODE  DS    CL1                 GST CODE                                     
GSTRATE  DS    XL2                 GST RATE                                     
GSTINDS  DS    X                   GST RATE DECIMALS 0=2, X'80'=3               
GSTACCT  DS    CL15                GST ACCOUNT CODE                             
         DS    CL61                SPARE                                        
GSTKLNQ  EQU   *-GSTKEY                                                         
GSTXTRA  DS    0CL180                                                           
GSTDATE  DS    PL3                 GST EFFECTIVE DATE                           
         DS    CL177               SPARE                                        
GSTXTLNQ EQU   *-GSTXTRA                                                        
GSTACCUM DS    CL(JOBLNQ)                                                       
GSTLNQ   EQU   *-GSTD                                                           
         EJECT                                                                  
*              DSECT TO COVER BUFFALO RECORDS FOR PST RECAP                     
*                                                                               
PSTD     DSECT                                                                  
PSTKY    DS    0C                                                               
PSTTYPE  DS    CL1                 TYPE                                         
PSTTYPE7 EQU   17                  TYPE 17 = REGULAR TRANSACTIONS               
*                                                                               
PSTSORT  DS    0CL80                                                            
PSTCODE  DS    CL1                 PST CODE                                     
PSTRATE  DS    XL2                 PST RATE                                     
PSTINDS  DS    X                   PST RATE DECIMALS 0=2, X'40'=3               
PSTPROV  DS    CL2                 PST PROVINCE CODE                            
PSTACCT  DS    CL15                PST ACCOUNT CODE                             
PSTNAME  DS    CL6                 PST NAME                                     
         DS    CL53                SPARE                                        
PSTKLNQ  EQU   *-PSTKY                                                          
PSTXTRA  DS    0CL180                                                           
PSTDATE  DS    PL3                 PST EFFECTIVE DATE                           
PSTREG   DS    CL12                PST REGISTRATION NUMBER                      
         DS    CL165               SPARE                                        
PSTXTLNQ EQU   *-PSTXTRA                                                        
PSTACCUM DS    CL(JOBLNQ)                                                       
PSTLNQ   EQU   *-PSTD                                                           
         EJECT                                                                  
*              DSECT TO COVER RECORDS FOR PROD. BILLING INVOICE REG.            
*                                                                               
PBRD     DSECT                                                                  
PBRLEN   DS    F                   RECORD LENGTH                                
PBRKY    DS    0C                                                               
PBRTYP   DS    CL1                 TYPE                                         
PBREQU   EQU   1                   PROD. BILLING REGISTER                       
PBRCNT   DS    CL2                 RELATIVE INVOICE NUMBER                      
PBRCLI   DS    CL3                 CLIENT                                       
PBRMED   DS    CL1                 MEDIA                                        
PBRPRD   DS    CL3                 PRODUCT                                      
PBRJOB   DS    CL6                 JOB                                          
PBROTH   DS    CL9                 OTHER NUMBER                                 
PBRKLNQ  EQU   *-PBRKY                                                          
PBRDTE   DS    CL3                 DATE PWOS                                    
PBRBILL  DS    CL10                BILL NUMBER                                  
PBRACCUM DS    CL(JOBLNQ)          ACCUMULATORS - SEE JOBD                      
PBRLNQ   EQU   *-PBRD                                                           
         EJECT                                                                  
*              DSECT TO COVER RECORDS FOR INTERNAL INVOICE REGISTER             
*                                                                               
INVRD    DSECT                                                                  
INVRLEN  DS    F                   RECORD LENGTH                                
INVRKEY  DS    0C                                                               
INVRTYP  DS    CL1                 TYPE                                         
INVREQU  EQU   2                   INTERNAL INVOICE                             
INVRCLI  DS    CL3                 CLIENT                                       
INVRPRD  DS    CL3                 PRODUCT                                      
INVRJOB  DS    CL6                 JOB                                          
INVROTH  DS    CL9                 OTHER NUMBER                                 
INVRKLNQ EQU   *-INVRKEY                                                        
INVRACC  DS    CL12                SK ACCOUNT                                   
INVRDTE  DS    CL3                 SK ITEM DATE PWOS                            
INVRREF  DS    CL6                 SK ITEM REFERENCE                            
INVRAMT  DS    PL8                 SK AMOUNT                                    
INVRLNQ  EQU   *-INVRD                                                          
         EJECT                                                                  
*              DSECT TO COVER RECORDS FOR REGISTER OF TARGET ACCOUNTS           
*                                                                               
RTAD     DSECT                                                                  
RTALEN   DS    F                   RECORD LENGTH                                
RTAKEY   DS    0C                                                               
RTATYP   DS    CL1                 TYPE                                         
RTAEQU   EQU   3                   REGISTER OF TARGET ACCOUNTS                  
RTACLI   DS    CL3                 CLIENT                                       
RTAPRD   DS    CL3                 PRODUCT                                      
RTAJOB   DS    CL6                 JOB                                          
RTAOTH   DS    CL9                 OTHER NUMBER                                 
RTAKLNQ  EQU   *-RTAKEY                                                         
RTADTE   DS    CL3                 DATE PWOS                                    
RTABILL  DS    CL10                BILL NUMBER                                  
RTAREC   DS    CL12                RECEIVABLE ACCOUNT                           
RTACOST  DS    CL12                COSTING ACCOUNT                              
RTASALES DS    CL12                SALES ACCOUNT                                
RTAACCUM DS    CL(JOBLNQ)          ACCUMULATORS - SEE JOBD                      
RTALNQ   EQU   *-RTAD                                                           
         EJECT                                                                  
*                                  INTERCOMPANY REGISTER                        
INTD     DSECT                                                                  
INTRLN   DS    F                   RECORD LENGTH                                
INTRKEY  DS    0C                                                               
INTRTYP  DS    CL1                 TYPE                                         
INTREQU  EQU   4                   INTERCOMPANY POSTING                         
INTRSTUD DS    CL4                 STUDIO TYPE                                  
INTRMED  DS    CL1                 MEDIA CODE                                   
INTRSACC DS    0CL12               STUDIO ACCOUNT                               
INTRSCLI DS    CL3                  CLIENT                                      
INTRSPRO DS    CL3                  PRODUCT                                     
INTRSJOB DS    CL6                  JOB                                         
INTRKLNQ EQU   *-INTRKEY                                                        
INTRDATE DS    PL3                 DATE                                         
INTRBILL DS    CL10                BILL NUMBER                                  
INTRAMT  DS    PL8                 POSTING AMOUNT                               
INTRAJOB DS    CL12                AGENCY JOB                                   
INTRCACC DS    CL14                CREDIT ACCOUNT                               
INTRLNQ  EQU   *-INTD                                                           
         EJECT                                                                  
*                                  EXCEPTION REGISTER                           
EXCD     DSECT                                                                  
EXCRLN   DS    F                   RECORD LENGTH                                
EXCRKEY  DS    0C                                                               
EXCRTYP  DS    CL1                 TYPE                                         
EXCREQU  EQU   5                   STUDIO REGISTER                              
EXCRSTUD DS    CL4                 STUDIO TYPE                                  
EXCRSACC DS    0CL12               STUDIO ACCOUNT                               
EXCRSCLI DS    CL3                  CLIENT                                      
EXCRSPRO DS    CL3                  PRODUCT                                     
EXCRSJOB DS    CL6                  JOB                                         
EXCRKLNQ EQU   *-EXCRKEY                                                        
EXCRDATE DS    PL3                 DATE                                         
EXCRBILL DS    CL10                BILL NUMBER                                  
EXCRAJOB DS    CL12                AGENCY JOB                                   
EXCRMSG  DS    CL60                WARNING MESSAGE                              
EXCRLNQ  EQU   *-EXCD                                                           
         EJECT                                                                  
*              DSECT TO COVER RECORDS FOR NO-BILLING                            
*                                                                               
NOBD     DSECT                                                                  
NOBLEN   DS    F                   RECORD LENGTH                                
NOBKEY   DS    0C                                                               
NOBTYP   DS    CL1                 TYPE                                         
NOBEQU   EQU   6                   SUMMARY OF NON-BILLABLE JOBS                 
NOBCLI   DS    CL3                 CLIENT                                       
NOBPRD   DS    CL3                 PRODUCT                                      
NOBJOB   DS    CL6                 JOB                                          
NOBRSN   DS    CL1                 REASON CODE                                  
         DS    CL8                                                              
NOBKLNQ  EQU   *-NOBKEY                                                         
NOBDATA  DS    CL70                NARRATIVE                                    
NOBLNQ   EQU   *-NOBD                                                           
         EJECT                                                                  
*              DSECT TO COVER RECORDS FOR RETAINERS                             
*                                                                               
RRSD     DSECT                                                                  
RRSLEN   DS    F                   RECORD LENGTH                                
RRSKEY   DS    0C                                                               
RRSTYP   DS    CL1                 TYPE                                         
RRSEQU   EQU   7                   SUMMARY OF RETAINER JOBS                     
RRSBIL   DS    CL1                 BILLING STATUS                               
RRSCLI   DS    CL3                 CLIENT                                       
RRSPRD   DS    CL3                 PRODUCT                                      
RRSJOB   DS    CL6                 JOB                                          
         DS    CL8                                                              
RRSKLNQ  EQU   *-RRSKEY                                                         
RRSSI    DS    CL14                SI ACCOUNT                                   
RRSWC    DS    CL2                 WORKCODE                                     
RRSBILL  DS    CL10                BILL NUMBER                                  
RRSAMT   DS    PL8                 CONTINGENCY AMOUNT                           
         DS    CL26                SPARE                                        
RRSLNQ   EQU   *-RRSD                                                           
         TITLE 'BINSRCH DSECTS'                                                 
*             DSECT FOR MEDIA SUMMARY RECORDS                                   
*                                                                               
MESD     DSECT                                                                  
MESCDE   DS    CL1                 MEDIA CODE                                   
         DS    CL3                 SPARE                                        
MESKLEN  EQU   *-MESD                                                           
MESNME   DS    CL12                MEDIA NAME                                   
MESBK    EQU   *                                                                
MESACCUM DS    CL(JOBLNQ)          ACCUMULATORS - SEE JOBD                      
MESLNQ   EQU   *-MESD                                                           
         EJECT                                                                  
*                                  WORKCODE SUMMARY RECORDS                     
WRKD     DSECT                                                                  
WRKCDE   DS    CL2                 WORKCODE                                     
         DS    CL2                 SPARE                                        
WRKKLEN  EQU   *-WRKD                                                           
WRKBK    EQU   *                                                                
WRKACCUM DS    CL(JOBLNQ)          ACCUMULATORS - SEE JOBD                      
WRKLNQ   EQU   *-WRKD                                                           
         EJECT                                                                  
*             DSECT FOR GROUP BILLING RECORDS                                   
*                                                                               
GRECD    DSECT                                                                  
GRECCLI  DS    CL3                 CLIENT CODE (CLICODE)                        
GRECBILL DS    CL6                 BILL NUMBER (BILLNO) / (QSELECT)             
GRECBDTE DS    XL3                 BILL DATE (BILLDTE) / (QEND)                 
GRECKLEN EQU   *-GRECD                                                          
*                                                                               
GRECFORM DS    CL1                 FORMAT (FORMTYP)                             
GRECLVL  DS    CL1                 LEVEL (GRPTYPE)                              
GRECFDTE DS    XL2                 FROM DATE (FRDAT2)                           
GRECTDTE DS    XL2                 TO DATE (TODAT2)                             
GRECTYPE DS    CL1                 BILLTYPE (BILLTYP)                           
GRECRDTE DS    XL3                 RUN DATE (RCDATE)                            
GRECDDTE DS    XL3                 DUE DATE (DUEDATE)                           
GRECRECA DS    CL15                RECEIVABLE (RECEIVABL)                       
GRECROFF DS    CL2                 RECEIVABLE OFFICE (RECOFF)                   
GRECUBIL DS    CL6                 UNBILL BILL NUMBER (BILLNO)                  
GRECUDTE DS    XL3                 UNBILL DATE (BILLDTE)                        
         DS    CL6                 SPARE                                        
*                                                                               
GRECBK   EQU   *                                                                
GRECACCS DS    0CL(GRECBLNQ)       PACKED FIELDS                                
GRECPAY  DS    PL6                 AMOUNTSJ                                     
GRECREC  DS    PL6                 AMOUTSR                                      
GRECINC  DS    PL6                 AMOUNT12                                     
GRECGRS  DS    PL6                 AMOUNT11                                     
GRECCSH  DS    PL6                 JOBCD                                        
GRECINT  DS    PL6                 INTAMT                                       
GRECTME  DS    PL6                 TIME                                         
GRECOOP  DS    PL6                 OUT-OF-POCKET                                
GRECPRV  DS    PL6                 PREVIOUSLY BILLED                            
GRECPRE  DS    PL6                 PRE-BILLING                                  
GRECRET  DS    PL6                 RETAINER                                     
GRECPRT  DS    PL6                 PRINT                                        
GRECBLNQ EQU   *-GRECPAY                                                        
GRECLNQ  EQU   *-GRECD                                                          
         EJECT                                                                  
*              DSECT FOR THE BINSRCH LIST                                       
*                                                                               
BIND     DSECT                                                                  
BININ    DS    F                   NUMBER IN TABLE                              
BINLEN   DS    F                   RECORD LENGTH                                
BINDISP  DS    CL1                 DISPLACEMENT IN RECORD                       
BINKEY   DS    CL3                 KEY LENGTH                                   
BINMAX   DS    F                   MAXIMUM NUMBER IN TABLE                      
BINNUMB  DS    CL1                 NUMBER OF BUCKETS                            
BINFRST  DS    CL1                 DISP. TO FIRST BUCKET                        
BINSTAT  DS    CL1                 X'80' BINARY DATA                            
         DS    CL1                 SPARE                                        
BINTABLE DS    0CL1                                                             
         EJECT                                                                  
*              DSECT FOR THE NARRATIVE OF A BILLING RECORD                      
*                                                                               
NARRD    DSECT                                                                  
NARDESC  DS    CL15      0         DESCRIPTION (50 PC ESTIMATE ETC)             
NARCOMM  DS    PL6       15        COMMISSION BILLED                            
NARCSHD  DS    PL6       21        CASH DISCOUNT                                
NARPAY   DS    PL6       27        PAYABLE AMOUNT                               
NARTODAY DS    XL2       33        TODAYS DATE                                  
NARUNBIL DS    XL2       35        UNBILLED DATE                                
NARSKPSI DS    XL2       37        DATE SK INCOME POSTED TO SI                  
NARMEDC  DS    PL6       39        MEDIA COSTS INCLUDED IN BILL TOTAL           
NARSKINC DS    PL6       45        AMOUNT OF INCOME POSTED TO SK                
NARFLTWC DS    CL2       51        QTRNSFLT (WORKCODE) AA OR *AA                
NARTLPCT DS    PL4       53        PERCENT- RETAIL DISTRIBUTION                 
         DS    PL6       57                                                     
         DS    PL6       63                                                     
         DS    PL6       69                                                     
         DS    PL6       75                                                     
         DS    PL6       81                                                     
         DS    PL6       87                                                     
NARRLNQ  EQU   *-NARRD                                                          
         EJECT                                                                  
*              DSECT FOR OPTTTAB                                                
*                                                                               
OPTTABD  DSECT                                                                  
OPTLEN   DS    0CL15                                                            
OPTFORM  DS    CL1                 PRINT FORMAT                                 
OPTALL   DS    CL1                 READ ALL WORKCODES      Y OR N               
OPTTYPM  DS    CL1                 READ TYPE M WORKCODES   Y OR N               
OPTTYPO  DS    CL1                 READ TYPE O WORKCODE    Y OR N               
OPTTYPP  DS    CL1                 READ TYPE P WORKCODE    Y OR N               
OPTTYPT  DS    CL1                 READ TYPE T WORKCODES   Y OR N               
OPTTYPR  DS    CL1                 READ TYPE R WORKCODES   Y OR N               
         DS    CL8                 SPARE                                        
         EJECT                                                                  
*              DSECT FOR BILLTAB                                                
*                                                                               
BILLTD   DSECT                                                                  
BILLEN   DS    0CL20                                                            
BILLNME  DS    CL15                BILLING TYPE NAME                            
BILLCDE  DS    CL1                 BILLING CODE                                 
BILLTRNS DS    CL1                 READ TRANSACTIONS Y OR N                     
BILLCOD  DS    CL1                 BILL TYPE CODE TRNBTYPE                      
         DS    CL1                 SPARE                                        
BILLTYP  DS    XL1                 BILL TYPE                                    
         EJECT                                                                  
*ACGENFILE                                                                      
         PRINT OFF                                                              
       ++INCLUDE ACGENFILE                                                      
         PRINT ON                                                               
*ACREPWORKD                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACREPWORKD                                                     
         PRINT ON                                                               
*ACMASTD                                                                        
         PRINT OFF                                                              
       ++INCLUDE ACMASTD                                                        
         PRINT ON                                                               
*ACGENMODES                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACGENMODES                                                     
         PRINT ON                                                               
         EJECT                                                                  
SVTABD   DSECT                                                                  
SVTYPE   DS    CL1                 G=GST, P=PST                                 
SVCODE   DS    CL1                 TAX CODE                                     
SVPROV   DS    CL2                 PROVINCE CODE (PST)                          
SVRATE   DS    XL2                 TAX RATE                                     
SVINDS   DS    X                   TAX RATE DECIMALS                            
SVNAME   DS    CL6                 PROVINCE NAME                                
SVACCT   DS    CL15                POSTING ACCOUNT                              
SVDATE   DS    PL3                 EFFECTIVE DATE                               
SVTABLNQ EQU   *-SVTABD                                                         
         EJECT                                                                  
SUBTABD  DSECT                                                                  
SUBACT   DS    0C                                                               
SUBSTA   DS    XL(L'APENSTAT)      STATUS                                       
SUBACC   DS    CL(L'APENACT)       ACCOUNT                                      
SUBTABL  EQU   *-SUBTABD                                                        
         EJECT                                                                  
       ++INCLUDE ACVATICAND                                                     
         EJECT                                                                  
       ++INCLUDE DDCTRYEQUS                                                     
         EJECT                                                                  
       ++INCLUDE ACGENPOST                                                      
         EJECT                                                                  
JBLOCKD  DSECT                                                                  
       ++INCLUDE ACJOBBLOCK                                                     
         EJECT                                                                  
*ACJOBBERD                                                                      
         PRINT OFF                                                              
       ++INCLUDE ACJOBBERD                                                      
         PRINT ON                                                               
GOBLOCKD DSECT                                                                  
       ++INCLUDE ACGOBLOCK                                                      
         EJECT                                                                  
GOXBLKD  DSECT                                                                  
       ++INCLUDE ACGOXBLOCK                                                     
         EJECT                                                                  
*ACREPPROFD                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACREPPROFD                                                     
         PRINT ON                                                               
*DDLOGOD                                                                        
         PRINT OFF                                                              
       ++INCLUDE DDLOGOD                                                        
         PRINT ON                                                               
*DDREPXTRAD                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDREPXTRAD                                                     
         PRINT ON                                                               
*DDREPMASTD                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDREPMASTD                                                     
         PRINT ON                                                               
*DDREMOTED                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDREMOTED                                                      
         PRINT ON                                                               
*ACWCNTABD                                                                      
         PRINT OFF                                                              
       ++INCLUDE ACWCNTABD                                                      
         PRINT ON                                                               
*ACDDEQUS                                                                       
         PRINT OFF                                                              
       ++INCLUDE ACDDEQUS                                                       
         PRINT ON                                                               
*DDCUREDITD                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCUREDITD                                                     
         PRINT ON                                                               
*ACQD                                                                           
         PRINT OFF                                                              
       ++INCLUDE ACQD                                                           
         PRINT ON                                                               
*SRUPDD                                                                         
         PRINT OFF                                                              
       ++INCLUDE SRUPDD                                                         
         PRINT ON                                                               
*FASSBOFF                                                                       
         PRINT OFF                                                              
       ++INCLUDE FASSBOFF                                                       
         PRINT ON                                                               
* DDCOREQUS                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCOREQUS                                                      
         PRINT ON                                                               
* CTGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE CTGENFILE                                                      
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'072ACREP2702 04/20/16'                                      
         END                                                                    
