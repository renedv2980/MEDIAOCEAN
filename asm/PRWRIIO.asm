*          DATA SET PRWRIIO    AT LEVEL 177 AS OF 02/07/20                      
*PHASE T00A4CA,*                                                                
*INCLUDE BINSRCH2                                                               
*INCLUDE GETADVC                                                                
*INCLUDE PPBYOUT                                                                
*INCLUDE QSORT                                                                  
*INCLUDE ADDAY                                                                  
*INCLUDE PPGETPO#                                                               
*               T00A4C - PRWRIIO - PRINTWRITER IO HANDLER                       
         TITLE 'T00A4C - PRWRIIO - PRINTWRITER IO HANDLER'                      
***********************************************************************         
* USER    JIRA       DATE                  CHANGE LOG                 *         
* ---- ----------  -------- ----------------------------------------- *         
* AKAT SPEC-42954  02/05/20 OPTIMIZE CLEARANCE BUFFER                 *         
* AKAT SPEC-31455  01/23/19 INCREASE CLEARANCE BUFFER                 *         
* AKAT SPEC-22216  11/05/18 SUPPORT NEW MEDIA TYPE "D" (DIGITAL AUDIO)*         
* AKAT SPEC-13     07/14/16 PUBLOCK FILTER                            *         
* AKAT DSSUP-7252  04/14/16 RESTORE PUB REC TO AIO3 AFTER READING EST *         
* AKAT DSSUP-7252  04/04/16 FIX PRD FILTER BUG FOR INVOICES           *         
* AKAT DSSUP-6499  01/06/16 INCLUDE $0 BILBL WHEN USING BILBL FILTER  *         
* AKAT MOSBTK-239  12/16/15 DON'T DIE IF PRDBUFF ENTRY !FOUND FOR INV *         
* AKAT    11/04/15 FIX ALL MED/SINGLE CLT REQ LOOP BUG IN GETCLT      *         
* AKAT    07/21/15 MEDIA B,V & W SUPPORT                                        
* AKAT    10/13/14 SUPPORT NEW PAYSRC=SCRIPT/-SCRIPT FILTER                     
* AKAT    03/24/14 MEDIA L SUPPORT                                              
* BOBY    05/00/13 ADD PO# FILTERS FOR INACTIVE AND ACTIVE                      
* BOBY    01/00/09 FIX DUPLICATE VENDOR INVOICES IN CLRST                       
* BOBY    01/00/09 IMPLEMENT BCHGS FILTER                                       
* BOBY    11/00/08 PPBYOUT TO USE COMPACT FORM OF ZZZ ALLOC                     
* BOBY    04/00/07 CLIENT STRING SECURITY                                       
* BOBY    05/00/06 STEWARD FILTERING                                            
* BOBY    04/00/06 RUN BY PUBLIST                                               
* BOBY    12/00/05 NVMATCHED FILTER                                             
* BOBY    02/00/05 NVPAYABLE FILTER                                             
* BOBY    01/00/05 SUBMEDIA FILTERING                                           
* BOBY    12/00/03 NEW INVOICE RECORDS                                          
* BOBY    04/20/95 CASH APPLIED BUFFER USING TSAROFF                            
* BOBY 57 05/06/94 RUN AOR REPORTS FOR BRAND AGENCY                             
* BOBY 19 12/16/93 READ ISSUE RECORDS                                           
* BOBY 1/13/93 BILL AND PAY ELEMENT PROCESSING                                  
* BOBY 8/11/92 GST COLUMN FILTERING                                             
* BOBY 7/20/92 AD CODE FILTERING                                                
* ROSA 4/26/91 READ AOR RECORD IF NEEDED                           L14          
* ROSA 4/2/91  REFLECT SIZE INCREASE OF CONTRACT TABLE             L13          
* ROSA 3/7/91  ADD FILTER FOR INERTION ORDERS                      L12          
* ROSA 3/1/91  INCUDE DETETED BUYS WITH A OPTION OF START DATE OR  L11          
*              RANGE                                               L11          
*              INCLUED DELETED BUYS W/ REGULAR BUYS ALWAYS         L10          
* ROSA 2/13/91  INCLUDE DELETED BUYS ONLY                          L09          
* ROSA 1/25/91  ADD GST TO PAID, BILLED AND ORDERED BASED ON OPTION L08         
*               USDING P,B AND O GST FROM GETINS                                
*                                                                               
* ROSA 12/9/90 BUG IN PROCESSING POL(ZZZ) BUYS - PRODUCT INCRECMETED            
*      WITHIN THE READ BUY SUB ROUTINE(RDBUYS). ALL PRODUCT CHANGING            
*      SHOULD BE HANDLED BY EXITING SUBROUTINE                  BUG05           
*                                                                               
* ROSA 12/3/90 ADD NEW GETINSG                                    L06           
*ROSA 11/28/90 CRASH WHEN REQUEST WAS FOR CONTRULE AND FOR A SPECIFIC           
*       DIVISION.  PRODUCTS ARE FILTERED OUT BY DIVISION WHEN BUILDING          
*       PRODUCT BUFFER.  IN ROUTINE FNDPRD ( FIND PRODUCT FOR BUY)              
*       PGM  CRASHED IF NO PROD FOUND.. SOLUTION = CHECK TO SEE IF              
*       DIVISION REQUESTED IF PROD NOT FOUND AND BYPASS PRODUCT. BUG04          
*ROSA 10/29/90 PASS PUB ADDRESS IN PUB IO AREA                     L05          
*ROSA 9/14/90 ALLOW FOR WILD CARD CLIENTS                          L04          
*ROSA 7/12/90 LOGIC TO SELECT BY CD PUBS                           L03          
*ROSA 7/9/90 LOGIC TO SELECT BUYS -- TEST ONLY, LIVE ONLY OR BOTH L02           
*BPLA 5/4/90  LOGIC ADDED TO READ BUCKETS                                       
*ROSA 430/90  REMOVE DATE TEST AT CSTLOW  CONTRACT DATE TESTING ERR             
*ROSA 4/18/90 THIS PROGRAM WILL READ DELETED BUYS.  HOWEVER IT WAS              
*             READING A DIRECTORY RECORD THAT HAD A X'FF' IN THE DELETE         
*             PORTION OF THE KEY.  THIS RECORD S/B BYPASSED   **BUG02**         
*                                                                               
* ROSA 2/20/90 CONTRACT RELATED BUY FLAVOR WHEN REQUESTING A PRODUCT            
*         NOT PROCESSING.  PRODUCT TABLE CREATED WHEN PROCESSING A              
*         SPECIFIC PRODUCT. THIS IS DONE WHEN CONTRACT RELATED ENTRY            
*         IS REQUESTED SO POL BUYS WILL BE INCLUDED FOR THAT PRODUCT.           
*         WHEN PROCESSING CONTRACTS (BUY FLAVOR) ONLY THE FIRST PROD            
*         IS PROCESSED THEN GOES TO EOJ                     ***BUG01**          
*                                                                               
* ROSA  1/1/90  INCLUDE LOGIC FOR READING OAN RECORD IN CONTRACT    L01         
*                                                                   L01         
*                                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - PRINTWRITER IO HANDLER - INIT'               
***********************************************************************         
*                                                                     *         
*        INITIALIZATION                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRWRIIO  CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 PRWRIIOX-PRWRIIOD,PRWRIIO,RR=RE,CLEAR=YES                        
*                                                                               
         USING PRWRIIOD,RC         RC = A(LOCAL WORKING STORAGE)                
*                                                                               
         MVC   USERRD,4(RD)        SAVE LINK BACK TO USER                       
*                                                                               
         L     R7,0(R1)            ESTABLISH PRNTBLOCK                          
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
*                                                                               
         L     R9,=A(SUBROUTS)     ESTABLISH SUBROUTINES                        
         AR    R9,RE               ADD ON RELOCATION FACTOR                     
         USING SUBROUTS,R9                                                      
*                                                                               
         ST    RC,PBAIOWRK         MAKE WORK AREA ACCESSABLE TO OTHER           
*                                                                PGMS           
         STM   R7,RC,SAVER7        SAVE DATA POINTING REGISTERS                 
         ST    RE,RELO                                                          
*                                                                               
         MVI   BLANKS,C' '                                                      
         MVC   BLANKS+1(L'BLANKS-1),BLANKS                                      
         MVI   XFF,X'FF'                                                        
         MVC   XFF+1(L'XFF-1),XFF                                               
*                                                                               
         MVC   PBABUFFS,=C'*BUFFERS'                                            
         MVC   PBMODEQ,=C'***MODE='                                             
         MVC   PBQAREA,=C'REQUESTS'                                             
         MVC   FESBUFFA,PBAESTBF SET ADDR OF EST BUFF FOR BINSRCH               
*                                                                               
         L     R0,PBLESTBF         DETERMINE MAX ENTRIES IN ESTIMATE            
         SRDA  R0,32                 BUFFER                                     
         LA    RE,EBFLEN                                                        
         DR    R0,RE                                                            
         ST    R1,FESMAX                                                        
*                                                                               
         L     RE,=A(IOPRINT)                                                   
         A     RE,RELO                                                          
         MVC   0(4,RE),PBPRINT     SET ADDRESS OF PRINT FOR IOTRACE             
*                                                                               
         MVC   AIO1(12),PBAIO1     SET IO AREAS FROM BLOCK                      
         MVI   IONUM,3             SET NUMBER OF I/O AREAS                      
*                                  SET T00A PHASE ADDRESSES                     
         LA    R2,PHASES           R2=A(PHASE LIST)                             
         LA    R3,COREFACS         R3=A(ADDRESS LIST)                           
         LA    R4,PHASESN          R4=MAXIMUM NUMBER OF PHASES                  
*                                                                               
*  DETERMINE ADDRESS OF CORE RESIDENT PHASES  R0 BYTE 0 = R =READ               
*   BYTE 1+2 =X'000A' IS CORE RESIDENT PHASE FLAG                               
*   BYTE 3 = PHASE NAME -- SEE 'DDCOREQUS' FOR PGM EQUATES                      
*                                                                               
         ICM   R0,14,=X'D9000A'                                                 
         LA    R1,PARM                                                          
         L     RF,PBCOMFAC                                                      
         L     RF,CCALLOV-COMFACSD(RF)                                          
*                                                                               
PRPHASLP DS    0H                                                               
*                                                                               
         ICM   R0,1,0(R2)          INSERT PGM CORE RESIDENT ID                  
*                                                                               
         GOTO1 (RF),(R1),0,(R0)    FIND ADDRESS IN CORE                         
*                                                                               
         MVC   0(4,R3),0(R1)       SAVE THAT ADDRESS IN COREFACS                
*                                                                               
PRPHASCN DS    0H                                                               
*                                                                               
         LA    R2,1(R2)            TO NEXT PGM ID TO BE SEARCHED                
         LA    R3,4(R3)            NEXT ADDRESS SAVE AREA                       
         BCT   R4,PRPHASLP                                                      
*                                                                               
         EJECT                                                                  
*                                  SET PRWRIIO FACILITY ADDRESSES               
         LA    R0,CONADDRN         R0=NUMBER OF CONTROLLER ADDRESSES            
         LTR   R0,R0                                                            
         BZ    PR11                                                             
*                                                                               
         SR    RE,RE               RE=INDEX TO ADDRESS VALUE                    
         L     RF,=A(CONADDRS)                                                  
         A     RF,RELO                                                          
*                                                                               
         L     R1,0(RF,RE)                                                      
         A     R1,RELO             RELOCATE AND STORE IN W/S                    
         ST    R1,CONFACS(RE)                                                   
         LA    RE,4(RE)                                                         
         BCT   R0,*-16                                                          
*                                  FIND FILE TABLE ENTRY (FOR IO)               
PR11     L     R1,AFILTAB          R1 = A(FILE NAMES TABLE)                     
         LA    R1,3(R1)                                                         
         ST    R1,AFILNTRY         SAVE A(FILE TABLE ENTRY)                     
*                                                                               
         OC    PBQTODAY,PBQTODAY   GET TODAY'S DATE BINARY                      
         BZ    PR12                                                             
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATCON-COMFACSD(RF)    DATCON ADDRESS                        
         GOTO1 (RF),PARM,PBQTODAY,(3,PBBTODAY)                                  
*                                                                               
PR12     DS    0H                                                               
*                                                                               
         MVC   PBBSRCH,BINSRCH     PASS ALONG A(BINSRCH)                        
*                                                                               
         TITLE 'T00A4C - PRWRIIO - PRINTWRITER IO HANDLER - PRMAIN'             
***********************************************************************         
*                                                                     *         
*        MAIN LOGIC FOR PROGRAM                                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRMAIN   DS    0H                                                               
*                                                                               
         MVI   PBSLAVE,C'N'        ASSUME NON-SLAVE CLIENT                      
         XC    ESTDATA,ESTDATA     INIT ESTIMATE DATA                           
         XC    SESTDATA,SESTDATA                                                
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   PUBLISHER FILTER                             
         BZ    *+10                                                             
         MVC   SVEPUBNO,PBQPUB     SAVE ORIGINAL FILTER                         
*                                                                               
*        OUTERMOST LOOP CYCLES THROUGH AGENCIES & MEDIA                         
*          ADVERTISER PROCESSING CAN RESULT IN PROCESSING OF SEVERAL            
*          AGENCIES AND SEVERAL CLIENTS WITHIN EACH                             
*          MEDIA 'C', '*' RESULT IN SEVERAL MEDIA TO BE PROCESSED               
*                                                                               
PRMAGMLP DS    0H                                                               
*                                                                               
         GOTO1 =A(GETAGMD),RR=RELO GET NEXT AGENCY/MEDIA                        
         BNE   PRMEOJ              END OF LIST                                  
*                                                                               
*        INIT REP BUFFER                                                        
*                                                                               
PRIRBF   DS    0H                                                               
*                                                                               
         ICM   RF,15,PBAREPBF      GET ADDRESS OF BUFFER                        
         BZ    PRIRBFX               SKIP IF NOT SET UP                         
*                                                                               
         LR    RE,RF               GET LENGTH OF BUFFER                         
         SH    RE,=H'4'                                                         
         L     RE,0(RE)            LENGTH                                       
*                                                                               
         SH    RE,=Y(REPBUFLN)     MAKE SURE THERE IS ROOM IN BUFFER            
         BP    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         XC    0(REPBUFLN,RF),0(RF)  INIT FIRST ENTRY                           
*                                                                               
PRIRBFX  DS    0H                                                               
*                                                                               
         GOTO1 =A(GETFLT),RR=RELO  DETERMINE REQUEST FILTERS                    
*                                                                               
         TITLE 'T00A4C - PRWRIIO - PRINTWRITER IO HANDLER - PRMCLT'             
***********************************************************************         
*                                                                     *         
*        CLIENT PROCESSING                                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRMCLT   DS    0H                                                               
*                                                                               
         XC    PBCLT,PBCLT         CLEAR CLIENT IN PROCESS                      
         MVI   MASTCLIR,0          CLEAR MASTER CLIENT READ SWITCH              
         MVI   PBSLAVE,C'N'        NOT DOING SLAVES YET                         
*                                                                               
PRMCLTLP DS    0H                                                               
*                                                                               
         XC    PBPROD,PBPROD       CLEAR PRODUCT IN PROCESS                     
*                                                                               
         MVI   NOPRDERR,C'N'       RESET FLAG                                   
*                                                                               
         GOTOR GETCLT              GET NEXT CLIENT                              
         BNE   PRMCLTDN            END OF CLIENTS                               
*                                                                               
         CLI   PBQDRDSW,PBQDRDYQ   CHECK IF DIV/REG/DST REQUESTED               
         BE    *+14                                                             
         CLC   PBQDIV,=C'   '      TEST PROCESS DIVISIONS                       
         BNH   PRMCLT10                                                         
*                                                                               
         GOTO1 =A(BLDDRD),RR=RELO  BUILD DIV/RGN/DST BUFFER                     
*                                                                               
PRMCLT10 DS    0H                                                               
*                                                                               
         GOTO1 =A(BLDPRD),RR=RELO        BUILD PRODUCT BUFFER                   
*                                                                               
         XC    FESCOUNT,FESCOUNT   CLEAR ESTIMATE BUFFER COUNT                  
*                                                                               
*        CALLER DOES ALL I/O HANDLING                                           
*                                                                               
         CLI   PBQREAD,255         SKIP IF IO HANDLING NOT DONE                 
         BNE   PRMSPCX               BY CALLER                                  
*                                                                               
PRMSPCLP DS    0H                                                               
*                                                                               
         L     RE,AIO3              CHECK FOR EOJ                               
*                                                                               
         CLC   0(10,RE),=C'THAT IS IT'                                          
         BE    PRMEOJ               NO MORE PROCESSING (EOJ)                    
*                                                                               
         BAS   RE,GO               RETURN TO CALLER                             
*                                                                               
PRMSPCCN DS    0H                                                               
*                                                                               
         B     PRMSPCLP                                                         
*                                                                               
PRMSPCX  DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - PRINTWRITER IO HANDLER - PRMCON'             
***********************************************************************         
*                                                                     *         
*        BUY RECORDS CONTROLLED BY CONTRACTS                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRMCON   DS    0H                                                               
*                                                                               
         CLI   PBFLAVOR,C'C'       SKIP IF CONTRACTS DON'T DRIVE REPORT         
         BE    *+8                                                              
         CLI   PBFLAVOR,C'O'                                                    
         BNE   PRMCONX                                                          
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   IF PUBLISHER FILTER BEING USED               
         BZ    *+10                                                             
         MVC   PBQPUB(6),SVEPUBNO     RESTORE ORIGINAL PUB                      
*                                                                               
PRMCONLP DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDCON    SKIP IF NOT READING CONTRACTS FOR            
         BNO   PRMCON10              DATA                                       
*                                                                               
         GOTO1 =A(READCONT),RR=RELO                                             
         BNE   PRMCONDN            FINISHED CONTRACTS                           
*                                                                               
         TM    PBQREAD,PBQRDBUY    SKIP IF BUYS ALSO BEING READ                 
         BO    PRMCON10                                                         
*                                                                               
         GOTO1 =A(GETPUBN),HALF    READ PUB NAME                                
*                                                                               
         BNE   PRMCONCN            DROP IF PUB FAILS FILTERING                  
*                                                                               
PRMCON10 DS    0H                                                               
*                                                                               
PRMCNIS  DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDISS    TEST TO READ ISSUE RECORDS                   
         BZ    PRMCNISX            NO                                           
*                                                                               
         GOTO1 =A(READISS),RR=RELO  READ THE ISSUE RECORDS                      
*                                                                               
PRMCNISX DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDBLS    TEST TO READ BILLS                           
         BO    *+8                                                              
         TM    PBBYOPTS,PBBYBHTQ   TEST TO READ BILLS                           
         BNO   PRMCON25                                                         
*                                                                               
         GOTO1 =A(READBLLS),RR=RELO                                             
*                                                                               
PRMCON25 DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDBUY    TEST TO READ BUYS                            
         BZ    PRMCON20            NO                                           
*                                                                               
         GOTO1 =A(CONTBUYS),RR=RELO    READ THE BUY RECORDS                     
*                                                                               
PRMCON20 DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDBUY    IF BUYS WERE NOT READ                        
         BO    PRMCON30              THEN                                       
*                                                                               
         GOTO1 =A(CONTRATE),RR=RELO   READ CONTRACT RATE ELEMENTS               
*                                                                               
PRMCON30 DS    0H                                                               
*                                                                               
PRMCONCN DS    0H                                                               
*                                                                               
         B     PRMCONLP            GET NEXT CONTRACT                            
*                                                                               
PRMCONDN DS    0H                                                               
*                                                                               
         B     PRMCLTCN            END OF CLIENT                                
*                                                                               
PRMCONX  DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - PRINTWRITER IO HANDLER - PRMPRD'             
***********************************************************************         
*                                                                     *         
*        PROCESS SINGLE PRODUCT AT A TIME                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRMPRD   DS    0H                                                               
*                                                                               
PRMPRDLP DS    0H                                                               
*                                                                               
         XC    FESCOUNT,FESCOUNT   CLEAR ESTIMATE BUFFER COUNT                  
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   IF PUBLISHER FILTER                          
         BZ    *+10                                                             
         MVC   PBQPUB(6),SVEPUBNO     RESTORE ORIGINAL PUB                      
*                                                                               
         GOTOR GETPRD              GET NEXT PRODUCT                             
         BNE   PRMPRDDN                                                         
*                                                                               
         TM    PBQREAD,PBQRDBLS    TEST TO READ BILLS                           
         BO    *+8                                                              
         TM    PBBYOPTS,PBBYBHTQ   TEST TO READ BILLS                           
         BNO   PRMPRD07                                                         
*                                                                               
         GOTOR READBLLS                                                         
*                                                                               
PRMPRD07 DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDISS    TEST TO READ ISSUES                          
         BZ    PRMPRISX            NO                                           
*                                                                               
         GOTOR READISS             READ THE ISSUE RECORDS                       
*                                                                               
PRMPRISX DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDBUY    TEST TO READ BUYS                            
         BZ    PRMPRD05            NO                                           
*                                                                               
         GOTO1 =A(READBUYS),RR=RELO  READ THE BUY RECORDS                       
*                                                                               
PRMPRD05 DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDBKS    TEST TO READ BUCKETS                         
         BZ    PRMPRD06                                                         
*                                                                               
         GOTOR READBKS                                                          
*                                                                               
PRMPRD06 DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDEST    TEST TO READ ESTIMATES                       
         BNO   PRMPRD17                                                         
*                                                                               
         GOTOR READEST                                                          
*                                                                               
PRMPRD17 DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - PGEST DATA - PRDPG'                          
***********************************************************************         
*                                                                     *         
*        CALL DRIVER FOR EACH PGEST RECORD IF DOING PGESTREC KYWDS    *         
*              NEED TO HANDLE RECORDS WITH 000 FORESTIMATE            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRDPG    DS    0H                                                               
*                                                                               
         TM    PBQCFOPT,PBQCFPGQ   SKIP IF NOT REPORTING PGEST KYWDS            
         BNO   PRDPGX                                                           
*                                                                               
         MVC   PRDSAVKY,IOKEY      SAVE CURRENT KEY                             
         XC    PBEST,PBEST         FORCE ESTIMATE TO 000                        
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS PGEST REC KY            
         USING PGSTKEY,R2                                                       
*                                                                               
         MVC   PGSTKAGY,PBAGY      SET AGENCY                                   
         MVC   PGSTKMED,PBMED      SET MEDIA                                    
         MVI   PGSTKRCD,PGSTKIDQ   SET RECORD ID                                
         MVC   PGSTKCLT,PBCLT      SET CLIENT                                   
         MVC   PGSTKPRD,PBPROD     SET PRODUCT                                  
         XC    PGSTKEST,PGSTKEST   SET ESTIMATE TO 000                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIR HI                                  
*                                                                               
         CLC   PGSTKEY,IOKEYSAV    SAME A/M/TY/CL/PR/EST                        
         BNE   PRDPGDN             NO - DONE                                    
*                                                                               
         TM    IOKEY+25,X'80'      REJECT IF DELETED                            
         BO    PRDPGDN                                                          
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3+IORDEL GET PGEST RECORD                   
*                                                                               
PRDPGGO  DS    0H                  CALL DRIVER                                  
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO DRIVER                               
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    PRDPGGO              PASS BACK SAME RECORD                       
*                                                                               
PRDPGDN  DS    0H                                                               
*                                                                               
         TM    PBQCFOPT,PBQCFPGQ   DONE IF NOT REPORTING PGEST KYWDS            
         BNO   PRDPGX                                                           
*                                                                               
         MVC   IOKEY,PRDSAVKY      PRDTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL RE-READ CURRENT FILE PTR                
*                                                                               
PRDPGX   DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GFEST DATA - PRDGF'                          
***********************************************************************         
*                                                                     *         
*        CALL DRIVER FOR EACH GFEST RECORD IF DOING GFESTREC KYWDS    *         
*              NEED TO HANDLE RECORDS WITH 000 FORESTIMATE            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRDGF    DS    0H                                                               
*                                                                               
         TM    PBQCFOP2,PBQCFGFQ   SKIP IF NOT REPORTING GFEST KYWDS            
         BNO   PRDGFX                                                           
*                                                                               
         MVC   PRDSAVKY,IOKEY      SAVE CURRENT KEY                             
         XC    PBEST,PBEST         FORCE ESTIMATE TO 000                        
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS PGEST REC KY            
         USING PGSTKEY,R2                                                       
*                                                                               
         MVC   PGSTKAGY,PBAGY      SET AGENCY                                   
         MVC   PGSTKMED,PBMED      SET MEDIA                                    
         MVI   PGSTKRCD,X'0B'      SET RECORD ID                                
         MVC   PGSTKCLT,PBCLT      SET CLIENT                                   
         MVC   PGSTKPRD,PBPROD     SET PRODUCT                                  
         XC    PGSTKEST,PGSTKEST   SET ESTIMATE TO 000                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIR HI                                  
*                                                                               
         CLC   PGSTKEY,IOKEYSAV    SAME A/M/TY/CL/PR/EST                        
         BNE   PRDGFDN             NO - DONE                                    
*                                                                               
         TM    IOKEY+25,X'80'      REJECT IF DELETED                            
         BO    PRDGFDN                                                          
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3+IORDEL GET GFEST RECORD                   
*                                                                               
PRDGFGO  DS    0H                  CALL DRIVER                                  
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO DRIVER                               
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    PRDGFGO              PASS BACK SAME RECORD                       
*                                                                               
PRDGFDN  DS    0H                                                               
*                                                                               
         TM    PBQCFOP2,PBQCFGFQ   DONE IF NOT REPORTING GFEST KYWDS            
         BNO   PRDGFX                                                           
*                                                                               
         MVC   IOKEY,PRDSAVKY      PRDTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL RE-READ CURRENT FILE PTR                
*                                                                               
PRDGFX   DS    0H                                                               
*                                                                               
         B     PRMPRDCN                                                         
*                                                                               
PRMPRDCN DS    0H                                                               
*                                                                               
         B     PRMPRDLP            GET NEXT PRODUCT                             
*                                                                               
PRDSAVKY DS    XL(L'IOKEY)         KEY SAVEAREA                                 
PRMPRDDN DS    0H                  END OF PRODUCT                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - PRINTWRITER IO HANDLER - PRMCLTCN'           
***********************************************************************         
*                                                                     *         
*        CONTINUATION OF CLIENT PROCESSING                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRMCLTCN DS    0H                                                               
*                                                                               
*        READ INVOICE RECORDS FOR CLIENT IF NEEDED                              
*                                                                               
         TM    PBQREAD2,PBQRDINV   TEST TO READ INVOICE RECORDS                 
         BNO   PRMCLTIX                                                         
*                                                                               
         MVI   PBMODE,PBPROCIV     PROCESSING INVOICE RECORD                    
*                                                                               
         GOTOR READINV                                                          
*                                                                               
PRMCLTIX DS    0H                                                               
*                                                                               
*        READ NEW INVOICE RECORDS FOR CLIENT IF NEEDED                          
*                                                                               
         TM    PBQREAD2,PBQRDNV    TEST TO READ NEW INVOICE RECORDS             
         BNO   PRMCLTVX                                                         
*                                                                               
         MVI   PBMODE,PBPROCNV     PROCESSING NEW INVOICE RECORD                
*                                                                               
         GOTOR READPNV                                                          
*                                                                               
PRMCLTVX DS    0H                                                               
*                                                                               
         B     PRMCLTLP            NEXT CLIENT                                  
*                                                                               
PRMCLTDN DS    0H                                                               
*                                                                               
*        HANDLE ANY PUB FILE PROCESSING                                         
*                                                                               
         TM    PBQREAD2,PBQRDPBS   TEST TO READ PUBS                            
         BNO   PRMCLT20                                                         
*                                                                               
         MVI   PBMODE,PBPROCPB     PROCESSING A PUB RECORD                      
*                                                                               
         GOTO1 =A(READPUB),RR=RELO                                              
*                                                                               
PRMCLT20 DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - PRINTWRITER IO HANDLER - PRMAGYCN'           
***********************************************************************         
*                                                                     *         
*        CONTINUATION OF AGENCY PROCESSING                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRMAGYCN DS    0H                                                               
*                                                                               
         CLI   PBQMED,C'*'         IF MULTI-MEDIA REQUEST                       
         BE    *+8                                                              
         CLI   PBQMED,C'C'                                                      
         BE    PRMAGMLP              GO PROCESS NEXT MEDIA                      
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    PRMAGMLP              GO PROCESS NEXT AGENCY                     
*                                                                               
PRMAGYDN DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - PRINTWRITER IO HANDLER - PRMEOJ'             
***********************************************************************         
*                                                                     *         
*        END OF REPORT                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRMEOJ   DS    0H                                                               
*                                                                               
         TM    PBBYOPTS,PBBYBHTQ   SKIP UNLESS BUILDING BILLREC TABLE           
         BNO   PRMCSHX                                                          
*                                                                               
         LA    R6,CSHIERC          POINT TO CASHIER CONTROL BLOCK               
         USING CSHIERD,R6          ESTABLISH AREA                               
*                                                                               
         CLI   CSHSYS,0            SKIP IF CASHIER NEVER INITIALIZED            
         BE    PRMCSHX                                                          
*                                                                               
         MVI   CSHACT,CSHCLSQ      SET TO CLOSE BUFFER                          
*                                                                               
         GOTO1 VCASHIER,PARM,CSHIERD    CLOSE DDCASHIER                         
         CLI   CSHERR,0            NO ERRORS TOLERATED                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
PRMCSHX  DS    0H                                                               
*                                                                               
         LTR   RB,RB               FORCE NEQ CC                                 
*                                                                               
PRMAINX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - SUBROUTINES'                                 
***********************************************************************         
*                                                                     *         
*        COMMONLY USED SUBROUTINES                                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
SUBROUTS DS    0D                                                               
*                                                                               
IOPRINT  DS    A                   A(PRINT)                                     
GAMQSE   DC    X'00'               AOR SE CODE                                  
GETIN    DS    CL1                                                              
*                                                                               
FESPARMS DC    A(0)                                                             
FESBUFFA DC    A(0)                A(PBAESTBF)                                  
FESCOUNT DC    F'0'                NUMBER OF ENTRIES SO FAR                     
         DC    A(EBFLEN)           REC LENGTH                                   
         DC    AL1(0),AL3(EBFKEYLN)    KEY DSPL/LENGTH                          
FESMAX   DC    A(0)                MAX ENTRIES                                  
******                                                                          
PRTFILES DS    0C                  LIST OF PRINT FILES                          
         DC    CL8' PRTDIR'                                                     
         DC    CL8' PRTFIL'                                                     
         DC    CL8' PUBDIR'                                                     
         DC    CL8' PUBFIL'                                                     
         DC    CL8'X'              END OF LIST                                  
*                                                                               
EQXIT    CR    RE,RE                                                            
         B     EXIT                                                             
*                                                                               
NEQXIT   LTR   RE,RE                                                            
         B     EXIT                                                             
*                                                                               
XIT      EQU   *                                                                
EXIT     XIT1  ,                                                                
         TITLE 'T00A4C - PRWRIIO - NEXT RECORD ELEMENT - NXTELM'                
***********************************************************************         
*                                                                     *         
*        SUBROUTINE TO FIND NEXT ELEMENT IN RECORD WHOSE ID           *         
*            EQUALS REQUESTED ID                                      *         
*                                                                     *         
*NTRY    R6 ==>   CURRENT ELEMENT IN RECORD                           *         
*        ELCODE = ID OF ELEMENT WANTED                                *         
*                                                                     *         
*EXIT    R6 ==>   FOUND ELEMENT WHOSE ID EQUALS THAT IN ELCODE        *         
*                                                                     *         
*        CC    EQ  - ELEMENT FOUND                                    *         
*             NEQ  - ELEMENT NOT FOUND                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
NXTELM   DS    0H                                                               
*                                                                               
         SR    R0,R0                                                            
*                                                                               
NXTELMLP DS    0H                                                               
*                                                                               
         ICM   R0,1,1(R6)          GET CURRENT ELEMENT LENGTH                   
         BNZ   *+6                                                              
         DC    H'0'                MUST BE NON-ZERO                             
*                                                                               
         AR    R6,R0               BUMP TO NEXT ELEMENT IN RECORD               
*                                                                               
         CLI   0(R6),0             DONE IF END OF RECORD REACHED                
         BE    NXTELMX                                                          
*                                                                               
         CLC   ELCODE,0(R6)        MATCH TO ASKED FOR ELEMENT ID                
         BNE   NXTELMLP                                                         
         B     *+6                 EXIT WITH EQ CC                              
NXTELMX  DS    0H                                                               
         LTR   RE,RE               SET CC NOT EQ                                
         BR    RE                                                               
*                                                                               
         EJECT                                                                  
*===================================================*                           
* SUBROUTINE MOVES REC AT R2 TO R1 FOR LENGTH IN R0 *                           
* RETURN ON RE (R0-R2 AND RF ARE DESTROYED)         *                           
*===================================================*                           
         SPACE 1                                                                
MOVEREC  LA    RF,256                                                           
         CR    R0,RF                                                            
         BNH   MOVEREC2                                                         
         MVC   0(256,R1),0(R2)                                                  
         AR    R1,RF                                                            
         AR    R2,RF                                                            
         SR    R0,RF                                                            
         B     MOVEREC                                                          
*                                                                               
MOVEREC2 LTR   RF,R0                                                            
         BZR   RE                                                               
         BCTR  RF,0                                                             
         EX    RF,*+6                                                           
         BR    RE                                                               
         MVC   0(0,R1),0(R2) *EXECUTED*                                         
         SPACE 2                                                                
*==================================================                             
* SUBROUTINE CLEARS BUFFER AT R1 FOR LENGTH IN R0 *                             
*==================================================                             
         SPACE 1                                                                
CLRBUFF  LA    RF,256                                                           
         CR    R0,RF                                                            
         BNH   CLRBUFF2                                                         
         XC    0(256,R1),0(R1)                                                  
         AR    R1,RF                                                            
         SR    R0,RF                                                            
         BP    CLRBUFF                                                          
*                                                                               
CLRBUFF2 LTR   RF,R0                                                            
         BZR   RE                                                               
         BCTR  RF,0                                                             
         EX    RF,*+6                                                           
         BR    RE                                                               
         XC    0(0,R1),0(R1) *EXECUTED*                                         
*                                                                               
         EJECT                                                                  
         GETEL R6,33,ELCODE                                                     
*                                                                               
         TITLE 'T00A4C - PRWRIIO - HOOK TO USER - GO'                           
***********************************************************************         
*                                                                     *         
*        HOOK TO USER                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
GO       NTR1                      SAVE REGISTERS                               
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9         SUBROUTINES                                  
         USING PRWRIIOD,RC         WORKING STORAGE                              
*                                                                               
         MVC   PAGETINS,GETINS     PASS A(GETINS)                               
*                                                                               
         L     RF,PBIOHOOK         GET HOOK ADDRESS                             
         L     RE,USERRD           RESTORE REGISTERS                            
         LM    R0,RC,20(RE)                                                     
*                                                                               
         BASR  RE,RF               TAKE USER HOOK                               
*                                                                               
         XIT1                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - FIND ESTIMATE FILTERS - FLTREST'             
***********************************************************************         
*                                                                     *         
*        SUBROUTINE TESTS ESTIMATE FILTER VALUES                      *         
*        AND READS ESTIMATE HEADER IF NECESSARY                       *         
*                                                                     *         
*NTRY    ON ENTRY 'ESTDATA' CONTAINS PRD AND EST                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
FLTREST  NTR1                                                                   
*                                                                               
         LA    R4,ESTDATA          ESTABLISH ESTDATA AS EST BUFF ENTRY          
         USING ESTBUFFD,R4                                                      
*                                                                               
         CLI   PBQEST+2,C' '       SKIP IF DOING ALL ESTIMATES                  
         BE    FESESTX                                                          
         CLC   PBQEST,=C'ALL'      SKIP IF DOING ALL ESTIMATES                  
         BE    FESESTX                                                          
*                                  ONE EST                                      
         CLC   EBFEST,PBQESTB      ELSE MUST MATCH REQUESTED ESTIMATE           
         BL    FESERR                                                           
         BE    FESESTX                                                          
         CLC   EBFEST,PBQESTBX     OR FALL IN ESTIMATE RANGE                    
         BH    FESERR                                                           
*                                                                               
FESESTX  DS    0H                                                               
*                                                                               
*        TEST ESTIMATE IN TABLE ALREADY                                         
*                                                                               
FESTBL   DS    0H                                                               
*                                                                               
         OC    PBAESTBF,PBAESTBF  DONE IF NO EST BUFFER GIVEN                   
         BZ    FLTRESTX                                                         
*                                                                               
         OC    EBFEST,EBFEST      MAY NOT HAVE AN EST NUMBER FOR                
         BZ    FLTRESTX           SOME OLD BILLS, SO SKIP EST READING           
*                                                                               
         CLC   ESTDATA(EBFKEYLN),SESTDATA DONE IF SAME AS LAST ESTIMATE         
         BE    FLTRESTX                                                         
*                                                                               
*        INSERT ENTRY IN TABLE IF NOT THERE                                     
*                                                                               
         MVI   EBFIND,0                   CLEAR INDS                            
*                                                                               
*        INSERTS ESTDATA INTO BUFFER IF NO MATCH IS FOUND                       
*                                                                               
         GOTO1 BINSRCH,FESPARMS,(X'01',ESTDATA),RR=RELO                         
*                                                                               
         OC    1(3,R1),1(R1)              TEST ROOM IN TABLE                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   PBCESTBF,FESCOUNT   UPDATE # IN BUFFER                           
*                                                                               
         L     R4,0(R1)            POINT TO FOUND ENTRY                         
         USING ESTBUFFD,R4         ESTABLISH AS BUFFER ENTRY                    
*                                                                               
         TM    EBFIND,EBFIREAD     IF ESTIMATE RECORD NOT READ YET              
         BZ    FESFLTN                GO READ IT                                
*                                                                               
*        HANDLE ESTIMATE FILTERS                                                
*                                                                               
FESFLT   DS    0H                                                               
*                                                                               
         CLC   PBQESTX,BLANKS      SKIP IF NO FILTERING BEING DONE              
         BE    FESFLTX                                                          
         OC    PBQESTB,PBQESTB                                                  
         BNZ   FESFLTX             OR ONE OR RANGE OF ESTS REQUESTED            
*                                                                               
*        MUST BE ESTIMATE FILTER                                                
*                                                                               
         TM    EBFIND,EBFIFLTR     SKIP IF PASSED FILTER ALREADY                
         BO    FESFLTX                                                          
         B     FESCLRBF            REMOVE FROM BUFFER                           
*                                                                               
FESFLTX  DS    0H                                                               
*                                                                               
         B     FESOK               ACCEPT ESTIMATE                              
*                                                                               
FESFLTN  DS    0H                                                               
*                                                                               
FESTBLX  DS    0H                                                               
*                                                                               
*        READ ESTIMATE HEADER                                                   
*                                                                               
FESRD    DS    0H                                                               
*                                                                               
         MVC   WORK(64),IOKEY      SAVE IOKEY/IOKEYSAV                          
*                                                                               
         XC    IOKEY,IOKEY         ESTABLISH KEY AREA AS ESTIMATE KEY           
         LA    R2,IOKEY            ESTABLISH KEY AREA AS ESTIMATE KEY           
         USING PESTRECD,R2                                                      
*                                                                               
         MVC   PESTKAGY,PBAGY      SET AGENCY                                   
         MVC   PESTKMED,PBMED      SET MEDIA                                    
         MVI   PESTKRCD,PESTKIDQ   SET RECORD IDENTIFIER                        
         MVC   PESTKCLT,PBCLT      SET CLIENT                                   
         MVC   PESTKPRD,EBFPRD     SET PRODUCT                                  
         MVC   PESTKEST,EBFEST     SET ESTIMATE                                 
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ ESTIMATE POINTER                        
*                                                                               
         CLC   IOKEY(17),IOKEYSAV  MUST FIND POINTER                            
         BNE   FESERR1             FAILS FILTER IF ESTIMATE NOT FOUND           
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3   READ ESTIMATE RECORD                    
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
         USING PESTRECD,R2                                                      
*                                                                               
         OI    EBFIND,EBFIREAD     SET EST READ FLAG                            
*                                                                               
         MVC   EBFNAME,PESTNAME    SET NAMES                                    
         MVC   EBFNAM2,PESTNAM2                                                 
         MVC   EBFFLTR,PESTGRPS    SAVE ESTIMATE FILTER                         
         MVC   EBFESTLK,PESTSTAT   SAVE ESTIMATE LOCKED STATUS                  
         MVC   EBFESTTS,PESTTEST   SAVE ESTIMATE TEST   STATUS                  
         MVC   EBFRTETP,PESTRTYP   SAVE ESTIMATE RATE TYPE                      
*                                                                               
         MVC   EBFBLBAS(6),PESTBILP SET START OF BILLING PROFILE                
*                                                                               
*        FIND PLANNED COST BILLING EFFECTIVE DATE                               
*                                                                               
         MVI   ELCODE,PEBPCECQ     BILLING EFD ELEMENT CODE                     
         LA    R6,PESTKEY                                                       
         USING PEBPCELC,R6         ESTABLISH BILLING EFD ELEMENT                
*                                                                               
         BRAS  RE,GETEL            FIND ELEMENT                                 
         BNE   *+10                ELEMENT NOT FOUND                            
         MVC   EBFPCBLD,PEBPCEFF   SAVE BILL EFFECTIVE DATE                     
*                                                                               
*        FIND PLANNED COST ACTUALIZATION DATE                                   
*                                                                               
         MVI   ELCODE,PEACTECQ     ACTUALIZATION DATE ELM CODE                  
         LA    R6,PESTKEY                                                       
         USING PEACTELC,R6         ESTABLISH ACTUALAIZATION DATE ELM            
*                                                                               
         BRAS  RE,GETEL            FIND ELEMENT                                 
         BNE   *+10                ELEMENT NOT FOUND                            
         MVC   EBFPCACD,PEACTDAT   SAVE ACTUALIZATION DATE                      
*                                                                               
*        SAVE ESTIMATE RECORD                                                   
*                                                                               
         OC    PBESTADR,PBESTADR   SKIP IF NO ESTREC SAVEAREA AVAILABLE         
         BZ    FESSAVX                                                          
*                                                                               
         L     R0,PBESTLEN         GET SAVEAREA LENGTH                          
         CLM   R0,3,PESTLEN        COMPARE TO REC LENGTH                        
         BNH   *+8                 AND USE SMALLER                              
         ICM   R0,3,PESTLEN                                                     
*                                                                               
         ICM   R1,15,PBESTADR      GET ESTIMATE BUFFER ADDRESS                  
         BZ    *+12                  NONE GIVEN                                 
         BAS   RE,MOVEREC          SAVE ESTIMATE RECORD                         
         L     R2,IOADDR           RESET ESTREC POINTER                         
*                                                                               
FESSAVX  DS    0H                                                               
*                                                                               
         CLC   PBQESTX,BLANKS     SKIP IF ALL ESTIMATES WANTED                  
         BE    FESFLTRX                                                         
         OC    PBQESTB,PBQESTB    OR ONE OR RANGE WANTED                        
         BNZ   FESFLTRX                                                         
*                                                                               
*        FILTER ESTIMATE                                                        
*                                                                               
         LA    RE,PBQESTX          POINT TO START OF ESTIMATE FILTERS           
         LA    RF,PESTGRPS         POINT TO ESTIMATE REC FILTER                 
         LA    R0,3                MAX 3 FILTERS                                
*                                                                               
FESFLTLP DS    0H                                                               
*                                                                               
         CLI   0(RE),C'*'          IGNORE IF WILD CARD ENTRY                    
         BE    FESFLTCN                                                         
         CLI   0(RE),C' '          OR NO VALUE GIVEN                            
         BE    FESFLTCN                                                         
*                                                                               
         TM    0(RE),X'40'         IF POSITIVE FILTER                           
         BZ    FESFLT10                                                         
*                                                                               
         CLC   0(1,RE),0(RF)          MUST MATCH ESTIMATE VALUE                 
         BNE   FESCLRBF            REMOVE FROM BUFFER                           
         B     FESFLTCN                                                         
*                                                                               
FESFLT10 DS    0H                  ELSE NEGATIVE FILTER                         
*                                                                               
         MVC   DUB(1),0(RE)        MOVE FILTER TO WORKAREA                      
         OI    DUB,X'40'           MAKE POSITIVE FILTER                         
         CLC   DUB(1),0(RF)        NOW MUST NOT MATCH ESTIMATE VALUE            
         BE    FESCLRBF            REMOVE FROM BUFFER                           
*                                                                               
FESFLTCN DS    0H                                                               
*                                                                               
         LA    RE,1(RE)            BUMP POINTERS                                
         LA    RF,1(RF)                                                         
         BCT   R0,FESFLTLP         MAX 3 TIMES THROUGH LOOP                     
*                                                                               
*        SP    TRAP,=P'1'                                                       
*        BNZ   *+8                                                              
*        DC    H'0'                                                             
*TRAP     DC    PL2'2'                                                          
*                                                                               
         OI    EBFIND,EBFIFLTR     SET IND FOR PASSED FILTER                    
*                                                                               
FESFLTRX DS    0H                                                               
*                                                                               
*        FILTER ESTIMATE ON DATES                                               
*                                                                               
         CLI   PBMODE,PBPROCES     SKIP IF NOT PROCESSING BY EST                
         BNE   FESDATEX                                                         
*                                                                               
         TM    PBQALLOP,PBQALEPR   SKIP IF DATES MUST LIE IN PERIOD             
         BO    FESINPER                                                         
*                                                                               
*        ESTIMATE DATES MUST OVERLAP PERIOD                                     
*                                                                               
         CLC   PESTST,PBQEND       ESTIMATE DATES MUST OVERLAP                  
         BNL   FESCLRBF            REQUEST PERIOD                               
         CLC   PESTEND,PBQSTART                                                 
         BL    FESCLRBF                                                         
*                                                                               
         B     FESDATEX                                                         
*                                                                               
*        ESTIMATE DATES MUST LIE IN REQUEST PERIOD                              
*                                                                               
FESINPER DS    0H                                                               
*                                                                               
         CLC   PESTST,PBQSTART     ESTIMATE DATES MUST LIE                      
         BL    FESCLRBF            IN PERIOD                                    
         CLC   PESTEND,PBQEND                                                   
         BH    FESCLRBF                                                         
*                                                                               
FESDATEX DS    0H                                                               
*                                                                               
*        FILTER ON RATE TYPE                                                    
*                                                                               
FESRTE   DS    0H                                                               
*                                                                               
         CLI   PBQESTRT,0          SKIP IF NO FILTER GIVEN                      
         BE    FESRTEX                                                          
*                                                                               
         MVC   BYTE,PBQESTRT       MOVE FFILTER TO WORKAREA                     
         OI    BYTE,X'40'          RESTORE X'40' BIT                            
*                                                                               
         TM    PBQESTRT,X'40'      IF POSITIVE FILTER                           
         BNO   FESRTE10                                                         
*                                                                               
         CLC   PESTRTYP,BYTE          MUST MATCH FILTER                         
         BNE   FESCLRBF                                                         
*                                                                               
         B     FESRTEX                                                          
*                                                                               
FESRTE10 DS    0H                  IF NEGATIVE FILTER                           
*                                                                               
         CLC   PESTRTYP,BYTE          MUST NOT MATCH FILTER                     
         BE    FESCLRBF                                                         
*                                                                               
FESRTEX  DS    0H                                                               
*                                                                               
*        ESTIMATE MUST BE BILLED IF BILL DATE FILTER GIVEN                      
*                                                                               
FESBLD   DS    0H                                                               
*                                                                               
         CLC   PBQEST,=C'ALL'      SKIP IF NOT ALL ESTIMATE REQUEST             
         BNE   FESBLDX                                                          
*                                                                               
         OC    PBQBLLDT,PBQBLLDT   SKIP IF NO BILLED DATE FILTER                
         BZ    FESBLDX                                                          
*                                                                               
         TM    EBFIND,EBFIBLLD     ELSE MUST BE BILLED TODAY                    
         BZ    FESCLRBF            REMOVE FROM BUFFER                           
*                                                                               
FESBLDX  DS    0H                                                               
*                                                                               
*        IF NO BILLING FORMULA GIVEN LOOK FOR DEFAULT ONE                       
*           UNDER PRODUCT 'AAA'                                                 
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
*                                                                               
         OC    PESTBILP,PESTBILP   IF NO BILLING FORMULA IN RECORD              
         BNZ   FESBFLX                                                          
*                                                                               
         LA    R2,IOKEY            RE-ESTABLISH KEYAREA                         
*                                                                               
         MVC   PESTKPRD,=C'AAA'    SET FOR DEFAULT PRODUCT                      
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ POINTER FOR 'AAA'                       
*                                                                               
         CLC   PESTKEY,IOKEYSAV    IF DEFAULT FOUND                             
         BNE   FESDFLTX                                                         
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3  READ DEFAULT RECORD                      
         BE    *+6                 NOT ERRORS TOLERATED                         
         DC    H'0'                                                             
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
*                                                                               
         OC    EBFBLBAS(6),PESTBILP    SAVE DEFAULT BILLING PROFILE             
*                                                                               
FESDFLTX DS    0H                                                               
*                                                                               
FESBFLX  DS    0H                                                               
*                                                                               
*        IF FILTERING ON PO#'S                                                  
*           CHECK FOR PO# RECORD                                                
*                                                                               
FESPO#   DS    0H                                                               
*                                                                               
         TM    PBQPO#OP,PBQPO#NQ   IF REPORTING ON BUYS NEEDING PO#             
         BNO   FESPO#X                                                          
*                                                                               
         LA    R2,IOKEY            RE-ESTABLISH KEYAREA                         
         USING PPO#RECD,R2         ESTABLISH PO# RECORD KEY                     
*                                                                               
         MVI   PPO#KRCD,PPO#KIDQ   CHANGE TO PO# REC ID                         
*                                                                               
         MVI   ELCODE,PCLTPOEQ     FIND PO# ELEMENT IN CLTREC                   
         L     R6,PBCLTADR         LOOK IN CLIENT RECORD                        
*                                                                               
         BRAS  RE,GETEL                                                         
         BNZ   FESPO#10            SKIP IF CLT HAS NO PO#'S                     
*                                                                               
         USING PCLTPOEL,R6         ESTABLISH CLIENT PO# ELM                     
         MVC   BYTE,PCLTPOLV       SAVE CLIENT PO# LEVEL                        
*                                                                               
         XC    PPO#KPRD,PPO#KPRD   INIT PRD AND EST                             
         XC    PPO#KEST,PPO#KEST                                                
*                                                                               
         CLI   BYTE,P_POLVCQ       DONE IF CLIENT LEVEL PO#                     
         BE    FESPO#10                                                         
*                                                                               
         MVC   PPO#KPRD,EBFPRD     RESET PRODUCT/EST CODES IN CASE              
*                                                                               
         CLI   BYTE,P_POLVPQ       DONE IF PRODUCT LEVEL PO#                    
         BE    FESPO#10                                                         
*                                                                               
         MVC   PPO#KEST,EBFEST     'AAA' PRODUCT RECORD WAS READ                
*                                                                               
FESPO#10 DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ POINTER FOR PO#                         
*                                                                               
         CLC   PPO#KEY,IOKEYSAV    IF PPO#REC  FOUND                            
         BNE   FESPO#X                                                          
*                                                                               
         TM    PPO#CNTL,X'80'      NO PO#'S IF DELETED                          
         BO    FESPO#X                                                          
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3  READ PO# RECORD                          
         BE    *+6                 NO ERRORS TOLERATED                          
         DC    H'0'                                                             
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
*                                                                               
         SR    RF,RF                                                            
         LA    R6,PO#FIRST         POINT TO FIRST ELEMENT IN RECORD             
         USING PO#DELM,R6          ESTABLISH PO# ELEMENT                        
*                                                                               
FESPO#LP DS    0H                                                               
*                                                                               
         CLI   PO#DELID,0          NO PO#'S IF END OF RECORD                    
         BE    FESPO#DN                                                         
*                                                                               
         CLI   PO#DELID,PO#DLIDQ   MATCH ON ELEMENT ID                          
         BNE   FESPO#CN                                                         
*                                                                               
         CLC   PO#DEND,PBQBST      PO# RANGE COVERS REQUEST                     
         BL    FESPO#CN                                                         
         CLC   PO#DSTRT,PBQBEND                                                 
         BH    FESPO#CN                                                         
*                                                                               
         B     FESPO#FD                                                         
*                                                                               
FESPO#CN DS    0H                                                               
         IC    RF,PO#DLEN          GET ELEMENT LENGTH                           
         LA    R6,PO#DELM(RF)      BUMP TO NEXT ELEMENT                         
         B     FESPO#LP                                                         
*                                                                               
FESPO#FD DS    0H                                                               
*                                                                               
         OI    EBFIND,EBFIPO#      ESTIMATE HAS A PO#                           
*                                                                               
FESPO#DN DS    0H                                                               
*                                                                               
FESPO#X  DS    0H                                                               
*                                                                               
         MVC   IOKEY(64),WORK     RESTORE KEY AND KEYSAVE                       
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL RE-POINT TO LAST KEY                    
*                                                                               
FESOK    DS    0H                                                               
*                                                                               
         LA    RF,EBFBLBAS         RETURN BILLING PROFILE ADDRESS               
         ST    RF,PBABILLB                                                      
*                                                                               
         MVC   SESTDATA,ESTBUFFD   SAVE THIS ESTIMATE DATA                      
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     FLTRESTX                                                         
*                                                                               
*     IF ESTIMATE DOES NOT PASS FILTER TESTING - DO NOT INSERT IN TABLE         
*                                                                               
FESCLRBF DS    0H                  REMOVE FOUND ENTRY FROM TABLE                
*                                                                               
*                                                                               
*        REMOVES ENTRY FROM BUFFER                                              
*                                                                               
         GOTO1 BINSRCH,FESPARMS,(X'80',ESTDATA),RR=RELO                         
*                                                                               
         MVC   PBCESTBF,FESCOUNT   UPDATE BUFFER COUNT                          
*                                                                               
         B     FESERR1                                                          
*                                                                               
FESERR   DS    0H                                                               
*                                                                               
         LTR   R9,R9                SET NEQ CC                                  
*                                                                               
         B     FLTRESTX                                                         
*                                                                               
FESERR1  DS    0H                                                               
*                                                                               
         MVC   IOKEY(64),WORK     RESTORE KEY AND KEYSAVE                       
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL RE-POINT TO LAST KEY                    
*                                                                               
         LTR   R9,R9                SET NEQ CC                                  
*                                                                               
         B     FLTRESTX                                                         
*                                                                               
FLTRESTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GET AGY PUB ID - GTAGYPUB'                   
***********************************************************************         
*                                                                     *         
*        GIVEN AOR'S PUB ID FIND AGENCY'S PUB ID                      *         
*           ROUTINE USES PUB EQUIVALENCE PASSIVE POINTERS             *         
*                                                                     *         
*NTRY    0(R1)   = A(AOR'S PUB ID)                                    *         
*                                                                     *         
*EXIT    PAORPUB = AOR'S    PUB ID                                    *         
*        PAOPUB  = AGENCY'S PUB ID                                    *         
*        CC      EQ   EXACT MATCH ON PUB,ZONE,EDITION                 *         
*                LE   MATCH ON BASE PUB ONLY                          *         
*                GT   NO MATCH                                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
GTAGYPUB NTR1                                                                   
*                                                                               
         SR    R0,R0               INIT FOR ERROR CHECK                         
*                                                                               
         MVC   GTIOKEY,IOKEY       SAVE CURRENT IOKEY                           
         MVC   GTIOKEYS,IOKEYSAV   SAVE CURRENT IOKEYSAV                        
*                                                                               
         L     RF,0(R1)            POINT TO AGENCIES PUB                        
*                                                                               
*****    CLC   GTAGYAGY,PAOAGY     SKIP IF BRAND AGENCY CHANGED                 
*****    BNE   *+14                                                             
*****    CLC   PAORPUB,0(RF)       IF NO CHANGE IN AOR'S PUB                    
*****    BE    GTAGYPBX               EXIT WITH SAME AGY PUB                    
*                                                                               
*****    MVC   GTAGYAGY,PAOAGY     SAVE CURRENT AGENCY                          
         MVC   PAORPUB,0(RF)       SAVE AOR'S    PUB ID                         
*                                                                               
         XC    PAOPUB,PAOPUB       INIT AGENCY'S PUB ID                         
*                                                                               
         CLC   PAORAGY,PAOAGY      IF THIS IS AOR AGENCY                        
         BNE   *+14                                                             
         MVC   PAOPUB,PAORPUB         COPY AGENCY'S PUB AND EXIT                
         B     GTAGYPBX                                                         
*                                                                               
         SR    R3,R3                                                            
         L     RF,PBUTLA                                                        
         IC    R3,4(RF)            SAVE CURRENT SE                              
         MVC   4(1,RF),PAOSE       SET TO READ AGY'S FILES                      
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS PUBFILE KEY             
         USING PUBREC,R2                                                        
*                                                                               
         MVI   PUBVID,PUBVIDQ      SET PUB ADV PTR ID                           
         MVC   PUBVMED,PBMED       SET MEDIA                                    
         MVC   PUBVADV,PAORQADV    SET ADVERTISER'S CODE                        
         MVC   PUBVAOR,PAORAGY     SET AOR'S AGY CODE                           
         MVC   PUBVAGY,PAOAGY      SET AGY                                      
         MVC   PUBVVPUB,PAORPUB    SET AOR'S PUB ID                             
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOHI   READ PASSIVE POINTER                         
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     RF,PBUTLA                                                        
         STC   R3,4(RF)            RESET TO INCOMING FILES                      
*                                                                               
         CLC   IOKEY(PUBVAPUB-PUBKEY),IOKEYSAV    IF EXACT MATCH                
         BNE   *+14                                                             
         MVC   PAOPUB,PUBVAPUB     SAVE AGY'S PUB ID                            
         B     GTAGYPBX                                                         
*                                                                               
         CLC   IOKEY(PUBVAPUB-2-PUBKEY),IOKEYSAV  IF BASE PUB MATCH             
         BNE   *+18                                                             
         L     R0,=F'-1'           SET INDICATOR                                
         MVC   PAOPUB(4),PUBVAPUB  SAVE AGY'S BASE PUB ID                       
         B     GTAGYPBX                                                         
*                                                                               
         TM    PAOCCNTL,X'01'      IF PUBLINKS NOT REQUIRED                     
         BO    *+14                                                             
         MVC   PAOPUB,PAORPUB      USE AOR'S NUMBER                             
         B     GTAGYPBX                                                         
*                                                                               
         B     GTAGYPER                                                         
*                                                                               
GTAGYPER DS    0H                                                               
*                                                                               
         B     GTAGYPEX            SKIP PRINTING ON REPORT                      
*                                                                               
         CLI   PBQDOWN,C'Y'        SKIP IF WE ARE DOWNLOADING                   
         BE    GTAGYPEX                                                         
*                                                                               
         L     R3,PBPLEDCB         PUBERR DCB ADDRESS                           
*                                                                               
         MVI   PAOPLESW,C'Y'       INDICATE PUBERR FILE USED                    
*                                                                               
         PUT   (R3),PAOBLK         SAVE PAOBLK FOR REPORT                       
*                                                                               
GTAGYPEX DS    0H                                                               
*                                                                               
         LA    R0,1                INDICATE ERROR                               
*                                                                               
         B     GTAGYPBX            NEQ CC SET                                   
*                                                                               
GTAGYPBX DS    0H                                                               
*                                                                               
         MVC   IOKEY,GTIOKEY       RESTORE SAVED KEYS                           
         MVC   IOKEYSAV,GTIOKEYS                                                
*                                                                               
         LTR   R0,R0               SET CC                                       
*                                                                               
         XIT1                                                                   
*                                                                               
GTAGYAGY DC    CL(L'PAOAGY)'00'    CURRENT AGENCY SAVE AREA                     
*                                                                               
         DROP  R2                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GET AOR PUB ID - GTAORPUB'                   
***********************************************************************         
*                                                                     *         
*        GIVEN AGENCY'S PUB ID FIND AOR'S PUB ID                      *         
*           ROUTINE USES PUB EQUIVALENCE PASSIVE POINTERS             *         
*                                                                     *         
*NTRY    0(R1)   = A(AGENCY'S PUB ID)                                 *         
*                                                                     *         
*EXIT    PAORPUB = AOR'S    PUB ID                                    *         
*        PAOPUB  = AGENCY'S PUB ID                                    *         
*        CC      EQ   EXACT MATCH ON PUB,ZONE,EDITION                 *         
*                LE   MATCH ON BASE PUB ONLY                          *         
*                GT   NO MATCH                                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
GTAORPUB NTR1  WORK=(RA,500)                                                    
*                                                                               
         SR    R0,R0               INIT ERROR INDICATOR                         
*                                                                               
         MVC   GTIOKEY,IOKEY       SAVE CURRENT IOKEY                           
         MVC   GTIOKEYS,IOKEYSAV   SAVE CURRENT IOKEYSAV                        
*                                                                               
         L     RF,0(R1)            POINT TO AGENCIES PUB                        
******                                                                          
******   CLC   GTAORAGY,PAOAGY     SKIP IF BRAND AGENCY CHANGED                 
******   BNE   *+14                                                             
******   CLC   PAOPUB,0(RF)        IF NO CHANGE IN AGENCY PUB                   
******   BE    GTAORPBX               EXIT                                      
******                                                                          
******   MVC   GTAORAGY,PAOAGY     SAVE CURRENT BRAND AGENCY                    
         MVC   PAOPUB,0(RF)        SAVE PUB ID                                  
*                                                                               
         XC    PAORPUB,PAORPUB     INIT AOR'S PUB ID                            
*                                                                               
         CLC   PAOAGY,PAORAGY      IF THIS IS AOR AGENCY                        
         BNE   *+14                                                             
         MVC   PAORPUB,PAOPUB         COPY PUB ID AND EXIT                      
         B     GTAORPBX                                                         
*                                                                               
         SR    R3,R3                                                            
         L     RF,PBUTLA                                                        
         IC    R3,4(RF)            SAVE CURRENT SE                              
         MVC   4(1,RF),PAOSE       SET TO READ AGY'S FILES                      
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS PUBFILE KEY             
         USING PUBREC,R2                                                        
*                                                                               
         MVI   PUBAID,PUBAIDQ      SET PUB ADV PTR ID                           
         MVC   PUBAMED,PBMED       SET MEDIA                                    
         MVC   PUBAAGY,PAOAGY      SET AGY                                      
         MVC   PUBAADV,PAORQADV    SET ADVERTISER'S CODE                        
         MVC   PUBAAOR,PAORAGY     SET AOR'S AGY CODE                           
         MVC   PUBAAPUB,PAOPUB     SET AGENCY'S PUB ID                          
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOHI   READ PASSIVE POINTER                         
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     RF,PBUTLA                                                        
         STC   R3,4(RF)            RESTORE CURRENT SE                           
*                                                                               
         CLC   IOKEY(PUBAVPUB-PUBKEY),IOKEYSAV    IF EXACT MATCH                
         BNE   *+14                                                             
         MVC   PAORPUB,PUBAVPUB    SAVE AOR'S PUB ID                            
         B     GTAORPBX                                                         
*                                                                               
         CLC   IOKEY(PUBAVPUB-2-PUBKEY),IOKEYSAV  IF BASE PUB MATCH             
         BNE   *+18                                                             
         L     R0,=F'-1'           SET INDICATOR                                
         MVC   PAORPUB(4),PUBAVPUB SAVE AOR'S BASE PUB ID                       
         B     GTAGYPBX                                                         
*                                                                               
         TM    PAOCCNTL,X'01'      IF PUBLINKS NOT REQUIRED                     
         BO    *+14                                                             
         MVC   PAORPUB,PAOPUB         USE AGY'S NUMBER                          
         B     GTAORPBX                                                         
*                                                                               
         B     GTAORPER                                                         
*                                                                               
         DROP  R2                                                               
*                                                                               
GTAORPER DS    0H                                                               
*                                                                               
         CLI   PBQDOWN,C'Y'        SKIP IF WE ARE DOWNLOADING                   
         BE    GTAORPEX                                                         
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY BUILD AREA                          
         LA    R6,IOKEY            ESTABLISH KEY AREA AS PUB MASTER KEY         
         USING PUBREC,R6                                                        
*                                                                               
         MVC   PUBKMED,PBMED       MEDIA                                        
         MVC   PUBKPUB(L'PBPUB+L'PBZONE+L'PBACTED),PAOPUB                       
         MVC   PUBKAGY,PBAGY                                                    
         MVI   PUBKCOD,X'81'                                                    
         MVC   PUBKAGY,PAOAGY      BUYING AGENCY                                
*                                                                               
         SR    R3,R3                                                            
         L     RF,PBUTLA                                                        
         IC    R3,4(RF)            SAVE CURRENT SE                              
         MVC   4(1,RF),PAOSE       SET TO READ AGY'S FILES                      
*                                                                               
         L     R2,AIO3             SAVE IOAREA ADDRESS                          
         ST    RA,AIO3             RESET TO WORKAREA                            
*                                                                               
*        PUB-IO READ PUBREC DIR                                                 
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOHI                                                
*                                                                               
         CLC   IOKEY(L'PUBKEY),IOKEYSAV IF DESIRED RECORD FOUND                 
         BE    GTAORDRX           GO GET RECORD                                 
*                                                                               
         CLI   PBAGYPRF+16,C'0'    IF NOT USING SRDS DEFAULT                    
         BNE   *+6                                                              
         DC    H'0'                   THEN MUST HAVE PUB                        
*                                  ELSE LOOK UNDER DEFAULT AGENCY               
         MVC   IOKEY,IOKEYSAV      RESTORE ORIGINAL KEY                         
         MVC   PUBKAGY,=C'ZZ'      CHANGE TO DEFAULT AGENCY                     
*                                                                               
*        PUB-IO READ PUBREC DIR                                                 
*                                                                               
         GOTO1 AIO,IOPUBDIR+IO3+IOHI                                            
*                                                                               
         CLC   IOKEY(L'PUBKEY),IOKEYSAV                                         
         BE    *+6                                                              
         DC    H'0'                PUB NOT FOUND                                
*                                                                               
*        READ RECORD INTO CORE                                                  
*                                                                               
GTAORDRX DS     0H                                                              
*                                                                               
         GOTO1 AIO,IOPUBFIL+IO3+IOGET                                           
         BE    *+6                                                              
         DC    H'0'                MUST FIND IT                                 
*                                                                               
         ST    R2,AIO3             RESTORE IOAREA POINTER                       
*                                                                               
         LR    R6,RA                                              L05           
*                                                                               
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
*                                                                               
         CLI   0(R6),X'10'         DONE IF PUB NAME ELEMENT                     
         BE    GTAORPN1                                                         
         ICM   RF,1,1(R6)          ELEMENT LENGTH                               
         LA    R6,0(RF,R6)         NEXT ELEMENT                                 
         BNZ   *-16                                                             
         DC    H'0'                MUST FIND IT                                 
*                                                                               
GTAORPN1 DS    0H                                                               
*                                                                               
         USING PUBNAMD,R6          ESTABLISH PUBNAME ELEMENT                    
*                                                                               
         MVC   GTPAOBLK,PAOBLK     COPY PAOBLK                                  
         MVC   GTMED,PBMED         COPY MEDIA                                   
         MVC   GTPUBNM,PUBNAME     COPY PUB NAME                                
         MVC   GTPZNAME,PUBZNAME   COPY PUB ZONE NAME                           
         MVC   GTPCITY,PUBCITY     COPY PUB CITY                                
         MVC   GTPSTATE,PUBSTATE   COPY PUB STATE                               
*                                                                               
         L     R4,PBPLEDCB         PUBERR DCB ADDRESS                           
*                                                                               
         MVI   PAOPLESW,C'Y'       INDICATE PUBERR FILE USED                    
*                                                                               
         PUT   (R4),GTPAOBLK       SAVE PAOBLK FOR REPORT                       
*                                                                               
         L     RF,PBUTLA                                                        
         STC   R3,4(RF)            RESTORE CURRENT SE                           
*                                                                               
GTAORPEX DS    0H                                                               
*                                                                               
         LA    R0,1                INDICATE ERROR                               
*                                                                               
         B     GTAORPBX            NEQ CC SET                                   
*                                                                               
GTAORPBX DS    0H                                                               
*                                                                               
         MVC   IOKEY,GTIOKEY       RESTORE SAVED KEYS                           
         MVC   IOKEYSAV,GTIOKEYS                                                
*                                                                               
         LTR   R0,R0               SET CC                                       
*                                                                               
         XIT1                                                                   
*                                                                               
GTAORAGY DC    CL(L'PAOAGY)'00'    CURRENT AGENCY SAVE AREA                     
*                                                                               
GTIOKEY  DS    XL32                KEY SAVE AREA                                
GTIOKEYS DS    XL32                KEYSAVE SAVE AREA                            
*                                                                               
GTPERR   DS    0X                  START OF UBERR FILE DATA                     
GTPAOBLK DS    XL(PAOBLKL)         PAOBLK PUT AREA                              
GTMED    DS    XL(L'PBMED)         MEDIA CODE                                   
GTPUBNM  DS    XL(L'PUBNAME)       PUB NAME      PUT AREA                       
GTPZNAME DS    XL(L'PUBZNAME)      PUB ZONE NAME PUT AREA                       
GTPCITY  DS    XL(L'PUBCITY)       PUB CITY      PUT AREA                       
GTPSTATE DS    XL(L'PUBSTATE)      PUB STATE     PUT AREA                       
GTPERRL  EQU   *-GTPERR            LENGTH OF PUBERR FILE DATA                   
*                                                                               
         EJECT                                                                  
*                                                                               
SAVER7   DS    F                                                                
SAVER8   DS    F                                                                
SAVER9   DS    F                                                                
SAVERA   DS    F                                                                
SAVERB   DS    F                                                                
SAVERC   DS    F                                                                
*                                                                               
OCASHDSC DC    H'0'                                                             
*                                                                               
PATCH    DC    20X'00'                                                          
PHASES   DS    0X                  ** LOADED PHASE LIST **                      
         DC    AL1(QOFFICER)                                                    
         DC    AL1(QSPOOL)                                                      
         DC    AL1(QTSAROFF)                                                    
         DC    AL1(QCASHIER)                                                    
         DC    AL1(QGETINS)                                                     
PHASESN  EQU   *-PHASES                                                         
         SPACE 1                                                                
CONADDRS DS    0F                  ** PRWRIIO FACILITIES **                     
         DC    V(QSORT)                                                         
         DC    V(BINSRCH)                                                       
         DC    A(FILTAB)                                                        
         DC    A(SYSTAB)                                                        
         DC    A(CMDTAB)                                                        
         DC    A(IOEX)                                                          
         DC    A(0)                                                             
         DC    A(0)                                                             
         DC    A(0)                                                             
         DC    V(ADDAY)                                                         
CONADDRN EQU   (*-CONADDRS)/L'CONADDRS                                          
*                                                                               
* DATE FILTER TABLE  +0 ALPHA CODE/  (VALUE IN PBQDATYP)                        
*      +1 ELEMENT ID / WHICH ELEMENT DATE IS TO BE CHECKED                      
*              IF 00  DATE CHECK WILL BE DONE PRIOR TO DTEFLT (KEY)             
*              IF FF  DTE CHK WILL BE DONE IN GETINS                            
*      +2 IF ELEMENT ID IS OTHER THAN 00 OR FF THIS WILL CONTAIN                
*              DISPLACEMENT OF THE DATE  WITHIN THE ELEMENT                     
*              IF +1 IS FF THIS WILL CONTAIN FILTER FOR GETINS                  
*                                                                               
DTEFLT   DC    C'A',X'FF',C'P'   PAID DATE                                      
         DC    C'B',X'20',AL1(PBDBDATE-PBDELEM)  BILLABLE DATE                  
         DC    C'C',X'20',AL1(PBDCDATE-PBDELEM)  CLOSING                        
         DC    C'I',X'00',AL1(PBUYKDAT-PBUYREC)  INSERTION DATE                 
         DC    C'L',X'FF',C'B'   BILLED                                         
         DC    C'M',X'20',AL1(PBDMDATE-PBDELEM)  MATERIALS CLOSING              
         DC    C'O',X'70',AL1(PIODATE-PIOELEM)  INSERTION ORDER L12             
         DC    C'P',X'20',AL1(PBDPDATE-PBDELEM)  PAYABLE DATE                   
         DC    C'S',X'20',AL1(PBDSDATE-PBDELEM)  ON SALE DATE                   
         DC    C'T',X'FF',C'T'  FILTER ON PAID AND/OR BILLED DATE               
         DC    C'U',X'00',AL1(PBUYKDAT-PBUYREC)  UNPAID BY INSERT DTE01         
         DC    C'Z',X'FF',C'T'  FILTER - BOTH MUST BE PAID AND BILLED           
         DC    C'1',X'20',AL1(PBDBDATE-PBDELEM)  MONTH OF SERVICE               
         DC    X'FF'            END OF TABLE                                    
*                                                                               
         TITLE 'T00A4C - PRWRIIO - FILTER ON SPACE DESC - SPCFLT'               
***********************************************************************         
*                                                                     *         
*        ROUTINE TO FILTER ON SPACE DESCRIPTIONS                      *         
*                                                                     *         
*NTRY    PARM0       A(SPACE DESCRIPTION)                             *         
*                                                                     *         
*EXIT    EQ     -   PASSES SPACE FILTER                               *         
*        NEQ    -   FAILS  SPACE FILTER                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
SPCFLT   NTR1                                                                   
*                                                                               
         L     R3,0(R1)            POINT TO SPACE DESCRIPTION                   
*                                                                               
         CLC   PBQSPDS1,BLANKS     SKIP IF FIRST SPACE FILTER MISSING           
         BNH   SPCF1N                                                           
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,PBQSPD1L         LENGTH OF SPACE FILTER 1                   
         SLL   RF,25                 CLEAR 80 BIT                               
         SRL   RF,25                                                            
*                                                                               
         LTR   RF,RF                                                            
         BZ    SPCF13                NO LENGTH ASSUME MATCH                     
*                                                                               
         BCTR  RF,0                  DECREMENT FOR EXECUTE                      
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R3),PBQSPDS1      THEN SPACE DESCRIPTION MUST MATCH          
         BNE   SPCF14                                                           
*                                                                               
SPCF13 DS      0H                                                               
*                                                                               
         TM    PBQSPD1L,X'80'      DROP IF A NEGATIVE FILTER                    
         BO    SPCFDROP                                                         
         B     SPCFKEEP            ELSE KEEP                                    
*                                                                               
SPCF14 DS      0H                                                               
*                                                                               
         CLC   PBQSPDS2,BLANKS    IF SECOND FILTER NOT ENTERED                  
         BH    *+16                                                             
         TM    PBQSPD1L,X'80'        KEEP IF A NEGATIVE FILTER                  
         BO    SPCFKEEP                                                         
         B     SPCFDROP              ELSE DROP                                  
*                                                                               
*        SECOND SPACE FILTER PRESENT                                            
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,PBQSPD2L         LENGTH OF SPACE FILTER 2                   
         SLL   RF,25                 CLEAR 80 BIT                               
         SRL   RF,25                                                            
*                                                                               
         LTR   RF,RF                                                            
         BZ    SPCF23                NO LENGTH ASSUME MATCH                     
*                                                                               
         BCTR  RF,0                  DECREMENT FOR EXECUTE                      
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R3),PBQSPDS2      COMPARE TO SECOND FILTER                   
         BNE   SPCF24                                                           
*                                                                               
SPCF23 DS      0H                                                               
*                                                                               
         TM    PBQSPD2L,X'80'      DROP IF A NEGATIVE FILTER                    
         BO    SPCFDROP                                                         
         B     SPCFKEEP            ELSE KEEP                                    
*                                                                               
SPCF24 DS      0H                                                               
*                                                                               
         TM    PBQSPD2L,X'80'        KEEP IF A NEGATIVE FILTER                  
         BO    SPCFKEEP                                                         
         B     SPCFDROP              ELSE DROP                                  
*                                                                               
SPCF1N DS      0H                                                               
*                                                                               
         CLC   PBQSPDS2,BLANKS       ACCEPT IF NO SECOND FILTER                 
         BNH   SPCFKEEP                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,PBQSPD2L         LENGTH OF SPACE FILTER 2                   
         SLL   RF,25                 CLEAR 80 BIT                               
         SRL   RF,25                                                            
*                                                                               
         LTR   RF,RF                                                            
         BZ    SPCF33                NO LENGTH ASSUME MATCH                     
*                                                                               
         BCTR  RF,0                  DECREMENT FOR EXECUTE                      
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R3),PBQSPDS2      COMPARE TO SECOND FILTER                   
         BNE   SPCF34                                                           
*                                                                               
SPCF33 DS      0H                                                               
*                                                                               
         TM    PBQSPD2L,X'80'      DROP IF A NEGATIVE FILTER                    
         BO    SPCFDROP                                                         
         B     SPCFKEEP            ELSE KEEP                                    
*                                                                               
SPCF34 DS      0H                                                               
*                                                                               
         TM    PBQSPD2L,X'80'        KEEP IF A NEGATIVE FILTER                  
         BO    SPCFKEEP                                                         
         B     SPCFDROP              ELSE DROP                                  
*                                                                               
SPCFDROP DS    0H                  FAILS  SPACE FILTER                          
         LTR   RB,RB               SET CC NEQ                                   
         B     SPCFX                                                            
*                                                                               
SPCFKEEP DS    0H                  PASSES SPACE FILTER                          
         CR    RB,RB               SET CC EQ                                    
         B     SPCFX                                                            
*                                                                               
SPCFX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - READ BILL RECORDS - READBLLS'                
***********************************************************************         
*                                                                     *         
*        ROUTINE TO READ BILL RECORDS                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
READBLLS NMOD1 0,**+RBL**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    PBRGN,PBRGN         INIT REGION CODE                             
         XC    PBREGNM,PBREGNM     INIT REGION NAME                             
         XC    PBDST,PBDST         INIT DISTRICT CODE                           
         XC    PBDSTNM,PBDSTNM     INIT DISTRICT NAME                           
*                                                                               
***********************************************************************         
*                                                                     *         
*        INITIALIZE DDCASHIER CONTROL BLOCK                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
CSHINIT  DS    0H                                                               
*                                                                               
         TM    PBBYOPTS,PBBYBHTQ   SKIP UNLESS BUILDING BILLREC TABLE           
         BNO   CSHINITX                                                         
*                                                                               
         LA    R6,CSHIERC          POINT TO CASHIER CONTROL BLOCK               
         USING CSHIERD,R6          ESTABLISH AREA                               
         XC    CSHIERD(CSHIERL),CSHIERD INIT CONTROL BLOCK                      
*                                                                               
         MVI   CSHACT,CSHINIQ      SET TO INITIALIZE                            
*                                                                               
         MVC   CSHAGYCH,PBAGY      SET AGENCY ALPHA                             
         MVI   CSHSYS,CSHPRTQ      SET TO PRINT SYSTEM                          
*                                                                               
         MVC   CSHBLLL,=Y(256)     MAX BILL HEADER RECORD LENGTH                
         MVI   CSHBLLKL,L'PBILLKEY BILL RECORD KEY LENGTH                       
*                                                                               
         MVC   CSHMAX,=F'2000'     MAX NUMBER OF BILL RECORDS                   
*                                                                               
         OI    CSHCTL,CSHCBLLQ     INDICATE BILL DATA WANTED                    
*                                                                               
         TM    PBBYOPT2,PBBYCSHQ   IF CASH DATA NEEDED                          
         BNO   *+8                                                              
         OI    CSHCTL,CSHCCSHQ        INDICATE CASH DATA WANTED                 
*                                                                               
         MVC   CSHBLLA,IOADDR      SET A(BILLREC)                               
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         MVC   CSHDMGRA,CDATAMGR-COMFACSD(RF)   DATAMGR ADDRESS                 
         MVC   CSHGTPRA,CGETPROF-COMFACSD(RF)   GETPROF ADDRESS                 
         MVC   CSHDATCA,CDATCON-COMFACSD(RF)    DATCON  ADDRESS                 
*                                                                               
         CLI   PBQTRACE,C'Y'       IF TRACING                                   
         BNE   CSHINIT1                                                         
*                                                                               
         L     RF,=A(ACCTRACE)        POINT TO ACC TRACE ROUTINE                
         ST    RF,CSHDMGRA                                                      
         L     RF,=A(ACTR7SV)      SAVE R7                                      
         ST    R7,0(RF)                                                         
*                                                                               
CSHINIT1 DS    0H                                                               
*                                                                               
         MVC   CSHTSARA,VTSAROFF   PASS V(TSAROFF)                              
         MVC   CSHUTLA,PBUTLA      PASS V(UTL)                                  
         MVC   CSHCLTA,PBCLTADR    PASS A(CLTREC)                               
*                                                                               
         GOTO1 VCASHIER,PARM,CSHIERD    INIT DDCASHIER                          
         CLI   CSHERR,0            NO ERRORS TOLERATED                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
CSHINITX DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS BILL RECORD KEY         
         USING PBILLRCD,R2                                                      
*                                                                               
         MVC   PBILKAGY,PBAGY      SET AGENCY                                   
         MVC   PBILKMED,PBMED      SET MEDIA                                    
         MVI   PBILKRCD,PBILKIDQ   SET RECORD ID                                
         MVC   PBILKCLT,PBCLT      SET CLIENT                                   
         MVC   PBILKPRD,PBPROD     SET PRODUCT                                  
         MVC   PBILKEST,PBQESTB    SET ESTIMATE                                 
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST POINTER                           
*                                                                               
RBLBLLLP DS    0H                                                               
*                                                                               
         CLC   IOKEY(PBILKEST-PBILLRCD),IOKEYSAV  SAME A/M/C/P                  
         BNE   READBLLX                                                         
*                                                                               
         LA    R2,IOKEY            RE-ESTABLISH KEYAREA AS BILLREC KEY          
         USING PBILLRCD,R2                                                      
*                                                                               
*        FILTER ON ESTIMATE                                                     
*                                                                               
         XC    ESTDATA,ESTDATA     INIT ESTIMATE DATA                           
         LA    R8,ESTDATA          ESTABLISH ESTIMATE DATA AREA AS              
         USING ESTBUFFD,R8           ENTRY IN ESTIMATE BUFFER                   
*                                                                               
         MVC   EBFMED,PBILKMED     SET MEDIA                                    
         MVC   EBFCLT,PBILKCLT     SET CLIENT                                   
         MVC   EBFPRD,PBILKPRD     SET PRODUCT                                  
         MVC   EBFEST,PBILKEST     SET ESTIMATE                                 
*                                                                               
         BAS   RE,FLTREST          FILTER ON ESTIMATE                           
         BE    RBLFLTX               PASSED  FILTER                             
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,3,PBILKEST       FORCE NEXT ESTIMATE                          
         LA    RE,1(RE)                                                         
         STCM  RE,3,PBILKEST                                                    
         XC    PBILKMOS(13),PBILKMOS CLEAR REST OF KEY                          
         B     RBLBLLNX            READ NEXT POINTER                            
*                                                                               
RBLFLTX  DS    0H                                                               
*                                                                               
         CLI   PBQPRTYP,PBQPRMOS   SKIP IF PERIOD IS NOT FOR MOS                
         BNE   RBLPER20                                                         
*                                                                               
         CLC   PBILKMOS,PBQBST     TEST PRIOR TO REQUEST PERIOD                 
         BNL   RBLPER10            YES                                          
*                                                                               
         MVC   PBILKMOS,PBQBST     BUMP DATES FOR NEXT READ                     
         XC    PBILKBMN(11),PBILKBMN  CLEAR REST OF KEY                         
         B     RBLBLLNX                                                         
*                                                                               
RBLPER10 DS    0H                                                               
*                                                                               
         CLC   PBILKMOS,PBQBEND    TEST AFTER REQUEST PERIOD END                
         BNH   RBLPERX             NO                                           
*                                                                               
         MVC   PBILKMOS(15),XFF    FORCE NEXT ESTIMATE                          
         B     RBLBLLNX                                                         
*                                                                               
RBLPER20 DS    0H                                                               
*                                                                               
         CLC   PBILKBMN,PBQBST     TEST PRIOR TO REQUEST PERIOD                 
         BNL   RBLBLL25            YES                                          
*                                                                               
         MVC   PBILKBMN,PBQBST     FORCE TO REQUEST START                       
         XC    PBILKBNO(9),PBILKBNO CLEAR REST OF KEY                           
         B     RBLBLLNX                                                         
*                                                                               
RBLBLL25 DS    0H                                                               
*                                                                               
         CLC   PBILKBMN,PBQBEND    TEST AFTER REQUEST PERIOD END                
         BNH   RBLPERX             NO                                           
*                                                                               
         MVC   PBILKBMN(13),XFF    FORCE NEXT ESTIMATE                          
         B     RBLBLLNX                                                         
*                                                                               
RBLPERX  DS    0H                                                               
*                                                                               
         OC    PBQBLLST(6),PBQBLLST  SKIP IF NO BILLED-IN FILTER                
         BZ    RBLBFLX                                                          
*                                                                               
         CLC   PBILKBMN,PBQBLLST     SKIP IF BEFORE                             
         BL    RBLBLLCN                                                         
         CLC   PBILKBMN,PBQBLLND       OR AFTER BILLED-IN PERIOD                
         BH    RBLBLLCN                                                         
*                                                                               
RBLBFLX  DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1    READ RECORD                            
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
*                                                                               
         MVC   PBEST,PBILKEST      SET ACTUAL ESTIMATE                          
*                                                                               
         OC    PBQBLLST(6),PBQBLLST SKIP IF NO BILLED-IN FILTER                 
         BZ    RBLBLL30                                                         
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATCON-COMFACSD(RF)    DATCON ADDRESS                        
*                                                                               
         GOTO1 (RF),PARM,PBILLDAT,(3,DUB)   CONVERT DATE FORMAT                 
*                                                                               
         CLC   DUB(3),PBQBLLST     BILLED IN DATES MUST LIE IN                  
         BL    RBLBLLCN                                                         
         CLC   DUB(3),PBQBLLND       FILTER PERIOD                              
         BH    RBLBLLCN                                                         
*                                                                               
RBLBLL30 DS    0H                                                  L14          
*                                                                               
*        CHECK RUN, DUE, INVOICE & POSTING DATE FILTERS                         
*                                                                               
         OC    PBQBRNST(6),PBQBRNST SKIP IF NO RUN DATE FILTER                  
         BZ    RBLBLRNN                                                         
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATCON-COMFACSD(RF)    DATCON ADDRESS                        
*                                                                               
         GOTO1 (RF),PARM,PBILLDAT,(3,DUB)   CONVERT DATE FORMAT                 
*                                                                               
         CLC   DUB(3),PBQBRNST     RUN DATES MUST LIE IN                        
         BL    RBLBLLCN                                                         
         CLC   DUB(3),PBQBRNND       FILTER PERIOD                              
         BH    RBLBLLCN                                                         
*                                                                               
RBLBLRNN DS    0H                                                               
*                                                                               
         OC    PBQBDUST(6),PBQBDUST SKIP IF NO DUE DATE FILTER                  
         BZ    RBLBLDUN                                                         
*                                                                               
         CLC   PBILDUED,PBQBDUST   RUN DATES MUST LIE IN                        
         BL    RBLBLLCN                                                         
         CLC   PBILDUED,PBQBDUND     FILTER PERIOD                              
         BH    RBLBLLCN                                                         
*                                                                               
RBLBLDUN DS    0H                                                               
*                                                                               
         OC    PBQBEDST(4),PBQBEDST SKIP IF NO EDI DATE FILTER                  
         BZ    RBLBLEDN                                                         
*                                                                               
         CLC   PBILEDID,PBQBEDST   EDI DATES MUST LIE IN                        
         BL    RBLBLLCN                                                         
         CLC   PBILEDID,PBQBEDND     FILTER PERIOD                              
         BH    RBLBLLCN                                                         
*                                                                               
RBLBLEDN DS    0H                                                               
*                                                                               
*                                                                               
         OC    PBQBIVST(6),PBQBIVST SKIP IF NO INVOICE DATE FILTER              
         BZ    RBLBLIVN                                                         
*                                                                               
         CLC   PBILINVD,PBQBIVST   RUN DATES MUST LIE IN                        
         BL    RBLBLLCN                                                         
         CLC   PBILINVD,PBQBIVND     FILTER PERIOD                              
         BH    RBLBLLCN                                                         
*                                                                               
RBLBLIVN DS    0H                                                               
*                                                                               
         OC    PBQBPSST(6),PBQBPSST SKIP IF NO POSTING DATE FILTER              
         BZ    RBLBLPSN                                                         
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATCON-COMFACSD(RF)    DATCON ADDRESS                        
*                                                                               
         GOTO1 (RF),PARM,(2,PBILPOST),(3,DUB)   CONVERT DATE FORMAT             
*                                                                               
         CLC   DUB(3),PBQBPSST     RUN DATES MUST LIE IN                        
         BL    RBLBLLCN                                                         
         CLC   DUB(3),PBQBPSND       FILTER PERIOD                              
         BH    RBLBLLCN                                                         
*                                                                               
RBLBLPSN DS    0H                                                               
*                                                                               
         MVC   WORK,IOKEY          SAVE KEY                                     
*                                                                               
         CLC   PBQBTYPE,=C'  '      SKIP IF NO BILL TYPE FILTER                 
         BH    *+16                                                             
*                                     OR UFC/NET/COM/AOR/CLR FLTR               
         TM    PBQBLLOP,PBQBUFCQ+PBQBNETQ+PBQBCOMQ+PBQBAORQ+PBQBCLRQ            
         BNZ   *+8                                                              
         B     RBLBTPX                                                          
*                                                                               
*        CHECK FOR UFC FILTERING                                                
*                                                                               
         TM    PBQBLLOP,PBQBUFCQ   SKIP IF NOT UFC BILLING TYPE                 
         BNO   RBLBTPUN                                                         
*                                                                               
         TM    PBQBLLOP,PBQBNBTQ   SKIP IF EXCLUSION SWITCH ON                  
         BO    RBLBTPU5                                                         
*                                                                               
         TM    PBILCMSW,X'01'           REJECT IF NOT A UFC BILL                
         BNO   RBLBLLCN                                                         
*                                                                               
         B     RBLBTP01                 ELSE KEEP CONSIDERING                   
*                                                                               
RBLBTPU5 DS    0H                                                               
*                                                                               
         TM    PBILCMSW,X'01'      ACCEPT IF NOT A UFC BILL                     
         BNO   RBLBTPX                                                          
*                                                                               
         CLC   PBQBTYPE,=C'  '     REJECT IF NO BILL TYPE FILTER                
         BNH   RBLBLLCN                                                         
*                                                                               
         B     RBLBTP01            ELSE KEEP CONSIDERING                        
*                                                                               
RBLBTPUN DS    0H                                                               
*                                                                               
*        CHECK FOR NET FILTERING                                                
*                                                                               
         TM    PBQBLLOP,PBQBNETQ    SKIP IF NOT NET BILLING TYPE                
         BNO   RBLBTPNN                                                         
*                                                                               
         TM    PBQBLLOP,PBQBNBTQ   SKIP IF EXCLUSION SWITCH ON                  
         BO    RBLBTPN5                                                         
*                                                                               
         TM    PBILCMSW,X'08'      REJECT IF NOT A NET BILL                     
         BNO   RBLBLLCN                                                         
*                                                                               
         B     RBLBTP01            ELSE KEEP CONSIDERING                        
*                                                                               
RBLBTPN5 DS    0H                                                               
*                                                                               
         TM    PBILCMSW,X'08'      ACCEPT NOT A NET BILL                        
         BNO   RBLBTPX                                                          
*                                                                               
         CLC   PBQBTYPE,=C'  '     REJECT IF NO BILL TYPE FILTER                
         BNH   RBLBLLCN                                                         
*                                                                               
         B     RBLBTP01            ELSE KEEP CONSIDERING                        
*                                                                               
RBLBTPNN DS    0H                                                               
*                                                                               
*        CHECK FOR COMMISSION BILLS FILTERING                                   
*                                                                               
         TM    PBQBLLOP,PBQBCOMQ    SKIP IF NOT COM BILLING TYPE                
         BNO   RBLBTPCN                                                         
*                                                                               
         TM    PBQBLLOP,PBQBNBTQ   SKIP IF EXCLUSION SWITCH ON                  
         BO    RBLBTPC5                                                         
*                                                                               
         TM    PBILCMSW,X'02'      REJECT IF NOT A COM BILL                     
         BNO   RBLBLLCN                                                         
*                                                                               
         B     RBLBTP01            ELSE KEEP CONSIDERING                        
*                                                                               
RBLBTPC5 DS    0H                                                               
*                                                                               
         TM    PBILCMSW,X'02'      ACCEPT IF NOT A COM BILL                     
         BNO   RBLBTPX                                                          
*                                                                               
         CLC   PBQBTYPE,=C'  '     REJECT IF NO BILL TYPE FILTER                
         BNH   RBLBLLCN                                                         
*                                                                               
         B     RBLBTP01            ELSE KEEP CONSIDERING                        
*                                                                               
RBLBTPCN DS    0H                                                               
*                                                                               
*        CHECK FOR AOR BILLS FILTERING                                          
*                                                                               
         TM    PBQBLLOP,PBQBAORQ    SKIP IF NOT AOR BILLING TYPE                
         BNO   RBLBTPAN                                                         
*                                                                               
         TM    PBQBLLOP,PBQBNBTQ   SKIP IF EXCLUSION SWITCH ON                  
         BO    RBLBTPA5                                                         
*                                                                               
         TM    PBILCMSW,X'20'      REJECT IF NOT AN AOR BILL                    
         BNO   RBLBLLCN                                                         
*                                                                               
         B     RBLBTP01            ELSE KEEP CONSIDERING                        
*                                                                               
RBLBTPA5 DS    0H                                                               
*                                                                               
         TM    PBILCMSW,X'20'      ACCEPT IF NOT AN AOR BILL                    
         BNO   RBLBTPX                                                          
*                                                                               
         CLC   PBQBTYPE,=C'  '     REJECT IF NO BILL TYPE FILTER                
         BNH   RBLBLLCN                                                         
*                                                                               
         B     RBLBTP01            ELSE KEEP CONSIDERING                        
*                                                                               
RBLBTPAN DS    0H                                                               
*                                                                               
*        CHECK FOR CLR BILLS FILTERING                                          
*                                                                               
         TM    PBQBLLOP,PBQBCLRQ    SKIP IF NOT CLR BILLING TYPE                
         BNO   RBLBTCLN                                                         
*                                                                               
         TM    PBQBLLOP,PBQBNBTQ   SKIP IF EXCLUSION SWITCH ON                  
         BO    RBLBTCL5                                                         
*                                                                               
         TM    PBILSTAT,X'01'      REJECT IF NOT AN CLR BILL                    
         BNO   RBLBLLCN                                                         
*                                                                               
         B     RBLBTP01            ELSE KEEP CONSIDERING                        
*                                                                               
RBLBTCL5 DS    0H                                                               
*                                                                               
         TM    PBILSTAT,X'01'      ACCEPT IF NOT A CLR BILL                     
         BNO   RBLBTPX                                                          
*                                                                               
         CLC   PBQBTYPE,=C'  '     REJECT IF NO BILL TYPE FILTER                
         BNH   RBLBLLCN                                                         
*                                                                               
         B     RBLBTP01            ELSE KEEP CONSIDERING                        
*                                                                               
RBLBTCLN DS    0H                                                               
*                                                                               
*        CHECK ON BILL TYPE AND MODE                                            
*                                                                               
RBLBTP01 DS    0H                                                               
*                                                                               
         CLC   PBQBTYPE,=C'  '      SKIP IF NO BILL TYPE FILTER                 
         BNH   RBLBTPX                                                          
*                                                                               
         TM    PBQBLLOP,PBQBNBTQ   SKIP IF EXCLUSION SWITCH ON                  
         BO    RBLBTP15                                                         
*                                                                               
         CLC   PBILLTYP,PBQBTYPE   REJECT IF NO BILL TYPE MATCH                 
         BNE   RBLBLLCN                                            L14          
*                                                                               
         CLI   PBQBTYPE+1,C' '     ACCEPT IF NO MODE ENTERED                    
         BNH   RBLBTPX                                                          
*                                                                               
         CLC   PBILLMOD,PBQBTYPE+1 ELSE MUST MATCH ON MODE                      
         BNE   RBLBLLCN                                                         
*                                                                               
         B     RBLBTPX             ELSE ACCEPT                                  
*                                                                               
RBLBTP15 DS    0H                                                               
*                                                                               
         CLC   PBILLTYP,PBQBTYPE   ACCEPT IF NO BILL TYPE MATCH                 
         BNE   RBLBTPX                                                          
*                                                                               
         CLI   PBQBTYPE+1,C' '     REJECT IF NO MODE ENTERED                    
         BNH   RBLBLLCN                                                         
*                                                                               
         CLC   PBILLMOD,PBQBTYPE+1  REJECT IF MATCH ON MODE                     
         BE    RBLBLLCN                                                         
*                                                                               
         B     RBLBTPX             ELSE ACCEPT                                  
*                                                                               
RBLBTPX  DS    0H                                                               
*                                                                               
*        FILTER ON DIVISION                                                     
*                                                                               
RBLDIV   DS    0H                                                               
*                                                                               
         CLC   PBQDIV,=C'ALL'      ACCEPT IF ALL DIVISIONS REQUESTED            
         B     RBLDIVX             BYPASS TEST                                  
         OC    PBQDIV,PBQDIV               BIN ZERO = ALL                       
         BE    *+10                                                             
         CLC   PBQDIV,PNBPGR1      ELSE MUST MATCH REQUESTED DIVISION           
         BNE   RBLBLLCN                                                         
*                                                                               
RBLDIVX  DS    0H                                                               
*                                                                               
*        FILTER ON REGION                                                       
*                                                                               
RBLREG   DS    0H                                                               
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   SKIP IF DRDCLI PRESENT                       
         BNZ   RBLREG1                                                          
*                                                                               
         CLC   PBQRGN,=C'ALL'      ACCEPT IF ALL REGIONS REQUESTED              
         BE    *+10                                                             
         OC    PBQRGN,PBQRGN               BIN ZERO = ALL                       
         BE    *+10                                                             
         CLC   PBQRGN,PNBMGR1      ELSE MUST MATCH REQUESTED REGION             
         BNE   RBLBLLCN                                                         
*                                                                               
RBLREG1  DS    0H                                                               
*                                                                               
*        FILTER ON DISTRICT                                                     
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   SKIP IF DRDCLI PRESENT                       
         BNZ   RBLDST1                                                          
*                                                                               
         CLC   PBQDST,=C'ALL'      ACCEPT IF ALL DISTRICTS REQUESTED            
         BE    *+10                                                             
         OC    PBQDST,PBQDST              BIN 0  MEANS ALL                      
         BZ    *+10                                                             
         CLC   PBQDST,PNBMGR2       ELSE MUST MATCH REQUESTED DISTRICT          
         BNE   RBLBLLCN                                                         
*                                                                               
RBLDST1  DS    0H                                                               
*                                                                               
*        LOOK UP REGION/DISTRICT NAMES IN REGION BUFFER                         
*                                                                               
         MVC   PBRGN,PNBMGR1       RETURN REGION   CODE                         
*                                                                               
         ICM   R8,15,PBADRDBF      ADDRESS OF DRD BUFFER                        
         BNZ   *+6                                                              
         DC    H'0'                MUST HAVE BUFFER                             
         USING DRDBUFFD,R8         ESTABLISH DRD BUFFER ENTRY                   
*                                                                               
RBLBUFLP DS    0H                                                               
*                                                                               
         OC    0(DRDLEN,R8),0(R8)  DONE IF END OF TABLE                         
         BZ    RBLBUFDN                                                         
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   IF USING ANOTHER CLIENT'S DRD                
         BZ    *+18                   SCHEME                                    
         CLC   =C'000',DRDDIV         MATCH TO DIVISION 000                     
         BE    RBLBUFL1                                                         
         B     RBLBUFCN               ELSE REJECT                               
*                                                                               
         OC    PNBPGR1,PNBPGR1     IF DIVISION PRESENT                          
         BZ    *+10                                                             
         CLC   PNBPGR1,DRDDIV         MATCH DIVISION                            
         BNE   RBLBUFCN                                                         
*                                                                               
RBLBUFL1 DS    0H                                                               
*                                                                               
         OC    PNBMGR1,PNBMGR1     IF REGION PRESENT                            
         BZ    RBLBUF40                                                         
         CLC   PNBMGR1,DRDRGN        MATCH REGION                               
         BNE   RBLBUFCN                                                         
*                                                                               
*          REGION ENTRY ALWAYS BEFORE DISTRICT ENTRIES                          
*                                                                               
         OC    DRDDST,DRDDST       DISTRICT MUST BE NULLS FOR REG               
         BNZ   RBLBUF40               ENTERY IN BUFFER                          
*                                                                               
         MVC   PBREGNM,DRDNAME     SET REGION NAME                              
*                                                                               
*        FIND DISTRICT ENTRY                                                    
*                                                                               
RBLBUF40 DS    0H                                                               
*                                                                               
         OC    PBQDST,PBQDST       SKIP IF NO DISTRICT SCHEME WANTED            
         BZ    RBLBUFDN                                                         
*                                                                               
         OC    PNBMGR2,PNBMGR2     IF DISTRICT PRESENT                          
         BZ    RBLBUFDN                                                         
*                                                                               
         CLC   PNBMGR2,DRDDST         MUST MATCH ON DISTRICT                    
         BNE   RBLBUFCN                                                         
*                                                                               
         MVC   PBDST,DRDDST        RETURN DISTRICT CODE                         
         MVC   PBDSTNM,DRDNAME     RETURN DISTRICT NAME                         
*                                                                               
         B     RBLBUFDN            ALL DONE                                     
*                                                                               
RBLBUFCN DS    0H                                                               
*                                                                               
         LA    R8,DRDLEN(R8)       BUMP TO NEXT ELEMENT IN BUFFER               
         B     RBLBUFLP                                                         
*                                                                               
RBLBUFDN DS    0H                                                               
*                                                                               
*        FILTER ON JOB CODE IF NEEDED                                           
*           JOB AND AD CODES ARE THE SAMETHING                                  
*                                                                               
RBLJOB   DS    0H                                                               
*                                                                               
         CLC   PBQADC,=CL6' '      SKIP IF NO AD CODE REQUESTED                 
         BNH   RBLJOBX                                                          
*                                                                               
         SR    RF,RF                                                            
         LA    R6,PBILLEL          POINT TO FIRST ELEMENT IN RECORD             
         USING PBILOTH,R6          ESTABLISH AS OTHER ELEMENT                   
*                                                                               
         CLI   PBILOTH,X'09'       FIND OTHER ELEMENT                           
         BE    *+24                                                             
         IC    RF,PBILOTH+1        BUMP TO NEXT ELEMENT IN RECORD               
         LA    R6,0(RF,R6)                                                      
         CLI   0(R6),0             CONTINUE IF NOT END OF REC                   
         BNE   *-20                                                             
         B     RBLBLLCN            NO ELEMENT FOUND                             
*                                                                               
         CLC   PBQADC,PBILLJOB     JOB CODE MUST MATCH                          
         BNE   RBLBLLCN                                                         
*                                                                               
RBLJOBX  DS    0H                                                               
*                                                                               
*        READ IN AOR RECORD IF AOR BILL                                         
*                                                                               
         OC    AORECORD,AORECORD   SKIP IF NO AOR RECORD AREA AVAILABLE         
         BZ    RBLAORX                                             L14          
*                                                                               
         TM    PBILCMSW,X'20'      IF NOT AN AOR BILL                           
         BO    RBLAOR10               CLEAR AOR RECORD AREA        L14          
*                                                                               
         L     RF,PBPBLSLN              LENGTH OF BUFFER           L14          
         L     RE,AORECORD              ADDRESS OF AOR             L14          
         XCEF  (RE),(RF)                CLEAR AREA                 L14          
         B     RBLAORX                SKIP AOR RECORD SEARCH       L14          
*                                                                               
RBLAOR10 DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY                        L14          
*                                                                               
         MVC   AORKAGY-AORKEY+IOKEY,PBILKAGY SET AGENCY                         
         MVC   AORKMED-AORKEY+IOKEY,PBILKMED SET MEDIA                          
         MVI   AORKRCD-AORKEY+IOKEY,AORKIDQ SET RECORD ID                       
         MVC   AORKCLT-AORKEY+IOKEY,PBILKCLT SET CLIENT                         
         MVC   AORKPRD-AORKEY+IOKEY,PBILKPRD SET PRODUCT                        
         MVC   AORKEST-AORKEY+IOKEY,PBILKEST SET ESTIMATE                       
*                                                                               
         L     RE,AORECORD                                         L14          
*                                                                               
         CLC   AORKEY-AORKEY+IOKEY,0(RE) IF RECORD ALREADY PRESENT              
         BNE   *+14                                                             
         MVC   IOKEY,WORK                   RESTORE CURRENT KEY                 
         B     RBLAORX                                                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ POINTER                                 
*                                                                               
         CLC   AORKEY-AORKEY+IOKEY,IOKEYSAV NEED EXACT MATCH                    
         BE    RBLAOR50                                            L14          
*                                                                  L14          
*  MAY BE DEFAULT                                                  L14          
*                                                                  L14          
         CLC   IOKEY(AORKEST-AORKEY),IOKEYSAV  SAME AG/CLI/PRD                  
         BNE   RBLAORNF            NOT FOUND                       L14          
*                                                                  L14          
         MVC   AORKEST-AORKEY+IOKEY,=X'FFFF' SET FOR DEFAULT   L14              
*                                                                  L14          
         L     RE,AORECORD                                                      
         CLC   AORKEY-AORKEY+IOKEY,0(RE) DONE IF ALREADY READ IN                
         BE    RBLAORNX                                            L14          
*                                                                  L14          
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIRECTORY                  L14          
*                                                                  L14          
         CLC   AORKEY-AORKEY+IOKEY,IOKEYSAV MUST FIND EXACTLY                   
         BE    RBLAOR50                                            L14          
*                                                                  L14          
*  NO AOR EXISTS FOR THIS AOR BILL // CLEAR SAVED AOR              L14          
*                                                                  L14          
RBLAORNF DS    0H                                                               
*                                                                  L14          
         L     RF,PBPBLSLN         LENGTH OF BUFFER                L14          
         L     RE,AORECORD         ADDRESS OF AOR                  L14          
         XCEF  (RE),(RF)           CLEAR AREA                      L14          
         B     RBLAORNX                                            L14          
*                                                                  L14          
*----------->READ AOR RECORD                                       L14          
*                                                                  L14          
RBLAOR50 DS    0H                                                               
*                                                                  L14          
         MVC   IOADDR,AORECORD     SET I/O AREA ADDRESS            L14          
*                                                                  L14          
         GOTO1 AIO,IOPRTFIL+IOGET  READ RECORD                     L14          
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                  L14          
*----------->RESET POINTERS                                        L14          
*                                                                  L14          
RBLAORNX DS    0H                                                               
*                                                                  L14          
         MVC   IOKEY,WORK          RESTORE LAST USED KEY           L14          
*                                                                  L14          
         GOTO1 AIO,IOPRTDIR+IOHI   RE-POINT DIRECTORY KEY          L14          
*                                                                               
RBLAORX  DS    0H                                                               
*                                                                               
         MVC   PBBHDELA,AIO2       SET BILL RECORD ADDRESS                      
*                                                                               
         TM    PBBYOPTS,PBBYBHTQ   SKIP UNLESS DOING BILL HEADER TABLE          
         BNO   RBLBHTX                                                          
*                                                                               
*        ADD BILL RECORD TO TSAROFF BUFFER                                      
*                                                                               
         LA    R6,CSHIERC          POINT TO CASHIER CONTROL BLOCK               
         USING CSHIERD,R6          ESTABLISH AREA                               
*                                                                               
         MVI   CSHACT,CSHADDQ      SET ACTION                                   
         MVC   CSHMED,PBMED        SET MEDIA                                    
         MVC   CSHBLLA,IOADDR      SET BILL RECORD ADDRESS                      
*                                                                               
         GOTO1 VCASHIER,PARM,CSHIERD    ADD BILL RECORD TO BUFFER               
*                                                                               
         CLI   CSHERR,0            NO ERRORS TOLERATED                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RESTORE FILE POINTERS                        
*                                                                               
         MVC   PBBHDELA,CSHRECA    SAVE BILL RECORD ADDRESS                     
*                                  ALSO NOW HAS CASH APPLIED DATA               
*                                                                               
RBLBHTX  DS    0H                                                               
*                                                                               
         MVI   PBMODE,PBPROCBL     SET HOOK MODE                                
*                                                                               
         CLI   PBBYOPTS,0          IF USING PBBYOPTS SWITCH                     
         BZ    *+16                                                             
         TM    PBBYOPTS,PBBYBHDQ   AND IF GENERAL BILL HEADER DATA              
         BO    RBLGO                  PROCESS BILL RECORD                       
         B     RBLGOX              ELSE SKIP PROCESSING BILL RECORD             
*                                                                               
         TM    PBQREAD,PBQRDBLS    IF READING BILLS                             
         BNO   RBLGOX                                                           
*                                                                               
RBLGO    DS    0H                                                               
*                                                                               
*        READBLLS LOOP TO HANDLE BILL HEADER DATA                               
*                                                                               
         XC    PBMBTELA,PBMBTELA   INIT MEDIA TRANSFER ELEMENT ADDRESS          
         XC    PBTRNELA,PBTRNELA   INIT CASH TRANSACTION ELEMENT ADDR           
*                                                                               
         TM    PBBYOPT2,PBBYCSHQ   SKIP IF CASH DATA NOT WANTED                 
         BNO   RBLCSHX                                                          
*                                                                               
         L     R3,PBBHDELA         POINT TO BILL HEADER FROM CASHIER            
         LA    R3,256(R3)          POINT TO CASH APPLIED DATA                   
         USING MBTELD,R3           ESTABLISH AS MEDIA TRANSFER ELEMENT          
*                                                                               
RBLCSHLP DS    0H                                                               
*                                                                               
         CLI   MBTEL,0             DONE IF END OF RECORD REACHED                
         BE    RBLCSHDN                                                         
*                                                                               
         CLI   MBTEL,MBTELQ        SKIP IF NOT A MEDIA TRANSFER ELMENT          
         BNE   *+8                                                              
         ST    R3,PBMBTELA         SAVE ADDRESS                                 
*                                                                               
         USING TRNELD,R3           ESTABLISH AS TRANSACTION ELEMENT             
*                                                                               
         CLI   TRNEL,TRNELQ        SKIP IF NOT TRANSACTION ELEMENT              
         BE    *+8                                                              
         CLI   TRNEL,X'FF'         SKIP IF NOT TRANSACTION ELEMENT              
         BNE   RBLCSHCN                                                         
*                                                                               
         CLI   TRNTYPE,X'09'       SKIP IF ORIGINAL POSTING ELEMENT             
         BE    RBLCSHCN                                                         
*                                                                               
         CLI   TRNTYPE,X'06'       SKIP IF ORIGINAL POSTING ELEMENT             
         BE    RBLCSHCN                                                         
*                                                                               
         ST    R3,PBTRNELA         SAVE ADDRESS                                 
*                                                                               
RBLCSHGO DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RBLCSHGO                                                         
*                                                                               
         XC    PBTRNELA,PBTRNELA   INIT CASH TRANSACTION ELEMENT ADDR           
*                                                                               
RBLCSHCN DS    0H                                                               
*                                                                               
         USING MBTEL,R3            ESTABLISH AS MEDIA TRANSFER ELEMENT          
*                                                                               
         SR    RF,RF                                                            
         IC    RF,MBTLLN           BUMP TO NEXT ELEMENT                         
         LA    R3,MBTEL(RF)                                                     
*                                                                               
         B     RBLCSHLP                                                         
*                                                                               
RBLCSHDN DS    0H                                                               
*                                                                               
RBLCSHX  DS    0H                                                               
*                                                                               
RBLBHDGO DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RBLBHDGO            PASS BACK SAME RECORD                        
*                                                                               
RBLGOX   DS    0H                                                               
*                                                                               
         B     RBLBLLCN                                                         
*                                                                               
RBLBLLNX DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   ADVANCE ALONG DIRECTORY                      
*                                                                               
         B     RBLBLLLP                                                         
*                                                                               
RBLBLLCN DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ SEQUENTIAL ON DIRECTO0RY                
*                                                                               
         B     RBLBLLLP                                                         
*                                                                               
RBLBLLDN DS    0H                                                               
*                                                                               
READBLLX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - READ BUCKET RECORDS - READBKS'               
***********************************************************************         
*                                                                     *         
*        ROUTINE TO READ BUCKET RECORDS                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
READBKS  NMOD1 0,**+RBK**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    IOKEY,IOKEY         ESTABLISH KEYAREA AS BUCKET RECORD           
         LA    R2,IOKEY                                                         
         USING PBKRECD,R2                                                       
*                                                                               
         MVC   PBKKAGY,PBAGY       SET AGENCY                                   
         MVC   PBKKMED,PBMED       SET MEDIA                                    
         MVI   PBKKRCD,PBKKIDQ     SET RECORD ID                                
         MVC   PBKKCLT,PBCLT       SET CLIENT                                   
         MVC   PBKKPRD,PBPROD      SET PRODUCT                                  
         MVC   PBKKEST,PBQESTB     SET ESTIMATE                                 
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST DIRECTORY POINTER                 
*                                                                               
RBKRDLP  DS    0H                                                               
*                                                                               
         CLC   IOKEY(PBKKEST-PBKRECD),IOKEYSAV    SAME A/M/C/P                  
         BNE   RBKRDDN                                                          
*                                                                               
         XC    ESTDATA,ESTDATA     INIT ESTIMATE DATA                           
         LA    R8,ESTDATA          FILL IN ESTIMATE DATA AREA                   
         USING ESTBUFFD,R8         AS IF IT WAS EST BUFFER ENTRY                
*                                                                               
         MVC   EBFMED,PBKKMED      SET MEDIA                                    
         MVC   EBFCLT,PBKKCLT      SET CLIENT                                   
         MVC   EBFPRD,PBKKPRD      SET PRODUCT                                  
         MVC   EBFEST,PBKKEST      SET ESTIMATE                                 
*                                                                               
         BAS   RE,FLTREST          FILTER ON ESTIMATE                           
         BNE   RBKRDCN             FAILS FILTERING                              
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO2  READ ESTIMATE BUCKET RECORD              
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
*                                                                               
         MVC   PBEST,PBKKEST       SET ACTUAL ESTIMATE                          
*                                                                               
RBKRDGO  DS    0H                                                               
*                                                                               
         MVI   PBMODE,PBPROCBK     SET HOOK MODE                                
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RBKRDGO             PASS BACK SAME RECORD                        
*                                                                               
         LA    R2,IOKEY            RESET KEYAREA POINTER                        
*                                                                               
RBKRDCN  DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT POINTER                            
*                                                                               
         B     RBKRDLP                                                          
*                                                                               
RBKRDDN  DS    0H                                                               
*                                                                               
READBKX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C-PRWRIIO-READ CONTRACT - READCONT'                        
***********************************************************************         
*                                                                     *         
*        ROUTINE TO READ CONTRACT RECORD                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
*                                                                               
         DS    0D                                                               
READCONT NMOD1  0,**+RCN**                                                      
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF DOING ADVERTISER CLIENT REPORT         
         BNE   *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAORSE         SET TO READ AOR'S FILES                   
*                                                                               
         LA    R2,IOKEY            ESTABLISH KEYAREA AS CONTRACT KEY            
         USING PCONRECD,R2                                                      
*                                                                               
         OC    PBKEY2,PBKEY2     IF THERE WAS NO PREVIOUS                       
         BNZ   RCNPREV               CONTRACT FOUND                             
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BZ    RCNGPPBX                                                         
*                                                                               
         GOTO1 =A(PUBGRP),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RCNPREVX               ONE FOUND                                 
         B     RCNEND                 END OF PUBS                               
*                                                                               
RCNGPPBX DS    0H                                                               
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST PROCESSING                       
         BZ    RCNLISX                                                          
*                                                                               
         GOTO1 =A(PUBLIS),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RCNPREVX               ONE FOUND                                 
         B     RCNEND                 END OF PUBS                               
*                                                                               
RCNLISX  DS    0H                                                               
*                                                                               
         OC    PBQPBLSH,PBQPBLSH AND NOT FILTERING ON PUBLISHER                 
         BZ    RCNPREVX              GO BUILD NEW KEY                           
*                                                                               
         GOTO1 =A(PBLFLTR),RR=RELO   PUBLISHER FILTER REQUESTED                 
*                                    RETURNS NEXT PUB IN PBQPUB                 
*                                                                               
         BE    RCNPREVX            NEXT PUB FOUND                               
         B     RCNEND              END OF PUBS                                  
*                                                                               
RCNPREV  DS    0H                                                               
*        MAY BE PROCESSING PRODUCT CONTRACT                                     
*          RATES ARE GIVEN BY PRODUCT IN DIFFERENT ELEMENTS                     
*          NEED TO USE OLD CONTRACT RECORD BUT FIND RATE                        
*          ELEMENT FOR NEXT PRODUCT IN CONTRACT PRODUCT TABLE. TABLE            
*          BUILT WHEN CONTRACT WAS READ AND SORTED INTO ALPHABETICAL            
*          ORDER                                                                
*                                                                               
RCNPRD   DS    0H                                                               
*                                                                               
         CLI   CONTPROD,0        SKIP IF NO PREVIOUS CONTRACT PRODUCT           
         BE    RCNPRDX               EXISTS                                     
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BZ    RCNPRPBX                                                         
*                                                                               
         GOTO1 =A(PUBGRP),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RCNPREVX               ONE FOUND                                 
         B     RCNEND                 END OF PUBS                               
*                                                                               
RCNPRPBX DS    0H                                                               
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST PROCESSING                       
         BZ    RCNLISTX                                                         
*                                                                               
         GOTO1 =A(PUBLIS),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RCNPREVX               ONE FOUND                                 
         B     RCNEND                 END OF PUBS                               
*                                                                               
RCNLISTX DS    0H                                                               
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   SKIP IF NOT FILTERING ON PUBLISHER           
         BZ    RCNPRT20                                                         
*                                                                               
         GOTO1 =A(PBLFLTR),RR=RELO   PUBLISHER FILTER REQUESTED                 
*                                    RETURNS NEXT PUB IN PBQPUB                 
*                                                                               
         BE    RCNPREVX            NEXT PUB FOUND                               
         B     RCNEND              END OF PUBS                                  
*                                                                               
*        SEARCH CONTRACT PRODUCT TABLE FOR NEXT PRODUCT                         
*                                                                               
         LA    R1,CONTPTAB                                                      
*                                                                               
         CLC   0(3,R1),CONTPROD  FIND LAST PRODUCT PROCESSED                    
         BE    *+12                                                             
         LA    R1,3(R1)            BUMP TABLE POINTER                           
         B     *-14                                                             
*                                                                               
         CLI   3(R1),0             SKIP IF END OF TABLE REACHED                 
         BE    *+8                                                              
         CLI   3(R1),255                                                        
         BE    RCNPRDX                                                          
*                                                                               
         MVC   CONTPROD,3(R1)      ELSE SET TO NEXT PRODUCT                     
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF DOING ADVERTISER CLIENT REPORT         
         BNE   *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAOSE          RESTORE AGENCY FILES                      
*                                                                               
         CR    RE,RE                    SET EQ CC                               
*                                                                               
         B     READCONX                 RETURN                                  
*                                                                               
RCNPRDX  DS    0H                                                               
*                                                                               
         MVC   IOKEY,PBKEY2       RESTORE KEY OF PREVIOUS READ CONTRACT         
         XC    CONTPROD,CONTPROD  CLEAR LAST CONTRACT PROD                      
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   POINT TO PREVIOUS CONTRACT                   
*                                                                               
         CLC   PCONKEY,IOKEYSAV    MUST FIND POINTER                            
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BZ    RCNPRT19                                                         
*                                                                               
         GOTO1 =A(PUBGRP),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RCNPREVX               ONE FOUND                                 
         B     RCNEND                 END OF PUBS                               
*                                                                               
RCNPRT19 DS    0H                                                               
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST PROCESSING                       
         BZ    RCNLSTX                                                          
*                                                                               
         GOTO1 =A(PUBLIS),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RCNPREVX               ONE FOUND                                 
         B     RCNEND                 END OF PUBS                               
*                                                                               
RCNLSTX  DS    0H                                                               
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   SKIP IF NOT FILTERING ON PUBLISHER           
         BZ    RCNPRT20                                                         
*                                                                               
         GOTO1 =A(PBLFLTR),RR=RELO   PUBLISHER FILTER REQUESTED                 
*                                    RETURNS NEXT PUB IN PBQPUB                 
*                                                                               
         BE    RCNPREVX            NEXT PUB FOUND                               
         B     RCNEND              END OF PUBS                                  
*                                                                               
RCNPRT20 DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT CONTRACT ON FILE                   
*                                                                               
         B     RCNKEYX             GO CHECK KEY                                 
*                                                                               
RCNPREVX DS    0H                                                               
*                                                                               
*        BUILD CONTRACT RECORD KEY FROM SCRATCH                                 
*                                                                               
RCNKEY   DS    0H                                                               
*                                                                               
RCNKEYLP DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY         INIT KEYAREA                                 
         XC    IOKEYSAV,IOKEYSAV   INIT KEY SAVEAREA                            
*                                                                               
         MVC   PCONKAGY,PBAGY      SET AGENCY                                   
         MVC   PCONKMED,PBMED      SET MEDIA                                    
         MVI   PCONKRCD,PCONKIDQ   SET RECORD ID                                
         MVC   PCONKCLT,PBCLT      SET CLIENT                                   
*                                                                               
*        DETERMINE CLIENT                                                       
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF DOING ADVERTISER CLIENT REPORT         
         BNE   *+16                                                             
         MVC   PCONKAGY,PAORAGY       USE AOR AGENCY                            
         MVC   PCONKCLT,PAORQADV      USE ADV CLIENT                            
*                                                                               
         CLI   PBQSLAVE,C'Y'       IF REQUEST FOR MASTER CLIENT                 
         BNE   RCNCLT10                  WITH SLAVES                            
*                                                                               
         MVC   PCONKCLT,PBQCLT        USE REQUESTED CLIENT                      
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF DOING ADVERTISER CLIENT REPORT         
         BNE   *+10                                                             
         MVC   PCONKCLT,PAORQADV      USE AOR ADV CLIENT CODE                   
*                                                                               
         B     RCNCLTX                                                          
*                                                                               
RCNCLT10 DS    0H                                                               
*                                                                               
*        IF SLAVE CLIENT REQUESTED USE CONTRACT FOR ITS MASTER CLIENT           
*                                                                               
         CLI   PBCPROF+5,C'2'      SKIP IF NOT A SLAVE CLIENT                   
         BNE   RCNCLTX                                                          
*                                                                               
         MVC   PCONKCLT,PBCPROF+6  USE THIS SLAVE'S MASTER CLIENT CODE          
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF DOING ADVERTISER CLIENT REPORT         
         BNE   *+10                                                             
         MVC   PCONKCLT,PAORQADV   USE AOR ADV CLIENT CODE                      
*                                                                               
RCNCLTX  DS    0H                                                               
*                                                                               
RCNPUB   DS    0H                                                               
*                                                                               
         OC    PBQPUB,PBQPUB       SKIP IF DOING ALL PUBS                       
         BZ    RCNPUBX                                                          
*                                                                               
         MVC   PCONKPUB(6),PBQPUB  MOVE REQUESTED PUB IN KEY                    
*                                                                               
         CLI   PBQCLTSW,C'Y'       IF DOING ADVERTISER CLIENT REPORT            
         BNE   RCNPUB10                                                         
*                                                                               
         GOTO1 GTAORPUB,PARM,PBQPUB    FIND AOR PUB ID                          
*****    BH    RCNEND                    BASE PUB NOT FOUND                     
         BNE   RCNEND                    BASE PUB NOT FOUND                     
         MVC   PCONKPUB(6),PAORPUB         USE AOR PUB NUMBER                   
         BE    RCNPUB10                  EXACT PUB/ZN/EDN MATCH                 
*                                        BASE PUB ONLY MATCH                    
         CLI   PBQALLZN,C'Y'             OKAY IF DOING ALL ZONES + EDTS         
         BNE   RCNEND                                                           
*                                                                               
RCNPUB10 DS    0H                                                               
*                                                                               
RCNPUBX  DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIRECTORY REC                           
*                                                                               
RCNKEYX  DS    0H                                                               
*                                                                               
RCNRDLP  DS    0H                                                               
*                                                                               
         LA    R2,IOKEY            ESTABLISH KEYAREA AS CONTRACT KEY            
         USING PCONRECD,R2                                                      
*                                                                               
         CLC   PCONKEY(PCONKPUB-PCONKEY),IOKEYSAV MUST MATCH ON                 
         BNE   RCNRDDN             AGY/MED/ID/CLT                               
*                                                                               
         CLI   PBQCLTSW,C'Y'       IF DOING ADVERTISER CLIENT REPORT            
         BNE   RCNRD04                                                          
*                                                                               
         SR    R0,R0               INIT TO NO ERRORS                            
*                                                                               
         GOTO1 GTAGYPUB,PARM,PCONKPUB   FIND AGY PUB ID                         
         BE    *+8                 NO ERRORS                                    
         LA    R0,1                INDICATE NO LINK FOUND                       
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RE-READ DIRECTORY REC                        
*                                                                               
         LTR   R0,R0               TEST FOR NO LINK FOUND                       
         BNZ   RCNRDCN             NO LINK FOUND - SKIP                         
*                                                                               
         OC    PBQPUB,PBQPUB      SKIP IF ALL PUBS REQUESTED                    
         BZ    RCNZONFX                                                         
*                                                                               
         CLC   PBQPUB,PAOPUB#     MUST MATCH REUESTED PUB                       
         BNE   RCNRDDN                                                          
*                                                                               
         CLI   PBQALLZN,C'Y'      ACCEPT IF ALL ZONES ASKED FOR                 
         BE    RCNZONFX                                                         
*                                                                               
         CLC   PCONKZON(2),PAOZON MUST MATCH REQUESTED ZONE AND EDITION         
         BNE   RCNRDDN                                                          
*                                                                               
         B     RCNZONFX                                                         
*                                                                               
RCNRD04  DS    0H                                                               
*                                                                               
*        FILTER ON PUB IF PART OF THE REQUEST                                   
*                                                                               
         OC    PBQPUB,PBQPUB      SKIP IF ALL PUBS REQUESTED                    
         BZ    RCNZONFX                                                         
*                                                                               
         CLC   PCONKPUB,PBQPUB    ELSE MUST MATCH REQUESTED PUB                 
         BNE   RCNRDDN                                                          
*                                                                               
RCNRD07  DS    0H                                                               
*                                                                               
         CLI   PBQALLZN,C'Y'      SKIP IF ALL ZONES AND EDITON                  
         BE    RCNZONFX                REQUESTED                                
*                                                                               
         CLC   PCONKZON,PBQZON    ELSE MUST MATCH ON ZONE                       
         BNE   RCNRDDN                                                          
         CLC   PCONKEDT,PBQEDT      AND EDITION                                 
         BNE   RCNRDDN                                                          
*                                                                               
RCNZONFX DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO2  READ CONTRACT RECORD                     
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R2,AIO2             POINT TO FOUND RECORD                        
         USING PCONRECD,R2                                                      
*                                                                               
*        CONTRACT PERIOD MUST OVERLAP REQUEST PERIOD                            
*                                                                               
         CLC   PCONEDT,PBQBST     CONTRACT ENDS BEFORE REQUEST STARTS           
         BL    RCNRDCN                                                          
         CLC   PCONSDT,PBQBEND    CONTRACT STARTS AFTER REQUERST ENDS           
         BH    RCNRDCN                                                          
*                                                                               
         OC    PBQCENST(6),PBQCENST SKIP IF CONTRACT END DATE FILTERING         
         BZ    RCNCENX                                                          
*                                                                               
         OC    PBQCENEN,PBQCENEN   IF NO END DATE ENTERED                       
         BNZ   RCNCEN10                                                         
         CLC   PCONEDT,PBQCENST       MUST MATCH START DATE                     
         BNE   RCNRDCN                                                          
         B     RCNCENX             CONTRACT OKAY                                
*                                                                               
RCNCEN10 DS    0H                                                               
*                                                                               
         CLC   PCONEDT,PBQCENST   CONTRACT END DATE MUST LIE IN                 
         BL    RCNRDCN                                                          
         CLC   PCONEDT,PBQCENEN     FILTER PERIOD                               
         BH    RCNRDCN                                                          
*                                                                               
RCNCENX  DS    0H                                                               
*                                                                               
         MVC   PBKEY2,PCONKEY     SAVE KEY// WILL BE DESTROYED BY BUY           
         MVC   PBQCONDA,IOKEY+27   SAVE CONTRACT DISC ADDRESS                   
*                                                                               
*        REQUEST MAY BE FOR A SPECIFIC PRODUCT... FILTER ON PROD                
*                                                                               
         CLC   PBQPRD,=C'ALL'    SKIP IF ALL PRODUCTS REQUESTED                 
         BE    *+8                                                              
         CLI   PCONKMED,C'N'     NO PRODUCTS ALLOWED FOR NEWSPAPERS             
         BE    RCNRDPRX                                                         
*                                                                               
*        IF CONTRACT IS A PRODUCT CONTRACT THEN PRODUCT MUST EQUAL              
*           REQUESTED PRODUCT                                                   
*                                                                               
         CLI   PCONPRD,0           SKIP IF NOT A PRODUCT CONTRACT               
         BE    *+14                                                             
         CLC   PBQPRD,PCONPRD      ELSE MUST MATCH REQUESTED PRODUCT            
         BNE   RCNRDCN                                                          
*                                                                               
RCNRDPRX DS    0H                                                               
*                                                                               
         CLI   PBFLAVOR,C'O'       IF CONTONLY REPORT                           
         BNE   RCNRDCOX                                                         
*                                                                               
         CLC   PBQRGN,BLANKS       SKIP IF REGION NOT REQUESTED                 
         BH    *+10                                                             
         CLC   PBQDST,BLANKS       AND  IF DISTRICTS NOT REQUESTED              
         BNH   RCNRDCOX                                                         
*                                                                               
         GOTO1 =A(FLTDRD),PARM,RR=RELO   FILTER ON REG/DST                      
*                                                                               
         CLI   3(R1),C'N'             DO NOT INCLUDE                            
         MVI   3(R1),0                 RESET                                    
         BE    RCNRDCN                FAILS FILTER                              
*                                                                               
RCNRDCOX DS    0H                                                               
*                                                                               
         B     RCNRDFD             CONTRACT FOUND                               
*                                                                               
RCNRDCN  DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT DIRECTORY POINTER                  
         B     RCNRDLP                                                          
*                                                                               
RCNRDDN  DS    0H                                                               
*                                                                               
RCNKEYCN DS    0H                                                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BZ    RCNKEYC1                                                         
*                                                                               
         GOTO1 =A(PUBGRP),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RCNKEYLP               ONE FOUND                                 
         B     RCNKEYDN               END OF PUBS                               
*                                                                               
RCNKEYC1 DS    0H                                                               
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST PROCESSING                       
         BZ    RCNKEYC2                                                         
*                                                                               
         GOTO1 =A(PUBLIS),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RCNKEYLP               ONE FOUND                                 
         B     RCNKEYDN               END OF PUBS                               
*                                                                               
RCNKEYC2 DS    0H                                                               
*                                                                               
*  CHECK TO SEE IF PUBLISHER FILTER WAS REQUESTED.. IF SO PUBNUMBER             
*          IS GENERATED IN PBLFLTR AND IS USED TO FIND PUBS ASSOCIATED          
*           WITH THE REQUESTED PUBLISHER.                                       
*                                                                               
         OC    PBQPBLSH,PBQPBLSH     DONE IF NO PUBLISHER FILTER                
         BZ    RCNKEYDN                                                         
*                                                                               
         GOTO1 =A(PBLFLTR),RR=RELO   PUBLISHER FILTER REQUESTED                 
*                                    RETURNS NEXT PUB IN PBQPUB                 
*                                                                               
         BE    RCNKEYLP            ANOTHER PUB FOUND                            
*                                  END OF PUBS                                  
*                                                                               
RCNKEYDN DS    0H                                                               
*                                                                               
         B     RCNEND              NOTHING FOUND                                
*                                                                               
RCNRDFD  DS    0H                  CONTRACT FOUND                               
*                                                                               
*   DETERMINE IF RATES FOR PRODUCTS EXIST // IF SO BUILD TABLE                  
*       OF PRODUCTS THEN SORT THE TABLE                                         
*                                                                               
RCNPRDT  DS    0H                                                               
*                                                                               
         LA     R3,CONTPTAB        POINT TO CONTRACT PRODUCT TABLE              
         XC     0(L'PCONPRD,R3),0(R3) CLEAR FIRST ENTRY                         
         LA    R1,0                INIT ENTRY COUNTER                           
*                                                                               
         LA     R6,PCONDESC        POINT TO FIRST ELEMENT IN RECORD             
         MVI    ELCODE,X'20'       LOOKING FOR CURR LVL RATE ELM                
*                                                                               
RCNPRDTL DS    0H                                                               
*                                                                               
         BAS    RE,NXTELM           FIND 1ST/NEXT RATE ELM                      
         BNE    RCNPRDTD            NO MORE FOUND                               
*                                                                               
         CLI    PRBOPEN,C'A'     IF HIGH THEN M/B PRODUCT                       
         BL     RCNOKAY          ALL ELEMENTS HAVE PROD OR 'ALL' PROD           
*                                                                               
*   REQUEST MAY BE FOR A SPECIFIC PRODUCT... FILTER ON PROD                     
*                                                                               
         CLC   PBQPRD,=C'ALL'    SKIP IF REQUEST FOR ALL PRODUCTS               
         BE    *+14                                                             
         CLC   PBQPRD,PRBOPEN    ELSE MATCH ON REQUESTED PRODUCT                
         BNE   RCNPRDTC                                                         
*                                                                               
*        ADD PRODUCT TO TABLE ONLY IF IT IS NOT ALREADY IN IT                   
*                                                                               
RCNSRCH  DS    0H                                                               
*                                                                               
         LA    R5,CONTPTAB         POINT TO CONTRACT PRODUCT TABLE              
*                                                                               
RCNSRCHL DS    0H                                                               
*                                                                               
        CLI    0(R5),0             IF END OF TABLE REACHED                      
        BE     RCNPRDTD              GO ADD PRODUCT                             
*                                                                               
        CLI    0(R5),255                                                        
        BNE    *+6                                                              
        DC     H'0'                TABLE FULL                                   
*                                                                               
        CLC    0(3,R5),PRBOPEN     CONTINUE IF PRODUCT ALREADY IN TABLE         
        BE     RCNPRDTC                                                         
*                                                                               
RCNSRCHC DS    0H                                                               
*                                                                               
        LA     R5,3(R5)                                                         
        B      RCNSRCHL                                                         
*                                                                               
RCNSRCHD DS    0H                  NEW PRODUCT FOR TABLE                        
*                                                                               
        MVC    0(3,R3),PRBOPEN     ADD PRODUCT TO TABLE                         
*                                                                               
        LA    R3,3(R3)             BUMP TABLE POINTER                           
        LA    R1,1(R1)             BUMP ENTRY COUNTER                           
*                                                                               
RCNPRDTC DS    0H                                                               
*                                                                               
        B      RCNPRDTL                                                         
*                                                                               
RCNPRDTD DS    0H                  ALL PRODUCTS ADDED TO TABLE                  
*                                                                               
*        SORT PRODUCT TABLE                                                     
*                                                                               
RCNSORT  DS    0H                                                               
*                                                                               
        CLI    CONTPTAB,0          SKIP IF TABLE IS EMPTY                       
        BE     RCNSORTX                                                         
*                                                                               
        LR    R6,R1                COPY NUMBER OF ENTRIES IN TABLE              
*                                                                               
        GOTO1  QSORT,PARM,CONTPTAB,(R6),3,3,0,RR=RELO SORT TABLE                
*                                                                               
        MVC    CONTPROD,CONTPTAB      MOVE FIRST PRODUCT                        
*                                                                               
RCNSORTX DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF DOING ADVERTISER CLIENT REPORT         
         BNE   *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAOSE       RESTORE AGENCY FILES                         
*                                                                               
RCNOKAY  DS    0H                                                               
*                                                                               
         CR    RE,RE               SET EQ CC                                    
         B     READCONX                                                         
*                                                                               
RCNEND   DS    0H                                                               
*                                                                               
         XC    PBKEY2,PBKEY2       INIT SAVED KEY                               
         XC    PBQCONDA,PBQCONDA   NO CONTRACT DISK ADDRESS                     
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF DOING ADVERTISER CLIENT REPORT         
         BNE   *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAOSE       RESTORE AGENCY FILES                         
*                                                                               
         LTR   RE,RE               SET NEQ CC                                   
*                                                                               
READCONX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
CONTPTAB DC    200XL3'0'                                                        
         DC    X'FF'                                                            
*                                                                               
         DROP                                                                   
*                                                                               
        TITLE 'T00A4C-PRWRIIO-READ CONTRACT CURRENT RATE ELMS-CONTRATE'         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO READ CONTRACT CURRENT RATE ELEMENTS               *         
*              FOR EACH FOUND IT IS SAVED AND DRIVER CALLED TO PROCESS*         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
CONTRATE NMOD1 0,**+CRTS                                                        
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         L     R6,AIO2             POINT TO CONTRACT RECORD                     
         USING PCONRECD,R6         ESTABLISH RECORD                             
*                                                                               
         LA    R6,PCONELEM         POINT TO FIRST ELEMENT                       
         USING PRBELEM,R6          ESTABLISH AS RATE ELEMENT                    
*                                                                               
         MVI   CRTSGOSW,0          INIT GO SWITCH                               
         XC    CRTSELMA,CRTSELMA   INIT A(LAST USED RATE ELEMENT)               
         XC    CRTSCRTS,CRTSCRTS   CLEAR RATE ELEMENT SAVE AREA                 
         XC    PBQCRTA,PBQCRTA     INIT RATE ELEMENT ADDRESS                    
         SR    R0,R0               INIT LENGTH REGISTER                         
*                                                                               
CRTSLOOP DS    0H                                                               
*                                                                               
         CLI   PRBELEM,X'20'       LOOKING FOR CURRENT RATE ELEMENT             
         BNE   CRTSLPCN                                                         
*                                                                               
         GOTO1 SPCFLT,PARM,PRBDESC  FILTER ON SPACE DESCRIPTION                 
         BNE   CRTSLPCN            FAILS FILTER - DROP                          
*                                                                               
         ST    R6,PBQCRTA          PASS RATE ELEMENT ADDRESS                    
         MVC   CRTSCRTS,PRBELEM    SAVE RATE ELEMENT                            
*                                                                               
CRTSLPGO DS    0H                                                               
*                                                                               
         MVI   PBMODE,PBPROCCO         NEED TO PROCESS A CONTRACT               
         MVI   PBRTCODE,0              INIT RETURN CODE                         
*                                                                               
         MVI   CRTSGOSW,C'Y'       INDICATE WE HAVE GONE TO DRIVER ONCE         
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    CRTSLPGO            PASS BACK SAME RECORD                        
*                                                                               
         ST    R6,CRTSELMA         SAVE A(LAST USED ELEMENT)                    
*                                                                               
CRTSLPCN DS    0H                                                               
*                                                                               
         LTR   RF,R6               SAVE LAST ELEMENT POINTER                    
         BZ    CRTSLPC1            SKIP IF NO LAST ELEMENT USED                 
*                                                                               
         IC    R0,PRBELEM+1        GET ELEMENT LENGTH                           
         AR    R6,R0               BUMP TO NEXT ELEMENT                         
*                                                                               
         CLI   PRBELEM,0           DONE IF END OF RECORD                        
         BNE   CRTSLOOP                                                         
*                                                                               
CRTSLPC1 DS    0H                                                               
*                                                                               
         CLI   CRTSGOSW,0          GO TO DRIVER AT LEAST ONCE                   
         BE    CRTSLPC2                                                         
*                                                                               
         OC    PBMINLNS,PBMINLNS   GO BACK AGAIN IF MORE                        
         BZ    CRTSLPDN               LINES NEEDED FOR PRINTING                 
*                                                                               
CRTSLPC2 DS    0H                                                               
*                                                                               
         SR    R6,R6               INDICATE NO RATE ELEMENT AVAILABLE           
         XC    CRTSCRTS,CRTSCRTS   CLEAR RATE ELEMENT SAVE AREA                 
         XC    PBQCRTA,PBQCRTA     INIT RATE ELEMENT ADDRESS                    
         B     CRTSLPGO            RETURN TO DRIVER                             
*                                                                               
******   ICM   R6,15,CRTSELMA      RESTORE ELEMENT POINTER                      
******   BNZ   CRTSLOOP                                                         
*                                                                               
CRTSLPDN DS    0H                                                               
*                                                                               
CRTS20   DS    0H                                                               
*                                                                               
         XC    CRTSCRTS,CRTSCRTS   CLEAR RATE ELEMENT SAVE AREA                 
         XC    PBQCRTA,PBQCRTA     INIT RATE ELEMENT ADDRESS                    
*                                                                               
CONTRATX DS    0H                                                               
         XIT1                                                                   
*                                                                               
CRTSPACE DC    CL32' '             SPACE CONSTANT                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
         DS    0F                                                               
CRTSELMA DS    A                   A(LAST USED RATES ELEMENT)                   
CRTSCRTS DS    XL256               CONTRACT RATE ELEMENT SAVE AREA              
CRTSGOSW DS    X                   C'Y' - HAVE GONE TO DRIVER ONCE              
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - I/O ROUTINES - IOEX'                         
***********************************************************************         
* ROUTINE TO ISSUE AN I/O TO ANY STANDARD SYSTEM FILE                 *         
*                                                                     *         
* NTRY - R1=I/O CONTROL BYTES (LOW ORDER 2 BYTES) SET FROM IO EQUATES *         
*           CONTAINS - FILE NUMBER       (ZERO=USE IOFILE)            *         
*                      COMMAND NUMBER    (ZERO=USE IOCMND)            *         
*                      COMMAND QUALIFIER (READ LOCK/READ DELETES)     *         
*                      I/O AREA NUMBER   (ZERO=USE IOADDR)            *         
*                                                                     *         
* EXIT - CC=LOW IF A HARD I/O ERROR OCCURED                           *         
*        CC=EQUAL IF I/O SUCCESSFUL (NO ERRORS)                       *         
*        CC=HIGH IF A SOFT ERROR (EOF/NOT FOUND/DELETED)              *         
*        IOADDR=A(I/O AREA USED)                                      *         
*        IOERR=DATAMGR ERROR BYTE                                     *         
*        IOKEYSAV=SAVE IOKEY VALUE (BEFORE I/O IS EXECUTED)           *         
*        IODA=DISK ADDRESS EXTRACTED FOR I/S RECORD (I/S D/A PAIR)    *         
*                                                                     *         
* NOTE - FOR INDEX SEQUENTIAL I/O'S IOKEY IS ALWAYS SAVED IN IOKEYSAV *         
*        BEFORE I/O IS EXECUTED. FOR D/A FILE I/O'S IF IODA IS ZERO   *         
*        AND FILE HAS A DIRECTORY ATTACHED (I/S D/A PAIR) THE READ    *         
*        SPECIFIED TO THE FILE (HIGH/READ) IS EXECUTED TO THE         *         
*        DIRECTORY.                                                   *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
IOEX     NMOD1 IOWORKX-IOWORKD,IOEX                                             
*                                                                               
         LR    RA,RC                                                            
         USING IOWORKD,RA                                                       
*                                                                               
         USING PBLOCKD,R7                                                       
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
IOEX2    XC    IOWORKD(IOWORKX-IOWORKD),IOWORKD                                 
         ST    R1,IOCTRL           SAVE I/O CONTROL BYTES IN W/S                
         MVI   IOQ,0               ESTABLISH COMMAND QUALIFIER                  
         TM    IOCTRL+3,IOLOCK     TEST READ-FOR-UPDATE                         
         BZ    *+8                                                              
         OI    IOQ,X'80'                                                        
         TM    IOCTRL+3,IORDEL     TEST DELETED RECORDS WANTED                  
         BZ    *+8                                                              
         OI    IOQ,X'08'                                                        
         LA    R1,IO1+IO2          ESTABLISH I/O AREA ADDRESS                   
         N     R1,IOCTRL                                                        
         BZ    IOEX4                                                            
         SRL   R1,6                R1=I/O AREA NUMBER                           
         CLM   R1,1,IONUM                                                       
         BNH   *+6                                                              
         DC    H'0'                I/O AREA NUMBER INVALID                      
         SLL   R1,2                                                             
         L     R1,AIO1-4(R1)                                                    
         STCM  R1,15,IOADDR        SET ADDRESS OF I/O AREA                      
IOEX4    LA    R1,IOFILES          ESTABLISH FILE                               
         N     R1,IOCTRL                                                        
         BNZ   IOEX6                                                            
         OC    IOFILE,IOFILE                                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   IOFILNM,IOFILE      SET FILE NAME                                
         OC    IOCMND,IOCMND       FILE GIVEN - SO MUST COMMAND BE              
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   IOCMDNM,IOCMND      SET COMMAND NAME                             
         B     IOEX20                                                           
IOEX6    SRL   R1,8                R1=FILE NUMBER                               
         L     RE,AFILNTRY         POINT TO LOCAL SYSTEM FILES                  
         LA    R0,10                                                            
         CR    R1,R0                                                            
         BNH   *+8                                                              
***      =====          **                                                      
         L     RE,ASYSTAB          POINT TO GLOBAL SYSTEM FILES                 
         USING FILTABD,RE                                                       
***      =====          **                                                      
IOEX8    CLI   FILNUM,EOT          TEST E-O-T                                   
         BNE   *+6                                                              
         DC    H'0'                INVALID FILE NUMBER                          
         CLM   R1,1,FILNUM         MATCH ON FILE NUMBER                         
         BE    *+12                                                             
         LA    RE,FILTABL(RE)                                                   
         B     IOEX8                                                            
         MVC   IOFILV,FILNUM       EXTRACT FILE VALUES                          
         L     RE,ACMDTAB          RE=A(I/O COMMAND TABLE)                      
         SR    RF,RF                                                            
         LA    R1,IOCMNDS          ESTABLISH COMMAND                            
         N     R1,IOCTRL                                                        
         BNZ   IOEX10                                                           
         OC    IOCMND,IOCMND       NOT GIVEN - TEST COMMAND NAMED               
         BNZ   *+6                                                              
         DC    H'0'                                                             
         B     IOEX20                                                           
IOEX10   CLI   0(RE),EOT           TEST E-O-T                                   
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   IODUB(1),0(RE)                                                   
         NC    IODUB(1),IOFILI                                                  
         CLC   IODUB(1),IOFILI                                                  
         BNE   *+12                                                             
         LA    RE,4(RE)                                                         
         B     *+16                                                             
         ICM   RF,3,2(RE)                                                       
***      =====          **                                                      
         LA    RE,3(RF,RE)                                                      
         B     IOEX10                                                           
         USING CMDTABD,RE          RE=A(FILE/COMMAND TABLE)                     
***      =====          **                                                      
IOEX12   CLI   0(RE),EOT           TEST E-O-T                                   
         BNE   *+6                                                              
         DC    H'0'                INVALID COMMAND                              
         CLM   R1,1,CMDNUMB        MATCH ON COMMAND NUMBER                      
         BE    *+12                                                             
         LA    RE,CMDTABL(RE)                                                   
         B     IOEX12                                                           
         MVC   IOCMDV,CMDNAME      EXTRACT COMMAND VALUES                       
*                                                                               
         TM    IOCMDI,CMDIDAXC     TEST CLEAR D/A NOW                           
         BZ    *+10                                                             
         XC    IODA,IODA                                                        
         TM    IOCMDI,CMDIDADD     TEST DISK ADDRESS RETURNED                   
         BNZ   IOEX14                                                           
         TM    IOCMDI,CMDIDARQ     TEST D/A REQUIRED FOR I/O                    
         BZ    IOEX16                                                           
         OC    IODA,IODA           TEST D/A PRESENT                             
         BNZ   IOEX14                                                           
         TM    IOFILI,FILIIS       TEST THIS IS A D/A FILE                      
         BNZ   *+14                                                             
         TM    IOFILI2,FILIDI      AND THAT AN I/S FILE IS ATTACHED             
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   IODUB(4),IOCTRL                                                  
         NI    IODUB+2,X'F0'       TURN-OFF FILE INDICATORS                     
         L     R0,IODUB                                                         
         ZIC   R1,IOFILN2                                                       
         SLL   R1,8                                                             
         OR    R1,R0                                                            
         GOTO1 IOEX                                                             
         BE    IOEX14              SUCCESSFUL I/O                               
         BL    IOEXX               EXIT ON BAD I/S ERRORS                       
         TM    IOERR,IOERNF        TEST RECORD-NOT-FOUND                        
         BNZ   IOEXX                                                            
         TM    IOERR,IOEDEL        TEST RECORD IS DELETED                       
         BZ    IOEXX                                                            
         OC    IODA,IODA           TEST DISK ADDRESS SET                        
         BNZ   *+6                                                              
         DC    H'0'                SOMETHING BAD HAPPENED                       
IOEX14   ICM   R0,15,IOADDR                                                     
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATAMGR-COMFACSD(RF)    DATAMGR ADDRESS                      
         GOTO1 (RF),PARM,(IOQ,IOCMDNM),IOFILNM,IODA,(R0),IOWORK                 
         MVC   IOERR,8(R1)         SAVE ERROR RETURN BYTE                       
         B     IOEXX               EXIT TO CALLER                               
IOEX16   TM    IOFILI,FILIIS       TEST INDEX SEQUENTIAL FILE                   
         BZ    IOEX20                                                           
IOEX17   MVC   IOKEYSAV,IOKEY      SAVE CURRENT I/O KEY                         
         LA    R0,IOKEY            FL I/S READS INTO IOKEY                      
         TM    IOFILI2,FILIID      TEST I/S FILE HAS D/A ATTACHED               
         BZ    *+12                YES - MUST READ INTO IOAREA                  
         TM    IOFILI,FILIVL                                                    
         BZ    *+14                                                             
         ICM   R0,15,IOADDR        VL I/S MUST READ INTO IOAREA ALSO            
         BNZ   *+6                                                              
         DC    H'0'                                                             
IOEX18   L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATAMGR-COMFACSD(RF)    DATAMGR ADDRESS                      
         GOTO1 (RF),PARM,(IOQ,IOCMDNM),IOFILNM,IOKEY,(R0)                       
         MVC   IOERR,8(R1)         SAVE ERROR RETURN BYTE                       
         TM    IOERR,IOERRS        TEST ANY ERRORS FOUND                        
         BZ    *+12                                                             
         TM    IOERR,IOEDEL        TEST DELETED RECORD FOUND                    
         BZ    IOEXX               NO - EXIT WITH ERROR                         
         TM    IOFILI2,FILIID      TEST D/A FILE ATTCHED TO THIS FILE           
         BZ    IOEXX               NO - EXIT                                    
         CLC   =C'PRTDIR',IOFILNM  PASS ONLY IF BUY FILE DIRECTORY              
         BNE   IOEX19A                                                          
*                                                                               
         DROP  R7                                                               
*                                                                               
         L     RF,=A(SAVER7)                                                    
         L     RF,0(RF)                                                         
*                                                                               
         USING PBLOCKD,RF                                                       
*                                                                               
         MVC   IOKEYSVE,IOKEY                                                   
*                                                                               
         DROP  RF                                                               
*                                                                               
         USING PBLOCKD,R7                                                       
*                                                                               
IOEX19A  ZIC   R1,IOFILKL          YES - EXTRACT DISK ADDRESS                   
         ZIC   R0,IOFILCL                                                       
         AR    R1,R0                                                            
         LA    R1,IOKEY(R1)                                                     
         MVC   IODA,0(R1)                                                       
         B     IOEXX                                                            
IOEX20   ICM   R0,15,IOADDR                                                     
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATAMGR-COMFACSD(RF)    DATAMGR ADDRESS                      
         GOTO1 (RF),PARM,(IOQ,IOCMDNM),IOFILNM,(R0),(R0)                        
         MVC   IOERR,8(R1)                                                      
         B     IOEXX                                                            
*                                                                               
IOEXX    L     RE,=A(SAVER7)         GET POINTER TO PRNTBLOCK                   
         L     RE,0(RE)                                                         
         CLI   PBQTRACE-PBLOCKD(RE),C'Y'                                        
         BNE   *+8                                                              
         BAS   RE,IOTRACE                                                       
         MVI   IOQ,1                                                            
         TM    IOERR,IOERRS                                                     
         BZ    IOEXXX                                                           
         MVI   IOQ,2                                                            
         TM    IOERR,IOEEOF+IOERNF+IOEDEL                                       
         BNZ   IOEXXX                                                           
         MVI   IOQ,0                                                            
IOEXXX   CLI   IOQ,1               SET CONDITION CODE FOR CALLER                
         B     EXITIO                                                           
         SPACE 2                                                                
IOTRACE  NTR1                      ** IO TRACE ROUTINE **                       
         CLC   IOKEYSAV+3(5),=X'D506D7C2C6'                                     
*        BNE   ITX                                                              
***      MVI   *-3,X'00'            PRINT FROM THIS POINT ON                    
***      CP    TRCOUNT,=P'20000'                                                
***      BH    *-2                                                              
         AP    TRCOUNT,=P'1'                                                    
*********CLC   IOFILNM,=C'PRTDIR '                                              
*******  BE    *+14                                                             
*******  CLC   IOFILNM,=C'PRTFIL '                                              
*******  BNE   ITX                                                              
         CLI   IOCMDNO,IOHI                                                     
         BNE   IT2                                                              
         LA    RE,IOKEYSAV                                                      
         ST    RE,IOTR1                                                         
         MVI   IOTR1,25                                                         
         LA    RE,IOKEY                                                         
         ST    RE,IOTR2                                                         
         MVI   IOTR2,31                                                         
         B     IT8                                                              
IT2      CLI   IOCMDNO,IOSQ                                                     
         BNE   IT4                                                              
         LA    RE,IOKEYSAV                                                      
         ST    RE,IOTR1                                                         
         MVI   IOTR1,25                                                         
         LA    RE,IOKEY                                                         
         ST    RE,IOTR2                                                         
         MVI   IOTR2,31                                                         
         B     IT8                                                              
IT4      CLI   IOCMDNO,IOGET                                                    
         BNE   IT6                                                              
         LA    RE,IOKEY+27                                                      
         ST    RE,IOTR1                                                         
         MVI   IOTR1,4                                                          
         L     RE,IOADDR                                                        
         ST    RE,IOTR2                                                         
         MVI   IOTR2,25                                                         
         B     IT8                                                              
IT6      CLI   IOCMDNO,IOGET                                                    
         BNE   ITX                                                              
         LA    RE,IOKEY                                                         
         ST    RE,IOTR1                                                         
         MVI   IOTR1,25                                                         
         L     RE,IOADDR                                                        
         ST    RE,IOTR2                                                         
         MVI   IOTR2,25                                                         
IT8      OC    IOPRINT,IOPRINT                                                  
         BZ    ITX                                                              
         MVC   P,BLANKS                                                         
         MVC   P(6),IOCMDNM                                                     
         MVC   P+8(6),IOFILNM                                                   
         LA    R3,P+16                                                          
         ZIC   R0,IOTR1                                                         
         L     RE,IOTR1                                                         
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CHEXOUT-COMFACSD(RF)    HEXOUT ADDRESS                        
         GOTO1 (RF),PARM,(RE),(R3),(R0),=C'TOG'                                 
         A     R3,PARM+16                                                       
         LA    R3,2(R3)                                                         
         ZIC   R0,IOTR2                                                         
         L     RE,IOTR2                                                         
         GOTO1 (RF),PARM,(RE),(R3),(R0),=C'TOG'                                 
*                                                                               
         L     RE,4(RD)     POINT TO CALLER                                     
         L     RE,4(RE)     POINT TO HIS CALLER                                 
         L     RF,4(RE)                                                         
         MVC   CSECTN,0(RF) SAVE CSECT NAME                                     
         L     RF,12(RE)    REG 14                                              
         LA    RF,0(RF)     STRIP FIRST BYTE                                    
         L     RE,64(RE)    BASE                                                
         LA    RE,0(RE)                                                         
         SR    RF,RE                                                            
         ST    RF,IOTR2                                                         
         A     R3,PARM+16                                                       
         LA    R3,2(R3)                                                         
         LA    R0,3                                                             
         LA    RE,IOTR2+1                                                       
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CHEXOUT-COMFACSD(RF)    HEXOUT ADDRESS                        
         GOTO1 (RF),PARM,(RE),(R3),(R0),=C'TOG'                                 
         A     R3,PARM+16                                                       
         LA    R3,1(R3)                                                         
         MVC   0(13,R3),=C'DISP IN CSECT'                                       
         MVC   14(4,R3),CSECTN                                                  
*                                                                               
         GOTO1 IOPRINT,PARM,PASA,=C'BL01'                                       
         SH    R3,=H'7'                                                         
         XC    0(25,R3),0(R3)                                                   
*                                                                               
ITX      XIT1                                                                   
**************                                                                  
**************                                                                  
EXITIO   XMOD1 1                                                                
         DS    CL256               FOR NEW PROCESSOR                            
CSECTN   DS    CL4                                                              
TRCOUNT  DC    PL3'0'                                                           
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO -  TRACE DMGR CALLS TO ACC -ACCTRACE'         
***********************************************************************         
*                                                                     *         
*        TRACE DMGR CALLS TO ACCPAK                                   *         
*                                                                     *         
*NTRY          DMCB FOR DATAMGR CALL                                  *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
ACCTRACE NMOD1 0,**+ACC                                                         
*                                                                               
         LR    R2,R1               SAVE PARAMETER LIST POINTER                  
*                                                                               
         L     R7,ACTR7SV          RESTORE R7                                   
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    P,P                                                              
*                                                                               
         L     R3,0(R2)            POINT TO DMGR COMMAND                        
         MVC   P(6),0(R3)          PRINT COMMAND                                
*                                                                               
         L     R3,4(R2)            POINT TO DMGR FILE                           
         MVC   P+7(6),0(R3)        PRINT FILE                                   
*                                                                               
         L     R3,4(RD)            POINT TO CALLER                              
         L     R3,4(R3)            POINT TO HIS CALLER                          
         MVC   P+15(4),0(R3)       PRINT CSECT NAME                             
*                                                                               
         L     R3,8(R2)            POINT TO FIRST KEY                           
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CHEXOUT-COMFACSD(RF)    HEXOUT ADDRESS                        
         GOTO1 (RF),ACTPARM,(R3),P+20,54,=C'TOG'                                
*                                                                               
         GOTO1 PBPRINT,ACTPARM,PASA,=C'BL01'                                    
*                                                                               
         XC    P,P                                                              
*                                                                               
         L     RE,4(RD)     POINT TO CALLER                                     
         L     RE,4(RE)     POINT TO HIS CALLER                                 
         L     RF,12(RE)    REG 14                                              
         LA    RF,0(RF)     STRIP FIRST BYTE                                    
         L     RE,64(RE)    BASE                                                
         LA    RE,0(RE)                                                         
         SR    RF,RE                                                            
         ST    RF,ACTDISP                                                       
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CHEXOUT-COMFACSD(RF)    HEXOUT ADDRESS                        
         GOTO1 (RF),ACTPARM,ACTDISP,P+10,8,=C'TOG'                              
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATAMGR-COMFACSD(RF)    DATAMGR ADDRESS                      
*                                                                               
         GOTO1 (RF),(R2)           PERFORM DATAMANAGER REQUEST                  
*                                                                               
         L     R3,12(R2)           POINT TO SECOND KEY                          
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CHEXOUT-COMFACSD(RF)    HEXOUT ADDRESS                        
         GOTO1 (RF),ACTPARM,(R3),P+20,54,=C'TOG'                                
*                                                                               
         GOTO1 PBPRINT,ACTPARM,PASA,=C'BL01'                                    
*                                                                               
ACTX     XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
ACTR7SV  DS    F                   R7 SAVEAREA                                  
ACTDISP  DS    F                   DISPPLACEMENT IN DSECT                       
ACTPARM  DS    XL24          LOCAL PARAMETER BLOCK                              
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO -  FILTER ON DATES - FLTDTE'                  
***********************************************************************         
*                                                                     *         
*        FILTER BUYS ON VARIOUS DATES                                 *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT    CC     EQ      ACCEPT BUY                                    *         
*              NEQ      REJECT BUY                                    *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
FLTDTE   NMOD1  0,**+FDTE          ** FILTER ON DATES  **                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    PBGRS(20),PBGRS     CLEAR ORDERED DATA                           
*                                                                               
         L     R2,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R2                                                      
*                                                                               
         L     R4,=A(DTEFLT)       ADDRESS OF DATE FILTER TABLE                 
*                                                                               
FDTFLTLP DS    0H                                                               
*                                                                               
         CLI   0(R4),255           PROBLEM IF END OF TABLE REACHED              
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   0(1,R4),PBQDATYP    MATCH DATE TYPE                              
         BE    FDTFLTDN                                                         
*                                                                               
FDTFLTCN DS    0H                                                               
*                                                                               
         LA    R4,3(R4)            TO NEXT ELEMENT                              
         B     FDTFLTLP                                                         
*                                                                               
FDTFLTDN DS    0H                                                               
*                                                                               
         CLI   1(R4),0             IF DATE CHECK DONE IN KEY ANALYSIS           
         BNE   *+12                                                             
         MVI   GETIN,0               NO SPECIAL PROCESSING IN GETINS            
         B     FDTGETIN                                                         
*                                                                               
         CLI   1(R4),255           IF GETINS WILL CHECK DATES                   
         BNE   FDTGETIN                                                         
*                                                                               
         MVC   GETIN,2(R4)            SET DATE TYPE TO FILTER ON                
*                                                                               
FDTGETIN DS    0H                                                               
*                                                                               
         GOTO1 =A(DOGETINS),RR=RELO  GET FINANCIAL DAT                          
*                                                                               
FDTDEL   DS    0H                                                               
*                                                                               
         TM    PBUYCNTL,X'80'      SKIP IF BUY NOT DELETED                      
         BNO   FDTDELX                                                          
*                                                                               
*****    XC    GVALUES(GVALUESL),GVALUES NO TAX ON DELETED                      
         XC    GSTTAX,GSTTAX       NO ORDERED TAX ON DELETED                    
*                                                                               
         LA    RF,PSTAREA          CLEAR ORDERED PST DATA                       
         LA    R0,10               10 PROVINCES                                 
*                                                                               
         XC    PSTTAX-PSTAREA(L'PSTTAX,RF),PSTTAX-PSTAREA(RF)                   
*******  XC    0(PSTAREAL,RF),0(RF)                                             
         LA    RF,PSTAREAL(RF)                                                  
         BCT   R0,*-10                                                          
*                                                                               
         CLI   PBQTEST,C'D'        IF PROCESS ONLY DELETES                      
         BNE   FDTDEL10                                                         
*                                                                               
         CLI   PBQDELST,0             ACCEPT IF NOT FILTERING ON                
         BE    FDTDELX                  DAY OF DELETION            L10          
*                                                                               
         CLC   PBDDATE,PBQDELST    REJECT IF DATE OF CHANGE(DELETE)             
         BL    FDTDROP                OUTSIDE OF DELETE PERIOD                  
*                                                                               
         CLI   PBQDELND,0              ACCEPT IF NO END DELETE DATEL10          
         BE    FDTDELX                                                          
*                                                                               
         CLC   PBDDATE,PBQDELND    CHANGE DATE TO END              L10          
         BH    FDTDROP               REJECT                        L10          
*                                                                               
         B     FDTDELX                                             L09          
*                                                                               
FDTDEL10 DS    0H                                                               
*                                                                               
         TM    PBQPOPT,PBQPODEL    IF INCLUDING ALL DELETED BUYS                
         BNO   FDTDEL20                                                         
*                                                                               
         CLI   PBQDELST,0             ACCEPT IF NOT FILTERING ON                
         BE    FDTDEL11                 DAY OF DELETION            L10          
*                                                                               
         CLC   PBDDATE,PBQDELST    REJECT IF DATE OF CHANGE(DELETE)             
         BL    FDTDROP                OUTSIDE OF DELETE PERIOD                  
*                                                                               
         CLI   PBQDELND,0              ACCEPT IF NO END DELETE DATEL10          
         BE    FDTDEL11                                                         
*                                                                               
         CLC   PBDDATE,PBQDELND    CHANGE DATE TO END              L10          
         BH    FDTDROP               REJECT                        L10          
*                                                                               
FDTDEL11 DS    0H                                                               
*                                                                               
         CLI   0(R4),C'O'             FILTER INSERTION ORDER DATES              
         BE    FDTDTE                                                           
         B     FDTDELX                OTHERWISE ACCEPT BUY                      
*                                                                               
FDTDEL20 DS    0H                                                               
*                                                                               
*        KEEP DELETED BUY IF REQUEST ASKS FOR DELETED BUYS FOR                  
*          PAYABLE, BILLABLE, PAID OR BILLED DATA                               
*                                                                               
         TM    PBQSPLOP,PBQIDELA+PBQIDELB+PBQIDELC+PBQIDELD                     
         BZ    FDTDROP                                                          
*                                                                               
*  THIS CODE UP TO LABEL 'FDTDELX' CHECKS TO SEE IF THIS DELETED BUY  *         
*  HAS HAD ANY REQUESTED COLUMN DATA FOR BILLED, PAID, PAYABLE OR     *         
*  BILLABLE DOLLARS OR PAID/BILLED ELEMENTS.. IF ANY ARE PRESENT      *         
*  CONTINUE PROCESSING THIS RECORD..                                  *         
*                                                                               
FDTDLBL  DS    0H                  BILLED DATA                                  
*                                                                               
         TM    PBQSPLOP,PBQIDELD     IF BILLED   REQUESTED                      
         BNO   FDTDLBLX                                                         
*                                                                               
         OC    PBBGROSS(12),PBBGROSS    ACCEPT IF ANYTHING BILLED               
         BNZ   FDTDELX                                                          
*                                                                               
         BAS   RE,BILDC                 ACCEPT IF SOMETHING BILLED BUT          
         BNE   FDTDELX                  BILLED ELEMENTS NET TO ZERO             
*                                                                               
FDTDLBLX DS    0H                                                               
*                                                                               
FDTDLPD  DS    0H                  PAID DATA                                    
*                                                                               
         TM    PBQSPLOP,PBQIDELC     IF PAID  REQUESTED                         
         BNO   FDTDLPDX                                                         
*                                                                               
         OC    PBPGROSS(12),PBPGROSS    ACCEPT IF ANY PAID DATA                 
         BNZ   FDTDELX                                                          
*                                                                               
         BAS   RE,PAYDC                 OR THERE IS PAID DATA AND               
         BNE   FDTDELX                     PAID ELEMENTS NET TO ZERO            
*                                                                               
FDTDLPDX DS    0H                                                               
*                                                                               
FDTDLPB  DS    0H                  PAYABLE DATA                                 
*                                                                               
         TM    PBQSPLOP,PBQIDELA     IF PAYABLE DATA REQUESTED                  
         BNO   FDTDLPBX                                                         
*                                                                               
         OC    PBPGROSS(12),PBPGROSS    ACCEPT IF ANY PAYABLE DATA              
         BNZ   FDTDELX                                                          
*                                                                               
         TM    PBQMATS2,PBQNVPYQ   SKIP IF NOT NVPAYABLE                        
         BNO   FDTDLPBX                                                         
*                                                                               
         BRAS  RE,PBLNV                 ACCEPT IF NVPAYABLE AND                 
         BNE   FDTDELX                     MARKED DISCREPANT                    
*                                                                               
FDTDLPBX DS    0H                                                               
*                                                                               
FDTDLBB  DS    0H                  BILLABLE DATA                                
*                                                                               
         TM    PBQSPLOP,PBQIDELB     IF BILLABLE DATA REQUESTED                 
         BNO   FDTDLBBX                                                         
*                                                                               
         OC    PBBGROSS(12),PBBGROSS    ACCEPT IF ANY BILLABLE DATA             
         BNZ   FDTDELX                                                          
*                                                                               
FDTDLBBX DS    0H                                                               
*                                                                               
*        NONE OF THE ABOVE REQUESTED DATA PRESENT                               
*                                                                               
         CLI   PBQFLTDA,0          REJECT IF NO SECONDARY FILTERING             
         BE    FDTDROP                                                          
*                                                                               
FDTDELX  DS    0H                                                               
*                                                                               
*        FILTER DATA PASSED REQUEST DATE TYPE                                   
*                                                                               
FDTFLT   DS    0H                                                               
*                                                                               
FDTFLPD  DS    0H                                                               
*                                                                               
         CLI   0(R4),C'A'          IF PAID DATE REQUEST FILTER                  
         BNE   FDTFLPDX                                                         
*                                                                               
         OC    PBPGROSS(16),PBPGROSS ACCEPT IF PAID DATA EXISTS                 
         BNZ   FDTFLTX                                                          
*                                                                               
         BAS   RE,PAYDC               OR PAID ELEMENTS THAT                     
*                                                                               
         BNE   FDTFLTX                   NET TO ZERO                            
         B     FDTDROP               ELSE REJECT                                
*                                                                               
FDTFLPDX DS    0H                                                               
*                                                                               
FDTFLPB  DS    0H                  PAID OR BILLED                               
*                                                                               
         CLI   0(R4),C'T'   IF PAID AND BILLED DATE REQUEST FILTER              
         BNE   FDTFLPBX                                                         
*                                                                               
         OC    PBPGROSS(16),PBPGROSS ACCEPT IF PAID DOLLARS PASSED              
         BNZ   FDTFLTX                                                          
         OC    PBBGROSS(16),PBBGROSS ACCEPT IF BILLED DOLLARS PASSED            
         BNZ   FDTFLTX                                                          
*                                                                               
         BAS   RE,PAYDC            ACCEPT IF PAID ELEMENTS NET TO ZERO          
         BNE   FDTFLTX             Y- PAID ELEMENTS NET TO ZERO                 
         BAS   RE,BILDC            ACCEPT  IF BILL ELEMENTS NET TO ZERO         
         BNE   FDTFLTX             Y- BILL ELEMENTS NET TO ZERO                 
*                                                                               
         B     FDTDROP             ELSE REJECT                                  
*                                                                               
FDTFLPBX DS    0H                                                               
*                                                                               
FDTFLBP  DS    0H                  PAID AND BILLED                              
*                                                                               
         CLI   0(R4),C'Z'   IF MUST BE BOTH BILLED AND PAID                     
         BNE   FDTFLBPX                                                         
*                                                                               
         OC    PBPGROSS(16),PBPGROSS PAID DOLLARS MUST EXIST                    
         BNZ   FDTFLBP1                                                         
*                                                                               
         BAS   RE,PAYDC         OR PAID ELEMENTS NET TO ZERO                    
         BNE   FDTFLBP1                                                         
         B     FDTDROP             ELSE REJECT                                  
*                                                                               
FDTFLBP1 DS    0H                                                               
*                                                                               
         OC    PBBGROSS(16),PBBGROSS AND BILLED DOLLARS MUST EXIST              
         BNZ   FDTFLTX                                                          
*                                                                               
         BAS   RE,BILDC               OR BILL ELEMENTS NET TO ZERO              
         BNE   FDTFLTX             Y- BILL ELEMENTS NET TO ZERO                 
         B     FDTDROP             ELSE REJECT                                  
*                                                                               
FDTFLBPX DS    0H                                                               
*                                                                               
FDTFLBL  DS    0H                  BILLED DATA                                  
*                                                                               
         CLI   0(R4),C'L'         IF BILLED  DATE REQUEST FILTER                
         BNE   FDTFLBLX                                                         
*                                                                               
         OC    PBBGROSS(16),PBBGROSS ACCEPT IF BILLED DOLLARS PASSED            
         BNZ   FDTFLTX                                                          
*                                                                               
         BAS   RE,BILDC               OR BILLED ELEMENTS NET TO ZERO            
         BNE   FDTFLTX                  Y- BILL ELEMENTS NET TO ZERO            
*                                                                               
         B     FDTDROP             ELSE REJECT                                  
*                                                                               
FDTFLBLX DS    0H                                                               
*                                                                               
*            ==== DATE TEST ====                                                
*                                                                               
FDTDTE   DS    0H                  FILTER ON DATES                              
*                                                                               
         CLI   1(R4),0          SKIP IF DATES TESTED BY CALLER                  
         BE    FDTFLTX                                                          
*                                                                               
         LA    R6,PBUYREC+33       POINT TO FIRST ELEMENT IN BUY RECORD         
         MVC   ELCODE,1(R4)        SET TO FIND BUY DESC ELEMENT                 
*                                                                               
         CLI   ELCODE,X'20'        SKIP IF NOT FIRST ELM IN RECORD              
         BE    FDTDTELP                                                         
*                                                                               
         BAS   RE,NXTELM           FIND NEXT BUY DESCRIPTION ELEMENT            
         BNE   FDTDROP                 REJECT IF NOT FOUND                      
*                                                                               
FDTDTELP DS    0H                                                               
*                                                                               
         ZIC   RE,2(R4)            GET DISPLACEMENT OF DATE IN ELM              
         AR    RE,R6               POINT TO DATE IN ELEMENT                     
*                                                                               
         CLC   PBQBST,0(RE)       DATE MUST LIE IN REQUEST PERIOD               
         BH    FDTDTECN                                                         
         CLC   PBQBEND,0(RE)      END DATE                                      
         BL    FDTDTECN                                                         
*                                                                               
         B     FDTDTEDN                                                         
*                                                                               
FDTDTECN DS    0H                                                               
*                                                                               
         BAS   RE,NXTELM          FIND NEXT ELEMENT                             
         BE    FDTDTELP           ELEMENT FOUND                                 
*                                                                               
         B     FDTDROP             ELSE REJECT                                  
*                                                                               
FDTDTEDN DS    0H                                                               
*                                                                               
FDTFLTX  DS    0H                                                               
*                                                                               
         CLI   PBQFLTDA,0          SKIP IF SECONDARY FILTERING                  
         BNE   FDT2ND                TO BE DONE                                 
*                                                                               
         OC    PBGRS(16),PBGRS   ACCEPT IF FINANCIAL DATA EXISTS                
         BNZ   FDTINC                                                           
*                                                                               
         TM    PBUYCNTL,X'80'    DELETED BUYS OK AT THIS POINT                  
         BO    FDTINC                                                           
*                                                                               
*                                  IF BILLED, PAID, BILLABLE OR PAYABLE         
         TM    PBQSPLOP,PBQIDELA+PBQIDELB+PBQIDELC+PBQIDELD                     
         BZ    FDT30                                                            
*                                                                               
         BAS   RE,BILDC            ACCEPT IF BILLED NETS TO 0                   
         BNE   FDTINC                                                           
         BAS   RE,PAYDC            ACCEPT IF PAID NETS TO 0                     
         BNE   FDTINC                                                           
*                                                                               
FDT30    DS    0H                                                               
*                                                                               
         CLI   PBQZERO,C'N'        ELSE REJECT ZERO BUYS IF ASKED               
         BE    FDTDROP                                                          
*                                                                               
         B     FDTINC              ELSE ACCEPT                                  
*                                                                               
*        HANDLE SECONDARY FILTERING                                             
*                                                                               
FDT2ND   DS    0H                                                               
*                                                                               
         CLI   PBQFLTDA,C'B'       IF ONLY BILLED DATA                          
         BNE   FDT2ND10                                                         
*                                                                               
         OC    PBBGROSS(16),PBBGROSS   ACCEPT IF ANY BILLING DATA               
         BNZ   FDTINC                                                           
*                                                                               
         BAS   RE,BILDC               OR BILL ELEMENTS NET TO ZERO              
         BNE   FDTINC              Y- BILL ELEMENTS NET TO ZERO                 
*                                                                               
         B     FDTDROP        ELSE REJECT                                       
*                                                                               
FDT2ND10 DS    0H                                                               
*                                                                               
         CLI   PBQFLTDA,C'P'       IF ONLY PAID DATA                            
         BNE   FDT2ND20                                                         
*                                                                               
         OC    PBPGROSS(16),PBPGROSS   ACCEPT IF ANY PAID DATA                  
         BNZ   FDTINC                                                           
         BAS   RE,PAYDC               OR PAID ELEMENTS NET TO ZERO              
         BNE   FDTINC              Y- PAID ELEMENTS NET TO ZERO                 
*                                                                               
         B     FDTDROP        ELSE REJECT                                       
*                                                                               
FDT2ND20 DS    0H                                                               
*                                                                               
         CLI   PBQFLTDA,C'A'       IF ONLY PAYABLE DATA WANTED                  
         BNE   FDT2ND30                                                         
*                                                                               
         TM    PBUYCNTL,X'80'         IF DELETED                                
         BZ    FDT2ND25                                                         
*                                                                               
         OC    PBPGROSS(16),PBPGROSS    PAID MUST BE NON-ZERO                   
         BNZ   FDTINC                                                           
*                                                                               
         B     FDTDROP             ELSE REJECT                                  
*                                                                               
FDT2ND25 DS    0H                                                               
*                                                                               
         CLC   PBPGROSS(16),PBGRS      IF LIVE PAID MUST NOT EQUAL              
         BE    FDT2ND26                   TOTAL VALUE                           
*                                                                               
         CLI   PBDCOSIN,C'C'           IF CRATE BUY 5CT LEE WAY ON AC           
         BNE   FDTINC                                                           
*                                                                               
         CLC   PBPGROSS,PBGRS             JUST COMPARE GROSS                    
         BNE   FDTINC                                                           
*                                                                               
******                                                                          
******   L     RF,PBPAGCOM         PAID AC                                      
******   L     RE,PBGYCOM          ORDERED AGENCY COM                           
******                                                                          
******   SR    RF,RE               DIFFERENCE                                   
******   LPR   RF,RF                                                            
******                                                                          
******   CHI   RF,5                INCLUDE IF MORE THAN 5 CTS                   
******   BH    FDTINC                                                           
*                                                                               
FDT2ND26 DS    0H                                                               
*                                                                               
         BRAS  RE,PBLDC                 CHECK FOR UNPAID PAY ELEMENTS           
         BE    FDTINC                   SOME FOUND - ACCEPT                     
*                                                                               
         TM    PBQMATS2,PBQNVPYQ   SKIP IF NOT NVPAYABLE                        
         BNO   FDT2ND27                                                         
*                                                                               
         BRAS  RE,PBLNV                 CHECK FOR DISCREPANT INV STATUS         
         BNE   FDTINC                   DISCREPANT STATUS                       
*                                                                               
FDT2ND27 DS    0H                                                               
*                                                                               
         B     FDTDROP             ELSE REJECT                                  
*                                                                               
FDT2ND30 DS    0H                                                               
*                                                                               
         CLI   PBQFLTDA,C'I'       IF ONLY BILLABLE DATA WANTED                 
         BNE   FDT2ND40                                                         
*                                                                               
         TM    PBUYCNTL,X'80'         IF DELETED                                
         BZ    FDT2ND35                                                         
*                                                                               
         OC    PBBGROSS(16),PBBGROSS     BILLED SHOULD NET NOT TO ZERO          
         BNZ   FDTINC                                                           
*                                                                               
         B     FDTDROP             ELSE REJECT                                  
*                                                                               
FDT2ND35 DS    0H                                                               
*                                                                               
         CLC   PBGRS(16),PBBGROSS      IF LIVE ACCEPT ONLY THOSE                
         BNE   FDTINC              WHICH HAVE BILLED NEQ GROSS                  
         OC    PBBGROSS(16),PBBGROSS  ZERO BILLABLE?                            
         BNZ   FDTDROP                NO - REJECT                               
         BAS   RE,BILDC               ACCEPT IF SOMETHING BILLED BUT            
         BE    FDTINC                 BILLED ELEMENTS NET TO ZERO               
*                                                                               
         B     FDTDROP             ELSE REJECT                                  
*                                                                               
FDT2ND40 DS    0H                                                               
*                                                                               
         CLI   PBQFLTDA,C'U'       IF ONLY UNORDERED DATA                       
         BNE   FDT2ND50                                                         
*                                                                               
         MVI   ELCODE,X'70'          FIND INSERTION ORDER ELEMENT               
         LA    R6,PBUYREC+33                                                    
*                                                                               
FDTUNOLP DS    0H                                                               
*                                                                               
         BAS   RE,NXTELM           FIND NEXT INSERTION ORDER ELEMENT            
         BNE   FDTINC              IF NONE - INCLUDE                            
*                                                                               
         CLI   2(R6),0             SEE IF INSERTION  ORDER DATE PRESENT         
         BE    FDTUNOLP            LOOK AT NEXT IF NO ORDER YET                 
*                                                                               
         B     FDTDROP             DROP IF ORDER WAS SENT                       
*                                                                               
FDT2ND50 DS    0H                                                               
*                                                                               
         CLI   PBQFLTDA,C'O'       IF ONLY ORDERED                              
         BNE   FDT2ND60                                                         
*                                                                               
         MVI   ELCODE,X'70'        FIND INSERTION ORDER ELEMENT                 
         LA    R6,PBUYREC+33                                                    
*                                                                               
FDTORDLP BAS   RE,NXTELM           READ I/O                                     
         BNE   FDTDROP             IF NONE - EXCLUDE                            
*                                                                               
         CLI   2(R6),0             IF INSERTION  ORDER DATE                     
         BE    FDTORDLP              NOT PRESENT KEEP LOOKING                   
*                                  ELSE ACCEPT                                  
FDT2ND60 DS    0H                                                               
*                                                                               
FDTINC   DS    0H                                                               
*                                                                               
FDTOKAY  DS    0H                                                               
*                                                                               
         CLI   0(R4),C'T'         PAID AND BILLED FILTER                        
         BNE   FDTINC10           FORCE TO GO THRU GETINS AGAIN TO GET          
*                                                                               
         MVI   GETIN,0            CORRECT BILLED AND PAID DATA                  
         GOTO1 =A(DOGETINS),RR=RELO (IRENE WEXLER)                              
*                                                                               
FDTINC10 DS    0H                                                               
*                                                                               
* IF FILTERING ON PAY REP, CHECK SPECIAL REP IN BUY FOR POSSIBLE MATCH          
*                                                                               
         OC    PBQREPF,PBQREPF     ACCEPT IF NO PAY REP FILTERING               
         BZ    FDTREPX                                                          
*                                                                               
         CLI   PBQREPF+4,C'P'      MUST BE PAYING  REP FILTER                   
         BE    *+8                                                              
         CLI   PBQREPF+4,C'P'-X'40'                                             
         BE    *+8                                                              
         CLI   PBQREPF+4,C'S'      OR      SPECIAL REP FILTER                   
         BE    *+8                                                              
         CLI   PBQREPF+4,C'S'-X'40'                                             
         BNE   FDTREPX                                                          
*                                                                               
         LA    R6,PBUYREC+33       FIND SPECIAL REP ELEMENT                     
         MVI   ELCODE,X'80'                                                     
*                                                                               
         BAS   RE,NXTELM           LOOK FOR SPECIAL REP                         
         BNE   FDTREPNF            NO REP FOUND                                 
*                                                                               
         TM    PBQREPF+4,X'40'     IF POSITIVE FILTER                           
         BNO   FDTREPF1                                                         
*                                                                               
         OC    PBQREPF(4),PBQREPF  IF NO REP SPECIFIED                          
         BZ    FDTREPX                ACCEPT BUY                                
*                                                                               
         CLC   2(4,R6),PBQREPF     ELSE MUST MATCH                              
         BNE   FDTDROP                  EXCLUDE                                 
*                                                                               
         B     FDTREPX                  ELSE ACCEPT                             
*                                                                               
FDTREPF1 DS    0H                  NEGATIVE FILTER                              
*                                                                               
         OC    PBQREPF(4),PBQREPF  IF NO REP SPECIFIED                          
         BZ    FDTDROP                DROP BUY                                  
*                                                                               
         CLC   2(4,R6),PBQREPF        MUST NOT MATCH                            
         BE    FDTDROP                EXCLUDE                                   
*                                                                               
         B     FDTREPX                ELSE ACCEPT                               
*                                                                               
FDTREPNF DS    0H                  NO SPECIAL REP FOUND                         
*                                                                               
         CLI   PBQREPF+4,C'S'      IF POSITIVE SPECIAL REP FILTERING            
         BE    FDTDROP                DROP BUY                                  
*                                                                               
FDTREPX  DS    0H                                                               
*                                                                               
*        FILTER ON CHANGE DATE IF REQUESTED                                     
*                                                                               
FDTCHGD  DS    0H                                                               
*                                                                               
         TM    PBBYOPTS,PBBYCHGQ   SKIP IF NOT FILTERING ON CHG DATE            
         BNO   FDTCHGDX                                                         
*                                                                               
         CLC   PBDBUYDT,PBQCHGST   IF BOUGHT ON OR AFTER START                  
         BL    FDTCHGD1                                                         
*                                                                               
         OC    PBQCHGEN,PBQCHGEN      KEEP IF NO END DATE                       
         BZ    FDTCHGDX                                                         
*                                                                               
         CLC   PBDBUYDT,PBQCHGEN      DROP IF NOT BOUGHT BEFORE END             
         BH    FDTDROP                                                          
*                                                                               
         B     FDTCHGDX               ELSE KEEP                                 
*                                                                               
FDTCHGD1 DS    0H                                                               
*                                                                               
         TM    PBUYKEY+27,X'80'    SKIP IF NOT DELETED                          
         BNO   FDTCDELX                                                         
*                                                                               
         CLC   PBDDATE,PBQCHGST    IF DELETED BEFORE START                      
         BL    FDTDROP                DROP                                      
*                                                                               
         OC    PBQCHGEN,PBQCHGEN      KEEP IF NO END DATE                       
         BZ    FDTCDELX                                                         
*                                                                               
         CLC   PBDDATE,PBQCHGEN       KEEP IF DELETED BEFORE END                
         BNH   FDTKEEP                                                          
*                                     ELSE CONTINUE                             
FDTCDELX DS    0H                                                               
*                                                                               
*        EXAMINE CHANGE ELEMENTS                                                
*                                                                               
         LA    R6,PBUYKEY+33                                                    
         MVI   ELCODE,PCHGELQ      LOOK FOR CHANGE ELEMENTS                     
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATCON-COMFACSD(RF)    DATCON ADDRESS                        
*                                                                               
FDTCHGDL DS    0H                                                               
*                                                                               
         BAS   RE,NXTELM           LOOK FOR CHANGE ELEMENT                      
         BNE   FDTCHGDD            NONE FOUND                                   
*                                                                               
         USING PCHGELD,R6          ESTABLISH CHANGE ELEMENT                     
*                                                                               
         GOTO1 (RF),PARM,(2,PCHGDAT),(3,WORK)  CONVERT DATE TO BINARY           
*                                                                               
         CLC   WORK(3),PBQCHGST    IF CHANGED ON OR AFTER START                 
         BL    FDTCHGDC                                                         
*                                                                               
         OC    PBQCHGEN,PBQCHGEN      KEEP IF NO END DATE                       
         BZ    FDTCHGDX                                                         
*                                                                               
         CLC   WORK(3),PBQCHGEN       ELSE MUST BE CHANGED BEFORE END           
         BNH   FDTCHGDX                                                         
*                                                                               
FDTCHGDC DS    0H                                                               
*                                                                               
         B     FDTCHGDL                                                         
*                                                                               
FDTCHGDD DS    0H                  NO CHANGES IN PERIOD                         
*                                                                               
*        FOLLOWING FOR BUYS BOUGHT AND DELETED WITH                             
*        NO OTHER CHANGES                                                       
*                                                                               
*        ALSO HANDLES NEW BUYS WITH NO OTHER CHANGES                            
*                                                                               
         LA    RF,PBDDATE          POINT TO LAST CHANGED DATE                   
*                                                                               
         OC    PBDDATE,PBDDATE     IF THERE IS NO LAST CHANGED DATE             
         BNZ   *+8                                                              
         LA    RF,PBDBUYDT         USE ORIGINAL BUY DATE                        
*                                                                               
         CLC   0(3,RF),PBQCHGST    LAST CHANGE -  ON OR AFTER START             
         BL    FDTDROP                                                          
*                                                                               
         OC    PBQCHGEN,PBQCHGEN      KEEP IF NO END DATE                       
         BZ    FDTCHGDX                                                         
*                                                                               
         CLC   0(3,RF),PBQCHGEN       ELSE LAST CHANGED BEFORE END              
         BNH   FDTCHGDX                                                         
*                                                                               
         B     FDTDROP             DROP                                         
*                                                                               
FDTCHGDX DS    0H                                                               
*                                                                               
         B     FDTKEEP                                                          
*                                                                               
         DROP  R6                                                               
*                                                                               
FDTKEEP  DS    0H                                                               
*                                                                               
         CR    RE,RE              PASSED TEST SET EQ CC                         
*                                                                               
         B     FLTDTEX                                                          
*                                                                               
FDTDROP  DS    0H                                                               
*                                                                               
         LTR   RB,RB               FAILED FILTER SET NEQ CC                     
*                                                                               
FLTDTEX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
PAYCNT   DS    PL3       COUNT OF PAID ELEMENTS                                 
BILCNT   DS    PL3                BILLED                                        
OPAYCNT  DS    PL3       COUNT OF PAID ELEMENTS                                 
OBILCNT  DS    PL3                BILLED                                        
******                                                                          
BILDC    CP    BILCNT,=P'0'                                                     
         BNER  RE                                                               
         CLI   PBFINAN,X'0'        FINANCIAL CLIENT                             
         BER   RE                                                               
         CP    OBILCNT,=P'0'                                                    
         BR    RE                                                               
****************                                                                
PAYDC    CP    PAYCNT,=P'0'                                                     
         BNER  RE                                                               
         CLI   PBFINAN,X'0'        FINANCIAL CLIENT                             
         BER   RE                                                               
         CP    OPAYCNT,=P'0'                                                    
         BR    RE                                                               
*                                                                               
***********************                                                         
PBLDC    NTR1  LABEL=*             PAYABLE IF UNPAID PAY ELEMENT                
*                                                                               
         MVI   ELCODE,X'25'        PAY ELEMENT CODE                             
         LR    R6,R2               START OF BUY RECORD                          
         BAS   RE,GETEL            FIND A PAY ELEMENT                           
*                                                                               
PBLDCLP  DS    0H                                                               
*                                                                               
         BNE   PBLDCDN             NOT FOUND                                    
*                                                                               
         USING PPAYELEM,R6         ESTABLISH PAY ELEMENT                        
*                                                                               
         OC    PPDDATE,PPDDATE     MUST BE UPAID                                
         BZ    PBLDCFD                                                          
*                                                                               
PBLDCCN  DS    0H                                                               
*                                                                               
         BRAS  RE,NEXTEL                                                        
         B     PBLDCLP                                                          
*                                                                               
PBLDCDN  DS    0H                  NO ELEMENTS FOUND                            
         LTR   RB,RB               SET NE CC                                    
         B     PBLDCX                                                           
*                                                                               
PBLDCFD  DS    0H                  UNPAID ELM FOUND                             
         CR    RB,RB               SET EQ CC                                    
*                                                                               
PBLDCX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DROP  R6                                                               
*                                                                               
***********************                                                         
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - DISCREPANT BUYS - PBLNV'                     
***********************************************************************         
*                                                                     *         
*        DETERMINE IF BUY MARKED DISCREPANT                           *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*     PBQMATS2 =  PBQMNVPQ - SEARCH FOR DISCREPANT STATUS             *         
*                                                                     *         
*EXIT CC       NE  BUY MARKED DISCREPANT                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
PBLNV    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
*                                                                               
         MVI   ELCODE,X'52'        STATUS ELEMENT CODE                          
         L     R6,AIO1             START OF BUY RECORD                          
         BAS   RE,GETEL            FIND A STATUS ELEMENT                        
         BNE   PBLNVOK             NOT FOUND                                    
*                                                                               
         USING PBMATELD,R6         ESTABLISH MATCH STATUS ELEMENT               
*                                                                               
         CLI   PBMTSTAT,PBMTSMTQ   CAN'T BE MATCHED                             
         BNE   PBLNVOK                                                          
*                                                                               
PBLNVDEL DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
         B     PBLNVX                                                           
*                                                                               
PBLNVOK  DS    0H                  NO MATCHING STATUS                           
         LTR   RB,RB               SET NE CC                                    
*                                                                               
PBLNVX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - NEXT AGENCY/MEDIA'                           
***********************************************************************         
*                                                                     *         
*        FIND NEXT AGENCY/MEDIA                                       *         
*                                                                     *         
*NTRY PBQMED   =  '*' = ALL MEDIA SEPARATELY                          *         
*                 'C' = ALL MEDIA COMBINED                            *         
*                                                                     *         
*     PBQADVSW =  'Y' = ADVERTISER REPORT - MAY READ ACROSS AGENCIES  *         
*     PBQADV   =  ADVERTISER CODE = MASTER CLIENT CODE ON AOR FILES   *         
*                                                                     *         
*EXIT PBAGY    =   AGENCY ID                                          *         
*     PBMED    =   MEDIA                                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
GETAGMD NMOD1 0,**+GAM**                                                        
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
*        FIND 1ST/NEXT MEDIA TO USE                                             
*                                                                               
GAMMED   DS    0H                  1ST/NEXT MEDIA                               
*                                                                               
         MVI   PAOERR,0            INIT ERROR CODE                              
*                                                                               
         CLI   PBQMED,C'*'         IF REQUEST FOR ONLY ONE MEDIA                
         BE    *+8                                                              
         CLI   PBQMED,C'C'                                                      
         BE    GAMMED10                                                         
*                                                                               
         MVC   PBMED,PBQMED          SET MEDIA CODE                             
         XC    PBAGY,PBAGY           FORCE NEW AGENCY                           
*                                                                               
         B     GAMMEDX                                                          
*                                                                               
GAMMED10 DS    0H                  ELSE GET NEXT MEDIA VALUE                    
*                                                                               
         USING CONTTABL,R8         ESTABLISH CONTRACT TABLE ENTRY               
         ICM   R8,15,PBACONTB      POINT TO CONTRACT TABLE BUILD AREA           
         BZ    *+10                NO BUFFER AVAILABLE                          
         XC    CONTTABL(CONTNLEN),CONTTABL  INIT FIRST ENTRY                    
*                                                                               
         LA    R1,GAMVMED          POINT TO LIST OF VALID MEDIA                 
         LA    R0,GAMVMEDL-1       NUMBER OF VALID ITEMS IN LIST                
*                                                                               
         OC    PBQMEDLS,PBQMEDLS   IF A MEDIA LIST ENTERED                      
         BZ    GAMMEDLX                                                         
*                                                                               
*        SET UP TO USE ENTERED MEDIA LIST                                       
*                                                                               
         LA    R0,L'PBQMEDLS       MAX NUMBER OF MEDIA IN LIST                  
         LA    R1,PBQMEDLS+L'PBQMEDLS-1  POINT TO END OF LIST                   
*                                                                               
         CLI   0(R1),C' '          FIND LAST ITEM IN LIST                       
         BH    *+12                                                             
         BCTR  R1,0                BACK UP ONE IN LIST                          
         BCT   R0,*-10             DECREMENT MEDIA COUNTER                      
         DC    H'0'                SHOULD NOT BE HERE                           
*                                                                               
*                                  R0 HAS NUMBER OF VALID MEDIA IN LIST         
         LA    R1,PBQMEDLS         POINT TO START OF MEDIA LIST                 
*                                                                               
GAMMEDLX DS    0H                                                               
*                                                                               
GAMMEDLP DS    0H                                                               
*                                                                               
         CLC   PBMED,0(R1)         MATCH CURRENT MEDIA TO LIST                  
         BE    GAMMEDFD                                                         
*                                                                               
GAMMEDCN DS    0H                                                               
*                                                                               
         LA    R1,1(R1)            NEXT MEDIA IN LIST                           
         BCT   R0,GAMMEDLP                                                      
*                                  MEDIA NOT IN LIST                            
         DC    H'0'                SHOULD NOT HAPPEN                            
*                                                                               
GAMVMED  DC    X'00'                                                            
         DC    C'ILMNOSTBVWD'      VALID MED=I/L/M/N/O/S/T/B/V/W/D              
         DC    X'00'                                                            
GAMVMEDL EQU   *-GAMVMED           LENGTH OF VALID MEDIA LIST                   
*                                                                               
GAMMEDFD DS    0H                                                               
*                                                                               
         MVC   PBMED,1(R1)         USE NEXT MEDIA IN LIST                       
*                                                                               
         CLI   PBMED,0             IF END OF LIST                               
         BNE   GAMMEDX                                                          
*                                                                               
         CLI   PBQADVSW,C'Y'       DONE IF NOT ADVERTISER REPORT                
         BNE   GAMAGYDN                                                         
*                                                                               
*        ICM   R4,15,PBAMEDBF         GET MEDIA BUFFER ADDRESS                  
*        USING MEDBUFFD,R4                                                      
*        MVI   MBFMED,0               SET END OF MEDIA LIST INDICATOR           
*        XC    PBCMEDBF,PBCMEDBF      RESET NUMBER OF ENTRIES IN LIST           
*                                                                               
         XC    PBAGY,PBAGY            FORCE NEW AGENCY                          
*                                                                               
         B     GAMMED              ELSE FIND FIRST IN LIST                      
*                                                                               
GAMMEDX  DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*        FIND 1ST/NEXT AGENCY TO USE                                            
*                                                                               
GAMAGY   DS    0H                  NEXT AGENCY                                  
*                                                                               
         OC    PBAGY,PBAGY         SKIP IF AGENCY KNOWN                         
         BNZ   GAMAGYX                                                          
*                                                                               
         CLI   PBQADVSW,C'Y'       IF NOT DOING ADVERTISER REPORT               
         BE    *+14                                                             
         MVC   PBAGY,PBQAGY           USE REQUEST'S AGENCY                      
         B     GAMAGYX                                                          
*                                                                               
*        INITIALIZE ADVERTISER CONTROL BLOCK                                    
*                                                                               
GAMADV1  DS    0H                                                               
*                                                                               
         OC    PAOBLK(PAOBLKL),PAOBLK      SKIP IF NOT 1ST TIME                 
         BNZ   GAMADV1X                                                         
*                                                                               
         MVI   PAOACT,PAOINITQ     SET FOR GETADV INITIALIZATION                
*                                                                               
         GOTO1 =A(GETADV),PARM,PAOBLK INIT ADVERTISER CONTROL BLOCK             
*                                                                               
         CLI   PAOERR,0            DONE ON ERROR                                
         BNE   GAMAGYDN                                                         
*                                                                               
*        CLC   PAOSE,PAORSE        SKIP IF NEW SYSTEM = AOR SYSTEM              
*        BE    GAMOPENX              BECAUSE IT'S FILES ARE ALWAYS OPEN         
*                                                                               
*        OPEN AOR FILES IF NEEDED                                               
*                                                                               
         L     R8,PBUTLA           POINT TO UTL                                 
         CLC   PAORQSE,4(R8)       SKIP IF SAME AS CURRENT FILE SET             
         BE    GAMOPNAX                                                         
*                                                                               
         L     RF,PBCOMFAC         GET DATAMGR ADDRESS                          
         L     RF,CDATAMGR-COMFACSD(RF)                                         
*                                                                               
         IC    R0,4(R8)            SAVE SE CODE                                 
*                                                                               
         MVC   4(1,R8),PAORQSE     SET NEW SYSTEM NUMBER                        
*                                  OPEN ITS FILES                               
         GOTO1 (RF),PARM,=C'DMOPEN',=C'PRINT',PRTFILES,IOWORK                   
*                                                                               
         STC   R0,4(R8)            RESTORE SE CODE                              
*                                                                               
GAMOPNAX DS    0H                                                               
*                                                                               
GAMADV1X DS    0H                                                               
*                                                                               
         MVI   PAOACT,PAOAGYQ      ASK FOR NEXT AGENCY                          
*                                                                               
         GOTO1 =A(GETADV),PARM,PAOBLK,RR=RELO                                   
*                                                                               
         CLI   PAOERR,PAOEOFQ      IF END OF AGENCIES                           
         BE    GAMAGYDN               STOP PROCESSING AGENCIES                  
         CLI   PAOERR,0            ELSE NO ERRORS TOLERATED                     
         BNE   GAMAGYDN                                                         
*                                                                               
*        IF SYSTEM HAS CHANGED WE MUST OPEN NEW SET OF FILES                    
*                                                                               
GAMOPEN  DS    0H                                                               
*                                                                               
*        CLC   PAOSE,PAORSE        SKIP IF NEW SYSTEM = AOR SYSTEM              
*        BE    GAMOPENX              BECAUSE IT'S FILES ARE ALWAYS OPEN         
*                                                                               
         L     R8,PBUTLA           POINT TO UTL                                 
         CLC   PAOSE,4(R8)         SKIP IF SAME AS CURRENT FILE SET             
         BE    GAMOPENX                                                         
*                                                                               
         L     RF,PBCOMFAC         GET DATAMGR ADDRESS                          
         L     RF,CDATAMGR-COMFACSD(RF)                                         
*                                                                               
         MVC   4(1,R8),PAOSE       SET NEW SYSTEM NUMBER                        
*                                  OPEN ITS FILES                               
         GOTO1 (RF),PARM,=C'DMOPEN',=C'PRINT',PRTFILES,IOWORK                   
*                                                                               
GAMOPENX DS    0H                                                               
*                                                                               
         MVC   PBAGY,PAOAGY        SET AGENCY TO BE USED                        
*                                                                               
GAMAGYX  DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*        READ IN AGENCY RECORD - VARIES BY MEDIA                                
*                                                                               
GAMAREC  DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY AREA                                
***      =====          **                                                      
         LA    R2,IOKEY            ESTABLISH AS PAGYREC KEY                     
         USING PAGYRECD,R2                                                      
***      ===== *******                                                          
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BNE   GAMAREC1                                                         
*                                                                               
         L     RF,PBUTLA              SET TO NEW AGENCIES FILES                 
         MVC   4(1,RF),PAOSE                                                    
*                                                                               
GAMAREC1 DS    0H                                                               
*                                                                               
         MVC   PAGYKAGY,PBAGY      SET AGENCY                                   
         MVC   PAGYKMED,PBMED      SET MEDIA                                    
         MVI   PAGYKRCD,PAGYKIDQ   SET RECORD ID                                
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ KEY                                     
*                                                                               
         CLC   IOKEY(L'PAGYKEY),IOKEYSAV  SKIP IF RECORD KEY NOT FOUND          
         BNE   GAMAGYCN                                                         
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1     ELSE READ RECORD INTO IO1             
         BE    *+6                                                              
         DC    H'0'                            NO ERRORS TOLERATED              
*                                                                               
         L     R2,IOADDR           POINT TO AGENCY RECORD                       
         MVC   PBMEDNM,PAGYMED     SAVE MEDIA CODE                              
         MVC   PBAGYPRF,PAGYPROF   SAVE PROFILE                                 
*                                                                               
         L     R0,PBAGYLEN         GET RECORD LENGTH                            
         ICM   R1,15,PBAGYADR      POINT TO AGENCY RECORD SAVEAREA              
         BZ    *+8                   NONE AVAIALBLE                             
         BAS   RE,MOVEREC          SAVE AGENCY RECORD                           
*                                                                               
         L     R2,IOADDR           RE-POINT TO AGENCY RECORD                    
*                                                                               
*        SAVE MEDIA AND MEDIA DESCRIPTION IN BUFFER                             
*                                                                               
***      =====          **                                                      
         ICM   R4,15,PBAMEDBF      GET BUFFER ADDRESS                           
         USING MEDBUFFD,R4                                                      
***      =====          **                                                      
         BZ    GETAGMDX            IGNORE IF NO BUFFER AVAILABLE                
*                                                                               
*        IF NEW MEDIA ADD IT TO BUFFER                                          
*                                                                               
GAMMBFLP DS    0H                                                               
*                                                                               
         CLI   MBFMED,0            CHECK FOR END OF BUFFER                      
         BE    GAMMBFDN                                                         
*                                                                               
         CLC   MBFMED,PAGYKMED     CHECK IF MEDIA ALREADY IN BUFFER             
         BE    GAMMBFFD                                                         
*                                                                               
GAMMBFCN DS    0H                                                               
*                                                                               
         LA    R4,MBFLEN(R4)       BUMP TO NEXT POSITION IN BUFFER              
         B     GAMMBFLP                                                         
*                                                                               
GAMMBFDN DS    0H                  ADD MEDIA TO BUFFER                          
*                                                                               
         L     R5,PBCMEDBF         BUMP NUMBER OF BUFFER ENTRIES                
         LA    R5,1(R5)                                                         
         ST    R5,PBCMEDBF         SAVE NUMBER OF ENTRIES                       
*                                                                               
         MH    R5,=Y(MBFLEN)       CALCULATE BUFFER LENGTH NEEDED               
*                                                                               
         C     R5,PBLMEDBF         COMPARE TO BUFFER LENGTH                     
         BL    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   MBFMED,PAGYKMED     SAVE CODE                                    
         MVC   MBFNAME,BLANKS                                                   
         MVC   MBFNAME(L'PAGYMED),PAGYMED     AND NAME                          
*                                                                               
*        INTERPRET INTERACTIVE ABBREVIATIONS                                    
*                                                                               
         CLC   MBFNAME(10),=C'INTERACTIV'                                       
         BE    *+10                                                             
         CLC   MBFNAME(9),=C'INTERACTV' COVERS INTERACTV AND INTERACTVE         
         BE    *+10                                                             
         CLC   MBFNAME(6),=C'INTRAC' COVERS INTRACTIVE (AND OTHERS)             
         BNE   *+10                                                             
         MVC   MBFNAME(11),=C'INTERACTIVE'                                      
*                                                                               
         LA    R4,MBFLEN(R4)       POINT TO NEXT ENTRY                          
         MVI   MBFMED,0            SET END OF LIST INDICATOR                    
*                                                                               
GAMMBFFD DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*        READ APPROPRIATE P0 PROFILE *                                          
*                                                                               
         XC    PBSPROF,PBSPROF     CLEAR PROFILE SAVEAREA                       
*                                                                               
         XC    WORK,WORK           BUILD KEY IN WORKAREA                        
         LA    R2,WORK                                                          
         MVC   0(4,R2),=C'P000'    PROFILE ID                                   
         MVC   4(2,R2),PBAGY       AGENCY                                       
         MVC   6(1,R2),PBMED       MEDIA                                        
*                                                                               
         CLI   PBQMED,C'C'         IF COMBINED MEDIA                            
         BNE   *+8                                                              
         MVI   6(R2),C'M'          USE MAGAZINE PROFILE                         
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     R0,CDATAMGR-COMFACSD(RF)   DATAMGR ADDRESS                       
         L     RF,CGETPROF-COMFACSD(RF)   GETPROF ADDRESS                       
         GOTO1 (RF),PARM,WORK,PBSPROF,(R0) GET PROFILE                          
*                                                                               
         XC    PBCLT,PBCLT         FORCE NEW CLIENT                             
         MVI   MASTCLIR,0          CLEAR MASTER CLIENT READ SWITCH              
         MVI   PBSLAVE,C'N'        NOT DOING SLAVES YET                         
*                                                                               
         CR    RB,RB               SET EQUAL CC                                 
         B     GETAGMDX                                                         
*                                                                               
GAMAGYCN DS    0H                                                               
*                                                                               
         CLI   PBQMED,C'*'         DONE IF REQUEST FOR ONLY ONE MEDIA           
         BE    GAMAGYC1                                                         
         CLI   PBQMED,C'C'                                                      
         BE    GAMAGYC1                                                         
*                                                                               
         CLI   PBQADVSW,C'Y'       AND NOT AN ADVERTISER REPORT                 
         BNE   GAMAGYDN                                                         
*                                                                               
GAMAGYC1 DS    0H                                                               
*                                                                               
         B     GAMMED              FIND NEXT MEDIA                              
*                                                                               
GAMAGYDN DS    0H                                                               
*                                                                               
         LTR   RB,RB               SET UNEQUAL CC                               
*                                                                               
GETAGMDX DS    0H                  NORMAL EXIT                                  
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GETADVC INTERFACE - GETADV'                  
***********************************************************************         
*                                                                     *         
*        GETADVC INTERFACE                                            *         
*                                                                     *         
*NTRY PAOACT   =  ACTION - INIT, NEXT AGENCY, NEXT CLIENT, INIT CLIENT*         
*                                                                     *         
*EXIT PBAGY    =   AGENCY ID                                          *         
*     PBMED    =   MEDIA                                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
GETADV   NMOD1 0,**+GADV                                                        
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
*        DETERMINE ACTION                                                       
*                                                                               
         CLI   PAOACT,PAOINITQ     INITIALIZATION                               
         BE    GADINIT                                                          
*                                                                               
         CLI   PAOACT,PAOAGYQ      NEXT AGENCY                                  
         BE    GADAGY                                                           
*                                                                               
         CLI   PAOACT,PAOCLTQ      NEXT CLIENT                                  
         BE    GADCLT                                                           
*                                                                               
         CLI   PAOACT,PAOICLQ      INITIALIZE A CLIENT                          
         BE    GADICL                                                           
*                                                                               
         DC    H'0'                UNKNOWN ACTION                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*       CALL GETADVC TO BUILD TABLE OF ADVERTISER DATA FOR ALL AGY/CLT*         
*          COMBOS FOR REPORT                                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
GADINIT  DS    0H                                                               
*                                                                               
         XC    PAOBLK(PAOBLKL),PAOBLK     CLEAR ADVERTISER DATA AREA            
*                                                                               
         ICM   R8,15,PBACONTB      POINT TO CONTRACT TABLE BUILD AREA           
         USING CONTTABL,R8         ESTABLISH ENTRY IN TABLE                     
         BZ    *+10                                                             
         XC    CONTTABL(CONTNLEN),CONTTABL  INIT FIRST ENTRY                    
*                                                                               
         LA    R8,AORELMSV         ESTABLISH AOR ELEMENT FROM CLTHDR            
         USING PCLTADVE,R8                                                      
*                                                                               
         CLI   GAMQSE,0            IF WE HAVEN'T GOT AOR SE CODE                
         BNE   GADINIT1              SAVE IT NOW                                
*                                                                               
         MVC   GAMQSE,PCLTAORS     AOR SE NUMBER                                
*                                                                               
*        OPEN CONTROL SYSTEM FILES                                              
*                                                                               
         L     RE,PBUTLA           POINT TO UTL                                 
         IC    R0,4(RE)            SAVE CURRENT SE NUMBER                       
*                                                                               
         L     RF,PBCOMFAC         GET DATAMGR ADDRESS                          
         L     RF,CDATAMGR-COMFACSD(RF)                                         
*                                                                               
         MVI   4(RE),X'0A'         SET FOR CONTROL SYSTEM                       
*                                  OPEN ITS FILES                               
         GOTO1 (RF),PARM,=C'DMOPEN',=C'CONTROL',GADCFILS,IOWORK                 
*                                                                               
         L     RE,PBUTLA           POINT TO UTL                                 
         STC   R0,4(RE)            RESTORE CURRENT SE NUMBER                    
*                                                                               
GADINIT1 DS    0H                                                               
*                                                                               
         MVI   PAOACT,PAOINITQ     RESET ACTION                                 
         MVC   PAORQSE,GAMQSE      REQUESTING SE NUMBER                         
         MVC   PAORQADV,PCLTADV    REQUESTING ADVERTISER                        
         MVC   PAORQAGY,PBQAGY     REQUESTING AGENCY                            
*                                                                               
         MVC   PAOQAGY,PBQQAGY     REQUESTED AGENCY                             
*****    CLC   PAOQAGY,=C'ALL'     CHANGE 'ALL' TO NULLS                        
*****    BNE   *+10                                                             
*****    XC    PAOQAGY,PAOQAGY                                                  
*                                                                               
         MVC   PAOQMED,PBMED       REQUESTED MEDIA                              
*                                                                               
         MVC   PAOQCLT,PBQQCLT     REQUESTED ADVERTISER CLIENT                  
         CLC   PAOQCLT,=C'ALL'     CHANGE 'ALL' TO NULLS                        
         BNE   *+10                                                             
         XC    PAOQCLT,PAOQCLT                                                  
*                                                                               
         MVC   PAORQAGY,PCLTAOR    AOR AGENCY                                   
         MVC   PAORAGY,PCLTAOR     AOR AGENCY                                   
*                                                                               
*        BUILD TABLE OF ENTRIES FOR MEDIA                                       
*                                                                               
         XC    GADCTLB(GADCTLBL),GADCTLB     INIT CONTROL BLOCK                 
         LA    R2,GADCTLB          ESTABLISH CONTROL BLOCK                      
         USING GETADVCD,R2                                                      
*                                                                               
         MVI   GADSTYP,C'P'        PRINT SYSTEM                                 
         MVC   GADMED,PBMED        CURRENT MEDIA                                
         MVC   GADRAGY,PAORAGY     AOR AGENCY ID                                
         MVC   GADADV,PAORQADV     ADVERTISER CODE                              
         MVC   GADQAGY,PAOQAGY     REQUESTED AGENCY                             
*                                                                               
         OC    PBQQAGFL,PBQQAGFL   IF AGENCY FILTER ENTERED                     
         BZ    *+14                                                             
         MVI   GADQAGY,C'*'           SET GETADVC FLAG                          
         MVC   GADFLTR,PBQQAGFL       PASS FILTER                               
*                                                                               
*        SWITCH TO CONTROL SYSTEM                                               
*                                                                               
         L     RE,PBUTLA           POINT TO UTL                                 
         IC    R0,4(RE)            SAVE CURRENT SE NUMBER                       
*                                                                               
         L     RF,PBCOMFAC         GET DATAMGR ADDRESS                          
         L     RF,CDATAMGR-COMFACSD(RF)                                         
*                                                                               
         MVI   4(RE),X'0A'         SET FOR CONTROL SYSTEM                       
*                                                                               
         GOTO1 =V(GETADVC),PARM,GADCTLB,GADTAB,(RF)                             
*                                                                               
         L     RE,PBUTLA           POINT TO UTL                                 
         STC   R0,4(RE)            RESTORE CURRENT SE NUMBER                    
*                                                                               
         ICM   R0,15,8(R1)         MUST HAVE SOME ENTRIES                       
         BNE   *+8                                                              
         MVI   PAOERR,X'FF'        FORCE AN ERROR CONDITION                     
*                                                                               
         STC   R0,GADENT#          SAVE NUMBER OF ENTRIES                       
         XC    GADENTA,GADENTA     INIT LAST USED ENTRY ADDRESS                 
*                                                                               
         CLC   PAORQAGY,PBQAGY     IF A BRAND AGENCY REQUEST                    
         BE    GADINIT3                                                         
*                                                                               
         OC    PBQPUB,PBQPUB       AND DOING SINGLE PUB                         
         BZ    GADINIT3                                                         
*                                                                               
*        REPLACE REQUESTED PUB ID WITH AOR ID                                   
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS PUBFILE KEY             
         USING PUBREC,R2                                                        
*                                                                               
         MVI   PUBAID,PUBAIDQ      SET PUB ADV PTR ID                           
         MVC   PUBAMED,PBMED       SET MEDIA                                    
         MVC   PUBAAGY,PBQAGY      SET AGY                                      
         MVC   PUBAADV,PAORQADV    SET ADVERTISER'S CODE                        
         MVC   PUBAAOR,PAORAGY     SET AOR'S AGY CODE                           
         MVC   PUBAAPUB,PBQPUB     SET AGENCY'S PUB ID                          
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOHI   READ PASSIVE POINTER                         
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         CLC   IOKEY(PUBAVPUB-PUBKEY),IOKEYSAV    IF EXACT MATCH                
         BNE   *+14                                                             
         MVC   PBQPUB,PUBAVPUB        USE AS REQUESTED PUB                      
         B     GADINIT2                                                         
*                                                                               
         CLC   IOKEY(PUBAVPUB-2-PUBKEY),IOKEYSAV  IF BASE PUB MATCH             
         BNE   GADINIT3            NO MATCH LEAVE AS IS                         
*                                                                               
         MVC   PBQPUB(4),PUBAVPUB  USE AOR'S BASE PUB ID                        
         MVC   PBQPUB+4(2),=X'0000' CLEAR ZONE & EDITION                        
*                                                                               
GADINIT2 DS    0H                                                               
*                                                                               
         CLI   PBQALLZN,C'Y'       IF DOING ALL ZONES/EDITIONS                  
         BNE   *+10                                                             
         XC    PBQPUB+4(2),PBQPUB+4    KILL ZONE AND EDITION                    
*                                                                               
GADINIT3 DS    0H                                                               
*                                                                               
GADINITX DS    0H                                                               
*                                                                               
         B     GETADVX                                                          
*                                                                               
         DROP  R8                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        FIND NEXT AGENCY TO BE USED IN REPORT                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
GADAGY   DS    0H                                                               
*                                                                               
*        INIT ADV BLOCK FIELDS                                                  
*                                                                               
         XC    PAOSYS,PAOSYS       PRINT NUMBER                                 
         XC    PAOSE,PAOSE         SE NUMBER                                    
         XC    PAOAGY,PAOAGY       AGENCY                                       
         XC    PAOMCL,PAOMCL       MASTER CLIENT                                
         XC    PAOCLT,PAOCLT       CLIENT                                       
         XC    PAORCLT,PAORCLT     AOR CLIENT                                   
         XC    PAORCLTA,PAORCLTA   AOR CLIENT HEADER ADDRESS                    
         XC    PAOCLTST,PAOCLTST   START DATE                                   
         XC    PAOCLTEN,PAOCLTEN   END DATE                                     
         XC    PAOCCNTL,PAOCCNTL   CONTROL BYTES                                
*                                                                               
         ICM   R2,15,GADENTA       GET LAST USED ENTRY ADDRESS                  
         BNZ   *+12                                                             
         LA    R2,GADTAB           IF FIRST TIME USE FIRST IN TABLE             
         B     GADAGYFD                                                         
*                                                                               
         USING GETADVCD,R2         ESTABLISH TABLE ENTRY                        
*                                                                               
         CLC   GETVAGY,GETVAGY+GETVLEN LOOK FOR AGENCY CHANGE                   
         BNE   *+12                                                             
         LA    R2,GETVLEN(R2)      BUMP TO NEXT TABLE ENTRY                     
         B     *-14                                                             
*                                                                               
         LA    R2,GETVLEN(R2)      BUMP TO NEXT TABLE ENTRY                     
*                                                                               
GADAGYFD DS    0H                                                               
*                                                                               
         CLC   0(2,R2),=X'FFFF'    CHECK FOR END OF LIST                        
         BNE   GADAGYF1                                                         
*                                                                               
         MVI   PAOERR,PAOEOFQ      INDICATE END OF LIST                         
         L     RF,PBUTLA           POINT TO UTL                                 
         MVC   4(1,RF),PAORSE      SET FOR AOR SYSTEM                           
*                                                                               
         B     GETADVX                                                          
*                                                                               
GADAGYF1 DS    0H                                                               
*                                                                               
*        FILL IN ADVERTISER FIELDS IN PRNTBLOCK                                 
*                                                                               
         MVC   PAORSE,GAMQSE       AOR SE NUMBER                                
         MVC   PAOSYS,GETVSYS      PRINT NUMBER                                 
         MVC   PAOSE,GETVSE        SE NUMBER                                    
         MVC   PAOAGY,GETVAGY      AGENCY                                       
*                                                                               
         ST    R2,GADENTA          UPDATE ENTRY POINTER                         
         ST    R2,GADAGYA          UPDATE FIRST POINTER FOR AGENCY              
*                                                                               
         B     GETADVX                                                          
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        FIND NEXT CLIENT IN TABLE FOR AGENCY                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
GADCLT   DS    0H                                                               
*                                                                               
*        INIT CLIENT FIELDS IN ADVERTISER AREA IN PRNTBLOCK                     
*                                                                               
         ICM   R2,15,GADENTA       GET LAST USED ENTRY ADDRESS                  
         BNZ   *+12                                                             
         LA    R2,GADCTLB          IF FIRST TIME USE FIRST IN TABLE             
         B     GADCLTFD                                                         
*                                                                               
         OC    PBCLT,PBCLT         IF FIRST CLIENT FOR AGENCY                   
         BNZ   *+14                                                             
         ICM   R2,15,GADAGYA          USE FIRST AGENCY ENTRY                    
         BNZ   GADCLTL1                                                         
         DC    H'0'                CAN'T CONTINUE                               
*                                                                               
GADCLTFD DS    0H                                                               
*                                                                               
GADCLTLP DS    0H                                                               
*                                                                               
         CLC   GETVAGY,GETVAGY+GETVLEN EXIT ON AGENCY CHANGE                    
         BE    *+12                                                             
         MVI   PAOERR,PAOEOFQ      SET END OF FILE ERROR CODE                   
         B     GETADVX                                                          
*                                                                               
         LA    R2,GETVLEN(R2)      BUMP TO NEXT TABLE ENTRY                     
*                                                                               
GADCLTL1 DS    0H                                                               
*                                                                               
         CLC   0(2,R2),=X'FFFF'    CHECK FOR END OF LIST                        
         BNE   *+12                                                             
         MVI   PAOERR,PAOEOFQ      INDICATE END OF LIST                         
         B     GETADVX                                                          
*                                                                               
         OC    PAOQCLT,PAOQCLT     IF SINGLE CLIENT WANTED                      
         BZ    GADCLTDN                                                         
*                                                                               
         OC    PAOQAGY,PAOQAGY        IF ALL AGENCIES WANTED                    
         BNZ   *+14                                                             
         CLC   PAOQCLT,GETVVCLT          FILTER ON AOR CLIENT CODE              
         B     *+10                   ELSE                                      
         CLC   PAOQCLT,GETVACLT          FILTER ON AGY CLIENT CODE              
*                                                                               
         BE    GADCLTDN               CLIENT FOUND                              
*                                                                               
GADCLTCN DS    0H                                                               
*                                                                               
         B     GADCLTLP                                                         
*                                                                               
GADCLTDN DS    0H                                                               
*                                                                               
*        FILL IN ADVERTISER FIELDS IN PRNTBLOCK                                 
*                                                                               
         MVC   WORK,0(R2)                                                       
*                                                                               
         MVC   PAOSYS,GETVSYS      CLIENT AGENCY'S SYSTEM NUMBER                
         MVC   PAOAGY,GETVAGY      CLIENT'S AGENCY                              
         MVC   PAOSE,GETVSE        CLIENT AGENCY'S SE                           
         MVC   PAOCLT,GETVACLT     AGENCY CLIENT                                
         OC    PAOCLT,=C'   '                                                   
         MVC   PAORCLT,GETVVCLT    ADVERTISER EQUIVALENT CLIENT                 
         OC    PAORCLT,=C'   '                                                  
         MVC   PAOCLTST,GETVSTRD   CLIENT START DATE                            
         MVC   PAOCLTEN,GETVENDD   CLIENT END   DATE                            
         MVC   PAOCCNTL,GETVCNTL   CLIENT CONTROL BYTES                         
*                                                                               
         ST    R2,GADENTA          UPDATE ENTRY POINTER                         
*                                                                               
*        READ IN AOR CLIENT HEADER                                              
*                                                                               
         L     R8,PBUTLA           POINT TO UTL                                 
         MVC   GADSESV,4(R8)       SAVE CURRENT SE NUMBER                       
         MVC   4(1,R8),PAORSE      SET FOR AOR SYSTEM                           
*                                                                               
         MVC   GADKEYSV,IOKEYSAV   SAVE CURRENT KEY                             
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY                                     
         LA    R2,IOKEY            ESTABLISH CLIENT RECORD KEY                  
         USING PCLTRECD,R2                                                      
*                                                                               
         MVC   GADIOASV,IOADDR     SAVE CURRENT IOADDR                          
         LA    RF,GADCHDR          SET AOR CLIENT HEADER ADDRESS                
         ST    RF,IOADDR                                                        
         ST    RF,PAORCLTA         SAVE IT CONTROL BLOCK                        
*                                                                               
         XC    PCLTKEY,PCLTKEY     INIT CLIENT HEADER KEY                       
*                                                                               
         MVC   PCLTKAGY,PAORAGY    SET AOR AGENCY                               
         MVC   PCLTKMED,PBMED      SET MEDIA                                    
         MVI   PCLTKRCD,PCLTKIDQ   SET RECORD ID                                
         MVC   PCLTKCLT,PAORCLT    SET AOR CLIENT                               
         OC    PCLTKCLT,=C'   '    MAKE UPPERCASE                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIRECTORY                               
*                                                                               
         CLC   IOKEY(L'PCLTKEY),IOKEYSAV  MUST BE SAME A-M-TY-CLT               
         BE    GADCLT10              CLIENT FOUND FOR MEDIA                     
*                                                                               
*        THERE IS NO AOR EQUIVALENT CLIENT                                      
*                                                                               
         MVC   PAORCLT,BLANKS      ERASE AOR CLIENT                             
         MVC   PAORCLTA,PBCLTADR   USE CLIENT RECORD FOR AOR CLIENT             
         B     GADCLT20                                                         
*                                                                               
GADCLT10 DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET                                               
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R2,IOADDR           POINT TO FOUND AOR CLIENT HEADER             
*                                                                               
         CLI   PCLTPROF+5,C'2'      SKIP IF NOT A SLAVE CLIENT                  
         BNE   *+10                                                             
         MVC   PAORMCL,PCLTPROF+6     SAVE MASTER CLIENT ID                     
*                                                                               
GADCLT20 DS    0H                                                               
*                                                                               
         MVC   IOADDR,GADIOASV     RESTORE CURRENT IOADDR                       
         L     R8,PBUTLA           POINT TO UTL                                 
         MVC   4(1,R8),GADSESV     RESTORE CURRENT SE NUMBER                    
         MVC   IOKEY,GADKEYSV      RESTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RE-POINT DIRECTORY                           
*                                                                               
         L     R8,PBUTLA           POINT TO UTL                                 
         MVC   4(1,R8),PAOSE       SET FOR CLIENT'S FILES                       
*                                                                               
         B     GETADVX                                                          
*                                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        ERROR ROUTINES, MODULE EXIT AND WORKAREAS                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
GADICL   DS    0H                                                               
*                                                                               
GADERR   DS    0H                  ERROR WE CAN'T HANDLE                        
         MVI   PAOERR,PAOFTLQ      FATAL ERROR                                  
         B     GETADVX                                                          
*                                                                               
GETADVX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
GADCFILS DS    0C                  LIST OF CONTROL SYSTEM FILES                 
         DC    CL8' GENDIR'                                                     
         DC    CL8' GENFIL'                                                     
         DC    CL8'X'              END OF LIST                                  
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
GADCTLB  DS    0D                  DATA FOR GETADVC                             
GADSTYP  DS    CL1                 SYSTEM ID                                    
GADMED   DS    CL1                 MEDIA                                        
GADRAGY  DS    CL2                 AOR AGENCY ID                                
GADADV   DS    CL3                 ADVERTISER CODE                              
GADQAGY  DS    CL2                 REQUESTED AGENCY (OPTIONAL)                  
         ORG   *-1                                                              
GADFLTR  DS    CL3                 AGENCY FILTER                                
GADCTLBL EQU   *-GADCTLB           CONTROL BLOCK LENGTH                         
*                                                                               
GADENTA  DS    A                   A(LAST  TABLE ENTRY USED)                    
GADAGYA  DS    A                   A(FIRST TABLE ENTRY FOR AGY)                 
*                                                                               
GADRQSE  DS    XL1                 REQUESTING SE NUMBER                         
GADSESV  DS    XL1                 CURRENT    SE NUMBER                         
GADENT#  DS    XL1                 NUMBER OF ENTRIES IN TABLE                   
GADKEYSV DS    XL(L'IOKEY)         KEY SAVEAREA                                 
GADIOASV DS    A                   IOADDR SAVEAREA                              
         DS    0D                                                               
GADCHDR  DS    XL2000              AOR CLIENT'S HEADER RECORD                   
*                                                                               
         DS    0D                                                               
GADTAB   DS    XL6000              TABLE RETURNED BY GETADVC                    
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GET NEXT CLIENT-GETCLT'                      
***********************************************************************         
*                                                                     *         
*        FIND NEXT CLIENT                                             *         
*                                                                     *         
*NTRY PBQCLT   =  'ALL' OR SPACES MEANS ALL CLIENTS                   *         
*              =  ELSE IS A CLIENT CODE                               *         
*     PBQXCL   =  CLIENT CODE TO BE EXCLUDED                          *         
*                                                                     *         
*                                                                     *         
*     PBQADVSW =  'Y' = ADVERTISER REPORT - MAY READ OTHER AGENCIES   *         
*     PBQADV   =  ADVERTISER CODE = MASTER CLIENT CODE ON AOR FILES   *         
*                                                                     *         
*EXIT PBCLT    =   CLIENT                                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
GETCLT   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
*                                                                               
*        RESERVE CORE TO SAVE CLIENT HEADER                                     
*                                                                               
GCLCORE  DS    0H                                                               
*                                                                               
         OC    PBCLTADR,PBCLTADR   SKIP IF CORE ALREADY RESERVED                
         BNZ   GCLCOREX                                                         
*                                                                               
         L     RF,PBT2PTR          NEXT AVAIL PIECE OF WORKING STORAGE          
         ST    RF,PBCLTADR         IN T40502                                    
         MVC   PBCLTLEN,=F'1000'   RESERVE 1000 BYTES                           
*                                                                               
         LA    RF,1000(RF)         UPDATE NEXT AVAILABLE CORE POINTER           
         ST    RF,PBT2PTR                                                       
*                                                                               
GCLCOREX DS    0H                                                               
*                                                                               
*        RESET MEDIA NAME TO STANDARD FORM                                      
*                                                                               
GCLMD    DS    0H                                                               
*                                                                               
         OC    GCLMEDSV,GCLMEDSV   SKIP IF THERE WAS NO OVERRIDE                
         B     GCLMDX                                                           
*                                                                               
         ICM   R4,15,PBAMEDBF      GET MEDIA BUFFER ADDRESS                     
         USING MEDBUFFD,R4                                                      
*                                                                               
GCLMBFLP DS    0H                                                               
*                                                                               
         CLI   MBFMED,0            CHECK FOR END OF BUFFER                      
         BNE   *+6                                                              
         DC    H'0'                SHOULD NOT BE HERE                           
*                                                                               
         CLC   MBFMED,GCLMEDSV     FIND LAST USED MEDIA IN TABLE                
         BE    GCLMBFFD                                                         
*                                                                               
GCLMBFCN DS    0H                                                               
*                                                                               
         LA    R4,MBFLEN(R4)       BUMP TO NEXT POSITION IN BUFFER              
         B     GCLMBFLP                                                         
*                                                                               
GCLMBFFD DS    0H                  ADD MEDIA TO BUFFER                          
*                                                                               
         MVC   MBFNAME,GCLMDNSV    RESTORE MEDIA NAME                           
*                                                                               
         XC    GCLMEDSV,GCLMEDSV   CLEAR SAVEAREAS                              
         XC    GCLMDNSV,GCLMDNSV                                                
*                                                                               
GCLMDX   DS    0H                                                               
*                                                                               
         DROP  R4                                                               
*                                                                               
         MVI   READSW,0            INIT EXACT READ SWITCH                       
*                                                                               
*        IF PROCESSING SLAVE CLIENTS NEED TO FIND THEM                          
*                                                                               
GCLSLV   DS    0H                                                               
*                                                                               
         MVI   PBQCLTSW,0          INIT ADVERTISER CLIENT SWITCH                
*                                                                               
         CLI   PBQADVSW,C'Y'       SKIP IF ADVERTISER REPORT                    
         BE    GCLSLVX               CLIENTS FOUND ANOTHER WAY                  
*                                                                               
         CLI   PBQSLAVE,C'Y'       SKIP IF REQUEST DOES NOT                     
         BNE   GCLSLVX               INVOLVE SLAVE CLIENTS                      
*                                                                               
         CLI   PBSLAVE,C'Y'        IF NOT PROCESSING SLAVES YET                 
         BE    GCLSLV10                                                         
*                                                                               
         MVC   PBCLT,PBQCLT           SET TO PROCESS MASTER NOW                 
         MVI   PBSLAVE,C'Y'           SET FOR SLAVES NEXT TIME                  
*                                                                               
         B     GCLREAD                READ CLIENT HEADER                        
*                                                                               
GCLSLV10 DS    0H                                                               
*                                                                               
         CLC   PBCLT,PBQCLT         IF A NON-MASTER JUST PROCESSED              
         BNE   GCLNEXT                 READ NEXT SLAVE CLIENT                   
*                                                                               
         CLI   MASTCLIR,C'R'        IF SECOND TIME FOR MASTER THEN              
         BE    GCLNEXT                 CONTINUE WITH NEXT SLAVE                 
*                                                                               
         MVI   MASTCLIR,C'R'        ELSE TURN ON MAST CL READ INDICATOR         
         MVC   PBCLT,=C'AAA'           START READING SLAVES AT BEGINING         
*                                                                               
         B     GCLNEXT             READ NEXT CLIENT HEADER                      
*                                                                               
GCLSLVX  DS    0H                                                               
*                                                                               
*        IF ADVERTISER REPORT NEED TO USE GETADV FOR NEXT CLIENT                
*                                                                               
GCLADV   DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       SPECIAL PROCESSING IF REQUEST                
         BNE   GCLADVX               INVOLVES ADVERTISER REPORTING              
*                                                                               
         MVI   PAOACT,PAOCLTQ      ASK FOR NEXT CLIENT                          
*                                                                               
         GOTO1 =A(GETADV),PARM,PAOBLK,RR=RELO   GET NEXT CLIENT                 
*                                                                               
         CLI   PAOERR,PAOEOFQ      END OF CLIENTS                               
         BE    GCLEOL                                                           
         CLI   PAOERR,0            FATAL ERROR CHECK                            
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   PBCLT,PAOCLT        SET CLIENT CODE                              
         B     GCLREAD               GO READ CLIENT HEADER                      
*                                                                               
GCLADVX  DS    0H                                                               
*                                                                               
*        IF CLIENT GROUP REQUEST GO FIND NEXT CLIENT                            
*                                                                               
         OC    PBQGPCLT,PBQGPCLT   IF GROUP SCHEME PRESENT                      
         BZ    GCLGRPX                                                          
*                                                                               
         GOTO1 =A(CLTGRP)             FIND NEXT CLIENT IN GROUP                 
*                                                                               
         OC    PBCLT,PBCLT            DONE IF END OF LIST REACHED               
         BZ    GCLEOL                                                           
*                                                                               
         B     GCLREAD                GO READ CLIENT HEADER                     
*                                                                               
GCLGRPX  DS    0H                                                               
*                                                                               
*        SKIP END OF CLIENT CHECK IF REQUEST INVOLVES                           
*          MULTIPLE CLIENTS                                                     
*                                                                               
GCLEND   DS    0H                                                               
*                                                                               
         CLC   =C'ALL',PBQCLT      ALL CLIENTS                                  
         BE    GCLNEXT                                                          
*                                                                               
         CLI   PBQCLT,C'*'         TEST OFFICE REQUEST                          
         BE    GCLNEXT                                                          
*                                                                               
         CLI   PBQCLT,C'&&'        TEST GROUP REQUEST                           
         BE    GCLNEXT                                                          
*                                                                               
         CLI   PBQCLT,C'$'         TEST OFFICE LIST                             
         BE    GCLNEXT                                                          
*                                                                               
         OC    PBCLT,PBCLT         IF SINGLE CLIENT REQUEST THEN DONE           
         BNZ   GCLEOL                IF CLIENT ALREADY SET                      
*                                  ELSE FIRST TIME                              
         MVC   PBCLT,PBQCLT          SET WORKING CLIENT CODE                    
         B     GCLREAD               AND READ CLIENT HEADER                     
*                                                                               
*        READ CLIENT HEADER                                                     
*          OPTIONS ARE                                                          
*            EXACTLY OR NEXT SEQUENTIALLY                                       
*                                                                               
GCLNEXT  DS    0H                                                               
*                                                                               
         MVI   NOPRDERR,C'Y'       SET FLAG TO SUPPRESS PRD/EST ERRS            
         B     *+8                                                              
GCLREAD  DS    0H                                                               
         MVI   READSW,C'E'         SET EXACT READ SWITCH                        
*                                                                               
GCLRDLP DS     0H                                                               
*                                                                               
         MVC   IOADDR,AIO1         CLIENT RECORD ADDRESS                        
*                                                                               
         LA    R2,IOKEY            ESTABLISH CLIENT RECORD KEY                  
         USING PCLTRECD,R2                                                      
*                                                                               
         XC    PCLTKEY,PCLTKEY     INIT CLIENT HEADER KEY                       
*                                                                               
         MVC   PCLTKAGY,PBAGY      SET AGENCY                                   
         MVC   PCLTKMED,PBMED      SET MEDIA                                    
         MVI   PCLTKRCD,PCLTKIDQ   SET RECORD ID                                
         MVC   PCLTKCLT,PBCLT      SET CLIENT                                   
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIRECTORY                               
*                                                                               
         CLC   IOKEY(PCLTKCLT-PCLTKEY),IOKEYSAV  MUST BE SAME AG/MED            
         BNE   GCLEOL                                                           
*                                                                               
         CLI   READSW,C'E'         IF EXACT READ                                
         BNE   *+18                                                             
         CLC   IOKEY(L'PCLTKEY),IOKEYSAV  MUST BE SAME A-M-TY-CLT               
         BNE   GCLEOL                                                           
         B     GCLGET                GET RECORD                                 
*                                                                               
         CLC   IOKEY(L'PCLTKEY),IOKEYSAV  IF NEW CLIENT                         
         BNE   GCLGET                GET RECORD                                 
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT DIRECTORY RECORD                   
*                                                                               
         CLC   IOKEY(PCLTKCLT-PCLTKEY),IOKEYSAV  MUST BE SAME AG/MED            
         BNE   GCLEOL                                                           
*                                                                               
GCLGET   DS    0H                  READ RECORD                                  
*                                                                               
         MVC   PBCLT,PCLTKCLT      SAVE NEW CODE SO NO LOOPS                    
*                                                                               
         CLC   PBCLT,PBQXCL        DROP CLIENT IF BEING EXCLUDED                
         BE    GCLRDCN                                                          
*                                                                               
         OC    PBQXCGRP,PBQXCGRP   IF CLIENT GROUP BEING EXCLUDED               
         BZ    *+12                                                             
         BRAS  RE,XCGRFLT             FILTER ON CLIENT GROUP                    
         BNE   GCLRDCN                   FAILS FILTER                           
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET                                               
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
*        CALL OFFICER TO SEE IF USER CAN SEE CLIENT                             
*                                                                               
         LA    R3,WORK             SET UP OFFICER CONTROL BLOCK                 
         XC    WORK,WORK           INIT OFFICER PARAMETERS                      
*                                                                               
         USING OFFICED,R3                                                       
*                                                                               
         MVI   OFCSYS,C'P'         SYSTEM                                       
         MVC   OFCAUTH,PBACCS      SIGN ON LIMITS                               
         MVC   OFCAGY,PBAGY        AGENCY ID                                    
         MVC   OFCLMT,PBACCS       LIMIT ACCESS VALUE                           
         MVC   OFCSECD,PBASECRT    A(FASECRET BLOCK)                            
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
         LA    R6,33(R2)           POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
         USING PCLTELEM,R6         ESTABLISH CLIENT HEADER ELEMENT              
*                                                                               
         MVC   OFCPMED,PCLTKMED    MEDIA                                        
         MVC   OFCOFC,PCLTOFF      SET CLIENT OFFICE CODE                       
         MVC   OFCCLT,PCLTKCLT     SET CLIENT CODE                              
*                                                                               
         LR    R0,R6               SAVE CURRENT ELEMENT POINTER                 
*                                                                               
         CLI   PBTRAFID,C'T'       IF TRAFFIC SIGN ON                           
         BNE   GCLGET1                                                          
*                                                                               
         MVI   ELCODE,X'50'        TRAFFIC OFFICE ELEMENT                       
*                                                                               
         BRAS  RE,NEXTEL           FIND ELEMENT                                 
         BNZ   GCLGET1             SKIP IF NO ELEM FOUND                        
         USING PCLTTOEL,R5         ESTABLISH TRAFFIC ELEMENT                    
*                                                                               
         MVC   OFCOFC,PCLTTOFC     VALIDATE TRAFFIC OFFICE                      
*                                                                               
GCLGET1  DS    0H                                                               
*                                                                               
         LR    R6,R0               RESTORE ELEMENT PONTER                       
*                                                                               
         GOTOR VOFFICER,PARM,(C'N',OFFICED),PBCOMFAC                            
*                                                                               
         CLI   0(R1),0                                                          
         BE    *+12                                                             
         OI    PBQSWTCH,PBQXCLTQ      INDICATE CLIENT DROPPED FOR               
         B     GCLRDCN                SECURITY REASONS                          
*                                                                               
*        SAVE CLIENT HEADER                                                     
*                                                                               
         L     R0,PBCLTLEN         HEADER SAVEAREA LENGTH                       
         ICM   R1,15,PBCLTADR      POINT TO HEADER SAVEAREA                     
         BZ    *+8                   NONE AVAILABLE                             
         BAS   RE,CLRBUFF                                                       
*                                                                               
         L     R0,PBCLTLEN         HEADER SAVEAREA LENGTH                       
*                                                                               
         CLM   R0,3,PCLTLEN        COMPARE TO REC LENGTH                        
         BNH   *+8                 AND USE SMALLER                              
         ICM   R0,3,PCLTLEN                                                     
*                                                                               
         ICM   R1,15,PBCLTADR      POINT TO HEADER SAVEAREA                     
         BZ    *+8                   NONE AVAILABLE                             
         BAS   RE,MOVEREC          SAVE CLIENT RECORD                           
*                                                                               
         L     R2,IOADDR           RESET CLIENT HEADER POINTER                  
*                                                                               
*        TRANSLATE CLIENT OFFICE CODE                                           
*                                                                               
         MVC   PBOFC,PCLTOFF       INTERNAL OFFICE CODE                         
*                                                                               
         XC    WORK,WORK                                                        
         LA    R3,WORK             ESTABLISH OFFICER PARAMETER LIST             
         USING OFFICED,R3                                                       
*                                                                               
         MVI   OFCSYS,C'P'         PASS SYSTEM CODE                             
         MVC   OFCAGY,PBAGY        PASS AGENCY CODE                             
         MVC   OFCOFC,PCLTOFF      PASS OFFICE CODE                             
*                                                                               
         GOTO1 VOFFICER,PARM,(C'2',OFFICED),(0,PBCOMFAC)                        
*                                                                               
         MVC   PBOFC2,OFCOFC2      EXTERNAL OFFICE CODE                         
*                                                                               
         DROP  R3                                                               
*                                                                               
*        IF REQUESTOR HAS LIMITED ACCESS,                                       
*           VERIFY IT CAN READ THIS CLIENT                                      
*                                                                               
GCLRDAC  DS    0H                                                               
*                                                                               
         CLI   READSW,C'E'         DONE IF EXACT READ WANTED                    
         BE    GCLRDDN                                                          
*                                                                               
*        MULTIPLE CLIENT AND/OR SLAVE CLIENTS REQUEST                           
*                                                                               
         CLI   PBFLAVOR,C'O'       IF DOING CONTRACTS ONLY                      
         BNE   *+12                                                             
         CLI   PCLTPROF+5,C'2'        BYPASS ALL SLAVE CLIENTS                  
         BE    GCLRDCN                                                          
*                                                                               
*        FILTER OFFICE REQUEST                                                  
*                                                                               
*                                                                               
         CLI   PBQCLT,C'*'         SKIP IF NOT OFFICE REQUEST                   
         BNE   GCLRDOFN                                                         
*                                                                               
         CLI   PBQCLT+1,C'-'       SKIP IF 'ALL BUT OFFICE'                     
         BE    GCLRDOF1                                                         
*                                                                               
         CLC   PCLTOFF,PBQCLT+1    CLIENT OFFICE MUST MATCH                     
         BE    GCLRDOFX                REQUEST'S OFFICE                         
*                                                                               
*                                    OR FALL IN OFFICE RANGE                    
*                                                                               
         CLI   PBQCLT+2,C' '           IF NOT OFFICE RANGE                      
         BNH   GCLRDCN                      REJECT                              
*                                                                               
*        TRANSLATE RANGE TO EXTERNAL OFFICE CODES                               
*                                                                               
         OC    GCLOFCST,GCLOFCST   SKIP IF TRANSLATION DONE ALREADY             
         BNZ   GCLRDTRX                                                         
*                                                                               
         XC    WORK,WORK                                                        
         LA    R3,WORK             ESTABLISH OFFICER PARAMETER LIST             
         USING OFFICED,R3                                                       
*                                                                               
         MVI   OFCSYS,C'P'         PASS SYSTEM CODE                             
         MVC   OFCAGY,PBAGY        PASS AGENCY CODE                             
         MVC   OFCOFC,PBQCLT+1     PASS STARTING OFFICE                         
*                                                                               
         GOTO1 VOFFICER,PARM,(C'2',OFFICED),(0,PBCOMFAC)                        
*                                                                               
         MVC   GCLOFCST,OFCOFC2    EXTERNAL OFFICE CODE                         
*                                                                               
         MVC   OFCOFC,PBQCLT+2     PASS ENDING   OFFICE                         
*                                                                               
         GOTO1 VOFFICER,PARM,(C'2',OFFICED),(0,PBCOMFAC)                        
*                                                                               
         MVC   GCLOFCEN,OFCOFC2    EXTERNAL OFFICE CODE                         
*                                                                               
         DROP  R3                                                               
*                                                                               
GCLRDTRX DS    0H                                                               
*                                                                               
         CLC   PBOFC2,GCLOFCST     CLIENT OFFICE MUST BE IN RANGE               
         BL    GCLRDCN                                                          
         CLC   PBOFC2,GCLOFCEN                                                  
         BH    GCLRDCN                                                          
*                                                                               
         B     GCLRDOFX                                                         
*                                                                               
*        ALL BUT AN OFFICE REQUEST                                              
*                                                                               
GCLRDOF1 DS    0H                                                               
*                                                                               
         CLC   PCLTOFF,PBQCLT+2     IF 'ALL BUT' OFFICE                         
         BE    GCLRDCN                   REJECT IF OFFICE MATCHES               
*                                                                               
GCLRDOFX DS    0H                                                               
*                                                                               
         B     GCLRDSFL                                                         
*                                                                               
GCLRDOFN DS    0H                                                               
*                                                                               
*        CLIENT MUST BELONG TO OFFICE LIST                                      
*                                                                               
         CLI   PBQCLT,C'$'         TEST OFFICE LIST                             
         BNE   GCLRDOLN                                                         
*                                                                               
         XC    WORK,WORK                                                        
         LA    R3,WORK             ESTABLISH OFFICER PARAMETER LIST             
         USING OFFICED,R3                                                       
*                                                                               
         MVI   OFCSYS,C'P'         PASS SYSTEM CODE                             
         MVC   OFCAUTH,PBQCLT      PASS OFFICE LIST CODE                        
         MVC   OFCAGY,PBAGY        PASS AGENCY CODE                             
         MVC   OFCLMT(3),PBQCLT    PASS OFFICE LIST CODE                        
         MVC   OFCOFC,PCLTOFF      PASS CLIENT OFFICE                           
*                                                                               
         GOTO1 VOFFICER,PARM,(C'N',OFFICED),(0,PBCOMFAC) CHK OFC LIST           
         CLI   0(R1),0             TEST INCLUDE THIS CLIENT                     
         BNE   GCLRDCN               NO                                         
*                                                                               
         DROP  R3                                                               
*                                                                               
GCLRDOLX DS    0H                                                               
*                                                                               
         B     GCLRDSFL                                                         
*                                                                               
GCLRDOLN DS    0H                                                               
*                                                                               
*        BILLING GROUP REQUEST                                                  
*                                                                               
         CLI   PBQCLT,C'&&'        IF GROUP REQUEST                             
         BNE   GCLRDBGX                                                         
*                                                                               
         CLC   PBQCLT+1(1),PCLTBLGP CLIENT MUST HAVE CORRECT BILLING            
*                                     GROUP                                     
         BNE   GCLRDCN                  NO                                      
         B     GCLRDSFL                                                         
*                                                                               
GCLRDBGX DS    0X                                                               
*                                                                               
*        SLAVE FILTERING                                                        
*                                                                               
GCLRDSFL DS    0H                                                               
*                                                                               
         CLI   PBSLAVE,C'Y'         SKIP IF NOT PROCESSING SLAVES               
         BNE   GCLRDDN                                                          
*                                                                               
         CLI   MASTCLIR,C'R'        IF MASTER NOT READ YET THEN THIS            
         BNE   GCLRDCN                 MUST BE MASTER                           
*                                                                               
         CLI   PCLTPROF+5,C'2'      SKIP IF NOT A SLAVE CLIENT                  
         BNE   GCLRDCN                                                          
*                                                                               
         CLC   PCLTPROF+6(3),PBQCLT SKIP IF NOT RIGHT MASTER                    
         BNE   GCLRDCN                                                          
*                                                                               
******   CLC   PCLTPROF+6(3),PBQXCL SKIP IF DROPPING MASTER                     
******   BE    GCLRDCN                                                          
*                                                                               
         B     GCLRDDN                                                          
*                                                                               
GCLRDSLX DS    0H                                                               
*                                                                               
GCLRDCN  DS    0H                                                               
         CLC   PBCLT,PBQCLT        SINGLE CLIENT REQUEST?                       
         BE    GCLEOL              YES - DO NOT PROCESS AGAIN!                  
*                                                                               
*        IF CLIENT GROUP REQUEST GO FIND NEXT CLIENT                            
*                                                                               
         OC    PBQGPCLT,PBQGPCLT   IF GROUP SCHEME PRESENT                      
         BZ    GCLRDCN1                                                         
*                                                                               
         GOTOR CLTGRP                 FIND NEXT CLIENT IN GROUP                 
*                                                                               
         OC    PBCLT,PBCLT            DONE IF END OF LIST REACHED               
         BZ    GCLEOL                                                           
*                                                                               
GCLRDCN1 DS    0H                                                               
*                                                                               
         B     GCLRDLP                                                          
*                                                                               
*        A CLIENT HAS BEEN FOUND                                                
*                                                                               
GCLRDDN  DS    0H                  HAVE A VALID CLIENT                          
*                                                                               
*        CHECK HERE IF NON-ADV REPORT BUT CLIENT HAS ADV ON OTHER FILES         
*                                                                               
*                                                                               
*        FILL IN IMPORTANT CLIENT FIELDS FOR REPORT                             
*                                                                               
         OC    PBQQCLT,PBQQCLT     SKIP IF SINGLE CLIENT                        
         BZ    *+10                                                             
         OC    PBQQAGY,PBQQAGY        FOR SINGLE AGENCY                         
         BNZ   *+16                                                             
         CLI   PBQADVSW,C'Y'       IF AOR REPORT                                
         BNE   *+8                                                              
         L     R2,PAORCLTA         POINT TO AOR CLIENT HEADER                   
*                                                                               
         MVC   PBCLTNM,PCLTNAME    FILL IN NAME                                 
         MVC   PBCOFF,PCLTOFF      OFFICE                                       
         MVC   PBCPROF,PCLTPROF    PROFILE                                      
         MVC   PBCBLGP,PCLTBLGP    BILLING GROUP                                
*                                                                               
*        ADD CLIENT TO CLIENT BUFFER                                            
*                                                                               
         USING CLTBUFFD,R4         ESTABLISH CLIENT BUFFER                      
         ICM   R4,15,PBACLTBF      GET BUFFER ADDRESS                           
         BZ    GCLSETX             NONE AVAILABLE                               
*                                                                               
         L     R5,PBCCLTBF         GET NUMBER OF ENTRIES SO FAR                 
         LA    R5,1(R5)            ADD 1 FOR CURRENT CLIENT                     
         ST    R5,PBCCLTBF         UPDATE NUMBER OF ENTRIES                     
*                                                                               
         MH    R5,=Y(CBFLEN)       PROPOSED BUFFER LENGTH                       
*                                                                               
         C     R5,PBLCLTBF         COMPARE TO ALLOWED BUFFER LENGTH             
         BL    *+6                                                              
         DC    H'0'                NO ROOM LEFT IN BUFFER                       
*                                                                               
         SH    R5,=Y(CBFLEN)                                                    
         LA    R4,0(R5,R4)         POINT TO NEXT ENTRY IN BUFFER                
*                                                                               
         MVC   CBFMED,PCLTKMED     MOVE MEDIA                                   
         CLI   PBQMED,C'C'          IF COMBINED MEDIA                           
         BNE   *+8                                                              
         MVI   CBFMED,C'C'             ALL MEDIA ARE THE SAME                   
         MVC   CBFCLT,PCLTKCLT      CLIENT                                      
         MVC   CBFNAME,PCLTNAME     AND CLIENT NAME                             
*                                                                               
         LA    R4,CBFLEN(R4)       POINT TO NEXT ENTRY                          
         XC    0(CBFLEN,R4),0(R4)  INITIALIZE ENTRY                             
*                                                                               
*        READ P0 PROFILE FOR CLIENT                                             
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'P000'    REQUEST P0 PROFILE                           
         MVC   WORK+4(2),PBAGY     AGENCY                                       
         MVC   WORK+6(1),PBMED     MEDIA                                        
         MVC   WORK+7(3),PBCLT     CLIENT                                       
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),PCLTOFF  CLIENT OFFICE                                
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     R0,CDATAMGR-COMFACSD(RF)    DATAMGR ADDRESS                      
         L     RF,CGETPROF-COMFACSD(RF)    GETPROF ADDRESS                      
*                                                                               
         GOTO1 (RF),PARM,WORK,PBPPROF,(R0)                                      
*                                                                               
*        READ B2B PROFILE FOR CLIENT                                            
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'PB2B'    REQUEST B2B PROFILE                          
         NI    WORK,X'FF'-X'40'    MAKE 'P' LOWERCASE                           
*                                  NEEDED FOR 3CH PROF IDS                      
         MVC   WORK+4(2),PBAGY     AGENCY                                       
         MVC   WORK+6(1),PBMED     MEDIA                                        
         MVC   WORK+7(3),PBCLT     CLIENT                                       
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),PCLTOFF  CLIENT OFFICE                                
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     R0,CDATAMGR-COMFACSD(RF)    DATAMGR ADDRESS                      
         L     RF,CGETPROF-COMFACSD(RF)    GETPROF ADDRESS                      
*                                                                               
         GOTO1 (RF),PARM,WORK,WORK+16,(R0)                                      
*                                                                               
         MVC   PBPCCBLD,WORK+16+13   SAVE CLIENT BILLING EFF DATE               
*                                                                               
         CLI   PBPCCBLD,80         SET CENTURY                                  
         BNL   GCLSETX                                                          
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PBPCCBLD         SET CENTURY                                  
         AHI   RF,100                                                           
         STC   RF,PBPCCBLD                                                      
*                                                                               
GCLSETX  DS    0H                                                               
*                                                                               
*        CHECK CLIENT HEADER FOR ADVERTISER ELEMENT                             
*                                                                               
GCLADVT  DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       THIS DATA ALREADY GOTTEN IF                  
         BE    GCLADVTX              DOING AN ADVERTISER REPORT                 
*                                                                               
         LR    R6,R2               POINT TO CLIENT HEADER                       
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
         MVI   ELCODE,X'15'        SET TO LOOK FOR ADVERTISER ELM               
         BAS   RE,NXTELM           FIND ELEMENT                                 
         BNE   GCLADVTX            NONE FOUND                                   
*                                                                               
         USING PCLTADVE,R6         ESTABLISH ADVERTISER ELEMENT                 
*                                                                               
         TM    PCLTACON,X'20'      SKIP UNLESS AGENCY CAN READ                  
         BNO   GCLADVTX               AOR CONTRACT                              
*                                                                               
         MVI   PBQCLTSW,C'Y'       INDICATE ADVERTISER CLIENT                   
*                                                                               
         MVC   PAORQADV,PCLTADV    SET ADVERTISER'S CODE                        
         MVC   PAORAGY,PCLTAOR     SET AOR AGENCY CODE                          
         MVC   PAORSE,PCLTAORS     SET AOR SE     CODE                          
         MVC   PAOAGY,PBAGY        SET AGENCY                                   
         L     RF,PBUTLA                                                        
         MVC   PAOSE,4(RF)         GET AGENCY SE                                
         MVC   PAORCLT,PCLTADVC    SET AOR'S CLIENT CODE                        
         MVC   PAOCLT,PBCLT        SET BUYING AGENCY'S CLIENT CODE              
         OC    PAOCLT,=C'   '                                                   
         MVC   PAOCLTST,PCLTASDT   SET CLIENT START DATE                        
         MVC   PAOCLTEN,PCLTAEDT   SET CLIENT END   DATE                        
         MVC   PAOCCNTL,PCLTACON   SET CONTROL BYTES                            
*                                                                               
*        OPEN AOR'S FILES IF NEEDED                                             
*                                                                               
         CLC   PAOSE,PAORSE        SKIP IF CLT SYSTEM = AOR SYSTEM              
         BE    GCLOPENX              BECAUSE IT'S FILES ARE OPEN                
*                                                                               
         L     R8,PBUTLA           POINT TO UTL                                 
         MVC   4(1,R8),PAORSE      SET AOR SYSTEM NUMBER                        
*                                                                               
         L     RF,PBCOMFAC         GET DATAMGR ADDRESS                          
         L     RF,CDATAMGR-COMFACSD(RF)                                         
*                                  OPEN AOR FILES                               
         GOTO1 (RF),PARM,=C'DMOPEN',=C'PRINT',PRTFILES,IOWORK                   
*                                                                               
         MVC   4(1,R8),PAOSE       RESET TO AGENCY FILES                        
*                                                                               
GCLOPENX DS    0H                                                               
*                                                                               
GCLADVTX DS    0H                                                               
*                                                                               
*        CHECK CLIENT HEADER FOR MEDIA NAME OVERRRIDE ELEMENT                   
*                                                                               
GCLMNO   DS    0H                                                               
*                                                                               
         CLC   PCLTKCLT,PBQCLT     SKIP UNLESS REQUEST FOR THIS CLIENT          
         BNE   GCLMNOX                                                          
*                                                                               
         LR    R6,R2               POINT TO CLIENT HEADER                       
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
         MVI   ELCODE,X'41'        SET TO LOOK FOR MEDIANAME OVR ELM            
         BAS   RE,NXTELM           FIND ELEMENT                                 
         BNE   GCLMNOX             NONE FOUND                                   
*                                                                               
         USING PCLTMEL,R6          ESTABLISH ADVERTISER ELEMENT                 
*                                                                               
*        SET MEDIA NAME TO OVERRIDE                                             
*                                                                               
         ICM   R4,15,PBAMEDBF      GET MEDIA BUFFER ADDRESS                     
         USING MEDBUFFD,R4                                                      
*                                                                               
GCLMNOLP DS    0H                                                               
*                                                                               
         CLI   MBFMED,0            CHECK FOR END OF BUFFER                      
         BNE   *+6                                                              
         DC    H'0'                SHOULD NOT BE HERE                           
*                                                                               
         CLC   MBFMED,PCLTKMED     FIND MEDIA IN TABLE                          
         BE    GCLMNOFD                                                         
*                                                                               
GCLMNOCN DS    0H                                                               
*                                                                               
         LA    R4,MBFLEN(R4)       BUMP TO NEXT POSITION IN BUFFER              
         B     GCLMNOLP                                                         
*                                                                               
GCLMNOFD DS    0H                  ADD MEDIA TO BUFFER                          
*                                                                               
         MVC   GCLMEDSV,PCLTKMED   SAVE MEDIA                                   
         MVC   GCLMDNSV,MBFNAME    SAVE MEDIA NAME                              
*                                                                               
         MVC   MBFNAME,BLANKS                                                   
         MVC   MBFNAME(L'PCLTMNAM),PCLTMNAM MOVE IN OVERRIDE NAME               
*                                                                               
*        INTERPRET INTERACTIVE ABBREVIATIONS                                    
*                                                                               
         CLC   MBFNAME(10),=C'INTERACTIV'                                       
         BE    *+10                                                             
         CLC   MBFNAME(9),=C'INTERACTV' COVERS INTERACTV AND INTERACTVE         
         BE    *+10                                                             
         CLC   MBFNAME(6),=C'INTRAC' COVERS INTRACTIVE (AND OTHERS)             
         BNE   *+10                                                             
         MVC   MBFNAME(11),=C'INTERACTIVE'                                      
*                                                                               
GCLMNOX  DS    0H                                                               
*                                                                               
         DROP  R4                                                               
         DROP  R6                                                               
*                                                                               
*        HOOK TO USER FOR CLIENT HANDLING                                       
*                                                                               
GCLCONGO DS    0H                                                               
*                                                                               
         MVI   PBMODE,PBPROCCL     INDICATE CLIENT TO BE PROCESSED              
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    GCLCONGO            PASS BACK SAME RECORD                        
*                                                                               
         ICM   RF,15,PBACONTB      BUILD CONTRACT TABLE                         
         BZ    GCLCONX             IF TABLE ADDRESS PASSED                      
*                                                                               
         GOTO1 =A(BLDCON),RR=RELO                                               
*                                                                               
GCLCONX  DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
         B     GETCLTX                                                          
*                                                                               
*        END OF CLIENT(S) PROCESSING                                            
*                                                                               
GCLEOL   DS    0H                                                               
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
GETCLTX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
GCLMEDSV DC    XL1'00'             MEDIA      SAVEAREA                          
GCLMDNSV DC    XL11'00'            MEDIA NAME SAVEAREA                          
*                                                                               
GCLOFCST DS    CL2                 START OF OFFICE RANGE                        
GCLOFCEN DS    CL2                 END   OF OFFICE RANGE                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - FILTER ON CLIENT GROUP - XCGRFLT'            
***********************************************************************         
*                                                                     *         
*        TEST IF CLIENT BELONGS TO EXCLUDED CLIENT GROUP              *         
*                                                                     *         
*NTRY IOKEY    =  CLTREC KEY FOR DESIRED CLIENT                       *         
*                                                                     *         
*EXIT CC       =  NE = CLIENT FAILS FILTER                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
XCGRFLT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
*                                                                               
         MVC   XCGKEYSV,IOKEY      SAVE CLIENT KEY                              
*                                                                               
         LA    R2,XCGKEYSV         ESTABLISH CLIENT RECORD KEY                  
         USING PCLTRECD,R2                                                      
*                                                                               
         LA    R4,IOKEY            ESTABLLISH CLT GRP PASSIVE                   
         USING GRPPKEY,R4                                                       
         XC    GRPPKEY,GRPPKEY     INIT KEY                                     
*                                                                               
         MVC   GRPPAGY,PCLTKAGY    SET AGENCY                                   
         MVC   GRPPMED,PCLTKMED    SET CLIENT                                   
         MVI   GRPPTYP,GRPPCGQ     CLIENT GROUP                                 
         MVC   GRPPVAL,BLANKS      INIT VALUE CODE                              
         MVC   GRPPVAL(L'PCLTKCLT),PCLTKCLT    SET CLIENT                       
         MVC   GRPPID,PBQXCGS      SET GROUP ID                                 
         PACK  GRPPCODE(3),PBQXCGC(5)    SET GROUP CODE (PWOS)                  
         MVI   GRPPCODE+L'GRPPCODE+1,0 KILL EXTRANEOUS BYTE                     
*                                                                               
*                                                                               
*        FIND ACTUAL LENGTH OF BASIC KEY                                        
*                                                                               
         LA    R3,L'GRPPKEY        MAX LENGTH OF FILTER                         
         LA    R1,GRPKEY(R3)       LAST BYTE OF FILTER                          
         BCTR  R1,0                                                             
*                                                                               
         CLI   0(R1),0             DONE IF SOMETHING PRESENT                    
         BNE   *+10                                                             
         BCTR  R1,0                BACK UP A BYTE                               
         BCT   R3,*-10                                                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FOR PASSIVE                             
*                                                                               
         BCTR  R3,0                DECREMENT FOR EXECUTE                        
         EX    R3,*+8                                                           
         B     *+10                                                             
         CLC   GRPPKEY(0),IOKEYSAV DROP IF BASE PASSIVE MATCHES                 
         BE    XCGRDROP                                                         
*                                                                               
XCGROK   DS    0H                  KEEP CLIENT IN REPORT                        
*                                                                               
         MVC   IOKEY,XCGKEYSV      RESTORE CLIENT KEY                           
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RE-READ DIRECTORY                            
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     XCGRFLTX                                                         
*                                                                               
XCGRDROP DS    0H                  DROP CLIENT FROM REPORT                      
*                                                                               
         MVC   IOKEY,XCGKEYSV      RESTORE CLIENT KEY                           
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RE-READ DIRECTORY                            
*                                                                               
         LTR   RB,RB               SET NE CC                                    
*                                                                               
         B     XCGRFLTX                                                         
*                                                                               
*                                                                               
XCGRFLTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
XCGKEYSV DC    XL(L'IOKEY)'00'    KEY SAVEAREA                                  
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GET NEXT PRODUCT - GETPRD'                   
***********************************************************************         
*                                                                     *         
*        FIND NEXT PRODUCT                                            *         
*                                                                     *         
*NTRY PBQPRD   =  'ALL' OR SPACES MEANS ALL PRODUCTS                  *         
*              =  ELSE IS A PRODUCT CODE                              *         
*                                                                     *         
*EXIT PBPROD   =   PRODUCT CODE                                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
GETPRD   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
*                                                                               
         OC    PBAPRDBF,PBAPRDBF   IF PRODUCT BUFFER PRESENT USE IT             
         BNZ   GPRBUFF                FOR PRODUCT SEARCH                        
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS PRODUCT RECORD          
         USING PPRDRECD,R2                                                      
*                                                                               
         MVC   IOADDR,AIO1         READ INTO IO1                                
*                                                                               
         MVC   PPRDKAGY,PBAGY      SET AGENCY                                   
         MVC   PPRDKMED,PBMED      SET MEDIA                                    
         MVI   PPRDKRCD,PPRDKIDQ   SET RECORD ID                                
         MVC   PPRDKCLT,PBCLT      SET CLIENT                                   
*                                                                               
*        SINGLE PRODUCT                                                         
*                                                                               
         CLC   =C'ALL',PBQPRD      SKIP IF ALL PRODUCTS WANTED                  
         BE    GPRALL                                                           
         CLC   PBQPRD,BLANKS                                                    
         BE    GPRALL                                                           
*                                                                               
         OC    PBPROD,PBPROD       TEST FIRST TIME                              
         BNZ   GPREND              NO - DONE                                    
*                                                                               
         MVC   PPRDKPRD,PBQPRD     SET REQUESTED PRODUCT                        
*                                                                               
         B     GPRPRD                                                           
*                                                                               
*        MULTIPLE PRODUCTS                                                      
*                                                                               
GPRALL   DS    0H                                                               
*                                                                               
         MVC   PPRDKPRD,PBPROD     SET LAST PRODUCT PROCESSED                   
*****                                                                           
*****    CLI   PBMODE,PBPROCIV     IF PROCESSING INVOICES                       
*****    BNE   GPRALL05                                                         
*****    ICM   RF,15,PBIKYELA         POINT TO INVOICE KEY                      
*****    BZ    GPRALL05                  NONE FOUND                             
*****    CLC   =C'***',PINVPRD-PINVKEY(RF) IF PRODUCT VARIOUS                   
*****    BNE   GPRALL05                                                         
*****    B     GPRALL10                   SKIP FORCING TO NEXT PRODUCT          
*****                                                                           
GPRALL05 DS    0H                                                               
*                                                                               
         MVI   PPRDKPRD+L'PPRDKPRD,X'FF' FORCE READ OF NEXT ONE                 
*                                                                               
GPRALL10 DS    0H                                                               
*                                                                               
*        READ POINTERS FOR PRODUCT POINTER                                      
*                                                                               
GPRPRD   DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   SET FILE TO FIRST CANDIDATE                  
*                                                                               
         CLC   IOKEY(PPRDKPRD-PPRDKEY),IOKEYSAV   DONE IF NOT SAME              
         BNE   GPREND              AGY/MED/TYP/CLT                              
*                                                                               
         CLC   =C'ALL',PBQPRD      SKIP IF ALL PRODUCTS WANTED                  
         BE    *+10                                                             
         CLC   PBQPRD,BLANKS                                                    
         BE    GPRPRD10                                                         
*                                                                               
         CLC   PPRDKPRD,PBQPRD     ELSE PRODUCT MUST MATCH REQUEST              
         BE    GPRPRD10                                                         
*                                                                               
         CLI   NOPRDERR,C'Y'       IF IGNORING PRD/EST ERRS                     
         BE    GPREND                  EXIT                                     
         DC    H'0'                ELSE HAVE A SERIOUS PROBLEM                  
*                                                                               
GPRPRD10 DS    0H                                                               
*                                                                               
         MVC   PBPROD,PPRDKPRD     SAVE FOUND PRODUCT                           
*                                                                               
*        FILTER ON OTHER AGENCY'S PRODUCT                                       
*                                                                               
         CLI   PBQOAPRD,C'Y'       ACCEPT IF PROCESSING OTHER AGENCY            
         BE    *+12                  PRODUCTS                                   
         CLI   PPRDKPRD,C'*'       ELSE REJECT IF IT IS ANOTHER                 
         BE    GPREND                AGENCY'S PRODUCT                           
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET  READ PRODUCT RECORD                          
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
*                                                                               
         MVC   PBPRDNM,PPRDNAME    SAVE PRODUCT NAME                            
         MVC   PBOANCOD,PPRDOAN    SAVE OTHER AGENCY CODE                       
*                                                                               
         CLC   PBQDIV,=C'   '      IF DOING DIVISIONS                           
         BNH   *+10                                                             
         MVC   PBDIV,PPRDDIV         SAVE PRODUCT'S DIVISION CODE               
*                                                                               
*        FIND PLANNED COST BILLING EFFECTIVE DATE                               
*                                                                               
         MVI   ELCODE,PPBPCECQ     BILLING EFD ELEMENT CODE                     
         LA    R6,PPRDKEY                                                       
         USING PPBPCELC,R6         ESTABLISH BILLING EFD ELEMENT                
*                                                                               
         BRAS  RE,GETEL            FIND ELEMENT                                 
         BNE   *+10                ELEMENT NOT FOUND                            
         MVC   PBPCPBLD,PPBPCEFF   SET BILL EFFECTIVE DATE                      
*                                                                               
         B     GPRBUFFX                                                         
         EJECT                                                                  
*                                                                               
*        GET NEXT PRODUCT FROM PRODUCT BUFFER                                   
*                                                                               
GPRBUFF  DS    0H                                                               
*                                                                               
         L     R4,PBAPRDBF         ESTABLISH PRODUCT BUFFER                     
         USING PRDBUFFD,R4                                                      
*                                                                               
         OC    PBCPRDBF,PBCPRDBF   DONE IF NO PRODUCTS IN BUFFER                
         BZ    GPREND                                                           
*                                                                               
         OC    PBPROD,PBPROD       USE FIRST ENTRY IF FIRST TIME                
         BZ    GPRBUFFD                                                         
*                                                                               
         CLC   =C'ALL',PBQPRD      GO LOOK FOR NEXT IF                          
         BE    *+10                                                             
         CLC   PBQPRD,BLANKS         MULTIPLE PRODUCTS REQUESTED                
         BE    *+8                                                              
         B     GPREND              ELSE END OF PRODUCTS                         
*                                                                               
*        FIND LAST USED PRODUCT IN BUFFER                                       
*                                                                               
         L     R5,PBCPRDBF         GET NUMBER OF ENTRIES IN BUFFER              
*                                                                               
         CLC   PBPROD,PBFPRD       FIND PRODUCT IN BUFFER                       
         BE    GPRBUF00                                                         
         LA    R4,PBFLEN(R4)          NEXT BUFFER ENTRY                         
         BCT   R5,*-14                                                          
*                                                                               
         CLI   PBMODE,PBPROCNV     PROCESSING NEW INVOICE RECORD?               
         BE    GPREND              YES - RETURN NOT FOUND                       
         DC    H'0'                MUST FIND IT                                 
*                                                                               
GPRBUF00 CLI   PBMODE,PBPROCNV     IF PROCESSING NEW INVOICE RECORD             
         BE    GPRBUF10               SKIP BUMPING TO NEXT PRODUCT              
*                                     WE ARE JUST FINDING PRD IN BUFFER         
*                                                                               
         CLI   PBMODE,PBPROCIV     IF PROCESSING INVOICES                       
         BNE   GPRBUF05                                                         
         ICM   RF,15,PBIKYELA         POINT TO INVOICE KEY                      
         BZ    GPRBUF05                  NONE FOUND                             
*                                                                               
         CLC   =C'***',PINVPRD-PINVKEY(RF) IF PRODUCT VARIOUS                   
         BE    GPRBUF10                   SKIP FORCING TO NEXT PRODUCT          
*                                                                               
GPRBUF05 DS    0H                                                               
*                                                                               
         LA    R4,PBFLEN(R4)       BUMP TO NEXT BUFFER ENTRY                    
         OC    0(3,R4),0(R4)       TEST END OF BUFFER                           
         BZ    GPREND              DONE IF AT END OF BUFFER                     
*                                                                               
GPRBUF10 DS    0H                                                               
*                                                                               
GPRBUFFD DS    0H                  BUFFER ENTRY FOUND                           
*                                                                               
         MVC   PBPROD,PBFPRD       SET PRODUCT                                  
         MVC   PBDIV,PBFDIV        SET DIVISION                                 
         MVC   PBPRDNM,PBFNAME     SET PRODUCT NAME                             
         MVC   PBACCTNO,PBFACCTN   SET PRODUCT ACCOUNT NUMBER                   
         MVC   PBOANCOD,PBFOANCD   SET OAN CODE                                 
         MVC   PBGPCODE,PBFGPCDE   SET GROUP CODE                               
         MVC   PBPCPBLD,PBFPCBLD   SET PLANNED COST BILL EFD                    
*                                                                               
GPRBUFFX DS    0H                                                               
*                                                                               
*        FIND DIVISION NAME IF DOING DIVISIONS                                  
*                                                                               
GPRDIV   DS    0H                                                               
*                                                                               
         XC    PBDIVNM,PBDIVNM     INIT DIVISION NAME                           
*                                                                               
         CLC   PBQDIV,=C'   '      SKIP IF NOT DOING DIVISIONS                  
         BNH   GPRDIVX                                                          
*                                                                               
*        LOOK UP DIVISION NAME IN BUFFER                                        
*                                                                               
*        BUFFER FOR DRD MUST BE SET UP WHEN PROCESSING CLI                      
*        AND REQUESTING DIVISION                                                
*                                                                               
         ICM   R1,15,PBADRDBF      ADDRESS OF DRD BUFFER                        
         BZ    GPRDIVNF            NO BUFFER SET UP                             
         USING DRDBUFFD,R1         ESTABLISH DRD BUFFER ENTRY                   
*                                                                               
         ICM   R4,15,PBCDRDBF      NUMBER OF RECORDS                            
         BZ    GPRDIVNF            NO DIVISIONS IN TABLE                        
*                                                                               
GPRDIVLP DS    0H                                                               
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   SKIP IF NO DRD CLT SPECIFIED                 
         BZ    GPRDIV10                                                         
*                                                                               
*        OTHER CLIENT DRD ENTRIES MARKED WITH X'FF' IN FIRST BYTE               
*                                                                               
GPRDIVCL DS    0H                                                               
*                                                                               
         CLI   0(R1),X'FF'         LOOK FOR SPECIAL INDICATOR                   
         BNE   *+14                                                             
         CLC   1(3,R1),PBDIV       MATCH ON DIVISION ID                         
         BE    GPRDIVFD            DIV FOUND - GO PROCESS                       
         LA    R1,DRDLEN(R1)       BUMP TO NEXT TABLE ENTRY                     
         BCT   R4,*-22                                                          
         B     GPRDIVNF            REACHED END OF TABLE                         
*                                                                               
GPRDIV10 DS    0H                                                               
*                                                                               
         CLC   DRDDIV,PBDIV        MATCH DIVISION                               
         BNE   *+14                                                             
         OC    DRDRGN,DRDRGN         WITHOUT REGION CODE                        
         BZ    GPRDIVFD                                                         
*                                                                               
         LA    R1,DRDLEN(R1)       BUMP TO NEXT TABLE ENTRY                     
         BCT   R4,*-24                                                          
         B     GPRDIVNF            REACHED END OF TABLE                         
*                                                                               
GPRDIVFD DS    0H                                                               
*                                                                               
         MVC   PBDIVNM,DRDNAME     SAVE DIVISION NAME                           
         B     GPRDIVX                                                          
*                                                                               
GPRDIVNF DS    0H                  DIVISION NOT FOUND                           
*                                                                               
         MVC   PBDIVNM,=CL20'UNASSIGNED DIVISION'                               
*                                                                               
GPRDIVX  DS    0H                                                               
*                                                                               
*        READ OTHER AGENCY RECORD (OANREC) TO GET NAME                          
*                                                                               
GPROAN   DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDOAN    SKIP UNLESS READING OAN PRODUCTS             
         BNO   GPROANX                                                          
*                                                                               
         CLI   PBOANAME,0          SKIP IF WE HAVE OAN NAME                     
         BE    *+14                                                             
         CLC   PBOANAME+32(2),PBOANCOD  FOR PRODUCT'S OTHER AGENCY              
         BE    GPROANX                                                          
*                                                                               
         GOTO1 =A(READREC),PARM,1,RR=RELO  ELSE READ OAN REC                    
*                                                                               
GPROANX  DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     GETPRDX             ALL DONE                                     
*                                                                               
GPREND   DS    0H                  END OF PRODUCTS                              
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
GETPRDX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C- PRWRIIO - READ BUYS SEQUENTIALLY - READBUYS'           
***********************************************************************         
*                                                                     *         
*        READ BUYS SEQUENTIALLY                                       *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT    IO1    CONTAINS BUY RECORD                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
READBUYS NMOD1 0,**+RBY**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        READ PRODUCT RECORD IF REQUIRED                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RBYPRD   DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY         ESTABLISH KEY AREA AS PRODUCT RECORD         
         LA    R2,IOKEY                                                         
         USING PPRDRECD,R2                                                      
*                                                                               
         OC    PBPRDADR,PBPRDADR   SKIP IF NO PRODUCT SAVEAREA                  
         BZ    RBYPRDX               PROVIDED                                   
*                                                                               
*        BUILD PRODUCT RECORD KEY                                               
*                                                                               
         MVC   PPRDKAGY,PBAGY     AGENCY                                        
         MVC   PPRDKMED,PBMED     MEDIA                                         
         MVI   PPRDKRCD,PPRDKIDQ  RECORD ID                                     
         MVC   PPRDKCLT,PBCLT     CLIENT                                        
         MVC   PPRDKPRD,PBPROD    PRODUCT                                       
*                                                                               
         L     RF,PBPRDADR        POINT TO PRODUCT RECORD SAVEAREA              
*                                                                               
         CLC   PPRDKEY,0(RF)      DONE IF CURRENT RECORD IS THE                 
         BE    RBYPRDX              WANTED ONE                                  
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI  READ PRODUCT DIRECTORY POINTER                
*                                                                               
         CLC   IOKEY(L'PPRDKEY),IOKEYSAV  MUST FIND POINTER                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1  READ IN PRODUCT RECORD                   
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L      R2,AIO1            POINT TO FOUND PRODUCT RECORD                
         USING  PPRDRECD,R2                                                     
*                                                                               
*        SAVE PRODUCT RECORD                                                    
*                                                                               
         L     R0,PBPRDLEN         GET SAVE AREA LENGTH                         
*                                                                               
         ICM   R1,15,PBPRDADR      POINT TO PRODUCT RECORD SAVEAREA             
         BAS   RE,CLRBUFF          CLEAR AREA                                   
*                                                                               
         L     R0,PBPRDLEN         GET SAVE AREA LENGTH                         
         CLM   R0,3,PPRDLEN        COMPARE TO REC LENGTH                        
         BNH   *+8                 AND USE SMALLER                              
         ICM   R0,3,PPRDLEN                                                     
*                                                                               
         ICM   R1,15,PBPRDADR      POINT TO PRODUCT RECORD SAVEAREA             
         BAS   RE,MOVEREC          SAVE PRODUCT RECORD                          
*                                                                               
RBYPRDX  DS    0H                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        FIND NEXT PUB FOR PUBLISHER IF REQUESTED                     *         
*          EACH PUB FOUND IS SET IN PBQPUB SO LOGIC ACTS AS IF        *         
*          A SINGLE PUB WAS REQUESTED                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RBYPBLLP DS    0H                                                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BZ    RBYGRPX                                                          
*                                                                               
         GOTO1 =A(PUBGRP),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RBYPBL10               ONE FOUND                                 
         B     RBYPBLDN               END OF PUBS                               
*                                                                               
RBYGRPX  DS    0H                                                               
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST PROCESSING                       
         BZ    RBYLISX                                                          
*                                                                               
         GOTO1 =A(PUBLIS),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RBYPBL10               ONE FOUND                                 
         B     RBYPBLDN               END OF PUBS                               
*                                                                               
RBYLISX  DS    0H                                                               
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   SKIP IF NO PUBLISHER GIVEN                   
         BZ    RBYPBL10                                                         
*                                                                               
         GOTO1 =A(PBLFLTR),RR=RELO PUBLISHER FILTER REQUESTED                   
         BNE   RBYPBLDN       REACHED END OF PUBS FOR PUBLISHER                 
*                                                                               
RBYPBL10 DS    0H                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        IF WE ARE DOING A SINGLE/PUB AND AOR PROCESSING              *         
*          FIND NEXT PUB/ZONE/EDITION TO LOOK AT                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RBYZEDLP DS    0H                                                               
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    RBYZED10                                                         
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   RBYZED10                                                         
         CLI   PBQALLZN,C'Y'       IF ALL ZONES AND EDITIONS                    
         BNE   RBYZED10                                                         
*                                                                               
         GOTO1 =A(GETNXTZN)           FIND NEXT ZONE/EDITION                    
         BZ    RBYZEDDN                   NO MORE                               
*                                                                               
RBYZED10 DS    0H                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        READ BUY RECORDS FOR PUB                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RBYBUY   DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS BUY RECORD KEY          
         USING PBUYRECD,R2                                                      
*                                                                               
         MVC   PBUYKAGY,PBAGY      FILL IN AGENCY                               
         MVC   PBUYKMED,PBMED      MEDIA                                        
         MVI   PBUYKRCD,PBUYKIDQ   RECORD ID                                    
         MVC   PBUYKCLT,PBCLT      CLIENT                                       
         MVC   PBUYKPRD,PBPROD     PRODUCT                                      
         MVC   PBUYKPUB,PBQPUB     PUB                                          
         MVC   PBUYKZON,PBQZON     ZONE                                         
         MVC   PBUYKEDT,PBQEDT     EDITION                                      
*                                                                               
         OC    PBQPUB,PBQPUB       SKIP IF DOING ALL PUBS                       
         BZ    RBYBUY10                                                         
*                                                                               
         CLI   PBQADVSW,C'Y'       SKIP UNLESS ADVERTISER REPORT                
         BNE   RBYBUY10                                                         
*                                                                               
         GOTO1 GTAGYPUB,PARM,PBQPUB  FIND AGENCY PUB ID                         
         MVC   PBUYKPUB(6),PAOPUB    USE AGENCY'S PUB ID                        
*                                                                               
         BNE   RBYBUYDN            PUB ID NOT FOUND  - REJECT                   
*                                                                               
RBYBUY10 DS    0H                                                               
*                                                                               
*        FIND FIRST BUY RECORD CANDIDATE                                        
*                                                                               
         MVC   RBYSTKEY,IOKEY      SAVE START KEY                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL  READ DIR HI- INCLUDE DELETES           
*                                                                               
RBYBUYLP DS    0H                                                               
*                                                                               
         XC    PBPCEBLD,PBPCEBLD   INIT PC BILL EFD                             
         XC    PBPCACDT,PBPCACDT   INIT PC ACTUALIZATION DATE                   
*                                                                               
         LA    R2,IOKEY            RE-POINT TO KEY AREA                         
*                                                                               
         CLC   RBYSTKEY(PBUYKPUB-PBUYREC),IOKEY SAME A/M/TY/CL/PRD              
         BNE   RBYBUYDN            NO - DONE                                    
*                                                                               
         CLI   IOKEY+25,X'FF'      SKIP IF PURGED RECORD                        
         BE    RBYBUYCN                                                         
         TM    IOKEY+25,X'C0'      SKIP IF CLOSED OUT RECORD                    
         BO    RBYBUYCN                                                         
*                                                                               
* TEST TO SEE IF DIRECTORY RECORD IS DELETED AND IF SO CHECK TO SEE             
* IF BILLABLE OR PAYABLE DATA REQUESTED                                         
*                                                                               
RBYDEL   DS    0H                                                               
*                                                                               
         CLI   PBQTEST,C'D'        IF ONLY DELETED TO BE PROCESSED              
         BNE   RBYDEL10                                                         
*                                                                               
         TM    IOKEY+25,X'80'         REJECT IF NOT DELETED                     
         BNO   RBYBUYCN                                                         
*                                                                               
         B     RBYDELX                ELSE ACCEPT UNCONDITIONALLY               
*                                                                               
RBYDEL10 DS    0H                  ELSE                                         
*                                                                               
         TM    IOKEY+25,X'80'      ACCEPT IF NOT DELETED                        
         BNO   RBYDELX                                                          
*                                                                               
         TM    PBQPOPT,PBQPODEL    INCLUDE DELETED BUYS REGARDLESS L10          
         BO    RBYDELX             OF WHAT WAS REQUESTED           L10          
*                                                                               
*        ACCEPT DELETED BUYS IF BILLABLE, PAYABLE, BILLED OR PAID               
*           DATA BEING REPORTED                                                 
*                                                                               
         TM    PBQSPLOP,PBQIDELA+PBQIDELB+PBQIDELC+PBQIDELD                     
         BNZ   RBYDELX                                                          
*                                                                               
         CLI   PBQFLTDA,0          IF NO FILTERING                              
         BE    RBYBUYCN               BYPASS RECORD                             
*                                                                               
         CLI   PBQFLTDA,C'P'       FILTERING ON PAID DATA                       
         BE    RBYDELX                                                          
*                                                                               
         CLI   PBQFLTDA,C'B'       FILTERING ON BILLED DATA                     
         BE    RBYDELX                                                          
*                                                                               
         CLI   PBQFLTDA,C'I'       FILTERING ON UNBILLED                        
         BE    RBYDELX                                                          
*                                                                               
         CLI   PBQFLTDA,C'A'       FILTERING ON PABYABLE                        
         BE    RBYDELX                                                          
*                                                                               
         B     RBYBUYCN            REJECT RECORD                                
*                                                                               
RBYDELX  DS    0H                                                               
*                                                                               
         MVI   FLAG,C'N'           INIT BUY READ SWITCH                         
*                                                                               
*        FILTER AGAINST REQUESTED PUB                                           
*                                                                               
RBYPUB   DS    0H                                                               
*                                                                               
         OC    PBQPUB,PBQPUB       ACCEPT IF  DOING ALL PUBS                    
         BZ    RBYPUBX                                                          
*                                  IF SINGLE PUB                                
         CLI   PBQADVSW,C'Y'          SKIP UNLESS ADVERTISER REPORT             
         BNE   RBYPUB10                                                         
*                                                                               
         CLC   PBUYKPUB,PAOPUB#    REJECT IF PUB ^= AGENCY PUBID                
         BNE   RBYBUYDN                 FOR REQUESTED PUB                       
*                                                                               
*        CLI   PBQALLZN,C'Y'       ACCEPT IF DOING ALL ZONES + EDTS             
*        BE    RBYPUBX                                                          
*                                                                               
         CLC   PBUYKZON,PAOZON     REJECT IF ZONE                               
         BNE   RBYBUYDN                                                         
*                                                                               
         CLC   PBUYKEDT,PAOED        OR EDITION DON'T MATCH                     
         BNE   RBYBUYDN                                                         
*                                                                               
         B     RBYPUBX                                                          
*                                                                               
RBYPUB10 DS    0H                                                               
*                                                                               
         CLC   PBUYKPUB,PBQPUB        REJECT IF PUB ^= REQUESTED PUB            
         BNE   RBYBUYDN                                                         
*                                                                               
RBYPUB20 DS    0H                                                               
*                                                                               
         CLI   PBQALLZN,C'Y'       ACCEPT IF DOING ALL ZONES + EDTS             
         BE    RBYPUBX                                                          
*                                                                               
         CLC   PBUYKZON,PBQZON     REJECT IF ZONE                               
         BNE   RBYBUYDN                                                         
*                                                                               
         CLC   PBUYKEDT,PBQEDT       OR EDITION DON'T MATCH                     
         BNE   RBYBUYDN                                                         
*                                                                               
RBYPUBX  DS    0H                                                               
*                                                                               
*        TRANSLATE PUB ID IF ADVERTISER REPORT                                  
*                                                                               
RBYADVP  DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       SKIP UNLESS ADVERTISER REPORT                
         BNE   RBYADVPX                                                         
*                                                                               
*****    CLC   PBUYKPUB,PBUYKPUB-PBUYKEY+IOKEYSAV   SKIP IF NOT NEW PUB         
*****    BE    RBYADVP1                                                         
*                                                                               
         GOTO1 GTAORPUB,PARM,PBUYKPUB   FIND AOR PUB ID                         
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL   RE-POINT DIRECTORY                    
*                                                                               
RBYADVP1 DS    0H                                                               
*                                                                               
         OC    PAORPUB,PAORPUB     DROP BUY IF NO LINK FOUND                    
         BZ    RBYBUYCN                                                         
*                                                                               
RBYADVPX DS    0H                                                               
*                                                                               
*        FILTER ON INSERT DATE IF REQUIRED                                      
*                                                                               
RBYDTE   DS    0H                                                               
*                                                                               
         CLI   PBQDATYP,C'I'      SKIP IF NOT USING INSERT DATES                
         BE    *+8                                                              
         CLI   PBQDATYP,C'U'                                                    
         BNE   RBYDTEX                                                          
*                                                                               
         CLC   PBUYKDAT,KEYBST     IF INSERTION DATE BEFORE                     
         BNL   RBYDTE10               REQUEST START                             
*                                                                               
         MVC   PBUYKDAT,KEYBST        BUMP INSERT DATE IN KEY TO                
         XC    PBUYKEST(6),PBUYKEST    SKIP UNWANTED RECORDS                    
         B     RBYBUYNX                                                         
*                                                                               
RBYDTE10 DS    0H                                                               
*                                                                               
         CLC   PBUYKDAT,KEYBEN      IF INSERTION AFTER REQUEST                  
         BNH   RBYDTEX                 END DATE                                 
*                                                                               
         MVC   PBUYKDAT,XFF           FORCE NEXT PUB                            
         B     RBYBUYNX                                                         
*                                                                               
RBYDTEX  DS    0H                                                               
*                                                                               
*        FILTER ON ESTIMATE                                                     
*                                                                               
RBYEST   DS    0H                                                               
*                                                                               
         XC    ESTDATA,ESTDATA     INIT ESTIMATE DATA                           
         LA    R8,ESTDATA          ESTABLISH DUMMY EST BUFFER ENTRY             
         USING ESTBUFFD,R8                                                      
*                                                                               
         MVC   EBFMED,PBUYKMED     SET MEDIA                                    
         MVC   EBFCLT,PBUYKCLT     SET CLIENT                                   
         MVC   EBFPRD,PBUYKPRD     SET PRODUCT                                  
         MVC   EBFEST,PBUYKEST     SET ESTIMATE                                 
*                                                                               
         BAS   RE,FLTREST          FILTER ON ESTIMATE AND PUT IN TABLE          
         BNE   RBYBUYCN              REJECTED                                   
*                                                                               
         LA    R8,SESTDATA         POINT TO SAVED DATA                          
         USING ESTBUFFD,R8         ESTABLISH ESTIMATE DATA                      
*                                                                               
         MVC   PBPCEBLD,EBFPCBLD   SAVE PC BILL EFD                             
         MVC   PBPCACDT,EBFPCACD   SAVE PC ACTUALIZATION DATE                   
*                                                                               
         DROP  R8                                                               
*                                                                               
*        FILTER ON PRODUCT                                                      
*                                                                               
*     IF REQUEST IS FOR ZZZ (POL) THEN BYPASS ALL BUYS WITHOUT NULLS            
*        IN ACTIVE PRODUCT IN KEY IN DIRECTORY. THESE ARE PASSIVE               
*        POINTERS                                                               
*                                                                               
*     IF REQUEST IS FOR A SPECIFIC PRODUCT OTHER THAN ZZZ                       
*        PROCESS ONLY THOSE... SAVE THE PRODUCT CODE IF +21 OF                  
*        KEY IS NOT ZERO.. THIS MEANS THERE IS A PASSIVE PRODUCT                
*        AND GETINS MUST HAVE THAT DATA                                         
*                                                                               
RBYFPR   DS    0H                                                               
*                                                                               
         XC    PASSPRD,PASSPRD     INIT PASSIVE PRODUCT ID                      
*                                                                               
RBYPOL   DS    0H                                                               
*                                                                               
         CLC   PBQPRD,=C'ZZZ'      SKIP UNLESS POL REQUESTED                    
         BNE   RBYPOLX                                                          
*                                                                               
         OC    PBUYKACT,PBUYKACT   REJECT IF  ACTIVE PRODUCT SET IN KEY         
         BNZ   RBYBUYCN               I.E. NOT MASTER POOL POINTER              
*                                                                               
         CLC   PBUYKPRD,=C'ZZZ'    ELSE PRODUCT MUST BE POOL                    
         BNE   RBYBUYCN                                                         
*                                                                               
         B     RBYFPRX                                                          
*                                                                               
RBYPOLX  DS    0H                                                               
*                                                                               
         CLC   PBQPRD,=C'ALL'      SKIP IF                                      
         BE    RBYALL                PROCESSING ALL PRODUCTS                    
*                                                                               
         CLC   PBQPRD,PBUYKPRD     ELSE FILTER ON PRODUCT                       
         BNE   RBYBUYCN                                                         
*                                                                               
         OC    PBUYKACT,PBUYKACT   IF THIS IS A PASSIVE POINTER                 
         BZ    *+10                                                             
         MVC   PASSPRD,PBUYKPRD       SAVE PRODUCT AS PASSIVE PRD               
*                                                                               
         B     RBYFPRX                                                          
*                                                                               
RBYALL   DS    0H                                                               
*                                                                               
         TM    PBQPOPT,PBQPOSPL    IF SPLITTING POL BUYS                        
         BNO   RBYALL10                                                         
*                                                                               
         OC    PBUYKACT,PBUYKACT      BYPASS ALL PASSIVE POINTERS               
         BNZ   RBYBUYCN                                                         
*                                                                               
         B     RBYFPRX                ELSE ACCEPT RECORD                        
*                                                                               
RBYALL10 DS    0H                                                               
*                                                                               
         CLC   PBUYKPRD,=C'ZZZ'    ELSE BYPASS ALL ZZZ POL PROD                 
         BE    RBYBUYCN                                                         
*                                                                               
         OC    PBUYKACT,PBUYKACT   ELSE IF THIS IS A PASSIVE POINTER            
         BZ    *+10                                                             
         MVC   PASSPRD,PBUYKPRD            SAVE PRODUCT AS PASSIVE PRD          
*                                                                               
RBYFPRX  DS    0H                                                               
*                                                                               
*        READ BUY RECORD                                                        
*                                                                               
         MVC   PBABUY,IOKEY+27     SAVE DISK ADDRESS OF BUY                     
*                                  MAY BE USED IN DRIVER                        
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1+IORDEL GET BUY RECORD                     
*                                                                               
         L     R2,AIO1             POINT TO FOUND RECORD                        
*                                                                               
*        FILTER ON SPACE DESCRIPTION IF REQUESTED                               
*                                                                               
RBYSPC   DS    0H                                                               
*                                                                               
         CLI   PBDSPACE,X'FF'      OUTDOOR HAS SPECIAL CODING                   
         BE    RBYSPCOD            IN SPACE // WILL FAIL ALL                    
*                                  TESTS FOR SPACE FILTERING                    
*                                                                               
         TM    PBBYOPTS,PBBYCSPQ   IF BUY MUST BELONG TO CONTRACT               
         BNO   *+12                                                             
         CLI   PBDSPACE,C'*'          DROP IF SPACE(1) IS C'*'                  
         BE    RBYBUYCN                                                         
*                                                                               
         OC    PBDSPACE,BLANKS     FORCE UPPERCASE SPACE DESCRIPTION            
*                                                                               
         GOTO1 SPCFLT,PARM,PBDSPACE FILTER ON SPACE DESCRIPTION                 
         BE    RBYSPCX             PASSES FILTER KEEP                           
         B     RBYSPC50            FAILS FILTER                                 
*                                                                               
RBYSPCOD DS    0H                                                               
*                                                                               
         CLI   PBMED,C'O'          SKIP UNLESS OUTDOOR                          
         BNE   RBYSPC50                                                         
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,X'66'        LOOKING FOR FIRST COMMENT ELEMENT            
*                                                                               
         BAS   RE,NXTELM           FIND 1ST/NEXT COMMENT ELM                    
         BNE   RBYSPC30            NONE FOUND                                   
*                                                                               
         CLI   1(R6),19            MAXIMUM 17 BYTES TO BE CONSIDERED            
         BNH   RBYSPC40                                                         
*                                                                               
RBYSPC30 DS    0H                                                               
*                                                                               
         CLC   PBQSPDS1,BLANKS     ACCEPT IF FIRST SPACE FILTER MISSING         
         BH    *+10                                                             
         CLC   PBQSPDS2,BLANKS     AND  IF SECOND SPACE FILTER MISSING          
         BNH   RBYSPCX                                                          
*                                                                               
         TM    PBQSPD1L,X'80'      ACCEPT IF NEGATIVE SPACE FILTERS             
         BO    RBYSPCX                                                          
         TM    PBQSPD2L,X'80'                                                   
         BO    RBYSPCX                                                          
*                                                                               
         B     RBYSPC50            ELSE REJECT                                  
*                                                                               
RBYSPC40 DS    0H                                                               
*                                                                               
         MVC   WORK,BLANKS         INIT WORKAREA                                
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R6)            SPACE DESCRIPTION LENGTH                     
         SH    RF,=H'3'            DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),2(R6)       MOVE TO FIELD AT LEAST 17 LONG               
*                                                                               
         TM    PBBYOPTS,PBBYCSPQ   IF BUY MUST BELONG TO CONTRACT               
         BNO   *+12                                                             
         CLI   WORK,C'*'              DROP IF SPACE(1) IS C'*'                  
         BE    RBYBUYCN                                                         
*                                                                               
         GOTO1 SPCFLT,PARM,WORK    FILTER ON SPACE DESCRIPTION                  
         BE    RBYSPCX             PASSES FILTER - KEEP                         
*                                                                               
RBYSPC50 DS    0H                                                               
*                                                                               
         B     RBYBUYCN            REJECT BUY RECORD                            
*                                                                               
RBYSPCX  DS    0H                                                               
*                                                                               
*        FILTER ON OLD INVOICE MATCHED STATUS                                   
*                                                                               
         TM    PBQMATSW,PBQMATYQ   IF MATCHED ONLY                              
         BNO   RBYMAT10                                                         
*                                                                               
         TM    PBDSTAT,X'40'          DROP IF NOT MATCHED                       
         BNO   RBYBUYCN                                                         
         B     RBYMAT40                                                         
*                                                                               
RBYMAT10 DS    0H                                                               
*                                                                               
         TM    PBQMATSW,PBQMATNQ   IF UNMATCHED ONLY                            
         BNO   RBYMAT40                                                         
*                                                                               
         TM    PBDSTAT,X'40'          DROP IF MATCHED                           
         BO    RBYBUYCN                                                         
*                                                                               
RBYMAT40 DS    0H                                                               
*                                                                               
*        FILTER ON NEW INVOICE MATCHED STATUS                                   
*                                                                               
         TM    PBQMATS2,PBQNMTYQ   IF MATCHED ONLY                              
         BNO   RBYNMT10                                                         
*                                                                               
         MVI   ELCODE,PBMATELQ     FIND NEW INVOICE MATCH ELEMENT               
         L     R6,AIO1             POINT TO BUY RECORD                          
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   RBYBUYCN            NOT FOUND - DROP                             
*                                                                               
         USING PBMATELD,R6         ESTABLISH MATCH STATUS ELEMENT               
*                                                                               
         CLI   PBMTSTAT,PBMTSMTQ      DROP IF NOT MATCHED                       
         BNE   RBYBUYCN                                                         
         B     RBYNMT40                                                         
*                                                                               
RBYNMT10 DS    0H                                                               
*                                                                               
         TM    PBQMATS2,PBQNMTNQ   IF UNMATCHED ONLY                            
         BNO   RBYNMT40                                                         
*                                                                               
         MVI   ELCODE,PBMATELQ     FIND NEW INVOICE MATCH ELEMENT               
         L     R6,AIO1             POINT TO BUY RECORD                          
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   RBYNMT40            NOT FOUND - KEEP                             
*                                                                               
         USING PBMATELD,R6         ESTABLISH MATCH STATUS ELEMENT               
*                                                                               
         CLI   PBMTSTAT,PBMTSMTQ      DROP IF MATCHED                           
         BE    RBYBUYCN                                                         
         B     RBYNMT40                                                         
*                                                                               
RBYNMT40 DS    0H                                                               
*                                                                               
*        FILTER ON NEW INVOICE NO INVOICE STATUS                                
*                                                                               
         TM    PBQMATS2,PBQNVNIQ   IF NO INVOICE ONLY                           
         BNO   RBYNVNIX                                                         
*                                                                               
         MVI   ELCODE,PBMATELQ     FIND NEW INVOICE MATCH ELEMENT               
         L     R6,AIO1             POINT TO BUY RECORD                          
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   RBYNVNIX            NOT FOUND - KEEP                             
*                                                                               
         USING PBMATELD,R6         ESTABLISH MATCH STATUS ELEMENT               
*                                                                               
         CLI   PBMTSTAT,PBMTSNIQ      DROP IF NOT NO INVOICE                    
         BNE   RBYBUYCN                                                         
*                                                                               
RBYNVNIX DS    0H                                                               
*                                                                               
*        FILTER ON NEW INVOICE DISCREPANCY STATUS                               
*                                                                               
RBYDSTF  DS    0H                                                               
*                                                                               
         CLI   PBQDSTA,0           SKIP IF NO FILTERING ON DSTA                 
         BE    RBYDSTFX                                                         
*                                                                               
         MVI   ELCODE,PBMATELQ     FIND NEW INVOICE MATCH ELEMENT               
         L     R6,AIO1             POINT TO BUY RECORD                          
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   RBYBUYCN            NOT FOUND - DROP                             
*                                                                               
         USING PBMATELD,R6         ESTABLISH MATCH STATUS ELEMENT               
*                                                                               
         CLC   PBQDSTA,PBMTDSTA    MATCH ON DISCREPANCY STATUS                  
         BNE   RBYBUYCN            NE - DROP BUY                                
*                                                                               
RBYDSTFX DS    0H                                                               
*                                                                               
*        FILTER ON INVOICE TEARSHEET STATUS                                     
*                                                                               
         TM    PBQMATSW,PBQTSHYQ   IF TEARSHEETS ONLY                           
         BNO   RBYTSH10                                                         
*                                                                               
         TM    PBDSTAT,X'10'          DROP IF NO TEARSHEET                      
         BNO   RBYBUYCN                                                         
         B     RBYTSH40                                                         
*                                                                               
RBYTSH10 DS    0H                                                               
*                                                                               
         TM    PBQMATSW,PBQTSHNQ   IF NO TEARSHEET ONLY                         
         BNO   RBYTSH40                                                         
*                                                                               
         TM    PBDSTAT,X'10'          DROP IF TEARSHEET                         
         BO    RBYBUYCN                                                         
*                                                                               
RBYTSH40 DS    0H                                                               
*                                                                               
*        FILTER ON TEARSHEET STATUS VALUES                                      
*                                                                               
RBYTSS   DS    0H                                                               
*                                                                               
         CLI   PBQTSSTA,0          IF TEARSHEET STATUS PRESENT                  
         BE    RBYTSSX                                                          
*                                                                               
         MVI   ELCODE,X'95'        FIND TEARSHEET ELEMENT                       
         L     R6,AIO1             POINT TO BUY RECORD                          
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   RBYTSS40            NOT FOUND                                    
*                                                                               
         USING PTSHTEL,R6          ESTABLISH TEARSHEET ELEMENT                  
*                                                                               
         CLC   PBQTSSTA,PTSHSTAT   OKAY IF STATUS MATCHES FILTER                
         BE    RBYTSSX                                                          
*                                                                               
         CLI   PBQTSSTA,C'X'       IF BUYS WITH NO TEARSHEET WANTED             
         BNE   RBYBUYCN            ELSE DROP BUY                                
*                                                                               
         CLI   PTSHSTAT,C' '          DROP IF TEARSHEET ENTERED                 
         BH    RBYBUYCN                                                         
         B     RBYTSSX             ELSE KEEP                                    
*                                                                               
RBYTSS40 DS    0H                  NO TEARSHEET ELEMENT                         
*                                                                               
         CLI   PBQTSSTA,C'X'       OKAY IF MISSING TSHEETS WANTED               
         BE    RBYTSSX                                                          
*                                                                               
         B     RBYBUYCN            ELSE DROP BUY                                
*                                                                               
RBYTSSX  DS    0H                                                               
*                                                                               
*        FILTER OF REFERENCE NUMBER IF NEEDED                                   
*                                                                               
RBYREF   DS    0H                                                               
*                                                                               
         CLC   PBREFFLT,BLANKS     SKIP IF NO FILTER GIVEN                      
         BNH   RBYREFX                                                          
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,PBREFELQ     LOOKING FOR REFERENCE ELEMENT                
*                                                                               
         BAS   RE,NXTELM           FIND 1ST/NEXT ELM                            
         BNE   RBYBUYCN            NONE FOUND - DROP                            
*                                                                               
         USING PBREFELD,R6         ESTABLISH REFERENCE ELEMENT                  
*                                                                               
         MVC   WORK,BLANKS         INIT WORKAREA                                
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R6)            GET FILTER LENGTH                            
         SH    RF,=Y(PBREFNO-PBREFELD)  REF NUMBER LENGTH                       
         BNP   RBYBUYCN            NO NUMBER - REJECT                           
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),PBREFNO     MOVE REFERENCE NUMBER TO WORKAREA            
*                                                                               
         OC    WORK,BLANKS         FORCE UPPERCASE                              
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,PBREFFLL       LENGTH OF REFERENCE NO FILTER                
         BZ    RBYREFX             NO LENGTH ASSUME MATCH                       
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   PBREFFLT(0),WORK    MATCH TO FILTER                              
         BNE   RBYBUYCN            REJECT BUY IF NO MATCH                       
*                                                                               
RBYREFX  DS    0H                                                               
*                                                                               
*                                  VALID BUY - SET FLAG                         
*                                                                               
         MVI   FLAG,C'Y'                                                        
*                                                                               
*        FILTER ON TEST/STEWARD BUY STATUS                                      
*              STEWARD IS A SPECIAL TEST BUY                                    
*                                                                               
RBYTST   DS    0H                                                               
*                                                                               
*        LIVE BUY                                                               
*                                                                               
         CLI   PBDBFD,C'T'         IF LIVE BUY                                  
         BE    RBYTST20                                                         
*                                                                               
         CLI   PBQTEST,C'T'           IF TSTONLY FILTER                         
         BE    RBYBUYCN                  REJECT                                 
         TM    PBQOPSTW,PBQSTWOQ      IF STEWARDONLY FILTER                     
         BO    RBYBUYCN                  REJECT                                 
*                                                                               
         B     RBYTSTX                ELSE ACCEPT                               
*                                                                               
*        TEST BUY                                                               
*                                                                               
RBYTST20 DS    0H                                                               
*                                                                               
         TM    PBDSTAT2,X'40'      IF TEST BUY (AND NOT STEWARD)                
         BO    RBYTST40                                                         
*                                                                               
         CLI   PBQTEST,C'Y'           IF LIVE AND TEST BUYS                     
         BE    RBYTSTX                   ACCEPT                                 
         CLI   PBQTEST,C'T'           IF TEST ONLY BUYS                         
         BE    RBYTSTX                   ACCEPT                                 
*                                                                               
         B     RBYBUYCN               ELSE REJECT                               
*                                                                               
*        STEWARD BUY                                                            
*                                                                               
RBYTST40 DS    0H                                                               
*                                                                               
         TM    PBQOPSTW,PBQSTWYQ+PBQSTWOQ                                       
         BNZ   RBYTSTX                   ACCEPT IF FILTERING ON STEWARD         
*                                                                               
         B     RBYBUYCN                  ELSE REJECT                            
*                                                                               
RBYTSTX  DS    0H                                                               
*                                                                               
*        FILTER ON HELD BUY STATUS IF REQUESTED                                 
*                                                                               
RBYHLD   DS    0H                                                               
*                                                                               
         CLI   PBQHLDSW,0          SKIP IF NO SWITCHES ON                       
         BE    RBYHLDXX                                                         
*                                                                               
         TM    PBQHLDSW,PBQHLDOQ   IF ONLY HELD BUYS REQUESTED                  
         BNO   RBYHLDN                                                          
*                                                                               
         TM    PBDSTAT,X'08'          ACCEPT ONLY HELD BUYS                     
         BNO   RBYBUYCN                                                         
*                                                                               
         B     RBYHLDX                                                          
*                                                                               
RBYHLDN  DS    0H                  IF EXCLUDING HELD BUYS                       
*                                                                               
         TM    PBQHLDSW,PBQHLDOQ                                                
         BNO   RBYRELN                                                          
*                                                                               
         TM    PBDSTAT,X'08'          REJECT HELD BUYS                          
         BO    RBYBUYCN                                                         
*                                                                               
RBYRELN  DS    0H                                                               
*                                                                               
RBYHLDX  DS    0H                                                               
*                                                                               
*        FILTER ON STAR RATE BUYS IF REQUESTED                                  
*                                                                               
         TM    PBQHLDSW,PBQHSROQ   IF ONLY *RATE BUYS REQUESTED                 
         BNO   RBYSRON                                                          
*                                                                               
         TM    PBDRLIND,X'08'         ACCEPT ONLY FROZEN BUYS                   
         BNO   RBYBUYCN                                                         
*                                                                               
RBYSRON  DS    0H                  IF EXCLUDING *RATE BUYS                      
*                                                                               
         TM    PBQHLDSW,PBQHSRNQ                                                
         BNO   RBYSRNN                                                          
*                                                                               
         TM    PBDRLIND,X'08'         REJECT FROZEN BUYS                        
         BO    RBYBUYCN                                                         
*                                                                               
RBYSRNN  DS    0H                                                               
*                                                                               
RBYHLDXX DS    0H                                                               
*                                                                               
*        FILTER ON TRAFFICKED BUYS OPTION                                       
*                                                                               
RBYTBS   DS    0H                                                               
*                                                                               
         CLI   PBQTROPT,0          SKIP IF NO TRAFFICKED BUYS OPTION            
         BE    RBYTBSX                                                          
*                                                                               
         CLI   PBQTROPT,PBQTBSQ    IF ONLY TRAFFICKED BUYS WANTED               
         BNE   RBYTBSN                                                          
*                                                                               
         TM    PBDSTAT,X'20'          DROP NON-TRAFFICKED BUYS                  
         BO    RBYBUYCN                                                         
*                                                                               
         B     RBYTBSX                                                          
*                                                                               
RBYTBSN  DS    0H                  IF EXCLUDING TRAFFICKED BUYS                 
*                                                                               
         CLI   PBQTROPT,PBQTBXQ                                                 
         BNE   RBYTBXN                                                          
*                                                                               
         TM    PBDSTAT,X'20'          ACCEPT ONLY NON-TRAFFICKED BUYS           
         BNO   RBYBUYCN                                                         
*                                                                               
RBYTBXN  DS    0H                                                               
*                                                                               
RBYTBSX  DS    0H                                                               
*                                                                               
*        FILTER ON PO# OPTIONS                                                  
*                                                                               
RBYPO#   DS    0H                                                               
*                                                                               
         CLI   PBQPO#OP,0          SKIP IF NOT FILTERING ON PO#                 
         BE    RBYPO#X                                                          
*                                                                               
         LA    R8,SESTDATA         ESTABLISH SAVED EST BUFFER ENTRY             
         USING ESTBUFFD,R8                                                      
*                                                                               
         MVI   ELCODE,PBYPOELQ                                                  
         LA    R6,PBUYKEY          POINT TO BUY RECORD                          
         BRAS  RE,GETEL            FIND PO# ELEMENT                             
*                                                                               
RBYPO#LP DS    0H                                                               
*                                                                               
         BNE   RBYPO#NF            NONE FOUND                                   
*                                                                               
         USING PBYPOELD,R6         ESTABLISH AS PO# ELEMENT                     
*                                                                               
         TM    PBYPOSTA,BYPOZZZQ   FOUND IF NOT ZZZ BUY                         
         BNO   RBYPO#FD                                                         
*                                                                               
         CLC   PBPROD,PBYPOPRD     CHECK THAT PO# FOR CURRENT PRODUCT           
         BE    RBYPO#FD            YES                                          
*                                  NO                                           
RBYPO#CN DS    0H                                                               
*                                                                               
         BRAS  RE,NEXTEL           READ NEXT PO# ELEMENT                        
         B     RBYPO#LP                                                         
*                                                                               
RBYPO#FD DS    0H                                                               
*                                  PO# ELEMENT FOUND                            
         TM    PBQPO#OP,PBQPO#XQ   IF REPORTING BUYS W/O PO#                    
         BO    RBYBUYCN               DROP                                      
         TM    PBQPO#OP,PBQPO#NQ   IF REPORTING BUYS NEEDING PO#                
         BO    RBYBUYCN               DROP                                      
*                                                                               
         TM    PBQPO#OP,PBQPO#AQ+PBQPO#IQ SKIP IF NOT ACTIVE/INACTIVE           
         BZ    RBYPO#90                        FILTER                           
*                                                                               
*        CALL PPGETPO# TO GET A(PO# ELEMENT) IN PO#REC                          
*                                                                               
         MVI   ELCODE,PCLTPOEQ     FIND PO# ELEMENT IN CLTREC                   
         L     R6,PBCLTADR         LOOK IN CLIENT RECORD                        
*                                                                               
         BRAS  RE,GETEL                                                         
         BNZ   RBYBUYCN            DROP IF CLT HAS NO PO#'S                     
*                                                                               
         USING PCLTPOEL,R6         ESTABLISH CLIENT PO# ELM                     
         MVC   BYTE,PCLTPOLV       SAVE CLIENT PO# LEVEL                        
*                                                                               
         MVC   RBYSVKEY,IOKEY      SAVE CURRENT KEY                             
*                                                                               
         GOTOR =V(PPGETPO#),PARM,(C'B',PBUYREC),(BYTE,RBYPOEL),        X        
               PBCOMFAC,0                                                       
*                                                                               
         MVC   IOKEY,RBYSVKEY      RESTORE FILE POINTERS                        
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL                                         
*                                                                               
         CLI   PARM,X'FF'          SKIP IF ERRORS                               
         BE    RBYBUYCN                                                         
*                                                                               
         L     R6,PARM+12          ESTABLISH PO# ELEMENT                        
         USING PO#DELMD,R6                                                      
*                                                                               
         TM    PBQPO#OP,PBQPO#AQ   IF REPORTING BUYS WITH ACTIVE PO#            
         BNO   *+16                                                             
         TM    PO#DACTV,PO#DINAQ       IF INACTIVE PO#                          
         BO    RBYBUYCN                   DROP                                  
         B     RBYPO#X                 ELSE KEEP                                
*                                                                               
         TM    PBQPO#OP,PBQPO#IQ   IF REPORTING BUYS WITH INACTV PO#            
         BNO   *+16                                                             
         TM    PO#DACTV,PO#DINAQ       IF INACTIVE PO#                          
         BO    RBYPO#X                    KEEP                                  
         B     RBYBUYCN                ELSE DROP                                
*                                                                               
RBYPO#90 DS    0H                                                               
*                                                                               
         B     RBYPO#X             ELSE KEEP                                    
*                                                                               
RBYPO#NF DS    0H                  BUY HAS NO PO#                               
*                                                                               
         TM    PBQPO#OP,PBQPO#XQ   IF REPORTING BUYS W/O PO#                    
         BO    RBYPO#X                KEEP                                      
*                                                                               
         TM    PBQPO#OP,PBQPO#OQ   IF REPORTING BUYS WITH PO#                   
         BO    RBYBUYCN               DROP                                      
*                                                                               
         TM    PBQPO#OP,PBQPO#AQ+PBQPO#IQ IF ACTIVE/INACTIVE FILTER             
         BNZ   RBYBUYCN                        DROP                             
*                                                                               
         TM    PBQPO#OP,PBQPO#NQ   IF REPORTING BUYS NEEDING PO#                
         BNO   RBYPO#X                ELSE KEEP                                 
         TM    EBFIND,EBFIPO#         IF ESTIMATE HAS PO#'S                     
         BO    RBYPO#X                   KEEP                                   
*                                                                               
         B     RBYBUYCN            ELSE DROP                                    
*                                                                               
RBYPO#X  DS    0H                                                               
*                                                                               
*        HANDLE ANY OTHER FILTERING                                             
*                                                                               
         CLI   PBQACTIV,C'Y'       IF READING ACTIVE PRODUCTS ONLY              
         BNE   *+14                                                             
         OC    PBUYKACT,PBUYKACT      REJECT ANY PASSIVE POINTER                
         BNZ   RBYBUYCN                                                         
*                                                                               
         GOTO1 =A(FLTDTE),RR=RELO    FILTER BUYS ON VARIOUS DATES               
         BNE   RBYBUYCN      REJECT IF DIDN'T PASS FILTERING                    
*                                                                               
*        FILTER ON CHANGES TO THE BUY                                           
*                                                                               
         TM    PBQBCHOP,PBQBCHPS+PBQBCHNG IF FILTERING ON CHANGES               
         BZ    *+12                                                             
         GOTOR BCHFLT                        GO CHECK CHANGES                   
         BNZ   RBYBUYCN                      DROP BUY                           
*                                                                               
         GOTO1 =A(GETPUBN),RBYWORKH,RR=RELO     READ PUB NAME                   
*                                                                               
         BNE   RBYBUYCN            DROP IF PUB FAILS FILTERING                  
*                                                                               
         OC    PBQCDFLT,PBQCDFLT   IF CASH DISC FILTER GIVEN                    
         BZ    *+14                                                             
         CLC   RBYWORKH+1(1),PBQCDFLT  THEN MUST BE A CD PUB                    
         BNE   RBYBUYCN                                                         
*                                                                               
*        FILTER ON REGION OR DISTRICTS                                          
*                                                                               
RBYDRD   DS    0H                                                               
*                                                                               
         CLC   PBQRGN,BLANKS       SKIP IF REGION NOT REQUESTED                 
         BH    *+10                                                             
         CLC   PBQDST,BLANKS       AND  IF DISTRICTS NOT REQUESTED              
         BNH   RBYDRDX                                                          
*                                                                               
         GOTO1 =A(FLTDRD),PARM,RR=RELO   FILTER ON REG/DST                      
*                                                                               
         CLI   3(R1),C'N'             DO NOT INCLUDE                            
         MVI   3(R1),0                 RESET                                    
         BE    RBYBUYCN                                                         
*                                                                               
RBYDRDX  DS    0H                                                               
*                                                                               
*        EXPAND BUY RECORD INTO USABLE PARTS                                    
*                                                                               
*          NOTE PBYOCTL1 AND PBYOCTL2  MUST BE SET FOR FIELDS NEEDED            
*            SEE DOCUMENTATION                                                  
*                                                                               
RBYEXP   DS    0H                                                               
*                                                                               
*        SET PARAMETERS FOR PPBYOUT                                             
*                                                                               
         LA    R6,PPBYOUTC         ESTABLISH PPBYOUT AREA                       
         USING PPBYOUTD,R6                                                      
*                                                                               
         MVI   PBYOCTL,X'28'        GENERATE COMMENTS AND ZZZ SPLIT             
         MVI   PBYOCLT2,X'20'       GENERATE COMPACT ZZZ ALLOC                  
         MVC   PBYOINPT,AIO1        ADDRESS OF BUY RECORD                       
*                                                                               
         LA    RF,PBGRS             GETINP                                      
         ST    RF,PBYOVALS                                                      
*                                                                               
         L     RF,PBCOMFAC                                                      
         MVC   PBYODTCN,CDATCON-COMFACSD(RF) DATE CONVERSION                    
*                                                                               
         GOTO1 =V(PPBYOUT),PARM,PPBYOUTD,RR=RELO                                
*                                                                               
         L     R2,AIO1         POINT TO BUY REC                                 
*                                                                               
         CLC   PBQADC,=CL6' '   FILTER ON AD CODE                               
         BNH   *+14                                                             
         CLC   PBQADC,PBDJOB    MUST BE THE SAME                                
         BNE   RBYBUYCN         READ NEXT BUY                                   
*                                                                               
         CLC   PBQADFLT,=CL6' '    SKIP IF NO AD FILTER GIVEN                   
         BNH   RBYADFLX                                                         
*                                                                               
         GOTO1 =A(FLTAD)           FILTER ON AD                                 
         BNE   RBYBUYCN            DROP IF IT DOESN'T PASS FILTER               
*                                                                               
RBYADFLX DS    0H                                                               
*                                  SET PUB/ZONE/EDITION                         
*        FILTER ON UPID                                                         
*                                                                               
         OC    PBUPIDFL,PBUPIDFL   SKIP IF NO FILTER AROUND                     
         BZ    RBYUPIDX                                                         
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,X'90'        SET TO READ UPLOAD ELEMENT                   
         BRAS  RE,NXTELM           FIND 1ST/NEXT ELM                            
         BNE   RBYBUYCN            DROP IF NONE FOUND                           
*                                                                               
         USING PIUPEL,R6           ESTABLISH UPLOAD ELEMENT                     
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,PBUPIDCL       GET COMPARE LENGTH FOR FILTER                
         BZ    RBYUPIDX            SKIP IF NO FILTER                            
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   PIUPUSEQ(0),PBUPIDST   UPID MUST LIE IN RANGE                    
         BL    RBYBUYCN                                                         
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   PIUPUSEQ(0),PBUPIDEN                                             
         BH    RBYBUYCN                                                         
*                                                                               
RBYUPIDX DS    0H                                                               
*                                                                               
         MVC   PBPUB(L'PBPUB+L'PBZONE+L'PBACTED),PBUYKPUB                       
         MVC   PBINSDT,PBUYKDAT   SET INSERT DATE                               
         MVC   PBACTLIN,PBUYKLIN  SET LINE NUMBER                               
         MVC   PBEST,PBUYKEST     SET ESTIMATE NUMBER                           
*                                                                               
RBYEXPX  DS    0H                                                               
*                                                                               
         DROP  R6                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        HOOK TO USER TO PROCESS THE BUY RECORD                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RBYHOOK  DS    0H                                                               
*                                                                               
         MVI   PBMODE,PBPROCBY     SET PROCESSING MODE TO BUY                   
*                                                                               
         TM    PBQSPLOP,X'80'     IF THIS BUY FLAVOR AND CONTRACT ITEM          
         BNO   RBYHOOK1              REQUESTED                                  
*                                                                               
         GOTOR GETCON                READ IN CONTRACT                           
*                                                                               
RBYHOOK1 DS    0H                                                               
*                                                                               
         XC    PBCRHELA,PBCRHELA   INIT CIRCULATION ADDRESSES                   
         XC    PBCRHELA,PBCRHELA                                                
*                                                                               
         TM    PBQREAD2,PBQRDCRC  IF CIRCULATION RECORD NEEDED                  
         BNO   RBYHK10                                                          
*                                                                               
         GOTOR GETCRC              FIND APPROPRIATE ELEMENTS                    
*                                                                               
RBYHK10  DS    0H                                                               
*                                                                               
*        IF REPORTING ONLY PAY PENDING BUYS                                     
*           CHECK IF BUY HAS PAYMENT PENDING                                    
*                                                                               
         TM    PBQOPTS,PBQOXPD     IF EXCLUDING PAID BUYS                       
         JNO   *+12                                                             
         BRAS  RE,PDBUYCHK            CHECK IF FULLY PAID                       
         JZ    RBYHOOKX                 DROP FULLY PAID BUYS                    
*                                                                               
*        IF PROCESSING PAY ELEMENTS                                             
*           READ NEXT PAY ELEMENT                                               
*              IF NEEDED, MATCH TO CLEARANCE STATUS TABLE ELEMENT               
*              GO TO USER FOR PROCESSING                                        
*                                                                               
RBYPAY   DS    0H                                                               
*                                                                               
         XC    PBPAYELA,PBPAYELA   INIT PAY ELEMENT ADDRESS                     
         XC    PBCLSELA,PBCLSELA   INIT CLEARANCE STATUS  ELEMENT ADDR          
         XC    PBCLINVA,PBCLINVA   INIT CLEARANCE INVOICE ELEMENT ADDR          
*                                                                               
         TM    PBBYOPTS,PBBYPAYQ   SKIP IF NOT PROCESSING PAY ELEMENTS          
         BNO   RBYPAYX                                                          
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,PPAYELQ      LOOKING FOR PAY ELEMENT                      
*                                                                               
RBYPAYLP DS    0H                  PROCESS PAY ELEMENTS                         
*                                                                               
         BAS   RE,NXTELM           FIND 1ST/NEXT PAY ELM                        
         BNE   RBYPAYDN            NONE FOUND                                   
*                                                                               
         USING PPAYELEM,R6                                                      
         TM    PBQOPTS,PBQNSCPT    EXCLUDE SCRIPT?                              
         BZ    *+20                NO                                           
         CLI   PPAYELLN,22         HAVE NEW FLAGS?                              
         BNH   *+12                NO - DEFINITELY NOT SCRIPT                   
         TM    PPDSTAT,X'08'       YES - SCRIPT PAY UPLOAD?                     
         BO    RBYPAYDN            YES - EXCLUDE IT                             
*                                                                               
         TM    PBQOPTS,PBQYSCPT    ONLY WANT SCRIPT?                            
         BZ    *+20                NO                                           
         CLI   PPAYELLN,22         HAVE NEW FLAGS?                              
         BNH   RBYPAYDN            NO - DEFINITELY NOT SCRIPT                   
         TM    PPDSTAT,X'08'       YES - SCRIPT PAY UPLOAD?                     
         BZ    RBYPAYDN            NO - EXCLUDE IT                              
         DROP  R6                                                               
*                                                                               
         ST    R6,PBPAYELA         SET PAY ELEMENT ADDRESS                      
*                                                                               
         CLI   PBQTRACE,C'Y'                                                    
         BNE   RBYPAYL1                                                         
*                                                                               
         GOTOR RBYTRAC,PARM,(R6)                                                
*                                                                               
RBYPAYL1 DS    0H                                                               
*                                                                               
         TM    PBBYOPTS,PBBYCLSQ   SKIP IF NOT PROCESSING                       
         BNO   RBYPAY50              CLEARANCE STATUS ELEMENTS                  
*                                                                               
         GOTOR GETCLS              FIND CLEARANCE STATUS ELEMENT                
*                                                                               
         TM    PBQOPTS,PBQOXPD     IF EXCLUDING PAID BUYS                       
         JNO   RBYPAY50                                                         
*                                                                               
         ICM   R5,15,PBCLSELA      KEEP IF NO CHECK ELEMENT FOUND               
         JZ    RBYPAY50                                                         
*                                                                               
         USING PPCLEL01,R5            ESTABLISH CHECK ELEMENT                   
*                                                                               
         CLC   =C'VOID',PPCLCHK       KEEP IF CHECK WAS VOIDED                  
         JE    RBYPAY50                                                         
*                                                                               
         OC    PPCLCHK,PPCLCHK        DROP IF CHECK HAS BEEN CUT                
         JNZ   RBYPAYCN                                                         
*                                                                               
RBYPAY50 DS    0H                                                               
*                                                                               
         BRAS  RE,ELMHIDE          HIDE ALL OTHER ELEMENTS                      
*                                                                               
         XC    PBCLINVA,PBCLINVA   INIT INVOICE ELM POINTER                     
*                                                                               
         ICM   R5,15,PBCLSELA      SKIP IF NO CHECK ELEMENT FOUND               
         JZ    RBYPAY53                                                         
*                                                                               
         CLI   PBQTRACE,C'Y'                                                    
         BNE   RBYPAYL2                                                         
*                                                                               
         GOTOR RBYTRAC,PARM,(R5)                                                
*                                                                               
RBYPAYL2 DS    0H                                                               
*                                                                               
         TM    PPCLSTAT,X'02'      SKIP IF NO 03 ELEMENTS                       
         BNO   RBYPAY53                                                         
*                                                                               
         LLC   R3,PPCLEL01+1       GET ELEMENT LENGTH                           
         LA    R3,0(R3,R5)         POINT TO NEXT ELEMENT IN TABLE               
         CLI   0(R3),X'03'         SKIP IF NOT AN INVOICE ELEMENT               
         BNE   *+8                                                              
         ST    R3,PBCLINVA         PASS A(INVOICE ELEMENT)                      
*                                                                               
         USING PPCLEL03,R3         ESTABLISH INVOICE ELEMENT                    
*                                                                               
         CLI   PBQTRACE,C'Y'                                                    
         BNE   RBYPAYL3                                                         
*                                                                               
         GOTOR RBYTRAC,PARM,(R3)                                                
*                                                                               
RBYPAYL3 DS    0H                                                               
*                                                                               
RBYPAY53 DS    0H                                                               
*                                                                               
RBYPAY55 DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RBYPAY55             PASS BACK SAME ELEMENT                      
*                                                                               
         OC    PBCLSELA,PBCLSELA   SKIP IF NO CLEARANCE STATUS ELM              
         BZ    RBYPAYGD                                                         
*                                                                               
         TM    PPCLSTAT,X'02'      SKIP IF NO 03 ELEMENTS                       
         BNO   RBYPAYGD                                                         
*                                                                               
*        FIND NEXT 03 INVOICE ELEMENT                                           
*                                                                               
RBYPAYGL DS    0H                                                               
*                                                                               
         LLC   RF,PPCLEL03+1       GET ELEMENT LENGTH                           
         LA    R3,0(RF,R3)         POINT TO NEXT ELEMENT IN TABLE               
*                                                                               
         CLI   0(R3),X'00'         DONE IF END OF TABLE                         
         BE    RBYPAYGD                                                         
         CLI   0(R3),X'01'         DONE IF NEXT 01 ELEMENT                      
         BE    RBYPAYGD                                                         
*                                                                               
         CLI   0(R3),X'03'         SKIP IF NOT AN INVOICE ELEMENT               
         BNE   RBYPAYGL                                                         
*                                                                               
         ST    R3,PBCLINVA         PASS A(INVOICE ELEMENT)                      
*                                                                               
         CLI   PBQTRACE,C'Y'                                                    
         BNE   RBYPAYGC                                                         
*                                                                               
         GOTOR RBYTRAC,PARM,(R3)                                                
*                                                                               
RBYPAYGC DS    0H                                                               
*                                                                               
         B     RBYPAY55            RETURN TO WRITER                             
*                                                                               
RBYPAYGD DS    0H                                                               
*                                                                               
         BRAS  RE,ELMRSTR          RESTORE ALL HIDDEN ELEMENTS                  
*                                                                               
RBYPAYCN DS    0H                                                               
*                                                                               
         XC    PBPAYELA,PBPAYELA   INIT PAY ELEMENT ADDRESS                     
         XC    PBCLSELA,PBCLSELA   INIT CLEARANCE STATUS ELEMENT ADDR           
         XC    PBCLINVA,PBCLINVA   INIT CLEARANCE INV    ELEMENT ADDR           
*                                                                               
         B     RBYPAYLP                                                         
*                                                                               
RBYPAYDN DS    0H                                                               
*                                                                               
RBYPAYX  DS    0H                                                               
*                                                                               
*        IF PROCESSING BILL ELEMENTS                                            
*           READ NEXT BILL ELEMENT                                              
*              IF NEEDED, MATCH TO BILL HEADER TABLE ELEMENT                    
*              GO TO USER FOR PROCESSING                                        
*                                                                               
RBYBLL   DS    0H                                                               
*                                                                               
         XC    PBBLLELA,PBBLLELA   INIT BILL ELEMENT ADDRESS                    
         XC    PBBHDELA,PBBHDELA   INIT BILL HEADER TABLE ADDRESS               
         XC    PBMBTELA,PBMBTELA   INIT MEDIA TRANSFER ELEMENT ADDRESS          
         XC    PBTRNELA,PBTRNELA   INIT CASH TRANSACTION ELEMENT ADDR           
*                                                                               
         TM    PBBYOPTS,PBBYBLLQ   SKIP IF NOT PROCESSING BILL ELEMENTS         
         BNO   RBYBLLX                                                          
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,PBILELQ      LOOKING FOR BILL ELEMENT                     
*                                                                               
RBYBLLLP DS    0H                  PROCESS BILL ELEMENTS                        
*                                                                               
         BAS   RE,NXTELM           FIND 1ST/NEXT BILL ELM                       
         BNE   RBYBLLDN            NONE FOUND                                   
*                                                                               
         CLC   PBPROD,PBPRD-PBILELD(R6)   MUST BE FOR CURRENT PRODUCT           
         BNE   RBYBLLCN                                                         
*                                                                               
         CLI   PBQPRFW0+7,C'Y'     SKIP IF PROFILE NOT ON                       
         BNE   *+12                                                             
         TM    PBBILST-PBILELD(R6),X'C0' SKIP IF REVERSED OR REVERSAL           
         BM    RBYBLLCN                                                         
*                                                                               
         USING PBILELD,R6          ESTABLISH BILLING ELEMENT                    
*                                                                               
         OC    PBLDATE,PBLDATE     SKIP IF NO BILL DATE (WAS UNBILLED)          
         BZ    RBYBLLCN                                                         
*                                                                               
         ST    R6,PBBLLELA         SET BILL ELEMENT ADDRESS                     
*                                                                               
         OC    PBQBRNST(6),PBQBRNST SKIP IF NO RUN DATE FILTER                  
         BZ    RBYBLL20                                                         
*                                                                               
         CLC   PBLDATE,PBQBRNST    MUST LIE IN RUN DATE PERIOD                  
         BL    RBYBLLCN                                                         
         CLC   PBLDATE,PBQBRNND                                                 
         BH    RBYBLLCN                                                         
*                                                                               
RBYBLL20 DS    0H                                                               
*                                                                               
         TM    PBBYOPTS,PBBYBHTQ   SKIP IF NOT PROCESSING                       
         BNO   RBYBLLGO              BILL HEADER RECORDS                        
*                                                                               
         GOTO1 =A(GETBHD)          FIND BILL HEADER TABLE ENTRY                 
*                                                                               
*        READBUYS LOOP TO HANDLE BILL HEADER AND CASH APPLIED DATA              
*                                                                               
         ICM   R3,15,PBBHDELA      POINT TO BILL HEADER FROM CASHIER            
         BZ    RBYBLLCN               NONE FOUND                                
*                                                                               
         TM    PBBYOPT2,PBBYCSHQ   SKIP IF CASH DATA NOT WANTED                 
         BNO   RBYCSHX                                                          
*                                                                               
         LA    R3,256(R3)          POINT TO CASH APPLIED DATA                   
         USING MBTELD,R3           ESTABLISH AS MEDIA TRANSFER ELEMENT          
*                                                                               
         MVI   PBBLLSW,X'F0'       NEVER POSTED TO ACC                          
*                                                                               
RBYCSHLP DS    0H                                                               
*                                                                               
         CLI   MBTEL,0             DONE IF END OF RECORD REACHED                
         BE    RBYCSHDN                                                         
*                                                                               
         CLI   MBTEL,MBTELQ        SKIP IF NOT A MEDIA TRANSFER ELMENT          
         BNE   *+8                                                              
         ST    R3,PBMBTELA         SAVE ADDRESS                                 
*                                                                               
         USING TRNELD,R3           ESTABLISH AS TRANSACTION ELEMENT             
*                                                                               
         CLI   TRNEL,TRNELQ        SKIP IF NOT TRANSACTION ELEMENT              
         BE    *+8                                                              
         CLI   TRNEL,X'FF'                                                      
         BNE   RBYCSHCN                                                         
*                                                                               
         CLI   TRNTYPE,X'09'       SKIP IF ORIGINAL POSTING ELEMENT             
         BE    *+8                                                              
         CLI   TRNTYPE,X'06'                                                    
         BE    RBYCSHCN                                                         
*                                                                               
         ST    R3,PBTRNELA         SAVE ADDRESS                                 
*                                                                               
         BRAS  RE,ELMHIDE          HIDE ALL OTHER ELEMENTS                      
*                                                                               
RBYCSHGO DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         CLI   PBQTRACE,C'Y'       SKIP IF NOT TRACING                          
         BNE   RBYCSHG1                                                         
*                                                                               
         GOTOR RBYTRAC,PARM,(R6)                                                
*                                                                               
RBYCSHG1 DS    0H                                                               
*                                                                               
         CLI   0(R6),X'F0'         SKIP IF MASTER ELM HIDDEN                    
         BNL   RBYCSHG2                                                         
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RBYCSHGO                                                         
*                                                                               
         CLI   PBQPRFW0+14,C'Y'    IF BILLS TO MATCH CASH                       
         BNE   RBYCSH20                                                         
*                                                                               
*        SEND BILL ELEMENT ALONE TO GET BILL DATA                               
*              NEEDED IN CASES WHERE THERE ARE MULTIPLE                         
*              PAYMENTS BY CLIENT                                               
*                                                                               
         XC    PBTRNELA,PBTRNELA   INIT CASH TRANSACTION ELEMENT ADDR           
         L     R0,PBMBTELA         SAVE POSTING ELEMENT ADDRESS                 
         XC    PBMBTELA,PBMBTELA   INIT POSTING ELEMENT ADDRESS                 
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         ST    R0,PBMBTELA         RESTORE POSTING ELEMENT ADDRESS              
*                                                                               
         MVI   PBBLLSW,X'FF'       ALREADY GONE WITH BILL ELEMENT               
*                                                                               
RBYCSH20 DS    0H                                                               
*                                                                               
RBYCSHG2 DS    0H                                                               
*                                                                               
         BRAS  RE,ELMRSTR          RESTORE ALL HIDDEN ELEMENTS                  
*                                                                               
RBYCSHCN DS    0H                                                               
*                                                                               
         USING MBTEL,R3            ESTABLISH AS MEDIA TRANSFER ELEMENT          
*                                                                               
         SR    RF,RF                                                            
         IC    RF,MBTLLN           BUMP TO NEXT ELEMENT                         
         LA    R3,MBTEL(RF)                                                     
*                                                                               
         B     RBYCSHLP                                                         
*                                                                               
RBYCSHDN DS    0H                                                               
*                                                                               
         XC    PBMBTELA,PBMBTELA   INIT MEDIA TRANSFER ELEMENT ADDRESS          
         XC    PBTRNELA,PBTRNELA   INIT CASH TRANSACTION ELEMENT ADDR           
*                                                                               
RBYCSHX  DS    0H                                                               
*                                                                               
RBYBLLGO DS    0H                                                               
*                                                                               
         CLI   PBBLLSW,X'FF'       SKIP IF BILL ELEMENT ALREADY SENT            
         BE    RBYBLLCN                                                         
*                                                                               
         BRAS  RE,ELMHIDE          HIDE ALL OTHER ELEMENTS                      
*                                                                               
RBYBLLGA DS    0H                                                               
*                                                                               
         CLI   PBQTRACE,C'Y'                                                    
         BNE   RBYBLLG1                                                         
*                                                                               
         GOTOR RBYTRAC,PARM,(R6)                                                
*                                                                               
RBYBLLG1 DS    0H                                                               
*                                                                               
         CLI   0(R6),X'F0'         SKIP IF MASTER ELM HIDDEN                    
         BNL   RBYBLLG2                                                         
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         CLI   PBQPRFW0+14,C'Y'    SKIP IF BILLS TO MATCH CASH                  
         BNE   *+8                                                              
         MVI   PBBLLSW,X'F0'            1ST & ONLY PASS FOR BLL ELM             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RBYBLLGA             PASS BACK SAME ELEMENT                      
*                                                                               
RBYBLLG2 DS    0H                                                               
*                                                                               
         BRAS  RE,ELMRSTR          RESTORE ALL HIDDEN ELEMENTS                  
*                                                                               
RBYBLLCN DS    0H                                                               
*                                                                               
         XC    PBBLLELA,PBBLLELA   INIT BILL ELEMENT ADDRESS                    
         XC    PBBHDELA,PBBHDELA   INIT BILL HEADER TABLE ADDRESS               
*                                                                               
         B     RBYBLLLP                                                         
*                                                                               
RBYBLLDN DS    0H                                                               
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
         CLI   ELCODE,PBILELQ      IF FINISHED WITH BILL ELEMENT                
         BNE   *+12                                                             
         MVI   ELCODE,PBILOPNQ        LOOK FOR OPEN RATE ELEMENTS               
         B     RBYBLLLP                                                         
*                                                                               
         CLI   ELCODE,PBILOPNQ     IF FINISHED WITH OPEN RATE ELEMENT           
         BNE   *+12                                                             
         MVI   ELCODE,PBILREBQ        LOOK FOR REBATE ELEMENTS                  
         B     RBYBLLLP                                                         
*                                                                               
RBYBLLX  DS    0H                                                               
*                                                                               
*        IF PROCESSING ADDITIONAL CHARGES ELEMENTS                              
*           READ NEXT ADDITIONAL CHARGE ELEMENT                                 
*              GO TO USER FOR PROCESSING                                        
*                                                                               
RBYACH   DS    0H                                                               
*                                                                               
         XC    PBACHELA,PBACHELA   INIT ACH ELEMENT ADDRESS                     
*                                                                               
         TM    PBBYOPT2,PBBYACHQ   SKIP IF NOT PROCESSING ACH ELEMENTS          
         BNO   RBYACHX                                                          
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,X'44'        LOOKING FOR ADDL CHG ELEMENT                 
*                                                                               
RBYACHLP DS    0H                  PROCESS ACHG ELEMENTS                        
*                                                                               
         BRAS  RE,NXTELM           FIND 1ST/NEXT ACHG ELM                       
         BNE   RBYACHDN            NONE FOUND                                   
*                                                                               
         TM    PBQACHGS,PBQACOPQ+PBQAC1Q  IF SINGLE CHARGE FOR REPORT           
         BNO   RBYACH10                                                         
*                                                                               
         USING PACELEM,R6          ESTABLISH ACHG ELEMENT                       
*                                                                               
         CLC   PBQACHG,PACCODE        MUST BE FOR CHARGE CODE                   
         BNE   RBYACHCN                                                         
*                                                                               
RBYACH10 DS    0H                                                               
*                                                                               
         ST    R6,PBACHELA         SET ACHG ELEMENT ADDRESS                     
*                                                                               
RBYACHGO DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BRAS  RE,ELMHIDE          HIDE ALL BUT THIS PACELEM                    
*                                                                               
         CLI   PBQTRACE,C'Y'                                                    
         BNE   RBYACHG1                                                         
*                                                                               
         GOTOR RBYTRAC,PARM,(R6)                                                
*                                                                               
RBYACHG1 DS    0H                                                               
*                                                                               
         BRAS  RE,GO               HOOK TO USER                                 
*                                                                               
         BRAS  RE,ELMRSTR          RESTORE ACHELEMS                             
*                                                                               
         NI    PBBYOPT2,X'FF'-PBBY1STQ TURN OFF 1ST TIME IND                    
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RBYACHGO             PASS BACK SAME ELEMENT                      
*                                                                               
RBYACHCN DS    0H                                                               
*                                                                               
         XC    PBACHELA,PBACHELA   INIT ADD'L CHARGE  ELEMENT ADDRESS           
*                                                                               
         B     RBYACHLP                                                         
*                                                                               
RBYACHDN DS    0H                                                               
*                                                                               
RBYACHX  DS    0H                                                               
*                                                                               
*        IF PROCESSING NEW INVOICE ELEMENTS                                     
*           READ NEXT NEW INVOICE ELEMENT                                       
*              GO TO USER FOR PROCESSING                                        
*                                                                               
RBYPNV   DS    0H                                                               
*                                                                               
         XC    PBPNVELA,PBPNVELA   INIT PNV ELEMENT ADDRESS                     
*                                                                               
         OI    PBBYOPT2,PBBY1STQ   INDICATE FIRST TIME TO WRITER                
*                                                                               
         TM    PBBYOPT2,PBBYPNVQ   SKIP IF NOT PROCESSING PNV ELEMENTS          
         BNO   RBYPNVX                                                          
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,PBNVELQ      LOOKING FOR NEW INVOICE ELEMENT              
*                                                                               
RBYPNVLP DS    0H                  PROCESS PNV ELEMENTS                         
*                                                                               
         BRAS  RE,NXTELM           FIND 1ST/NEXT PNVG ELM                       
         BNE   RBYPNVDN            NONE FOUND                                   
*                                                                               
         USING PBNVELMD,R6         ESTABLISH PNV ELEMENT                        
*                                                                               
         ST    R6,PBPNVELA         SET PNV ELEMENT ADDRESS                      
*                                                                               
RBYPNVGO DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         CLI   PBQTRACE,C'Y'                                                    
         BNE   RBYPNVG1                                                         
*                                                                               
         GOTOR RBYTRAC,PARM,(R6)                                                
*                                                                               
RBYPNVG1 DS    0H                                                               
*                                                                               
         BRAS  RE,GO               HOOK TO USER                                 
*                                                                               
         NI    PBBYOPT2,X'FF'-PBBY1STQ TURN OFF 1ST TIME IND                    
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RBYPNVGO             PASS BACK SAME ELEMENT                      
*                                                                               
RBYPNVCN DS    0H                                                               
*                                                                               
         XC    PBPNVELA,PBPNVELA   INIT NEW INVOICE ELEMENT ADDRESS             
*                                                                               
         B     RBYPNVLP                                                         
*                                                                               
RBYPNVDN DS    0H                                                               
*                                                                               
RBYPNVX  DS    0H                                                               
*                                                                               
RBYHOOK2 DS    0H                                                               
*                                                                               
         XC    PBBLLELA,PBBLLELA   INIT BILL ELEMENT ADDRESS                    
         XC    PBBHDELA,PBBHDELA   INIT BILL HEADER TABLE ADDRESS               
         XC    PBMBTELA,PBMBTELA   INIT MEDIA TRANSFER ELEMENT ADDRESS          
         XC    PBTRNELA,PBTRNELA   INIT CASH TRANSACTION ELEMENT ADDR           
         XC    PBACHELA,PBACHELA   INIT ADD'L CHARGE  ELEMENT ADDRESS           
         XC    PBPNVELA,PBPNVELA   INIT NEW INVOICE   ELEMENT ADDRESS           
*                                                                               
         TM    PBBYOPTS,PBBYBUYQ   GENERAL BUY RECORD DATA NEEDED               
         BO    RBYHOOK3                                                         
*                                                                               
         TM    PBBYOPTS,PBBYBUYQ+PBBYPAYQ+PBBYBLLQ  IF NO NEW SWITCHES          
         BNZ   RBYHOOK4                                                         
         TM    PBQREAD,PBQRDBUY       USE OLD SWITCH                            
         BNO   RBYHOOK4                                                         
*                                                                               
RBYHOOK3 DS    0H                                                               
*                                                                               
         TM    PBBYOPT2,PBBY1STQ   SKIP IF ALREADY BEEN TO WRITER               
         BZ    RBYHOOK4                                                         
*                                                                               
RBYHOK30 DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         NI    PBBYOPT2,X'FF'-PBBY1STQ TURN OFF 1ST TIME IND                    
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RBYHOK30            PASS BACK SAME RECORD                        
*                                                                               
RBYHOOK4 DS    0H                                                               
*                                                                               
         NI    PBBYOPT2,X'FF'-PBBY1STQ TURN OFF 1ST TIME IND                    
*                                                                               
RBYHOOKX DS    0H                                                               
*                                                                               
         B     RBYBUYCN                                                         
*                                                                               
*        CONTINUATION OF BUY PROCESSING LOOP                                    
*                                                                               
RBYBUYNX DS    0H                  BYPASS SOME RECORDS                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL                                         
*                                                                               
         B     RBYBUYLP                                                         
*                                                                               
RBYBUYCN DS    0H                  READ NEXT BUY ON FILE                        
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ+IORDEL                                         
*                                                                               
         B     RBYBUYLP                                                         
*                                                                               
RBYBUYDN DS    0H                  END OF BUYS FOR PUB                          
*                                                                               
RBYZEDCN DS    0H                                                               
*                                                                               
*        IF ADVERTISER REPORT FOR SINGLE PUB AND ALL EDITIONS                   
*           DO NEXT PUB/ZONE/EDITION                                            
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    RBYZEDDN                                                         
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   RBYZEDDN                                                         
         CLI   PBQALLZN,C'Y'       IF ALL ZONES AND EDITIONS                    
         BNE   RBYZEDDN                                                         
*                                                                               
         B     RBYZEDLP                                                         
*                                                                               
RBYZEDDN DS    0H                                                               
*                                                                               
RBYPBLCN DS    0H                                                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BNZ   RBYPBLLP               GO CHECK FOR MORE PUBS IN GRP             
*                                                                               
*        FIND NEXT PUB FOR PUBLISHER IF REQUESTED                               
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   CONTINUE IF PUBLISHER FILTER GIVEN           
         BNZ   RBYPBLLP                                                         
*                                                                               
*        FIND NEXT PUB IN PUB LIST IF REQUESTED                                 
*                                                                               
         OC    PBQLISCD,PBQLISCD   CONTINUE IF PUB LIST FILTER GIVEN            
         BNZ   RBYPBLLP                                                         
*                                                                               
RBYPBLDN DS    0H                                                               
*                                                                               
READBUYX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    XL256                                                            
RBYWORKH DC    H'0'                HALF WORD WORKAREA                           
RBYSTKEY DS    XL(L'IOKEY)         START KEY                                    
RBYSVKEY DS    XL(L'IOKEY)         KEY SAVEAREA                                 
*                                                                               
RBYPOEL  DS    XL32                PO# RETURN AREA                              
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C- PRWRIIO - TRACE ELEMENTS - RBUYTRAC'                   
***********************************************************************         
*                                                                     *         
*        PRINT TRACE OF AN ELEMENT                                    *         
*                                                                     *         
*NTRY    PARM0  - A(ELEMENT)                                          *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
RBYTRAC  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
         USING PBUYRECD,R2                                                      
*                                                                               
         L     R5,0(R1)            POINT TO ELEMENT                             
*                                                                               
         MVC   P,BLANKS                                                         
         SR    R0,R0                                                            
         IC    R0,1(R5)            ELEMENT LENGTH                               
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CHEXOUT-COMFACSD(RF)    HEXOUT ADDRESS                        
*                                                                               
         GOTO1 (RF),PARM,(R5),P+20,(R0),=C'TOG'                                 
*                                                                               
         GOTO1 IOPRINT,PARM,PASA,=C'BL01'                                       
*                                                                               
RBYTRACX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C- PRWRIIO - HIDE ALL BUT ONE ELEM - ELMHIDE'             
***********************************************************************         
*                                                                     *         
*        HIDE ALL BUT ONE OF ELEMENT TYPE                             *         
*                                                                     *         
*NTRY    R2==>  BUY RECORD                                            *         
*        R6==>  ELEMENT TO KEEP                                       *         
*                                                                     *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ELMHIDE  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
         USING PBUYRECD,R2                                                      
*                                                                               
         SR    RF,RF                                                            
         LA    R1,PBDELEM          FIRST ELEMENT                                
*                                                                               
ELMHLOOP DS    0H                                                               
*                                                                               
         CLI   0(R1),0             DONE AT END OF RECORD                        
         BE    ELMHDONE                                                         
*                                                                               
         CR    R1,R6               IGNORE CURRENT ELEMENT                       
         BE    ELMHCONT                                                         
*                                                                               
         LA    R3,ELMHTAB          POINT TO TABLE OF ELEMENTS TO HIDE           
*                                                                               
ELMHTBLP DS    0H                                                               
*                                                                               
         CLC   0(1,R1),0(R3)       IGNORE ALL BUT ELMS TO BE HIDDEN             
         BE    ELMHTBFD                                                         
*                                                                               
ELMHTBCN DS    0H                                                               
*                                                                               
         LA    R3,2(R3)            NEXT ENTRY IN TABLE                          
*                                                                               
         CLI   0(R3),X'FF'         CONTINUE IF NOT END OF TABLE                 
         BNE   ELMHTBLP                                                         
*                                                                               
         B     ELMHTBDN            NOT AN ELEMENT TO BE HIDDEN                  
*                                                                               
ELMHTBFD DS    0H                                                               
*                                                                               
         CLI   0(R1),X'28'         IF OPEN RATE ELEMENT                         
         BNE   ELMHTB20                                                         
*                                                                               
         CLI   0(R6),X'26'         IF MASTER IS BILL ELEMENT                    
         BNE   ELMHTB40                                                         
*                                                                               
         CLC   PBINVNO-PBILELEM(L'PBINVNO,R1),PBINVNO-PBILELEM(R6)              
         BE    ELMHTBDN               KEEP IF SAME BILL NUMBER                  
         B     ELMHTB40            ELSE - HIDE ELEMENT                          
*                                                                               
ELMHTB20 DS    0H                                                               
*                                                                               
         CLI   0(R1),X'26'         IF BILL ELEMENT                              
         BNE   ELMHTB40                                                         
*                                                                               
         CLI   0(R6),X'28'         AND MASTER IS OPEN RATE ELEMENT              
         BNE   ELMHTB40                                                         
*                                                                               
         CLC   PBINVNO-PBILELEM(L'PBINVNO,R1),PBINVNO-PBILELEM(R6)              
         BNE   ELMHTB40            HIDE IF NOT SAME BILL NUMBER                 
*                                  ELSE                                         
         MVI   0(R6),X'FD'         HIDE MASTER ELEMENT AS WELL                  
*                                                                               
ELMHTB40 DS    0H                                                               
*                                                                               
         MVC   0(1,R1),1(R3)       MAKE IT A BOGUS ELEMENT                      
*                                                                               
ELMHTBDN DS    0H                                                               
*                                                                               
ELMHCONT DS    0H                                                               
*                                                                               
         IC    RF,1(R1)            BUMP TO NEXT ELEMENT                         
         LA    R1,0(RF,R1)                                                      
         B     ELMHLOOP                                                         
*                                                                               
ELMHDONE DS    0H                                                               
*                                                                               
ELMHIDEX DS    0H                                                               
         XIT1                                                                   
*                                                                               
ELMHTAB  DS    0D                  TABLE FOR HIDING ELEMENTS                    
         DC    X'44',X'FA'         ADDITIONAL CHARGE ELEMENT                    
         DC    X'25',X'FB'         PAY ELEMENT                                  
         DC    X'26',X'FC'         BILL ELEMENT                                 
         DC    X'28',X'FD'         OPEN   BILL ELEMENT                          
         DC    X'29',X'FE'         REBATE BILL ELEMENT                          
         DC    X'FF'                                                            
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C- PRWRIIO - FILTER ON BUY CHANGES'                       
***********************************************************************         
*                                                                     *         
*        FILTER ON PARTICULAR CHANGES TO THE BUY                      *         
*                                                                     *         
*NTRY    R2==>  BUY RECORD                                            *         
*                                                                     *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
BCHFLT   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
         USING PBUYRECD,R2                                                      
*                                                                               
         TM    PBQBCHOP,PBQBCHPS+PBQBCHNG SKIP IF NO BUY TYPE OPTS              
         BZ    BCHFLTX                                                          
*                                                                               
         LA    R6,PBDELEM          FIRST ELEMENT                                
         USING PBDELEM,R6          ESTABLISH BUY DECRIPTION ELM                 
*                                                                               
         TM    PBBYOPTS,PBBYCHGQ   SKIP IF NOT FILTERING ON CHG DATE            
         BNO   BCHFDTEX                                                         
*                                                                               
         CLC   PBDBUYDT,PBQCHGST   IF BOUGHT ON OR AFTER START                  
         BL    BCHFADDX               CONTINUE                                  
*                                                                               
         OC    PBQCHGEN,PBQCHGEN      KEEP IF NO END DATE                       
         BZ    BCHFKEEP                                                         
*                                                                               
         CLC   PBDBUYDT,PBQCHGEN      ELSE MUST BE BOUGHT BEFORE END            
         BH    BCHFDROP                                                         
*                                                                               
         B     BCHFKEEP               ELSE KEEP                                 
*                                                                               
BCHFADDX DS    0H                                                               
*                                                                               
         TM    PBUYKEY+27,X'80'    SKIP IF NOT DELETED                          
         BNO   BCHFDTEX                                                         
*                                                                               
         CLC   PBDDATE,PBQCHGST    IF DELETED BEFORE START                      
         BL    BCHFDROP               DROP                                      
*                                                                               
         OC    PBQCHGEN,PBQCHGEN      KEEP IF NO END DATE                       
         BZ    BCHFDELX                                                         
*                                                                               
         CLC   PBDDATE,PBQCHGEN       KEEP IF DELETED BEFORE END                
         BNH   BCHFKEEP                                                         
*                                     ELSE CONTINUE                             
BCHFDELX DS    0H                                                               
*                                                                               
BCHFDTEX DS    0H                                                               
*                                                                               
BCHFLOOP DS    0H                  FIND CHANGE ELEMENTS                         
*                                                                               
         USING PCHGELD,R6          ESTABLISH CHANGE ELEMENT                     
*                                                                               
         CLI   PCHGELEM,0          DONE AT END OF RECORD                        
         BE    BCHFDONE                                                         
*                                                                               
         CLI   PCHGELEM,PCHGELQ    SKIP IF NOT A CHANGE ELEMENT                 
         BNE   BCHFCONT                                                         
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATCON-COMFACSD(RF)    DATCON ADDRESS                        
*                                                                               
         GOTOR (RF),PARM,(2,PCHGDAT),(3,WORK) DATE TO BINARY                    
*                                                                               
         CLC   WORK(3),PBQCHGST    IF CHANGED ON OR AFTER START                 
         BL    BCHFCONT                                                         
*                                                                               
         OC    PBQCHGEN,PBQCHGEN      CONTINUE IF NO END DATE                   
         BZ    BCHFCHG1                                                         
*                                                                               
         CLC   WORK(3),PBQCHGEN       ELSE MUST BE CHANGED BEFORE END           
         BH    BCHFCONT                                                         
*                                                                               
BCHFCHG1 DS    0H                                                               
*                                                                               
         XC    WORK,WORK           INIT WORKAREA                                
*                                                                               
*        COLLECT ALL CHANGE INDICATORS IN WORK AREA                             
*                                                                               
         MVC   WORK(1),PCHGIND1    FIRST  SET OF CHANGES                        
         MVC   WORK+1(1),PCHGIND2  SECOND SET OF CHANGES                        
         MVC   WORK+2(1),PCHGIND3  THIRD  SET OF CHANGES                        
         MVC   WORK+3(1),PCHGIND4  FOURTH SET OF CHANGES                        
*                                                                               
         CLI   PCHGLEN,PCHGOLDS    DONE IF OLD SHORT ELEMENT                    
         BNH   BCHF10                                                           
*                                                                               
         CLI   PCHGLEN,PCHGOLDL    DONE IF OLD LONG  ELEMENT                    
         BE    BCHF10                                                           
*                                                                               
*        CHANGE ELEMENT HAS PID AND CHG INDICATORS AT END                       
*                                                                               
         LLC   RF,PCHGLEN          GET ELEMENT LENGTH                           
         SHI   RF,1                                                             
         LA    R1,PCHGELEM(RF)     POINT TO LAST BYTE OF ELEMENT                
*                                                                               
         MVC   WORK+4(1),0(R1)     FIFTH  SET OF CHANGES                        
*                                                                               
BCHF10   DS    0H                                                               
*                                                                               
         TM    PBQBCHOP,PBQBCHPS   IF POSITIVE FILTER                           
         BNO   BCHF20                                                           
*                                                                               
         NC    WORK(L'PBQBCHGS),PBQBCHGS  KILL UNWANTED CHANGES                 
         BNZ   BCHFKEEP            SOME CHANGES - KEEP IN REPORT                
*                                                                               
         B     BCHFCONT                                                         
*                                                                               
BCHF20   DS    0F                  NEGATIVE FILTER                              
*                                                                               
         MVC   WORK+16(16),=16X'FF' SET MASK                                    
         XC    WORK+16(L'PBQBCHGS),PBQBCHGS  KILL EXCLUDED CHANGES              
         NC    WORK(L'PBQBCHGS),WORK+16   CHECK FOR OTHER CHANGES               
         BNZ   BCHFKEEP            KEEP IF STILL SOME CHANGES                   
*                                                                               
BCHFCONT DS    0H                                                               
*                                                                               
         LLC   RF,PCHGLEN          BUMP TO NEXT ELEMENT                         
         LA    R6,0(RF,R6)                                                      
         B     BCHFLOOP                                                         
*                                                                               
BCHFDONE DS    0H                                                               
*                                                                               
BCHFDROP DS    0H                                                               
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
         B     BCHFLTX                                                          
*                                                                               
BCHFKEEP DS    0H                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
BCHFLTX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C- PRWRIIO - RESTORE ALL HIDDEN ELMS - ELMRSTR'           
***********************************************************************         
*                                                                     *         
*        RESTORE ALL HIDDEN ELEMENTS                                  *         
*                                                                     *         
*NTRY    R2==>  BUY RECORD                                            *         
*        R6==>  CURRENT ELEMENT                                       *         
*                                                                     *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ELMRSTR  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
         USING PBUYRECD,R2                                                      
*                                                                               
         SR    RF,RF                                                            
         LA    R1,PBDELEM          FIRST ELEMENT                                
*                                                                               
ELMRLOOP DS    0H                                                               
*                                                                               
         CLI   0(R1),0             DONE AT END OF RECORD                        
         BE    ELMRDONE                                                         
*                                                                               
         LA    R3,ELMRTAB          POINT TO TABLE OF ELMS TO RESTORE            
*                                                                               
ELMRTBLP DS    0H                                                               
*                                                                               
         CLC   0(1,R1),1(R3)       IGNORE ALL BUT ELMS TO BE RESTORED           
         BE    ELMRTBFD                                                         
*                                                                               
ELMRTBCN DS    0H                                                               
*                                                                               
         LA    R3,2(R3)            NEXT ENTRY IN TABLE                          
*                                                                               
         CLI   0(R3),X'FF'         CONTINUE IF NOT END OF TABLE                 
         BNE   ELMRTBLP                                                         
*                                                                               
         B     ELMRTBDN            NOT AN ELEMENT TO BE RESTORED                
*                                                                               
ELMRTBFD DS    0H                                                               
*                                                                               
         MVC   0(1,R1),0(R3)       MAKE IT A RESTORED ELEMENT                   
*                                                                               
ELMRTBDN DS    0H                                                               
*                                                                               
ELMRCONT DS    0H                                                               
*                                                                               
         IC    RF,1(R1)            BUMP TO NEXT ELEMENT                         
         LA    R1,0(RF,R1)                                                      
         B     ELMRLOOP                                                         
*                                                                               
ELMRDONE DS    0H                                                               
*                                                                               
ELMRSTRX DS    0H                                                               
         XIT1                                                                   
*                                                                               
ELMRTAB  DS    0D                  TABLE FOR HIDING ELEMENTS                    
         DC    X'44',X'FA'         ADDITIONAL CHARGE ELEMENT                    
         DC    X'25',X'FB'         PAY ELEMENT                                  
         DC    X'26',X'FC'         BILL ELEMENT                                 
         DC    X'28',X'FD'         OPEN   BILL ELEMENT                          
         DC    X'29',X'FE'         REBATE BILL ELEMENT                          
         DC    X'FF'                                                            
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C- PRWRIIO - READ BUYS FOR CONTRACT - CONTBUYS'           
***********************************************************************         
*                                                                     *         
*        READ BUYS FOR CONTRACT                                       *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT    IO1    CONTAINS BUY RECORD                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
CONTBUYS NMOD1 0,**+CBY**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEY AREA AS BUY KEY                
         USING PBUYRECD,R2                                                      
*                                                                               
*        USE PUB ORDER PASSSIVE POINTER                                         
*          BECAUSE WE ARE DEALING WITH ONE ONLY PUB AT A TIME                   
*                                                                               
         MVC   PBUYPAGY,PBAGY      SET AGENCY                                   
         MVC   PBUYPMED,PBMED      SET MEDIA                                    
         MVI   PBUYPRCD,PBUYPIDQ   SET POINTER ID                               
         MVC   PBUYPCLT,PBCLT      SET CLIENT                                   
*                                                                               
         L     RF,AIO2             GET ADDRESS OF CONTRACT                      
         MVC   PBUYPPUB,PCONKPUB-PCONKEY(RF)   SET PUB                          
         MVC   PBUYPZON,PCONKZON-PCONKEY(RF)   SET ZONE                         
         MVC   PBUYPEDT,PCONKEDT-PCONKEY(RF)   SET EDITION                      
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR ADVERTISER CLIENT                         
         BNE   CBYBUY05                                                         
*                                                                               
         GOTO1 GTAGYPUB,PARM,PBUYPPUB    FIND AGENCY PUB ID                     
         BNE   CBYBUYDN            AGENCY ID NOT FOUND                          
*                                                                               
         MVC   PBUYPPUB(6),PAOPUB   USE AGENCY PUB- CONTRACTS'S IS AOR          
*                                                                               
CBYBUY05 DS    0H                                                               
*                                                                               
         CLC   PBQPRD,=C'ALL'      SKIP IF ALL OR NO PRODUCTS ASKED FOR         
         BE    CBYBUY10                                                         
         CLC   PBQPRD,BLANKS                                                    
         BNH   CBYBUY10                                                         
*                                                                               
         MVC   PBUYPPRD,PBQPRD  ELSE SET REQUESTED PRODUCT                      
*                                                                               
CBYBUY10 DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR ADVERTISER CLIENT                         
         BNE   *+14                                                             
         ICM   RF,15,PBUTLA           SET UTL                                   
         MVC   4(1,RF),PAOSE            TO BUYING AGENCY                        
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL READ POINTERS WITH DELETED BUYS         
*                                                                               
CBYBUYLP DS    0H                                                               
*                                                                               
         XC    PBPCEBLD,PBPCEBLD   INIT PC BILL EFD                             
         XC    PBPCACDT,PBPCACDT   INIT PC ACTUALIZATION DATE                   
*                                                                               
         LA    R2,IOKEY            RE-POINT TO KEY AREA                         
*                                                                               
         CLC   PBUYPKEY(PBUYPPRD-PBUYPKEY),IOKEYSAV  A/M/TY/CL/PUB              
         BNE   CBYBUYDN            DONE NO MORE BUYS                            
*                                                                               
* TEST TO SEE IF DIRECTORY RECORD IS DELETED AND IF SO CHECK TO SEE             
* IF BILLABLE OR PAYABLE DATA REQUESTED                                         
*                                                                               
         CLI   IOKEY+25,X'FF'      REJECT PURGED RECORDS                        
         BE    CBYBUYCN                                                         
*                                                                               
*        FILTER ON DELETED/NON-DELTED STATUS                                    
*                                                                               
CBYDEL   DS    0H                                                               
*                                                                               
         CLI   PBQTEST,C'D'        IF ONLY DELETED TO BE PROCESSED              
         BNE   CBYDEL10                                                         
*                                                                               
         TM    IOKEY+25,X'80'         TEST IF DELETED AND                       
         BNO   CBYBUYCN               REJECT NON-DELETED BUYS                   
         B     CBYDELX                                                          
*                                                                               
CBYDEL10 DS    0H                  ELSE                                         
*                                                                               
         TM    IOKEY+25,X'80'        ACCEPT NON-DELETED BUYS                    
         BNO   CBYDELX                                                          
*                                  ELSE                                         
         TM    PBQPOPT,PBQPODEL    INCLUDE DELETED BUYS REGARDLESS L10          
         BO    CBYDELX             OF WHAT WAS REQUESTED? - YES    L10          
*                                                                               
         TM    PBQSPLOP,X'78'     BILLABLE PAYABLE BILLED OR PAID               
         BM    CBYDELX            TEST TO SEE IF DELETED BUYS                   
*                                                                               
         CLI   PBQFLTDA,0          FILTERING ON BILLING OR PAID DATA            
         BE    CBYBUYCN             NONE -- BYPASS RECORD                       
*                                                                               
         CLI   PBQFLTDA,C'P'        PAID DATA                                   
         BE    CBYDELX                                                          
*                                                                               
         CLI   PBQFLTDA,C'B'        BILLED DATA                                 
         BE    CBYDELX                                                          
*                                                                               
         CLI   PBQFLTDA,C'I'        UNBILLED                                    
         BE    CBYDELX                                                          
*                                                                               
         CLI   PBQFLTDA,C'A'        PAYABLE                                     
         BE    CBYDELX                                                          
*                                                                               
         BNE   CBYBUYCN            ELSE REJECT                                  
*                                                                               
CBYDELX  DS    0H                                                               
*                                                                               
         MVI   FLAG,C'N'           INDICATE BUY NOT READ                        
*                                                                               
*        FILTER ON PRODUCT                                                      
*                                                                               
CBYCPRD  DS    0H                                                               
*                                                                               
         L     R8,AIO2             ESTABLISH CONTRACT RECORD                    
         USING PCONRECD,R8                                                      
*                                                                               
         CLI   PCONPRD,X'C0'       SKIP UNLESS PRODUCT CONTRACT                 
         BNH   CBYCPRDX                                                         
*                                                                               
         CLC   PBUYPPRD,PCONPRD    FILTER PRODUCTS / THIS IS 21 REC             
         BE    CBYCPRDX            ACCEPT IF PRODUCT MATCHES                    
         BH    CBYBUYDN            ELSE BREAK IN PRODUCT - DONE                 
*                                                                               
*     LOW PRODUCT-- SKIP TO ACTUAL PRODUCT                                      
*                                                                               
         MVC   PBUYPPRD,PCONPRD    RESET PRODUCT                                
         MVC   PBUYPDAT,PCONSDT    CLEAR DATE                                   
         XC    PBUYPEST,PBUYKEST   ESTIMATE                                     
         XC    PBUYPACT,PBUYKACT   ACTIVE PRODUCT                               
         XC    PBUYPLIN,PBUYKLIN   LINE NUMBER                                  
*                                                                               
         B     CBYBUYNX                                                         
*                                                                               
CBYCPRDX DS    0H                                                               
*                                                                               
*        FILTER ON REQUEST DATES                                                
*                                                                               
CBYQDTE  DS    0H                                                               
*                                                                               
         CLI   PBQCNRLE,C'Y'       SKIP IF CONTRACT RULED REQUEST               
         BE    CBYQDTEX                                                         
*                                                                               
         CLC   PBUYPDAT,KEYBST     IF BEFORE REQUEST START                      
         BNL   CBYQDTE1                                                         
*                                                                               
         MVC   PBUYPDAT,KEYBST        BUMP TO REQUEST START                     
         XC    PBUYPEST,PBUYKEST      CLEAR ESTIMATE                            
         XC    PBUYPACT,PBUYKACT      CLEAR ACTIVE PRODUCT                      
         XC    PBUYPLIN,PBUYKLIN      CLEAR  LINE NUMBER                        
*                                                                               
         B     CBYBUYNX                                                         
*                                                                               
CBYQDTE1 DS    0H                                                               
*                                                                               
         CLC   PBUYPDAT,KEYBST+3     REJECT IF AFTER REQUEST END                
         BH    CBYBUYCN                                                         
*                                                                               
*  BUY FALLS WITHIN REQUEST START AND END DATE // NOW SEE IF                    
*          IT FALLS WITHIN CONTRACT START AND END                               
*                                                                               
CBYQDTEX DS    0H                                                               
*                                                                               
*        FILTER ON CONTRACT DATES                                               
*                                                                               
CBYCDTE  DS    0H                                                               
*                                                                               
*        INSERT DATE MUST LIE WITHIN CONTRACT PERIOD                            
*                                                                               
         CLC   PBUYPDAT,PCONSDT    IF INSERT BEFORE CONTRACT                    
         BNL   CBYCDTE1                                                         
*                                                                               
         MVC   PBUYPDAT,PCONSDT       BUMP TO CONTRACT START                    
         XC    PBUYPEST,PBUYKEST      CLEAR ESTIMATE                            
         XC    PBUYPACT,PBUYKACT      CLEAR ACTIVE PRODUCT                      
         XC    PBUYPLIN,PBUYKLIN      CLEAR  LINE NUMBER                        
*                                                                               
         B     CBYBUYNX                                                         
*                                                                               
CBYCDTE1 DS    0H                                                               
*                                                                               
         CLC   PBUYPDAT,PCONEDT    ACCEPT IF NOT AFTER CONTRACT END             
         BNH   CBYCDTEX                                                         
*                                                                               
         MVI   PBUYPDAT,X'FF'      ELSE BUMP TO NEXT PRODUCT                    
*                                                                               
         B     CBYBUYNX                                                         
*                                                                               
CBYCDTEX DS    0H                                                               
*                                                                               
*        FILTER ON PRODUCT/EST                                                  
*                                                                               
         GOTO1 =A(FNDPRD)             VERIFY PRODUCT                            
         BNE   CBYBUYCN               REJECTED                    BUG04         
*                                                                               
*        FILTER ON ESTIMATE                                                     
*                                                                               
         BAS   RE,FLTREST          FILTER ON ESTIMATE                           
         BNE   CBYBUYCN              REJECTED                                   
*                                                                               
         LA    R8,SESTDATA         POINT TO SAVED DATA                          
         USING ESTBUFFD,R8         ESTABLISH ESTIMATE DATA                      
*                                                                               
         MVC   PBPCEBLD,EBFPCBLD   SAVE PC BILL EFD                             
         MVC   PBPCACDT,EBFPCACD   SAVE PC ACTUALIZATION DATE                   
*                                                                               
         DROP  R8                                                               
*                                                                               
*                                                                               
*        FILTER ON REQUESTED PRODUCT                                            
*                                                                               
CBYQPRD  DS    0H                                                               
*                                                                               
         XC    PASSPRD,PASSPRD     INIT PASSIVE PRODUCT CODE                    
*                                                                               
         CLC   PBQPRD,=C'ALL'      SKIP IF DOING ALL PRODUCTS                   
         BE    CBYQPRDX                                                         
*                                                                               
         CLC   IOKEY+13(3),=C'ZZZ' SKIP IF DOING PRODUCT POOL                   
         BE    CBYQPRDX                                                         
*                                                                               
         CLC   PBQPRD,PBUYPPRD     FILTER ON PRODUCT                            
         BNE   CBYBUYCN                                                         
*                                                                               
CBYQPRDX DS    0H                                                               
*                                                                               
*        READ BUY RECORD                                                        
*                                                                               
         MVC   PBABUY,IOKEY+27     SAVE DISK ADDRESS OF BUY                     
*                                  MAY BE USED IN DRIVER                        
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1+IORDEL                                    
         BNL   *+6                 NO HARD ERRORS TOLERATED                     
         DC    H'0'                                                             
*                                                                               
         L     R2,AIO1             POINT TO READ RECORD                         
*                                                                               
*        FILTER ON SPACE DESCRIPTION IF REQUESTED                               
*                                                                               
CBYSPC   DS    0H                                                               
*                                                                               
         CLI   PBDSPACE,255        OUTDOOR HAS SPECIAL CODING                   
         BE    CBYSPCOD            IN SPACE // WILL FAIL ALL                    
*                                  TESTS FOR SPACE FILTERING                    
*                                                                               
         TM    PBBYOPTS,PBBYCSPQ   IF BUY MUST BELONG TO CONTRACT               
         BNO   *+12                                                             
         CLI   PBDSPACE,C'*'          DROP IF SPACE(1) IS C'*'                  
         BE    CBYBUYCN                                                         
*                                                                               
         OC    PBDSPACE,BLANKS     FORCE UPPERCASE SPACE DESCRIPTION            
*                                                                               
         GOTO1 SPCFLT,PARM,PBDSPACE FILTER ON SPACE DESCRIPTION                 
         BE    CBYSPCX             KEEP - PASSES FILTER                         
         B     CBYSPC50            DROP - FAILS FILTER                          
*                                                                               
CBYSPCOD DS    0H                                                               
*                                                                               
         CLI   PBMED,C'O'          SKIP UNLESS OUTDOOR                          
         BNE   CBYSPC50                                                         
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,X'66'        LOOKING FOR FIRST COMMENT ELEMENT            
*                                                                               
         BAS   RE,NXTELM           FIND 1ST/NEXT COMMENT ELM                    
         BNE   CBYSPC30            NONE FOUND                                   
*                                                                               
         CLI   1(R6),19            MAXIMUM 17 BYTES TO BE CONSIDERED            
         BNH   CBYSPC40                                                         
*                                                                               
CBYSPC30 DS    0H                                                               
*                                                                               
         TM    PBQSPD1L,X'80'      ACCEPT IF NEGATIVE SPACE FILTERS             
         BO    *+8                                                              
         TM    PBQSPD2L,X'80'                                                   
         BO    CBYSPCX                                                          
         B     CBYSPC50            ELSE REJECT                                  
*                                                                               
CBYSPC40 DS    0H                                                               
*                                                                               
         GOTO1 SPCFLT,PARM,2(6)    FILTER ON SPACE DESCRIPTION                  
         BE    CBYSPCX             KEEP - PASSES FILTER                         
*                                                                               
CBYSPC50 DS    0H                                                               
*                                                                               
         B     CBYBUYCN            REJECT BUY RECORD                            
*                                                                               
CBYSPCX  DS    0H                                                               
*                                                                               
*        FILTER ON INVOICE MATCHED STATUS                                       
*                                                                               
         TM    PBQMATSW,PBQMATYQ   IF MATCHED ONLY                              
         BNO   CBYMAT10                                                         
*                                                                               
         TM    PBDSTAT,X'40'          DROP IF NOT MATCHED                       
         BNO   CBYBUYCN                                                         
         B     CBYMAT40                                                         
*                                                                               
CBYMAT10 DS    0H                                                               
*                                                                               
         TM    PBQMATSW,PBQMATNQ   IF UNMATCHED ONLY                            
         BNO   CBYMAT40                                                         
*                                                                               
         TM    PBDSTAT,X'40'          DROP IF MATCHED                           
         BO    CBYBUYCN                                                         
*                                                                               
CBYMAT40 DS    0H                                                               
*                                                                               
*        FILTER ON NEW INVOICE MATCHED STATUS                                   
*                                                                               
         TM    PBQMATS2,PBQNMTYQ   IF MATCHED ONLY                              
         BNO   CBYNMT10                                                         
*                                                                               
         MVI   ELCODE,PBMATELQ     FIND NEW INVOICE MATCH ELEMENT               
         L     R6,AIO1             POINT TO BUY RECORD                          
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   CBYBUYCN            NOT FOUND - DROP                             
*                                                                               
         USING PBMATELD,R6         ESTABLISH MATCH STATUS ELEMENT               
*                                                                               
         CLI   PBMTSTAT,PBMTSMTQ      DROP IF NOT MATCHED                       
         BNE   CBYBUYCN                                                         
         B     CBYNMT40                                                         
*                                                                               
CBYNMT10 DS    0H                                                               
*                                                                               
         TM    PBQMATS2,PBQNMTNQ   IF UNMATCHED ONLY                            
         BNO   CBYNMT40                                                         
*                                                                               
         MVI   ELCODE,PBMATELQ     FIND NEW INVOICE MATCH ELEMENT               
         L     R6,AIO1             POINT TO BUY RECORD                          
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   CBYNMT40            NOT FOUND - KEEP                             
*                                                                               
         USING PBMATELD,R6         ESTABLISH MATCH STATUS ELEMENT               
*                                                                               
         CLI   PBMTSTAT,PBMTSMTQ      DROP IF MATCHED                           
         BE    CBYBUYCN                                                         
         B     CBYNMT40                                                         
*                                                                               
CBYNMT40 DS    0H                                                               
*                                                                               
*        FILTER ON NEW INVOICE NO FILTER STATUS                                 
*                                                                               
         TM    PBQMATS2,PBQNVNIQ   IF NO INVOICE BUYS ONLY                      
         BNO   CBYNVNIX                                                         
*                                                                               
         MVI   ELCODE,PBMATELQ     FIND NEW INVOICE MATCH ELEMENT               
         L     R6,AIO1             POINT TO BUY RECORD                          
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   CBYNVNIX            NOT FOUND - KEEP                             
*                                                                               
         USING PBMATELD,R6         ESTABLISH MATCH STATUS ELEMENT               
*                                                                               
         CLI   PBMTSTAT,PBMTSNIQ      DROP IF NOT NO INVOICE                    
         BNE   CBYBUYCN                                                         
*                                                                               
CBYNVNIX DS    0H                                                               
*                                                                               
*        FILTER ON NEW INVOICE DISCREPANCY STATUS                               
*                                                                               
CBYDSTF  DS    0H                                                               
*                                                                               
         CLI   PBQDSTA,0           SKIP IF NO FILTERING ON DSTA                 
         BE    CBYDSTFX                                                         
*                                                                               
         MVI   ELCODE,PBMATELQ     FIND NEW INVOICE MATCH ELEMENT               
         L     R6,AIO1             POINT TO BUY RECORD                          
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   CBYBUYCN            NOT FOUND - DROP                             
*                                                                               
         USING PBMATELD,R6         ESTABLISH MATCH STATUS ELEMENT               
*                                                                               
         CLC   PBQDSTA,PBMTDSTA    MATCH ON DISCREPANCY STATUS                  
         BNE   CBYBUYCN            NE - DROP BUY                                
*                                                                               
CBYDSTFX DS    0H                                                               
*                                                                               
*        FILTER ON INVOICE TEARSHEET STATUS                                     
*                                                                               
         TM    PBQMATSW,PBQTSHYQ   IF TEARSHEETS ONLY                           
         BNO   CBYTSH10                                                         
*                                                                               
         TM    PBDSTAT,X'10'          DROP IF NO TEARSHEET                      
         BNO   CBYBUYCN                                                         
         B     CBYTSH40                                                         
*                                                                               
CBYTSH10 DS    0H                                                               
*                                                                               
         TM    PBQMATSW,PBQTSHNQ   IF NO TEARSHEET ONLY                         
         BNO   CBYTSH40                                                         
*                                                                               
         TM    PBDSTAT,X'10'          DROP IF TEARSHEET                         
         BO    CBYBUYCN                                                         
*                                                                               
CBYTSH40 DS    0H                                                               
*                                                                               
*        FILTER ON TEARSHEET STATUS VALUES                                      
*                                                                               
CBYTSS   DS    0H                                                               
*                                                                               
         CLI   PBQTSSTA,0          IF TEARSHEET STATUS PRESENT                  
         BE    CBYTSSX                                                          
*                                                                               
         MVI   ELCODE,X'95'        FIND TEARSHEET ELEMENT                       
         L     R6,AIO1             POINT TO BUY RECORD                          
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   CBYTSS40            NOT FOUND                                    
*                                                                               
         USING PTSHTEL,R6          ESTABLISH TEARSHEET ELEMENT                  
*                                                                               
         CLC   PBQTSSTA,PTSHSTAT   OKAY IF STATUS MATCHES FILTER                
         BE    CBYTSSX                                                          
*                                                                               
         CLI   PBQTSSTA,C'X'       IF BUYS WITH NO TEARSHEET WANTED             
         BNE   CBYBUYCN            ELSE DROP BUY                                
*                                                                               
         CLI   PTSHSTAT,C' '          DROP IF TEARSHEET ENTERED                 
         BH    CBYBUYCN                                                         
         B     CBYTSSX             ELSE KEEP                                    
*                                                                               
CBYTSS40 DS    0H                  NO TEARSHEET ELEMENT                         
*                                                                               
         CLI   PBQTSSTA,C'X'       OKAY IF MISSING TSHEETS WANTED               
         BE    CBYTSSX                                                          
*                                                                               
         B     CBYBUYCN            ELSE DROP BUY                                
*                                                                               
CBYTSSX  DS    0H                                                               
*                                                                               
*        FILTER ON REFERENCE NUMBER IF NEEDED                                   
*                                                                               
CBYREF   DS    0H                                                               
*                                                                               
         CLC   PBREFFLT,BLANKS     SKIP IF NO FILTER GIVEN                      
         BNH   CBYREFX                                                          
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,PBREFELQ     LOOKING FOR REFERENCE ELEMENT                
*                                                                               
         BAS   RE,NXTELM           FIND 1ST/NEXT ELM                            
         BNE   CBYBUYCN            NONE FOUND - DROP                            
*                                                                               
         USING PBREFELD,R6         ESTABLISH REFERENCE ELEMENT                  
*                                                                               
         MVC   WORK,BLANKS         INIT WORKAREA                                
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R6)            GET FILTER LENGTH                            
         SH    RF,=Y(PBREFNO-PBREFELD)  REF NUMBER LENGTH                       
         BNP   CBYBUYCN            NO NUMBER - REJECT                           
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),PBREFNO     MOVE REFERENCE NUMBER TO WORKAREA            
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,PBREFFLL       LENGTH OF REFERENCE NO FILTER                
         BZ    CBYREFX             NO LENGTH ASSUME MATCH                       
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   PBREFFLT(0),WORK    MATCH TO FILTER                              
         BNE   CBYBUYCN            REJECT BUY IF NO MATCH                       
*                                                                               
CBYREFX  DS    0H                                                               
*                                                                               
         MVI   FLAG,C'Y'           INDICATE BUY RECORD READ                     
*                                                                               
*        FILTER ON TEST/STEWARD BUY STATUS                                      
*              STEWARD IS A SPECIAL TEST BUY                                    
*                                                                               
CBYTST   DS    0H                                                               
*                                                                               
*        LIVE BUY                                                               
*                                                                               
         CLI   PBDBFD,C'T'         IF LIVE BUY                                  
         BE    CBYTST20                                                         
*                                                                               
         CLI   PBQTEST,C'T'           IF TSTONLY FILTER                         
         BE    CBYBUYCN                  REJECT                                 
         TM    PBQOPSTW,PBQSTWOQ      IF STEWARDONLY FILTER                     
         BO    CBYBUYCN                  REJECT                                 
*                                                                               
         B     CBYTSTX                ELSE ACCEPT                               
*                                                                               
*        TEST BUY                                                               
*                                                                               
CBYTST20 DS    0H                                                               
*                                                                               
         TM    PBDSTAT2,X'40'      IF TEST BUY (AND NOT STEWARD)                
         BO    CBYTST40                                                         
*                                                                               
         CLI   PBQTEST,C'Y'           IF LIVE AND TEST BUYS                     
         BE    CBYTSTX                   ACCEPT                                 
         CLI   PBQTEST,C'T'           IF TEST ONLY BUYS                         
         BE    CBYTSTX                   ACCEPT                                 
*                                                                               
         B     CBYBUYCN               ELSE REJECT                               
*                                                                               
*        STEWARD BUY                                                            
*                                                                               
CBYTST40 DS    0H                                                               
*                                                                               
         TM    PBQOPSTW,PBQSTWYQ+PBQSTWOQ                                       
         BNZ   CBYTSTX                   ACCEPT IF FILTERING ON STEWARD         
*                                                                               
         B     CBYBUYCN                  ELSE REJECT                            
*                                                                               
CBYTSTX  DS    0H                                                               
*                                                                               
*        FILTER ON HELD BUY STATUS IF REQUESTED                                 
*                                                                               
CBYHLD   DS    0H                                                               
*                                                                               
         CLI   PBQHLDSW,0          SKIP IF NO SWITCHES ON                       
         BE    CBYHLDXX                                                         
*                                                                               
         TM    PBQHLDSW,PBQHLDOQ   IF ONLY HELD BUYS REQUESTED                  
         BNO   CBYHLDN                                                          
*                                                                               
         TM    PBDSTAT,X'08'          ACCEPT ONLY HELD BUYS                     
         BNO   CBYBUYCN                                                         
*                                                                               
         B     CBYHLDX                                                          
*                                                                               
CBYHLDN  DS    0H                  IF EXCLUDING HELD BUYS                       
*                                                                               
         TM    PBQHLDSW,PBQHLDOQ                                                
         BNO   CBYRELN                                                          
*                                                                               
         TM    PBDSTAT,X'08'          REJECT HELD BUYS                          
         BO    CBYBUYCN                                                         
*                                                                               
CBYRELN  DS    0H                                                               
*                                                                               
CBYHLDX  DS    0H                                                               
*                                                                               
*        FILTER ON STAR RATE BUYS IF REQUESTED                                  
*                                                                               
         TM    PBQHLDSW,PBQHSROQ   IF ONLY *RATE BUYS REQUESTED                 
         BNO   CBYSRON                                                          
*                                                                               
         TM    PBDRLIND,X'08'         ACCEPT ONLY FROZEN BUYS                   
         BNO   CBYBUYCN                                                         
*                                                                               
CBYSRON  DS    0H                  IF EXCLUDING *RATE BUYS                      
*                                                                               
         TM    PBQHLDSW,PBQHSRNQ                                                
         BNO   CBYSRNN                                                          
*                                                                               
         TM    PBDRLIND,X'08'         REJECT FROZEN BUYS                        
         BO    CBYBUYCN                                                         
*                                                                               
CBYSRNN  DS    0H                                                               
*                                                                               
CBYHLDXX DS    0H                                                               
*                                                                               
*        FILTER ON OTHER CRITERIA                                               
*                                                                               
         GOTO1 =A(FLTDTE),RR=RELO    FILTER BUYS ON VARIOUS DATES               
         BNE   CBYBUYCN    IF NOT EQUAL THEN BUY DID NOT PASS TEST              
*                                                                               
         GOTO1 =A(GETPUBN),OCASHDSC,RR=RELO     READ PUB NAME                   
*                                                                               
         BNE   CBYBUYCN            FAILS FILTERING                              
*                                                                               
*        FILTER ON CASH DISCOUN Y/N                                             
*                                                                               
CBYCD    DS    0H                                                               
*                                                                               
         OC    PBQCDFLT,PBQCDFLT   SKIP IF NO CASH DISC FILTER                  
         BZ    CBYCDX                                                           
*                                                                               
         CLC   OCASHDSC+1(1),PBQCDFLT     REJECT IF THIS NOT A CD PUB           
         BNE   CBYBUYCN                                                         
*                                                                               
CBYCDX   DS    0H                                                               
*                                                                               
*        FILTER ON PO# OPTIONS                                                  
*                                                                               
CBYPO#   DS    0H                                                               
*                                                                               
         CLI   PBQPO#OP,0          SKIP IF NOT FILTERING ON PO#                 
         BE    CBYPO#X                                                          
*                                                                               
         LA    R8,SESTDATA         ESTABLISH SAVED EST BUFFER ENTRY             
         USING ESTBUFFD,R8                                                      
*                                                                               
         MVI   ELCODE,PBYPOELQ                                                  
         LA    R6,PBUYKEY          POINT TO BUY RECORD                          
         BRAS  RE,GETEL            FIND PO# ELEMENT                             
*                                                                               
CBYPO#LP DS    0H                                                               
*                                                                               
         BNE   CBYPO#NF            NONE FOUND                                   
*                                                                               
         USING PBYPOELD,R6         ESTABLISH AS PO# ELEMENT                     
*                                                                               
         TM    PBYPOSTA,BYPOZZZQ   FOUND IF NOT ZZZ BUY                         
         BNO   CBYPO#FD                                                         
*                                                                               
         CLC   PBPROD,PBYPOPRD     CHECK THAT PO# FOR CURRENT PRODUCT           
         BE    CBYPO#FD            YES                                          
*                                  NO                                           
CBYPO#CN DS    0H                                                               
*                                                                               
         BRAS  RE,NEXTEL           READ NEXT PO# ELEMENT                        
         B     CBYPO#LP                                                         
*                                                                               
CBYPO#FD DS    0H                                                               
*                                  PO# ELEMENT FOUND                            
         TM    PBQPO#OP,PBQPO#XQ   IF REPORTING BUYS W/O PO#                    
         BO    CBYBUYCN               DROP                                      
         TM    PBQPO#OP,PBQPO#NQ   IF REPORTING BUYS NEEDING PO#                
         BO    CBYBUYCN               DROP                                      
*                                                                               
         B     CBYPO#X             ELSE KEEP                                    
*                                                                               
CBYPO#NF DS    0H                  BUY HAS NO PO#                               
*                                                                               
         TM    PBQPO#OP,PBQPO#XQ   IF REPORTING BUYS W/O PO#                    
         BO    CBYPO#X                KEEP                                      
*                                                                               
         TM    PBQPO#OP,PBQPO#OQ   IF REPORTING BUYS WITH PO#                   
         BO    CBYBUYCN               DROP                                      
*                                                                               
         TM    PBQPO#OP,PBQPO#NQ   IF REPORTING BUYS NEEDING PO#                
         BNO   CBYPO#X                ELSE KEEP                                 
         TM    EBFIND,EBFIPO#         IF ESTIMATE HAS PO#'S                     
         BO    CBYPO#X                   KEEP                                   
*                                                                               
         B     CBYBUYCN            ELSE DROP                                    
*                                                                               
CBYPO#X  DS    0H                                                               
*                                                                               
*        FILTER ON REGIONS OR DISTRICTS                                         
*                                                                               
CBYDRD   DS    0H                                                               
*                                                                               
         CLC   PBQRGN,BLANKS       SKIP IF NO REGIONS REQUESTED                 
         BH    *+10                                                             
         CLC   PBQDST,BLANKS       AND  IF NO DISTRICTS REQUESTED               
         BNH   CBYDRDX                                                          
*                                                                               
         GOTO1 =A(FLTDRD),PARM,RR=RELO   FILTER ON REGIONS/DISTRICTS            
         CLI   3(R1),C'N'          REJECT IF IT DIDN'T PASS FILTERING           
         BE    CBYBUYCN                                                         
*                                                                               
CBYDRDX  DS    0H                                                               
*                                                                               
*  EXPAND BUY RECORD INTO USABLE PARTS                                          
*                                                                               
*======= NOTE PBYOCTL  AND PYBOCTL2  MUST BE SET FOR FIELDS NEEDED              
*          SEE DOCUMENTATION                                                    
*                                                                               
CBYEXP   DS    0H                                                               
*                                                                               
         LA    R6,PPBYOUTC         ESTABLISH PPBYOUT AREA                       
         USING PPBYOUTD,R6                                                      
*                                                                               
         MVI   PBYOCTL,X'28'        GENERATE COMMENTS AND ZZZ SPLIT             
         MVI   PBYOCLT2,X'20'       GENERATE COMPACT ZZZ ALLOC                  
         MVC   PBYOINPT,AIO1        BUY RECORD                                  
         LA    RF,PBGRS             GETINP                                      
         ST    RF,PBYOVALS                                                      
         L     RF,PBCOMFAC                                                      
         MVC   PBYODTCN,CDATCON-COMFACSD(RF) DATE CONVERSION                    
*                                                                               
         GOTO1 =V(PPBYOUT),PARM,PPBYOUTD,RR=RELO                                
*                                                                               
CBYEXPX  DS    0H                                                               
*                                                                               
         DROP  R6                                                               
*                                                                               
         CLC   PBQADC,=CL6' '   FILTER ON AD CODE                               
         BNH   *+14                                                             
         CLC   PBQADC,PBDJOB    MUST BE THE SAME                                
         BNE   CBYBUYCN                                                         
*                                                                               
         CLC   PBQADFLT,=CL6' '    SKIP IF NO AD FILTER GIVEN                   
         BNH   CBYADFLX                                                         
*                                                                               
         GOTO1 =A(FLTAD)           FILTER ON AD                                 
         BNE   CBYBUYCN            DROP IF IT DOESN'T PASS FILTER               
*                                                                               
CBYADFLX DS    0H                                                               
*                                                                               
*        FILTER ON UPID                                                         
*                                                                               
         OC    PBUPIDFL,PBUPIDFL   SKIP IF NO FILTER AROUND                     
         BZ    CBYUPIDX                                                         
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,X'90'        SET TO READ UPLOAD ELEMENT                   
         BRAS  RE,NXTELM           FIND 1ST/NEXT ELM                            
         BNE   CBYBUYCN            DROP IF NONE FOUND                           
*                                                                               
         USING PIUPEL,R6           ESTABLISH UPLOAD ELEMENT                     
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,PBUPIDCL       GET COMPARE LENGTH FOR FILTER                
         BZ    CBYUPIDX            SKIP IF NO FILTER                            
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   PIUPUSEQ(0),PBUPIDST   UPID MUST LIE IN RANGE                    
         BL    CBYBUYCN                                                         
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   PIUPUSEQ(0),PBUPIDEN                                             
         BH    CBYBUYCN                                                         
*                                                                               
CBYUPIDX DS    0H                                                               
*                                                                               
*        FILL IN PRNTBLOCK FIELDS                                               
*                                                                               
         MVC   PBPUB(L'PBPUB+L'PBZONE+L'PBACTED),PBUYKPUB                       
         MVC   PBINSDT,PBUYKDAT    INSERT DATE                                  
         MVC   PBACTLIN,PBUYKLIN   LINE NUMBER                                  
         MVC   PBEST,PBUYKEST      ESTIMATE                                     
*                                                                               
         MVI   PBMODE,PBPROCBY     SET CALLING MODE                             
*                                                                               
*        HOOK TO USER                                                           
*                                                                               
CBYHOOK  DS    0H                                                               
*                                                                               
*        IF PROCESSING PAY ELEMENTS                                             
*           READ NEXT PAY ELEMENT                                               
*              IF NEEDED, MATCH TO CLEARANCE STATUS TABLE ELEMENT               
*              GO TO USER FOR PROCESSING                                        
*                                                                               
CBYPAY   DS    0H                                                               
*                                                                               
         XC    PBPAYELA,PBPAYELA   INIT PAY ELEMENT ADDRESS                     
         XC    PBCLSELA,PBCLSELA   INIT CLEARANCE STATUS ELEMENT ADDR           
         XC    PBCLINVA,PBCLINVA   INIT CLEARANCE INVOICE ELEMENT ADDR          
*                                                                               
         TM    PBBYOPTS,PBBYPAYQ   SKIP IF NOT PROCESSING PAY ELEMENTS          
         BNO   CBYPAYX                                                          
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,PPAYELQ      LOOKING FOR PAY ELEMENT                      
*                                                                               
CBYPAYLP DS    0H                  PROCES PAY ELEMENTS                          
*                                                                               
         BAS   RE,NXTELM           FIND 1ST/NEXT PAY ELM                        
         BNE   CBYPAYDN            NONE FOUND                                   
*                                                                               
         ST    R6,PBPAYELA         SET PAY ELEMENT ADDRESS                      
*                                                                               
         TM    PBBYOPTS,PBBYCLSQ   SKIP IF NOT PROCESSING                       
         BNO   CBYPAY50              CLEARANCE STATUS ELEMENTS                  
*                                                                               
         GOTOR GETCLS              FIND CLEARANCE STATUS ELEMENT                
*                                                                               
         TM    PBQOPTS,PBQOXPD     IF EXCLUDING PAID BUYS                       
         JNO   CBYPAY50                                                         
*                                                                               
         OC    PBCLSELA,PBCLSELA   KEEP IF NO CHECK ELEMENT FOUND               
         JZ    CBYPAY50                                                         
*                                                                               
         ICM   R5,15,PBCLSELA      IF CHECK ELEMENT EXISTS                      
         USING PPCLEL01,R5            ESTABLISH CHECK ELEMENT                   
*                                                                               
         CLC   =C'VOID',PPCLCHK      KEEP IF CHECK WAS VOIDED                   
         JE    CBYPAY50                                                         
*                                                                               
         OC    PPCLCHK,PPCLCHK        DROP IF CHECK HAS BEEN CUT                
         JNZ   CBYPAYCN                                                         
*                                                                               
CBYPAY50 DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    CBYPAY50             PASS BACK SAME ELEMENT                      
*                                                                               
CBYPAYCN DS    0H                                                               
*                                                                               
         XC    PBPAYELA,PBPAYELA   INIT PAY ELEMENT ADDRESS                     
         XC    PBCLSELA,PBCLSELA   INIT CLEARANCE STATUS ELEMENT ADDR           
         XC    PBCLINVA,PBCLINVA   INIT CLEARANCE INVOICE ELEMENT ADDR          
*                                                                               
         B     CBYPAYLP                                                         
*                                                                               
CBYPAYDN DS    0H                                                               
*                                                                               
CBYPAYX  DS    0H                                                               
*                                                                               
*        IF PROCESSING BILL ELEMENTS                                            
*           READ NEXT BILL ELEMENT                                              
*              IF NEEDED, MATCH TO BILL HEADER TABLE ELEMENT                    
*              GO TO USER FOR PROCESSING                                        
*                                                                               
CBYBLL   DS    0H                                                               
*                                                                               
         XC    PBBLLELA,PBBLLELA   INIT BILL ELEMENT ADDRESS                    
         XC    PBBHDELA,PBBHDELA   INIT BILL HEADER TABLE ADDRESS               
         XC    PBMBTELA,PBMBTELA   INIT MEDIA TRANSFER ELEMENT ADDRESS          
         XC    PBTRNELA,PBTRNELA   INIT TRANSACTION ELEMENT ADDRESS             
*                                                                               
         TM    PBBYOPTS,PBBYBLLQ   SKIP IF NOT PROCESSING BILL ELEMENTS         
         BNO   CBYBLLX                                                          
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,PBILELQ      LOOKING FOR BILL ELEMENT                     
*                                                                               
CBYBLLLP DS    0H                  PROCESS BILL ELEMENTS                        
*                                                                               
         BAS   RE,NXTELM           FIND 1ST/NEXT BILL ELM                       
         BNE   CBYBLLDN            NONE FOUND                                   
*                                                                               
         CLC   PBPROD,PBPRD-PBILELD(R6)   MUST BE FOR CURRENT PRODUCT           
         BNE   CBYBLLCN                                                         
*                                                                               
         ST    R6,PBBLLELA         SET BILL ELEMENT ADDRESS                     
*                                                                               
         OC    PBQBRNST(6),PBQBRNST SKIP IF NO RUN DATE FILTER                  
         BZ    CBYBLL20                                                         
*                                                                               
         USING PBILELD,R6          ESTABLISH BILLING ELEMENT                    
*                                                                               
         CLC   PBLDATE,PBQBRNST    MUST LIE IN RUN DATE PERIOD                  
         BL    CBYBLLCN                                                         
         CLC   PBLDATE,PBQBRNND                                                 
         BH    CBYBLLCN                                                         
*                                                                               
CBYBLL20 DS    0H                                                               
*                                                                               
         TM    PBBYOPTS,PBBYBHTQ   SKIP IF NOT PROCESSING                       
         BNO   CBYBLLGO              BILL HEADER RECORDS                        
*                                                                               
         GOTO1 =A(GETBHD)          FIND BILL HEADER TABLE ENTRY                 
*                                                                               
*        READBUYS LOOP TO HANDLE BILL HEADER AND CASH APPLIED DATA              
*                                                                               
         ICM   R3,15,PBBHDELA      POINT TO BILL HEADER FROM CASHIER            
         BZ    CBYBLLCN               NONE FOUND                                
*                                                                               
         TM    PBBYOPT2,PBBYCSHQ   SKIP IF CASH DATA NOT WANTED                 
         BNO   CBYCSHX                                                          
*                                                                               
         LA    R3,256(R3)          POINT TO CASH APPLIED DATA                   
         USING MBTELD,R3           ESTABLISH AS MEDIA TRANSFER ELEMENT          
*                                                                               
CBYCSHLP DS    0H                                                               
*                                                                               
         CLI   MBTEL,0             DONE IF END OF RECORD REACHED                
         BE    CBYCSHDN                                                         
*                                                                               
         CLI   MBTEL,MBTELQ        SKIP IF NOT A MEDIA TRANSFER ELMENT          
         BNE   *+8                                                              
         ST    R3,PBMBTELA         SAVE ADDRESS                                 
*                                                                               
         USING TRNELD,R3           ESTABLISH AS TRANSACTION ELEMENT             
*                                                                               
         CLI   TRNEL,TRNELQ        SKIP IF NOT TRANSACTION ELEMENT              
         BE    *+8                                                              
         CLI   TRNEL,X'FF'         SKIP IF NOT TRANSACTION ELEMENT              
         BNE   CBYCSHCN                                                         
*                                                                               
         CLI   TRNTYPE,X'09'       SKIP IF ORIGINAL POSTING ELEMENT             
         BE    CBYCSHCN                                                         
*                                                                               
         CLI   TRNTYPE,X'06'       SKIP IF ORIGINAL POSTING ELEMENT             
         BE    CBYCSHCN                                                         
*                                                                               
         ST    R3,PBTRNELA         SAVE ADDRESS                                 
*                                                                               
CBYCSHGO DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOKTOUSER                                   
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    CBYCSHGO                                                         
*                                                                               
         XC    PBTRNELA,PBTRNELA   INIT CASH TRANSACTION ELEMENT ADDR           
*                                                                               
CBYCSHCN DS    0H                                                               
*                                                                               
         USING MBTEL,R3            ESTABLISH AS MEDIA TRANSFER ELEMENT          
*                                                                               
         SR    RF,RF                                                            
         IC    RF,MBTLLN           BUMP TO NEXT ELEMENT                         
         LA    R3,MBTEL(RF)                                                     
*                                                                               
         B     CBYCSHLP                                                         
*                                                                               
CBYCSHDN DS    0H                                                               
*                                                                               
         XC    PBMBTELA,PBMBTELA   INIT MEDIA TRANSFER ELEMENT ADDRESS          
*                                                                               
CBYCSHX  DS    0H                                                               
*                                                                               
CBYBLLGO DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    CBYBLLGO             PASS BACK SAME ELEMENT                      
*                                                                               
CBYBLLCN DS    0H                                                               
*                                                                               
         XC    PBBLLELA,PBBLLELA   INIT BILL ELEMENT ADDRESS                    
         XC    PBBHDELA,PBBHDELA   INIT BILL HEADER TABLE ADDRESS               
*                                                                               
         B     CBYBLLLP                                                         
*                                                                               
CBYBLLDN DS    0H                                                               
*                                                                               
         CLI   ELCODE,PBILELQ      IF FINISHED WITH BILL ELEMENT                
         BNE   *+12                                                             
         MVI   ELCODE,PBILOPNQ        LOOK FOR OPEN RATE ELEMENTS               
         B     CBYBLLLP                                                         
*                                                                               
         CLI   ELCODE,PBILOPNQ     IF FINISHED WITH OPEN RATE ELEMENT           
         BNE   *+12                                                             
         MVI   ELCODE,PBILREBQ        LOOK FOR REBATE ELEMENTS                  
         B     CBYBLLLP                                                         
*                                                                               
CBYBLLX  DS    0H                                                               
*                                                                               
*        IF PROCESSING ADDITIONAL CHARGES ELEMENTS                              
*           READ NEXT ADDITIONAL CHARGE ELEMENT                                 
*              GO TO USER FOR PROCESSING                                        
*                                                                               
CBYACH   DS    0H                                                               
*                                                                               
         XC    PBACHELA,PBACHELA   INIT ACH ELEMENT ADDRESS                     
*                                                                               
         TM    PBBYOPT2,PBBYACHQ   SKIP IF NOT PROCESSING BILL ELEMENTS         
         BNO   CBYACHX                                                          
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,X'44'        LOOKING FOR ADDL CHG ELEMENT                 
*                                                                               
CBYACHLP DS    0H                  PROCESS ACHG ELEMENTS                        
*                                                                               
         BRAS  RE,NXTELM           FIND 1ST/NEXT ACHG ELM                       
         BNE   CBYACHDN            NONE FOUND                                   
*                                                                               
         TM    PBQACHGS,PBQACOPQ+PBQAC1Q  IF SINGLE CHARGE FOR REPORT           
         BNO   CBYACH10                                                         
*                                                                               
         USING PACELEM,R6          ESTABLISH ACHG ELEMENT                       
*                                                                               
         CLC   PBQACHG,PACCODE        MUST BE FOR CHARGE CODE                   
         BNE   CBYACHCN                                                         
*                                                                               
CBYACH10 DS    0H                                                               
*                                                                               
         ST    R6,PBACHELA         SET ACHG ELEMENT ADDRESS                     
*                                                                               
CBYACHGO DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BRAS  RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    CBYACHGO             PASS BACK SAME ELEMENT                      
*                                                                               
CBYACHCN DS    0H                                                               
*                                                                               
         XC    PBACHELA,PBACHELA   INIT BILL ELEMENT ADDRESS                    
*                                                                               
         B     CBYACHLP                                                         
*                                                                               
CBYACHDN DS    0H                                                               
*                                                                               
CBYACHX  DS    0H                                                               
*                                                                               
*        IF PROCESSING NEW INVOICE ELEMENTS                                     
*           READ NEXT NEW INVOICE ELEMENT                                       
*              GO TO USER FOR PROCESSING                                        
*                                                                               
CBYPNV   DS    0H                                                               
*                                                                               
         XC    PBPNVELA,PBPNVELA   INIT PNV ELEMENT ADDRESS                     
*                                                                               
         TM    PBBYOPT2,PBBYPNVQ   SKIP IF NOT PROCESSING PNV ELEMENTS          
         BNO   CBYPNVX                                                          
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,PBNVELQ      LOOKING FOR NEW INVOICE ELEMENT              
*                                                                               
CBYPNVLP DS    0H                  PROCESS PNV ELEMENTS                         
*                                                                               
         BRAS  RE,NXTELM           FIND 1ST/NEXT PNVG ELM                       
         BNE   CBYPNVDN            NONE FOUND                                   
*                                                                               
         USING PBNVELMD,R6         ESTABLISH PNV ELEMENT                        
*                                                                               
         ST    R6,PBPNVELA         SET PNV ELEMENT ADDRESS                      
*                                                                               
CBYPNVGO DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         CLI   PBQTRACE,C'Y'                                                    
         BNE   CBYPNVG1                                                         
*                                                                               
         MVC   P,BLANKS                                                         
         SR    R0,R0                                                            
         IC    R0,1(R6)            ELEMENT LENGTH                               
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CHEXOUT-COMFACSD(RF)    HEXOUT ADDRESS                        
*                                                                               
         GOTO1 (RF),PARM,(R6),P+20,(R0),=C'TOG'                                 
*                                                                               
         GOTO1 IOPRINT,PARM,PASA,=C'BL01'                                       
*                                                                               
CBYPNVG1 DS    0H                                                               
*                                                                               
         BRAS  RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    CBYPNVGO             PASS BACK SAME ELEMENT                      
*                                                                               
CBYPNVCN DS    0H                                                               
*                                                                               
         XC    PBPNVELA,PBPNVELA   INIT NEW INVOICE ELEMENT ADDRESS             
*                                                                               
         B     CBYPNVLP                                                         
*                                                                               
CBYPNVDN DS    0H                                                               
*                                                                               
CBYPNVX  DS    0H                                                               
*                                                                               
CBYHOOK2 DS    0H                                                               
*                                                                               
         TM    PBBYOPTS,PBBYBUYQ   GENERAL BUY RECORD DATA NEEDED               
         BO    CBYHOOK3                                                         
*                                                                               
         TM    PBBYOPTS,PBBYBUYQ+PBBYPAYQ+PBBYBLLQ  IF NO NEW SWITCHES          
         BNZ   CBYHOOK4                                                         
         TM    PBQREAD,PBQRDBUY       USE OLD SWITCH                            
         BNO   CBYHOOK4                                                         
*                                                                               
CBYHOOK3 DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    CBYHOOK2            PASS BACK SAME RECORD                        
*                                                                               
CBYHOOK4 DS    0H                                                               
*                                                                               
CBYHOOKX DS    0H                                                               
*                                                                               
         B     CBYBUYCN                                                         
*                                                                               
*        CONTINUATION OF BUY PROCESSING LOOP                                    
*                                                                               
CBYBUYNX DS    0H                  BYPASS SOME RECORDS                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL                                         
*                                                                               
         B     CBYBUYLP                                                         
*                                                                               
CBYBUYCN DS    0H                  READ NEXT BUY ON FILE                        
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ+IORDEL                                         
*                                                                               
         B     CBYBUYLP                                                         
*                                                                               
CBYBUYDN DS    0H                  END OF BUYS FOR CONTRACT                     
*                                                                               
CONTBUYX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - CHECK IF BUY FULLY PAID - PDBUYCHK'          
***********************************************************************         
*                                                                     *         
*        ROUTINE TO CHECK FOR CLEARED BUT NOT PAID BUYS               *         
*                                                                     *         
*NTRY    R2==> BUYREC                                                 *         
*                                                                     *         
*EXIT    EQ  CC   ALL CLEARED PAY ELMS ARE PAID                       *         
*        NEQ CC   SOME CLEARED PAY ELM HAS NO CHECK                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
PDBUYCHK NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
         USING PBUYRECD,R2                                                      
*                                                                               
*        READ A PAY ELEMENT                                                     
*        MATCH TO CLEARANCE STATUS TABLE ELEMENT                                
*                                                                               
         XC    PBPAYELA,PBPAYELA   INIT PAY ELEMENT ADDRESS                     
         XC    PBCLSELA,PBCLSELA   INIT CLEARANCE STATUS ELEMENT ADDR           
         XC    PBCLINVA,PBCLINVA   INIT CLEARANCE INVOICE ELEMENT ADDR          
*                                                                               
PCKPAY   DS    0H                                                               
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         MVI   ELCODE,PPAYELQ      LOOKING FOR PAY ELEMENT                      
*                                                                               
PCKPAYLP DS    0H                  PROCESS PAY ELEMENTS                         
*                                                                               
         BAS   RE,NXTELM           FIND 1ST/NEXT PAY ELM                        
         BNE   PCKPAYDN            NONE FOUND                                   
*                                                                               
         USING PPAYELEM,R6         ESTABLISH PAY ELEMENT                        
*                                                                               
         OC    PPDDATE,PPDDATE     SKIP IF NOT CLEARED FOR PAYMENT              
         BZ    PCKPAYCN                                                         
*                                                                               
         ST    R6,PBPAYELA         SET PAY ELEMENT ADDRESS                      
*                                                                               
         GOTOR GETCLS              FIND CLEARANCE STATUS ELEMENT                
*                                                                               
         ICM   R5,15,PBCLSELA      IF CHECK ELEMENT EXISTS                      
         BZ    PCKPAYNF            DROP IF NO ELEMENT EXISTS                    
         USING PPCLEL01,R5            ESTABLISH CHECK ELEMENT                   
*                                                                               
         OC    PPCLCHK,PPCLCHK        CHECK IF CHECK HAS BEEN CUT               
         BZ    PCKPAYNF                  NOT YET                                
*                                                                               
         CLC   =C'VOID',PPCLCHK       KEEP IF CHECK VOIDED                      
         BE    PCKPAYNF                                                         
*                                                                               
PCKPAYCN DS    0H                                                               
*                                                                               
         XC    PBPAYELA,PBPAYELA   INIT PAY ELEMENT ADDRESS                     
         XC    PBCLSELA,PBCLSELA   INIT CLEARANCE STATUS ELEMENT ADDR           
         XC    PBCLINVA,PBCLINVA   INIT CLEARANCE INVOICE ELEMENT ADDR          
*                                                                               
         B     PCKPAYLP                                                         
*                                                                               
PCKPAYNF DS    0H                  CLEARED BUT NOT PAID ELEMENT FOUND           
*                                                                               
         LTR   RB,RB               NEQ CC SET                                   
         B     PCKPAYX                                                          
*                                                                               
PCKPAYDN DS    0H                                                               
*                                                                               
         CR    RB,RB               EQ CC SET                                    
*                                                                               
PCKPAYX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - READ ESTIMATE RECORDS - READEST'             
***********************************************************************         
*                                                                     *         
*        ROUTINE TO READ ESTIMATE RECORDS                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
READEST  NMOD1 0,**#RES**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    PBRGN,PBRGN         INIT REGION CODE                             
         XC    PBREGNM,PBREGNM     INIT REGION NAME                             
         XC    PBDST,PBDST         INIT DISTRICT CODE                           
         XC    PBDSTNM,PBDSTNM     INIT DISTRICT NAME                           
*                                                                               
         TITLE 'T00A4C - PRWRIIO - READ ESTIMATE RECORDS - RESESTLP'            
***********************************************************************         
*                                                                     *         
*        FIND NEXT ESTIMATE POINTER AND THEN APPLY ESTIMATE FILTERS   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RESEST   DS    0H                                                               
*                                                                               
         MVI   PBMODE,PBPROCES     PROCESSING AN ESTIMATE RECORD                
*                                                                               
         L     RF,AIO1             POINT TO BUY RECORD AREA                     
         XC    0(L'PBUYKEY,RF),0(RF)    ERASE EVIDENCE OF A BUY                 
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS ESTIMATE REC KY         
         USING PESTREC,R2                                                       
*                                                                               
         MVC   PESTKAGY,PBAGY      SET AGENCY                                   
         MVC   PESTKMED,PBMED      SET MEDIA                                    
         MVI   PESTKRCD,PESTKIDQ   SET RECORD ID                                
         MVC   PESTKCLT,PBCLT      SET CLIENT                                   
         MVC   PESTKPRD,PBPROD     SET PRODUCT                                  
*                                                                               
*        FIND FIRST ESTIMATE RECORD CANDIDATE                                   
*                                                                               
         MVC   RESTTKEY,IOKEY      SAVE START KEY                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIR HI                                  
*                                                                               
RESESTLP DS    0H                                                               
*                                                                               
         LA    R2,IOKEY            RE-POINT TO KEY AREA                         
*                                                                               
         CLC   RESTTKEY(PESTKEST-PESTREC),IOKEY     SAME A/M/TY/CL/PR           
         BNE   RESESTDN            NO - DONE                                    
*                                                                               
         TM    IOKEY+25,X'80'      REJECT IF DELETED                            
         BO    RESESTCN                                                         
*                                                                               
*        FILTER ON ESTIMATE                                                     
*                                                                               
         XC    ESTDATA,ESTDATA     INIT ESTIMATE DATA                           
         LA    R8,ESTDATA          ESTABLISH ESTIMATE DATA AREA AS              
         USING ESTBUFFD,R8           ENTRY IN ESTIMATE BUFFER                   
*                                                                               
         MVC   EBFMED,PESTKMED     SET MEDIA                                    
         MVC   EBFCLT,PESTKCLT     SET CLIENT                                   
         MVC   EBFPRD,PESTKPRD     SET PRODUCT                                  
         MVC   EBFEST,PESTKEST     SET ESTIMATE                                 
*                                                                               
         BAS   RE,FLTREST          FILTER ON ESTIMATE                           
         BNE   RESESTCN              FAILED FILTER                              
*                                                                               
         MVC   PBEST,EBFEST        SET ESTIMATE NUMBER                          
*                                                                               
         BAS   RE,GO               GET ESTIMATE DATA                            
*                                                                               
         TITLE 'T00A4C - PRWRIIO - BUDGET DATES- RESBUD'                        
***********************************************************************         
*                                                                     *         
*        CALL DRIVER FOR EACH BUDGET RECORD IF DOING BUDGETS          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RESBUD   DS    0H                                                               
*                                                                               
         TM    PBQCFOPT,PBQBDGQ    SKIP IF NOT REPORTING BUDGETS                
         BNO   RESBUDX                                                          
*                                                                               
         MVC   RESBUDCK,IOKEY      SAVE CURRENT KEY                             
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS BUDGET REC KY           
         USING PBUDREC,R2                                                       
*                                                                               
         MVC   PBUDKAGY,PBAGY      SET AGENCY                                   
         MVC   PBUDKMED,PBMED      SET MEDIA                                    
         MVI   PBUDKRCD,PBUDKIDQ   SET RECORD ID                                
         MVC   PBUDKCLT,PBCLT      SET CLIENT                                   
         MVC   PBUDKPRD,PBPROD     SET PRODUCT                                  
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,PBEST                                                       
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  PBUDKEST,DUB        SET ESTIMATE                                 
*                                                                               
         MVC   RBUDTKEY,IOKEY      SAVE START KEY                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIR HI                                  
*                                                                               
RESBUDLP DS    0H                                                               
*                                                                               
         LA    R2,IOKEY            RE-POINT TO KEY AREA                         
*                                                                               
         CLC   RBUDTKEY(PBUDKREG-PBUDREC),IOKEY  SAME A/M/TY/CL/PR/EST          
         BNE   RESBUDDN            NO - DONE                                    
*                                                                               
         TM    IOKEY+25,X'80'      REJECT IF DELETED                            
         BO    RESBUDCN                                                         
*                                                                               
*        FILTER ON REGION                                                       
*                                                                               
RESREG   DS    0H                                                               
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   SKIP IF DRDCLI PRESENT                       
         BNZ   RESREG1                                                          
*                                                                               
         CLC   PBQRGN,=C'ALL'      ACCEPT IF ALL REGIONS REQUESTED              
         BE    *+10                                                             
         OC    PBQRGN,PBQRGN               BIN ZERO = ALL                       
         BE    *+10                                                             
         CLC   PBQRGN,PBUDKREG     ELSE MUST MATCH REQUESTED REGION             
         BNE   RESBUDCN                                                         
*                                                                               
RESREG1  DS    0H                                                               
*                                                                               
*        FILTER ON DISTRICT                                                     
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   SKIP IF DRDCLI PRESENT                       
         BNZ   RESDST1                                                          
*                                                                               
         CLC   PBQDST,=C'ALL'      ACCEPT IF ALL DISTRICTS REQUESTED            
         BE    *+10                                                             
         OC    PBQDST,PBQDST              BIN 0  MEANS ALL                      
         BZ    *+10                                                             
         CLC   PBQDST,PBUDKDST      ELSE MUST MATCH REQUESTED DISTRICT          
         BNE   RESBUDCN                                                         
*                                                                               
RESDST1  DS    0H                                                               
*                                                                               
*        LOOK UP REGION/DISTRICT NAMES IN REGION BUFFER                         
*                                                                               
         MVC   PBRGN,PBUDKREG      RETURN REGION   CODE                         
*                                                                               
         ICM   R8,15,PBADRDBF      ADDRESS OF DRD BUFFER                        
         BNZ   *+6                                                              
         DC    H'0'                MUST HAVE BUFFER                             
         USING DRDBUFFD,R8         ESTABLISH DRD BUFFER ENTRY                   
*                                                                               
RESBUFLP DS    0H                                                               
*                                                                               
         OC    0(DRDLEN,R8),0(R8)  DONE IF END OF TABLE                         
         BZ    RESBUFDN                                                         
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   IF USING ANOTHER CLIENT'S DRD                
         BZ    *+18                   SCHEME                                    
         CLC   =C'000',DRDDIV         MATCH TO DIVISION 000                     
         BE    RESBUFL1                                                         
         B     RESBUFCN               ELSE REJECT                               
*                                                                               
RESBUFL1 DS    0H                                                               
*                                                                               
         OC    PBUDKREG,PBUDKREG   IF REGION PRESENT                            
         BZ    RESBUF40                                                         
         CLC   PBUDKREG,DRDRGN        MATCH REGION                              
         BNE   RESBUFCN                                                         
*                                                                               
*          REGION ENTRY ALWAYS BEFORE DISTRICT ENTRIES                          
*                                                                               
         OC    DRDDST,DRDDST       DISTRICT MUST BE NULLS FOR REG               
         BNZ   RESBUF40               ENTERY IN BUFFER                          
*                                                                               
         MVC   PBREGNM,DRDNAME     SET REGION NAME                              
*                                                                               
*        FIND DISTRICT ENTRY                                                    
*                                                                               
RESBUF40 DS    0H                                                               
*                                                                               
         OC    PBQDST,PBQDST       SKIP IF NO DISTRICT SCHEME WANTED            
         BZ    RESBUFDN                                                         
*                                                                               
         OC    PBUDKDST,PBUDKDST   IF DISTRICT PRESENT                          
         BZ    RESBUFDN                                                         
*                                                                               
         CLC   PBUDKDST,DRDDST        MUST MATCH ON DISTRICT                    
         BNE   RESBUFCN                                                         
*                                                                               
         MVC   PBDST,DRDDST        RETURN DISTRICT CODE                         
         MVC   PBDSTNM,DRDNAME     RETURN DISTRICT NAME                         
*                                                                               
         B     RESBUFDN            ALL DONE                                     
*                                                                               
RESBUFCN DS    0H                                                               
*                                                                               
         LA    R8,DRDLEN(R8)       BUMP TO NEXT ELEMENT IN BUFFER               
         B     RESBUFLP                                                         
*                                                                               
RESBUFDN DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3+IORDEL GET BUDGET RECORD                  
*                                                                               
         TITLE 'T00A4C - PRWRIIO - BUDGET DATES- RESBDGDT'                      
***********************************************************************         
*                                                                     *         
*        CALL DRIVER FOR EACH MONTH IN ESTIMATE IF DOING MONTH BUDGETS*         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RESBDGDT DS    0H                                                               
*                                                                               
         XC    PBBDGTST,PBBDGTST   INIT BUDGET PERIOD                           
         XC    PBBDGTEN,PBBDGTEN                                                
*                                                                               
         TM    PBQCFOPT,PBQBDGMQ   SKIP IF NOT REPORTING MONTH BUDGETS          
         BNO   RESBDGDX                                                         
*                                                                               
         L     R5,PBADTLST         POINT TO LIST OF DATES                       
         USING DATELSTD,R5         ESTABLISH DATE LIST                          
*                                                                               
         LA    R4,MNTHLIST         POINT TO LIST OF MONTHS                      
*                                                                               
RESBDGLP DS    0H                                                               
*                                                                               
         OC    0(3,R4),0(R4)       DONE AT END OF LIST                          
         BZ    RESBDGDN                                                         
*                                                                               
         CLC   3(3,R4),PBQBST      NEXT MONTH IN REQUEST PERIOD                 
         BL    RESBDGCN                                                         
         CLC   0(3,R4),PBQBEND                                                  
         BH    RESBDGDN                                                         
*                                                                               
         MVC   PBBDGTST,0(R4)      SET BUDGET MONTH                             
         MVC   PBBDGTEN,3(R4)                                                   
*                                                                               
RESBDGDX DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - HOOK TO USER - RESESTGO'                     
***********************************************************************         
*                                                                     *         
*        HOOK TO USER TO PROCESS ESTIMATE RECORD                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
*                                                                               
RESESTGO DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RESESTGO             PASS BACK SAME RECORD                       
*                                                                               
         TITLE 'T00A4C - PRWRIIO - BUDGET DATES CONTINUATION- RESBDGCN'         
***********************************************************************         
*                                                                     *         
*        CONTINUATION OF BUDGET DATES LOOP                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RESBDGCN DS    0H                                                               
*                                                                               
         TM    PBQCFOPT,PBQBDGMQ   DONE IF NOT REPORTING MONTH BUDGETS          
         BNO   RESBDGDN                                                         
*                                                                               
         LA    R4,6(R4)            BUMP TO NEXT MONTH IN LIST                   
         B     RESBDGLP                                                         
*                                                                               
RESBDGDN DS    0H                                                               
*                                                                               
         XC    PBBDGTST,PBBDGTST   INIT BUDGET PERIOD                           
         XC    PBBDGTEN,PBBDGTEN                                                
*                                                                               
         TM    PBQCFOPT,PBQBDGMQ+PBQBDGTQ  IF MONTHLY AND TOTAL                 
         BNO   RESBDGD1                                                         
*                                                                               
         MVI   PBRTCODE,0          CALL DRIVER FOR TOTALS                       
         BAS   RE,GO               HOOK TO USER                                 
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    *-12                PASS BACK SAME RECORD                        
*                                                                               
RESBDGD1 DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - BUDGET DATES CONTINUATION- RESBUDCN'         
***********************************************************************         
*                                                                     *         
*        CONTINUATION OF BUDGET LOOP                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RESBUDCN DS    0H                                                               
*                                                                               
         TM    PBQCFOPT,PBQBDGQ    DONE IF NOT REPORTING BUDGETS                
         BNO   RESBUDDN                                                         
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ+IORDEL  READ NEXT BUDGET RECORD                
*                                                                               
         B     RESBUDLP                                                         
*                                                                               
RESBUDDN DS    0H                                                               
*                                                                               
         TM    PBQCFOPT,PBQBDGQ    DONE IF NOT REPORTING BUDGETS                
         BNO   RESBUDX                                                          
*                                                                               
         MVC   IOKEY,RESBUDCK      RESTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL RE-READ CURRENT FILE PTR                
*                                                                               
RESBUDX  DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - PGEST DATA - RESPG'                          
***********************************************************************         
*                                                                     *         
*        CALL DRIVER FOR EACH PGEST RECORD IF DOING PGESTREC KYWDS    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RESPG    DS    0H                                                               
*                                                                               
         TM    PBQCFOPT,PBQCFPGQ   SKIP IF NOT REPORTING PGEST KYWDS            
         BNO   RESPGX                                                           
*                                                                               
         MVC   RESBUDCK,IOKEY      SAVE CURRENT KEY                             
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS PGEST REC KY            
         USING PGSTKEY,R2                                                       
*                                                                               
         MVC   PGSTKAGY,PBAGY      SET AGENCY                                   
         MVC   PGSTKMED,PBMED      SET MEDIA                                    
         MVI   PGSTKRCD,PGSTKIDQ   SET RECORD ID                                
         MVC   PGSTKCLT,PBCLT      SET CLIENT                                   
         MVC   PGSTKPRD,PBPROD     SET PRODUCT                                  
         MVC   PGSTKEST,PBEST      SET ESTIMATE                                 
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIR HI                                  
*                                                                               
         CLC   PGSTKEY,IOKEYSAV    SAME A/M/TY/CL/PR/EST                        
         BNE   RESPGDN             NO - DONE                                    
*                                                                               
         TM    IOKEY+25,X'80'      REJECT IF DELETED                            
         BO    RESPGDN                                                          
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3+IORDEL GET PGEST RECORD                   
*                                                                               
RESPGGO  DS    0H                  CALL DRIVER                                  
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO DRIVER                               
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RESPGGO              PASS BACK SAME RECORD                       
*                                                                               
RESPGDN  DS    0H                                                               
*                                                                               
         MVC   IOKEY,RESBUDCK      RESTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL RE-READ CURRENT FILE PTR                
*                                                                               
RESPGX   DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GFEST DATA - RESGF'                          
***********************************************************************         
*                                                                     *         
*        CALL DRIVER FOR EACH GFEST RECORD IF DOING GFESTREC KYWDS    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RESGF    DS    0H                                                               
*                                                                               
         TM    PBQCFOP2,PBQCFGFQ   SKIP IF NOT REPORTING GFEST KYWDS            
         BNO   RESGFX                                                           
*                                                                               
         CLC   PBPROD,=C'ZZZ'      IGNORE IF NOT PRODUCT ZZZ                    
         BNE   RESGFX                                                           
*                                                                               
         MVC   RESBUDCK,IOKEY      SAVE CURRENT KEY                             
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS PGEST REC KY            
         USING PGSTKEY,R2                                                       
*                                                                               
         MVC   PGSTKAGY,PBAGY      SET AGENCY                                   
         MVC   PGSTKMED,PBMED      SET MEDIA                                    
         MVI   PGSTKRCD,X'0B'      SET RECORD ID                                
         MVC   PGSTKCLT,PBCLT      SET CLIENT                                   
         MVC   PGSTKPRD,PBPROD     SET PRODUCT                                  
         MVC   PGSTKEST,PBEST      SET ESTIMATE                                 
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIR HI                                  
*                                                                               
         CLC   PGSTKEY,IOKEYSAV    SAME A/M/TY/CL/PR/EST                        
         BNE   RESGFDN             NO - DONE                                    
*                                                                               
         TM    IOKEY+25,X'80'      REJECT IF DELETED                            
         BO    RESGFDN                                                          
*                                                                               
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3+IORDEL GET GFEST RECORD                   
*                                                                               
RESGFGO  DS    0H                  CALL DRIVER                                  
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO DRIVER                               
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RESGFGO              PASS BACK SAME RECORD                       
*                                                                               
RESGFDN  DS    0H                                                               
*                                                                               
         MVC   IOKEY,RESBUDCK      RESTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL RE-READ CURRENT FILE PTR                
*                                                                               
RESGFX   DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - CONTINUATION EST READ - RESESTCN'            
***********************************************************************         
*                                                                     *         
*        CONTINUATION OF ESTIMATE PROCESSING LOOP                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RESESTCN DS    0H                  READ NEXT ESTIMATE RECORD ON FILE            
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ+IORDEL                                         
*                                                                               
         B     RESESTLP                                                         
*                                                                               
         TITLE 'T00A4C - PRWRIIO - END OF ESTIMTES - RESESTDN'                  
***********************************************************************         
*                                                                     *         
*        END OF ESTIMATE PROCESSING LOOP                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RESESTDN DS    0H                                                               
*                                                                               
READESTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
RESSVPRD DS    XL(L'PBPROD)        PRODUCT CODE SAVEAREA                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
RESTTKEY DS    XL(L'IOKEY)         START ESTIMATE KEY                           
RBUDTKEY DS    XL(L'IOKEY)         START BUDGET   KEY                           
RESBUDCK DS    XL(L'IOKEY)         BUDGET CURRENT KEY                           
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - READ PUB RECORDS - READPUB'                  
***********************************************************************         
*                                                                     *         
*        ROUTINE TO READ PUB      RECORDS                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
READPUB  NMOD1 0,**#RPB**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         L     RF,AIO1             CLEAR COMPETING I/OAREAS                     
         XC    0(256,RF),0(RF)                                                  
*                                                                               
         L     RF,AIO2             CLEAR COMPETING I/OAREAS                     
         XC    0(256,RF),0(RF)                                                  
*                                                                               
         MVC   PBCLTSV,PBCLT       SAVE CURRENT CLIENT CODE                     
*                                                                               
         CLC   PBCLT,PBQCLT        SKIP IF SINGLE CLIENT                        
         BE    *+10                                                             
         XC    PBCLT,PBCLT            REMOVE ANY CLT/PRD/EST REFERENCES         
*                                                                               
         XC    PBPROD,PBPROD                                                    
         XC    PBEST,PBEST                                                      
         XC    PBCLTNM,PBCLTNM                                                  
         XC    PBPRDNM,PBPRDNM                                                  
         XC    PBESTNM,PBESTNM                                                  
*                                                                               
         L     RF,=A(GZNKEYSV)     FORCE FIRST EDITION FOR AGENCY               
         XC    0(L'GZNKEYSV,RF),0(RF)                                           
*                                                                               
RPBINI   DS    0H                                                               
*                                                                               
         XC    PBPUB(6),PBPUB      INIT STARTING PUB                            
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    *+10                                                             
         MVC   PBPUB(6),PBQPUB        SET STARTING PUB NUMBER                   
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   IF PUBLISHER GIVEN                           
         BZ    RPBINIPN                                                         
*                                                                               
         XC    PBQPUB,PBQPUB          INIT STARTING PUB                         
*                                                                               
         GOTO1 =A(PBLFLTR),RR=RELO    FIND FIRST PUB                            
         BNE   RPBPUBDN               REACHED END OF PUBS FOR PUBLISHER         
*                                                                               
         MVC   PBPUB(6),PBQPUB        SET STARTING PUB NUMBER                   
*                                                                               
         B     RPBINIFD                                                         
*                                                                               
RPBINIPN DS    0H                                                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BZ    RPBINIGN                                                         
*                                                                               
         L     RF,=A(PGPBUFST)                                                  
         XC    0(L'PGPBUFST,RF),0(RF)  FORCES FIRST TIME PROCESSING             
*                                                                               
         GOTO1 =A(PUBGRP),RR=RELO     GET FIRST PUB                             
*                                                                               
         OC    PBPUB(6),PBPUB         DONE IF END OF PUBS REACHED               
         BZ    RPBPUBDN                  END OF PUBS                            
*                                                                               
         MVC   PBQPUB(6),PBPUB        MIMIC SINGLE PUB PROCESSING               
*                                                                               
         B     RPBINIFD                                                         
*                                                                               
RPBINIGN DS    0H                                                               
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST PROCESSING                       
         BZ    RPBLISX                                                          
*                                                                               
         L     RF,=A(PGPBUFST)                                                  
         XC    0(L'PGPBUFST,RF),0(RF)  FORCES FIRST TIME PROCESSING             
*                                                                               
         GOTO1 =A(PUBLIS),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RPBINIFD               ONE FOUND                                 
         B     RPBPUBDN               END OF PUBS                               
*                                                                               
RPBLISX  DS    0H                                                               
*                                                                               
RPBINIFD DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS PUB REC KY              
         USING PUBREC,R2                                                        
*                                                                               
         MVC   PUBKMED,PBMED       SET MEDIA                                    
*                                                                               
*        POINT TO FIRST PUBDIR RECORD                                           
*                                                                               
         MVC   PUBKPUB(6),PBPUB    SET STARTING PUB                             
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOHI   READ PASSIVE POINTER                         
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        PROCESS NEXT PUB                                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RPBPUBLP DS    0H                                                               
*                                                                               
*        OKAY TO USE NEXT PUB ON FILE                                           
*                                                                               
RPBPTRLP DS    0H                                                               
*                                                                               
         MVC   RPBKYSV,IOKEY       SAVE KEY                                     
*                                                                               
         CLC   PUBKMED,PBMED       DONE ON CHANGE OF MEDIA                      
         BNE   RPBPUBDN                                                         
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    RPBPTRL1                                                         
*                                                                               
         CLC   PUBKPUB(4),PBQPUB      MUST MATCH REQUESTED PUB                  
         BNE   RPBPUBCN                                                         
*                                                                               
         CLI   PBQALLZN,C'Y'          ACCEPT IF DOING ALL ZONES + EDTS          
         BE    RPBPTRL1                                                         
*                                                                               
         CLC   PUBKZON,PBQZON      REJECT IF ZONE                               
         BNE   RPBPUBCN                                                         
*                                                                               
         CLC   PUBKED,PBQEDT         OR EDITION DON'T MATCH                     
         BNE   RPBPUBCN                                                         
*                                                                               
RPBPTRL1 DS    0H                                                               
*                                                                               
         CLC   PUBKAGY,PBAGY       MUST BE SAME AGENCY                          
         BNE   RPBPTRCN                                                         
*                                                                               
         CLI   PUBKCOD,PUBKIDQ     MUST BE A PUB RECORD                         
         BNE   RPBPTRCN                                                         
*                                                                               
         TM    PUBKEY+25,X'80'     SKIP IF DELETED RECORD                       
         BNO   RPBPTRDN                                                         
*                                                                               
RPBPTRCN DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOSQ+IORDEL  READ NEXT POINTER                      
*                                                                               
         B     RPBPTRLP                                                         
*                                                                               
RPBPTRDN DS    0H                                                               
*                                                                               
         MVC   PBPUB(6),PUBKPUB    SAVE PUB NUMBER                              
*                                                                               
*        TRANSLATE PUB ID IF ADVERTISER REPORT                                  
*                                                                               
RPBADVP  DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       SKIP UNLESS ADVERTISER REPORT                
         BNE   RPBADVPX                                                         
*                                                                               
         GOTO1 GTAORPUB,PARM,PUBKPUB   FIND AOR PUB ID                          
         BNE   RPBPUBCN            NO LINK FOUND                                
*                                                                               
         MVC   IOKEY,RPBKYSV       RESTORE KEY                                  
         GOTO1 AIO,IOPUBDIR+IOHI+IORDEL   RE-POINT DIRECTORY                    
*                                                                               
RPBADVPX DS    0H                                                               
*                                                                               
         GOTO1 =A(GETPUBN),RPBWORKH,RR=RELO     READ PUB NAME                   
*                                                                               
         BNE   RPBPUBCN            DROP IF PUB FAILS FILTERING                  
*                                                                               
         MVC   IOKEY,RPBKYSV       RESTORE KEY                                  
         GOTO1 AIO,IOPUBDIR+IOHI+IORDEL   RE-POINT DIRECTORY                    
*                                                                               
         OC    PBQCDFLT,PBQCDFLT   IF CASH DISC FILTER GIVEN                    
         BZ    *+14                                                             
         CLC   RPBWORKH+1(1),PBQCDFLT  THEN MUST BE A CD PUB                    
         BNE   RPBPUBCN                                                         
*                                                                               
*        FILTER ON REGION OR DISTRICTS                                          
*                                                                               
RPBDRD   DS    0H                                                               
*                                                                               
         CLC   PBQRGN,BLANKS       SKIP IF REGION NOT REQUESTED                 
         BH    *+10                                                             
         CLC   PBQDST,BLANKS       AND  IF DISTRICTS NOT REQUESTED              
         BNH   RPBDRDX                                                          
*                                                                               
         GOTO1 =A(FLTDRD),PARM,RR=RELO   FILTER ON REG/DST                      
*                                                                               
         CLI   3(R1),C'N'             DO NOT INCLUDE                            
         MVI   3(R1),0                 RESET                                    
         BE    RPBPUBCN                                                         
*                                                                               
         MVC   IOKEY,RPBKYSV       RESTORE KEY                                  
         GOTO1 AIO,IOPUBDIR+IOHI+IORDEL   RE-POINT DIRECTORY                    
*                                                                               
RPBDRDX  DS    0H                                                               
*                                                                               
         TITLE 'T00A4C - PRWRIIO - HOOK TO USER - RESESTGO'                     
***********************************************************************         
*                                                                     *         
*        HOOK TO USER TO PROCESS PUB      RECORD                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
*                                                                               
RPBGO    DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RPBGO                PASS BACK SAME RECORD                       
*                                                                               
         TITLE 'T00A4C - PRWRIIO - CONTINUATION PUB READ - RPBPUBCN'            
***********************************************************************         
*                                                                     *         
*        CONTINUATION OF PUB      PROCESSING LOOP                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RPBPUBCN DS    0H                                                               
*                                                                               
         MVC   IOKEY,RPBKYSV       RESTORE KEY                                  
         GOTO1 AIO,IOPUBDIR+IOHI+IORDEL   RE-POINT DIRECTORY                    
*                                                                               
         OC    PBQPUB,PBQPUB       IF DOING ALL PUBS                            
         BNZ   RPBPUBC1                                                         
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOSQ+IORDEL   READ NEXT RECORD ON FILE              
*                                                                               
         B     RPBPUBLP                                                         
*                                                                               
RPBPUBC1 DS    0H                                                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BZ    RPBPUBC2                                                         
*                                                                               
         GOTO1 =A(PUBGRP),RR=RELO     GET NEXT PUB IN GROUP                     
*                                                                               
         OC    PBPUB(6),PBPUB         DONE IF END OF PUBS REACHED               
         BZ    RPBPUBDN                  END OF PUBS                            
*                                                                               
         MVC   PBQPUB(6),PBPUB        TREAT AS SINGLE PUB PROCESSING            
*                                                                               
         B     RPBPUBN1                                                         
*                                                                               
RPBPUBC2 DS    0H                                                               
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST PROCESSING                       
         BZ    RPBPUBC3                                                         
*                                                                               
         GOTO1 =A(PUBLIS),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB         DONE IF END OF PUBS REACHED               
         BZ    RPBPUBDN                  END OF PUBS                            
*                                                                               
         MVC   PBQPUB(6),PBPUB        TREAT AS SINGLE PUB PROCESSING            
*                                                                               
         B     RPBPUBN1                                                         
*                                                                               
RPBPUBC3 DS    0H                                                               
*                                                                               
*        FIND NEXT PUB FOR PUBLISHER IF REQUESTED                               
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   IF PUBLISHER FILTER GIVEN                    
         BZ    RPBPUBC4                                                         
*                                                                               
         GOTO1 =A(PBLFLTR),RR=RELO    FIND NEXT PUB FOR PUBLISHER               
         BNE   RPBPUBDN            DONE AT END OF PUBS                          
*                                                                               
         B     RPBPUBN1                                                         
*                                                                               
RPBPUBC4 DS    0H                                                               
*                                                                               
*        IF ADVERTISER REPORT FOR SINGLE PUB AND ALL EDITIONS                   
*           DO NEXT PUB/ZONE/EDITION                                            
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    RPBPUBC5                                                         
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   RPBPUBED                                                         
         CLI   PBQALLZN,C'Y'       IF ALL ZONES AND EDITIONS                    
         BNE   RPBPUBC5                                                         
*                                                                               
         GOTO1 =A(GETNXTZN)           FIND NEXT ZONE/EDITION                    
         BZ    RPBPUBDN                   NO MORE                               
*                                                                               
         B     RPBPUBN1                                                         
*                                                                               
RPBPUBED DS    0H                                                               
*                                                                               
         CLI   PBQALLZN,C'Y'       IF ALL ZONES AND EDITIONS                    
         BNE   RPBPUBC5                                                         
*                                                                               
         CLC   PBQPUB(4),PUBKPUB   DONE IF NEW PUB                              
         BNE   RPBPUBDN                                                         
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOSQ+IORDEL   READ NEXT RECORD ON FILE              
*                                                                               
         B     RPBPUBLP                                                         
*                                                                               
RPBPUBC5 DS    0H                                                               
*                                                                               
         B     RPBPUBDN            DONE - MUST BE SINGLE PUB                    
*                                                                               
RPBPUBN1 DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY                                                      
*                                                                               
         MVC   PUBKMED,PBMED       SET MEDIA                                    
*                                                                               
*        POINT TO NEXT PUBDIR RECORD                                            
*                                                                               
         MVC   PUBKPUB(6),PBQPUB   SET STARTING PUB                             
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOHI   READ PASSIVE POINTER                         
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         B     RPBPUBLP                                                         
*                                                                               
         TITLE 'T00A4C - PRWRIIO - END OF PUBS     - RPBPUBDN'                  
***********************************************************************         
*                                                                     *         
*        END OF PUB      PROCESSING LOOP                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RPBPUBDN DS    0H                                                               
*                                                                               
READPUBX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
RPBWORKH DS    XL2                 CD WORKAREA                                  
RPBSTKEY DS    XL(L'IOKEY)         START KEY                                    
RPBKYSV  DS    XL(L'IOKEY)         CURRENT PUB KEY                              
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - READ ISSUE RECORDS - READISS'                
***********************************************************************         
*                                                                     *         
*        ROUTINE TO READ ISSUE RECORDS                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
READISS  NMOD1 0,**#RIS**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        FIND NEXT PUB FOR PUBLISHER IF REQUESTED                     *         
*          EACH PUB FOUND IS SET IN PBQPUB SO LOGIC ACTS AS IF        *         
*          A SINGLE PUB WAS REQUESTED                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RISPBLLP DS    0H                                                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BZ    RISPBLL1                                                         
*                                                                               
         GOTO1 =A(PUBGRP),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RISPBL10               ONE FOUND                                 
         B     RISPBLDN               END OF PUBS                               
*                                                                               
RISPBLL1 DS    0H                                                               
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST PROCESSING                       
         BZ    RISPBLL2                                                         
*                                                                               
         GOTO1 =A(PUBLIS),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RISPBL10               ONE FOUND                                 
         B     RISPBLDN               END OF PUBS                               
*                                                                               
RISPBLL2 DS    0H                                                               
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   SKIP IF NO PUBLISHER GIVEN                   
         BZ    RISPBL10                                                         
*                                                                               
         GOTO1 =A(PBLFLTR),RR=RELO PUBLISHER FILTER REQUESTED                   
         BNE   RISPBLDN       REACHED END OF PUBS FOR PUBLISHER                 
*                                                                               
RISPBL10 DS    0H                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        IF WE ARE DOING A SINGLE/PUB AND AOR PROCESSING              *         
*          FIND NEXT PUB/ZONE/EDITION TO LOOK AT                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RISZEDLP DS    0H                                                               
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    RISZED10                                                         
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   RISZED10                                                         
         CLI   PBQALLZN,C'Y'       IF ALL ZONES AND EDITIONS                    
         BNE   RISZED10                                                         
*                                                                               
         GOTO1 =A(GETNXTZN)           FIND NEXT ZONE/EDITION                    
         BZ    RISZEDDN                   NO MORE                               
*                                                                               
RISZED10 DS    0H                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        READ ISSUE RECORDS FOR PUB                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RISISR   DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS ISSUE REC KEY           
         USING PISSREC,R2                                                       
*                                                                               
         MVC   PISSKAGY,PBAGY      SET AGENCY                                   
         MVC   PISSKMED,PBMED      SET MEDIA                                    
         MVI   PISSKTYP,X'29'      SET RECORD ID                                
*                                                                               
         MVC   PISSKPUB,PBQPUB     PUB - INCLUDING ZONE AND EDITION             
*                                                                               
         OC    PBQPUB,PBQPUB       SKIP IF DOING ALL PUBS                       
         BZ    RISISR10                                                         
*                                                                               
         CLI   PBQADVSW,C'Y'       SKIP UNLESS ADVERTISER REPORT                
         BNE   RISISR10                                                         
*                                                                               
         GOTO1 GTAGYPUB,PARM,PBQPUB  FIND AGENCY PUB ID                         
         BNE   RISISRDN            PUB ID NOT FOUND  - REJECT                   
*                                                                               
         MVC   PISSKPUB,PAOPUB     USE AGENCY'S PUB ID                          
*                                                                               
RISISR10 DS    0H                                                               
*                                                                               
*        FIND FIRST ISSUE RECORD CANDIDATE                                      
*                                                                               
         MVC   RISSTKEY,IOKEY      SAVE START KEY                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ DIR HI                                  
*                                                                               
RISISRLP DS    0H                                                               
*                                                                               
         LA    R2,IOKEY            RE-POINT TO KEY AREA                         
*                                                                               
         CLC   RISSTKEY(PISSKPUB-PISSREC),IOKEY     SAME A/M/TY                 
         BNE   RISISRDN            NO - DONE                                    
*                                                                               
         TM    IOKEY+25,X'80'      REJECT IF DELETED                            
         BO    RISISRCN                                                         
*                                                                               
*        FILTER AGAINST REQUESTED PUB                                           
*                                                                               
RISPUB   DS    0H                                                               
*                                                                               
         OC    PBQPUB,PBQPUB       ACCEPT IF  DOING ALL PUBS                    
         BZ    RISPUBX                                                          
*                                  IF SINGLE PUB                                
         CLI   PBQADVSW,C'Y'          SKIP UNLESS ADVERTISER REPORT             
         BNE   RISPUB10                                                         
*                                                                               
         CLC   PISSKPUB(4),PAOPUB#    REJECT IF PUB ^= AGENCY PUBID             
         BNE   RISISRDN                 FOR REQUESTED PUB                       
*                                                                               
         CLC   PISSKPUB+4(1),PAOZON  REJECT IF ZONE                             
         BNE   RISISRDN                                                         
*                                                                               
         CLC   PISSKPUB+5(1),PAOED   OR EDITION DON'T MATCH                     
         BNE   RISISRDN                                                         
*                                                                               
         B     RISPUBX                                                          
*                                                                               
RISPUB10 DS    0H                                                               
*                                                                               
         CLC   PISSKPUB(4),PBQPUB    REJECT IF PUB ^= REQUESTED PUB             
         BNE   RISISRDN                                                         
*                                                                               
RISPUB20 DS    0H                                                               
*                                                                               
         CLI   PBQALLZN,C'Y'       ACCEPT IF DOING ALL ZONES + EDTS             
         BE    RISPUBX                                                          
*                                                                               
         CLC   PISSKPUB+4(1),PBQZON     REJECT IF ZONE                          
         BNE   RISISRDN                                                         
*                                                                               
         CLC   PISSKPUB+5(1),PBQEDT       OR EDITION DON'T MATCH                
         BNE   RISISRDN                                                         
*                                                                               
RISPUBX  DS    0H                                                               
*                                                                               
*        TRANSLATE PUB ID IF ADVERTISER REPORT                                  
*                                                                               
RISADVP  DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       SKIP UNLESS ADVERTISER REPORT                
         BNE   RISADVPX                                                         
*                                                                               
*****    CLC   PISSKPUB,PISSKPUB-PISSKEY+IOKEYSAV   SKIP IF NOT NEW PUB         
*****    BE    RISADVP1                                                         
*                                                                               
         GOTO1 GTAORPUB,PARM,PISSKPUB   FIND AOR PUB ID                         
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL   RE-POINT DIRECTORY                    
*                                                                               
RISADVP1 DS    0H                                                               
*                                                                               
         OC    PAORPUB,PAORPUB     DROP IF NO LINK FOUND                        
         BZ    RISISRNX                                                         
*                                                                               
RISADVPX DS    0H                                                               
*                                                                               
*        FILTER ON RECORD DATE                                                  
*                                                                               
RISDTE   DS    0H                                                               
*                                                                               
         MVC   RISWYY,PBQSTART     GET START YEAR                               
         MVC   RISWCC,=C'19'       ASSUME 20ST CENTURY                          
*                                                                               
         CLC   RISWYY,=C'70'       IF BEFORE '70'                               
         BNL   *+10                                                             
         MVC   RISWCC,=C'20'          ASSUME 21ST CENTURY                       
*                                                                               
         CLC   PISSKYR,RISWYEAR    REJECT IF BEFORE REQUEST START DATE          
         BL    RISISRCN                                                         
*                                                                               
         MVC   RISWYY,PBQEND       GET END YEAR                                 
         MVC   RISWCC,=C'19'       ASSUME 20ST CENTURY                          
*                                                                               
         CLC   RISWYY,=C'70'       IF BEFORE '70'                               
         BNL   *+10                                                             
         MVC   RISWCC,=C'20'          ASSUME 21ST CENTURY                       
*                                                                               
         CLC   PISSKYR,RISWYEAR    REJECT IF AFTER REQUEST END DATE             
         BH    RISISRCN                                                         
*                                                                               
RISDTEX  DS    0H                                                               
*                                                                               
*        READ ISSUE RECORD                                                      
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1+IORDEL GET ISSUE RECORD                   
*                                                                               
         L     R2,AIO1             POINT TO FOUND RECORD                        
*                                                                               
         GOTO1 =A(GETPUBN),RISWORKH,RR=RELO     READ PUB NAME                   
*                                                                               
         BNE   RISISRCN            FAILS FILTERING                              
*                                                                               
         OC    PBQCDFLT,PBQCDFLT   IF CASH DISC FILTER GIVEN                    
         BZ    *+14                                                             
         CLC   RISWORKH+1(1),PBQCDFLT  THEN MUST BE A CD PUB                    
         BNE   RISISRCN                                                         
*                                                                               
*        FILTER ON REGION OR DISTRICTS                                          
*                                                                               
RISDRD   DS    0H                                                               
*                                                                               
         CLC   PBQRGN,BLANKS       SKIP IF REGION NOT REQUESTED                 
         BH    *+10                                                             
         CLC   PBQDST,BLANKS       AND  IF DISTRICTS NOT REQUESTED              
         BNH   RISDRDX                                                          
*                                                                               
         GOTO1 =A(FLTDRD),PARM,RR=RELO   FILTER ON REG/DST                      
*                                                                               
         CLI   3(R1),C'N'             DO NOT INCLUDE                            
         MVI   3(R1),0                 RESET                                    
         BE    RISISRCN                                                         
*                                                                               
RISDRDX  DS    0H                                                               
*                                                                               
*??????????????                    SET PUB/ZONE/EDITION                         
         MVC   PBPUB(L'PBPUB+L'PBZONE+L'PBACTED),PISSKPUB                       
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        HOOK TO USER TO PROCESS THE ISSUE ELEMENTS                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RISHOOK  DS    0H                                                               
*                                                                               
         MVI   PBMODE,PBPROCIS     SET PROCESSING MODE TO BUY                   
*                                                                               
*        PROCESSING ISSUE ELEMENTS                                              
*                                                                               
RISISS   DS    0H                                                               
*                                                                               
         XC    PBISSELA,PBISSELA   INIT ISSUE ELEMENT ADDRESS                   
*                                                                               
         SR    R0,R0                                                            
         LA    R6,PISSELEM         POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
RISISSLP DS    0H                  PROCES ISSUE ELEMENTS                        
*                                                                               
         USING PISSEL29,R6         ESTABLISH ISSUE ELEMENT                      
*                                                                               
         CLI   PISSEL29,0          END OF RECORD                                
         BE    RISISSDN                                                         
*                                                                               
         CLI   PISSEL29,X'29'      LOOK FOR ISSUE ELEMENTS                      
         BNE   RISISSCN                                                         
*                                                                               
*        ISSUE MUST LIE IN REQUEST PERIOD                                       
*                                                                               
         CLC   PISSDAT(2),PBQBST   MONTH AND YEAR                               
         BL    RISISSCN                                                         
         CLI   PISSDAT+2,0         OKAY IF MONTHLY ISSUE                        
         BE    *+14                                                             
         CLC   PISSDAT+2(1),PBQBST+2    ELSE CHECK DAY                          
         BL    RISISSCN                                                         
*                                                                               
         CLC   PISSDAT(2),PBQBEND  MONTH AND YEAR                               
         BH    RISISSCN                                                         
         CLI   PISSDAT+2,0         OKAY IF MONTHLY ISSUE                        
         BE    *+14                                                             
         CLC   PISSDAT+2(1),PBQBEND+2   ELSE CHECK DAY                          
         BH    RISISSCN                                                         
*                                                                               
         ST    R6,PBISSELA         SET ISSUE ELEMENT ADDRESS                    
*                                                                               
         GOTO1 =A(GETCON)          FIND CONTRACT                                
*                                                                               
RISISS50 DS    0H                                                               
*                                                                               
         MVI   PBRTCODE,0          INIT RETURN CODE                             
*                                                                               
         BAS   RE,GO               HOOK TO USER                                 
*                                                                               
         CLI   PBRTCODE,PBRTMORQ   CHECK IF MORE DATA IN RECORD                 
         BE    RISISS50             PASS BACK SAME ELEMENT                      
*                                                                               
RISISSCN DS    0H                                                               
*                                                                               
         XC    PBISSELA,PBISSELA   INIT ISSUE ELEMENT ADDRESS                   
*                                                                               
         IC    R0,PISSEL29+1       ELEMENT LENGTH                               
         AR    R6,R0               POINT TO NEXT ELEMENT                        
*                                                                               
         B     RISISSLP                                                         
*                                                                               
RISISSDN DS    0H                                                               
*                                                                               
RISISSX  DS    0H                                                               
*                                                                               
*                                                                               
         B     RISISRCN                                                         
*                                                                               
*        CONTINUATION OF ISSUE PROCESSING LOOP                                  
*                                                                               
RISISRNX DS    0H                  BYPASS SOME RECORDS                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL                                         
*                                                                               
         B     RISISRLP                                                         
*                                                                               
RISISRCN DS    0H                  READ NEXT ISSUE RECORD ON FILE               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ+IORDEL                                         
*                                                                               
         B     RISISRLP                                                         
*                                                                               
RISISRDN DS    0H                  END OF BUYS FOR PUB                          
*                                                                               
RISZEDCN DS    0H                                                               
*                                                                               
*        IF ADVERTISER REPORT FOR SINGLE PUB AND ALL EDITIONS                   
*           DO NEXT PUB/ZONE/EDITION                                            
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    RISZEDDN                                                         
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   RISZEDDN                                                         
         CLI   PBQALLZN,C'Y'       IF ALL ZONES AND EDITIONS                    
         BNE   RISZEDDN                                                         
*                                                                               
         B     RISZEDLP                                                         
*                                                                               
RISZEDDN DS    0H                                                               
*                                                                               
RISPBLCN DS    0H                                                               
*                                                                               
*        FIND NEXT PUB FOR PUBLISHER IF REQUESTED                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BNZ   RISPBLLP               GO GET NEXT PUB IN GROUP                  
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST  PROCESSING                      
         BNZ   RISPBLLP               GO GET NEXT PUB IN LIST                   
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   CONTINUE IF PUBLISHER FILTER GIVEN           
         BNZ   RISPBLLP                                                         
*                                                                               
RISPBLDN DS    0H                                                               
*                                                                               
READISSX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
RISWORKH DC    H'0'                HALF WORD WORKAREA                           
*                                                                               
RISWYEAR DS    0CL4                YEAR WORKAREA                                
RISWCC   DC    CL2' '              CENTURY                                      
RISWYY   DC    CL2' '              YEAR                                         
*                                                                               
RISSTKEY DS    XL(L'IOKEY)         START KEY                                    
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - READ INVOICE RECORDS - READINV'             
***********************************************************************         
*                                                                     *         
*        READ INVOICE RECORDS - MINIO RECORDSET                       *         
*              USES ITS OWN IO AREAS                                  *         
*                                                                     *         
*NTRY         HANDLES ONE CLIENT PER ENTRY                            *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
READINV  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
*                                                                               
         MVC   RIVSVMOD,PBMODE     SAVE CURRENT MODE                            
*                                                                               
         L     RF,AIO1             CLEAR ANY LEFTOVER BUYREC                    
         XC    0(256,RF),0(RF)                                                  
*                                                                               
         MVI   PBMODE,PBPROCIV     INDICATE PROCESSING INVOICES                 
*                                                                               
         XC    RIVHDR,RIVHDR       INIT HEADER SAVEAREA                         
         XC    RIVDTL,RIVDTL       INIT DETAIL ELEMENT                          
         XC    RIVCOM,RIVCOM       INIT COMMENT ELEMENT                         
         XC    PBIKYELA,PBIKYELA   INIT A(INVOICE KEY)                          
         XC    PBIHDELA,PBIHDELA   INIT A(INVOICE HEADER)                       
         XC    PBIDTELA,PBIDTELA   INIT A(DETAIL ELEMENT)                       
         XC    PBICMELA,PBICMELA   INIT A(COMMENT ELEMENT)                      
*                                                                               
         LA    R5,RIVBLKCB         ESTABLISH MINIO BLOCK                        
         USING MINBLKD,R5                                                       
*                                                                               
         BRAS  RE,RIVINIT          INITIALIZE MINIO RECORDSET                   
*                                                                               
         ST    R5,PBANVMIN         SAVE A(MINIO CONTROL BLOCK)                  
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        FIND NEXT PUB FOR PUBLISHER IF REQUESTED                     *         
*          EACH PUB FOUND IS SET IN PBQPUB SO LOGIC ACTS AS IF        *         
*          A SINGLE PUB WAS REQUESTED                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RIVPBLLP DS    0H                                                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BZ    RIVPBLL1                                                         
*                                                                               
         GOTO1 =A(PUBGRP)             GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RIVPBL10               ONE FOUND                                 
         B     RIVPBLDN               END OF PUBS                               
*                                                                               
RIVPBLL1 DS    0H                                                               
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST PROCESSING                       
         BZ    RIVPBLL2                                                         
*                                                                               
         GOTO1 =A(PUBLIS),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RIVPBL10               ONE FOUND                                 
         B     RIVPBLDN               END OF PUBS                               
*                                                                               
RIVPBLL2 DS    0H                                                               
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   SKIP IF NO PUBLISHER GIVEN                   
         BZ    RIVPBL10                                                         
*                                                                               
         GOTO1 =A(PBLFLTR),RR=RELO PUBLISHER FILTER REQUESTED                   
         BNE   RIVPBLDN       REACHED END OF PUBS FOR PUBLISHER                 
*                                                                               
RIVPBL10 DS    0H                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        IF WE ARE DOING A SINGLE/PUB AND AOR PROCESSING              *         
*          FIND NEXT PUB/ZONE/EDITION TO LOOK AT                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RIVZEDLP DS    0H                                                               
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    RIVZED10                                                         
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   RIVZED10                                                         
         CLI   PBQALLZN,C'Y'       IF ALL ZONES AND EDITIONS                    
         BNE   RIVZED10                                                         
*                                                                               
         GOTO1 =A(GETNXTZN)           FIND NEXT ZONE/EDITION                    
         BZ    RIVZEDDN                   NO MORE                               
*                                                                               
RIVZED10 DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
         XC    IOKEY,IOKEY         INIT INVOICE KEY                             
         LA    R4,IOKEY                                                         
         USING PINVKEY,R4          ESTABLISH INVOICE RECORD KEY                 
*                                                                               
         MVC   PINVAGY,PBAGY       SET AGENCY                                   
         MVC   PINVMED,PBMED       SET MEDIA                                    
         MVI   PINVTYPE,PINVTYPQ   SET RECORD TYPE TO INVOICE                   
         MVC   PINVCLT,PBCLT       SET CLIENT                                   
*                                  WOULD LIKE TO SET PRODUCT BUT                
*                                  SOME RECORDS HAVE MULTIPLE PRODUCTS          
*                                                                               
         MVC   PINVPRD,=C'***'     START WITH MULTI-PRODUCT INVOICE             
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    *+10                                                             
         MVC   PINVPUB,PBQPUB         SET PUB IN KEY                            
*                                                                               
         XC    PBPROD,PBPROD       INIT PRODUCT CODE FIELD                      
         XC    FESCOUNT,FESCOUNT   CLEAR ESTIMATE BUFFER COUNT                  
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI READ FIRST RECORD                              
*                                                                               
RIVPRDLP DS    0H                                                               
*                                                                               
         LA    R4,IOKEY            RE-ESTABLISH INVOICE RECORD KEY              
*                                                                               
         CLC   PINVKEY(PINVPUB-PINVKEY),IOKEYSAV DONE ON PRODUCT CHANGE         
         BNE   RIVPRDCN                                                         
*                                                                               
         OC    PBQPUB,PBQPUB       IF PROCESSING SINGLE PUB                     
         BZ    *+14                                                             
         CLC   PINVPUB,PBQPUB      THEN PUB MUST MATCH                          
         BNE   RIVPRDCN                                                         
*                                                                               
*****                                                                           
*****    CLC   PINVYS,PBINVYRS     YEAR MUST FALL IN INVOICE DATE RANGE         
*****    BL    RIVPRDSQ                                                         
*****    CLC   PINVYS,PBINVYRE                                                  
*****    BH    RIVPRDSQ                                                         
*                                                                               
*        READ INVOICE RECORDSET                                                 
*                                                                               
         XC    PBIKYELA,PBIKYELA   INIT ELM ADDRESSES                           
         XC    PBIHDELA,PBIHDELA   INIT ELM ADDRESSES                           
         XC    PBIDTELA,PBIDTELA   INIT ELM ADDRESSES                           
         XC    PBICMELA,PBICMELA   INIT ELM ADDRESSES                           
*                                                                               
         MVC   MINMKEY(L'PINVMAST),IOKEY       SET MASTER KEY FOR MINIO         
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINOPN',MINBLKD)  READ FIRST RECORD              
         CLI   MINERR,0                                                         
         BNE   RIVPRDNX            RECORD NOT FOUND                             
*                                                                               
         LA    RF,MINMKEY          PASS MASTER KEY ADDRESS                      
         ST    RF,PBIKYELA                                                      
*                                                                               
         MVC   PBPUB(6),PINVPUB-PINVKEY(RF)    SET PUB KEY                      
*                                                                               
         GOTOR GETPUBN,HALF        GET PUB RECORD IN CORE                       
         BNE   RIVPRDSQ            PUB NOT ON FILE - SKIP                       
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY                             
         MVI   MINEKEY,PIMHDREQ    SET TO READ HEADER ELEMENTS                  
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINHI',MINBLKD) READ FIRST HEADER ELM            
*                                                                               
RIVHDRLP DS    0H                                                               
*                                                                               
         XC    RIVHDR,RIVHDR       INIT HEADER SAVEAREA                         
         XC    PBIHDELA,PBIHDELA   INIT A(INVOICE HEADER)                       
*                                                                               
         CLI   MINERR,0                                                         
         BNE   RIVHDRDN            NO HEADERS FOUND                             
*                                                                               
         OC    PBQPUB,PBQPUB       ACCEPT IF  DOING ALL PUBS                    
         BZ    RIVPUBX                                                          
*                                  IF SINGLE PUB                                
         CLC   PINVPUB(4),PBQPUB    REJECT IF PUB ^= REQUESTED PUB              
         BNE   RIVHDRDN                                                         
*                                                                               
         CLI   PBQALLZN,C'Y'       ACCEPT IF DOING ALL ZONES + EDTS             
         BE    RIVPUBX                                                          
*                                                                               
         CLC   PINVPUB+4(1),PBQZON     REJECT IF ZONE                           
         BNE   RIVHDRDN                                                         
*                                                                               
         CLC   PINVPUB+5(1),PBQEDT       OR EDITION DON'T MATCH                 
         BNE   RIVHDRDN                                                         
*                                                                               
RIVPUBX  DS    0H                                                               
*                                                                               
         L     R3,MINELEM          ESTABLISH HEADER ELEMENT                     
         USING PIMHDREL,R3                                                      
*                                                                               
         CLI   PBQTRACE,C'Y'       IF TRACING                                   
         BNE   INVT1                                                            
*                                                                               
         GOTOR INVTRACE,PARM,(R3)                                               
*                                                                               
INVT1    DS    0H                                                               
*                                                                               
         CLI   PIMHDREL,PIMHDREQ   MUST BE HEADER ELEMENT                       
         BNE   RIVHDRDN                                                         
*                                                                               
         CLC   PIMENDDT,PBQBST     MAKE SURE INVOICE WITHIN                     
         BL    RIVHDRCN                                                         
         CLC   PIMSTDT,PBQBEND        REQUEST DATES                             
         BH    RIVHDRCN                                                         
*                                                                               
         MVC   RIVHDR,PIMHDREL     SAVE HEADER ELEMENT                          
         MVI   RIVHDRSW,C'Y'       INDICATE WE HAVE AN INVOICE HDR              
*                                                                               
         LA    R3,RIVHDR           PASS A(HEADER ELEMENT)                       
         ST    R3,PBIHDELA                                                      
*                                                                               
         XC    MINEKEY,MINEKEY     INIT MINIO ELEMENT KEY                       
*                                                                               
         MVI   MINEKEY,PIMDTLEQ    SET TO READ DETAIL KEY                       
         MVC   MINEKEY+1(1),PIMHDRSQ SET HEADER SEQUENCE NUMBER                 
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINHI',MINBLKD)  READ FIRST DETAIL ELM           
*                                                                               
RIVDTLLP DS    0H                                                               
*                                                                               
         XC    RIVDTL,RIVDTL       INIT DETAIL ELEMENT                          
         XC    RIVCOM,RIVCOM       INIT COMMENT ELEMENT                         
         XC    PBIDTELA,PBIDTELA   INIT A(DETAIL ELEMENT)                       
         XC    PBICMELA,PBICMELA   INIT A(COMMENT ELEMENT)                      
*                                                                               
         CLI   MINERR,0            DONE ON ERROR                                
         BNE   RIVDTLDN                                                         
*                                                                               
         L     R6,MINELEM          POINT TO FOUND DETAIL ELEMENT                
         USING PIMDTLEL,R6         ESTABLISH DETAIL ELEMENT                     
*                                                                               
         CLI   PBQTRACE,C'Y'       IF TRACING                                   
         BNE   INVT2                                                            
*                                                                               
         GOTOR INVTRACE,PARM,(R6)                                               
*                                                                               
INVT2    DS    0H                                                               
*                                                                               
         CLI   PIMDTLEL,PIMDTLEQ   MUST BE DETAIL ELEMENT                       
         BNE   RIVDTLDN                                                         
*                                                                               
         CLC   PIMDTLS1,PIMHDRSQ   MUST BE FOR CORRECT HEADER                   
         BNE   RIVDTLDN                                                         
*                                                                               
         MVI   RIVHDRSW,0          HEADER HAS DETAIL FOR PERIOD                 
*                                                                               
*        FILTER ON MATCHED STATUS                                               
*                                                                               
         TM    PBQMATSW,PBQMATYQ   IF MATCHED ONLY                              
         BNO   RIVMAT10                                                         
*                                                                               
         TM    PIMDSTAT,X'10'         DROP IF NOT MATCHED                       
         BNO   RIVDTLCN                                                         
         B     RIVMAT40                                                         
*                                                                               
RIVMAT10 DS    0H                                                               
*                                                                               
         TM    PBQMATSW,PBQMATNQ   IF UNMATCHED ONLY                            
         BNO   RIVMAT40                                                         
*                                                                               
         TM    PIMDSTAT,X'10'         DROP IF MATCHED                           
         BO    RIVDTLCN                                                         
*                                                                               
RIVMAT40 DS    0H                                                               
*                                                                               
*        FILTER ON TEARSHEET STATUS                                             
*                                                                               
         TM    PBQMATSW,PBQTSHYQ   IF TEARSHEET ONLY                            
         BNO   RIVTSH10                                                         
*                                                                               
         TM    PIMDSTAT,X'08'         DROP IF NO TEARSHEET                      
         BZ    RIVDTLCN                                                         
         B     RIVTSH40                                                         
*                                                                               
RIVTSH10 DS    0H                                                               
*                                                                               
         TM    PBQMATSW,PBQTSHNQ   IF NO TEARSHEET  ONLY                        
         BNO   RIVTSH40                                                         
*                                                                               
         TM    PIMDSTAT,X'08'         DROP IF TEARSHEET                         
         BO    RIVDTLCN                                                         
*                                                                               
RIVTSH40 DS    0H                                                               
*                                                                               
*        FILTER ON PAID STATUS                                                  
*                                                                               
         CLI   PBQFLTDA,C'P'         IF PAID  ONLY REQUESTED                    
         BNE   RIVDLPDX                                                         
*                                                                               
         TM    PIMDSTAT,X'02'         DROP IF NOT PAID                          
         BNO   RIVDTLCN                                                         
         B     RIVDLPBX                                                         
*                                                                               
RIVDLPDX DS    0H                                                               
*                                                                               
         CLI   PBQFLTDA,C'A'         IF PAYABLE ONLY DATA REQUESTED             
         BNE   RIVDLPBX                                                         
*                                                                               
         TM    PIMDSTAT,X'02'            DROP IF PAID                           
         BO    RIVDTLCN                                                         
*                                                                               
RIVDLPBX DS    0H                                                               
*                                                                               
         LA    R1,PIMIDATE         DEFAULT TO INVOICE RUN DATE                  
         OC    PIMBDATE,PIMBDATE   USE MATCHED BUY DATE IF PRESENT              
         BZ    *+8                                                              
         LA    R1,PIMBDATE                                                      
*                                                                               
         CLC   0(3,R1),PBQBST      MAKE SURE INVOICE DETAIL                     
         BL    RIVDTLCN                                                         
         CLC   0(3,R1),PBQBEND        IN REQUEST PERIOD                         
         BH    RIVDTLCN                                                         
*                                                                               
*              FIND PRODUCT IN BUFFER                                           
*                                                                               
         CLC   =C'ALL',PBQPRD      SKIP IF                                      
         BE    *+10                                                             
         CLC   PBQPRD,BLANKS         MULTIPLE PRODUCTS REQUESTED                
         BE    RIVDLPR0                                                         
*                                                                               
         CLC   PIMCPRD,BLANKS      IF CORRECTED PRODUCT EXISTS                  
         BNH   *+18                                                             
         CLC   PIMCPRD,PBQPRD         CORRECTED PRODUCT MUST MATCH              
         BNE   RIVDTLCN                                                         
         B     RIVDLPR0                                                         
*                                                                               
         CLC   PIMSPRD,BLANKS      IF SPECIFIC  PRODUCT EXISTS                  
         BNH   *+18                                                             
         CLC   PIMSPRD,PBQPRD         SPECIFIC  PRODUCT MUST MATCH              
         BNE   RIVDTLCN                                                         
         B     RIVDLPR0                                                         
*                                                                               
RIVDLPR0 DS    0H                                                               
*                                                                               
         CLC   PIMCPRD,BLANKS      IF CORRECTED PRODUCT EXISTS                  
         BNH   RIVDLPR1                                                         
*                                                                               
         CLC   PIMCPRD,PINVPRD        OKAY IF SAME AS INVOICE PRODUCT           
         BE    RIVDLPRX                                                         
         MVC   PBPROD,PIMCPRD         ELSE SET FOR CORRECTED PRODUCT            
         B     RIVDLPGT               GET PRODUCT FROM BUFFER                   
*                                                                               
RIVDLPR1 DS    0H                                                               
*                                                                               
         CLC   PIMSPRD,BLANKS      IF SPECIFIC  PRODUCT EXISTS                  
         BNH   RIVDLPR2                                                         
*                                                                               
         CLC   PIMSPRD,PINVPRD        OKAY IF SAME AS INVOICE PRODUCT           
         BE    RIVDLPRX                                                         
         MVC   PBPROD,PIMSPRD         ELSE SET FOR SPECIFC PRODUCT              
         B     RIVDLPGT               GET PRODUCT FROM BUFFER                   
*                                                                               
RIVDLPGT DS    0H                  GET PRODUCT FROM BUFFER                      
*                                                                               
         GOTOR GETPRD              FIND PRODUCT IN BUFFER                       
*                                                                               
         B     RIVDLPRX                                                         
*                                                                               
RIVDLPR2 DS    0H                                                               
         B     RIVDLPRX            IGNORE                                       
*                                                                               
RIVDLPRX DS    0H                                                               
*                                                                               
*              FIND CORRECT ESTIMATE                                            
*                                                                               
         XC    ESTDATA,ESTDATA     INIT ESTIMATE DATA                           
         LA    R8,ESTDATA          ESTABLISH DUMMY EST BUFFER ENTRY             
         USING ESTBUFFD,R8                                                      
*                                                                               
         MVC   EBFMED,PINVMED      SET MEDIA                                    
         MVC   EBFCLT,PINVCLT      SET CLIENT                                   
         MVC   EBFPRD,PBPROD       SET PRODUCT                                  
*                                                                               
         MVC   EBFEST,PIMBEST      DEFAULT TO MATCHED ESTIMATE                  
*                                                                               
         OC    EBFEST,EBFEST       IF NO MATCHED ESTIMATE                       
         BNZ   *+10                                                             
         MVC   EBFEST,PIMIEST         USE INVOICE'S ESTIMATE                    
*                                                                               
         BAS   RE,FLTREST          FILTER ON ESTIMATE AND PUT IN TABLE          
         BE    RIVEST10               ACCEPTED                                  
*                                                                               
         OC    EBFEST,EBFEST          DROP IF ESTIMATE KNOWN                    
         BNZ   RIVDTLCN                                                         
*                                                                               
RIVEST10 DS    0H                                                               
*                                                                               
         OC    PIMBDATE,PIMBDATE   IF MATCHED DETAIL                            
         BZ    *+10                                                             
         MVC   PBZONE(2),PIMBZONE     SET DETAIL'S ZONE AND EDITION             
*                                                                               
         GOTOR GETPUBN,HALF        GET PUB RECORD IN CORE                       
         BNE   RIVDTLCN            PUB NOT FOUND - SKIP                         
*                                                                               
         MVC   RIVDTL,PIMDTLEL     SAVE DETAIL ELEMENT                          
         LA    R6,RIVDTL                                                        
         ST    R6,PBIDTELA         PASS A(INVOICE DETAIL ELEMENT)               
*                                                                               
         TM    PIMDSTAT,X'04'      SKIP IF NO COMMENTS FOR DETAIL               
         BNO   RIVCOMDN                                                         
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY                             
         MVI   MINEKEY,PIMCOMEQ    SET FOR COMMENT ELEMENT                      
         MVC   MINEKEY+1(1),PIMHDRSQ SET HEADER SEQUENCE NUMBER                 
         MVC   MINEKEY+2(2),PIMDTLS2 SET DETAIL SEQUENCE NUMBER                 
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINRD',MINBLKD) READ COMMENT ELEMENT             
         CLI   MINERR,0            SKIP IF ERRORS                               
         BNE   RIVCOMDN                                                         
*                                                                               
         L     R1,MINELEM          POINT TO FOUND COMMENT ELEMENT               
         USING PIMCOMEL,R1         ESTABLISH COMMENT ELEMENT                    
*                                                                               
         CLI   PIMCOMEL,PIMCOMEQ   MUST BE COMMENT ELEMENT                      
         BNE   RIVDTLDN                                                         
*                                                                               
         CLC   PIMCOMS1,PIMHDRSQ   MUST BE FOR CORRECT HEADER                   
         BNE   RIVDTLDN                                                         
*                                                                               
         CLC   PIMCOMS2,PIMDTLS2   MUST BE FOR CORRECT DETAIL                   
         BNE   RIVDTLDN                                                         
*                                                                               
         MVC   RIVCOM,PIMCOMEL     SAVE COMMENT ELEMENT                         
         LA    R1,RIVCOM                                                        
         ST    R1,PBICMELA         PASS A(INVOICE COMMENT ELEMENT)              
*                                                                               
RIVCOMDN DS    0H                                                               
*                                                                               
         BRAS  RE,GO               HOOK TO DRIVER                               
*                                                                               
         TM    PIMDSTAT,X'04'      SKIP IF NO COMMENTS FOR DETAIL               
         BNO   RIVDTLCN                                                         
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY AREA                        
         MVC   MINEKEY(1),RIVDTL   SET TO RE-READ DETAIL ELEMENT                
         MVC   MINEKEY+1(L'PINVMINI-1),PIMDTLS1                                 
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINHI',MINBLKD) RE-POINT TO DTL ELM              
*                                                                               
RIVDTLCN DS    0H                                                               
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINSEQ',MINBLKD) READ NEXT DETAIL ELM            
*                                                                               
         CLI   MINERR,0                                                         
         BE    RIVDTLLP            DETAIL FOUND                                 
*                                                                               
RIVDTLDN DS    0H                                                               
*                                                                               
         TM    PBQMATSW,PBQMATYQ   SKIP IF MATCHED ONLY                         
         BO    RIVDTLD1                                                         
*                                                                               
         CLI   RIVHDRSW,C'Y'       IF HEADER HASN'T BEEN TO DRIVER              
         BNE   *+8                                                              
         BRAS  RE,GO                  GO TO DRIVER FOR HEADER ONLY              
*                                                                               
RIVDTLD1 DS    0H                                                               
*                                                                               
         MVI   RIVHDRSW,0          TURN OFF HEADER SWITCH                       
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY                             
         MVC   MINEKEY(1),PIMHDREL SET HEADER KEY                               
         MVC   MINEKEY+1(L'PINVMINI-1),PIMHDRSQ SET REST OF KEY                 
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINHI',MINBLKD) RE-SET HDR ELM POINTER           
*                                                                               
RIVHDRCN DS    0H                                                               
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINSEQ',MINBLKD) READ NEXT HEADER                
*                                                                               
         B     RIVHDRLP                                                         
*                                                                               
RIVHDRDN DS    0H                                                               
*                                                                               
RIVPRDNX DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RESTORE FILE POINTERS                        
*                                                                               
RIVPRDSQ DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   NEXT INVOICE FOR PRODUCT                     
*                                                                               
         CLC   IOKEY(L'PINVMAST),IOKEYSAV REPEAT IF SAME MASTER KEY             
         BE    RIVPRDSQ                                                         
*                                                                               
         B     RIVPRDLP                                                         
*                                                                               
RIVPRDCN DS    0H                                                               
*                                                                               
         XC    PBIKYELA,PBIKYELA   CLEAR A(KEY)                                 
         XC    PBIHDELA,PBIHDELA   CLEAR A(HEADER)                              
         XC    PBIDTELA,PBIDTELA   CLEAR A(DETAIL)                              
*                                                                               
         MVC   IOKEY,IOKEYSAV      RESTORE LAST INVOICE KEY                     
*                                                                               
         CLC   =C'***',PINVPRD-PINVKEY+IOKEY IF VARIOUS JUST DONE               
         BNE   *+10                                                             
         XC    PBPROD,PBPROD          INIT CURRENT PRODUCT                      
*                                                                               
         GOTOR GETPRD              GET NEXT PRODUCT                             
         BNZ   RIVPRDDN            DONE IF NO NEW PRODUCT FOUND                 
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY            RE-ESTABLISH INVOICE KEY                     
         USING PINVKEY,R4                                                       
*                                                                               
         MVC   PINVAGY,PBAGY       SET AGENCY                                   
         MVC   PINVMED,PBMED       SET MEDIA                                    
         MVI   PINVTYPE,PINVTYPQ   SET RECORD TYPE                              
         MVC   PINVCLT,PBCLT       SET CLIENT                                   
         MVC   PINVPRD,PBPROD      SET NEXT PRODUCT                             
*                                                                               
         OC    PBQPUB,PBQPUB       IF PROCESSING SINGLE PUB                     
         BZ    *+10                                                             
         MVC   PINVPUB,PBQPUB         USE IT                                    
*                                                                               
         XC    FESCOUNT,FESCOUNT   CLEAR ESTIMATE BUFFER COUNT                  
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST RECORD FOR PRODUCT                
*                                                                               
         B     RIVPRDLP                                                         
*                                                                               
RIVPRDDN DS    0H                                                               
*                                                                               
RIVZEDCN DS    0H                                                               
*                                                                               
*        IF ADVERTISER REPORT FOR SINGLE PUB AND ALL EDITIONS                   
*           DO NEXT PUB/ZONE/EDITION                                            
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    RIVZEDDN                                                         
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   RIVZEDDN                                                         
         CLI   PBQALLZN,C'Y'       IF ALL ZONES AND EDITIONS                    
         BNE   RIVZEDDN                                                         
*                                                                               
         B     RIVZEDLP                                                         
*                                                                               
RIVZEDDN DS    0H                                                               
*                                                                               
RIVPBLCN DS    0H                                                               
*                                                                               
*        FIND NEXT PUB FOR PUBLISHER IF REQUESTED                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BNZ   RIVPBLLP               GO GET NEXT PUB IN GROUP                  
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST  PROCESSING                      
         BNZ   RIVPBLLP               GO GET NEXT PUB IN LIST                   
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   CONTINUE IF PUBLISHER FILTER GIVEN           
         BNZ   RIVPBLLP                                                         
*                                                                               
RIVPBLDN DS    0H                                                               
*                                                                               
         MVC   PBMODE,RIVSVMOD     RESTORE CURRENT MODE                         
*                                                                               
READINVX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
RIVMINSW DC    C' '                C'I' - MINIO BLOCK INITIALIZED               
RIVHDRSW DC    C' '                C'Y' - HDR HASN'T BEEN TO DRIVER             
RIVSVMOD DS    XL1                 PROCESSING MODE SAVEAREA                     
*                                                                               
         DS    0D                                                               
RIVHDR   DS    XL256               INVOICE HEADER SAVEAREA                      
RIVDTL   DS    XL256               INVOICE DETAIL SAVEAREA                      
RIVCOM   DS    XL256               INVOICE COMMENT SAVEAREA                     
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - INITIALIZE MINIO BLOCK - RIVINIT'           
***********************************************************************         
*                                                                     *         
*        INITIALIZE MINIO CONTROL BLOCK                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
RIVINIT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
*                                                                               
         LA    R5,RIVBLKCB         ESTABLISH MINIO BLOCK                        
         USING MINBLKD,R5                                                       
*                                                                               
         LA    R0,RIVBLKCB         CLEAR MINBLOCK                               
         LA    R1,MINBLKL                                                       
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     R4,PBCOMFAC         POINT TO COMFACS                             
         USING COMFACSD,R4                                                      
         MVC   MINRECUP,CRECUP     A(RECUP)                                     
*                                                                               
         DROP  R4                                                               
*                                                                               
         MVC   MINCOMF,PBCOMFAC    A(COMFACS)                                   
         MVI   MINOPEN,C'N'        SET NOT OPEN                                 
         MVC   MINFIL,=CL8'PRTFILE' FILE NAME                                   
         MVC   MINDIR,=CL8'PRTDIR' DIR NAME                                     
         MVI   MINFKLEN,L'PINVKEY  KEY LENGTH                                   
         MVI   MINEKLEN,L'PINVMINI   ELEMENT KEY LENGTH                         
         MVI   MINEKDSP,PINVMINI-PINVKEY  DISP TO ELM KEY                       
         MVI   MINNCTL,2           NUMBER OF CONTROL BYTES                      
         MVC   MINFRCLM,=AL2(4096) MAXIMUM RECORD LENGTH                        
         MVC   MINBUFF,=A(RNVIOS)  A(FIRST BUFFER)                              
         MVI   MINNBUF,2           USE TWO BUFFERS                              
         MVC   MINRTAB,=A(RIVRTABC)   A(AREA FOR RECORD TABLE)                  
         MVC   MINRTABL,=Y(L'RIVRTABC) LENGTH OF RECORD TABLE                   
*                                                                               
         LA    RE,RIVELM           A(AREA FOR ELEM OR CLUSTER)                  
         ST    RE,MINELEM                                                       
         MVC   MINMAXEL,=Y(L'RIVELM)  MAX LENGTH OF ELEM OF CLUSTER             
         XC    RIVELM,RIVELM         CLEAR MINELEM AREA                         
*                                                                               
RIVINITX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - MINIO WORKAREAS - RIVMINWK'                 
***********************************************************************         
*                                                                     *         
*        WORKAREA MINIO CONTROL BLOCK                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RIVMINWK DS    0D                  ALIGNMENT                                    
         DC    C'MINBLKCB'         DUMP ID                                      
RIVELM   DS    XL256               ELEMENT WORKAREA                             
RIVBLKCB DS    XL(MINBLKL)         MINIO CONTROL BLOCK                          
         DS    0D                                                               
RIVRTABC DS    XL(20*(L'PINVMINI+6))   RECORD TABLE                             
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - READ NEW INVOICE RECS - READPNV'            
***********************************************************************         
*                                                                     *         
*        READ NEW INVOICE RECORDS - MINIO RECORDSET                   *         
*              USES ITS OWN IO AREAS                                  *         
*                                                                     *         
*NTRY         HANDLES ONE CLIENT PER ENTRY                            *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
READPNV  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
*                                                                               
         MVC   RNVSVMOD,PBMODE     SAVE CURRENT MODE                            
*                                                                               
         L     RF,AIO1             CLEAR ANY LEFTOVER BUYREC                    
         XC    0(256,RF),0(RF)                                                  
*                                                                               
         XC    PBPROD,PBPROD       CLEAR LEFTOVER FIELDS                        
         XC    PBEST,PBEST                                                      
         XC    PBPRDNM,PBPRDNM                                                  
         XC    PBESTNM,PBESTNM                                                  
*                                                                               
         MVI   PBMODE,PBPROCNV     INDICATE PROCESSING NEW INVS                 
*                                                                               
         XC    RNVADDDT,RNVADDDT   INIT INVOICE ADDED DATE                      
         XC    RNVHDR,RNVHDR       INIT HEADER SAVEAREA                         
         XC    RNVDTL,RNVDTL       INIT DETAIL ELEMENT                          
         XC    RNVHDRCM,RNVHDRCM   INIT HEADER COMMENT ELM                      
         XC    RNVDTLCM,RNVDTLCM   INIT DETAIL COMMENT ELM                      
*                                                                               
         XC    PBIKYELA,PBIKYELA   INIT A(INVOICE KEY)                          
         XC    PBIHDELA,PBIHDELA   INIT A(INVOICE HEADER)                       
         XC    PBIDTELA,PBIDTELA   INIT A(DETAIL ELEMENT)                       
         XC    PBICMELA,PBICMELA   INIT A(DETAIL COMMENT ELEMENT)               
         XC    PBICHELA,PBICHELA   INIT A(HEADER COMMENT ELEMENT)               
         XC    PBIADDTA,PBIADDTA   INIT A(INVOICE ADDED DATE)                   
*                                                                               
         L     R5,=A(RNVBLKCB)     ESTABLISH MINIO BLOCK                        
         USING MINBLKD,R5                                                       
*                                                                               
         BRAS  RE,RNVINIT          INITIALIZE MINIO RECORDSET                   
*                                                                               
         ST    R5,PBANVMIN         SAVE A(MINIO CONTROL BLOCK)                  
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        FIND NEXT PUB FOR PUBLISHER IF REQUESTED                     *         
*          EACH PUB FOUND IS SET IN PBQPUB SO LOGIC ACTS AS IF        *         
*          A SINGLE PUB WAS REQUESTED                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RNVPBLLP DS    0H                                                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BZ    RNVPBLL1                                                         
*                                                                               
         GOTOR PUBGRP                 GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RNVPBL10                  ONE FOUND                              
         B     RNVPBLDN                  END OF PUBS                            
*                                                                               
RNVPBLL1 DS    0H                                                               
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST PROCESSING                       
         BZ    RNVPBLL2                                                         
*                                                                               
         GOTO1 =A(PUBLIS),RR=RELO     GET NEXT PUB                              
*                                                                               
         OC    PBPUB(6),PBPUB      TEST IF END OF PUBS REACHED                  
         BNZ   RNVPBL10               ONE FOUND                                 
         B     RNVPBLDN               END OF PUBS                               
*                                                                               
RNVPBLL2 DS    0H                                                               
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   SKIP IF NO PUBLISHER GIVEN                   
         BZ    RNVPBL10                                                         
*                                                                               
         GOTOR PBLFLTR        PUBLISHER FILTER REQUESTED                        
         BNE   RNVPBLDN       REACHED END OF PUBS FOR PUBLISHER                 
*                                                                               
RNVPBL10 DS    0H                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        IF WE ARE DOING A SINGLE/PUB AND AOR PROCESSING              *         
*          FIND NEXT PUB/ZONE/EDITION TO LOOK AT                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RNVZEDLP DS    0H                                                               
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    RNVZED10                                                         
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   RNVZED10                                                         
         CLI   PBQALLZN,C'Y'       IF ALL ZONES AND EDITIONS                    
         BNE   RNVZED10                                                         
*                                                                               
         GOTOR GETNXTZN               FIND NEXT ZONE/EDITION                    
         BZ    RNVZEDDN                   NO MORE                               
*                                                                               
RNVZED10 DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
         XC    IOKEY,IOKEY         INIT INVOICE KEY                             
         LA    R4,IOKEY                                                         
         USING PNV2KEY,R4          ESTABLISH PERIOD PASSIVE PTR                 
*                                                                               
         MVC   PNV2AGY,PBAGY       SET AGENCY                                   
         MVC   PNV2MED,PBMED       SET MEDIA                                    
         MVI   PNV2RCD,PNV2RCDQ    SET RECORD TYPE TO NEW INVOICE               
         MVC   PNV2CLT,PBCLT       SET CLIENT                                   
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    *+10                                                             
         MVC   PNV2PBCD(6),PBQPUB     SET PUB IN KEY                            
*                                                                               
         XC    PBPROD,PBPROD       INIT PRODUCT CODE FIELD                      
         XC    PBPRDNM,PBPRDNM     INIT PRODUCT NAME FIELD                      
         XC    FESCOUNT,FESCOUNT   CLEAR ESTIMATE BUFFER COUNT                  
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL   READ FIRST RECORD                     
*                                                                               
RNVCLTLP DS    0H                                                               
*                                                                               
         LA    R4,IOKEY            RE-ESTABLISH INVOICE RECORD KEY              
*                                                                               
         CLC   PNV2KEY(PNV2PUB-PNV2KEY),IOKEYSAV DONE ON CLIENT CHANGE          
         BNE   RNVCLTDN                                                         
*                                                                               
         OC    PBQPUB,PBQPUB       IF PROCESSING SINGLE PUB                     
         BZ    *+14                                                             
         CLC   PBQPUB(6),PNV2PBCD  THEN PUB MUST MATCH                          
         BNE   RNVCLTDN                                                         
*                                                                               
         CLC   PNV2EDTE,PBQBST     INVOICE MUST COVER REQUEST PERIOD            
         BL    RNVCLTCN                                                         
         CLC   PNV2SDTE,PBQBEND                                                 
         BH    RNVCLTCN                                                         
*                                                                               
*        READ INVOICE RECORDSET                                                 
*                                                                               
         XC    PBIADDTA,PBIADDTA   INIT ELM ADDRESSES                           
         XC    PBIKYELA,PBIKYELA   INIT ELM ADDRESSES                           
         XC    PBIHDELA,PBIHDELA   INIT ELM ADDRESSES                           
         XC    PBIDTELA,PBIDTELA   INIT ELM ADDRESSES                           
         XC    PBICMELA,PBICMELA   INIT ELM ADDRESSES                           
         XC    PBICHELA,PBICHELA   INIT ELM ADDRESSES                           
*                                                                               
         LA    RF,MINMKEY          ESTABLISH MASTER KEY                         
         USING PNVRECD,RF                                                       
*                                                                               
         MVC   PNVKAGY,PNV2AGY     SET AGENCY                                   
         MVC   PNVKMED,PNV2MED     SET MEDIA                                    
         MVI   PNVKRCD,PNVKRCDQ    SET RECORD CODE                              
         MVC   PNVKSER#,PNV2SER#   SET SERIAL NUMBER                            
*                                                                               
         DROP  RF                                                               
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINOPN',MINBLKD)  OPEN MINIO SET                 
         CLI   MINERR,0                                                         
         BNE   RNVCLTCN            RECORD NOT FOUND                             
*                                                                               
         LA    RF,MINMKEY          PASS MASTER KEY ADDRESS                      
         ST    RF,PBIKYELA                                                      
*                                                                               
*        READ HEADER ELEMENT                                                    
*                                                                               
         XC    RNVHDR,RNVHDR       INIT HEADER SAVEAREA                         
         XC    RNVADDDT,RNVADDDT   INIT INVOICE ADDED DATE                      
         XC    RNVHDRCM,RNVHDRCM   INIT COMMENT ELEMENT                         
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEYAREA                         
         MVI   MINEKEY,PNVHKIDQ    SET FOR HEADER ELEMENT                       
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINHI',MINBLKD) READ HEADER ELM                  
*                                                                               
         CLI   MINERR,0            SKIP INVOICE IF                              
         BNE   RNVCLTCN            NO HEADER FOUND                              
*                                                                               
         L     R3,MINELEM          POINT TO FOUND HEADER                        
         USING PNVHDRD,R3          ESTABLISH HEADER ELEMENT                     
*                                                                               
         CLI   PBQTRACE,C'Y'       IF TRACING                                   
         BNE   RNVT1                                                            
*                                                                               
         GOTOR INVTRACE,PARM,(R3)                                               
*                                                                               
RNVT1    DS    0H                                                               
*                                                                               
         OC    PNVHKEY+2(6),PNVHKEY+2   MUST BE HEADER ELM                      
         BNZ   RNVCLTCN                                                         
*                                                                               
         MVC   RNVHDR,0(R3)        SAVE INVOICE HEADER                          
         LA    R3,RNVHDR           SWITCH HEADER POINTER                        
         ST    R3,PBIHDELA         PASS HEADER ELM ADDRESS                      
*                                                                               
         CLI   PBQTEST,C'D'        IF ONLY DELETES WANTED                       
         BNE   *+16                                                             
         TM    PNVHSTUS,PNVHDLQ       SKIP IF NOT DELETED                       
         BNO   RNVCLTCN                                                         
         B     RNVHDDLX                                                         
*                                                                               
         TM    PBQPOPT,PBQPODEL    SKIP IF INCLUDING DELETES                    
         BO    *+12                                                             
         TM    PNVHSTUS,PNVHDLQ    ELSE SKIP IF DELETED                         
         BO    RNVCLTCN                                                         
*                                                                               
RNVHDDLX DS    0H                                                               
*                                                                               
         MVI   RNVHDRSW,C'Y'       INDICATE WE HAVE AN INVOICE HDR              
*                                                                               
         MVC   PBPUB(6),PNVHPUB    SET PUB CODE FROM HEADER                     
*                                                                               
         GOTOR GETPUBN,HALF        GET PUB RECORD IN CORE                       
         BNE   RNVCLTCN            PUB NOT ON FILE - SKIP                       
*                                                                               
*        FIND LATEST COMMENT AND ACTIVITY ELEMENTS                              
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINSEQ',MINBLKD)  READ NEXT ELEMENT              
*                                                                               
         CLI   MINERR,0            DONE ON ERROR                                
         BNE   RNVHDRDN                                                         
*                                                                               
         XC    RNVHDRCM,RNVHDRCM   INIT COMMENT SAVEAREA                        
*                                                                               
RNVHDRLP DS    0H                                                               
*                                                                               
         CLI   MINERR,0            DONE IF ERRORS                               
         BNE   RNVHDRDN                                                         
*                                                                               
         L     R6,MINELEM          POINT TO FOUND ELEMENT                       
         USING PNVCOMD,R6          ESTABLISH AS COMMENT ELEMENT                 
*                                                                               
         CLI   PNVCKCDE,PNVCKHDQ   DONE IF NOT A HEADER ELEMENT                 
         BNE   RNVHDRDN                                                         
*                                                                               
         LA    R2,RNVHDRCM                                                      
*                                                                               
         CLI   PBQTRACE,C'Y'       IF TRACING                                   
         BNE   PNVT1A                                                           
*                                                                               
         GOTOR INVTRACE,PARM,(R6)                                               
*                                                                               
PNVT1A   DS    0H                                                               
*                                                                               
*        BUILD A DUMMY ELEMENT THAT STARTS WITH 1ST HEADER COMMENT              
*          IN A GROUP                                                           
*        COMMENT PORTION OF OTHER HEADER ELEMENTS                               
*        IS ADDED TO END OF DUMMY ELEMENT UNTIL MAX 255 LENGTH                  
*                                                                               
RNVHC1LP DS    0H                                                               
*                                                                               
         CLI   PNVCKTYP,PNVCKCMQ   SKIP IF NOT A GENERAL  COMMENT               
         BE    *+8                                                              
         CLI   PNVCKTYP,PNVCKPBQ   SKIP IF NOT A DIALOGUE COMMENT               
         BNE   RNVHC1DN                                                         
*                                                                               
         LA    R2,RNVHDRCM                                                      
         ST    R2,PBICHELA         SAVE A(COMMENT SAVEAREA)                     
*                                                                               
         XC    RNVHDRCM,RNVHDRCM   INIT COMMENT SAVEAREA                        
*                                                                               
         MVC   0(PNVCOMLQ,R2),PNVCOMD  SAVE HEADER PORTION                      
         LA    R2,PNVCOMLQ(R2)     POINT TO COMMENT SAVEAREA                    
*                                                                               
         LHI   R0,PNVCOMLQ         LENGTH ACCUMULATOR                           
*                                                                               
RNVHC2LP DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,PNVCKLEN       ELEMENT LENGTH                               
         SHI   RF,PNVCOMLQ         ADJUST FOR HEADER AREA                       
         BZ    RNVHC2CN            NO COMMENT                                   
*                                                                               
         AR    R0,RF               NEW TOTAL ELEMENT LENGTH                     
         CHI   R0,254              CANNOT EXCEDE 255                            
         BL    RNVHC210                                                         
*                                                                               
         LR    RE,R0               COPY PROPSED NEW LENGTH                      
         SHI   RE,254              DEFAULT TO MAX LENGTH                        
         SR    RF,RE               MAX LENGTH TO BE ADDED TO ELEMENT            
         BNP   RNVHC2CN            NO ROOM LEFT IN ELEMENT                      
*                                                                               
RNVHC210 DS    0H                                                               
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PNVCCOM     SAVE COMMENT ELEMENT                         
*                                                                               
         LA    R2,0(RF,R2)         POINT TO LAST OF COMMENT                     
         CLI   0(R2),C' '          IF NOT A SPACE                               
         BNH   *+12                                                             
         MVI   1(R2),C' '             ADD A SPACE TO THE END                    
         LA    R2,1(R2)               ADJUST POINTER                            
*                                                                               
         LA    R2,1(R2)            BUMP TO NEXT AVAILABLE SAVE AREA             
*                                                                               
         LA    RE,RNVHDRCM         RE-CALCULATE ELEMENT LENGTH                  
         LR    R0,R2                                                            
         SR    R0,RE                                                            
*                                                                               
RNVHC2CN DS    0H                                                               
*                                                                               
         MVC   MINEKEY+1(L'PNVKELMK-1),2(R6)     CURRENT ELEMENT KEY            
         GOTO1 PBVMINIO,PARM,('MINSEQ',MINBLKD)  READ NEXT ELEMENT              
*                                                                               
         CLI   MINERR,0            DONE ON ERROR                                
         BNE   RNVHC2DN                                                         
*                                                                               
         L     R6,MINELEM          POINT TO FOUND ELEMENT                       
*                                                                               
         CLI   PBQTRACE,C'Y'       IF TRACING                                   
         BNE   PNVT1B                                                           
*                                                                               
         GOTOR INVTRACE,PARM,(R6)                                               
*                                                                               
PNVT1B   DS    0H                                                               
*                                                                               
*                                                                               
*        CONTINUE IF SAME COMMENT GROUP                                         
*                                                                               
         CLC   PNVCKCDE,PNVCKCDE-PNVCOMD+RNVDTLCM   ELM CODE                    
         BNE   RNVHC2C1                                                         
*                                                                               
         CLC   PNVCKDSQ,PNVCKDSQ-PNVCOMD+RNVDTLCM   DTL SQN                     
         BNE   RNVHC2C1                                                         
*                                                                               
         CLC   PNVCKTYP,PNVCKTYP-PNVCOMD+RNVDTLCM   COMMENT TYPE                
         BNE   RNVHC2C1                                                         
*                                                                               
         CLC   PNVCKCGP,PNVCKCGP-PNVCOMD+RNVDTLCM   GROUP NUMBER                
         BNE   RNVHC2C1                                                         
*                                                                               
         B     RNVHC2LP            CONTINUE                                     
*                                                                               
RNVHC2C1 DS    0H                                                               
*                                                                               
*        NEW COMMENT GROUP - REPLACES ONE JUST BUILT                            
*                                                                               
         B     RNVHC1LP            TREAT AS NEWER COMMENT                       
*                                                                               
RNVHC2DN DS    0H                                                               
*                                                                               
RNVHC1CN DS    0H                                                               
*                                                                               
RNVHC1DN DS    0H                                                               
*                                                                               
*        SET LENGTH IN COMMENT ELEMENT                                          
*                                                                               
         OC    RNVHDRCM,RNVHDRCM   SKIP IF NO HEADER COMMENTS                   
         BZ    RNVHC1D1                                                         
*****                                                                           
*****    LA    RF,RNVHDRCM         POINT TO START OF SAVEAREA                   
*****    SR    R2,RF               LENGTH OF COMMENT ELEMENT                    
*****    STC   R2,RNVHDRCM+1       SET NEW COMMENT LENGTH                       
*****                                                                           
         STC   R0,RNVHDRCM+1       SET NEW COMMENT LENGTH                       
*                                                                               
RNVHC1D1 DS    0H                                                               
*                                                                               
         CLI   PNVCKCDE,PNVCKHDQ   DONE IF NOT A HEADER ELEMENT                 
         BNE   RNVHDRDN                                                         
*                                                                               
         USING PNVACTHD,R6         ESTABLISH AS HEADER ACTIVITY ELEMENT         
*                                                                               
         CLI   PNVAKACT,PNVAKACQ   SKIP IF NOT ACTIVITY ELEMENT                 
         BNE   RNVHACTN                                                         
*                                                                               
         TM    PNVAHCH1,PNVAHADD   SKIP IF NOT INVOICE ADD ACTIVITY             
         BNO   RNVHACTX                                                         
*                                                                               
         LA    RF,RNVADDDT            SET A(INVOICE ADDED DATE)                 
         ST    RF,PBIADDTA                                                      
*                                                                               
         MVC   RNVADDDT,PNVAHDTE      SAVE INVOICE ADDED DATE                   
         MVC   RNVADPID,PNVAHPID      SAVE INVOICE ADDED PID                    
*                                                                               
RNVHACTX DS    0H                                                               
*                                                                               
         B     RNVHDRCN                                                         
*                                                                               
RNVHACTN DS    0H                                                               
*                                                                               
RNVHDRCN DS    0H                                                               
*                                                                               
         MVC   MINEKEY+1(L'PNVKELMK-1),2(R6)     CURRENT ELEMENT KEY            
         GOTO1 PBVMINIO,PARM,('MINSEQ',MINBLKD)  READ NEXT ELEMENT              
*                                                                               
         B     RNVHDRLP                                                         
*                                                                               
RNVHDRDN DS    0H                                                               
*                                                                               
*        READ DETAIL ELEMENTS                                                   
*                                                                               
         XC    MINEKEY,MINEKEY     INIT MINIO ELEMENT KEY                       
*                                                                               
         MVI   MINEKEY,PNVDKIDQ    SET TO READ DETAIL ELEMENTS                  
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINHI',MINBLKD)  READ FIRST DETAIL ELM           
*                                                                               
RNVDTLLP DS    0H                                                               
*                                                                               
         XC    RNVDTL,RNVDTL       INIT DETAIL ELEMENT                          
         XC    PBIDTELA,PBIDTELA   INIT A(DETAIL ELEMENT)                       
*                                                                               
         XC    PBPROD,PBPROD       CLEAR LEFTOVER FIELDS                        
         XC    PBEST,PBEST                                                      
         XC    PBPRDNM,PBPRDNM                                                  
         XC    PBESTNM,PBESTNM                                                  
*                                                                               
         CLI   MINERR,0            DONE ON ERROR                                
         BNE   RNVDTLDN                                                         
*                                                                               
         L     R6,MINELEM          POINT TO FOUND DETAIL ELEMENT                
         USING PNVDTLD,R6          ESTABLISH DETAIL ELEMENT                     
*                                                                               
         CLI   PBQTRACE,C'Y'       IF TRACING                                   
         BNE   PNVT2                                                            
*                                                                               
         GOTOR INVTRACE,PARM,(R6)                                               
*                                                                               
PNVT2    DS    0H                                                               
*                                                                               
         CLI   PNVDKTYP,PNVDKDSQ   MUST BE DETAIL DESCRIPTION                   
         BNE   RNVDTLSQ                                                         
*                                                                               
         MVC   RNVDTL,PNVDTLD      SAVE DETAIL ELEMENT                          
*                                                                               
         LA    RF,PNVDPUB          DEFAULT TO DETAIL PUB                        
*                                                                               
         OC    PNVDPUB,PNVDPUB     IF NO PUB ENTERED                            
         BNZ   *+8                                                              
         LA    RF,PNVHPUB             USE HEADER PUB                            
*                                                                               
         CLC   PNV2PUB,0(RF)       MUST MATCH PASSIVE PUB                       
         BNE   RNVDTLCN                                                         
*                                                                               
         MVC   PBPUB(6),0(RF)      SAVE PUB CODE                                
*                                                                               
         CLI   PBQTEST,C'D'        IF ONLY DELETES WANTED                       
         BNE   *+16                                                             
         TM    PNVDSTAT,PNVDDLQ       SKIP IF NOT DELETED                       
         BNO   RNVDTLCN                                                         
         B     RNVDTDLX                                                         
*                                                                               
         TM    PBQPOPT,PBQPODEL    SKIP IF INCLUDING DELETES                    
         BO    *+12                                                             
         TM    PNVDSTAT,PNVDDLQ    ELSE SKIP IF DELETED                         
         BO    RNVDTLCN                                                         
*                                                                               
RNVDTDLX DS    0H                                                               
*                                                                               
         OC    PNVDCLT,PNVDCLT     IF CLIENT PRESENT                            
         BZ    *+14                                                             
         CLC   PNVDCLT,PBCLT          MUST MATCH CURRENT CLIENT                 
         BNE   RNVDTLCN                                                         
*                                                                               
RNVPUBOK DS    0H                                                               
*                                                                               
         GOTOR GETPUBN,HALF        GET PUB RECORD IN CORE                       
         BNE   RNVDTLCN            PUB NOT ON FILE - SKIP                       
*                                                                               
RNVPUBX  DS    0H                                                               
*                                                                               
*              FIND PRODUCT IN BUFFER                                           
*                                                                               
         CLC   =C'ALL',PBQPRD      SKIP IF                                      
         BE    *+10                                                             
         CLC   PBQPRD,BLANKS         MULTIPLE PRODUCTS REQUESTED                
         BNH   RNVDLPR0                                                         
*                                                                               
         CLC   PNVDPRD,BLANKS      SKIP IF DETAIL PRODUCT NOT PRESENT           
         BNH   RNVDLPRX                                                         
*                                                                               
         CLC   PNVDPRD,PBQPRD      DETAIL PRODUCT MUST MATCH REQUEST            
         BNE   RNVDTLCN                                                         
*                                                                               
RNVDLPR0 DS    0H                                                               
*                                                                               
         CLC   PNVDPRD,BLANKS      IF DETAIL PRODUCT EXISTS                     
         BNH   RNVDLPRX                                                         
*                                                                               
         MVC   PBPROD,PNVDPRD         SET FOR CORRECTED PRODUCT                 
         CLC   PBQPRD,PNVDPRD      DOES PRODUCT MATCH REQUESTED PRD?            
         BE    RNVDLPRX            YES - SKIP GETPRD CALL                       
*                                                                               
         GOTOR GETPRD                 FIND PRODUCT IN BUFFER                    
         BNE   RNVDTLCN            IF NOT THERE IT'S BEEN FILTERED OUT          
*                                                                               
RNVDLPRX DS    0H                                                               
*                                                                               
*              FIND CORRECT ESTIMATE                                            
*                                                                               
         XC    ESTDATA,ESTDATA     INIT ESTIMATE DATA                           
         LA    R8,ESTDATA          ESTABLISH DUMMY EST BUFFER ENTRY             
         USING ESTBUFFD,R8                                                      
*                                                                               
         MVC   EBFMED,PNVKMED-PNVKEY+RNVHDR   SET MEDIA                         
         MVC   EBFCLT,PNVDCLT      SET CLIENT                                   
         MVC   EBFPRD,PBPROD       SET PRODUCT                                  
*                                                                               
         MVC   EBFEST,PNVDEST      DEFAULT TO MATCHED ESTIMATE                  
*                                                                               
         OC    EBFEST,EBFEST       SKIP IF NO MATCHED ESTIMATE                  
         BZ    RNVEST10                                                         
*                                                                               
         BAS   RE,FLTREST          FILTER ON ESTIMATE AND PUT IN TABLE          
         BNE   RNVDTLCN               NOT ACCEPTED                              
         GOTOR GETPUBN,HALF        RESTORE PUB RECORD IN CORE!                  
*                                                                               
RNVEST10 DS    0H                                                               
*                                                                               
         LA    R6,RNVDTL                                                        
*                                                                               
         TM    PBQMATS2,PBQNMTYQ   IF FILTERING ON MATCHED DETAILS              
         BNO   *+14                                                             
         OC    PNVDSER#,PNVDSER#      SKIP IF NO MATCHING BUY                   
         BZ    RNVDTLCN                                                         
*                                                                               
         ST    R6,PBIDTELA         PASS A(INVOICE DETAIL ELEMENT)               
*                                                                               
         MVI   RNVHDRSW,0          HEADER HAS DETAIL FOR PERIOD                 
*                                                                               
*        FIND COMMENT ELEMENTS FOR THIS DETAIL                                  
*                                                                               
         XC    RNVDTLCM,RNVDTLCM   INIT COMMENT AREAS                           
         XC    PBICMELA,PBICMELA                                                
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINSEQ',MINBLKD) READ FOR NEXT ELM               
*                                                                               
         CLI   MINERR,0            SKIP IF ERRORS                               
         BNE   RNVDC1DN                                                         
*                                                                               
         L     R6,MINELEM          POINT TO FOUND ELEMENT                       
         USING PNVCOMD,R6          ESTABLISH COMMENT ELEMENT                    
*                                                                               
         CLI   PNVCKCDE,PNVCKDTQ   DONE IF NOT A DETAIL ELEMENT                 
         BNE   RNVDC1DN                                                         
*                                                                               
         CLC   PNVCKDSQ,PNVDKSQN-PNVDKEY+RNVDTL   MATCH SQN                     
         BNE   RNVDC1DN            DONE ON CHANGE OF DETAIL                     
*                                                                               
         CLI   PBQTRACE,C'Y'       IF TRACING                                   
         BNE   PNVT3                                                            
*                                                                               
         GOTOR INVTRACE,PARM,(R6)                                               
*                                                                               
PNVT3    DS    0H                                                               
*                                                                               
*        BUILD A DUMMY ELEMENT THAT STARTS WITH 1ST HEADER COMMENT              
*        COMMENT PORTION OF OTHER HEADER ELEMENTS                               
*        IS ADDED TO END OF DUMMY ELEMENT UNTIL MAX 255 LENGTH                  
*                                                                               
RNVDC1LP DS    0H                                                               
*                                                                               
         CLI   PNVCKTYP,PNVCKCMQ   SKIP IF NOT A GENERAL COMMENT                
         BE    *+8                                                              
         CLI   PNVCKTYP,PNVCKPBQ   AND     NOT A DIALOGUE COMMENT               
         BNE   RNVDC1CN                                                         
*                                                                               
         LA    R2,RNVDTLCM                                                      
         ST    R2,PBICMELA         SAVE A(COMMENT SAVEAREA)                     
*                                                                               
         MVC   0(PNVCOMLQ,R2),PNVCOMD  SAVE HEADER PORTION                      
         LA    R2,PNVCOMLQ(R2)     POINT TO COMMENT SAVEAREA                    
*                                                                               
         LHI   R0,PNVCOMLQ         LENGTH ACCUMULATOR                           
*                                                                               
RNVDC2LP DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,PNVCKLEN       ELEMENT LENGTH                               
         SHI   RF,PNVCOMLQ         ADJUST FOR HEADER AREA                       
         BZ    RNVDC2CN            NO COMMENT                                   
*                                                                               
         AR    R0,RF               NEW TOTAL ELEMENT LENGTH                     
         CHI   R0,254              CANNOT EXCEDE 255                            
         BL    RNVDC210                                                         
*                                                                               
         LR    RE,R0               COPY PROPSED NEW LENGTH                      
         SHI   RE,254              DEFAULT TO MAX LENGTH                        
         SR    RF,RE               MAX LENGTH TO BE ADDED TO ELEMENT            
         BNP   RNVDC2CN            NO ROOM LEFT IN ELEMENT                      
*                                                                               
RNVDC210 DS    0H                                                               
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PNVCCOM     SAVE COMMENT ELEMENT                         
*                                                                               
         LA    R2,0(RF,R2)         POINT TO LAST OF COMMENT                     
         CLI   0(R2),C' '          IF NOT A SPACE                               
         BNH   *+12                                                             
         MVI   0(R2),C' '             ADD A SPACE TO THE END                    
         LA    R2,1(R2)               ADJUST POINTER                            
*                                                                               
         LA    R2,1(R2)            BUMP TO NEXT AVAILABLE SAVE AREA             
*                                                                               
         LA    RE,RNVDTLCM         RE-CALCULATE ELEMENT LENGTH                  
         LR    R0,R2                                                            
         SR    R0,RE                                                            
*                                                                               
RNVDC2CN DS    0H                                                               
*                                                                               
         MVC   MINEKEY+1(L'PNVKELMK-1),2(R6)     CURRENT ELMENT KEY             
         GOTO1 PBVMINIO,PARM,('MINSEQ',MINBLKD)  READ NEXT ELEMENT              
*                                                                               
         CLI   MINERR,0            DONE ON ERROR                                
         BNE   RNVDC2DN                                                         
*                                                                               
         L     R6,MINELEM          POINT TO FOUND ELEMENT                       
*                                                                               
         CLI   PBQTRACE,C'Y'       IF TRACING                                   
         BNE   PNVT2B                                                           
*                                                                               
         GOTOR INVTRACE,PARM,(R6)                                               
*                                                                               
PNVT2B   DS    0H                                                               
*                                                                               
*        CONTINUE IF SAME COMMENT GROUP                                         
*                                                                               
         CLC   PNVCKCDE,PNVCKCDE-PNVCOMD+RNVDTLCM   ELM CODE                    
         BNE   RNVDC2C1                                                         
*                                                                               
         CLC   PNVCKDSQ,PNVCKDSQ-PNVCOMD+RNVDTLCM   DTL SQN                     
         BNE   RNVDC2C1                                                         
*                                                                               
         CLC   PNVCKTYP,PNVCKTYP-PNVCOMD+RNVDTLCM   COMMENT TYPE                
         BNE   RNVDC2C1                                                         
*                                                                               
         CLC   PNVCKCGP,PNVCKCGP-PNVCOMD+RNVDTLCM   GROUP NUMBER                
         BNE   RNVDC2C1                                                         
*                                                                               
         B     RNVDC2LP            CONTINUE                                     
*                                                                               
RNVDC2C1 DS    0H                                                               
*                                                                               
*        NEW COMMENT GROUP - REPLACES ONE JUST BUILT                            
*                                                                               
         B     RNVDC1LP            TREAT AS NEWER COMMENT                       
*                                                                               
RNVDC2DN DS    0H                                                               
*                                                                               
RNVDC1CN DS    0H                                                               
*                                                                               
RNVDC1DN DS    0H                                                               
*                                                                               
         OC    RNVDTLCM,RNVDTLCM   SKIP IF NO COMMENTS                          
         BZ    RNVDCMD1                                                         
*                                                                               
         LA    RF,RNVDTLCM         POINT TO START OF SAVEAREA                   
         SR    R2,RF               LENGTH OF COMMENT ELEMENT                    
         STC   R2,RNVDTLCM+1       SET NEW COMMENT LENGTH                       
*                                                                               
RNVDCMD1 DS    0H                                                               
*                                                                               
         BRAS  RE,GO                  GO TO DRNVER FOR DETAIL ONLY              
*                                                                               
RNVDTLCN DS    0H                                                               
*                                                                               
*        READ NEXT DETAIL ELEMENT                                               
*                                                                               
         XC    MINEKEY,MINEKEY     INIT MINIO ELEMENT KEY                       
*                                                                               
         MVI   MINEKEY,PNVDKIDQ    SET TO READ DETAIL ELEMENTS                  
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,PNVDKSQN-PNVDKEY+RNVDTL                                     
         AHI   RF,1                BUMP CURRENT DETAIL SQN                      
         STCM  RF,3,MINEKEY+1                                                   
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINHI',MINBLKD)  READ NEXT DETAIL ELM            
*                                                                               
         B     RNVDTLLP                                                         
*                                                                               
RNVDTLSQ DS    0H                                                               
*                                                                               
         MVC   MINEKEY+1(L'PNVKELMK-1),2(R6)     CURRENT ELEMENT KEY            
         GOTO1 PBVMINIO,PARM,('MINSEQ',MINBLKD)  READ NEXT ELEMENT              
*                                                                               
         B     RNVDTLLP                                                         
*                                                                               
         GOTO1 PBVMINIO,PARM,('MINSEQ',MINBLKD) READ NEXT DETAIL ELM            
*                                                                               
         CLI   MINERR,0                                                         
         BE    RNVDTLLP            DETAIL FOUND                                 
*                                                                               
RNVDTLDN DS    0H                                                               
*                                                                               
****     CLI   RNVHDRSW,C'Y'       IF HEADER HASN'T BEEN TO DRNVER              
****     BNE   *+8                                                              
****     BRAS  RE,GO                  GO TO DRNVER FOR HEADER ONLY              
*                                                                               
         MVI   RNVHDRSW,0          TURN OFF HEADER SWITCH                       
*                                                                               
RNVCLTCN DS    0H                                                               
*                                                                               
         XC    PBIKYELA,PBIKYELA   CLEAR A(KEY)                                 
         XC    PBIHDELA,PBIHDELA   CLEAR A(HEADER)                              
         XC    PBIDTELA,PBIDTELA   CLEAR A(DETAIL)                              
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ LAST INVOICE POINTER                    
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT INVOICE POINTER                    
*                                                                               
         B     RNVCLTLP                                                         
*                                                                               
RNVCLTDN DS    0H                                                               
*                                                                               
RNVZEDCN DS    0H                                                               
*                                                                               
*        IF ADVERTISER REPORT FOR SINGLE PUB AND ALL EDITIONS                   
*           DO NEXT PUB/ZONE/EDITION                                            
*                                                                               
         OC    PBQPUB,PBQPUB       IF SINGLE PUB REPORT                         
         BZ    RNVZEDDN                                                         
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   RNVZEDDN                                                         
         CLI   PBQALLZN,C'Y'       IF ALL ZONES AND EDITIONS                    
         BNE   RNVZEDDN                                                         
*                                                                               
         B     RNVZEDLP                                                         
*                                                                               
RNVZEDDN DS    0H                                                               
*                                                                               
RNVPBLCN DS    0H                                                               
*                                                                               
*        FIND NEXT PUB FOR PUBLISHER IF REQUESTED                               
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   IF PUB GROUP PROCESSING                      
         BNZ   RNVPBLLP               GO GET NEXT PUB IN GROUP                  
*                                                                               
         OC    PBQLISCD,PBQLISCD   IF PUB LIST  PROCESSING                      
         BNZ   RNVPBLLP               GO GET NEXT PUB IN LIST                   
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   CONTINUE IF PUBLISHER FILTER GIVEN           
         BNZ   RNVPBLLP                                                         
*                                                                               
RNVPBLDN DS    0H                                                               
*                                                                               
         MVC   PBMODE,RNVSVMOD     RESTORE CURRENT MODE                         
*                                                                               
READPNVX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
RNVMINSW DC    C' '                C'I'  - MINIO BLOCK INITIALIZED              
RNVHDRSW DC    C' '                C'Y'  - HDR HASN'T BEEN TO DRIVER            
RNVDTLSW DC    X'00'               X'01' - DTL HASN'T BEEN TO DRIVER            
RNVSVMOD DS    XL1                 PROCESSING MODE SAVEAREA                     
RNVADDDT DS    XL3                 INVOICE ADDED DATE                           
RNVADPID DS    XL2                 INVOICE ADDER PID                            
*                                                                               
         DS    0D                                                               
RNVHDR   DS    XL256               INVOICE HEADER SAVEAREA                      
RNVDTL   DS    XL256               INVOICE DETAIL SAVEAREA                      
RNVHDRCM DS    XL256               INVOICE HEADER COMMENT SAVEAREA              
RNVDTLCM DS    XL256               INVOICE DETAIL COMMENT SAVEAREA              
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO -  TRACE DMGR CALLS TO INV -INVTRACE'         
***********************************************************************         
*                                                                     *         
*        TRACE DMGR CALLS FOR INVOICE MINIO RECORDS                   *         
*                                                                     *         
*NTRY    PARM1 A(ELEMENT TO TRACE)                                    *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
INVTRACE NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
*                                                                               
         LR    R2,R1               SAVE PARAMETER LIST POINTER                  
         L     R3,0(R2)            ELEMENT TO PRINT                             
*                                                                               
         XC    P,P                                                              
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CHEXOUT-COMFACSD(RF)    HEXOUT ADDRESS                        
         GOTO1 (RF),PARM,(R3),P+20,54,=C'TOG'                                   
*                                                                               
         GOTO1 PBPRINT,PARM,PASA,=C'BL01'                                       
*                                                                               
         SP    INVTCTR,=P'1'       DECREMENT TRACE COUNTER                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
INVTRACX XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
INVTCTR  DC    PL8'1000'            MAX NUMBER OF ELEMENTS TRACED               
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - INITIALIZE MINIO BLOCK - RNVINIT'           
***********************************************************************         
*                                                                     *         
*        INITIALIZE MINIO CONTROL BLOCK                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
RNVINIT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC                                                      
*                                                                               
         LA    R5,RNVBLKCB         ESTABLISH MINIO BLOCK                        
         USING MINBLKD,R5                                                       
*                                                                               
         LA    R0,RNVBLKCB         CLEAR MINBLOCK                               
         LA    R1,MINBLKL                                                       
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     R4,PBCOMFAC         POINT TO COMFACS                             
         USING COMFACSD,R4                                                      
         MVC   MINRECUP,CRECUP     A(RECUP)                                     
*                                                                               
         DROP  R4                                                               
*                                                                               
         MVC   MINCOMF,PBCOMFAC    A(COMFACS)                                   
         MVI   MINOPEN,C'N'        SET NOT OPEN                                 
         MVC   MINFIL,=CL8'PRTFILE' FILE NAME                                   
         MVC   MINDIR,=CL8'PRTDIR' DIR NAME                                     
         MVI   MINFKLEN,L'PNVKEY   KEY LENGTH                                   
         MVI   MINEKLEN,L'PNVKELMK   ELEMENT KEY LENGTH                         
         MVI   MINEKDSP,PNVKELMK-PNVKEY  DISP TO ELM KEY                        
         MVI   MINNCTL,2           NUMBER OF CONTROL BYTES                      
         MVC   MINFRCLM,=AL2(4096) MAXIMUM RECORD LENGTH                        
         MVC   MINBUFF,=A(RNVIOS)  A(FIRST BUFFER)                              
         MVI   MINNBUF,2           USE TWO BUFFERS                              
         MVC   MINRTAB,=A(RNVRTABC)   A(AREA FOR RECORD TABLE)                  
         MVC   MINRTABL,=Y(L'RNVRTABC) LENGTH OF RECORD TABLE                   
*                                                                               
         LA    RE,RNVELM           A(AREA FOR ELEM OR CLUSTER)                  
         ST    RE,MINELEM                                                       
         MVC   MINMAXEL,=Y(L'RNVELM)  MAX LENGTH OF ELEM OF CLUSTER             
         XC    RNVELM,RNVELM         CLEAR MINELEM AREA                         
*                                                                               
RNVINITX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - MINIO WORKAREAS - RNVMINWK'                 
******************************************************************              
*                                                                     *         
*        WORKAREA MINIO CONTROL BLOCK                                 *         
*                                                                     *         
******************************************************************              
         SPACE 2                                                                
RNVMINWK DS    0D                  ALIGNMENT                                    
         DC    C'MINBLKCB'         DUMP ID                                      
RNVELM   DS    XL256               ELEMENT WORKAREA                             
RNVBLKCB DS    XL(MINBLKL)         MINIO CONTROL BLOCK                          
         DS    0D                                                               
RNVRTABC DS    XL(20*(L'PNVKELMK+6))   RECORD TABLE                             
         DS    0D                                                               
RNVIOS   DS    XL8192              MINIO I/OAREAS                               
*                                                                               
         DROP                                                                   
         TITLE  'T00A4C - PRWRIIO - READ SUBORDINATE RECORDS - READREC'         
***********************************************************************         
*                                                                     *         
*        READ SUBORDINATE RECORDS                                     *         
*              USES ITS OWN IO AREA SO PRIME RECORDS ARE              *         
*              UNDISTURBED                                            *         
*                                                                     *         
*NTRY    PARM1        CONTAINS RECORD TO READ ID                      *         
*               1     READ OANREC                                     *         
*                                                                     *         
*                                                                     *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
READREC  NMOD1 300,AOREC                                                        
*                                                                               
         LR    RA,RC               SAVE WORKING STORAGE POINTER                 
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         MVC   8(L'IOKEY,RA),IOKEY SAVE CURRENT KEY                             
*                                                                               
         ST    R1,0(RA)            SAVE PARAMETER POINTER                       
*                                                                               
         L     R1,0(R1)            GET RECORD IDENTIFIER                        
         SLL   R1,2                MULT BY 4                                    
*                                                                               
         B     *+4(R1)             GO TO APPROPRIATE READ ROUTINE               
*                                                                               
         DC    XL4'00'             MUST HAVE A VALUE                            
         B     RDROAN              X'01' PASSED // READ OAN RECORD              
         DC    XL4'00'             INVALID CODE                                 
*                                                                               
RDROAN   DS    0H                                                               
*                                                                               
         XC    PBOANAME,PBOANAME   INIT OTHER AGENCY NAME                       
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            ESTABLISH KEYAREA AS                         
         USING POTHRECD,R2           OTHER AGENCY RECORD KEY                    
*                                                                               
         MVC   POTHKAGY,PBAGY      SET AGENCY                                   
         MVC   POTHKMED,PBMED      SET MEDIA                                    
*                                                                               
         CLI   PBOANCOD,0          IF NO OTHER AGENCY CODE IN PRODUCT           
         BNE   RDROAN10               DEFAULT TO THIS AGENCY                    
*                                                                               
         MVI   POTHKRCD,1             SET TO READ AGENCY RECORD                 
         B     RDROAN20                                                         
*                                                                               
RDROAN10 DS    0H                                                               
*                                                                               
         MVI   POTHKRCD,POTHKIDQ   SET OTHER AGY REC ID                         
         MVC   POTHCODE,PBOANCOD   SET OTHER AGENCY CODE                        
*                                                                               
RDROAN20 DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ POINTER                                 
*                                                                               
         CLC   POTHKEY,IOKEYSAV    MUST FIND RECORD                             
         BNE   RDREND                                                           
*                                                                               
         MVC   4(4,RA),AIO3      SAVE ADDRESS OF IO3                            
*                                                                               
         LA    R2,80(RA)         REPLACE WITH WORKAREA ADDRESS                  
         ST    R2,AIO3                                                          
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3  READ RECORD                              
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         CLI   POTHKRCD,PAGYKIDQ   IF WE READ AN AGENCY RECORDDUCT              
         BNE   RDROAN30        DEFAULT TO THIS AGENCY                           
*                                                                               
         USING PAGYRECD,R2         ESTABLISH AS AGENCY RECORD                   
*                                                                               
         MVC   PBOANAME,PAGYNAME   SAVE NAME                                    
         MVC   PBOANCOD,PAGYKAGY   USE ITS POWERCODE FOR OAN                    
         B     RDROANX                                                          
*                                                                               
RDROAN30 DS    0H                                                               
         USING POTHRECD,R2         ESTABLISH AS OTHER AGENCY RECORD             
*                                                                               
         MVC   PBOANAME,POTHNAME   SAVE AGENCY NAME                             
         MVC   PBOANAME+32(2),PBOANCOD    SAVE POWER CODE                       
*                                                                               
RDROANX  DS    0H                                                               
*                                                                               
         MVC   AIO3,4(RA)        RESTORE POINTER                                
*                                                                               
RDREND   DS    0H                                                               
*                                                                               
         MVC   IOKEY,8(RA)       RESTORE CURRENT KEY                            
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL   RE-POINT TO CURRENT PTR               
*                                                                               
READRECX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - BUILD CONTRACT TABLE - BLDCON'              
***********************************************************************         
*                                                                     *         
*        BUILD TABLE OF CONTRACTS                                     *         
*                                                                     *         
*                                                                     *         
*EXIT PBACONTB ==>  CONTRACT TABLE                                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
BLDCON   NMOD1 0,**+BCN**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9         R9 = A(COMMON SUBROUTINES)                   
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   BLDCON1                                                          
*                                                                               
         L     R8,PBACONTB            POINT TO CONTRACT TABLE                   
         USING CONTTABL,R8            ESTABLISH ENTRY IN TABLE                  
*                                                                               
         OC    CONTTABL(CONTNLEN),CONTTABL  IF FIRST ENTRY PRESENT              
         BNZ   BLDCONX                         EXIT - TABLE BUILT               
*                                                                               
BLDCON1  DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY AREA                                
         LA    R2,IOKEY            ESTABLISH KEY AREA AS CONTRACT KEY           
         USING PCONRECD,R2                                                      
*                                                                               
         MVC   PCONKAGY,PBAGY      AGENCY                                       
         MVC   PCONKMED,PBMED      MEDIA                                        
         MVI   PCONKRCD,PCONKIDQ   RECORD ID                                    
         MVC   PCONKCLT,PBCLT      CLIENT                                       
*                                                                               
*        CONTRACTS ARE ALWAYS CARRIED UNDER THE MASTER CLIENT                   
*            OF A GROUP OF CLIENTS                                              
*                                                                               
         CLI   PBCPROF+5,C'2'       IS THIS A SLAVE                             
         BNE   *+10                                                             
         MVC   PCONKCLT,PBCPROF+6  USE THIS SLAVE'S MASTER CLIENT CODE          
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF ADVERTISER CLIENT REPORT               
         BNE   BCNADVX                                                          
*                                                                               
         MVC   PCONKAGY,PAORAGY       USE AOR AGENCY CODE                       
         MVC   PCONKCLT,PAORQADV      USE AOR ADV CLIENT CODE                   
         L     RF,PBUTLA              POINT TO UTL                              
         MVC   4(1,RF),PAORSE         SET FOR AOR FILES                         
*                                                                               
BCNADVX  DS    0H                                                               
*                                                                               
*        FILL IN PUB ID IF KNOWN                                                
*                                                                               
BCNPUB   DS    0H                                                               
*                                                                               
         OC    PBQPUB,PBQPUB       SKIP IF DOING ALL PUBS                       
         BZ    BCNPUBX                                                          
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   SKIP IF PUB GROUP PROCESSING                 
         BNZ   BCNPUBX                                                          
*                                                                               
         OC    PBQLISCD,PBQLISCD   SKIP IF PUB LIST  PROCESSING                 
         BNZ   BCNPUBX                                                          
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   SKIP IF FILTERING ON A PUBLISHER             
         BNZ   BCNPUBX             PBQPUB -- PBLSH=3                            
*                                                                               
*        NOTE FOR ADVERTISER REPORTS ALL PUB IDS IN REQUEST PARMS               
*        MUST BE FOR AOR AGENCY AND NEED NOT BE TRANSLATED                      
*        SINCE CONTRACTS ARE ON AOR'S FILES                                     
*                                                                               
         MVC   PCONKPUB,PBQPUB     MOVE REQUESTED PUB IN KEY                    
*                                                                               
         CLI   PBQCLTSW,C'Y'       IF ADVERTISER CLIENT REPORT                  
         BNE   BCNPUB10                                                         
*                                                                               
         GOTO1 GTAORPUB,PARM,PBQPUB     FIND AOR PUB ID                         
         MVC   PCONKPUB,PAORPUB    USE AOR'S PUB NUMBER                         
*                                                                               
BCNPUB10 DS    0H                                                               
*                                                                               
         CLI   PBQALLZN,C'Y'       SKIP IF DOING ALL ZONES + EDTS               
         BE    *+10                                                             
         MVC   PCONKZON(2),PBQZON  ELSE MOVE ZONE AND EDITION                   
*                                                                               
BCNPUBX  DS    0H                                                               
*                                                                               
*        SEARCH FILES FOR CONTRACTS                                             
*                                                                               
BCNCON   DS    0H                                                               
*                                                                               
         L     R8,PBACONTB         POINT TO CONTRACT TABLE BUILD AREA           
         USING CONTTABL,R8         ESTABLISH ENTRY IN TABLE                     
*                                                                               
         XC    CONTTABL(CONTNLEN),CONTTABL  INIT FIRST ENTRY                    
*                                                                               
         LA    R3,1500             MAX NUMBER OF CONTRACTS                      
*                                                                               
         XC    PBQCONDA,PBQCONDA   INIT CONTRACT DISK ADDRESS                   
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST CONTRACT POINTER                  
*                                                                               
BCNCONLP DS    0H                                                               
*                                                                               
         CLC   IOKEY(PCONKPUB-PCONKEY),IOKEYSAV MUST MATCH                      
         BNE   BCNCONDN              AGY-MED-CLT                                
*                                                                               
         OC    PBQPUB,PBQPUB      GET RECORD IF ALL PUBS REQUESTED              
         BZ    BCNCONRD                                                         
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   GET RECORD IF PUB GROUP PROCESSING           
         BNZ   BCNCONRD                                                         
*                                                                               
         OC    PBQLISCD,PBQLISCD   GET RECORD IF PUB LIS   PROCESSING           
         BNZ   BCNCONRD                                                         
*                                                                               
         OC    PBQPBLSH,PBQPBLSH  GET RECORD IF SPECIFIC PUBLISHER IN           
         BNZ   BCNCONRD           PBQPUB -- PBLSH=3                             
*                                                                               
         CLI   PBQCLTSW,C'Y'       IF ADVERTISER CLIENT                         
         BNE   BCNCON10                                                         
*                                                                               
         CLC   PCONKPUB,PAORPUB       MATCH TO AOR PUB                          
         BNE   BCNCONDN                                                         
         B     BCNCON20                                                         
*                                                                               
BCNCON10 DS    0H                                                               
*                                                                               
         CLC   PCONKPUB,PBQPUB     ELSE MUST MATCH REQUESTED PUB                
         BNE   BCNCONDN                                                         
*                                                                               
BCNCON20 DS    0H                                                               
*                                                                               
         CLI   PBQALLZN,C'Y'      ACCEPT IF ALL ZONES AND EDITON                
         BE    BCNCONRD                                                         
*                                                                               
         CLC   PCONKZON(2),PBQZON    ELSE MUST MATCH EDITION AND ZONE           
         BNE   BCNCONDN                                                         
*                                                                               
BCNCONRD DS    0H                                                               
*                                                                               
         MVC   PBQCONDA,IOKEY+27  SAVE CONTRACT DISK ADDRESS                    
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO2  READ CONTRACT RECORD                     
         BE    *+6                                                              
         DC    H'0'                  NO ERRORS TOLERATED                        
*                                                                               
*        CONTRACT MUST FALL ON OR WITHIN REQUEST DATES                          
*                                                                               
         L     R2,AIO2             POINT TO FOUND CONTRACT                      
         USING PCONRECD,R2         ESTABLISH CONTRACT RECORD                    
*                                                                               
         CLC   PCONEDT,PBQBST     CONTRACT ENDS BEFORE REQUEST START            
         BL    BCNCONCN                                                         
*                                                                               
         CLC   PCONSDT,PBQBEND    CONTRACT STARTS AFTER REQUEST PERIOD          
         BH    BCNCONCN                                                         
*                                                                               
*        GOOD CONTRACT - ADD IT TO TABLE                                        
*                                                                               
BCNTAB   DS    0H                                                               
*                                                                               
         USING CONTTABL,R8         ESTABLISH CONTRACT TABLE ENTRY               
*                                                                               
         MVC   CONTNPUB,PCONKPUB   SAVE PUB NUMBER                              
         MVC   CONTNZO,PCONKZON    PUBSAVE ZONE                                 
         MVC   CONTNED,PCONKEDT    SAVE EDITION                                 
         MVC   CONTNST,PCONSDT     CONTRACT START DATE                          
         MVC   CONTNEN,PCONEND     CONTRACT END   DATE                          
         MVC   CONTNADD,IOKEY+27           DISK ADDRESS                         
*                                                                               
         LA    R8,CONTNLEN(R8)     BUMP TO NEXT TABLE ENTRY                     
         XC    0(CONTNLEN,R8),0(R8)  INITIALIZE ENTRY                           
*                                                                               
         BCT   R3,*+6              DECREMENT ENTRY COUNTER                      
         DC    H'0'                ENLARGE TABLE                                
*                                                                               
BCNCONCN DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT POINTER ON DIRECTORY               
*                                                                               
         B     BCNCONLP                                                         
*                                                                               
BCNCONDN DS    0H                  END OF CONTRACTS                             
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF ADVERTISER CLIENT REPORT               
         BNE   *+14                                                             
         L     RF,PBUTLA              POINT TO UTL                              
         MVC   4(1,RF),PAOSE          RESET TO CLIENT'S FILES                   
*                                                                               
BLDCONX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - BUILD DRD TABLE - BLDDRD'                   
***********************************************************************         
*                                                                     *         
*        BUILD TABLE OF DIVISION/REGION/DISTRICT CODES AND NAMES      *         
*                                                                     *         
*        FOR ADVERTISER REPORTS ALL DRDS ARE THOSE ON AOR FILE        *         
*                                                                     *         
*EXIT PBADRDBF ==>  DRD TABLE                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
BLDDRD   NMOD1 0,**+BDR**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9         R9 = A(COMMON SUBROUTINES)                   
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         ICM   R4,15,PBADRDBF      POINT TO DRD BUFFER                          
         BNZ   *+10                                                             
         LTR   RB,RB                 SET NEQ CC                                 
         B     BLDDRDX               EXIT IF NO SPACE ASSIGNED                  
*                                                                               
         USING DRDBUFFD,R4         ESTABLISH BUFFER ENTRY                       
*                                                                               
         XC    0(DRDLEN,R4),0(R4)  INIT FIRST ENTRY                             
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAORSE         SET TO AOR FILES                          
*                                                                               
         L     R5,PBLDRDBF         GET LENGTH OF BUFFER                         
*                                                                               
*        READ DIVISION RECORDS                                                  
*                                                                               
BDRDIV   DS    0H                                                               
*                                                                               
         LA    R2,IOKEY           ESTABLISH KEYAREA AS DIVISION RECORD          
         USING PDIVRECD,R2                                                      
*                                                                               
         XC    PDIVKEY,PDIVKEY     INIT DIVISION KEY                            
*                                                                               
         MVC   PDIVKAGY,PBAGY      SET AGENCY                                   
         MVC   PDIVKMED,PBMED      SET MEDIA                                    
         MVI   PDIVKRCD,PDIVKIDQ   SET RECORD ID                                
         MVC   PDIVKCLT,PBCLT      SET CLIENT                                   
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   *+16                                                             
         MVC   PDIVKAGY,PAORAGY       USE AOR AGENCY CODE                       
         MVC   PDIVKCLT,PAORQADV      USE AOR CLIENT CODE                       
*                                                                               
         CLC   PBQDIV,=C'ALL'      SKIP IF ALL DIV REQUEST                      
         BE    *+10                                                             
         MVC   PDIVKDIV,PBQDIV        ELSE FILTER ON REQUESTED DIV              
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   IF USING ANOTHER CLIENT'S DRD                
         BZ    *+16                   SCHEME USE THAT CLIENT CODE               
         MVC   PDIVKCLT,PBQDRDCL                                                
         MVC   PDIVKDIV,=C'000'       AND DIVISION CODE 000                     
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST POINTER                           
*                                                                               
BDRDIVLP DS    0H                                                               
*                                                                               
         CLC   PDIVKEY(PDIVKDIV-PDIVKEY),IOKEYSAV  END OF DIV IF                
         BNE   BDRDIVDN              AGY/MED/TYP/CLT CHANGE                     
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   IF USING ANOTHER CLIENT'S DRD                
         BZ    *+18                   SCHEME                                    
         CLC   PDIVKDIV,=C'000'       MUST BE DIVISION 000                      
         BNE   BDRDIVDN                                                         
         B     BDRDIV10                                                         
*                                                                               
         CLC   PBQDIV,=C'ALL'      SKIP IF ALL DIV REQUEST                      
         BE    *+14                                                             
         CLC   PDIVKDIV,PBQDIV     ELSE MUST MATCH REQUESTED DIV                
         BNE   BDRDIVDN                                                         
*                                                                               
BDRDIV10 DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1  READ RECORD                              
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
*                                                                               
*        FILL IN BUFFER ENTRY                                                   
*                                                                               
         MVC   DRDDIV,PDIVKDIV     MOVE DIV CODE                                
         XC    DRDRGN,DRDRGN          NO REGION                                 
         XC    DRDDST,DRDDST           OR DISTRICT                              
         MVC   DRDNAME,PDIVNAME    SAVE DIVISION NAME                           
*                                                                               
         SH    R5,=Y(DRDLEN)    ANY ROOM LEFT IN TABLE                          
         BP    *+6                                                              
         DC    H'0'                NEED TO EXPAND DRD BUFFER                    
*                                                                               
         LA    R4,DRDLEN(R4)       BUMP TO NEXT TABLE ENTRY                     
         XC    0(DRDLEN,R4),0(R4)      AND INIT                                 
*                                                                               
BDRDIVCN DS    0H                                                               
*                                                                               
         LA    R2,IOKEY            RE-ESTABLISH KEY POINTER                     
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   SKIP IF USING ANOTHER CLIENT'S DRD           
         BNZ   BDRDIVDN               SCHEME                                    
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ     SEQL READ TO NEXT                          
         B     BDRDIVLP                                                         
*                                                                               
BDRDIVDN DS    0H                                                               
*                                                                               
         CLM   R4,15,PBADRDBF      CHECKS FOR NO ENTRIES IN TABLE               
         BNH   BDRCLTDN              NO DIVISIONS - GET OUT                     
*                                                                               
BDRDIVX  DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*        READ REGION RECORDS                                                    
*                                                                               
BDRRGN   DS    0H                                                               
*                                                                               
         MVC   DRDRGN,=X'000001'   SERVE AS A TEMP EOT FOR DIVISION             
*                                  RECORDS WHEN A REGION IS FOUND               
*                                  IT WILL OVERLAY THIS EOT RECORD              
*                                                                               
         LA    R2,IOKEY            ESTABLISH KEY AS REGION REC KEY              
         USING PREGRECD,R2                                                      
*                                                                               
         XC    PREGKEY,PREGKEY     INIT REGION KEY                              
*                                                                               
         MVC   PREGKAGY,PBAGY      SET AGENCY                                   
         MVC   PREGKMED,PBMED      SET MEDIA                                    
         MVI   PREGKRCD,PREGKIDQ   SET RECORD ID                                
         MVC   PREGKCLT,PBCLT      SET CLIENT                                   
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   *+16                                                             
         MVC   PREGKAGY,PAORAGY       USE AOR AGENCY CODE                       
         MVC   PREGKCLT,PAORQADV      USE AOR CLIENT CODE                       
*                                                                               
         OC    PBQDRDCL,PBQDRDCL       USING ANOTHER CLIENT'S DRD               
         BZ    *+10                     SCHEME                                  
         MVC   PREGKCLT,PBQDRDCL                                                
*                                                                               
*        LOOP THROUGH TABLE LOOKING FOR DIVISIONS                               
*        FOR EACH DIVISION ADD ALL REGIONS IN DIVISION                          
*                                                                               
         L     R3,PBADRDBF                 POINT TO START OF BUFFER             
*                                                                               
         MVC   BDR1STKY,PREGKEY    SAVE SKELETON KEY                            
*                                                                               
BDRRGNDL DS    0H                                                               
*                                                                               
         MVC   PREGKEY,BDR1STKY    RESTORE SKELETON KEY                         
*                                                                               
         MVC   PREGKDIV,(DRDDIV-DRDBUFFD)(R3)  MOVE DIVISION CODE               
*                                                                               
         OC    PBQRGN,PBQRGN       IF NOT AN ALL REGION REQUEST                 
         BZ    *+10                                                             
         CLC   PBQRGN,=C'ALL'                                                   
         BE    *+10                                                             
         MVC   PREGKREG,PBQRGN        SET REQUESTED REGION                      
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST REGION                            
*                                                                               
BDRRGNLP DS    0H                                                               
*                                                                               
         CLC   PREGKEY(PREGKREG-PREGKEY),IOKEYSAV DONE IF NOT SAME              
         BNE   BDRRGNDN              AGY/MED/TYP/CLT/DIV                        
*                                                                               
         OC    PBQRGN,PBQRGN       IF NOT AN ALL REGION REQUEST                 
         BZ    *+10                                                             
         CLC   PBQRGN,=C'ALL'                                                   
         BE    *+10                                                             
         CLC   PBQRGN,PREGKREG        MUST MATCH REQUESTED REGION               
         BNE   BDRRGNDN                                                         
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1   READ RECORD                             
         BE    *+6                                                              
         DC    H'0'                  NO ERRORS TOLERATED                        
*                                                                               
*        ADD REGION TO BUFFER                                                   
*                                                                               
         L     R2,IOADDR           POINT TO FOUND REGION RECORD                 
*                                                                               
         MVC   DRDDIV,PREGKDIV     SET DIVISION                                 
         MVC   DRDRGN,PREGKREG     SET REGION                                   
         XC    DRDDST,DRDDST       CLEAR DISTRICT                               
         MVC   DRDNAME,PREGNAME    SAVE REGION NAME                             
*                                                                               
         SH    R5,=Y(DRDLEN)       DECREMENT ROOM LEFT COUNTER                  
         BP    *+6                                                              
         DC    H'0'                NEED TO EXPAND DRD BUFFER                    
*                                                                               
         LA    R4,DRDLEN(R4)       POINT TO NEXT BUFFER ENTRY                   
         XC    0(DRDLEN,R4),0(R4)  INIT ENTRY                                   
*                                                                               
BDRRGNCN DS    0H                                                               
*                                                                               
         LA    R2,IOKEY            RE-ESTABLISH KEY POINTER                     
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT REGION RECORD                      
*                                                                               
         B     BDRRGNLP                                                         
*                                                                               
BDRRGNDN DS    0H                                                               
*                                                                               
BDRRGNDC DS    0H                                                               
*                                                                               
         LA    R3,DRDLEN(R3)       BUMP TO NEXT DIVISION ENTRY                  
         CR    R3,R4               MAKE SURE NOT PAST END OF TABLE              
         BNL   BDRDSTX               MEANS NO REGIONS FOUND                     
*                                                                               
*        END OF PURE DIVISION ENTRIES REACHED WHEN REGION CODE                  
*          IS NON-NULLS. IE. FIRST REGION ENTRY FOUND.                          
*                                                                               
         OC    DRDRGN-DRDBUFFD(L'DRDRGN,R3),DRDRGN-DRDBUFFD(R3)                 
         BZ    BDRRGNDL            CONTINUE IF MORE DIVISIONS                   
*                                                                               
BDRRGNDD DS    0H                                                               
*                                                                               
BDRRGNX  DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*        READ DISTRICT RECORDS                                                  
*                                                                               
BDRDST   DS    0H                                                               
*                                                                               
         MVC   DRDDST,=X'000001'  MAKE PSUEDO REGION EOT RECORD                 
*                                 WILL BE OVERLAYED BY 1ST DIST REC             
*                                                                               
         LA    R2,IOKEY                                                         
         USING PDSTRECD,R2         ESTABLISH KEYAREA AS DISTRICT REC            
*                                                                               
         XC    PDSTKEY,PDSTKEY    INIT DISTRICT RECORD KEY                      
*                                                                               
         MVC   PDSTKAGY,PBAGY      SET AGENCY                                   
         MVC   PDSTKMED,PBMED      SET MEDIA                                    
         MVI   PDSTKRCD,PDSTKIDQ   SET RECORD ID                                
         MVC   PDSTKCLT,PBCLT      SET CLIENT                                   
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   *+16                                                             
         MVC   PDSTKAGY,PAORAGY       USE AOR AGENCY CODE                       
         MVC   PDSTKCLT,PAORQADV      USE AOR CLIENT CODE                       
*                                                                               
         OC    PBQDRDCL,PBQDRDCL       USING ANOTHER CLIENT'S DRD               
         BZ    *+10                     SCHEME                                  
         MVC   PDSTKCLT,PBQDRDCL                                                
*                                                                               
         MVC   BDR1STKY,PDSTKEY    SAVE SKELETON KEY                            
*                                                                               
BDRDSTRL DS    0H                                                               
*                                                                               
         MVC   PDSTKEY,BDR1STKY    RESTORE SKELETON KEY                         
*                                                                               
         MVC   PDSTKDIV,(DRDDIV-DRDBUFFD)(R3)  SET DIV                          
         MVC   PDSTKREG,(DRDRGN-DRDBUFFD)(R3)  SET RGN                          
*                                                                               
         OC    PBQDST,PBQDST       IF NOT ALL DISTRICT REQUEST                  
         BZ    *+10                                                             
         CLC   PBQDST,=C'ALL'                                                   
         BE    *+10                                                             
         MVC   PDSTKDST,PBQDST        SET REQUESTED DISTRICT                    
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST DISTRICT POINTER                  
*                                                                               
BDRDSTLP DS    0H                                                               
*                                                                               
         CLC   PDSTKEY(PDSTKDST-PDSTKEY),IOKEYSAV DONE IF NOT SAME              
         BNE   BDRDSTDN              AGY/MED/TYP/CLT/DIV/RGN                    
*                                                                               
         OC    PBQDST,PBQDST       IF NOT AN ALL DISTRICT REQUEST               
         BZ    *+10                                                             
         CLC   PBQDST,=C'ALL'                                                   
         BE    *+10                                                             
         CLC   PBQDST,PDSTKDST        MUST MATCH REQUESTED DISTRICT             
         BNE   BDRDSTDN                                                         
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1  READ IN RECORD                           
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
*                                                                               
         MVC   DRDDIV,PDSTKDIV     SET DIVISION                                 
         MVC   DRDRGN,PDSTKREG     SET REGION                                   
         MVC   DRDDST,PDSTKDST     SET DISTRICT                                 
         MVC   DRDNAME,PDSTNAME    SET DISTRICT NAME                            
*                                                                               
         SH    R5,=Y(DRDLEN)       DECREMENT BUFFER SPACE COUNTER               
         BP    *+6                                                              
         DC    H'0'                NEED TO EXPAND DRD BUFFER                    
*                                                                               
         LA    R4,DRDLEN(R4)       BUMP TO NEXT BUFFER ENTRY                    
         XC    0(DRDLEN,R4),0(R4)  INIT ENTRY                                   
*                                                                               
BDRDSTCN DS    0H                                                               
*                                                                               
         LA    R2,IOKEY            RE-ESTABLISH KEY POINTER                     
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT DISTRICT POINTER                   
*                                                                               
         B     BDRDSTLP                                                         
*                                                                               
BDRDSTDN DS    0H                                                               
*                                                                               
BDRDSTRC DS    0H                                                               
*                                                                               
*        END OF PURE REGION ENTRIES REACHED WHEN DISTRICT CODE                  
*          IS NON-NULLS. IE. FIRST DISTRICT ENTRY FOUND.                        
*          ALSO NEED TO CHECK IF FOR END OF TABLE                               
*                                                                               
         LA    R3,DRDLEN(R3)       BUMP TO NEXT REGION ENTRY                    
         CR    R3,R4               MAKE SURE NOT PAST END OF TABLE              
         BNL   BDRDSTRD              MEANS NO DISTRICTS FOUND                   
         OC    DRDDST-DRDBUFFD(L'DRDDST,R3),DRDDST-DRDBUFFD(R3)                 
         BZ    BDRDSTRL                                                         
*                                                                               
BDRDSTRD DS    0H                                                               
*                                                                               
BDRDSTX  DS    0H                                                               
*                                                                               
         XC    0(DRDLEN,R4),0(R4)  CLEARS POSSIBLE PSUEDO EOT ENTRY             
*                                                                               
         EJECT                                                                  
*                                                                               
*        COMPUTE NUMBER OF ENTRIES IN BUFFER AND SORT                           
*                                                                               
         LR    R0,R4               GET CURRENT POINTER                          
         S     R0,PBADRDBF         LESS START OF BUFFER                         
*                                                                               
         SRDA  R0,32                                                            
         LA    RE,DRDLEN                                                        
         DR    R0,RE               DIVIDE BY BUFFER ENTRY LENGTH                
*                                                                               
         ST    R1,PBCDRDBF         SAVE BUFFER COUNT                            
*                                                                               
         LTR   R0,R0               MUST DIVIDE EVENLY                           
         BZ    *+6                                                              
         DC    H'0'                SHOULD BE NO REMAINDER                       
*                                                                               
         LTR   R0,R1               GET COUNT IN R0                              
         BZ    BDRCLTDN            DONE IF NO ENTRIES                           
*                                                                               
*        SORT TABLE                                                             
*                                                                               
         LA    RF,DRDLEN                                                        
         GOTO1 QSORT,PARM,PBADRDBF,(R0),(RF),9,0,RR=RELO                        
*                                                                               
*  IF DRD WAS REQUESTED BY DUMMY CLIENT SCHEME,  THIS TABLE IS CREATED          
*   USING THE DUMMY CLIENT.  DIVISIONS ARE DISPLAYED IN THE ORIGINAL            
*   CLIENT.  DIVISIONS FOR THE ORIGINAL CLIENT ARE SET UP HERE.                 
*   A X'FF' WILL PRECEEDE THESE ENTRIES AND WILL APPEAR AFTER THE               
*   SORTED TABLE                                                                
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   DONE IF NOT USING OTHER CLIENT'S             
         BZ    BDRCLTX               DRD SCHEME                                 
*                                                                               
*        DIVISION RECORDS FOR ORIGINAL CLIENT                                   
*                                                                               
BDRCLT   DS    0H                                                               
*                                                                               
         LA    R2,IOKEY            ESTABLISH KEY AS DIVREC KEY                  
         USING PDIVRECD,R2                                                      
*                                                                               
         XC    PDIVKEY,PDIVKEY     INIT DIVISION KEY                            
*                                                                               
         MVC   PDIVKAGY,PBAGY      SET AGENCY                                   
         MVC   PDIVKMED,PBMED      SET MEDIA                                    
         MVI   PDIVKRCD,PDIVKIDQ   SET RECORD ID                                
         MVC   PDIVKCLT,PBCLT      SET CLIENT                                   
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   *+16                                                             
         MVC   PDIVKAGY,PAORAGY       USE AOR AGENCY CODE                       
         MVC   PDIVKCLT,PAORQADV      USE AOR CLIENT CODE                       
*                                                                               
         CLC   PBQDIV,=C'ALL'      IF NOT ALL DIV REQUEST                       
         BE    *+10                                                             
         MVC   PDIVKDIV,PBQDIV           FILTER ON REQUESTED DIV                
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST POINTER                           
*                                                                               
BDRCLTLP DS    0H                                                               
*                                                                               
         CLC   PDIVKEY(PDIVKDIV-PDIVKEY),IOKEYSAV MUST MATCH ON                 
         BNE   BDRCLTDN            AGY/MED/RCD/CLT                              
*                                                                               
         CLC   PBQDIV,=C'ALL'      IF NOT ALL DIV REQUEST                       
         BE    *+14                                                             
         CLC   PDIVKDIV,PBQDIV        MUST MATCH ON DIVISION                    
         BNE   BDRCLTDN                                                         
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1   READ RECORD                             
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
*                                                                               
         XC    DRDRGN,DRDRGN          NO REGION                                 
         XC    DRDDST,DRDDST           OR DISTRICT                              
         MVC   DRDDIV+1(3),PDIVKDIV   MOVE DIV CODE                             
         MVI   DRDDIV,255          FLAG AS CLIENT DIVISION                      
         MVC   DRDNAME,PDIVNAME    SAVE DIVISION NAME                           
*                                                                               
         SH    R5,=Y(DRDLEN)       DECREMENT BUFFER SPACE COUNTER               
         BP    *+6                                                              
         DC    H'0'                NEED TO EXPAND DRD BUFFER                    
*                                                                               
         LA    R4,DRDLEN(R4)         TO NEXT TABLE ENTRY                        
         XC    0(DRDLEN,R4),0(R4)      AND CLEAR                                
*                                                                               
BDRCLTCN DS    0H                                                               
*                                                                               
         LA    R2,IOKEY            RE-ESTABLISH KEY POINTER                     
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ     SEQL READ TO NEXT                          
*                                                                               
         B     BDRCLTLP                                                         
*                                                                               
BDRCLTDN DS    0H                                                               
*                                                                               
*        RE-COMPUTE NUMBER OF ENTRIES IN BUFFER                                 
*                                                                               
         LR    R0,R4               GET CURRENT POINTER                          
         S     R0,PBADRDBF         LESS START OF BUFFER                         
*                                                                               
         SRDA  R0,32                                                            
         LA    RE,DRDLEN                                                        
         DR    R0,RE               DIVIDE BY BUFFER ENTRY LENGTH                
*                                                                               
         ST    R1,PBCDRDBF         SAVE BUFFER COUNT                            
*                                                                               
         LTR   R0,R0               MUST DIVIDE EVENLY                           
         BZ    *+6                                                              
         DC    H'0'                SHOULD BE NO REMAINDER                       
*                                                                               
BDRCLTX  DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAOSE          RESTORE AOR FILES                         
*                                                                               
         CR    RB,RB               FORCE EQ CC                                  
*                                                                               
BLDDRDX  DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
BDR1STKY DS    XL(L'PREGKEY)       SKELETON SAVEAREA                            
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - FILTER BUY ON DRD - FNDDRD'                  
***********************************************************************         
*                                                                     *         
*        FILTER BUY BY DRD                                            *         
*                                                                     *         
*NTRY    AIO1  ==> BUYREC                                             *         
*                                                                     *         
*EXIT    PARM0+3  C'N' - BUY FAILS DRD FILTER                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
FLTDRD   NMOD1  0,**+FDR                                                        
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         ST    R1,FDRPRMSV         SAVE PARAMER LIST POINTER                    
         MVI   3(R1),0             INIT RETURN CODE                             
*                                                                               
         XC    PBRGN,PBRGN         INIT REGION CODE                             
         XC    PBREGNM,PBREGNM     INIT REGION NAME                             
         XC    PBDST,PBDST         INIT DISTRICT CODE                           
         XC    PBDSTNM,PBDSTNM     INIT DISTRICT NAME                           
*                                                                               
*        READ LTLREC - PUB SUPPLEMENTAL RECORD                                  
*          IT CONTAINS ALL DRD SCHEMES                                          
*                                                                               
FDRLTL   DS    0H                                                               
*                                                                               
         MVC   FDRKEYSV,IOKEY      SAVE CURRENT KEY                             
         MVC   FDRAIOSV,AIO3       SAVE ADDRESS OF AIO2                         
*                                                                               
         LA    RE,LITTLREC         USE LITTLREC AREA FOR I/O'S                  
         ST    RE,PBALTLRC         FOR USE IN T40501                            
         ST    RE,AIO3             FORCE TO USE A DIFFERENT IO AREA             
*                                                                               
         LA    R6,IOKEY            ESTABLISH KEY WORKAREA AS LTLREC             
         USING LTLRECD,R6            CONTAINS SUPPLEMENTAL PUB INFO             
         XC    LTLKEY,LTLKEY       INIT KEY AREA                                
*                                                                               
         MVC   LTLKAGY,PBAGY       SET AGENCY                                   
         MVC   LTLKMED,PBMED       SET MEDIA                                    
         MVI   LTLKCOD,LTLKIDQ     SET RECORD ID                                
*                                                                               
         L     R2,AIO1             ADDRESS OF BUY                               
         USING PBUYRECD,R2         ESTABLISH BUY RECORD                         
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   SKIP IF NO BUY RECORD PRESENT                
         BNE   FDRBUYN                                                          
*                                                                               
         MVC   LTLKPUB,PBUYKPUB    SET PUB                                      
         MVC   LTLKZON,PBUYKZON    SET ZONE                                     
         MVC   LTLKED,PBUYKEDT     SET EDITION                                  
*                                                                               
         B     FDRCONX                                                          
*                                                                               
FDRBUYN  DS    0H                                                               
*                                                                               
         L     R2,AIO2             ADDRESS OF CONTRACT                          
         USING PCONRECD,R2         ESTABLISH CONTRACT RECORD                    
*                                                                               
         MVC   LTLKPUB,PCONKPUB    SET PUB                                      
         MVC   LTLKZON,PCONKZON    SET ZONE                                     
         MVC   LTLKED,PCONKEDT     SET EDITION                                  
*                                                                               
FDRCONX  DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BNE   FDRLTL10                                                         
*                                                                               
         MVC   LTLKAGY,PAORAGY     SET FOR AOR AGENCY                           
         MVC   LTLKPUB(6),PAORPUB     SET FOR AOR PUB NUMBER                    
*                                                                               
         L     RF,PBUTLA           SET TO READ AOR FILES                        
         MVC   FDRSESV,4(RF)       SAVE SE NUMBER                               
         MVC   4(1,RF),PAORSE                                                   
*                                                                               
FDRLTL10 DS    0H                                                               
*                                                                               
         CLI   PBQCLTSW,C'Y'       IF DOING CLIENT FOR AOR                      
         BNE   FDRLTL20                                                         
*                                                                               
         OC    PAOPUB,PAOPUB       SKIP IF NO PUB AVAILABLE                     
         BZ    FDRLTL15              OCCURS IF NOT READING CONTRACTS            
*                                                                               
         MVC   LTLKAGY,PAOAGY         SET FOR BRAND AGENCY                      
         MVC   LTLKPUB(6),PAOPUB      SET FOR AGY PUB NUMBER                    
*                                                                               
FDRLTL15 DS    0H                                                               
*                                                                               
         L     RF,PBUTLA              SET TO READ BRAND AGENCY FILES            
         MVC   FDRSESV,4(RF)          SAVE SE NUMBER                            
         MVC   4(1,RF),PAOSE                                                    
*                                                                               
FDRLTL20 DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPUBDIR+IO3+IOHI  READ LTLREC POINTER                       
*                                                                               
         CLC   LTLKEY,IOKEYSAV     MUST HAVE EXACT MATCH                        
         BNE   FDRTEST                                                          
*                                                                               
         GOTO1 AIO,IOPUBFIL+IO3+IOGET   READ LTLREC                             
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R6,AIO3             POINT TO FOUND RECORD                        
*                                                                               
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
*                                                                               
         CLI   0(R6),0             DONE IF ONLY KEY PRESENT                     
         BE    FDRTEST                                                          
*                                                                               
         MVI   ELCODE,PUBDSTQ      SET TO FIND REG/DIS ELEMENT                  
*                                                                               
         CLI   0(R6),PUBDSTQ       SKIP IF FIRST ELEMENT IS OF TYPE             
         BE    *+12                                                             
         BAS   RE,NXTELM           FIND 1ST PUBDSTEL                            
         BNE   FDRELMDN            END OF RECORD                                
*                                                                               
FDRELMLP DS    0H                                                               
*                                                                               
         USING PUBDSTEL,R6         ESTABLISH PUBDSTEL                           
*                                                                               
*        FILTER ON CLIENT                                                       
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   IF USING ANOTHER CLIENT'S DRD SCHEME         
         BZ    FDRELM10               NO                                        
*                                                                               
         CLC   PUBDDIV,=C'000'        THEN DIVISION MUST BE '000'               
         BNE   FDRELMCN                                                         
*                                                                               
         CLC   PUBDCLT,PBQDRDCL       AND ELEMENT'S CLT MUST MATCH              
         BNE   FDRELMCN                   OTHER CLIENT                          
*                                                                               
         B     FDRELM30               IN ORDER TO ACCEPT                        
*                                                                               
FDRELM10 DS    0H                  ELSE                                         
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BNE   *+18                                                             
         CLC   PUBDCLT,PAORQADV       ELEMENT CLT MUST MATCH AOR CLIENT         
         BNE   FDRELMCN                                                         
         B     FDRELM20                                                         
*                                  ELSE                                         
         CLC   PUBDCLT,PBCLT         ELEMENT CLIENT MUST MATCH CURRENT          
         BNE   FDRELMCN                 CLIENT                                  
*                                                                               
FDRELM20 DS    0H                                                               
*                                                                               
*        FILTER ON DIVISION                                                     
*                                                                               
         CLC   PUBDDIV,PBDIV       ELEMENT DIV MUST MATCH PRODUCT'S             
         BNE   FDRELMCN                                                         
*                                                                               
*        FILTER ON REGION                                                       
*                                                                               
FDRELM30 DS    0H                                                               
*                                                                               
         CLC   PBQRGN,=C'ALL'      ACCEPT IF ALL REGIONS REQUESTED              
         BE    *+10                                                             
         OC    PBQRGN,PBQRGN               BIN ZERO = ALL                       
         BE    *+10                                                             
         CLC   PUBDREG,PBQRGN      ELSE MUST MATCH REQUESTED REGION             
         BNE   FDRELMCN                                                         
*                                                                               
*        FILTER ON DISTRICT                                                     
*                                                                               
         CLC   PBQDST,=C'ALL'      ACCEPT IF ALL DISTRICTS REQUESTED            
         BE    *+10                                                             
         OC    PBQDST,PBQDST              BIN 0  MEANS ALL                      
         BZ    *+10                                                             
         CLC   PUBDDST,PBQDST       ELSE MUST MATCH REQUESTED DISTRICT          
         BNE   FDRELMCN                                                         
*                                                                               
         B     FDRDSTFD           CORRECT PUBDSTEL FOUND                        
*                                                                               
FDRELMCN DS    0H                                                               
*                                                                               
         BAS   RE,NXTELM           FIND NEXT PUBDSTEL                           
         BE    FDRELMLP                                                         
*                                                                               
FDRELMDN DS    0H                                                               
*                                                                               
         B     FDRTEST             NO REG/DST ELEMENT FOUND                     
*                                                                               
FDRDSTFD DS    0H                                                               
*                                                                               
*        LOOK UP REGION/DISTRICT NAMES IN REGION BUFFER                         
*                                                                               
         MVC   PBRGN,PUBDREG       RETURN REGION   CODE                         
*                                                                               
         ICM   R8,15,PBADRDBF      ADDRESS OF DRD BUFFER                        
         BNZ   *+6                                                              
         DC    H'0'                MUST HAVE BUFFER                             
         USING DRDBUFFD,R8         ESTABLISH DRD BUFFER ENTRY                   
*                                                                               
         LA    R5,DRDLEN           GET BUFFER LENGTH                            
*                                                                               
FDRBUFLP DS    0H                                                               
*                                                                               
         OC    0(DRDLEN,R8),0(R8)  DONE IF END OF TABLE                         
         BZ    FDRBUFDN                                                         
*                                                                               
         CLC   PUBDDIV,DRDDIV      MATCH DIVISION                               
         BNE   *+10                                                             
         CLC   PUBDREG,DRDRGN        AND REGION                                 
         BE    FDRBUF10                                                         
*                                                                               
*        MAY BE ANOTHER CLI DRD SCHEME ERGO DIV M/B 000                         
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   SKIP IF NOT ANOTHER                          
         BZ    FDRBUFCN              CLIENT'S DRD SCHEME                        
*                                                                               
         CLC   PUBDDIV,=C'000'     DIVISION MUST BE '000'                       
         BNE   *+10                                                             
         CLC   PUBDREG,DRDRGN        AND REGION MATCH                           
         BNE   FDRBUFCN                                                         
*                                                                               
*        HANDLE REGION ENTRY                                                    
*          REGION ENTRY ALWAYS BEFORE DISTRICT ENTRIES                          
*                                                                               
FDRBUF10 DS    0H                                                               
*                                                                               
         OC    DRDDST,DRDDST       DISTRICT MUST BE NULLS FOR REG               
         BNZ   FDRBUF40               ENTERY IN BUFFER                          
*                                                                               
         MVC   PBREGNM,DRDNAME     SET REGION NAME                              
*                                                                               
*        FIND DISTRICT ENTRY                                                    
*                                                                               
FDRBUF40 DS    0H                                                               
*                                                                               
         OC    PUBDDST,PUBDDST     SKIP IF NO DISTRICT SCHEME WANTED            
         BZ    FDRBUFDN                                                         
*                                                                               
         CLC   PUBDDST,DRDDST      MUST MATCH ON DISTRICT                       
         BNE   FDRBUFCN                                                         
*                                                                               
         MVC   PBDST,PUBDDST       RETURN DISTRICT CODE                         
         MVC   PBDSTNM,DRDNAME     RETURN DISTRICT NAME                         
*                                                                               
         B     FDRBUFDN            ALL DONE                                     
*                                                                               
FDRBUFCN DS    0H                                                               
*                                                                               
         LA    R8,DRDLEN(R8)       BUMP TO NEXT ELEMENT IN BUFFER               
         B     FDRBUFLP                                                         
*                                                                               
FDRBUFDN DS    0H                                                               
*                                                                               
         OC   PUBDSHR,PUBDSHR    IF SHARED COST ACROSS REGION/DIST              
         BZ   *+8                                                               
         ST   R6,PBALTLEL          SAVE ADDRESS OF FIRST PUBDSTEL               
*                                                                               
         B     FLTDRDX             DONE                                         
*                                                                               
*        DIV/REG/DST NOT FOUND                                                  
*          REJECT BUY IF A SPECIFIC DIV/REG/DST REQUESTED                       
*           ELSE ACCEPT BUY BUT CLEAR PB... FIELDS                              
*                                                                               
FDRTEST  DS    0H                                                               
*                                                                               
         CLC   PBQDIV,=C'000'      REJECT IF SELECTING                          
         BH    *+10                FOR A SPECIFIC DIVISION                      
         CLC   PBQRGN,=C'000'      FOR A SPECIFIC REGION                        
         BH    *+10                                                             
         CLC   PBQDST,=C'000'      FOR A SPECIFIC DISTRICT                      
         BH    FDRDROP                                                          
*                                  ELSE ACCEPT BUY                              
         B     FLTDRDX                                                          
*                                                                               
FDRDROP  DS    0H                                                               
*                                                                               
         L     R1,FDRPRMSV         RETRIEVE PARAMETER LIST POINTER              
         MVI   3(R1),C'N'          DO NOT INCLUDE BUY                           
*                                                                               
FLTDRDX  DS    0H                                                               
*                                                                               
         MVC   IOKEY,FDRKEYSV      RESTORE CURRENT KEY                          
         MVC   AIO3,FDRAIOSV       RESTORE I/O AREA POINTER                     
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR CLIENT FOR AOR                            
         BNE   *+14                                                             
         L     RF,PBUTLA              RE-SET TO INCOMING FILES                  
         MVC   4(1,RF),FDRSESV                                                  
*                                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
FDRPRMSV DS    A                   PARAMETER LIST POINTER SAVEAREA              
FDRAIOSV DS    A                   CURRENT A(I/O AREA) SAVEAREA                 
FDRKEYSV DS    XL(L'IOKEY)         CURRENT KEY         SAVEAREA                 
FDRSESV  DS    X                   CURRENT SE          SAVEAREA                 
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - BUILD PRODUCT TABLE - BLDPRD'                
*=====================================================================*         
*                                                                     *         
*        SUBROUTINE BUILDS TABLE OF PRODUCTS FOR CLIENT               *         
*                                                                     *         
*EXIT PBAPRDBF ==>  PRD TABLE                                         *         
*                                                                     *         
*=====================================================================*         
         SPACE 2                                                                
         DS    0D                                                               
BLDPRD   NMOD1 0,**#BPR**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
*        CLEAR PRODUCT BUFFER BEFORE BUILDING TABLE                             
*                                                                               
         ICM   R0,15,PBLPRDBF      GET BUFFER LENGTH                            
         BZ    BLDPRDX               EXIT IF NOT SET                            
         ICM   R1,15,PBAPRDBF      AND ADDRESS                                  
         BZ    BLDPRDX                 EXIT IF NOT SET                          
*                                                                               
         BAS   RE,CLRBUFF                                                       
*                                                                               
         XC    PBCPRDBF,PBCPRDBF      CLEAR ENTRIES COUNTER                     
*                                                                               
         L     R4,PBAPRDBF         POINT TO START OF BUFFER                     
         USING PRDBUFFD,R4           ESTABLISH BUFFER ENTRY                     
*                                                                               
         L     R5,PBLPRDBF         AND LENGTH OF BUFFER                         
*                                                                               
*        INIT PRODUCT RECORD KEY                                                
*                                                                               
         XC    IOKEY,IOKEY         ESTABLISH KEY AS PRODUCT KEY                 
         LA    R2,IOKEY                                                         
         USING PPRDRECD,R2                                                      
*                                                                               
         MVC   PPRDKAGY,PBAGY      SET AGENCY                                   
         MVC   PPRDKMED,PBMED      SET MEDIA                                    
         MVI   PPRDKRCD,PPRDKIDQ   SET RECORD ID                                
         MVC   PPRDKCLT,PBCLT      SET CLIENT                                   
*                                                                               
*        IF SINGLE PRODUCT REQUESTED WE MAY NEED THE CLIENT'S                   
*          DEFAULT BILLING FORMULA WHICH IS STORED UNDER PRODUCT 'AAA'          
*                                                                               
BPRONE   DS    0H                                                               
*                                                                               
         OC    PBQGPPRD,PBQGPPRD   IF USING PRODUCT GROUP SCHEME                
         BNZ   BPRBLL                 SEE IF DEFAULT BILLING FORMULA            
*                                                                               
         CLC   PBQPRD,=C'ALL'      SKIP IF NOT A SINGLE PRODUCT                 
         BE    *+10                                                             
         CLC   PBQPRD,=C'   '        REQUEST                                    
         BE    BPRONEX                                                          
*                                                                               
BPRBLL   DS    0H                                                               
*                                                                               
         TM    DATAIND,DPROFDEF    SKIP IF DEFAULT BILLING PROFILE              
         BNO   BPRBLLX                NOT NEEDED                                
*                                                                               
         MVC   PPRDKPRD,=C'AAA'    SET FOR SPECIAL PRODUCT                      
*                                                                               
         ICM   R8,15,PBPRDFLT      SKIP IF NO SPACE ALLOCATED                   
         BZ    BPRBLLX               FOR BILLING FORMULA                        
*                                                                               
         XC    0(37,R8),0(R8)      INIT PRODUCT DEFAULT BILL FORMULA            
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ POINTER                                 
*                                                                               
         CLC   PPRDKEY(PPRDKPRD-PPRDKEY+L'PPRDKPRD),IOKEYSAV                    
         BNE   BPRBLL10            MUST MATCH AGY/MED/ID/CLT/PRD                
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1    READ RECORD                            
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R2,AIO1             POINT TO FOUND RECORD                        
*                                                                               
         MVC   0(6,R8),PPRDBILP    SAVE BILLING BASIS                           
*                                                                               
BPRBLL10 DS    0H                                                               
*                                                                               
         MVC   IOKEY,IOKEYSAV      RESTORE BASIC KEY                            
         LA    R2,IOKEY            RESET KEY POINTER                            
*                                                                               
BPRBLLX  DS    0H                                                               
*                                                                               
         OC    PBQGPPRD,PBQGPPRD   SKIP IF USING PRODUCT GROUP SCHEME           
         BNZ   *+10                                                             
         MVC   PPRDKPRD,PBQPRD     SET PRODUCT IN KEY                           
*                                                                               
BPRONEX  DS    0H                                                               
*                                                                               
         OC    PBQGPPRD,PBQGPPRD   PROCESSING A PRODUCT GROUP                   
         BZ    BPRGPPX                                                          
*                                                                               
         GOTO1 =A(PRDGRP),RR=RELO  GET FIRST PRODUCT FOR GROUP                  
*                                                                               
         OC    PBPROD,PBPROD       DONE IF END OF PRODUCTS REACHED              
         BZ    BLDPRDX             END OF PRODUCTS                              
*                                                                               
         MVC   PPRDKPRD,PBPROD     SET PRODUCT CODE IN KEY                      
*                                                                               
BPRGPPX  DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST POINTER                           
*                                                                               
BPRPRDLP DS    0H                                                               
*                                                                               
         CLC   PPRDKEY(PPRDKPRD-PPRDRECD),IOKEYSAV                              
         BNE   BPRPRDDN            MUST MATCH ONE AGY/MED/ID/CLT                
*                                                                               
         OC    PBQGPPRD,PBQGPPRD   IF PROCESSING A PRODUCT GROUP                
         BZ    BPRPRD05                                                         
*                                                                               
         CLC   PPRDKPRD,PBPROD        MUST MATCH PRODUCT                        
         BE    BPRPRD07                                                         
*                                                                               
         B     BPRPRDDN                                                         
*                                                                               
BPRPRD05 DS    0H                                                               
*                                                                               
         CLC   PBQPRD,=C'ALL'      SKIP IF AN ALL PRODUCT                       
         BE    *+10                                                             
         CLC   PBQPRD,=C'   '        REQUEST                                    
         BE    BPRPRD07                                                         
*                                                                               
         CLC   PPRDKPRD,PBQPRD     ELSE MUST MATCH PRODUCT                      
         BNE   BPRPRDDN                                                         
*                                                                               
BPRPRD07 DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1   READ IN RECORD                          
         BE    *+6                                                              
         DC    H'0'                  NO ERRORS TOLERATED                        
*                                                                               
         L     R2,IOADDR           POINT TO FOUND RECORD                        
*                                                                               
*    FILTER ON DIV IF REQUESTED                                                 
*                                                                               
*                                                                               
         CLC   PBQDIV,=C'ALL'      SKIP IF ALL DIVISIONS                        
         BE    BPRPRD10                                                         
         CLC   PBQDIV,=C'   '        OR NO DIVISIONS ASKED FOR                  
         BNH   BPRPRD10                                                         
*                                                                               
         CLC   PBQDIV,PPRDDIV      FILTER ON DIVISION                           
         BNE   BPRPRDCN                                                         
*                                                                               
BPRPRD10 DS    0H                                                               
*                                                                               
         MVC   PBFPRD,PPRDKPRD     SAVE PRODUCT CODE                            
         MVC   PBFDIV,PPRDDIV      SAVE DIVISION CODE                           
         MVC   PBFNAME,PPRDNAME    SAVE PRODUCT NAME                            
         MVC   PBFOANCD,PPRDOAN    SAVE OTHER AGENCY CODE                       
         MVC   PBFBLBAS,PPRDBILP   SAVE BILLING PROFILE BASIS                   
         MVC   PBFBLFRM,PPRDBILP+1 SAVE BILLING FORMULA                         
         MVC   PBFGPCDE,PBGPCODE   SAVE GROUP CODE                              
*                                                                               
*        FIND PLANNED COST BILLING EFFECTIVE DATE                               
*                                                                               
         MVI   ELCODE,PPBPCECQ     BILLING EFD ELEMENT CODE                     
         LA    R6,PPRDKEY                                                       
         USING PPBPCELC,R6         ESTABLISH BILLING EFD ELEMENT                
*                                                                               
         BRAS  RE,GETEL            FIND ELEMENT                                 
         BNE   *+10                ELEMENT NOT FOUND                            
         MVC   PBFPCBLD,PPBPCEFF   SAVE BILL EFFECTIVE DATE                     
*                                                                               
         OC    PBQGPPRD,PBQGPPRD   IF PROCESSING A PRODUCT GROUP                
         BNZ   *+14                                                             
         CLC   PBQPRD,=C'ALL'      SKIP IF 'ALL' PRODUCTS                       
         BE    BPRPRD20                                                         
*                                                                               
         OC    PBFBLBAS(6),PBFBLBAS  SKIP IF HAVE BILLING PROFILE BASIS         
         BNZ   BPRPRD20                                                         
*                                                                               
         ICM   RF,15,PBPRDFLT      POINT TO DEFAULT BILLING FORMULA             
         BZ    BPRPRD20              SKIP IF NO SPACE RESERVED                  
*                                                                               
         MVC   PBFBLBAS(6),0(RF)     USE PRODUCT AAA BILLING BASIS              
*                                                                               
BPRPRD20 DS    0H                                                               
*                                                                               
         MVC   PBFACCTN,PPRDACCT    SAVE ACCOUNT NUMBER                         
*                                                                               
         SH    R5,=Y(PBFLEN)       DECREMENT ENTRY COUNTER                      
         BP    *+6                                                              
         DC    H'0'                EXPAND PRODUCT BUFFER                        
*                                                                               
         LA    R4,PBFLEN(R4)       BUMP TO NEXT BUFFER ENTRY                    
         XC    0(PBFLEN,R4),0(R4)    INIT ENTRY                                 
*                                                                               
         L     RE,PBCPRDBF         BUMP ENTRY COUNTER                           
         LA    RE,1(RE)                                                         
         ST    RE,PBCPRDBF                                                      
*                                                                               
BPRPRDCN DS    0H                                                               
*                                                                               
         LA    R2,IOKEY            RESET KEY POINTER                            
*                                                                               
         OC    PBQGPPRD,PBQGPPRD   IF PROCESSING A PRODUCT GROUP                
         BZ    BPRPRDC1                                                         
*                                                                               
         GOTO1 =A(PRDGRP),RR=RELO    GET NEXT PRODUCT                           
*                                                                               
         OC    PBPROD,PBPROD       DONE IF END OF PRODUCTS REACHED              
         BZ    BPRPRDDN            END OF PRODUCTS                              
*                                                                               
         MVC   PPRDKPRD,PBPROD     SET NEW PRODUCT IN KEY                       
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ PRODUCT DIRECTORY POINTER               
*                                                                               
         B     BPRPRDLP                                                         
*                                                                               
BPRPRDC1 DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT POINTER                            
*                                                                               
         B     BPRPRDLP                                                         
*                                                                               
BPRPRDDN DS    0H                                                               
*                                                                               
         XC    PBPROD,PBPROD       RESET PRODUCT FIELD                          
*                                                                               
BLDPRDX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - FIND PRODUCT - FNDPRD'                       
*=====================================================================*         
*                                                                     *         
*        SUBROUTINE FINDS PRODUCT IN PRODUCT TABLE                    *         
*          PRODUCT BUFFER BUILT FOR CLIENT. IF PRODUCT FOUND          *         
*          VARIOUS PB... VALUES FILLED IN.                            *         
*                                                                     *         
*NTRY    R2==>  BUY PASSIVE POINTER                                   *         
*                                                                     *         
*EXIT    CC      EQ  - PRODUCT FOUND                                  *         
*               NEQ  - PRODUCT NOT FOUND                              *         
*                                                                     *         
*=====================================================================*         
         SPACE 2                                                                
         DS    0D                                                               
FNDPRD   NMOD1 0,**+FPR**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         L     R4,PBAPRDBF         ESTABKISH ENTRY IN PRODUCT BUFFER            
         USING PRDBUFFD,R4                                                      
*                                                                               
         USING PBUYREC,R2          ESTABLISH BUY RECORD                         
*                                                                               
         ICM   R5,15,PBCPRDBF      NUMBER OF PRODUCTS IN BUFFER                 
         BZ    FPRERR              NO PRODUCTS IN BUFFER - NO MATCH             
*                                                                               
*        SEARCH PRODUCT BUFFER                                                  
*          SEARCH IS FOR PASSIVE PRODUCT IF ONE EXISTS                          
*                                                                               
FPRBUFLP DS    0H                                                               
*                                                                               
         CLI   PASSPRD,0           SKIP IF NO PASSIVE PRODUCT EXISTS            
         BE    FPRBUF10                                                         
*                                                                               
         CLC   PBFPRD,PASSPRD      MATCH BUFFER PRODUCT TO PASSIVE PRD          
         BE    FPRBUFFD                                                         
         B     FPRBUFCN                                                         
*                                                                               
FPRBUF10 DS    0H                                                               
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   SKIP IF NOT STANDARD KEY                     
         BNE   FPRBUF20                                                         
*                                                                               
         CLC   PBFPRD,PBUYKPRD     MATCH BUFFER PRD TO KEY PRD                  
         BE    FPRBUFFD                                                         
         B     FPRBUFCN                                                         
*                                                                               
FPRBUF20 DS    0H                  PUB ORDER KEY                                
*                                                                               
         CLC   PBFPRD,PBUYPPRD     MATCH BUFFER PRD TO PASS PTR PRD             
         BE    FPRBUFFD                                                         
*                                                                               
FPRBUFCN DS    0H                                                               
*                                                                               
         LA    R4,PBFLEN(R4)       POINT TO NEXT BUFFER ENTRY                   
         BCT   R5,FPRBUFLP         DECREMENT NUMBER OF ENTRIES COUNTER          
*                                                                               
FPRBUFDN DS    0H                                                               
*                                                                               
         B     FPRERR              PRODUCT NOT IN BUFFER                        
*                                                                               
FPRBUFFD DS    0H                  PRODUCT FOUND IN BUFFER                      
*                                                                               
         MVC   PBPROD,PBFPRD       SET PRODUCT CODE                             
         MVC   PBDIV,PBFDIV        SET DIVISION CODE                            
         MVC   PBPRDNM,PBFNAME     SET PRODUCT NAME                             
         MVC   PBOANCOD,PBFOANCD   SET OAN CODE                                 
         MVC   PBACCTNO,PBFACCTN   SET PRODUCT ACCOUNT NUMBER                   
         MVC   PBPCPBLD,PBFPCBLD   SET PLANNED COST BILL EFD                    
*                                                                               
*        FIND DIVISION NAME IF DOING DIVISIONS                                  
*                                                                               
FPRDIV   DS    0H                                                               
*                                                                               
         XC    PBDIVNM,PBDIVNM     INIT DIVISION NAME                           
*                                                                               
         CLC   PBQDIV,=C'   '      SKIP IF NOT DOING DIVISIONS                  
         BNH   FPRDIVX                                                          
*                                                                               
*        LOOK UP DIVISION NAME IN BUFFER                                        
*                                                                               
*        BUFFER FOR DRD MUST BE SET UP WHEN PROCESSING CLI                      
*        AND REQUESTING DIVISION                                                
*                                                                               
         ICM   R1,15,PBADRDBF      ADDRESS OF DRD BUFFER                        
         BZ    FPRDIVNF            NO BUFFER SET UP                             
         USING DRDBUFFD,R1         ESTABLISH DRD BUFFER ENTRY                   
*                                                                               
         ICM   R5,15,PBCDRDBF      NUMBER OF RECORDS                            
         BZ    FPRDIVNF            NO DIVISIONS IN TABLE                        
*                                                                               
FPRDIVLP DS    0H                                                               
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   SKIP IF NO DRD CLT SPECIFIED                 
         BZ    FPRDIV10                                                         
*                                                                               
*        OTHER CLIENT DRD ENTRIES MARKED WITH X'FF' IN FIRST BYTE               
*                                                                               
FPRDIVCL DS    0H                                                               
*                                                                               
         CLI   0(R1),X'FF'         LOOK FOR SPECIAL INDICATOR                   
         BNE   *+14                                                             
         CLC   1(3,R1),PBDIV       MATCH ON DIVISION ID                         
         BE    FPRDIVFD            DIV FOUND - GO PROCESS                       
         LA    R1,DRDLEN(R1)       BUMP TO NEXT TABLE ENTRY                     
         BCT   R5,*-22                                                          
         B     FPRDIVNF            REACHED END OF TABLE                         
*                                                                               
FPRDIV10 DS    0H                                                               
*                                                                               
         CLC   DRDDIV,PBDIV        MATCH DIVISION                               
         BNE   *+14                                                             
         OC    DRDRGN,DRDRGN         WITHOUT REGION CODE                        
         BZ    FPRDIVFD                                                         
*                                                                               
         LA    R1,DRDLEN(R1)       BUMP TO NEXT TABLE ENTRY                     
         BCT   R5,*-24                                                          
         B     FPRDIVNF            REACHED END OF TABLE                         
*                                                                               
FPRDIVFD DS    0H                                                               
*                                                                               
         MVC   PBDIVNM,DRDNAME     SAVE DIVISION NAME                           
         B     FPRDIVX                                                          
*                                                                               
FPRDIVNF DS    0H                  DIVISION NOT FOUND                           
*                                                                               
         MVC   PBDIVNM,=CL20'UNASSIGNED DIVISION'                               
*                                                                               
FPRDIVX  DS    0H                                                               
*                                                                               
*        GET OAN RECORD                                           L01           
*                                                                               
FPROAN   DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDOAN    SKIP IF OAN RECORD NOT NEEDED  L01           
         BNO   FPROANX                                            L01           
*                                                                               
         OC    PBOANAME,PBOANAME   READ OAN REC IF NAME NEEDED                  
         BZ    FPROANRD                                           L01           
*                                                                               
         CLC   PBOANAME+32(2),PBOANCOD  SKIP REC READ IF CURRENT                
         BE    FPROANX             OAN IS THE ONE WANTED                        
*                                                                               
FPROANRD DS    0H                                                 L01           
*                                                                               
         GOTO1 =A(READREC),PARM,1,RR=RELO       READ OAN REC                    
*                                                                               
FPROANX  DS    0H                                                 L01           
*                                                                               
*        FILL IN ESTIMATE WORKAREA FIELDS                                       
*                                                                               
FPREST   DS    0H                                                               
*                                                                               
         XC    ESTDATA,ESTDATA     INIT ESTIMATE DATA                           
         LA    R8,ESTDATA          ESTABLISH ESTIMATE AREA AS                   
         USING ESTBUFFD,R8         ESTIMATE BUFFER ENTRY                        
*                                                                               
         MVC   EBFMED,PBUYKMED     SET MEDIA                                    
         MVC   EBFCLT,PBUYKCLT     SET CLIENT                                   
         MVC   EBFPRD,PBFPRD       SET PRODUCT                                  
         MVC   EBFEST,PBUYKEST     SET ESTIMATE                                 
*                                                                               
         CR    RB,RB               SET EQ CC                                    
         B     FNDPRDX                                                          
*                                                                               
FPRERR   DS    0H                  PRODUCT NOT FOUND IN BUFFER                  
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
FNDPRDX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - FILTER BUY ON AD - FLTAD'                    
***********************************************************************         
*                                                                     *         
*        FILTER BUY BY AD FILTER                                      *         
*                                                                     *         
*NTRY    AIO1  ==> BUYREC                                             *         
*                                                                     *         
*EXIT    ^= CC  - BUY FAILS DRD FILTER                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
FLTAD    NMOD1  300,**+FAD                                                      
*                                                                               
         LR    RA,RC               SAVE WORKING STORAGE POINTER                 
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         L     R2,AIO1             ADDRESS OF BUY                               
         USING PBUYRECD,R2         ESTABLISH BUY RECORD                         
*                                                                               
*        SET UP TABLE BXLE REGS IF FIRST TIME FOR REQUEST                       
*                                                                               
FADINIT  DS    0H                                                               
*                                                                               
         ICM   R8,15,PBAADBF       START OF ADD BUFFER                          
         BZ    FLTADX              NO BUFFER PROVIDED - SKIP FILTERING          
*                                                                               
         USING ADBFD,R8            ESTABLISH AD BUFFER                          
*                                                                               
         CLC   ADBFPRD,PBUYKPRD    RE-INITIALIZE AD BUFFER ON PRD CHG           
         BNE   *+10                                                             
         CLC   ADBFCLT,PBCLT       OR CLIENT CHANGE                             
         BNE   *+10                                                             
         CLC   ADBFMED,PBMED       OR MEDIA CHANGE                              
         BE    FADINITX                                                         
*                                                                               
         LA    R3,ADBFENT          POINT TO FIRST ENTRY IN BUFFER               
         LA    R4,ADBFLN           LENGTH OF BUFFER ENTRY                       
         LR    R5,R3                                                            
         BCTR  R5,0                END OF BUFFER                                
         STM   R3,R5,ADBFBXLE      BXLE REGS FOR AD BUFFER                      
*                                                                               
         XC    ADBFENT(ADBFHDLN),ADBFENT  INIT FIRST BUFFER ENTRY               
         XC    ADBFJBKY,ADBFJBKY                                                
         XC    ADBFJBHD,ADBFJBHD                                                
*                                                                               
         MVC   ADBFMED,PBMED       RESET BUFFER CONTROL FIELDS                  
         MVC   ADBFCLT,PBCLT                                                    
         MVC   ADBFPRD,PBUYKPRD                                                 
*                                                                               
FADINITX DS  0H                                                                 
*                                                                               
*        SEARCH AD BUFFER TO SEE IF AD CAME UP BEFORE                           
*                                                                               
FADSRCH  DS    0H                                                               
*                                                                               
         OC    PBDJOB,PBDJOB       DROP IF NO AD CODE IN BUY                    
         BNZ   *+10                                                             
         LTR   RB,RB               SET ^= CC                                    
         B     FLTADX                                                           
*                                                                               
         LM    R3,R5,ADBFBXLE      LOAD BUFFER BXLE REGS                        
*                                                                               
         CR    R5,R3               BUFFER IS EMPTY IF END BEFORE START          
         BNH   FADSRCHX              GO ADD AD TO BUFFER                        
*                                                                               
         USING ADBFENT,R3          ESTABLISH BUFFER ENTRY                       
*                                                                               
FADSRCHL DS    0H                                                               
*                                                                               
         CLC   PBDJOB,PJOBKJOB-PJOBKEY+ADBFJBKY  FIND AD CODE                   
         BE    FADADDX             FOUND - SKIP ADDING TO BUFFER                
*                                                                               
FADSRCHC DS    0H                                                               
*                                                                               
         BXLE  R3,R4,FADSRCHL                                                   
*                                                                               
*                                  AD NOT IN BUFFER                             
*                                                                               
         L     RF,PBAADBF          BUFFER START                                 
         A     RF,PBLADBF          PLUS BUFFER LENGTH                           
*                                                                               
         LA    R1,0(R4,R3)         END OF NEW BUFFER ELEMENT                    
*                                                                               
         CR    R1,RF               ELEMENT MUST FIT IN BUFFER                   
         BL    *+6                                                              
         DC    H'0'                INCREASE SIZE OF AD BUFFER                   
*                                                                               
         XC    ADBFENT(ADBFHDLN),ADBFENT  INIT NEW BUFFER ENTRY                 
         XC    ADBFJBKY,ADBFJBKY                                                
         XC    ADBFJBHD,ADBFJBHD                                                
*                                                                               
FADSRCHX DS    0H                                                               
*                                                                               
*        READ JOB RECORD FOR NEW AD                                             
*                                                                               
FADJOB   DS    0H                                                               
*                                                                               
         MVC   8(L'IOKEY,RA),IOKEY SAVE CURRENT KEY                             
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R6,IOKEY            ESTABLISH KEYAREA AS                         
         USING PJOBRECD,R6           JOB RECORD KEY                             
*                                                                               
         MVC   PJOBKAGY,PBAGY      SET AGENCY                                   
         MVC   PJOBKMED,PBMED      SET MEDIA                                    
         MVI   PJOBKRCD,PJOBKIDQ   SET TO READ JOB RECORD                       
         MVC   PJOBKCLT,PBUYKCLT   SET CLIENT                                   
         MVC   PJOBKPRD,PBUYKPRD   SET PRODUCT                                  
         MVC   PJOBKJOB,PBDJOB     SET JOB CODE                                 
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ POINTER                                 
*                                                                               
         CLC   PJOBKEY,IOKEYSAV    IF RECORD NOT FOUND                          
         BNE   FADRESTR               DROP BUY                                  
*                                                                               
         MVC   4(4,RA),AIO3      SAVE ADDRESS OF IO3                            
*                                                                               
         LA    R6,80(RA)         REPLACE WITH WORKAREA ADDRESS                  
         ST    R6,AIO3                                                          
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3  READ RECORD                              
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         MVC   AIO3,4(RA)        RESTORE POINTER                                
*                                                                               
*        ADD AD TO BUFFER                                                       
*                                                                               
         MVC   ADBFDISK,IOKEY+27     SAVE JOB RECORD DISK ADDRESS               
         L     RF,PBUTLA                                                        
         MVC   ADBFSE,4(RF)        SAVE JOB RECORD SE                           
         MVC   ADBFJBKY,PJOBKEY    SAVE JOB RECORD KEY                          
         MVC   ADBFJBHD,PJOBELEM   SAVE JOB HEADER ELEMENT                      
*                                                                               
*        DETERMINE ACCEPTANCE STATUS                                            
*                                                                               
         LA    R0,L'PBQADFLT       NUMBER OF CH'S IN FILTER                     
         SR    RE,RE               INIT CHARACTER POINTER                       
         MVC   FADADFLT,PBQADFLT   MOVE FILTER TO WORK AREA                     
*                                                                               
FADACPTL DS    0H                                                               
*                                                                               
         LA    R1,FADADFLT(RE)     NEXT FILTER CHARACTER                        
*                                                                               
         CLI   0(R1),C'*'          SKIP IF WILD CARD                            
         BE    *+8                                                              
         CLI   0(R1),C' '          OR IF NO VALUE GIVEN                         
         BNH   FADACPTC                                                         
*                                                                               
         LA    RF,PJOBFILT-PJOBELEM+ADBFJBHD  POINT TO FILTER                   
         LA    RF,0(RE,RF)         POINT TO CORRES CH FOR AD                    
*                                                                               
         TM    0(R1),X'40'         C'40' BIT OFF IF NEGATIVE FILTER             
         BO    FADACPT1                                                         
*                                                                               
         OI    0(R1),X'40'         TURN ON BIT                                  
*                                                                               
         CLC   0(1,R1),0(RF)       DROP IF MATCH                                
         BE    FADACPTD                                                         
         B     FADACPTC                                                         
*                                                                               
FADACPT1 DS    0H                                                               
*                                                                               
         CLC   0(1,R1),0(RF)       DROP IF NO MATCH                             
         BNE   FADACPTD                                                         
*                                                                               
FADACPTC DS    0H                                                               
*                                                                               
         LA    RE,1(RE)            BUMP TO CHARACTER POINTER                    
         CR    RE,R0               CONTINUE IF MORE CHS LEFT                    
         BL    FADACPTL                                                         
*                                                                               
         MVI   ADBFIND,ADBFYES     ACCEPT AD                                    
*                                                                               
FADACPTD DS    0H                                                               
*                                                                               
         LA    R5,0(R4,R5)         NEW END OF BUFFER                            
         ST    R5,ADBFENA                                                       
*                                                                               
FADRESTR DS    0H                  RESTORE CURRENT POINTER                      
*                                                                               
         MVC   IOKEY,8(RA)       RESTORE CURRENT KEY                            
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL   RE-POINT TO CURRENT PTR               
*                                                                               
FADADDX  DS    0H                                                               
*                                                                               
*        TEST IF AD PASSES FILTER                                               
*                                                                               
FADTST   DS    0H                                                               
*                                                                               
         CLI   ADBFIND,ADBFYES       TEST IF AD ACCEPTABLE                      
*                                                                               
FLTADX   DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
FADADFLT DS    XL(L'PBQADFLT)        AD FILTER WORKAREA                         
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GET PUB NAME - GETPUBN'                      
*=====================================================================*         
*                                                                     *         
*        SUBROUTINE FINDS NEXT ZONE/EDITION FOR ADVERTISER REPORT     *         
*                                                                     *         
*NTRY    PBQPUB  -  REQUESTED PUB                                     *         
*                                                                     *         
*EXIT    PBQEDN,PBQZON  - SET TO NEXT EDITION/ZONE                    *         
*        CC - ZERO IF NONE FOUND                                      *         
*                                                                     *         
*=====================================================================*         
         SPACE 2                                                                
         DS    0D                                                               
GETNXTZN NMOD1 0,**+GZN**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
*               BUILD KEY FOR PUB/ZONE/EDITION                                  
*                                                                               
GZNKEY   DS    0H                                                               
*                                                                               
         MVC   GZNIOKEY,IOKEY      SAVE CURRENT FILE KEY                        
*                                                                               
         L     RF,PBUTLA           SET TO AOR'S FILES                           
         MVC   GZNSESV,4(RF)       SAVE CURRENT SE                              
         MVC   4(1,RF),PAORSE                                                   
*                                                                               
         LA    R6,IOKEY            ESTABLISH KEY AREA AS PUB MASTER KEY         
         USING PUBREC,R6                                                        
*                                                                               
         OC    GZNKEYSV,GZNKEYSV   IF NOT FIRST FOR AGENCY                      
         BZ    GZNKEY10                                                         
*                                                                               
         MVC   IOKEY,GZNKEYSV         RESTORE LAST USED KEY                     
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOHI  RE-READ LAST KEY                              
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOSQ  READ NEXT PUB KEY ON FILE                     
*                                                                               
         B     GZNKEYX                                                          
*                                                                               
GZNKEY10 DS    0H                                                               
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY BUILD AREA                          
*        SET PUBKEY FIELDS                                                      
*                                                                               
         MVI   PUBKCOD,PUBKIDQ     RECORD ID                                    
         MVC   PUBKMED,PBMED       MEDIA                                        
         MVC   PUBKPUB,PBQPUB      PUB NUMBER                                   
         MVC   PUBKAGY,PAORAGY     USE AOR AGENCY                               
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOHI  READ FIRST KEY ON FILE                        
*                                                                               
         MVC   GZNZONE(2),=X'FFFF' CLEAR SAVED ZONE/EDITION                     
*                                                                               
GZNKEYX  DS    0H                                                               
*                                                                               
         XC    GZNKEYSV,GZNKEYSV   INIT SAVED KEY                               
*                                                                               
GZNLOOP  DS    0H                                                               
*                                                                               
         CLC   PUBKPUB,PBQPUB      DONE ON CHANGE IN PUB                        
         BNE   GZNDONE                                                          
*                                                                               
         CLI   PUBKCOD,PUBKIDQ     REJECT IF NOT A PUB MASTER REC               
         BNE   GZNCONT                                                          
*                                                                               
         CLC   PUBKAGY,=C'ZZ'      IF AGENCY IS 'ZZ'                            
         BNE   GZNLOOP1                                                         
         CLI   PBAGYPRF+16,C'0'       REJECT IF NOT USING SRDS DEFAULT          
         BE    GZNCONT                                                          
         CLC   PUBKZON(2),GZNZONE     REJECT IF SAME AS LAST ZONE/EDN           
         BE    GZNCONT                                                          
*                                                                               
GZNLOOP1 DS    0H                                                               
*                                                                               
         CLC   PUBKAGY,PAORAGY     REJECT IF NOT AOR AGENCY PUB                 
         BNE   GZNCONT                                                          
*                                                                               
         B     GZNFOUND            ACCEPT                                       
*                                                                               
GZNCONT  DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOSQ  READ NEXT PUB KEY ON FILE                     
*                                                                               
         B     GZNLOOP                                                          
*                                                                               
GZNFOUND DS    0H                                                               
*                                                                               
         MVC   PBQZON,PUBKZON      SET ZONE                                     
         MVC   PAORZON,PUBKZON                                                  
         MVC   GZNZONE,PUBKZON                                                  
*                                                                               
         MVC   PBQEDT,PUBKED       SET EDITION                                  
         MVC   PAORED,PUBKED                                                    
         MVC   GZNED,PUBKED                                                     
*                                                                               
         MVC   GZNKEYSV,PUBKEY     SAVE PUB KEY                                 
*                                                                               
         B     GETNXTZX                                                         
*                                                                               
GZNDONE  DS    0H                                                               
*                                                                               
         MVC   GZNZONE(2),=X'FFFF' CLEAR SAVED ZONE/EDITION                     
*                                                                               
GETNXTZX DS    0H                                                               
*                                                                               
         L     RF,PBUTLA           RESTORE SE NUMBER                            
         MVC   4(1,RF),GZNSESV                                                  
*                                                                               
         MVC   IOKEY,GZNIOKEY      RESTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IORDEL+IOHI  RESET DIRECTORY POINTER                
*                                                                               
         OC    GZNKEYSV,GZNKEYSV   SET CC                                       
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
GZNZONE  DS    XL(L'PUBKZON)       LAST USED ZONE                               
GZNED    DS    XL(L'PUBKED)        LAST USED EDITION                            
GZNIOKEY DS    XL(L'IOKEY)         CURRENT KEY SAVEAREA                         
GZNKEYSV DS    XL(L'IOKEY)         LAST FOUND KEY                               
GZNSESV  DS    XL(L'PAORSE)        SE SAVEAREA                                  
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GET PUB NAME - GETPUBN'                      
*=====================================================================*         
*                                                                     *         
*        SUBROUTINE READS PUBNAME                                     *         
*                                                                     *         
*NTRY    R1==>  2 BYTE WORKAREA                                       *         
*                                                                     *         
*EXIT    IF FILTERING ON CASH DISCOUNT                                *         
*        WORKAREA+1  = C'Y' IF PUB OFFERS CASH DISCOUNT               *         
*                      C'N' OTHERWISE                                 *         
*                                                                     *         
*=====================================================================*         
         SPACE 2                                                                
         DS    0D                                                               
GETPUBN  NMOD1 9,**+GPN**                                                       
*                                                                               
         ST    R1,GPNR1SAV         SAVE PARAMETER LIST POINTER    L03           
         LR    RA,RC               SAVE WORKAREA POINTER                        
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    PBPUBNM,PBPUBNM     INIT NAME OF PUB                             
         MVI   PBPUBLOC,0          INIT PUB LOCK                                
*                                                                               
*               **** PUBLICATION NUMBER / NAME  ****                            
*                                                                               
GPNKEY   DS    0H                                                               
*                                                                               
         MVC   0(64,RA),IOKEY      SAVE CURRENT FILE KEY                        
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY BUILD AREA                          
         LA    R6,IOKEY            ESTABLISH KEY AREA AS PUB MASTER KEY         
         USING PUBREC,R6                                                        
*                                                                               
         CLI   PBMODE,PBPROCPB     IF READING THRU PUB FILE                     
         BNE   GPNKEY05                                                         
*                                                                               
         MVI   PUBKCOD,PUBKIDQ        RECORD ID                                 
         MVC   PUBKMED,PBMED          MEDIA                                     
         MVC   PUBKPUB(6),PBPUB       USE CURRENT PUB                           
         MVC   PUBKAGY,PBAGY          AGENCY                                    
         MVI   PUBKCOD,X'81'                                                    
*                                                                               
         B     GPNKEYX                                                          
*                                                                               
GPNKEY05 DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDBUY+PBQRDISS  IF NOT READING BUYS OR ISSUES         
         BNZ   GPNKEY50                                                         
         TM    PBQREAD2,PBQRDINV+PBQRDNV  AND NOT READING INVOICES              
         BNZ   GPNKEY50                                                         
*                                     USE CONTRACT RECORD FOR KEY               
*                                                                               
         L     R2,AIO2             ADDRESS OF CONTRACT RECORD                   
         USING PCONRECD,R2         ESTABLISH  CONTRACT RECORD                   
*                                                                               
*        SET WORKAREA FIELDS                                                    
*                                                                               
         MVI   PUBKCOD,PUBKIDQ     RECORD ID                                    
         MVC   PUBKMED,PBMED       MEDIA                                        
         MVC   PUBKPUB,PCONKPUB    PUB NUMBER                                   
         MVC   PUBKZON,PCONKZON    ZONE                                         
         MVC   PUBKED,PCONKEDT     EDITION                                      
         MVC   PUBKAGY,PBAGY       AGENCY                                       
*                                                                               
         CLI   PBQADVSW,C'Y'       IF AN ADVERTISER REPORT                      
         BNE   GPNKEY10                                                         
*                                                                               
         CLC   PAORQAGY,PAORAGY    BUT NOT BRAND AGENCY VIEWPOINT               
         BE    GPNKEY11                                                         
*                                                                               
         MVC   PUBKAGY,PAORAGY     USE AOR AGENCY                               
         L     RF,PBUTLA           SET TO AOR'S FILES                           
         MVC   4(1,RF),PAORSE                                                   
*                                                                               
         B     GPNKEY15                                                         
*                                                                               
GPNKEY10 DS    0H                                                               
*                                                                               
         CLI   PBQCLTSW,C'Y'       IF ADVERTISER CLIENT REPORT                  
         BNE   GPNKEY15                                                         
*                                                                               
GPNKEY11 DS    0H                                                               
*                                                                               
         GOTO1 GTAGYPUB,PARM,PUBKPUB  FIND AGENCY PUB ID                        
         BNE   GPNPBLX             NOT FOUND                                    
*                                                                               
         MVC   PUBKPUB(6),PAOPUB      AND USE IT                                
         MVC   PUBKAGY,PAOAGY      USE AGENCY'S AGENCY CODE                     
         L     RF,PBUTLA           SET TO AGY'S FILES                           
         MVC   4(1,RF),PAOSE                                                    
*                                                                               
GPNKEY15 DS    0H                                                               
*                                                                               
         MVC   PBPUB,PUBKPUB       PUB NUMBER                                   
         MVC   PBZONE,PUBKZON      ZONE                                         
         MVC   PBACTED,PUBKED      EDITION                                      
*                                                                               
         B     GPNKEY69            KEY BUILT                                    
*                                                                               
GPNKEY50 DS    0H                                                               
*                                                                               
         CLI   PBMODE,PBPROCIV    IF PROCESSING INVOICES                        
         BE    *+8                                                              
         CLI   PBMODE,PBPROCNV    IF PROCESSING INVOICES                        
         BNE   GPNKEY60                                                         
*                                                                               
         MVC   PUBKMED,PBMED          SET MEDIA                                 
         MVC   PUBKPUB(6),PBPUB       USE SUPPLIED PUB NUMBER                   
*                                                                               
GPNKEY57 DS    0H                                                               
*                                                                               
         B     GPNKEY69                                                         
*                                                                               
GPNKEY60 DS    0H                                                               
*                                                                               
         L     R2,AIO1             ADDRESS OF BUY RECORD                        
         USING PBUYRECD,R2         ESTABLISH BUY RECORD                         
*                                                                               
         MVC   PUBKMED,PBMED       MEDIA                                        
*                                                                               
         MVC   PUBKPUB(L'PBPUB+L'PBZONE+L'PBACTED),PBUYKPUB                     
*                                                                               
         CLI   PBUYKRCD,X'21'                                                   
         BNE   *+10                                                             
         MVC   PUBKPUB(L'PBPUB+L'PBZONE+L'PBACTED),PBUYKPRD IF 21               
*                           THEN PUB IS WHERE PRODUCT IS...                     
         CLI   PBUYKRCD,X'29'      IF ISSUE RECORD                              
         BNE   *+10                                                             
         MVC   PUBKPUB(L'PBPUB+L'PBZONE+L'PBACTED),PISSKPUB-PISSREC(R2)         
*                                                                               
GPNKEY69 DS    0H                                                               
*                                                                               
         MVC   PUBKAGY,PBAGY                                                    
         MVI   PUBKCOD,X'81'                                                    
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   GPNKEY70                                                         
*                                                                               
         GOTO1 GTAORPUB,PARM,PUBKPUB    FIND AOR PUB ID                         
         BNE   GPNPBLX             NOT FOUND                                    
*                                                                               
         MVC   PUBKPUB(6),PAORPUB     USE AOR'S PUB RECORD                      
         MVC   PUBKAGY,PAORAGY                                                  
         L     RF,PBUTLA           SET TO AOR'S FILES                           
         MVC   4(1,RF),PAORSE                                                   
*                                                                               
GPNKEY70 DS    0H                                                               
*                                                                               
GPNKEYX  DS    0H                                                               
*                                                                               
         L     RE,AIO3             POINT TO IOAREA                              
*                                                                               
         CLC   IOKEY(L'PUBKEY),0(RE)  CHECK IF RECORD ALREADY READ              
         BE    GPNRECX             ALREADY HAVE RECORD                          
*                                                                               
*        PUB-IO READ PUBREC DIR                                                 
*                                                                               
         GOTO1 AIO,IOPUBDIR+IOHI                                                
*                                                                               
         CLC   IOKEY(L'PUBKEY),IOKEYSAV IF DESIRED RECORD FOUND                 
         BE    GPNDIRX            GO GET RECORD                                 
*                                                                               
         CLI   PBAGYPRF+16,C'0'    IF NOT USING SRDS DEFAULT                    
         BE    GPNDROP                DROP PUB FROM REPORT                      
*                                  ELSE LOOK UNDER DEFAULT AGENCY               
         MVC   IOKEY,IOKEYSAV      RESTORE ORIGINAL KEY                         
         MVC   PUBKAGY,=C'ZZ'      CHANGE TO DEFAULT AGENCY                     
*                                                                               
         L     RE,AIO3             IOAREA                                       
*                                                                               
         CLC   IOKEY(L'PUBKEY),0(RE) CHECK IF RECORD ALREADY READ               
         BE    GPNRECX             HAVE SRDS RECORD IN IO         L03           
*                                                                               
         L     R1,GPNR1SAV                                                      
         MVI   1(R1),0             INITIALIZE CASH DISCOUNT INDICATOR           
*                                                                               
*        PUB-IO READ PUBREC DIR                                                 
*                                                                               
         GOTO1 AIO,IOPUBDIR+IO3+IOHI                                            
*                                                                               
         CLC   IOKEY(L'PUBKEY),IOKEYSAV                                         
         BNE   GPNDROP             DROP IF NOT FOUND                            
*                                                                               
*        READ RECORD INTO CORE                                                  
*                                                                               
GPNDIRX DS     0H                                                               
*                                                                               
         GOTO1 AIO,IOPUBFIL+IO3+IOGET                                           
         BE    *+6                                                              
         DC    H'0'                MUST FIND IT                                 
*                                                                               
         L     R6,AIO3                                            L05           
         MVC   29(4,R6),IODA       PASS DISK ADDRESS OF PUB       L05           
*                                                                               
GPNRECX DS     0H                                                               
*                                                                               
GPNCD    DS    0H                  DETERMINE IF CASH DISCOUNT OFFERED           
*                                                                               
         OC    PBQCDFLT,PBQCDFLT   SKIP IF NO PUB CD FILTERING                  
         BZ    GPNCDX                                             L03           
*                                                                               
         L     RF,GPNR1SAV         ASSUME NON CD PUB                            
         MVI   1(RF),C'N'                                         L03           
*                                                                               
         L     R6,AIO3             POINT TO PUB RECORD            L03           
         LA    R6,33(R6)           POINT TO FIRST ELEMENT IN RECORD03           
*                                                                               
         MVI   ELCODE,X'20'        SET TO FIND GENERAL INFO ELEMENT             
*                                                                               
         BAS   RE,NXTELM           LOOK FOR ELEMENT               L03           
         BNE   GPNCDX              NOT FOUND - NOT A CD PUB                     
*                                                                               
         USING PUBGEND,R6          ESTABLISH GENERAL INFO ELEMENT L03           
*                                                                               
         OC    PUBCDDAT,PUBCDDAT   ASSUME CD IF THERE IS  A                     
         BNZ   GPNCD10               CD EFFECTIVE DATE            L03           
*                                                                               
         OC    PUBCD,PUBCD         USE DEFAULT IF NO CASH DISCOUNTL03           
         BZ    GPNCDX                                             L03           
*                                                                               
         CP    PUBCD,=P'0'         OR CD IS ZERO                  L03           
         BE    GPNCDX                                             L03           
*                                                                               
GPNCD10 DS     0H                                                               
*                                                                               
         L     RF,GPNR1SAV         ELSE FLAG AS CD PUB            L03           
         MVI   1(RF),C'Y'                                         L03           
*                                                                               
GPNCDX   DS    0H                                                               
         EJECT                                                                  
*=====================================================================*         
*                                                                     *         
*       PAY/TRAFFIC / CONTRACT REP HANDLING                           *         
*                                                                     *         
*=====================================================================*         
         SPACE 2                                                                
GPNREP   DS    0H                                                               
*                                                                               
*   SEE IF REQUEST WAS FOR A SPECIFIC REP (REP IN PBQREPF)                      
*                                                                               
         OC    PBQREPF,PBQREPF     SKIP IF NO REP SPECIFIED                     
         BZ    GPNREPX                                                          
*                                                                               
         CLI   PBQREPF+4,C'S'      SKIP IF SPECIAL REP FILTERING                
         BE    GPNREPX                                                          
*                                                                               
*        FIND REP ELEMENT IN PUB MASTER RECORD                                  
*                                                                               
         L     R6,AIO3             POINT TO PUB MASTER RECORD                   
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
         MVI   ELCODE,X'14'        SET   TO SEARCH FOR REP ELEMENT              
*                                                                               
GPNREPL DS     0H                                                               
*                                                                               
         BAS   RE,NXTELM           SEARCH FOR A REP ELEMENT                     
         BE    GPNREPL1            REP FOUND                                    
*                                                                               
*                                  NONE FOUND                                   
*                                                                               
         TM    PBQREPF+4,X'40'     DROP IF A POSITIVE FILTER                    
         BO    GPNDROP                                                          
*                                                                               
         B     GPNREPD             ELSE KEEP                                    
*                                                                               
GPNREPL1 DS     0H                 REP FOUND                                    
*                                                                               
***      ===== *******                                                          
         USING PUBREPD,R6          ESTABLISH REP ELEMENT                        
***      ===== *******                                                          
*                                                                               
         CLC   PBCLT,PUBRPOFF      USE IF IT IS FOR CURRENT CLIENT              
         BE    GPNREPF                                                          
*                                                                               
         CLI   PUBRPOFF,X'FF'      IGNORE IF NOT A SPECIAL CODE                 
         BNE   GPNREPC                                                          
*                                                                               
         CLI   PUBRPOFF+1,X'FF'    USE IF IF IS AN ALL AGENCY REP               
         BE    GPNREPF                                                          
*                                                                               
         CLC   PUBRPOFF+1(1),PBCOFF ELSE MUST MATCH ON OFFICE                   
         BE    GPNREPF                                                          
*                                                                               
GPNREPC DS     0H                                                               
         B     GPNREPL                                                          
*                                                                               
*        FOUND MATCH                                                            
*                                                                               
GPNREPF DS     0H                                                               
*                                                                               
         CLI   PBQREPF+4,C'C'      IF LOOKING FOR CONTRACT REPS                 
         BE    *+8                                                              
         CLI   PBQREPF+4,C'C'-X'40' IF LOOKING FOR CONTRACT REPS                
         BNE   *+12                                                             
         LA    RF,PUBCNREP             MATCH TO CONTRACT REP NUMBER             
         B     GPNREPF1                                                         
*                                                                               
         CLI   PBQREPF+4,C'P'      IF LOOKING FOR PAYING REPS                   
         BE    *+8                                                              
         CLI   PBQREPF+4,C'P'-X'40' IF LOOKING FOR PAYING REPS                  
         BNE   *+12                                                             
         LA    RF,PUBPAREP             MATCH TO PAYING   REP NUMBER             
         B     GPNREPF1                                                         
*                                                                               
         CLI   PBQREPF+4,C'T'      IF LOOKING FOR TRAFFIC REPS                  
         BE    *+8                                                              
         CLI   PBQREPF+4,C'T'-X'40' IF LOOKING FOR TRAFFIC REPS                 
         BNE   *+12                                                             
         LA    RF,PUBTRREP             MATCH TO TRAFFIC  REP NUMBER             
         B     GPNREPF1                                                         
*                                                                               
GPNREPF1 DS     0H                                                              
*                                                                               
         OC    PBQREPF(4),PBQREPF  IF NO REP SPECIFIED                          
         BNZ   GPNREPF4                                                         
*                                                                               
         OC    0(4,RF),0(RF)       AND WE HAVE A REP                            
         BZ    GPNREPF2                                                         
*                                                                               
         TM    PBQREPF+4,X'40'        IF A POSITIVE FILTER                      
         BO    GPNREPD                   KEEP                                   
*                                                                               
         B     GPNDROP                ELSE DROP                                 
*                                                                               
GPNREPF2 DS     0H                 WE HAVE NO REP                               
*                                                                               
         TM    PBQREPF+4,X'40'        IF A POSITIVE FILTER                      
         BO    GPNDROP                   DROP                                   
*                                                                               
         B     GPNREPD                ELSE KEEP                                 
*                                                                               
GPNREPF4 DS     0H                 REP FOUND                                    
*                                                                               
         TM    PBQREPF+4,X'40'        IF A POSITIVE FILTER                      
         BNO   GPNREPF5                                                         
*                                                                               
         CLC   0(4,RF),PBQREPF           FILTER MUST MATCH                      
         BNE   GPNDROP                                                          
*                                                                               
         B     GPNREPD                                                          
*                                                                               
GPNREPF5 DS     0H                 NEGATIVE FILTER                              
*                                                                               
         CLC   0(4,RF),PBQREPF        FILTER MUST NOT MATCH                     
         BE    GPNDROP                                                          
*                                                                               
         B     GPNREPD                                                          
*                                                                               
GPNREPD  DS     0H                                                              
*                                                                               
GPNREPX  DS     0H                                                              
*                                                                               
         EJECT                                                                  
*=====================================================================*         
*                                                                     *         
*       SUBMEDIA CODE FILTERING                                       *         
*                                                                     *         
*=====================================================================*         
         SPACE 2                                                                
GPNSMD   DS    0H                                                               
*                                                                               
         CLI   PBQSMD,0            SKIP IF NO SUBMEDIA FILTERING                
         BZ    GPNSMDX                                                          
*                                                                               
         MVC   FULL(1),PBQSMD      COPY SUBMEDIA FILTER                         
         OI    FULL,X'40'          RESTORE NEGATIVE FILTER INDICATOR            
*                                                                               
*        FIND PUB PAY ELEMENT IN PUB MASTER RECORD                              
*                                                                               
         L     R6,AIO3             POINT TO PUB MASTER RECORD                   
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
         MVI   ELCODE,PUBPYELQ     SET   TO SEARCH FOR PUB PAY ELM              
*                                                                               
         SR    RF,RF               INIT REGISTER SAVEAREA                       
*                                                                               
GPNSMDLP DS    0H                                                               
*                                                                               
         BRAS  RE,NXTELM           SEARCH FOR A PUB PAY ELM                     
         BNE   GPNSMDDN            NO MORE ELEMENTS                             
*                                                                               
         USING PUBPAYEL,R6         ESTABLISH PUB PAY ELM                        
*                                                                               
         CLC   PBCLT,PUBPYOFF      USE IF IT IS FOR CURRENT CLIENT              
         BNE   *+10                                                             
         LR    RF,R6               SAVE CURRENT ELEMENT POINTER                 
         B     GPNSMDDN            THIS IS ELEMENT TO USE                       
*                                                                               
         CLI   PUBPYOFF,X'FF'      IGNORE IF NOT A SPECIAL CODE                 
         BNE   GPNSMDCN                                                         
*                                                                               
         CLC   PUBPYOFF+1(1),PBCOFF   IF MATCH ON OFFICE                        
         BNE   *+10                                                             
         LR    RF,R6                     SAVE ELEMENT POINTER                   
         B     GPNSMDCN                  CONTINUE LOOKING                       
*                                                                               
         CLC   PUBPYOFF,=X'FFFFFF'  IF IT IS AN ALL AGENCY ELM                  
         BNE   GPNSMDCN                                                         
*                                                                               
         LTR   RF,RF               SKIP IF BETTER ELEMENT FOUND ALREADY         
         BNZ   GPNSMDCN                                                         
*                                                                               
         LR    RF,R6                     SAVE ELEMENT POINTER                   
*                                                                               
GPNSMDCN DS    0H                                                               
         B     GPNSMDLP                                                         
*                                                                               
*        ANALYZE RESULTS OF SEARCH                                              
*                                                                               
GPNSMDDN DS    0H                                                               
*                                                                               
         LTR   R6,RF               GET SAVED POINTER                            
         BZ    GPNSMDNF            NO PUBPYELM FOUND                            
*                                                                               
         CLI   PUBPYSMD,0          CHECK IF NO SUBMEDIA                         
         BE    GPNSMDNF                                                         
*                                                                               
*        WE HAVE SOME KIND OF SUBMEDIA CODE                                     
*                                                                               
         CLI   FULL,PBQNONEQ       IF REPORTING ALL WITHOUT SMED                
         BNE   GPNSMD10                                                         
*                                                                               
         TM    PBQSMD,X'40'           IF NEGATIVE FILTER                        
         BNO   GPNSMDX                   KEEP                                   
         B     GPNDROP                ELSE DROP PUB FROM REPORT                 
*                                                                               
GPNSMD10 DS    0H                                                               
*                                                                               
         CLI   FULL,PBQONLYQ       IF REPORTING ONLY PUBS WITH SMED             
         BNE   GPNSMD20                                                         
*                                                                               
         TM    PBQSMD,X'40'           IF NEGATIVE FILTER                        
         BNO   GPNDROP                   DROP                                   
         B     GPNSMDX                ELSE KEEP PUB                             
*                                                                               
GPNSMD20 DS    0H                                                               
*                                                                               
         CLC   PUBPYSMD,FULL       IF SUBMEDIA MATCHES FILTER                   
         BNE   GPNSMD30                                                         
*                                                                               
         TM    PBQSMD,X'40'           IF NEGATIVE FILTER                        
         BNO   GPNDROP                   DROP                                   
         B     GPNSMDX                ELSE KEEP PUB                             
*                                                                               
GPNSMD30 DS    0H                  SUBMEDIA DOES NOT MATCH FILTER               
*                                                                               
         TM    PBQSMD,X'40'           IF NEGATIVE FILTER                        
         BNO   GPNSMDX                   KEEP                                   
         B     GPNDROP                ELSE DROP PUB                             
*                                                                               
GPNSMDNF DS     0H                 WE HAVE NO SUBMEDIA CODE                     
*                                                                               
         CLI   FULL,PBQNONEQ       IF REPORTING ALL WITHOUT SMED                
         BNE   GPNSMD40                                                         
*                                                                               
         TM    PBQSMD,X'40'           IF NEGATIVE FILTER                        
         BNO   GPNDROP                   DROP                                   
         B     GPNSMDX                ELSE KEEP PUB FROM REPORT                 
*                                                                               
GPNSMD40 DS    0H                                                               
*                                                                               
         CLI   FULL,PBQONLYQ       IF REPORTING ONLY PUBS WITH SMED             
         BNE   GPNSMD50                                                         
*                                                                               
         TM    PBQSMD,X'40'           IF NEGATIVE FILTER                        
         BNO   GPNSMDX                   KEEP                                   
         B     GPNDROP                ELSE DROP PUB                             
*                                                                               
GPNSMD50 DS    0H                  FILTERING ON SINGLE SUBMEDIA                 
*                                                                               
         TM    PBQSMD,X'40'           IF NEGATIVE FILTER                        
         BNO   GPNSMDX                   KEEP                                   
         B     GPNDROP                ELSE DROP PUB                             
*                                                                               
GPNSMDX  DS     0H                                                              
*                                                                               
         EJECT                                                                  
*                                                                               
         MVC   IOKEY(64),0(RA)     RESTORE SAVED INCOMING KEY                   
*                                                                               
GPNNAM   DS    0H                                                               
*                                                                               
         L     R6,AIO3             POINT TO PUB MASTER RECORD                   
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
         MVI   ELCODE,X'10'        SET PUB NAME ELEMENT CODE                    
*                                                                               
         CLI   0(R6),X'10'         DONE IF PUB NAME ELEMENT FIRST               
         BE    GPNNAM1                                                          
*                                                                               
         BAS   RE,NXTELM           ELSE FIND IT                                 
         BE    *+6                                                              
         DC    H'0'                ERROR IF NOT FOUND                           
*                                                                               
GPNNAM1 DS     0H                                                               
*                                                                               
         USING PUBNAMD,R6          ESTABLISH PUBNAME ELEMENT                    
*                                                                               
         TM    PBQOPTS2,PBQOPLKY   PUBLOCK = Y?                                 
         BZ    *+12                NO                                           
         TM    PUBLOCSW,PUBLCKDQ   YES - IS THE PUB LOCKED?                     
         BZ    GPNDROP             NO - DROP THIS PUB                           
*                                                                               
         TM    PBQOPTS2,PBQOPLKN   PUBLOCK = N?                                 
         BZ    *+12                NO                                           
         TM    PUBLOCSW,PUBLCKDQ   YES - IS THE PUB LOCKED?                     
         BNZ   GPNDROP             YES - DROP THIS PUB                          
*                                                                               
         MVI   PBPUBLOC,C'N'       INIT PUB LOCK TO "N"                         
         TM    PUBLOCSW,PUBLCKDQ   IS THE PUB LOCKED?                           
         BZ    *+8                 NO                                           
         MVI   PBPUBLOC,C'Y'       YES - SET PUB LOCK TO "Y"                    
*                                                                               
         MVC   PBPUBNM,PUBNAME       NAME OF PUB                                
**                                                                              
**  SEE IF PUBLISHER RECORD HAS TO BE READ (ADDRESS IN PBPBLSHA)                
**                                                                              
         OC    PBPBLSHA,PBPBLSHA     SKIP IF NO ADDRESS GIVEN                   
         BZ    GPNPBLX                                                          
*                                                                               
*  IS PUBLISHER RECORD THERE                                                    
*                                                                               
         L     RF,PBPBLSHA           POINT TO PUBLISHER RECORD                  
*                                                                               
         OC    PUBPLSH,PUBPLSH     IF PUB HAS NO PUBLISHER                      
         BNZ   *+14                                                             
         XC    0(150,RF),0(RF)        CLEAR PUBLISHER SAVEAREA                  
         B     GPNPBLX                AND EXIT                                  
*                                                                               
         CLC   PUBPLSH,PREPKREP-PREPKEY(RF) SKIP IF PUBLISHER IS IN             
         BE    GPNPBLX                RECORD SAVEAREA                           
*                                                                               
         XC    0(150,RF),0(RF)       CLEAR PUBLISHER SAVEAREA                   
*                                                                               
         XC    IOKEY,IOKEY         INITIALIZE KEY AREA                          
*                                                                               
         L     R2,AIO3             ADDRESS OF PUB      RECORD                   
         USING PUBRECD,R2          ESTABLISH  PUB      RECORD                   
*                                                                               
         MVC   PREPKAGY-PREPREC+IOKEY,PUBKAGY  AGENCY                           
         MVC   PREPKMED-PREPREC+IOKEY,PUBKMED  MEDIA                            
         MVI   PREPKRCD-PREPREC+IOKEY,X'11'    REP RECORD CODE                  
*                                                                               
         MVC   PREPKREP-PREPREC+IOKEY,PUBPLSH SET PUBLISHER'S CODE              
*                                                                               
         GOTO1 AIO,IOPRTDIR+IO1+IOHI                                            
*                                                                               
         CLC   IOKEY(10),IOKEYSAV  SAME PUBLISHER                               
         BNE   GPNPBLX                                                          
*****    BE    *+6                                                              
*****    DC    H'0'                MUST FIND RECORD                             
*                                                                               
         MVC   ADDSAVE,AIO1        SAVE CURRENT AIO1 ADDRESS                    
*                                                                               
         L     RF,PBPBLSHA         CHANGE AIO1 TO USE PUBLISHER SAVE            
         ST    RF,AIO1               SAVEAREA                                   
*                                                                               
         GOTO1 AIO,IOPRTFIL+IO1+IOGET READ IN PUBLISHER RECORD                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   AIO1,ADDSAVE        RESTORE AIO1 ADDRESS                         
*                                                                               
GPNPBLX DS     0H                                                               
*                                                                               
         MVC   IOKEY(64),0(RA)     RESTORE CURRENT RECORD KEY                   
*                                                                               
         CLI   PBQADVSW,C'Y'       IF AN ADVERTISER REPORT                      
*****    BE    *+8                                                              
*****    CLI   PBQCLTSW,C'Y'          OR ADVERTISER CLIENT REPORT               
         BNE   *+14                                                             
         L     RF,PBUTLA           RESTORE CURRENT AGENCY FILES                 
         MVC   4(1,RF),PAOSE                                                    
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL  RE-POINT TO CURRENT RECORD             
*                                                                               
GPNX     DS    0H                                                               
         CR    RB,RB               NORMAL EXIT CC EQ                            
         XIT1                                                                   
*                                                                               
GPNDROP  DS    0H                                                               
*                                                                               
         MVC   IOKEY(64),0(RA)     RESTORE CURRENT RECORD KEY                   
*                                                                               
         CLI   PBQADVSW,C'Y'       IF AN ADVERTISER REPORT                      
*****    BE    *+8                                                              
*****    CLI   PBQCLTSW,C'Y'          OR ADVERTISER CLIENT REPORT               
         BNE   *+14                                                             
         L     RF,PBUTLA           RESTORE CURRENT AGENCY FILES                 
         MVC   4(1,RF),PAOSE                                                    
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL  RE-POINT TO CURRENT RECORD             
*                                                                               
         LTR   RB,RB               BAD FILTERING CC NEQ                         
         XIT1                                                                   
*                                                                               
ADDSAVE  DS    F                                                                
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
GPNR1SAV DS    F                   R1 SAVEAREA                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GET BILL HEADER TABLE ENTRY -GETBHD'         
*=====================================================================*         
*                                                                     *         
*        SUBROUTINE MATCHES BUY BILL ELEMENT TO BILL HEADER RECORD    *         
*           STORED IN A TABLE                                         *         
*                                                                     *         
*        IT SEARCHES TABLE FOR BILL HEADER RECORD                     *         
*                                                                     *         
*NTRY    PBBLLELA ==> BILL ELEMENT                                    *         
*        AIO1     ==> BUY RECORD                                      *         
*                                                                     *         
*EXIT    PBBHDELA ==> MATCHING BILL HEADER TABLE ENTRY                *         
*                                                                     *         
*=====================================================================*         
         SPACE 2                                                                
         DS    0D                                                               
GETBHD   NMOD1 0,**#GBHD*                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    PBBHDELA,PBBHDELA   INIT RETURNED ELEMENT ADDRESS                
*                                                                               
         L     RA,PBBLLELA         ESTABLISH BUY BILL ELEMENT                   
         USING PBILELD,RA                                                       
*                                                                               
         XC    GBHSAVE,GBHSAVE     SAVE CURRENT KEY                             
*                                                                               
         OC    PBINVNO,PBINVNO     SKIP IF NOT BILLED                           
         BZ    GETBHDX                                                          
*                                                                               
         L     R2,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R2                                                      
*                                                                               
*        RETRIEVE BILL HEADER FROM TSAROFF BUFFER                               
*                                                                               
         LA    R6,CSHIERC          POINT TO CASHIER CONTROL BLOCK               
         USING CSHIERD,R6          ESTABLISH AREA                               
*                                                                               
         MVI   CSHACT,CSHRDHQ      SET ACTION TO READ HIGH                      
         MVC   CSHAGYCH,PBAGY      SET AGENCY ALPHA                             
         MVC   CSHMED,PBMED        SET MEDIA                                    
*                                                                               
*        BUILD BILL RECORD KEY FROM BILL ELEMENT                                
*                                                                               
         MVC   GBHSAVE,IOKEY       SAVE CURRENT KEY                             
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R3,IOKEY            ESTABLISH BILL KEY                           
         USING PBILLREC,R3                                                      
*                                                                               
         MVC   PBILKAGY,PBAGY      SET AGENCY                                   
         MVC   PBILKMED,PBMED      SET MEDIA                                    
         MVI   PBILKRCD,PBILKIDQ   SET AS BILL RECORD                           
         MVC   PBILKCLT,PBUYKCLT   SET CLIENT                                   
         MVC   PBILKPRD,PBPRD      SET PRODUCT                                  
         MVC   PBILKEST,PBUYKEST   SET ESTIMATE                                 
         MVC   PBILKMOS,PBDBDATE   SET MONTH OF SERVICE                         
         MVC   PBILKBMN,PBLDATE    SET INVOIICE BILL MONTH                      
         MVC   PBILKBNO,PBINVNO    SET INVOICE NUMBER                           
*                                                                               
         ST    R3,CSHBLLA          SET A(BILLKEY)                               
*                                                                               
         GOTO1 VCASHIER,PARM,CSHIERD    READ BILL RECORD                        
*                                                                               
GBHBHDLP DS    0H                                                               
*                                                                               
         ICM   RF,15,CSHRECA       POINT TO FOUND RECORD                        
         BZ    GBHIVDRP              NOT FOUND                                  
*                                                                               
         CLC   PBILLKEY,0(RF)      CHECK IF RECORD FOUND                        
         BE    GBHBHDFD                                                         
*                                                                               
*        BILL RECORD NOT FOUND                                                  
*        IF BILL WAS REVERSED OR A REVERSAL THEN BILLABLE DATE                  
*        MAY HAVE BEEN CHANGED AND NEED TO MATCH TO BILL DATE                   
*                                                                               
GBHREV   DS    0H                                                               
*                                                                               
         TM    PBBILST,X'C0'       MUST BE REVERSED OR REVERSAL                 
         BZ    GBHIVDRP              BILL NOT FOUND                             
*                                                                               
         XC    PBILKMOS,PBILKMOS   CLEAR MOS                                    
         XC    PBILKBMN,PBILKBMN   CLEAR INVOIICE BILL MONTH                    
         XC    PBILKBNO,PBILKBNO   CLEAR INVOICE NUMBER                         
*                                                                               
         L     RF,PBCOMFAC         GET DATCON ADDRESS                           
         L     RF,CDATCON-COMFACSD(RF)                                          
*                                                                               
         GOTO1 (RF),GBHPRMS,(3,PBLDATE),GBHBDATE CONVERT BILL DATE              
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL  READ BILL HEADERS                      
*                                                                               
GBHREVLP DS    0H                                                               
*                                                                               
         CLC   PBILLKEY(PBILKMOS-PBILLKEY),IOKEYSAV CHK CHNG BASE KEY           
         BE    *+6                                                              
         DC    H'0'                SHOULD NOT HAPPEN                            
*                                                                               
         CLC   PBILKBNO,PBINVNO    MATCH INV NO.                                
         BNE   GBHREVCN                                                         
*                                                                               
         GOTO1 AIO,IOPRTFIL+IO2+IOGET READ IN BILL RECORD                       
*                                                                               
         L     RF,AIO2             POINT TO FOUND RECORD                        
*                                                                               
         CLC   PBILLDAT-PBILLKEY(L'PBILLDAT,RF),GBHBDATE MATCH BDATE            
         BE    GBHREVFD                                                         
*                                                                               
GBHREVCN DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ+IORDEL   READ SEQUENTIAL                       
*                                                                               
         B     GBHREVLP                                                         
*                                                                               
GBHREVFD DS    0H                                                               
*                                                                               
         MVI   CSHACT,CSHRDHQ      SET ACTION TO READ HIGH                      
*                                                                               
         ST    R3,CSHBLLA          SET A(BILLKEY)                               
*                                                                               
         GOTO1 VCASHIER,PARM,CSHIERD    READ FOR BILL RECORD                    
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RESTORE FILE POINTERS                        
*                                                                               
         L     RF,CSHRECA          POINT TO FOUND RECORD                        
*                                                                               
         CLC   PBILLKEY,0(RF)      CHECK IF RECORD FOUND                        
         BE    GBHBHDFD                                                         
*                                  NOT FOUND                                    
*                                                                               
*        ADD BILL HEADER TO BUFFER                                              
*                                                                               
         MVI   CSHACT,CSHADDQ      SET ACTION                                   
         MVC   CSHMED,PBMED        SET MEDIA                                    
         MVC   CSHBLLA,AIO2        SET BILL RECORD ADDRESS                      
*                                                                               
         GOTO1 VCASHIER,PARM,CSHIERD    ADD BILL RECORD TO BUFFER               
*                                                                               
         CLI   CSHERR,0            NO ERRORS TOLERATED                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RESTORE FILE POINTERS                        
*                                                                               
GBHBHDFD DS    0H                                                               
*                                                                               
         OC    PBQINVST(12),PBQINVST SKIP IF NOT FILTERING ON INV #'S           
         BZ    GBHIVOK                                                          
*                                                                               
         L     R3,CSHRECA          ESTABLISH BILL HEADER                        
         USING PBILLREC,R3                                                      
*                                                                               
         OC    PBQINVST,PBQINVST   IF THERE IS A STARTING INV NUMBER            
         BZ    GBHIVSTX                                                         
*                                                                               
         CLC   PBILIMO,PBQINVST       MUST NOT BE LOW                           
         BL    GBHIVDRP               DROP RECORD                               
*                                                                               
         PACK  DUB,PBQINVST+2(4)   GET BILL NUMBER                              
         CVB   RF,DUB                                                           
         CLM   RF,3,PBILKBNO       CHECK BILL NUMBER                            
         BH    GBHIVDRP                                                         
*                                                                               
GBHIVSTX DS    0H                                                               
*                                                                               
         OC    PBQINVEN,PBQINVEN   SKIP IF NO END INVOICE NUMBER                
         BZ    GBHIVOK                                                          
*                                                                               
         CLC   PBILIMO,PBQINVEN       MUST NOT BE HIGH                          
         BH    GBHIVDRP               DROP RECORD                               
*                                                                               
         PACK  DUB,PBQINVEN+2(4)   GET BILL NUMBER                              
         CVB   RF,DUB                                                           
         CLM   RF,3,PBILKBNO       CHECK BILL NUMBER                            
         BL    GBHIVDRP                                                         
*                                                                               
GBHIVOK  DS    0H                                                               
*                                                                               
         MVC   PBBHDELA,CSHRECA    RETURN FOUND BILL RECORD ADDRESS             
*                                                                               
GBHIVDRP DS    0H                                                               
*                                                                               
*                                                                               
GETBHDX  DS    0H                                                               
*                                                                               
         OC    GBHSAVE,GBHSAVE     IF RECORDS WERE READ                         
         BZ    GETBHDX1                                                         
*                                                                               
         MVC   IOKEY,GBHSAVE          RESTORE KEY AND FILE POINTERS             
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL  RE-READ BUY POINTER                    
*                                                                               
GETBHDX1 DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
GBHPRMS  DS    2A                  PARAMETER BLOCK                              
GBHBDATE DS    CL6                 CHARACTER BILL DATE                          
GBHSAVE  DS    XL(L'IOKEY)         CURRENT KEY SAVEAREA                         
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GET CLEARANCE ELEMENT -GETCLS'               
*=====================================================================*         
*                                                                     *         
*        SUBROUTINE MATCHES CLEARANCE STATUS TABLE ELEMENT TO         *         
*           BUY PAY ELEMENT                                           *         
*                                                                     *         
*        IT SEARCHES TABLE FOR ELEMENT                                *         
*                                                                     *         
*        TABLE IS CLEARED ON CHANGE OF PUB                            *         
*                                                                     *         
*NTRY    PBPAYELA ==> PAY ELEMENT                                     *         
*        AIO1     ==> BUY RECORD                                      *         
*                                                                     *         
*EXIT    PBCLSELA ==> MATCHING CLEARANCE STATUS TABLE ELEMENT         *         
*                                                                     *         
*=====================================================================*         
         SPACE 2                                                                
         DS    0D                                                               
GETCLS   NMOD1 0,**#GCLS*                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK          RE-ESTABLISH LOCAL WORKAREA                 
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    PBCLSELA,PBCLSELA   INIT RETURNED ELEMENT ADDRESS                
         XC    PBCLINVA,PBCLINVA   INIT CLEARANCE INVOICE ELEMENT ADDR          
*                                                                               
         L     RA,PBPAYELA         ESTABLISH BUY PAY ELEMENT                    
         USING PPAYELD,RA                                                       
*                                                                               
         CLI   PPAYELEM+1,24       MUST HAVE LENGTH 24 FOR CLS DATA             
         BL    GETCLSX               NONE CAN'T DO ANYTHING                     
*                                                                               
         L     R2,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R2                                                      
*                                                                               
         L     R6,PBACLSBF         ESTABLISH CLEARANCE STATUS BUFFER            
         USING CLSBUFD,R6                                                       
*                                                                               
*        CLEAR TABLE WHEN PUB CHANGES                                           
*                                                                               
GCSCLS   DS    0H                                                               
*                                                                               
         CLC   PBUYKMED,PPCLMED-PPCLKEY+CLSKEYBS OKAY IF SAME MEDIA             
         BNE   *+10                                                             
         CLC   PBUYKCLT,PPCLCLT-PPCLKEY+CLSKEYBS OKAY IF SAME CLIENT            
         BNE   *+10                                                             
         CLC   PBUYKPUB,PPCLPUB-PPCLKEY+CLSKEYBS OKAY IF SAME PUB               
         BNE   *+10                                                             
         CLC   PPDDATE,CLSKEYCD    SAME CLEARANCE DATE?                         
         BE    GCSCLSX             YES - ALREADY BUFFERED THESE                 
*                                                                               
         LA    R3,CLSBFENT         SET START OF TABLE                           
         ST    R3,CLSBFSTA                                                      
         MVI   0(R3),0             CLEAR FIRST BYTE                             
*                                                                               
         LR    RF,R3                                                            
         BCTR  RF,0                                                             
         ST    RF,CLSBFENA         SET END OF TABLE                             
*                                                                               
         MVC   CLSKEYSV,IOKEYSVE   SAVE CURRENT KEY                             
         MVC   CLSAIOSV,AIO1       SAVE I/O AREA ADDRESS                        
*                                                                               
         LA    RF,CLSIO            SET TO READ INTO BUFFER AREA                 
         ST    RF,AIO1                                                          
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY BUILD AREA                          
         LA    R8,IOKEY            ESTABLISH KEY AREA AS CLR STATUS KEY         
         USING PPCLRST,R8                                                       
*                                                                               
         MVC   PPCLAGY,PBUYKAGY    AGENCY                                       
         MVC   PPCLMED,PBUYKMED    MEDIA                                        
         MVI   PPCLTYPE,X'25'      RECORD ID                                    
         MVC   PPCLCLT,PBUYKCLT    CLIENT                                       
         MVC   PPCLPUB(4),PBUYKPUB    PUB NUMBER                                
*                                                                               
         MVC   CLSKEYBS,IOKEY      SAVE AS BASIC KEY                            
         MVC   CLSKEYCD,PPDDATE    SAVE CLEARANCE DATE                          
*                                                                               
*        READ CLEARANCE STATUS RECORD POINTER                                   
*                                                                               
         GOTO1 AIO,IOPRTDIR+IO1+IOHI                                            
*                                                                               
GCSCLSLP DS    0H                                                               
*                                                                               
         CLC   IOKEY(PPCLDATE-PPCLRST),IOKEYSAV MUST MATCH PUB                  
         BNE   GCSCLSDN                                                         
*                                                                               
         GOTO1 AIO,IOPRTFIL+IO1+IOGET READ IN RECORD                            
*                                                                               
         L     R8,AIO1             POINT TO CLEARANCE STATUS RECORD             
*                                                                               
         LA    R5,PPCLELEM         POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
GCSDTLLP DS    0H                                                               
*                                                                               
         USING PPCLEL01,R5         ESTABLISH DETAIL ELEMENT                     
*                                                                               
         CLI   PPCLEL01,0          DONE IF END OF RECORD REACHED                
         BE    GCSDTLDN                                                         
*                                                                               
         CLI   PPCLEL01,X'03'      '03' ELEMENT?                                
         BE    GCSDTL05            YES                                          
         CLI   PPCLEL01,X'05'      '05' ELEMENT                                 
         BE    GCSDTL05            YES                                          
         CLI   PPCLEL01,X'01'      '01' ELEMENT?                                
         BNE   GCSDTLCN            NO                                           
*                                                                               
GCSDTL00 CLC   PPDDATE,PPCLCLRD    MATCH ON CLEARED DATE                        
         BE    GCSDTL05            YES - BUFFER X'01'/X'03'/X'05' ELEMS         
*                                                                               
GCSDTL01 LLC   RF,PPCLEL01+1       GET ELEMENT LENGTH                           
         LA    R5,0(RF,R5)         BUMP TO NEXT ELEMENT IN RECORD               
*                                                                               
         CLI   PPCLEL01,0          END OF RECORD REACHED?                       
         BE    GCSDTLDN            YES - DONE                                   
*                                                                               
         CLI   PPCLEL01,X'01'      '01' ELEMENT?                                
         BE    GCSDTL00            YES - TEST CLEARANCE DATE                    
         B     GCSDTL01            NO - BUMP TO NEXT ELEMENT                    
*                                                                               
GCSDTL05 LLC   RF,PPCLEL01+1       GET ELEMENT LENGTH                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),PPCLEL01    SAVE ELEMENT IN TABLE                        
*                                                                               
*        SOME USERS ENTER THE SAME INVOICE NUMBER ON TWO LINES                  
*        OF THE PAY SCREEN. THE MX DOESN'T UPDATE BOTH ENTRIES                  
*        IN THE CLRST RECORD WHEN A CHECK IS CUT. THIS CODE                     
*        SHOULD TAKE CARE OF IT                                                 
*        IT COPIES CHECK DATA TO THE UNMARKED 05 ELM IN THE                     
*        CLRST RECORD                                                           
*                                                                               
         CLI   PPCLEL01,X'01'      IF 01 ELEMENT                                
         BNE   *+20                                                             
         XC    SVELM03,SVELM03        INIT SAVEAREAS                            
         XC    SVELM05,SVELM05                                                  
         B     GCSDTL50                                                         
*                                                                               
         CLI   PPCLEL01,X'03'      IF AN 03 ELEMENT                             
         BNE   GCSDTL10                                                         
*                                  IF A DIFFERENT INVOICE THAN PREVIOUS         
         CLC   PPCLINV-PPCLEL03(L'PPCLINV,R3),PPCLINV-PPCLEL03+SVELM03          
         BE    GCSDTL50               SAME - LEAVE ALONE                        
*                                                                               
         XC    SVELM05,SVELM05        CLEAR LAST 05 ELM                         
         XC    SVELM03,SVELM03        CLEAR LAST 03 ELM                         
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   SVELM03(0),0(R3)       SAVE CURRENT 03 ELM                       
*                                                                               
         B     GCSDTL50                                                         
*                                                                               
GCSDTL10 DS    0H                                                               
*                                                                               
         CLI   PPCLEL01,X'05'      SKIP IF NOT AN 05 ELEMENT                    
         BNE   GCSDTL50                                                         
*                                                                               
         OC    PCL5CHK-PPCLEL05(L'PCL5CHK,R3),PCL5CHK-PPCLEL05(R3)              
         BNZ   GCSDTL40            OKAY IF PAID                                 
*                                                                               
         OC    SVELM05,SVELM05     IF LAST 05 FOR SAME INVOICE                  
         BZ    GCSDTL40                                                         
*                                     COPY CHECK DATA                           
         MVC   PCL5CHK-PPCLEL05(L'PCL5CHK,R3),PCL5CHK-PPCLEL05+SVELM05          
      MVC   PCL5CHDT-PPCLEL05(L'PCL5CHDT,R3),PCL5CHDT-PPCLEL05+SVELM05          
      MVC   PCL5BKDT-PPCLEL05(L'PCL5BKDT,R3),PCL5BKDT-PPCLEL05+SVELM05          
      MVC   PCL5STAT-PPCLEL05(L'PCL5STAT,R3),PCL5STAT-PPCLEL05+SVELM05          
*                                                                               
GCSDTL40 DS    0H                                                               
*                                                                               
         XC    SVELM05,SVELM05        CLEAR LAST 05 ELM                         
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   SVELM05(0),0(R3)       SAVE CURRENT 05 ELM                       
*                                                                               
GCSDTL50 DS    0H                                                               
*                                                                               
         LA    R3,1(RF,R3)         BUMP TABLE POINTER                           
         MVI   0(R3),0             CLEAR NEXT BYTE                              
*                                                                               
GCSDTLCN DS    0H                                                               
*                                                                               
         LLC   RF,PPCLEL01+1       GET ELEMENT LENGTH                           
         LA    R5,0(RF,R5)         BUMP TO NEXT ELEMENT IN RECORD               
         B     GCSDTLLP                                                         
*                                                                               
GCSDTLDN DS    0H                                                               
*                                                                               
GCSCLSCN DS    0H                                                               
*                                                                               
         LA    R8,IOKEY            RE-ESTABLISH KEYAREA                         
*                                                                               
         GOTO1 AIO,IOPRTDIR+IO1+IOSQ   READ NEXT CLEARANCE RECORD               
*                                                                               
         B     GCSCLSLP                                                         
*                                                                               
GCSCLSDN DS    0H                                                               
*                                                                               
         BCTR  R3,0                SET NEW TABLE END                            
         ST    R3,CLSBFENA         SET END OF TABLE                             
         L     RE,PBACLSBF         A(START OF CLEARANCE DATA)                   
         L     RF,PBLCLSBF         BUFFER LENGTH                                
         AR    RE,RF               A(END OF BUFFER)                             
         CR    R3,RE               DID WE BLOW PAST THE CLRST BUFFER?           
         BNH   *+6                 NO                                           
         DC    H'0'                YES - INCREASE BUFFER                        
*                                                                               
         MVC   IOKEY,CLSKEYSV      RESTORE SAVED INCOMING KEY                   
         MVC   AIO1,CLSAIOSV       RESTORE SAVED IOAREA ADDRESS                 
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL  RE-POINT TO CURRENT RECORD             
*                                                                               
GCSCLSX  DS    0H                                                               
*                                                                               
         DROP  R5                                                               
*                                                                               
*        FIND CORRECT ELEMENT IN TABLE                                          
*                                                                               
         LM    R3,R5,CLSBFBXL      LOAD BXLE REGS FOR TABLE                     
         USING PPCLEL01,R3         ESTABLISH ENTRY AS CLEAR ELEMENT             
*                                                                               
         CR    R3,R5               NO POINT IF TABLE EMPTY                      
         BNL   GETCLSX                                                          
*                                                                               
GCSMATLP DS    0H                                                               
*                                                                               
         USING PPCLEL01,R3         ESTABLISH TABLE ENTRY                        
*                                                                               
         CLI   PPCLEL01,X'00'      DONE IF END OF TABLE                         
         BE    GCSMATDN                                                         
*                                                                               
         CLI   PPCLEL01,X'01'      SKIP IF NOT CLEARANCE ELEMENT                
         BNE   GCSMATCN                                                         
*                                                                               
***      CLC   PPDDATE,PPCLCLRD    MATCH ON CLEARED DATE                        
***      BNE   GCSMATCN                                                         
         CLC   PPDSEQNO,PPCLCLSQ   MATCH ON SEQUENCE NUMBER                     
         BNE   GCSMATCN                                                         
*                                                                               
         ST    R3,PBCLSELA         SET CLEARANCE STATUS ELM ADDR                
*                                                                               
         CLI   PBQPRFW0+11,C'Y'    SKIP IF NOT REPORTING CK'S                   
         BNE   GCSMAT10                                                         
*                                                                               
         TM    PPREP,X'80'         IF PAY ELM IS CK                             
         BNO   GCSMAT10               NEED TO SET DUMMY DATA                    
*                                                                               
         MVC   PPCLCHK,=CL6'CHECK'    SET SPECIAL CHECK NUMBER                  
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATCON-COMFACSD(RF)    DATCON ADDRESS                        
         GOTO1 (RF),PARM,(3,PPDDATE),(2,PPCLCHDT)  CLEAR DATE                   
*                                                                               
*        FIX INVOICES PAID AS CASH RECEIPTS                                     
*                                                                               
         TM    PPCLSTAT,X'02'      DONE IF NO 03 ELEMENTS                       
         BNO   GCSMAT10                                                         
*                                                                               
         LR    R5,R3               COPY ELEMENT 1 POINTER                       
         USING PPCLEL05,R5         ESTABLISH INVOECE ELEMENT                    
*                                                                               
GCSMAT03 DS    0H                                                               
*                                                                               
         LLC   RF,PPCLLN05         GET ELEMENT LENGTH                           
         LA    R5,0(RF,R5)         POINT TO NEXT ELEMENT                        
*                                                                               
         CLI   PPCLEL05,X'00'      DONE IF END OF RECORD                        
         BE    GCSMAT10                                                         
*                                                                               
         CLI   PPCLEL05,X'01'      DONE IF NEXT 01 ELM                          
         BE    GCSMAT10                                                         
*                                                                               
         CLI   PPCLEL05,X'05'      SKIP IF NOT 05 ELM                           
         BNE   GCSMAT07                                                         
*                                                                               
         TM    PCL5STAT,PCL5STAT_CK IF CASH RECEIPT                             
         BNO   *+16                                                             
         MVC   PCL5CHK,PPCLCHK        SET SPECIAL CHECK NUMBER                  
         MVC   PCL5CHDT,PPCLCHDT      SET CLEARANCE DATE                        
*                                                                               
GCSMAT07 DS    0H                                                               
*                                                                               
         B     GCSMAT03                                                         
*                                                                               
GCSMAT10 DS    0H                                                               
*                                                                               
         B     GCSMATDN                                                         
*                                                                               
GCSMATCN DS    0H                                                               
*                                                                               
         LLC   R4,PPCLEL01+1       GET ELEMENT LENGTH                           
         BXLE  R3,R4,GCSMATLP      BUMP TO NEXT TABLE ENTRY                     
*                                                                               
GCSMATDN DS    0H                                                               
*                                                                               
GETCLSX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
SVELM03  DS    XL256                                                            
SVELM05  DS    XL256                                                            
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - GETINS INTERFACE - DOGETINS'                
***********************************************************************         
*                                                                     *         
*        GO TO GETINS TO EXPAND BUY                                   *         
*                                                                     *         
*NTRY    R2  ==>   BUYREC                                             *         
*        GETIN     FILTER OPTIONS                                     *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
DOGETINS NMOD1 0,**+DGI**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         USING PBUYREC,R2          ESTABLISH BUY RECORD                         
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    DGIWORK(DGIWORKL),DGIWORK INIT WORKAREA                          
*                                                                               
*        SET ADDITIONAL CHARGES OPTION                                          
*                                                                               
         TM    PBQACHGS,X'FF'-PBQACOPQ   SKIP IF NO ADDL CHGS OPTIONS           
         BZ    DGIACHX                                                          
*                                                                               
         MVC   DGIACOPT,PBQACHGS   DEFAULT TO GLOBAL OPTIONS                    
*                                                                               
         TM    DGIACOPT,PBQACEXQ   IF EXCLUDING ACHGS                           
         BNO   *+12                                                             
         MVI   DGIPARM4,C'X'          SET INDICATOR                             
         B     DGIACHX                                                          
*                                                                               
         TM    DGIACOPT,PBQACXFQ   IF EXCLUDING FX ACHG                         
         BNO   *+12                                                             
         MVI   DGIPARM4,C'F'          SET INDICATOR                             
         B     DGIACHX                                                          
PBQACXFQ EQU   X'04'                                                            
*                                                                               
         TM    DGIACOPT,PBQACLSQ   IF LISTING ACHGS                             
         BNO   *+12                                                             
         MVI   DGIPARM4,C'X'          SET INDICATOR                             
         B     DGIACHX                                                          
*                                                                               
         MVI   DGIPARM4,C'A'       ASSUME GETINS PARM6 ACTIVE                   
*                                                                               
         TM    DGIACOPT,PBQAC1Q    IF ONE SPECIFIC CHARGE                       
         BNO   *+16                                                             
         LA    RF,PBQACHG             POINT TO IT                               
         ST    RF,DGIPARM6            SET IN PARAMETERS                         
         B     DGIACHX                                                          
*                                                                               
         TM    DGIACOPT,PBQACONQ   IF ONLY ADDITIONAL CHARGES                   
         BNO   *+16                                                             
         LA    RF,=C'ALL'             POINT TO IT                               
         ST    RF,DGIPARM6            SET IN PARAMETERS                         
         B     DGIACHX                                                          
*                                                                               
         MVI   DGIPARM4,0          ASSUME GETINS PARM6 NOT ACTIVE               
*                                                                               
DGIACHX  DS    0H                                                               
*                                                                               
*        HANDLE PASSIVE PRODUCT                                                 
*                                                                               
DGIPSV   DS    0H                                                               
*                                                                               
         OC    PASSPRD,PASSPRD     SKIP IF NO PASSIVE PRODUCT                   
         BZ    DGIPSVX                                                          
*                                                                               
         MVC   PBGRS,=C'CRATE'     SET OPTIONS FOR GETINS                       
*                                  GET BUY FINANCIAL DATA                       
         GOTO1 GETINS,PARM,(GETIN,(R2)),PBGRS,(PBQOAPRD,PASSPRD),      X        
               (DGIPARM4,PBQBST),=C'BOTH',DGIPARM6,RR=RELO                      
*                                                                               
         L     R1,16(R1)           POINT TO DATA RETURN AREA                    
*                                                                               
         MVC   GVALUES(GVALUESL),0(R1)   SAVE GST DATA                          
*                                                                               
         LA    RF,PSTAREA-GVALUES(R1) POINT TO PST DATA                         
         LA    RE,PSTAREA          POINT TO PST SAVEAREA                        
         LA    R0,10               10 PROVINCES                                 
*                                                                               
         MVC   0(PSTAREAL,RE),0(RF) SAVE PST DATA                               
         LA    RE,PSTAREAL(RE)                                                  
         LA    RF,PSTAREAL(RF)                                                  
         BCT   R0,*-14                                                          
*                                                                               
         BAS   RE,ADDGST           ADD GST TO APPROPRIATE FIELDS                
*                                                                               
         L     RF,=A(PAYCNT)                                                    
         BAS   RE,CNVERT           CONVERT BINARY FLDS TO PACKED FORMAT         
*                                                                               
*        INIT BUY OPEN RATE FINANCIAL DATA                                      
*                                                                               
         XC    OGROSS(PBVALUEX-PBGRS),OGROSS   ORDERED/PAY/BILL DATA            
         XC    GOVALUE,GOVALUE     GST DATA                                     
*                                                                               
         LA    RF,PSTOAREA         PST DATA                                     
         LA    R0,10               FOR 10 PROVINCES                             
*                                                                               
         XC    0(PSTAREAL,RF),0(RF)                                             
         LA    RF,PSTAREAL(RF)                                                  
         BCT   R0,*-10                                                          
*                                                                               
         CLI   PBFINAN,C'Y'        SKIP IF NOT A FINANCIAL CLIENT               
         BNE   DOGETINX                                                         
*                                                                               
         MVC   OGROSS,=C'CRATE'    SET OPTIONS                                  
*                                  GET OPEN RATE FINANCIAL DATA                 
         GOTO1 GETINS,PARM,(GETIN,(R2)),(C'O',OGROSS),                 X        
               (PBQOAPRD,PASSPRD),                                     X        
               (DGIPARM4,PBQBST),=C'BOTH',DGIPARM6,RR=RELO                      
*                                                                               
         L     R1,16(R1)           POINT TO RETURNED DTA                        
*                                                                               
         MVC   GOVALUE(GVALUESL),0(R1)   SAVE GST DATA                          
*                                                                               
         LA    RF,PSTAREA-GVALUES(R1) POINT TO PST DATA                         
         LA    RE,PSTOAREA         POINT TO PST SAVEAREA                        
         LA    R0,10               10 PROVINCES                                 
*                                                                               
         MVC   0(PSTAREAL,RE),0(RF) SAVE PST DATA                               
         LA    RE,PSTAREAL(RE)                                                  
         LA    RF,PSTAREAL(RF)                                                  
         BCT   R0,*-14                                                          
*                                                                               
         L     RF,=A(OPAYCNT)                                     L06           
         BAS   RE,CNVERT           CONVERT DATA TO PACKED FORMAT  L06           
*                                                                               
         B     DOGETINX            DONE                                         
*                                                                               
DGIPSVX  DS    0H                                                               
*                                                                               
*        HANDLE ACTIVE PRODUCT                                                  
*                                                                               
         MVC   PBGRS,=C'CRATE'     GET BUY FINANCIAL DATA                       
         GOTO1 GETINS,PARM,(GETIN,(R2)),PBGRS,                         X        
               (PBQOAPRD,PBUYKPRD),                                    X        
               (DGIPARM4,PBQBST),=C'BOTH',DGIPARM6,RR=RELO                      
*                                                                               
         L     R1,16(R1)           POINT TO RETURNED DATA                       
*                                                                               
         MVC   GVALUES(GVALUESL),0(R1)   SAVE GST DATA                          
*                                                                               
         LA    RF,PSTAREA-GVALUES(R1) POINT TO PST DATA                         
         LA    RE,PSTAREA          POINT TO PST SAVEAREA                        
         LA    R0,10               10 PROVINCES                                 
*                                                                               
         MVC   0(PSTAREAL,RE),0(RF) SAVE PST DATA                               
         LA    RE,PSTAREAL(RE)                                                  
         LA    RF,PSTAREAL(RF)                                                  
         BCT   R0,*-14                                                          
*                                                                               
         BAS   RE,ADDGST           ADD GST TO APPROPRIATE DATA     L08          
*                                                                               
         L     RF,=A(PAYCNT)                                       L06          
         BAS   RE,CNVERT           CONVERT TO PACKED FORMAT        L06          
*                                                                               
*        INIT BUY OPEN RATE FINANCIAL DATA                                      
*                                                                               
         XC    OGROSS(PBVALUEX-PBGRS),OGROSS   ORDERED/PAY/BILL DATA            
         XC    GOVALUE,GOVALUE     GST DATA                                     
*                                                                               
         LA    RF,PSTOAREA         PST DATA                                     
         LA    R0,10               FOR 10 PROVINCES                             
*                                                                               
         XC    0(PSTAREAL,RF),0(RF)                                             
         LA    RF,PSTAREAL(RF)                                                  
         BCT   R0,*-10                                                          
*                                                                               
         MVC   OGROSS,=C'CRATE'    SET OPTIONS                                  
*                                                                               
         CLI   PBFINAN,C'Y'        SKIP IF NOT A FINANCIAL CLIENT               
         BNE   DOGETINX                                                         
*                                  GET OPEN RATE DATA                           
         GOTO1 GETINS,PARM,(GETIN,(R2)),(C'O',OGROSS),                 X        
               (PBQOAPRD,PBUYKPRD),                                    X        
               (DGIPARM4,PBQBST),=C'BOTH',DGIPARM6,RR=RELO                      
*                                                                               
         L     R1,16(R1)                                                        
*                                                                               
         MVC   GOVALUE(GVALUESL),0(R1)   SAVE GST DATA                          
*                                                                               
         LA    RF,PSTAREA-GVALUES(R1) POINT TO PST DATA                         
         LA    RE,PSTOAREA         POINT TO PST SAVEAREA                        
         LA    R0,10               10 PROVINCES                                 
*                                                                               
         MVC   0(PSTAREAL,RE),0(RF) SAVE PST DATA                               
         LA    RE,PSTAREAL(RE)                                                  
         LA    RF,PSTAREAL(RF)                                                  
         BCT   R0,*-14                                                          
*                                                                               
         L     RF,=A(OPAYCNT)                                   L06             
         BAS   RE,CNVERT           CONVERT TO PACKED FORMAT        L06          
*                                                                               
DOGETINX DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        ADD GST TO APPROPIATE FIELDS                                 *         
*                                                                     *         
*        THIS ROUTINE IS PROBABLY NEVER ENTERED                       *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ADDGST   NTR1                                                                   
*                                                                               
         CLI   PBQADDGS,C'O'                                      L08           
         BNE   ADDGSTX             EXIT IF GST NOT APPLICABLE     L08           
*                                                                               
         L     RF,PBGRS            GROSS                          L08           
         A     RF,GSTTAX           ADD GST                        L08           
         ST    RF,PBGRS                                           L08           
*                                                                               
         L     RF,PBPGROSS         PAID GROSS                     L08           
         A     RF,GSTTAXPD          ADD ON PAID GST                             
         ST    RF,PBPGROSS                                        L08           
*                                  PAID GROSS                                   
         S     RF,PBPAGCOM           LESS PAID COMMISSION                       
         S     RF,PBPCSHDS           LESS PAID CD                               
*                                                                               
         L     RE,PBGRS            GROSS                                        
         S     RE,PBGYCOM            LESS COMMISSION                            
         S     RE,PBCD                LESS CD                                   
*                                                                               
         SR    RE,RF                                                            
         ST    RE,PBPYABLE            PAYABLE GROSS                             
*                                                                               
         L     RF,PBPAID           ACUTAL PAID                    L08           
         A     RF,GSTTAXPD           PLUS GST PAID                L08           
         ST    RF,PBPAID                                          L08           
*                                                                               
         L     RF,PBBGROSS         BILLED GROSS                   L08           
         A     RF,GSTTAXBL         BILLED GST                     L08           
         ST    RF,PBBGROSS                                        L08           
*                                                                               
         L     RF,PBBILLED         BILLED                         L08           
         A     RF,GSTTAXBL         BILLED GST                     L08           
         ST    RF,PBBILLED                                        L08           
*                                                                               
         L     RF,PBBILLED         BILLED W/GST                   L08           
         A     RF,PBBAGCOM           PLUS AGENCY COMMISSION                     
*                                                                               
         L     RE,PBGRS            GROSS                                        
         S     RE,PBCD               LESS CD                                    
*                                                                               
         SR    RE,RF                                                            
         ST    RE,PBBLABLE         BILLABLE                       L08           
*                                                                               
ADDGSTX  DS    0H                                                 L08           
         XIT1                                                                   
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        CONVERT BINARY FIELDS TO PACKED FORMAT                       *         
*                                                                     *         
*NTRY    R1  ==>   PACKED FORMAT FIELDS                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
CNVERT   NTR1                      CONVERT COUNTS                               
*                                                                               
         L     RE,0(R1)            PAY COUNTS                                   
         CVD   RE,DUB                                                           
         ZAP   0(3,RF),DUB                                                      
*                                                                               
         L     RE,4(R1)            BILL COUNTS                                  
         CVD   RE,DUB                                                           
         ZAP   3(3,RF),DUB                                                      
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
DGIWORK  DS    0D                  WORKAREAS                                    
DGIPARM6 DS    A                   A(PARM 6 FOR GETINS)                         
DGIACOPT DS    XL1                 ADDL CHGS OPTIONS WORKAREA                   
DGIPARM4 DS    XL1                 PARM 4-0 IN GETINS CALL                      
DGIWORKL EQU   *-DGIWORK           LENGTH OF WORKAREAS                          
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - FILTER ON PUBLISHER - PBLFLTR'              
***********************************************************************         
*                                                                     *         
*        FILTER PUBS BASED ON PUBLISHER                               *         
*                                                                     *         
*NTRY    R2 ==> BUY RECORD                                            *         
*                                                                     *         
*EXIT    IO2    CONTAINS CONTRACT RECORD OR A DUMMY ONE               *         
*                                                                     *         
*        NEQ CC MEANS END OF PUBS REACHED                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
PBLFLTR  NMOD1 0,**+FPB**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
*        FIND A PUBLICATION FOR A REQUESTED PUBLISHER                           
*        THIS ROUTINE WILL INSERT A PUB NUMBER IN "PBQPUB" THAT HAS AN          
*        ASSOCIATED REP.. SINCE NO PUB CAN BE REQUESTED IN CONJUCNTION          
*          WITH A PUB. PROGRAM LOGIC WILL THEN THINK THIS IS A SPECIFIC         
*            PUB REQUEST.                                                       
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   EXIT IF NO FILTERING BEING DONE              
         BZ    PBFOKAY                                                          
*                                                                               
         XC    IOKEY,IOKEY         ESTABLISH KEY AREA AS PUB RECORD             
         LA    R2,IOKEY                                                         
         USING PUBRECD,R2                                                       
*                                                                               
         MVI   PUBPKCOD,X'F0'      SET REP/PUB PASSIVE PTR CODE                 
         MVI   PUBPKSCD,C'P'       SET PUBLISHER SUB-CODE                       
         MVC   PUBPKAGY,PBAGY      SET AGENCY                                   
         MVC   PUBPKMED,PBMED      SET MEDIA                                    
         MVC   PUBPKREP,PBQPBLSH   SET PUBLISHER                                
         MVC   PUBPKPUB(6),PBQPUB  SET PAST PUB USED                            
*                                                                               
*        ADVERTISER REPORTS REQUIRE SEARCHING AOR FILES                         
*          USING LAST PUB ON ITS FILES AND THEN TRANSLATING                     
*          ANY FOUND PUB TO AGENCY'S PUB                                        
*                                                                               
         CLI   PBQADVSW,C'Y'       SKIP IF NOT ADVERTISER REPORT                
         BNE   PBFADVX                                                          
*                                                                               
         L     RF,PBUTLA           POINT TO UTL                                 
         MVC   4(1,RF),PAORSE      SET FILES TO THOSE OF AOR                    
*                                                                               
         MVC   PUBPKAGY,PAORAGY    SET AOR AGENCY                               
         MVC   PUBPKPUB(6),PAORPUB    SET PUB TO AOR'S                          
*                                                                               
PBFADVX  DS    0H                                                               
*                                                                               
         MVI   PUBPKED+L'PUBPKED,X'FF' FORCE READ OF NEXT PTR                   
*                                                                               
         GOTO1 AIO,IOPUBDIR+IO1+IOHI                                            
*                                                                               
         CLI   PBQADVSW,C'Y'       RESET FILES IF DOING ADVERT REPORT           
         BNE   *+14                                                             
         L     RF,PBUTLA           POINT TO UTL                                 
         MVC   4(1,RF),PAOSE       SET TO AGENCY'S FILES                        
*                                                                               
         CLC   PUBPKEY(PUBPKPUB-PUBPKEY),IOKEYSAV   DONE ON BREAK               
         BNE   PBFEND              IN PUBLISHER                                 
*                                                                               
         MVC   PBQPUB(6),PUBPKPUB                                               
         B     PBFOKAY                                                          
*                                                                               
PBFOKAY  DS    0H                  NORMAL EXIT EQ CC                            
*                                                                               
         CR    RE,RE                                                            
*                                                                               
         B     PBLFLTRX                                                         
*                                                                               
PBFEND   DS    0H                  END OF PUBS FOR PUBLISHER                    
*                                                                               
         XC    PAORPUB,PAORPUB     CLEAR SAVED AOR PUB NO                       
         LTR   RE,RE                 NEQ CC                                     
*                                                                               
PBLFLTRX DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C - PRWRIIO - GET REQUEST FILTERS - GETFLT'               
***********************************************************************         
*                                                                     *         
*        SET UP REQUEST FILTERS                                       *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
GETFLT   NMOD1 0,**+GFL**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         CLI   PBQDATYP,C' '       DEFAULT TO INSERTION DATES                   
         BNE   *+8                   IF NO DATE TYPE GIVEN                      
         MVI   PBQDATYP,C'I'                                                    
*                                                                               
         MVC   PBQSTSV(6),PBQBST   SAVE REQ DATES FOR DATE TEST IN BUYS         
*                                                                               
*        CHECK TO SEE IF PHYSICAL DATE IS PRESENT                               
*                                                                               
GFLDTE   DS    0H                                                               
*                                                                               
         OC    PBQBST(6),PBQBST    SKIP IF REQUEST DATES GIVEN                  
         BNZ   GFLDTEX                                                          
*                                                                               
         CLI   PBQNOPER,C'Y'       IF NO PERIOD SPECIFIED                       
         BNE   GFLDTEX                                                          
*                                                                               
         MVC   PBQBST(6),=X'000000FFFFFF' SET FROM BIG BANG                     
         MVC   PBQSTSV(6),PBQBST      TO ARMAGEDDON                             
         B     GETFLTX                                                          
*                                                                               
GFLDTEX  DS    0H                                                               
*                                                                               
         CLI   PBQDATYP,C'I'                                                    
         BE    GETFLTX              DONE IF INSERTION DATES WANTED              
*                                                                               
*        IF BINARY DATES NOT PRESENT CALCULATE FROM REQUEST DATES               
*                                                                               
         OC    PBQBST(6),PBQBST                                                 
         BNZ   GFTBINX                                                          
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATCON-COMFACSD(RF)    DATCON ADDRESS                        
*                                                                               
         GOTO1 (RF),PARM,PBQSTART,(3,PBQBST)  CONVERT START                     
         GOTO1 (RF),(R1),PBQEND,(3,PBQBEND)   AND END DATES TO BINARY           
*                                                                               
         MVC   PBQSTSV(6),PBQBST      FOR DATE TEST IN BUYS                     
*                                                                               
GFTBINX  DS    0H                                                               
*                                                                               
*        BILLABLE AND PAYABLE DATES HAVE EXTENDED DATE RANGES                   
*                                                                               
GFTRNG   DS    0H                                                               
*                                                                               
         MVC   FULL(4),=AL2(6,3)   6 MONTHS BACK 3 INTO THE FUTURE              
         CLI   PBQDATYP,C'I'        FOR BILLABLE DATES                          
         BE    GFTRNG10                                                         
*                                                                               
         MVC   FULL(4),=AL2(5,5)   PAYABLE USES 5 MONTHS BACK,5 FORWARD         
         CLI   PBQDATYP,C'A'       TEST PAYABLE                                 
         BE    GFTRNG10                                                         
*                                                                               
         XC    FULL,FULL           ALL OTHERS HAVE NO RANGE                     
         B     GETFLTX                                                          
*                                                                               
GFTRNG10 DS    0H                                                               
*                                                                               
         CLI   PBQPRIOR,C'Y'       IF INCLUDING PRIOR YEAR                      
         BNE   GFTRNG20                                                         
*                                                                               
         LH    RE,FULL             BACK UP START DATE 12 MONTHS                 
         LA    RE,12(RE)                                                        
         STH   RE,FULL                                                          
*                                                                               
GFTRNG20 DS    0H                                                               
*                                                                               
*        NOW CALCULATE NEW START AND END DATES                                  
*                                                                               
         ZIC   RF,PBQBST+1         GET START MONTH                              
         SH    RF,FULL             BACK UP                                      
         STC   RF,PBQBST+1                                                      
*                                                                               
GFTRNGSL DS    0H                                                               
*                                                                               
         LTR   RF,RF               SKIP IF POSITIVE START MONTH                 
         BP    GFTRNGSD                                                         
*                                                                               
         LA    RF,12(RF)           ADVANCE MONTH BY 12                          
         STC   RF,PBQBST+1                                                      
*                                                                               
         ZIC   RE,PBQBST           DECREMENT YEAR                               
         BCTR  RE,0                                                             
         STC   RE,PBQBST                                                        
*                                                                               
         B     GFTRNGSL            CHECK WE NOW HAVE VALID MONTH                
*                                                                               
GFTRNGSD DS    0H                                                               
*                                                                               
         ZIC   RF,PBQBEND+1        BUMP END DATE                                
         AH    RF,FULL+2                                                        
         STC   RF,PBQBEND+1                                                     
*                                                                               
GFTRNGEL DS    0H                                                               
*                                                                               
         CLI   PBQBEND+1,12        IF MONTH PAST DECEMBER                       
         BNH   GFTRNGED                                                         
*                                                                               
         SH    RF,=H'12'              BACK MONTH UP A YEAR                      
         STC   RF,PBQBEND+1                                                     
*                                                                               
         ZIC   RE,PBQBEND          ADD 1 TO YEAR                                
         LA    RE,1(RE)                                                         
         STC   RE,PBQBEND                                                       
*                                                                               
         B     GFTRNGEL            REPEAT CALCULATION                           
*                                                                               
GFTRNGED DS    0H                                                               
*                                                                               
         MVI   PBQBST+2,1          USE FIRST TO LAST DAYS OF MONTHS             
         MVI   PBQBEND+2,31                                                     
*                                                                               
GETFLTX  DS    0H                                                               
*                                                                               
         MVC   KEYBST,PBQBST       USE MODIFIED DATES FOR KEY FILTER            
         MVC   KEYBEN,PBQBEND                                                   
         MVC   PBQBST(6),PBQSTSV   RESTORE REAL DATES                           
         CR    RB,RB                                                            
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C- PRWRIIO - GET CONTRACT - BUY FLAVOR - GETCON'          
***********************************************************************         
*                                                                     *         
*        FIND CONTRACT FOR GIVEN BUY RECORD                           *         
*                                                                     *         
*        IF CONTRACT HAS BEEN READ IN ALREADY                         *         
*           USE IT                                                    *         
*        ELSE                                                         *         
*           SEARCH TABLE FOR CORRECT CONTRACT                         *         
*             IF FOUND                                                *         
*                READ IT INTO IO2.                                    *         
*             ELSE                                                    *         
*                DUMMY UP A CONTRACT RECORD                           *         
*                                                                     *         
*NTRY    R2 ==> BUY RECORD                                            *         
*                                                                     *         
*EXIT    IO2    CONTAINS CONTRACT RECORD OR A DUMMY ONE               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
GETCON   NMOD1 0,**+GCN**                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         USING PBUYRECD,R2         R2 ==> BUY/ISSUE RECORD                      
*                                                                               
         XC    GCNPUB(6),GCNPUB    INIT PUB CODE                                
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   IF BUY RECORD IN CORE                        
         BNE   *+16                                                             
         MVC   GCNPUB(6),PBUYKPUB     SET PUB CODE                              
         MVC   GCNDATE,PBUYKDAT       USE INSERT DATE                           
*                                                                               
         CLI   PBUYKRCD,X'29'      IF ISSUE RECORD IN CORE                      
         BNE   *+24                                                             
         MVC   GCNPUB(6),PISSKPUB-PISSREC(R2)   SET PUB CODE                    
         ICM   RF,15,PBISSELA          POINT TO ISSUE ELEMENT                   
         BZ    GETCONX                 NONE AVAILABLE                           
         MVC   GCNDATE,PISSDAT-PISSEL29(RF)   USE ISSUE DATE                    
*                                                                               
         OC    GCNPUB(6),GCNPUB    IF NO PUB                                    
         BNZ   *+8                                                              
         B     GETCONX                EXIT                                      
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF DOING ADVERTISER CLIENT REPORT         
         BNE   GCNAORX                                                          
*                                                                               
         CLC   GCNPUB,PAOPUB       IF AOR PUB NOT SET                           
         BE    GCNAORX                                                          
*                                                                               
         GOTO1 GTAORPUB,PARM,GCNPUB    THEN FIND IT                             
         BNE   GCNCONDN            NOT FOUND                                    
*                                                                               
GCNAORX  DS    0H                                                               
*                                                                               
*        DETERMINE IF CURRENT CONTRACT IN IO2 IS DESIRED ONE                    
*                                                                               
GCNCHK   DS    0H                                                               
*                                                                               
         L     R8,AIO2             ESTABLISH IO2 AS CONTRACT RECORD             
         USING PCONRECD,R8                                                      
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF ADVERTISER CLIENT REPORT               
         BNE   GCNADVX                                                          
*                                                                               
         CLC   PCONKAGY,PAORAGY      MUST MATCH AOR AGENCY                      
         BNE   GCNCHKX                                                          
         CLC   PCONKPUB(6),PAORPUB      AND AOR PUB                             
         BNE   GCNCHKX                                                          
*                                                                               
         B     GCNPUBX             CONTINUE CHECKING                            
*                                                                               
GCNADVX  DS    0H                                                               
*                                                                               
         CLC   PCONKAGY,PBUYKAGY   MUST MATCH AGENCY'S AGENCY                   
         BNE   GCNCHKX                                                          
         CLC   PCONKPUB,GCNPUB     PUB                                          
         BNE   GCNCHKX                                                          
*                                                                               
GCNPUBX  DS    0H                                                               
*                                                                               
         CLC   PCONKMED,PBUYKMED   MUST MATCH MEDIA                             
         BNE   GCNCHKX                                                          
         CLC   PCONKZON,GCNZON     ZONE                                         
         BNE   GCNCHKX                                                          
         CLC   PCONKEDT,GCNEDT     EDITION                                      
         BNE   GCNCHKX                                                          
*                                                                               
         CLC   GCNDATE,PCONSDT     DATE MUST FALL WITHIN CONTRACT'S             
         BL    GCNCHKX                                                          
         CLC   GCNDATE,PCONEDT        START AND END DATES                       
         BH    GCNCHKX                                                          
*                                                                               
         B     GETCONX             USE THIS CONTRACT                            
*                                                                               
GCNCHKX  DS    0H                                                               
*                                                                               
*        SEARCH CONTRACT TABLE FOR CONTRACT ENTRY                               
*                                                                               
         L     R3,PBACONTB         ESTABLISH CONTRACT TABLE ENTRY               
         USING CONTTABL,R3                                                      
*                                                                               
GCNCONLP DS    0H                                                               
*                                                                               
         OC    CONTTABL(CONTNLEN),CONTTABL  DONE IF END OF TABLE                
         BZ    GCNCONDN                                                         
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF ADVERTISER CLIENT REPORT               
         BNE   GCNCON10                                                         
*                                                                               
         CLC   CONTNPUB,PAORPUB      MATCH CONTRACT PUB TO AOR PUB              
         BNE   GCNCONCN                                                         
         CLC   CONTNZO,PAORZON       ZONE                                       
         BNE   GCNCONCN                                                         
         CLC   CONTNED,PAORED        EDITION                                    
         BNE   GCNCONCN                                                         
*                                                                               
         B     GCNCON12                                                         
*                                                                               
GCNCON10 DS    0H                                                               
*                                                                               
         CLC   CONTNPUB,GCNPUB     ELSE MATCH CONTRACT PUB TO RECRD PUB         
         BNE   GCNCONCN                                                         
*                                                                               
         CLC   CONTNZO,GCNZON      ZONE                                         
         BNE   GCNCONCN                                                         
*                                                                               
         CLC   CONTNED,GCNEDT      EDITION                                      
         BNE   GCNCONCN                                                         
*                                                                               
GCNCON12 DS    0H                                                               
*                                                                               
         CLC   GCNDATE,CONTNST     BUY DATE TO CONTRACT PERIOD                  
         BL    GCNCONCN                                                         
         CLC   GCNDATE,CONTNEN                                                  
         BH    GCNCONCN                                                         
*                                                                               
         B     GCNCONFD            CONTRACT FOUND                               
*                                                                               
GCNCONCN DS    0H                                                               
*                                                                               
         LA    R3,CONTNLEN(R3)     BUMP TO NEXT TABLE ENTRY                     
         B     GCNCONLP                                                         
*                                                                               
GCNCONDN DS    0H                                                               
*                                                                               
*        NO CONTRACT FOUND BUILD A DUMMY ONE                                    
*                                                                               
         L     R8,AIO2             ESTABLISH CONTRACT RECORD IN IO2             
         USING PCONRECD,R8                                                      
*                                                                               
         MVC   PCONKAGY,PBUYKAGY   PUB'S AGENCY                                 
         MVC   PCONKMED,PBUYKMED   MEDIA                                        
         MVI   PCONKRCD,PCONKIDQ   RECORD IDENTIFIER                            
         MVC   PCONKCLT,PBCLT      CLIENT                                       
         MVC   PCONKPUB,GCNPUB     PUB                                          
         MVC   PCONKZON,GCNZON     ZONE                                         
         MVC   PCONKEDT,GCNEDT     EDITION                                      
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF DOING ADVERTISER CLIENT REPORT         
         BNE   GCNCON50                                                         
*                                                                               
         MVC   PCONKAGY,PAORAGY      USE AOR'S AGENCY                           
         GOTO1 GTAORPUB,PARM,PCONKPUB   FIND AOR PUB ID                         
         MVC   PCONKPUB(6),PAORPUB      USE AOR'S PUB                           
*                                                                               
GCNCON50 DS    0H                                                               
*                                                                               
         MVC   PCONNUM,=X'FFFF'        NO CONTRACT NUMBER                       
         MVC   PCONLEN,=X'0058'   X'33' + 25 RECORD LENGTH                      
*                                                                               
         XC    PCONDESC(50),PCONDESC  INIT DESCRIPTION ELEMENT                  
*                                                                               
         MVC   PCONDESC(2),=X'1025' ELEMENT ID AND LENGTH                       
         MVC   PCONSDT,GCNDATE     CONTRACT START DATE                          
*                                                                               
         XC    PBQCONDA,PBQCONDA   NO CONTRACT DISK ADDRESS                     
*                                                                               
         B     GETCONX                                                          
*                                                                               
*        CONTRACT FOUND IN TABLE - READ IN RECORD                               
*                                                                               
GCNCONFD DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF ADVERTISER CLIENT REPORT               
         BNE   *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAORSE         SET TO AOR FILES                          
*                                                                               
         MVC   IOKEY+27(4),CONTNADD   SET SAVED DISK ADDRESS                    
         MVC   IODA(4),CONTNADD       SET SAVED DISK ADDRESS                    
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO2                                           
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         MVC   PBQCONDA,IOKEY+27   SAVE CONTRACT DISK ADDRESS                   
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR IF ADVERTISER CLIENT REPORT               
         BNE   *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAOSE          RESET TO AGENCY'S FILES                   
*                                                                               
GETCONX  DS    0H                                                               
         XMOD1                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
GCNPUB   DS    XL4                 PUB NUMBER                                   
GCNZON   DS    XL1                 ZONE                                         
GCNEDT   DS    XL1                 EDITION                                      
*                                                                               
GCNDATE  DS    XL3                 DATE IN BINARY                               
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'T00A4C - PRWRIIO - GET CIRCULATION ELEMENT - GETCRC'            
*=====================================================================*         
*                                                                     *         
*        SUBROUTINE FINDS CIRCULATION ELEMENT THAT COVERS             *         
*           INSERTION DATE OR ISSUE DATE                              *         
*                                                                     *         
*        IT KEEPS RECORD IN CORE THAT COVERS TIME PERIOD AND          *         
*           SEARCHES FOR ELEMENT                                      *         
*                                                                     *         
*NTRY    PBISSELA ==> ISSUE ELEMENT IF NO BUY RECORD                  *         
*        AIO1     ==> BUY RECORD                                      *         
*                                                                     *         
*EXIT    PBCRCELA ==> CIRCULATION ELEMENT                             *         
*                                                                     *         
*=====================================================================*         
         SPACE 2                                                                
         DS    0D                                                               
GETCRC   NMOD1 0,**#GCRC*                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         MVC   GCRCKYSV,IOKEY      SAVE CURRENT KEY                             
*                                                                               
         XC    PBCRHELA,PBCRHELA   INIT CIRC HEADER ELEMENT ADDRESS             
         XC    PBCRCELA,PBCRCELA   INIT CIRC ELEMENT ADDRESS                    
         XC    PBCCRELA,PBCCRELA   INIT CLIENT CIRC ELEMENT ADDRESS             
*                                                                               
         XC    IOKEY,IOKEY         INIT CIRCULATION KEY                         
         LA    R4,IOKEY                                                         
         USING PCRCKEY,R4                                                       
*                                                                               
         MVC   PCRCKMED,PBMED      SET MEDIA                                    
         MVI   PCRCKTYP,PCRCKIDQ   SET RECORD ID                                
         MVC   PCRCKAGY,PBAGY      SET AGENCY                                   
         MVC   PCRCKPUB,PBPUB      SET PUB ID                                   
*                                                                               
         OC    PBISSELA,PBISSELA   USE ISSUE ELEMENT IF WE HAVE ONE             
         BZ    *+14                                                             
         MVC   GCRCDATE,PISSDAT-PISSEL29+PBISSELA  GET DATE                     
         B     GCRCYRX                                                          
*                                                                               
         L     R2,AIO1             POINT TO RECORD IN IOA1                      
*                                                                               
         USING PBUYRECD,R2         ESTABLISH AS BUY RCORD                       
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   MUST BE A BUY RECORD                         
         BNE   GETCRCX                                                          
*                                                                               
         MVC   GCRCDATE,PBUYKDAT   GET INSERT DATE                              
*                                                                               
         DROP  R2                                                               
*                                                                               
GCRCYRX  DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,GCRCDATE         GET YEAR OF DATE                             
*                                                                               
         AH    RF,=H'1900'         ASSUME THIS CENTURY                          
*                                                                               
         CLI   GCRCDATE,70         IF LESS THAN 70 THEN NEXT CENTURY            
         BNL   *+8                                                              
         LA    RF,100(RF)                                                       
*                                                                               
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  PCRCKYR,DUB         SET YEAR                                     
*                                                                               
*        READ CIRCULATION RECORD INTO CORE                                      
*                                                                               
         CLC   PCRCKEY,GCRCREC     SKIP READ IF RECORD IN CORE                  
         BE    GCRCRDX                                                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ CIRCULATION RECORD POINTER              
*                                                                               
         CLC   PCRCKEY(PCRCKSRC-PCRCKEY),IOKEYSAV SKIP IF PUB/YR CHGS           
         BNE   GETCRCX                                                          
*                                                                               
         MVC   FULL,AIO1           SAVE ADDRESS                                 
         LA    RF,GCRCREC          REPLACE WITH LOCAL                           
         ST    RF,AIO1                                                          
*                                                                               
         L     R0,AIO1             CLEAR RECORD AREA                            
         LA    R1,4000                                                          
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO1  READ RECORD                              
*                                                                               
         TM    PBQOPTS,PBQOXCCR    SKIP IF IGNORING CLIENT CIRC DATA            
         BO    *+8                                                              
         BRAS  RE,CLTCRC           FIND CLIENT OVERRIDES                        
*                                                                               
         MVC   AIO1,FULL           RESTORE I/O AREA POINTER                     
*                                                                               
GCRCRDX  DS    0H                                                               
*                                                                               
*        FIND CIRCULATION HEADER ELEMENT                                        
*                                                                               
         LA    R4,GCRCREC          POINT TO CIRCULATION RECORD                  
*                                                                               
         LA    R6,PCRCELEM         POINT TO FIRST ELEMENT                       
         USING PCRHELM,R6          ESTABLISH AS CIRCULATION HEADER ELM          
*                                                                               
         SR    RF,RF                                                            
*                                                                               
         CLI   PCRHELM,0           SKIP IF END OF RECORD REACHED                
         BE    GETCRCX                                                          
         CLI   PCRHELM,PCRHELQ     LOOK FOR HEADER ELEMENT                      
         BE    *+16                                                             
         IC    RF,PCRHLEN          GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     *-24                                                             
*                                                                               
         ST    R6,PBCRHELA         SAVE A(CIRCULATION HEADER)                   
*                                                                               
*        FROM FREQUENCY IN CIRC HEADER                                          
*        DETERMINE DATE RANGE THAT EACH ISSUE DATE APPLIES TO                   
*                                                                               
         MVC   GCRCSTRT,GCRCDATE   START WITH INSERT DATE                       
*                                                                               
         CLI   PCRHFRQ,PCRHFRMQ    IF MONTHLY                                   
         BE    *+8                                                              
         CLI   PCRHFRQ,PCRHFRQQ    OR QUARTERLY                                 
         BNE   GCRCFRMN                                                         
*                                                                               
         MVI   GCRCSTRT+2,0           MAKE DAYS 0 TO 32                         
         MVC   GCRCEND,GCRCSTRT                                                 
         MVI   GCRCEND+2,32                                                     
*                                                                               
         CLI   PCRHFRQ,PCRHFRQQ    IF QUARTERLY                                 
         BNE   GCRCFRQN                                                         
*                                                                               
         SR    RF,RF                                                            
*                                                                               
         IC    RF,GCRCEND+1           GET MONTH                                 
         LA    RF,3(RF)               BUMP BY 3 MONTHS                          
*                                                                               
         CH    RF,=H'12'              IF IN NEXT YEAR                           
         BNH   GCRCFRQX                                                         
*                                                                               
         SH    RF,=H'12'                 GET MONTH IN NEW YEAR                  
         STC   RF,GCRCEND+1              UPDATE ENDDATE MONTH                   
*                                                                               
         IC    RF,GCRCEND                BUMP END DATE YEAR                     
         LA    RF,1(RF)                                                         
         STC   RF,GCRCEND                                                       
*                                                                               
GCRCFRQX DS    0H                                                               
*                                                                               
GCRCFRQN DS    0H                                                               
*                                                                               
         B     GCRCENDX                                                         
*                                                                               
GCRCFRMN DS    0H                                                               
*                                                                               
         CLI   PCRHFRQ,PCRHFRIQ    IF DATES FROM ISSUE RECORD                   
         BE    *+8                                                              
         CLI   PCRHFRQ,PCRHFRXQ    OR ENTERED BY USER                           
         BNE   *+12                                                             
         LA    RF,0                   0 DAYS FORCES EXACT MATCH                 
*                                                                               
         B     GCRCFRIX                                                         
*                                                                               
         CLI   PCRHFRQ,PCRHFRWQ    IF WEEKLY FREQUENCY                          
         BNE   *+12                                                             
         LA    RF,6                   ADD 6 DAYS TO START DATE                  
         B     GCRCFRIX                                                         
*                                                                               
         B     GETCRCX             UNKNOWN FREQUENCY                            
*                                                                               
GCRCFRIX DS    0H                                                               
*                                                                               
         ST    RF,PARM+8           SET NUMBER OF DAYS TO ADD                    
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATCON-COMFACSD(RF)    DATCON ADDRESS                        
         GOTO1 (RF),PARM,(3,GCRCSTRT),(0,GCRCDTST)  CONVERT TO YYMMDD           
*                                                                               
         GOTO1 VADDAY,PARM,GCRCDTST,GCRCDTEN  ADD DAYS TO START DATE            
*                                                                               
         L     RF,PBCOMFAC         COMFACS ADDRESS                              
         L     RF,CDATCON-COMFACSD(RF)    DATCON ADDRESS                        
         GOTO1 (RF),PARM,(0,GCRCDTEN),(3,GCRCEND)  CONVERT TO YMD               
*                                                                               
GCRCENDX DS    0H                                                               
*                                                                               
*        FIND CIRCULATION ELEMENT THAT APPLIES                                  
*                                                                               
         LA    R4,GCRCREC          POINT TO CIRCULATION RECORD                  
*                                                                               
         LA    R6,PCRCELEM         POINT TO FIRST ELEMENT                       
         USING PCRCELM,R6          ESTABLISH AS CIRCULATION ELM                 
*                                                                               
         SR    RF,RF                                                            
*                                                                               
GCRCLOOP DS    0H                                                               
*                                                                               
         CLI   PCRCELM,0           DONE IF END OF RECORD REACHED                
         BE    GCRCDONE                                                         
*                                                                               
         CLI   PCRCELM,PCRCELQ     MUST BE CIRCULATION ELEMENT                  
         BNE   GCRCCONT                                                         
*                                                                               
         CLC   PCRCISS,GCRCSTRT    ISSUE DATE MUST LIE IN DATE RANGE            
         BL    GCRCCONT                                                         
         CLC   PCRCISS,GCRCEND                                                  
         BNH   GCRCFND                                                          
*                                                                               
GCRCCONT DS    0H                                                               
*                                                                               
         IC    RF,PCRCLEN          GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     GCRCLOOP                                                         
*                                                                               
GCRCFND  DS    0H                                                               
*                                                                               
         ST    R6,PBCRCELA         RETURN A(CIRC ELM)                           
*                                                                               
GCRCDONE DS    0H                                                               
*                                                                               
         TM    PBQOPTS,PBQOXCCR    SKIP IF EXCLUDING CLIENT CIRC DATA           
         BO    GCRCCLTX                                                         
*                                                                               
*        FIND CORRESPONDING CLIENT CIRC ELM AT END OF RECORD                    
*                                                                               
         SR    RF,RF                                                            
         LR    R1,R6               START WITH FOUND CIRC ELEMENT                
*                                                                               
         IC    RF,1(R1)            ELEMENT LENGTH                               
         LA    R1,0(RF,R1)         NEXT ELEMENT IN RECORD                       
*                                                                               
GCRCCLTL DS    0H                                                               
*                                                                               
         CLI   0(R1),0             DONE AT END OF RECORD                        
         BE    GCRCCLTD                                                         
*                                                                               
         CLI   0(R1),PCRCELQ+1     LOOKING FOR SPECIAL CLT ELMS                 
         BNE   GCRCCLTC                                                         
*                                                                               
         CLC   PCRCISS,PCRCISS-PCRCELM(R1)  MATCH ON ISSUE DATES                
         BE    GCRCCLTF                                                         
*                                                                               
GCRCCLTC DS    0H                                                               
*                                                                               
         IC    RF,1(R1)            ELEMENT LENGTH                               
         LA    R1,0(RF,R1)         NEXT ELEMENT IN RECORD                       
         B     GCRCCLTL                                                         
*                                                                               
GCRCCLTF DS    0H                                                               
*                                                                               
         ST    R1,PBCCRELA         SAVE A(CLIENT OVERRIDE ELEMENT)              
*                                                                               
GCRCCLTD DS    0H                                                               
*                                                                               
GCRCCLTX DS    0H                                                               
*                                                                               
GETCRCX  DS    0H                                                               
*                                                                               
         MVC   IOKEY,GCRCKYSV      RESTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI+IORDEL   RESTORE FILE POINTERS                 
*                                                                               
         XMOD1                                                                  
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
GCRCKYSV DS    XL(L'IOKEY)         KEY SAVEAREA                                 
GCRCDATE DS    XL3                 BINARY ISSUE DATE                            
GCRCSTRT DS    XL3                 START OF VALID DATE RANGE                    
GCRCEND  DS    XL3                 END OF VALID DATE RANGE                      
GCRCDTST DS    CL6                 START DATE YYMMD                             
GCRCDTEN DS    CL6                 END DATE YYMMDD                              
*                                                                               
         DS    0D                  ALIGNMENT                                    
GCRCREC  DS    XL4000              CIRCULATION RECORD                           
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIIO - FIND CIRC FOR CLIENT - CLTCRC'                        
***********************************************************************         
*                                                                     *         
*        CHECK FOR CLIENT CIRCULATION OVERRIDES AND APPLY             *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
CLTCRC   NMOD1 500,**#CCRC,CLEAR=YES                                            
*                                                                               
         ST    RC,CCRCRECA         SAVE WORKARAEA ADDRESS                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         LA    R4,IOKEY            ESTABLISH CIRC KEY                           
         USING PCRCKEY,R4                                                       
*                                                                               
         MVC   PCRCKCLT,PBCLT      FILL IN CURRENT CLIENT                       
         MVC   CCRCRASV,AIO1       SAVE A(BASIC CIRC RECORD)                    
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   CHECK IF CLIENT EXCEPTIONS EXIST             
*                                                                               
         CLC   PCRCKEY,IOKEYSAV    DONE IF NO CLIENT OVERRIDES                  
         BNE   CCRCDONE                                                         
*                                                                               
         MVC   AIO1,CCRCRECA       READ CLIENT RECORD INTO WORKAREA             
*                                                                               
         ICM   R0,15,AIO1          SAVE CURRENT IOAREA PTR                      
         GOTO1 AIO,IOPRTFIL+IOGET+IO1  READ RECORD                              
         STCM  R0,15,AIO1          RESTORE CURRENT IOAREA PTR                   
*                                                                               
         L     R1,CCRCRASV         POINT TO BASIC CIRC RECORD                   
*                                                                               
         LA    R1,33(R1)           POINT TO 1ST ELM IN BASIC CIRC REC           
         SR    RF,RF                                                            
*                                  FIND END OF BASIC CIRC REC                   
         CLI   0(R1),0                                                          
         BE    *+16                                                             
         IC    RF,1(R1) )             ELEMENT LENGTH                            
         LA    R1,0(RF,R1)            NEXT ELEMENT                              
         B     *-16                                                             
*                                                                               
         L     R2,CCRCRECA         POINT TO CLIENT CIRC REC                     
         LA    R2,33(R2)           POINT TO FIRST ELEMENT                       
*                                                                               
*        ADD CLIENT ELMS TO BASIC RECORD WITH                                   
*        SPECIAL ELEMENT ID                                                     
*                                                                               
CCRCLOOP DS    0H                                                               
*                                                                               
         CLI   0(R2),0             DONE AT END OF RECORD                        
         BE    CCRCDONE                                                         
*                                                                               
         CLI   0(R2),PCRCELQ       SKIP IF NOT CIRC ELEMENT                     
         BNE   CCRCCONT                                                         
*                                                                               
         IC    RF,1(R2)            CLT ELM LENGTH                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(R2)       MOVES CLT ELM TO BASE RE                     
*                                                                               
         MVI   0(R1),PCRCELQ+1     CHANGE ELM ID                                
*                                                                               
         LA    R1,1(RF,R1)         NEXT ELEMENT AREA                            
*                                                                               
CCRCCONT DS    0H                                                               
*                                                                               
         IC    RF,1(R2)            CLT ELM LENGTH                               
         LA    R2,0(RF,R2)         NEXT CLIENT ELM                              
         B     CCRCLOOP                                                         
*                                                                               
CCRCDONE DS    0H                                                               
*                                                                               
         MVC   PCRCKEY,IOKEYSAV    RESTORE CLIENT KEY                           
         XC    PCRCKCLT,PCRCKCLT   KILL CLIENT                                  
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RESTORE FILE POINTERS                        
*                                                                               
CLTCRCX  DS    0H                                                               
         XIT                                                                    
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
CCRCRECA DS    A                   A(CLIENT CIRCULATION RECORD)                 
CCRCRASV DS    A                   A(BASIC  CIRCULATION RECORD)                 
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIIO - FIND NEXT CLIENT IN GROUP - CLTGRP'                   
***********************************************************************         
*                                                                     *         
*        FIND NEXT CLIENT IN A GROUP SCHEME                           *         
*        ON FIRST ENTRY A TABLE IS BUILT OF ALL CLIENTS ELEGIBLE      *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT    PBCLT CONTAINS NEXT CLIENT CODE                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
CLTGRP   NMOD1 0,**#CLTGP                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    PBCLT,PBCLT         INIT RETURNED CLIENT CODE                    
*                                                                               
         OC    PBQGPCLT,PBQGPCLT   DONE IF NO FILTER                            
         BZ    CLTGRPX                                                          
*                                                                               
         LA    R2,IOKEY            ESTABLISH GROUP POINTER KEY                  
         USING GRPGKEY,R2                                                       
*                                                                               
         OC    CLGBUFST,CLGBUFST   FIRST TIME IF NO TABLE AVAILABLE             
         BNZ   CLGNEXT                                                          
*                                                                               
         LA    R3,CLGBUF           INIT BXLE REGISTERS FOR                      
         LA    R4,CLGBUFL          CLIENT GROUP BUFFER                          
         LR    R5,R3                                                            
         BCTR  R5,0                                                             
*                                                                               
         STM   R3,R5,CLGBXLE       INIT BUFFER BXLE REGISTERS                   
*                                                                               
         MVC   PBKEY,IOKEY         SAVE CURRENT KEY                             
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY                                     
*                                                                               
         MVC   GRPGAGY,PBAGY       SET AGENCY                                   
         MVC   GRPGMED,PBMED       SET MEDIA                                    
         MVI   GRPGTYP,GRPGCGQ     SET FOR CLIENT GROUP                         
         MVC   GRPGID,PBQGPCLS     SET SCHEME ID                                
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST CLIENT GROUP POINTER              
*                                                                               
CLGLOOP  DS    0H                                                               
*                                                                               
         CLC   GRPGKEY(GRPGCODE-GRPGKEY),IOKEYSAV DONE IF NEW ID                
         BNE   CLGDONE                                                          
*                                                                               
         TM    GRPGKEY+25,X'80'    SKIP IF DELETED                              
         BO    CLGCONT                                                          
*                                  BREAK OUT GROUP CODE                         
         UNPK  CLGCODE(L'CLGCODE+1),GRPGCODE(L'GRPGCODE+1)                      
*                                                                               
         LA    R1,PBQGPCLC         POINT TO REQUESTED PATTERN                   
         LA    RF,CLGCODE          POINT TO CURRENT CODE                        
         LA    R0,L'PBQGPCLC       CODE LENGTH                                  
*                                                                               
CLGCDELP DS    0H                                                               
*                                                                               
         CLI   0(R1),C' '          ACCEPT IF END OF REQ PATTERN REACHED         
         BNH   CLGCDEDN                                                         
*                                                                               
         CLI   0(R1),C'*'          OKAY IF THIS POSITION IS WILD CARD           
         BE    CLGCDECN                                                         
*                                                                               
         CLC   0(1,R1),0(RF)       REJECT IF DIGIT DOESN'T MATCH                
         BNE   CLGCDEX                                                          
*                                                                               
CLGCDECN DS    0H                                                               
*                                                                               
         LA    R1,1(R1)            BUMP POINTERS                                
         LA    RF,1(RF)                                                         
         BCT   R0,CLGCDELP                                                      
*                                                                               
CLGCDEDN DS    0H                  ACCEPT CLIENT CODE                           
*                                                                               
         MVC   CLGCLT-CLGCLT(L'CLGCLT,R3),GRPGVAL      CLIENT TO TABLE          
         MVC   CLGGCODE-CLGCLT(L'CLGGCODE,R3),GRPGCODE GROUP  TO TABLE          
*                                                                               
         LA    R3,CLGBUFL(R3)      BUMP TABLE POINTERS                          
*                                                                               
         L     RF,=A(CLGBUFX)      POINT TO END OF BUFFER                       
*                                                                               
         CR    R3,RF                                                            
         BL    *+6                                                              
         DC    H'0'                END OF BUFFER REACHED                        
*                                                                               
         LR    R5,R3                                                            
         BCTR  R5,0                                                             
*                                                                               
CLGCDEX  DS    0H                                                               
*                                                                               
CLGCONT  DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT GROUP POINTER                      
*                                                                               
         B     CLGLOOP                                                          
*                                                                               
CLGDONE  DS    0H                                                               
*                                                                               
         ST    R5,CLGBUFEN         SET END OF BUFFER ADDRESS                    
*                                                                               
         MVC   IOKEY,IOKEYSVE      RESTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RESTORE FILE POINTERS                        
*                                                                               
*        FIND NEXT AVAILABLE CLIENT IN TABLE                                    
*                                                                               
CLGNEXT  DS    0H                                                               
*                                                                               
         LM    R3,R5,CLGBXLE       GET BXLE REGISTERS FOR TABLE                 
*                                                                               
         CR    R5,R3               DONE IF END OF TABLE REACHED                 
         BNH   CLGEND                                                           
*                                                                               
         MVC   PBCLT,CLGCLT-CLGCLT(R3)        SET NEW CLIENT                    
         MVC   PBGCCODE,CLGGCODE-CLGCLT(R3)   SET NEW GROUP CODE                
*                                                                               
         LA    R3,CLGBUFL(R3)      UPDATE START OF BUFFER                       
         ST    R3,CLGBUFST                                                      
*                                                                               
         B     CLTGRPX             DONE                                         
*                                                                               
CLGEND   DS    0H                  END OF CLIENTS FOR GROUP SCHEME              
*                                                                               
         XC    CLGBXLE,CLGBXLE     RESET BXLE REGS TO FORCE RE-INIT             
         XC    PBGCCODE,PBGCCODE   END OF CLIENT GROUPS                         
*                                                                               
         B     CLTGRPX                                                          
*                                                                               
CLTGRPX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
         DS    0A                  ALIGNMENT                                    
CLGBXLE  DS    0XL12               BXLE REGISTERS FOR GROUP CLT BUFFER          
CLGBUFST DS    A                   START/CURRENT ELEMENT IN BUFFER              
CLGBUFLN DS    F                   LENGTH OF BUFFER ELEMENT                     
CLGBUFEN DS    A                   END OF BUFFER                                
*                                                                               
CLGCODE  DS    CL4                 UNPACKED GROUP CODE                          
         DS    XL1                 EXTRA FOR UNPACKING                          
*                                                                               
CLGBUF   DS    0D                  CLIENT GROUP BUFFER                          
CLGCLT   DS    CL(L'PBCLT)         BUFFER ENTRY CLIENT                          
CLGGCODE DS    CL(L'GRPGCODE)      BUFFER ENTRY GROUP CODE                      
CLGBUFL  EQU   *-CLGCLT            BUFFER ENTRY LENGTH                          
         DS    1000XL(CLGBUFL)     1000 ENTRY BUFFER                            
*                                  EXTRA ENTRY FOR SAFETY                       
CLGBUFX  EQU   *-1                 END OF BUFFER                                
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'PRWRIIO - FIND NEXT PRODUCT IN GROUP - PRDGRP'                 
***********************************************************************         
*                                                                     *         
*        FIND NEXT PRODUCT IN A GROUP SCHEME                          *         
*        ON FIRST ENTRY A TABLE IS BUILT OF ALL PRODUCTS ELEGIBLE     *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT    PBPROD CONTAINS NEXT PRODUCT CODE                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
PRDGRP   NMOD1 0,**#PRDGP                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    PBPROD,PBPROD       INIT RETURNED PRODUCT CODE                   
*                                                                               
         OC    PBQGPPRD,PBQGPPRD   DONE IF NO FILTER                            
         BZ    PRDGRPX                                                          
*                                                                               
         LA    R2,IOKEY            ESTABLISH GROUP POINTER KEY                  
         USING GRPGKEY,R2                                                       
*                                                                               
         OC    PRGBUFST,PRGBUFST   FIRST TIME IF NO TABLE AVAILABLE             
         BNZ   PRGNEXT                                                          
*                                                                               
         LA    R3,PRGBUF           INIT BXLE REGISTERS FOR                      
         LA    R4,PRGBUFL          PRODUCT GROUP BUFFER                         
         LR    R5,R3                                                            
         BCTR  R5,0                                                             
*                                                                               
         STM   R3,R5,PRGBXLE       INIT BUFFER BXLE REGISTERS                   
*                                                                               
         MVC   PBKEY,IOKEY         SAVE CURRENT KEY                             
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY                                     
*                                                                               
         MVC   GRPGAGY,PBAGY       SET AGENCY                                   
         MVC   GRPGMED,PBMED       SET MEDIA                                    
         MVI   GRPGTYP,GRPGPGQ     SET FOR PRODUCT GROUP                        
         MVC   GRPGID,PBQGPPRS     SET SCHEME ID                                
         MVC   GRPGCLT,PBCLT       SET CLIENT CODE                              
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST PRODUCT GROUP POINTER             
*                                                                               
PRGLOOP  DS    0H                                                               
*                                                                               
         CLC   GRPGKEY(GRPGCODE-GRPGKEY),IOKEYSAV DONE IF NEW ID                
         BNE   PRGDONE                                                          
*                                                                               
         TM    GRPGKEY+25,X'80'    SKIP IF DELETED                              
         BO    PRGCONT                                                          
*                                  BREAK OUT GROUP CODE                         
         UNPK  PRGCODE(L'PRGCODE+1),GRPGCODE(L'GRPGCODE+1)                      
*                                                                               
         LA    R1,PBQGPPRC         POINT TO REQUESTED PATTERN                   
         LA    RF,PRGCODE          POINT TO CURRENT CODE                        
         LA    R0,L'PBQGPPRC       CODE LENGTH                                  
*                                                                               
PRGCDELP DS    0H                                                               
*                                                                               
         CLI   0(R1),C' '          ACCEPT IF END OF REQ PATTERN REACHED         
         BNH   PRGCDEDN                                                         
*                                                                               
         CLI   0(R1),C'*'          OKAY IF THIS POSITION IS WILD CARD           
         BE    PRGCDECN                                                         
*                                                                               
         CLC   0(1,R1),0(RF)       REJECT IF DIGIT DOESN'T MATCH                
         BNE   PRGCDEX                                                          
*                                                                               
PRGCDECN DS    0H                                                               
*                                                                               
         LA    R1,1(R1)            BUMP POINTERS                                
         LA    RF,1(RF)                                                         
         BCT   R0,PRGCDELP                                                      
*                                                                               
PRGCDEDN DS    0H                  ACCEPT PRODUCT CODE                          
*                                                                               
         MVC   PRGPRD-PRGPRD(L'PRGPRD,R3),GRPGVAL      PROD   TO TABLE          
         MVC   PRGGCODE-PRGPRD(L'PRGGCODE,R3),GRPGCODE GROUP  TO TABLE          
*                                                                               
         LA    R3,PRGBUFL(R3)      BUMP TABLE POINTERS                          
*                                                                               
         L     RF,=A(PRGBUFX)      POINT TO END OF BUFFER                       
*                                                                               
         CR    R3,RF                                                            
         BL    *+6                                                              
         DC    H'0'                END OF BUFFER REACHED                        
*                                                                               
         LR    R5,R3                                                            
         BCTR  R5,0                                                             
*                                                                               
PRGCDEX  DS    0H                                                               
*                                                                               
PRGCONT  DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT GROUP POINTER                      
*                                                                               
         B     PRGLOOP                                                          
*                                                                               
PRGDONE  DS    0H                                                               
*                                                                               
         ST    R5,PRGBUFEN         SET END OF BUFFER ADDRESS                    
*                                                                               
         MVC   IOKEY,PBKEY         RESTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RESTORE FILE POINTERS                        
*                                                                               
*        FIND NEXT AVAILABLE PRODUCT IN TABLE                                   
*                                                                               
PRGNEXT  DS    0H                                                               
*                                                                               
         LM    R3,R5,PRGBXLE       GET BXLE REGISTERS FOR TABLE                 
*                                                                               
         CR    R5,R3               DONE IF END OF TABLE REACHED                 
         BNH   PRGEND                                                           
*                                                                               
         MVC   PBPROD,PRGPRD-PRGPRD(R3)       SET NEW PRODUCT                   
         MVC   PBGPCODE,PRGGCODE-PRGPRD(R3)   SET NEW GROUP CODE                
*                                                                               
         LA    R3,PRGBUFL(R3)      UPDATE START OF BUFFER                       
         ST    R3,PRGBUFST                                                      
*                                                                               
         B     PRDGRPX             DONE                                         
*                                                                               
PRGEND   DS    0H                  END OF PRODUCTS FOR GROUP SCHEME             
*                                                                               
         XC    PRGBXLE,PRGBXLE     RESET BXLE REGS TO FORCE RE-INIT             
         XC    PBGPCODE,PBGPCODE   END OF PRD GROUPS                            
*                                                                               
         B     PRDGRPX                                                          
*                                                                               
PRDGRPX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW PROCESSOR                            
         DS    0A                  ALIGNMENT                                    
PRGBXLE  DS    0XL12               BXLE REGISTERS FOR GROUP PRD BUFFER          
PRGBUFST DS    A                   START/CURRENT ELEMENT IN BUFFER              
PRGBUFLN DS    F                   LENGTH OF BUFFER ELEMENT                     
PRGBUFEN DS    A                   END OF BUFFER                                
*                                                                               
PRGCODE  DS    CL4                 UNPACKED GROUP CODE                          
         DS    XL1                 EXTRA FOR UNPACKING                          
*                                                                               
PRGBUF   DS    0D                  PRODUCT GROUP BUFFER                         
PRGPRD   DS    CL(L'PBPROD)        BUFFER ENTRY                                 
PRGGCODE DS    CL(L'GRPGCODE)      BUFFER ENTRY GROUP CODE                      
PRGBUFL  EQU   *-PRGPRD            BUFFER ENTRY LENGTH                          
         DS    1000XL(PRGBUFL)     1000 ENTRY BUFFER                            
*                                  EXTRA ENTRY FOR SAFETY                       
PRGBUFX  EQU   *-1                 END OF BUFFER                                
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'PRWRIIO - FIND NEXT PUB IN GROUP - PUBGRP'                     
***********************************************************************         
*                                                                     *         
*        FIND NEXT PUB IN A GROUP SCHEME                              *         
*        ON FIRST ENTRY A TABLE IS BUILT OF ALL PUBS ELEGIBLE         *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT    PBPUB CONTAINS NEXT PUB CODE                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
PUBGRP   NMOD1 0,**#PUBGP                                                       
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
*                                                                               
         L     RC,PBAIOWRK         RE-ESTABLISH LOCAL WORKAREA                  
         USING PRWRIIOD,RC                                                      
*                                                                               
         XC    PBPUB(6),PBPUB      INIT RETURNED PUB CODE                       
*                                                                               
         OC    PBQGPPUB,PBQGPPUB   DONE IF NO FILTER                            
         BZ    PUBGRPX                                                          
*                                                                               
         LA    R2,IOKEY            ESTABLISH GROUP POINTER KEY                  
         USING GRPGKEY,R2                                                       
*                                                                               
         OC    PGPBUFST,PGPBUFST   FIRST TIME IF NO TABLE AVAILABLE             
         BNZ   PGPNEXT                                                          
*                                                                               
         LA    R3,PGPBUF           INIT BXLE REGISTERS FOR                      
         LA    R4,PGPBUFL          PUB GROUP BUFFER                             
         LR    R5,R3                                                            
         BCTR  R5,0                                                             
*                                                                               
         STM   R3,R5,PGPBXLE       INIT BUFFER BXLE REGISTERS                   
*                                                                               
         MVC   PBKEY,IOKEY         SAVE CURRENT KEY                             
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY                                     
*                                                                               
         MVC   GRPGAGY,PBAGY       SET AGENCY                                   
         MVC   GRPGMED,PBMED       SET MEDIA                                    
         MVI   GRPGTYP,GRPGBGQ     SET FOR PUB GROUP                            
         MVC   GRPGID,PBQGPPBS     SET SCHEME ID                                
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BNE   *+20                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAORSE         SET TO READ AOR'S FILES                   
         MVC   GRPGAGY,PAORAGY        SET TO AOR AGENCY                         
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST PUB GROUP POINTER                 
*                                                                               
PGPLOOP  DS    0H                                                               
*                                                                               
         CLC   GRPGKEY(GRPGCODE-GRPGKEY),IOKEYSAV DONE IF NEW ID                
         BNE   PGPDONE                                                          
*                                                                               
         TM    GRPGKEY+25,X'80'    SKIP IF DELETED                              
         BO    PGPCONT                                                          
*                                  BREAK OUT GROUP CODE                         
         UNPK  PGPCODE(L'PGPCODE+1),GRPGCODE(L'GRPGCODE+1)                      
*                                                                               
         LA    R1,PBQGPPBC         POINT TO REQUESTED PATTERN                   
         LA    RF,PGPCODE          POINT TO CURRENT CODE                        
         LA    R0,L'PBQGPPBC       CODE LENGTH                                  
*                                                                               
PGPCDELP DS    0H                                                               
*                                                                               
         CLI   0(R1),C' '          ACCEPT IF END OF REQ PATTERN REACHED         
         BNH   PGPCDEDN                                                         
*                                                                               
         CLI   0(R1),C'*'          OKAY IF THIS POSITION IS WILD CARD           
         BE    PGPCDECN                                                         
*                                                                               
         CLC   0(1,R1),0(RF)       REJECT IF DIGIT DOESN'T MATCH                
         BNE   PGPCDEX                                                          
*                                                                               
PGPCDECN DS    0H                                                               
*                                                                               
         LA    R1,1(R1)            BUMP POINTERS                                
         LA    RF,1(RF)                                                         
         BCT   R0,PGPCDELP                                                      
*                                                                               
PGPCDEDN DS    0H                  ACCEPT PUB CODE                              
*                                                                               
         MVC   PGPPUB-PGPPUB(L'PGPPUB,R3),GRPGVAL      PROD   TO TABLE          
         MVC   PGPGCODE-PGPPUB(L'PGPGCODE,R3),GRPGCODE GROUP  TO TABLE          
*                                                                               
         LA    R3,PGPBUFL(R3)      BUMP TABLE POINTERS                          
*                                                                               
         L     RF,=A(PGPBUFX)      POINT TO END OF BUFFER                       
*                                                                               
         CR    R3,RF                                                            
         BL    *+6                                                              
         DC    H'0'                END OF BUFFER REACHED                        
*                                                                               
         LR    R5,R3                                                            
         BCTR  R5,0                                                             
*                                                                               
PGPCDEX  DS    0H                                                               
*                                                                               
PGPCONT  DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT GROUP POINTER                      
*                                                                               
         B     PGPLOOP                                                          
*                                                                               
PGPDONE  DS    0H                                                               
*                                                                               
         ST    R5,PGPBUFEN         SET END OF BUFFER ADDRESS                    
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BNE   *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAOSE          SET TO READ AGY'S FILES                   
*                                                                               
         MVC   IOKEY,IOKEY         RESTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RESTORE FILE POINTERS                        
*                                                                               
*        FIND NEXT AVAILABLE PUB IN TABLE                                       
*                                                                               
PGPNEXT  DS    0H                                                               
*                                                                               
         LM    R3,R5,PGPBXLE       GET BXLE REGISTERS FOR TABLE                 
*                                                                               
         CR    R5,R3               DONE IF END OF TABLE REACHED                 
         BNH   PGPEND                                                           
*                                                                               
         MVC   PBQPUB(6),PGPPUB-PGPPUB(R3)       SET NEW PUB                    
         MVC   PBPUB(6),PGPPUB-PGPPUB(R3)        SET NEW PUB                    
         MVC   PBGBCODE,PGPGCODE-PGPPUB(R3)   SET NEW GROUP CODE                
*                                                                               
         LA    R3,PGPBUFL(R3)      UPDATE START OF BUFFER                       
         ST    R3,PGPBUFST                                                      
*                                                                               
         CR    RF,RF               SET EQ CC                                    
*                                                                               
         B     PUBGRPX             DONE                                         
*                                                                               
PGPEND   DS    0H                  END OF PUBS FOR GROUP SCHEME                 
*                                                                               
         XC    PGPBXLE,PGPBXLE     RESET BXLE REGS TO FORCE RE-INIT             
         XC    PBGBCODE,PBGBCODE   END OF PUB GROUPS                            
*                                                                               
         LTR   RF,RF               SET NEQ CC                                   
*                                                                               
         B     PUBGRPX                                                          
*                                                                               
PUBGRPX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
         DS    CL256               FOR NEW PROCESSOR                            
PGPBUFFR DS    0D                  PUB GROUP BUFFER                             
PGPBXLE  DS    0XL12               BXLE REGISTERS FOR GROUP PUB BUFFER          
PGPBUFST DS    A                   START/CURRENT ELEMENT IN BUFFER              
PGPBUFLN DS    F                   LENGTH OF BUFFER ELEMENT                     
PGPBUFEN DS    A                   END OF BUFFER                                
*                                                                               
PGPCODE  DS    CL4                 UNPACKED GROUP CODE                          
         DS    XL1                 EXTRA FOR UNPACKING                          
*                                                                               
PGPBUF   DS    0D                  PUB GROUP BUFFER                             
PGPPUB   DS    XL6                 BUFFER ENTRY                                 
PGPGCODE DS    CL(L'GRPGCODE)      BUFFER ENTRY GROUP CODE                      
PGPBUFL  EQU   *-PGPPUB            BUFFER ENTRY LENGTH                          
         DS    20000XL(PGPBUFL)    20000 ENTRY BUFFER                           
*                                  EXTRA ENTRY FOR SAFETY                       
PGPBUFX  EQU   *-1                 END OF BUFFER                                
*                                                                               
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'PRWRIIO - FIND NEXT PUB IN LIST - PUBLIS'                      
***********************************************************************         
*                                                                     *         
*        FIND NEXT PUB IN A PUBLIST                                   *         
*        ON FIRST ENTRY A TABLE IS BUILT OF ALL PUBS ELEGIBLE         *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT    PBPUB CONTAINS NEXT PUB CODE                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
PUBLIS   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBLOCKD,R7          R7 = A(PRNTBLOCK)                            
         USING SUBROUTS,R9                                                      
         USING PRWRIIOD,RC         ESTABLISH LOCAL WORKAREA                     
*                                                                               
         XC    PBPUB(6),PBPUB      INIT RETURNED PUB CODE                       
*                                                                               
         OC    PBQLISCD,PBQLISCD   DONE IF NO PUB LIST CODE                     
         BZ    PUBLISX                                                          
*                                                                               
         L     R8,=A(PGPBUFFR)     POINT TO PUB GROUP BUFFER                    
         USING PGPBUFFR,R8         ESTABLISH BUFFER                             
*                                                                               
         LA    R2,IOKEY            ESTABLISH PUB LIST REC KEY                   
         USING PLISREC,R2                                                       
*                                                                               
         OC    PGPBUFST,PGPBUFST   FIRST TIME IF NO TABLE AVAILABLE             
         BNZ   PBLNEXT             ELSE GET NEXT PUB IN LIST                    
*                                                                               
         LA    R3,PGPBUF           INIT BXLE REGISTERS FOR                      
         LA    R4,PGPBUFL          PUB GROUP BUFFER                             
         LR    R5,R3                                                            
         BCTR  R5,0                                                             
*                                                                               
         STM   R3,R5,PGPBXLE       INIT BUFFER BXLE REGISTERS                   
*                                                                               
         MVC   PBKEY,IOKEY         SAVE CURRENT KEY                             
*                                                                               
         XC    IOKEY,IOKEY         INIT KEY                                     
*                                                                               
         MVC   PLISKAGY,PBAGY      SET AGENCY                                   
         MVC   PLISKMED,PBMED      SET MEDIA                                    
         MVI   PLISKRCD,PLISTIDQ   SET FOR PUB LIST                             
         MVC   PLISKCLT,PBCLT      SET CLIENT CODE                              
*                                                                               
         OC    PLISKCLT,PLISKCLT   IF NO CLIENT                                 
         BNZ   *+10                                                             
         MVC   PLISKCLT,PBCLTSV       USE SAVED CLIENT CODE                     
*                                                                               
         MVC   PLISKCOD,PBQLISCD   SET PUB LIST CODE                            
         MVI   PLISKLIN,1          SET FOR FIRST RECORD                         
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST PUB LIST RECORD                   
*                                                                               
         CLC   PLISKEY(PLISKLIN-PLISKEY),IOKEYSAV IF NOT FOUND                  
         BE    PBLLOOP                                                          
*                                                                               
         MVC   PLISKEY,IOKEYSAV    RESTORE STARTING KEY                         
*                                                                               
         MVC   PLISKCLT,=C'ZZZ'    SET TO CLIENT ZZZ                            
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   READ FIRST PUB LIST RECORD                   
*                                                                               
PBLLOOP  DS    0H                                                               
*                                                                               
         CLC   PLISKEY(PLISKLIN-PLISKEY),IOKEYSAV DONE IF NEW LIST              
         BNE   PBLDONE                                                          
*                                                                               
         GOTO1 AIO,IOPRTFIL+IOGET+IO3 GET PUBLIST RECORD                        
*                                                                               
         L     R6,AIO3             POINT TO PUBLIST RECORD                      
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
*                                                                               
         L     R0,=A(PGPBUFX)      POINT TO END OF BUFFER                       
         SR    RF,RF                                                            
*                                                                               
PBLPUBLP DS    0H                                                               
*                                                                               
         USING PLISPBD,R6          ESTABLISH PUB ELEMENT                        
*                                                                               
         CLI   PLISPBEL,0          DONE AT END OF LIST                          
         BE    PBLPUBDN                                                         
*                                                                               
         CLI   PLISPBEL,PLISPBQ    LOOK FOR PUB ELEMENTS                        
         BNE   PBLPUBCN                                                         
*                                                                               
         MVC   PGPPUB-PGPPUB(L'PGPPUB,R3),PLISPUB   PUB TO TABLE                
*                                                                               
         LA    R3,PGPBUFL(R3)      BUMP TABLE POINTERS                          
*                                                                               
         CR    R3,R0                                                            
         BL    *+6                                                              
         DC    H'0'                END OF BUFFER REACHED                        
*                                                                               
PBLPUBCN DS    0H                                                               
*                                                                               
         IC    RF,PLISPBEL+1       GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
*                                                                               
         B     PBLPUBLP                                                         
*                                                                               
PBLPUBDN DS    0H                                                               
*                                                                               
         LR    R5,R3               SET END OF BXLE REGISTER                     
         BCTR  R5,0                                                             
*                                                                               
PBLCONT  DS    0H                                                               
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOSQ   READ NEXT PUB LIST RECORD                    
*                                                                               
         B     PBLLOOP                                                          
*                                                                               
PBLDONE  DS    0H                                                               
*                                                                               
         ST    R5,PGPBUFEN         SET END OF BUFFER ADDRESS                    
*                                                                               
         MVC   IOKEY,PBKEY         RESTORE CURRENT KEY                          
*                                                                               
         GOTO1 AIO,IOPRTDIR+IOHI   RESTORE FILE POINTERS                        
*                                                                               
*        FIND NEXT AVAILABLE PUB IN TABLE                                       
*                                                                               
PBLNEXT  DS    0H                                                               
*                                                                               
         LM    R3,R5,PGPBXLE       GET BXLE REGISTERS FOR TABLE                 
*                                                                               
         CR    R5,R3               DONE IF END OF TABLE REACHED                 
         BNH   PBLEND                                                           
*                                                                               
         MVC   PBQPUB(6),PGPPUB-PGPPUB(R3)       SET NEW PUB                    
         MVC   PBPUB(6),PGPPUB-PGPPUB(R3)        SET NEW PUB                    
*                                                                               
         LA    R3,PGPBUFL(R3)      UPDATE START OF BUFFER                       
         ST    R3,PGPBUFST                                                      
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     PUBLISX             DONE                                         
*                                                                               
PBLEND   DS    0H                  END OF PUBS FOR GROUP SCHEME                 
*                                                                               
         XC    PGPBXLE,PGPBXLE     RESET BXLE REGS TO FORCE RE-INIT             
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
         B     PUBLISX                                                          
*                                                                               
PUBLISX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'T00A4C - PRWRIIO - SYSTEM FILE NAMES'                           
* SYSTEM FILE NAMES TABLE (FILE NUMBERS 1 THRU 9)                               
*                                                                               
FILTAB   DS    0X                                                               
*                                  ** PRNT SYSTEM FILES **                      
FILSPT   DC    X'02',AL2(FILSPTX-*)                                             
*                                                                               
         DC    AL1(1),C'PRTDIR '   MUST BE FIRST TABLE ENTRY                    
         DC    AL1(FILIIS,FILIID)                                               
         DC    AL1(2,25,02),AL2(31)                                             
         DC    XL5'00'                                                          
*                                                                               
         DC    AL1(2),C'PRTFIL '   MUST BE SECOND TABLE ENTRY                   
         DC    AL1(FILIDA,FILIDI)                                               
         DC    AL1(1,25,33),AL2(4000)                                           
         DC    XL5'00'                                                          
*                                                                               
         DC    AL1(3),C'PUBDIR '                                                
         DC    AL1(FILIIS,FILIID)                                               
         DC    AL1(2,25,02),AL2(31)                                             
         DC    XL5'00'                                                          
*                                                                               
         DC    AL1(4),C'PUBFIL '                                                
         DC    AL1(FILIDA,FILIDI)                                               
         DC    AL1(1,25,33),AL2(4000)                                           
         DC    XL5'00'                                                          
*                                                                               
FILSPTX  DC    AL1(EOT)                                                         
*                                                                               
FILTABX  DC    AL1(EOT)                                                         
         SPACE 1                                                                
* TABLE OF GLOBAL SYSTEM FILES (FILE NUMBERS 10 THRU 15)                        
*                                                                               
SYSTAB   DS    0X                                                               
*                                                                               
         DC    AL1(11),C'CTFILE '  CONTROL FILE                                 
         DC    AL1(FILIVL+FILIIS,0)                                             
         DC    AL1(0,25,29),AL2(2000)                                           
         DC    XL5'00'                                                          
*                                                                               
SYSTABX  DS    AL1(EOT)                                                         
         TITLE 'T00A4C - PRWRIIO - SYSTEM FILE COMMAND TABLE'                   
* SYSTEM FILE COMMANDS TABLE                                                    
*                                                                               
CMDTAB   DS    0X                                                               
*                                  INDEX SEQUENTIAL COMMANDS                    
CMDIS    DC    AL1(FILIVL+FILIIS,0),AL2(CMDISX-*)                               
         DC    C'DMRDHI ',AL1(IOHI,0,0)                                         
         DC    C'DMREAD ',AL1(IORD,0,0)                                         
         DC    C'DMRSEQ ',AL1(IOSQ,0,0)                                         
         DC    C'DMADD  ',AL1(IOADD,0,0)                                        
         DC    C'DMWRT  ',AL1(IOWRITE,0,0)                                      
CMDISX   DC    AL1(EOT)                                                         
*                                  DIRECT ACCESS COMMANDS                       
CMDDA    DC    AL1(FILIDA,0),AL2(CMDDAX-*)                                      
         DC    C'GETREC ',AL1(IOHI,CMDIDARQ+CMDIDAXC,0)                         
         DC    C'GETREC ',AL1(IORD,CMDIDARQ+CMDIDAXC,0)                         
         DC    C'GETREC ',AL1(IOSQ,CMDIDARQ+CMDIDAXC,0)                         
         DC    C'GETREC ',AL1(IOGET,CMDIDARQ,0)                                 
         DC    C'ADDREC ',AL1(IOADDREC,CMDIDADD,0)                              
         DC    C'PUTREC ',AL1(IOPUTREC,CMDIDARQ,0)                              
CMDDAX   DC    AL1(EOT)                                                         
*                                                                               
CMDTABX  DC    AL1(EOT)                                                         
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE  'T00A4C-PRWRIIO-I/O SUBROUTINE LOCAL WORKING STORAGE'           
IOWORKD  DSECT                     ** IO S/R LOCAL W/S **                       
IODUB    DS    D                   GENERAL WORK AREA                            
IOCTRL   DS    XL4                 I/O COMMAND WORD                             
IOTR1    DS    F                   TRACE WORD 1                                 
IOTR2    DS    F                   TRACE WORD 2                                 
IOQ      DS    X                   I/O COMMAND QUALIFIER (RFU/DELETES)          
IOFILV   DS    0XL15               EXTRACTED FILE VALUES (THIS I/O)             
IOFILNO  DS    X                   FILE NUMBER                                  
IOFILNM  DS    CL7                 COMMAND NAME                                 
IOFILI   DS    X                   FILE INDICATORS - 1                          
IOFILI2  DS    X                   FILE INDICATORS - 2                          
IOFILN2  DS    X                   FILE NUMBER 2 (I/S D/A PAIR)                 
IOFILKL  DS    X                   KEY LENGTH                                   
IOFILCL  DS    X                   CONTROL LENGTH                               
IOFILDE  EQU   IOFILCL             DISPLACEMENT TO FIRST ELEMENT                
IOFILML  DS    XL2                 MAXIMUM RECORD LENGTH                        
IOCMDV   DS    0XL10               EXTRACTED COMMAND VALUES (THIS I/O)          
IOCMDNM  DS    CL7                 COMMAND NAME                                 
IOCMDNO  DS    X                   COMMAND NUMBER                               
IOCMDI   DS    X                   COMMAND INDICATORS - 1                       
IOCMDI2  DS    X                   COMMAND INDICATORS - 2                       
IOWORKX  EQU   *                                                                
         TITLE 'T00A4C-PRWRIIO-GLOBAL EQUATES'                                  
*                                  ** GLOBAL EQUATES **                         
EOT      EQU   0                   END-OF-TABLE INDICATOR                       
FF       EQU   X'FF'                                                            
         SPACE 1                                                                
*                                  ** I/O FILE EQUATES **                       
IOFILES  EQU   X'0F00'             RESERVED FOR CONTROLLER USE                  
IOPRTDIR EQU   X'0100'             I/O TO PRNT DIRECTORY                        
IOPRTFIL EQU   X'0200'             I/O TO PRNT FILE                             
IOPUBDIR EQU   X'0300'             I/O TO PRNT DIRECTORY                        
IOPUBFIL EQU   X'0400'             I/O TO PRNT FILE                             
IOCTFILE EQU   X'0B00'             I/O TO CONTROL FILE                          
         SPACE 1                                                                
*                                  ** I/O AREA EQUATES **                       
IO1      EQU   X'0040'             I/O AREA 1 TO BE USED FOR I/O                
IO2      EQU   X'0080'             I/O AREA 2 TO BE USED FOR I/O                
IO3      EQU   X'00C0'             I/O AREA 3 TO BE USED FOR I/O                
         SPACE 1                                                                
*                                  ** I/O COMMAND EQUATES **                    
IOCMNDS  EQU   X'000F'             RESERVED FOR CONTROLLER USE                  
IOLOCK   EQU   X'0010'             READ FOR UPDATE                              
IORDEL   EQU   X'0020'             READ DELETED RECORDS                         
IOHI     EQU   X'0001'             DMRDHI                                       
IOHID    EQU   IOHI+IORDEL         DMRDHI (FOR DELETES)                         
IOHIUP   EQU   IOHI+IOLOCK         DMRDHI (FOR UPDATE)                          
IOHIUPD  EQU   IOHI+IOLOCK+IORDEL  DMRDHI (FOR UPDATE & DELETES)                
IORD     EQU   X'0002'             DMREAD                                       
IORDD    EQU   IORD+IORDEL         DMREAD (FOR DELETES)                         
IORDUP   EQU   IORD+IOLOCK         DMREAD (FOR UPDATE)                          
IORDUPD  EQU   IORD+IOLOCK+IORDEL  DMREAD (FOR UPDATE & DELETES)                
IOSQ     EQU   X'0003'             DMRSEQ                                       
IOSQD    EQU   IOSQ+IORDEL         DMRSEQ (FOR DELETES)                         
IOSQUP   EQU   IOSQ+IOLOCK         DMRSEQ (FOR UPDATE)                          
IOSQUPD  EQU   IOSQ+IOLOCK+IORDEL  DMRSEQ (FOR UPDATE & DELETES)                
IOGET    EQU   X'0004'             GETREC                                       
IOGETRUP EQU   IOGET+IOLOCK        GETREC (FOR UPDATE)                          
IOADD    EQU   X'0005'             DMADD                                        
IOADDREC EQU   X'0005'             ADDREC                                       
IOWRITE  EQU   X'0006'             DMWRT                                        
IOPUTREC EQU   X'0006'             PUTREC                                       
IOUNLOCK EQU   X'0007'             DMUNLK                                       
         TITLE 'T00A4C-PRWRIIO-I/O FILE TABLE'                                  
FILTABD  DSECT                     ** I/O FILE TABLE **                         
FILNUM   DS    XL1                 FILE NUMBER (IOFILES EQUATE)                 
FILNAME  DS    CL7                 FILE NAME                                    
FILINDS  DS    XL1                 FILE INDICATORS - 1                          
FILIVL   EQU   X'80'               FILE RECORDS ARE VARIABLE LENGTH             
FILIDA   EQU   X'40'               FILE IS A DIRECT ACCESS FILE                 
FILIIS   EQU   X'20'               FILE IS AN INDEX SEQUENTIAL FILE             
FILINDS2 DS    XL1                 FILE INDICATORS - 2                          
FILIDI   EQU   X'80'               FILE IS D/A WITH I/S INDEX                   
FILIID   EQU   FILIDI              FILE IS I/S INDEX TO A D/A FILE              
FILNUM2  DS    XL1                 D/A OR I/S FILE NUMBER                       
FILKEYL  DS    XL1                 D/A OR I/S KEY LENGTH                        
FILCTLL  DS    XL1                 FIXED LENGTH I/S CONTROL LENGTH              
FILDISP  EQU   FILCTLL             DISPLACEMENT TO FIRST RECORD ELEMENT         
FILMAXL  DS    XL2                 MAXIMUM RECORD LENGTH                        
         DS    XL5                 SPARE                                        
FILTABL  EQU   *-FILTABD                                                        
         SPACE 1                                                                
CMDTABD  DSECT                     ** I/O COMMAND TABLE **                      
CMDNAME  DS    CL7                 COMMAND NAME                                 
CMDNUMB  DS    XL1                 COMMAND NUMBER (SEE IOCMNDS)                 
CMDINDS  DS    XL1                 COMMAND INDICATORS - 1                       
CMDIDARQ EQU   X'80'               DISK ADDRESS REQUIRED FOR I/O                
CMDIDAXC EQU   X'40'               CLEAR DISK ADDRESS BEFORE I/O                
CMDIDADD EQU   X'20'               DISK ADDRESS RETURNED FROM I/O               
CMDINDS2 DS    XL1                 COMMAND INDICATORS - 2                       
CMDTABL  EQU   *-CMDTABD                                                        
         TITLE 'T00A4C - PRWRIIO - LOCAL WORKING STORAGE'                       
PRWRIIOD DSECT                     ** LOCAL WORKING STORAGE **                  
RELO     DS    A                                                                
PARM     DS    8F                                                               
WORK     DS    XL64                                                             
DUB      DS    D                                                                
FULL     DS    F                                                                
HALF     DS    H                                                                
HALF2    DS    H                                                                
USERRD   DS    A                   USER REGISTER 13                             
*                                                                               
AFILNTRY DS    A                                                                
ACLTREC  DS    A                                                                
*                                                                               
BYTE     DS    X                                                                
BYTE2    DS    X                                                                
BYTE3    DS    X                                                                
ELCODE   DS    X                                                                
FLAG     DS    X                                                                
INDS     DS    X                                                                
IONUM    DS    X                                                                
KEYBST   DS    XL3                 REQUEST START DATE                           
KEYBEN   DS    XL3                 REQUEST END DATE                             
PBQSTSV  DS    XL6                                                              
*                                                                               
READSW   DS    X                   RECORD READ SWITCH                           
*                                  C'N' READ NEXT                               
*                                  C'E' READ EXACTLY                            
BLANKS   DS    CL133                                                            
XFF      DS    XL16                                                             
*                                                                               
PASA     DS    X                                                                
P        DS    CL132                                                            
*                                                                               
BILLFORM DS    0CL5                DEFAULT BILL FORMULA                         
BILLBASE DS    X                                                                
BILLCOM  DS    XL4                                                              
MASTCLIR DS    XL1                                                              
         SPACE 1                                                                
*                                  ** SAVED VALUES **                           
SVPRD    DS    X                                                                
SVIOKEY  DS    XL32                                                             
SVIOKEYS DS    XL32                                                             
*                                                                               
ESTDATA  DS    CL(EBFLEN)                                                       
SESTDATA DS    CL(L'ESTDATA)                                                    
NOPRDERR DS    C                   SET TO 'Y' SUPPRESS PRD/EST NOT FND          
*                                                                               
IOAREAST DS    0F                  ** I/O CONTROLLER VARIABLES **               
IOADDR   DS    A                   I/O AREA ADDRESS                             
IOFILE   DS    CL7                 FILE NAME                                    
IOCMND   DS    CL7                 DATAMGR COMMAND                              
IOERR    DS    XL1                 I/O ERROR RETURN BYTE                        
IOEEOF   EQU   X'80'               END-OF-FILE                                  
IOEDSK   EQU   X'40'               NON-RECOVERABLE DISK ERROR                   
IOEDUP   EQU   X'20'               DUPLICATE KEY ON ADD                         
IOERNF   EQU   X'10'               RECORD NOT FOUND                             
IOEDEL   EQU   X'02'               RECORD IS DELETED                            
IOERRS   EQU   X'FF'               RESERVED FOR CONTROLLER USE                  
IOKEY    DS    CL32                ACTUAL KEY VALUE                             
IOKEYSAV DS    CL32                SAVED ACTUAL KEY VALUE (BEFORE I/O)          
IODA     DS    XL4                 DISK ADDRESS OF D/A RECORD                   
IOWORK   DS    XL96                D/A LINKED FILES WORK AREA                   
IOAREAND EQU   *                                                                
         SPACE 1                                                                
COREFACS DS    0A                  ** T00A PHASE ROUTINES **                    
VOFFICER DS    V ===================== WATCH THESE                              
VSPOOL   DS    V                                                                
VTSAROFF DS    V                                                                
VCASHIER DS    V                                                                
GETINS   DS    A                                                                
         SPACE 1                                                                
CONFACS  DS    0F                  ** PRWRIIO FACILITIES **                     
QSORT    DS    A                                                                
BINSRCH  DS    A                                                                
AFILTAB  DS    A                                                                
ASYSTAB  DS    A                                                                
ACMDTAB  DS    A                                                                
AIO      DS    A                                                                
VIO      DS    A                                                                
VGETADV  DS    A                                                                
         DS    A                                                                
VADDAY   DS    A                                                                
         DS    10A                                                              
         SPACE 1                                                                
AIOAREAS DS    0F                  ** IO AREA ADDRESSES **                      
AIO1     DS    A                                                                
AIO2     DS    A                                                                
AIO3     DS    A                                                                
*                                                                               
CSHIERC  DS    XL(CSHIERL)         CASHIER CONTROL BLOCK                        
*                                                                               
SVEPUBNO DS    CL6                                                              
*                                                                               
         DC    C'**LITTLREC**'                                                  
LITTLREC DS    CL4096                                                           
*                                                                               
*                                                                               
PRWRIIOX EQU   *                                                                
         EJECT                                                                  
CONTTABL DSECT                                                                  
CONTNPUB DS    XL4                 CONTRACT PUB NUMBER                          
CONTNZO  DS    XL1                 ZONE                                         
CONTNED  DS    XL1                 EDITION                                      
CONTNST  DS    XL3                 CONT START DATE                              
CONTNEN  DS    XL3                 CONT END DATE                                
CONTNADD DS    XL4                 DISK ADDR                                    
CONTNLEN EQU   *-CONTTABL                                                       
*                                                                               
         EJECT                                                                  
       ++INCLUDE GETADVCD                                                       
         EJECT                                                                  
PBLOCKD  DSECT                     ** PRNTBLOCK AREA **                         
         PRINT OFF                                                              
       ++INCLUDE PRNTBLOCK                                                      
         PRINT ON                                                               
* DDCOREQUS                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCOREQUS                                                      
         PRINT ON                                                               
* PRDATELSTD                                                                    
         PRINT OFF                                                              
       ++INCLUDE PRDATELSTD                                                     
         PRINT ON                                                               
* DDCASHIERD                                                                    
         PRINT OFF                                                              
       ++INCLUDE DDCASHIERD                                                     
         PRINT ON                                                               
* DDTSARD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DDTSARD                                                        
         PRINT ON                                                               
* PRGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE PRGENFILE                                                      
         PRINT ON                                                               
* ACGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACGENFILE                                                      
         PRINT ON                                                               
* DDCOMFACS                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCOMFACS                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* DDOFFICED                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDOFFICED                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* FAFACTS                                                                       
         PRINT OFF                                                              
       ++INCLUDE FAFACTS                                                        
         PRINT ON                                                               
         SPACE 1                                                                
* FATIOB                                                                        
         PRINT OFF                                                              
       ++INCLUDE FATIOB                                                         
         PRINT ON                                                               
         SPACE 1                                                                
* FASYSLSTD                                                                     
         PRINT OFF                                                              
       ++INCLUDE FASYSLSTD                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* DDREPMASTD                                                                    
         PRINT OFF                                                              
       ++INCLUDE DDREPMASTD                                                     
         PRINT ON                                                               
         SPACE 1                                                                
* CTGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE CTGENFILE                                                      
         PRINT ON                                                               
* DDMINBLK                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDMINBLK                                                       
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'177PRWRIIO   02/07/20'                                      
         END                                                                    
