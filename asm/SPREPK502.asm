*          DATA SET SPREPK502  AT LEVEL 010 AS OF 01/06/10                      
*PHASE SPK502A                                                                  
*INCLUDE BUFFERIN                                                               
*INCLUDE CALCASHP                                                               
*INCLUDE LOCKET                                                                 
                                                                                
***********************************************************************         
* QOPT1  -  Re-allocation option                                      *         
* QOPT2  -  Allocation basis (D=Demos, $=Dollars)                     *         
* QOPT3  -  Allocate excess                                           *         
* QOPT4  -  Y=Test run                                                *         
* QOPT5  -  Sub-media for GETPROF calls                               *         
* QOPT6  -  Zero week option override                                 *         
***********************************************************************         
                                                                                
SPK502   TITLE '- Network Allocation Program'                                   
SPK502   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,**SPK502                                                       
                                                                                
         L     R9,0(R1)                                                         
         LR    RA,R9                                                            
         AHI   RA,FOURK                                                         
         USING SPWORKD,R9,RA       R9/RA=A(SPWORKD)                             
         L     R8,MEDBUFF                                                       
         USING MEDBLOCK,R8         R8=A(MEDBLOCK)                               
         LARL  RC,GLOBALS                                                       
         USING GLOBALS,RC          RC=A(GLOBAL VALUES)                          
         STM   R9,RA,SAVER9RA                                                   
         ST    RD,NTRYRD           SAVE CURRENT RD                              
         SAM31 ,                   SET 31 BIT ADDRESSING MODE                   
                                                                                
         CLI   MODE,PROCNGOL       PROCESS GOAL RECORD                          
         BE    PRCG                                                             
         CLI   MODE,ESTFRST        FIRST FOR ESTIMATE                           
         BE    ESTF                                                             
         CLI   MODE,CLTFRST        FIRST FOR CLIENT                             
         BE    CLTF                                                             
         CLI   MODE,REQFRST        FIRST FOR REQUEST                            
         BE    REQF                                                             
         CLI   MODE,REQLAST        LAST FOR REQUEST                             
         BE    REQL                                                             
         CLI   MODE,RUNFRST        FIRST FOR RUN                                
         BE    RUNF                                                             
         CLI   MODE,RUNLAST        LAST FOR RUN                                 
         BE    RUNL                                                             
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* First for run                                                       *         
***********************************************************************         
                                                                                
RUNF     GOTOR ARUNFST                                                          
         J     EXIT                                                             
                                                                                
***********************************************************************         
* First for request                                                   *         
***********************************************************************         
                                                                                
REQF     GOTOR AREQFST                                                          
         J     EXIT                                                             
                                                                                
***********************************************************************         
* First for client                                                    *         
***********************************************************************         
                                                                                
CLTF     GOTOR ACLTFST                                                          
         J     EXIT                                                             
                                                                                
***********************************************************************         
* First for estimate                                                  *         
***********************************************************************         
                                                                                
ESTF     GOTOR AESTFST                                                          
         J     EXIT                                                             
                                                                                
***********************************************************************         
* Process a goal record                                               *         
***********************************************************************         
                                                                                
PRCG     GOTOR APRCGOL                                                          
         J     EXIT                                                             
                                                                                
***********************************************************************         
* Last for request                                                    *         
***********************************************************************         
                                                                                
REQL     GOTOR AREQLST                                                          
         J     EXIT                                                             
                                                                                
***********************************************************************         
* Last for run                                                        *         
***********************************************************************         
                                                                                
RUNL     GOTOR ARUNLST                                                          
         J     EXIT                                                             
         DROP  RB                                                               
         EJECT                                                                  
GLOBALS  DS    0H                  ** GLOBAL LITERALS **                        
                                                                                
PATCH    DS    0X                  ** PATCHABLE AREA **                         
                                                                                
DIAGNOPS DS    0XL2                ** DIAGNOSTIC OPTIONS **                     
                                                                                
DIAGNOP1 DC    X'00'               ** DIAGNOSTIC OPTION 1 **                    
DPRDUNTQ EQU   X'80'               PRINT PRODUCT BUFFER + UNIT TABLES           
DENVAFTQ EQU   X'40'               ENVIRONMENT TABLES (POST)                    
DPRTUPDQ EQU   X'20'               DUMP WRITE BACK RECORDS                      
DPRTRESQ EQU   X'10'               PRINT RESCALE WORKSHEETS                     
DPRTVARQ EQU   X'08'               PRINT VARIABLE ANALYSIS                      
DPRTCMPQ EQU   X'04'               COMPLETE VARIABLE ANALYSIS                   
DENVBEFQ EQU   X'02'               ENVIRONMENT TABLES (PRE)                     
DNDXPRTQ EQU   X'01'               PRINT INDEX ENTRIES                          
                                                                                
DIAGNOP2 DC    X'00'               ** DIAGNOSTIC OPTION 2 **                    
DPRTBUFQ EQU   X'80'               PRINT BUFFERIN TRACE                         
DPODBRDQ EQU   X'40'               POD BRAND SELECT TRACE                       
DSUPSTRQ EQU   X'08'               SUPPRESS U PHASE TRACE                       
DSUPBTRQ EQU   X'04'               SUPPRESS B PHASE TRACE                       
DSUPXTRQ EQU   X'02'               SUPPRESS X PHASE TRACE                       
DTRCKEYQ EQU   X'01'               TRACE BUFFER 1 PUTS                          
                                                                                
DIEKEY   DS    XL(GBUFFKL)         GBUFFK TO DIE ON                             
                                                                                
SAVER9RA DC    2A(0)               SAVE AREA FOR R9 AND RA                      
NTRYRD   DC    A(0)                SAVED RD VALUE ON ENTRY                      
                                                                                
LBRDTAB  DC    A(ONEK*ONEK*8)      BRAND TABLE SIZE (8M)                        
                                                                                
ABUFF    DC    A(ABUFFER)          PACKED ACCUMULATOR BUFFER AREA               
                                                                                
ABUFF1   DC    A(BUFF1)            BUFFERIN FILE 1 CONTROL BLOCK                
ABUFF2   DC    A(BUFF2)            BUFFERIN FILE 2 CONTROL BLOCK                
ABUFF3   DC    A(BUFF3)            BUFFERIN FILE 3 CONTROL BLOCK                
                                                                                
ARUNFST  DC    A(RUNFST)                                                        
ARUNLST  DC    A(RUNLST)                                                        
AREQFST  DC    A(REQFST)                                                        
AREQLST  DC    A(REQLST)                                                        
ACLTFST  DC    A(CLTFST)                                                        
AESTFST  DC    A(ESTFST)                                                        
APRCGOL  DC    A(PRCGOL)                                                        
                                                                                
ANETUNT  DC    A(NETUNT)                                                        
ARSCALE  DC    A(RSCALE)                                                        
ADSCALE  DC    A(DSCALE)                                                        
AGETROW  DC    A(GETROW)                                                        
APUTROW  DC    A(PUTROW)                                                        
APRTBUF  DC    A(PRTBUF)                                                        
APRTENV  DC    A(PRTENV)                                                        
APRTUNT  DC    A(PRTUNT)                                                        
APRTVAR  DC    A(PRTVAR)                                                        
AALLOC   DC    A(ALLOC)                                                         
AALWEEK  DC    A(ALWEEK)                                                        
AAWKINI  DC    A(AWKINI)                                                        
ASETENV  DC    A(SETENV)                                                        
AADDSUB  DC    A(ADDSUB)                                                        
ACHKCLS  DC    A(CHKCLS)                                                        
ABLDVPL  DC    A(BLDVPL)                                                        
ASETVAL  DC    A(SETVAL)                                                        
AUNTUSE  DC    A(UNTUSE)                                                        
AREWREC  DC    A(REWREC)                                                        
AGETUNT  DC    A(GETUNT)                                                        
APODUPD  DC    A(PODUPD)                                                        
AUPDUNT  DC    A(UPDUNT)                                                        
ADETRPT  DC    A(DETRPT)                                                        
ADT2RPT  DC    A(DT2RPT)                                                        
ASUMRPT  DC    A(SUMRPT)                                                        
ARECRPT  DC    A(RECRPT)                                                        
APGMRCP  DC    A(PGMRCP)                                                        
APARREP  DC    A(PARREP)                                                        
AHEDBLD  DC    A(HEDBLD)                                                        
APRDBLD  DC    A(PRDBLD)                                                        
                                                                                
BUFFERIN DC    V(BUFFERIN)                                                      
CALCASHP DC    V(CALCASHP)                                                      
LOCKET   DC    V(LOCKET)                                                        
                                                                                
ACLSTRT  DC    A(CLSTRT)                                                        
ASCELLS  DC    A(SCELLS)                                                        
AEQVMSG  DC    A(EQVMSG)                                                        
APODDSC  DC    A(PODDSC)                                                        
                                                                                
ANETBLK  DC    A(NETBLK)                                                        
APXCREC  DC    A(PXCREC)                                                        
                                                                                
APLAINDX DC    A(PLAINDX)                                                       
APLBINDX DC    A(PLBINDX)                                                       
APLCINDX DC    A(PLCINDX)                                                       
APLDINDX DC    A(PLDINDX)                                                       
APLXINDX DC    A(PLXINDX)                                                       
APPAINDX DC    A(PPAINDX)                                                       
APPBINDX DC    A(PPBINDX)                                                       
APPCINDX DC    A(PPCINDX)                                                       
APPDINDX DC    A(PPDINDX)                                                       
                                                                                
AENV1SET DC    A(ENV1SET)                                                       
AENV2SET DC    A(ENV2SET)                                                       
AENV3SET DC    A(ENV3SET)                                                       
                                                                                
AWEEKLST DC    A(WEEKLST)                                                       
                                                                                
AALCTABX DC    A(ALCTABX)                                                       
ASUBTABX DC    A(SUBTABX)                                                       
APODTABX DC    A(PODTABX)                                                       
                                                                                
AVPECNTS DC    A(VPECNTS)                                                       
APODPRDS DC    A(PODPRDS)                                                       
                                                                                
SUPPRD   DC    FL(PRDLENQ)'00'     PRODUCT FOR SUPPLY                           
UNAPRD   DC    FL(PRDLENQ)'-2'     PRODUCT FOR UNALLOCATED                      
TOTPRD   DC    FL(PRDLENQ)'-1'     PRODUCT FOR TOTALS (GETS APOLPRD)            
                                                                                
UNTLIST  DS    0C                  ** FILE OPEN LIST **                         
UNTFILO  DC    C'U'                                                             
UNTFIL   DC    C'UNTFIL '                                                       
UNTDIRO  DC    C'U'                                                             
UNTDIR   DC    C'UNTDIR '                                                       
UNTLISTX DC    C'X'                                                             
                                                                                
BU1PUTL  DC    C'BU1PUT='                                                       
BU1RDHL  DC    C'BU1HIG='                                                       
BU1RSQL  DC    C'BU1SEQ='                                                       
BU2PUTL  DC    C'BU2PUT='                                                       
BU2RDHL  DC    C'BU2HIG='                                                       
BU2RSQL  DC    C'BU2SEQ='                                                       
                                                                                
UNITSL   DC    C'Units'                                                         
TOTALL   DC    C'Total'                                                         
CLASSEQL DC    C'Class='                                                        
WEEKL    DC    C'Week'                                                          
POLPRDL  DC    C'POL'                                                           
NOL      DC    C'NO'                                                            
UNALITL  DC    C'***'                                                           
C100L    DC    C'100'                                                           
PODL     DC    C'POD'                                                           
ALL3L    DS    0CL3                                                             
ALLL     DC    C'ALL  '                                                         
                                                                                
RQBYPSSL DC    C'**Request bypassed**'                                          
NUNTFRWK DC    C'**No units for this week**'                                    
AVALFRWK DC    C'Average values for week ='                                     
TOTALSL  DC    C'** Totals **'                                                  
TRUNFNML DC    C'**Test run-file not marked**'                                  
HIGHVALS DC    C'**High**'                                                      
                                                                                
DASHES   DC    30C'-'                                                           
T00A     DC    C'T00A'                                                          
EFFS     DC    8X'FF'                                                           
ZONES    DC    C'000000'                                                        
ALLDL    DC    AL1(ALLDPT,ALLLEN)                                               
ALLDLL   EQU   *-ALLDL                                                          
                                                                                
PDRFXSPL DC    AL1(01,00)          NON-POD DUMMY ENTRY                          
         DC    AL1(00,FF)                                                       
         DC    AL1(FF)                                                          
                                                                                
XSORTXA  DC    A(X'00FFFFFF')      FOR XSORT GOTOR CALLS                        
                                                                                
MAXNEG   DC    A(X'80000000')                                                   
MAXPOS   DC    A(X'7FFFFFFF')                                                   
                                                                                
FW1      DC    F'1'                                                             
FW10     DC    F'10'                                                            
FW100    DC    F'100'                                                           
FW133    DC    F'133'                                                           
FW150    DC    F'150'                                                           
FW1000   DC    F'1000'                                                          
FW10000  DC    F'10000'                                                         
FW100000 DC    F'100000'                                                        
                                                                                
HW1      DC    H'1'                                                             
HW20     DC    H'20'                                                            
HWHIVAL  DC    H'32767'                                                         
MAXBVAL  DC    D'2147483647'                                                    
P7EFFS   DC    P'2147483647'       PACKED VALUE OF X'7FFFFFFF'                  
         EJECT                                                                  
GLOBVARS DS    0D                  ** GLOBAL VARIABLES **                       
                                                                                
DIVDUB   DS    D                   USED BY DIVIDE ROUTINE                       
DIVWORK  DS    XL(L'DIVDUB*2)      USED BY DIVIDE ROUTINE                       
                                                                                
DEMOVALS DS    0A                  ** DEMO DISPLACEMENTS/LENGTHS **             
DEMOVDD  DS    A                   DISP. TO DEMO VALUES IN PTBUFFD              
DEMOVDL  DS    F                   LENGTH OF DEMO VALUES                        
DEMOVWD  DS    A                   DISP. TO DEMO WEIGHTS IN PTBUFFD             
DEMOVWL  DS    F                   LENGTH OF DEMO WEIGHTS                       
                                                                                
NETVALUE DS    A                   A(NETVALUE)                                  
                                                                                
ABRDTAB  DS    A                   A(BRAND TABLE)                               
                                                                                
AUNTTAB  DS    A                   A(UNIT TABLE)                                
UNTTABL  DS    F                   L'UNIT TABLE                                 
UNTTABN  DS    F                   NUMBER OF ENTRIES IN UNTTAB                  
                                                                                
SAVERE   DS    A                   SAVE AREA FOR RE                             
SAVERF   DS    A                   SAVE AREA FOR RF                             
SAVER0   DS    A                   SAVE AREA FOR R0                             
SAVER1   DS    A                   SAVE AREA FOR R1                             
                                                                                
HEXPARM  DS    4F                  HEXOUT PARAMETER LIST                        
                                                                                
XCTPARS  DS    0F                  ** XCTAB BINSRCH PARAMETERS **               
XCTAREC  DS    A                   A(RECORD)                                    
XCTATAB  DS    A                   A(TABLE)                                     
XCTNREC  DS    F                   N'RECORDS                                    
XCTLREC  DS    F                   L'RECORD                                     
XCTDSPC  DS    0XL1                DISPLACEMENT OF KEY                          
XCTLKEY  DS    F                   L'KEY                                        
XCTMREC  DS    F                   MAXIMUM N'RECORDS                            
                                                                                
THISPRD  DS    A                   A(CURRENT PRODUCT BUFFER ENTRY)              
THISUNT  DS    A                   A(CURRENT UNTTAB ENTRY)                      
BESTUNT  DS    A                   BEST VALUED UNIT                             
UNITA    DS    A                   A(UNIT A)                                    
UNITB    DS    A                   A(UNIT B)                                    
SLOTA    DS    A                   A(CURRENT UNITA SLOT)                        
SLOTB    DS    A                   A(CURRENT UNITB SLOT)                        
ASLOT    DS    A                   A(CURRENT UNIT SLOT)                         
                                                                                
CURAPRD  DS    A                   CURRENT ASSIGNED PRODUCT                     
BESTPRD  DS    A                   MOST DESERVING PRODUCT                       
HIGHPRD  DS    A                   BRAND W/HIGHEST NUMERICAL REMAINDER          
                                                                                
ASUPROW  DS    A                   A(SUPPLY ROW)                                
ATOTROW  DS    A                   A(TOTAL ROW)                                 
AEXCROW  DS    A                   A(EXCESS ROW)                                
                                                                                
AFSTBRD  DS    A                   A(ROW FOR FIRST PRODUCT)                     
APOLPRD  DS    A                   A(POL PRODUCT) PRODUCT BUFFER ENTRY          
                                                                                
CURVAL   DS    F                   CURRENT WEIGHTED BRAND VALUE                 
NEWVAL   DS    F                   NEW WEIGHTED BRAND VALUE                     
BESTVAL  DS    F                   BEST WEIGHTED (UNIT OR BRAND) VALUE          
BRDVAL   DS    F                   WEIGHTED BRAND VALUE                         
UNTVAL   DS    F                   WEIGHTED UNIT VALUE                          
HOLDVAR  DS    F                   VARIABLE HOLD AREA                           
                                                                                
FACTOR1  DS    F                                                                
FACTOR2  DS    F                                                                
                                                                                
WKCPD    DS    F                   WEEK'S AVERAGE CPP/CPM                       
WSECS    DS    F                   TOTAL SECONDS LENGTH TO BE ALLOCATED         
                                                                                
AWKVALS  DS    0F                  ** WEEKLY ALLOCATION VALUES **               
AWKNZCST DS    F                                                                
AWKNZBAS DS    F                                                                
AWKNZCSP DS    F                                                                
AWKNZDSP DS    F                                                                
AWKNZCPD DS    F                                                                
AWKRUNTS DS    F                                                                
AWKZUNTS DS    F                                                                
AWKRSECS DS    F                                                                
AWKZSECS DS    F                                                                
AWKTGAVG DS    F                   AVERAGE OF AVERAGES                          
AWKLOTRG DS    (PTZDEMMX+1)F                                                    
AWKAVGS  DS    (PTZDEMMX+1)F                                                    
AWKAVGSL EQU   *-AWKAVGS                                                        
AWKVALSL EQU   *-AWKVALS                                                        
                                                                                
WAVCOST  DS    F                   AVERAGE COST FOR N-Z UNITS                   
WAVBASD  DS    F                   AVERAGE BASE RATING FOR N-Z UNITS            
EQVUNTS  DS    F                   EQUIVALENT UNITS FOR ALLOCATION              
WAVGOAL  DS    F                   AVERAGE GOAL FOR WEEK                        
COSTSHR  DS    F                   COST SHARE                                   
                                                                                
ENVPCNT  DS    F                   COUNT OF PRODUCTS                            
ENVCCNT  DS    F                   COUNT OF CLASSES                             
ENVTCNT  DS    F                   PRODUCTS + CLASSES                           
                                                                                
VARWGTS  DS    0F                  ** VARIABLE WEIGHTS **                       
                                                                                
FILVAR   DS    F                   GOAL FULFILLMENT                             
CPMVAR   DS    F                   CPP/M DIVERGENCE                             
                                                                                
ENV1VAR  DS    F                   ENVIRONMENT 1 DISPERSION                     
ENV2VAR  DS    F                   ENVIRONMENT 2 DISPERSION                     
ENV3VAR  DS    F                   ENVIRONMENT 3 DISPERSION                     
ENVNVAR  EQU   (*-ENV1VAR)/L'ENV1VAR                                            
                                                                                
TG1VAR   DS    F                   TARGET 1 ACHIEVEMENT                         
TG2VAR   DS    F                   TARGET 2 ACHIEVEMENT                         
                                                                                
VARWGTSN EQU   (*-VARWGTS)/L'VARWGTS                                            
VARWGTSL EQU   *-VARWGTS                                                        
                                                                                
VARCTLD  EQU   *-VARWGTS                                                        
VARCTLS  DS    (VARWGTSN)F                                                      
                                                                                
VARVALD  EQU   *-VARWGTS                                                        
VARVALS  DS    (VARWGTSN)F                                                      
                                                                                
HOLDDEM  DS    (PTZDEMMX)F         HOLD DEMO VALUES                             
HOLDDEML EQU   *-HOLDDEM                                                        
                                                                                
SWAPS    DS    0X                  ** SWAPPING VARIABLES **                     
SWAPAA   DS    (SWAPN)F            HOLD AREA FOR SWAP VARIABLES                 
SWAPL    EQU   *-SWAPS                                                          
SWAPBB   DS    (SWAPN)F            HOLD AREA FOR SWAP VARIABLES                 
SWAPAB   DS    (SWAPN)F            HOLD AREA FOR SWAP VARIABLES                 
SWAPBA   DS    (SWAPN)F            HOLD AREA FOR SWAP VARIABLES                 
SWAPSN   EQU   (*-SWAPS)/SWAPL                                                  
SWAPN    EQU   VARWGTSN+1                                                       
                                                                                
OBJWGTS  DS    (VARWGTSN)AL1       OBJECTIVE WEIGHTS (1 PER VARIABLE)           
OBJWGTSL EQU   *-OBJWGTS                                                        
                                                                                
TOTDISP  DS    F                   DISPLACEMENT TO TOTAL                        
HIGHPRDN DS    H                   HIGHEST PRODUCT NUMBER IN PTBUFF             
AWKTPRDS DS    H                   TRUE ACTIVE BRAND COUNT                      
AWKAPRDS DS    H                   NUMBER OF ACTIVE BRANDS                      
NTARGETS DS    H                   NUMBER OF TARGETS                            
ENVPRDD  DS    H                   ENVIRONMENT TABLE PRODUCT DISP.              
ENVENVD  DS    H                   ENVIRONMENT TABLE ENV CODE DISP,             
CURDISP  DS    H                   DISPLACEMENT TO CURRENT VALUES               
NWKS     DS    H                   NUMBER OF WEEKS                              
NWKSP1   DS    H                   NUMBER OF WEEKS+1 (WITH TOTAL)               
SAVENWKS DS    H                   SAVED NWKS                                   
NPRDS    DS    H                   NUMBER OF PRODUCTS                           
NPRDSKIP DS    H                   NUMBER OF PRODUCTS TO SKIP                   
NPRDPRNT DS    H                   NUMBER OF PRODUCTS TO PRINT                  
CELLWID  DS    H                   CELL WIDTH (4 BYTES PER ITEM)                
WEEKWID  DS    H                   SPACE BETWEEN WEEK COLUMNS                   
ROWDISP  DS    H                   DISPLACEMENT TO ROW DESCRIPTION              
AMTDISP  DS    H                   DISPLACEMENT TO TOTAL                        
ROWLEN   DS    H                   LENGTH OF ROW                                
RPTNOWKS DS    H                   NUMBER OF REPORT WEEKS                       
WEEKDISP DS    H                   DISPLACEMENT TO CURRENT WEEK                 
UNTSEQ   DS    H                   UNIT SEQUENCE NUMBER                         
                                                                                
RUNFLAG  DS    X                   ** RUN FLAG **                               
RUNFSOON EQU   X'80'               RUNNING SOON REQUEST                         
                                                                                
REQFLAG1 DS    X                   ** REQUEST FLAGS 1 **                        
REQFQUIT EQU   X'80'               FORCED END OF REQUEST                        
REQFESTE EQU   X'40'               ESTIMATE CHECKING ERROR                      
REQFDPTR EQU   X'20'               AGENCY USES NEW DAYPART RECORDS              
REQFMIXG EQU   X'10'               MIXED GOALS                                  
REQFMIXB EQU   X'08'               MIXED BASIS                                  
REQFTRGS EQU   X'02'               TARGETS PRESENT                              
REQFHNAD EQU   X'01'               HAVE NAD DEMOS                               
                                                                                
REQFLAG2 DS    X                   ** REQUEST FLAGS 2 **                        
REQFSLEN EQU   X'80'               SEPARATE UNIT LENGTHS                        
REQFSDPT EQU   X'40'               SEPARATE DAYPARTS                            
                                                                                
CLTFLAG  DS    X                   ** CLIENT FLAGS **                           
CLTFOPRD EQU   X'80'               OVERFLOW PRODUCTS ON THIS CLIENT             
                                                                                
CLTCPRD  DS    CL(L'CPRPRD)        CORPORATE PRODUCT                            
                                                                                
UNTVALS  DS    0X                  ** UNIT VALUES **                            
UNTLEN   DS    XL(L'NULEN)         CURRENT UNIT LENGTH                          
UNTPRD1  DS    FL(PRDLENQ)         CURRENT ALLOCATED PRODUCT 1                  
UNTLEN1  DS    XL(L'NULEN1)        CURRENT PRODUCT 1 LENGTH                     
UNTPRD2  DS    FL(PRDLENQ)         CURRENT ALLOCATED PRODUCT 2                  
UNTLEN2  DS    XL(L'NULEN1)        CURRENT PRODUCT 2 LENGTH                     
UNTP1SHR DS    XL(L'NUP1SHR)       CURRENT PRODUCT 1 SHARE                      
UNTINFO  DS    X                   ** UNIT CHANGE INFO **                       
UNTIDUSE EQU   X'01'               DELETE UNIT SEQUENCE ELEMENT                 
UNTVALL  EQU   *-UNTVALS                                                        
                                                                                
ALCVALS  DS    0X                  ** ALLOCATION VALUES **                      
ALCLEN   DS    XL(L'NULEN)         NEW UNIT LENGTH                              
ALCPRD1  DS    FL(PRDLENQ)         NEW ALLOCATED PRODUCT 1                      
ALCLEN1  DS    XL(L'NULEN1)        NEW ALLOCATED PRODUCT 1 LENGTH               
ALCPRD2  DS    FL(PRDLENQ)         NEW ALLOCATED PRODUCT 2                      
ALCVALL  EQU   *-ALCVALS                                                        
                                                                                
ENVNO    DS    X                   ** CURRENT ENVIRONMENT NUMBER **             
ENVNPGMQ EQU   1                   PROGRAM ENVIRONMENT                          
ENVNNETQ EQU   2                   NETWORK ENVIRONMENT                          
ENVNDOWQ EQU   3                   DAY-OF-WEEK ENVIRONMENT                      
                                                                                
PEMODE   DS    X                   ** PRTENV FLAG **                            
PEMPREQ  EQU   X'80'               PRE-ALLOCATION                               
PEMPSTQ  EQU   X'40'               POST-ALLOCATION                              
                                                                                
PBMODE   DS    X                   ** PRTBUF FLAG **                            
PBMLSTQ  EQU   C'L'                LAST TIME                                    
PBMDPTQ  EQU   C'D'                OVERALL DAYPART BALANCING                    
PBMDRUQ  EQU   C'S'                DAYPART ROLLUP                               
                                                                                
PVMODE1  DS    X                   ** PRTVAR FLAG 1 **                          
                                                                                
PVMODE2  DS    X                   ** PRTVAR FLAG 2 **                          
PVMODE1Q EQU   C'1'                                                             
PVMODE2Q EQU   C'2'                                                             
                                                                                
WEEKNO   DS    X                   ALLOCATION WEEK NUMBER                       
                                                                                
ALPHASE  DS    C                   ** ALLOCATION PHASE **                       
ALPUNTQ  EQU   C'U'                UNIT PHASE                                   
ALPBRDQ  EQU   C'B'                BRAND PHASE                                  
ALPXCHQ  EQU   C'X'                EXCHANGE PHASE                               
ALPS30Q  EQU   C'3'                30'S PHASE                                   
                                                                                
ZSPASS   DS    C                   ** ZERO UNITS PASS FLAG **                   
ZSPYESQ  EQU   C'Y'                ZERO UNITS ONLY                              
ZSPNOQ   EQU   C'N'                NON-ZERO UNITS ONLY                          
ZSPTOGQ  EQU   C'T'                ZERO & NON-ZERO TOGETHER                     
                                                                                
ZEROA    DS    C                   VALUES CAN BE YESQ/NOQ                       
ZEROB    DS    C                   VALUES CAN BE YESQ/NOQ                       
                                                                                
LPRDLEN  DS    0XL(L'LPRD+L'LLEN)  ** LAST PRODUCT/LENGTH **                    
LPRD     DS    FL(PRDLENQ)         LAST PRODUCT POINTER                         
LLEN     DS    FL(L'GBLEN)         LAST UNIT LENGTH                             
                                                                                
CLASS1   DS    C                   PRODUCT CLASS 1                              
CLASS2   DS    C                   PRODUCT CLASS 2                              
                                                                                
HOLDPRD  DS    FL(PRDLENQ)         HOLD AREA FOR PRODUCT POINTER                
                                                                                
SVNBVAL1 DS    XL(NBACTSUB-NBACTDAT)                                            
SVNBVAL2 DS    XL(NBACTPAK-NBACTEST)                                            
                                                                                
CELLD    DS    H                   CURRENT CELL DISPLACEMENT                    
                                                                                
TYP      DS    X                   ** BUFFER RECORD TYPE **                     
                                                                                
TDEMQ    EQU   X'01'               DEMOS                                        
TDOLQ    EQU   X'02'               DOLLARS                                      
TUNTQ    EQU   X'03'               UNITS                                        
                                                                                
TGOLQ    EQU   X'10'                                                            
TGOLDEMQ EQU   TGOLQ+TDEMQ         GOAL DEMO                                    
TGOLDOLQ EQU   TGOLQ+TDOLQ         GOAL DOLLARS                                 
TGOLUNTQ EQU   TGOLQ+TUNTQ         GOAL UNITS                                   
                                                                                
TPREQ    EQU   X'20'                                                            
TPREDEMQ EQU   TPREQ+TDEMQ         PRE-ALLOCATED DEMO                           
TPREDOLQ EQU   TPREQ+TDOLQ         PRE-ALLOCATED DOLLARS                        
TPREUNTQ EQU   TPREQ+TUNTQ         PRE-ALLOCATED UNITS                          
                                                                                
TACHQ    EQU   X'30'                                                            
TACHDEMQ EQU   TACHQ+TDEMQ         ACHIEVED DEMO                                
TACHDOLQ EQU   TACHQ+TDOLQ         ACHIEVED DOLLARS                             
TACHUNTQ EQU   TACHQ+TUNTQ         ACHIEVED UNITS                               
                                                                                
TRSCQ    EQU   X'40'                                                            
TRSCGOLQ EQU   TRSCQ+TDEMQ         BALANCED AND ADJUSTED GOALS                  
                                                                                
TPRET00Q EQU   X'50'               BASE FOR PRE-ALLOCATED TARGET DEMO           
TPRET01Q EQU   TPRET00Q+1          PRE-ALLOCATED TARGET DEMO 1                  
TPRET02Q EQU   TPRET00Q+2          PRE-ALLOCATED TARGET DEMO 2                  
TPRET03Q EQU   TPRET00Q+3          PRE-ALLOCATED TARGET DEMO 3                  
TPRET04Q EQU   TPRET00Q+4          PRE-ALLOCATED TARGET DEMO 4                  
TPRET05Q EQU   TPRET00Q+5          PRE-ALLOCATED TARGET DEMO 5                  
TPRET06Q EQU   TPRET00Q+6          PRE-ALLOCATED TARGET DEMO 6                  
TPRET07Q EQU   TPRET00Q+7          PRE-ALLOCATED TARGET DEMO 7                  
TPRET08Q EQU   TPRET00Q+8          PRE-ALLOCATED TARGET DEMO 8                  
TPRET09Q EQU   TPRET00Q+9          PRE-ALLOCATED TARGET DEMO 9                  
TPRET10Q EQU   TPRET00Q+10         PRE-ALLOCATED TARGET DEMO 10                 
TPRET11Q EQU   TPRET00Q+11         PRE-ALLOCATED TARGET DEMO 11                 
TPRET12Q EQU   TPRET00Q+12         PRE-ALLOCATED TARGET DEMO 12                 
TPRET13Q EQU   TPRET00Q+13         PRE-ALLOCATED TARGET DEMO 13                 
TPRET14Q EQU   TPRET00Q+14         PRE-ALLOCATED TARGET DEMO 14                 
TPRET15Q EQU   TPRET00Q+15         PRE-ALLOCATED TARGET DEMO 15                 
TPRET16Q EQU   TPRET00Q+16         PRE-ALLOCATED TARGET DEMO 16                 
TPRET17Q EQU   TPRET00Q+17         PRE-ALLOCATED TARGET DEMO 17                 
TPRET18Q EQU   TPRET00Q+18         PRE-ALLOCATED TARGET DEMO 18                 
TPRET19Q EQU   TPRET00Q+19         PRE-ALLOCATED TARGET DEMO 19                 
TPRET20Q EQU   TPRET00Q+20         PRE-ALLOCATED TARGET DEMO 20                 
TPRET21Q EQU   TPRET00Q+21         PRE-ALLOCATED TARGET DEMO 21                 
TPRET22Q EQU   TPRET00Q+22         PRE-ALLOCATED TARGET DEMO 22                 
TPRET23Q EQU   TPRET00Q+23         PRE-ALLOCATED TARGET DEMO 23                 
TPRET24Q EQU   TPRET00Q+24         PRE-ALLOCATED TARGET DEMO 24                 
TPRET25Q EQU   TPRET00Q+25         PRE-ALLOCATED TARGET DEMO 25                 
TPRET26Q EQU   TPRET00Q+26         PRE-ALLOCATED TARGET DEMO 26                 
TPRET27Q EQU   TPRET00Q+27         PRE-ALLOCATED TARGET DEMO 27                 
TPRET28Q EQU   TPRET00Q+28         PRE-ALLOCATED TARGET DEMO 28                 
TPRET29Q EQU   TPRET00Q+29         PRE-ALLOCATED TARGET DEMO 29                 
TPRET30Q EQU   TPRET00Q+30         PRE-ALLOCATED TARGET DEMO 30                 
TPRET31Q EQU   TPRET00Q+31         PRE-ALLOCATED TARGET DEMO 31                 
TPRET32Q EQU   TPRET00Q+32         PRE-ALLOCATED TARGET DEMO 32                 
TPRET33Q EQU   TPRET00Q+33         PRE-ALLOCATED TARGET DEMO 33                 
TPRET34Q EQU   TPRET00Q+34         PRE-ALLOCATED TARGET DEMO 34                 
TPRET35Q EQU   TPRET00Q+35         PRE-ALLOCATED TARGET DEMO 35                 
TPRET36Q EQU   TPRET00Q+36         PRE-ALLOCATED TARGET DEMO 36                 
TPRET37Q EQU   TPRET00Q+37         PRE-ALLOCATED TARGET DEMO 37                 
TPRET38Q EQU   TPRET00Q+38         PRE-ALLOCATED TARGET DEMO 38                 
TPRET39Q EQU   TPRET00Q+39         PRE-ALLOCATED TARGET DEMO 39                 
TPRET40Q EQU   TPRET00Q+40         PRE-ALLOCATED TARGET DEMO 40                 
TPRET41Q EQU   TPRET00Q+41         PRE-ALLOCATED TARGET DEMO 41                 
TPRET42Q EQU   TPRET00Q+42         PRE-ALLOCATED TARGET DEMO 42                 
TPRET43Q EQU   TPRET00Q+43         PRE-ALLOCATED TARGET DEMO 43                 
TPRET44Q EQU   TPRET00Q+44         PRE-ALLOCATED TARGET DEMO 44                 
TPRET45Q EQU   TPRET00Q+45         PRE-ALLOCATED TARGET DEMO 45                 
TPRET46Q EQU   TPRET00Q+46         PRE-ALLOCATED TARGET DEMO 46                 
TPRET47Q EQU   TPRET00Q+47         PRE-ALLOCATED TARGET DEMO 47                 
TPRET48Q EQU   TPRET00Q+48         PRE-ALLOCATED TARGET DEMO 48                 
TPRET49Q EQU   TPRET00Q+49         PRE-ALLOCATED TARGET DEMO 49                 
TPRET50Q EQU   TPRET00Q+50         PRE-ALLOCATED TARGET DEMO 50                 
                                                                                
TACHT00Q EQU   X'90'               BASE FOR ACHIEVED TARGET DEMO                
TACHT01Q EQU   TACHT00Q+1          ACHIEVED FOR TARGET DEMO 1                   
TACHT02Q EQU   TACHT00Q+2          ACHIEVED FOR TARGET DEMO 2                   
TACHT03Q EQU   TACHT00Q+3          ACHIEVED FOR TARGET DEMO 3                   
TACHT04Q EQU   TACHT00Q+4          ACHIEVED FOR TARGET DEMO 4                   
TACHT05Q EQU   TACHT00Q+5          ACHIEVED FOR TARGET DEMO 5                   
TACHT06Q EQU   TACHT00Q+6          ACHIEVED FOR TARGET DEMO 6                   
TACHT07Q EQU   TACHT00Q+7          ACHIEVED FOR TARGET DEMO 7                   
TACHT08Q EQU   TACHT00Q+8          ACHIEVED FOR TARGET DEMO 8                   
TACHT09Q EQU   TACHT00Q+9          ACHIEVED FOR TARGET DEMO 9                   
TACHT10Q EQU   TACHT00Q+10         ACHIEVED FOR TARGET DEMO 10                  
TACHT11Q EQU   TACHT00Q+11         ACHIEVED FOR TARGET DEMO 11                  
TACHT12Q EQU   TACHT00Q+12         ACHIEVED FOR TARGET DEMO 12                  
TACHT13Q EQU   TACHT00Q+13         ACHIEVED FOR TARGET DEMO 13                  
TACHT14Q EQU   TACHT00Q+14         ACHIEVED FOR TARGET DEMO 14                  
TACHT15Q EQU   TACHT00Q+15         ACHIEVED FOR TARGET DEMO 15                  
TACHT16Q EQU   TACHT00Q+16         ACHIEVED FOR TARGET DEMO 16                  
TACHT17Q EQU   TACHT00Q+17         ACHIEVED FOR TARGET DEMO 17                  
TACHT18Q EQU   TACHT00Q+18         ACHIEVED FOR TARGET DEMO 18                  
TACHT19Q EQU   TACHT00Q+19         ACHIEVED FOR TARGET DEMO 19                  
TACHT20Q EQU   TACHT00Q+20         ACHIEVED FOR TARGET DEMO 20                  
TACHT21Q EQU   TACHT00Q+21         ACHIEVED FOR TARGET DEMO 21                  
TACHT22Q EQU   TACHT00Q+22         ACHIEVED FOR TARGET DEMO 22                  
TACHT23Q EQU   TACHT00Q+23         ACHIEVED FOR TARGET DEMO 23                  
TACHT24Q EQU   TACHT00Q+24         ACHIEVED FOR TARGET DEMO 24                  
TACHT25Q EQU   TACHT00Q+25         ACHIEVED FOR TARGET DEMO 25                  
TACHT26Q EQU   TACHT00Q+26         ACHIEVED FOR TARGET DEMO 26                  
TACHT27Q EQU   TACHT00Q+27         ACHIEVED FOR TARGET DEMO 27                  
TACHT28Q EQU   TACHT00Q+28         ACHIEVED FOR TARGET DEMO 28                  
TACHT29Q EQU   TACHT00Q+29         ACHIEVED FOR TARGET DEMO 29                  
TACHT30Q EQU   TACHT00Q+30         ACHIEVED FOR TARGET DEMO 30                  
TACHT31Q EQU   TACHT00Q+31         ACHIEVED FOR TARGET DEMO 31                  
TACHT32Q EQU   TACHT00Q+32         ACHIEVED FOR TARGET DEMO 32                  
TACHT33Q EQU   TACHT00Q+33         ACHIEVED FOR TARGET DEMO 33                  
TACHT34Q EQU   TACHT00Q+34         ACHIEVED FOR TARGET DEMO 34                  
TACHT35Q EQU   TACHT00Q+35         ACHIEVED FOR TARGET DEMO 35                  
TACHT36Q EQU   TACHT00Q+36         ACHIEVED FOR TARGET DEMO 36                  
TACHT37Q EQU   TACHT00Q+37         ACHIEVED FOR TARGET DEMO 37                  
TACHT38Q EQU   TACHT00Q+38         ACHIEVED FOR TARGET DEMO 38                  
TACHT39Q EQU   TACHT00Q+39         ACHIEVED FOR TARGET DEMO 39                  
TACHT40Q EQU   TACHT00Q+40         ACHIEVED FOR TARGET DEMO 40                  
TACHT41Q EQU   TACHT00Q+41         ACHIEVED FOR TARGET DEMO 41                  
TACHT42Q EQU   TACHT00Q+42         ACHIEVED FOR TARGET DEMO 42                  
TACHT43Q EQU   TACHT00Q+43         ACHIEVED FOR TARGET DEMO 43                  
TACHT44Q EQU   TACHT00Q+44         ACHIEVED FOR TARGET DEMO 44                  
TACHT45Q EQU   TACHT00Q+45         ACHIEVED FOR TARGET DEMO 45                  
TACHT46Q EQU   TACHT00Q+46         ACHIEVED FOR TARGET DEMO 46                  
TACHT47Q EQU   TACHT00Q+47         ACHIEVED FOR TARGET DEMO 47                  
TACHT48Q EQU   TACHT00Q+48         ACHIEVED FOR TARGET DEMO 48                  
TACHT49Q EQU   TACHT00Q+49         ACHIEVED FOR TARGET DEMO 49                  
TACHT50Q EQU   TACHT00Q+50         ACHIEVED FOR TARGET DEMO 50                  
                                                                                
PROGPROA DS    0XL16               ** SPK5A PROFILE VALUES **                   
OBJ1WGHT DS    C                   GOAL FULFILLMENT                             
OBJ2WGHT DS    C                   CPP/M EQUALIZATION                           
OBJ3WHGT DS    C                   SCHEDULE BALANCING - PROGRAM                 
OBJ4WGHT DS    C                                      - NETWORK                 
OBJ5WGHT DS    C                                      - DAY OF WEEK             
OBJ6WGHT DS    C                   TARGET 1 MAXIMIZATION                        
OBJ7WGHT DS    C                   TARGET 2 MAXIMIZATION                        
         DS    C                   N/D                                          
         DS    C                   N/D                                          
         DS    C                   N/D                                          
         DS    C                   N/D                                          
RPRGOPTN DS    C                   PROGRAM RECAP BY PROGRAM TYPE?               
CPMSOPTN DS    C                   CPP/M EQU. BY WEEK OR SCHEDULE               
CPMSWKYQ EQU   C'W'                WEEKLY                                       
CPMSDLNQ EQU   C'S'                DAYPART/UNIT LENGTH                          
PCHAOPTN DS    C                   POD CHANGE ANALYSIS SECTION                  
OFLOOPTN DS    C                   OVERFLOW OPTION (SEE NETUNT)                 
FCGLOPTN DS    C                   **DDS USE ONLY** (MIX)                       
                                                                                
PROGPROB DS    0XL16               ** SPK5B PROFILE OPTIONS **                  
SPLDOPTN DS    C                   SPLIT $ OPTION                               
SPLDDOLQ EQU   C'$'                ROUND SPLIT POD TO DOLLARS                   
SPLPOPTN DS    C                   SPLIT/PIGGYBACK PODS                         
SPLPGPPQ EQU   C'P'                DOING PSEUDO-PIGS                            
         DS    C                   N/D                                          
GDEMOPTN DS    C                   FORCE GOAL DEMOS TO RATINGS                  
NROTOPTN DS    C                   (NETPAK) USE ROTATION? - NETWORK             
CROTOPTN DS    C                                          - CABLE               
SROTOPTN DS    C                                          - SYNDICATION         
OROTOPTN DS    C                                          - OTHER               
         DS    C                   N/D                                          
ONETOPTN DS    C                   ONE NETWORK REALLOCATION                     
INTGOPTN DS    C                   INCLUDE INTEGRATION COSTS?                   
SKIPOPTN DS    C                   SKIP BONUS UNITS?                            
BBCLOPTN DS    C                   CLEAR BILLBOARD INFO?                        
ICSPOPTN DS    C                   INCLUDE COPY SPLITS                          
SPCLOPTN DS    C                   SPECIAL CLASS CODE (OR BINARY ZERO)          
ZCSTOPTN DS    C                   SKIP ZERO COST UNITS?                        
                                                                                
REALLSDT DS    XL2                 RE-ALLOCATION START (WEEK) DATE              
                                                                                
REALLOC  DS    X                   RE-ALLOCATION SWITCH (YESQ/NOQ/WKNO)         
                                                                                
NTUPODSW DS    C                   ** NETUNT SWITCH **                          
NTUPFLSQ EQU   C'F'                FLUSHING POD TABLE                           
NTUPBLDQ EQU   C'Y'                BUILDING POD DESCRIPTION ONLY                
NTUPNOTQ EQU   C'N'                NOT A POD                                    
                                                                                
GOALOPT  DS    C                   ** GOALS OPTION **                           
GOALDOLS EQU   C'$'                DOLLAR GOALS                                 
GOALDEMS EQU   C'D'                DEMO GOALS                                   
                                                                                
ZERWKOPT DS    C                   ** ZERO WEEKS OPTION **                      
ZERWIGNQ EQU   C'N'                IGNORE                                       
ZERWERRQ EQU   C'E'                ERROR                                        
ZERWPRVQ EQU   C'P'                USE PREVIOUS WEEK                            
ZERWZERQ EQU   C'A'                USE AVERAGE WEEK                             
                                                                                
RSWKOPT  DS    C                   ** RESCALE OPTION **                         
RSWKBALQ EQU   C'B'                BALANCING ONLY                               
RSWKREPQ EQU   C'R'                REPORT ONLY                                  
RSWKNOQ  EQU   C'N'                NO GOAL BALANCING                            
RSWKYESQ EQU   C'Y'                GOAL BALANCING ON                            
                                                                                
EXCSOPT  DS    C                   VALUES CAN BE YESQ/NOQ                       
PCTOPT   DS    C                   VALUES CAN BE YESQ/NOQ                       
                                                                                
ACHSW    DS    C                   ** ADDACH SWITCH **                          
ACHSSUBQ EQU   C'+'                SUBTRACT ACHIEVEMENT                         
ACHSADDQ EQU   C'-'                ADD ACHIEVEMENT                              
                                                                                
DPSLFLT  DS    0XL2                ** DAYPART/LENGTH FILTER **                  
DPTFLT   DS    C                   DAYPART FILTER                               
LENFLT   DS    X                   UNIT LENGTH FILTER                           
LENFPODO EQU   C'P'                POD SPLIT REQUEST ONLY                       
                                                                                
CORPDEM  DS    XL4                 CORPORATE (POL) TARGET DEMO                  
                                                                                
TARGETS  DS    (PTZDEMMX)XL4       TARGET DEMO LIST                             
TARGETSL EQU   *-TARGETS                                                        
                                                                                
ACTDEMS  DS    0XL(PTZDEMMX)       ** ACTIVE TARGET DEMOS **                    
ACTDEMSL DS    (PTZDEMMX)X                                                      
                                                                                
PMHLSW   DS    C                   ** PARREP SWITCH **                          
PMHLBRDQ EQU   C'B'                DOING BRAND LIST HEADINGS                    
                                                                                
TRGBASE  DS    C                   ** TARGET VALUE BASE **                      
TRGBDOLS EQU   C'$'                DOLLARS                                      
TRGBDEMS EQU   C'D'                DEMOS                                        
                                                                                
PODDESC  DS    0H                  ** POD SPLIT DEFINITION **                   
PODLENS  DS    10AL1                                                            
PODLENN  EQU   (*-PODLENS)/L'PODLENS                                            
PODLENSN DS    H                                                                
PODSUBL  DS    H                                                                
PODEQU   DS    H                                                                
         ORG   PODEQU+(L'PODEQU-L'PODLEN)                                       
PODLEN   DS    X                                                                
PODPRNT  DS    CL20                                                             
PODDSCL  EQU   *-PODDESC           LENGTH OF POD DESCRIPTOR                     
                                                                                
PODRSW   DS    C                   VALUES ARE YESQ/NOQ                          
PODCOD   DS    C                   POD CODE SET FROM REQUEST                    
PODNUM   DS    X                   POD NUMBER (1=A, 2=B ETC)                    
                                                                                
DPSLDESC DS    CL40                DAYPART/LENGTH DESCRIPTION                   
                                                                                
DSTAB    DS    0XL2                ** DAYPART/UNIT LENGTH TABLE **              
DSTABMAX EQU   30                                                               
         DS    (DSTABMAX)XL(L'DSTAB)                                            
DSTABL   EQU   *-DSTAB                                                          
                                                                                
DSSW     DS    C                   ** DAYPART RESCALING SWITCH **               
DSSCURQ  EQU   C'C'                DAYPART RESCALING IN PROGRESS                
DSSYESQ  EQU   C'Y'                DAYPART RESCALED                             
DSSNOQ   EQU   C'N'                DAYPART RESCALING NOT DONE                   
                                                                                
DLCNT    DS    X                   DAYPART/LENGTH COUNT                         
                                                                                
PRESW    DS    C                   PRE-ALLOCATION SWITCH                        
ZERWKSW  DS    X                   ZERO WEEK ERROR SWITCH                       
                                                                                
MKTBUYGL DS    X                   ** MARKET BUY/GOALS FLAG **                  
MKTBHBUY EQU   X'80'               MARKET HAS BUYS                              
MKTBHGOL EQU   X'08'               MARKET HAS GOALS                             
                                                                                
RSLCNT   DS    X                   RSLOOP ITERATION COUNTER                     
                                                                                
PRDCLSSW DS    C                   ** PRODUCT/CLASS SWITCH **                   
PRDCLSP  EQU   C'P'                PRODUCT                                      
PRDCLSC  EQU   C'C'                CLASS                                        
                                                                                
INTRVLS  DS    0X                  ** BRAND/CLASS INTERVALS **                  
PINTRVL  DS    X                   BRAND TIME INTERVAL (MINUTES)                
PINTPCT  DS    X                   BRAND PERCENT LEEWAY                         
CINTRVL  DS    X                   CLASS TIME INTERVAL (MINUTES)                
CINTPCT  DS    X                   CLASS PERCENT LEEWAY                         
INTRVLSL EQU   *-INTRVLS                                                        
                                                                                
NOMID    DS    C                   Y=SUPPRESS CONTINUED MESSAGE                 
                                                                                
SRPNL1   DS    CL60                                                             
SRPNL2   DS    CL60                                                             
                                                                                
HCLASS   DS    XL(L'PTCLASS)                                                    
HDEM     DS    XL(L'CORPDEM)                                                    
                                                                                
RSCHGSW  DS    C                                                                
                                                                                
RWILNSW  DS    C                   ** GETROW SWITCH **                          
RWILSEP  EQU   C'S'                KEEP LENGTHS SEPARATE                        
RWILTOG  EQU   C'T'                                                             
                                                                                
PSLSW    DS    C                   ** REPORT SWITCH **                          
PSLSONE  EQU   C'S'                SINGLE UNITLEN FOR POD                       
PSLSALL  EQU   C'T'                ALL UNITLENS FOR POD                         
PSLSNOT  EQU   C'N'                NO POD/UNITLENS                              
                                                                                
SUMRPTSW DS    X                                                                
WLENFLT  DS    X                                                                
PDRBUNL  DS    X                                                                
                                                                                
RPTSWK   DS    X                                                                
                                                                                
PREPRD   DS    FL(PRDLENQ)         PUTBUF CURRENT PRODUCT POINTER               
PRELEN   DS    XL(L'UNTLEN1)       PUTBUF CURRENT LENGTH                        
PRECLASS DS    XL(L'PTCLASS)       PUTBUF CURRENT PRODUCT CLASS                 
                                                                                
PUTPASS  DS    X                   PUTBUF PASS NUMBER                           
                                                                                
EXCHSW   DS    X                   ** EXCHANGE SWITCH **                        
EXCHCURQ EQU   C'C'                                                             
EXCHREVQ EQU   C'R'                                                             
EXCHNULQ EQU   X'0'                                                             
                                                                                
FASTPOD  DS    C                   FAST POD ALLOCATION (YESQ/NOQ)               
                                                                                
SAVBUFFK DS    XL(GBUFFKL)         SAVED BUFFER KEY                             
LSTBUFFK DS    XL(GBUFFKL)         LAST BUFFER KEY                              
                                                                                
SVQNET   DS    CL(L'QNET)          SAVED QNET VALUE                             
                                                                                
HDEMO    DS    XL20                                                             
                                                                                
PODCHGSW DS    C                                                                
PODRPTSW DS    C                                                                
PODUPDER DS    C                                                                
                                                                                
PDRPRDL  EQU   8                                                                
PDRPRDS  DS    XL(7*PDRPRDL)                                                    
PDRBLST  DS    XL(7*PDRPRDL)                                                    
PDRLEN   DS    X                                                                
PDRANXT  DS    A                                                                
PDRASLT  DS    A                                                                
PDRAFST  DS    A                                                                
PDRFSPL  DS    A                                                                
PDRVTOT  DS    F                                                                
PDRAVG   DS    F                                                                
PDRBAVG  DS    F                                                                
PDRSVAL  DS    XL(UBPRDSL)         SAVE AREA FOR INITIAL ALLOCATION             
PDRPMAX  DS    H                   MAXIMUM COUNT FOR PRODUCT/PROGRAM            
PDRCMAX  DS    H                   MAXIMUM COUNT FOR CLASS/PROGRAM              
PDRRSECS DS    H                   REMAINING SECONDS FOR PROGRAM                
PDRBSECS DS    H                   BLOCKED SECONDS                              
PDRBBLK  DS    H                   BEST (IE LEAST) BLOCKING SCORE               
                                                                                
APCSW    DS    X                   APC ON/OFF SWITCH                            
                                                                                
GBUFFR   DS    0F                  ** BUFFER RECORD LAYOUT **                   
GBUFEOTQ EQU   FF                  END OF TABLE INDICATOR                       
                                                                                
GBUFFK   DS    0X                  ** KEY **                                    
GBDPT    DS    X                   DAYPART                                      
GBLEN    DS    X                   UNIT LENGTH 0=PODS                           
GBPRD    DS    AL3                 PRODUCT                                      
GBTYP    DS    X                   SEE TYP EQUATES                              
GBCLASS  DS    X                   PRODUCT CLASS                                
GBUFFKL  EQU   *-GBUFFK            KEY LENGTH                                   
                                                                                
GBPRI    DS    X                   PRIORITY CODE                                
GBUFFHL  EQU   *-GBUFFK            HEADER LENGTH                                
                                                                                
GBROW    DS    0F                  ** DATA **                                   
GBTOT    DS    F                   TOTAL OF ALL WEEKS                           
GBWKS    DS    (MAXWEEKS)F         WEEKLY TOTALS                                
GBWKSL   EQU   *-GBWKS                                                          
GBROWL   EQU   *-GBROW                                                          
GBROWN   EQU   (*-GBROW)/L'GBROW                                                
                                                                                
GBUFFRL  EQU   *-GBUFFR                                                         
                                                                                
         DS    0F                                                               
WORK1    DS    XL256               WORK AREA 1                                  
WORK2    DS    XL(L'PODPRDS)       WORK AREA 2                                  
                                                                                
DEMNMSN  EQU   PTZDEMMX+6          ** DEMO NAMES **                             
DEMNMS   DS    (DEMNMSN)XL(DEMNLENQ)                                            
DEMNMSL  EQU   *-DEMNMS                                                         
                                                                                
GLOBVARL EQU   *-GLOBVARS                                                       
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Global routines                                                     *         
***********************************************************************         
                                                                                
EXIT     IPM   R0                  SAVE CONDITION CODE                          
         C     RD,NTRYRD           TEST EXITING OUT                             
         JNE   *+6                                                              
         SAM24 ,                   YES - SET 24 BIT ADDRESSING MODE             
         SPM   R0                  RESTORE CONDITION CODE                       
         L     RD,4(RD)            TAKE BACKWARD LINK                           
         LM    RE,RC,12(RD)        RESTORE CALLER'S REGISTERS                   
         BR    RE                  RETURN WITH CC INTACT                        
                                                                                
ENDREQ   GOTOR REPORT,XA=OFF       REQUEST ERRORS                               
         OI    REQFLAG1,REQFQUIT   SET FORCED END OF REQUEST                    
         GOTOR AENDREQ,XA=OFF                                                   
         J     EXIT                                                             
                                                                                
LOCPRD   ST    RF,12(RD)           POINT TO PTBUFF ENTRY FOR PRODUCT            
         L     RF,APOLPRD          POINT TO POL ENTRY                           
         CLC   TOTPRD,0(R1)        TOTAL POINTS TO POL ENTRY                    
         JE    LOCPRDX                                                          
         CLC   UNAPRD,0(R1)        UNALLOCATED POINTS TO POL ENTRY              
         JE    LOCPRDX                                                          
         SR    RF,RF               CAN'T BE SUPPLY                              
         ICM   RF,PRDMSKQ,0(R1)                                                 
         JNZ   LOCPRDX                                                          
         DC    H'0'                                                             
LOCPRDX  LR    R1,RF               RETURN A(ENTRY) IN R1                        
         L     RF,12(RD)                                                        
         BR    RE                                                               
                                                                                
LOCPRA   STM   RE,R0,12(RD)        SEARCH PTBUFF FOR PRODUCT CODE               
         L     RF,PRDBUFF                                                       
         LH    R0,HIGHPRDN         MAXIMUM PRODUCTS                             
LOCPRA02 CLC   PTPRDA-PTBUFFD(,RF),0(R1)                                        
         JE    LOCPRAX                                                          
         AH    RF,PRDBUFLN                                                      
         JCT   R0,LOCPRA02                                                      
         CHI   R0,1                SET CC=NOT EQUAL IF NOT FOUND                
LOCPRAX  LR    R1,RF               RETURN A(ENTRY) IN R1                        
         LM    RE,R0,12(RD)                                                     
         BR    RE                                                               
                                                                                
LOCPRN   STM   RE,R0,12(RD)        SEARCH PTBUFF FOR PRODUCT NUMBER             
         L     RF,PRDBUFF                                                       
         LH    R0,HIGHPRDN         MAXIMUM PRODUCTS                             
LOCPRN02 CLC   PTPRDN-PTBUFFD(,RF),0(R1)                                        
         JE    LOCPRNX                                                          
         AH    RF,PRDBUFLN                                                      
         JCT   R0,LOCPRN02                                                      
         CHI   R0,1                SET CC=NOT EQUAL IF NOT FOUND                
LOCPRNX  LR    R1,RF               RETURN A(ENTRY) IN R1                        
         LM    RE,R0,12(RD)                                                     
         BR    RE                                                               
                                                                                
DEMNAM   LA    RF,DEMNMS           GET FULL DEMO NAME IN WORK+3                 
         USING DEMNAMD,RF                                                       
         MVC   WORK(L'DEMNDEMN),0(R1)                                           
         MVC   WORK+L'DEMNDEMN(20),SPACES                                       
         LHI   R0,DEMNMSN                                                       
         CLC   DEMNDEMN,WORK                                                    
         JE    DEMNAM02                                                         
         AHI   RF,DEMNLENQ                                                      
         JCT   R0,*-14                                                          
         MVC   WORK(DEMNLENQ),SPACES                                            
         MVI   WORK+(DEMNNAME-DEMNAMD),C'?'                                     
         LA    RF,WORK                                                          
         BR    RE                                                               
                                                                                
DEMNAM02 MVC   WORK+L'DEMNDEMN(L'DEMNNAME),DEMNNAME                             
         CLI   DEMNDEMN,0                                                       
         JE    *+10                                                             
         MVC   WORK+L'DEMNDEMN(L'DEMNNADP+L'DEMNNAME),L'DEMNDEMN(RF)            
         BR    RE                                                               
         DROP  RF                                                               
                                                                                
CLRBRD   STM   RE,R1,12(RD)        CLEAR BRDTAB TO BINARY ZEROES                
         L     R0,ABRDTAB                                                       
         AHI   R0,8                ADJUST FOR EYECATCHER                        
         L     R1,LBRDTAB                                                       
         SHI   R1,8                ADJUST FOR EYECATCHER                        
         J     CLEAR2                                                           
                                                                                
CLEAR    STM   RE,R1,12(RD)        GENERAL CLEAR ROUTINE                        
                                                                                
CLEAR2   SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LM    RE,R1,12(RD)                                                     
         BR    RE                                                               
                                                                                
GETWKN   L     RF,AWEEKLST         LOOK UP WEEK NUMBER                          
         LHI   R0,1                                                             
GETWKN02 CLC   0(2,R1),2(RF)                                                    
         JNH   GETWKN04                                                         
         CLI   0(RF),0                                                          
         JE    GETWKN04                                                         
         AHI   RF,L'MEDQ1WKS                                                    
         AHI   R0,1                                                             
         J     GETWKN02                                                         
GETWKN04 LR    RF,R0                                                            
         BR    RE                                                               
                                                                                
DIVIDE   LTR   RF,RF               TEST DIVIDE BY ZERO                          
         JNZ   *+8                                                              
         SR    R1,R1               YES - RETURN ZERO                            
         BR    RE                                                               
         STM   R0,R1,DIVDUB        SAVE 64 BIT VALUE                            
         LG    GR1,DIVDUB          GET 64 BIT VALUE INTO GR1                    
         MGHI  GR1,2               MULTIPLY DIVIDEND BY 2                       
         DSGFR GR0,RF              DIVIDE BY 32 BIT DIVISOR                     
         LTGR  GR1,GR1             TEST QUOTIENT IS NEGATIVE                    
         JNP   *+8                                                              
         AGHI  GR1,1               NO - ADD 1                                   
         SRAG  GR1,GR1,1           DIVIDE QUOTIENT BY 2                         
         CG    GR1,MAXBVAL         TEST QUOTIENT EXCEEDS 31 BIT VALUE           
         JH    *+8                                                              
         CR    RE,RE               NO - SET CONDITION CODE TO EQUAL             
         BR    RE                                                               
         SR    R1,R1               SET QUOTIENT TO ZERO                         
         CR    RE,R1               AND SET CONDITION CODE TO HIGH               
         BR    RE                                                               
                                                                                
DIVIDEP  SRP   DIVWORK(L'DIVDUB*2),1,0                                          
         CVD   RF,DIVDUB                                                        
         DP    DIVWORK(L'DIVDUB*2),DIVDUB                                       
         SRP   DIVWORK(L'DIVDUB),64-1,5                                         
         SR    R1,R1                                                            
         CP    DIVWORK(L'DIVDUB),P7EFFS TEST RESULT LARGER THAN LARGEST         
         BHR   RE                                                               
         CVB   R1,DIVWORK                                                       
         BR    RE                                                               
                                                                                
***********************************************************************         
* Note:- BUFFER 1 records are built with binary accumulators - these  *         
* are converted to packed in the routines below.  This is done so     *         
* that pennies may be posted for the goals (TGOLDOLQ) in order to get *         
* the correct supply total (the old version of the K5 would round the *         
* values to dollars before posting - this caused dollar differences   *         
* in the supply total).  When reading the TGOLDOLQ records the total  *         
* and weekly accumulators are rounded to dollars so that no other     *         
* code changes are necessary in this program.  When tracing BUFFER 1  *         
* I/O the binary records are printed.                                 *         
***********************************************************************         
                                                                                
BU1INI   STM   RE,R1,SAVERE        INITIALIZE BUFFER 1                          
         L     RF,ABUFF1                                                        
         USING BUFFD,RF                                                         
         LHI   R0,GBUFFKL                                                       
         STCM  R0,3,BUFFLKEY       KEY LENGTH                                   
         LHI   R0,L'GBPRI                                                       
         STCM  R0,3,BUFFLCOM       COMMENT LENGTH                               
         MVI   BUFFNCOL,MAXWEEKS+1 NUMBER OF ACCUMULATORS                       
         NI    BUFFINDS,BUFFIINI                                                
         OI    BUFFINDS,BUFFIPAK                                                
         DROP  RF                                                               
         GOTOR BUFFERIN,DMCB,('BUFFAINI',ABUFF1),0,ACOMFACS,XA=OFF              
BU1INIX  LM    RE,R1,SAVERE                                                     
         BR    RE                                                               
                                                                                
BU1CLO   ST    RE,SAVERE           CLOSE BUFFER 1                               
         GOTOR BUFFERIN,DMCB,('BUFFACLO',ABUFF1),0,ACOMFACS,XA=OFF              
BU1CLOX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU1RDH   NTR1  LABEL=NO            READ HIGH BUFFER 1                           
         L     RF,ABUFF                                                         
         MVC   0(L'ABUFFK,RF),GBUFFK                                            
         GOTOR BUFFERIN,DMCB,('BUFFARDH',ABUFF1),(RF),ACOMFACS,XA=OFF           
         LA    R0,BU1RDHL                                                       
         TM    DM2,EOFQ                                                         
         J     BU1CNV                                                           
                                                                                
BU1RSQ   NTR1  LABEL=NO            READ SEQUENTIAL BUFFER 1                     
         L     RF,ABUFF                                                         
         MVC   0(L'ABUFFK,RF),GBUFFK                                            
         GOTOR BUFFERIN,DMCB,('BUFFASEQ',ABUFF1),(RF),ACOMFACS,XA=OFF           
         LA    R0,BU1RSQL                                                       
         TM    DM2,EOFQ                                                         
         J     BU1CNV                                                           
                                                                                
BU1GET   NTR1  LABEL=NO            GET BUFFER 1 RECORD                          
         L     RF,ABUFF                                                         
         MVC   0(L'ABUFFK,RF),GBUFFK                                            
         GOTOR BUFFERIN,DMCB,('BUFFAGET',ABUFF1),(RF),ACOMFACS,XA=OFF           
         TM    DM2,NTFQ                                                         
         SR    R0,R0               NO TRACE REQUIRED FOR GET                    
                                                                                
BU1CNV   JNZ   EXIT                EXIT IF NOT GOOD COMPLETION                  
         LR    R6,R0               SAVE TRACE TYPE                              
         L     R2,ABUFF                                                         
         USING ABUFFD,R2           CONVERT RECORD TO BINARY IN GBUFF            
         MVC   GBUFFK(GBUFFHL),ABUFFK                                           
         LA    R3,ABTOT            R2=A(WEEKLY ACCUMULATORS)                    
         LA    R4,GBTOT                                                         
         LHI   R5,MAXWEEKS+1       R3=NUMBER OF WEEKS                           
BU1CNV02 ZAP   DIVWORK(8),0(L'ABTOT,R3)                                         
         CLI   GBTYP,TGOLDOLQ      TEST NEEDS SCALING                           
         JNE   BU1CNV04                                                         
         ZAP   DIVWORK,0(L'ABTOT,R3)                                            
         LHI   RF,100                                                           
         GOTOR DIVIDEP                                                          
BU1CNV04 CVB   R0,DIVWORK          CONVERT TO BINARY                            
         ST    R0,0(R4)                                                         
         AHI   R3,L'ABTOT                                                       
         AHI   R4,L'GBTOT                                                       
         JCT   R5,BU1CNV02                                                      
         LTR   R6,R6               TEST TRACE REQUIRED                          
         JZ    BU1CNVX                                                          
         GOTOR BU1HEX,(R6)         PRINT TRACE IF REQUIRED                      
BU1CNVX  CR    RE,RE                                                            
         J     EXIT                                                             
         DROP  R2                                                               
                                                                                
BU1PUT   NTR1  LABEL=NO            PUT BUFFER 1 RECORD                          
         TM    DIAGNOP2,DTRCKEYQ   TEST TRACING SPECIFIC KEY                    
         JNZ   BU1PUT02                                                         
         CLC   GBUFFK(GBUFFKL),DIEKEY                                           
         JNE   BU1PUT02                                                         
         DC    H'0'                                                             
                                                                                
BU1PUT02 L     R2,ABUFF            CONVERT RECORD TO PACKED IN ABUFFER          
         USING ABUFFD,R2                                                        
         MVC   ABUFFK,GBUFFK       SET KEY AND COMMENT                          
         LA    R3,GBTOT                                                         
         LA    R4,ABTOT                                                         
         LHI   R5,MAXWEEKS+1                                                    
BU1PUT04 L     R0,0(R3)            CONVERT ACCUMULATORS TO PACKED               
         CVD   R0,DIVDUB                                                        
         ZAP   0(L'ABTOT,R4),DIVDUB                                             
         AHI   R3,L'GBTOT                                                       
         AHI   R4,L'ABTOT                                                       
         JCT   R5,BU1PUT04                                                      
         GOTOR BU1HEX,BU1PUTL                                                   
         GOTOR BUFFERIN,DMCB,('BUFFAPUT',ABUFF1),(R2),ACOMFACS,XA=OFF           
BU1PUTX  J     EXIT                                                             
         DROP  R2                                                               
                                                                                
BU1HEX   TM    DIAGNOP2,DTRCKEYQ   TEST TRACING SPECIFIC KEY                    
         JZ    BU1HEX02                                                         
         CLC   GBUFFK(GBUFFKL),DIEKEY                                           
         JE    BU1HEX04                                                         
BU1HEX02 TM    DIAGNOP2,DPRTBUFQ   TEST TRACE REQUIRED                          
         BZR   RE                                                               
                                                                                
BU1HEX04 NTR1  LABEL=NO                                                         
         MVC   P1(7),0(R1)                                                      
         GOTOR HEXOUT,HEXPARM,GBUFFK,P1+7,GBWKS-GBUFFK,NOL,XA=OFF               
         GOTOR (RF),(R1),GBWKS,P2+7,GBWKSL/2,NOL,XA=OFF                         
         GOTOR (RF),(R1),GBWKS+(GBWKSL/2),P3+7,GBWKSL/2,NOL,XA=OFF              
         MVI   P4,0                                                             
         GOTOR REPORT,XA=OFF                                                    
         J     EXIT                                                             
                                                                                
BU2INI   ST    RE,SAVERE           INITIALIZE BUFFER 2                          
         GOTOR BUFFERIN,DMCB,('BUFFAINI',ABUFF2),0,ACOMFACS,XA=OFF              
         L     RE,0(R1)                                                         
         LH    RE,BUFFLREC-BUFFD(RE)                                            
         ST    RE,UNTTABL                                                       
BU2INIX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU2CLO   ST    RE,SAVERE           CLOSE BUFFER 2                               
         GOTOR BUFFERIN,DMCB,('BUFFACLO',ABUFF2),0,ACOMFACS,XA=OFF              
BU2CLOX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU2RDH   STM   RE,R1,SAVERE        READ HIGH BUFFER 2                           
         LR    R0,R1                                                            
         GOTOR BUFFERIN,DMCB,('BUFFARDH',ABUFF2),(R0),ACOMFACS,XA=OFF           
         GOTOR BU2HEX,BU2RDHL                                                   
         TM    DM2,EOFQ                                                         
BU2RDHX  LM    RE,R1,SAVERE                                                     
         BR    RE                                                               
                                                                                
BU2RSQ   STM   RE,R1,SAVERE        READ SEQUENTIAL BUFFER 2                     
         LR    R0,R1                                                            
         GOTOR BUFFERIN,DMCB,('BUFFASEQ',ABUFF2),(R0),ACOMFACS,XA=OFF           
         GOTOR BU2HEX,BU2RSQL                                                   
         TM    DM2,EOFQ                                                         
BU2RSQX  LM    RE,R1,SAVERE                                                     
         BR    RE                                                               
                                                                                
BU2PUT   STM   RE,R1,SAVERE        PUT BUFFER 2 RECORD                          
         LR    R0,R1                                                            
         GOTOR ,DMCB,('BUFFAPUT',ABUFF2),(R0),ACOMFACS                          
         GOTOR BU2HEX,BU2PUTL                                                   
         GOTOR BUFFERIN,DMCB,XA=OFF                                             
BU2PUTX  LM    RE,R1,SAVERE                                                     
         BR    RE                                                               
                                                                                
BU2HEX   TM    DIAGNOP2,DPRTBUFQ   TEST TRACE REQUIRED                          
         BZR   RE                                                               
                                                                                
         NTR1  LABEL=N                                                          
         MVC   P1(7),0(R1)                                                      
         L     R2,ABUFF2                                                        
         LH    R2,BUFFLREC-BUFFD(R2)                                            
         L     R3,DM2                                                           
         GOTOR HEXOUT,HEXPARM,(R3),P1+7,UBFIXLN,NOL,XA=OFF                      
         GOTOR REPORT,XA=OFF                                                    
         AHI   R3,UBFIXLN                                                       
         SHI   R2,UBFIXLN                                                       
         JZ    EXIT                                                             
BU2HEX02 LHI   R0,50                                                            
         CR    R2,R0                                                            
         JH    *+6                                                              
         LR    R0,R2                                                            
         GOTOR HEXOUT,HEXPARM,(R3),P1+7,(R0),NOL,XA=OFF                         
         GOTOR REPORT,XA=OFF                                                    
         AR    R3,R0                                                            
         SR    R2,R0                                                            
         JP    BU2HEX02                                                         
         J     EXIT                                                             
                                                                                
SETCLS   MVI   CLASS1,0            SET PRODUCT CLASS CODE(S)                    
         MVI   CLASS2,0                                                         
         CLI   0(R1),0                                                          
         BER   RE                  CC=EQUAL FOR NO CLASS                        
         MVC   CLASS1,0(R1)                                                     
         CLI   0(R1),TWOPTCLS      CC=HIGH FOR SINGLE CLASS                     
         BHR   RE                                                               
         PACK  CLASS1,0(1,R1)                                                   
         NI    CLASS1,DIGIT                                                     
         OI    CLASS1,ATOIBITS                                                  
         MVC   CLASS2,0(R1)                                                     
         NI    CLASS2,DIGIT                                                     
         OI    CLASS2,ATOIBITS                                                  
         CLI   CLASS1,FF           CC=LOW FOR 2-PART CLASS                      
         BR    RE                                                               
                                                                                
FRMPRD   ST    RE,SAVERE           FORMAT PRODUCT/LENGTH FOR PRINTING           
         LM    RF,R0,0(R1)                                                      
         SR    R1,R1                                                            
         ICM   R1,PRDMSKQ,0(RF)                                                 
         JZ    FRMPRDX                                                          
         SR    RE,RE                                                            
         IC    RE,L'PTPRDA(RF)                                                  
         CVD   RE,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         LR    RF,R0                                                            
         MVC   0(L'PTPRDA,RF),PTPRDA-PTBUFFD(R1)                                
         UNPK  L'PTPRDA(3,RF),DUB                                               
FRMPRDX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
OPVARS   LA    RF,VARCTLS          SET OFF VARIABLE NO-OPS                      
         LHI   R0,VARWGTSN                                                      
         NI    0(RF),FF-TVNOPQ                                                  
         AHI   RF,L'VARCTLS                                                     
         JCT   R0,*-8                                                           
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* First for run                                                       *         
***********************************************************************         
                                                                                
RUNFST   NMOD1 0,**RUNFST                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         LA    R0,GLOBVARS         CLEAR GLOBAL VARIABLES                       
         LHI   R1,GLOBVARL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         MVC   HEADHOOK,AHEDBLD    SET A(HEADHOOK)                              
                                                                                
         LHI   R0,PTZBUFFL         ACQUIRE STORAGE FOR PRODUCT BUFFER           
         STCM  R0,3,PRDBUFLN       SET PRODUCT BUFFER WIDTH                     
         MHI   R0,MAXPRDS                                                       
         GETMAIN R,LV=(0)                                                       
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,PRDBUFF          SET A(PRODUCT BUFFER)                        
                                                                                
         L     R0,LBRDTAB          ACQUIRE STORAGE FOR BRAND TABLE              
         GETMAIN RU,LV=(0),LOC=(ANY,ANY),BNDRY=PAGE                             
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ABRDTAB          SET A(BRAND TABLE)                           
         MVC   0(8,R1),=C'*BRDTAB*'                                             
                                                                                
         SR    RE,RE               SET EXCLUSION TABLE BINSRCH PARMS            
         LARL  RF,XCTABC                                                        
         SR    R0,R0                                                            
         LHI   R1,XCTTABL                                                       
         LHI   R2,XCTTABL                                                       
         LHI   R3,XCTTMAX                                                       
         STM   RE,R3,XCTPARS                                                    
                                                                                
         L     R2,VMASTC                                                        
         USING MASTD,R2            R2=A(MASTC)                                  
                                                                                
         OC    MCREMPQK,MCREMPQK                                                
         BZ    *+8                                                              
         OI    RUNFLAG,RUNFSOON    SET RUNNING SOON                             
                                                                                
         CLI   RCWRITE,YESQ        TEST WRITE=Y                                 
         BE    *+12                                                             
         MVI   UNTFILO,C'N'        NO - OPEN FILES READ-ONLY                    
         MVI   UNTDIRO,C'N'                                                     
         GOTOR DATAMGR,DMCB,=C'OPEN',=C'SPOT',UNTLIST,ADBUY,XA=OFF              
                                                                                
         L     RF,SSB              SET TO RECOVER OFFLINE COPIES                
         OI    SSOSTAT2-SSBD(RF),SSOSROLC                                       
                                                                                
         MVC   MCDUB,SPACES        LOAD NETVALUE                                
         MVC   MCDUB(L'T00A),T00A                                               
         MVI   BYTE,QNETVALU                                                    
         GOTOR HEXOUT,DMCB,BYTE,MCDUB+L'T00A,L'BYTE,NOL,XA=OFF                  
         GOTOR MCVLOADM,(R1),0,XA=OFF                                           
         MVC   NETVALUE,4(R1)      SET A(NETVALUE)                              
                                                                                
RUNFX    J     EXIT                                                             
         DROP  R2,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Last for run                                                        *         
***********************************************************************         
                                                                                
RUNLST   NMOD1 0,**RUNLST                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         GOTOR BU1CLO              CLOSE BUFFER 1                               
         GOTOR BU2CLO              CLOSE BUFFER 2                               
                                                                                
         L     R0,LBRDTAB          FREE STORAGE FOR BRAND TABLE                 
         L     R1,ABRDTAB                                                       
         FREEMAIN RC,A=(1),LV=(0)                                               
                                                                                
         LHI   R0,PTZBUFFL         FREE STORAGE FOR PRODUCT BUFFER              
         MHI   R0,MAXPRDS                                                       
         L     R1,PRDBUFF                                                       
         FREEMAIN R,A=(1),LV=(0)                                                
                                                                                
S        USING QAREA,QSAVE                                                      
         CLI   S.QOPT4,YESQ        TEST REQUEST WAS DRAFT                       
         JE    EXIT                                                             
         TM    RUNFLAG,RUNFSOON    TEST RUNNING SOON                            
         JZ    EXIT                                                             
                                                                                
         XC    WORK,WORK                                                        
         LA    RF,WORK                                                          
         USING LKKEYD,RF                                                        
         MVC   LOCKSE,SPOTSE       SE NUMBER                                    
         MVC   LOCKAGY,AGY         AGENCY                                       
         MVC   LOCKRTY,=C'UN'      RECORD CODE                                  
         MVC   LOCKKEY(L'CLT),CLT                                               
         MVC   LOCKKEY+L'CLT(L'QNET),SPACES                                     
         GOTOR LOCKET,DMCB,(C'U',LKKEYD),ACOMFACS,XA=OFF                        
         CLI   4(R1),0             TEST FOR UNLOCK ERROR                        
         JE    EXIT                                                             
         DC    H'0'                                                             
         DROP  RB,RF,S                                                          
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* First for request                                                   *         
***********************************************************************         
                                                                                
REQFST   NMOD1 0,**REQFST                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         MVI   REQFLAG1,0                                                       
         LHI   RE,PTZDEM-PTBUFFD                                                
         LHI   RF,PTZDEML-1                                                     
         LHI   R0,PTZWGHT-PTBUFFD                                               
         LHI   R1,L'PTZWGHT-1                                                   
         STM   RE,R1,DEMOVALS      SET DISPS/LENS OF DEMO VALUES                
                                                                                
         LHI   R0,MEDXCHG-MEDDATA                                               
         ST    R0,MEDLCHNK                                                      
         LHI   R0,MAXWEEKS+1                                                    
         STCM  R0,15,MEDNUMWK                                                   
         MVI   RQEQUIV,YESQ                                                     
         MVC   PAGE,HW1                                                         
                                                                                
         MVC   SVQNET,SPACES                                                    
         CLI   QNET,SPACE                                                       
         BNH   REQFX                                                            
         CLI   QNET,ZONE                                                        
         BNL   REQFX                                                            
         CLC   ALL3L,QNET                                                       
         BE    REQFX                                                            
         MVC   SVQNET,QNET         SAVE REQUESTED NETWORK                       
                                                                                
REQFX    J     EXIT                                                             
         DROP  RB                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Last for request                                                    *         
***********************************************************************         
                                                                                
REQLST   NMOD1 0,**REQLST                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         TM    REQFLAG1,REQFQUIT+REQFESTE                                       
         JNZ   EXIT                                                             
                                                                                
         GOTOR ANETUNT,NETNGETQ    READ UNIT RECORDS                            
         MVI   MODE,ESTLAST                                                     
         GOTOR GETPXC              GET 'ALL' NETWORK EXCLUSIONS                 
         GOTOR APARREP             PRINT PARAMETER REPORT                       
                                                                                
         L     RF,ABUFF1           TEST ANYTHING POSTED TO BUFFER               
         TM    BUFFINDS-BUFFD(RF),BUFFIINI                                      
         JZ    EXIT                NO - EXIT                                    
                                                                                
         GOTOR SETSLT              SET SLOT COUNTS FOR ENV1'S                   
         GOTOR ADSCALE             DAYPART BALANCING                            
                                                                                
         TM    DIAGNOP2,DPRTBUFQ   TEST TRACE REQUIRED                          
         BZ    REQLST06                                                         
         XC    GBUFFK(GBUFFKL),GBUFFK                                           
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     REQLST04                                                         
REQLST02 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
REQLST04 BNZ   REQLST06                                                         
                                                                                
         GOTOR HEXOUT,HEXPARM,GBUFFK,P1,GBWKS-GBUFFK,NOL,XA=OFF                 
         GOTOR (RF),(R1),GBWKS,P2,GBWKSL/2,NOL,XA=OFF                           
         GOTOR (RF),(R1),GBWKS+(GBWKSL/2),P3,GBWKSL/2,NOL,XA=OFF                
         MVI   P4,0                                                             
         GOTOR REPORT,XA=OFF                                                    
         B     REQLST02                                                         
                                                                                
L        USING GBUFFK,LSTBUFFK                                                  
S        USING GBUFFK,SAVBUFFK                                                  
                                                                                
REQLST06 CLI   PODRSW,YESQ         FOR POD RUNS                                 
         BNE   *+8                                                              
         MVI   RWILNSW,RWILSEP     KEEP LENGTHS SEPARATE IN GETROW              
         XC    NPRDS,NPRDS                                                      
         XC    GBUFFK(GBUFFKL),GBUFFK                                           
         XC    L.GBUFFK(GBUFFKL),L.GBUFFK                                       
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     REQLST10                                                         
REQLST08 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
REQLST10 BZ    *+14                                                             
         MVC   GBUFFK(L'GBDPT+L'GBLEN),EFFS                                     
         B     *+14                                                             
         OC    GBROW(GBROWL),GBROW SKIP NULL RECORDS                            
         BZ    REQLST08                                                         
         CLC   GBDPT,L.GBDPT       TEST CHANGE OF DAYPART                       
         BNE   REQLST12                                                         
         CLC   GBLEN,L.GBLEN       TEST CHANGE OF UNIT LENGTH                   
         BE    REQLST28                                                         
         CLI   PODRSW,YESQ         NO LENGTH BREAK IF POD RUN                   
         BE    REQLST28                                                         
REQLST12 MVC   S.GBUFFK(GBUFFKL),GBUFFK                                         
         OC    L.GBUFFK(GBUFFKL),L.GBUFFK                                       
         BZ    REQLST26                                                         
         MVC   DPSLDESC,SPACES                                                  
         CLC   ALLDL,L.GBDPT                                                    
         BNE   *+14                                                             
         MVC   DPSLDESC(20),=C'All Dayparts/Lengths'                            
         B     REQLST18                                                         
         MVC   DPSLDESC(16),=C'Daypart/Length ='                                
         LA    R3,DPSLDESC+17                                                   
         CLI   L.GBDPT,ALLDPT                                                   
         BNE   REQLST14                                                         
         MVC   0(L'ALL3L,R3),ALL3L                                              
         AHI   R3,L'ALL3L                                                       
         B     REQLST16                                                         
                                                                                
REQLST14 MVC   0(L'GBDPT,R3),L.GBDPT                                            
         TM    REQFLAG1,REQFDPTR   TEST USING NEW DAYPART RECORDS               
         BNZ   *+12                                                             
         AHI   R3,L'GBDPT          NO - JUST DISPLAY THE CODE                   
         B     REQLST16                                                         
                                                                                
         LA    R2,KEY                                                           
         USING NDPTKEY,R2                                                       
         XC    NDPTKEY,NDPTKEY                                                  
         MVI   NDPTKTY,NDPTKTYQ                                                 
         MVI   NDPTKST,NDPTKSTQ                                                 
         MVC   NDPTAGM,BAGYMD                                                   
         MVC   NDPTDPTE,L.GBDPT                                                 
         TM    L.GBDPT,X'80'       TEST AGENCY LEVEL DAYPART                    
         BNZ   *+10                                                             
         MVC   NDPTCLT,BCLT        NO - SET CLIENT CODE                         
         MVC   KEYSAVE,NDPTKEY                                                  
         GOTOR DATAMGR,DMCB,DMRDHI,UNTDIR,NDPTKEY,NDPTKEY,XA=OFF                
         CLC   NDPTKEY(NDPTDES-NDPTKEY),KEYSAVE                                 
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   0(L'NDPTDES,R3),NDPTDES                                          
         AHI   R3,L'NDPTDES                                                     
         CLI   0(R3),SPACE                                                      
         BH    *+8                                                              
         BCT   R3,*-8                                                           
         AHI   R3,1                                                             
         DROP  R2                                                               
                                                                                
REQLST16 MVI   0(R3),SLASH                                                      
         CLI   L.GBLEN,ALLLEN                                                   
         BNE   *+14                                                             
         MVC   1(L'ALL3L,R3),ALL3L                                              
         B     REQLST18                                                         
                                                                                
         CLI   PODRSW,YESQ         TEST POD RUN                                 
         BNE   *+14                                                             
         MVC   1(L'PODL,R3),PODL                                                
         B     REQLST18                                                         
                                                                                
         EDIT  (B1,L.GBLEN),(3,1(R3)),ALIGN=LEFT                                
                                                                                
REQLST18 NI    REQFLAG1,FF-(REQFESTE)                                           
         OC    NPRDS,NPRDS                                                      
         BZ    REQLST20            NO GOALS                                     
                                                                                
         GOTOR ARSCALE             DO RESCALING                                 
         GOTOR CHKEST              TEST ALL NEEDED ESTIMATES OPEN               
         JNE   ENDREQ                                                           
                                                                                
         CLI   ZERWKSW,0           ZERO WEEK ERROR                              
         BNE   REQLST22            SKIP ALLOCATION                              
         LHI   R0,TPREDEM-TABDATA  WRITE OUT FROM +4                            
         TM    REQFLAG1,REQFMIXB   UNLESS MIXED GOAL BASE                       
         BZ    *+8                                                              
         LHI   R0,TRSCGOL-TABDATA  THEN USE +0                                  
         STH   R0,CELLD                                                         
         MVI   TYP,TRSCGOLQ        FINAL GOALS                                  
         L     R1,ABUFF1                                                        
         USING BUFFD,R1                                                         
         OI    BUFFINDS,BUFFIRCM                                                
         GOTOR APUTROW                                                          
         NI    BUFFINDS,FF-(BUFFIRCM)                                           
         DROP  R1                                                               
                                                                                
REQLST20 CLI   RSWKOPT,RSWKBALQ    SKIP ALLOCATION IF BALANCING ONLY            
         BE    REQLST26                                                         
         GOTOR AALLOC              DO THE ALLOCATION                            
                                                                                
REQLST22 LH    R0,NWKSP1           WEEKS (INCLUDING TOTAL)                      
         LHI   R1,MAXWKPP          MAXIMUM WEEKS PER REPORT PAGE                
         TM    REQFLAG1,REQFHNAD   BUT IF HAVE NAD DEMOS                        
         BZ    *+8                                                              
         LHI   R1,MAXWKNAD         THEN FEWER COLUMNS                           
         SR    R2,R2               STARTING WEEK NUMBER                         
REQLST24 CR    R0,R1               WILL WHATS LEFT FIT ON THIS PAGE             
         BNL   *+6                                                              
         LR    R1,R0               YES, DO IT ALL                               
         STH   R1,RPTNOWKS                                                      
         STC   R2,RPTSWK                                                        
         GOTOR ASUMRPT             PRINT SUMMARY (WEEKLY) REPORT                
         LHI   RE,MAXWKPP          MAXIMUM WEEKS PER PAGE                       
         TM    REQFLAG1,REQFHNAD   BUT FEWER IF HAVE NAD DEMOS                  
         BZ    *+8                                                              
         LHI   RE,MAXWKNAD                                                      
         AR    R2,RE                                                            
         SR    R0,R1                                                            
         BP    REQLST24            DO NEXT SET OF WEEKS                         
                                                                                
         GOTOR APGMRCP             PRINT PROGRAM RECAP                          
                                                                                
REQLST26 LHI   RF,24               SET 'CELL WIDTH'                             
         STH   RF,CELLWID                                                       
         LH    RF,NWKS                                                          
         AHI   RF,1                                                             
         MH    RF,CELLWID                                                       
         AHI   RF,TABDATA-TABD                                                  
         STH   RF,ROWLEN           LENGTH OF ROW                                
         A     RF,ASUPROW                                                       
         ST    RF,ATOTROW          TOTAL ROW                                    
         AH    RF,ROWLEN                                                        
         ST    RF,AFSTBRD          FIRST BRAND                                  
         XC    NPRDS,NPRDS                                                      
         XC    LPRDLEN,LPRDLEN                                                  
         GOTOR CLRBRD              CLEAR BRDTAB TO BINARY ZEROES                
         MVC   GBUFFK(GBUFFKL),S.GBUFFK                                         
         CLI   GBUFFR,GBUFEOTQ                                                  
         BE    REQLST46                                                         
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
                                                                                
         MVC   L.GBUFFK(GBUFFKL),GBUFFK                                         
         IC    RF,DLCNT            COUNT NUMBER OF DAYPART/LENGTHS              
         AHI   RF,1                                                             
         STC   RF,DLCNT                                                         
REQLST28 LHI   R0,TRSCGOL-TABDATA  CONTINUATION OF DAYPART/LENGTHS              
         STH   R0,CELLD                                                         
         CLI   GBTYP,TRSCGOLQ                                                   
         BE    REQLST36                                                         
         CLI   GBTYP,TGOLDEMQ      GOAL DEMO                                    
         BE    REQLST30                                                         
         CLI   GBTYP,TGOLDOLQ      GOAL DOLLARS                                 
         BE    REQLST32                                                         
         B     REQLST08                                                         
REQLST30 CLI   GOALOPT,GOALDOLS    DOLLARS OR RATINGS                           
         BE    REQLST08                                                         
         B     REQLST34                                                         
REQLST32 CLI   GOALOPT,GOALDOLS                                                 
         BNE   REQLST08                                                         
REQLST34 CLI   GBTYP,TPREDEMQ                                                   
         BNL   REQLST36                                                         
         CLC   GBPRD,SUPPRD        SUPPLY                                       
         BE    REQLST36                                                         
         CLI   DSSW,DSSYESQ        IF HAVE DAYPART RESCALED                     
         BE    REQLST08            USE INTERMEDIATE GOALS HERE-TYP 41           
REQLST36 CLC   GBPRD,SUPPRD        COUNT PRODUCTS                               
         BE    REQLST40                                                         
         CLC   GBPRD,TOTPRD                                                     
         BE    REQLST40                                                         
         CLC   GBPRD,LPRD                                                       
         BNE   REQLST38                                                         
         CLI   PODRSW,YESQ         IF POD RUN                                   
         BNE   REQLST40                                                         
         CLC   GBLEN,LLEN          NEW LENGTH COUNTS AS NEW PRODUCT             
         BE    REQLST40                                                         
                                                                                
REQLST38 MVC   LPRD,GBPRD                                                       
         MVC   LLEN,GBLEN                                                       
         LH    RF,NPRDS            BUMP PRODUCT COUNT                           
         AHI   RF,1                                                             
         STH   RF,NPRDS                                                         
*                                  FOR RESCALE MUST EQUIVALENCE DEMOS           
REQLST40 CLI   GBTYP,TGOLDEMQ      ONLY DEMOS (AND NOT IF DPT RESCALED)         
         BNE   REQLST44                                                         
         CLI   PODRSW,YESQ         NO LENGTH BREAK IF POD RUN                   
         BNE   REQLST44                                                         
         CLC   GBLEN,PODLEN        SKIP IF ALREADY HAVE EQUIV BASE              
         BE    REQLST44                                                         
         CLC   GBPRD,SUPPRD        SKIP FOR SUPPLY                              
         BE    REQLST44                                                         
         LA    R2,GBTOT            START WITH TOTAL                             
         LHI   R3,MAXWEEKS+1       FOR BCT                                      
REQLST42 L     R1,0(R2)            VALUE                                        
         SR    R0,R0                                                            
         IC    R0,GBLEN                                                         
         MR    R0,R0               X ACTUAL LENGTH                              
         LH    RF,PODEQU                                                        
         GOTOR DIVIDE                                                           
         ST    R1,0(R2)                                                         
         AHI   R2,L'GBTOT                                                       
         BCT   R3,REQLST42                                                      
                                                                                
REQLST44 CLI   PODRSW,YESQ         ONLY FOR POD RUN                             
         BNE   *+8                                                              
         MVI   RWILNSW,RWILSEP     KEEP LENGTHS SEPARATE IN GETROW              
         GOTOR AGETROW                                                          
         B     REQLST08                                                         
                                                                                
REQLST46 MVI   RWILNSW,RWILTOG     RESET GETROW LENGTH SWITCH                   
         CLI   DLCNT,1             TEST MULTIPLE DAYPART/LENGTHS                
         BNH   REQLST50                                                         
         XC    L.GBUFFK(GBUFFKL),L.GBUFFK                                       
         MVC   DPSLDESC,SPACES                                                  
         MVC   DPSLDESC(20),=C'All Dayparts/Lengths'                            
                                                                                
         LH    R0,NWKSP1           WEEKS (INCLUDING TOTAL)                      
         LHI   R1,MAXWKPP          MAXIMUM WEEKS PER REPORT PAGE                
         TM    REQFLAG1,REQFHNAD   BUT IF HAVE NAD DEMOS                        
         BZ    *+8                                                              
         LHI   R1,MAXWKNAD         THEN FEWER COLUMNS                           
         SR    R2,R2               STARTING WEEK NUMBER                         
REQLST48 CR    R0,R1               WILL WHATS LEFT FIT ON THIS PAGE             
         BNL   *+6                                                              
         LR    R1,R0               YES, DO IT ALL                               
         STH   R1,RPTNOWKS                                                      
         STC   R2,RPTSWK                                                        
         GOTOR ASUMRPT             PRINT SUMMARY (WEEKLY) REPORT                
         LHI   RE,MAXWKPP          MAXIMUM WEEKS PER PAGE                       
         TM    REQFLAG1,REQFHNAD   BUT FEWER IF HAVE NAD DEMOS                  
         BZ    *+8                                                              
         LHI   RE,MAXWKNAD                                                      
         AR    R2,RE                                                            
         SR    R0,R1                                                            
         BP    REQLST48            DO NEXT SET OF WEEKS                         
                                                                                
         GOTOR APGMRCP             PRINT PROGRAM RECAP                          
                                                                                
REQLST50 MVI   PBMODE,PBMLSTQ                                                   
         GOTOR APRTBUF                                                          
         OC    AUNTTAB,AUNTTAB     IF NO UNIT TABLE THERE WAS                   
         JZ    EXIT                SOME EARLIER ERROR, SO QUIT                  
         TM    MKTBUYGL,MKTBHBUY+MKTBHGOL                                       
         JNO   EXIT                GOALS AND BUYS                               
         MVI   RCWRITE,YESQ                                                     
         CLI   QOPT4,YESQ          FOR TEST RUN                                 
         BNE   *+8                                                              
         MVI   RCWRITE,NOQ         SUPPRESS WRITE                               
         GOTOR ANETUNT,NETNPUTQ    YES - GO TO NETWORK UPDATE ROUTINE           
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Read product exclusion records and post to table                    *         
***********************************************************************         
                                                                                
GETPXC   NTR1  ,                                                                
         LA    R2,KEY                                                           
         USING PXCRECD,R2                                                       
         XC    PXCKEY,PXCKEY                                                    
         MVI   PXCKTYP+0,PXCKTYPQ                                               
         MVI   PXCKTYP+1,PXCKSUBQ                                               
         MVC   PXCKAGM,BAGYMD                                                   
         MVC   PXCKCLT,BCLT                                                     
         MVC   AREC,APXCREC                                                     
         GOTOR HIGH,XA=OFF                                                      
         B     GETPXC04                                                         
GETPXC02 GOTOR SEQ,XA=OFF                                                       
GETPXC04 LA    R2,KEY                                                           
         CLC   PXCKEY(PXCKSTA-PXCKEY),KEYSAVE                                   
         JNE   EXIT                                                             
         CLI   PXCKEST,0           TEST ALL ESTIMATES                           
         BE    GETPXC08                                                         
         CLI   BEST,0              TEST REQUEST BY ESTIMATE                     
         BE    GETPXC06            NO - USE ESTLST                              
         CLC   PXCKEST,BEST                                                     
         BE    GETPXC08                                                         
         BL    GETPXC02                                                         
         CLI   BESTEND,0                                                        
         BE    GETPXC02                                                         
         CLC   PXCKEST,BESTEND                                                  
         BH    GETPXC02                                                         
         B     GETPXC08                                                         
                                                                                
GETPXC06 SR    RF,RF                                                            
         IC    RF,PXCKEST          TEST ESTIMATE APPLICABLE                     
         LA    RF,ESTLST-L'PXCKEST(RF)                                          
         CLI   0(RF),0                                                          
         BE    GETPXC02                                                         
                                                                                
GETPXC08 GOTOR GET,XA=OFF          GET ACTUAL RECORD                            
                                                                                
         L     R2,APXCREC          R2=A(RECORD)                                 
         GOTOR MSUNPK,DMCB,PXCKSTA-2,FULL,DUB,XA=OFF                            
         GOTOR LOCPRA,PXCKPRD                                                   
         JNE   GETPXC02                                                         
         STCM  R1,PRDMSKQ,HOLDPRD  SAVE PRODUCT                                 
                                                                                
         LA    R3,PXCEL01                                                       
         USING PXCEL05,R3                                                       
         SR    R0,R0                                                            
GETPXC10 CLI   PXCEL05,EOR         TEST TEST END OF RECORD                      
         BE    GETPXC02                                                         
         CLI   PXCEL05,PXCEL05Q                                                 
         BNE   GETPXC12                                                         
         CLC   PXCSTDTE,BQENDP     TEST OVERLAPS REQUEST DATES                  
         BH    GETPXC12                                                         
         CLC   PXCEDTE,BQSTARTP                                                 
         BNL   GETPXC14                                                         
GETPXC12 IC    R0,PXC05LEN         BUMP TO NEXT ELEMENT                         
         AR    R3,R0                                                            
         B     GETPXC10                                                         
                                                                                
B        USING XCTABD,WORK         BUILD & ADD EXCLUSION TABLE ENTRY            
GETPXC14 XC    B.XCTABD(XCTTABL),B.XCTABD                                       
         MVC   B.XCTNET,DUB                                                     
         MVC   B.XCTPRD,HOLDPRD                                                 
         MVC   B.XCTEST,PXCKEST                                                 
         MVC   B.XCTDATA(XCTDATAL),PXCPGM                                       
         CLI   B.XCTTYPE,XCTSPCLQ  TEST SPECIAL 'PROGRAM'                       
         BNL   GETPXC16                                                         
         CLI   B.XCTTYPE,XCTTDOWQ  TEST DAY                                     
         BE    GETPXC18                                                         
         OC    B.XCTETIME,B.XCTETIME                                            
         BNZ   GETPXC18                                                         
         MVC   B.XCTETIME,B.XCTSTIME                                            
         B     GETPXC18                                                         
                                                                                
GETPXC16 OC    B.XCTPGM,SPACES     REMOVE BINARY ZEROES                         
                                                                                
GETPXC18 GOTOR BINSRCH,XCTPARS,(1,B.XCTABD),XA=OFF                              
         OC    1(3,R1),1(R1)       TEST EXCLUSION TABLE IS FULL                 
         BNZ   GETPXC12                                                         
         MVC   P1(38),=C'**Too many product exclusion records**'                
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         J     ENDREQ                                                           
         DROP  R2,B                                                             
         EJECT                                                                  
***********************************************************************         
* Check all estimates are open                                        *         
***********************************************************************         
                                                                                
CHKEST   NTR1  ,                                                                
         NI    REQFLAG1,FF-(REQFESTE)                                           
         CLC   NOL,QEST                                                         
         BE    CHKEST06                                                         
         CLC   ALL3L,QEST                                                       
         BE    CHKESTX                                                          
         CLI   QESTEND,SPACE                                                    
         BE    CHKESTX                                                          
                                                                                
***********************************************************************         
* For range of estimates first build a list of POL estimates          *         
***********************************************************************         
                                                                                
         XC    ESTLST,ESTLST       BUILD LIST OF POL ESTIMATES                  
         LA    R2,KEY                                                           
         USING ESTHDR,R2                                                        
         L     RF,ADCLT            COPY CLIENT KEY                              
         MVC   EKEY,0(RF)                                                       
         MVC   EKEYPRD,POLPRDL                                                  
         OC    QEST(L'QEST+L'QESTEND),ZONES                                     
         PACK  DUB,QEST                                                         
         CVB   R0,DUB                                                           
         STC   R0,EKEYEST          START ESTIMATE                               
         PACK  DUB,QESTEND                                                      
         CVB   R0,DUB                                                           
         STC   R0,DUB              END ESTIMATE                                 
         GOTOR HIGH,XA=OFF                                                      
         B     CHKEST04                                                         
CHKEST02 GOTOR SEQ,XA=OFF                                                       
CHKEST04 LA    R2,KEY                                                           
         CLC   EKEY(EKEYEST-EKEY),KEYSAVE                                       
         BNE   CHKEST06                                                         
         CLC   EKEYEST,DUB                                                      
         BH    CHKEST06                                                         
         GOTOR GETEST,XA=OFF                                                    
         L     R2,ADEST                                                         
         CLC   QSTART,EEND         TEST EST WITHIN REQUEST PERIOD               
         BH    CHKEST02                                                         
         CLC   QEND,ESTART                                                      
         BL    CHKEST02                                                         
         SR    RF,RF                                                            
         IC    RF,EKEYEST          ADD ESTIMATE NUMBER TO LIST                  
         LA    RF,ESTLST-L'EKEYEST(RF)                                          
         MVC   0(L'EKEYEST,RF),EKEYEST                                          
         B     CHKEST02                                                         
                                                                                
CHKEST06 L     R2,AFSTBRD          CHECK PRODUCT ESTIMATES OPEN                 
         USING TABD,R2                                                          
         LH    R0,NPRDS            R0=NUMBER OF PRODUCTS                        
CHKEST08 GOTOR LOCPRD,TABPRD                                                    
         GOTOR CKEPRD                                                           
         AH    R2,ROWLEN           BUMP TO NEXT PRODUCT                         
         BCT   R0,CHKEST08                                                      
         DROP  R2                                                               
                                                                                
CHKESTX  TM    REQFLAG1,REQFESTE   SET CC=NOT EQUAL ON ERROR                    
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Read product estimates - set error flag if any are missing          *         
***********************************************************************         
                                                                                
         USING PTBUFFD,R1                                                       
CKEPRD   NTR1  ,                                                                
CKE      USING EKEY,KEY                                                         
         L     RF,ADCLT                                                         
         XC    CKE.EKEY,CKE.EKEY                                                
         MVC   CKE.EKEY(EKEYPRD-EKEY),0(RF)                                     
         MVC   CKE.EKEYPRD,PTPRDA                                               
                                                                                
         LA    R1,ESTLST           TRY ALL POL ESTIMATES                        
         LHI   R0,L'ESTLST                                                      
CKEPRD02 CLI   0(R1),0             TEST UNUSED ENTRY                            
         BE    CKEPRD04                                                         
         MVC   CKE.EKEYEST,0(R1)   READ FOR ESTIMATE                            
         GOTOR HIGH,XA=OFF                                                      
         CLC   CKE.EKEY,KEYSAVE                                                 
         BE    CKEPRD04                                                         
         MVC   P1(57),=C'**Est NNN for Prd XXX not on file- Market NNNN*        
                bypassed**'                                                     
         SR    RE,RE                                                            
         IC    RE,KEYSAVE+(EKEYEST-EKEY)                                        
         CVD   RE,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  P1+6(3),DUB                                                      
         MVC   P1+19(L'EKEYPRD),KEYSAVE+(EKEYPRD-EKEY)                          
         MVC   P1+42(4),MKT                                                     
         GOTOR REPORT,XA=OFF                                                    
         OI    REQFLAG1,REQFESTE   SET ERROR                                    
CKEPRD04 AHI   R1,L'EKEYEST        NEXT ESTIMATE IN LIST                        
         BCT   R0,CKEPRD02                                                      
                                                                                
CKEPRDX  J     EXIT                                                             
         DROP  CKE                                                              
         EJECT                                                                  
***********************************************************************         
* Calculate product/class slots                                       *         
***********************************************************************         
                                                                                
SETSLT   NTR1  ,                                                                
         L     R4,AENV1SET         ENVIRONMENT 1 VALUE SET                      
         L     R4,ENVSATAB-ENVSETD(R4)                                          
         USING ENVTABD,R4                                                       
SETSLT02 CLI   ENVS1KEY,ENVSEOTQ                                                
         BE    SETSLTX                                                          
                                                                                
         GOTOR MILMIN,ENVS1STR                                                  
         MVC   DUB+0(2),HALF                                                    
         GOTOR MILMIN,ENVS1END                                                  
         MVC   DUB+2(2),HALF                                                    
                                                                                
         SR    R0,R0               COUNT NUMBER OF DAYS IN ROTATOR              
         SR    R1,R1                                                            
         IC    R1,ENVS1DAY                                                      
         SLL   R1,32-DAYWEEK                                                    
         LA    RF,DAYWEEK                                                       
         SR    RE,RE                                                            
SETSLT04 SLDL  R0,1                                                             
         LTR   R0,R0                                                            
         BZ    *+10                                                             
         AHI   RE,1                                                             
         SR    R0,R0                                                            
         BCT   RF,SETSLT04                                                      
SETSLT06 STC   RE,DUB+4            NUMBER OF DAYS                               
                                                                                
         XC    WORD,WORD                                                        
         XC    ENVS1SLP,ENVS1SLP                                                
         CLI   PINTPCT,0           NO BRAND CHECKING                            
         BE    SETSLT08                                                         
         MVC   HALF,PINTRVL        PRODUCT INTERVAL AND PERCENT                 
         GOTOR GETSLT                                                           
         MVC   ENVS1SLP,WORD                                                    
                                                                                
SETSLT08 XC    ENVS1SLC,ENVS1SLC                                                
         CLI   CINTPCT,0           NO COMPETATIVE BRAND CHECKING                
         BE    SETSLT10                                                         
         MVC   ENVS1SLC,WORD                                                    
         CLC   CINTRVL(2),PINTRVL                                               
         BE    SETSLT10                                                         
         MVC   HALF,CINTRVL        INTERVAL AND PERCENT 2                       
         GOTOR GETSLT                                                           
         MVC   ENVS1SLC,WORD       SLOTS2                                       
                                                                                
SETSLT10 AHI   R4,ENVS1LEN                                                      
         B     SETSLT02                                                         
                                                                                
SETSLTX  J     EXIT                                                             
         EJECT                                                                  
MILMIN   MVC   HALF,0(R1)          CONVERT MILITARY TIME TO MINUTES             
         LH    R1,HALF                                                          
         LTR   R1,R1                                                            
         BZR   RE                  LEAVE ZERO RESULT                            
         SR    R0,R0                                                            
         D     R0,FW100                                                         
         MHI   R1,MINHOUR                                                       
         AR    R1,R0                                                            
         STH   R1,HALF                                                          
         BR    RE                                                               
                                                                                
GETSLT   LHI   RF,1                                                             
         CLI   HALF,1              ONE MINUTE                                   
         BE    GETSLT04            CONVENTION FOR PROGRAM EXCLUSION             
                                                                                
         CLC   DUB(2),DUB+2        CHECK START VS END                           
         BNH   *+16                                                             
         LH    R0,DUB+2            IF HIGH TIMES SPAN 6A                        
         AHI   R0,MINHOUR*HOURDAY  ADJUST END TIME +24 HOURS                    
         STH   R0,DUB+2                                                         
                                                                                
         LH    R3,DUB                                                           
         SR    R0,R0                                                            
         IC    R0,HALF                                                          
GETSLT02 AR    R3,R0                                                            
         CH    R3,DUB+2                                                         
         BNL   GETSLT04                                                         
         AHI   RF,1                                                             
         B     GETSLT02                                                         
                                                                                
GETSLT04 LR    R1,RF                                                            
         SR    RF,RF                                                            
         IC    RF,DUB+4            X NUMBER OF DAYS IN ROTATOR                  
         MR    R0,RF                                                            
         SR    RF,RF               X PERCENT                                    
         IC    RF,HALF+1                                                        
         MR    R0,RF                                                            
         SLDA  R0,1                                                             
         D     R0,FW10             LEAVE UNITS AS N.N                           
         LTR   R1,R1                                                            
         BNP   *+8                                                              
         A     R1,FW1                                                           
         SRA   R1,1                                                             
         STH   R1,WORD             VALUE BEING RETURNED                         
GETSLTX  BR    RE                                                               
         DROP  R1,R4,RB                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* First for estimate                                                  *         
***********************************************************************         
                                                                                
ESTFST   NMOD1 0,**ESTFST                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     RF,ADEST                                                         
         USING ESTHDR,RF                                                        
         CLI   EOWSDAY,0           IF OUT OF WEEK START DAY PRESENT             
         BE    *+10                                                             
         MVC   SPOTPROF+8(1),EOWSDAY                                            
         DROP  RF                                                               
         GOTOR MEDDATE,DMCB,SPWORKD,XA=OFF                                      
                                                                                
         GOTOR APRDBLD             BUILD PRODUCT BUFFER                         
         JZ    ENDREQ                                                           
                                                                                
         XC    ACTDEMS,ACTDEMS     CLEAR ACTIVE DEMO LIST                       
         MVI   ACTDEMSL,FF         BASE ALWAYS ACTIVE                           
         XC    NTARGETS,NTARGETS                                                
         XC    TARGETS(TARGETSL),TARGETS                                        
         LA    R0,DEMNMS                                                        
         GOTOR CLEAR,DEMNMSL                                                    
         NI    REQFLAG1,FF-(REQFMIXG+REQFMIXB+REQFTRGS)                         
                                                                                
         L     R6,PRDBUFF          LOOP TO SET MIX SWITCHES                     
         USING PTBUFFD,R6                                                       
         LH    R0,HIGHPRDN                                                      
         SHI   R0,1                                                             
ESTFST02 CLI   FCGLOPTN,YESQ       TEST 'FORCE' GOALS                           
         BNE   *+10                                                             
         MVC   PTDEMNO,CORPDEM     TO BE FOR CORPORATE DEMO                     
         CLC   PTDEMNO,CORPDEM                                                  
         BE    ESTFST04                                                         
         OI    REQFLAG1,REQFMIXG   SET HAVE MIXED GOALS                         
         CLI   GOALOPT,GOALDOLS    IF BASIS NOT DOLLARS                         
         BE    ESTFST04                                                         
         OI    REQFLAG1,REQFMIXB   SET HAVE MIXED BASIS                         
ESTFST04 AH    R6,PRDBUFLN                                                      
         BCT   R0,ESTFST02                                                      
                                                                                
         L     R6,PRDBUFF          LOOP TO SET MIX SWITCHES                     
         LH    R0,HIGHPRDN                                                      
         SHI   R0,1                                                             
                                                                                
***********************************************************************         
* Set targets                                                         *         
***********************************************************************         
                                                                                
ESTFST06 LA    R5,PTTRGS           TARGET POSITION CODES                        
         LA    R4,TG1VAR           FIRST TARGET VARIABLE                        
                                                                                
ESTFST08 CLI   0(R5),0                                                          
         BE    ESTFST24            **PATCH HERE TO NO-OP TARGETS**              
                                                                                
**NOOP** CLC   =C'NE',QAGY         NO-OP TARGETS FOR DNNYN FOR NOW              
**NOOP** BE    ESTFST24            ???????????????????????????????              
                                                                                
         SR    R2,R2                                                            
         IC    R2,0(R5)                                                         
         MHI   R2,L'PTDEMNO                                                     
         LA    R2,PTDEMNO-L'PTDEMNO(R2)                                         
         CLC   0(L'PTDEMNO,R2),CORPDEM                                          
         BNE   ESTFST10                                                         
         MVI   0(R5),0             CLEAR AS TARGET                              
         B     ESTFST24                                                         
                                                                                
ESTFST10 LA    R3,TARGETS          FIND DEMO IN TARGET LIST                     
         LHI   RF,PTZDEMMX                                                      
ESTFST12 OC    0(L'PTDEMNO,R3),0(R3)                                            
         BZ    ESTFST14            SET NEW                                      
         CLC   0(L'PTDEMNO,R2),0(R3)                                            
         BE    ESTFST20            ALREADY HAVE                                 
         AHI   R3,L'TARGETS        NEXT TARGET ENTRY                            
         BCT   RF,ESTFST12                                                      
         MVC   P1(20),=C'**Too many targets**'                                  
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         MVI   SKIPSPEC,YESQ                                                    
         J     ENDREQ                                                           
                                                                                
ESTFST14 MVC   0(L'PTDEMNO,R3),0(R2)                                            
                                                                                
         L     RF,APOLPRD          GET ITS POSITION IN POL DEMO LIST            
         AHI   RF,PTDEMNO-PTBUFFD                                               
         LHI   R1,PTZDEMMX                                                      
ESTFST16 CLC   0(L'PTDEMNO,R3),0(RF)                                            
         BE    ESTFST18                                                         
         AHI   RF,L'PTDEMNO                                                     
         BCT   R1,ESTFST16                                                      
         MVC   P2(55),=C'**Demo missing from POL estimate header - prod*        
               uct XXX**'                                                       
         MVC   P2+50(L'PTPRDA),PTPRDA                                           
         MVC   P1(L'QAREA),QAREA                                                
         CLI   INTGBOPT,YESQ       TEST IF IGNORING NON TARGET BRANDS           
         BE    *+12                                                             
         MVI   SKIPSPEC,YESQ                                                    
         J     ENDREQ                                                           
                                                                                
         MVC   P1,P2                                                            
         MVC   P2,SPACES                                                        
         MVC   P2(27),=C'**Product will be ignored**'                           
         GOTOR REPORT,XA=OFF                                                    
         MVI   PTPRDN,PTBEOTQ      SET NO PRODUCT IN THIS ENTRY                 
         XC    PTPRDA,PTPRDA                                                    
         B     ESTFST26                                                         
                                                                                
ESTFST18 LHI   RE,PTZDEMMX                                                      
         SR    R1,RE                                                            
         LPR   R1,R1                                                            
         STC   R1,3(R3)            SET POLP POSITION IN TARGET LIST             
         LR    RE,R3               SET RELATIVE TARGET NUMBER                   
         LA    RF,TARGETS-L'TARGETS                                             
         SR    RE,RF                                                            
         SRL   RE,2                                                             
         STC   RE,ACTDEMSL(R1)                                                  
         LH    RF,NTARGETS         COUNT OF TARGETS                             
         AHI   RF,1                                                             
         STH   RF,NTARGETS                                                      
         B     ESTFST22                                                         
                                                                                
ESTFST20 SR    RF,RF               ALREADY HAVE DEMO AS TARGET                  
         IC    RF,3(R3)                                                         
         SR    RE,RE                                                            
         IC    RE,ACTDEMSL(RF)     GET RELATIVE TARGET NUMBER                   
                                                                                
ESTFST22 LTR   R5,R5               IF NOT DOING GOALED DEMO                     
         BZ    ESTFST26                                                         
         STC   RE,0(R5)            SET RELATIVE TARGET NUMBER                   
                                                                                
ESTFST24 AHI   R4,L'TG1VAR         NEXT TARGET VARIABLE                         
         AHI   R5,1                NEXT TARGET                                  
         LA    RF,PTTRGS+NTGVARS   END OF TARGETS                               
         CR    R5,RF                                                            
         BL    ESTFST08                                                         
         CLC   PTDEMNO,CORPDEM     UNLESS GOALED DEMO IS CORPORATE              
         BE    ESTFST26                                                         
         LA    R2,PTDEMNO          SET IT IN TARGET LIST ALSO                   
         SR    R5,R5                                                            
         B     ESTFST10                                                         
                                                                                
ESTFST26 AH    R6,PRDBUFLN         BUMP TO NEXT PRODUCT                         
         BCT   R0,ESTFST06                                                      
                                                                                
         OC    NTARGETS,NTARGETS   TEST ANY TARGETS PRESENT                     
         BZ    *+8                                                              
         OI    REQFLAG1,REQFTRGS                                                
                                                                                
         NI    REQFLAG1,FF-(REQFHNAD) SET OFF NAD SWITCH                        
         LA    R4,DEMNMS                                                        
         USING DEMNAMD,R4                                                       
         L     R2,APOLPRD                                                       
         AHI   R2,PTDEMLST-PTBUFFD                                              
POL      USING PTDEMLST,R2                                                      
         LHI   R5,PTZDEMMX                                                      
ESTFST28 CLI   POL.PTDEMNO,FF      TEST END OF LIST                             
         BE    ESTFST36                                                         
         OC    POL.PTDEMNO,POL.PTDEMNO                                          
         BZ    ESTFST36                                                         
         MVC   DEMNDEMN,POL.PTDEMNO                                             
         GOTOR DEMOCON,DMCB,DEMNDEMN,(2,DEMNNAME),(C'S',ADBLOCK),      X        
               (SPOTPROF+9,SPUSRNMS),XA=OFF                                     
         MVC   DEMNNADP,SPACES     NAD DEMO PREFIX                              
         CLI   DEMNDEMN,0                                                       
         BE    ESTFST30                                                         
         SR    R0,R0                                                            
         IC    R0,DEMNDEMN                                                      
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  DEMNNADP(3),DUB                                                  
         MVI   DEMNNADP+L'DEMNNADP-1,C'.'                                       
         OI    REQFLAG1,REQFHNAD   SET ON NAD SWITCH                            
ESTFST30 CLI   DEMNDEMN+1,USERDEMO USER DEMO?                                   
         BNE   ESTFST32                                                         
         CLI   DEMNNAME,SPACE      DID DEMOCON GIVE US A NAME?                  
         BH    ESTFST32                                                         
         SR    RF,RF               NO - GET NAME FROM ESTIMATE HEADER           
         IC    RF,DEMNDEMN+L'DEMNDEMN-1                                         
         MHI   RF,L'EUSRNML                                                     
         A     RF,ADEST                                                         
         AHI   RF,EUSRNML-L'EUSRNML-ESTHDR                                      
         MVC   DEMNNAME,0(RF)                                                   
ESTFST32 MVI   DEMNRVSA,DEMNRATQ   USE BYTE AFTER NAME AS RATING                
         CLI   DEMNDEMN+1,RATINGQ  VS AUDIENCE INDICATOR                        
         BE    ESTFST34                                                         
         CLI   DEMNNAME,C'R'       THIS TEST MOSTLY FOR UDEMS                   
         BE    ESTFST34                                                         
         MVI   DEMNRVSA,DEMNAUDQ                                                
ESTFST34 AHI   R2,L'PTDEMNO                                                     
         AHI   R4,DEMNLENQ                                                      
         BCT   R5,ESTFST28                                                      
         DROP  POL,R4                                                           
                                                                                
ESTFST36 L     RF,AWEEKLST         MAKE COPY OF MEDWEEKS                        
         MVC   0(15*L'MEDQ1WKS,RF),MEDQ1WKS                                     
         CLI   MEDQ2WKS,0          ARE ANY WEEKS IN SECOND QUARTER              
         BE    ESTFST38            NO                                           
*                                  YES, ADD THEM AT END OF QTR1                 
         LHI   R0,15               BECAUSE WEEK PROCESSING THROUGHOUT           
         CLI   0(RF),0             PROGRAM DEPENDS ON A                         
         BE    *+12                CONTINUOUS LIST                              
         AHI   RF,L'MEDQ1WKS                                                    
         BCT   R0,*-12                                                          
         MVC   0(15*L'MEDQ1WKS,RF),MEDQ2WKS                                     
                                                                                
ESTFST38 MVI   15*L'MEDQ1WKS(RF),0                                              
         L     RE,AWEEKLST         COUNT WEEKS                                  
         SR    RF,RF                                                            
ESTFST40 CLI   0(RE),0                                                          
         BE    *+16                                                             
         AHI   RF,1                                                             
         AHI   RE,L'MEDQ1WKS                                                    
         B     ESTFST40                                                         
         CHI   RF,MAXWEEKS                                                      
         BNH   ESTFST44                                                         
ESTFST42 MVC   P1(27),=C'**Request period too long**'                           
         J     ENDREQ                                                           
                                                                                
ESTFST44 STH   RF,NWKS                                                          
         AHI   RF,1                                                             
         STH   RF,NWKSP1                                                        
         L     R0,ABRDTAB                                                       
         AHI   R0,8                                                             
         ST    R0,ASUPROW                                                       
                                                                                
         MVC   REALLSDT,EFFS       NO REALLOCATION                              
         CLI   REALLOC,NOQ                                                      
         BE    ESTFST46                                                         
         XC    REALLSDT,REALLSDT   REALLOCATE ALL                               
         CLI   REALLOC,YESQ                                                     
         BE    ESTFST46                                                         
         MVC   BYTE,REALLOC        REALLOCATE STARTING WITH WEEK N              
         NI    BYTE,DIGIT                                                       
         SR    RF,RF                                                            
         IC    RF,BYTE                                                          
         CLI   REALLOC,ZONE                                                     
         BNL   *+8                                                              
         AHI   RF,9                                                             
         BCTR  RF,0                                                             
         MHI   RF,L'MEDQ1WKS                                                    
         A     RF,AWEEKLST                                                      
         MVC   REALLSDT,0(RF)                                                   
                                                                                
ESTFST46 L     RF,ABUFF2           INITIALIZE BUFFER 2 VARIABLES                
         USING BUFFD,RF                                                         
         LHI   R0,UBUFFKL                                                       
         STH   R0,BUFFLKEY         SET KEY LENGTH                               
         LH    R0,NTARGETS         R0=NUMBER OF TARGETS                         
         MHI   R0,L'UBTARGS        X WIDTH OF EACH TARGET                       
         AHI   R0,UBDATAL          ADD ON FIXED DATA WIDTH                      
         CLI   PODRSW,YESQ         AND FOR POD RUN                              
         BNE   *+8                                                              
         AHI   R0,L'UBPODD         ADD ON LENGTH OF POD EXTENSION               
         STH   R0,BUFFLCOM         SET DATA LENGTH                              
         DROP  RF                                                               
                                                                                
         L     RF,AENV1SET         INITIALIZE ENVIRONMENT 1 TABLE               
         L     RF,ENVSATAB-ENVSETD(RF)                                          
         MVI   ENVS1KEY-ENVTABD(RF),ENVSEOTQ                                    
         L     RF,AENV2SET         INITIALIZE ENVIRONMENT 2 TABLE               
         L     RF,ENVSATAB-ENVSETD(RF)                                          
         MVI   ENVS2KEY-ENVTABD(RF),ENVSEOTQ                                    
         L     RF,AENV3SET         INITIALIZE ENVIRONMENT 3 TABLE               
         L     RF,ENVSATAB-ENVSETD(RF)                                          
         MVI   ENVS3KEY-ENVTABD(RF),ENVSEOTQ                                    
                                                                                
         GOTOR BU1INI              INITIALIZE BUFFER 1                          
         GOTOR BU2INI              INITIALIZE BUFFER 2                          
                                                                                
         MVI   DLCNT,0             CLEAR DAYPART/LENGTH COUNT                   
         MVI   MKTBUYGL,0          CLEAR MARKET/BUY FLAG                        
         XC    XCTNREC,XCTNREC     CLEAR EXCLUSION TABLE                        
                                                                                
         L     RF,PRDBUFF          CLEAR PTSTAT IN PRDBUFF                      
         LH    R0,HIGHPRDN                                                      
         MVI   PTSTAT-PTBUFFD(RF),0                                             
         AH    RF,PRDBUFLN                                                      
         BCT   R0,*-8                                                           
         J     EXIT                                                             
         DROP  R6,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* First for client                                                    *         
***********************************************************************         
                                                                                
CLTFST   NMOD1 0,**CLTFST                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     R5,ADCLT                                                         
         USING CLTHDR,R5           R5=A(CLIENT RECORD)                          
                                                                                
         TM    CINDS1,CIN1OVP                                                   
         BZ    *+8                                                              
         OI    CLTFLAG,CLTFOPRD    SET OVERFLOW PRODUCTS ON THIS CLIENT         
                                                                                
         MVC   CLTCPRD,CPRPRD      CORPORATE PRODUCT                            
                                                                                
         XC    PROGPROA(L'PROGPROA+L'PROGPROB),PROGPROA                         
         XC    WORK,WORK                                                        
         MVI   WORK,C'S'                                                        
         MVC   WORK+2(2),QPROG     SET TO READ K5 PROFILE                       
         MVC   WORK+4(2),AGY                                                    
         MVC   WORK+6(1),MED                                                    
         CLI   QOPT5,C' '          TEST SUB-MEDIA SPECIFIED ON REQUEST          
         BE    *+10                                                             
         MVC   WORK+6(1),QOPT5     YES - USE IT                                 
         MVC   WORK+7(3),CLIENT                                                 
         MVI   WORK+10,ASTERISK                                                 
         MVC   WORK+11(1),COFFICE                                               
         MVC   WORK1(16),WORK                                                   
                                                                                
         CLI   QOPT5,C' '          TEST SUB-MEDIA SPECIFIED                     
         BE    CLTFST02                                                         
         GOTOR GETPROF,DMCB,WORK,PROGPROF,DATAMGR,XA=OFF                        
                                                                                
CLTFST02 NI    WORK,FF-C' '                                                     
         MVC   WORK+1(2),QPROG                                                  
         MVI   WORK+3,C'A'                                                      
         GOTOR GETPROF,DMCB,WORK,PROGPROA,DATAMGR,XA=OFF                        
                                                                                
         MVI   WORK+3,C'B'                                                      
         GOTOR (RF),(R1),,PROGPROB,XA=OFF                                       
                                                                                
         CLI   ONETOPTN,YESQ       IF OPTION SET TO YES                         
         BNE   CLTFST04                                                         
         CLI   SVQNET,SPACE        AND WAS SINGLE NETWORK REQUEST               
         BNH   CLTFST04            RESET QNET TO ALL                            
         MVC   QNET,ALLL           (IT WAS SAVED IN SVQNET)                     
                                                                                
CLTFST04 CLI   QNET,SPACE                                                       
         BH    *+10                                                             
         MVC   QNET,ALLL                                                        
         CLC   QNET,ALLL                                                        
         BE    CLTFST06                                                         
         MVC   WORK(16),WORK1      READ NET N2 PROFILE GOT GOAL OPTION          
         MVI   WORK,C'N'                                                        
         MVC   WORK+2(2),QPROGN2L                                               
         MVC   WORK+6(1),MED                                                    
         GOTOR GETPROF,DMCB,WORK,WORK1,DATAMGR,XA=OFF                           
         CLI   WORK1+15,YESQ                                                    
         BNE   CLTFST06                                                         
         MVC   P1(61),=C'** Network=All requests not allowed if doing N*        
               etwork goals **'                                                 
         GOTOR REPORT,XA=OFF                                                    
                                                                                
CLTFST06 L     RF,ADBLOCK          INITIALIZE DBLOCK VALUES                     
         MVC   DBFILE-DBLOCK(L'DBFILE,RF),=C'NTI'                               
         MVC   DBSELMED-DBLOCK(L'DBSELMED,RF),QMED                              
         NI    REQFLAG2,FF-(REQFSLEN+REQFSDPT)                                  
         MVC   GOALOPT,ALOCOPTN                                                 
         MVC   RSWKOPT,GOALOPTN                                                 
         MVC   ZERWKOPT,ZEROOPTN                                                
         CLI   QOPT6,SPACE         QOPT6=ZERO WEEK OPTION OVERRIDE              
         BE    *+10                                                             
         MVC   ZERWKOPT,QOPT6                                                   
         CLI   DSEPOPTN,YESQ                                                    
         BNE   *+8                                                              
         OI    REQFLAG2,REQFSDPT                                                
         CLI   DSECOPTN,YESQ                                                    
         BNE   *+8                                                              
         OI    REQFLAG2,REQFSLEN                                                
         MVC   INTRVLS(INTRVLSL),BTVLOPTN INTERVAL CONTROLS                     
                                                                                
         CLI   PINTPCT,0           PERCENTS FROM 0 TO 100                       
         BNE   *+8                                                              
         MVI   PINTPCT,100                                                      
         CLI   CINTPCT,0                                                        
         BNE   *+8                                                              
         MVI   CINTPCT,100                                                      
         CLI   PINTRVL,0           IF INTERVLS ARE 0 PCTS SHOULD BE 0           
         BNE   *+8                                                              
         MVI   PINTPCT,0                                                        
         CLI   CINTRVL,0                                                        
         BNE   *+8                                                              
         MVI   CINTPCT,0                                                        
         CLI   PINTRVL,1           IF PRODUCT PROGRAM EXCLUSION                 
         BNE   *+16                                                             
         CLI   PINTPCT,100         PERCENT MUST BE AT LEAST 100                 
         BNL   *+8                                                              
         MVI   PINTPCT,100                                                      
         CLI   CINTRVL,1           IF CLASS PROGRAM EXCLUSION                   
         BNE   *+16                                                             
         CLI   CINTPCT,100         PERCENT MUST BE AT LEAST 100                 
         BNL   *+8                                                              
         MVI   CINTPCT,100                                                      
         MVC   OBJWGTS(OBJWGTSL),OBJ1WGHT                                       
                                                                                
CLTFST08 MVC   REALLOC,QOPT1                                                    
         CLI   REALLOC,SPACE                                                    
         BNE   *+8                                                              
         MVI   REALLOC,NOQ                                                      
         CLI   QOPT3,NOQ                                                        
         BE    *+8                                                              
         MVI   QOPT3,YESQ          EXCESS OPTION DEFAULTS TO YES                
         MVC   EXCSOPT,QOPT3                                                    
         CLI   QOPT2,SPACE                                                      
         BE    CLTFST10                                                         
         MVC   GOALOPT,QOPT2       OVERRIDE FOR GOALOPT                         
                                                                                
CLTFST10 MVC   TRGBASE,GOALOPT     SET TARGET VALUE BASIS                       
         TM    REQFLAG1,REQFMIXB                                                
         BZ    *+8                                                              
         MVI   TRGBASE,GOALDOLS    MUST BE DOLLARS IF MIXED GOALS               
                                                                                
***********************************************************************         
* Note:- force CPM target maximization not value per base demo point  *         
***********************************************************************         
                                                                                
         MVI   TRGBASE,GOALDOLS    BASE ALWAYS DOLLARS                          
         LA    RE,OBJWGTS          SET REQUEST OVERRIDES OF WEIGHTS             
         LA    RF,QBOOK1           WEIGHTS AT QBOOK1                            
         LA    R1,VARWGTS                                                       
         LHI   R0,VARWGTSN                                                      
CLTFST12 CLI   0(RF),SPACE                                                      
         BNH   CLTFST14                                                         
         MVC   0(1,RE),0(RF)                                                    
         NI    0(RE),DIGIT         STRIP ZONE                                   
         CLI   0(RF),C'A'          A = 10                                       
         BNE   CLTFST14                                                         
         MVI   0(RE),10                                                         
CLTFST14 XC    0(L'VARWGTS,R1),0(R1)                                            
         MVC   L'VARWGTS-L'OBJWGTS(L'OBJWGTS,R1),0(RE)                          
         AHI   R1,L'VARWGTS                                                     
         AHI   RE,L'OBJWGTS        NEXT WEIGHT                                  
         AHI   RF,1                                                             
         BCT   R0,CLTFST12                                                      
                                                                                
         OC    OBJWGTS(OBJWGTSL),OBJWGTS TEST ANY WEIGHTS                       
         BNZ   CLTFST16                                                         
         MVC   P1(37),=C'**No SK5A profile - request aborted**'                 
         J     ENDREQ                                                           
                                                                                
***********************************************************************         
* Adjust env variable weights to reduce their impact. Factor each     *         
* weight down so the sum of the weights equals the largest weight     *         
* given.  This is done because people tend to overstate these weights *         
* and these variables are less visible.                               *         
***********************************************************************         
                                                                                
CLTFST16 LA    R2,ENV1VAR          ENVIRONMENT VARIABLES ARE 3                  
         LHI   R3,ENVNVAR          THRU 5                                       
         SR    RF,RF               FOR SUM                                      
         SR    R4,R4               FOR LARGEST                                  
CLTFST18 A     RF,0(R2)            SUM                                          
         C     R4,0(R2)            TEST VS LARGEST                              
         BNL   *+8                                                              
         L     R4,0(R2)                                                         
         AHI   R2,L'ENV1VAR                                                     
         BCT   R3,CLTFST18                                                      
                                                                                
         LA    R2,ENV1VAR                                                       
         LHI   R3,ENVNVAR                                                       
CLTFST20 ICM   R1,15,0(R2)         CURRENT WEIGHT                               
         BZ    CLTFST22                                                         
         MR    R0,R4               X LARGEST                                    
         GOTOR DIVIDE              / SUM                                        
         LTR   R1,R1               DON'T REDUCE TO ZERO                         
         BP    *+8                                                              
         LHI   R1,1                                                             
         ST    R1,0(R2)            = NEW WEIGHT                                 
CLTFST22 AHI   R2,L'ENV1VAR                                                     
         BCT   R3,CLTFST20                                                      
                                                                                
***********************************************************************         
* Move all env adcons and variables to environment set areas          *         
***********************************************************************         
                                                                                
         LA    RE,ENV1VAR                                                       
         LA    R1,AENV1SET                                                      
         LHI   R0,NENVS                                                         
CLTFST24 L     RF,0(R1)                                                         
         MVC   ENVSVAR-ENVSETD(,RF),0(RE) VARIABLES                             
         AHI   RE,L'ENV1VAR        NEXT VAR                                     
         AHI   R1,L'AENV1SET       NEXT ENVIRONMENT SET                         
         BCT   R0,CLTFST24                                                      
                                                                                
         XC    DPSLFLT,DPSLFLT     SET DAYPART/LENGTH FILTERS                   
                                                                                
         LA    R2,KEY                                                           
         USING NDPTKEY,R2          TEST USING DAYPART RECORDS                   
         XC    NDPTKEY,NDPTKEY                                                  
         MVI   NDPTKTY,NDPTKTYQ                                                 
         MVI   NDPTKST,NDPTKSTQ                                                 
         MVC   NDPTAGM,BAGYMD                                                   
         MVC   KEYSAVE,NDPTKEY                                                  
         GOTOR DATAMGR,DMCB,DMRDHI,UNTDIR,NDPTKEY,NDPTKEY,XA=OFF                
         CLC   NDPTKEY(NDPTCLT-NDPTKEY),KEYSAVE                                 
         BNE   *+8                                                              
         OI    REQFLAG1,REQFDPTR   SET AGENCY USES DAYPART RECORDS              
                                                                                
         CLI   QPROG+58,SPACE      TEST OLD DAYPART FILTER SET                  
         BE    CLTFST26                                                         
         MVC   DPTFLT,QPROG+58                                                  
         NI    REQFLAG1,FF-(REQFDPTR)                                           
         B     CLTFST32                                                         
                                                                                
CLTFST26 CLI   QDPTFLT,SPACE       TEST NEW DAYPART FILTER SET                  
         BNH   CLTFST32                                                         
         MVC   DPTFLT,QDPTFLT      SET DAYPART FILTER FROM REQUEST              
         TM    REQFLAG1,REQFDPTR   TEST AGENCY USES DAYPART RECORDS             
         BZ    CLTFST32                                                         
                                                                                
CLTFST28 CLC   NDPTKEY(NDPTDPTE-NDPTKEY),KEYSAVE                                
         BNE   CLTFST30                                                         
         CLC   NDPTDPTA,QDPTFLT    MATCH DAYPART FILTER TO RECORD               
         BNE   *+14                                                             
         MVC   DPTFLT,NDPTDPTE     SET FILTER FROM DAYPART KEY                  
         B     CLTFST32                                                         
         GOTOR DATAMGR,DMCB,DMRSEQ,UNTDIR,NDPTKEY,NDPTKEY,XA=OFF                
         B     CLTFST28                                                         
                                                                                
CLTFST30 MVC   NDPTKEY,KEYSAVE     RESTORE FIRST SEARCH KEY                     
         OC    NDPTCLT,NDPTCLT     TEST SEARCHED FOR CLIENT DAYPART             
         BZ    *+6                                                              
         DC    H'0'                YES - INVALID DAYPART FILTER                 
         MVC   NDPTCLT,BCLT                                                     
         MVC   KEYSAVE,NDPTKEY                                                  
         GOTOR DATAMGR,DMCB,DMRDHI,UNTDIR,NDPTKEY,NDPTKEY,XA=OFF                
         B     CLTFST28                                                         
         DROP  R2                                                               
                                                                                
CLTFST32 MVI   PODRSW,NOQ          SET NOT A POD RUN                            
         XC    PODDESC(PODDSCL),PODDESC                                         
         CLI   QPROG+59,SPACE      SECOND LENGTH FILT AT +59(2)                 
         BNH   CLTFSTX                                                          
         CLI   QPROG+59,ZONE       POD REQUEST                                  
         BNL   CLTFST34                                                         
                                                                                
         MVI   PODRSW,YESQ         SET IS A POD RUN                             
         OI    REQFLAG2,REQFSLEN+REQFSDPT                                       
         MVI   LENFLT,LENFPODO                                                  
         MVC   PODNUM,QPROG+59     POD CODE (LETTER)                            
         NI    PODNUM,DIGIT        STRIP HOB                                    
         CLI   PODNUM,PODDSCN      TEST VALID POD GROUP                         
         BH    CLTFSTX                                                          
         SR    RF,RF                                                            
         ICM   RF,1,PODNUM                                                      
         BZ    CLTFSTX                                                          
         BCTR  RF,0                                                             
         MHI   RF,PODDSCL                                                       
         A     RF,APODDSC                                                       
         MVC   PODDESC(PODDSCL),0(RF)                                           
         MVC   PODCOD,QPROG+59     SET POD CODE                                 
         B     CLTFSTX                                                          
                                                                                
CLTFST34 PACK  DUB,QPROG+59(2)     REGULAR SECONDS LENGTH FILTER                
         CVB   R0,DUB                                                           
         STC   R0,LENFLT                                                        
                                                                                
CLTFSTX  J     EXIT                                                             
         DROP  R5,RB                                                            
                                                                                
QPROGN2L DC    AL2(QPROGN2)        N2 PROGRAM CODE                              
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Process a goal record                                               *         
***********************************************************************         
                                                                                
         USING MEDBLOCK,R8                                                      
PRCGOL   NMOD1 PGWORKL,**PRCGOL,CLEAR=YES                                       
         LR    R5,RC                                                            
         USING PGWORKD,R5          R5=A(LOCAL WORKING STORAGE)                  
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     R7,ADGOAL                                                        
         USING GXKEY,R7            R7=A(GOAL RECORD)                            
         MVC   PGEST,GXKEYEST                                                   
         MVC   PGDPT,GXKEYDPT                                                   
         CLI   GXKEYSEC,0          IF TOTAL LENGTH = 0                          
         BNE   *+10                                                             
         MVC   GXKEYSEC,GXKEYSLN   USE OTHER LENGTH                             
         MVC   PGLEN,GXKEYSEC                                                   
         GOTOR LOCPRA,GXKPRDA      LOCATE PRODUCT BUFFER ENTRY                  
         BNE   PRCGOLX                                                          
         LA    R7,GXDATA           POINT TO FIRST ELEMENT                       
         DROP  R7                                                               
                                                                                
PRCGOL04 STCM  R1,PRDMSKQ,PGPRD    SET PRODUCT CODE & CLASS                     
         MVC   PGCLASS,PTCLASS-PTBUFFD(R1)                                      
                                                                                
         CLI   DPTFLT,0            APPLY DAYPART FILTER IF NECESSARY            
         BE    *+14                                                             
         CLC   PGDPT,DPTFLT                                                     
         BNE   PRCGOLX                                                          
                                                                                
         CLI   LENFLT,0            APPLY LENGTH FILTER IF NECESSARY             
         BE    PRCGOL06                                                         
         CLC   PGLEN,LENFLT                                                     
         BE    PRCGOL06                                                         
         CLI   LENFLT,LENFPODO     TEST POD SPLITS REQUEST ONLY                 
         BNE   PRCGOLX                                                          
         LA    RF,PODLENS          RF=A(POD SPLIT LENGTHS)                      
         LH    R0,PODLENSN         NUMBER OF LENGTHS                            
         CLC   PGLEN,0(RF)                                                      
         BE    PRCGOL06                                                         
         AHI   RF,L'PODLENS                                                     
         BCT   R0,*-14                                                          
         B     PRCGOLX             REJECT IF LENGTH IS NOT USABLE               
                                                                                
PRCGOL06 MVI   PGACTSW,NOQ         CLEAR ACTIVITY FOR THIS RECORD               
         L     RF,ABUFF1           SET REPLACE DATA OPTION                      
         OI    BUFFINDS-BUFFD(RF),BUFFIRCM                                      
         MVC   MEDSPTLN,PGLEN                                                   
         MVC   MEDDPNO,PGDPT                                                    
         MVI   MEDNOPIG,YESQ       DON'T SPLIT UP PIGGY DOLLARS                 
         GOTOR MEDGETGL,DMCB,SPWORKD,XA=OFF                                     
                                                                                
         XC    GBUFFR(GBUFFRL),GBUFFR                                           
         MVC   GBDPT(ALLDLL),ALLDL                                              
         TM    REQFLAG2,REQFSDPT                                                
         BZ    *+10                                                             
         MVC   GBDPT,PGDPT         DAYPART                                      
         TM    REQFLAG2,REQFSLEN                                                
         BZ    *+10                                                             
         MVC   GBLEN,PGLEN         SECONDS LENGTH                               
         MVI   GBTYP,TGOLDEMQ      ORIGINAL GOALS                               
                                                                                
         USING GDELEM,R7                                                        
PRCGOL08 MVC   GBPRD,PGPRD                                                      
         MVC   GBCLASS,PGCLASS                                                  
         MVI   GBPRI,NOQ                                                        
         TM    GDSTAT,GDSXALCQ                                                  
         BZ    *+8                                                              
         MVI   GBPRI,YESQ                                                       
         L     RF,MEDPERD+4                                                     
         USING MEDDATA,RF                                                       
         CLI   GBTYP,TGOLDEMQ      DEMO                                         
         BE    PRCGOL10                                                         
         MVC   GBTOT,MEDGLD                                                     
         B     PRCGOL12                                                         
                                                                                
PRCGOL10 MVC   GBTOT,MEDGL1        GOALS                                        
         SR    R1,R1                                                            
         ICM   R1,PRDMSKQ,PGPRD                                                 
         MVC   HDEM,PTDEMNO-PTBUFFD(R1)                                         
         CLI   HDEM+1,RATINGQ      OK IF RATING                                 
         BE    PRCGOL12                                                         
         CLI   HDEM+1,EXDRTGQ      OR EXTENDED RATING                           
         BE    PRCGOL12                                                         
         L     R1,MEDGL1           ELSE DIVIDE BY 10                            
         M     R0,FW1                                                           
         LHI   RF,10                                                            
         GOTOR DIVIDE                                                           
         STCM  R1,15,GBTOT                                                      
                                                                                
PRCGOL12 OC    GBTOT,GBTOT                                                      
         BZ    PRCGOL26                                                         
         MVI   PGACTSW,YESQ        SET RECORD ACTIVITY                          
         L     R4,MEDAFRST                                                      
         LA    R2,GBWKS            R2=A(WEEKLY ACCUMULATORS)                    
PRCGOL14 CLI   0(R4),0             SKIP GAPS                                    
         BE    PRCGOL22                                                         
         L     RF,4(R4)                                                         
         CLI   GBTYP,TGOLDEMQ      DEMO                                         
         BE    PRCGOL18                                                         
         MVC   0(L'GBWKS,R2),MEDGLD                                             
         B     PRCGOL20                                                         
                                                                                
PRCGOL18 MVC   0(L'GBWKS,R2),MEDGL1 GOAL                                        
         CLI   HDEM+1,RATINGQ      OK IF RATING                                 
         BE    PRCGOL20                                                         
         CLI   HDEM+1,EXDRTGQ      OR EXTENDED RATING                           
         BE    PRCGOL20                                                         
         L     R1,MEDGL1           ELSE DIVIDE BY 10                            
         M     R0,FW1                                                           
         LHI   RF,10                                                            
         GOTOR DIVIDE                                                           
         ST    R1,0(R2)                                                         
PRCGOL20 AHI   R2,L'GBWKS          NEXT WEEK                                    
PRCGOL22 AHI   R4,L'MEDQ1WKS                                                    
         C     R4,MEDALAST         TEST AT END                                  
         BNH   PRCGOL14                                                         
                                                                                
PRCGOL24 OC    GBROW(GBROWL),GBROW                                              
         BZ    PRCGOL26                                                         
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
         MVC   GBPRD,TOTPRD        PRODUCT TOTALS                               
         MVI   GBCLASS,0                                                        
         MVI   GBPRI,NOQ                                                        
         GOTOR BU1PUT                                                           
                                                                                
PRCGOL26 CLI   GBTYP,TGOLDOLQ      TEST HAVE DONE DOLLARS                       
         BE    PRCGOL28                                                         
         MVI   GBTYP,TGOLDOLQ      NO - DO NOW                                  
         B     PRCGOL08                                                         
                                                                                
PRCGOL28 CLI   PGACTSW,YESQ        TEST RECORD ACTIVE                           
         BNE   PRCGOL42            NO, DONE                                     
                                                                                
         OI    MKTBUYGL,MKTBHGOL   SET HAVE GOALS                               
         SR    R1,R1                                                            
         ICM   R1,PRDMSKQ,PGPRD                                                 
         USING PTBUFFD,R1          UPDATE PRODUCT BUFFER ENTRY                  
         OI    PTSTAT,PTSACTVQ     SET BRAND ACTIVE                             
         TM    GDSTAT,GDSXALCQ     TEST IGNORE SET FOR ALLOCATIONS              
         BZ    *+8                                                              
         OI    PTSTAT,PTSPRTYQ     YES - SET PRIORTY                            
         DROP  R1                                                               
                                                                                
         LA    R7,GDELEM           CHECK DAY OF WEEK MASK                       
         USING GLEMENT,R7                                                       
PRCGOL30 MVI   PGDAY1,0            CLEAR DAY MASK                               
         CLI   GLCODE,0            TEST END OF RECORD                           
         BE    PRCGOL38                                                         
         CLI   GLCODE,GLCODEQ      GOAL WEEKLY ELEMENT                          
         BE    PRCGOL34                                                         
PRCGOL32 SR    R0,R0               BUMP TO NEXT ELEMENT ON RECORD               
         IC    R0,GLEN                                                          
         AR    R7,R0                                                            
         B     PRCGOL30                                                         
                                                                                
PRCGOL34 CLC   GLWEEK,BQSTARTP     SKIP IF BEFORE START                         
         BL    PRCGOL32                                                         
         CLC   GLWEEK,BQENDP       OR IF AFTER END                              
         BH    PRCGOL32                                                         
         CLI   GLEN,GLEN3Q         NO MASK IF ELEMENT NOT LONG ENOUGH           
         BL    PRCGOL36                                                         
         CLI   GLDAY,0             OR IF DAY MASK IS NULL                       
         BE    PRCGOL36                                                         
         CLI   GLDAY,GLDAYMSQ      OR IF MONDAY-SUNDAY                          
         BE    PRCGOL36                                                         
         MVC   PGDAY1,GLDAY        ELSE SET MASK                                
PRCGOL36 CLC   PGDAY1,PGDAY2       ARE MASKS THE SAME                           
         BNE   PRCGOL38                                                         
         MVC   PGWEEK2,GLWEEK      YES, SAVE LATEST WEEK                        
         B     PRCGOL32            AND GET NEXT ELEMENT                         
                                                                                
PRCGOL38 CLI   PGDAY2,0            IS ANY ENTRY READY TO FINISH                 
         BE    PRCGOL40            NO, START A NEW ONE                          
                                                                                
B        USING XCTABD,PGBUILD                                                   
         XC    B.XCTABD(XCTTABL),B.XCTABD                                       
         MVC   B.XCTNET,EFFS       SET NETWORK TO 'ALL'                         
         MVC   B.XCTPRD,PGPRD      PRODUCT                                      
         MVC   B.XCTEST,PGEST      ESTIMATE                                     
         MVI   B.XCTTYPE,XCTTDOWQ  SET TYPE TO DAY OF WEEK                      
         MVC   B.XCTDAY,PGDAY2     SAVED DAY OF WEEK                            
         XI    B.XCTDAY,GLDAYMSQ   COMPLEMENT                                   
         MVC   B.XCTDPT,PGDPT      DAYPART                                      
         MVC   B.XCTLEN,PGLEN      LENGTH                                       
         GOTOR DATCON,DMCB,(2,PGWEEK2),WORK,XA=OFF                              
         GOTOR ADDAY,DMCB,WORK,WORK+6,6,XA=OFF                                  
         GOTOR DATCON,DMCB,(0,WORK+6),(2,PGWEEK2),XA=OFF                        
         MVC   B.XCTDATES(XCTDATEL),PGWEEK1                                     
         GOTOR BINSRCH,XCTPARS,(1,B.XCTABD),XA=OFF                              
         OC    1(3,R1),1(R1)       TEST TABLE IS FULL                           
         BNZ   PRCGOL40                                                         
         MVC   P1(23),=C'**Too many exclusions**'                               
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         J     ENDREQ                                                           
                                                                                
PRCGOL40 CLI   GLCODE,0            TEST END OF RECORD                           
         BE    PRCGOL42                                                         
         MVC   PGDAY2,PGDAY1       ELSE MOVE THIS DAY MASK TO OLD               
         MVC   PGWEEK1,GLWEEK      START WEEK                                   
         MVC   PGWEEK2,GLWEEK                                                   
         B     PRCGOL32            NEXT ELEMENT                                 
                                                                                
PRCGOL42 L     RF,ABUFF1                                                        
         NI    BUFFINDS-BUFFD(RF),FF-(BUFFIRCM)                                 
                                                                                
PRCGOLX  J     EXIT                                                             
         DROP  R5,R7,RB                                                         
                                                                                
         LTORG                                                                  
                                                                                
PGWORKD  DSECT                     ** PRCGOL LOCAL WORKING STORAGE **           
PGACTSW  DS    C                   GOAL RECORD ACTIVE (YESQ/NOQ)                
PGPRD    DS    FL(PRDLENQ)         PRODUCT POINTER                              
PGCLASS  DS    XL(L'PTCLASS)       PRODUCT CLASS                                
PGEST    DS    XL(L'GKEYEST)       ESTIMATE NUMBER                              
PGDPT    DS    XL(L'GKEYDPT)       DAYPART CODE                                 
PGLEN    DS    XL(L'GKEYSEC)       SECONDS LENGTH                               
                                                                                
PGDAY1   DS    XL(L'GLDAY)         DAY 1 MASK                                   
PGDAY2   DS    XL(L'GLDAY)         DAY 2 MASK                                   
                                                                                
PGWEEK1  DS    XL(L'GLWEEK)        START WEEK                                   
PGWEEK2  DS    XL(L'GLWEEK)        END WEEK                                     
                                                                                
PGBUILD  DS    XL(XCTTABL)         XCTAB BUILD AREA                             
                                                                                
PGWORKL  EQU   *-PGWORKD                                                        
SPK502   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Call NETIO to read unit records and process them                    *         
***********************************************************************         
                                                                                
NETNGETQ EQU   C'R'                                                             
NETNPUTQ EQU   C'W'                                                             
                                                                                
NETUNT   NMOD1 0,**NETUNT                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     R8,ANETBLK                                                       
         USING NETBLKD,R8          R8=A(NET BLOCK)                              
                                                                                
         CHI   R1,NETNPUTQ         IF FROM WRITEBACK REWRITE RECORDS            
         BNE   NETUNT04                                                         
                                                                                
         MVI   PODUPDER,NOQ        OVERFLOW TEST ON                             
         IC    R0,QOPT4                                                         
         MVI   QOPT4,YESQ                                                       
         GOTOR AREWREC             DO TEST UPDATE OF FILE                       
         CLI   PODUPDER,YESQ       TEST FOR ERRORS                              
         BNE   NETUNT02                                                         
         MVC   P1(68),=C'** Errors have occurred in attempting to write*        
                POD allocation. **'                                             
         MVC   P2(32),=C'** File has not been updated. **'                      
         MVI   P3,0                                                             
         MVC   P4(17),=C'** Contact DDS **'                                     
         GOTOR REPORT,XA=OFF                                                    
         B     NETUNTX                                                          
                                                                                
NETUNT02 CHI   R0,YESQ             IF TEST RUN REQUEST, THEN DONE               
         BE    NETUNTX                                                          
         STC   R0,QOPT4                                                         
         GOTOR AREWREC             DO REAL UPDATE OF FILE                       
         CLI   PODUPDER,NOQ        TEST FOR ERRORS                              
         BE    NETUNTX                                                          
         DC    H'0'                                                             
         EJECT                                                                  
***********************************************************************         
* Read units (via NETIO), filter and post to buffers                  *         
***********************************************************************         
                                                                                
NETUNT04 LA    R0,NETBLKD          INITIALIZE NETBLOCK VALUES                   
         LHI   R1,XDBLKEND-NETBLKD                                              
         GOTOR CLEAR                                                            
         MVC   NBNETVAL,NETVALUE                                                
         MVC   NBDEMCON,DEMOCON                                                 
         LARL  RE,DMGRWORK                                                      
         ST    RE,NBADMWRK         SET DATAMGR WORK AREA                        
         MVC   NBSELAGY,QAGY       AGENCY                                       
         MVC   NBSELMED,QMED       MEDIA                                        
         MVC   NBSELCLI,CLT        CLIENT                                       
         MVC   NBSELEST,BEST       ESTIMATE START                               
         MVC   NBSELESE,BESTEND    ESTIMATE END                                 
         CLC   NOL,QEST                                                         
         BNE   *+10                                                             
         MVC   NBSELEFL,QESTEND    ESTIMATE FILTER                              
         CLC   NBSELEFL,SPACES                                                  
         BNE   *+10                                                             
         XC    NBSELEFL,NBSELEFL                                                
         MVC   NBSELSTR(L'QSTART+L'QEND),QSTART                                 
         CLI   QNET,SPACE                                                       
         BNH   NETUNT06                                                         
         MVC   NBSELNET,QNET       SELECT NETWORK                               
         CLC   ALL3L,QNET          TEST 'ALL' NETWORK REQUEST                   
         BNE   NETUNT06                                                         
         XC    NBSELNET,NBSELNET                                                
         CLI   QSUBMED,C' '        TEST/SET MEDIA FILTER                        
         BNH   NETUNT06                                                         
         MVC   NBSELMFL,QSUBMED                                                 
                                                                                
NETUNT06 MVI   NBDATA,NBDUNTQ      UNITS                                        
         MVI   NBSEQ,NBSNETQ       READ UNITS IN DATE SEQUENCE                  
         CLI   BEST,0              BUT FOR SINGLE ESTIMATE REQUEST              
         BE    NETUNT08            READ IN PROGRAM SEQUENCE                     
         CLI   BESTEND,0           (NOT IF ESTIMATE RANGE)                      
         BNE   NETUNT08                                                         
         CLC   QESTEND,SPACES      (OR FILTER)                                  
         BNE   NETUNT08                                                         
         MVI   NBSEQ,NBSPRGQ       ELSE SET PROGRAM SEQUENCE                    
                                                                                
NETUNT08 MVI   NBESTOPT,NBESTOUQ   ESTIMATED DEMOS (ALSO MAKEGOODS)             
         MVC   NBTRCOPT,RCTRACE    TRACE                                        
         MVI   NBFUNCT,NBFNORM     NORMAL FUNCTION                              
         MVC   NBAIO,APXCREC       USE EXCLUSION RECORD AREA                    
         MVC   NBPRINT,PRINT                                                    
         MVC   NBLOADER,LOADER                                                  
         MVC   NBACOM,ACOMFACS                                                  
         LARL  RE,NETBUFF                                                       
         ST    RE,NBANBUFF                                                      
         LARL  RE,DMGRWORK                                                      
         ST    RE,NBADMWRK         SET DATAMGR WORK AREA                        
         OI    NBINDS6,NBI6XDEM    SET EXPANDED DEMO BLOCK                      
         OI    NBINDS7,NBI7NTIO    SET EXPANDED BUFFER                          
         LA    RE,XDDEMBLK                                                      
         ST    RE,NBADEM           A(DEMO AREA)                                 
         LM    RE,RF,DEMOVDD       RE=DISP. TO DEMO LIST/RF=LENGTH-1            
         A     RE,APOLPRD                                                       
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   XDDEMOS(0),0(RE)    DEMO LIST                                    
         LM    RE,RF,DEMOVWD       RE=DISP. TO WEIGHT LIST/RF=LENGTH-1          
         A     RE,APOLPRD                                                       
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   XDWGTLST(0),0(RE)   WEIGHTING LIST                               
         L     RF,ADEST                                                         
         MVC   XDUSRNMS,EUSRNMS-ESTHDR(RF)                                      
         TM    REQFLAG1,REQFTRGS   TEST TARGETS                                 
         BNZ   *+10                                                             
         XC    XDDEMOS+L'XDDEMLST(L'XDDEMLST),XDDEMOS+L'XDDEMLST                
         XC    UNTSEQ,UNTSEQ       INITIALIZE UNIT SEQUENCE NUMBER              
         LARL  RF,PODTAB                                                        
         MVI   0(RF),PDTEOTQ       CLEAR POD TABLE                              
                                                                                
NETUNT10 GOTOR NETIO,DMCB,NETBLKD,XA=OFF                                        
         CLI   NBERROR,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLI   NBMODE,NBVALCLI     TEST VALIDATE CLIENT                         
         BNE   *+12                                                             
         MVI   NBN0B2,0            SUPPRESS AUTO EQUIVALENCING                  
         B     NETUNT10                                                         
                                                                                
         CLI   NBMODE,NBREQLST     TEST LAST FOR REQUEST                        
         BE    NETUNT44                                                         
                                                                                
         CLI   NBMODE,NBPROCUN     TEST PROCESS UNIT                            
         BNE   NETUNT10                                                         
         EJECT                                                                  
***********************************************************************         
* Process a unit record                                               *         
***********************************************************************         
                                                                                
         L     R4,NBAIO                                                         
         USING NURECD,R4           R4=A(UNIT RECORD)                            
                                                                                
         TM    NBUNITST,NBUNPREQ+NBUNMISQ                                       
         BNZ   NETUNT10                                                         
                                                                                
         CLI   ZCSTOPTN,C'Y'       TEST EXCLUDING ZERO COST UNITS               
         BNE   *+14                                                             
         OC    NUACTUAL,NUACTUAL   TEST ACTUAL COST                             
         BZ    NETUNT10                                                         
                                                                                
         CLI   DPTFLT,0            TEST DAYPART FILTER PRESENT                  
         BE    *+14                                                             
         CLC   DPTFLT,NBACTDP      YES - TEST                                   
         BNE   NETUNT10                                                         
                                                                                
         CLI   LENFLT,0            TEST LENGTH FILTER                           
         BE    NETUNT12                                                         
         CLC   LENFLT,NBLEN        IF AGREES ON LENGTH - OK                     
         BE    NETUNT12                                                         
         CLI   LENFLT,LENFPODO     TEST POD RUN                                 
         BNE   NETUNT10            NO - REJECT UNIT                             
         LA    RF,PODLENS          TEST LENGTH IS A POD SPLIT LENGTH            
         LH    R0,PODLENSN                                                      
         CLC   NBLEN,0(RF)                                                      
         BE    NETUNT12                                                         
         AHI   RF,L'PODLENS                                                     
         BCT   R0,*-14                                                          
         B     NETUNT10                                                         
                                                                                
NETUNT12 GOTOR AGETUNT             GET UNIT VALUES                              
         BNE   NETUNT10            REJECT IF BAD (PRODUCTS)                     
                                                                                
         AHI   R4,NUDATA-NURECD                                                 
         USING NUPRDD,R4                                                        
         SR    R0,R0                                                            
NETUNT14 CLI   NUPRDEL,EOR         TEST END OF RECORD                           
         BE    NETUNT16                                                         
         CLI   NUPRDEL,NUPRDELQ    SKIP ANY TRIGBACK UNITS                      
         BE    NETUNT10                                                         
         IC    R0,NUPRDLEN         BUMP TO NEXT ELEMENT ON RECORD               
         AR    R4,R0                                                            
         B     NETUNT14                                                         
                                                                                
NETUNT16 CLI   SKIPOPTN,YESQ       TEST TO EXCLUDE BONUS UNITS                  
         BNE   NETUNT18                                                         
         TM    NBUNITST,NBUNPFBQ   SKIP IF PFB                                  
         BNZ   NETUNT10                                                         
         B     NETUNT20            LOOK FOR SECOND DATA ELEMENT                 
                                                                                
NETUNT18 CLI   ICSPOPTN,YESQ       TEST TO INCLUDE COPY SPLITS                  
         BE    NETUNT26            YES, NO SPECIAL CHECK HERE                   
                                                                                
NETUNT20 L     R4,NBAIO                                                         
         AHI   R4,NUDATA-NURECD    LOOK FOR SECONDARY STANDARD ELEMENT          
         USING NUSDRD,R4                                                        
         SR    R0,R0                                                            
NETUNT22 CLI   NUSDREL,EOR         TEST END OF RECORD                           
         BE    NETUNT26                                                         
         CLI   NUSDREL,NUSDRELQ                                                 
         BE    NETUNT24                                                         
         IC    R0,NUSDRLEN                                                      
         AR    R4,R0                                                            
         B     NETUNT22                                                         
                                                                                
NETUNT24 CLI   SKIPOPTN,YESQ       IF SKIPPING BONUS UNITS                      
         BNE   *+12                                                             
         TM    NUSDST3,NUSDADUQ    THEN SKIP ADU UNITS                          
         BNZ   NETUNT10                                                         
         CLI   ICSPOPTN,YESQ       TEST TO INCLUDE COPY SPLITS                  
         BE    NETUNT26                                                         
         TM    NUSDST3,NUSDUCSQ    NO, THEN SKIP THEM                           
         BNZ   NETUNT10                                                         
         DROP  R4                                                               
                                                                                
NETUNT26 MVI   NTUPODSW,NTUPNOTQ   SET NOT POD                                  
                                                                                
         L     R1,NBACTUAL         COST IS ACTUAL                               
         CLI   ASSGNOPT,YESQ                                                    
         BNE   *+8                                                              
         L     R1,NBASSIGN         OR ASSIGNED                                  
         CLI   INTGOPTN,YESQ       TEST INCLUDING INTEGRATION                   
         BNE   *+8                                                              
         A     R1,NBINTEG                                                       
         ST    R1,FACTOR2          UNROUNDED COST IN FACTOR2                    
         M     R0,FW1              ROUND COST TO DOLLARS                        
         LHI   RF,100                                                           
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1          ROUNDED COST IN FACTOR1                      
                                                                                
         CLI   PODRSW,YESQ         IF NOT A POD RUN                             
         BNE   NETUNT30            TREAT AS NON-POD                             
         TM    NBUNST2,NBUNPAFQ+NBUNLFAQ                                        
         BNZ   NETUNT30                                                         
         TM    NBUNITST,NBUNMGOQ                                                
         BNZ   NETUNT30                                                         
         GOTOR TSTOKA,NBACTDAT     TEST CAN RE-ALLOCATE                         
         BNE   NETUNT30            NO, TREAT AS NON-POD                         
                                                                                
         L     R1,NBAIO                                                         
         AHI   R1,NUDATA-NURECD                                                 
         USING NUOTH,R1                                                         
         SR    R0,R0                                                            
NETUNT28 CLI   NUOTEL,EOR          TEST END OF RECORD                           
         BE    NETUNT40                                                         
         CLI   NUOTEL,NUOTELQ      'OTHER' ELEMENT                              
         BNE   *+12                                                             
         CLI   NUOTTYP,NUOTPACQ                                                 
         BE    *+14                                                             
         IC    R0,NUOTLEN                                                       
         AR    R1,R0                                                            
         B     NETUNT28                                                         
         CLI   NUOTHER,C'N'        =PB=N = NON-PIGGABLE                         
         BNE   NETUNT40                                                         
         DROP  R1                                                               
                                                                                
NETUNT30 LH    RF,UNTSEQ           BUMP UNIT SEQUENCE NUMBER                    
         AHI   RF,1                                                             
         STH   RF,UNTSEQ                                                        
         GOTOR PUTUNT,WORK2        ADD TO UNIT BUFFER                           
         GOTOR PUTBUF,(R1)         ADD TO MAIN BUFFER                           
         B     NETUNT10                                                         
         EJECT                                                                  
***********************************************************************         
* Unit to be part of POD                                              *         
***********************************************************************         
                                                                                
NETUNT40 CLC   SVNBVAL1,NBACTDAT   COMPARE DATE,SQH,NET,PROG                    
         BNE   NETUNT44                                                         
         CLC   SVNBVAL2,NBACTEST   COMPARE EST,DPT                              
         BNE   NETUNT44                                                         
         CLI   SPLPOPTN,SPLPGPPQ   FOR PSEUDO PIG RUN                           
         BNE   NETUNT56            ALL UNITS ARE UNIQUE PODS                    
                                                                                
NETUNT44 CLI   PODRSW,YESQ         FOR POD RUNS                                 
         BNE   NETUNT54                                                         
                                                                                
***********************************************************************         
* Flush POD table                                                     *         
***********************************************************************         
                                                                                
         LARL  R6,PODTAB                                                        
         USING PDTABD,R6                                                        
NETUNT46 CLI   PDTABD,PDTEOTQ      TEST END OF TABLE                            
         BE    NETUNT52                                                         
                                                                                
B        USING UBUFFRD,PDTSVPD     UNIT RECORD AT PDTSVPD                       
         CLI   SPLPOPTN,SPLPGPPQ   IF DOING PSEUDO PIGS UNIT WILL NOT           
         BE    *+10                BE REWRITTEN AS POD                          
         XC    B.UBDA,B.UBDA       SO DON'T CLEAR DISK ADDRESS                  
         OI    B.UBSTAT2,UBSDPODQ  SET IS A DIVISIBLE POD                       
*                                  SET FULL POD TOTALS AND SUBLINES             
         LH    RF,NTARGETS         AFTER LAST TARGET                            
         SLL   RF,2                                                             
         LA    RF,B.UBTARGS(RF)                                                 
         MVC   B.UBPDLINS-B.UBPODD(,RF),PDTLINS                                 
         LA    RF,PDTLINS+L'UBPDLINS   POSITION IN SUBLINE LIST                 
         ST    RF,WORD                 SAVE FOR NEXT SUBPOD                     
         OI    B.UBSTAT2,UBSMSUBQ  SET MASTER SUB-POD                           
         LH    R3,PDTLEN           TOTAL SECONDS                                
         SR    R4,R4               FOR SECONDS USED SO FAR                      
         SR    R7,R7               FOR DOLLARS USED SO FAR                      
NETUNT48 LR    RF,R3                                                            
         CH    RF,PODSUBL          MAXIMUM SUB-POD SIZE                         
         BNH   *+8                                                              
         LH    RF,PODSUBL                                                       
         STC   RF,B.UBPDLEN                                                     
         STC   RF,B.UBUNLEN                                                     
         AR    R4,RF               BUMP SECONDS USED SO FAR                     
         LH    RF,UNTSEQ           SEQUENCE NUMBER                              
         AHI   RF,1                BUMP                                         
         STH   RF,UNTSEQ                                                        
         STCM  RF,3,B.UBSEQ                                                     
         L     R1,PDTTIME          GET SHARE OF COST                            
         MR    R0,R4               COST X TIME USED SO FAR                      
         LH    RF,PDTLEN                                                        
         MHI   RF,100              ROUND TO DOLLARS                             
         GOTOR DIVIDE              / TOTAL LENGTH                               
         SR    R1,R7               LESS DOLLARS USED SO FAR                     
         STCM  R1,15,B.UBCOST                                                   
         AR    R7,R1               CUME DOLLARS USED SO FAR                     
                                                                                
         GOTOR BU2PUT,B.UBUFFRD                                                 
                                                                                
         LH    RF,NTARGETS         FULL POD TOTALS AND SUBLINES                 
         SLL   RF,2                ARE ONLY FOR FIRST SUB-POD                   
         LA    RF,B.UBTARGS(RF)                                                 
         XC    0(L'UBPODD,RF),0(RF)                                             
         NI    B.UBSTAT2,FF-UBSMSUBQ                                            
         L     RE,WORD             POSITION IN SUBLINE LIST                     
         LA    R0,PDTLINSX         TEST AT END                                  
         CR    RE,R0                                                            
         BNL   NETUNT50                                                         
         MVC   B.UBPDLINS-B.UBPODD(,RF),0(RE)                                   
         AHI   RE,L'UBPDLINS                                                    
         ST    RE,WORD                                                          
NETUNT50 SH    R3,PODSUBL                                                       
         BP    NETUNT48                                                         
                                                                                
         MVI   NTUPODSW,NTUPFLSQ   SET POST TO PRODUCT TABLES                   
         LH    RF,PDTLEN                                                        
         STC   RF,B.UBPDLEN        RESET LENGTHS                                
         STC   RF,B.UBUNLEN                                                     
         MVC   HOLDDEM(HOLDDEML),PDTHDEM                                        
         MVC   FACTOR2,PDTTIME                                                  
         MVC   HALF,PDTLEN         EQUIV BASED ON TOTAL LENGTH                  
         GOTOR GETEDP                                                           
         GOTOR PUTBUF,B.UBUFFRD                                                 
         AHI   R6,PDTABL           NEXT ENTRY                                   
         B     NETUNT46                                                         
         DROP  B                                                                
                                                                                
NETUNT52 LARL  R6,PODTAB                                                        
         MVI   PDTABD,PDTEOTQ      CLEAR POD TABLE                              
                                                                                
NETUNT54 CLI   NBMODE,NBREQLST     TEST LAST FOR REQUEST                        
         BE    NETUNTX                                                          
                                                                                
         MVC   SVNBVAL1,NBACTDAT   SAVE DATE,SQH,NET,PROG                       
         MVC   SVNBVAL2,NBACTEST   SAVE EST,DPT                                 
                                                                                
***********************************************************************         
* Add unit to POD table                                               *         
***********************************************************************         
                                                                                
NETUNT56 L     RF,NBACTUAL         GET ACTUAL COST                              
         CLI   ASSGNOPT,YESQ                                                    
         BNE   *+8                                                              
         L     RF,NBASSIGN         OR ASSIGNED COST                             
                                                                                
         CLI   PODGOPTN,PODGOACT   TEST POD GROUPING USES ACTUAL                
         BNE   *+8                                                              
         L     RF,NBACTUAL                                                      
         CLI   PODGOPTN,PODGOASS   TEST POD GROUPING USES ASSIGNED              
         BNE   *+8                                                              
         L     RF,NBASSIGN                                                      
                                                                                
         LTR   RF,RF               SET CC BASED ON VALUE IN RF                  
                                                                                
         MVI   BYTE,0              ZERO                                         
         BZ    NETUNT58                                                         
         MVI   BYTE,C'+'           POSITIVE                                     
         BP    NETUNT58                                                         
         MVI   BYTE,C'-'           NEGATIVE                                     
                                                                                
NETUNT58 LARL  R6,PODTAB           LOCATE POD FOR THIS UNIT                     
NETUNT60 CLI   PDTABD,PDTEOTQ      TEST END OF POD TABLE                        
         BE    NETUNT62                                                         
                                                                                
         CLC   PDTCSW,BYTE         MATCH COST TYPE                              
         BNE   NETUNT66                                                         
         CLC   PDTPKG,NBPACK       MATCH PACKAGE                                
         BNE   NETUNT66                                                         
         CLC   PDTDMN,XDDEMOS      MATCH DEMO CODES                             
         BNE   NETUNT66                                                         
         LA    R0,PDTDEM                                                        
         LHI   R1,PDTDEML                                                       
         LA    RE,XDESTDEM                                                      
         LR    RF,R1                                                            
         CLCL  R0,RE               MATCH DEMO VALUES                            
         BNE   NETUNT66                                                         
         B     NETUNT64                                                         
                                                                                
NETUNT62 C     R6,APODTABX         CREATE NEW POD TABLE ENTRY                   
         BL    *+6                                                              
         DC    H'0'                TABLE FULL                                   
         LA    R0,PDTABD           CLEAR ENTRY                                  
         GOTOR CLEAR,PDTABL                                                     
                                                                                
         LA    R0,PDTDEM                                                        
         LHI   R1,PDTDEML                                                       
         LA    RE,XDESTDEM                                                      
         LR    RF,R1                                                            
         MVCL  R0,RE               DEMO VALUES                                  
         MVC   PDTDMN,XDDEMOS      DEMO CODES                                   
         MVC   PDTCSW,BYTE         COST SWITCH                                  
         MVC   PDTPKG,NBPACK       PACKAGE                                      
         MVI   NTUPODSW,NTUPBLDQ                                                
         GOTOR PUTUNT,PDTSVPD                                                   
         MVC   PDTHDEM,HOLDDEM     SAVE REFORMATTED DEMOS                       
         MVI   PDTABD+PDTABL,PDTEOTQ                                            
                                                                                
NETUNT64 L     RF,NBACTUAL         ADD TO POD TOTALS                            
         CLI   ASSGNOPT,YESQ                                                    
         BNE   *+8                                                              
         L     RF,NBASSIGN         OR ASSIGNED                                  
         CLI   INTGOPTN,YESQ       INCLUDE INTEGRATION?                         
         BNE   *+8                                                              
         A     RF,NBINTEG                                                       
         A     RF,PDTTIME                                                       
         ST    RF,PDTTIME          COST                                         
                                                                                
         LH    RF,PDTLEN                                                        
         SR    RE,RE                                                            
         IC    RE,NBLEN                                                         
         AR    RF,RE                                                            
         STH   RF,PDTLEN           SECONDS                                      
                                                                                
         LA    RE,PDTLINS          SET LINE NUMBERS                             
         LHI   R0,L'PDTLINS        FOR BCT                                      
         CLI   0(RE),0             GET FIRST EMPTY SLOT                         
         BE    *+14                                                             
         AHI   RE,L'NBACTSUB                                                    
         BCT   R0,*-12                                                          
         DC    H'0'                TOO MANY SUBLINES                            
                                                                                
         MVC   0(L'NBACTSUB,RE),NBACTSUB                                        
         B     NETUNT10                                                         
                                                                                
NETUNT66 AHI   R6,PDTABL           BUMP TO NEXT POD TABLE ENTRY                 
         B     NETUNT60                                                         
                                                                                
NETUNTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Put unit record to unit buffer                                      *         
*                                                                     *         
* Ntry:  R1=A(Where to build unit buffer entry)                       *         
***********************************************************************         
                                                                                
PUTUNT   NTR1  ,                                                                
         LR    R5,R1                                                            
         USING UBUFFRD,R5          R5=A(UNIT BUILD AREA)                        
         LA    R0,UBUFFRD                                                       
         LHI   R1,UBTOTLN                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         MVC   UBDPT(ALLDLL),ALLDL                                              
         TM    REQFLAG2,REQFSDPT   TEST SEPARATE DAYPARTS                       
         BZ    *+10                                                             
         MVC   UBDPT,NBACTDP                                                    
         TM    REQFLAG2,REQFSLEN   TEST SEPARATE UNIT LENGTHS                   
         BZ    *+10                                                             
         MVC   UBLEN,NBLEN                                                      
         CLI   PODRSW,YESQ         FOR POD RUN                                  
         BNE   *+8                                                              
         MVI   UBLEN,0             SET SECONDS LENGTH TO ZERO                   
         MVC   UBPDLEN,NBLEN       SET POD LENGTH                               
         MVC   UBUNLEN,NBLEN       AND UNALL LENGTH                             
         MVC   UBDA,NBKEY+(NUDA-NURECD)                                         
         MVC   UBNET,NBACTNET                                                   
         MVC   UBEST,NBACTEST                                                   
         MVC   UBDATE,NBACTDAT                                                  
                                                                                
         LA    RF,CROTOPTN         ROTATION OPTION FOR CABLE                    
         CLI   NBSTATYP,NBSTCABQ                                                
         BE    PUTUNT02                                                         
         LA    RF,SROTOPTN         SYNDICATION                                  
         CLI   NBSTATYP,NBSTSYNQ                                                
         BE    PUTUNT02                                                         
         LA    RF,OROTOPTN         OTHER                                        
         CLI   NBSTATYP,NBSTOTHQ                                                
         BE    PUTUNT02                                                         
         LA    RF,NROTOPTN         ELSE NETWORK                                 
PUTUNT02 CLI   0(RF),YESQ                                                       
         BNE   PUTUNT04                                                         
         MVC   UBDAY,NBSDROT       USE ROTATOR                                  
         CLI   UBDAY,0             IF PRESENT                                   
         BNE   PUTUNT06                                                         
                                                                                
PUTUNT04 MVC   UBDAY,NBDAY         ELSE USE REGULAR DAY FIELD                   
                                                                                
PUTUNT06 MVC   UBSTIM,NBTIME                                                    
         MVC   UBSEQ,UNTSEQ                                                     
         GOTOR UNTENV,UBUFFRD      SET ENVIRONMENT TABLES                       
         MVC   UBCOST,FACTOR1                                                   
                                                                                
         XC    HOLDDEM(HOLDDEML),HOLDDEM MOVE DEMOS TO HOLDDEM TO ALLOW         
         LA    R1,HOLDDEM          FOR PARALLEL OF NETBUY CODE                  
         LA    RE,XDESTDEM                                                      
         LA    RF,XDDEMLST                                                      
         LHI   R0,PTZDEMMX                                                      
PUTUNT08 OC    0(L'XDDEMLST,RF),0(RF)                                           
         BZ    PUTUNT10                                                         
         MVC   2(2,R1),2(RE)       SET AS RATING                                
         CLI   1(RF),RATINGQ                                                    
         BE    *+10                                                             
         MVC   0(L'HOLDDEM,R1),4(RE)                                            
         AHI   R1,L'HOLDDEM                                                     
         AHI   RE,8                                                             
         AHI   RF,L'XDDEMLST                                                    
         BCT   R0,PUTUNT08                                                      
                                                                                
PUTUNT10 MVC   UBCDEM,HOLDDEM      CORPORATE DEMO                               
         TM    REQFLAG1,REQFTRGS   SET TARGETS                                  
         BZ    PUTUNT16                                                         
         LA    R1,HOLDDEM+L'HOLDDEM                                             
         LA    RE,ACTDEMS+1                                                     
         LHI   R0,PTZDEMMX                                                      
PUTUNT12 SR    RF,RF                                                            
         ICM   RF,1,0(RE)          TEST DEMO IS AN ACTIVE TARGET                
         BZ    PUTUNT14                                                         
         SLL   RF,2                                                             
         LA    RF,UBTARGS-L'UBTARGS(RF)                                         
         MVC   0(L'UBTARGS,RF),0(R1)                                            
PUTUNT14 AHI   R1,L'HOLDDEM                                                     
         AHI   RE,1                                                             
         BCT   R0,PUTUNT12                                                      
                                                                                
PUTUNT16 GOTOR GETWKN,UBDATE       FIND WEEK                                    
         STC   RF,UBWEEK                                                        
                                                                                
         GOTOR TSTOKA,UBDATE       TEST OK TO ALLOCATE                          
         BE    PUTUNT20                                                         
         OI    UBSTAT2,UBSPRALQ    SET PRE-ALLOCATED                            
         MVC   UBPRD1,UNTPRD1                                                   
         MVC   UBLEN1,UNTLEN1                                                   
         MVC   UBPRD2,UNTPRD2                                                   
         MVC   UBLEN2,UNTLEN2                                                   
         MVI   UBUNLEN,0           NO UNALLOCATED LENGTH                        
                                                                                
PUTUNT20 OI    MKTBUYGL,MKTBHBUY   SET HAVE BUY                                 
         CLI   NTUPODSW,NTUPBLDQ   TEST JUST BUILDING POD DESC                  
         BE    PUTUNTX             YES - RETURN TO POD TABLE BUILD              
                                                                                
         GOTOR BU2PUT,UBUFFRD                                                   
                                                                                
         CLI   PODRSW,YESQ         SKIP IF NOT A POD RUN                        
         BNE   PUTUNTX                                                          
         CLC   UBPDLEN,PODLEN      SKIP IF HAVE EQUIV BASE                      
         BE    PUTUNTX                                                          
         MVI   HALF,0                                                           
         MVC   HALF+L'HALF-L'UBPDLEN(L'UBPDLEN),UBPDLEN                         
         GOTOR GETEDP                                                           
                                                                                
PUTUNTX  J     EXIT                                                             
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
* Put records to main buffer                                          *         
***********************************************************************         
                                                                                
PUTBUF   NTR1  ,                                                                
         LR    R5,R1                                                            
         USING UBUFFRD,R5          R5=A(UNIT BUILD AREA)                        
         SR    R4,R4               ADD TO BUFFER                                
         IC    R4,UBWEEK           POINT R4 TO WEEK SLOT                        
         SLL   R4,2                                                             
         LA    R4,GBWKS-L'GBWKS(R4)                                             
         XC    GBUFFR(GBUFFRL),GBUFFR                                           
         MVC   GBDPT(L'GBDPT+L'GBLEN),UBDPT                                     
         TM    REQFLAG2,REQFSDPT   TEST SEPARATE DAYPARTS                       
         BNZ   *+8                                                              
         MVI   GBDPT,ALLDPT        NO - SET 'ALL'                               
         TM    REQFLAG2,REQFSLEN   TEST IF ALL LENGTHS TOGETHER                 
         BNZ   *+8                                                              
         MVI   GBLEN,ALLLEN        NO - USE 'ALL'                               
         MVI   GBTYP,TGOLDEMQ      DEMO SUPPLY                                  
         MVC   GBTOT,HOLDDEM                                                    
         MVC   0(L'GBWKS,R4),HOLDDEM  SET DEMO FOR WEEK                         
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
         MVI   GBTYP,TGOLUNTQ      UNITS                                        
         LHI   R0,10               COUNT UNITS (0.0)                            
         CLI   PODRSW,YESQ         UNLESS POD RUN                               
         BNE   PUTBUF02                                                         
         IC    R0,UBPDLEN          THEN COUNT SECONDS                           
         CLI   NTUPODSW,NTUPFLSQ   BUT IF DOING POD FLUSH                       
         BNE   PUTBUF02                                                         
         LH    R0,PDTLEN           USE WHOLE POD LENGTH                         
                                                                                
PUTBUF02 STCM  R0,15,GBTOT                                                      
         ST    R0,0(R4)                                                         
         GOTOR BU1PUT                                                           
                                                                                
         TM    REQFLAG1,REQFTRGS   SET TARGET SUPPLIES                          
         BZ    PUTBUF08                                                         
         LA    R3,HOLDDEM+L'HOLDDEM                                             
         LHI   R7,1                                                             
                                                                                
PUTBUF04 SR    RE,RE                                                            
         IC    RE,ACTDEMS(R7)                                                   
         LTR   RE,RE                                                            
         BZ    PUTBUF06                                                         
         AHI   RE,TACHT00Q                                                      
         STC   RE,GBTYP            RECORD CODE                                  
         MVC   GBTOT,0(R3)         TOTAL                                        
         MVC   0(L'GBWKS,R4),0(R3) WEEK POSITION                                
         GOTOR BU1PUT                                                           
                                                                                
PUTBUF06 AHI   R3,L'HOLDDEM        NEXT DEMO                                    
         AHI   R7,1                                                             
         CHI   R7,PTZDEMMX                                                      
         BL    PUTBUF04                                                         
                                                                                
PUTBUF08 CLI   NTUPODSW,NTUPFLSQ   NO PRE-ALLOCATED TEST IF                     
         BE    PUTBUF18            FLUSHING POD TABLE                           
         GOTOR TSTOKA,UBDATE       TEST PRE-ALLOCATED                           
         BE    PUTBUF18            NO                                           
                                                                                
         MVI   PUTPASS,1           SET DOING FIRST PASS                         
         OC    UNTPRD1,UNTPRD1                                                  
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   PREPRD,UNTPRD1      DO FIRST PRODUCT                             
         MVC   PRELEN,UNTLEN1                                                   
                                                                                
PUTBUF10 MVC   GBPRD,PREPRD        SET PRODUCT                                  
         GOTOR LOCPRD,GBPRD        SET PRODUCT CLASS                            
         MVC   PRECLASS,PTCLASS-PTBUFFD(R1)                                     
         MVC   GBLEN,PRELEN        FOR PRE-ALLOCS USE REAL LENGTH               
         TM    REQFLAG2,REQFSLEN   UNLESS ALL LENGTHS TOGETHER                  
         BNZ   *+8                                                              
         MVI   GBLEN,ALLLEN                                                     
         MVC   GBCLASS,PRECLASS                                                 
         MVI   GBTYP,TPREUNTQ      PRE-ALLOCATED UNITS                          
         LHI   R0,10               COUNT UNITS (0.0)                            
         CLI   PODRSW,YESQ         UNLESS POD RUN                               
         BNE   *+8                                                              
         IC    R0,PRELEN           THEN COUNT SECONDS                           
         STCM  R0,15,GBTOT                                                      
         ST    R0,0(R4)                                                         
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
         MVC   GBPRD,TOTPRD        TOTALS                                       
         MVI   GBCLASS,0                                                        
         GOTOR BU1PUT                                                           
                                                                                
         MVI   GBTYP,TPREDEMQ      DEMO PRE-ALLOCATED                           
         MVC   GBTOT,HOLDDEM                                                    
         MVC   0(L'GBWKS,R4),HOLDDEM                                            
         MVC   GBPRD,PREPRD                                                     
         MVC   GBCLASS,PRECLASS                                                 
         GOTOR BU1PUT                                                           
                                                                                
         MVC   GBPRD,TOTPRD                                                     
         MVI   GBCLASS,0                                                        
         GOTOR BU1PUT                                                           
                                                                                
         TM    REQFLAG1,REQFTRGS   SET TARGETS                                  
         BZ    PUTBUF16                                                         
         LA    R3,HOLDDEM+L'HOLDDEM                                             
         LHI   R7,1                                                             
                                                                                
PUTBUF12 LA    RE,ACTDEMS(R7)                                                   
         CLI   0(RE),0             TEST DEMO AN ACTIVE TARGET                   
         BE    PUTBUF14                                                         
         SR    RE,RE                                                            
         IC    RE,ACTDEMS(R7)                                                   
         AHI   RE,TPRET00Q                                                      
         STC   RE,GBTYP            RECORD CODE                                  
         MVC   GBPRD,PREPRD                                                     
         MVC   GBCLASS,PRECLASS                                                 
         MVC   GBTOT,0(R3)         TOTAL                                        
         MVC   0(L'GBWKS,R4),0(R3) WEEK POSITION                                
         GOTOR BU1PUT                                                           
                                                                                
         MVC   GBPRD,TOTPRD                                                     
         MVI   GBCLASS,0                                                        
         GOTOR BU1PUT                                                           
                                                                                
PUTBUF14 AHI   R3,L'HOLDDEM        NEXT DEMO                                    
         AHI   R7,1                                                             
         CHI   R7,PTZDEMMX                                                      
         BL    PUTBUF12                                                         
                                                                                
PUTBUF16 OC    UNTPRD2,UNTPRD2     IS THERE A SECOND PRODUCT TO DO              
         BZ    PUTBUF18                                                         
         CLI   PUTPASS,2           HAVE WE ALREADY DONE IT                      
         BE    PUTBUF18                                                         
         MVI   PUTPASS,2           DO SECOND PRODUCT                            
         MVC   PREPRD,UNTPRD2                                                   
         MVC   PRELEN,UNTLEN2                                                   
         B     PUTBUF10                                                         
                                                                                
PUTBUF18 MVC   GBDPT(L'GBDPT+L'GBLEN),UBDPT                                     
         TM    REQFLAG2,REQFSDPT   TEST SEPARATE DAYPARTS                       
         BNZ   *+8                                                              
         MVI   GBDPT,ALLDPT        NO - SET 'ALL'                               
         TM    REQFLAG2,REQFSLEN   TEST LENGTHS TOGETHER                        
         BNZ   *+8                                                              
         MVI   GBLEN,ALLLEN        NO - USE 'ALL'                               
         MVC   GBPRD,SUPPRD                                                     
         MVI   GBCLASS,0                                                        
         MVI   GBTYP,TGOLDOLQ      DOLLARS SUPPLY                               
         MVC   GBTOT,FACTOR2                                                    
         MVC   0(L'GBWKS,R4),FACTOR2                                            
         GOTOR BU1PUT                                                           
                                                                                
         CLI   NTUPODSW,NTUPFLSQ   NO PRE-ALLOCATED TEST IF                     
         BE    PUTBUFX             FLUSHING POD TABLE                           
         GOTOR TSTOKA,UBDATE       TEST PRE-ALLOCATED                           
         BE    PUTBUFX                                                          
         OC    UNTPRD1,UNTPRD1                                                  
         BZ    PUTBUFX                                                          
                                                                                
         MVC   GBTOT,FACTOR1       USE DOLLAR VALUES FOR PRE-ALLOCATED          
         MVC   0(L'GBWKS,R4),FACTOR1                                            
                                                                                
         MVI   PUTPASS,1           SET DOING FIRST PASS                         
         MVC   PREPRD,UNTPRD1      DO FIRST PRODUCT                             
         MVC   PRELEN,UNTLEN1                                                   
                                                                                
PUTBUF20 GOTOR LOCPRD,PREPRD       SET PRODUCT CLASS                            
         MVC   PRECLASS,PTCLASS-PTBUFFD(R1)                                     
         MVC   GBLEN,PRELEN        USE ACTUAL LENGTH                            
         TM    REQFLAG2,REQFSLEN   UNLESS LENGTHS TOGETHER                      
         BNZ   *+8                                                              
         MVI   GBLEN,ALLLEN                                                     
         MVI   GBTYP,TPREDOLQ      DOLLARS PRE-ALLOCATED                        
         MVC   GBPRD,PREPRD                                                     
         MVC   GBCLASS,PRECLASS                                                 
         OC    UNTPRD2,UNTPRD2     IS THERE IS A SECOND PRODUCT                 
         BZ    PUTBUF22            NO, SUPPLY IS SET AND IS OK                  
         L     R1,FACTOR1          ELSE, MUST SPLIT THE DOLLARS                 
         SR    R0,R0                                                            
         ICM   R0,3,UNTP1SHR       USE BRAND 1 SHARE                            
         CLI   PUTPASS,1                                                        
         BE    *+10                                                             
         SHI   R0,10000            OR ITS COMPLEMENT                            
         LCR   R0,R0               FOR BRAND 2                                  
         MR    R0,R0                                                            
         LHI   RF,10000                                                         
         GOTOR DIVIDE                                                           
         STCM  R1,15,GBTOT                                                      
         STCM  R1,15,0(R4)                                                      
                                                                                
PUTBUF22 GOTOR BU1PUT                                                           
                                                                                
         MVC   GBPRD,TOTPRD                                                     
         MVI   GBCLASS,0                                                        
         GOTOR BU1PUT                                                           
                                                                                
         OC    UNTPRD2,UNTPRD2     IS THERE A SECOND PRODUCT TO DO              
         BZ    PUTBUFX             NO                                           
         CLI   PUTPASS,2           HAVE WE ALREADY DONE IT                      
         BE    PUTBUFX                                                          
         MVI   PUTPASS,2           DO SECOND PRODUCT                            
         MVC   PREPRD,UNTPRD2                                                   
         MVC   PRELEN,UNTLEN2                                                   
         B     PUTBUF20                                                         
                                                                                
PUTBUFX  J     EXIT                                                             
         DROP  R5,R6,R8                                                         
         EJECT                                                                  
***********************************************************************         
* Set unit in environment tables                                      *         
***********************************************************************         
                                                                                
UNTENV   NTR1  ,                                                                
         LR    R2,R1                                                            
         USING UBUFFRD,R2                                                       
         LA    R3,WORK                                                          
         USING ENVTABD,R3                                                       
                                                                                
         L     RF,ANETBLK                                                       
         USING NETBLKD,RF                                                       
         XC    ENVTABD(ENVS1LEN),ENVTABD                                        
         MVC   ENVS1NET,UBNET                                                   
         MVC   ENVS1DAY,UBDAY                                                   
         MVC   ENVS1TIM,NBTIME                                                  
         OC    ENVS1END,ENVS1END   IF ONLY ONE TIME                             
         BNZ   *+10                                                             
         MVC   ENVS1END,ENVS1STR   SET END = START                              
         MVC   ENVS1PGM,NBPROGNM                                                
         OC    ENVS1PGM,SPACES     REMOVE BINARY ZEROES                         
         MVC   ENVS1PGC,NBACTPRG   SET PROGRAM CODE                             
         CLI   RPRGOPTN,YESQ       UNLESS PROGRAM TYPE SUPRESSED                
         BNE   UNTENV02                                                         
         MVC   ENVS1TYP(L'NBPRFILT),NBPRFILT                                    
         DROP  RF                                                               
                                                                                
UNTENV02 GOTOR GETENV,DMCB,AENV1SET,ENVS1KLN,ENVS1LEN,ENVS1MAX,UBENV1           
                                                                                
         XC    ENVTABD(ENVS2LEN),ENVTABD                                        
         MVC   ENVS2NET,UBNET                                                   
         GOTOR GETENV,DMCB,AENV2SET,ENVS2KLN,ENVS2LEN,ENVS2MAX,UBENV2           
                                                                                
         XC    ENVTABD(ENVS3LEN),ENVTABD                                        
         MVC   ENVS3DAY,UBDAY                                                   
         GOTOR GETENV,DMCB,AENV3SET,ENVS3KLN,ENVS3LEN,ENVS3MAX,UBENV3           
                                                                                
UNTENVX  J     EXIT                                                             
                                                                                
GETENV   STM   RE,R0,12(RD)                                                     
                                                                                
         LM    RE,RF,0(R1)                                                      
         L     RE,ENVSATAB-ENVSETD(RE)                                          
         BCTR  RF,0                RF=L'KEY-1                                   
NEW      USING ENVTABD,RE          RF=A(TABLE)                                  
         LHI   R0,1                R0=COUNTER                                   
                                                                                
GETENV02 EX    RF,*+8              TEST KEY MATCHES                             
         BE    GETENV04                                                         
         CLC   NEW.ENVTABD(0),ENVTABD                                           
         CLI   NEW.ENVTABD,ENVSEOTQ                                             
         BE    *+16                                                             
         A     RE,8(R1)            BUMP TO NEXT ENTRY                           
         AHI   R0,1                BUMP COUNTER                                 
         B     GETENV02                                                         
                                                                                
         C     R0,12(R1)           TEST TABLE SIZE EXCEEDED                     
         BNH   *+6                                                              
         DC    H'0'                                                             
         L     RF,8(R1)            RF=L'ENTRY                                   
         EX    RF,*+8              MOVE NEW ENTRY IN                            
         B     *+10                                                             
         MVC   NEW.ENVTABD(0),ENVTABD                                           
         LA    RF,NEW.ENVTABD(RF)                                               
         MVI   0(RF),ENVSEOTQ                                                   
                                                                                
GETENV04 L     RE,16(R1)                                                        
         STH   R0,0(RE)            SET ENVIRONMENT COUNTER                      
                                                                                
GETENVX  LM    RE,R0,12(RD)                                                     
         BR    RE                                                               
         DROP  NEW                                                              
         EJECT                                                                  
***********************************************************************         
* Test OK to allocate this unit                                       *         
***********************************************************************         
                                                                                
         USING NETBLKD,R8                                                       
TSTOKA   TM    NBUNST2,NBUNPAFQ    TEST PRODUCT ALLOCATION FROZEN               
         BNZ   TSTOKAN                                                          
         OC    UNTPRD1,UNTPRD1     TEST ALLOCATED                               
         BZ    TSTOKAY                                                          
         CLI   QOPT4,YESQ          IF TEST RUN-SKIP BILL/PAY TEST               
         BE    *+14                                                             
         OC    NBBILTGR(NBPAYSPC-NBBILTGR),NBBILTGR                             
         BNZ   TSTOKAN                                                          
         CLC   0(L'REALLSDT,R1),REALLSDT                                        
         BL    TSTOKAN                                                          
TSTOKAY  CR    RE,RE               OK TO RE-ALLOCATE                            
         BR    RE                                                               
TSTOKAN  LTR   RE,RE               NOT OK TO REALLOCATE                         
         BR    RE                                                               
         DROP  R8                                                               
                                                                                
***********************************************************************         
* Get equivalent demos for PODs                                       *         
***********************************************************************         
                                                                                
GETEDP   NTR1  ,                                                                
         LA    R3,HOLDDEM                                                       
         LHI   R2,PTZDEMMX                                                      
         LH    RF,PODEQU                                                        
GETEDP02 L     R1,0(R3)                                                         
         LH    RE,HALF                                                          
         MR    R0,RE                                                            
         GOTOR DIVIDE                                                           
         ST    R1,0(R3)                                                         
         AHI   R3,L'HOLDDEM                                                     
         BCT   R2,GETEDP02                                                      
GETEDPX  J     EXIT                                                             
         DROP  R2,R3,RB                                                         
                                                                                
         LTORG                                                                  
         DS    0H                                                               
DMGRWORK DS    XL96                DATAMGR WORK AREA                            
         EJECT                                                                  
***********************************************************************         
* Weekly goal balancing                                               *         
***********************************************************************         
                                                                                
RSCALE   NMOD1 0,**RSCALE                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     RF,ATOTROW                                                       
         USING TABD,RF                                                          
         OC    TRSCGOL,TRSCGOL     TEST ANY GOALS TO BALANCE                    
         BZ    RSCALEX                                                          
         MVI   EXCSW,NOQ                                                        
         LH    RF,NWKS                                                          
         AHI   RF,1                                                             
         STH   RF,NWKSP1                                                        
         LH    RF,ROWLEN                                                        
         MH    RF,NPRDS                                                         
         A     RF,AFSTBRD                                                       
         ST    RF,AEXCROW          A(ROW FOR EXCESS SUPPLY)                     
         L     RE,ATOTROW                                                       
         MVC   TABKEY(TABKEYL),TABKEY-TABD(RE)                                  
         MVC   TABPRD,UNAPRD       UNALLOCATED PRODUCT                          
         CLI   PODRSW,YESQ         IF POD RUN                                   
         BNE   *+10                                                             
         MVC   TABLEN,PODLEN                                                    
         DROP  RF                                                               
                                                                                
***********************************************************************         
* Find any weeks with no goals and either subtract their supply from  *         
* total or set proportioned campaign goals for that week or use prior *         
* week's goal or set error and exit                                   *         
***********************************************************************         
                                                                                
         MVI   ZERWKSW,0                                                        
         LH    R3,NWKS             FOR BCT                                      
         L     R4,ASUPROW          POINT TO SUPPLY ROW                          
SUPTOT   USING TABD,R4                                                          
         LA    R5,SUPTOT.TABD                                                   
         AH    R5,CELLWID          WEEK 1                                       
SUPWKT   USING TABD,R5                                                          
         L     R7,ATOTROW          POINT TO TOTAL ROW                           
         AH    R7,CELLWID          WEEK 1                                       
TOTWKT   USING TABD,R7                                                          
                                                                                
RSCALE02 OC    TOTWKT.TRSCGOL,TOTWKT.TRSCGOL                                    
         BNZ   RSCALE16            YES - NEXT WEEK                              
         CLI   DSSW,DSSCURQ        IF DOING DAYPART RESCALING                   
         BE    RSCALE04            SPECIAL WEEK OPTIONS DO NOT APPLY            
         CLI   ZERWKOPT,ZERWZERQ   OPTION TO USE ZERO GOAL WEEKS                
         BE    RSCALE08                                                         
         CLI   ZERWKOPT,ZERWPRVQ   OPTION TO USE PRIOR WEEKS GOAL               
         BE    RSCALE10                                                         
         CLI   ZERWKOPT,ZERWERRQ   ERROR OPTION                                 
         BNE   RSCALE04                                                         
         OC    SUPWKT.TRSCGOL,SUPWKT.TRSCGOL                                    
         BZ    RSCALE16                                                         
         MVI   ZERWKSW,1           SET ERROR IF ANY SUPPLY                      
         B     RSCALEX                                                          
                                                                                
RSCALE04 L     RF,SUPTOT.TRSCGOL   SUBTRACT SUPPLY FROM TOTAL                   
         S     RF,SUPWKT.TRSCGOL                                                
         ST    RF,SUPTOT.TRSCGOL                                                
         B     RSCALE16                                                         
                                                                                
RSCALE08 L     R8,ATOTROW          USE CAMPAIGN GOALS                           
         B     RSCALE12                                                         
RSCALE10 LR    R8,R7               USE PRIOR WEEKS GOALS                        
         SH    R8,CELLWID          NB-FIRST WEEK GOES TO CAMP TOTAL             
                                                                                
TOTBAS   USING TABD,R8             SET TO CAMPAIGN/PREV WK GOALS                
RSCALE12 OC    SUPWKT.TRSCGOL,SUPWKT.TRSCGOL                                    
         BZ    RSCALE16            SKIP IF NO SUPPLY                            
         L     R1,SUPWKT.TRSCGOL                                                
         M     R0,FW100000                                                      
         L     RF,TOTBAS.TRSCGOL                                                
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1          = SUPPLY/OTHER GOAL                          
         L     R6,ATOTROW                                                       
TOTALS   USING TABD,R6                                                          
         LR    R2,R7                                                            
CURWKT   USING TABD,R2                                                          
RSCALE14 L     R1,TOTBAS.TRSCGOL                                                
         M     R0,FACTOR1                                                       
         L     RF,FW100000                                                      
         GOTOR DIVIDE                                                           
         ST    R1,CURWKT.TRSCGOL                                                
         A     R1,TOTALS.TRSCGOL   ADD INTO TOTAL COLUMN                        
         ST    R1,TOTALS.TRSCGOL                                                
         AH    R6,ROWLEN           NEXT PRODUCT                                 
         AH    R2,ROWLEN                                                        
         AH    R8,ROWLEN                                                        
         CLI   TOTALS.TABKEY,0     TEST END OF PRODUCTS                         
         BNE   RSCALE14                                                         
RSCALE16 AH    R5,CELLWID          BUMP TO NEXT WEEK                            
         AH    R7,CELLWID                                                       
         BCT   R3,RSCALE02                                                      
                                                                                
***********************************************************************         
* Set orig goals at +4 for later comparison +16 for printing          *         
* if EXCSOPT=N create excess row with leftover for week and           *         
* then treat as a regular brand                                       *         
***********************************************************************         
                                                                                
RSCALE18 LH    R6,NWKSP1                                                        
         SR    R2,R2               START AT TOTAL COLUMN                        
RSCALE20 L     R3,ATOTROW                                                       
         USING TABD,R3                                                          
         L     RF,TRSCGOL(R2)                                                   
         ST    RF,TPREDEM(R2)      ORIGINAL GOAL                                
         ST    RF,TSAVDEM(R2)      SET IN WORK GOAL                             
                                                                                
         L     R3,AFSTBRD                                                       
         XC    RSREGTOT(L'RSREGTOT+L'RSPRITOT),RSREGTOT                         
RSCALE22 L     RF,TRSCGOL(R2)      ORIG GOAL                                    
         ST    RF,TPREDEM(R2)      SET IN WORK GOAL                             
         ST    RF,TSAVDEM(R2)      SAVE FOR REPORT                              
         LA    RE,RSREGTOT         POST TO REGULAR BAND TOTAL                   
         CLI   TABPRI,YESQ                                                      
         BNE   *+8                                                              
         LA    RE,RSPRITOT         OR PRIORITY BRAND TOTAL                      
         A     RF,0(RE)                                                         
         ST    RF,0(RE)                                                         
         AH    R3,ROWLEN           NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   RSCALE22                                                         
                                                                                
         L     R5,ASUPROW          SAVING EXCESS                                
SAVEXC   USING TABD,R5                                                          
         L     RF,SAVEXC.TRSCGOL(R2) SUPPLY                                     
         ST    RF,SAVEXC.TSAVDEM(R2) SAVE                                       
         L     RE,RSREGTOT                                                      
         A     RE,RSPRITOT         RE = TOTAL GOAL                              
         CR    RF,RE               TEST ANY EXCESS                              
         BNH   RSCALE26            NO                                           
         CLI   EXCSOPT,YESQ        IF NOT ALLOCATING EXCESS                     
         BNE   RSCALE24                                                         
         OC    RSREGTOT,RSREGTOT   OR IF ALL BRANDS ARE PRIORITY                
         BNZ   RSCALE26            (OR THERE ARE NO BRANDS)                     
RSCALE24 MVI   EXCSW,YESQ                                                       
         L     R5,AEXCROW                                                       
         SR    RF,RE                                                            
         LH    RE,NPRDS            BUT AVOID CREATING EXCESS ROW                
         AHI   RE,1                OUT OF ROUNDING ERRORS                       
         CR    RF,RE               MUST BE MORE THAN 1 PER PRODUCT              
         BNH   RSCALE26                                                         
         ST    RF,SAVEXC.TRSCGOL(R2) SET LEFTOVER IN EXCESS ROW                 
         ST    RF,SAVEXC.TPREDEM(R2)                                            
         ST    RF,SAVEXC.TSAVDEM(R2)                                            
         OC    RSREGTOT,RSREGTOT                                                
         BNZ   RSCALE26                                                         
         LA    RF,SAVEXC.TPREDOL(R2)                                            
         MVI   0(RF),FF            SET HAVE ONLY PRI BRANDS FOR WEEK            
                                                                                
RSCALE26 AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R6,RSCALE20                                                      
         CLI   EXCSW,YESQ          ADD FOR TOTAL OF WEEKLY EXCESSES             
         BNE   RSCALE36                                                         
         L     R3,AEXCROW                                                       
         LH    R0,NWKS                                                          
         LH    R2,CELLWID                                                       
         SR    RF,RF                                                            
         A     RF,TRSCGOL(R2)                                                   
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R0,*-8                                                           
         C     RF,TRSCGOL          TEST SUM OF WEEKS VS ACTUAL TOTAL            
         BH    RSCALE30                                                         
         ST    RF,TRSCGOL          SET TOTAL EXCESS                             
         ST    RF,TPREDEM          SET IN WORK GOAL                             
         B     RSCALE36                                                         
                                                                                
***********************************************************************         
* Here if we have mixture of excess and non-excess weeks              *         
***********************************************************************         
                                                                                
RSCALE30 CLI   EXCSOPT,YESQ        DON'T RESCALE IF ALLOCATING EXCESS           
         BE    RSCALE36                                                         
         L     R3,AEXCROW                                                       
         L     R1,TRSCGOL          ACTUAL TOTAL EXCESS                          
         M     R0,FW10000                                                       
         GOTOR DIVIDE              / SUM OF WEEKS WITH EXCESS                   
         ST    R1,FACTOR1                                                       
         L     RF,FW10000                                                       
         LH    R6,NWKS                                                          
         LH    R2,CELLWID                                                       
RSCALE32 LA    R7,TPREDOL(R2)      DON'T RESCALE                                
         CLI   0(R7),FF            IF PRI ONLY WEEK                             
         BE    RSCALE34                                                         
         L     R1,TRSCGOL(R2)                                                   
         LTR   R1,R1                                                            
         BNP   RSCALE34                                                         
         M     R0,FACTOR1                                                       
         GOTOR DIVIDE                                                           
         LTR   R1,R1               DON'T REDUCE TO ZERO                         
         BP    *+8                                                              
         LHI   R1,1                                                             
         ST    R1,TRSCGOL(R2)                                                   
         ST    R1,TPREDEM(R2)                                                   
         ST    R1,TSAVDEM(R2)                                                   
RSCALE34 MVI   0(R7),0                                                          
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R6,RSCALE32                                                      
RSCALE36 SR    R2,R2               RESCALE TOTAL COLUMN                         
         GOTOR RSVERT                                                           
         L     R3,AFSTBRD          SET RESCALED GOAL IN TABGOAL                 
RSCALE38 MVC   TABGOAL,TPREDEM                                                  
         AH    R3,ROWLEN                                                        
         C     R3,AEXCROW                                                       
         BNH   RSCALE38                                                         
         GOTOR RSPRNT              PRINT RESCALING WORKSHEET                    
                                                                                
         MVI   RSLCNT,0            RESCALING LOOP                               
RSCALE40 LH    R2,CELLWID          START AT WEEK 1                              
         LH    R0,NWKS             FOR BCT                                      
         GOTOR RSVERT              DO VERTICLE RESCALE                          
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R0,*-8                                                           
                                                                                
***********************************************************************         
* Now add across for total and compare to last results                *         
***********************************************************************         
                                                                                
         L     R3,AFSTBRD                                                       
         MVI   RSCHGSW,NOQ         SET NO CHANGE                                
RSCALE44 LH    R2,CELLWID          START AT WEEK 1                              
         LH    R0,NWKS                                                          
         SR    RF,RF                                                            
         A     RF,TPREDEM(R2)                                                   
         AH    R2,CELLWID                                                       
         BCT   R0,*-8                                                           
         LR    RE,RF                                                            
         S     RE,TPREDEM                                                       
         LPR   RE,RE                                                            
         C     RE,FW1                                                           
         BNH   *+8                                                              
         MVI   RSCHGSW,YESQ        SET HAVE CHANGE                              
         MVC   TPREDOL,TPREDEM     SAVE OLD RESULT                              
         ST    RF,TPREDEM          SET NEW WORK GOAL                            
         AH    R3,ROWLEN           NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   RSCALE44                                                         
         CLI   RSWKOPT,RSWKNOQ     IF NO WEEKLY BALANCING THEN DONE             
         BE    RSCALE52                                                         
         CLI   RSCHGSW,NOQ         OR IF NO CHANGE                              
         BE    RSCALE52                                                         
         SR    RF,RF                                                            
         IC    RF,RSLCNT           OR IF TOO MANY TIMES AROUND LOOP             
         CHI   RF,RLOOPMAX                                                      
         BE    RSCALE52                                                         
         AHI   RF,1                                                             
         STC   RF,RSLCNT                                                        
         GOTOR RSPRNT              PRINT RESCALING WORKSHEET                    
                                                                                
***********************************************************************         
* Now rescale horizontally and try again                              *         
***********************************************************************         
                                                                                
         L     R3,AFSTBRD                                                       
RSCALE46 ICM   R1,15,TABGOAL       ORIGINAL GOALS (BUT ONCE RESCALED)           
         M     R0,FW10000                                                       
         BZ    RSCALE50                                                         
         L     RF,TPREDEM          / CURRENT WORK GOAL                          
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1          = RESCALE FACTOR                             
         C     R1,FW10000          SKIP IF NO CHANGE                            
         BE    RSCALE50                                                         
         LH    R2,CELLWID          START AT WEEK 1                              
         LH    R7,NWKS                                                          
RSCALE48 L     R1,TPREDEM(R2)                                                   
         ST    R1,TPREDOL(R2)      SAVE CURRENT FOR LATER COMPARE               
         M     R0,FACTOR1                                                       
         L     RF,FW10000                                                       
         GOTOR DIVIDE                                                           
         C     R1,TMINRES(R2)      TST VS MINIMUN                               
         BNL   *+8                                                              
         L     R1,TMINRES(R2)                                                   
         ST    R1,TPREDEM(R2)      SET NEW WORK GOAL                            
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R7,RSCALE48                                                      
RSCALE50 AH    R3,ROWLEN           NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   RSCALE46                                                         
         B     RSCALE40            TAKE IT FROM THE TOP                         
                                                                                
***********************************************************************         
* Ensure no brands are 'balanced' out of existance                    *         
***********************************************************************         
                                                                                
RSCALE52 L     R3,AFSTBRD                                                       
RSCALE54 SR    R2,R2               START AT TOTAL COLUMN                        
         LH    R7,NWKSP1                                                        
RSCALE56 L     RF,TRSCGOL(R2)      TEST ANY ORIG GOAL                           
         LTR   RF,RF                                                            
         BZ    RSCALE58            NO - IGNORE                                  
         L     RF,TPREDEM(R2)      TEST ANY 'BALANCED' GOAL                     
         LTR   RF,RF                                                            
         BNZ   RSCALE58            YES - IGNORE                                 
         LHI   RF,1                SET BALANCED GOAL TO 1                       
         ST    RF,TPREDEM(R2)      (KEEPS BRAND ALIVE IN WEEK)                  
RSCALE58 AH    R2,CELLWID                                                       
         BCT   R7,RSCALE56                                                      
         AH    R3,ROWLEN                                                        
         C     R3,AEXCROW                                                       
         BNH   RSCALE54                                                         
                                                                                
***********************************************************************         
* Set total goal = supply at +4 (replace regular brand total)         *         
***********************************************************************         
                                                                                
         L     R4,ATOTROW                                                       
TOT      USING TABD,R4                                                          
         L     R5,ASUPROW                                                       
SUP      USING TABD,R5                                                          
         SR    R2,R2                                                            
         LH    R0,NWKSP1                                                        
         L     RE,SUP.TRSCGOL(R2)                                               
         ST    RE,TOT.TPREDEM(R2)                                               
         AH    R2,CELLWID                                                       
         BCT   R0,*-12                                                          
         GOTOR RSPRNT              PRINT RESCALING WORKSHEET                    
                                                                                
*                                  PRINT RESCALING REPORT                       
         LH    RF,NWKSP1           WEEKS (INCLUDING TOTAL)                      
         LHI   R1,MAXWKPP          MAXIMUM WEEKS PER REPORT PAGE                
         SR    R0,R0               STARTING WEEK NUMBER                         
RSCALE62 CR    RF,R1               WILL WHATS LEFT FIT ON THIS PAGE             
         BNL   *+6                                                              
         LR    R1,RF               YES, DO IT ALL                               
         STH   R1,RPTNOWKS                                                      
         STC   R0,RPTSWK                                                        
         GOTOR RSREPT              RESCALING REPORT                             
         AHI   R0,MAXWKPP          WEEKS PER PAGE                               
         SR    RF,R1                                                            
         BP    RSCALE62            DO NEXT SET OF WEEKS                         
                                                                                
RSCALEX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Vertical rescaler                                                   *         
***********************************************************************         
                                                                                
RSVERT   NTR1  ,                                                                
         L     R3,AFSTBRD         SET REG TOT AND PRI TOT                       
BRD      USING TABD,R3                                                          
         L     R5,ATOTROW                                                       
TOT      USING TABD,R5                                                          
         L     R6,ASUPROW                                                       
SUP      USING TABD,R6                                                          
         SR    R0,R0                                                            
         ST    R0,TOT.TPREDEM(R2)  CLEAR REG TOT                                
         ST    R0,TOT.TPREDOL(R2)  CLEAR PRI TOT                                
RSVERT02 LA    RE,TOT.TPREDOL(R2)  PRI TOT                                      
         CLI   BRD.TABPRI,YESQ                                                  
         BE    *+8                                                              
         LA    RE,TOT.TPREDEM(R2)  REG TOT                                      
         L     RF,0(RE)                                                         
         A     RF,BRD.TPREDEM(R2)                                               
         ST    RF,0(RE)                                                         
         AH    R3,ROWLEN           NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   RSVERT02                                                         
*                                  SET SUPPLY AMOUNTS                           
         L     RF,SUP.TRSCGOL(R2)  TOTAL SUPPLY                                 
         L     RE,TOT.TPREDOL(R2)  TOTAL PRI GOAL                               
         ST    RF,SUP.TPREDOL(R2)  SET PRI SUPPLY = TOTAL SUPPLY                
         SR    R0,R0               AND CLEAR REG SUPPLY                         
         ST    R0,SUP.TPREDEM(R2)                                               
         CR    RF,RE               IF TOTAL SUPPLY L.E. PRI SUPPLY              
         BNH   RSVERT04                                                         
         ST    RE,SUP.TPREDOL(R2)  SET PRI SUPPLY=TOTAL PRI GOAL                
         SR    RF,RE                                                            
         ST    RF,SUP.TPREDEM(R2)  AND REG SUPPLY TO REMAINDER                  
*                                  GET RESCALING FACTORS                        
RSVERT04 L     R1,SUP.TPREDEM(R2)  REG SUPPLY                                   
         M     R0,FW10000                                                       
         L     RF,TOT.TPREDEM(R2)  REG GOAL TOTAL                               
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1          REG PRODUCT FACTOR                           
         L     R1,SUP.TPREDOL(R2)  PRI SUPPLY                                   
         M     R0,FW10000                                                       
         L     RF,TOT.TPREDOL(R2)  PRI GOAL                                     
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR2          PRI FACTOR                                   
         L     R3,AFSTBRD                                                       
RSVERT06 LA    RF,FACTOR2                                                       
         CLI   TABPRI,YESQ                                                      
         BE    *+8                                                              
         LA    RF,FACTOR1                                                       
         L     R1,BRD.TPREDEM(R2)  BRAND GOAL                                   
         M     R0,0(RF)            X FACTOR                                     
         L     RF,FW10000                                                       
         GOTOR DIVIDE                                                           
         ST    R1,BRD.TPREDEM(R2)  SET RESULT                                   
         CLI   RSLCNT,0            ON FIRST TIME SET                            
         BNE   RSVERT08            SET MINIMUN RESCALING LIMIT                  
         LTR   R1,R1                                                            
         BNP   RSVERT08                                                         
         M     R0,FW10             10 PERCENT OF FIRST RESCALING                
         LHI   RF,100                                                           
         GOTOR DIVIDE                                                           
         LTR   R1,R1                                                            
         BP    *+8                                                              
         LHI   R1,1                                                             
         ST    R1,BRD.TMINRES(R2)                                               
RSVERT08 AH    R3,ROWLEN           NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   RSVERT06                                                         
RSVERTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Print rescaling work sheet                                          *         
***********************************************************************         
                                                                                
RSPRNT   TM    DIAGNOP1,DPRTRESQ                                                
         BZR   RE                                                               
                                                                                
RSPRNTN  NTR1  ,                                                                
         MVI   FORCEHED,YESQ                                                    
         MVI   SKIPSPEC,YESQ                                                    
         MVC   P1(19),=C'Rescaling worksheet'                                   
         MVC   P2(19),DASHES                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         L     R3,ASUPROW                                                       
RSPRNT02 XC    WORK1,WORK1                                                      
         GOTOR HEXOUT,HEXPARM,TABD,WORK1,TABDATA-TABD,NOL,XA=OFF                
         MVC   P1(12),WORK1                                                     
         MVC   P2(12),WORK1+12                                                  
         EDIT  TABGOAL,(8,P3+2),ZERO=NOBLANK                                    
         LH    RF,NWKSP1           WEEKS (INCLUDING TOTAL)                      
         LHI   R1,MAXWKPP          MAXIMUM WEEKS PER REPORT PAGE                
         SR    R0,R0               STARTING WEEK NUMBER                         
RSPRNT04 CR    RF,R1               WILL WHATS LEFT FIT ON THIS PAGE             
         BNL   *+6                                                              
         LR    R1,RF               YES, DO IT ALL                               
         STH   R1,RPTNOWKS                                                      
         STC   R0,RPTSWK                                                        
         GOTOR RSPTAB              RESCALING REPORT                             
         AHI   R0,MAXWKPP          WEEKS PER PAGE                               
         SR    RF,R1                                                            
         BP    RSPRNT04            DO NEXT SET OF WEEKS                         
         AH    R3,ROWLEN           NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   RSPRNT02                                                         
         J     EXIT                                                             
                                                                                
RSPTAB   NTR1  ,                                                                
         LA    R2,P1+12                                                         
         LH    R4,RPTNOWKS                                                      
         LA    R6,TABDATA-TABD(R3)                                              
         SR    RF,RF                                                            
         IC    RF,RPTSWK           STARTING WEEK NUMBER                         
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
RSPTAB02 LH    R5,CELLWID                                                       
         SRL   R5,2                                                             
         LR    R7,R2                                                            
RSPTAB04 EDIT  (B4,0(R6)),(8,0(R7)),ZERO=NOBLANK                                
         AHI   R7,L'P1             NEXT CELL ON NEXT LINE                       
         AHI   R6,L'TRSCGOL                                                     
         BCT   R5,RSPTAB04                                                      
         AHI   R2,8                NEXT WEEK                                    
         BCT   R4,RSPTAB02                                                      
         MVI   SPACING,2                                                        
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
RSPTABX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Rescaling report                                                    *         
***********************************************************************         
                                                                                
RSREPT   NTR1  ,                                                                
         CLI   RSWKOPT,RSWKREPQ    NEED BALANCE REPORT                          
         BE    *+12                                                             
         CLI   RSWKOPT,RSWKBALQ    ONLY BALANCING                               
         BNE   RSREPTX                                                          
         MVI   FORCEHED,YESQ                                                    
         MVI   RCSUBPRG,7                                                       
         MVI   NOMID,YESQ                                                       
         LH    RF,RPTNOWKS         SET COLUMN SPACING CONTROLS                  
         BCTR  RF,0                                                             
         MHI   RF,L'RSLTAB                                                      
         LARL  R0,RSLTAB                                                        
         AR    RF,R0                                                            
         MVC   ROWDISP+1(1),0(RF)  START OF ROW DESCRIPTION                     
         MVC   AMTDISP+1(1),1(RF)  OVER TO TOTAL COLUMN                         
         MVC   WEEKWID+1(1),2(RF)  SPACE BETWEEN COLUMNS                        
RSREPT04 LH    R7,RPTNOWKS         SET TOTAL ROW                                
         SR    R2,R2                                                            
         IC    R2,RPTSWK           STARTING WEEK NUMBER                         
         MH    R2,CELLWID                                                       
RSREPT06 SR    RE,RE                                                            
                                                                                
         L     R3,AFSTBRD                                                       
         USING TABD,R3                                                          
RSREPT08 CLC   TABPRD,SUPPRD                                                    
         BE    RSREPT10                                                         
         CLC   TABPRD,UNAPRD                                                    
         BE    RSREPT10                                                         
         A     RE,TSAVDEM(R2)                                                   
         AH    R3,ROWLEN                                                        
         B     RSREPT08                                                         
                                                                                
RSREPT10 L     RF,ATOTROW                                                       
         ST    RE,TSAVDEM-TABD(RF,R2)                                           
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R7,RSREPT06                                                      
*                                  SORT BRANDS IN PRINT ORDER                   
         L     R3,AFSTBRD          FIRST BUILD TABLE OF ADDRS                   
         L     R4,APXCREC          USE PXCREC FOR BRAND SORTING                 
         SR    RF,RF                                                            
RSREPT12 CLC   TABPRD,SUPPRD                                                    
         BE    RSREPT14                                                         
         MVC   0(L'TABPRD,R4),TABPRD                                            
         STCM  R3,15,L'TABPRD(R4)                                               
         AH    R3,ROWLEN           NEXT PRODUCT                                 
         AHI   R4,L'TABPRD+4       NEXT TABLE ENTRY                             
         AHI   RF,1                COUNT PRODUCTS                               
         B     RSREPT12                                                         
                                                                                
RSREPT14 MVC   0(L'TOTPRD,R4),TOTPRD                                            
         LTR   RF,RF                                                            
         BZ    RSREPT18            NO PRODUCTS                                  
         GOTOR XSORT,DMCB,APXCREC,(RF),L'TABPRD+4,L'TABPRD,0,XA=OFF             
                                                                                
         MVC   THISPRD,ASUPROW     SUPPLY                                       
         GOTOR RSBRDR                                                           
                                                                                
         L     R4,APXCREC          BRANDS                                       
RSREPT16 CLC   TOTPRD,0(R4)        TEST END                                     
         BE    RSREPT18                                                         
         MVC   THISPRD,L'TABPRD(R4)                                             
         GOTOR RSBRDR              DO BRAND REPORT                              
         AHI   R4,L'TABPRD+4                                                    
         B     RSREPT16                                                         
                                                                                
RSREPT18 MVC   THISPRD,ATOTROW     TOTALS                                       
         GOTOR RSBRDR                                                           
                                                                                
RSREPT20 L     R2,ATOTROW                                                       
         OC    TABDATA-TABD(8,R2),TABDATA-TABD(R2)                              
         BNZ   RSREPT22                                                         
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(16),=C'*** No Goals for'                                      
         MVC   P1+17(L'DPSLDESC),DPSLDESC                                       
         MVI   SPACING,2                                                        
         MVC   P2,SPACES                                                        
         GOTOR REPORT,XA=OFF                                                    
                                                                                
RSREPT22 CLI   DSSW,DSSYESQ        IF DID DAYPART RESCALING                     
         BNE   RSREPT24                                                         
         CLI   PBMODE,PBMDPTQ      AND THIS IS A WEEK RESCALE                   
         BE    RSREPT24                                                         
         MVC   P1(65),=C'Note- ''Before'' figures are derived from over*        
               all daypart rescaling'                                           
         MVC   P2+6(62),=C'(possibly adjusted by daypart to daypart rol*        
               l-up adjustments),'                                              
         MVC   P3+6(32),=C'they are not the original goals.'                    
         GOTOR REPORT,XA=OFF                                                    
                                                                                
RSREPT24 CLI   PODRSW,YESQ         FOR POD RUN                                  
         BNE   RSREPT28                                                         
         CLI   GOALOPT,GOALDEMS    AND IF DEMO ALLOCATION                       
         BNE   RSREPT28                                                         
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(56),=C'Note- Demos are 30 second equivalenced before *        
               rescaling.'                                                      
         GOTOR REPORT,XA=OFF                                                    
                                                                                
RSREPT28 MVI   RCSUBPRG,0                                                       
                                                                                
RSREPTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Format and print brand report line                                  *         
***********************************************************************         
                                                                                
RSBRDR   NTR1  ,                                                                
         MVC   SRPNL1,SPACES                                                    
         MVC   SRPNL2,SPACES                                                    
         L     R3,THISPRD                                                       
         CLC   TABPRD,SUPPRD       SUPPLY                                       
         BNE   RSBRDR02                                                         
         MVC   SRPNL1(12),=C'** Supply **'                                      
         B     RSBRDR12                                                         
                                                                                
RSBRDR02 CLC   TABPRD,TOTPRD                                                    
         BNE   RSBRDR04                                                         
         MVC   SRPNL1(L'TOTALSL),TOTALSL                                        
         B     RSBRDR12                                                         
                                                                                
RSBRDR04 CLC   TABPRD,UNAPRD                                                    
         BNE   RSBRDR06                                                         
         OC    TRSCGOL(L'TRSCGOL+L'TPREDEM),TRSCGOL                             
         BZ    RSBRDRX             SKIP IF NONE                                 
         MVC   SRPNL1(11),=C'***  Excess'                                       
         B     RSBRDR10                                                         
                                                                                
RSBRDR06 GOTOR LOCPRD,TABPRD                                                    
         LR    RF,R1                                                            
         USING PTBUFFD,RF                                                       
         MVC   HOLDPRD,TABPRD                                                   
         MVC   SRPNL1(L'PTPRDA),PTPRDA                                          
         LA    R7,SRPNL1+5                                                      
         CLI   PODRSW,YESQ         FOR POD RUN SHOW LENGTH                      
         BNE   RSBRDR08                                                         
         LA    R7,SRPNL1+4                                                      
         MVI   0(R7),OPAREN                                                     
         SR    R0,R0                                                            
         IC    R0,TABLEN                                                        
         EDIT  (R0),(3,1(R7)),ALIGN=LEFT                                        
         AR    R7,R0                                                            
         MVI   1(R7),CPAREN                                                     
         AHI   R7,4                                                             
RSBRDR08 MVC   0(L'PTNAME,R7),PTNAME                                            
         DROP  RF                                                               
                                                                                
RSBRDR10 CLI   TABPRI,YESQ                                                      
         BNE   RSBRDR12                                                         
         LA    R7,SRPNL1+40                                                     
         CLI   0(R7),SPACE                                                      
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVC   3(3,R7),=C'(P1)'                                                 
         AHI   R7,4                                                             
                                                                                
RSBRDR12 LA    R6,P1                                                            
         AH    R6,ROWDISP                                                       
         MVC   0(L'SRPNL1,R6),SRPNL1                                            
         MVC   L'P1(L'SRPNL2,R6),SRPNL2                                         
         MVC   SRPNL1,SPACES                                                    
         MVC   SRPNL2,SPACES                                                    
         LA    R2,P1                                                            
         AH    R2,ROWDISP                                                       
         CLC   TABPRD,SUPPRD                                                    
         BE    RSBRDR14                                                         
         LA    R2,P2                                                            
         AH    R2,ROWDISP          START OF ROW DESCREPTIONS                    
         CLC   TABPRD,UNAPRD       NO BEFORE FOR EXCESS ROW                     
         BE    RSBRDR26                                                         
         LR    RF,R2               POSITION OF BEFORE/AFTER                     
         AH    RF,AMTDISP                                                       
         AHI   RF,-7               7 BEFORE AMOUNTS                             
         MVC   0(6,RF),=C'Before'                                               
RSBRDR14 LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TSAVDEM          ORIGINAL GOAL                                
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           STARTING WEEK NUMBER                         
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
RSBRDR16 L     R1,0(R6)                                                         
         CLI   GOALOPT,GOALDOLS                                                 
         BNE   RSBRDR20                                                         
         EDIT  (R1),(8,0(R4)),ZERO=NOBLANK                                      
         B     RSBRDR24                                                         
RSBRDR20 CLI   CORPDEM+1,RATINGQ                                                
         BE    RSBRDR22                                                         
         EDIT  (R1),(8,0(R4)),ZERO=NOBLANK                                      
         B     RSBRDR24                                                         
RSBRDR22 EDIT  (R1),(8,0(R4)),1,ZERO=NOBLANK                                    
RSBRDR24 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,RSBRDR16                                                      
         AHI   R2,L'P1             NEXT LINE                                    
RSBRDR26 CLC   TABPRD,SUPPRD       NO AFTER FOR SUPPLY                          
         BE    RSBRDR38                                                         
         LR    RF,R2               POSITION OF BEFORE/AFTER                     
         AH    RF,AMTDISP                                                       
         AHI   RF,-7               7 BEFORE AMOUNTS                             
         MVC   0(5,RF),=C'After'                                                
         CLC   TABPRD,TOTPRD       FOR TOTALS                                   
         BNE   *+12                                                             
         L     R3,ASUPROW          USE SUPPLY AS 'AFTER'                        
         B     RSBRDR14                                                         
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TPREDEM                                                       
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           STARTING WEEK NUMBER                         
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
RSBRDR28 L     R1,0(R6)            GET IN DOLLARS                               
         CLI   GOALOPT,GOALDOLS                                                 
         BNE   RSBRDR32                                                         
         EDIT  (R1),(8,0(R4)),ZERO=NOBLANK                                      
         B     RSBRDR36                                                         
RSBRDR32 CLI   CORPDEM+1,RATINGQ                                                
         BE    RSBRDR34                                                         
         EDIT  (R1),(8,0(R4)),ZERO=NOBLANK                                      
         B     RSBRDR36                                                         
RSBRDR34 EDIT  (R1),(8,0(R4)),1,ZERO=NOBLANK                                    
RSBRDR36 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,RSBRDR28                                                      
         AHI   R2,L'P1             NEXT LINE                                    
RSBRDR38 MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
RSBRDRX  J     EXIT                                                             
         DROP  R3,RB,SUPWKT,SUPTOT,SAVEXC,TOT,TOTALS,TOTBAS,SUP,TOTWKT          
         DROP  BRD,CURWKT                                                       
                                                                                
RSREGTOT DS    F                   REGULAR BRAND TOTAL                          
RSPRITOT DS    F                   PRIORITY BRAND TOTAL                         
EXCSW    DS    C                   RSCALE EXCESS SWITCH                         
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Daypart rescaling                                                   *         
*                                                                     *         
* Treat daypart/lengths as 'weeks' and use RSCALE                     *         
***********************************************************************         
                                                                                
DSCALE   NMOD1 0,**DSCALE                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         MVI   DSSW,DSSNOQ                                                      
         TM    REQFLAG2,REQFSDPT+REQFSLEN MUST BE SEPARATE DPT/LEN              
         BNO   DSCALEX                                                          
         CLI   PODRSW,YESQ         AND NOT A POD RUN                            
         BE    DSCALEX                                                          
         CLI   RSWKOPT,RSWKNOQ     AND RESCALE OPTION                           
         BE    DSCALEX                                                          
         TM    REQFLAG1,REQFMIXB   AND NOT MIXED GOAL BASIS                     
         BNZ   DSCALEX                                                          
         OC    DPSLFLT,DPSLFLT     AND DAYPART/LENGTH FILTER NOT SET            
         BNZ   DSCALEX                                                          
         MVI   PBMODE,PBMDPTQ      DAYPART MODE FOR PRTBUF                      
         MVI   DSSW,DSSCURQ        SET CURRENTLY DOING DAYPART RESCALE          
         LHI   RF,24               SET 'CELL WIDTH'                             
         STH   RF,CELLWID                                                       
         LHI   RF,MAXWEEKS+1       USE MAXIMUM WKS FOR DAYPART RESCALE          
         MH    RF,CELLWID                                                       
         AHI   RF,TABDATA-TABD                                                  
         STH   RF,ROWLEN           LENGTH OF ROW                                
         A     RF,ASUPROW                                                       
         ST    RF,ATOTROW          TOTAL ROW                                    
         AH    RF,ROWLEN                                                        
         ST    RF,AFSTBRD          FIRST BRAND                                  
         MVC   SAVENWKS,NWKS       SAVE NWKS                                    
         XC    NWKS,NWKS                                                        
         XC    NPRDS,NPRDS                                                      
         GOTOR CLRBRD              CLEAR BRDTAB TO BINARY ZEROES                
         XC    DSTAB(DSTABL),DSTAB CLEAR DAYPART/LENGTH TABLE                   
         LA    R2,DSTAB                                                         
         XC    L.GBUFFK(GBUFFKL),L.GBUFFK                                       
         XC    DSCALEWK,DSCALEWK   START AT TOTAL COLUMN                        
         XC    GBUFFK(GBUFFKL),GBUFFK                                           
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     DSCALE06                                                         
DSCALE04 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
DSCALE06 BNZ   DSCALE20                                                         
         OC    GBROW(GBROWL),GBROW SKIP RECS WITH NULL VALUES                   
         BZ    DSCALE04                                                         
         LHI   R0,TGOLDEMQ         RATINGS                                      
         CLI   GOALOPT,GOALDEMS                                                 
         BE    *+8                                                              
         LHI   R0,TGOLDOLQ         OR DOLLARS                                   
         CLM   R0,1,GBTYP                                                       
         BNE   DSCALE04                                                         
         CLC   GBDPT,L.GBDPT                                                    
         BNE   DSCALE08                                                         
         CLC   GBLEN,L.GBLEN                                                    
         BE    DSCALE10                                                         
         CLI   PODRSW,YESQ         NO LENGTH BREAK IF POD RUN                   
         BE    DSCALE10                                                         
DSCALE08 MVC   L.GBUFFK(GBUFFKL),GBUFFK                                         
         MVC   0(L'DSTAB,R2),GBDPT SAVE DAYPART/LENGTH IN DSTAB                 
         AHI   R2,L'DSTAB                                                       
         LH    RF,DSCALEWK         NEXT 'WEEK'                                  
         AH    RF,CELLWID                                                       
         STH   RF,DSCALEWK                                                      
         LH    RF,NWKS             BUMP 'DAYPART' COUNT                         
         AHI   RF,1                                                             
         STH   RF,NWKS                                                          
DSCALE10 L     R6,ASUPROW                                                       
         CLC   GBPRD,SUPPRD        SUPPLY                                       
         BE    DSCALE16                                                         
         L     R6,ATOTROW                                                       
         CLC   GBPRD,TOTPRD        TOTAL                                        
         BE    DSCALE16                                                         
         L     R6,AFSTBRD          FIND RIGHT PRODUCT                           
         USING TABD,R6                                                          
DSCALE12 CLC   TABPRD,GBPRD                                                     
         BE    DSCALE16                                                         
         CLC   TABPRD,SUPPRD                                                    
         BNE   DSCALE14                                                         
         LH    R1,NPRDS            BUMP NUMBER OF PRODUCTS                      
         AHI   R1,1                                                             
         STH   R1,NPRDS                                                         
         B     DSCALE16                                                         
DSCALE14 AH    R6,ROWLEN                                                        
         B     DSCALE12                                                         
DSCALE16 MVC   TABKEY(TABKEYL),GBUFFK                                           
         CLI   TABPRI,0                                                         
         BNE   *+10                                                             
         MVC   TABPRI,GBPRI                                                     
         ICM   R1,15,GBTOT                                                      
         CLI   GBTYP,TGOLDEMQ      ONLY DEMOS                                   
         BNE   DSCALE18                                                         
         CLI   PODRSW,YESQ         ONLY FOR POD RUN                             
         BNE   DSCALE18                                                         
         CLC   GBLEN,PODLEN        SKIP IF AREADY HAVE EQUIV BASE?              
         BE    DSCALE18                                                         
         CLC   GBPRD,SUPPRD        SKIP FOR SUPPLY                              
         BE    DSCALE18                                                         
         SR    R0,R0                                                            
         IC    R0,GBLEN                                                         
         MR    R0,R0               X ACTUAL LENGTH                              
         LH    RF,PODEQU           / BASE LENGTH                                
         GOTOR DIVIDE                                                           
DSCALE18 L     R0,TRSCGOL          ADD TO TOTAL COLUMN                          
         AR    R0,R1                                                            
         ST    R0,TRSCGOL                                                       
         AH    R6,DSCALEWK                                                      
         ST    R1,TRSCGOL                                                       
         B     DSCALE04                                                         
         DROP  R6                                                               
DSCALE20 CLC   NWKS,HW1            SKIP IF ONLY ONE DAYPART                     
         BH    DSCALE22                                                         
         MVI   DSSW,DSSNOQ         NO DAYPART RESCALING                         
         B     DSCALE36                                                         
                                                                                
DSCALE22 GOTOR ARSCALE                                                          
                                                                                
***********************************************************************         
* Now read original rows and rewrite rescaled goals - TYP 41          *         
***********************************************************************         
                                                                                
         MVC   DSCALEWK,CELLWID    START AT 'WEEK' 1                            
         LA    R2,DSTAB                                                         
DSCALE24 L     R3,ATOTROW                                                       
         USING TABD,R3                                                          
         LH    R4,DSCALEWK                                                      
DSCALE26 XC    GBUFFK(GBUFFKL),GBUFFK                                           
         MVC   GBUFFK(GBUFFKL),TABKEY KEY FOR BUFF                              
         MVC   GBDPT(L'GBDPT+L'GBLEN),0(R2) DAYPART/LENGTH FROM TABLE           
         GOTOR BU1GET                                                           
         BNZ   DSCALE34            SKIP IF THIS PRODUCT/DPT NOT ACTIVE          
*                                  CALCULATE FACTOR                             
*                                  SCALE EACH WEEK TO NEW TOTALS                
         CLC   GBTOT,FW1           BUT IF GBTOT NOT GREATER THAN 1 THEN         
         BH    DSCALE28            COMPLETE BUY/GOAL DAYPART MISMATCH           
*                                  AND CAN'T PROCEED (PREVENTS A                
*                                  DIVISION DUMP)                               
         MVC   P1(29),=C'**Buy/Goal daypart mismatch**'                         
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         J     ENDREQ                                                           
                                                                                
DSCALE28 L     R1,TPREDEM(R4)                                                   
         M     R0,FW100000                                                      
         MVC   FULL,GBTOT                                                       
         L     RF,FULL                                                          
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1                                                       
         L     R1,TPREDEM(R4)                                                   
         STCM  R1,15,GBTOT                                                      
         LH    R5,SAVENWKS         FOR BCT                                      
         LA    R6,GBWKS                                                         
DSCALE30 ICM   R1,15,0(R6)                                                      
         BZ    DSCALE32                                                         
         M     R0,FACTOR1                                                       
         L     RF,FW100000                                                      
         GOTOR DIVIDE                                                           
         LTR   R1,R1               DON'T REDUCE TO ZERO                         
         BP    *+8                                                              
         LHI   R1,1                                                             
         ST    R1,0(R6)                                                         
DSCALE32 AHI   R6,L'GBWKS                                                       
         BCT   R5,DSCALE30                                                      
                                                                                
         MVI   GBTYP,TRSCGOLQ                                                   
         MVC   GBPRI,TABPRI                                                     
         L     RF,ABUFF1                                                        
         OI    BUFFINDS-BUFFD(RF),BUFFIRCM                                      
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
         L     RF,ABUFF1                                                        
         NI    BUFFINDS-BUFFD(RF),FF-(BUFFIRCM)                                 
DSCALE34 AH    R3,ROWLEN           NEXT PRODUCT                                 
         CLC   TABPRD,SUPPRD                                                    
         BNE   DSCALE26                                                         
         AHI   R2,L'DSTAB          NEXT DAYPART/LENGTH                          
         CLI   0(R2),0             TEST END                                     
         BE    DSCALE36                                                         
         LH    RF,DSCALEWK                                                      
         AH    RF,CELLWID                                                       
         STH   RF,DSCALEWK                                                      
         B     DSCALE24                                                         
DSCALE36 MVC   NWKS,SAVENWKS       RESTORE NWKS                                 
         LH    RF,NWKS                                                          
         AHI   RF,1                                                             
         STH   RF,NWKSP1                                                        
         CLI   DSSW,DSSCURQ                                                     
         BNE   DSCALEX                                                          
         GOTOR APRTBUF                                                          
         MVI   DSSW,DSSYESQ        SET HAVE DONE DAYPART RESACLE                
                                                                                
DSCALEX  MVI   PBMODE,0                                                         
         J     EXIT                                                             
         DROP  R3,RB                                                            
                                                                                
         LTORG                                                                  
                                                                                
DSCALEWK DS    H                   DSCALE WEEK DISPLACEMENT                     
         EJECT                                                                  
***********************************************************************         
* Move supply/goal to table row                                       *         
***********************************************************************         
                                                                                
GETROW   NMOD1 0,**GETROW                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     R2,ASUPROW          POINT TO SUPPLY ROW                          
         CLC   GBPRD,SUPPRD        TEST SUPPLY PRODUCT                          
         BE    GETROW10                                                         
         L     R2,ATOTROW          POINT TO TOTAL ROW                           
         CLC   GBPRD,TOTPRD        TEST TOTAL PRODUCT                           
         BE    GETROW10                                                         
         L     R2,AFSTBRD          FIND RIGHT PRODUCT                           
         USING TABD,R2                                                          
GETROW02 CLC   TABPRD,GBPRD        PRODUCT MUST AGREE                           
         BNE   GETROW04                                                         
         CLI   RWILNSW,RWILSEP     IF SEPARATING LENGTHS                        
         BNE   GETROW08                                                         
         CLC   TABDPT(L'TABDPT+L'TABLEN),GBDPT MATCH DPT/LENGTHS TOO            
         BE    GETROW08                                                         
GETROW04 CLC   TABPRD,SUPPRD       TEST END OF PRODUCT BUFFER                   
         BE    *+12                                                             
         AH    R2,ROWLEN           NO - BUMP TO NEXT ENTRY                      
         B     GETROW02                                                         
         LA    R0,TABD             YES - CLEAR AND USE LAST ROW                 
         LH    R1,ROWLEN                                                        
         GOTOR CLEAR                                                            
GETROW08 MVI   TABGLDEM,0          SET GOAL DEMO                                
         CLC   GBPRD,UNAPRD                                                     
         BNL   GETROW10                                                         
         TM    REQFLAG1,REQFMIXB   TEST MIXED GOAL BASIS                        
         BZ    GETROW10                                                         
         GOTOR LOCPRD,GBPRD                                                     
         CLC   CORPDEM,PTDEMNO-PTBUFFD(R1)                                      
         BE    GETROW10                                                         
         MVC   TABGLDEM,PTTRGS-PTBUFFD(R1)                                      
                                                                                
GETROW10 MVC   TABKEY(TABKEYL),GBUFFK SET KEY                                   
         OC    TABPRI,GBPRI        SET PRIORITY                                 
         LA    R1,GBROW                                                         
         LH    RF,CELLD            ADD DISPLACEMENT TO REQUIRED CELL            
         LA    RF,TABDATA(RF)      AND POINT TO ACCUMULATOR                     
         LHI   R0,GBROWN           R0=N'GBROW ENTRIES                           
GETROW12 L     RE,0(R1)                                                         
         A     RE,0(RF)                                                         
         ST    RE,0(RF)                                                         
         AH    RF,CELLWID          NEXT WEEK                                    
         AHI   R1,L'GBWKS                                                       
         BCT   R0,GETROW12                                                      
                                                                                
GETROWX  J     EXIT                                                             
         DROP  R2,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Write supply/goal table back to buffer                              *         
***********************************************************************         
                                                                                
PUTROW   NMOD1 0,**PUTROW                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     R2,ATOTROW                                                       
         USING TABD,R2                                                          
PUTROW02 XC    GBUFFR(GBUFFRL),GBUFFR                                           
         MVC   GBUFFK(GBUFFKL+L'GBPRI),TABKEY                                   
         MVC   GBTYP,TYP           SET TYPE                                     
         CLI   TYP,TRSCGOLQ                                                     
         BNE   PUTROW04                                                         
         CLI   DSSW,DSSYESQ                                                     
         BNE   PUTROW04                                                         
         GOTOR BU1GET              READ RECORD ALREADY THERE                    
         BZ    PUTROW04                                                         
         XC    GBUFFR(GBUFFRL),GBUFFR                                           
         MVC   GBUFFK(GBUFFKL+L'GBPRI),TABKEY                                   
         MVC   GBTYP,TYP           SET TYPE                                     
PUTROW04 LH    RE,CELLD            USE CORRECT CELL                             
         LA    RE,TABDATA(RE)      START AT TOTAL COLUMN                        
         LH    R0,NWKSP1                                                        
         LA    R1,GBTOT                                                         
PUTROW06 L     RF,0(R1)            COMPLEMENT WHATEVER WAS THERE                
         LCR   RF,RF               IN ORDER TO REPLACE IT NOT ADD TO IT         
         A     RF,0(RE)                                                         
         ST    RF,0(R1)                                                         
         AHI   R1,L'TRSCGOL                                                     
         AH    RE,CELLWID                                                       
         BCT   R0,PUTROW06                                                      
         MVC   GBPRI,TABPRI                                                     
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
         AH    R2,ROWLEN                                                        
         CLC   TABPRD,SUPPRD       TEST END                                     
         BNE   PUTROW02                                                         
                                                                                
PUTROWX  J     EXIT                                                             
         DROP  R2,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Print supply/goal buffer records                                    *         
***********************************************************************         
                                                                                
PRTBUF   TM    DIAGNOP1,DPRDUNTQ                                                
         BZR   RE                                                               
                                                                                
PRTBUFN  NMOD1 0,**PUTROW                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         CLI   PBMODE,PBMDRUQ                                                   
         BE    PRTBUF14                                                         
         CLI   PBMODE,PBMDPTQ                                                   
         BNE   PRTBUF02                                                         
         TM    DIAGNOP1,DPRTRESQ                                                
         BZ    PRTBUFX                                                          
         MVC   P1(17),=C'Daypart rescaling'                                     
         MVC   P2(17),DASHES                                                    
         B     PRTBUF04                                                         
                                                                                
PRTBUF02 MVC   P1(18),=C'Supply/Goal BUFFER'                                    
         MVC   P2(18),DASHES                                                    
                                                                                
PRTBUF04 MVI   FORCEHED,YESQ                                                    
         MVI   SPACING,2                                                        
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1+15(L'TOTALL),TOTALL                                           
         MVC   P2+15(L'TOTALL),DASHES                                           
         LHI   R5,1                                                             
         LA    R2,P1+20                                                         
PRTBUF06 EDIT  (R5),(2,5(R2))                                                   
         MVC   L'P1+3(5,R2),DASHES                                              
         AHI   R2,8                                                             
         AHI   R5,1                                                             
         CH    R5,NWKS                                                          
         BH    *+12                                                             
         CHI   R5,14               NO MORE THAN 14 WEEKS                        
         BNH   PRTBUF06                                                         
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         XC    L.GBUFFK(GBUFFKL),L.GBUFFK                                       
         XC    GBUFFK(GBUFFKL),GBUFFK                                           
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     PRTBUF12                                                         
PRTBUF10 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
PRTBUF12 BNZ   PRTBUF36                                                         
         CLC   GBUFFK(GBTYP-GBUFFK),L.GBUFFK                                    
         BE    PRTBUF24                                                         
         MVC   L.GBUFFK(GBUFFKL),GBUFFK                                         
PRTBUF14 MVI   P1,0                                                             
         MVC   P2(1),GBDPT                                                      
         CLI   GBDPT,ALLDPT                                                     
         BNE   *+8                                                              
         MVI   P2,ASTERISK                                                      
         MVC   P2+1(L'ALL3L),ALL3L                                              
         CLI   GBLEN,ALLLEN                                                     
         BE    PRTBUF16                                                         
         MVC   P2+1(L'PODL),PODL                                                
         CLI   GBLEN,0                                                          
         BE    PRTBUF16                                                         
         EDIT  (B1,GBLEN),(3,P2+1),ALIGN=LEFT                                   
PRTBUF16 CLC   GBPRD,SUPPRD                                                     
         BNE   *+14                                                             
         MVC   P2+5(6),=C'Supply'                                               
         B     PRTBUF22                                                         
         CLC   GBPRD,UNAPRD                                                     
         BNE   *+14                                                             
         MVC   P2+5(3),=C'Una'                                                  
         B     PRTBUF22                                                         
         CLC   GBPRD,TOTPRD                                                     
         BNE   *+14                                                             
         MVC   P2+5(L'TOTALL),TOTALL                                            
         B     PRTBUF22                                                         
         MVC   P2+5(4),=C'Prd='                                                 
         SR    R1,R1                                                            
         ICM   R1,3,GBPRD                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   P2+9(L'PTPRDA),PTPRDA-PTBUFFD(R1)                                
         CLI   GBPRI,YESQ                                                       
         BNE   *+8                                                              
         MVI   P2+15,C'P'                                                       
         CLI   PBMODE,PBMDRUQ                                                   
         BE    PRTBUF22                                                         
         TM    REQFLAG1,REQFTRGS                                                
         BZ    PRTBUF20                                                         
         MVC   P2+17(6),=C'Targs='                                              
         GOTOR LOCPRD,GBPRD                                                     
         LA    R6,PTTRGS-PTBUFFD(R1)                                            
         LA    R4,P2+23                                                         
         LHI   R3,NTGVARS                                                       
PRTBUF18 EDIT  (B1,0(R6)),(2,0(R4)),ZERO=NOBLANK                                
         AHI   R4,3                                                             
         AHI   R6,1                                                             
         BCT   R3,PRTBUF18                                                      
PRTBUF20 GOTOR SETCLS,GBCLASS                                                   
         BE    PRTBUF22                                                         
         MVC   P2+30(L'CLASSEQL),CLASSEQL                                       
         MVC   P2+36(1),CLASS1                                                  
         BH    PRTBUF22                                                         
         MVI   P2+37,COMMA                                                      
         MVC   P2+38(1),CLASS2                                                  
PRTBUF22 MVC   P3(11),DASHES                                                    
         CLI   PBMODE,PBMDRUQ                                                   
         BNE   *+10                                                             
         MVC   P2+40(14),=C'Daypart rollup'                                     
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
                                                                                
PRTBUF24 LARL  R2,TYPTAB                                                        
PRTBUF26 CLC   GBTYP,0(R2)                                                      
         BE    PRTBUF28                                                         
         CLI   0(R2),FF                                                         
         BE    PRTBUF28                                                         
         AHI   R2,L'TYPTAB                                                      
         B     PRTBUF26                                                         
                                                                                
PRTBUF28 MVC   P1+2(9),1(R2)                                                    
         CLC   GBPRD,SUPPRD                                                     
         BNE   *+10                                                             
         MVC   P1+2(4),SPACES                                                   
         LA    R2,P1+12                                                         
         LA    R4,GBTOT                                                         
         LH    R5,NWKS                                                          
         AHI   R5,1                                                             
         CHI   R5,MAXWKPP          15 WEEKS MAXIMUM FOR PRINTOUT                
         BNH   PRTBUF30                                                         
         LHI   R5,MAXWKPP                                                       
PRTBUF30 L     R1,0(R4)                                                         
         MVC   BYTE,GBTYP                                                       
         NI    BYTE,DIGIT                                                       
         CLI   BYTE,TDOLQ          ROUND DOLLARS                                
         BE    PRTBUF32                                                         
         CLI   GBTYP,TRSCGOLQ      AND RESCALED GOALS (IF DOLLARS)              
         BNE   PRTBUF34                                                         
         CLI   GOALOPT,GOALDOLS                                                 
         BNE   PRTBUF34                                                         
PRTBUF32 AHI   R1,50                                                            
         M     R0,FW1                                                           
         D     R0,FW100                                                         
PRTBUF34 EDIT  (R1),(8,0(R2)),FLOAT=-                                           
         AHI   R2,8                                                             
         AHI   R4,4                                                             
         BCT   R5,PRTBUF30                                                      
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         CLI   PBMODE,PBMDRUQ                                                   
         BE    PRTBUFX                                                          
         B     PRTBUF10                                                         
PRTBUF36 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
PRTBUFX  J     EXIT                                                             
         DROP  RB                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Print environment counter tables                                    *         
***********************************************************************         
                                                                                
PRTENV   NMOD1 0,**PRTENV                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         TM    PEMODE,PEMPREQ      TEST PRE ALLOCATION                          
         BZ    *+16                                                             
         TM    DIAGNOP1,DENVBEFQ   YES - TEST TO DO PRE-ALLOCATION              
         BZ    PRTENVX                                                          
         B     *+12                                                             
         TM    DIAGNOP1,DENVAFTQ   TEST TO DO POST-ALLOCATION                   
         BZ    PRTENVX                                                          
                                                                                
         TM    PEMODE,PEMPSTQ      SKIP 'ACTUAL' COUNTS                         
         BZ    PRTENV02                                                         
         CLI   PODRSW,YESQ         UNLESS POD RUN                               
         BNE   PRTENVX                                                          
         CLI   ENVNO,ENVNPGMQ      AND ENVIRONMENT 1                            
         BNE   PRTENVX                                                          
                                                                                
PRTENV02 SR    R7,R7               SET ENVIRONMENT POINTER                      
         IC    R7,ENVNO                                                         
         SLL   R7,2                                                             
         L     R7,AENV1SET-L'AENV1SET(R7)                                       
         USING ENVSETD,R7                                                       
         MVI   SPACING,2                                                        
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(19),=C'Env X counter table'                                   
         MVC   P1+4(1),ENVNO                                                    
         OI    P1+4,ZONE                                                        
         MVC   P2(19),DASHES                                                    
         MVC   P1+21(7),=C'Daypart'                                             
         MVC   P1+29(1),L.GBDPT                                                 
         CLI   L.GBDPT,ALLDPT                                                   
         BNE   *+8                                                              
         MVI   P1+29,ASTERISK                                                   
         MVC   P1+30(L'ALL3L),ALL3L                                             
         CLI   L.GBLEN,ALLLEN                                                   
         BE    PRTENV04                                                         
         MVC   P1+30(L'PODL),PODL                                               
         CLI   L.GBLEN,0                                                        
         BE    PRTENV04                                                         
         EDIT  (B1,L.GBLEN),(3,P1+30),ALIGN=LEFT                                
PRTENV04 MVC   P1+35(11),=C'Pre-alloc  '                                        
         TM    PEMODE,PEMPREQ                                                   
         BNZ   *+10                                                             
         MVC   P1+35(15),=C'Post-alloc     '                                    
         TM    PEMODE,PEMPSTQ                                                   
         BZ    PRTENV06                                                         
         MVC   P1+53(25),=C'**Unequivalenced counts**'                          
PRTENV06 MVI   P3,0                                                             
         LARL  RE,PRTHD1                                                        
         MVC   P4(L'PRTHD1),0(RE)                                               
         MVC   P5(L'PRTHD2),L'PRTHD1(RE)                                        
         MVC   P6(L'PRTHD3),L'PRTHD1+L'PRTHD2(RE)                               
         LHI   R5,1                                                             
         LA    R2,P5+20                                                         
PRTENV08 EDIT  (R5),(2,4(R2))                                                   
         MVC   L'P1+1(8,R2),DASHES                                              
         AHI   R2,9                                                             
         AHI   R5,1                                                             
         CH    R5,NWKS                                                          
         BH    PRTENV10                                                         
         CHI   R5,MAXWKPP2         NO MORE THAN 12 WEEKS                        
         BNH   PRTENV08                                                         
PRTENV10 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         OC    ENVSTLEN,ENVSTLEN                                                
         BZ    PRTENVX                                                          
                                                                                
         SR    R2,R2                                                            
         SR    R3,R3                                                            
                                                                                
PRTENV12 EDIT  (R3),(3,P1+5),ZERO=NOBLANK                                       
                                                                                
         C     R3,ENVPCNT          TEST A PRODUCT                               
         BH    PRTENV14                                                         
         L     RE,PRDBUFF          PRODUCT SEQUENCE CODE                        
         LH    R0,HIGHPRDN                                                      
         CLM   R3,3,PTENVSEQ-PTBUFFD(RE)                                        
         BE    *+14                                                             
         AH    RE,PRDBUFLN                                                      
         BCT   R0,*-12                                                          
         DC    H'0'                                                             
         MVC   P1+9(L'PTPRDA),PTPRDA-PTBUFFD(RE)                                
         B     PRTENV18                                                         
                                                                                
PRTENV14 L     RE,ACLSTRT          CLASS SEQUENCE CODE                          
         LR    RF,RE                                                            
         LHI   R0,L'CLSTRT                                                      
         CLM   R3,1,0(RE)                                                       
         BE    *+14                                                             
         AHI   RE,1                                                             
         BCT   R0,*-12                                                          
         DC    H'0'                                                             
         SR    RE,RF                                                            
         MVI   P1+9,C'C'                                                        
         MVI   P1+10,C'='                                                       
         STC   RE,P1+11                                                         
         B     PRTENV18                                                         
                                                                                
PRTENV18 LTR   R3,R3               IF PRD DISP = 0, DO ENV CODE + SE            
         BNZ   PRTENV26                                                         
         STH   R2,HALF             ENVIRONMENT CODE AND SEQUENCE                
         LA    R4,ENVSTTAB                                                      
PRTENV22 CLC   HALF,0(R4)          FIND IN ENTRY                                
         BE    *+12                                                             
         AHI   R4,L'ENVSTTAB                                                    
         B     PRTENV22                                                         
         LA    R0,ENVSTTAB                                                      
         SR    R4,R0                                                            
         SRL   R4,1                                                             
         EDIT  (R4),(3,P1+2)                                                    
         EDIT  (R2),(2,P1+0),ZERO=NOBLANK                                       
                                                                                
PRTENV26 LR    RF,R3               PRINT COUNTERS                               
         MH    RF,ENVPRDD                                                       
         LR    RE,R2                                                            
         MH    RE,ENVENVD                                                       
         LA    R8,0(RF,RE)                                                      
         LR    R6,R8                                                            
                                                                                
         L     RE,ENVSACNT         COUNTS                                       
         L     RF,ENVSASHR         SHARES                                       
         TM    PEMODE,PEMPSTQ                                                   
         BZ    *+12                                                             
         L     RE,ENVSACTC         ACTUAL COUNTS                                
         L     RF,ENVSACNT         AND EQUIV COUNTS                             
         AR    R8,RE                                                            
         AR    R6,RF                                                            
         LA    R4,P1+13                                                         
         LH    R5,NWKS                                                          
         CHI   R5,MAXWKPP2                                                      
         BNH   PRTENV28                                                         
         LHI   R5,MAXWKPP2                                                      
PRTENV28 EDIT  (B2,0(R8)),(4,0(R4))                                             
         OI    3(R4),ZONE                                                       
         MVI   4(R4),SLASH                                                      
         EDIT  (B2,0(R6)),(4,5(R4)),ALIGN=LEFT                                  
         OI    5(R4),ZONE                                                       
         CLC   0(2,R8),0(R6)                                                    
         BNH   PRTENV30                                                         
         LA    RF,5(R4)                                                         
         AR    RF,R0                                                            
         MVI   0(RF),ASTERISK      OVERAGE                                      
PRTENV30 AHI   R4,9                                                             
         AHI   R8,2                                                             
         AHI   R6,2                                                             
         BCT   R5,PRTENV28                                                      
                                                                                
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         AHI   R3,1                NEXT PRODUCT/CLASS                           
         C     R3,ENVTCNT                                                       
         BL    PRTENV12                                                         
*                                  UNIT TOTALS FOR ENVIRONMENT                  
         MVC   P1+2(11),=C'Unit totals'                                         
         LH    R5,NWKSP1                                                        
         LA    R4,P1+13                                                         
         LR    R6,R2                                                            
         MHI   R6,(MAXWEEKS+1)*2                                                
         A     R6,ENVSATOT         POINT TO RIGHT SET                           
PRTENV32 EDIT  (B2,0(R6)),(5,0(R4)),ZERO=NOBLANK                                
         AHI   R4,9                                                             
         AHI   R6,2                                                             
         BCT   R5,PRTENV32                                                      
         MVI   SKIPSPEC,YESQ                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         SR    R3,R3                                                            
         AHI   R2,1                NEXT ENVIRONMENT CODE                        
         C     R2,ENVSWCNT                                                      
         BL    PRTENV12                                                         
         L     R4,ENVSATAB         A(ENVIRONMENT TABLE)                         
         MVI   SKIPSPEC,YESQ                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(11),=C'Env x table'                                           
         MVC   P1+4(1),ENVNO                                                    
         OI    P1+4,ZONE                                                        
         MVC   P2(11),DASHES                                                    
         GOTOR REPORT,XA=OFF                                                    
         LHI   R6,1                R6=COUNTER                                   
                                                                                
         USING ENVTABD,R4                                                       
PRTENV34 CLI   ENVS1KEY,ENVSEOTQ   TEST END OF TABLE                            
         BE    PRTENVX                                                          
                                                                                
         CLI   ENVNO,ENVNPGMQ      TEST PROGRAM ENVIRONMENT                     
         BNE   PRTENV36                                                         
         EDIT  (R6),(3,P1+1)                                                    
         MVC   P1+5(L'ENVS1NET),ENVS1NET                                        
         GOTOR CODAY,DMCB,ENVS1DAY,P1+13,XA=OFF                                 
         GOTOR UNTIME,DMCB,ENVS1TIM,P1+21,XA=OFF                                
         MVC   P1+33(06),ENVS1PGC                                               
         MVC   P1+40(17),ENVS1PGM                                               
         MVC   P1+58(03),ENVS1TYP                                               
         EDIT  (B2,ENVS1SLP),(5,P1+62),ZERO=NOBLANK                             
         EDIT  (B2,ENVS1SLC),(5,P1+68),ZERO=NOBLANK                             
         AHI   R4,ENVS1LEN                                                      
         B     PRTENV40                                                         
                                                                                
PRTENV36 CLI   ENVNO,ENVNNETQ      TEST NETWORK/MARKET ENVIRONMENT              
         BNE   PRTENV38                                                         
         EDIT  (R6),(3,P1+1)                                                    
         MVC   P1+5(L'ENVS2NET),ENVS2NET                                        
         AHI   R4,ENVS2LEN                                                      
         B     PRTENV40                                                         
                                                                                
PRTENV38 CLI   ENVNO,ENVNDOWQ      TEST DAY-OF-WEEK ENVIRONMENT                 
         BNE   PRTENV40                                                         
         EDIT  (R6),(3,P1+1)                                                    
         GOTOR CODAY,DMCB,ENVS3DAY,P1+5,XA=OFF                                  
         MVI   SKIPSPEC,YESQ                                                    
         AHI   R4,ENVS3LEN                                                      
                                                                                
PRTENV40 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         AHI   R6,1                BUMP COUNT                                   
         B     PRTENV34                                                         
                                                                                
PRTENVX  J     EXIT                                                             
         DROP  R4,R7,RB                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Print unit table                                                    *         
***********************************************************************         
                                                                                
PRTUNT   TM    DIAGNOP1,DPRDUNTQ                                                
         BZR   RE                                                               
                                                                                
PRTUNTN  NMOD1 0,**PRTUNT                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         LARL  RE,NETHD1                                                        
         MVC   P1,0(RE)                                                         
         MVC   P2(L'NETHD2),L'NETHD1(RE)                                        
         MVI   P3,0                                                             
         LA    R2,P4                                                            
         USING SLINED,R2                                                        
         EDIT  WAVCOST,(8,SLCOST)                                               
         EDIT  WAVBASD,(7,SLBASE),1                                             
         LA    R6,AWKAVGS          TARGET AVERAGE 'COSTS'                       
         LA    R4,SLTARG1                                                       
         SR    R3,R3                                                            
         ICM   R3,3,NTARGETS                                                    
         BZ    PRTUNT04                                                         
         CHI   R3,3                                                             
         BNH   PRTUNT02                                                         
         LHI   R3,3                ONLY 3 TARGETS HERE                          
PRTUNT02 EDIT  (B4,0(R6)),(7,0(R4)),2                                           
         AHI   R6,L'AWKAVGS                                                     
         AHI   R4,SLTARG2-SLTARG1                                               
         BCT   R3,PRTUNT02                                                      
PRTUNT04 MVC   SLDPT(19),=C'**Averages/Ratios**'                                
         MVI   SPACING,2                                                        
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
                                                                                
         L     R5,AUNTTAB                                                       
         USING UBUFFRD,R5                                                       
PRTUNT06 CLI   UBUFFRD,UBUFEOTQ    TEST END OF UNIT TABLE                       
         BE    PRTUNTX                                                          
         LA    R2,P1                                                            
         MVC   SLDPT,UBDPT                                                      
         CLI   UBDPT,ALLDPT                                                     
         BNE   *+8                                                              
         MVI   SLDPT,ASTERISK                                                   
         MVC   SLLEN,ALL3L                                                      
         CLI   UBLEN,ALLLEN                                                     
         BE    PRTUNT08                                                         
         MVC   SLLEN,PODL                                                       
         CLI   UBLEN,0                                                          
         BE    PRTUNT08                                                         
         EDIT  (B1,UBLEN),(3,SLLEN),ALIGN=LEFT                                  
PRTUNT08 EDIT  (B1,UBWEEK),(2,SLWK)                                             
         EDIT  (B2,UBSEQ),(5,SLSEQ)                                             
         EDIT  (B2,UBENV1),(3,SLENV1)                                           
         EDIT  (B2,UBENV2),(3,SLENV2)                                           
         EDIT  (B2,UBENV3),(3,SLENV3)                                           
         EDIT  (B1,UBPDLEN),(3,SLPDLEN)                                         
         EDIT  (B1,UBUNLEN),(3,SLUNLEN)                                         
         MVC   WORK(L'UBDA),UBDA                                                
         GOTOR HEXOUT,HEXPARM,WORK,SLDA,L'UBDA,NOL,XA=OFF                       
         MVC   WORK(L'UBDAY),UBDAY                                              
         GOTOR (RF),(R1),WORK,SLDAY,L'UBDAY,XA=OFF                              
         MVC   WORK(UBSTATL),UBSTAT                                             
         GOTOR (RF),(R1),WORK,SLSTAT,UBSTATL,XA=OFF                             
         MVC   WORK(L'UBDATE),UBDATE                                            
         GOTOR DATCON,DMCB,(2,WORK),(4,SLDATE),XA=OFF                           
         GOTOR FRMPRD,DMCB,UBPRD1,SLALLOC+(L'P1*0)                              
         GOTOR FRMPRD,DMCB,UBPRD2,SLALLOC+(L'P1*0)+7                            
         GOTOR FRMPRD,DMCB,UBPRD3,SLALLOC+(L'P1*1)                              
         GOTOR FRMPRD,DMCB,UBPRD4,SLALLOC+(L'P1*1)+7                            
         GOTOR FRMPRD,DMCB,UBPRD5,SLALLOC+(L'P1*2)                              
         GOTOR FRMPRD,DMCB,UBPRD6,SLALLOC+(L'P1*2)+7                            
         EDIT  (B4,UBCOST),(8,SLCOST)                                           
         EDIT  (B4,UBCDEM),(7,SLBASE),1                                         
         ICM   R1,15,UBCOST        CPM                                          
         CLI   PODRSW,YESQ         FOR POD RUNS PUT ON 30 BASIS                 
         BNE   PRTUNT10                                                         
         CLC   UBPDLEN,PODLEN                                                   
         BE    PRTUNT10                                                         
         LH    R0,PODEQU                                                        
         MR    R0,R0                                                            
         SR    RF,RF                                                            
         IC    RF,UBPDLEN                                                       
         GOTOR DIVIDE                                                           
PRTUNT10 M     R0,FW1000                                                        
         ICM   RF,15,UBCDEM                                                     
         GOTOR DIVIDE                                                           
         EDIT  (R1),(7,SLBASE+L'P1),2                                           
         TM    REQFLAG1,REQFTRGS                                                
         BZ    PRTUNT20                                                         
         SR    R3,R3                                                            
         ICM   R3,3,NTARGETS                                                    
         BZ    PRTUNT20                                                         
         CHI   R3,3                                                             
         BNH   *+8                                                              
         LHI   R3,3                ONLY 3 PRINT HERE                            
         LA    R4,UBTARGS                                                       
         LA    R6,SLTARG1                                                       
PRTUNT12 EDIT  (B4,0(R4)),(7,0(R6)),1                                           
         CLI   TRGBASE,GOALDOLS                                                 
         BNE   PRTUNT16                                                         
         ICM   R1,15,UBCOST                                                     
         CLI   PODRSW,YESQ         FOR POD RUNS PUT ON 30 BASIS                 
         BNE   PRTUNT14                                                         
         CLC   UBPDLEN,PODLEN                                                   
         BE    PRTUNT14                                                         
         LH    R0,PODEQU                                                        
         MR    R0,R0                                                            
         SR    RF,RF                                                            
         IC    RF,UBPDLEN                                                       
         GOTOR DIVIDE                                                           
PRTUNT14 M     R0,FW1000                                                        
         B     PRTUNT18                                                         
PRTUNT16 ICM   R1,15,UBCDEM                                                     
         M     R0,FW100                                                         
PRTUNT18 L     RF,0(R4)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(7,L'P1(R6)),2                                              
         AHI   R4,L'UBTARGS                                                     
         AHI   R6,8                                                             
         BCT   R3,PRTUNT12                                                      
PRTUNT20 MVC   SLNET,UBNET                                                      
         SR    R0,R0                                                            
         IC    R0,UBEST                                                         
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  SLEST,DUB                                                        
         MVI   SKIPSPEC,YESQ                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
                                                                                
         A     R5,UNTTABL                                                       
         B     PRTUNT06                                                         
                                                                                
PRTUNTX  J     EXIT                                                             
         DROP  R2,R5,RB                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Print unit variable analysis                                        *         
***********************************************************************         
                                                                                
PRTVAR   TM    DIAGNOP1,DPRTVARQ                                                
         BZR   RE                                                               
                                                                                
PRTVARN  NMOD1 0,**PRTVAR                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         LA    R1,DSUPSTRQ         UNIT PHASE                                   
         CLI   ALPHASE,ALPUNTQ                                                  
         BE    PRTVAR02                                                         
         LA    R1,DSUPBTRQ         BRAND PHASE                                  
         CLI   ALPHASE,ALPBRDQ                                                  
         BE    PRTVAR02                                                         
         LA    R1,DSUPXTRQ         EXCHANGE PHASE                               
PRTVAR02 EX    R1,*+8              TEST TO SUPPRESS TRACE                       
         BNZ   PRTVARX                                                          
         TM    DIAGNOP2,0                                                       
                                                                                
         AP    VARCNT,=P'1'                                                     
         CP    VARCNT,=P'10000'                                                 
         BH    PRTVARX                                                          
         CLI   PVMODE2,PVMODE2Q    DOING ONE ITEM - NOT HEADINGS                
         BE    PRTVAR50                                                         
PRTVAR04 MVC   P1,SPACES                                                        
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(14),=C'Product status'                                        
         MVC   P2(14),DASHES                                                    
         MVC   P1+17(8),=C'Daypart='                                            
         MVC   P1+25(1),L.GBDPT                                                 
         CLI   P1+25,ALLDPT                                                     
         BNE   *+8                                                              
         MVI   P1+25,ASTERISK                                                   
         MVC   P1+26(L'ALL3L),ALL3L                                             
         CLI   L.GBLEN,ALLLEN                                                   
         BE    PRTVAR06                                                         
         MVC   P1+26(L'PODL),PODL                                               
         CLI   L.GBLEN,0                                                        
         BE    PRTVAR06                                                         
         EDIT  (B1,L.GBLEN),(3,P1+26),ALIGN=LEFT                                
PRTVAR06 MVC   P1+30(L'WEEKL),WEEKL                                             
         MVI   P1+30+L'WEEKL,EQUAL                                              
         EDIT  (B1,WEEKNO),(2,P1+35)                                            
         MVC   P1+38(6),=C'CPP/M='                                              
         L     R1,WKCPD                                                         
         CLI   ZSPASS,ZSPYESQ                                                   
         BNE   *+8                                                              
         L     R1,AWKNZCPD                                                      
         EDIT  (R1),(7,P1+45),2                                                 
         MVC   P1+55(15),=C'Zero unit pass='                                    
         MVC   P1+70(1),ZSPASS                                                  
         CLI   PVMODE1,ALPUNTQ                                                  
         BNE   PRTVAR08                                                         
         MVC   P1+75(24),=C'**Unit selection phase**'                           
         MVC   P1+101(7),=C'LENFLT='                                            
         EDIT  (B1,WLENFLT),(3,P1+108),ZERO=NOBLANK                             
         B     PRTVAR10                                                         
PRTVAR08 CLI   PVMODE1,ALPBRDQ                                                  
         BNE   *+14                                                             
         MVC   P1+75(25),=C'**Brand selection phase**'                          
         B     PRTVAR10                                                         
         CLI   PVMODE1,ALPXCHQ                                                  
         BNE   PRTVAR10                                                         
         MVC   P1+75(24),=C'**Brand exchange phase**'                           
PRTVAR10 LARL  RE,VARHD1                                                        
         MVC   P3(L'VARHD1),0(RE)                                               
         MVC   P4(L'VARHD2),L'VARHD1(RE)                                        
         MVC   P5(L'VARHD3),L'VARHD1+L'VARHD2(RE)                               
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
                                                                                
         L     R2,AFSTBRD                                                       
         USING TABD,R2                                                          
PRTVAR12 CLI   WLENFLT,0          SKIP IF DOES NOT PASS LENGTH FILTER           
         BE    *+14                                                             
         CLC   WLENFLT,TABLEN                                                   
         BNE   PRTVAR30                                                         
         GOTOR LOCPRD,TABPRD                                                    
         MVC   P1(L'PTPRDA),PTPRDA-PTBUFFD(R1)                                  
         LA    R0,TABD                                                          
         C     R0,BESTPRD                                                       
         BNE   PRTVAR14                                                         
         CLI   PVMODE1,ALPUNTQ                                                  
         BNE   PRTVAR14                                                         
         MVI   P1+3,ASTERISK                                                    
PRTVAR14 CLI   TABPRI,YESQ                                                      
         BNE   *+8                                                              
         MVI   P1+4,C'P'                                                        
         GOTOR SETCLS,TABCLASS                                                  
         BE    PRTVAR16                                                         
         MVC   P1+5(1),CLASS1                                                   
         MVC   P1+6(1),CLASS2                                                   
PRTVAR16 MVI   P1+7,ASTERISK                                                    
         CLI   TABLEN,ALLLEN          ALL LENGTHS TOGETHER                      
         BE    PRTVAR18                                                         
         EDIT  (B1,TABLEN),(2,P1+7)   LENGTH                                    
PRTVAR18 LA    R4,P1+10                                                         
         GOTOR LOCPRD,TABPRD                                                    
         LA    R6,PTTRGS-PTBUFFD(R1)                                            
         LHI   R3,NTGVARS                                                       
PRTVAR20 EDIT  (B1,0(R6)),(2,0(R4))                                             
         AHI   R4,2                                                             
         AHI   R6,1                                                             
         BCT   R3,PRTVAR20                                                      
                                                                                
PRTVAR22 LA    R5,P1+14                                                         
         LHI   R6,3                                                             
         LA    R4,TRSCGOL-TABD(R2)                                              
         GOTOR PVEDIT                                                           
         LR    R4,R2                                                            
         AH    R4,WEEKDISP                                                      
         LHI   R6,5                                                             
         GOTOR PVEDIT                                                           
         L     R4,TABROLL                                                       
         EDIT  (R4),(9,0(R5)),FLOAT=-                                           
         AHI   R5,9                                                             
         L     R4,TABGOAL                                                       
         EDIT  (R4),(9,0(R5)),FLOAT=-                                           
         AHI   R5,9                                                             
         LR    R4,R2               CPP/M                                        
         AH    R4,WEEKDISP                                                      
         L     R1,8(R4)                                                         
         M     R0,FW1000                                                        
         L     RF,4(R4)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(9,1(R5)),2                                                 
         AHI   R5,10                                                            
         TM    REQFLAG1,REQFTRGS   TARGETS                                      
         BZ    PRTVAR28                                                         
         CLC   TABPRD,UNAPRD                                                    
         BNL   PRTVAR28                                                         
         GOTOR LOCPRD,TABPRD                                                    
         LA    R4,PTTRGS-PTBUFFD(R1)                                            
         LHI   R3,NTGVARS                                                       
PRTVAR24 SR    RF,RF                                                            
         ICM   RF,1,0(R4)                                                       
         BZ    PRTVAR26                                                         
         SLL   RF,2                                                             
         AR    RF,R2                                                            
         AH    RF,WEEKDISP                                                      
         L     R1,TABTA1-L'TABTA1-TABDATA(RF)                                   
         EDIT  (R1),(9,0(R5)),ZERO=NOBLANK                                      
PRTVAR26 AHI   R4,1                                                             
         AHI   R5,9                                                             
         BCT   R3,PRTVAR24                                                      
PRTVAR28 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
PRTVAR30 AH    R2,ROWLEN                                                        
         CLC   TABPRD,SUPPRD                                                    
         BNE   PRTVAR12                                                         
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         CLI   PVMODE1,ALPUNTQ                                                  
         BNE   PRTVAR34                                                         
PRTVAR32 MVC   P2(24),=C'Netwk Est Lin Seq  Alloc'                              
         MVC   P3(24),=C'----- --- --- ---  -----'                              
         B     PRTVAR40                                                         
                                                                                
PRTVAR34 CLI   PVMODE1,ALPBRDQ                                                  
         BNE   PRTVAR40                                                         
         MVC   P1(5),=C'Unit='                                                  
         L     R5,THISUNT                                                       
         USING UBUFFRD,R5                                                       
         MVC   P1+6(L'UBNET),UBNET                                              
         SR    R0,R0                                                            
         IC    R0,UBEST                                                         
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  P1+12(3),DUB                                                     
         EDIT  (B2,UBSEQ),(5,P1+18)                                             
         LA    RF,UBCOST                                                        
         CLI   TRGBASE,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,UBCDEM                                                        
         OC    0(4,RF),0(RF)                                                    
         BNZ   *+8                                                              
         MVI   P2+19,C'Z'          ZERO UNIT                                    
         MVC   P2(6),=C'Alloc='    FORMAT CURRENT ALLOCATIONS (6)               
         GOTOR FRMPRD,DMCB,UBPRD1,P2+6+(7*0)                                    
         GOTOR FRMPRD,DMCB,UBPRD2,P2+6+(7*1)                                    
         GOTOR FRMPRD,DMCB,UBPRD3,P2+6+(7*2)                                    
         GOTOR FRMPRD,DMCB,UBPRD4,P2+6+(7*3)                                    
         GOTOR FRMPRD,DMCB,UBPRD5,P2+6+(7*4)                                    
         GOTOR FRMPRD,DMCB,UBPRD6,P2+6+(7*5)                                    
                                                                                
PRTVAR40 LA    R4,P1+52                                                         
         LARL  R5,VARHDS                                                        
         LHI   R6,VARWGTSN                                                      
PRTVAR42 MVC   0(8,R4),0(R5)                                                    
         MVC   L'P1(8,R4),8(R5)                                                 
         MVC   L'P1*2(8,R4),16(R5)                                              
         AHI   R5,L'VARHDS                                                      
         AHI   R4,8                                                             
         BCT   R6,PRTVAR42                                                      
                                                                                
         LARL  RE,VARHDL                                                        
         MVC   0(8,R4),0(RE)                                                    
         MVC   L'P1(8,R4),8(RE)                                                 
         MVC   L'P1*2(8,R4),16(RE)                                              
         CLI   PODRSW,YESQ                                                      
         BNE   PRTVAR44                                                         
         CLI   ALPHASE,ALPBRDQ                                                  
         BNE   PRTVAR44                                                         
         AHI   R4,9                                                             
         LARL  RE,PDRHD1                                                        
         MVC   000(15,R4),0(RE)                                                 
         MVC   L'P1(15,R4),L'PDRHD1(RE)                                         
         MVC   L'P1*2(15,R4),L'PDRHD1+L'PDRHD2(RE)                              
PRTVAR44 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
PRTVAR46 MVC   P1(6),=C'Status'                                                 
         MVC   P2(6),=C'Weight'                                                 
         LA    R6,P1+52                                                         
         LA    R3,VARWGTS                                                       
         LHI   R2,VARWGTSN                                                      
PRTVAR48 CLI   VARCTLD(R3),0       TEST VARIABLE NO-OPED                        
         BE    *+10                                                             
         MVC   000+3(5,R6),=C'No-op'                                            
         L     R1,0(R3)            WEIGHT                                       
         EDIT  (R1),(8,L'P1(R6)),FLOAT=-                                        
         OI    L'P1+7(R6),ZONE                                                  
         AHI   R3,L'VARWGTS                                                     
         AHI   R6,8                                                             
         BCT   R2,PRTVAR48                                                      
         MVI   SKIPSPEC,YESQ                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         B     PRTVARX                                                          
                                                                                
PRTVAR50 CLI   PVMODE1,ALPUNTQ     UNIT PHASE                                   
         BE    PRTVAR70                                                         
         CLI   PVMODE1,ALPXCHQ     EXCHANGE PHASE                               
         BE    PRTVAR60                                                         
         L     R2,THISPRD          BRAND PHASE                                  
         MVC   P1+3(2),=C'P1='                                                  
         GOTOR LOCPRD,TABPRD                                                    
         MVC   P1+5(L'PTPRDA),PTPRDA-PTBUFFD(R1)                                
         MVI   P1+8,DASH                                                        
         SR    R0,R0                                                            
         IC    R0,TABLEN                                                        
         EDIT  (R0),(3,P1+9)                                                    
         C     R2,BESTPRD                                                       
         BNE   *+8                                                              
         MVI   P1+12,ASTERISK                                                   
         L     R5,THISUNT                                                       
         TM    UBSTAT1,UBSPRRJQ                                                 
         BZ    *+14                                                             
         MVC   P1+14(3),=C'Pri'    PRIORITY REJECT                              
         B     PRTVAR56                                                         
         TM    UBSTAT1,UBSEXRJQ                                                 
         BZ    *+14                                                             
         MVC   P1+14(4),=C'Excl'   EXCLUSION REJECT                             
         B     PRTVAR56                                                         
         TM    UBSTAT1,UBSENRJQ    ENVIRONMENT REJECT                           
         BZ    PRTVAR52                                                         
         MVC   P1+14(3),=C'Env'                                                 
         B     PRTVAR56                                                         
                                                                                
PRTVAR52 LA    R4,VARVALS                                                       
         LA    R2,P1+52                                                         
         LHI   R6,VARWGTSN                                                      
PRTVAR54 EDIT  (B4,0(R4)),(8,0(R2)),FLOAT=-                                     
         OI    7(R2),ZONE                                                       
         AHI   R4,4                                                             
         AHI   R2,8                                                             
         BCT   R6,PRTVAR54                                                      
         CLC   BRDVAL,MAXNEG                                                    
         BNE   *+14                                                             
         MVC   5(3,R2),DASHES                                                   
         B     PRTVAR56                                                         
         EDIT  (B4,BRDVAL),(8,0(R2)),FLOAT=-                                    
         OI    7(R2),ZONE                                                       
PRTVAR56 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         B     PRTVARX                                                          
                                                                                
PRTVAR60 MVC   P1(2),=C'A='        SWAP PRINT                                   
         L     R5,UNITA                                                         
         L     R4,SLOTA                                                         
         LA    R6,P1+2                                                          
         GOTOR PVSVAL                                                           
         MVC   P1+27(2),=C'B='                                                  
         L     R5,UNITB                                                         
         L     R4,SLOTB                                                         
         LA    R6,P1+29                                                         
         GOTOR PVSVAL                                                           
         MVC   P1+54(4),=C'Val='                                                
         EDIT  (B4,CURVAL),(8,P1+58),FLOAT=-                                    
         OI    P1+65,ZONE                                                       
         MVC   P1+67(5),=C'Exch='                                               
         CLC   NEWVAL,MAXNEG                                                    
         BNE   *+14                                                             
         MVC   P1+72(6),=C'Reject'                                              
         B     PRTVAR68                                                         
         EDIT  (B4,NEWVAL),(8,P1+72),FLOAT=-                                    
         OI    P1+79,ZONE                                                       
         L     RF,CURVAL                                                        
         C     RF,NEWVAL                                                        
         BH    *+8                                                              
         MVI   P1+80,ASTERISK      SWAP HAS HAPPENED                            
         TM    DIAGNOP1,DPRTCMPQ   TEST FULL PRINT                              
         BZ    PRTVAR68                                                         
                                                                                
         MVC   P2+9(2),=C'AA'                                                   
         MVC   P3+9(2),=C'BB'                                                   
         MVC   P4+9(2),=C'AB'                                                   
         MVC   P5+9(2),=C'BA'                                                   
         LA    R4,SWAPS                                                         
         LHI   R3,SWAPSN                                                        
         LA    R2,P2+42                                                         
PRTVAR64 LA    R7,SWAPN                                                         
         LR    R6,R2                                                            
PRTVAR66 EDIT  (B4,0(R4)),(8,0(R6)),FLOAT=-                                     
         OI    7(R6),ZONE                                                       
         AHI   R6,8                                                             
         AHI   R4,4                                                             
         BCT   R7,PRTVAR66                                                      
         AHI   R2,L'P1                                                          
         BCT   R3,PRTVAR64                                                      
                                                                                
PRTVAR68 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         L     RF,CURVAL           AFTER SWAP                                   
         C     RF,NEWVAL                                                        
         BL    PRTVAR04            PRINT PRODUCT TABLE                          
         B     PRTVARX                                                          
                                                                                
PRTVAR70 L     R5,THISUNT          UNIT PHASE                                   
         CLI   UBUNLEN,0           SKIP ALREADY COMPLETELY ALLOCATED            
         BE    PRTVARX                                                          
         TM    UBSTAT1,UBSZPRJQ    ZERO PASS REJECT                             
         BNZ   PRTVARX             SKIP                                         
         MVC   P1(L'UBNET),UBNET                                                
         SR    R0,R0                                                            
         IC    R0,UBEST                                                         
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  P1+6(3),DUB                                                      
         EDIT  (B2,UBSEQ),(5,P1+12)                                             
         GOTOR FRMPRD,DMCB,UBPRD1,P1+19+(7*0)                                   
         GOTOR FRMPRD,DMCB,UBPRD2,P1+19+(7*1)                                   
         GOTOR FRMPRD,DMCB,UBPRD3,P1+19+(7*2)                                   
         GOTOR FRMPRD,DMCB,UBPRD4,P1+19+(7*3)                                   
         GOTOR FRMPRD,DMCB,UBPRD5,P2+19+(7*0)                                   
         GOTOR FRMPRD,DMCB,UBPRD6,P2+19+(7*1)                                   
         C     R5,BESTUNT                                                       
         BNE   *+8                                                              
         MVI   P1+17,ASTERISK      FLAG IF BEST SO FAR                          
         TM    UBSTAT1,UBSEXRJQ    TEST ANY EXCLUSION                           
         BZ    *+12                                                             
         MVI   P1+17,C'X'                                                       
         B     PRTVAR78                                                         
         TM    UBSTAT1,UBSPRRJQ    PRIORITY REJECT                              
         BZ    *+12                                                             
         MVI   P1+17,C'P'                                                       
         B     PRTVAR78                                                         
         TM    UBSTAT1,UBSENRJQ    ENVIRONMENT REJECT                           
         BZ    *+12                                                             
         MVI   P1+17,C'E'                                                       
         B     PRTVAR78                                                         
         LA    R6,P1+52                                                         
         LA    R2,VARWGTS                                                       
         LA    R3,VARVALS                                                       
         LHI   R4,VARWGTSN                                                      
PRTVAR76 EDIT  (B4,0(R3)),(8,0(R6)),FLOAT=-                                     
         OI    7(R6),ZONE                                                       
         AHI   R2,L'VARWGTS                                                     
         AHI   R3,L'VARVALS                                                     
         AHI   R6,8                                                             
         BCT   R4,PRTVAR76                                                      
         EDIT  (B4,UNTVAL),(8,0(R6)),FLOAT=-                                    
PRTVAR78 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
PRTVARX  J     EXIT                                                             
         EJECT                                                                  
PVEDIT   EDIT  (B4,0(R4)),(9,0(R5)),FLOAT=-                                     
         OI    8(R5),ZONE                                                       
         AHI   R4,4                                                             
         AHI   R5,9                                                             
         BCT   R6,PVEDIT                                                        
         BR    RE                                                               
                                                                                
PVSVAL   NTR1  ,                                                                
         MVC   0(L'UBNET,R6),UBNET                                              
         SR    R0,R0                                                            
         IC    R0,UBEST                                                         
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  5(3,R6),DUB                                                      
         SR    R0,R0                                                            
         ICM   R0,3,UBSEQ                                                       
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  9(5,R6),DUB                                                      
         MVI   14(R6),DASH                                                      
         LA    R0,UBPRD1-UBPRDL    GET SLOT NUMBER                              
         LR    R3,R4                                                            
         SR    R3,R0                                                            
         SRL   R3,2                (THIS IS HARD CODE)                          
         CVD   R3,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  15(2,R6),DUB                                                     
         GOTOR LOCPRD,TABPRD                                                    
         MVC   18(L'PTPRDA,R6),PTPRDA-PTBUFFD(R1)                               
         SR    R1,R1                                                            
         IC    R1,L'UBPRD1(R4)                                                  
         CVD   R1,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  21(3,R6),DUB                                                     
         LA    RF,UBCOST                                                        
         CLI   TRGBASE,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,UBCDEM                                                        
         OC    0(4,RF),0(RF)                                                    
         BNZ   PVSVALX                                                          
         MVI   17(R6),C'Z'         ZERO UNIT                                    
PVSVALX  J     EXIT                                                             
         DROP  R2,R5,RB                                                         
                                                                                
VARCNT   DC    PL3'0'                                                           
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Do the allocation                                                   *         
***********************************************************************         
                                                                                
ALLOC    NMOD1 0,**ALLOC                                                        
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         MVI   FASTPOD,NOQ                                                      
         CLC   =C'**FAST',QUESTOR                                               
         BNE   *+8                                                              
         MVI   FASTPOD,YESQ        SET ON 'FASTPOD'                             
         LH    RF,NTARGETS         SET 'CELL WIDTH'                             
         SLL   RF,2                NUMBER OF TARGETS*4                          
         AHI   RF,TABTA1-TABDATA   PLUS DISP TO START OF TARGETS                
         STH   RF,CELLWID          =CELL WIDTH                                  
         LH    RF,NWKSP1                                                        
         MH    RF,CELLWID                                                       
         AHI   RF,TABDATA-TABD                                                  
         STH   RF,ROWLEN           LENGTH OF ROW                                
         A     RF,ASUPROW                                                       
         ST    RF,ATOTROW          TOTAL ROW                                    
         AH    RF,ROWLEN                                                        
         ST    RF,AFSTBRD          SET A(FIRST BRAND)                           
         GOTOR CLRBRD              CLEAR BRDTAB TO BINARY ZEROES                
         CLI   PODRSW,YESQ         FOR POD RUNS                                 
         BNE   *+8                                                              
         MVI   RWILNSW,RWILSEP     HAVE GETROW SEPARATE LENGTHS                 
         MVC   GBUFFK(GBUFFKL),L.GBUFFK START OF DAYPART/LENGTH                 
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     ALLOC04                                                          
ALLOC02  GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
ALLOC04  BZ    *+12                                                             
         MVI   GBDPT,FF                                                         
         B     *+14                                                             
         OC    GBROW(GBROWL),GBROW SKIP IF NO DATA                              
         BZ    ALLOC02                                                          
         CLC   GBDPT,L.GBDPT                                                    
         BNE   ALLOC16                                                          
         CLC   GBLEN,L.GBLEN                                                    
         BE    *+12                                                             
         CLI   PODRSW,YESQ         IF PODS NO BREAK                             
         BNE   ALLOC16                                                          
         CLC   GBPRD,SUPPRD        TEST SUPPLY                                  
         BNE   ALLOC10                                                          
         SR    RF,RF                                                            
         IC    RF,GBTYP            LINE UP OTHER SUPPLY CODES                   
         CLI   GBTYP,TPRET00Q      EXCEPT FOR TARGETS                           
         BH    ALLOC08                                                          
         AHI   RF,TACHDEMQ-TPREDEMQ                                             
         STC   RF,GBTYP                                                         
         B     ALLOC10                                                          
*                                  FOR TARGETS - LINE UP                        
ALLOC08  SHI   RF,TACHT00Q-TPRET00Q                                             
         STC   RF,GBTYP                                                         
ALLOC10  LHI   R0,TRSCGOL-TABDATA                                               
         STH   R0,CELLD                                                         
         CLI   GBTYP,TRSCGOLQ      RESCALED GOALS    (+0)                       
         BE    ALLOC14                                                          
         CLC   GBPRD,TOTPRD        SKIP TOTALS FOR PRE-ALLOCS                   
         BE    ALLOC02                                                          
         LHI   R0,TPREDEM-TABDATA                                               
         STH   R0,CELLD                                                         
         CLI   GBTYP,TPREDEMQ      ACHIEVED RATINGS  (+4)                       
         BE    ALLOC14                                                          
         LHI   R0,TPREDOL-TABDATA                                               
         STH   R0,CELLD                                                         
         CLI   GBTYP,TPREDOLQ      ACHIEVED DOLLARS  (+8)                       
         BE    ALLOC14                                                          
         LHI   R0,TPREUNT-TABDATA                                               
         STH   R0,CELLD                                                         
         CLI   GBTYP,TPREUNTQ      ACHIEVED UNITS    (+12)                      
         BE    ALLOC14                                                          
         CLI   GBTYP,TPRET01Q      TARGET PRE-ALLOCS                            
         BL    ALLOC02                                                          
         CLI   GBTYP,TACHT00Q                                                   
         BH    ALLOC02                                                          
         SR    RF,RF                                                            
         IC    RF,GBTYP                                                         
         SHI   RF,TPRET01Q                                                      
         SLL   RF,2                                                             
         AHI   RF,TABTA1-TABDATA   START OF TARGETS                             
         STH   RF,CELLD                                                         
ALLOC14  GOTOR AGETROW                                                          
         B     ALLOC02                                                          
*                                  SET TOTAL REMAINDERS AT +16                  
ALLOC16  L     R3,ATOTROW          START WITH TOTAL ROW                         
         USING TABD,R3                                                          
         L     R4,AFSTBRD          FIRST SET TOTAL ROW 'KEY'                    
         MVC   TABKEY(TABVALL),TABKEY-TABD(R4)                                  
         MVC   TABPRD,TOTPRD                                                    
         MVI   TABPRI,NOQ                                                       
         MVI   TABCLASS,0                                                       
         CLI   PODRSW,YESQ         FOR POD RUNS                                 
         BNE   ALLOC18                                                          
         MVI   TABLEN,0            TOTAL ROW IS FOR ALL LENGTHS                 
                                                                                
ALLOC18  CLC   TABPRD,SUPPRD                                                    
         BE    ALLOC26                                                          
         CLC   TABPRD,UNAPRD       FOR UNALLOCATED                              
         BNE   *+8                                                              
         MVI   TABCLASS,0          THERE IS NO CLASS                            
         L     RF,TRSCGOL          RESCALED GOAL                                
         L     R0,TPREDOL          LESS EITHER DOLLARS                          
         CLI   GOALOPT,GOALDOLS                                                 
         BE    ALLOC20                                                          
         L     R0,TPREDEM          OR DEMO VALUE                                
         TM    REQFLAG1,REQFMIXB   IF MIXED GOAL BASIS                          
         BZ    ALLOC20                                                          
         SR    RE,RE                                                            
         ICM   RE,1,TABGLDEM                                                    
         BZ    ALLOC20             AND BRAND DEMO NOT = CORPORATE               
         SLL   RE,2                                                             
         L     R0,TABTA1-L'TABTA1(RE)                                           
ALLOC20  SR    RF,R0                                                            
         ST    RF,TSAVDEM          SET REMAINDER                                
                                                                                
         MVI   TABACTWK,0          COUNT ACTIVE WEEKS FOR BRAND                 
         LH    R4,CELLWID                                                       
         LH    R7,NWKS                                                          
ALLOC22  L     RF,TRSCGOL(R4)                                                   
         LTR   RF,RF                                                            
         BZ    ALLOC24                                                          
         SR    RF,RF                                                            
         IC    RF,TABACTWK                                                      
         AHI   RF,1                                                             
         STC   RF,TABACTWK                                                      
ALLOC24  AH    R4,CELLWID          NEXT WEEK                                    
         BCT   R7,ALLOC22                                                       
         AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     ALLOC18                                                          
                                                                                
ALLOC26  LA    R1,TABD             END OF PRODUCT TABLES                        
         CLI   PODRSW,YESQ         IF POD RUN                                   
         BNE   ALLOC28                                                          
         LH    R1,PODLENSN         LEAVE ROOM FOR INDIVIDUAL LENGTH             
         MH    R1,ROWLEN           TOTAL ROWS                                   
         LA    R1,TABD+16(R1)      (16 SLACK)                                   
                                                                                
ALLOC28  GOTOR ASETENV,(R1)        SET ENVIRONMENT TABLES                       
                                                                                
         LHI   R2,1                DO ALLOCATIONS ONE WEEK AT A TIME            
ALLOC30  STC   R2,WEEKNO                                                        
         LR    RF,R2                                                            
         MH    RF,CELLWID                                                       
         AHI   RF,TABDATA-TABD                                                  
         STH   RF,WEEKDISP                                                      
                                                                                
***********************************************************************         
* Adjust for roll-ups from previous week and rescale adjusted goals - *         
* set in TABGOAL and set remainders at +16                            *         
***********************************************************************         
                                                                                
         XC    FULL,FULL                                                        
         L     R3,AFSTBRD                                                       
ALLOC32  CLC   TABPRD,SUPPRD                                                    
         BE    ALLOC38                                                          
         XC    TABGOAL,TABGOAL                                                  
         LR    R5,R3                                                            
         AH    R5,WEEKDISP                                                      
         OC    0(4,R5),0(R5)       SKIP IF NOT ACTIVE IN WEEK                   
         BZ    ALLOC36                                                          
         L     RF,TABROLL                                                       
         LTR   RF,RF                                                            
         BNM   ALLOC34             JUST ADD A NON-NEGATIVE ROLL-UP              
         L     R0,0(R5)            DON'T REDUCE GOAL BY MORE THAN HALF          
         LPR   RE,RF                                                            
         SLL   RE,1                                                             
         CR    RE,R0                                                            
         BNH   ALLOC34                                                          
         LCR   RF,R0                                                            
         SRA   RF,1                                                             
ALLOC34  A     RF,0(R5)                                                         
         ST    RF,TABGOAL                                                       
         A     RF,FULL             CUME ADJUSTED GOALS                          
         ST    RF,FULL                                                          
ALLOC36  AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     ALLOC32                                                          
                                                                                
ALLOC38  L     RF,ATOTROW          NOW RESCALE ADJUSTED GOALS                   
         AH    RF,WEEKDISP                                                      
         L     R1,0(RF)            TOTAL OF ORIGINAL RESCALED GOALS             
         M     R0,FW10000                                                       
         L     RF,FULL                                                          
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1          RESCALING FACTOR                             
                                                                                
         L     R3,AFSTBRD                                                       
ALLOC40  CLC   TABPRD,SUPPRD                                                    
         BE    ALLOC48                                                          
         LR    R5,R3                                                            
         AH    R5,WEEKDISP                                                      
         OC    0(4,R5),0(R5)       SKIP IF NOT ACTIVE                           
         BZ    ALLOC46                                                          
         L     R1,TABGOAL                                                       
         TM    REQFLAG1,REQFMIXB   DON'T RESCALE IF MIXED GOALS                 
         BNZ   ALLOC42                                                          
         M     R0,FACTOR1                                                       
         L     RF,FW10000                                                       
         GOTOR DIVIDE                                                           
         ST    R1,TABGOAL                                                       
                                                                                
ALLOC42  L     R0,8(R5)            LESS ACHIEVEMENT                             
         CLI   GOALOPT,GOALDOLS    DOLLARS                                      
         BE    ALLOC44                                                          
         L     R0,4(R5)            OR DEMO                                      
         TM    REQFLAG1,REQFMIXB   IF MIXED DEMO GOALS                          
         BZ    ALLOC44                                                          
         SR    RE,RE                                                            
         ICM   RE,1,TABGLDEM                                                    
         BZ    ALLOC44             AND BRAND DEMO NOT = CORPORATE               
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         L     R0,TABTA1-TABDATA(R5,RE) USE BRAND DEMO                          
ALLOC44  SR    R1,R0                                                            
         ST    R1,16(R5)           = REMAINDER FOR WEEK                         
                                                                                
ALLOC46  AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     ALLOC40                                                          
                                                                                
ALLOC48  GOTOR AALWEEK             DO ALLOCATION FOR THIS WEEK                  
                                                                                
***********************************************************************         
* First re-compute cumulative remainder for this week                 *         
***********************************************************************         
                                                                                
ALLOC50  CLI   RSWKOPT,NOQ         OPTION TO RESCALE BY WEEK                    
         BE    ALLOC64                                                          
         CH    R2,NWKS             DON'T DO AFTER LAST WEEK                     
         BE    ALLOC64                                                          
                                                                                
ALLOC54  L     R3,AFSTBRD                                                       
ALLOC56  CLC   TABPRD,SUPPRD                                                    
         BE    ALLOC64                                                          
         LR    R6,R3                                                            
         AH    R6,CELLWID          SKIP TOTAL WEEK                              
         AH    R6,WEEKDISP         SET NEXT WEEK FOR END CHECK                  
         LA    R5,TRSCGOL                                                       
         AH    R5,CELLWID          SKIP TOTAL WEEK                              
         SR    RF,RF                                                            
ALLOC58  CR    R5,R6               TEST THIS WEEK                               
         BNL   ALLOC62                                                          
         A     RF,0(R5)            GOAL                                         
         L     R0,8(R5)            LESS DOLLARS                                 
         CLI   GOALOPT,GOALDOLS                                                 
         BE    ALLOC60                                                          
         L     R0,4(R5)            OR DEMO                                      
         TM    REQFLAG1,REQFMIXB   IF MIXED DEMO GOALS                          
         BZ    ALLOC60                                                          
         SR    RE,RE                                                            
         ICM   RE,1,TABGLDEM                                                    
         BZ    ALLOC60             AND BRAND DEMO NOT = CORPORATE               
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         L     R0,TABTA1-TABDATA(R5,RE) USE BRAND DEMO                          
ALLOC60  SR    RF,R0                                                            
         AH    R5,CELLWID          NEXT WEEK                                    
         B     ALLOC58                                                          
ALLOC62  ST    RF,TABROLL          SET ROLLED UP REMAINDER                      
         AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     ALLOC56                                                          
                                                                                
ALLOC64  AHI   R2,1                BUMP TO NEXT WEEK                            
         CH    R2,NWKS                                                          
         BNH   ALLOC30                                                          
                                                                                
***********************************************************************         
* Put total ach rating,dollars,units in total row                     *         
***********************************************************************         
                                                                                
         LHI   R2,TABDATA-TABD     START AT TOTAL COLUMN                        
         LH    R7,NWKSP1           R7=NUMBER OF WEEKS                           
ALLOC66  L     R4,ATOTROW          TOTAL ROW                                    
         L     R3,AFSTBRD          FIRST BRAND                                  
ALLOC68  CLC   TABPRD,SUPPRD                                                    
         BE    ALLOC74                                                          
         CLC   TABPRD,UNAPRD       SKIP UNALLOCATED                             
         BE    ALLOC72                                                          
         LH    R0,CELLWID                                                       
         SRL   R0,2                CELLWID / 4 FOR BCT                          
         LA    R5,0(R3,R2)         THIS BRAND                                   
         LA    R6,0(R4,R2)         TOTAL                                        
ALLOC70  L     RF,0(R5)                                                         
         A     RF,0(R6)                                                         
         ST    RF,0(R6)                                                         
         AHI   R5,4                                                             
         AHI   R6,4                                                             
         BCT   R0,ALLOC70                                                       
ALLOC72  AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     ALLOC68                                                          
                                                                                
ALLOC74  AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R7,ALLOC66                                                       
                                                                                
         MVI   ENVNO,0             PRINT ENVIRONMENT TABLES                     
ALLOC76  SR    R7,R7                                                            
         IC    R7,ENVNO            BUMP ENVIRONMENT NUMBER                      
         AHI   R7,1                                                             
         STC   R7,ENVNO                                                         
         CLI   ENVNO,NENVS         TEST ALL DONE                                
         BH    ALLOC80                                                          
         SLL   R7,2                                                             
         L     R7,AENV1SET-L'AENV1SET(R7)                                       
         USING ENVSETD,R7                                                       
         OC    ENVSVAR,ENVSVAR     IS VARIABLE ACTIVE                           
         BNZ   ALLOC78             YES - PRINT                                  
         CLI   ENVNO,ENVNPGMQ      ELSE SKIP UNLESS ENVIRONMENT 1               
         BNE   ALLOC76                                                          
         CLI   PINTRVL,0           AND TIMER INTERVALS ACTIVE                   
         BNE   ALLOC78                                                          
         CLI   CINTRVL,0                                                        
         BE    ALLOC76                                                          
ALLOC78  MVI   PEMODE,0            DO POST ALLOCATION ENV COUNTERS              
         GOTOR APRTENV             PRINT ENVIRONMENT TABLES TRACE               
         OI    PEMODE,PEMPSTQ      ALSO DO ACTUAL COUNTS                        
         GOTOR APRTENV                                                          
         B     ALLOC76                                                          
         DROP  R7                                                               
                                                                                
ALLOC80  L     R3,AFSTBRD                                                       
ALLOC82  CLC   TABPRD,SUPPRD                                                    
         BE    ALLOC84                                                          
         GOTOR DPTADJ                                                           
         AH    R3,ROWLEN                                                        
         B     ALLOC82                                                          
                                                                                
***********************************************************************         
* Before writing achievements back to buffer set total rows for       *         
* individual lengths                                                  *         
***********************************************************************         
                                                                                
ALLOC84  CLI   PODRSW,YESQ         ONLY IF POD RUN                              
         BNE   ALLOC102                                                         
*                                  FIRST SET ROW HEADERS                        
         ST    R3,FULL             SAVE A FIRST LENGTH TOTAL ROW                
         LA    R2,PODLENS          LIST OF LENGTHS                              
         LH    R1,PODLENSN         COUNT                                        
         L     R4,ATOTROW                                                       
ALLOC86  MVC   TABD(TABDATA-TABD),0(R4)                                         
         MVC   TABLEN,0(R2)        SET LENGTH                                   
         AH    R3,ROWLEN           NEXT ROW                                     
         AHI   R2,L'PODLENS        NEXT LENGTH                                  
         BCT   R1,ALLOC86                                                       
         MVC   TABPRD,SUPPRD                                                    
                                                                                
***********************************************************************         
* Put total ach rating,dollars,units in total row                     *         
***********************************************************************         
                                                                                
         LHI   R2,TABDATA-TABD     START AT TOTAL COLUMN                        
         LH    R7,NWKSP1           FOR WEEK BCT                                 
ALLOC88  L     R3,AFSTBRD          FIRST BRAND                                  
ALLOC90  CLC   TABPRD,TOTPRD       END (START OF LENGTH TOTAL ROWS)             
         BE    ALLOC100                                                         
         CLC   TABPRD,UNAPRD       SKIP UNALLOCATED                             
         BE    ALLOC98                                                          
         LA    RF,PODLENS          FIND LENGTH IN LIST                          
         LH    R0,PODLENSN                                                      
ALLOC92  CLC   TABLEN,0(RF)                                                     
         BE    *+14                                                             
         AHI   RF,L'PODLENS                                                     
         BCT   R0,ALLOC92                                                       
         DC    H'0'                LENGTH MISSING                               
         LA    R0,PODLENS          DISPLACEMENT IN LIST                         
         SR    RF,R0               IS INDEX TO ROW                              
         MH    RF,ROWLEN                                                        
         A     RF,FULL             POINT TO RIGHT LENGTH TOT ROW                
         LR    R4,RF                                                            
         LH    R0,CELLWID                                                       
         SRL   R0,2                CELLWID / 4 FOR BCT                          
         LA    R5,0(R3,R2)         THIS BRAND                                   
         LA    R6,0(R4,R2)         TOTAL                                        
ALLOC96  L     RF,0(R5)                                                         
         A     RF,0(R6)                                                         
         ST    RF,0(R6)                                                         
         AHI   R5,4                                                             
         AHI   R6,4                                                             
         BCT   R0,ALLOC96                                                       
ALLOC98  AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     ALLOC90                                                          
ALLOC100 AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R7,ALLOC88                                                       
                                                                                
ALLOC102 LHI   R0,TPREDEM-TABDATA  WRITE TOTALS BACK TO BUFFER                  
         STH   R0,CELLD                                                         
         MVI   TYP,TACHDEMQ        RATING                                       
         GOTOR APUTROW                                                          
         LHI   R0,TPREDOL-TABDATA                                               
         STH   R0,CELLD                                                         
         MVI   TYP,TACHDOLQ        DOLLARS                                      
         GOTOR APUTROW                                                          
         LHI   R0,TPREUNT-TABDATA                                               
         STH   R0,CELLD                                                         
         MVI   TYP,TACHUNTQ                                                     
         GOTOR APUTROW                                                          
         TM    REQFLAG1,REQFTRGS   TARGETS                                      
         BZ    ALLOC106                                                         
                                                                                
         LHI   R0,TABTA1-TABDATA   STARTING CELL                                
         STH   R0,CELLD                                                         
         LH    R0,NTARGETS                                                      
         MVI   TYP,TACHT01Q        STARTING TYPE                                
ALLOC104 GOTOR APUTROW                                                          
         LH    R1,CELLD            BUMP CELL DISPLACEMENT                       
         AHI   R1,L'TABTA1                                                      
         STH   R1,CELLD                                                         
         SR    R1,R1                                                            
         IC    R1,TYP              BUMP TYPE                                    
         AHI   R1,1                                                             
         STC   R1,TYP                                                           
         BCT   R0,ALLOC104                                                      
                                                                                
ALLOC106 MVC   GBUFFK(GBUFFKL),S.GBUFFK RESET BUFFER 'KEY'                      
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         MVI   RWILNSW,RWILTOG     RESET GETROW TO LUMP LENGTH                  
                                                                                
ALLOCX   J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Roll daypart remainders forward                                     *         
***********************************************************************         
                                                                                
DPTADJ   NTR1  ,                                                                
         CLI   DSSW,YESQ           SKIP IF NO DAYPART RESCALING                 
         BNE   DPTADJX                                                          
         TM    REQFLAG1,REQFMIXB   OR MIXED DEMO GOALS                          
         BNZ   DPTADJX                                                          
         OC    TSAVDEM,TSAVDEM     NO REMAINDER TO ROLL                         
         BZ    DPTADJX                                                          
         MVC   GBUFFK(L'GBDPT+L'GBLEN),L.GBDPT                                  
         MVI   GBUFFK+L'GBDPT+L'GBLEN,FF                                        
         GOTOR BU1RDH              READ HIGH TO GET NEXT LENGTH                 
         B     DPTADJ04                                                         
DPTADJ02 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
DPTADJ04 BNZ   DPTADJX                                                          
         OC    GBROW(GBROWL),GBROW SKIP IF ALL VALUES NULL                      
         BZ    DPTADJ02                                                         
         CLI   GBTYP,TRSCGOLQ      LOOK FOR RESCALED GOALS                      
         BNE   DPTADJ02                                                         
         CLC   GBDPT,L.GBDPT                                                    
         BNE   DPTADJ06                                                         
         CLC   GBLEN,L.GBLEN                                                    
         BE    DPTADJ02                                                         
         CLI   PODRSW,YESQ         IF PODS, SKIP                                
         BE    DPTADJ02                                                         
DPTADJ06 CLC   TABPRD,GBPRD        TEST CORRECT PRODUCT                         
         BNE   DPTADJ02                                                         
         MVC   FULL,GBTOT                                                       
         L     R1,FULL                                                          
         L     RF,TSAVDEM          HOLD REMAINDER                               
         ST    RF,DUB                                                           
         XC    TSAVDEM,TSAVDEM     CLEAR REMAINDER                              
                                                                                
***********************************************************************         
* Don't adjust coming dpts goal by more than half                     *         
***********************************************************************         
                                                                                
         LPR   RF,RF               REMAINDER                                    
         SLL   RF,1                X 2                                          
         C     RF,FULL             COMPARE TO GOAL                              
         BNH   DPTADJ08            NOT MORE THAN HALF                           
         L     RF,FULL             GOAL                                         
         SRL   RF,1                / 2                                          
         L     RE,DUB              REMAINDER                                    
         LTR   RE,RE               IF REMAINDER -VE - ADD 1/2 OF GOAL           
         BNP   *+6                 TO REMAINDER                                 
         LCR   RF,RF               ELSE SUBTRACT                                
         AR    RE,RF                                                            
         ST    RE,TSAVDEM          SAVE ADDITIONAL REMAINDER                    
         LCR   RF,RF               REVERSE FOR GOAL ADJUSTMENT                  
         ST    RF,DUB                                                           
DPTADJ08 A     R1,DUB                                                           
         M     R0,FW10000                                                       
         L     RF,FULL                                                          
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1                                                       
                                                                                
         LA    R5,GBTOT                                                         
         LH    R7,NWKSP1                                                        
DPTADJ10 L     R1,0(R5)                                                         
         M     R0,FACTOR1                                                       
         L     RF,FW10000                                                       
         GOTOR DIVIDE                                                           
         S     R1,0(R5)            REMOVE EXISTING NUMBER SO                    
         ST    R1,0(R5)            BUFFERIN WILL REPLACE NOT ADD                
         AHI   R5,L'GBTOT                                                       
         BCT   R7,DPTADJ10                                                      
                                                                                
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
         MVI   PBMODE,PBMDRUQ                                                   
         GOTOR APRTBUF                                                          
         MVI   PBMODE,0                                                         
                                                                                
DPTADJ12 OC    TSAVDEM,TSAVDEM     ANY MORE REMAINDER                           
         BNZ   DPTADJ02            YES                                          
                                                                                
DPTADJX  J     EXIT                                                             
         DROP  R3,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Set environment counter tables                                      *         
***********************************************************************         
                                                                                
SETENV   NMOD1 0,**SETENV                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     RF,AENV1SET         FIRST COUNT ENV1 TABLE ENTRIES               
         L     RF,ENVSATAB-ENVSETD(RF)                                          
         SR    R0,R0                                                            
         CLI   0(RF),ENVSEOTQ      TEST END                                     
         BE    *+16                                                             
         AHI   R0,1                                                             
         AHI   RF,ENVS1LEN                                                      
         B     *-16                                                             
         ST    R0,ENV1CNT                                                       
                                                                                
         MVI   ENVNO,0             SET ENVIRONMENT TABLES                       
SETENV02 SR    R8,R8                                                            
         IC    R8,ENVNO            BUMP ENVIRONMENT NUMBER                      
         AHI   R8,1                                                             
         STC   R8,ENVNO                                                         
         CLI   ENVNO,NENVS         TEST ALL DONE                                
         BH    SETENV68                                                         
         SLL   R8,2                                                             
         L     R8,AENV1SET-L'AENV1SET(R8)                                       
         USING ENVSETD,R8                                                       
                                                                                
         AHI   R1,15              SET START OF ENVIRONMENT TABLE                
         SRL   R1,3               (R1) POINTS TO WHERE TABLE CAN START          
         SLL   R1,3               SKIP 8 AND DOUBLE WORD ALIGN                  
         MVC   0(8,R1),=C'*ENCNTS*'                                             
         MVC   2(1,R1),ENVNO                                                    
         OI    2(R1),ZONE                                                       
         AHI   R1,8                                                             
         ST    R1,ENVSACNT                                                      
         ST    R1,ENVSACTC         PRETEND HAVE ACTUAL COUNT TABLE              
*                                  (SAME AS ENVSACNT EXCEPT FOR PODS)           
*                                  (SAVES CHECKING AT SETENV34)                 
         SR    R2,R2                                                            
         OC    ENVSVAR,ENVSVAR     SKIP IF VARIABLE NOT ACTIVE                  
         BNZ   SETENV04                                                         
         CLI   ENVNO,ENVNPGMQ      BUT WILL NEED ENVIRONMENT 1                  
         BNE   SETENV34                                                         
         CLI   PINTRVL,0           IF TIME INTERVAL CHECK ACTIVE                
         BNE   SETENV04                                                         
         CLI   CINTRVL,0                                                        
         BE    SETENV34                                                         
                                                                                
SETENV04 L     RE,ACLSTRT                                                       
         MVI   0(RE),FF            INITIALIZE CLASS TRANSLATION                 
         MVC   1(L'CLSTRT-1,RE),0(RE)                                           
                                                                                
         L     RE,PRDBUFF          INITIALIZE PRODUCT TRANSLATION               
         LH    R0,HIGHPRDN                                                      
         MVI   PTENVSEQ-PTBUFFD(RE),PTENVSNC                                    
         AH    RE,PRDBUFLN                                                      
         BCT   R0,*-8                                                           
                                                                                
         SR    R2,R2               START WITH PRODUCT SEQUENCE 0                
         L     R3,AFSTBRD                                                       
         USING TABD,R3                                                          
SETENV06 CLC   TABPRD,SUPPRD                                                    
         BE    SETENV10                                                         
         OC    TRSCGOL(L'TRSCGOL+L'TPREDEM+L'TPREDOL),TRSCGOL                   
         BZ    SETENV08                                                         
         GOTOR LOCPRD,TABPRD                                                    
         CLI   PTENVSEQ-PTBUFFD(R1),PTENVSNC                                    
         BNE   SETENV08                                                         
         STCM  R2,3,PTENVSEQ-PTBUFFD(R1)                                        
         AHI   R2,1                                                             
SETENV08 AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     SETENV06                                                         
                                                                                
SETENV10 ST    R2,ENVPCNT          COUNT OF PRODUCTS                            
                                                                                
         CLI   CINTRVL,0           TEST NEED CLASSES                            
         BE    SETENV16                                                         
         L     R3,AFSTBRD                                                       
SETENV12 CLC   TABPRD,SUPPRD                                                    
         BE    SETENV16                                                         
         OC    TRSCGOL,TRSCGOL     ONLY ACTIVES                                 
         BZ    SETENV14                                                         
         GOTOR SETCLS,TABCLASS                                                  
         BE    SETENV14            NO CLASS                                     
         SR    RF,RF               FIRST CLASS SHOULD BE SET                    
         IC    RF,CLASS1                                                        
         A     RF,ACLSTRT                                                       
         CLI   0(RF),FF            ALREADY COUNTED                              
         BNE   *+12                                                             
         STC   R2,0(RF)            SET POSITION CODE                            
         AHI   R2,1                                                             
         SR    RF,RF                                                            
         ICM   RF,1,CLASS2         SECOND MAY BE ZERO                           
         BZ    SETENV14                                                         
         A     RF,ACLSTRT                                                       
         CLI   0(RF),FF            ALREADY COUNTED                              
         BNE   SETENV14                                                         
         STC   R2,0(RF)            SET POSITION CODE                            
         AHI   R2,1                                                             
SETENV14 AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     SETENV12                                                         
         DROP  R3                                                               
                                                                                
SETENV16 ST    R2,ENVTCNT          COUNT OF PRODUCTS + CLASSES                  
         LR    RF,R2                                                            
         S     RF,ENVPCNT          LESS PRODUCT COUNT                           
         ST    RF,ENVCCNT          = COUNT OF CLASSES                           
         LTR   R2,R2                                                            
         BZ    SETENV34            NO PRODUCTS/CLASSES                          
                                                                                
         LH    RF,NWKSP1                                                        
         SLL   RF,1                2 BYTES PER WEEK                             
         STH   RF,ENVPRDD          DISPLACEMENT FOR PRODUCT/CLASS               
         MH    R2,ENVPRDD                                                       
         STH   R2,ENVENVD          DISPLACEMENT FOR ENVIRONMENT CODE            
                                                                                
         L     R0,ENVSATOT         CLEAR UNIT COUNTS                            
         L     R1,ENVSLTOT                                                      
         GOTOR CLEAR                                                            
                                                                                
         LA    R0,ENVSTTAB         INITIALIZE TRANSLATION TABLE                 
         L     R1,ENVSMAXN                                                      
         MHI   R1,L'ENVSTTAB                                                    
         SR    RE,RE                                                            
         LHI   RF,FF                                                            
         SLL   RF,24                                                            
         MVCL  R0,RE                                                            
                                                                                
***********************************************************************         
* For env 1 on POD run also need actual count table                   *         
***********************************************************************         
                                                                                
         CLI   PODRSW,YESQ                                                      
         BNE   SETENV20                                                         
         CLI   ENVNO,ENVNPGMQ                                                   
         BNE   SETENV20                                                         
                                                                                
***********************************************************************         
* Note: allow maximum size for E1CNTS else would have to read         *         
* units again                                                         *         
***********************************************************************         
                                                                                
         L     RF,ENV1CNT          PUT AFTER REG COUNT TABLE                    
         MH    RF,ENVENVD                                                       
         A     RF,ENVSACNT                                                      
         AHI   RF,15               SKIP 8 AND DOUBLE WORD ALIGN                 
         SRL   RF,3                                                             
         SLL   RF,3                                                             
         MVC   0(8,RF),=C'*EN1UCT*'                                             
         AHI   RF,8                                                             
         ST    RF,ENVSACTC                                                      
                                                                                
W        USING UBUFFRD,WORK2       NOW READ UNITS AND POST                      
SETENV20 XC    W.UBUFFK(UBUFFKL),W.UBUFFK                                       
         MVC   W.UBDPT(L'GBDPT+L'GBLEN),L.GBDPT                                 
         CLI   PODRSW,YESQ         IF POD RUN                                   
         BNE   *+8                                                              
         MVI   W.UBLEN,0           GET ALL FOR DAYPART                          
         SR    R2,R2                                                            
         GOTOR BU2RDH,W.UBUFFRD    READ HIGH BUFFER 2                           
         B     SETENV24                                                         
                                                                                
SETENV22 GOTOR BU2RSQ,W.UBUFFRD    READ SEQUENTIAL BUFFER 2                     
SETENV24 BNZ   SETENV34                                                         
                                                                                
         CLC   W.UBDPT,L.GBDPT                                                  
         BNE   SETENV34                                                         
         CLC   W.UBLEN,L.GBLEN                                                  
         BE    *+12                                                             
         CLI   PODRSW,YESQ         ALL FOR DAYPART IF POD RUN                   
         BNE   SETENV34                                                         
         SR    RF,RF                                                            
         IC    RF,ENVNO                                                         
         SLL   RF,1                                                             
         LH    RF,W.UBENV1-L'UBENV1(RF)                                         
         SLL   RF,1                                                             
         LA    RF,ENVSTTAB(RF)     POINT TO TOTAL COUNTERS                      
         CLC   0(2,RF),EFFS        TEST ALREADY USED                            
         BNE   *+12                                                             
         STCM  R2,3,0(RF)          NO - SET NEW TRANS NUMBER                    
         AHI   R2,1                                                             
                                                                                
         SR    R6,R6               BUMP NUMBER OF UNITS - TOTAL                 
         ICM   R6,3,0(RF)                                                       
         MHI   R6,(MAXWEEKS+1)*2                                                
         A     R6,ENVSATOT         POINTS TO COUNTERS FOR THIS ENV              
         LH    RF,0(R6)                                                         
         GOTOR GETEQV              GET EQUIV UNITS IN R1                        
         AR    RF,R1                                                            
         STH   RF,0(R6)                                                         
                                                                                
         SR    RF,RF               BUMP UNITS FOR WEEK                          
         IC    RF,W.UBWEEK         WEEK IS ADDITIONAL DISPLACEMENT              
         SLL   RF,1                                                             
         AR    R6,RF                                                            
         LH    RF,0(R6)                                                         
         AR    RF,R1               BUMP BY EQUIV UNITS                          
         STH   RF,0(R6)                                                         
                                                                                
         OC    W.UBPRD1,W.UBPRD1   TEST PRE-ALLOCATED                           
         BZ    SETENV22                                                         
         GOTOR LOCPRD,W.UBPRD1                                                  
         CLI   PTENVSEQ-PTBUFFD(R1),PTENVSNC                                    
         BE    SETENV22                                                         
         SR    RE,RE                                                            
         ICM   RE,3,PTENVSEQ-PTBUFFD(R1)                                        
         OC    ENVSVAR,ENVSVAR     TEST VARIABLE ACTIVE                         
         BNZ   SETENV26                                                         
         CLI   ENVNO,ENVNPGMQ      BUT WILL NEED ENVIRONMENT 1                  
         BNE   SETENV22                                                         
         CLI   PINTRVL,0           IF TIME INTERVAL CHECK ACTIVE                
         BNE   SETENV26                                                         
         CLI   CINTRVL,0                                                        
         BE    SETENV22                                                         
                                                                                
SETENV26 MH    RE,ENVPRDD          X DISPLACEMENT FOR A PRODUCT                 
         SR    R6,R6                                                            
         IC    R6,ENVNO            POINT TO RIGHT ENVIRONMENT CODE              
         SLL   R6,1                                                             
         LH    R6,W.UBENV1-L'UBENV1(R6)                                         
         SLL   R6,1                                                             
         LH    RF,ENVSTTAB(R6)                                                  
         MH    RF,ENVENVD          DISPLACEMENT FOR AN ENVIRONMENT              
         AR    RF,RE               TOTAL DISPLACEMENT                           
         LR    R6,RF               SAVE TOTAL DISPLACEMENT                      
         A     RF,ENVSACNT         PLUS START OF TABLE                          
         GOTOR GETEQV              GET EQUIV UNITS IN R1                        
         LH    RE,0(RF)            BUMP PRE COUNTER - TOTAL                     
         AR    RE,R1               BUMP BY EQUIV UNITS                          
         STH   RE,0(RF)                                                         
         SR    RE,RE                                                            
         IC    RE,W.UBWEEK         AND FOR WEEK                                 
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    RF,RE                                                            
         LH    RE,0(RF)                                                         
         AR    RE,R1               BUMP BY EQUIV UNITS                          
         STH   RE,0(RF)                                                         
                                                                                
         CLI   PODRSW,YESQ         FOR POD RUN                                  
         BNE   SETENV28                                                         
         CLI   ENVNO,ENVNPGMQ      IF ENVIRONMENT 1                             
         BNE   SETENV28                                                         
*                                  DO 'ACTUAL' COUNTS ALSO                      
         LR    RF,R6               TOTAL DISPLACEMENT                           
         A     RF,ENVSACTC                                                      
         LH    RE,0(RF)            BUMP TOTAL COUNTER                           
         AHI   RE,10               1.0 UNITS                                    
         STH   RE,0(RF)                                                         
                                                                                
         SR    RE,RE                                                            
         IC    RE,W.UBWEEK         AND WEEK COUNTER                             
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    RF,RE                                                            
         LH    RE,0(RF)                                                         
         AHI   RE,10               1.0 UNITS                                    
         STH   RE,0(RF)                                                         
*                                  NOW DO CLASS                                 
SETENV28 CLI   CINTRVL,0           DON'T NEED CLASSES                           
         BE    SETENV22                                                         
         CLI   ENVNO,ENVNPGMQ      CLASSES ONLY FOR ENVIRONMENT 1               
         BNE   SETENV22                                                         
         GOTOR LOCPRD,W.UBPRD1                                                  
         AHI   R1,PTCLASS-PTBUFFD                                               
         GOTOR SETCLS                                                           
         BE    SETENV22            NO CLASS                                     
                                                                                
SETENV30 SR    RF,RF                                                            
         ICM   RF,1,CLASS1                                                      
         BZ    SETENV32            NO CLASS                                     
         A     RF,ACLSTRT                                                       
         SR    RE,RE                                                            
         IC    RE,0(RF)                                                         
         MH    RE,ENVPRDD          DISPLACEMENT FOR PRODUCT/CLASS               
         SR    R6,R6                                                            
         IC    R6,ENVNO            POINT TO RIGHT ENVIRONMENT CODE              
         SLL   R6,1                                                             
         LH    R6,W.UBENV1-L'UBENV1(R6)                                         
         SLL   R6,1                                                             
         LH    RF,ENVSTTAB(R6)                                                  
         MH    RF,ENVENVD          DISPLACEMENT FOR ENVIRONMENT CODE            
         AR    RF,RE                                                            
         LR    R6,RF               SAVE TOTAL DISPLACEMENT                      
         A     RF,ENVSACNT         PLUS START OF TABLE                          
         GOTOR GETEQV              GET EQUIV UNITS IN R1                        
         LH    RE,0(RF)            BUMP PRE COUNTER - TOTAL                     
         AR    RE,R1               BUMP BY EQUIV UNITS                          
         STH   RE,0(RF)                                                         
                                                                                
         SR    RE,RE                                                            
         IC    RE,W.UBWEEK         AND FOR WEEK                                 
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    RF,RE                                                            
         LH    RE,0(RF)                                                         
         AR    RE,R1               BUMP BY EQUIV UNITS                          
         STH   RE,0(RF)                                                         
                                                                                
         CLI   PODRSW,YESQ         FOR POD RUN                                  
         BNE   SETENV32                                                         
         CLI   ENVNO,ENVNPGMQ      IF ENVIRONMENT 1                             
         BNE   SETENV32                                                         
*                                  DO 'ACTUAL' COUNTS ALSO                      
         LR    RF,R6               TOTAL DISPLACEMENT                           
         A     RF,ENVSACTC                                                      
         LH    RE,0(RF)            BUMP TOTAL COUNTER                           
         AHI   RE,1                                                             
         STH   RE,0(RF)                                                         
                                                                                
         SR    RE,RE                                                            
         IC    RE,W.UBWEEK         AND WEEK COUNTER                             
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    RF,RE                                                            
         LH    RE,0(RF)                                                         
         AHI   RE,1                                                             
         STH   RE,0(RF)                                                         
                                                                                
SETENV32 CLI   CLASS2,0            TEST NEED TO DO 2ND OF 2 PART CLASS          
         BE    SETENV22            NO                                           
         MVC   CLASS1,CLASS2                                                    
         MVI   CLASS2,0                                                         
         B     SETENV30                                                         
                                                                                
SETENV34 ST    R2,ENVSWCNT         COUNT OF ENVIRONMENTS                        
         MH    R2,ENVENVD                                                       
         ST    R2,ENVSTLEN         LENGTH OF ENVIRONMENT TABLE                  
         A     R2,ENVSACTC                                                      
*                                  SET START OF ENV1 SHARES TABLE               
         AHI   R2,15               SKIP 8 AND DOUBLE WORD ALIGN                 
         SRL   R2,3                                                             
         SLL   R2,3                                                             
         MVC   0(8,R2),=C'*ENSHRS*'                                             
         MVC   2(1,R2),ENVNO                                                    
         OI    2(R2),ZONE                                                       
         AHI   R2,8                                                             
         ST    R2,ENVSASHR                                                      
                                                                                
SETENV36 OC    ENVSWCNT,ENVSWCNT   NOW SET PRODUCT/CLASS UNIT SHARES            
         BZ    SETENV66                                                         
         SR    R3,R3               PRODUCT/CLASS NUMBER                         
                                                                                
SETENV38 XC    WORK2(256),WORK2    SET %'AGES FOR PRODUCT/CLASS                 
                                                                                
         C     R3,ENVPCNT          TEST PRODUCT OR CLASS                        
         BNL   SETENV40                                                         
                                                                                
         L     RF,PRDBUFF          FIND PRODUCT                                 
         LH    R0,HIGHPRDN                                                      
         CLM   R3,3,PTENVSEQ-PTBUFFD(RF)                                        
         BE    *+14                                                             
         AH    RF,PRDBUFLN                                                      
         BCT   R0,*-12                                                          
         DC    H'0'                                                             
         STCM  RF,PRDMSKQ,FULL     SET PRODUCT                                  
         B     SETENV42                                                         
                                                                                
SETENV40 L     RF,ACLSTRT                                                       
         LHI   R0,L'CLSTRT                                                      
         CLM   R3,1,0(RF)          FIND CLASS                                   
         BE    *+14                                                             
         AHI   RF,1                                                             
         BCT   R0,*-12                                                          
         DC    H'0'                                                             
         S     RF,ACLSTRT                                                       
         STC   RF,FULL             SET CLASS                                    
                                                                                
SETENV42 L     R4,AFSTBRD          SCAN PRODUCT TABLES                          
         USING TABD,R4                                                          
                                                                                
SETENV44 CLC   TABPRD,SUPPRD       TEST SUPPLY                                  
         BE    SETENV54                                                         
                                                                                
         C     R3,ENVPCNT          TEST PRODUCT OR CLASS                        
         BNL   SETENV46                                                         
         CLC   TABPRD,FULL         TEST PRODUCT MATCH                           
         BE    SETENV48                                                         
         B     SETENV52                                                         
                                                                                
SETENV46 CLC   TABCLASS,FULL       TEST VS PRODUCT CLASS                        
         BE    SETENV48                                                         
         GOTOR SETCLS,TABCLASS                                                  
         BH    SETENV52                                                         
         CLC   CLASS1,FULL                                                      
         BE    SETENV48                                                         
         CLC   CLASS2,FULL                                                      
         BNE   SETENV52                                                         
                                                                                
SETENV48 LH    R5,NWKSP1           ADD INTO WORK2                               
         LA    R6,WORK2                                                         
         LA    R7,TRSCGOL                                                       
SETENV50 L     RF,0(R6)                                                         
         A     RF,0(R7)                                                         
         ST    RF,0(R6)                                                         
         AH    R7,CELLWID                                                       
         AHI   R6,4                                                             
         BCT   R5,SETENV50                                                      
                                                                                
SETENV52 AH    R4,ROWLEN           NEXT PRODUCT                                 
         B     SETENV44                                                         
                                                                                
SETENV54 LH    R5,NWKSP1           SET PERCENTAGES                              
         LA    R6,WORK2                                                         
         L     R4,ATOTROW                                                       
         LA    R4,TRSCGOL          START AT TOTAL COLUMN                        
SETENV56 L     R1,0(R6)                                                         
         M     R0,FW100                                                         
         L     RF,0(R4)                                                         
         GOTOR DIVIDE                                                           
         ST    R1,0(R6)                                                         
         AHI   R6,4                                                             
         AH    R4,CELLWID                                                       
         BCT   R5,SETENV56                                                      
                                                                                
         SR    R2,R2               R2=ENVIRONMENT NUMBER                        
SETENV58 LR    R7,R2               SET UNIT SHARES FOR 1 ENV + PRD/CLS          
         MHI   R7,((MAXWEEKS+1)*2)                                              
         A     R7,ENVSATOT         POINT TO COUNTERS FOR THIS ENV               
         AHI   R7,2                START AT WEEK 1                              
         L     R6,ENVSASHR         START OF SHARES                              
         LR    RF,R2               ENVIRONMENT DISPLACEMENT                     
         MH    RF,ENVENVD                                                       
         LR    RE,R3               PRODUCT/CLASS DISPLACEMENT                   
         MH    RE,ENVPRDD                                                       
         AR    R6,RF                                                            
         AR    R6,RE               R6 NOW POINTS TO PROPER COUNTERS             
         ST    R6,DUB              SAVE COUNTER ADDRESS                         
         AHI   R6,2                POINT TO WEEK 1                              
         LH    R5,NWKS                                                          
         LA    R4,WORK2+4          PERCENTS ARE IN WORK2+4 (WK 1 AT +4)         
         LHI   RF,100              DIVISOR                                      
         XC    FULL,FULL           FOR UNROUNDED SUM                            
SETENV60 LH    R1,0(R7)                                                         
         LTR   R1,R1                                                            
         BNP   SETENV62                                                         
         ICM   RE,15,0(R4)         TEST ANY PERCENT                             
         BZ    SETENV62                                                         
         MR    R0,RE               X PERCENT                                    
         LR    RE,R1                                                            
         A     RE,FULL             SUM UNROUNDED SHARES                         
         ST    RE,FULL                                                          
         GOTOR DIVIDE              / DIVISOR                                    
         CHI   R1,10               TEST VS MINIMUM SHARE                        
         BNL   *+8                                                              
         LHI   R1,10               SHARE MUST BE AT LEAST MINIMUM               
         STH   R1,0(R6)                                                         
SETENV62 AHI   R4,4                NEXT PERCENT                                 
         AHI   R6,2                NEXT WEEK                                    
         AHI   R7,2                                                             
         BCT   R5,SETENV60                                                      
*                                  NOW SET TOTAL                                
         ICM   R1,15,FULL          UNROUNDED SUM                                
         BZ    SETENV64                                                         
         M     R0,FW1                                                           
         GOTOR DIVIDE              ROUND                                        
         CHI   R1,10               TEST VS MINIMUM SHARE                        
         BNL   *+8                                                              
         LHI   R1,10               SHARE MUST BE AT LEAST MINIMUM               
         L     RF,DUB                                                           
         STH   R1,0(RF)                                                         
                                                                                
SETENV64 AHI   R2,1                NEXT ENVIRONMENT                             
         C     R2,ENVSWCNT         TEST DONE                                    
         BL    SETENV58                                                         
         AHI   R3,1                NEXT PRODUCT/CLASS                           
         C     R3,ENVTCNT          TEST DONE                                    
         BL    SETENV38                                                         
                                                                                
SETENV66 MVI   PEMODE,PEMPREQ      PRE-ALLOCATIONS                              
         GOTOR APRTENV             PRINT ENVIRONMENT TABLES                     
         OI    PEMODE,PEMPSTQ      ALSO ACTUAL COUNTS                           
         GOTOR APRTENV                                                          
         L     R1,ENVSTLEN                                                      
         A     R1,ENVSASHR         POINT TO NEXT AREA                           
         B     SETENV02                                                         
                                                                                
SETENV68 AHI   R1,15               SET START OF UNIT TABLE                      
         SRL   R1,3                SKIP 8 AND DOUBLE WORD ALIGN                 
         SLL   R1,3                                                             
         MVC   0(8,R1),=C'*UNTTAB*'                                             
         AHI   R1,8                                                             
         ST    R1,AUNTTAB                                                       
                                                                                
SETENVX  J     EXIT                                                             
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Get equiv units in R1                                               *         
***********************************************************************         
                                                                                
GETEQV   LHI   R1,10               1.0 UNITS                                    
         CLI   PODRSW,YESQ         TEST POD RUN                                 
         BNER  RE                                                               
         CLC   W.UBPDLEN,PODLEN    TEST HAVE EQUIV BASE                         
         BER   RE                                                               
         SR    R1,R1                                                            
         IC    R1,W.UBPDLEN                                                     
         M     R0,FW10                                                          
         XC    FULL,FULL           AVOID FINDING A REGISTER TO USE              
         MVC   FULL+L'FULL-L'PODLEN(L'PODLEN),PODLEN                            
         D     R0,FULL                                                          
         BR    RE                                                               
         DROP  R8,RB,W                                                          
                                                                                
ENV1CNT  DS    F                   TOTAL COUNT OF ENVIRONMENT 1'S               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Module to allocate one week                                         *         
***********************************************************************         
                                                                                
ALWEEK   NMOD1 0,**ALWEEK,R8                                                    
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         GOTOR AAWKINI             INITIALIZE FOR WEEK ALLOCATION               
         SR    RF,RF                                                            
         ICM   RF,3,AWKAPRDS       TEST ANY ACTIVE BRANDS                       
         BZ    ALWEEK96                                                         
                                                                                
***********************************************************************         
* Unit selection phase                                                *         
***********************************************************************         
                                                                                
         MVI   ALPHASE,ALPUNTQ                                                  
         MVI   ZSPASS,ZSPNOQ       DO ONLY NON-ZERO UNITS                       
         MVC   WSECS,AWKRSECS      TOTAL LENGTH TO BE ALLOCATED                 
         L     R3,AFSTBRD          CLEAR BRAND SWITCHES                         
         USING TABD,R3                                                          
ALWEEK02 CLC   TABPRD,SUPPRD                                                    
         BE    ALWEEK04                                                         
         MVI   TABNOSPT,0                                                       
         AH    R3,ROWLEN                                                        
         B     ALWEEK02                                                         
                                                                                
ALWEEK04 MVI   WLENFLT,0                                                        
         CLI   PODRSW,YESQ         FOR POD RUNS                                 
         BNE   ALWEEK08            DO EACH LENGTH SEPARATELY                    
         CLI   FASTPOD,YESQ        IF 'FASTPOD'                                 
         BE    ALWEEK12            DO ALL LENGTHS TOGETHER                      
                                                                                
         LH    R6,PODLENSN         FOR BCT                                      
         LA    R4,PODLENS-L'PODLENS(R6) START WITH LARGEST LENGTH               
ALWEEK06 MVC   WLENFLT,0(R4)                                                    
ALWEEK08 GOTOR GPRUNT                                                           
         CLI   PODRSW,YESQ         TEST A POD RUN                               
         BNE   ALWEEK14            NO DONE                                      
         BCTR  R4,0                ELSE TRY NEXT LENGTH                         
         BCT   R6,ALWEEK06                                                      
         MVI   WLENFLT,0           NOW DO ANY LEFT OVER                         
                                                                                
         L     R3,AFSTBRD          CLEAR BRAND SWITCHES                         
ALWEEK10 CLC   TABPRD,SUPPRD                                                    
         BE    ALWEEK12                                                         
         MVI   TABNOSPT,0                                                       
         AH    R3,ROWLEN                                                        
         B     ALWEEK10                                                         
         DROP  R3                                                               
                                                                                
ALWEEK12 GOTOR GPRUNT              GET PRODUCT/UNIT                             
                                                                                
ALWEEK14 GOTOR APRTUNT             PRINT UNIT TABLE                             
                                                                                
***********************************************************************         
* Brand selection phase                                               *         
***********************************************************************         
                                                                                
         CLI   PODRSW,YESQ         FOR POD RUN USE NEW LOGIC                    
         BNE   *+12                                                             
         GOTOR ALPODS                                                           
         B     ALWEEK40                                                         
                                                                                
         MVI   ALPHASE,ALPBRDQ                                                  
         MVI   ZSPASS,ZSPNOQ       SET NON-ZERO UNIT PASS                       
ALWEEK16 GOTOR OPVARS                                                           
         CLI   ZSPASS,ZSPYESQ                                                   
         BNE   *+8                                                              
         OI    VARCTLS,TVNOPQ      NO-OP VARIABLE                               
         L     R5,AUNTTAB                                                       
         ICM   R6,15,UNTTABN                                                    
         BZ    ALWEEK36                                                         
ALWEEK18 ST    R5,THISUNT                                                       
         USING UBUFFRD,R5                                                       
         TM    UBSTAT2,UBSPRALQ    DON'T DO PRE-ALLOCS                          
         BNZ   ALWEEK34                                                         
         LA    RF,UBCOST                                                        
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,UBCDEM                                                        
         CLI   ZSPASS,ZSPYESQ      IF ZERO UNIT PASS                            
         BNE   ALWEEK20                                                         
         OC    0(4,RF),0(RF)                                                    
         BNZ   ALWEEK34            SKIP NON-ZERO UNITS                          
         B     ALWEEK22                                                         
ALWEEK20 OC    0(4,RF),0(RF)       IF NON-ZERO UNIT PASS                        
         BZ    ALWEEK34            SKIP ZERO UNITS                              
ALWEEK22 MVI   PVMODE1,ALPBRDQ     FOR VARIABLE TRACE                           
         MVI   PVMODE2,PVMODE1Q                                                 
         GOTOR APRTVAR                                                          
                                                                                
         XC    CURAPRD,CURAPRD     CLEAR CURRENT PRODUCT ADDR                   
         OC    UBPRD1,UBPRD1       DON'T SUBTRACT IF UNA ON FIRST PASS          
         BZ    ALWEEK28                                                         
                                                                                
         L     R2,AFSTBRD                                                       
         USING TABD,R2                                                          
ALWEEK24 CLC   TABPRD,SUPPRD                                                    
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   UBPRD1,TABPRD                                                    
         BE    *+12                                                             
         AH    R2,ROWLEN                                                        
         B     ALWEEK24                                                         
         ST    R2,CURAPRD          SAVE CURRENT PRODUCT ADDRESS                 
         ST    R2,THISPRD                                                       
         GOTOR AADDSUB,SUBITQ                                                   
ALWEEK28 MVC   BESTVAL,MAXNEG      SET TO MAXIMUM NEGATIVE VALUE                
         XC    BESTPRD,BESTPRD                                                  
                                                                                
         L     R2,AFSTBRD                                                       
ALWEEK30 CLC   TABPRD,SUPPRD                                                    
         BE    ALWEEK32                                                         
         ST    R2,THISPRD                                                       
         GOTOR ASETVAL,VALBRDQ     VALUE BRAND                                  
         AH    R2,ROWLEN           NEXT PRODUCT                                 
         B     ALWEEK30                                                         
                                                                                
ALWEEK32 ICM   R2,15,BESTPRD                                                    
         BZ    ALWEEK34            NO BRAND ACCEPTABLE                          
         ST    R2,THISPRD                                                       
         GOTOR AADDSUB,ADDITQ                                                   
         NI    UBSTAT1,FF-UBSRJCTQ CLEAR REJECT BITS                            
         CLC   UBPRD1,TABPRD       IF SAME BRAND DON'T RE-BUFFER                
         BE    ALWEEK34                                                         
         OI    UBSTAT1,UBSABRDQ    SET ALLOCATED IN BRAND PHASE                 
         MVC   UBPRD1,TABPRD       SET PRODUCT CODE (FIRST SLOT)                
         MVC   UBLEN1,UBPDLEN      SET LENGTH                                   
         MVI   UBUNLEN,0           CLEAR UNALLOCATED LENGTH                     
         GOTOR PUTALC                                                           
ALWEEK34 A     R5,UNTTABL                                                       
         BCT   R6,ALWEEK18                                                      
                                                                                
ALWEEK36 CLI   ZSPASS,ZSPYESQ      DONE IF THIS WAS ZERO PASS                   
         BE    ALWEEK38                                                         
         OC    AWKZUNTS,AWKZUNTS   TEST HAVE ANY ZERO UNITS                     
         BZ    ALWEEK38                                                         
         MVI   ZSPASS,ZSPYESQ      YES - DO ZERO UNIT PASS NOW                  
         B     ALWEEK16                                                         
                                                                                
ALWEEK38 GOTOR APRTUNT             PRINT UNIT TABLE                             
                                                                                
***********************************************************************         
* Brand exchange phase                                                *         
***********************************************************************         
                                                                                
ALWEEK40 MVI   ALPHASE,ALPXCHQ                                                  
         MVI   ZSPASS,ZSPTOGQ                                                   
         MVC   UNITA,AUNTTAB                                                    
         L     R5,UNITA                                                         
         XC    UNITB,UNITB                                                      
         GOTOR OPVARS                                                           
         MVI   PVMODE1,ALPXCHQ                                                  
         MVI   PVMODE2,PVMODE1Q                                                 
         GOTOR APRTVAR                                                          
                                                                                
ALWEEK44 CLI   UBUFFRD,UBUFEOTQ    TEST END OF UNITS                            
         BE    ALWEEK78                                                         
         TM    UBSTAT2,UBSPRALQ    SKIP PRE-ALLOCATED                           
         BNZ   ALWEEK76                                                         
         OC    UBPRD1,UBPRD1       SKIP UNALLOCATED                             
         BZ    ALWEEK76                                                         
         MVI   ZEROA,NOQ                                                        
         LA    RF,UBCOST           TEST ZERO UNIT                               
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,UBCDEM                                                        
         OC    0(4,RF),0(RF)                                                    
         BNZ   ALWEEK46                                                         
         MVI   ZEROA,YESQ                                                       
ALWEEK46 ICM   R5,15,UNITB                                                      
         BNZ   ALWEEK48                                                         
         L     R5,UNITA                                                         
ALWEEK48 A     R5,UNTTABL          LOOK FOR POTENTIAL SWAP                      
         CLI   UBUFFRD,UBUFEOTQ                                                 
         BE    ALWEEK76            DONE WITH THIS UNIT                          
         TM    UBSTAT2,UBSPRALQ    SKIP PRE-ALLOCATED                           
         BNZ   ALWEEK48                                                         
         OC    UBPRD1,UBPRD1       SKIP UNALLOCATED                             
         BZ    ALWEEK48                                                         
         MVI   ZEROB,NOQ                                                        
         LA    RF,UBCOST           TEST ZERO UNIT                               
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,UBCDEM                                                        
         OC    0(4,RF),0(RF)                                                    
         BNZ   *+8                                                              
         MVI   ZEROB,YESQ                                                       
         CLC   ZEROA,ZEROB         DON'T SWAP ZERO WITH NON-ZERO UNIT           
         BNE   ALWEEK48                                                         
         ST    R5,UNITB                                                         
         NI    VARCTLS,FF-TVNOPQ                                                
         CLI   ZEROA,YESQ          IF ZERO UNITS                                
         BNE   *+8                                                              
         OI    VARCTLS,TVNOPQ      NO-OP GOAL FULFULL VARIABLE                  
                                                                                
***********************************************************************         
* Have UNITA and UNITB go thru UNITA slots                            *         
***********************************************************************         
                                                                                
         L     R5,UNITA                                                         
         LA    R3,UBPRD1           START WITH SLOT 1                            
ALWEEK50 OC    0(L'UBPRD,R3),0(R3) WITH FIRST UNA SLOT                          
         BZ    ALWEEK46                                                         
         LA    R0,UBPRDX                                                        
         CR    R3,R0               OR AT END OF SLOT A'S                        
         BH    ALWEEK46            GET ANOTHER UNITB                            
                                                                                
         L     R5,UNITB            NOW FIND POTENTIAL SWAP IN UNITB             
         LA    R4,UBPRD1           R4 FOR UNITB SLOTS                           
ALWEEK52 OC    0(L'UBPRD,R4),0(R4)                                              
         BZ    ALWEEK56                                                         
         LA    R0,UBPRDX                                                        
         CR    R4,R0               OR IF AT END OF UNITB SLOTS                  
         BH    ALWEEK56            TRY NEXT UNIT A SLOT                         
         CLC   0(L'UBPRD,R3),0(R4)                                              
         BE    ALWEEK54                                                         
         CLC   L'UBPRD(L'UBLEN,R3),L'UBPRD(R4)                                  
         BE    ALWEEK58            ELSE TRY SWAP                                
                                                                                
ALWEEK54 AHI   R4,UBPRDL           NEXT UNITB SLOT                              
         B     ALWEEK52                                                         
*                                  CONE WITH UNITB SLOTS                        
ALWEEK56 AHI   R3,UBPRDL           TRY NEXT UNITA SLOT                          
         B     ALWEEK50                                                         
                                                                                
***********************************************************************         
* Have pair of slots to test                                          *         
***********************************************************************         
                                                                                
ALWEEK58 SR    RE,RE               PRDBUFF ADDRESS FOR PRDA                     
         SR    RF,RF               PRDBUFF ADDRESS FOR PRDB                     
         L     R2,AFSTBRD                                                       
                                                                                
ALWEEK60 CLC   TABPRD,SUPPRD                                                    
         BE    ALWEEK66                                                         
                                                                                
         CLC   TABPRD,0(R3)        TEST = PRODUCT A                             
         BNE   ALWEEK62                                                         
         TM    REQFLAG2,REQFSLEN   IF ALL LENGTHS TOGETHER                      
         BZ    *+14                SKIP LENGTH TEST                             
         CLC   TABLEN,L'UBPRD(R3)                                               
         BNE   ALWEEK62                                                         
         LR    RE,R2               A(PRODUCT ENTRY)                             
         LTR   RF,RF               TEST ALREADY HAVE PRDB ALSO                  
         BNZ   ALWEEK66            YES - DONE                                   
                                                                                
ALWEEK62 CLC   TABPRD,0(R4)        TEST = PRODUCT B                             
         BNE   ALWEEK64                                                         
         TM    REQFLAG2,REQFSLEN   IF ALL LENGTHS TOGETHER                      
         BZ    *+14                SKIP LENGTH TEST                             
         CLC   TABLEN,L'UBPRD(R4)                                               
         BNE   ALWEEK64                                                         
         LR    RF,R2               A(PRODUCT B ENTRY)                           
         LTR   RE,RE               TEST ALREADY HAVE PRDA ALSO                  
         BNZ   ALWEEK66            YES - DONE                                   
                                                                                
ALWEEK64 AH    R2,ROWLEN           NEXT PRODUCT                                 
         B     ALWEEK60                                                         
                                                                                
ALWEEK66 LTR   RE,RE                                                            
         BNZ   *+6                                                              
         DC    H'0'                PRODUCT A MISSING                            
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                PRODUCT B MISSING                            
         ST    RE,PRDAR                                                         
         ST    RF,PRDBR                                                         
ALWEEK68 MVI   EXCHSW,EXCHCURQ     SET DOING CURRENT VALUATION                  
         MVC   THISUNT,UNITA                                                    
         MVC   THISPRD,PRDAR                                                    
         GOTOR ASETVAL,VALBRDQ     CURRENT A'S                                  
         MVC   SWAPAA(VARWGTSL),VARVALS                                         
         MVC   SWAPAA+VARWGTSL(L'BRDVAL),BRDVAL                                 
         L     R6,BRDVAL                                                        
         MVC   THISUNT,UNITB                                                    
         MVC   THISPRD,PRDBR                                                    
         GOTOR ASETVAL,VALBRDQ     CURRENT B'S                                  
         MVC   SWAPBB(VARWGTSL),VARVALS                                         
         MVC   SWAPBB+VARWGTSL(L'BRDVAL),BRDVAL                                 
         A     R6,BRDVAL                                                        
         ST    R6,CURVAL           SAVE CURRENT TOTAL                           
                                                                                
***********************************************************************         
* Subtract current assigns                                            *         
* Note: ADDSUB and value routines don't rely on the prd code being    *         
* set in the UBUFFRD slot, only the length                            *         
***********************************************************************         
                                                                                
         MVC   THISUNT,UNITA                                                    
         MVC   THISPRD,PRDAR                                                    
         ST    R3,ASLOT            UNITA SLOT                                   
         GOTOR AADDSUB,SUBITQ                                                   
         MVC   THISUNT,UNITB                                                    
         MVC   THISPRD,PRDBR                                                    
         ST    R4,ASLOT            UNITB SLOT                                   
         GOTOR AADDSUB,SUBITQ                                                   
*                                  NOW ADD REVERSE ASSIGNS                      
         MVI   EXCHSW,EXCHREVQ     SET DOING REVERSES                           
         MVC   THISUNT,UNITA                                                    
         MVC   THISPRD,PRDBR                                                    
         ST    R3,ASLOT            UNITA SLOT                                   
         GOTOR AADDSUB,ADDITQ                                                   
         MVC   THISUNT,UNITB                                                    
         MVC   THISPRD,PRDAR                                                    
         ST    R4,ASLOT            UNITB SLOT                                   
         GOTOR AADDSUB,ADDITQ                                                   
         MVC   NEWVAL,MAXNEG       NOW EVALUATE REVERSED ASSIGNS                
         GOTOR ASETVAL,VALBRDQ     UNITB + PRDA                                 
         MVC   SWAPBA(VARWGTSL),VARVALS                                         
         MVC   SWAPBA+VARWGTSL(L'BRDVAL),BRDVAL                                 
         CLC   BRDVAL,MAXNEG       IF REJECT- NO SWAP                           
         BE    ALWEEK70                                                         
         L     R6,BRDVAL                                                        
         MVC   THISUNT,UNITA       UNITA + PRDB                                 
         MVC   THISPRD,PRDBR                                                    
         GOTOR ASETVAL,VALBRDQ                                                  
         MVC   SWAPAB(VARWGTSL),VARVALS                                         
         MVC   SWAPAB+VARWGTSL(L'BRDVAL),BRDVAL                                 
         CLC   BRDVAL,MAXNEG       IF REJECT - NO SWAP                          
         BE    ALWEEK70                                                         
         A     R6,BRDVAL                                                        
         ST    R6,NEWVAL                                                        
ALWEEK70 MVI   EXCHSW,EXCHNULQ     CLEAR EXCHANGE MODE SWITCH                   
         ST    R3,SLOTA            FOR TRACE                                    
         ST    R4,SLOTB                                                         
         MVI   PVMODE2,PVMODE2Q                                                 
         GOTOR APRTVAR                                                          
         CLC   BRDVAL,MAXNEG       IF ANY REJECT                                
         BE    ALWEEK72            NO SWAP                                      
         C     R6,CURVAL           IF NEW IS WORSE, NO SWAP(ON TIE,             
         BL    ALWEEK72            PRESERVE SWAP RATHER THAN RESET)             
*                                  SWAP ALLOCATIONS                             
         L     R5,THISUNT          UNITA                                        
         ST    R3,ASLOT            UNITA SLOT                                   
         OI    UBSTAT1,UBSAEXCQ    SET ALLOCATED IN EXCHANGE PHASE              
         GOTOR PUTALC                                                           
         MVC   THISUNT,UNITB                                                    
         MVC   THISPRD,PRDAR                                                    
         L     R5,UNITB                                                         
         ST    R4,ASLOT            UNITB SLOT                                   
         OI    UBSTAT1,UBSAEXCQ                                                 
         GOTOR PUTALC                                                           
         B     ALWEEK54                                                         
                                                                                
ALWEEK72 MVC   THISUNT,UNITA       NO SWAP - RESTORE ORIGINAL ASSIGNS           
         MVC   THISPRD,PRDBR       FIRST SUBTRACT REVERSE ASSIGNS               
         GOTOR AADDSUB,SUBITQ                                                   
         MVC   THISUNT,UNITB                                                    
         MVC   THISPRD,PRDAR                                                    
         ST    R4,ASLOT            UNITB SLOT                                   
         GOTOR AADDSUB,SUBITQ                                                   
         MVC   THISUNT,UNITA       NO SWAP - RESTORE ORIGINALS                  
         MVC   THISPRD,PRDAR                                                    
         ST    R3,ASLOT            UNITA SLOT                                   
         GOTOR AADDSUB,ADDITQ                                                   
         MVC   THISUNT,UNITB                                                    
         MVC   THISPRD,PRDBR                                                    
         ST    R4,ASLOT            UNITB SLOT                                   
         GOTOR AADDSUB,ADDITQ                                                   
         L     R5,UNITA                                                         
         NI    UBSTAT1,FF-UBSRJCTQ CLEAR REJECT BITS                            
         L     R5,UNITB                                                         
         NI    UBSTAT1,FF-UBSRJCTQ CLEAR REJECT BITS                            
         B     ALWEEK54            NEXT UNITB SLOT                              
ALWEEK76 L     R5,UNITA            NEXT UNITA                                   
         A     R5,UNTTABL                                                       
         ST    R5,UNITA                                                         
         XC    UNITB,UNITB                                                      
         B     ALWEEK44                                                         
                                                                                
ALWEEK78 MVI   PVMODE2,PVMODE1Q    PRINT FINAL PRODUCT STATUS                   
         GOTOR APRTVAR                                                          
         GOTOR APRTUNT             PRINT UNIT TABLE                             
         MVI   PVMODE1,SPACE                                                    
         MVI   PVMODE2,SPACE                                                    
                                                                                
ALWEEK96 CLC   NTARGETS,=Y(2)      IF 3+ TARGETS                                
         BNH   ALWEEK98                                                         
         GOTOR ADETRPT                                                          
         B     ALWEEKX                                                          
                                                                                
ALWEEK98 GOTOR ADT2RPT             ELSE MODE 2                                  
                                                                                
ALWEEKX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* POD run brand select phase                                          *         
* for this phase the units must be in seq on program (UBENV1)         *         
* (NB-they will always be in or very close to that sequence)          *         
***********************************************************************         
                                                                                
ALPODS   NTR1  ,                                                                
         CLI   FASTPOD,YESQ        IF 'FASTPOD' SKIP BRAND PHASE                
         BE    ALPODSX                                                          
         LH    R0,NPRDS                                                         
         CHI   R0,30               OR MORE THAN 30 BRANDS                       
         BH    ALPODSX                                                          
         L     R0,UNTTABN                                                       
         L     RF,UNTTABL                                                       
         GOTOR XSORT,DMCB,XSORTXA,(R0),(RF),L'UBENV1,UBENV1-UBUFFRD,   *        
               AUNTTAB,XA=OFF                                                   
         MVI   FORCEHED,YESQ                                                    
         MVI   ALPHASE,ALPBRDQ     SET BRAND PHASE                              
         MVI   ZSPASS,ZSPTOGQ      DO ZERO AND NON-ZERO UNITS TOGETHER          
         GOTOR OPVARS                                                           
         LA    R3,APPAINDX-L'APPAINDX POINT TO APPROPRIATE ADDRESS LIST         
         CLI   SPLPOPTN,SPLPGPPQ   TEST DOING PSEUDO PIGS                       
         BE    *+8                                                              
         LA    R3,APLAINDX-L'APLAINDX                                           
         SR    RE,RE                                                            
         ICM   RE,1,PODNUM                                                      
         BZ    ALPODS04                                                         
         SLL   RE,2                POD NUMBER X 4                               
         L     R3,0(RE,R3)         R3=A(POD TABLE)                              
         B     ALPODS08                                                         
ALPODS04 L     R3,APLXINDX         NON-PODS                                     
         L     RE,AFSTBRD                                                       
         MVC   0(1,R3),TABLEN-TABD(RE) SET LENGTH IN INDX                       
         L     RF,0(R3)                                                         
         MVC   2(1,RF),TABLEN-TABD(RE) SET LENGTH SPLIT TABLE                   
ALPODS08 ST    R3,PDRANXT                                                       
         MVC   PDRLEN,0(R3)        SET ACTUAL LENGTH                            
         MVC   PDRFSPL,0(R3)       SET A(FIRST SPLIT)                           
         MVI   PDRFSPL,0                                                        
         TM    DIAGNOP2,DPODBRDQ   TEST TRACE POD OPTION SET                    
         BZ    ALPODS10                                                         
         MVC   P1(20),=C'***POD length=NNN***'                                  
         EDIT  (B1,PDRLEN),(3,P1+14)                                            
         GOTOR REPORT,XA=OFF                                                    
ALPODS10 L     R5,AUNTTAB          GET PODS FOR THE POD LENGTH                  
         USING UBUFFRD,R5                                                       
ALPODS12 CLI   UBUFFRD,UBUFEOTQ    TEST END OF PODS                             
         BE    ALPODS68            GET NEXT POD LENGTH                          
         TM    UBSTAT2,UBSPRALQ    SKIP PRE-ALLOCATED                           
         BNZ   ALPODS66                                                         
         CLC   UBPDLEN,PDRLEN      TEST RIGHT LENGTH                            
         BNE   ALPODS66                                                         
         MVC   PDRSVAL,UBPRD1      SAVE INITIAL ALLOCATION                      
ALPODS14 MVI   ZEROA,NOQ                                                        
         LA    RF,UBCOST           TEST ZERO UNIT                               
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,UBCDEM                                                        
         OC    0(4,RF),0(RF)                                                    
         BNZ   *+8                                                              
         MVI   ZEROA,YESQ                                                       
         NI    VARCTLS,FF-TVNOPQ                                                
         CLI   ZEROA,YESQ          IF ZERO UNIT                                 
         BNE   *+8                                                              
         OI    VARCTLS,TVNOPQ      NO-OP GOAL FULFILLMENT VARIABLE              
         MVC   PDRBUNL,UBPDLEN     SET 'BEST' UNA LENGTH                        
         XC    PDRBLST,PDRBLST     CLEAR BEST LIST                              
         MVC   PDRBAVG,MAXNEG      SET VALUE SUM TO MAXIMUM NEGATIVE            
         MVC   PDRBBLK,HWHIVAL     SET BLOCKING SCORE TO MAXIMUM                
         ST    R5,THISUNT                                                       
*                                  GET LIMITS FOR PROD/CLASS CHECKING           
         LH    R3,UBENV1           ENVIRONMENT 1 (PROGRAM) INDEX                
         BCTR  R3,0                                                             
         MHI   R3,ENVS1LEN                                                      
         L     RF,AENV1SET                                                      
         A     R3,ENVSATAB-ENVSETD(RF)                                          
         USING ENVTABD,R3                                                       
         LA    RF,ENVS1SLP         PRODUCT MAXIMUM FOR ENVIRONMENT 1            
         CLI   PINTRVL,0           BUT IF PRODUCT CHECK NOT ACTIVE              
         BNE   *+8                                                              
         LA    RF,HWHIVAL          USE HIGH NUMBER                              
         MVC   PDRPMAX,0(RF)       SET MAXIMUM FOR PRODUCT                      
         LA    RF,ENVS1SLC         CLASS MAXIMUM FOR ENVIRONMENT 1              
         CLI   CINTRVL,0           BUT IF CLASS CHECK NOT ACTIVE                
         BNE   *+8                                                              
         LA    RF,HWHIVAL          USE HIGH NUMBER                              
         MVC   PDRCMAX,0(RF)       SET MAXIMUM FOR CLASS                        
         GOTOR PODSUB              CLEAR AND SUBTRACT CURRENT ALLOCS            
         XC    PDRRSECS,PDRRSECS   CLEAR REMAINING PROGRAM SECONDS              
*                                  FOR THIS POD                                 
         CLC   PDRPMAX,HW20        IF BOTH PRODUCT                              
         BL    ALPODS16                                                         
         CLC   PDRCMAX,HW20        AND CLASS LIMITS ARE 2.0+                    
         BL    ALPODS16                                                         
         MVI   APCSW,NOQ           NO-OP APC LOGIC                              
         B     ALPODS26            AND DON'T LOOK FOR OTHER PODS                
*                                  ALSO CLEAR ALL OTHER ALLOCATIONS             
*                                  FOR THIS SAME PROGRAM                        
ALPODS16 ST    R5,WORD             SAVE UNIT POINTER                            
         MVC   HALF,UBENV1         AND ENVIRONMENT 1 CODE                       
*                                  FIRST LOOK AHEAD                             
ALPODS18 A     R5,UNTTABL                                                       
         CLI   UBUFFRD,UBUFEOTQ    TEST END OF UNIT TABLE                       
         BE    ALPODS20                                                         
         CLC   UBENV1,HALF         TEST SAME PROGRAM                            
         BNE   ALPODS20            NO - DONE (UNITS ARE IN PROG ORDER)          
         TM    UBSTAT1,UBSABRDQ    DON'T UNDO THIS PHASE ALLOCATIONS            
         BNZ   ALPODS18                                                         
         TM    UBSTAT2,UBSPRALQ    SKIP PRE-ALLOCATED                           
         BNZ   ALPODS18                                                         
         GOTOR PODSUB                                                           
         B     ALPODS18                                                         
ALPODS20 L     R5,WORD             RESTORE INITIAL UNIT POINTER                 
ALPODS22 S     R5,UNTTABL          NOW LOOK BACKWARD                            
         C     R5,AUNTTAB          TEST AT START                                
         BL    ALPODS24                                                         
         CLC   UBENV1,HALF         TEST RIGHT PROGRAM                           
         BNE   ALPODS24            NO - DONE                                    
         TM    UBSTAT1,UBSABRDQ    DON'T UNDO THIS PHASE ALLOCATIONS            
         BNZ   ALPODS22                                                         
         TM    UBSTAT2,UBSPRALQ    SKIP PRE-ALLOCATED                           
         BNZ   ALPODS22                                                         
         GOTOR PODSUB                                                           
         B     ALPODS22                                                         
                                                                                
ALPODS24 L     R5,WORD             RESTORE ORIGINAL UNIT POINTER                
         MVI   APCSW,YESQ          ACTIVATE ACP LOGIC                           
         OC    PDRRSECS,PDRRSECS   ONLY IF HAVE OTHER PODS FOR PROGRAM          
         BNZ   ALPODS26                                                         
         MVI   APCSW,NOQ           ELSE NO-OP                                   
                                                                                
ALPODS26 ST    R5,THISUNT                                                       
         GOTOR SETEVC              SET ENVIRONMENT 1 COUNTS FOR PROGRAM         
         MVI   BYTE,C'I'           TRACE INITIAL ALLOCATION                     
         GOTOR PUNTRC                                                           
         GOTOR ABLDVPL             BUILD VALUE/PRODUCT LIST                     
         L     R3,PDRFSPL          FIRST SPLIT FOR THIS LENGTH                  
         ST    R3,PDRASLT                                                       
         TM    UBSTAT2,UBSDPODQ    TEST IF A DIVISIBLE POD                      
         BNZ   ALPODS28            YES - OK                                     
         LA    R3,PDRFXSPL         NO - USE SPECIAL 'SPLIT TABLE'               
         MVC   2(1,R3),UBPDLEN     WITH ONLY THAT LENGTH                        
         ST    R3,PDRASLT                                                       
                                                                                
ALPODS28 CLI   0(R3),FF            TEST END OF SPLITS                           
         BE    ALPODS52            GET NEXT POD                                 
*                                  HAVE SPLIT - DO SLOTS                        
         XC    PDRPRDS,PDRPRDS     CLEAR PRODUCT LIST                           
         LA    R4,2(R3)            START OF SLOT LENGTHS                        
         ST    R4,PDRAFST          SAVE A(FIRST SLOT LENGTH)                    
         GOTOR TSTSPU              TEST SPLIT USABLE                            
         BNE   ALPODS48            NO - GET NEXT                                
         LA    R6,PDRPRDS          START OF PRODUCT LIST                        
         LA    RF,UBPRD1           FIRST SLOT                                   
         ST    RF,ASLOT                                                         
                                                                                
ALPODS30 CLI   0(R4),FF            TEST END OF SLOTS                            
         BE    ALPODS50            PRINT THE PRODUCT SET                        
                                                                                
         USING VPLD,R2                                                          
ALPODS32 MVC   WLENFLT,0(R4)       SET LENGTH FILTER                            
         ICM   R2,15,0(R6)         TEST FIRST TIME FOR SLOT                     
         BZ    ALPODS34            YES - START WITH FIRST BRAND                 
         CLI   1(R4),FF            IF LAST SLOT                                 
         BE    *+8                 SKIP VPSUB BECAUSE DIDNT DO VPADD            
         GOTOR VPSUB               SUBTRACT FROM COUNTS                         
         SR    RF,RF                                                            
         IC    RF,UBUNLEN          INCREMENT UBUNLEN                            
         SR    RE,RE                                                            
         IC    RE,VPLEN                                                         
         AR    RF,RE                                                            
         STC   RF,UBUNLEN                                                       
         B     ALPODS38            AND GET NEXT BRAND                           
                                                                                
ALPODS34 LARL  R2,VPLIST                                                        
         LR    R1,R4               UNLESS THIS SLOT LEN = LAST LEN              
         BCTR  R1,0                                                             
         CLC   0(1,R1),0(R4)                                                    
         BNE   ALPODS36                                                         
         SHI   R6,PDRPRDL          IF SO, START THIS SLOT WITH                  
         L     R2,0(R6)            LAST SLOTS BRAND                             
         AHI   R6,PDRPRDL                                                       
                                                                                
ALPODS36 CLI   VPLD,VPLEOTQ        TEST END OF PRODUCT LIST                     
         BE    ALPODS46            YES - BACK UP SLOT                           
         CLC   VPLEN,WLENFLT       TEST RIGHT LENGTH                            
         BNE   ALPODS38            YES - HAVE GOOD PRODUCT                      
*                                  HAVE A PRODUCT                               
         MVC   THISPRD,VPPRDA      SET ADDR OF PRDBUFF ENTRY                    
         MVC   4(4,R6),MAXNEG      CLEAR VALUE                                  
         GOTOR GETVAL              GET SCORE FOR PRODUCT                        
         ST    R2,0(R6)            SET IN PRODUCT/SLOT LIST                     
         MVC   4(4,R6),BRDVAL      SET SCORE                                    
         CLC   BRDVAL,MAXNEG       TEST REJECT                                  
         BNE   ALPODS42            NO - PROCESS                                 
         GOTOR SUMVAL              YES - STILL SUM VALUE AND SAVE BEST          
         GOTOR ALPTRC              AND TRACE                                    
ALPODS38 AHI   R2,VPLDL            NO - NEXT PRODUCT                            
         B     ALPODS36                                                         
                                                                                
ALPODS42 SR    RF,RF                                                            
         IC    RF,UBUNLEN          DECREMENT UBUNLEN                            
         SR    RE,RE                                                            
         IC    RE,VPLEN                                                         
         SR    RF,RE                                                            
         BNM   *+6                                                              
         DC    H'0'                                                             
         STC   RF,UBUNLEN                                                       
         CLI   1(R4),FF            IF THIS IS LAST SLOT                         
         BNE   ALPODS44                                                         
         GOTOR SUMVAL              SUM VALUE                                    
         GOTOR ALPTRC              TRACE                                        
         B     ALPODS32            AND TRY ANOTHER PRODUCT IN SLOT              
                                                                                
ALPODS44 GOTOR VPADD               ADD TO COUNTS                                
         AHI   R6,PDRPRDL          BUMP PRODUCT LOCATION                        
         AHI   R4,1                BUMP SLOT LENGTH                             
         XC    0(PDRPRDL,R6),0(R6) CLEAR NEXT ENTRY                             
         B     ALPODS30                                                         
*                                  NO MORE BRANDS TO TRY FOR THIS SLOT          
ALPODS46 C     R4,PDRAFST          TEST AT FIRST SLOT                           
         BH    ALPODS50            YES - TRY ANOTHER PRODUCT                    
                                                                                
ALPODS48 L     R3,PDRASLT          GET NEXT SPLIT                               
         SR    RF,RF                                                            
         IC    RF,0(R3)            NO OF SLOTS IN SPLIT                         
         LA    R3,3(R3,RF)         +1 FOR LEN,CTL,AND FF                        
         ST    R3,PDRASLT                                                       
         B     ALPODS28                                                         
*                                  ALL SLOTS FILLED                             
ALPODS50 XC    0(PDRPRDL,R6),0(R6) CLEAR THIS ONE                               
         SHI   R6,PDRPRDL          BACK UP PRODUCT LOCATION                     
         SHI   R4,1                AND SLOT LENGTH                              
         B     ALPODS32            AND GET ANOTHER PRODUCT                      
                                                                                
***********************************************************************         
* Have finished combos for this POD                                   *         
***********************************************************************         
                                                                                
ALPODS52 OI    UBSTAT1,UBSABRDQ    SET ALLOCATED IN THIS PHASE                  
         OC    PDRBLST,PDRBLST     TEST ANY SUITABLE ALLOCATION                 
         BZ    ALPODS64            NO                                           
         CLI   SPLPOPTN,SPLPGPPQ   IF DOING PSEUDO PIGS                         
         BNE   ALPODS58                                                         
         SR    R0,R0               SEE IF ONLY PARTLY ALLOCATED                 
         LA    R6,PDRBLST                                                       
ALPODS54 ICM   R2,15,0(R6)         A(PRODUCT)                                   
         BZ    ALPODS56                                                         
         SR    RF,RF                                                            
         IC    RF,VPLEN            LENGTH                                       
         AR    R0,RF                                                            
         AHI   R6,PDRPRDL                                                       
         B     ALPODS54                                                         
ALPODS56 CLM   R0,1,UBPDLEN        IS IT TOTALLY ALLOCATED                      
         BNE   ALPODS64            NO, DON'T ALLOCATE AT ALL                    
                                                                                
ALPODS58 LA    R6,PDRBLST          SET RESULTS OF ALLOCATION                    
         LA    R4,UBPRD1                                                        
         SR    R0,R0                                                            
ALPODS60 ST    R4,ASLOT                                                         
         ICM   R2,15,0(R6)         A(PRODUCT)                                   
         BZ    ALPODS62            DONE IF NONE                                 
         CLC   4(4,R6),MAXNEG      OR WHEN HAVE REJECT                          
         BE    ALPODS62                                                         
         MVC   0(L'UBPRD,R4),VPPRD                                              
         MVC   L'UBPRD(L'UBLEN,R4),VPLEN                                        
         MVC   THISPRD,VPPRDA      ADDRESS OF PRDBUFF ENTRY                     
         GOTOR AADDSUB,ADDITQ      POST TO TOTALS                               
         SR    RF,RF                                                            
         IC    RF,VPLEN                                                         
         AR    R0,RF               SUM ALLOCATION LENGTHS                       
         LA    RE,UBPRDX           TEST AT END                                  
         CR    R4,RE                                                            
         BE    ALPODS62                                                         
         AHI   R6,PDRPRDL                                                       
         AHI   R4,UBPRDL                                                        
         B     ALPODS60                                                         
                                                                                
ALPODS62 SR    RF,RF                                                            
         IC    RF,UBPDLEN          TOTAL POD LENGTH                             
         SR    RF,R0               LESS TOTAL ALLOCATION                        
         BNM   *+6                                                              
         DC    H'0'                CANNOT GO NEGATIVE                           
         STC   RF,UBUNLEN          = UNALLOCATED LENGTH                         
ALPODS64 GOTOR PUTALC              BUFFER POD                                   
         MVI   BYTE,C'F'           TRACE FINAL ALLOCATION                       
         GOTOR PUNTRC                                                           
ALPODS66 A     R5,UNTTABL          NEXT POD                                     
         B     ALPODS12                                                         
                                                                                
ALPODS68 L     R3,PDRANXT          BUMP TO NEXT POD LENGTH ENTRY                
         AHI   R3,4                                                             
         ST    R3,PDRANXT                                                       
         CLI   0(R3),FF            TEST END OF POD LENGTHS                      
         BNE   ALPODS08                                                         
                                                                                
         MVI   WLENFLT,0           CLEAR LENGTH FILT                            
         GOTOR APRTUNT             PRINT UNIT TABLE                             
                                                                                
ALPODSX  J     EXIT                NOW TRY EXCHANGE PHASE                       
         EJECT                                                                  
***********************************************************************         
* Get value for brand                                                 *         
***********************************************************************         
                                                                                
GETVAL   CLC   VPPRD,UNAPRD        SKIP PRODUCT/CLASS CHECK                     
         BE    GETVAL04            FOR PRODUCT UNA (EXCESS)                     
         CLI   PINTRVL,0           TEST PRODUCT CHECK ACTIVE                    
         BE    GETVAL02            NO                                           
         SR    RF,RF                                                            
         ICM   RF,3,VPPSQ          PRODUCT SEQUENCE                             
         SLL   RF,1                2 BYTES PER                                  
         A     RF,AVPECNTS                                                      
         LH    R1,0(RF)                                                         
         AHI   R1,10               BUMP BY 1.0                                  
         CH    R1,PDRPMAX          VS PRODUCT MAXIMUM                           
         BH    GETVAL06            REJECT                                       
                                                                                
GETVAL02 CLI   CINTRVL,0           TEST CLASS CHECK ACTIVE                      
         BE    GETVAL04            NO                                           
         CLI   VPCLASS1,0          TEST HAVE CLASS                              
         BE    GETVAL04            NO                                           
         SR    RF,RF                                                            
         IC    RF,VPC1SQ           CLASS 1 SEQUENCE                             
         SLL   RF,1                2 BYTES PER                                  
         A     RF,AVPECNTS                                                      
         LH    R1,0(RF)                                                         
         AHI   R1,10               BUMP BY 1.0                                  
         CH    R1,PDRCMAX          VS CLASS MAXIMUM                             
         BH    GETVAL06            REJECT                                       
         CLI   VPCLASS2,0          TEST HAVE SECOND CLASS                       
         BE    GETVAL04            NO                                           
         SR    RF,RF                                                            
         IC    RF,VPC2SQ           CLASS 2 SEQUENCE                             
         SLL   RF,1                2 BYTES PER                                  
         A     RF,AVPECNTS                                                      
         LH    R1,0(RF)            0(RF)                                        
         AHI   R1,10               BUMP BY 1.0                                  
         CH    R1,PDRCMAX          VS CLASS MAXIMUM                             
         BH    GETVAL06            REJECT                                       
                                                                                
GETVAL04 SR    RF,RF                                                            
         IC    RF,VPAOCS           NUMBER OF TIMES PRODUCT USED SO FAR          
         SLL   RF,2                IS INDEX TO WHICH VALUE TO USE               
         LA    RF,VPVALS(RF)                                                    
         MVC   BRDVAL,0(RF)                                                     
         BR    RE                                                               
                                                                                
GETVAL06 MVC   BRDVAL,MAXNEG       REJECT BRAND                                 
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* Sum values and save best                                            *         
***********************************************************************         
                                                                                
SUMVAL   NTR1  ,                   SUM VALUES AND SAVE BEST ALLOC               
         MVC   PDRAVG,MAXNEG                                                    
         CLI   SPLPOPTN,SPLPGPPQ   IF DOING PSEUDO-PIGS                         
         BNE   SUMVAL02                                                         
         ICM   RE,15,PDRPRDS       TEST NO DUPE PIGGY                           
         BZ    SUMVAL02                                                         
         ICM   RF,15,PDRPRDS+PDRPRDL                                            
         BZ    SUMVAL02                                                         
         AHI   RF,VPPRD-VPLD                                                    
         AHI   RE,VPPRD-VPLD                                                    
         CLC   0(L'VPPRD,RF),0(RE)                                              
         BE    SUMVALX             IF SAME BRAND, REJECT                        
         MVC   SUMPRDA,0(RE)                                                    
         MVC   SUMPRDB,0(RF)                                                    
         GOTOR ACHKCLS,DMCB,SUMPRDA,0,SUMPRDB,0                                 
         BNE   SUMVALX             IF IN SAME CLASS, REJECT                     
                                                                                
SUMVAL02 CLC   UBUNLEN,UBPDLEN     TEST TOTALLY UNALLOCATED                     
         BE    SUMVALX             YES - IGNORE                                 
         CLC   UBUNLEN,PDRBUNL     TEST UNA LEN VS BEST UNA LEN                 
         BH    SUMVALX             IF WORSE IGNORE                              
         BE    SUMVAL04            IF SAME - JUST SUM THESE VALUES              
         MVC   PDRBUNL,UBUNLEN     IF BETTER - SAVE AS BEST                     
         MVC   PDRBAVG,MAXNEG      AND RESET BEST AVERAGE                       
         MVC   PDRBBLK,HWHIVAL     AND BEST BLOCKING SCORE                      
SUMVAL04 XC    PDRBSECS,PDRBSECS   CLEAR BLOCKED SECONDS                        
         CLI   APCSW,YESQ          TEST ACP LOGIC ACTIVE                        
         BNE   SUMVAL20            NO                                           
                                                                                
         LARL  R4,APCLST           YES - GET APC BLOCKING SCORE                 
         USING APCLSTD,R4                                                       
         SR    R6,R6               FOR USABLE SECONDS TOTAL                     
SUMVAL06 CLI   APCLSTD,0           TEST END OF APCLST                           
         BE    SUMVAL18                                                         
         LA    R3,PDRPRDS                                                       
                                                                                
SUMVAL08 OC    0(4,R3),0(R3)       EMPTY SLOT MEANS END                         
         BZ    SUMVAL14                                                         
         CLC   4(4,R3),MAXNEG      SO DOES UNUSABLE ENTRY                       
         BE    SUMVAL14                                                         
         L     R2,0(R3)                                                         
         USING VPLD,R2                                                          
         CLI   APCTYPE,APCTCLS     CLASS                                        
         BE    SUMVAL10                                                         
         CLC   APCPRD,VPPRD                                                     
         BNE   SUMVAL12                                                         
         B     SUMVAL16            PRODUCT IS BLOCKED                           
                                                                                
SUMVAL10 CLC   APCCLASS,VPCLASS1                                                
         BE    SUMVAL16            CLASS IS BLOCKED                             
         CLC   APCCLASS,VPCLASS2                                                
         BE    SUMVAL16            CLASS IS BLOCKED                             
                                                                                
SUMVAL12 AHI   R3,PDRPRDL                                                       
         B     SUMVAL08                                                         
                                                                                
SUMVAL14 SR    RF,RF               THIS PRODUCT/CLASS NOT BLOCKED               
         IC    RF,APCHLEN                                                       
         AR    R6,RF                                                            
                                                                                
SUMVAL16 AHI   R4,APCLSTL          BUMP TO NEXT APC ENTRY                       
         B     SUMVAL06                                                         
                                                                                
SUMVAL18 LH    RF,PDRRSECS         REMAINING SECONDS OUTSIDE THIS POD           
         SR    RF,R6               LESS USABLE SECONDS                          
         BP    *+6                 POS VALUE IS BLOCKED SECOND COUNT            
         SR    RF,RF               ELSE NO BLOCKED SECONDS                      
         STH   RF,PDRBSECS         SAVE BLOCKED SECOND SCORE                    
                                                                                
         CLC   PDRBSECS,PDRBBLK    TEST VS BEST (LEAST) SCORE                   
         BH    SUMVALX             IF WORSE IGNORE                              
         BE    SUMVAL20            IF SAME - JUST SUM THESE VALUES              
         MVC   PDRBBLK,PDRBSECS    IF BETTER - SAVE AS BEST                     
         MVC   PDRBAVG,MAXNEG      AND RESET BEST AVERAGE                       
SUMVAL20 LA    RF,PDRPRDS          SUM VALUES                                   
         SR    R1,R1                                                            
         SR    R7,R7                                                            
         LHI   R0,UBPODMAX                                                      
SUMVAL22 OC    0(4,RF),0(RF)       TEST USED                                    
         BZ    SUMVAL24            NO - DONE                                    
         CLC   4(4,RF),MAXNEG      PRODUCT NOT USABLE                           
         BE    SUMVAL24                                                         
         AHI   R7,1                BUMP COUNT                                   
         A     R1,4(RF)                                                         
         AHI   RF,PDRPRDL                                                       
         BCT   R0,SUMVAL22                                                      
SUMVAL24 M     R0,FW1              GET AVERAGE VALUE                            
         LR    RF,R7                                                            
         GOTOR DIVIDE                                                           
         ST    R1,PDRAVG                                                        
         C     R1,PDRBAVG          TEST VS BEST                                 
         BL    SUMVALX                                                          
         ST    R1,PDRBAVG                                                       
         MVC   PDRBLST,PDRPRDS     SAVE BEST LIST                               
SUMVALX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Routine to get product/unit                                         *         
***********************************************************************         
                                                                                
GPRUNT   NTR1  ,                                                                
GPRUNT02 OC    WSECS,WSECS         SET OFF PRODUCT LEVEL NO-OPS                 
         BZ    GPRUNTX                                                          
         GOTOR OPVARS                                                           
                                                                                
         XC    BESTPRD,BESTPRD     GET MOST DESERVING PRODUCT                   
         L     R2,AFSTBRD                                                       
LOC      USING TABD,R2                                                          
         LR    R4,R2                                                            
         AH    R4,WEEKDISP                                                      
         MVC   FULL,MAXNEG                                                      
         MVC   DUB(L'FULL),MAXNEG                                               
GPRUNT04 OC    LOC.TABPRD,LOC.TABPRD                                            
         BZ    GPRUNT14                                                         
         CLI   LOC.TABNOSPT,0      SKIP IF NO USABLE UNITS FOR PRODUCT          
         BNE   GPRUNT12                                                         
         ICM   R0,15,TRSCGOL-TABDATA(R4) MUST BE ACTIVE IN WEEK                 
         BNP   GPRUNT12                                                         
         CLI   WLENFLT,0           ANY LENGTH FILTER                            
         BE    *+14                                                             
         CLC   LOC.TABLEN,WLENFLT  YES - GOAL MUST AGREE                        
         BNE   GPRUNT12                                                         
*                                  SET PERCENT UNACHIEVED                       
         L     R1,TSAVDEM-TABDATA(R4) REMAINDER                                 
         LTR   R1,R1               IF OVERACHIEVED                              
         BP    GPRUNT06                                                         
         CLI   LOC.TABPRI,YESQ     DON'T GIVE PRIORITY BRAND ANOTHER            
         BE    GPRUNT12                                                         
         CLI   WLENFLT,0           OR IF DOING ONE LENGTH FOR PODS              
         BNE   GPRUNT12                                                         
GPRUNT06 CLI   WLENFLT,0           SKIP HIGHPRD SET                             
         BNE   GPRUNT08            IF DOING ONE LENGTH OF POD                   
         C     R1,DUB              SAVE NUMERICALY GREATEST REMAINDER           
         BL    GPRUNT08                                                         
         ST    R2,HIGHPRD          SAVE PRODUCT                                 
         ST    R1,DUB                                                           
GPRUNT08 M     R0,FW100                                                         
         L     RF,LOC.TABGOAL      GOAL                                         
         L     RE,WAVGOAL                                                       
         SRL   RE,3                PLUS 1/8 OF AVERAGE GOAL                     
         AR    RF,RE               NOTE - USING ADJUSTED DENOMINATOR            
         GOTOR DIVIDE              YIELDS BETTER VARIABLE - ESPECIALLY          
*                                  WHEN ACHIEVEMENT IS ZERO                     
GPRUNT10 C     R1,FULL             SAVE HIGH VALUE                              
         BNH   *+12                                                             
         ST    R2,BESTPRD                                                       
         ST    R1,FULL                                                          
GPRUNT12 AH    R2,ROWLEN                                                        
         AH    R4,ROWLEN                                                        
         B     GPRUNT04                                                         
                                                                                
GPRUNT14 ICM   R2,15,BESTPRD                                                    
         BZ    GPRUNTX                                                          
         CLI   CPMSOPTN,CPMSDLNQ                                                
         BE    *+12                                                             
         AH    R2,WEEKDISP         USE WEEKLY                                   
         B     *+8                                                              
         AHI   R2,TABDATA-TABD     OR SCHEDULE                                  
         OC    4(8,R2),4(R2)       TEST BRAND HAS ACHIEVEMENT                   
         BNZ   *+8                                                              
         OI    CPMVAR+VARCTLD,TVNOPQ                                            
                                                                                
         MVC   THISPRD,BESTPRD                                                  
         MVI   PVMODE1,ALPUNTQ                                                  
         MVI   PVMODE2,PVMODE1Q                                                 
         GOTOR APRTVAR                                                          
         GOTOR ASETVAL,VALUNTQ     EVALUATE UNITS AND SET BEST                  
         ICM   R5,15,BESTUNT       TEST ANY UNIT SELECTED                       
         BZ    GPRUNT02            NO - TRY ANOTHER BRAND                       
         ST    R5,THISUNT                                                       
         GOTOR PUTALC              RECORD ALLOCATION                            
         GOTOR AADDSUB,ADDITQ      POST TO TOTALS                               
         B     GPRUNT02                                                         
                                                                                
GPRUNTX  J     EXIT                                                             
         DROP  LOC                                                              
         EJECT                                                                  
ALPTRC   TM    DIAGNOP2,DPODBRDQ   TEST TRACE OPTN                              
         BZR   RE                                                               
                                                                                
ALPTRCN  NTR1  ,                                                                
         LA    R4,PDRPRDS                                                       
         LHI   R6,UBPODMAX                                                      
         LA    R3,P1+5                                                          
ALPTRC02 ICM   R2,15,0(R4)                                                      
         BZ    ALPTRC06                                                         
         USING VPLD,R2                                                          
         GOTOR LOCPRD,VPPRD                                                     
         MVC   0(L'PTPRDA,R3),PTPRDA-PTBUFFD(R1)                                
         MVI   3(R3),SLASH                                                      
         MVC   4(3,R3),DASHES                                                   
         CLC   4(4,R4),MAXNEG                                                   
         BE    ALPTRC04                                                         
         EDIT  (B4,4(R4)),(8,4(R3)),FLOAT=-,ALIGN=LEFT                          
ALPTRC04 AHI   R3,12                                                            
         AHI   R4,PDRPRDL                                                       
         BCT   R6,ALPTRC02                                                      
ALPTRC06 LA    R3,P1+80                                                         
         MVC   0(4,R3),=C'Una='                                                 
         EDIT  (B1,UBUNLEN),(3,4(R3)),ZERO=NOBLANK                              
         LA    R3,P1+89                                                         
         MVC   0(6,R3),=C'Block='                                               
         EDIT  (B2,PDRBSECS),(3,6(R3)),ZERO=NOBLANK                             
         LA    R3,P1+99                                                         
         MVC   0(4,R3),=C'Avg='                                                 
         MVC   9(3,R3),DASHES                                                   
         CLC   PDRAVG,MAXNEG                                                    
         BE    ALPTRC08                                                         
         EDIT  PDRAVG,(8,4(R3)),FLOAT=-                                         
ALPTRC08 CLC   PDRAVG,PDRBAVG                                                   
         BNE   *+8                                                              
         MVI   12(R3),ASTERISK                                                  
         GOTOR REPORT,XA=OFF                                                    
ALPTRCX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Test split usable                                                   *         
***********************************************************************         
                                                                                
TSTSPU   NTR1  ,                                                                
                                                                                
         LA    R0,WORK2            COPY LENGTH LIST INTO WORK2                  
         LHI   R1,L'PODPRDS                                                     
         L     RE,APODPRDS                                                      
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         SR    R7,R7               MAXIMUM ALLOCATABLE COUNTER                  
         LR    R6,R4               FIRST LENGTH OF SPLIT                        
TSTSPU02 CLI   0(R6),FF            TEST END OF SPLIT                            
         BE    TSTSPU06                                                         
         SR    RE,RE                                                            
         IC    RE,0(R6)            RE=LENGTH                                    
         LR    RF,RE                                                            
         SLL   RF,1                LENGTH X 2 (2 BYTES PER PRODUCT)             
         LA    RF,WORK2(RF)                                                     
         OC    0(2,RF),0(RF)       TEST STILL USABLE                            
         BZ    TSTSPU06            NO - DONE                                    
         CLC   PDRPMAX,HW20        IF LESS THAN 2.0                             
         BNL   TSTSPU04            PRODUCT OCCURRENCES PER PROGRAM              
         SR    R0,R0                                                            
         ICM   R0,3,0(RF)          DECREMENT USABLE PRODUCT COUNTER             
         BCTR  R0,0                                                             
         STCM  R0,3,0(RF)                                                       
TSTSPU04 AR    R7,RE               BUMP ALLOCATABLE TOTAL                       
         AHI   R6,1                NEXT LENGTH                                  
         B     TSTSPU02                                                         
                                                                                
TSTSPU06 TM    DIAGNOP2,DPODBRDQ   TEST TRACE SPLIT ON                          
         BZ    TSTSPU12                                                         
         MVC   P1(9),=C'***Split='                                              
         LA    RF,P1+14                                                         
         L     R1,PDRASLT                                                       
         AHI   R1,2                                                             
TSTSPU08 CLI   0(R1),FF                                                         
         BE    TSTSPU10                                                         
         EDIT  (B1,0(R1)),(2,0(RF))                                             
         MVI   2(RF),DASH                                                       
         AHI   RF,3                                                             
         AHI   R1,1                                                             
         B     TSTSPU08                                                         
                                                                                
TSTSPU10 BCTR  RF,0                                                             
         MVI   0(RF),SPACE                                                      
         LA    RF,P1+42                                                         
         MVC   0(14,RF),=C'Max allocable='                                      
         EDIT  (R7),(3,14(RF)),ZERO=NOBLANK                                     
         SR    R1,R1                                                            
         IC    R1,UBPDLEN                                                       
         SR    R0,R0                                                            
         IC    R0,PDRBUNL          TEST VS BEST ALLOC LENGTH SO FAR             
         SR    R1,R0                                                            
         CR    R7,R1                                                            
         BNL   *+10                                                             
         MVC   18(8,RF),=C'bypassed'                                            
         GOTOR REPORT,XA=OFF                                                    
                                                                                
TSTSPU12 SR    R1,R1                                                            
         IC    R1,UBPDLEN                                                       
         SR    R0,R0                                                            
         IC    R0,PDRBUNL          TEST VS BEST ALLOC LENGTH SO FAR             
         SR    R1,R0                                                            
         CR    R7,R1                                                            
         BL    TSTSPUX             (NOTE - CC = NOT EQUAL)                      
         CR    RE,RE               SET CC = 0K                                  
TSTSPUX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Trace POD/unit                                                      *         
***********************************************************************         
                                                                                
PUNTRC   TM    DIAGNOP2,DPODBRDQ   TEST TRACE OPTION                            
         BZR   RE                                                               
                                                                                
PUNTRCN  NTR1  ,                                                                
         MVC   P1(12),=C'***POD/Unit='                                          
         EDIT  (B2,UBSEQ),(5,P1+14)                                             
         MVC   P1+20(14),=C'  Final alloc='                                     
         LA    R6,UBPRD1                                                        
         CLI   BYTE,C'F'                                                        
         BE    PUNTRC02                                                         
         MVC   P1+20(14),=C'Initial alloc='                                     
         MVC   P1+90(20),=C'Other pods for prog='                               
         EDIT  (B2,PDRRSECS),(4,P1+110),ZERO=NOBLANK                            
         LA    R6,PDRSVAL                                                       
PUN      USING UBPRD1,R6                                                        
PUNTRC02 GOTOR FRMPRD,DMCB,PUN.UBPRD1,P1+34+(7*0)                               
         GOTOR FRMPRD,DMCB,PUN.UBPRD2,P1+34+(7*1)                               
         GOTOR FRMPRD,DMCB,PUN.UBPRD3,P1+34+(7*2)                               
         GOTOR FRMPRD,DMCB,PUN.UBPRD4,P1+34+(7*3)                               
         GOTOR FRMPRD,DMCB,PUN.UBPRD5,P1+34+(7*4)                               
         GOTOR FRMPRD,DMCB,PUN.UBPRD6,P1+34+(7*5)                               
         CLI   BYTE,C'F'           FOR FINAL TRACE                              
         BNE   PUNTRC04                                                         
         CLC   PDRSVAL,UBPRD1      TEST VS INITIAL ALLOCATION                   
         BE    PUNTRC04                                                         
         MVC   P1+78(10),=C'**Changed**'                                        
PUNTRC04 GOTOR REPORT,XA=OFF                                                    
PUNTRCX  J     EXIT                                                             
         DROP  PUN                                                              
         EJECT                                                                  
***********************************************************************         
* Subtract out all allocations for POD                                *         
***********************************************************************         
                                                                                
PODSUB   SR    R0,R0                                                            
         IC    R0,UBPDLEN          BUMP REMAINING SECONDS TOTAL                 
         AH    R0,PDRRSECS                                                      
         STH   R0,PDRRSECS                                                      
         OC    UBPRD1,UBPRD1       IF NO ALLOCATIONS                            
         BZR   RE                  DONE                                         
                                                                                
PODSUBN  NTR1  ,                                                                
         ST    R5,THISUNT          SUBTRACT OUT CURRENT ALLOCATIONS             
         LA    R4,UBPRD1           FIRST SLOT                                   
PODSUB02 ST    R4,ASLOT                                                         
         OC    0(L'UBPRD,R4),0(R4) DONE IF UNALLOCATED SLOT                     
         BZ    PODSUB10                                                         
                                                                                
         L     R2,AFSTBRD          FIND PRODUCT LIST ENTRY                      
         USING TABD,R2                                                          
PODSUB04 CLC   TABPRD,SUPPRD                                                    
         BNE   *+6                                                              
         DC    H'0'                PRODUCT NOT FOUND                            
         CLC   TABPRD,0(R4)        TEST RIGHT PRODUCT                           
         BNE   PODSUB06                                                         
         CLC   TABLEN,L'UBPRD(R4)  AND LENGTH                                   
         BE    PODSUB08                                                         
PODSUB06 AH    R2,ROWLEN           NEXT PRODUCT                                 
         B     PODSUB04                                                         
                                                                                
PODSUB08 ST    R2,THISPRD                                                       
         GOTOR AADDSUB,SUBITQ                                                   
         LA    R0,UBPRDX           TEST DONE                                    
         CR    R4,R0                                                            
         BE    PODSUB10                                                         
         AHI   R4,UBPRDL           BUMP SLOT                                    
         B     PODSUB02                                                         
                                                                                
PODSUB10 XC    UBPRDS(UBPRDSL),UBPRDS                                           
         MVC   UBUNLEN,UBPDLEN     SET TOTALLY UNALLOCATED                      
PODSUBX  J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Set ENV1 counts in VPECNTS for use by GETVAL                        *         
***********************************************************************         
                                                                                
SETEVC   NTR1  ,                                                                
         L     R1,AVPECNTS                                                      
         L     RE,AENV1SET         ENVIRONMENT 1 VALUE SET                      
         LH    RF,UBENV1                                                        
         SLL   RF,1                                                             
         LH    RF,ENVSTTAB-ENVSETD(RE,RF)                                       
         MH    RF,ENVENVD                                                       
         A     RF,ENVSACTC-ENVSETD(RE) USE ACTUAL UNIT COUNTS                   
         SR    RE,RE                                                            
         IC    RE,UBWEEK                                                        
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    RF,RE               RF AT POSITION FOR THIS WEEK                 
*                                  FOR FIRST PRODUCT                            
         ICM   RE,15,ENVTCNT       COUNT OF PRODUCTS + CLASSES FOR BCT          
         BZ    SETEVC04                                                         
SETEVC02 MVC   0(L'VPECNTS,R1),0(RF)                                            
         AHI   R1,L'VPECNTS                                                     
         AH    RF,ENVPRDD          NEXT PRODUCT                                 
         BCT   RE,SETEVC02                                                      
                                                                                
SETEVC04 TM    DIAGNOP2,DPODBRDQ   TEST TRACING                                 
         BZ    SETEVCX                                                          
         MVC   P1(21),=C'ENV1 PM=NNNN,CM=NNNN '                                 
         EDIT  (B2,PDRPMAX),(4,P1+8),ZERO=NOBLANK                               
         EDIT  (B2,PDRCMAX),(4,P1+16),ZERO=NOBLANK                              
         LA    R4,P1+22                                                         
         L     R3,AVPECNTS                                                      
         ICM   R6,15,ENVTCNT                                                    
         BZ    SETEVC08                                                         
SETEVC06 EDIT  (B2,0(R3)),(4,0(R4)),ZERO=NOBLANK                                
         AHI   R4,5                                                             
         AHI   R3,2                                                             
         BCT   R6,SETEVC06                                                      
SETEVC08 GOTOR REPORT,XA=OFF                                                    
                                                                                
SETEVCX  J     EXIT                                                             
         EJECT                                                                  
         USING VPLD,R2                                                          
VPADD    LHI   R0,10               + 1.0 UNITS                                  
         LHI   R1,1                + 1 OCCURENCE FOR PRODUCT                    
         B     VPDOIT                                                           
                                                                                
VPSUB    LHI   R0,-10                                                           
         LHI   R1,-1               -1 OCCURRENCE FOR PRODUCT                    
                                                                                
VPDOIT   SR    RF,RF                                                            
         IC    RF,VPAOCS           +1/-1 PRODUCT OCCURRENCES                    
         AR    RF,R1                                                            
         BNM   *+6                                                              
         DC    H'0'                                                             
         STC   RF,VPAOCS                                                        
         CLI   PINTRVL,0           TEST PRODUCT CHECK ACTIVE                    
         BE    VPDOIT02                                                         
         SR    RF,RF                                                            
         ICM   RF,3,VPPSQ          PRODUCT SEQUENCE NUMBER                      
         SLL   RF,1                                                             
         A     RF,AVPECNTS                                                      
         LR    R1,R0                                                            
         AH    R1,0(RF)            +/- 1.0                                      
         BNM   *+6                                                              
         DC    H'0'                                                             
         STH   R1,0(RF)                                                         
VPDOIT02 CLI   CINTRVL,0           IS CLASS CHECKING ACTIVE                     
         BE    VPDOITX                                                          
         CLI   VPCLASS1,0          IS PRODUCT IN A CLASS                        
         BE    VPDOITX             NO                                           
         SR    RF,RF                                                            
         IC    RF,VPC1SQ           CLASS 1 SEQUENCE NUMBER                      
         SLL   RF,1                                                             
         A     RF,AVPECNTS                                                      
         LR    R1,R0                                                            
         AH    R1,0(RF)            +/- 1.0                                      
         BNM   *+6                                                              
         DC    H'0'                                                             
         STH   R1,0(RF)                                                         
         CLI   VPCLASS2,0          IS THERE A SECOND CLASS                      
         BE    VPDOITX             NO                                           
         SR    RF,RF                                                            
         IC    RF,VPC2SQ           CLASS 2 SEQUENCE NUMBER                      
         SLL   RF,1                                                             
         A     RF,AVPECNTS                                                      
         LR    R1,R0                                                            
         AH    R1,0(RF)            +/- 1.0                                      
         BNM   *+6                                                              
         DC    H'0'                                                             
         STH   R1,0(RF)                                                         
VPDOITX  BR    RE                                                               
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Post allocation back to buffer                                      *         
***********************************************************************         
                                                                                
PUTALC   NTR1  ,                                                                
         L     R5,THISUNT                                                       
         L     R2,THISPRD                                                       
         USING TABD,R2                                                          
         CLI   ALPHASE,ALPUNTQ     UNIT PHASE                                   
         BE    PUTALC02                                                         
         CLI   ALPHASE,ALPBRDQ     BRAND PHASE                                  
         BE    PUTALC12                                                         
         CLI   ALPHASE,ALPXCHQ     EXCH PHASE                                   
         BE    PUTALC16                                                         
         CLI   ALPHASE,ALPS30Q     SPLIT 30'S PHASE                             
         BE    PUTALC14                                                         
*                                  UNIT PHASE                                   
PUTALC02 LA    R3,UBPRD1           FIND SLOT FOR ALLOCATION                     
         LHI   R0,UBPODMAX                                                      
PUTALC04 OC    0(L'UBPRD,R3),0(R3)                                              
         BZ    *+14                                                             
         AHI   R3,UBPRDL           2 BYTES PER ALLOCATION                       
         BCT   R0,PUTALC04                                                      
         DC    H'0'                NO SLOTS AVAILABLE                           
                                                                                
         MVC   0(L'UBPRD,R3),TABPRD                                             
         MVC   L'UBPRD(L'UBLEN,R3),TABLEN                                       
         TM    REQFLAG2,REQFSLEN   TEST IF ALL LENGTHS TOGETHER                 
         BNZ   PUTALC08                                                         
         MVC   L'UBPRD(L'UBLEN,R3),UBPDLEN                                      
         MVI   UBUNLEN,0                                                        
         B     PUTALC10                                                         
                                                                                
PUTALC08 SR    R0,R0                                                            
         IC    R0,UBUNLEN          DECREMENT UNALL LENGTH                       
         SR    R1,R1                                                            
         IC    R1,L'UBPRD(R3)                                                   
         SR    R0,R1                                                            
         BNM   *+6                                                              
         DC    H'0'                LENGTH CANNOT GO NEGATIVE                    
         STC   R0,UBUNLEN                                                       
                                                                                
PUTALC10 ST    R3,ASLOT            SET SLOT POSITION                            
         B     PUTALC18                                                         
*                                  'B' PHASE                                    
PUTALC12 B     PUTALC18            PRODUCT/LENGTH ALREADY SET                   
*                                  '3' PHASE                                    
PUTALC14 B     PUTALC18            PRODUCT/LENGTH ALREADY SET                   
                                                                                
PUTALC16 L     RF,ASLOT            'X' PHASE                                    
         MVC   0(L'UBPRD,RF),TABPRD                                             
         MVC   L'UBPRD(L'UBLEN,RF),TABLEN                                       
         TM    REQFLAG2,REQFSLEN   TEST IF ALL LENGTHS TOGETHER                 
         BNZ   PUTALC18                                                         
         MVC   L'UBPRD(L'UBLEN,RF),UBPDLEN                                      
                                                                                
PUTALC18 NI    UBSTAT1,FF-UBSRJCTQ RESET REJECTS                                
         MVC   WORK2(UBUFFKL),UBUFFK                                            
         GOTOR BU2RDH,WORK2                                                     
         CLC   UBUFFK(UBUFFKL),WORK2                                            
         BE    *+6                                                              
         DC    H'0'                RECORD DOESN'T EXITS                         
                                                                                
         LA    R0,WORK2            COPY RECORD INTO WORK2 AND PUT IT            
         L     R1,ABUFF2                                                        
         LH    R1,BUFFLREC-BUFFD(R1)                                            
         LA    RE,UBUFFRD                                                       
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         GOTOR BU2PUT,WORK2        (PUT RECORD FROM 24 BIT ADDRESS)             
                                                                                
PUTALCX  J     EXIT                                                             
         DROP  R2,R3,R4,R8,RB                                                   
                                                                                
PRDAR    DS    A                                                                
PRDBR    DS    A                                                                
SUMPRDA  DS    XL(L'VPPRD)                                                      
SUMPRDB  DS    XL(L'VPPRD)                                                      
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Add/subtract allocation                                             *         
***********************************************************************         
                                                                                
ADDITQ   EQU   0                   ADD                                          
SUBITQ   EQU   1                   SUBTRACT                                     
                                                                                
ADDSUB   NMOD1 0,**ADDSUB                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     R5,THISUNT                                                       
         USING UBUFFRD,R5                                                       
                                                                                
         MVI   ACHSW,ACHSADDQ      SET ADD MODE                                 
         CHI   R1,ADDITQ                                                        
         BE    ADDSUB04                                                         
         MVI   ACHSW,ACHSSUBQ      SET SUBTRACT MODE                            
                                                                                
         ICM   R0,15,UBCOST                                                     
         LCR   R0,R0                                                            
         STCM  R0,15,UBCOST                                                     
         ICM   R0,15,UBCDEM                                                     
         LCR   R0,R0                                                            
         STCM  R0,15,UBCDEM                                                     
                                                                                
         LA    RE,UBTARGS                                                       
         SR    R0,R0                                                            
         ICM   R0,3,NTARGETS                                                    
         BZ    ADDSUB04                                                         
ADDSUB02 L     RF,0(RE)                                                         
         LCR   RF,RF                                                            
         ST    RF,0(RE)                                                         
         AHI   RE,L'UBTARGS                                                     
         BCT   R0,ADDSUB02                                                      
                                                                                
ADDSUB04 ICM   R2,15,ASLOT                                                      
         BNZ   *+8                 ASLOT MAY NOT BE SET ON                      
         LA    R2,UBPRD1           NON-POD RUNS                                 
         MVC   WORK1,UBCOST                                                     
         LHI   R0,10               EQUIV UNITS = 1.0                            
         ST    R0,EQVUNTS                                                       
         CLI   PODRSW,YESQ         EQUIV ONLY FOR POD RUNS                      
         BNE   ADDSUB10                                                         
         SR    R1,R1                                                            
         IC    R1,L'UBPRD(R2)      LENGTH FOR THIS ALLOCATION                   
         ST    R1,ASECS                                                         
         CLC   PODLEN,L'UBPRD(R2)  SKIP IF = EQUIV BASE                         
         BE    ADDSUB06                                                         
         M     R0,FW10             FIND LENGTH FOR THIS ALLOCATION              
         LH    RF,PODEQU                                                        
         GOTOR DIVIDE                                                           
         ST    R1,EQVUNTS          EQUIVALENT UNITS FOR THIS ALLOCATION         
*                                  SET SHARE OF COST                            
ADDSUB06 L     R1,WORK1+0          COST AT WORK1+0                              
         M     R0,ASECS            X THESE SECONDS                              
         SR    RF,RF                                                            
         IC    RF,UBPDLEN          / TOTAL SECONDS                              
         GOTOR DIVIDE                                                           
         ST    R1,WORK1+0                                                       
*                                  EQUIVALENCE DEMOS                            
         CLC   PODLEN,L'UBPRD(R2)  SKIP IF = EQUIV BASE                         
         BE    ADDSUB10                                                         
         LH    R2,NTARGETS         FOR BCT                                      
         AHI   R2,1                ONE MORE FOR BASE                            
         LA    R4,WORK1+4          BASE AT WORK1+4                              
ADDSUB08 L     R1,0(R4)            DEMO VALUE                                   
         M     R0,ASECS            X THESE SECONDS                              
         LH    RF,PODEQU           / EQUIV BASE                                 
         GOTOR DIVIDE                                                           
         ST    R1,0(R4)                                                         
         AHI   R4,4                                                             
         BCT   R2,ADDSUB08                                                      
                                                                                
ADDSUB10 L     R3,THISPRD                                                       
         USING TABD,R3                                                          
         LA    R4,TABD                                                          
         AH    R4,WEEKDISP         POINT TO WEEK FOR PRODUCT                    
         TM    REQFLAG1,REQFTRGS   TARGETS                                      
         BZ    ADDSUB14                                                         
         LHI   R1,TABTA1-TABDATA   STARTING CELLD                               
         LA    RE,WORK1+8          TARGETS AT WORK1+8                           
         LH    R0,NTARGETS                                                      
ADDSUB12 L     RF,0(R4,R1)         WEEK                                         
         A     RF,0(RE)                                                         
         ST    RF,0(R4,R1)                                                      
         L     RF,TRSCGOL(R1)      TOTAL                                        
         A     RF,0(RE)                                                         
         ST    RF,TRSCGOL(R1)                                                   
         AHI   R1,L'TABTA1         NEXT TARGET                                  
         AHI   RE,4                                                             
         BCT   R0,ADDSUB12                                                      
                                                                                
ADDSUB14 L     RF,WORK1+4          BASE DEMO AT WORK1+4                         
         A     RF,4(R4)                                                         
         ST    RF,4(R4)                                                         
         L     RF,WORK1+0          COST AT WORK1+0                              
         A     RF,8(R4)                                                         
         ST    RF,8(R4)                                                         
         LHI   RF,10               1.0 UNITS                                    
         CLI   PODRSW,YESQ         IF NOT POD RUN                               
         BNE   *+12                                                             
         L     RE,ASLOT            ELSE USE ACTUAL SECONDS                      
         IC    RF,L'UBPRD(RE)                                                   
         CLI   ACHSW,ACHSADDQ      ADD IF ADDING                                
         BE    *+6                                                              
         LCR   RF,RF               ELSE SUBTRACT                                
         A     RF,12(R4)                                                        
         ST    RF,12(R4)                                                        
         L     RF,16(R4)           REMAINDER                                    
         L     R0,WORK1+0          SUBTRACT COST                                
         CLI   GOALOPT,GOALDOLS                                                 
         BE    ADDSUB16                                                         
         L     R0,WORK1+4          OR DEMO VALUE                                
         TM    REQFLAG1,REQFMIXB   IF MIXED DEMO GOALS                          
         BZ    ADDSUB16                                                         
         SR    RE,RE                                                            
         ICM   RE,1,TABGLDEM                                                    
         BZ    ADDSUB16            AND BRAND DEMO NOT = CORPORATE               
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         LA    RE,WORK1+8(RE)      TARGETS AT WORK1+8                           
         L     R0,0(RE)            USE BRAND DEMO                               
ADDSUB16 SR    RF,R0                                                            
         ST    RF,16(R4)                                                        
*                                  ** TOTALS **                                 
         L     RF,WORK1+4          DEMO AT WORK1+4                              
         A     RF,TPREDEM                                                       
         ST    RF,TPREDEM                                                       
         L     RF,WORK1+0          COST AT WORK1+0                              
         A     RF,TPREDOL                                                       
         ST    RF,TPREDOL                                                       
         LHI   RF,10               1.0 UNITS                                    
         CLI   PODRSW,YESQ         IF NOT POD RUN                               
         BNE   *+12                                                             
         L     RE,ASLOT            ELSE USE ACTUAL SECONDS                      
         IC    RF,L'UBPRD(RE)                                                   
         CLI   ACHSW,ACHSADDQ      ADD IF ADDING                                
         BE    *+6                                                              
         LCR   RF,RF               ELSE SUBTRACT                                
         A     RF,TPREUNT                                                       
         ST    RF,TPREUNT                                                       
         L     RF,TSAVDEM          REMAINDER                                    
         L     R0,WORK1+0          SUBTRACT COST                                
         CLI   GOALOPT,GOALDOLS                                                 
         BE    ADDSUB18                                                         
         L     R0,WORK1+4          OR DEMO VALUE                                
         TM    REQFLAG1,REQFMIXB   IF MIXED DEMO GOALS                          
         BZ    ADDSUB18                                                         
         SR    RE,RE                                                            
         ICM   RE,1,TABGLDEM                                                    
         BZ    ADDSUB18            AND BRAND DEMO NOT = CORPORATE               
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         L     R0,TABTA1-TABDATA(R4,RE) USE BRAND DEMO                          
ADDSUB18 SR    RF,R0                                                            
         ST    RF,TSAVDEM                                                       
*                                  POST TO ALL ENV COUNTER TABLES               
ADDSUB20 MVI   ENVNO,0             START WITH ENVIRONMENT 1                     
ADDSUB22 SR    R7,R7                                                            
         IC    R7,ENVNO            BUMP ENVIRONMENT NUMBER                      
         AHI   R7,1                                                             
         STC   R7,ENVNO                                                         
         CLI   ENVNO,NENVS         TEST ALL DONE                                
         BH    ADDSUB32                                                         
         SLL   R7,2                                                             
         L     R7,AENV1SET-L'AENV1SET(R7)                                       
         USING ENVSETD,R7                                                       
         OC    ENVSVAR,ENVSVAR     IS VARIABLE ACTIVE                           
         BNZ   ADDSUB24            YES                                          
         CLI   ENVNO,ENVNPGMQ      OR IF ENVIRONMENT 1                          
         BNE   ADDSUB22                                                         
         CLI   PINTRVL,0           AND INTERVAL CHECK ACTIVE                    
         BNE   ADDSUB24                                                         
         CLI   CINTRVL,0                                                        
         BE    ADDSUB22                                                         
                                                                                
ADDSUB24 GOTOR LOCPRD,TABPRD       POST TO ENVIRONMENT TABLES                   
         SR    RE,RE                                                            
         ICM   RE,3,PTENVSEQ-PTBUFFD(R1)                                        
         MH    RE,ENVPRDD                                                       
         SR    R1,R1                                                            
         IC    R1,ENVNO                                                         
         SLL   R1,1                                                             
         LH    R1,UBENV1-L'UBENV1(R1)                                           
         SLL   R1,1                                                             
         LH    R1,ENVSTTAB(R1)                                                  
         MH    R1,ENVENVD                                                       
         AR    R1,RE                                                            
         ST    R1,DUB              SAVE TOTAL DISPLACEMENT                      
         A     R1,ENVSACNT         R1 POINTS TO RIGHT COUNTER SET               
         GOTOR ADDTOT              BUMP TOTAL COUNTER                           
         SR    RE,RE                                                            
         IC    RE,UBWEEK           DO FOR THIS WEEK                             
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    R1,RE                                                            
         GOTOR ADDTOT                                                           
         CLI   PODRSW,YESQ         FOR POD RUN                                  
         BNE   ADDSUB26                                                         
         CLI   ENVNO,ENVNPGMQ      IF ENVIRONMENT 1                             
         BNE   ADDSUB26                                                         
*                                  DO 'ACTUAL' COUNTS ALSO                      
         MVC   FULL,EQVUNTS        SAVE EQUIV UNITS                             
         MVC   EQVUNTS,FW10        1.0 UNIT                                     
         L     R1,DUB              RESTORE TOTAL DISPLACEMENT                   
         A     R1,ENVSACTC                                                      
         GOTOR ADDTOT                                                           
         SR    RE,RE                                                            
         IC    RE,UBWEEK           AND WEEK COUNTER                             
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    R1,RE                                                            
         GOTOR ADDTOT                                                           
         MVC   EQVUNTS,FULL        RESTORE EQUIV UNITS                          
ADDSUB26 CLI   CINTRVL,0           TEST NEED CLASSES                            
         BE    ADDSUB22                                                         
         CLI   ENVNO,ENVNPGMQ      CLASSES ONLY FOR ENVIRONMENT 1               
         BNE   ADDSUB22                                                         
         GOTOR SETCLS,TABCLASS                                                  
         BE    ADDSUB22            SKIP IF NO CLASS                             
ADDSUB28 SR    R1,R1                                                            
         ICM   R1,1,CLASS1         CLASS CODE                                   
         BZ    ADDSUB30                                                         
         A     R1,ACLSTRT                                                       
         SR    RE,RE                                                            
         IC    RE,0(R1)            DISPLACEMENT CODE                            
         MH    RE,ENVPRDD                                                       
         SR    R1,R1                                                            
         IC    R1,ENVNO                                                         
         SLL   R1,1                                                             
         LH    R1,UBENV1-L'UBENV1(R1)                                           
         SLL   R1,1                                                             
         LH    R1,ENVSTTAB(R1)                                                  
         MH    R1,ENVENVD                                                       
         AR    R1,RE                                                            
         ST    R1,DUB              SAVE TOTAL DISPLACEMENT                      
         A     R1,ENVSACNT         R1 POINTS TO RIGHT COUNTER SET               
         GOTOR ADDTOT              BUMP TOTAL COUNTER                           
         SR    RE,RE                                                            
         IC    RE,UBWEEK           DO FOR THIS WEEK                             
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    R1,RE                                                            
         GOTOR ADDTOT                                                           
         CLI   PODRSW,YESQ         FOR POD RUN                                  
         BNE   ADDSUB30                                                         
         CLI   ENVNO,ENVNPGMQ      IF ENVIRONMENT 1                             
         BNE   ADDSUB30                                                         
*                                  DO 'ACTUAL' COUNTS ALSO                      
         MVC   FULL,EQVUNTS        SAVE EQUIV UNITS                             
         MVC   EQVUNTS,FW10        1.0 UNIT                                     
         L     R1,DUB              RESTORE TOTAL DISPLACEMENT                   
         A     R1,ENVSACTC                                                      
         GOTOR ADDTOT                                                           
         SR    RE,RE                                                            
         IC    RE,UBWEEK           AND WEEK COUNTER                             
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    R1,RE                                                            
         GOTOR ADDTOT                                                           
         MVC   EQVUNTS,FULL        RESTORE EQUIV UNITS                          
ADDSUB30 CLI   CLASS2,0            TEST NEED TO DO 2ND OF 2 PART CLASS          
         BE    ADDSUB22            NO                                           
         MVC   CLASS1,CLASS2                                                    
         MVI   CLASS2,0                                                         
         B     ADDSUB28                                                         
                                                                                
ADDSUB32 CLI   ACHSW,ACHSSUBQ      IF SUBTRACT MODE                             
         BNE   ADDSUBX                                                          
         ICM   R0,15,UBCOST        RE-COMPLEMENT VALUES                         
         LCR   R0,R0                                                            
         STCM  R0,15,UBCOST                                                     
         ICM   R0,15,UBCDEM                                                     
         LCR   R0,R0                                                            
         STCM  R0,15,UBCDEM                                                     
                                                                                
         LA    RE,UBTARGS                                                       
         SR    R0,R0                                                            
         ICM   R0,3,NTARGETS                                                    
         BZ    ADDSUBX                                                          
ADDSUB34 L     R1,0(RE)                                                         
         LCR   R1,R1                                                            
         ST    R1,0(RE)                                                         
         AHI   RE,L'UBTARGS                                                     
         BCT   R0,ADDSUB34                                                      
                                                                                
ADDSUBX  J     EXIT                                                             
         DROP  R3,R7                                                            
                                                                                
ADDTOT   LH    RF,0(R1)            BUMP ENVIRONMENT COUNTER                     
         L     R0,EQVUNTS          EQUIVALENT UNITS                             
         CLI   ACHSW,ACHSADDQ                                                   
         BE    *+6                                                              
         LCR   R0,R0               OR SUBTRACT                                  
         AR    RF,R0                                                            
         BNM   *+6                 SHOULD NEVER GO -VE                          
         SR    RF,RF               SET TO ZERO IF IT DOES                       
         STH   RF,0(R1)                                                         
         BR    RE                                                               
         DROP  RB                                                               
                                                                                
ASECS    DS    F                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Class check for two brands in pseudo-pig                            *         
***********************************************************************         
                                                                                
CHKCLS   NMOD1 0,**CHKCLS                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         ICM   R2,15,4(R1)         TEST A(PRODUCT 1) SUPPLIED                   
         BNZ   CHKCLS04                                                         
         L     R2,AFSTBRD          PRODUCT TABLE ENTRY FOR FIRST                
         L     RF,0(R1)                                                         
PR1      USING TABD,R2                                                          
CHKCLS02 OC    PR1.TABPRD,PR1.TABPRD                                            
         BNZ   *+6                                                              
         DC    H'0'                PRODUCT MISSING                              
         CLC   PR1.TABPRD,0(RF)                                                 
         BE    CHKCLS04                                                         
         AH    R2,ROWLEN           NEXT ROW                                     
         B     CHKCLS02                                                         
                                                                                
PR2      USING TABD,R3                                                          
CHKCLS04 ICM   R3,15,12(R1)        TEST A(PRODUCT 2) SUPPLIED                   
         BNZ   CHKCLS08                                                         
         L     RF,8(R1)                                                         
         L     R3,AFSTBRD          PRODUCT TABLE ENTRY FOR SECOND               
CHKCLS06 OC    PR2.TABPRD,PR2.TABPRD                                            
         BNZ   *+6                                                              
         DC    H'0'                PRODUCT MISSING                              
         CLC   PR2.TABPRD,0(RF)                                                 
         BE    CHKCLS08                                                         
         AH    R3,ROWLEN           NEXT ROW                                     
         B     CHKCLS06                                                         
                                                                                
CHKCLS08 CLI   SPCLOPTN,0          'SPECIAL CLASS' CODE                         
         BE    CHKCLS10                                                         
         CLI   PR1.TABCLASS,TWOPTCLS                                            
         BNH   CHKCLS10            SINGLE CLASSES                               
         CLI   PR2.TABCLASS,TWOPTCLS                                            
         BNH   CHKCLS10                                                         
         CLC   PR1.TABCLASS,PR2.TABCLASS                                        
         BNE   CHKCLS10                                                         
         CLC   PR1.TABCLASS,SPCLOPTN                                            
         JE    EXIT                                                             
                                                                                
CHKCLS10 XC    DUB,DUB             SET VARIOUS CLASSES IN DUB                   
         GOTOR SETCLS,PR1.TABCLASS                                              
         JE    EXIT                NO CLASS - OK                                
         MVC   DUB+0(2),CLASS1                                                  
                                                                                
         GOTOR SETCLS,PR2.TABCLASS                                              
         JE    EXIT                NO CLASS - OK                                
         MVC   DUB+2(2),CLASS1                                                  
                                                                                
         LA    R1,DUB+0            NOW TRY ALL COMBOS                           
         LA    RF,DUB+2                                                         
         GOTOR CLSCMP                                                           
                                                                                
         LA    RF,DUB+3                                                         
         GOTOR CLSCMP                                                           
                                                                                
         LA    R1,DUB+1                                                         
         LA    RF,DUB+2                                                         
         GOTOR CLSCMP                                                           
                                                                                
         LA    RF,DUB+3                                                         
         GOTOR CLSCMP                                                           
                                                                                
         CR    RE,RE               CLASSES NOT THE SAME                         
         J     EXIT                                                             
         DROP  PR1,PR2                                                          
                                                                                
CLSCMP   CLC   0(1,R1),0(RF)       CLASSES EQUAL                                
         BNER  RE                  NO - RETURN                                  
         CLI   0(R1),0             IF EQUAL BUT 0, THATS OK TOO                 
         BER   RE                                                               
         LTR   RE,RE               ELSE SET CLASSES THE SAME                    
         J     EXIT                                                             
         DROP  RB                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Build value/product list                                            *         
***********************************************************************         
                                                                                
BLDVPL   NMOD1 0,**BLDVPL                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         USING UBUFFRD,R5                                                       
         MVI   WLENFLT,0                                                        
         L     R0,APODPRDS                                                      
         GOTOR CLEAR,L'PODPRDS                                                  
         LARL  RF,APCLST                                                        
         XC    0(APCLSTL,RF),0(RF)                                              
         MVI   PVMODE1,ALPBRDQ                                                  
         MVI   PVMODE2,PVMODE1Q                                                 
         GOTOR APRTVAR                                                          
                                                                                
         L     R2,AFSTBRD                                                       
         USING TABD,R2                                                          
         LARL  R3,VPLIST                                                        
         USING VPLD,R3                                                          
         MVI   VPLD,VPLEOTQ        CLEAR LIST                                   
BLDVPL02 CLC   TABPRD,SUPPRD       TEST END OF LIST                             
         BE    BLDVPL28                                                         
         CLC   TABLEN,UBPDLEN      TEST WILL FIT IN POD                         
         BH    BLDVPL26            NO - NEXT PRODUCT                            
         BE    BLDVPL04                                                         
         TM    UBSTAT2,UBSDPODQ    IF NOT A DIVISIBLE POD                       
         BZ    BLDVPL26            MUST FIT EXACTLY                             
BLDVPL04 XC    VPLD(VPLDL),VPLD    CLEAR ENTRY                                  
         MVC   VPPRD,TABPRD                                                     
         STCM  R2,15,VPPRDA                                                     
         MVC   VPLEN,TABLEN                                                     
         CLI   CINTRVL,0           IF NOT CHECKING CLASSES                      
         BE    BLDVPL06            IGNORE THEM                                  
         GOTOR SETCLS,TABCLASS                                                  
         MVC   VPCLASS1,CLASS1                                                  
         MVC   VPCLASS2,CLASS2                                                  
                                                                                
BLDVPL06 GOTOR LOCPRD,VPPRD                                                     
         MVC   VPPSQ,PTENVSEQ-PTBUFFD(R1)                                       
                                                                                
         SR    RE,RE                                                            
         ICM   RE,1,VPCLASS1       SET CLASS1 SEQ FOR ENV 1 COUNTS              
         BZ    *+14                                                             
         A     RE,ACLSTRT                                                       
         MVC   VPC1SQ,0(RE)        VALUE FROM TRANSLATE TABLE                   
                                                                                
         SR    RE,RE                                                            
         ICM   RE,1,VPCLASS2       SET CLASS2 SEQ FOR ENV 1 COUNTS              
         BZ    *+14                                                             
         A     RE,ACLSTRT                                                       
         MVC   VPC2SQ,0(RE)        VALUE FROM TRANSLATE TABLE                   
                                                                                
         LHI   RF,UBPODMAX         SET ALL VALUES TO MAXNEG                     
         LA    RE,VPVALS                                                        
         MVC   0(L'VPVALS,RE),MAXNEG                                            
         AHI   RE,L'VPVALS                                                      
         BCT   RF,*-10                                                          
         SR    R1,R1                                                            
         IC    R1,UBPDLEN          SET MAXIMUM OCCURENCES                       
         SR    R0,R0               = POD LENGTH                                 
         SR    RF,RF                                                            
         IC    RF,TABLEN           / THIS LENGTH                                
         DR    R0,RF               NO ROUND                                     
         STC   R1,VPMOCS                                                        
         LR    R0,R1               SET BCT = MAXIMUM OCCURRENCES                
         LA    R4,VPVALS                                                        
         LA    RF,UBPRD1                                                        
         ST    RF,ASLOT                                                         
BLDVPL12 MVC   UBPRD1,VPPRD        NOTE - CAN ALWAYS USE FIRST SLOT             
         MVC   UBLEN1,VPLEN                                                     
         ST    R2,THISPRD                                                       
         GOTOR ASETVAL,VALBRDQ                                                  
         TM    UBSTAT1,UBSRJCTQ    HANDLE 'REJECTS'                             
         BNZ   *+14                                                             
         CLC   BRDVAL,MAXNEG       BUT NOT INACTIVES                            
         BE    BLDVPL16                                                         
         XC    BESTPRD,BESTPRD                                                  
         MVI   PVMODE2,PVMODE2Q                                                 
         GOTOR APRTVAR                                                          
         CLC   BRDVAL,MAXNEG       DONE IF REJECT                               
         BE    BLDVPL16                                                         
         MVC   0(L'VPVALS,R4),BRDVAL                                            
         BCT   R0,*+8                                                           
         B     BLDVPL16                                                         
         AHI   R4,L'VPVALS                                                      
         GOTOR AADDSUB,ADDITQ                                                   
         B     BLDVPL12                                                         
                                                                                
BLDVPL16 LA    R0,VPVALS           DONE WITH GETING VALUES                      
         SR    R4,R0               NOW SUBTRACT BACK OUT                        
         BNP   BLDVPL18            NUMBER OF TIMES DID ADDACH                   
         LR    R0,R4                                                            
         SRL   R0,2                /4 = NUMBER TO BACK OUT                      
         GOTOR AADDSUB,SUBITQ                                                   
         BCT   R0,*-2                                                           
                                                                                
BLDVPL18 XC    UBPRD(UBPRDL),UBPRD CLEAR THE TEMPORARY ALLOCATION               
         CLC   VPVALS,MAXNEG       TEST BRAND USABLE AT ALL                     
         BE    BLDVPL26            NO - DON'T SAVE ENTRY                        
         SR    RF,RF                                                            
         IC    RF,VPLEN            ALSO KEEP COUNT BY LENGTH                    
         SLL   RF,1                LENGTH X 2 (2 BYTES PER PRODUCT)             
         A     RF,APODPRDS         IN PODPRD                                    
         SR    R0,R0                                                            
         ICM   R0,3,0(RF)                                                       
         AHI   R0,1                                                             
         STCM  R0,3,0(RF)                                                       
*                                  ALSO ADD TO APCLST                           
*                                  (AVAILABLE PRODUCTS/CLASSES)                 
         CLI   APCSW,YESQ          TEST APC LOGIC ACTIVE                        
         BNE   BLDVPL24                                                         
         CLC   PDRCMAX,HW20        IF CLASS LIMIT IS 2.0+                       
         BNL   BLDVPL20            THEN IGNORE CLASSES FOR APCLST               
*                                  (BECAUSE THE APC LOGIC HANDLES               
*                                  YES OR NO EXCLUSION)                         
         CLI   VPCLASS1,0          TEST HAVE ANY CLASS                          
         BNE   BLDVPL22                                                         
                                                                                
BLDVPL20 MVI   APCPTYP,APCTPRD     ADD AS STAND-ALONE PRODUCT                   
         MVC   APCPVAL(L'VPPRD),VPPRD                                           
         GOTOR SETAPC                                                           
         B     BLDVPL24                                                         
                                                                                
BLDVPL22 MVI   APCPTYP,APCTCLS     ADD CLASS(ES)                                
         XC    APCPVAL,APCPVAL                                                  
         MVC   APCPVAL(L'VPCLASS1),VPCLASS1                                     
         GOTOR SETAPC                                                           
                                                                                
         CLI   VPCLASS2,0          TEST HAVE 2 CLASSES                          
         BE    BLDVPL24                                                         
         MVC   APCPVAL(L'VPCLASS2),VPCLASS2                                     
         GOTOR SETAPC                                                           
                                                                                
BLDVPL24 AHI   R3,VPLDL            BUMP TO NEXT ENTRY                           
BLDVPL26 AH    R2,ROWLEN           BUMP TO NEXT PRODUCT                         
         B     BLDVPL02                                                         
                                                                                
BLDVPL28 MVI   VPLD,VPLEOTQ        SET END OF LIST                              
                                                                                
         TM    DIAGNOP2,DPODBRDQ   PRINT TRACE OF PRODUCT/VALUE LIST            
         BZ    BLDVPLX                                                          
         GOTOR REPORT,XA=OFF                                                    
                                                                                
         LARL  RE,VPLHD1                                                        
         MVC   P1(L'VPLHD1),0(RE)                                               
         GOTOR REPORT,XA=OFF                                                    
                                                                                
         LARL  R3,VPLIST                                                        
BLDVPL30 CLI   VPLD,VPLEOTQ                                                     
         BE    BLDVPL36                                                         
         EDIT  (B1,VPLEN),(3,P1)                                                
         GOTOR LOCPRD,VPPRD                                                     
         MVC   P1+5(L'PTPRDA),PTPRDA-PTBUFFD(R1)                                
         MVC   P1+10(2),VPCLASS1                                                
         EDIT  (B2,VPPSQ),(3,P1+14),ZERO=NOBLANK                                
         EDIT  (B1,VPC1SQ),(3,P1+18),ZERO=NOBLANK                               
         EDIT  (B1,VPC2SQ),(3,P1+22),ZERO=NOBLANK                               
         EDIT  (B1,VPMOCS),(3,P1+26),ZERO=NOBLANK                               
         EDIT  (B1,VPAOCS),(3,P1+30),ZERO=NOBLANK                               
         LHI   R7,UBPODMAX                                                      
         LA    R4,P1+37                                                         
         LA    R6,VPVALS                                                        
BLDVPL32 CLC   0(L'VPVALS,R6),MAXNEG                                            
         BE    BLDVPL34                                                         
         EDIT  (B4,0(R6)),(8,0(R4)),FLOAT=-                                     
         AHI   R4,8                                                             
         AHI   R6,L'VPVALS                                                      
         BCT   R7,BLDVPL32                                                      
BLDVPL34 GOTOR REPORT,XA=OFF                                                    
         AHI   R3,VPLDL                                                         
         B     BLDVPL30                                                         
                                                                                
BLDVPL36 LARL  R4,APCLST                                                        
         USING APCLSTD,R4                                                       
         CLI   APCLSTD,0                                                        
         BE    BLDVPLX                                                          
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
                                                                                
         MVC   P1(6),=C'APCLST'                                                 
BLDVPL38 CLI   APCLSTD,0                                                        
         BE    BLDVPLX                                                          
         MVC   P1+8(L'APCTYPE),APCTYPE                                          
         MVC   P1+10(L'APCCLASS),APCCLASS                                       
         CLI   APCTYPE,APCTCLS                                                  
         BE    BLDVPL40                                                         
         GOTOR LOCPRD,APCPRD                                                    
         MVC   P1+10(L'PTPRDA),PTPRDA-PTBUFFD(R1)                               
BLDVPL40 EDIT  (B1,APCHLEN),(3,P1+16),ZERO=NOBLANK                              
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         AHI   R4,APCLSTL                                                       
         B     BLDVPL38                                                         
                                                                                
BLDVPLX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Set entries in available product/class list                         *         
***********************************************************************         
                                                                                
SETAPC   LARL  R4,APCLST                                                        
SETAPC02 CLC   0(APCKEYL,R4),APCPTYP FIND MATCHING ENTRY                        
         BE    SETAPC04                                                         
         CLI   APCLSTD,0           TEST END OF LIST                             
         BE    *+12                                                             
         AHI   R4,APCLSTL                                                       
         B     SETAPC02                                                         
                                                                                
         MVC   APCTYPE,APCPTYP                                                  
         CLI   APCTYPE,APCTPRD     TEST PRODUCT OR CLASS                        
         BNE   *+14                                                             
         MVC   APCPRD,APCPVAL                                                   
         B     *+10                                                             
         MVC   APCCLASS,APCPVAL                                                 
         MVC   APCHLEN,VPLEN                                                    
         MVI   APCLSTD+APCLSTL,0   SET NEW END                                  
         BR    RE                                                               
                                                                                
SETAPC04 CLC   VPLEN,APCHLEN       SAVE HIGHEST GOAL LENGTH                     
         BNHR  RE                                                               
         MVC   APCHLEN,VPLEN                                                    
         BR    RE                                                               
         DROP  R3,R5,RB                                                         
                                                                                
APCPTYP  DS    XL(L'APCTYPE)       BLDVPL/SETAPC TYPE                           
APCPVAL  DS    XL(L'APCPRD)        BLDVPL/SETAPC VALUE                          
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Valuation routines                                                  *         
***********************************************************************         
                                                                                
VALBRDQ  EQU   0                   VALUE BRAND                                  
VALUNTQ  EQU   1                   VALUE UNIT                                   
                                                                                
SETVAL   NMOD1 0,**SETVAL                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         CHI   R1,VALUNTQ          TEST VALUE UNIT                              
         BE    VALUNT                                                           
                                                                                
***********************************************************************         
* Value brand for unit                                                *         
***********************************************************************         
                                                                                
VALBRD   L     R5,THISUNT                                                       
         USING UBUFFRD,R5                                                       
         NI    UBSTAT1,FF-UBSRJCTQ CLEAR REJECT BITS                            
         MVC   BRDVAL,MAXNEG       SET TO MAXIMUM NEGATIVE                      
         XC    VARVALS(VARWGTSL),VARVALS                                        
         L     R2,THISPRD          TEST BRAND ACTIVE IN WEEK                    
         AH    R2,WEEKDISP                                                      
         OC    0(4,R2),0(R2)                                                    
         BZ    VALBRDX                                                          
         GOTOR AUNTUSE             TEST UNIT USABLE FOR BRAND                   
         BNZ   VALBRD10            NO                                           
         XC    BRDVAL,BRDVAL                                                    
         L     R2,THISPRD                                                       
         GOTOR SETCSH              SET COST SHARE                               
         ST    R1,COSTSHR          RETURNED IN R1                               
                                                                                
         LA    RF,VSBRTAB                                                       
         LA    R3,VARWGTS                                                       
         LA    R4,VARVALS                                                       
         LHI   R0,VARWGTSN                                                      
VALBRD02 OC    0(L'VARWGTS,R3),0(R3) TEST VAR ACTIVE                            
         BZ    VALBRD06                                                         
         CLI   VARCTLD(R3),0       TEST NO-OPED                                 
         BNE   VALBRD06                                                         
                                                                                
         XC    HOLDVAR,HOLDVAR                                                  
         LA    RE,VALBRD04                                                      
         NTR1  LABEL=NO                                                         
         BR    RF                                                               
                                                                                
VALBRD04 TM    UBSTAT1,UBSRJCTQ    TEST REJECT                                  
         BNZ   VALBRD10                                                         
         MVC   0(L'VARVALS,R4),HOLDVAR                                          
         L     R1,0(R4)            SUM VALUES - VALUE                           
         MH    R1,2(R3)            X WEIGHT                                     
         A     R1,BRDVAL                                                        
         ST    R1,BRDVAL                                                        
                                                                                
VALBRD06 AHI   RF,L'VSBRTAB        NEXT VARIABLE                                
         AHI   R3,L'VARWGTS                                                     
         AHI   R4,L'VARVALS                                                     
         BCT   R0,VALBRD02                                                      
                                                                                
         L     R0,BRDVAL           TEST VS CURRENT BEST                         
         C     R0,BESTVAL                                                       
         BL    VALBRD10            NOT AS GOOD                                  
         BH    VALBRD08            BETTER                                       
         CLC   THISPRD,CURAPRD     IF = SELECT ONLY IF CURRENT ASSIGN           
         BNE   VALBRD10                                                         
VALBRD08 ST    R0,BESTVAL                                                       
         ST    R2,BESTPRD                                                       
                                                                                
VALBRD10 CLI   ALPHASE,ALPXCHQ     ON EXCHANGE PHASE SKIP TRACE                 
         BE    VALBRDX                                                          
         CLI   PODRSW,YESQ         FOR POD RUNS                                 
         BE    VALBRDX                                                          
         MVI   PVMODE2,PVMODE2Q    FOR VARIABLE TRACE                           
         GOTOR APRTVAR                                                          
VALBRDX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Set variables for unit                                              *         
***********************************************************************         
                                                                                
VALUNT   L     R2,THISPRD                                                       
         MVC   BESTVAL,MAXNEG                                                   
         XC    BESTUNT,BESTUNT                                                  
         ICM   R6,15,UNTTABN                                                    
         BZ    VALUNT20                                                         
         L     R5,AUNTTAB                                                       
VALUNT02 NI    UBSTAT1,FF-UBSRJCTQ CLEAR REJECT BITS                            
         CLI   UBUNLEN,0           TEST ANY UNALLOCATED LENGTH                  
         BE    VALUNT18            NO - REJECT                                  
         TM    UBSTAT2,UBSDPODQ    TEST IF A DIVISIBLE POD                      
         BNZ   VALUNT04            YES - OK                                     
         CLC   UBUNLEN,TABLEN      NO - LENGTH MUST FIT EXACTLY                 
         BE    VALUNT06                                                         
         TM    REQFLAG2,REQFSLEN   OK IF ALL LENGTHS TOGETHER                   
         BZ    VALUNT06                                                         
         B     VALUNT18                                                         
VALUNT04 CLC   UBUNLEN,TABLEN      SKIP IF NOT ENOUGH                           
         BL    VALUNT18            ROOM FOR THIS LENGTH                         
VALUNT06 OC    UBPRDX,UBPRDX       SKIP IF NO SLOTS LEFT                        
         BNZ   VALUNT18                                                         
         ST    R5,THISUNT                                                       
         GOTOR SETCSH              SET COST SHARE                               
         ST    R1,COSTSHR          RETURNED IN R1                               
         XC    UNTVAL,UNTVAL                                                    
         GOTOR AUNTUSE             TEST UNIT USABLE FOR BRAND                   
         BNZ   VALUNT16            NO                                           
VALUNT08 XC    VARVALS(VARWGTSL),VARVALS                                        
         LA    RF,VSBRTAB                                                       
         LA    R3,VARWGTS                                                       
         LA    R4,VARVALS                                                       
         LHI   R0,VARWGTSN                                                      
VALUNT10 OC    0(L'VARWGTS,R3),0(R3) TEST VARIABLE ACTIVE                       
         BZ    VALUNT14            (WEIGHT NOT EQUAL ZERO)                      
         CLI   VARCTLD(R3),0       TEST NO-OPED                                 
         BNE   VALUNT14                                                         
                                                                                
         XC    HOLDVAR,HOLDVAR                                                  
         LA    RE,VALUNT12                                                      
         NTR1  LABEL=NO                                                         
         BR    RF                                                               
                                                                                
VALUNT12 TM    UBSTAT1,UBSRJCTQ    TEST REJECT                                  
         BNZ   VALUNT16                                                         
         MVC   0(L'VARVALS,R4),HOLDVAR                                          
         L     R1,0(R4)            SUM VALUES - VALUE                           
         MH    R1,2(R3)            X WEIGHT                                     
         A     R1,UNTVAL                                                        
         ST    R1,UNTVAL                                                        
                                                                                
VALUNT14 AHI   RF,L'VSBRTAB        NEXT VARIABLE                                
         AHI   R3,L'VARWGTS                                                     
         AHI   R4,L'VARVALS                                                     
         BCT   R0,VALUNT10                                                      
                                                                                
         L     R0,UNTVAL           TEST VS CURRENT BEST                         
         C     R0,BESTVAL                                                       
         BNH   VALUNT16                                                         
         ST    R0,BESTVAL          SAVE BEST VALUE                              
         ST    R5,BESTUNT          SAVE BEST UNIT                               
VALUNT16 MVI   PVMODE2,PVMODE2Q                                                 
         GOTOR APRTVAR                                                          
VALUNT18 A     R5,UNTTABL          NEXT UNIT                                    
         BCT   R6,VALUNT02                                                      
                                                                                
VALUNT20 OC    BESTUNT,BESTUNT                                                  
         BNZ   *+12                                                             
         MVI   TABNOSPT,FF         SET NO USABLE UNIT FOR PRODUCT               
         B     VALUNTX                                                          
                                                                                
         L     RF,WSECS            DECREMENT REMAINING LENGTH                   
         SR    R0,R0                                                            
         IC    R0,TABLEN           BY LENGTH BEING ALLOCATED                    
         TM    REQFLAG2,REQFSLEN   BUT IF ALL LENGTHS TOGETHER                  
         BNZ   *+12                                                             
         L     R5,BESTUNT                                                       
         IC    R0,UBPDLEN          DECREMENT BY UNIT LENGTH                     
         SR    RF,R0                                                            
         BNM   *+6                                                              
         DC    H'0'                                                             
         ST    RF,WSECS                                                         
         MVC   THISUNT,BESTUNT                                                  
         L     R5,THISUNT                                                       
         OI    UBSTAT1,UBSANETQ    SET ALLOCATED IN UNIT PHASE                  
                                                                                
VALUNTX  J     EXIT                                                             
                                                                                
VSBRTAB  DS    0XL4                                                             
         B     GOLFUL              GOAL FULFILLMENT                             
         B     CPPDEV              CPP(M) DEVIATION                             
         B     PRDDSP              PRODUCT DISPERSION                           
         B     NETDSP              NETWORK DISPERSION                           
         B     DOWDSP              DAY OF WEEK DISPERSION                       
         B     TARG01              TARGET 1                                     
         B     TARG02              TARGET 2                                     
         J     EXIT                N/D                                          
         EJECT                                                                  
***********************************************************************         
* Variable 1  - goal fulfillment                                      *         
***********************************************************************         
                                                                                
GOLFUL   L     RF,TABGOAL          WORKING GOAL                                 
         LA    R4,TABD                                                          
         AH    R4,WEEKDISP                                                      
         L     R1,TSAVDEM-TABDATA(,R4) REMAINDER                                
         CLI   ALPHASE,ALPUNTQ     SPECIAL FOR UNIT SELECT PHASE                
         BE    GOLFUL10                                                         
         CLI   ALPHASE,ALPXCHQ     FOR EXCHANGE PHASE                           
         BNE   GOLFUL02                                                         
         LNR   R1,R1               USE (-) ABSOLUTE VALUE                       
         B     GOLFUL08            (CURRENT UNIT IN INCLUDED)                   
*                                  BRAND SELECT PHASE                           
GOLFUL02 LTR   R1,R1               IF OVERACHIEVED                              
         BNM   GOLFUL06                                                         
         CLI   TABPRI,YESQ         REJECT PRIORITY BRANDS                       
         BNE   GOLFUL06                                                         
         CLI   PODRSW,YESQ         ALWAYS FOR POD RUNS                          
         BE    GOLFUL04                                                         
         OC    UBPRD1,UBPRD1       OTHERWISE, UNLESS UNIT NOT                   
         BZ    GOLFUL06            ASSIGNED IN FIRST PASS                       
         CLC   UBPRD1,TABPRD       OR IS CURRENTLY ASSIGNED                     
         BE    GOLFUL06            TO THIS BRAND                                
GOLFUL04 OI    UBSTAT1,UBSPRRJQ                                                 
         B     GOLFULX                                                          
                                                                                
GOLFUL06 L     RE,WAVGOAL                                                       
         SRL   RE,3                ADD 1/8 OF AVG GOAL (NOT FOR EXCH)           
         AR    RF,RE               NOTE - ADJUSTING DENOMINATOR YIELDS          
*                                  A MORE USEFUL VARIABLE - ESPECIALLY          
*                                  WHEN ACHIEVEMENT = 0                         
GOLFUL08 M     R0,FW100                                                         
         GOTOR DIVIDE                                                           
         CLI   TABPRI,YESQ         FOR PRIORITY BRANDS                          
         BNE   GOLFUL14                                                         
         M     R0,FW150            INCREASE VALUE                               
         LHI   RF,100                                                           
         GOTOR DIVIDE                                                           
         B     GOLFUL14                                                         
*                                  UNIT SELECT PHASE                            
GOLFUL10 CLI   WLENFLT,0           IF DOING ONE LENGTH OF POD                   
         BE    GOLFUL12            NO                                           
*                                  YES - REJECT MATCH IF UNIT                   
*                                  CAUSES BRAND TO GO OVER BY MORE              
*                                  THAN 1/2 OF AMOUNT IT WAS SHORT              
         LPR   R4,R1               ABS(REMAINDER)                               
         LCR   RE,R1                                                            
         ICM   RF,15,COSTSHR                                                    
         AR    RE,RF                                                            
         BNP   GOLFUL12            DOES NOT GO OVER                             
         LPR   RE,RE               ABS(NEW REMAINDER)                           
         SRL   R4,1                                                             
         CR    RE,R4               COMPARE CURRENT TO 1/2 OLD                   
         BNH   GOLFUL12                                                         
         OI    UBSTAT1,UBSPRRJQ    SET REJECT                                   
         B     GOLFULX                                                          
*                                  PENALIZE A UNIT FOR GOING OVER               
*                                  BRANDS GOAL                                  
GOLFUL12 C     R2,HIGHPRD          SKIP IF BRAND HAS                            
         BE    GOLFULX             HIGHEST NUMERICAL REMAINDER                  
         ICM   R4,15,COSTSHR                                                    
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         ICM   R4,15,UBCDEM                                                     
         SR    R1,R4               ADD TO ALREADY ACHIEVED                      
         BNM   GOLFULX             NO PENALTY IF NOT OVER                       
         M     R0,FW100                                                         
         GOTOR DIVIDE                                                           
         AHI   R1,10               DON'T PENALIZE FIRST 10 PERCENT              
         BNM   GOLFULX                                                          
         CHI   R1,-25              ALSO SET CEILING                             
         BNL   GOLFUL14                                                         
         LHI   R1,-25                                                           
GOLFUL14 ST    R1,HOLDVAR          PERCENT UNACHIEVED                           
GOLFULX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Variable  2  -  CPP/M deviation                                     *         
***********************************************************************         
                                                                                
CPPDEV   CLI   CPMSOPTN,CPMSDLNQ                                                
         BE    *+12                                                             
         AH    R2,WEEKDISP         USE WEEKLY CPM'S                             
         B     *+8                                                              
         AHI   R2,TRSCGOL-TABD     OR WHOLE SCHEDULE                            
         CLI   ALPHASE,ALPBRDQ     DIFFERENT FOR BRAND SELECT PHASE             
         BE    CPPDEV06                                                         
         L     R1,8(R2)            COST SO FAR                                  
         L     RF,4(R2)            DEMO SO FAR                                  
         CLI   ALPHASE,ALPXCHQ     FOR EXCHANGE PHASE                           
         BE    CPPDEV02            DON'T ADD IN THIS UNIT                       
         ICM   R4,15,COSTSHR       PLUS THIS UNIT COST                          
         AR    R1,R4                                                            
         ICM   R4,15,UBCDEM        PLUS THIS DEMO VALUE                         
         AR    RF,R4                                                            
CPPDEV02 M     R0,FW1000           GET RESULTANT CPP/M                          
         GOTOR DIVIDE                                                           
         S     R1,WKCPD            GET DIFFERENCE FROM WEEK'S AVG CPP/M         
         LNR   R1,R1               USE (-)  ABSOLUTE VALUE                      
         M     R0,FW100            SET AS PERCENT OF AVERAGE                    
         L     RF,WKCPD                                                         
         GOTOR DIVIDE                                                           
         CLI   ALPHASE,ALPUNTQ     FOR UNIT PHASE                               
         BNE   CPPDEV08                                                         
         CHI   R1,-40              SET A CEILING                                
         BNL   *+8                 (PREVENTS EXCESSIVE DELAY OF                 
         LHI   R1,-40              WILDLY DIVERGENT BRANDS)                     
         B     CPPDEV08                                                         
*                                  BRAND SELECT PHASE                           
*                                  VALUE IS -                                   
*                                    ABS (OLD CPM - AVG) -                      
*                                    ABS (NEW CPM - AVG) / AVG                  
*                                  (MAY NOT BE PERFECT BUT AT LEAST             
*                                  GUARANTEES MOTION TOWARD CENTER)             
*                                  GET NEW CPM                                  
CPPDEV06 L     R1,8(R2)            CUURENT DOLLARS                              
         L     RF,4(R2)            CURRENT DEMO                                 
         ICM   R4,15,COSTSHR       PLUS THIS UNIT                               
         AR    R1,R4                                                            
         ICM   R4,15,UBCDEM                                                     
         AR    RF,R4                                                            
         M     R0,FW1000                                                        
         GOTOR DIVIDE                                                           
         S     R1,WKCPD            LESS AVERAGE                                 
         LPR   R1,R1               ABS                                          
         ST    R1,FULL                                                          
*                                  GET OLD CPM                                  
         L     R1,8(R2)            CURRENT DOLLARS                              
         L     RF,4(R2)            CURRENT DEMO                                 
         M     R0,FW1000                                                        
         GOTOR DIVIDE              CPM                                          
         LTR   R1,R1               IF NO CURRENT CPM IGNORE THIS VAR            
         BZ    CPPDEV08                                                         
         S     R1,WKCPD            LESS AVERAGE                                 
         LPR   R1,R1               ABS                                          
         S     R1,FULL             OLD LESS NEW                                 
         M     R0,FW100                                                         
         L     RF,WKCPD            /AVERAGE                                     
         GOTOR DIVIDE                                                           
         LTR   R1,R1               HALVE IF POSITIVE                            
         BM    CPPDEV08                                                         
         SRA   R1,1                                                             
CPPDEV08 ST    R1,HOLDVAR                                                       
CPPDEVX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Variable 3 - dispersion of products thru ENV1                       *         
***********************************************************************         
                                                                                
PRDDSP   L     R8,AENV1SET         USE ENVIRONMENT 1 VALUE SET                  
         USING ENVSETD,R8                                                       
         MVI   ENVNO,ENVNPGMQ                                                   
                                                                                
PRDDSP02 CLC   ENVSWCNT,FW1        IF ONLY ONE ENVIRONMENT ENTRY                
         BNH   PRDDSPX             IGNORE VARIABLE                              
         GOTOR LOCPRD,TABPRD                                                    
         SR    RF,RF                                                            
         ICM   RF,3,PTENVSEQ-PTBUFFD(R1)                                        
         MH    RF,ENVPRDD          PRODUCT DISPLACEMENT                         
         SR    RE,RE                                                            
         IC    RE,ENVNO                                                         
         SLL   RE,1                                                             
         LH    RE,UBENV1-L'UBENV1(RE)                                           
         SLL   RE,1                                                             
         LH    RE,ENVSTTAB(RE)                                                  
         MH    RE,ENVENVD          ENVIRONMENT DISPLACEMENT                     
         AR    RF,RE                                                            
         ST    RF,TOTDISP          DISPLACEMENT FOR TOTAL                       
         SR    RE,RE                                                            
         IC    RE,WEEKNO                                                        
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    RE,RF                                                            
         LR    R6,RE                                                            
         A     R6,ENVSACNT         DO SCORE FOR WEEK                            
         LH    R6,0(R6)            COUNT FOR WEEK                               
         A     RE,ENVSASHR                                                      
         LH    R1,0(RE)            SHARE                                        
         LR    RF,R1                                                            
         SR    R1,R6               SHARE LESS COUNT                             
         M     R0,FW100                                                         
         AHI   RF,10               NOTE - % ON SHARE +1.0 YIELDS BETTER         
         GOTOR DIVIDE              RESULT - ESPECIALLY WHEN COUNT = 0           
         CLI   ALPHASE,ALPUNTQ     FOR UNIT PHASE                               
         BNE   PRDDSP04                                                         
         LTR   R1,R1                                                            
         BNP   *+8                                                              
         SRA   R1,1                HALVE VALUE IF NOT OVER SHARE                
         B     PRDDSP06                                                         
*                                  FOR ADJUSTMENT PHASES                        
PRDDSP04 CLI   ZSPASS,ZSPYESQ      UNLESS ZERO UNIT                             
         BE    PRDDSP06                                                         
         AHI   R1,10               ONLY COUNT 10 PERCENT+ OVERAGES              
         BM    *+6                                                              
         SR    R1,R1                                                            
         CLI   ALPHASE,ALPXCHQ     FOR EXCHANGE PHASE                           
         BNE   PRDDSP06                                                         
         SRA   R1,1                HALVE                                        
                                                                                
PRDDSP06 LR    R5,R1               SAVE WEEK SCORE                              
*                                  NOW DO OVERALL SCORE                         
         CLC   NWKS,HW1            SKIP IF ONLY ONE WEEK                        
         BE    PRDDSP16                                                         
                                                                                
         LH    RE,NWKS             GET SUM OF SHARES IN FULL                    
         L     R6,TOTDISP                                                       
         A     R6,ENVSASHR                                                      
         AHI   R6,2                START AT WEEK 1                              
         SR    R7,R7                                                            
PRDDSP08 AH    R7,0(R6)                                                         
         AHI   R6,2                                                             
         BCT   RE,PRDDSP08                                                      
                                                                                
         ST    R7,FULL             SAVE TOTAL OF SHARES                         
         XC    WORK(8),WORK        NOW SUM SHARES AND COUNTS SO FAR             
         L     R6,TOTDISP                                                       
         A     R6,ENVSACNT         COUNTS                                       
         AHI   R6,2                START AT WEEK 1                              
         L     R7,TOTDISP                                                       
         A     R7,ENVSASHR         SHARES                                       
         AHI   R7,2                START AT WEEK 1                              
         SR    RE,RE                                                            
         IC    RE,WEEKNO                                                        
PRDDSP10 LH    RF,0(R6)            COUNTS                                       
         A     RF,WORK                                                          
         ST    RF,WORK                                                          
         LH    RF,0(R7)            SHARES                                       
         A     RF,WORK+4                                                        
         ST    RF,WORK+4                                                        
         AHI   R6,2                NEXT WEEK                                    
         AHI   R7,2                                                             
         BCT   RE,PRDDSP10                                                      
                                                                                
         L     R1,WORK+4           CUME OF SHARES                               
         M     R0,FW100                                                         
         L     RE,TOTDISP                                                       
         A     RE,ENVSASHR                                                      
         LH    RF,0(RE)            X 'TOTAL' SHARE                              
         MR    R0,RF                                                            
         L     RF,FULL             / SUM OF SHARES                              
         GOTOR DIVIDE                                                           
         AHI   R1,99               FORCE A ROUND UP                             
         SR    R0,R0                                                            
         D     R0,FW100            SET IN UNITS                                 
         LR    RF,R1               (R1 NOW HAS 'ACTUAL SHARE')                  
         S     R1,WORK             SHARE LESS CUME OF COUNTS                    
         M     R0,FW100                                                         
         AHI   RF,10               NOTE - % ON SHARE +1.0 YIELDS BETTER         
         GOTOR DIVIDE              RESULT - ESPECIALLY WHEN COUNT = 0           
         CLI   ALPHASE,ALPUNTQ     FOR UNIT PHASE                               
         BNE   PRDDSP12                                                         
         LTR   R1,R1                                                            
         BNP   *+8                                                              
         SRA   R1,1                HALVE VALUE IF NOT OVER SHARE                
         B     PRDDSP14                                                         
*                                  FOR ADJUSTMENT PHASES                        
PRDDSP12 CLI   ZSPASS,ZSPYESQ      UNLESS ZERO UNIT                             
         BE    PRDDSP14                                                         
         AHI   R1,10               ONLY COUNT 10 PERCENT+ OVERAGES              
         BM    PRDDSP14                                                         
         SR    R1,R1                                                            
*                                  NOTE - GIVE CUME SCORE AND THIS              
*                                  WEEK SCORE EQUAL WEIGHT                      
PRDDSP14 AR    R1,R5               THIS WEEK PLUS CUME                          
         SRA   R1,1                / 2                                          
PRDDSP16 ST    R1,HOLDVAR          =RESULT                                      
PRDDSPX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Variable 4 - dispersion by network                                  *         
***********************************************************************         
                                                                                
NETDSP   L     R8,AENV2SET         ENVIRONMENT 2 VALUE SET                      
         MVI   ENVNO,ENVNNETQ                                                   
         B     PRDDSP02            SAME ROUTINE AS FOR ENVIRONMENT 1            
                                                                                
***********************************************************************         
* Variable 5 - dispersion by day of week                              *         
***********************************************************************         
                                                                                
DOWDSP   L     R8,AENV3SET         ENVIRONMENT 3 VALUE SET                      
         MVI   ENVNO,ENVNDOWQ                                                   
         B     PRDDSP02            SAME ROUTINE AS FOR ENVIRONMENT 1            
         EJECT                                                                  
***********************************************************************         
* Variable 6 - target 1                                               *         
***********************************************************************         
                                                                                
TARG01   SR    R4,R4               NO TARGET                                    
         CLC   TABPRD,UNAPRD       IF 'EXCESS' PRODUCT                          
         BE    TARG0104                                                         
         GOTOR LOCPRD,TABPRD                                                    
         LR    R6,R1                                                            
         SR    R4,R4                                                            
         IC    R4,PTTRGS-PTBUFFD(R6)                                            
*                                  NOTE - THIS VARIABLE EVALUATED               
*                                  DIFFERENTLY FOR EACH PHASE                   
TARG0102 CLI   ALPHASE,ALPUNTQ     UNIT SELECT PHASE                            
         BE    TARG0110                                                         
TARG0104 SR    R1,R1               SET VARIABLE TO 0                            
         LTR   R4,R4               IF THIS TARGET NOT USED                      
         BZ    TARG0144                                                         
         CLI   ALPHASE,ALPBRDQ     BRAND SELECT PHASE                           
         BE    TARG0126                                                         
*                                  MUST BE EXCHANGE PHASE                       
*                                  CALC RESULTANT 'CPU'                         
*                                  NOTE -UNIT BEING VALUED IS ALREADY           
*                                  ADDED IN                                     
         SLL   R4,2                                                             
         AH    R2,WEEKDISP                                                      
         L     RF,TABTA1-L'TABTA1-TABDATA(R2,R4) RF HAS RESULTANT ACH           
         LTR   RF,RF               IF NO RESULTANT ACHIEVEMENT                  
         BNZ   *+8                                                              
         L     RF,AWKLOTRG-L'AWKLOTRG(R4) USE LOWEST RATED UNIT VALUE           
         CLI   TRGBASE,TRGBDEMS                                                 
         BE    TARG0106                                                         
         ICM   R1,15,8(R2)         ALREADY ACHIEVED COST                        
         BNZ   *+8                                                              
         L     R1,WAVCOST          IF ZERO USE AVERAGE                          
         M     R0,FW1000                                                        
         B     TARG0108                                                         
TARG0106 ICM   R1,15,4(R2)         ALREADY ACHIEVED CORPORATE DEMO              
         BNZ   *+8                                                              
         L     R1,WAVBASD          IF ZERO USE AVERAGE                          
         M     R0,FW100                                                         
TARG0108 GOTOR DIVIDE              RESULT 'COST' IN TERMS OF ALLOC BASE         
         M     R0,FW100                                                         
         L     RF,AWKAVGS-L'AWKAVGS(R4)                                         
         GOTOR DIVIDE                                                           
         S     R1,FW100            IF INDEX OVER 100                            
         BNP   *+8                                                              
         SLA   R1,1                DOUBLE PENALTY IF OVER AVERAGE               
         LCR   R1,R1               COMPLEMENT                                   
         M     R0,FW133            FOR EXCHANGE PHASE FACTOR SCORE UP           
         LHI   RF,100                                                           
         GOTOR DIVIDE                                                           
         B     TARG0144                                                         
*                                  UNIT SELECT PHASE                            
*                                  USE RELATIVE 'CPU' (-) OF UNIT               
TARG0110 LTR   R4,R4               TEST HAVE TARGET                             
         BNZ   TARG0112            YES                                          
*                                  NO TARGET FOR THIS PRODUCT                   
*                                  (HERE ONLY FOR TARGET 1)                     
         SR    R1,R1                                                            
         LA    RF,PTTRGS-PTBUFFD(R6) IF NOT ALL TARGETS ARE ABSENT              
         OC    0(L'PTTRGS,RF),0(RF)                                             
         BNZ   TARG0144            EXIT WITH VALUE ZERO                         
         SR    R0,R0                                                            
         ICM   R0,3,NTARGETS       SUM VALUES OF ACTIVE TARGETS                 
         BZ    TARG0144                                                         
         SR    RF,RF                                                            
         LA    RE,UBTARGS                                                       
         A     RF,0(RE)                                                         
         AHI   RE,L'UBTARGS                                                     
         BCT   R0,*-8                                                           
         SR    R1,R1               IF NO TARGET RATINGS                         
         LTR   RF,RF                                                            
         BZ    TARG0144            EXIT WITH ZERO VALE                          
         B     TARG0114                                                         
                                                                                
TARG0112 SLL   R4,2                TARGET IS PRESENT                            
         LA    RF,UBTARGS-L'UBTARGS(R4) POINT TO TARGET VALUE                   
         ICM   RF,15,0(RF)                                                      
         BNZ   TARG0114            IF ZERO VALUE FOR TARGET                     
         L     RF,AWKLOTRG-L'AWKLOTRG(R4) USE LOWEST RATING                     
         SRL   RF,1                /2                                           
                                                                                
TARG0114 LR    R6,RF               SAVE DIVISOR                                 
         CLI   TRGBASE,TRGBDOLS                                                 
         BNE   TARG0120                                                         
         ICM   R1,15,UBCOST                                                     
         BZ    TARG0116            IF ZERO USE AVERAGE COST                     
         CLI   PODRSW,YESQ         FOR POD RUNS                                 
         BNE   TARG0118            MUST GET EQUIV BASE COST SHARE               
         CLC   UBPDLEN,PODLEN      TEST ALREADY HAVE                            
         BE    TARG0118                                                         
         LH    R0,PODEQU                                                        
         MR    R0,R0               VALUE X EQUIV BASE                           
         SR    RF,RF                                                            
         IC    RF,UBPDLEN                                                       
         GOTOR DIVIDE              / POD LENGTH                                 
         B     TARG0118                                                         
TARG0116 L     R1,WAVCOST          IF ZERO USE AVERAGE COST                     
TARG0118 M     R0,FW1000                                                        
         B     TARG0122                                                         
TARG0120 ICM   R1,15,UBCDEM        CORPORATE DEMO VALUE                         
         BNZ   *+8                                                              
         L     R1,WAVBASD          IF ZERO USE AVERAGE                          
         M     R0,FW100                                                         
TARG0122 LR    RF,R6               RESTORE DIVISOR                              
         GOTOR DIVIDE              'CPU'                                        
         M     R0,FW100                                                         
         LTR   R4,R4               SPECIAL IF NO TARGET FOR BRAND               
         BZ    TARG0124                                                         
         L     RF,AWKAVGS-L'AWKAVGS(R4) OVER AVERAGE 'CPU'                      
         GOTOR DIVIDE                                                           
         S     R1,FW100                                                         
         LCR   R1,R1               COMPLEMENT                                   
         B     TARG0144                                                         
TARG0124 L     RF,AWKTGAVG         SPECIAL IF NO TARGET FOR BRAND               
         GOTOR DIVIDE              UNCHOOSE GOOD UNITS FOR TARGETS              
         S     R1,FW100                                                         
         B     TARG0144                                                         
                                                                                
***********************************************************************         
* Brand select phase                                                  *         
*                                                                     *         
* Use composite of 2 values                                           *         
* 1 - relative 'CPU' of unit - as for U phase                         *         
* times 2 - current relative 'CPU' - as for X phase                   *         
*                                                                     *         
* Note:  has effect of increasing importance of                       *         
*        variable by degree to which brand is                         *         
*        currently worse than average                                 *         
***********************************************************************         
                                                                                
TARG0126 SLL   R4,2                                                             
         LA    RF,UBTARGS-L'UBTARGS(R4) POINT TO TARGET VALUE                   
         ICM   RF,15,0(RF)                                                      
         BNZ   TARG0128            IF ZERO VALUE FOR TARGET                     
         L     RF,AWKLOTRG-L'AWKLOTRG(R4) USE LOWEST RATING                     
         SRL   RF,1                /2                                           
TARG0128 LR    R6,RF               SAVE DIVISOR                                 
         CLI   TRGBASE,TRGBDOLS                                                 
         BNE   TARG0134                                                         
         ICM   R1,15,UBCOST                                                     
         BZ    TARG0130            IF ZERO USE AVERAGE COST                     
         CLI   PODRSW,YESQ         FOR POD RUNS                                 
         BNE   TARG0132            MUST GET EQUIV BASE COST SHARE               
         CLC   UBPDLEN,PODLEN      TEST ALREADY HAVE                            
         BE    TARG0132                                                         
         LH    R0,PODEQU                                                        
         MR    R0,R0               VALUE X EQUIV BASE                           
         SR    RF,RF                                                            
         IC    RF,UBPDLEN                                                       
         GOTOR DIVIDE              / POD LENGTH                                 
         B     TARG0132                                                         
TARG0130 L     R1,WAVCOST          IF ZERO USE AVERAGE COST                     
TARG0132 M     R0,FW1000                                                        
         B     TARG0136                                                         
TARG0134 ICM   R1,15,UBCDEM        CORPORATE DEMO VALUE                         
         BNZ   *+8                                                              
         L     R1,WAVBASD          IF ZERO USE AVERAGE                          
         M     R0,FW100                                                         
TARG0136 LR    RF,R6               RESTORE DIVISOR                              
         GOTOR DIVIDE              'CPU'                                        
         M     R0,FW100                                                         
         L     RF,AWKAVGS-L'AWKAVGS(R4) OVER AVERAGE 'CPU'                      
         GOTOR DIVIDE                                                           
         S     R1,FW100                                                         
         LCR   R1,R1               COMPLEMENT                                   
         ST    R1,HOLDVAR          SAVE THIS COMPONENT                          
*                                  SECOND COMPONENT                             
*                                  CALCULATE CURRENT 'CPU'                      
         AH    R2,WEEKDISP                                                      
         LHI   R1,100              USE NEUTRAL VALUE IF NO ACHIEVEMENT          
         L     RF,TABTA1-L'TABTA1-TABDATA(R2,R4)                                
         LTR   RF,RF                                                            
         BZ    TARG0142                                                         
         CLI   TRGBASE,TRGBDEMS                                                 
         BE    TARG0138                                                         
         L     R1,8(R2)            ACHIEVED COST                                
         M     R0,FW1000                                                        
         B     TARG0140                                                         
TARG0138 L     R1,4(R2)            ACHIEVED CORPORATE DEMO                      
         M     R0,FW100                                                         
TARG0140 GOTOR DIVIDE              'COST' IN TERMS OF ALLOCATION BASIS          
         M     R0,FW100                                                         
         L     RF,AWKAVGS-L'AWKAVGS(R4) OVER AVERAGE                            
         GOTOR DIVIDE                                                           
*                                  COMBINE THE 2 COMPONENTS                     
TARG0142 LTR   R1,R1               IF ZERO                                      
         BNZ   *+8                                                              
         LHI   R1,100              SET TO 100 (NEUTRAL)                         
         S     R1,FW100            DOUBLE FACTOR VALUE                          
         SLA   R1,1                                                             
         A     R1,FW100                                                         
         M     R0,HOLDVAR          X FIRST COMPONENT                            
         LHI   RF,100                                                           
         GOTOR DIVIDE                                                           
TARG0144 ST    R1,HOLDVAR                                                       
TARG01X  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Variable 7 - target 2                                               *         
***********************************************************************         
                                                                                
TARG02   SR    R4,R4               NO TARGET                                    
         CLC   TABPRD,UNAPRD       IF 'EXCESS' PRODUCT                          
         BE    TARG0104                                                         
         GOTOR LOCPRD,TABPRD                                                    
         LR    R6,R1                                                            
         SR    R4,R4                                                            
         IC    R4,PTTRGS+1-PTBUFFD(R6)                                          
         B     TARG0102            BRANCH INTO TARGET 1 ROUTINE                 
         EJECT                                                                  
SETCSH   ICM   R1,15,UBCOST        SET COST SHARE FOR UNIT                      
         CLI   PODRSW,YESQ         SKIP IF NOT POD RUN                          
         BNER  RE                                                               
         CLC   UBPDLEN,TABLEN      OR IF USING WHOLE POD                        
         BER   RE                                                               
         SR    R0,R0                                                            
         IC    R0,TABLEN                                                        
         MR    R0,R0               COST X THIS LENGTH                           
         SR    RF,RF                                                            
         IC    RF,UBPDLEN          / WHOLE LENGTH                               
         J     DIVIDE                                                           
         DROP  R8,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Test unit usable for brand                                          *         
***********************************************************************         
                                                                                
UNTUSE   NMOD1 0,**UNTUSE                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         NI    UBSTAT1,FF-UBSRJCTQ CLEAR ALL REJECT BITS                        
         CLI   ZSPASS,ZSPTOGQ                                                   
         BE    UNTUSE06                                                         
*                                  TEST REJECT BECAUSE ZERO UNIT ON NON         
*                                  ZERO PASS OR VICE-VERSA                      
         LA    RF,UBCOST           USE COST                                     
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,UBCDEM           OR DEMO                                      
         OC    0(L'UBCOST,RF),0(RF)                                             
         BNZ   UNTUSE02                                                         
         CLI   ZSPASS,ZSPYESQ                                                   
         BE    UNTUSE06            KEEP                                         
         B     UNTUSE04            REJECT                                       
UNTUSE02 CLI   ZSPASS,ZSPNOQ                                                    
         BE    UNTUSE06            KEEP                                         
UNTUSE04 OI    UBSTAT1,UBSZPRJQ    REJECT                                       
         B     UNTUSEX                                                          
                                                                                
UNTUSE06 L     R2,THISPRD          TEST VS PROD EXCLUSION TABLE                 
         USING TABD,R2                                                          
         MVC   HOLDPRD,TABPRD                                                   
         CLI   SPLPOPTN,SPLPGPPQ   IF DOING PSEUDO-PIGS                         
         BNE   UNTUSE12                                                         
         CLI   PODRSW,YESQ         AND IT IS A POD RUN                          
         BNE   UNTUSE12                                                         
         CLI   ALPHASE,ALPBRDQ     FOR BRAND SELECT PHASE SKIP DUPE             
         BE    UNTUSE12            BRAND CHECK (DONE IN SUMVAL)                 
         CLI   EXCHSW,EXCHCURQ     ALSO SKIP IF EVALUATING CURRENT              
         BE    UNTUSE12            ALLOCATION DURING EXCHANGE PASS              
         CLC   UBPRD1,TABPRD       ELSE CANT PIGGY A BRAND WITH ITSELF          
         BE    UNTUSE10                                                         
         CLC   UBPRD2,TABPRD                                                    
         BE    UNTUSE10                                                         
         OC    UBPRD1,UBPRD1       SAME CLASS ALSO NO GOOD                      
         BZ    UNTUSE08                                                         
         GOTOR ACHKCLS,DMCB,0,TABD,UBPRD1,0                                     
         BNE   UNTUSE10            YES, REJECT                                  
UNTUSE08 OC    UBPRD2,UBPRD2                                                    
         BZ    UNTUSE12                                                         
         GOTOR ACHKCLS,DMCB,0,TABD,UBPRD2,0                                     
         BE    UNTUSE12            NO, OK                                       
UNTUSE10 OI    UBSTAT1,UBSEXRJQ    REJECT - CALL IT AN EXCLUSION                
         B     UNTUSEX                                                          
                                                                                
UNTUSE12 CLC   TABPRD,UNAPRD       FOR BRAND 'EXCESS'                           
         BE    UNTUSEX             SKIP EXCLUSION AND INTERVAL TESTS            
                                                                                
         L     R4,XCTATAB          START OF TABLE                               
         ICM   R3,15,XCTNREC       NO OF ENTRIES                                
         BZ    UNTUSE34            NO EXCLUSIONS PRESENT                        
         USING XCTABD,R4                                                        
         LH    R6,UBENV1           GET PROGRAM FROM ENVIRONMENT 1 TABLE         
         BCTR  R6,0                                                             
         MHI   R6,ENVS1LEN                                                      
         L     RF,AENV1SET                                                      
         A     R6,ENVSATAB-ENVSETD(RF)                                          
         USING ENVTABD,R6                                                       
UNTUSE14 CLC   UBNET,XCTNET        TEST CORRECT NETWORK                         
         BE    UNTUSE16                                                         
         CLI   XCTNET,FF           OR 'ALL' NETWORK                             
         BNE   UNTUSE32                                                         
UNTUSE16 CLC   XCTPRD,HOLDPRD      PRODUCT                                      
         BNE   UNTUSE32                                                         
         CLI   XCTEST,0            ESTIMATE 0 = ALL                             
         BE    UNTUSE18                                                         
         CLC   XCTEST,UBEST                                                     
         BNE   UNTUSE32                                                         
UNTUSE18 CLC   ALL3L,XCTPGM                                                     
         BE    UNTUSE30                                                         
         CLC   XCTPGM,ENVS1PGM     TEST PROGRAM                                 
         BE    UNTUSE30                                                         
         CLI   XCTTYPE,XCTTTODQ    TEST TIME                                    
         BE    UNTUSE20                                                         
         CLI   XCTTYPE,XCTTADYQ    TEST TIME + DAY                              
         BNE   UNTUSE28            NO - THEN TRY DAY ALONE                      
         MVC   BYTE,XCTDOW         DAY FILTER AFTER TIME                        
         NC    BYTE,ENVS1DAY       TEST ANY OVERLAP                             
         BZ    UNTUSE32            NO, IGNORE TIME TEST                         
*                                  **TIME CHECKS**                              
UNTUSE20 CLC   XCTSTIME,XCTETIME   TEST TIMES SPAN 12M                          
         BH    UNTUSE26                                                         
         CLC   ENVS1STR,XCTSTIME   TIMES DO NOT SPAN 12M                        
         BE    UNTUSE30            ES = XS                                      
         BL    UNTUSE22                                                         
         CLC   ENVS1STR,XCTETIME                                                
         BL    UNTUSE30            (ES GT XS) AND (ES LT XE)                    
UNTUSE22 CLC   ENVS1END,XCTETIME                                                
         BE    UNTUSE30            EE = XE                                      
         BH    UNTUSE24                                                         
         CLC   ENVS1END,XCTSTIME                                                
         BH    UNTUSE30            (EE LT XE) AND (EE GT XS)                    
UNTUSE24 CLC   ENVS1STR,XCTSTIME                                                
         BNL   UNTUSE32                                                         
         CLC   ENVS1END,ENVS1STR                                                
         BL    UNTUSE30            (ES LT XS) AND (EE LT ES)                    
         CLC   ENVS1END,XCTSTIME                                                
         BH    UNTUSE30            (ES LT XS) AND (EE GT XS)                    
         B     UNTUSE32                                                         
UNTUSE26 CLC   ENVS1STR,XCTSTIME   PXC TIME DO SPAN 12M                         
         BNL   UNTUSE30            ES GE XS                                     
         CLC   ENVS1STR,XCTETIME                                                
         BL    UNTUSE30            ES LT XE                                     
         CLC   ENVS1END,XCTETIME                                                
         BNH   UNTUSE30            EE LE XE                                     
         CLC   ENVS1END,XCTSTIME                                                
         BH    UNTUSE30            EE GT XS                                     
         CLC   ENVS1END,ENVS1STR                                                
         BL    UNTUSE30            EE LT ES                                     
         B     UNTUSE32                                                         
UNTUSE28 CLI   XCTTYPE,XCTTDOWQ    TRY DAY OF WEEK                              
         BNE   UNTUSE32                                                         
         MVC   BYTE,XCTDAY                                                      
         NC    BYTE,ENVS1DAY       TEST ANY OVERLAP                             
         BZ    UNTUSE32            NO, OK                                       
         CLI   XCTDPT,0            TEST HAVE DPT/LENGTH (IF FROM GOALS)         
         BE    UNTUSE30                                                         
         CLC   XCTDPT,UBDPT        TEST DAYPART MATCH                           
         BNE   UNTUSE32            NO, NOT APPLICABLE                           
         CLC   TABLEN,XCTLEN       SAME FOR UNIT LENGTH                         
         BNE   UNTUSE32                                                         
UNTUSE30 CLC   XCTSDATE,UBDATE     DATES                                        
         BH    UNTUSE32                                                         
         CLC   XCTEDATE,UBDATE                                                  
         BL    UNTUSE32                                                         
         OI    UBSTAT1,UBSEXRJQ    EXCLUDED                                     
         B     UNTUSEX                                                          
UNTUSE32 A     R4,XCTLREC          NEXT TABLE ENTRY                             
         BCT   R3,UNTUSE14                                                      
                                                                                
UNTUSE34 L     R2,THISPRD          NOW DO TIME SLOT CHECKS                      
         CLI   PINTRVL,0           PRODUCT INTERVAL                             
         BE    UNTUSE36            SKIP                                         
         MVI   PRDCLSSW,PRDCLSP                                                 
         GOTOR LOCPRD,TABPRD                                                    
         LR    RE,R1                                                            
         SR    R1,R1                                                            
         ICM   R1,3,PTENVSEQ-PTBUFFD(RE)                                        
         GOTOR TSTENV                                                           
         BNZ   UNTUSEX             REJECT                                       
                                                                                
UNTUSE36 CLI   CINTRVL,0           CLASS INTERVAL                               
         BE    UNTUSEX             SKIP                                         
         CLI   TABCLASS,0          IF NO CLASS                                  
         BNH   UNTUSEX             SKIP                                         
         CLI   SPCLOPTN,0          'SPECIAL CLASS' CODE                         
         BE    UNTUSE44                                                         
         CLI   TABCLASS,TWOPTCLS   IF BOTH BRANDS ARE IN                        
         BNH   UNTUSE44            SINGLE CLASSES                               
         CLC   TABCLASS,SPCLOPTN   AND IT'S THE 'SPECIAL' CLASS                 
         BE    UNTUSEX             THEN PAIR IS OK (CC=0)                       
                                                                                
UNTUSE44 MVI   PRDCLSSW,PRDCLSC                                                 
         GOTOR SETCLS,TABCLASS                                                  
         SR    RE,RE                                                            
         ICM   RE,1,CLASS1                                                      
         BZ    UNTUSE46                                                         
         A     RE,ACLSTRT                                                       
         SR    R1,R1                                                            
         IC    R1,0(RE)                                                         
         GOTOR TSTENV                                                           
         BNZ   UNTUSEX                                                          
                                                                                
UNTUSE46 SR    RE,RE                                                            
         ICM   RE,1,CLASS2                                                      
         BZ    UNTUSEX                                                          
         A     RE,ACLSTRT                                                       
         SR    R1,R1                                                            
         IC    R1,0(RE)                                                         
         GOTOR TSTENV                                                           
                                                                                
UNTUSEX  TM    UBSTAT1,UBSRJCTQ    TEST REJECTED                                
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Ntry:  RF=env product/class entry number                            *         
***********************************************************************         
                                                                                
TSTENV   STM   RE,R2,12(RD)                                                     
         MH    R1,ENVPRDD          X DISPLACEMENT                               
         LH    RE,UBENV1                                                        
         SLL   RE,1                                                             
         L     R2,AENV1SET         USE ENVIRONMENT 1 VALUE SET                  
         USING ENVSETD,R2                                                       
         LH    RE,ENVSTTAB(RE)     TRANSLATE TABLE                              
         MH    RE,ENVENVD          X ENVIRONMENT DISPLACEMENT                   
         AR    R1,RE                                                            
         SR    RE,RE                                                            
         IC    RE,WEEKNO                                                        
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    R1,RE               PLUS WEEK                                    
         A     R1,ENVSACTC         USE ACTUAL UNIT COUNTS                       
*                                  (SAME AS ENVSACNT EXCEPT FOR PODS)           
         LH    RF,0(R1)            RF HASE COUNT SO FAR                         
         CLI   ALPHASE,ALPXCHQ     UNLESS EXCHANGE PHASE                        
         BE    *+8                                                              
         AHI   RF,10               BUMP BY 1.0                                  
         LH    R1,UBENV1           NOW GET LIMIT FROM ENV1 TABLE                
         BCTR  R1,0                                                             
         MHI   R1,ENVS1LEN                                                      
         A     R1,ENVSATAB                                                      
         LA    RE,ENVS1SLP-ENVTABD(R1)                                          
         CLI   PRDCLSSW,PRDCLSP                                                 
         BE    *+8                                                              
         LA    RE,ENVS1SLC-ENVTABD(R1)                                          
         CH    RF,0(RE)                                                         
         BNH   *+8                                                              
         OI    UBSTAT1,UBSENRJQ    SET ENVIRONMENT REJECT                       
         TM    UBSTAT1,UBSENRJQ    TEST ENVIRONMENT REJECT                      
         LM    RE,R2,12(RD)                                                     
         BR    RE                                                               
         DROP  R2,R4,R5,R6,RB                                                   
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Initialize for week allocation                                      *         
***********************************************************************         
                                                                                
AWKINI   NMOD1 0,*AWKINI                                                        
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         LA    R0,AWKVALS                                                       
         LHI   R1,AWKVALSL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         XC    AWKAPRDS,AWKAPRDS                                                
         L     R4,AUNTTAB                                                       
         MVI   0(R4),UBUFEOTQ      CLEAR UNIT TABLE                             
                                                                                
         L     R3,ASUPROW          TEST ANY SUPPLY FOR THIS WEEK                
         AH    R3,WEEKDISP                                                      
         OC    TPREUNT-TABDATA(,R3),TPREUNT-TABDATA(R3)                         
         BZ    AWKINIX                                                          
         SR    R5,R5               COUNT ACTIVE BRANDS FOR WEEK                 
         SR    R7,R7                                                            
         L     R3,AFSTBRD                                                       
         USING TABD,R3                                                          
         LH    R4,WEEKDISP                                                      
AWKINI02 CLC   TABPRD,SUPPRD                                                    
         BE    AWKINI04                                                         
         L     RF,TRSCGOL-TABDATA(R3,R4)                                        
         LTR   RF,RF                                                            
         BZ    *+8                                                              
         AHI   R5,1                BUMP PRODUCT COUNT                           
         AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     AWKINI02                                                         
         DROP  R3                                                               
                                                                                
AWKINI04 STH   R5,AWKAPRDS         COUNT OF ACTIVE BRANDS                       
         STH   R7,AWKTPRDS         'TRUE' ACTIVE BRAND COUNT                    
                                                                                
         L     R4,ATOTROW          SET AVERAGE GOALS FOR WEEK                   
         AH    R4,WEEKDISP                                                      
         L     R1,0(R4)                                                         
         SR    R0,R0                                                            
         LR    RF,R5                                                            
         GOTOR DIVIDE                                                           
         ST    R1,WAVGOAL          AVERAGE GOAL THIS WEEK                       
                                                                                
W        USING UBUFFRD,WORK2                                                    
         XC    W.UBUFFK(UBUFFKL),W.UBUFFK                                       
         MVC   W.UBDPT(L'UBDPT+L'UBLEN),L.GBDPT                                 
         CLI   PODRSW,YESQ         IF PODS                                      
         BNE   *+8                                                              
         MVI   W.UBLEN,0           LENGTH ALL FOR DAYPART                       
                                                                                
         L     R4,AUNTTAB                                                       
B        USING UBUFFRD,R4                                                       
         SR    R6,R6                                                            
         GOTOR BU2RDH,W.UBUFFRD                                                 
         B     AWKINI08                                                         
AWKINI06 GOTOR BU2RSQ,W.UBUFFRD                                                 
AWKINI08 BNZ   AWKINI30                                                         
                                                                                
         CLC   W.UBDPT,L.GBDPT                                                  
         BNE   AWKINI30                                                         
         CLC   W.UBLEN,L.GBLEN                                                  
         BE    AWKINI10                                                         
         CLI   PODRSW,YESQ         IF PODS, OK                                  
         BNE   AWKINI30                                                         
                                                                                
AWKINI10 CLC   W.UBWEEK,WEEKNO     TEST RIGHT WEEK                              
         BNE   AWKINI06                                                         
         OC    W.UBPRD1,W.UBPRD1   DON'T TOTAL PRE-ALLOCATED UNITS              
         BNZ   AWKINI16                                                         
                                                                                
         LA    RF,W.UBCOST         ZERO UNIT TEST - GET COST                    
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,W.UBCDEM         OR DEMO                                      
         OC    0(L'UBCOST,RF),0(RF)                                             
         BNZ   AWKINI12                                                         
         L     R1,AWKZUNTS         ZERO UNIT COUNTER                            
         AHI   R1,1                                                             
         ST    R1,AWKZUNTS                                                      
         SR    R1,R1                                                            
         IC    R1,W.UBPDLEN                                                     
         A     R1,AWKZSECS         ZERO LENGTH COUNTER                          
         ST    R1,AWKZSECS                                                      
         B     AWKINI16                                                         
                                                                                
AWKINI12 ICM   R1,15,W.UBCOST      GET TOTAL OF COST                            
         A     R1,AWKNZCST                                                      
         ST    R1,AWKNZCST                                                      
         ICM   R1,15,W.UBCDEM      AND CORPORATE DEMO                           
         CLI   PODRSW,YESQ         ONLY FOR PODS                                
         BNE   AWKINI14                                                         
         CLC   W.UBPDLEN,PODLEN    SKIP IF ALREADY AT BASE                      
         BE    AWKINI14                                                         
         SR    R0,R0                                                            
         IC    R0,W.UBPDLEN                                                     
         MR    R0,R0               DEMO VALUE BY EQUIV                          
         LH    RF,PODEQU                                                        
         GOTOR DIVIDE                                                           
                                                                                
AWKINI14 A     R1,AWKNZBAS         FOR NON-ZERO UNITS                           
         ST    R1,AWKNZBAS                                                      
         L     R1,AWKRUNTS         NON-ZERO UNIT COUNTER                        
         AHI   R1,1                                                             
         ST    R1,AWKRUNTS                                                      
         SR    R1,R1                                                            
         IC    R1,W.UBPDLEN                                                     
         A     R1,AWKRSECS                                                      
         ST    R1,AWKRSECS                                                      
                                                                                
AWKINI16 SR    R0,R0               SET LOWEST NON-ZERO VALUE/TARGET             
         ICM   R0,3,NTARGETS                                                    
         BZ    AWKINI24            NO TARGETS                                   
         LA    R1,W.UBTARGS                                                     
         LA    RE,AWKLOTRG                                                      
AWKINI18 ICM   RF,15,0(R1)         TARGET VALUE                                 
         BZ    AWKINI22            SKIP IF ZERO                                 
         C     RF,0(RE)                                                         
         BL    AWKINI20                                                         
         OC    0(L'AWKLOTRG,RE),0(RE) FIRST TIME                                
         BNZ   AWKINI22                                                         
AWKINI20 ST    RF,0(RE)            SAVE LOWEST                                  
AWKINI22 AHI   R1,L'UBTARGS        NEXT TARGET                                  
         AHI   RE,L'AWKLOTRG                                                    
         BCT   R0,AWKINI18                                                      
                                                                                
AWKINI24 LHI   R1,10               1.0 UNITS                                    
         CLI   PODRSW,YESQ         TEST POD RUN                                 
         BNE   AWKINI26                                                         
         CLC   W.UBPDLEN,PODLEN    TEST HAVE EQUIV BASE                         
         BE    AWKINI26                                                         
         SR    R1,R1                                                            
         IC    R1,W.UBPDLEN                                                     
         M     R0,FW10                                                          
         LH    RF,PODEQU                                                        
         DR    R0,RF                                                            
AWKINI26 OC    W.UBCOST,W.UBCOST   COUNT NON-ZERO COST UNITS                    
         BZ    *+14                                                             
         L     RF,AWKNZCSP                                                      
         AR    RF,R1                                                            
         ST    RF,AWKNZCSP                                                      
         OC    W.UBCDEM,W.UBCDEM   COUNT NON-ZERO RATED UNITS                   
         BZ    AWKINI28                                                         
         L     RF,AWKNZDSP                                                      
         AR    RF,R1               BUMP BY EQUIV UNITS                          
         ST    RF,AWKNZDSP                                                      
                                                                                
AWKINI28 L     RF,UNTTABL          MOVE TO UNIT TABLE                           
         SHI   RF,1                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   B.UBUFFRD(0),W.UBUFFRD                                           
         A     R4,UNTTABL                                                       
         MVI   B.UBUFFRD,UBUFEOTQ  SET END OF UNIT TABLE                        
         AHI   R6,1                                                             
         B     AWKINI06                                                         
         DROP  B                                                                
                                                                                
AWKINI30 ST    R6,UNTTABN          TOTAL UNIT COUNT                             
         L     RF,AWKRUNTS                                                      
         A     RF,AWKZUNTS                                                      
         BZ    AWKINIX             DONE IF NO UNALLOCATED UNITS                 
*                                  CPP/M FOR WEEK                               
         CLI   CPMSOPTN,CPMSDLNQ   IF CPM'S BASED ON SCHED                      
         BE    AWKINI32            (NOTE-SUPPLY DEMOS ARE EQUIVALENCED)         
         L     R4,ASUPROW                                                       
         AH    R4,WEEKDISP                                                      
         L     R1,8(R4)            DOLLARS                                      
         M     R0,FW1000                                                        
         L     RF,4(R4)            DEMO                                         
         GOTOR DIVIDE                                                           
         ST    R1,WKCPD                                                         
         B     AWKINI36                                                         
*                                  CPP/M FOR NON-ZERO UNITS                     
AWKINI32 L     R4,ASUPROW          DO RUNNING CPM IF BASED ON SCHEDULE          
SUP      USING TABD,R4                                                          
         AH    R4,CELLWID          START WITH WEEK 1                            
         SR    R0,R0                                                            
         IC    R0,WEEKNO           FOR BCT                                      
         SR    R1,R1                                                            
         SR    RF,RF                                                            
AWKINI34 A     R1,SUP.TPREDOL      DOLLARS                                      
         A     RF,SUP.TPREDEM      DEMO                                         
         AH    R4,CELLWID                                                       
         BCT   R0,AWKINI34                                                      
         M     R0,FW1000                                                        
         GOTOR DIVIDE                                                           
         ST    R1,WKCPD                                                         
                                                                                
AWKINI36 L     R1,AWKNZCST                                                      
         M     R0,FW1000                                                        
         L     RF,AWKNZBAS                                                      
         GOTOR DIVIDE                                                           
         ST    R1,AWKNZCPD                                                      
*                                  SET AVERAGE VALUE PER BASIS                  
*                                  UNIT FOR TARGETS                             
*                                  (NOTE-SUPPLY DEMOS ARE EQUIVALENCED)         
         SR    R7,R7                                                            
         ICM   R7,3,NTARGETS                                                    
         BZ    AWKINI44                                                         
         L     R4,ASUPROW                                                       
         AH    R4,WEEKDISP                                                      
         LA    R5,TABTA1-TABDATA(R4) POINT TO FIRST TARGET                      
         LA    R6,AWKAVGS          VALUES PER                                   
AWKINI38 L     RF,0(R5)            TARGET VALUE                                 
         A     RF,AWKTGAVG                                                      
         ST    RF,AWKTGAVG         TOTAL OF VALUES                              
         L     RF,0(R5)            TARGET VALUE                                 
         CLI   TRGBASE,TRGBDOLS                                                 
         BNE   AWKINI40                                                         
         L     R1,TPREDOL-TABDATA(R4)                                           
         M     R0,FW1000                                                        
         B     AWKINI42                                                         
AWKINI40 L     R1,TPREDEM-TABDATA(R4)                                           
         M     R0,FW100                                                         
AWKINI42 GOTOR DIVIDE                                                           
         ST    R1,0(R6)                                                         
         AHI   R5,L'TABTA1         NEXT TARGET                                  
         AHI   R6,L'AWKAVGS                                                     
         BCT   R7,AWKINI38                                                      
                                                                                
AWKINI44 L     RF,AWKTGAVG         SET TARGET AVERAGE OF AVERAGE'S              
         CLI   TRGBASE,TRGBDOLS                                                 
         BNE   AWKINI46                                                         
         L     R1,TPREDOL-TABDATA(R4)                                           
         M     R0,FW1000                                                        
         B     AWKINI48                                                         
AWKINI46 L     R1,TPREDEM-TABDATA(R4)                                           
         M     R0,FW100                                                         
AWKINI48 GOTOR DIVIDE                                                           
         ST    R1,AWKTGAVG                                                      
         L     R4,ASUPROW          SET AVERAGE COST FOR NON-ZERO UNITS          
         AH    R4,WEEKDISP                                                      
         L     R1,TPREDOL-TABDATA(R4) COST TOTAL                                
         M     R0,FW10             BECAUSE UNITS ARE 0.0                        
         L     RF,AWKNZCSP         / NUMBER OF NON-ZERO UNITS                   
         GOTOR DIVIDE                                                           
         ST    R1,WAVCOST                                                       
*                                  SET AVG BASE RATING PER NON-ZERO SPT         
         L     R1,TPREDEM-TABDATA(R4) TOTAL BASE DEMO                           
         M     R0,FW10             BECAUSE UNITS ARE 0.0                        
         L     RF,AWKNZDSP         / NUMBER OF NON-ZERO RATED UNITS             
         GOTOR DIVIDE                                                           
         ST    R1,WAVBASD                                                       
                                                                                
         LA    RF,VARCTLS          SET OFF ALL VARIABLE NO-OPS                  
         LHI   R0,VARWGTSN                                                      
         MVI   0(RF),0                                                          
         AHI   RF,L'VARCTLS                                                     
         BCT   R0,*-8                                                           
                                                                                
         OC    NTARGETS,NTARGETS   IF NO TARGETS                                
         BNZ   AWKINI50                                                         
         OI    TG1VAR+VARCTLD,TVOFFQ SET OFF TARGET VARIABLES                   
         OI    TG2VAR+VARCTLD,TVOFFQ                                            
         B     AWKINIX                                                          
*                                  IF ALL BRANDS HAVE SAME TARGET 1             
AWKINI50 MVI   WORD,FF             OR TARGET 2 NO-OP THAT VARIABLE              
         L     R2,AFSTBRD                                                       
         USING TABD,R2                                                          
         MVI   BYTE,0                                                           
AWKINI52 CLC   TABPRD,SUPPRD                                                    
         BE    AWKINI58                                                         
         CLC   TABPRD,UNAPRD       IGNORE UNALLOCATED                           
         BE    AWKINI56                                                         
         GOTOR LOCPRD,TABPRD                                                    
         MVC   HALF,PTTRGS-PTBUFFD(R1)                                          
AWKINI54 CLI   WORD,FF             IF FIRST TIME                                
         BNE   *+14                                                             
         MVC   WORD(2),HALF        JUST SET TARGETS                             
         B     AWKINI56                                                         
         CLC   WORD(1),HALF                                                     
         BE    *+8                                                              
         OI    BYTE,X'80'          MULTIPLE TARGET 1'S                          
         CLC   WORD+1(1),HALF+1                                                 
         BE    AWKINI56                                                         
         OI    BYTE,X'40'          MULTIPLE TARGET 2'S                          
AWKINI56 AH    R2,ROWLEN                                                        
         B     AWKINI52                                                         
         DROP  R2                                                               
                                                                                
AWKINI58 TM    BYTE,X'80'          TEST MULTIPLE TARGET 1'S                     
         BNZ   *+8                                                              
         OI    TG1VAR+VARCTLD,TVOFFQ                                            
         TM    BYTE,X'40'          TEST MULTIPLE TARGET 2'S                     
         BNZ   AWKINIX                                                          
         OI    TG2VAR+VARCTLD,TVOFFQ                                            
                                                                                
AWKINIX  J     EXIT                                                             
         DROP  RB,SUP,W                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Update unit records                                                 *         
***********************************************************************         
                                                                                
REWREC   NMOD1 0,**REWREC                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         TM    RUNFLAG,RUNFSOON    TEST RUNNING SOON                            
         BZ    REWREC02                                                         
         L     RF,ABUFF1           YES - INITIALIZE NEW UNIT KEY BUFFER         
         USING BUFFD,RF                                                         
         LHI   R0,L'NUKEY                                                       
         STCM  R0,3,BUFFLKEY                                                    
         XC    BUFFLCOM,BUFFLCOM                                                
         MVI   BUFFNCOL,0                                                       
         NI    BUFFINDS,BUFFIINI                                                
         OI    BUFFINDS,BUFFIDTA                                                
         GOTOR BUFFERIN,DMCB,('BUFFAINI',ABUFF1),0,ACOMFACS,XA=OFF              
         DROP  RF                                                               
                                                                                
         USING NETBLKD,R8                                                       
REWREC02 MVI   FORCEHED,YESQ                                                    
         MVI   PODRPTSW,NOQ        CLEAR POD ANALYSIS REPORT SWITCH             
         CLI   PCHAOPTN,YESQ       IF DOING POD CHANGE ANALYSIS                 
         BNE   REWREC04                                                         
         CLI   PODCOD,SPACE        AND A POD REQUEST                            
         BE    REWREC04                                                         
         MVI   RCSUBPRG,8                                                       
                                                                                
REWREC04 MVI   NBNOWRIT,NOQ        SUPPRESS FILE MARK                           
         CLI   QOPT4,YESQ          FOR TEST                                     
         BE    *+8                                                              
         MVI   NBNOWRIT,YESQ       TURN OF WRITE                                
         L     R6,NBAIO                                                         
         USING NURECD,R6                                                        
         LARL  R3,SUBTAB                                                        
         USING SUBTABD,R3                                                       
         MVI   SUBTABD,SUBTEOTQ    CLEAR SUBTAB                                 
                                                                                
W        USING UBUFFRD,WORK2                                                    
         XC    W.UBUFFK(UBUFFKL),W.UBUFFK                                       
         GOTOR BU2RDH,W.UBUFFRD                                                 
         B     REWREC08                                                         
REWREC06 GOTOR BU2RSQ,W.UBUFFRD                                                 
REWREC08 BNZ   REWREC24                                                         
                                                                                
         TM    W.UBSTAT2,UBSPRALQ  SKIP IF PRE-ALLOCATED                        
         BNZ   REWREC06                                                         
         OC    W.UBDA,W.UBDA       IF NO DISK ADDRESS                           
         BNZ   REWREC10                                                         
         GOTOR APODUPD,W.UBUFFRD   CALL POD UPDATE ROUTINE                      
         B     REWREC06                                                         
                                                                                
REWREC10 MVC   NBKEY+(NUDA-NURECD)(L'NUDA),W.UBDA                               
         MVI   NBFUNCT,NBFGET                                                   
         GOTOR NETIO,DMCB,NETBLKD,XA=OFF                                        
                                                                                
         GOTOR AGETUNT             GET CURRENT UNIT VALUES                      
         BE    *+6                                                              
         DC    H'0'                NOT BAD BEFORE SO CAN'T BE BAD NOW           
                                                                                
         CLI   SPLPOPTN,SPLPGPPQ   PSEUDO PIGS NEED SPECIAL TREATMENT           
         BNE   REWREC16                                                         
         OC    W.UBPRD2,W.UBPRD2   IF NO SECOND PRODUCT, ITS A REG UNIT         
         BZ    REWREC16                                                         
                                                                                
         OC    W.UBPRD3,W.UBPRD3   NO THIRD PRODUCT ALLOWED                     
         BNZ   REWREC12                                                         
         CLC   W.UBPRD1,UNAPRD     UNA NOT ALLOWED                              
         BE    REWREC12                                                         
         CLC   W.UBPRD2,UNAPRD                                                  
         BE    REWREC12                                                         
         SR    RF,RF                                                            
         IC    RF,W.UBLEN1         SUM OF LENGTHS                               
         SR    RE,RE                                                            
         IC    RE,W.UBLEN2                                                      
         AR    RF,RE                                                            
         CLM   RF,1,NULEN          MUST BE RIGHT                                
         BE    REWREC14                                                         
                                                                                
REWREC12 DC    H'0'                SHOULD NEVER HAPPEN                          
                                                                                
REWREC14 XC    ALCVALS(ALCVALL),ALCVALS                                         
         MVC   ALCPRD1,W.UBPRD1    SET NEW ALLOCATION VALUES                    
         MVC   ALCPRD2,W.UBPRD2                                                 
         MVC   ALCLEN,NULEN                                                     
         MVC   ALCLEN1,W.UBLEN1                                                 
         B     REWREC18                                                         
                                                                                
REWREC16 MVC   HOLDPRD,W.UBPRD1                                                 
         CLC   W.UBPRD1,UNAPRD     TEST UNALLOCATED                             
         BNE   *+10                                                             
         XC    HOLDPRD,HOLDPRD     YES - CLEAR PRODUCT                          
         CLC   UNTPRD1,HOLDPRD     IS ALLOCATION THE SAME                       
         BE    REWREC06            YES SKIP                                     
                                                                                
         XC    ALCVALS(ALCVALL),ALCVALS                                         
         MVC   ALCPRD1,HOLDPRD     SET NEW ALLOCATION VALUES                    
         MVC   ALCLEN,NULEN                                                     
                                                                                
REWREC18 GOTOR AUPDUNT             UPDATE UNIT RECORD                           
                                                                                
REWREC20 TM    DIAGNOP1,DPRTUPDQ   TEST TO DUMP WRITES                          
         BZ    REWREC22                                                         
         MVC   P1(4),=C'Unt='                                                   
         GOTOR HEXOUT,HEXPARM,W.UBUFFRD,P1+4,UBFIXLN,NOL,XA=OFF                 
         MVC   P2(4),=C'Rec='                                                   
         GOTOR (RF),(R1),NURECD,P2+4,50,XA=OFF                                  
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
                                                                                
REWREC22 MVI   NBFUNCT,NBFNORM                                                  
         MVI   NBUPUNIT,YESQ                                                    
         GOTOR NETIO,DMCB,NETBLKD,XA=OFF                                        
         B     REWREC06                                                         
                                                                                
REWREC24 MVC   W.UBUFFK(UBNET-UBUFFK),EFFS                                      
         GOTOR APODUPD,W.UBUFFRD   CALL POD UPDATE ROUTINE                      
                                                                                
         CLI   RCSUBPRG,8          IF POD REPORT CALLED FOR                     
         BNE   REWRECX                                                          
         CLI   PODRPTSW,NOQ        BUT NO CHANGES TO REPORT                     
         BNE   REWRECX                                                          
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1+5(38),=C'** No unit length changes to report **'              
         GOTOR REPORT,XA=OFF                                                    
                                                                                
REWRECX  J     EXIT                                                             
         DROP  R6,R8,RB,W                                                       
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Set current values for unit in UNTVALS                              *         
***********************************************************************         
                                                                                
GETUNT   NMOD1 0,**GETUNT                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     R2,ANETBLK                                                       
         USING NETBLKD,R2          R2=A(NETBLOCK)                               
         L     R3,NBAIO                                                         
         USING NURECD,R3           R3=A(UNIT RECORD)                            
                                                                                
         XC    UNTVALS(UNTVALL),UNTVALS                                         
         MVC   UNTLEN,NULEN        PRESET UNIT LENGTH                           
         MVC   UNTLEN1,NULEN       PRESET PRODUCT 1 LENGTH                      
         MVC   UNTP1SHR,NUP1SHR    PRESET PRODUCT 1 SHARE                       
                                                                                
         LA    R4,NUDATA                                                        
         USING NUPDED,R4           R4=A(FIRST ELEMENT ON RECORD)                
         SR    R0,R0                                                            
GETUNT02 CLI   NUPDEEL,EOR         TEST END OF RECORD                           
         BE    GETUNT04                                                         
         CLI   NUPDEEL,NUPDEELQ    TEST PRODUCT ELEMENT                         
         BE    GETUNT06                                                         
         IC    R0,NUPDELEN         BUMP TO NEXT ELEMENT ON RECORD               
         AR    R4,R0                                                            
         B     GETUNT02                                                         
                                                                                
GETUNT04 CLI   NUPRD,0             TEST ALLOCATED                               
         BE    GETUNTY                                                          
                                                                                
         GOTOR LOCPRN,NUPRD                                                     
         BNE   GETUNTN                                                          
         STCM  R1,PRDMSKQ,UNTPRD1  SET ALLOCATED PRODUCT 1                      
         CLI   NUPRD2,0                                                         
         BE    GETUNTY                                                          
         GOTOR LOCPRN,NUPRD2                                                    
         BNE   GETUNTN                                                          
         STCM  R1,PRDMSKQ,UNTPRD2  SET ALLOCATED PRODUCT 2                      
         B     GETUNT08                                                         
                                                                                
GETUNT06 CLI   NUPDELEN,NUPDEFL2   TEST MORE THAN 2 PRODUCTS                    
         BH    GETUNTN                                                          
                                                                                
         GOTOR LOCPRA,NUPDEPR      LOCATE PRODUCT 1                             
         BNE   GETUNTN                                                          
         STCM  R1,PRDMSKQ,UNTPRD1  SET ALLOCATED PRODUCT 1                      
         MVC   UNTP1SHR,NUPDEPCT   SET PRODUCT 1 SHARE                          
         CLI   NUPDELEN,NUPDEFL1   TEST 2 PRODUCTS                              
         BNH   GETUNTY                                                          
         GOTOR LOCPRA,NUPDEPR+NUPDTLEN                                          
         BNE   GETUNTN                                                          
         STCM  R1,PRDMSKQ,UNTPRD2  SET ALLOCATED PRODUCT 2                      
                                                                                
GETUNT08 SR    R1,R1               SET SPLIT LENGTHS                            
         IC    R1,UNTLEN                                                        
         SR    R0,R0                                                            
         ICM   R0,3,UNTP1SHR       X FIRST SHARE                                
         BNZ   *+8                                                              
         LHI   R0,5000                                                          
         MR    R0,R0                                                            
         LHI   RF,10000                                                         
         GOTOR DIVIDE                                                           
         STC   R1,UNTLEN1          = FIRST LENGTH                               
         SR    RF,RF                                                            
         IC    RF,UNTLEN                                                        
         SR    RF,R1                                                            
         STC   RF,UNTLEN2          SET SECOND PRODUCT LENGTH                    
                                                                                
GETUNTY  LHI   R0,0                PRODUCTS ARE GOOD                            
         B     GETUNTX                                                          
                                                                                
GETUNTN  LHI   R0,1                PRODUCTS ARE BAD                             
                                                                                
GETUNTX  LTR   R0,R0               SET CC FOR CALLER                            
         J     EXIT                                                             
         DROP  R2,R3,R4,RB                                                      
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Handle POD write back                                               *         
***********************************************************************         
                                                                                
PODUPD   NMOD1 0,**PODUPD                                                       
         LR    R7,R1                                                            
         USING UBUFFRD,R7          R7=A(UNIT BUFFER RECORD)                     
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     R6,ANETBLK                                                       
         MVC   PODWRITE,NBNOWRIT-NETBLKD(R6)                                    
         L     R6,NBAIO-NETBLKD(R6)                                             
         USING NURECD,R6           R6=A(UNIT RECORD)                            
                                                                                
W        USING NURECD,PODSVPDK     WORK KEY                                     
K        USING NURECD,KEY          CURRENT KEY                                  
                                                                                
         MVI   DMINBTS,X'08'       SET TO PASS DELETES                          
         MVI   DMOUTBTS,X'FD'                                                   
         CLC   UBUFFK(UBNET-UBUFFK),EFFS                                        
         BE    *+12                                                             
         TM    UBSTAT2,UBSMSUBQ    TEST A 'MASTER' SUBPOD                       
         BZ    PODUPD82            NO - ADD TO TABLES                           
*                                  WITH NEW MASTER OR AT END                    
                                                                                
*                                  MATCH UP LISTS/WRITE RECS/DO REPORT          
         MVI   PODCHGSW,NOQ        RESET POD CHANGE SWITCH                      
         LARL  R3,SUBTAB           TEST ANY SUB LINES                           
         USING SUBTABD,R3                                                       
         CLI   SUBTABD,SUBTEOTQ                                                 
         BE    PODUPD66                                                         
         SR    R0,R0                                                            
         ICM   R0,3,PODWULEN       IF ANY UNALLOCATED                           
         BZ    PODUPD04                                                         
                                                                                
         L     R4,PODWNXAL                                                      
         USING ALCTABD,R4                                                       
PODUPD02 LR    RF,R0               DIVIDE INTO 30 SECOND UNITS                  
         CHI   RF,SECS30                                                        
         BNH   *+8                                                              
         LHI   RF,SECS30                                                        
         XC    ALCTABD(ALCTABL),ALCTABD                                         
         STC   RF,ALCTLEN          SET LENGTH (LEAVE PROD=ZERO)                 
         AHI   R4,ALCTABL                                                       
         C     R4,AALCTABX                                                      
         BL    *+6                                                              
         DC    H'0'                ALCTAB FULL                                  
         MVI   ALCTABD,ALCTEOTQ    SET NEW END                                  
         SR    R0,RF                                                            
         BP    PODUPD02                                                         
                                                                                
PODUPD04 LARL  R4,ALCTAB           NOW SPLIT UP COSTS IN ALCTAB                 
         XC    WORK(12),WORK       FOR DOLLARS USED                             
         SR    R2,R2               FOR SECONDS USED                             
         LH    RF,PODWLEN          TOTAL SECONDS                                
PODUPD06 CLI   ALCTABD,ALCTEOTQ    TEST AT END                                  
         BE    PODUPD12                                                         
         SR    R0,R0                                                            
         IC    R0,ALCTLEN                                                       
         AR    R2,R0                                                            
         L     R1,PODTTACT         ACTUAL                                       
         MR    R0,R2               X SECONDS SO FAR                             
         LH    RF,PODWLEN                                                       
         GOTOR DIVIDE              / TOTAL SECONDS                              
         CLI   SPLDOPTN,SPLDDOLQ   OPTION TO ROUND TO DOLLARS                   
         BNE   PODUPD08                                                         
         M     R0,FW1                                                           
         LHI   RF,100                                                           
         GOTOR DIVIDE                                                           
         M     R0,FW100                                                         
PODUPD08 S     R1,WORK+0           LESS DOLLARS SO FAR                          
         ST    R1,ALCTACT          =THIS SHARE                                  
         A     R1,WORK+0                                                        
         ST    R1,WORK+0                                                        
         L     R1,PODTTASG         ASSIGNED                                     
         MR    R0,R2               X SECONDS SO FAR                             
         LH    RF,PODWLEN                                                       
         GOTOR DIVIDE              / TOTAL SECONDS                              
         CLI   SPLDOPTN,SPLDDOLQ   OPTION TO ROUND TO DOLLARS                   
         BNE   PODUPD10                                                         
         M     R0,FW1                                                           
         LHI   RF,100                                                           
         GOTOR DIVIDE                                                           
         M     R0,FW100                                                         
PODUPD10 S     R1,WORK+4           LESS DOLLARS SO FAR                          
         ST    R1,ALCTASN          =THIS SHARE                                  
         A     R1,WORK+4                                                        
         ST    R1,WORK+4                                                        
         MVC   ALCTINT,PODTTINT                                                 
         AHI   R4,ALCTABL                                                       
         B     PODUPD06                                                         
                                                                                
***********************************************************************         
* Now try matching                                                    *         
***********************************************************************         
                                                                                
PODUPD12 LARL  R4,ALCTAB           EXACT MATCHES FIRST                          
                                                                                
PODUPD14 CLI   ALCTABD,ALCTEOTQ    TEST END OF ALCTAB                           
         BE    PODUPD22            YES - DONE                                   
*                                  FOR EACH ALCTAB ENTRY, TRY TO FIND           
         LARL  R3,SUBTAB           EXACT MATCH IN SUBTAB                        
PODUPD16 CLI   SUBTABD,SUBTEOTQ    TEST END OF SUBTAB                           
         BE    PODUPD20            GET NEW ALCTAB ENTRY                         
         CLC   ALCTPRD(ALCTSUB-ALCTPRD),SUBTPRD                                 
         BNE   PODUPD18                                                         
         TM    SUBTSTAT,SUBTSUSQ   TEST ALREADY USED                            
         BNZ   PODUPD18                                                         
*                                  HAVE MATCH                                   
         OI    ALCTSTAT,ALCTSUSQ   SET ALLOCATION USED                          
         OI    SUBTSTAT,SUBTSUSQ   SET SUBLINE USED                             
         MVC   ALCTSUB,SUBTSUB     SET SUBLINE IN ALCTAB                        
         B     PODUPD20            NEXT ALCTAB ENTRY                            
                                                                                
PODUPD18 AHI   R3,SUBTABL          NEXT SUBTAB ENTRY                            
         B     PODUPD16                                                         
                                                                                
PODUPD20 AHI   R4,ALCTABL          NEXT ALCTAB ENTRY                            
         B     PODUPD14                                                         
                                                                                
***********************************************************************         
* Now take care of non-matches                                        *         
***********************************************************************         
                                                                                
PODUPD22 MVI   PODWHSUB,0          SET SUBLINE NOT ESTABLISHED                  
         LARL  R4,ALCTAB                                                        
         LARL  R3,SUBTAB                                                        
PODUPD24 CLI   ALCTABD,ALCTEOTQ    TEST END OF ALCTAB                           
         BE    PODUPD46                                                         
         TM    ALCTSTAT,ALCTSUSQ   TEST ALREADY HANDLED                         
         BNZ   PODUPD44            YES                                          
*                                  NO - USE NEXT AVAILABLE SUB ENTRY            
PODUPD26 CLI   SUBTABD,SUBTEOTQ    NONE LEFT                                    
         BE    PODUPD28                                                         
         TM    SUBTSTAT,SUBTSUSQ   TEST THIS ONE USED                           
         BZ    *+12                NO - USE IT                                  
         AHI   R3,SUBTABL          YES - TRY NEXT                               
         B     PODUPD26                                                         
                                                                                
         GOTOR PODGET,SUBTDA       GET UNIT RECORD                              
                                                                                
         GOTOR AGETUNT             GET CURRENT UNIT VALUES                      
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         XC    ALCVALS(ALCVALL),ALCVALS                                         
         MVC   ALCLEN,ALCTLEN      SET NEW ALLOCATION VALUES                    
         MVC   ALCPRD1,ALCTPRD                                                  
                                                                                
         GOTOR AUPDUNT             UPDATE UNIT RECORD                           
                                                                                
         MVC   NUACTUAL,ALCTACT    SET ACTUAL COST                              
         MVC   NUASSIGN,ALCTASN    SET ASSIGNED COST                            
         MVC   NUINTEG,ALCTINT     SET INTEGRATION COST                         
                                                                                
         GOTOR CALCASHP,DMCB,NURECD,ACOMFACS,CLTCPRD,XA=OFF                     
         GOTOR PODPUT              PUT UNIT RECORD                              
                                                                                
         OI    SUBTSTAT,SUBTSUSQ+SUBTSRWQ                                       
         OI    ALCTSTAT,ALCTSUSQ+ALCTSRWQ                                       
         MVC   ALCTSUB,SUBTSUB     SET SUBLINE IN ALCTAB                        
         CLC   ALCTLEN,SUBTLEN     IF LENGTHS CHANGE                            
         BE    *+8                                                              
         MVI   PODCHGSW,YESQ       SET ON CHANGE SWITCH                         
         B     PODUPD44                                                         
*                                  NEED NEW RECORD                              
*                                  FIRST GET NEXT USABLE SUB NUMBER             
PODUPD28 CLI   PODWHSUB,0          TEST ALREADY HAVE LINE NUMBER                
         BNE   PODUPD34                                                         
                                                                                
         XC    K.NUKEY,K.NUKEY                                                  
         MVC   K.NUKEY(L'NUKPKEY),W.NUKEY                                       
         XC    K.NUKPSUB(L'NUKPSUB+L'NUKPDP),K.NUKPSUB                          
         GOTOR PODRDH                                                           
         B     *+8                                                              
PODUPD30 GOTOR PODSEQ                                                           
         CLC   K.NUKEY(NUKPSUB-NUKPKEY),KEYSAVE                                 
         BNE   PODUPD32                                                         
         MVC   PODWHSUB,K.NUKPSUB  SAVE HIGHEST LINE NUMBER                     
         B     PODUPD30                                                         
                                                                                
PODUPD32 CLI   PODWHSUB,0          TEST LINE NUMBER FOUND                       
         BNE   PODUPD34                                                         
         DC    H'0'                FOUND NO RECORDS                             
                                                                                
PODUPD34 SR    RF,RF                                                            
         IC    RF,PODWHSUB         BUMP SEQUENCE NUMBER                         
         AHI   RF,1                                                             
         CHI   RF,255              TEST WRAP-AROUND                             
         BH    PODUPD36                                                         
         CHI   RF,NUKSTRAQ-1       TEST WITHIN ACCEPTABLE LIMIT                 
         BL    PODUPD38                                                         
                                                                                
PODUPD36 MVC   P1(30),=C'** Too many subline numbers **'                        
         LA    RF,P1+32                                                         
         MVC   0(4,RF),K.NUKNET                                                 
         MVC   15(6,RF),K.NUKPROG                                               
         GOTOR DATCON,DMCB,(2,K.NUKDATE),(5,6(RF)),XA=OFF                       
         GOTOR REPORT,XA=OFF                                                    
         MVI   PODUPDER,YESQ       SET HAVE HAD ERROR                           
         B     *+8                 DON'T UPDATE PODWHSUB                        
PODUPD38 STC   RF,PODWHSUB                                                      
                                                                                
         MVC   K.NUKEY,KEYSAVE                                                  
         MVC   K.NUKPSUB,PODWHSUB                                               
                                                                                
         LARL  R1,SUBTAB           USE FIRST RECORD AS MODEL                    
         GOTOR PODGET,SUBTDA-SUBTABD(R1)                                        
                                                                                
         XC    ALCVALS(ALCVALL),ALCVALS                                         
         MVC   ALCPRD1,ALCTPRD     SET ALLOCATION VALUES                        
         MVC   ALCLEN,ALCTLEN                                                   
                                                                                
         MVI   NULEN,0             INDICATE NEW RECORD BEING ADDED              
         GOTOR AUPDUNT             UPDATE UNIT RECORD                           
                                                                                
         MVC   NUACTUAL,ALCTACT    SET ACTUAL COST                              
         MVC   NUASSIGN,ALCTASN    SET ASSIGNED COST                            
         MVC   NUINTEG,ALCTINT     SET INTEGRATION COST                         
                                                                                
         MVC   NUKSUB,PODWHSUB     SET SUBLINE NUMBER                           
         GOTOR KEYFIX,NUKEY        FIX UNIT KEY IF NECESSARY                    
         BE    PODUPD40                                                         
         CLI   PODUPDER,YESQ       IGNORE ERROR IF ALREADY IN ERROR             
         BE    PODUPD44                                                         
         B     PODUPD36                                                         
                                                                                
PODUPD40 GOTOR CALCASHP,DMCB,NURECD,ACOMFACS,CLTCPRD,XA=OFF                     
         GOTOR PODADD              ADD UNIT RECORD                              
                                                                                
         MVC   K.NUKEY,W.NUKEY                                                  
         MVC   K.NUKPSUB,NUKSUB                                                 
         MVC   K.NUKSTAT,NURSTAT                                                
                                                                                
         GOTOR PODADR              ADD X'84' PASSIVE                            
                                                                                
         XC    K.NUKDKEY,K.NUKDKEY                                              
         MVI   K.NUKDTYPE,NUKDTYPQ                                              
         MVC   K.NUKDAM,NUKAM                                                   
         MVC   K.NUKDCLT,NUKCLT                                                 
         MVC   K.NUKDEST,NUKEST                                                 
         MVC   K.NUKDNET,NUKNET                                                 
                                                                                
         LARL  RF,DAYTAB           SET DAY FROM TRANSLATE LIST                  
         LHI   RE,DAYTABN                                                       
PODUPD42 CLC   NUDAY,0(RF)                                                      
         BE    *+12                                                             
         AHI   RF,L'DAYTAB                                                      
         BCT   RE,PODUPD42                                                      
                                                                                
         MVC   K.NUKDDAY,1(RF)     SET DAY TRANSLATE                            
         MVC   K.NUKDTIME,NUKTIME                                               
         MVC   K.NUKDPROG,NUKPROG                                               
         MVC   K.NUKDDATE,NUKDATE                                               
         MVC   K.NUKDSUB,NUKSUB                                                 
                                                                                
         GOTOR PODADR              ADD X'94' PASSIVE POINTER                    
                                                                                
         OI    ALCTSTAT,ALCTSUSQ+ALCTSRWQ+ALCTSRAQ                              
         MVC   ALCTSUB,NUKSUB      SET SUBLINE IN ALCTAB                        
         MVI   PODCHGSW,YESQ       SET ON CHANGE SWITCH                         
PODUPD44 AHI   R4,ALCTABL          NEXT ALCTAB ENTRY                            
         B     PODUPD24                                                         
                                                                                
***********************************************************************         
* Done with my allocations, see if any records left over              *         
***********************************************************************         
                                                                                
PODUPD46 LARL  R3,SUBTAB                                                        
PODUPD48 CLI   SUBTABD,SUBTEOTQ    TEST END OF LIST                             
         BE    PODUPD56                                                         
         TM    SUBTSTAT,SUBTSUSQ   TEST USED                                    
         BNZ   PODUPD50            YES                                          
         GOTOR PODGET,SUBTDA                                                    
         OI    NUUNITST,NBUNPREQ   SET PRE-EMPTED                               
         GOTOR PODPUT                                                           
         MVI   PODCHGSW,YESQ       SET ON CHANGE SWITCH                         
PODUPD50 AHI   R3,SUBTABL          NEXT ENTRY                                   
         B     PODUPD48                                                         
                                                                                
PODUPD56 TM    DIAGNOP1,DPRTUPDQ                                                
         BZ    PODUPD66                                                         
         MVC   P1(4),=C'Key='                                                   
         GOTOR HEXOUT,HEXPARM,W.NUKEY,P1+4,L'NUKEY,NOL,XA=OFF                   
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
                                                                                
         LARL  R3,SUBTAB                                                        
PODUPD58 CLI   SUBTABD,SUBTEOTQ    TEST END OF TABLE                            
         BE    PODUPD62                                                         
         MVC   P1(4),=C'Sub='                                                   
         MVC   P1+4(L'PTPRDA),UNALITL                                           
         OC    SUBTPRD,SUBTPRD                                                  
         BZ    PODUPD60                                                         
         GOTOR LOCPRD,SUBTPRD                                                   
         MVC   P1+4(L'PTPRDA),PTPRDA-PTBUFFD(R1)                                
                                                                                
PODUPD60 GOTOR HEXOUT,HEXPARM,SUBTSTAT,P1+52,1,NOL,XA=OFF                       
         GOTOR (RF),(R1),SUBTDA,P1+55,4,NOL,XA=OFF                              
         EDIT  (B4,SUBTACT),(12,P1+11),2,FLOAT=$                                
         EDIT  (B4,SUBTASN),(12,P1+24),2,FLOAT=$                                
         EDIT  (B4,SUBTINT),(12,P1+37),2,FLOAT=$                                
         EDIT  (B1,SUBTSUB),(3,P1+64),FILL=0                                    
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         AHI   R3,SUBTABL                                                       
         B     PODUPD58                                                         
                                                                                
PODUPD62 LARL  R4,ALCTAB                                                        
         USING ALCTABD,R4                                                       
PODUPD64 CLI   ALCTABD,ALCTEOTQ    TEST END OF TABLE                            
         BE    PODUPD66                                                         
         MVC   P1(4),=C'Alt='                                                   
         GOTOR LOCPRD,ALCTPRD                                                   
         MVC   P1+4(L'PTPRDA),PTPRDA-PTBUFFD(R1)                                
         GOTOR HEXOUT,HEXPARM,ALCTSTAT,P1+52,1,NOL,XA=OFF                       
         EDIT  (B4,ALCTACT),(12,P1+11),2,FLOAT=$                                
         EDIT  (B4,ALCTASN),(12,P1+24),2,FLOAT=$                                
         EDIT  (B4,ALCTINT),(12,P1+37),2,FLOAT=$                                
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
         AHI   R4,ALCTABL                                                       
         B     PODUPD64                                                         
                                                                                
PODUPD66 CLI   PCHAOPTN,YESQ       OPTION FOR THIS REPORT                       
         BNE   PODUPD80                                                         
         CLI   PODCOD,SPACE        AND MUST BE POD RUN                          
         BNH   PODUPD80                                                         
         LARL  R3,SUBTAB           TEST ANY SUBLINES                            
         CLI   SUBTABD,SUBTEOTQ    NO, DONE                                     
         BE    PODUPD80                                                         
         CLI   PODCHGSW,YESQ       WERE THERE ANY SUBSTANTIVE CHANGES           
         BNE   PODUPD80            NO, DONE                                     
         MVC   PDLNET,W.NUKPNET                                                 
         GOTOR DATCON,DMCB,(2,W.NUKPDATE),(5,PDLDATE),XA=OFF                    
         MVC   PDLPGM,W.NUKPPROG                                                
         SR    R0,R0                                                            
         IC    R0,W.NUKPEST                                                     
         CVD   R0,DUB                                                           
         OI    DUB+7,DIGIT                                                      
         UNPK  PDLEST,DUB                                                       
                                                                                
PODUPD68 LARL  R3,SUBTAB           SUBTAB HAS ORIGINALS                         
         LARL  R4,ALCTAB           ALCTAB HAS NEW ALLOCATIONS                   
         USING ALCTABD,R4                                                       
                                                                                
PODUPD70 CLI   SUBTABD,SUBTEOTQ    TEST END OF UNIT TABLE                       
         BE    PODUPD74                                                         
         SR    R0,R0                                                            
         IC    R0,SUBTSUB          SUB-LINE                                     
         CVD   R0,DUB                                                           
         OI    DUB+7,DIGIT                                                      
         UNPK  PDLBFLIN,DUB                                                     
         MVC   PDLBFPRD,UNALITL                                                 
         OC    SUBTPRD,SUBTPRD                                                  
         BZ    PODUPD72                                                         
         GOTOR LOCPRD,SUBTPRD                                                   
         MVC   PDLBFPRD,PTPRDA-PTBUFFD(R1)                                      
PODUPD72 SR    R0,R0                                                            
         IC    R0,SUBTLEN          LENGTH                                       
         CVD   R0,DUB                                                           
         OI    DUB+7,DIGIT                                                      
         UNPK  PDLBFLEN,DUB                                                     
                                                                                
PODUPD74 CLI   ALCTABD,ALCTEOTQ    TEST END OF ALLOCATION TABLE                 
         BE    PODUPD76                                                         
         SR    R0,R0                                                            
         IC    R0,ALCTSUB          SUB-LINE                                     
         CVD   R0,DUB                                                           
         OI    DUB+7,DIGIT                                                      
         UNPK  PDLAFLIN,DUB                                                     
         MVC   PDLAFPRD,UNALITL                                                 
         OC    ALCTPRD,ALCTPRD     TEST 'UNALLOCATED'                           
         JZ    PODUPD75                                                         
         GOTOR LOCPRD,ALCTPRD                                                   
         MVC   PDLAFPRD,PTPRDA-PTBUFFD(R1)                                      
PODUPD75 SR    R0,R0                                                            
         IC    R0,ALCTLEN          LENGTH                                       
         CVD   R0,DUB                                                           
         OI    DUB+7,DIGIT                                                      
         UNPK  PDLAFLEN,DUB                                                     
                                                                                
PODUPD76 CLI   SUBTABD,SUBTEOTQ                                                 
         BNE   *+12                                                             
         CLI   ALCTABD,ALCTEOTQ                                                 
         BE    PODUPD78                                                         
         GOTOR REPORT,XA=OFF                                                    
         CLI   SUBTABD,SUBTEOTQ                                                 
         BE    *+8                                                              
         AHI   R3,SUBTABL          NEXT SUBTAB ENTRY                            
         CLI   ALCTABD,ALCTEOTQ                                                 
         BE    *+8                                                              
         AHI   R4,ALCTABL          NEXT ALCTAB ENTRY                            
         B     PODUPD70                                                         
                                                                                
PODUPD78 MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         MVI   PODRPTSW,YESQ       SET HAVE DONE POD ANALYSIS REP               
                                                                                
PODUPD80 LARL  R3,SUBTAB           SET START OF SUBLINE TABLE                   
         MVI   SUBTABD,SUBTEOTQ                                                 
         ST    R3,PODWNXSU                                                      
                                                                                
         LARL  R4,ALCTAB           SET START OF ALLOCATION TABLE                
         ST    R4,PODWNXAL                                                      
         MVI   ALCTABD,ALCTEOTQ                                                 
         DROP  R4                                                               
                                                                                
         XC    PODVALS(PODVALL),PODVALS                                         
                                                                                
PODUPD82 LH    R4,NTARGETS         FULL POD DESCRIPTION IS AT END               
         SLL   R4,2                OF TARGETS                                   
         LA    R4,UBTARGS(R4)      USE R4                                       
PODUPD84 CLC   UBUFFK(UBNET-UBUFFK),EFFS                                        
         BE    PODUPD98                                                         
         XC    W.NUKEY,W.NUKEY                                                  
         MVI   W.NUKPTYPE,NUKPTYPQ BUILD THE X'84' PASSIVE KEY                  
         L     RF,ANETBLK                                                       
         MVC   W.NUKPAM,NBACTAM-NETBLKD(RF)                                     
         MVC   W.NUKPCLT,NBACTCLI-NETBLKD(RF)                                   
         MVC   W.NUKPNET,UBNET                                                  
         LH    RF,UBENV1           GET PROGRAM CODE FROM ENV1 TABLE             
         BCTR  RF,0                                                             
         MHI   RF,ENVS1LEN                                                      
         L     R1,AENV1SET         ENVIRONMENT 1 VALUE SET                      
         A     RF,ENVSATAB-ENVSETD(R1)                                          
         MVC   W.NUKPPROG,ENVS1PGC-ENVTABD(RF)                                  
         MVC   W.NUKPDATE,UBDATE                                                
         MVC   W.NUKPEST,UBEST                                                  
         MVC   W.NUKPDP,UBDPT                                                   
*                                  NOW READ EACH EXISTING SUB LINE              
*                                  AND BUILD TABLE                              
         L     R3,PODWNXSU                                                      
         USING SUBTABD,R3          R3=A(SUBLINE TABLE ENTRY)                    
         LHI   R0,L'UBPDLINS       FOR BCT                                      
PODUPD86 CLI   0(R4),0             TEST END OF SUBLINES                         
         BE    PODUPD88                                                         
         C     R3,ASUBTABX         TEST ROOM FOR ANOTHER SUBLINE                
         BL    *+6                                                              
         DC    H'0'                TOO MANY SUBLINES IN A POD                   
         MVC   K.NUKEY,W.NUKEY                                                  
         MVC   K.NUKPSUB,0(R4)                                                  
                                                                                
         GOTOR PODRDE              READ DIRECTORY RECORD                        
         GOTOR PODGET,K.NUDA       READ UNIT RECORD                             
                                                                                
         GOTOR AGETUNT             GET CURRENT UNIT VALUES                      
         BE    *+6                                                              
         DC    H'0'                NOT BAD BEFORE SO CAN'T BE BAD NOW           
                                                                                
         XC    SUBTABD(SUBTABL),SUBTABD                                         
         MVC   SUBTSUB,NUKSUB                                                   
         MVC   SUBTSTIM,NUKTIME                                                 
         MVC   SUBTDA,K.NUDA                                                    
         MVC   SUBTPRD,UNTPRD1                                                  
         MVC   SUBTLEN,NULEN                                                    
         MVC   SUBTACT,NUACTUAL                                                 
         MVC   SUBTASN,NUASSIGN                                                 
         MVC   SUBTINT,NUINTEG                                                  
         L     RF,PODTTACT                                                      
         A     RF,SUBTACT                                                       
         ST    RF,PODTTACT         TOTAL ACTUAL COST                            
         L     RF,PODTTASG                                                      
         A     RF,SUBTASN                                                       
         ST    RF,PODTTASG         TOTAL ASSIGNED COST                          
         OC    PODTTINT,PODTTINT   TEST ALREADY HAVE INTEGRATION COST           
         BNZ   *+10                                                             
         MVC   PODTTINT,SUBTINT    NO - SET FROM FIRST UNIT FOUND               
         AHI   R3,SUBTABL          BUMP TO NEXT ENTRY                           
         MVI   SUBTABD,SUBTEOTQ    SET NEW END OF TABLE                         
         ST    R3,PODWNXSU                                                      
         AHI   R4,1                NEXT POD SUBLINE                             
         BCT   R0,PODUPD86                                                      
                                                                                
PODUPD88 SR    R0,R0               NOW ADD SUB-POD ALLOCS TO TABLE              
         IC    R0,UBPDLEN          CUME SECONDS LENGTH                          
         AH    R0,PODWLEN                                                       
         STH   R0,PODWLEN                                                       
         SR    R0,R0                                                            
         IC    R0,UBUNLEN          CUME UNALLOCATED SECONDS LENGTH              
         AH    R0,PODWULEN                                                      
         STH   R0,PODWULEN                                                      
                                                                                
         LA    R2,UBPRD1                                                        
         MVI   PODCOUNT,1          FOR BCT                                      
         L     R4,PODWNXAL         ADDRESS FOR NEXT ALLOCATION ENTRY            
         USING ALCTABD,R4                                                       
PODUPD90 OC    0(L'UBPRD,R2),0(R2)                                              
         BZ    PODUPD94                                                         
         XC    ALCTABD(ALCTABL),ALCTABD                                         
         MVC   ALCTPRD(L'ALCTPRD+L'ALCTLEN),0(R2)                               
         CLC   ALCTPRD,UNAPRD      CHANGE UNALLOCATED                           
         BNE   *+10                                                             
         XC    ALCTPRD,ALCTPRD     TO 0                                         
         AHI   R4,ALCTABL          NEXT ENTRY                                   
         C     R4,AALCTABX                                                      
         BL    PODUPD92                                                         
         MVC   P1(27),=C'** Allocation table full **'                           
         LA    RF,P1+32                                                         
         MVC   0(4,RF),NUKNET                                                   
         MVC   15(6,RF),NUKPROG                                                 
         GOTOR DATCON,DMCB,(2,NUKDATE),(5,6(RF)),XA=OFF                         
         GOTOR REPORT,XA=OFF                                                    
         MVI   PODUPDER,YESQ       SET HAVE HAD ERROR                           
         B     PODUPD96                                                         
                                                                                
PODUPD92 AHI   R2,UBPRDL           NEXT SLOT                                    
         SR    R1,R1                                                            
         IC    R1,PODCOUNT         BUMP SLOT COUNT                              
         AHI   R1,1                                                             
         STC   R1,PODCOUNT                                                      
         CLI   PODCOUNT,UBPODMAX   TEST AGAINST MAXIMUM VALUE                   
         BNH   PODUPD90                                                         
                                                                                
PODUPD94 ST    R4,PODWNXAL         SET ADDRESS OF NEXT ENTRY                    
         MVI   ALCTABD,ALCTEOTQ                                                 
                                                                                
PODUPD96 TM    DIAGNOP1,DPRTUPDQ                                                
         BZ    PODUPD98                                                         
         MVI   SKIPSPEC,YESQ                                                    
         MVC   P1(4),=C'POD='                                                   
         EDIT  (B2,UBSEQ),(5,P1+4)                                              
         LH    RF,NTARGETS         FULL POD DESCRIPTION IS AT END               
         SLL   RF,2                OF TARGETS                                   
         LA    RF,UBTARGS(RF)      USE RF                                       
         MVC   WORK(L'UBPDLINS),UBPDLINS-UBPODD(RF)                             
         GOTOR HEXOUT,HEXPARM,WORK,P1+10,L'UBPDLINS,NOL,XA=OFF                  
         MVC   WORK(UBSTATL),UBSTAT                                             
         GOTOR (RF),(R1),WORK,P1+83,UBSTATL,NOL,XA=OFF                          
         GOTOR LOCPRD,UBPRD1                                                    
         MVC   P1+32(L'PTPRDA),PTPRDA-PTBUFFD(R1)                               
         MVC   P1+58(6),=C'Pdlen='                                              
         EDIT  (B1,UBPDLEN),(3,P1+64)                                           
         MVC   P1+68(6),=C'Unlen='                                              
         EDIT  (B1,UBUNLEN),(3,P1+74),ZERO=NOBLANK                              
         MVC   P1+78(5),=C'Stat='                                               
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
                                                                                
PODUPD98 MVI   DMINBTS,0           SET NOT TO PASS DELETES                      
         MVI   DMOUTBTS,FF                                                      
                                                                                
PODUPDX  J     EXIT                                                             
         DROP  R3,R4                                                            
         EJECT                                                                  
***********************************************************************         
* POD unit I/O routines                                               *         
***********************************************************************         
                                                                                
PODRDH   ST    RE,SAVERE                                                        
         MVC   KEYSAVE,K.NUKEY                                                  
         GOTOR DATAMGR,DMCB,(DMINBTS,DMRDHI),UNTDIR,K.NUKEY,K.NUKEY,0, *        
               XA=OFF                                                           
         B     PODIOC                                                           
                                                                                
PODRDE   ST    RE,SAVERE                                                        
         MVC   KEYSAVE,K.NUKEY                                                  
         GOTOR DATAMGR,DMCB,(DMINBTS,DMREAD),UNTDIR,K.NUKEY,K.NUKEY,0, *        
               XA=OFF                                                           
         B     PODIOC                                                           
                                                                                
PODSEQ   ST    RE,SAVERE                                                        
         GOTOR DATAMGR,DMCB,(DMINBTS,DMRSEQ),UNTDIR,K.NUKEY,K.NUKEY,0, *        
               XA=OFF                                                           
         B     PODIOC                                                           
                                                                                
PODWRT   ST    RE,SAVERE                                                        
         GOTOR ,DMCB,DMWRT,UNTDIR,K.NUKEY,K.NUKEY,0                             
         CLI   PODWRITE,YESQ                                                    
         BNE   PODTRC                                                           
         GOTOR DATAMGR,XA=OFF                                                   
         B     PODIOC                                                           
                                                                                
PODADR   ST    RE,SAVERE                                                        
         GOTOR ,DMCB,DMADD,UNTDIR,K.NUKEY,K.NUKEY,0                             
         CLI   PODWRITE,YESQ                                                    
         BNE   PODTRC                                                           
         GOTOR DATAMGR,XA=OFF                                                   
         B     PODIOC                                                           
                                                                                
PODGET   ST    RE,SAVERE                                                        
         MVC   K.NUDA,0(R1)        SET UNIT DISK ADDRESS                        
         GOTOR DATAMGR,DMCB,GETREC,UNTFIL,K.NUDA,NURECD,DMWORK,XA=OFF           
         XC    UNTVALS(UNTVALL),UNTVALS                                         
         B     PODIOC                                                           
                                                                                
PODADD   ST    RE,SAVERE                                                        
         GOTOR ,DMCB,ADDREC,UNTFIL,K.NUDA,NURECD,DMWORK                         
         CLI   PODWRITE,YESQ                                                    
         BNE   PODTRC                                                           
         GOTOR DATAMGR,XA=OFF                                                   
         B     PODIOC                                                           
                                                                                
PODPUT   ST    RE,SAVERE                                                        
         GOTOR ,DMCB,PUTREC,UNTFIL,K.NUDA,NURECD,DMWORK                         
         CLI   PODWRITE,YESQ                                                    
         BNE   PODTRC                                                           
         GOTOR DATAMGR,XA=OFF                                                   
                                                                                
PODIOC   MVC   BYTE,8(R1)                                                       
         NC    BYTE,DMOUTBTS                                                    
         BZ    *+6                                                              
         DC    H'0'                                                             
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
PODTRC   TM    DIAGNOP1,DPRTUPDQ   DM TRACE FOR WRITES                          
         BZ    PODTRCX                                                          
         L     RF,DM1              A(COMMAND)                                   
         MVC   P1(6),0(RF)                                                      
         L     RE,DM2              A(FILE)                                      
         CLI   3(RE),C'D'          TEST DIRECTORY                               
         BNE   PODTRC02                                                         
         L     R0,DM3              RF=A(KEY)                                    
         GOTOR HEXOUT,HEXPARM,(R0),P1+10,25,NOL,XA=OFF                          
         B     PODTRC04                                                         
                                                                                
PODTRC02 L     R0,DM4              A(RECORD)                                    
         GOTOR HEXOUT,HEXPARM,(R0),P1+10,60,NOL,XA=OFF                          
         AHI   R0,60                                                            
         GOTOR (RF),(R1),(R0),P2+10,50,XA=OFF                                   
         CLI   P1,C'A'             FOR ADDS NO DA                               
         BE    PODTRC04                                                         
         GOTOR (RF),(R1),K.NUDA,P2+114,L'NUDA,XA=OFF                            
                                                                                
PODTRC04 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT,XA=OFF                                                    
                                                                                
PODTRCX  L     RE,SAVERE                                                        
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* Fix key if running soon and sub-reference number is already used    *         
***********************************************************************         
                                                                                
KEYFIX   TM    RUNFLAG,RUNFSOON    TEST RUNNING SOON                            
         BZR   RE                                                               
         STM   RE,R1,SAVERE                                                     
                                                                                
KEYFIX02 LR    R0,R1                                                            
         MVC   WORK(L'NUKEY),0(R1)                                              
         GOTOR BUFFERIN,DMCB,('BUFFAGET',ABUFF1),WORK,ACOMFACS,XA=OFF           
         TM    DM2,EOFQ+NTFQ                                                    
         BNZ   KEYFIXY                                                          
         LR    R1,R0                                                            
         SR    R0,R0                                                            
         IC    R0,NUKSUB-NUKEY(R1)                                              
         AHI   R0,1                                                             
         CHI   R0,NUKSTRAQ-1                                                    
         BH    KEYFIXN                                                          
         STC   R0,NUKSUB-NUKEY(R1)                                              
         STC   R0,PODWHSUB                                                      
         B     KEYFIX02                                                         
                                                                                
KEYFIXY  LR    R1,R0                                                            
         MVC   WORK(L'NUKEY),0(R1)                                              
         GOTOR BUFFERIN,DMCB,('BUFFAPUT',ABUFF1),WORK,ACOMFACS,XA=OFF           
         CR    RE,RE                                                            
         B     KEYFIXX                                                          
                                                                                
KEYFIXN  LTR   RE,RE                                                            
                                                                                
KEYFIXX  LM    RE,R1,SAVERE                                                     
         BR    RE                                                               
         DROP  R6,R7,RB,K                                                       
                                                                                
         LTORG                                                                  
                                                                                
PODVALS  DS    0F                  ** POD VALUES **                             
PODTTACT DS    F                   ACTUAL COST                                  
PODTTASG DS    F                   ASSIGNED COST                                
PODTTINT DS    F                   INTEGRATION COST                             
PODWLEN  DS    H                   LENGTH                                       
PODWULEN DS    H                   UNALLOCATED LENGTH                           
PODVALL  EQU   *-PODVALS                                                        
                                                                                
PODWNXAL DS    A                   A(NEXT ALLOCATION ENTRY FOR POD)             
PODWNXSU DS    A                   A(NEXT SUB-TABLE ENTRY FOR POD)              
PODWHSUB DS    X                   SUB-LINE NUMBER                              
                                                                                
PODCOUNT DS    X                   POD COUNT                                    
PODSVPDK DS    XL32                SAVED KEY                                    
PODWRITE DS    CL(L'NBNOWRIT)      EXTRACTED NBNOWRIT VALUE                     
         EJECT                                                                  
***********************************************************************         
* Set traffic, activity and allocation values in unit record.  Also   *         
* delete sequence element when either adding a new unit (split) or    *         
* changing the unit length (join).                                    *         
*                                                                     *         
* Note: NULEN is set to zero by caller to indicate that a new unit    *         
*       record is being created                                       *         
***********************************************************************         
                                                                                
UPDUNT   NMOD1 0,**UPDUNT                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     R2,ANETBLK                                                       
         L     R2,NBAIO-NETBLKD(R2)                                             
         USING NURECD,R2           R2=A(UNIT RECORD)                            
                                                                                
         CLI   NULEN,0             IF ADDING A NEW RECORD                       
         JNE   *+8                                                              
         OI    UNTINFO,UNTIDUSE    YES - SET TO DELETE EDI ELEMENT              
                                                                                
         LA    R3,NUDATA                                                        
         USING NUCMLEL,R3          R3=A(FIRST ELEMENT ON RECORD)                
         SR    R0,R0               LOOK FOR TRAFFIC/FEED ELEMENTS               
UPDUNT02 CLI   NUCMLEID,EOR        TEST END OF RECORD                           
         BE    UPDUNT14                                                         
         CLI   NUCMLEID,NUCMLEQ    TEST UNIT COMMERCIAL ELEMENT                 
         BE    UPDUNT06                                                         
         CLI   NUCMLEID,NUFDCEIQ   TEST FEED WITH CMMLS ELEMENT                 
         BE    UPDUNT12                                                         
UPDUNT04 IC    R0,NUCMLELN         BUMP TO NEXT ELEMENT                         
         AR    R3,R0                                                            
         B     UPDUNT02                                                         
                                                                                
UPDUNT06 CLI   NULEN,0             IF ADDING A NEW RECORD                       
         BNE   UPDUNT08            DELETE THE EXISTING ELEMENT...               
         GOTOR RECUP,DMCB,(C'U',NURECD),NUCMLEL,XA=OFF                          
         B     UPDUNT02                                                         
                                                                                
UPDUNT08 CLC   UNTPRD1,ALCPRD1     TEST PRODUCT 1 CHANGED                       
         BNE   *+14                                                             
         OC    UNTPRD2,ALCPRD2     TEST PRODUCT 2 CHANGED                       
         BE    UPDUNT10                                                         
                                                                                
         OI    NUCMLFLG,NUCUPCIQ   SET PRODUCT CHANGE INDICATOR                 
         CLI   BBCLOPTN,YESQ       OPTION TO CLEAR BILLBOARD INFO               
         BNE   UPDUNT10                                                         
         MVI   NUCMLBSL,0          LENGTH                                       
         XC    NUCMLBSN,NUCMLBSN   SLIDE                                        
         XC    NUCMLBCN,NUCMLBCN   COPY                                         
         XC    NUCMLBPS,NUCMLBPS   POSITION                                     
                                                                                
UPDUNT10 CLC   NULEN,ALCLEN        TEST UNIT LENGTH CHANGE                      
         BE    UPDUNT12                                                         
         OI    NUCMLFLG,NUCULCIQ   SET LENGTH CHANGE INDICATOR                  
         B     UPDUNT04            NEXT ELEMENT                                 
                                                                                
         USING NUFDCEL,R3                                                       
UPDUNT12 CLI   NULEN,0             IF ADDING A NEW RECORD                       
         BNE   UPDUNT04            DELETE THE EXISTING ELEMENT...               
         GOTOR RECUP,DMCB,(C'U',NURECD),NUFDCEL,XA=OFF                          
         B     UPDUNT02                                                         
                                                                                
UPDUNT14 LA    R3,NUDATA                                                        
         USING NUACTEL,R3          R3=A(FIRST ELEMENT ON RECORD)                
         XC    WORK,WORK           CLEAR NEW ACTIVITY ELEMENT                   
         SR    R0,R0               LOOK FOR ACTIVITY ELEMENTS                   
UPDUNT16 CLI   NUACTEL,EOR         TEST END OF RECORD                           
         BE    UPDUNT18                                                         
         CLI   NUACTEL,NUACTELQ    TEST ACTIVITY ELEMENT                        
         BH    UPDUNT18            HIGH - ALL DONE                              
         BE    *+14                                                             
         IC    R0,NUACTLEN                                                      
         AR    R3,R0                                                            
         B     UPDUNT16                                                         
                                                                                
         MVC   WORK,NUACTEL        SAVE THIS ELEMENT AND DELETE IT              
         GOTOR RECUP,DMCB,(C'U',NURECD),NUACTEL,XA=OFF                          
         B     UPDUNT16                                                         
                                                                                
***********************************************************************         
* Note: 'new' units created out of PODs get their added data from the *         
* original unit                                                       *         
***********************************************************************         
                                                                                
B        USING NUACTD,WORK                                                      
UPDUNT18 MVI   B.NUACTEL,NUACTELQ                                               
         MVI   B.NUACTLEN,NUACTLNQ                                              
         XC    B.NUACTCCD,B.NUACTCCD                                            
         MVC   B.NUACTCDT,TODAYB   LAST CHANGE DATE                             
         L     RF,VMASTC                                                        
         MVC   B.NUACTCID,MCRHPSWD-MASTD(RF)                                    
         XC    B.NUACTAGD,B.NUACTAGD                                            
         CLI   Q2USER+12,SPACE                                                  
         BNH   *+10                                                             
         MVC   B.NUACTAGD,Q2USER+12                                             
         MVC   B.NUACTRSN,SPACES                                                
         MVI   B.NUACTRSN,C'X'     DEFAULT REASON CODE                          
         CLI   Q2USER,SPACE        ANY REASON WITH REQUEST?                     
         BNH   *+10                                                             
         MVC   B.NUACTRSN,Q2USER                                                
         GOTOR RECUP,DMCB,(C'U',NURECD),B.NUACTD,(C'R',NUACTD),0,XA=OFF         
                                                                                
         CLC   NULEN,ALCLEN        TEST UNIT LENGTH CHANGED                     
         JE    *+8                                                              
         OI    UNTINFO,UNTIDUSE    YES - SET TO DELETE EDI ELEMENT              
                                                                                
         MVC   NULEN,ALCLEN        SET UNIT LENGTH                              
         MVI   NUPRD,0             CLEAR ALLOCATION VALUES                      
         MVI   NUPRD2,0                                                         
         XC    NUP1SHR,NUP1SHR                                                  
                                                                                
         OC    ALCPRD2,ALCPRD2     TEST 2 PRODUCT ALLOCATION                    
         BZ    UPDUNT20                                                         
         SR    R1,R1                                                            
         IC    R1,ALCLEN1          YES - CALCULATE PRODUCT 1 SHARE              
         SR    RF,RF                                                            
         IC    RF,ALCLEN                                                        
         M     R0,FW10000                                                       
         GOTOR DIVIDE                                                           
         STH   R1,HALF             SAVE PRODUCT 1 SHARE                         
                                                                                
UPDUNT20 LA    R3,NUDATA                                                        
         USING NUPDED,R3           R3=A(FIRST ELEMENT ON RECORD)                
         SR    R0,R0               LOCATE PRODUCT ELEMENT ON RECORD             
UPDUNT22 CLI   NUPDEEL,EOR         TEST END OF RECORD                           
         BE    UPDUNT24                                                         
         CLI   NUPDEEL,NUPDEELQ    TEST PRODUCT ELEMENT                         
         BNL   UPDUNT24            (ASSUMES IN RIGHT SEQUENCE IN UNIT)          
         IC    R0,NUPDELEN         BUMP TO NEXT ELEMENT ON RECORD               
         AR    R3,R0                                                            
         B     UPDUNT22                                                         
                                                                                
UPDUNT24 OC    ALCPRD1,ALCPRD1     TEST ANYTHING TO BE ALLOCATED                
         BZ    UPDUNT32            NO                                           
                                                                                
         GOTOR LOCPRD,ALCPRD1      SET OLD ALLOCATION VALUES                    
         MVC   NUPRD,PTPRDN-PTBUFFD(R1)                                         
         OC    ALCPRD2,ALCPRD2                                                  
         BZ    UPDUNT26                                                         
         GOTOR LOCPRD,ALCPRD2                                                   
         MVC   NUPRD2,PTPRDN-PTBUFFD(R1)                                        
         MVC   NUP1SHR,HALF                                                     
                                                                                
UPDUNT26 TM    CLTFLAG,CLTFOPRD    TEST OVERFLOW PRODUCTS FOR CLIENT            
         BNZ   *+12                                                             
         CLI   NUPDEEL,NUPDEELQ    OR PRODUCT ELEMENT ALREADY ON UNIT           
         BNE   UPDUNT34                                                         
                                                                                
B        USING NUPDED,WORK         BUILD & ADD/UPDATE PRODUCT ELEMENT           
         XC    B.NUPDED(NUPDEFL2),B.NUPDED                                      
         MVI   B.NUPDEEL,NUPDEELQ                                               
         MVI   B.NUPDELEN,NUPDEFL1                                              
         GOTOR LOCPRD,ALCPRD1      SET ALLOCATED PRODUCT 1                      
         MVC   B.NUPDEPR,PTPRDA-PTBUFFD(R1)                                     
         OC    ALCPRD2,ALCPRD2     TEST TWO PRODUCT ALLOCATION                  
         BZ    UPDUNT28                                                         
         MVC   B.NUPDEPCT,HALF     SET PRODUCT 1 PERCENT                        
         MVI   B.NUPDELEN,NUPDEFL2                                              
         GOTOR LOCPRD,ALCPRD2                                                   
         MVC   B.NUPDEPR+NUPDTLEN,PTPRDA-PTBUFFD(R1)                            
         LHI   R0,10000            CALCULATE PRODUCT 2 PERCENT                  
         SH    R0,HALF                                                          
         STCM  R0,3,B.NUPDEPCT+NUPDTLEN                                         
                                                                                
UPDUNT28 CLI   NUPDEEL,NUPDEELQ    TEST PRODUCT ELEMENT                         
         BNE   UPDUNT30            (ASSUMES IN RIGHT SEQUENCE IN UNIT)          
         GOTOR RECUP,DMCB,(C'U',NURECD),NUPDED,XA=OFF                           
UPDUNT30 GOTOR RECUP,DMCB,(C'U',NURECD),B.NUPDED,(C'R',NUPDED),0,XA=OFF         
         B     UPDUNT34                                                         
                                                                                
UPDUNT32 CLI   NUPDEEL,NUPDEELQ    DELETE PRODUCT ELEMENT AS                    
         BNE   UPDUNT34            UNIT IS NOW UNALLOCATED                      
         GOTOR RECUP,DMCB,(C'U',NURECD),NUPDEEL,XA=OFF                          
                                                                                
UPDUNT34 TM    UNTINFO,UNTIDUSE    TEST DELETE EDI ELEMENT                      
         BZ    UPDUNTX                                                          
                                                                                
         LA    R3,NUDATA                                                        
         USING NUSQD,R3            R3=A(FIRST ELEMENT ON RECORD)                
         SR    R0,R0               LOOK FOR EDI ELEMENT                         
UPDUNT36 CLI   NUSQEL,EOR          TEST END OF RECORD                           
         BE    UPDUNTX                                                          
         CLI   NUSQEL,NUSQELQ      TEST EDI ELEMENT                             
         BE    *+14                                                             
         IC    R0,NUSQLEN                                                       
         AR    R3,R0                                                            
         B     UPDUNT36                                                         
         GOTOR RECUP,DMCB,(C'U',NURECD),NUSQEL,XA=OFF                           
                                                                                
UPDUNTX  J     EXIT                                                             
         DROP  R2,R3,RB,B                                                       
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Detail unit report                                                  *         
***********************************************************************         
                                                                                
DETRPT   NMOD1 0,**DETRPT                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         CLI   RPTOPTN,RPTOALLQ    TEST DOING DETAIL REPORT                     
         BNE   DETRPTX                                                          
         MVI   RCSUBPRG,4                                                       
         CLI   WEEKNO,1            FOR WEEK 1                                   
         BNE   *+8                                                              
         MVI   FORCEHED,YESQ       ALWAYS NEW PAGE                              
         MVC   P1(L'WEEKL),WEEKL                                                
         EDIT  (B1,WEEKNO),(2,P1+5)                                             
         SR    R0,R0                                                            
         IC    R0,WEEKNO                                                        
         BCTR  R0,0                                                             
         MHI   R0,L'MEDQ1WKS                                                    
         A     R0,AWEEKLST                                                      
         GOTOR DATCON,DMCB,(2,(R0)),(5,P1+9),XA=OFF                             
         AHI   R0,2                                                             
         GOTOR (RF),(R1),(2,(R0)),(5,P1+18),XA=OFF                              
         MVI   P1+17,DASH                                                       
         MVC   P2(7),DASHES                                                     
         L     R5,AUNTTAB                                                       
         USING UBUFFRD,R5                                                       
         CLI   UBUFFRD,UBUFEOTQ                                                 
         BNE   DETRPT02                                                         
         MVC   P1+27(L'NUNTFRWK),NUNTFRWK                                       
         B     DETRPT04                                                         
DETRPT02 MVI   FORCEHED,YESQ       NEW PAGE FOR WEEK                            
         MVI   SPACING,2                                                        
DETRPT04 GOTOR REPORT,XA=OFF                                                    
         CLI   UBUFFK,UBUFEOTQ     NO UNITS - DONE                              
         BE    DETRPTX                                                          
         MVC   DRNET(L'AVALFRWK),AVALFRWK                                       
         L     R4,ASUPROW                                                       
         AH    R4,WEEKDISP                                                      
         L     R1,TPREDOL-TABDATA(R4)                                           
         LHI   R0,10               UNITS ARE 0.0                                
         CLI   PODRSW,YESQ         BUT IF POD RUN                               
         BNE   *+8                                                              
         LH    R0,PODEQU           THEN IN SECONDS                              
         MR    R0,R0                                                            
         L     RF,TPREUNT-TABDATA(R4) UNITS                                     
         GOTOR DIVIDE                                                           
         EDIT  (R1),(11,DRCOST),FLOAT=$                                         
         MVC   HDEM,CORPDEM                                                     
         L     R1,TPREDEM-TABDATA(R4)                                           
         LHI   R0,10               UNITS ARE 0.0                                
         CLI   PODRSW,YESQ         BUT IF POD RUN                               
         BNE   *+8                                                              
         LH    R0,PODEQU           THEN IN SECONDS                              
         MR    R0,R0                                                            
         L     RF,TPREUNT-TABDATA(R4) UNITS                                     
         GOTOR DIVIDE              AVERAGE RATING                               
         CLI   HDEM+1,RATINGQ                                                   
         BE    DETRPT10                                                         
         EDIT  (R1),(8,DRBASD),ZERO=NOBLANK                                     
         B     DETRPT12                                                         
DETRPT10 EDIT  (R1),(8,DRBASD),1,ZERO=NOBLANK                                   
DETRPT12 L     R1,TPREDOL-TABDATA(R4) DOLLARS                                   
         L     RF,FW1000                                                        
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,FW100                                                         
         MR    R0,RF                                                            
         L     RF,TPREDEM-TABDATA(R4)                                           
         GOTOR DIVIDE                                                           
         LA    R5,DRBASD+L'P1                                                   
         EDIT  (R1),(8,0(R5)),2    CORPORATE DEMO CPM                           
         LA    R3,TABTA1-TABDATA(R4)                                            
         LA    R5,DRTARG1                                                       
         LA    R6,TARGETS          DEMOS                                        
         SR    R7,R7                                                            
         ICM   R7,3,NTARGETS                                                    
         BZ    DETRPT20                                                         
         CHI   R7,8                ONLY 8 TARGETS CAN PRINT                     
         BNH   DETRPT14                                                         
         LHI   R7,8                NO ROOM FOR 9+ TARGETS                       
DETRPT14 MVC   HDEM,0(R6)          SET DEMO CODE                                
         L     R1,0(R3)            VALUE                                        
         LHI   R0,10               UNITS ARE 0.0                                
         CLI   PODRSW,YESQ         BUT IF POD RUN                               
         BNE   *+8                                                              
         LH    R0,PODEQU           THEN IN SECONDS                              
         MR    R0,R0                                                            
         L     RF,TPREUNT-TABDATA(R4)                                           
         GOTOR DIVIDE              AVERAGE VALUE                                
         CLI   HDEM+1,RATINGQ                                                   
         BE    DETRPT16                                                         
         EDIT  (R1),(8,0(R5)),ZERO=NOBLANK                                      
         B     DETRPT18                                                         
DETRPT16 EDIT  (R1),(8,0(R5)),1,ZERO=NOBLANK                                    
DETRPT18 L     R1,TPREDOL-TABDATA(R4) /DOLLARS                                  
         L     RF,FW1000                                                        
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,FW100                                                         
         MR    R0,RF                                                            
         L     RF,0(R3)            VALUE                                        
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,L'P1(R5)),2 TARGET CPM                                   
         AHI   R3,4                                                             
         AHI   R5,9                                                             
         AHI   R6,L'TARGETS                                                     
         BCT   R7,DETRPT14                                                      
DETRPT20 MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
                                                                                
***********************************************************************         
* Unit processing                                                     *         
***********************************************************************         
                                                                                
         L     R0,UNTTABN          SORT UNITS IN DATE/TIME ORDER                
         L     RF,UNTTABL                                                       
         GOTOR XSORT,DMCB,XSORTXA,(R0),(RF),UBDAY-UBDATE,UBDATE-UBUFFK,*        
               AUNTTAB,XA=OFF                                                   
                                                                                
         L     R5,AUNTTAB          R5=A(UNIT TABLE)                             
DETRPT22 CLI   UBUFFK,UBUFEOTQ     TEST END OF UNIT TABLE                       
         BE    DETRPTX                                                          
         LA    R8,UBPRD1           START WITH FIRST SLOT                        
         OC    0(L'UBPRD,R8),0(R8) SKIP IF COMPLETELY UNALLOCATED               
         BZ    DETRPT54                                                         
DETRPT24 MVC   DRNET(L'UBNET),UBNET                                             
         LH    R6,UBENV1                                                        
         BCTR  R6,0                                                             
         MHI   R6,ENVS1LEN                                                      
         L     R1,AENV1SET         ENVIRONMENT 1 VALUE SET                      
         A     R6,ENVSATAB-ENVSETD(R1)                                          
         USING ENVTABD,R6                                                       
         GOTOR CODAY,DMCB,ENVS1DAY,DRDAYS,XA=OFF                                
         MVC   WORK(L'UBDATE),UBDATE                                            
         GOTOR DATCON,DMCB,(2,WORK),(4,DRDATE),XA=OFF                           
         EDIT  (B1,UBEST),(3,DRLIN),FILL=0                                      
         CLC   ENVS1STR,ENVS1END                                                
         BNE   *+10                                                             
         XC    ENVS1END,ENVS1END                                                
         GOTOR UNTIME,DMCB,ENVS1TIM,DRTIME,XA=OFF                               
         MVC   DRPROG,ENVS1PGM                                                  
DETRPT28 MVC   DRCOST+L'P1+6(6),=C'CPP/M-'                                      
         LA    R3,DRBASD                                                        
         LA    R4,UBCDEM                                                        
         LA    R6,CORPDEM                                                       
         LH    R7,NTARGETS                                                      
         CHI   R7,8                ONLY 8 TARGETS CAN PRINT                     
         BNH   *+8                                                              
         LHI   R7,8                                                             
         AHI   R7,1                ADD ONE FOR CORPORATE                        
         MVC   FACTOR1,UBCOST      SET COST (SHARE) IN FACTOR1                  
         CLI   PODRSW,YESQ                                                      
         BNE   DETRPT30                                                         
         L     R1,FACTOR1          COST                                         
         SR    R0,R0                                                            
         IC    R0,L'UBPRD(R8)      X ALLOCATED SECONDS                          
         MR    R0,R0                                                            
         SR    RF,RF                                                            
         IC    RF,UBPDLEN          / POD LENGTH                                 
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1                                                       
DETRPT30 MVC   HDEM,0(R6)                                                       
         CLI   HDEM+1,RATINGQ                                                   
         BE    DETRPT32                                                         
         EDIT  (B4,0(R4)),(8,0(R3)),ZERO=NOBLANK                                
         B     DETRPT34                                                         
DETRPT32 EDIT  (B4,0(R4)),(8,0(R3)),1,ZERO=NOBLANK                              
DETRPT34 L     R1,FACTOR1          COST                                         
         L     RF,FW1000                                                        
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,FW100                                                         
         MR    R0,RF                                                            
         L     RF,0(R4)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,L'P1(R3)),2                                              
         AHI   R3,9                                                             
         AHI   R4,4                                                             
         AHI   R6,4                                                             
         BCT   R7,DETRPT30                                                      
         TM    REQFLAG1,REQFTRGS   INDICATE WHICH DEMOS ARE TARGETS             
         BZ    DETRPT42                                                         
         OC    0(L'UBPRD,R8),0(R8)                                              
         BZ    DETRPT42                                                         
         CLC   UNAPRD,0(R8)                                                     
         BE    DETRPT42                                                         
         GOTOR LOCPRD,0(R8)                                                     
         LA    R4,PTTRGS-PTBUFFD(R1)                                            
         LHI   R0,NTGVARS                                                       
         LA    R3,DRTARG1                                                       
DETRPT38 SR    RF,RF               DISPLACE TO RIGHT TARGET                     
         ICM   RF,1,0(R4)                                                       
         BZ    DETRPT40            TARGET NOT ACTIVE                            
         BCTR  RF,0                                                             
         MHI   RF,L'DRTARG1        LENGTH OF FIELD ON LINE                      
         AR    RF,R3                                                            
         MVI   L'DRTARG1-1(RF),ASTERISK                                         
DETRPT40 AHI   R4,1                                                             
         BCT   R0,DETRPT38                                                      
                                                                                
DETRPT42 MVC   DRPRD,UNALITL       UNALLOCATED                                  
         CLC   UNAPRD,0(R8)                                                     
         BE    DETRPT44                                                         
         CLC   SUPPRD,0(R8)                                                     
         BE    DETRPT44                                                         
         GOTOR LOCPRD,0(R8)                                                     
         MVC   DRPRD,PTPRDA-PTBUFFD(R1)                                         
DETRPT44 TM    UBSTAT2,UBSPRALQ    PRODUCT PRE-ALLOCATED                        
         BZ    *+8                                                              
         MVI   DRPRD+3,ASTERISK                                                 
         CLI   PODRSW,YESQ         IF A POD SET                                 
         BNE   DETRPT46                                                         
         EDIT  (B1,L'UBPRD(R8)),(3,DRLEN)                                       
         TM    UBSTAT2,UBSLPRAQ    LENGTH PRE-ALLOCATED                         
         BZ    DETRPT46                                                         
         MVI   DRLEN+3,ASTERISK                                                 
DETRPT46 EDIT  (B4,FACTOR1),(11,DRCOST),FLOAT=$                                 
         TM    DIAGNOP1,FF-(DENVBEFQ+DNDXPRTQ)                                  
         BZ    DETRPT52                                                         
         MVC   WORK(UBSTATL),UBSTAT                                             
         GOTOR HEXOUT,HEXPARM,WORK,DRSTAT,UBSTATL,NOL,XA=OFF                    
         GOTOR LOCPRD,0(R8)                                                     
         MVC   DRPRDLEN(L'PTPRDA),PTPRDA-PTBUFFD(R1)                            
         SR    R0,R0                                                            
         ICM   R0,1,L'UBPRD(R8)                                                 
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  DRPRDLEN+L'PTPRDA(2),DUB                                         
                                                                                
DETRPT52 MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         LA    R0,WORD             IF POINTING TO SPECIAL                       
         CR    R8,R0               UNALLOCATED 'SLOT'                           
         BE    DETRPT56            THEN DEFINITELY DONE                         
         AHI   R8,UBPRDL           NEXT SLOT                                    
         LA    R0,UBPRDX                                                        
         CR    R8,R0                                                            
         BH    DETRPT54                                                         
         OC    0(L'UBPRD,R8),0(R8)                                              
         BNZ   DETRPT24                                                         
*                                  DONE WITH ALLOCATION SLOTS                   
DETRPT54 CLI   UBUNLEN,0           TEST ANY UNALLOCATED LENGTH                  
         BE    DETRPT56            NO - DONE                                    
         MVC   WORD(L'UNAPRD),UNAPRD                                            
         MVC   WORD+L'UNAPRD(L'UBUNLEN),UBUNLEN                                 
         LA    R8,WORD                                                          
         B     DETRPT24                                                         
                                                                                
DETRPT56 A     R5,UNTTABL          NEXT UNIT                                    
         B     DETRPT22                                                         
                                                                                
DETRPTX  J     EXIT                                                             
         DROP  R5,R6,RB                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Detail unit report - mode 2 (2 targets or less)                     *         
***********************************************************************         
                                                                                
DT2RPT   NMOD1 0,**DT2RPT                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         CLI   RPTOPTN,RPTOALLQ    TEST DOING DETAIL REPORT                     
         BNE   DT2RPTX                                                          
         MVI   RCSUBPRG,5                                                       
         CLI   WEEKNO,1            FOR WEEK 1                                   
         BNE   *+12                                                             
         MVI   FORCEHED,YESQ       ALWAYS NEW PAGE                              
         B     DT2RPT02                                                         
         GOTOR REPORT,XA=OFF       ELSE SKIP A LINE                             
DT2RPT02 MVC   P1(L'WEEKL),WEEKL                                                
         EDIT  (B1,WEEKNO),(2,P1+5)                                             
         L     R8,MEDBUFF                                                       
         USING MEDBLOCK,R8                                                      
         SR    R4,R4                                                            
         IC    R4,WEEKNO                                                        
         BCTR  R4,0                                                             
         MHI   R4,L'MEDQ1WKS                                                    
         A     R4,AWEEKLST                                                      
         GOTOR DATCON,DMCB,(2,0(R4)),(5,P1+9),XA=OFF                            
         GOTOR (RF),(R1),(2,2(R4)),(5,P1+18),XA=OFF                             
         MVI   P1+17,DASH                                                       
         DROP  R8                                                               
         L     R5,AUNTTAB                                                       
         USING UBUFFRD,R5                                                       
         CLI   UBUFFRD,UBUFEOTQ                                                 
         BNE   DT2RPT04                                                         
         MVC   P1+27(L'NUNTFRWK),NUNTFRWK                                       
         GOTOR REPORT,XA=OFF                                                    
         B     DT2RPTX                                                          
DT2RPT04 MVI   SPACING,2                                                        
         CLI   UBUFFK,UBUFEOTQ     NO UNITS - DONE                              
         BE    DT2RPTX                                                          
         MVC   P1+30(L'AVALFRWK),AVALFRWK                                       
         L     R4,ASUPROW                                                       
         AH    R4,WEEKDISP                                                      
         L     R1,TPREDOL-TABDATA(R4)                                           
         LHI   R0,10               UNITS ARE 0.0                                
         CLI   PODRSW,YESQ         BUT IF POD RUN                               
         BNE   *+8                                                              
         LH    R0,PODEQU           THEN IN SECONDS                              
         MR    R0,R0                                                            
         L     RF,12(R4)           UNITS                                        
         GOTOR DIVIDE                                                           
DT2RPT06 EDIT  (R1),(11,D2RCOST),FLOAT=$                                        
         MVC   HDEM,CORPDEM                                                     
         L     R1,4(R4)            DEMO                                         
         LHI   R0,10               UNITS ARE 0.0                                
         CLI   PODRSW,YESQ         BUT IF POD RUN                               
         BNE   *+8                                                              
         LH    R0,PODEQU           THEN IN SECONDS                              
         MR    R0,R0                                                            
         L     RF,12(R4)           UNITS                                        
         GOTOR DIVIDE              AVERAGE RATING                               
         CLI   HDEM+1,RATINGQ                                                   
         BE    DT2RPT10                                                         
         EDIT  (R1),(7,D2RBASD),ZERO=NOBLANK                                    
         B     DT2RPT12                                                         
DT2RPT10 EDIT  (R1),(7,D2RBASD),1,ZERO=NOBLANK                                  
DT2RPT12 L     R1,8(R4)            DOLLARS                                      
         L     RF,FW1000                                                        
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,FW100                                                         
         MR    R0,RF                                                            
         L     RF,4(R4)            DEMO                                         
         GOTOR DIVIDE                                                           
         LA    R5,D2RBASCP                                                      
         EDIT  (R1),(7,0(R5)),2    CORPORATE DEMO CPM                           
         LA    R3,TABTA1-TABDATA(R4) TARGETS                                    
         LA    R5,D2RTARG1                                                      
         LA    R6,TARGETS          DEMOS                                        
         SR    R7,R7                                                            
         ICM   R7,3,NTARGETS                                                    
         BZ    DT2RPT20                                                         
DT2RPT14 MVC   HDEM,0(R6)          SET DEMO CODE                                
         L     R1,0(R3)            VALUE                                        
         LHI   R0,10               UNITS ARE 0.0                                
         CLI   PODRSW,YESQ         BUT IF POD RUN                               
         BNE   *+8                                                              
         LH    R0,PODEQU           THEN IN SECONDS                              
         MR    R0,R0                                                            
         L     RF,12(R4)           / UNITS                                      
         GOTOR DIVIDE              AVERAGE VALUE                                
         CLI   HDEM+1,RATINGQ                                                   
         BE    DT2RPT16                                                         
         EDIT  (R1),(7,0(R5)),ZERO=NOBLANK                                      
         B     DT2RPT18                                                         
DT2RPT16 EDIT  (R1),(7,0(R5)),1,ZERO=NOBLANK                                    
DT2RPT18 L     R1,8(R4)            /DOLLARS                                     
         L     RF,FW1000                                                        
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,FW100                                                         
         MR    R0,RF                                                            
         L     RF,0(R3)            VALUE                                        
         GOTOR DIVIDE                                                           
         EDIT  (R1),(7,8(R5)),2    TARGET CPM                                   
         AHI   R3,4                                                             
         AHI   R5,16                                                            
         AHI   R6,L'TARGETS                                                     
         BCT   R7,DT2RPT14                                                      
DT2RPT20 GOTOR REPORT,XA=OFF                                                    
                                                                                
***********************************************************************         
* Unit processing                                                     *         
***********************************************************************         
                                                                                
         L     R0,UNTTABN          SORT UNITS IN DATE/TIME ORDER                
         L     RF,UNTTABL                                                       
         GOTOR XSORT,DMCB,XSORTXA,(R0),(RF),UBDAY-UBDATE,UBDATE-UBUFFK,*        
               AUNTTAB,XA=OFF                                                   
         L     R5,AUNTTAB                                                       
DT2RPT22 CLI   UBUFFK,UBUFEOTQ     DONE                                         
         BE    DT2RPTX                                                          
         CLI   PODRSW,YESQ         FOR POD RUN                                  
         BNE   DT2RPT24                                                         
         GOTOR REPORT,XA=OFF       SKIP BTWEEN PODS (ACTUALLY SUB-PODS)         
DT2RPT24 LA    R8,UBPRD1           START WITH FIRST SLOT                        
         OC    0(L'UBPRD,R8),0(R8) SKIP IF COMPLETELY UNALLOCATED               
         BZ    DT2RPT52                                                         
DT2RPT26 MVC   D2RNET(L'UBNET),UBNET                                            
         LH    R6,UBENV1                                                        
         BCTR  R6,0                                                             
         MHI   R6,ENVS1LEN                                                      
         L     R1,AENV1SET         ENVIRONMENT 1 VALUE SET                      
         A     R6,ENVSATAB-ENVSETD(R1)                                          
         USING ENVTABD,R6                                                       
         GOTOR CODAY,DMCB,ENVS1DAY,D2RDAYS,XA=OFF                               
         MVC   WORK(L'UBDATE),UBDATE                                            
         GOTOR DATCON,DMCB,(2,WORK),(4,D2RDATE),XA=OFF                          
         EDIT  (B1,UBEST),(3,D2REST),FILL=0                                     
DT2RPT28 CLC   ENVS1STR,ENVS1END                                                
         BNE   *+10                                                             
         XC    ENVS1END,ENVS1END                                                
         GOTOR UNTIME,DMCB,ENVS1TIM,D2RTIME,XA=OFF                              
         MVC   D2RPROG,ENVS1PGM                                                 
DT2RPT30 LA    R3,D2RBASD                                                       
         LA    R4,UBCDEM                                                        
         LA    R6,CORPDEM                                                       
         LH    R7,NTARGETS                                                      
         AHI   R7,1                                                             
         MVC   FACTOR1,UBCOST      SET COST (SHARE) IN FACTOR1                  
         CLI   PODRSW,YESQ                                                      
         BNE   DT2RPT32                                                         
         L     R1,FACTOR1          COST                                         
         SR    R0,R0                                                            
         IC    R0,L'UBPRD(R8)      X ALLOCATED SECONDS                          
         MR    R0,R0                                                            
         SR    RF,RF                                                            
         IC    RF,UBPDLEN          / POD LENGTH                                 
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1                                                       
DT2RPT32 MVC   HDEM,0(R6)                                                       
         CLI   HDEM+1,RATINGQ                                                   
         BE    DT2RPT34                                                         
         EDIT  (B4,0(R4)),(7,0(R3)),ZERO=NOBLANK                                
         B     DT2RPT36                                                         
DT2RPT34 EDIT  (B4,0(R4)),(7,0(R3)),1,ZERO=NOBLANK                              
DT2RPT36 L     R1,FACTOR1          COST                                         
         L     RF,FW1000                                                        
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,FW100                                                         
         MR    R0,RF                                                            
         L     RF,0(R4)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(7,8(R3)),2                                                 
         AHI   R3,16                                                            
         AHI   R4,4                                                             
         AHI   R6,4                                                             
         BCT   R7,DT2RPT32                                                      
         TM    REQFLAG1,REQFTRGS   INDICATE WHICH DEMOS ARE TARGETS             
         BZ    DT2RPT42                                                         
         CLC   SUPPRD,0(R8)                                                     
         BE    DT2RPT42                                                         
         CLC   UNAPRD,0(R8)                                                     
         BE    DT2RPT42                                                         
         GOTOR LOCPRD,0(R8)                                                     
         LA    R4,PTTRGS-PTBUFFD(R1)                                            
         LHI   R0,NTGVARS                                                       
         LA    R3,D2RTARG1                                                      
DT2RPT38 SR    RF,RF               DISPLACE TO RIGHT TARGET                     
         ICM   RF,1,0(R4)                                                       
         BZ    DT2RPT40            TARGET NOT ACTIVE                            
         BCTR  RF,0                                                             
         MHI   RF,14               LENGTH OF FIELD ON LINE                      
         AR    RF,R3                                                            
         MVI   7(RF),ASTERISK                                                   
DT2RPT40 AHI   R4,1                                                             
         BCT   R0,DT2RPT38                                                      
DT2RPT42 MVC   D2RPRD,UNALITL      UNALLOCATED                                  
         CLC   UNAPRD,0(R8)                                                     
         BE    DT2RPT44                                                         
         CLC   SUPPRD,0(R8)                                                     
         BE    DT2RPT44                                                         
         GOTOR LOCPRD,0(R8)                                                     
         MVC   D2RPRD,PTPRDA-PTBUFFD(R1)                                        
DT2RPT44 TM    UBSTAT2,UBSPRALQ    PRODUCT PRE-ALLOCATED                        
         BZ    *+8                                                              
         MVI   D2RPRD+3,ASTERISK                                                
         EDIT  (B1,L'UBPRD(R8)),(3,D2RLEN)                                      
         TM    UBSTAT2,UBSLPRAQ    LENGTH PRE-ALLOCATED                         
         BZ    *+8                                                              
         MVI   D2RLEN+3,ASTERISK                                                
         EDIT  (B4,FACTOR1),(11,D2RCOST),FLOAT=$                                
         GOTOR REPORT,XA=OFF                                                    
         LA    R0,WORD             IF POINTING TO SPECIAL                       
         CR    R8,R0               UNALLOCATED 'SLOT'                           
         BE    DT2RPT54            THEN DEFINITELY DONE                         
         AHI   R8,UBPRDL           NEXT SLOT                                    
         LA    R0,UBPRDX                                                        
         CR    R8,R0                                                            
         BH    DT2RPT52                                                         
         OC    0(L'UBPRD,R8),0(R8)                                              
         BNZ   DT2RPT26                                                         
*                                  DONE WITH ALLOCATED SLOTS                    
DT2RPT52 CLI   UBUNLEN,0           TEST ANY UNALLOCATED LENGTH                  
         BE    DT2RPT54            NO - DONE                                    
         MVC   WORD(L'UNAPRD),UNAPRD                                            
         MVC   WORD+L'UNAPRD(L'UBUNLEN),UBUNLEN                                 
         LA    R8,WORD                                                          
         B     DT2RPT26                                                         
                                                                                
DT2RPT54 A     R5,UNTTABL          NEXT UNIT                                    
         B     DT2RPT22                                                         
                                                                                
DT2RPTX  J     EXIT                                                             
         DROP  R5,R6,RB                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Summary report                                                      *         
***********************************************************************         
                                                                                
SUMRPT   NMOD1 0,**SUMRPT,R8                                                    
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         MVI   FORCEHED,YESQ                                                    
         LH    RF,NTARGETS         SET 'CELL WIDTH'                             
         MHI   RF,SUMAUDL          8 BYTES FOR EACH TARGET (PRE + ACH)          
         AHI   RF,SUMDATAL         PLUS FIXED 9 WORDS-FIRST OF SUMCELLS         
         STH   RF,CELLWID                                                       
         LH    RF,NWKSP1                                                        
         MH    RF,CELLWID                                                       
         AHI   RF,TABDATA-TABD                                                  
         STH   RF,ROWLEN           LENGTH OF ROW                                
         A     RF,ASUPROW                                                       
         ST    RF,ATOTROW          TOTAL ROW                                    
         AH    RF,ROWLEN                                                        
         ST    RF,AFSTBRD          FIRST BRAND                                  
         XC    0(TABDATA-TABD,RF),0(RF)                                         
         LH    RF,RPTNOWKS         SET COLUMN SPACING CONTROLS                  
         BCTR  RF,0                                                             
         MHI   RF,L'SRLTAB         BASED ON NUMBER OF WEEKS                     
         LARL  R0,SRLTAB                                                        
         AR    RF,R0                                                            
         TM    REQFLAG1,REQFHNAD   IF HAVE NAD DEMOS                            
         BZ    *+8                 DEMO NAMES ARE LONGER                        
         AHI   RF,L'SRLTAB/2       SO USE SPECIAL CONTROLS                      
         MVC   ROWDISP+1(1),0(RF)  START OF ROW DESCRIPTION                     
         MVC   AMTDISP+1(1),1(RF)  OVER TO TOTAL COLUMN                         
         MVC   WEEKWID+1(1),2(RF)  SPACE BETWEEN COLUMNS                        
         MVI   PSLSW,PSLSNOT       SET OFF POD/LENGTH SWITCH                    
         CLI   PODRSW,YESQ         FOR POD RUN                                  
         BNE   SUMRPT02                                                         
         MVI   L.GBLEN,1           LOOK FOR FIRST LENGTH                        
         MVI   PSLSW,PSLSONE       SET DOING ONE LENGTH OF POD RUN              
         MVI   RWILNSW,RWILSEP     GETROW TO KEEP LENGTHS SEPARATE              
         B     SUMRPT76            BYPASS SEPARATE LENGTH REPORTS               
                                                                                
SUMRPT02 XC    GBUFFR(GBUFFRL),GBUFFR                                           
         MVC   GBUFFK(L'GBDPT+L'GBLEN),L.GBDPT                                  
         XC    NPRDS,NPRDS                                                      
         MVI   SUMRPTSW,0                                                       
         GOTOR CLRBRD              CLEAR BRDTAB TO BINARY ZEROES                
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     SUMRPT06                                                         
SUMRPT04 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
SUMRPT06 BZ    *+8                                                              
         MVI   GBUFFR,GBUFEOTQ                                                  
         TM    DIAGNOP1,DNDXPRTQ                                                
         BZ    SUMRPT08                                                         
         GOTOR HEXOUT,HEXPARM,GBUFFR,P1,L'GBUFFR,NOL,XA=OFF                     
         GOTOR REPORT,XA=OFF                                                    
SUMRPT08 CLI   GBUFFR,GBUFEOTQ                                                  
         BE    *+14                                                             
         OC    L.GBUFFK(GBUFFKL),L.GBUFFK                                       
         BZ    SUMRPT10                                                         
         CLC   GBDPT,L.GBDPT                                                    
         BNE   SUMRPT16                                                         
         CLC   GBLEN,L.GBLEN                                                    
         BE    SUMRPT10                                                         
         CLI   L.GBLEN,0           TEST REPORT FOR ALL POD LENGTH               
         BNE   SUMRPT16            NO - HAVE LENGTH BREAK                       
         CLC   GBPRD,TOTPRD        FOR TOTALS MUST MATCH LENGTH                 
         BNE   SUMRPT10                                                         
         CLI   GBTYP,TGOLDEMQ      BUT NEED GOALS                               
         BE    SUMRPT10                                                         
         CLI   GBTYP,TGOLDOLQ                                                   
         BNE   SUMRPT04                                                         
SUMRPT10 CLC   GBPRD,UNAPRD        BYPASS 'UNALLOCATED'                         
         BE    SUMRPT04                                                         
         CLC   GBPRD,SUPPRD        FOR SUPPLY                                   
         BNE   SUMRPT12                                                         
         SR    RE,RE                                                            
         IC    RE,GBTYP                                                         
         CLI   GBTYP,TPRET00Q      EXCEPT FOR TARGETS                           
         BH    *+8                                                              
         AHI   RE,TACHDEMQ-TGOLDEMQ                                             
         STC   RE,GBTYP            LINE UP WITH ACHIEVEMENT                     
SUMRPT12 L     R1,ASCELLS                                                       
SUMRPT14 CLI   0(R1),FF            SKIP ONES NOT NEEDED HERE                    
         BE    SUMRPT04                                                         
         CLC   GBTYP,0(R1)                                                      
         BE    *+12                                                             
         AHI   R1,L'SCELLS                                                      
         B     SUMRPT14                                                         
         S     R1,ASCELLS          GET CELL NUMBER FROM POSITION                
         SLL   R1,2                X 4                                          
         STH   R1,CELLD                                                         
         GOTOR AGETROW                                                          
         CLC   GBPRD,TOTPRD        TOTAL ROW MAY BE NULL                        
         BE    *+8                 SO DON'T                                     
         MVI   SUMRPTSW,1          SET ACTIVITY SWITCH                          
         B     SUMRPT04                                                         
*                                  RESET DPSLDESC (FOR PODS)                    
SUMRPT16 CLI   SUMRPTSW,0          NO DATA FOR DAYPART/LENGTH                   
         BE    SUMRPT72                                                         
         CLI   PODRSW,YESQ         TEST POD RUN                                 
         BNE   SUMRPT18                                                         
         LA    RE,DPSLDESC+17                                                   
         LA    RF,12                                                            
         CLI   0(RE),SLASH                                                      
         BE    SUMRPT17                                                         
         AHI   RE,1                                                             
         BCT   RF,*-12                                                          
         B     SUMRPT18                                                         
                                                                                
SUMRPT17 CLI   PSLSW,PSLSALL       TEST DOING ALL LENGTHS FOR POD               
         BNE   *+14                                                             
         MVC   1(L'PODL,RE),PODL                                                
         B     SUMRPT18                                                         
                                                                                
         EDIT  (B1,L.GBLEN),(1,4(RE)),ALIGN=LEFT                                
                                                                                
SUMRPT18 CLI   ZERWKSW,0           ZERO WEEK ERROR                              
         BE    SUMRPT20                                                         
         MVC   P1(L'UNALITL),UNALITL                                            
         MVC   P1+4(L'DPSLDESC),DPSLDESC                                        
         LA    RE,P1+4+L'DPSLDESC-1                                             
         CLI   0(RE),SPACE                                                      
         BNE   *+8                                                              
         BCT   RE,*-8                                                           
         MVC   2(50,RE),=C'has week(s) with Units but no Goals - bypass*        
               ed ***'                                                          
         GOTOR REPORT,XA=OFF                                                    
         B     SUMRPT72                                                         
                                                                                
SUMRPT20 MVI   FORCEHED,YESQ                                                    
         L     RF,AFSTBRD          SET EXCESS ROW                               
         SR    RE,RE                                                            
SUMRPT22 CLC   TABPRD-TABD(,RF),SUPPRD                                          
         BE    SUMRPT24                                                         
         AHI   RE,1                                                             
         AH    RF,ROWLEN                                                        
         B     SUMRPT22                                                         
SUMRPT24 ST    RF,AEXCROW          A(ROW FOR EXCESS)                            
         STH   RE,NPRDS                                                         
         LR    R0,RF               CLEAR EXCESS ROW                             
         LH    R1,ROWLEN                                                        
         GOTOR CLEAR                                                            
         L     RF,AEXCROW                                                       
         MVC   TABPRD-TABD(,RF),UNAPRD                                          
                                                                                
***********************************************************************         
* Set unallocated totals and set total ach = supply                   *         
***********************************************************************         
                                                                                
         CLI   PSLSW,PSLSONE       FOR REPORT FOR ONE LENGTH OF POD             
         BE    SUMRPT42            SUPPLY WILL BE MISSING                       
         L     R3,ASUPROW          SUPPLY                                       
         USING TABD,R3                                                          
         L     R4,ATOTROW          TOTALS                                       
TOT      USING TABD,R4                                                          
         MVC   TOT.TABPRD,TOTPRD                                                
         CLC   TOT.SUMASD,SUMASD                                                
         BE    SUMRPT34            IF SO - NO UNALL                             
         L     R5,AEXCROW          UNALLOCATED                                  
SUMRPT26 LH    R0,RPTNOWKS         START AT TOTAL COLUMN                        
         SR    R2,R2                                                            
         IC    R2,RPTSWK           START WEEK NO                                
         MH    R2,CELLWID                                                       
         AHI   R2,TABDATA-TABD                                                  
*                                  LOOP THRU THIS WEEK                          
SUMRPT28 LA    R7,12(R2)           SKIP GOALS                                   
         LH    RE,CELLWID                                                       
         SRL   RE,2                NUMBER OF WORDS                              
         SHI   RE,3                SKIP GOALS                                   
         SRL   RE,1                DO EVERY OTHER ONE (SKIP PRE)                
         L     RF,0(R3,R7)                                                      
         C     RF,0(R4,R7)         IF SUPPLY UNITS = ACHIEVED UNITS             
         BE    SUMRPT32            THEN NO UNALLOCATED FOR WEEK                 
SUMRPT30 L     RF,0(R3,R7)         SUPPLY                                       
         S     RF,0(R4,R7)         LESS TOTAL ACHIEVEMENT                       
         ST    RF,0(R5,R7)         = UNALLOCATED                                
         L     RF,0(R3,R7)                                                      
         ST    RF,0(R4,R7)         SET TOTAL = SUPPLY                           
         AHI   R7,8                NEXT WORD                                    
         BCT   RE,SUMRPT30                                                      
SUMRPT32 AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R0,SUMRPT28                                                      
*                                  FOR REPORT OF ALL LENGTH FOR POD             
SUMRPT34 CLI   PSLSW,PSLSALL       MUST SET EQUIV GOAL DEMO TOTALS              
         BNE   SUMRPT52                                                         
         L     R4,ATOTROW                                                       
         LH    R6,RPTNOWKS         FOR BCT                                      
         SR    R2,R2               START WITH TOTAL COLUMN                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R2,RF                                                            
SUMRPT36 SR    R0,R0                                                            
         ST    R0,SUMGLRD-TABD(R4,R2)                                           
         L     R3,AFSTBRD                                                       
SUMRPT38 CLC   TABPRD,SUPPRD       TEST END OF PRODUCT ROWS                     
         BE    SUMRPT40            NEXT WEEK                                    
         L     R1,SUMGLRD(R2)      GOAL DEMOS                                   
         GOTOR DEMEQV                                                           
         L     RF,TOT.SUMGLRD(R2)  ADD TO TOTAL ROW                             
         AR    RF,R1                                                            
         ST    RF,TOT.SUMGLRD(R2)                                               
         AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     SUMRPT38                                                         
*                                                                               
SUMRPT40 AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R6,SUMRPT36                                                      
                                                                                
***********************************************************************         
* For rpt of one length of POD or for all lengths for POD             *         
* must 'unequivalence' ach dems                                       *         
***********************************************************************         
                                                                                
SUMRPT42 L     R3,ATOTROW          START WITH TOTALS                            
         CLI   PSLSW,PSLSONE       IF ONE LENGTH                                
         BE    SUMRPT44                                                         
         L     R3,AFSTBRD          ELSE WITH FIRST BRAND                        
SUMRPT44 CLC   TABPRD,SUPPRD       TEST END OF PRODUCT ROWS                     
         BE    SUMRPT52                                                         
         CLC   TABPRD,UNAPRD       DON'T DO FOR UNALLOCATED                     
         BE    SUMRPT50                                                         
         LH    R6,RPTNOWKS         FOR BCT                                      
         SR    R2,R2               START WITH TOTAL COLUMN                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R2,RF                                                            
*                                  DO BASE AND TARGETS                          
SUMRPT46 LA    R4,SUMARD(R2)       ACHIEVED DEMO                                
         SR    R5,R5                                                            
         ICM   R5,3,NTARGETS       FOR BCT                                      
         BZ    SUMRPT52                                                         
         AHI   R5,1                ONE MORE FOR BASE DEMO                       
         SLL   R5,1                2 AMTS - ACH AND PRE FOR EACH                
SUMRPT48 L     R1,0(R4)                                                         
         GOTOR DEMUNQ                                                           
         ST    R1,0(R4)                                                         
         AHI   R4,4                                                             
         BCT   R5,SUMRPT48                                                      
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R6,SUMRPT46                                                      
SUMRPT50 AH    R3,ROWLEN           NEXT PRODUCT                                 
         B     SUMRPT44                                                         
                                                                                
SUMRPT52 MVI   FORCEHED,YESQ       NOW DO REPORT FOR EACH BRAND                 
         MVI   RCSUBPRG,3                                                       
         MVI   PCTOPT,YESQ         ACTIVATE PERCENTAGE OPTION                   
*                                  SORT BRANDS IN PRINT ORDER                   
         L     R3,AFSTBRD          FIRST BUILD TABLE OF ADDRS                   
         L     R4,APXCREC          USE PXCREC FOR BRAND SORTING                 
         SR    RF,RF                                                            
SUMRPT54 CLC   TABPRD,SUPPRD                                                    
         BE    SUMRPT56                                                         
         MVC   0(L'TABPRD,R4),TABPRD                                            
         STCM  R3,15,L'TABPRD(R4)                                               
         AH    R3,ROWLEN           NEXT PRODUCT                                 
         AHI   R4,L'TABPRD+4       NEXT TABLE ENTRY                             
         AHI   RF,1                COUNT PRODUCTS                               
         B     SUMRPT54                                                         
                                                                                
SUMRPT56 MVC   0(L'TOTPRD,R4),TOTPRD                                            
         LTR   RF,RF                                                            
         BZ    SUMRPT60            NO PRODUCTS                                  
         GOTOR XSORT,DMCB,APXCREC,(RF),L'TABPRD+4,L'TABPRD,0,XA=OFF             
         CLI   RPTOPTN,RPTORCPQ    IF DOING ONLY RECAP SKIP WEEKLY RPT          
         BE    SUMRPT64                                                         
                                                                                
         L     R4,APXCREC                                                       
SUMRPT58 CLC   TOTPRD,0(R4)        TEST END                                     
         BE    SUMRPT60                                                         
         MVC   THISPRD,L'TABPRD(R4)                                             
         GOTOR BRDREP              DO BRAND REPORT                              
         AHI   R4,L'TABPRD+4                                                    
         B     SUMRPT58                                                         
                                                                                
SUMRPT60 MVC   THISPRD,ATOTROW                                                  
         GOTOR BRDREP              DO TOTALS                                    
                                                                                
SUMRPT62 SR    RF,RF               DO RECAP REPORT                              
         IC    RF,RPTSWK           (BUT ONLY AFTER LAST SET OF WEEKS)           
         AH    RF,RPTNOWKS                                                      
         CH    RF,NWKSP1                                                        
         BL    SUMRPT66                                                         
         CLI   PSLSW,PSLSALL       TEST DOING ALL LENGTH FOR POD                
         BNE   *+14                                                             
         L     RE,AEQVMSG                                                       
         MVC   P1(L'EQVMSG),0(RE)                                               
         GOTOR REPORT,XA=OFF       AT END OF WEEK REPORT                        
                                                                                
SUMRPT64 GOTOR ARECRPT             PRINT RECAP REPORT                           
                                                                                
SUMRPT66 CLI   PSLSW,PSLSONE       FOR REPORT FOR ONE LENGTH OF POD             
         BE    SUMRPT68            SUPPLY WILL BE MISSING                       
         MVI   WORK,0                                                           
         L     R3,ASUPROW                                                       
         OC    SUMASD(L'SUMASD+L'SUMPSD),SUMASD                                 
         BZ    SUMRPT70                                                         
SUMRPT68 MVI   WORK,1                                                           
         L     R3,ATOTROW                                                       
         OC    SUMGLDD(L'SUMGLDD+L'SUMGLRD),SUMGLDD                             
         BNZ   SUMRPT72                                                         
SUMRPT70 GOTOR REPORT,XA=OFF                                                    
         MVC   P1(18),=C'*** No Supply for '                                    
         CLI   WORK,0                                                           
         BE    *+10                                                             
         MVC   P1+7(6),=C'Goals '                                               
         MVC   P1+18(L'DPSLDESC),DPSLDESC                                       
         MVI   SPACING,2                                                        
         MVC   P2,SPACES                                                        
         GOTOR REPORT,XA=OFF                                                    
                                                                                
SUMRPT72 CLI   PODRSW,YESQ         IF DOING PODS                                
         BNE   SUMRPT78                                                         
         CLC   GBDPT,L.GBDPT       TEST STILL HAVE SAME DAYPART                 
         BNE   SUMRPT76                                                         
         MVC   L.GBLEN,GBLEN       DO NEXT LENGTH                               
         B     SUMRPT02                                                         
*                                  AT END OF DAYPART                            
SUMRPT76 CLI   L.GBLEN,0           HAVE I DONE 'POD' REPORT                     
         BE    SUMRPT78                                                         
         MVI   L.GBLEN,0           NO - DO IT NOW                               
         MVI   PSLSW,PSLSALL       DOING ALL LENGTH TOGETHER FOR POD            
         B     SUMRPT02                                                         
                                                                                
SUMRPT78 CLI   PSLSW,PSLSALL       TEST DOING ALL LENGTH FOR POD                
         BNE   SUMRPT80                                                         
         L     RE,AEQVMSG                                                       
         MVC   P1(L'EQVMSG),0(RE)                                               
         GOTOR REPORT,XA=OFF                                                    
                                                                                
SUMRPT80 MVI   RWILNSW,RWILTOG     RESET GETROW LENGTH SWITCH                   
         MVI   RCSUBPRG,0                                                       
                                                                                
SUMRPTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Report for one brand                                                *         
***********************************************************************         
                                                                                
BRDREP   NTR1  ,                                                                
         MVC   SRPNL1,SPACES                                                    
         MVC   SRPNL2,SPACES                                                    
         GOTOR REPORT,XA=OFF                                                    
         L     R3,THISPRD                                                       
         MVI   HCLASS,0                                                         
         CLC   TABPRD,TOTPRD                                                    
         BNE   BRDREP02                                                         
         MVC   SRPNL1(L'TOTALSL),TOTALSL                                        
         MVC   SRPNL2(12),DASHES                                                
         B     BRDREP14                                                         
                                                                                
BRDREP02 CLC   TABPRD,UNAPRD                                                    
         BNE   BRDREP04                                                         
         MVC   SRPNL1(16),=C'***  Unallocated'                                  
         OC    SUMASD,SUMASD                                                    
         BZ    BRDREPX             SKIP IF NO UNALLOCATED                       
         B     BRDREP08                                                         
                                                                                
BRDREP04 GOTOR LOCPRD,TABPRD                                                    
         LR    RF,R1                                                            
         USING PTBUFFD,RF                                                       
         MVC   HOLDPRD,TABPRD                                                   
         MVC   SRPNL1(L'PTPRDA),PTPRDA                                          
         LA    R7,SRPNL1+5                                                      
         CLI   PODRSW,YESQ         FOR POD RUN SHOW LENGTH                      
         BNE   BRDREP06                                                         
         LA    R7,SRPNL1+4                                                      
         MVI   0(R7),OPAREN                                                     
         SR    R0,R0                                                            
         IC    R0,TABLEN                                                        
         EDIT  (R0),(3,1(R7)),ALIGN=LEFT                                        
         AR    R7,R0                                                            
         MVI   1(R7),CPAREN                                                     
         AHI   R7,4                                                             
BRDREP06 MVC   0(L'PTNAME,R7),PTNAME                                            
         MVC   HCLASS,PTCLASS      AND CLASS                                    
         DROP  RF                                                               
                                                                                
BRDREP08 LA    R7,SRPNL1+34        UNDERLINE                                    
         CLI   0(R7),SPACE                                                      
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         LA    R0,SRPNL1                                                        
         SR    R7,R0                                                            
         EX    R7,*+8                                                           
         B     *+10                                                             
         MVC   SRPNL2(0),DASHES                                                 
         CLC   TABPRD,UNAPRD       NO SPECIALS FOR UNALLOCATED                  
         BE    BRDREP14                                                         
         CLI   PODRSW,YESQ         FOR POD RUNS BREAK AFTER LENGTH              
         BNE   BRDREP10                                                         
         MVI   SRPNL2+8,SPACE                                                   
         MVI   SRPNL2+9,SPACE                                                   
         B     BRDREP12                                                         
                                                                                
BRDREP10 LA    RF,SRPNL1+2         BREAK IN UNDERLINING                         
         CLI   0(RF),SPACE                                                      
         BNE   *+8                                                              
         MVI   L'SRPNL1+0(RF),SPACE                                             
         MVI   L'SRPNL1+1(RF),SPACE                                             
         MVI   L'SRPNL1+2(RF),SPACE                                             
                                                                                
BRDREP12 LA    R7,SRPNL1(R7)                                                    
         CLI   TABPRI,YESQ                                                      
         BNE   *+14                                                             
         MVC   3(3,R7),=C'(P)'                                                  
         AHI   R7,4                                                             
         CLI   HCLASS,SPACE                                                     
         BNH   BRDREP14                                                         
         MVC   3(L'CLASSEQL,R7),CLASSEQL                                        
         GOTOR SETCLS,HCLASS                                                    
         MVC   9(1,R7),CLASS1                                                   
         BH    BRDREP14                                                         
         MVI   10(R7),COMMA                                                     
         MVC   11(1,R7),CLASS2                                                  
                                                                                
BRDREP14 CLI   LINE,47                                                          
         BL    *+8                                                              
         MVI   FORCEHED,YESQ                                                    
         LA    R6,P1                                                            
         AH    R6,ROWDISP                                                       
         MVC   0(L'SRPNL1,R6),SRPNL1                                            
         MVC   L'P1(L'SRPNL2,R6),SRPNL2                                         
         MVI   NOMID,YESQ          SUPPRESS CONTINUED MESSAGE                   
         GOTOR REPORT,XA=OFF                                                    
         MVI   NOMID,NOQ                                                        
         LA    R7,SRPNL1+L'SRPNL1-1                                             
         CLI   0(R7),SPACE                                                      
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVC   3(11,R7),=C'(Continued)'                                         
                                                                                
***********************************************************************         
* Goals                                                               *         
***********************************************************************         
                                                                                
         GOTOR REPORT,XA=OFF                                                    
         LA    R2,P1                                                            
         AH    R2,ROWDISP          START OF ROW DESCS                           
         CLC   TABPRD,UNAPRD       NO GOALS FOR UNALLOCATED                     
         BE    BRDREP52                                                         
         MVC   0(6,R2),=C'Goals-'                                               
         MVC   L'P1(5,R2),DASHES                                                
         AHI   R2,L'P1*2                                                        
         MVC   2(6,R2),=C'-None-'  NO GOALS FOR THIS PRODUCT                    
         OC    SUMGLDD(L'SUMGLDD+L'SUMGLRD),SUMGLDD TEST ANY GOALS              
         BZ    BRDREP50                                                         
         MVC   2(6,R2),=C'Budget'                                               
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMGLDD          GOAL DOLLARS                                 
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP16 ICM   R1,15,0(R6)         SET IN DOLLARS                               
         BZ    BRDREP20                                                         
BRDREP18 EDIT  (R1),(8,0(R4)),FLOAT=$                                           
BRDREP20 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP16                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         CLC   TABPRD,TOTPRD       PERCENT OF TOTAL BUDGET                      
         BE    BRDREP30                                                         
         CLI   PCTOPT,NOQ                                                       
         BE    BRDREP30                                                         
         MVC   2(4,R2),=C' Pct'                                                 
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMGLDD                                                       
         L     R7,ATOTROW                                                       
         AHI   R7,SUMGLDD-TABD                                                  
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
BRDREP22 L     R1,0(R6)                                                         
         M     R0,FW1000           1 DECIMAL                                    
         L     RF,0(R7)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP22                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         CLI   GOALOPT,GOALDOLS                                                 
         BNE   BRDREP30                                                         
         TM    DIAGNOP1,FF-(DENVBEFQ+DNDXPRTQ)                                  
         BZ    BRDREP30                                                         
         MVC   2(9,R2),=C' Rescaled'                                            
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMRSGD                                                       
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP24 ICM   R1,15,0(R6)         GET IN DOLLARS                               
         BZ    BRDREP28                                                         
BRDREP26 EDIT  (R1),(8,0(R4)),FLOAT=$                                           
BRDREP28 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP24                                                      
         AHI   R2,L'P1             NEXT LINE                                    
BRDREP30 CLC   TABPRD,TOTPRD       FOR TOTALS                                   
         BNE   *+12                                                             
         TM    REQFLAG1,REQFMIXG   SKIP IF MIXED GOALS                          
         BNZ   BRDREP50                                                         
         GOTOR LOCPRD,TABPRD                                                    
         GOTOR DEMNAM,PTDEMNO-PTBUFFD(R1)                                       
         MVC   HDEMO,WORK                                                       
         MVC   2(L'DEMNNAME+L'DEMNNADP,R2),WORK+L'DEMNDEMN                      
         LR    R4,R2               SET GOAL DEMO LINE                           
         AH    R4,AMTDISP          START OF AMOUNTS                             
         LA    R6,SUMGLRD          GOAL DEMO DISPLACEMENT                       
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP32 CLI   HDEMO+1,RATINGQ                                                  
         BE    BRDREP34                                                         
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    BRDREP34                                                         
         EDIT  (B4,0(R6)),(8,0(R4)),ZERO=BLANK                                  
         B     BRDREP36                                                         
BRDREP34 EDIT  (B4,0(R6)),(8,0(R4)),1,ZERO=BLANK                                
BRDREP36 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP32                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         TM    REQFLAG1,REQFMIXG   SKIP PERCENTS FOR MIXED GOALS                
         BNZ   BRDREP50                                                         
         CLC   TABPRD,TOTPRD       AND FOR TOTAL                                
         BE    BRDREP40                                                         
         CLI   PCTOPT,NOQ                                                       
         BE    BRDREP40                                                         
         MVC   2(4,R2),=C' Pct'                                                 
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMGLRD          GOAL DEMO DISPLACEMENT                       
         L     R7,ATOTROW          TOTAL ROW                                    
         AHI   R7,SUMGLRD-TABD                                                  
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
BRDREP38 L     R1,0(R6)                                                         
         CLI   PSLSW,PSLSALL       IF DOING ALL LENGTHS FOR POD                 
         BNE   *+8                                                              
         GOTOR DEMEQV              MUST EQUIVALENCE DEMO FOR INDEXING           
         M     R0,FW1000           1 DECIMAL                                    
         L     RF,0(R7)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP38                                                      
         AHI   R2,L'P1             NEXT LINE                                    
BRDREP40 MVC   2(4,R2),=C' CPM'    CPP/M                                        
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+12                                                             
         CLI   HDEMO+1,EXDRTGQ                                                  
         BNE   *+8                                                              
         MVI   2+3(R2),C'P'                                                     
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP42 L     R1,SUMGLDD-TABD(R6) GOAL DOLLARS                                 
         L     RF,FW1000                                                        
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+8                                                              
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    *+8                                                              
         L     RF,FW100                                                         
         MR    R0,RF                                                            
         L     RF,SUMGLRD-TABD(R6) GOAL DEMO                                    
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),2,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP42                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         CLI   GOALOPT,GOALDEMS                                                 
         BNE   BRDREP50                                                         
         TM    DIAGNOP1,FF-(DENVBEFQ+DNDXPRTQ)                                  
         BZ    BRDREP50            DO RESCALE ONLY IF TRACE                     
         MVC   2(9,R2),=C' Rescaled'                                            
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMRSGD                                                       
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RE,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP44 CLI   HDEMO+1,RATINGQ                                                  
         BE    BRDREP46                                                         
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    BRDREP46                                                         
         EDIT  (B4,0(R6)),(8,0(R4)),ZERO=BLANK                                  
         B     BRDREP48                                                         
BRDREP46 EDIT  (B4,0(R6)),(8,0(R4)),1,ZERO=BLANK                                
BRDREP48 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP44                                                      
         AHI   R2,L'P1             NEXT LINE                                    
BRDREP50 MVI   SPACING,2           PRINT WHOLE GOAL SECTION                     
         GOTOR REPORT,XA=OFF                                                    
                                                                                
***********************************************************************         
* Achievement                                                         *         
***********************************************************************         
                                                                                
BRDREP52 LA    R2,P1                                                            
         AH    R2,ROWDISP                                                       
         MVC   0(12,R2),=C'Achievement-'                                        
         MVC   L'P1(11,R2),DASHES                                               
         AHI   R2,L'P1*2                                                        
         OC    SUMASD,SUMASD        TEST ANY ACHIEVED UNITS                     
         BNZ   BRDREP54                                                         
         MVC   2(28,R2),=C'-No allocation for brand XXX-'                       
         SR    RF,RF                                                            
         ICM   RF,PRDMSKQ,HOLDPRD                                               
         MVC   27(L'PTPRDA,R2),PTPRDA-PTBUFFD(RF)                               
         CLC   TABPRD,TOTPRD                                                    
         BNE   *+10                                                             
         MVC   2+15(30,R2),SPACES                                               
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         B     BRDREPX                                                          
BRDREP54 MVC   2(L'UNITSL,R2),UNITSL UNITS FOR NETWORK                          
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMASD           UNITS                                        
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
                                                                                
BRDREP56 CLI   PSLSW,PSLSALL       TEST DOING ALL LENGTHS FOR POD               
         BE    BRDREP58                                                         
         EDIT  (B4,0(R6)),(8,WORK1),1                                           
         MVC   2(6,R4),WORK1       DROP .0                                      
         B     BRDREP62                                                         
*                                  DOING ALL LENGTH FOR PODS                    
BRDREP58 L     R1,0(R6)            SECONDS                                      
         SR    R0,R0                                                            
         SR    RF,RF                                                            
         IC    RF,TABLEN           MUST CONVERT SECONDS TO UNITS                
         CLC   TABPRD,UNAPRD       IF TOTAL OR UNALLOCATED                      
         BL    *+12                                                             
         LH    RF,PODEQU           USE EQUIV BASE                               
         MHI   R1,10                                                            
         GOTOR DIVIDE                                                           
         CLC   TABPRD,UNAPRD       IF TOTAL OR UNALLOCATED                      
         BL    BRDREP60                                                         
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         B     BRDREP62                                                         
BRDREP60 EDIT  (R1),(8,0(R4))                                                   
BRDREP62 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP56                                                      
                                                                                
         AHI   R2,L'P1             NEXT LINE                                    
         CLC   TABPRD,TOTPRD       NO PRECENTS FOR TOTAL                        
         BE    BRDREP65                                                         
         CLI   PCTOPT,NOQ                                                       
         BE    BRDREP65                                                         
         MVC   2(4,R2),=C' Pct'    PERCENT OF TOTAL UNITS                       
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMASD                                                        
         L     R7,ATOTROW                                                       
         AHI   R7,SUMASD-TABD                                                   
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
BRDREP64 L     R1,0(R6)                                                         
         M     R0,FW1000           1 DECIMAL                                    
         L     RF,0(R7)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP64                                                      
         AHI   R2,L'P1             NEXT LINE                                    
                                                                                
BRDREP65 MVC   2(4,R2),=C'Cost'    ACHIEVED DOLLARS                             
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMADD                                                        
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP66 ICM   R1,15,0(R6)                                                      
         BZ    BRDREP70                                                         
BRDREP68 EDIT  (R1),(8,0(R4)),FLOAT=$                                           
BRDREP70 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP66                                                      
         AHI   R2,L'P1             NEXT LINE                                    
*                                  PERCENT OF DOLLARS                           
         CLC   TABPRD,TOTPRD       SKIP PERCENT FOR TOTAL                       
         BE    BRDREP82                                                         
         CLI   PCTOPT,NOQ                                                       
         BE    BRDREP74                                                         
         MVC   2(4,R2),=C' Pct'                                                 
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMADD           DOLLARS                                      
         L     R7,ATOTROW                                                       
         AHI   R7,SUMADD-TABD                                                   
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
BRDREP72 L     R1,0(R6)                                                         
         M     R0,FW1000           1 DECIMAL                                    
         L     RF,0(R7)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP72                                                      
                                                                                
         AHI   R2,L'P1                                                          
         CLC   TABPRD,TOTPRD       SKIP INDEX FOR TOTAL                         
         BNE   BRDREP74                                                         
         CLI   INDXOPT,INDXPCTQ    IF INDEX OF PERCENTS                         
         BE    BRDREP82                                                         
                                                                                
BRDREP74 MVC   2(6,R2),=C' Index'                                               
         LR    R4,R2                                                            
         MVC   CURDISP,=Y(SUMADD-TABD)                                          
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         L     R7,ATOTROW                                                       
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
BRDREP76 CLI   INDXOPT,INDXPCTQ    TEST INDEX OF PERCENTS                       
         BE    BRDREP78            YES                                          
         LH    R1,CURDISP          NO - USE RAW NUMBERS                         
         L     R1,0(R1,R6)         PRODUCT ACHIEVEMENT                          
         M     R0,FW100                                                         
         L     RF,SUMGLDD-TABD(R6) / PRODUCT GOAL                               
         B     BRDREP80                                                         
BRDREP78 LH    R1,CURDISP                                                       
         L     R1,0(R1,R6)         PRODUCT ACHIEVEMENT                          
         M     R0,FW1000                                                        
         L     RF,SUMGLDD-TABD(R6) / PRODUCT GOAL                               
         GOTOR DIVIDE                                                           
         BNH   *+14                                                             
         MVC   0(8,R4),HIGHVALS                                                 
         B     BRDREP81                                                         
         M     R0,SUMGLDD-TABD(R7) X TOTAL GOAL                                 
         LH    RF,CURDISP                                                       
         L     RF,0(RF,R7)         / TOTAL ACHIEVEMENT                          
         MHI   RF,10                                                            
BRDREP80 GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4))                                                   
BRDREP81 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP76                                                      
                                                                                
         AHI   R2,L'P1             NEXT LINE                                    
BRDREP82 MVI   SPACING,2           CPP/M                                        
         GOTOR REPORT,XA=OFF       PRINT UNITS AND DOLLARS                      
                                                                                
         GOTOR DEMNAM,DEMNMS       NOW DO DEMO ACHIEVEMENTS                     
         MVC   HDEMO,WORK                                                       
         MVC   CURDISP,=Y(SUMARD-TABD)                                          
         MVI   PRESW,NOQ           SET NOT DOING PRE-ALLOCS                     
         GOTOR FMTDEM,0                                                         
         SR    R5,R5                                                            
         ICM   R5,3,NTARGETS       NOW TARGETS                                  
         BZ    BRDREP86                                                         
         LA    R4,TARGETS                                                       
         LHI   R6,SUMAT1D-TABD     FIRST TARGET                                 
BRDREP84 GOTOR DEMNAM,0(R4)                                                     
         MVC   HDEMO,WORK                                                       
         STH   R6,CURDISP                                                       
         LR    R1,R4                                                            
         LA    R0,TARGETS-L'TARGETS                                             
         SR    R1,R0                                                            
         SRL   R1,2                                                             
         GOTOR FMTDEM                                                           
         AHI   R4,L'TARGETS                                                     
         AHI   R6,SUMAUDL                                                       
         BCT   R5,BRDREP84                                                      
*                                  PRE-ALLOCATED                                
BRDREP86 OC    SUMPSD,SUMPSD       TEST ANY PRE-ALLOCATED UNITS                 
         BZ    BRDREPX             NO - SKIP SECTION                            
         LA    R2,P1                                                            
         AH    R2,ROWDISP                                                       
         MVC   0(14,R2),=C'Pre-allocated-'                                      
         MVC   L'P1(13,R2),DASHES                                               
         AHI   R2,L'P1*2                                                        
         MVC   2(L'UNITSL,R2),UNITSL UNITS FOR NETWORK                          
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMPSD                                                        
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP88 CLI   PSLSW,PSLSALL       TEST DOING ALL LENGTHS FOR POD               
         BE    BRDREP90                                                         
         EDIT  (B4,0(R6)),(8,WORK1),1                                           
         MVC   2(6,R4),WORK1       DROP .0                                      
         B     BRDREP94                                                         
*                                  DOING ALL LENGTH FOR PODS                    
BRDREP90 L     R1,0(R6)            SECONDS                                      
         SR    R0,R0                                                            
         SR    RF,RF                                                            
         IC    RF,TABLEN           MUST CONVERT SECONDS TO UNITS                
         CLC   TABPRD,UNAPRD       IF TOTAL OR UNALLOCATED                      
         BL    *+12                                                             
         LH    RF,PODEQU           USE EQUIV BASE                               
         MHI   R1,10                                                            
         GOTOR DIVIDE                                                           
         CLC   TABPRD,UNAPRD       IF TOTAL OR UNALLOCATED                      
         BL    BRDREP92                                                         
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         B     BRDREP94                                                         
BRDREP92 EDIT  (R1),(8,0(R4))                                                   
BRDREP94 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP88                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         MVC   2(4,R2),=C'Cost'                                                 
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMPDD                                                        
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP96 L     R1,0(R6)                                                         
         LTR   R1,R1                                                            
         BZ    BRDREP97                                                         
         EDIT  (R1),(8,0(R4)),FLOAT=$                                           
BRDREP97 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP96                                                      
         GOTOR REPORT,XA=OFF                                                    
         GOTOR DEMNAM,DEMNMS                                                    
         MVC   HDEMO,WORK                                                       
         MVC   CURDISP,=Y(SUMPRD-TABD)                                          
         MVI   PRESW,YESQ          SET DOING PRE-ALLOCATIONS                    
         GOTOR FMTDEM,0                                                         
         SR    R5,R5                                                            
         ICM   R5,3,NTARGETS                                                    
         BZ    BRDREPX             NO TARGETS                                   
         LA    R4,TARGETS                                                       
         LHI   R6,SUMPT1D-TABD     PRE-ALLOCATED TARGET 1                       
BRDREP98 GOTOR DEMNAM,0(R4)                                                     
         MVC   HDEMO,WORK                                                       
         LR    R1,R4                                                            
         LA    R0,TARGETS-L'TARGETS                                             
         SR    R1,R0                                                            
         SRL   R1,2                                                             
         STH   R6,CURDISP                                                       
         GOTOR FMTDEM                                                           
         AHI   R4,L'TARGETS        NEXT TARGET                                  
         AHI   R6,SUMAUDL                                                       
         BCT   R5,BRDREP98                                                      
BRDREPX  J     EXIT                                                             
         EJECT                                                                  
FMTDEM   NTR1  ,                                                                
         LR    R0,R1                                                            
         LA    R2,P1                                                            
         AH    R2,ROWDISP                                                       
         MVC   2(L'DEMNNADP+L'DEMNNAME,R2),HDEMO+L'DEMNDEMN                     
*                                  SHOW IF A BRAND TARGET                       
         CLC   TABPRD,TOTPRD       NOT FOR TOTAL                                
         BE    FMTDEM06                                                         
         CLC   TABPRD,UNAPRD       OR UNALLOCATED                               
         BE    FMTDEM06                                                         
         LTR   R0,R0               OR CORPORATE                                 
         BZ    FMTDEM06                                                         
         GOTOR LOCPRD,TABPRD                                                    
         LA    RF,PTTRGS-PTBUFFD(R1)                                            
         LA    RE,NTGVARS          FOR BCT THRU BRAND TARGETS                   
FMTDEM02 CLM   R1,1,0(RF)                                                       
         BE    FMTDEM04                                                         
         AHI   RF,1                                                             
         BCT   RE,FMTDEM02                                                      
         B     FMTDEM06                                                         
FMTDEM04 LA    R4,9(R2)            SLOT FOR TARGET TAG FOR NORMAL DEMO          
         CLI   HDEMO,0             IF A NAD DEMO                                
         BNH   *+8                                                              
         LA    R4,13(R2)           MOVE TO RIGHT                                
         SHI   RE,NTGVARS+1                                                     
         LPR   RE,RE                                                            
         STC   RE,2(R4)                                                         
         OI    2(R4),ZONE                                                       
         MVI   0(R4),OPAREN                                                     
         MVI   1(R4),C'T'                                                       
         MVI   3(R4),CPAREN                                                     
FMTDEM06 LA    R6,TABD                                                          
         AH    R6,CURDISP                                                       
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
FMTDEM08 CLI   HDEMO+1,RATINGQ                                                  
         BE    FMTDEM10                                                         
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    FMTDEM10                                                         
         EDIT  (B4,0(R6)),(8,0(R4)),ZERO=BLANK                                  
         B     FMTDEM12                                                         
FMTDEM10 EDIT  (B4,0(R6)),(8,0(R4)),1,ZERO=BLANK                                
FMTDEM12 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,FMTDEM08                                                      
         CLI   PRESW,YESQ          DONE IF DOING PRE-ALLOCATED                  
         BE    FMTDEM38                                                         
         AHI   R2,L'P1             NEXT LINE                                    
*                                  PERCENT ACHIEVED                             
         CLC   TABPRD,TOTPRD       NO PERCENTS FOR TOTAL                        
         BE    FMTDEM16                                                         
         CLI   PCTOPT,NOQ                                                       
         BE    FMTDEM16                                                         
         MVC   2(4,R2),=C' Pct'                                                 
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         AH    R6,CURDISP                                                       
         L     R7,ATOTROW                                                       
         AH    R7,CURDISP                                                       
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
FMTDEM14 L     R1,0(R6)                                                         
         CLI   PSLSW,PSLSALL       IF DOING ALL LENGTHS FOR POD                 
         BNE   *+8                                                              
         GOTOR DEMEQV              MUST EQUIV DEMO FOR INDEXING                 
         M     R0,FW1000           1 DECIMAL                                    
         L     RF,0(R7)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,FMTDEM14                                                      
                                                                                
         AHI   R2,L'P1             NEXT LINE                                    
FMTDEM16 GOTOR LOCPRD,TABPRD       INDEX                                        
         A     R1,DEMOVDD                                                       
         CLC   HDEMO(L'DEMNDEMN),0(R1)                                          
         BNE   FMTDEM26                                                         
         CLC   TABPRD,TOTPRD       SKIP INDEX FOR TOTAL                         
         BNE   FMTDEM18                                                         
         CLI   INDXOPT,INDXPCTQ    IF INDEX OF PERCENTS                         
         BE    FMTDEM26                                                         
FMTDEM18 MVC   2(6,R2),=C' Index'                                               
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         L     R7,ATOTROW                                                       
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
FMTDEM20 CLI   INDXOPT,INDXPCTQ    TEST INDEX OF PERCENTS                       
         BE    FMTDEM22            YES                                          
         LH    R1,CURDISP          NO - USE RAW NUMBERS                         
         L     R1,0(R1,R6)         PRODUCT ACHIEVEMENT                          
         M     R0,FW100                                                         
         L     RF,SUMGLRD-TABD(R6) / PRODUCT GOAL                               
         B     FMTDEM24                                                         
FMTDEM22 TM    REQFLAG1,REQFMIXG   NO PERCENT INDEX IF MIXED GOALS              
         BZ    *+14                                                             
         MVC   2(6,R2),SPACES                                                   
         B     FMTDEM26                                                         
         LH    R1,CURDISP                                                       
         L     R1,0(R1,R6)         PRODUCT ACHIEVEMENT                          
         CLI   PSLSW,PSLSALL       IF DOING ALL LENGTHS FOR POD                 
         BNE   *+8                                                              
         GOTOR DEMEQV              MUST EQUIV DEMO FOR INDEXING                 
         ST    R1,FULL             SAVE PRODUCT ACHIEVEMENT                     
         L     R1,SUMGLRD-TABD(R6) / PRODUCT GOAL                               
         CLI   PSLSW,PSLSALL       IF DOING ALL LENGTHS FOR POD                 
         BNE   *+8                                                              
         GOTOR DEMEQV              MUST EQUIV DEMO FOR INDEXING                 
         LR    RF,R1               DIVISOR                                      
         L     R1,FULL             RESTORE PRODUCT ACHIEVEMENT                  
         M     R0,FW1000                                                        
         GOTOR DIVIDE                                                           
         M     R0,SUMGLRD-TABD(R7) X TOTAL GOAL                                 
         LH    RF,CURDISP                                                       
         L     RF,0(RF,R7)         / TOTAL ACHIEVEMENT                          
         MHI   RF,10                                                            
FMTDEM24 GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4))                                                   
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,FMTDEM20                                                      
                                                                                
         AHI   R2,L'P1             NEXT LINE                                    
FMTDEM26 MVC   2(4,R2),=C' CPM'    CPP/M                                        
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+12                                                             
         CLI   HDEMO+1,EXDRTGQ                                                  
         BNE   *+8                                                              
         MVI   2+3(R2),C'P'                                                     
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
FMTDEM28 L     R1,SUMADD-TABD(R6)  ACHIEVED DOLLARS                             
         L     RF,FW1000                                                        
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+8                                                              
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    *+8                                                              
         L     RF,FW100                                                         
         MR    R0,RF                                                            
         LH    RF,CURDISP                                                       
         L     RF,0(R6,RF)         ACHIEVED DEMO                                
         GOTOR DIVIDE                                                           
         BNH   *+14                                                             
         MVC   0(8,R4),HIGHVALS                                                 
         B     FMTDEM30                                                         
         EDIT  (R1),(8,0(R4)),2,ZERO=BLANK                                      
FMTDEM30 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,FMTDEM28                                                      
         AHI   R2,L'P1             NEXT LINE                                    
*                                  CPM INDEX                                    
         CLC   TABPRD,TOTPRD       SKIP CPM INDEX FOR TOTALS                    
         BE    FMTDEM36                                                         
         MVC   2(10,R2),=C' CPM index'                                          
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+12                                                             
         CLI   HDEMO+1,EXDRTGQ                                                  
         BNE   *+8                                                              
         MVI   2+3(R2),C'P'                                                     
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         L     R7,ATOTROW                                                       
         LH    R5,RPTNOWKS                                                      
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
FMTDEM32 L     R1,SUMADD-TABD(R6)  PRODUCT DOLLARS                              
         M     R0,FW1000                                                        
         LH    RF,CURDISP                                                       
         L     RF,0(R6,RF)         PRODUCT DEMO                                 
         GOTOR DIVIDE                                                           
         BNH   *+14                                                             
         MVC   0(8,R4),HIGHVALS                                                 
         B     FMTDEM34                                                         
         LH    RF,CURDISP                                                       
         M     R0,0(R7,RF)         X TOTAL DEMO                                 
         L     RF,SUMADD-TABD(R7)  / TOTAL DOLLARS                              
         MHI   RF,10                                                            
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4))                                                   
FMTDEM34 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,FMTDEM32                                                      
FMTDEM36 MVI   SPACING,2                                                        
FMTDEM38 GOTOR REPORT,XA=OFF                                                    
FMTDEMX  J     EXIT                                                             
                                                                                
***********************************************************************         
* Unequivalence ach units and dems (value is in R1)                   *         
***********************************************************************         
                                                                                
DEMUNQ   SR    RF,RF                                                            
         IC    RF,TABLEN           SECONDS LENGTH                               
         CH    RF,PODEQU           SKIP IF = BASE                               
         BER   RE                                                               
         LH    R0,PODEQU                                                        
         MR    R0,R0               VALUE X BASE                                 
         J     DIVIDE              / THIS LENGTH                                
                                                                                
***********************************************************************         
* Equivalence demos (value is in R1)                                  *         
***********************************************************************         
                                                                                
DEMEQV   SR    RF,RF                                                            
         IC    RF,TABLEN           SECONDS LENGTH                               
         CH    RF,PODEQU           SKIP IF = TO BASE                            
         BER   RE                                                               
         MR    R0,RF               VALUE X LENGTH                               
         LH    RF,PODEQU           / BASE                                       
         J     DIVIDE                                                           
         DROP  R3,R8,RB,TOT                                                     
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Recap report                                                        *         
***********************************************************************         
                                                                                
RECRPT   NMOD1 0,**RECRPT                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         MVI   FORCEHED,YESQ                                                    
         MVI   RCSUBPRG,2                                                       
         XC    WEEKDISP,WEEKDISP   SET TO DO TOTAL 'WEEK'                       
                                                                                
         L     R4,APXCREC          USE SORTED BRAND TABLE                       
RECRPT02 CLI   0(R4),FF            TEST END                                     
         BE    RECRPT04                                                         
         MVC   THISPRD,L'TABPRD(R4)                                             
         GOTOR RCRFMT                                                           
         AHI   R4,L'TABPRD+4                                                    
         B     RECRPT02                                                         
                                                                                
RECRPT04 MVC   THISPRD,ATOTROW     DO TOTALS                                    
         GOTOR RCRFMT                                                           
                                                                                
RECRPTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Format data for 1 brand/week                                        *         
***********************************************************************         
                                                                                
RCRFMT   NTR1  ,                                                                
         L     R3,THISPRD                                                       
         USING TABD,R3                                                          
         LA    R2,P1                                                            
         USING RRLIND,R2                                                        
         CLC   TABPRD,TOTPRD                                                    
         BNE   *+14                                                             
         MVC   RRBRD(L'TOTALSL),TOTALSL                                         
         B     RCRFMT10                                                         
         CLC   TABPRD,UNAPRD                                                    
         BNE   RCRFMT02                                                         
         LH    R8,WEEKDISP                                                      
         LA    RF,TABD(R8)                                                      
         OC    SUMASD-TABD(,RF),SUMASD-TABD(RF)                                 
         BZ    RCRFMTX                                                          
         MVC   RRBRD(16),=C'*** Unallocated*'                                   
         B     RCRFMT10                                                         
                                                                                
RCRFMT02 GOTOR LOCPRD,TABPRD                                                    
         LR    R4,R1                                                            
         USING PTBUFFD,R4                                                       
         MVC   RRBRD,PTPRDA                                                     
         MVC   RRBRDN(L'PTNAME),PTNAME                                          
         LA    R5,RRBRDN+L'P1                                                   
         CLI   PODRSW,YESQ                                                      
         BNE   RCRFMT04                                                         
         MVI   0(R5),OPAREN                                                     
         SR    R0,R0                                                            
         IC    R0,TABLEN                                                        
         EDIT  (R0),(3,1(R5)),ALIGN=LEFT                                        
         AR    R5,R0                                                            
         MVI   1(R5),CPAREN                                                     
         LA    R5,RRBRDN+L'P1+7                                                 
RCRFMT04 CLI   TABPRI,YESQ                                                      
         BNE   RCRFMT06                                                         
         MVC   0(3,R5),=C'(P)'                                                  
         AHI   R5,4                                                             
RCRFMT06 CLI   TABCLASS,0                                                       
         BNH   RCRFMT08                                                         
         MVC   0(L'CLASSEQL,R5),CLASSEQL                                        
         GOTOR SETCLS,TABCLASS                                                  
         MVC   6(1,R5),CLASS1                                                   
         BH    RCRFMT08                                                         
         MVI   7(R5),COMMA                                                      
         MVC   8(1,R5),CLASS2                                                   
RCRFMT08 ST    R4,ZPRD             SAVE A(PRODUCT ENTRY)                        
RCRFMT10 LH    R8,WEEKDISP         R8 = PERMANENT WEEK DISPLACEMENT             
*                                  UNITS                                        
         MVC   RRDESC(L'UNITSL),UNITSL                                          
         L     R1,SUMASD(R8)                                                    
         CLI   PSLSW,PSLSALL       TEST DOING ALL LENGTHS FOR POD               
         BE    RCRFMT12                                                         
         EDIT  (R1),(8,WORK1),1                                                 
         MVC   RRACH+2(6),WORK1    DROP .0                                      
         B     RCRFMT16                                                         
                                                                                
RCRFMT12 SR    R0,R0               DOING ALL LENGTHS FOR PODS                   
         SR    RF,RF                                                            
         IC    RF,TABLEN           MUST CONVERT SECONDS TO UNITS                
         CLC   TABPRD,UNAPRD       IF TOTAL OR UNALLOCATED                      
         BL    *+12                                                             
         LH    RF,PODEQU           USE EQUIV BASE                               
         MHI   R1,10                                                            
         GOTOR DIVIDE                                                           
         CLC   TABPRD,UNAPRD       IF TOTAL OR UNALLOCATED                      
         BL    RCRFMT14                                                         
         EDIT  (R1),(8,RRACH),1    NEED DECIMAL POINT                           
         B     RCRFMT16                                                         
RCRFMT14 EDIT  (R1),(8,RRACH)                                                   
RCRFMT16 L     R4,ATOTROW                                                       
         L     RF,SUMASD-TABD(R4,R8)                                            
         L     R1,SUMASD(R8)                                                    
         M     R0,FW100                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,RRAPCT)                                                  
         AHI   R2,L'P1             NEXT LINE                                    
*                                  COSTS                                        
         MVC   RRDESC(4),=C'Cost'                                               
         L     R1,SUMGLDD(R8)      GOAL DOLLARS                                 
         LTR   R1,R1                                                            
         BZ    RCRFMT20                                                         
RCRFMT18 EDIT  (R1),(8,RRGOAL),FLOAT=$,ZERO=NOBLANK                             
RCRFMT20 L     R4,ATOTROW                                                       
         L     RF,SUMGLDD-TABD(R4,R8)                                           
         L     R1,SUMGLDD(R8)                                                   
         M     R0,FW100                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,RRGPCT)     GOAL DOLLARS PERCENT                         
         L     R1,SUMADD(R8)       ACHIEVED DOLLARS                             
         LTR   R1,R1                                                            
         BZ    RCRFMT24                                                         
RCRFMT22 EDIT  (R1),(8,RRACH),FLOAT=$,ZERO=NOBLANK                              
RCRFMT24 L     RF,SUMADD-TABD(R4,R8)                                            
         L     R1,SUMADD(R8)                                                    
         M     R0,FW100                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,RRAPCT)     ACHIEVED DOLLARS PERCENT                     
         CLI   INDXOPT,INDXPCTQ    TEST INDEX OF PERCENTS                       
         BE    RCRFMT26                                                         
*                                  INDEX OF RAW NUMBERS                         
         L     R1,SUMADD(R8)       ACHIEVED DOLLARS                             
         M     R0,FW100                                                         
         L     RF,SUMGLDD(R8)      / GOAL DOLLARS                               
         B     RCRFMT28                                                         
*                                  PERCENT INDEX                                
RCRFMT26 L     R1,SUMADD(R8)       PRODUCT ACHIEVED                             
         M     R0,FW1000                                                        
         L     RF,SUMGLDD(R8)      / PRODUCT GOAL DOLLARS                       
         GOTOR DIVIDE                                                           
         M     R0,SUMGLDD-TABD(R4,R8) X TOTAL GOAL                              
         L     RF,SUMADD-TABD(R4,R8)  / TOTAL ACHIEVEMENT                       
         MHI   RF,10                                                            
RCRFMT28 GOTOR DIVIDE                                                           
         EDIT  (R1),(4,RRINDX)                                                  
         AHI   R2,L'P1             NEXT LINE                                    
*                                  DEMOS                                        
         MVC   HDEMO,DEMNMS        FIRST DO CORPORATE DEMO                      
         MVC   CURDISP,=Y(SUMARD-TABD)                                          
         GOTOR RCFDEM                                                           
*                                  NOW DO GOALED DEMO                           
         CLC   TABPRD,UNAPRD       NOT FOR UNALLOCATED                          
         BE    RCRFMT40                                                         
         CLC   TABPRD,TOTPRD       SPECIAL FOR TOTAL                            
         BE    RCRFMT36                                                         
         L     R4,ZPRD                                                          
         LA    RF,PTBUFFD                                                       
         A     RF,DEMOVDD          RF=A(DEMO LIST)                              
         MVC   HDEMO(L'DEMNDEMN),0(RF)                                          
         CLC   HDEMO(L'DEMNDEMN),DEMNMS                                         
         BE    RCRFMT30            SKIP IF EQUAL CORPORATE                      
         LA    RF,TARGETS          FIND IN TARGET LIST                          
         CLC   HDEMO(L'DEMNDEMN),0(RF)                                          
         BE    *+12                                                             
         AHI   RF,L'TARGETS                                                     
         B     *-14                                                             
         LA    R0,TARGETS                                                       
         SR    RF,R0                                                            
         SLL   RF,1                8 BYTES PER TARGET                           
         AHI   RF,SUMAT1D-TABD                                                  
         STH   RF,CURDISP          SET DISPLACEMENT                             
         LA    R2,P1                                                            
         GOTOR RCFDEM                                                           
RCRFMT30 TM    REQFLAG1,REQFTRGS   TARGETS 1-N                                  
         BZ    RCRFMT40                                                         
         LA    R4,PTTRGS                                                        
         LA    R7,NTGVARS                                                       
RCRFMT32 CLI   0(R4),0                                                          
         BE    RCRFMT34                                                         
         SR    R6,R6                                                            
         IC    R6,0(R4)            GET FROM TARGET LIST                         
         BCTR  R6,0                                                             
         SLL   R6,2                                                             
         LA    RF,TARGETS(R6)                                                   
         MVC   HDEMO(L'DEMNDEMN),0(RF)                                          
         CLC   HDEMO(L'DEMNDEMN),DEMNMS                                         
         BE    RCRFMT34                                                         
         L     RF,ZPRD                                                          
         A     RF,DEMOVDD                                                       
         CLC   HDEMO(L'DEMNDEMN),0(RF)                                          
         BE    RCRFMT34                                                         
         SLL   R6,1                8 BYTES PER TARGET                           
         AHI   R6,SUMAT1D-TABD                                                  
         STH   R6,CURDISP                                                       
         LA    R2,P1                                                            
         GOTOR RCFDEM                                                           
RCRFMT34 AHI   R4,1                                                             
         BCT   R7,RCRFMT32                                                      
         B     RCRFMT40                                                         
                                                                                
RCRFMT36 SR    R7,R7                                                            
         ICM   R7,3,NTARGETS       FOR TOTAL DO ALL TARGETS                     
         BZ    RCRFMT40                                                         
         LA    R6,TARGETS                                                       
         LHI   RF,SUMAT1D-TABD                                                  
RCRFMT38 MVC   HDEMO(L'DEMNDEMN),0(R6)                                          
         STH   RF,CURDISP                                                       
         LA    R2,P1                                                            
         GOTOR RCFDEM                                                           
         AHI   R6,L'TARGETS        NEXT TARGET                                  
         AHI   RF,SUMAUDL                                                       
         BCT   R7,RCRFMT38                                                      
RCRFMT40 GOTOR REPORT,XA=OFF                                                    
RCRFMTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Recap report - demo line                                            *         
***********************************************************************         
                                                                                
RCFDEM   NTR1  ,                                                                
         GOTOR DEMNAM,HDEMO                                                     
         MVC   RRDESC(L'DEMNNADP+L'DEMNNAME),WORK+L'DEMNDEMN                    
*                                  SET DEMO RELATION TO PRODUCT                 
         CLC   TABPRD,UNAPRD       NOT FOR UNALL OR TOTAL                       
         BNL   RCFDEM16                                                         
         MVC   WORK(10),SPACES                                                  
         MVI   WORK,OPAREN                                                      
         LA    R5,WORK+1                                                        
         CLC   HDEMO(L'DEMNDEMN),DEMNMS                                         
         BNE   RCFDEM02                                                         
         MVC   0(2,R5),=C'C,'      CORPORATE                                    
         AHI   R5,2                                                             
*                                                                               
RCFDEM02 TM    REQFLAG1,REQFMIXG                                                
         BZ    RCFDEM04                                                         
         L     RF,ZPRD                                                          
         A     RF,DEMOVDD                                                       
         CLC   HDEMO(L'DEMNDEMN),0(RF)                                          
         BNE   RCFDEM04                                                         
         MVC   0(2,R5),=C'G,'      GOALED DEMO                                  
         AHI   R5,2                                                             
RCFDEM04 LHI   R7,PTZDEMMX                                                      
         LA    R6,TARGETS                                                       
RCFDEM06 CLC   HDEMO(L'DEMNDEMN),0(R6)                                          
         BE    RCFDEM08                                                         
         AHI   R6,L'TARGETS                                                     
         BCT   R7,RCFDEM06                                                      
         B     RCFDEM14                                                         
*                                                                               
RCFDEM08 LA    R0,TARGETS-L'TARGETS                                             
         SR    R6,R0                                                            
         SRL   R6,2                SEE IF A TARGET FOR THIS PRODUCT             
         STC   R6,BYTE                                                          
         LHI   R7,NTGVARS                                                       
         L     R4,ZPRD                                                          
         LA    R6,PTTRGS                                                        
RCFDEM10 CLC   BYTE,0(R6)                                                       
         BE    RCFDEM12                                                         
         AHI   R6,1                                                             
         BCT   R7,RCFDEM10                                                      
         B     RCFDEM14                                                         
RCFDEM12 LA    R0,PTTRGS-1                                                      
         SR    R6,R0                                                            
         MVI   0(R5),C'T'                                                       
         STC   R6,1(R5)            TARGET NUMBER FOR PRODUCT                    
         OI    1(R5),ZONE                                                       
         MVI   2(R5),COMMA                                                      
         AHI   R5,3                                                             
RCFDEM14 BCTR  R5,0                                                             
         MVI   0(R5),CPAREN                                                     
         CLC   WORK(3),=C'(C)'     IF CORPORATE ONLY - DON'T PRINT              
         BE    RCFDEM16                                                         
         CLI   WORK,CPAREN                                                      
         BE    RCFDEM16                                                         
         MVC   RRDESC+12(10),WORK                                               
RCFDEM16 MVI   GOLDEMSW,NOQ        NOT GOALED DEMO                              
         CLC   TABPRD,UNAPRD       UNALLOCATED                                  
         BE    RCFDEM26                                                         
         CLC   TABPRD,TOTPRD       TOTAL                                        
         BNE   RCFDEM18                                                         
         CLC   HDEMO(L'DEMNDEMN),CORPDEM                                        
         BNE   RCFDEM26                                                         
         TM    REQFLAG1,REQFMIXG                                                
         BNZ   RCFDEM26                                                         
         B     RCFDEM20                                                         
RCFDEM18 L     RF,ZPRD                                                          
         A     RF,DEMOVDD                                                       
         CLC   HDEMO(L'DEMNDEMN),0(RF)                                          
         BNE   RCFDEM26                                                         
RCFDEM20 MVI   GOLDEMSW,YESQ       SET IS GOALED DEMO                           
         L     R1,SUMGLRD(R8)      GOAL                                         
         CLI   HDEMO+1,RATINGQ                                                  
         BE    RCFDEM22                                                         
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    RCFDEM22                                                         
         EDIT  (R1),(8,RRGOAL),ZERO=NOBLANK                                     
         B     RCFDEM24                                                         
RCFDEM22 EDIT  (R1),(8,RRGOAL),1,ZERO=NOBLANK                                   
RCFDEM24 TM    REQFLAG1,REQFMIXG   SKIP PERCENT IF MIXED GOALS                  
         BNZ   RCFDEM26                                                         
         MVC   RRGPCT,C100L        100 PERCENT FOR TOTALS                       
         CLC   TABPRD,TOTPRD                                                    
         BE    RCFDEM26                                                         
         L     R4,ATOTROW                                                       
         L     R1,SUMGLRD(R8)                                                   
         CLI   PSLSW,PSLSALL       IF DOING ALL LENGTHS FOR POD                 
         BNE   *+8                                                              
         GOTOR DEMEQV              MUST EQUIVALENCE DEMO FOR INDEXING           
         M     R0,FW100                                                         
         L     RF,SUMGLRD-TABD(R4,R8)                                           
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,RRGPCT)                                                  
RCFDEM26 LA    RF,0(R3,R8)         ACHIEVED DEMO                                
         AH    RF,CURDISP                                                       
         L     R1,0(RF)                                                         
         CLI   HDEMO+1,RATINGQ                                                  
         BE    RCFDEM28                                                         
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    RCFDEM28                                                         
         EDIT  (R1),(8,RRACH),ZERO=NOBLANK                                      
         B     RCFDEM30                                                         
RCFDEM28 EDIT  (R1),(8,RRACH),1,ZERO=NOBLANK                                    
*                                  ACHIEVED PERCENT                             
RCFDEM30 MVC   RRAPCT,C100L        100 PERCENT FOR TOTALS                       
         CLC   TABPRD,TOTPRD                                                    
         BE    RCFDEM32                                                         
         L     R4,ATOTROW                                                       
         LA    RE,0(R3,R8)                                                      
         AH    RE,CURDISP                                                       
         L     R1,0(RE)            THIS PRODUCT                                 
         CLI   PSLSW,PSLSALL       IF DOING ALL LENGTHS FOR POD                 
         BNE   *+8                                                              
         GOTOR DEMEQV              MUST EQUIVALENCE DEMO FOR INDEXING           
         M     R0,FW100                                                         
         LA    RE,0(R4,R8)                                                      
         AH    RE,CURDISP                                                       
         L     RF,0(RE)            TOTAL FOR DEMO                               
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,RRAPCT)                                                  
RCFDEM32 CLI   GOLDEMSW,YESQ       NO INDEX IF NOT GOALED DEMO                  
         BNE   RCFDEM40                                                         
         CLI   INDXOPT,INDXPCTQ    TEST PERCENT INDX                            
         BE    RCFDEM36                                                         
RCFDEM34 LA    RF,0(R3,R8)         RAW NUMBER INDEX                             
         AH    RF,CURDISP                                                       
         L     R1,0(RF)                                                         
         M     R0,FW100                                                         
         L     RF,SUMGLRD(R8)                                                   
         B     RCFDEM38                                                         
*                                  PERCENT INDX                                 
RCFDEM36 TM    REQFLAG1,REQFMIXG   SKIP IF MIXED GOALS                          
         BNZ   RCFDEM40                                                         
         MVC   RRINDX+1(L'C100L),C100L                                          
         CLC   TABPRD,TOTPRD                                                    
         BE    RCFDEM40                                                         
         LA    RF,0(R3,R8)                                                      
         AH    RF,CURDISP                                                       
         L     R1,0(RF)            PRODUCT ACHIEVEMENT                          
         CLI   PSLSW,PSLSALL       IF DOING ALL LENGTHS FOR POD                 
         BNE   *+8                                                              
         GOTOR DEMEQV              MUST EQUIVALENCE DEMO FOR INDEXING           
         LR    R6,R1               SAVE PRODUCT ACHIEVEMENT                     
         L     R1,SUMGLRD(R8)      / PRODUCT GOAL                               
         CLI   PSLSW,PSLSALL       IF DOING ALL LENGTHS FOR POD                 
         BNE   *+8                                                              
         GOTOR DEMEQV              MUST EQUIV DEMO FOR INDEXING                 
         LR    RF,R1               DIVISOR                                      
         LR    R1,R6               RESTORE PRODUCT ACHIEVEMENT                  
         M     R0,FW1000                                                        
         GOTOR DIVIDE                                                           
         L     R4,ATOTROW                                                       
         M     R0,SUMGLRD-TABD(R4,R8) X TOTAL GOAL                              
         LA    RF,0(R4,R8)                                                      
         AH    RF,CURDISP                                                       
         L     RF,0(RF)            / TOTAL ACHIEVEMENT                          
         MHI   RF,10                                                            
RCFDEM38 GOTOR DIVIDE                                                           
         EDIT  (R1),(4,RRINDX)                                                  
*                                  CPP/M                                        
RCFDEM40 AHI   R2,L'P1             NEXT LINE                                    
         LA    RF,RRDESC+1                                                      
         MVC   0(3,RF),=C'CPP'                                                  
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+8                                                              
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    *+10                                                             
         MVC   0(3,RF),=C'CPM'                                                  
         CLI   GOLDEMSW,YESQ       GOAL CPM ONLY IF GOALED DEMO                 
         BNE   RCFDEM42                                                         
         L     R1,SUMGLDD(R8)      GOAL DOLLARS                                 
         L     RF,FW1000                                                        
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+8                                                              
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    *+8                                                              
         L     RF,FW100                                                         
         MR    R0,RF                                                            
         L     RF,SUMGLRD(R8)      GOAL DEMO                                    
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,RRGOAL),2                                                
RCFDEM42 L     R1,SUMADD(R8)       ACHIEVED DOLLARS                             
         L     RF,FW1000                                                        
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+8                                                              
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    *+8                                                              
         L     RF,FW100                                                         
         MR    R0,RF                                                            
         LA    RF,0(R3,R8)                                                      
         AH    RF,CURDISP                                                       
         L     RF,0(RF)            ACHIEVED DEMO                                
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,RRACH),2                                                 
         GOTOR REPORT,XA=OFF                                                    
RCFDEMX  J     EXIT                                                             
         DROP  R2,R3,R4,RB                                                      
                                                                                
ZPRD     DS    A                                                                
GOLDEMSW DS    C                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Program/product recap                                               *         
***********************************************************************         
                                                                                
PGMRCP   OC    NPRDS,NPRDS                                                      
         BZR   RE                                                               
                                                                                
PGMRCPN  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         L     RF,ABUFF3           USE BUFFER 3 FOR THIS REPORT                 
         USING BUFFD,RF            INITIALIZE BUFFER                            
         LHI   R0,PPRKEYL                                                       
         STCM  R0,3,BUFFLKEY       SET KEY LENGTH                               
         LH    R0,NPRDS            ENTRY LENGTH = PRODUCT COUNT                 
         AHI   R0,1                PLUS UNALLOCATED                             
         MHI   R0,L'PPRPRD         X 2 BYTE PER COUNTER                         
         AHI   R0,L'PPRTOT         PLUS TOTAL                                   
         STCM  R0,3,BUFFLCOM       SET DATA LENGTH                              
         DROP  RF                                                               
                                                                                
         GOTOR BUFFERIN,DMCB,('BUFFAINI',ABUFF3),0,ACOMFACS,XA=N                
                                                                                
         L     R6,ADBUY            USE BUY RECORD AS WORK AREA                  
         USING PPRD,R6             R6=A(PROGRAM/PRODUCT BUFFER RECORD)          
                                                                                
W        USING UBUFFRD,WORK2                                                    
         LA    R0,W.UBUFFK                                                      
         LHI   R1,UBUFFL                                                        
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   W.UBDPT(L'UBDPT+L'UBLEN),L.GBDPT                                 
         CLI   PODRSW,YESQ         IF PODS                                      
         BNE   *+8                                                              
         MVI   W.UBLEN,0           GET ALL FOR DAYPART                          
         GOTOR BU2RDH,W.UBUFFRD                                                 
         B     PGMRCP04                                                         
PGMRCP02 GOTOR BU2RSQ,W.UBUFFRD                                                 
PGMRCP04 BNZ   PGMRCP24                                                         
                                                                                
         CLC   W.UBDPT,L.GBDPT                                                  
         BNE   PGMRCP24                                                         
         CLC   W.UBLEN,L.GBLEN                                                  
         BE    *+12                                                             
         CLI   PODRSW,YESQ         IF PODS, OK                                  
         BNE   PGMRCP24                                                         
                                                                                
         LA    R0,PPRD                                                          
         L     RF,ABUFF3                                                        
         SR    R1,R1                                                            
         ICM   R1,3,BUFFLREC-BUFFD(RF)                                          
         GOTOR CLEAR               PRE-CLEAR THE BUFFER RECORD                  
                                                                                
         LH    RF,W.UBENV1                                                      
         BCTR  RF,0                                                             
         MHI   RF,ENVS1LEN                                                      
         L     RE,AENV1SET                                                      
         A     RF,ENVSATAB-ENVSETD(RE)                                          
         USING ENVTABD,RF                                                       
         MVC   PPRNET,ENVS1NET     NETWORK                                      
         MVC   PPRTYP,ENVS1TYP     PROGRAM TYPE                                 
         MVC   PPRPGM,ENVS1PGM     PROGRAM NAME                                 
         MVC   PPRPGMC,ENVS1PGC    PROGRAM CODE                                 
         DROP  RF                                                               
                                                                                
         SR    RF,RF               BUMP TOTAL UNITS/SECONDS                     
         IC    RF,W.UBPDLEN        SECONDS                                      
         CLI   PODRSW,YESQ         IF POD RUN                                   
         BE    *+8                                                              
         LHI   RF,1                ELSE UNITS                                   
         ICM   R0,15,PPRTOT                                                     
         AR    R0,RF                                                            
         STCM  R0,15,PPRTOT                                                     
                                                                                
         CLI   W.UBUNLEN,0         BUMP UNALLOCATED UNITS/SECONDS               
         BE    PGMRCP06                                                         
         SR    RF,RF                                                            
         IC    RF,W.UBUNLEN        SECONDS                                      
         CLI   PODRSW,YESQ         IF POD RUN                                   
         BE    *+8                                                              
         LHI   RF,1                ELSE UNITS                                   
         LH    RE,NPRDS            POINT TO UNALLOCATED POSITION                
         SLL   RE,1                                                             
         LA    RE,PPRPRD(RE)                                                    
         AH    RF,0(RE)                                                         
         STH   RF,0(RE)                                                         
                                                                                
PGMRCP06 LA    R4,W.UBPRD1         SLOT 1                                       
         LHI   R3,UBPODMAX                                                      
                                                                                
PGMRCP08 OC    0(L'UBPRD1,R4),0(R4) UNALLOCATED SLOT - DONE                     
         BZ    PGMRCP20                                                         
         CLI   L'UBPRD(R4),0       IF ALLOCATED LENGTH = 0                      
         BNE   *+10                (NON-POD RUNS SOMETIMES NOT SET)             
         MVC   L'UBPRD(L'UBLEN,R4),W.UBLEN                                      
         CLC   UNAPRD,0(R4)        ALLOCATED TO UNALLOCATED                     
         BNE   PGMRCP10                                                         
         SR    RF,RF                                                            
         IC    RF,L'UBPRD(R4)      BUMP BY SECONDS                              
         CLI   PODRSW,YESQ         IF POD RUN                                   
         BE    *+8                                                              
         LHI   RF,1                ELSE UNITS                                   
         LH    RE,NPRDS            POINT TO UNALLOCATED POSITION                
         SLL   RE,1                                                             
         LA    RE,PPRPRD(RE)                                                    
         AH    RF,0(RE)                                                         
         STH   RF,0(RE)                                                         
         B     PGMRCP18            NEXT SLOT                                    
                                                                                
PGMRCP10 L     R2,AFSTBRD          FIND PRODUCT/LENGTH SEQUENCE                 
         USING TABD,R2                                                          
         SR    RF,RF                                                            
PGMRCP12 CLC   TABPRD,UNAPRD                                                    
         BE    PGMRCP02                                                         
         CLC   TABPRD,0(R4)        TEST RIGHT PRODUCT                           
         BNE   PGMRCP14                                                         
         CLC   TABLEN,L'TABPRD(R4) AND LENGTH                                   
         BE    PGMRCP16                                                         
         CLI   TABLEN,ALLLEN       OK IF LENGTHS NOT SEPARATE                   
         BE    PGMRCP16                                                         
PGMRCP14 AHI   RF,1                BUMP PRODUCT/LENGTH COUNTER                  
         AH    R2,ROWLEN           NEXT PRODUCT/LENGTH                          
         B     PGMRCP12                                                         
                                                                                
PGMRCP16 SLL   RF,1                2 BYTES PER PRODUCT                          
         LA    RF,PPRPRD(RF)       POINT TO POSITION IN PPR TAB ENTRY           
         LH    RE,0(RF)                                                         
         AHI   RE,1                COUNT UNITS NOT SECONDS                      
         STH   RE,0(RF)                                                         
                                                                                
PGMRCP18 AHI   R4,UBPRDL           NEXT SLOT                                    
         BCT   R3,PGMRCP08                                                      
                                                                                
PGMRCP20 GOTOR PGMPUT              ADD TO BUFFER                                
                                                                                
         XC    PPRPGM,PPRPGM                                                    
         XC    PPRPGMC,PPRPGMC                                                  
         MVI   PPRPGM,FF           DO NETWORK/TYPE TOTALS                       
                                                                                
         GOTOR PGMPUT              ADD TO BUFFER                                
                                                                                
         CLI   RPRGOPTN,YESQ       ALSO SKIP IF PROGRAM TYPE NOT USED           
         BNE   PGMRCP22                                                         
         MVC   FULL(L'PPRTYP),PPRTYP SAVE TYPE                                  
         XC    PPRTYP,PPRTYP                                                    
         MVI   PPRTYP,FF           DO NETWORK TOTALS                            
                                                                                
         GOTOR PGMPUT              ADD TO BUFFER                                
                                                                                
PGMRCP22 XC    PPRNET,PPRNET                                                    
         MVI   PPRNET,FF           DO TOTAL TOTALS                              
                                                                                
         GOTOR PGMPUT              ADD TO BUFFER                                
                                                                                
         CLI   RPRGOPTN,YESQ       ALSO SKIP IF PROGRAM TYPE NOT USED           
         BNE   PGMRCP02                                                         
         MVC   PPRTYP,FULL         DO TYPE ACROSS NET (SAVED IN FULL)           
                                                                                
         GOTOR PGMPUT              ADD TO BUFFER                                
                                                                                
         B     PGMRCP02            NEXT POD RECORD                              
                                                                                
PGMRCP24 L     RF,ABUFF3           TEST ANY ENTRIES ADDED                       
         OC    BUFFNREC-BUFFD(,RF),BUFFNREC-BUFFD(RF)                           
         BZ    PGMRCPX                                                          
                                                                                
         MVI   RCSUBPRG,6          FOR HEADLINE ROUTINE                         
         LH    R5,NPRDS            PRODUCT COUNT                                
         AHI   R5,1                PLUS UNALLOCATED                             
         SR    RF,RF                                                            
PGMRCP26 LR    R0,R5                                                            
         MVI   BYTE,YESQ                                                        
         CHI   R0,RCPPPG           MAXIMUM PER PAGE                             
         BNH   *+12                                                             
         LHI   R0,RCPPPG                                                        
         MVI   BYTE,NOQ                                                         
         STH   R0,NPRDPRNT         NUMBER TO DO THIS TIME                       
         STH   RF,NPRDSKIP         NUMBER TO SKIP                               
                                                                                
         CLI   RPRGOPTN,YESQ       TEST PROGRAM TYPE USED                       
         BE    PGMRCP28                                                         
         LARL  RE,PGMHD1                                                        
         MVC   L'P1*0+8(4,RE),SPACES                                            
         MVC   L'P1*1+8(4,RE),SPACES                                            
         MVC   L'P1*2+8(4,RE),SPACES                                            
                                                                                
PGMRCP28 LARL  RF,PGMHD2                                                        
         MVC   30(L'UNITSL,RF),UNITSL                                           
         CLI   PODRSW,YESQ                                                      
         BNE   PGMRCP30                                                         
         MVC   30(5,RF),=C' (30)'                                               
                                                                                
PGMRCP30 L     R2,AFSTBRD                                                       
         USING TABD,R2                                                          
         LH    RF,NPRDSKIP         NUMBER OF PRODUCTS TO SKIP THIS TIME         
         MH    RF,ROWLEN                                                        
         AR    R2,RF                                                            
                                                                                
PGMRCP32 LH    RF,NPRDPRNT         NUMBER OF PRODUCTS TO DO THIS TIME           
                                                                                
         LARL  R1,PGMHD1                                                        
         AHI   R1,35                                                            
         MVC   0(L'P1-35,R1),SPACES                                             
         MVC   L'P1(L'P1-35,R1),SPACES                                          
         MVC   L'P1*2(L'P1-35,R1),SPACES                                        
                                                                                
PGMRCP34 CLC   TABPRD,UNAPRD       TEST UNALLOCATED                             
         BNE   *+12                                                             
         LA    RE,=C'UN-'                                                       
         B     PGMRCP36                                                         
                                                                                
         LR    R0,R1                                                            
         GOTOR LOCPRD,TABPRD                                                    
         MVC   DUB(L'PTPRDA),PTPRDA-PTBUFFD(R1)                                 
         CLI   DUB+L'PTPRDA-1,SPACE                                             
         BH    *+14                                                             
         MVI   DUB,SPACE                                                        
         MVC   DUB+1(L'PTPRDA-1),PTPRDA-PTBUFFD(R1)                             
         LA    RE,DUB                                                           
         LR    R1,R0                                                            
                                                                                
PGMRCP36 CLI   PODRSW,YESQ         TEST POD RUN                                 
         BE    PGMRCP38            YES - SPECIAL                                
         MVC   L'P1+1(L'PTPRDA,R1),0(RE)                                        
         CLC   TABPRD,UNAPRD       FOR UNALLOCATED                              
         BNE   PGMRCP40                                                         
         MVC   1(L'PTPRDA,R1),0(RE)                                             
         MVC   L'P1+1(L'ALL3L,R1),ALL3L                                         
         B     PGMRCP40                                                         
                                                                                
PGMRCP38 MVC   1(L'PTPRDA,R1),0(RE)                                             
         SR    R0,R0                                                            
         IC    R0,TABLEN           LENGTH                                       
         LA    RE,L'P1+1(R1)                                                    
         EDIT  (R0),(3,0(RE))                                                   
         CLC   TABPRD,UNAPRD       UNALLOCATED                                  
         BNE   PGMRCP40                                                         
         MVC   1(5,R1),=C'Unall'                                                
         MVC   L'P1+1(5,R1),=C' (30)'                                           
         MVC   L'P1*2+1(5,R1),DASHES                                            
PGMRCP40 MVC   L'P1*2+1(L'PTPRDA,R1),DASHES                                     
         AHI   R1,4                NEXT PRINT POSITION                          
         AH    R2,ROWLEN                                                        
         BCT   RF,PGMRCP34                                                      
                                                                                
         MVI   FORCEHED,YESQ       NEW PAGE FOR THIS REPORT                     
                                                                                
         XC    PPRKEY(PPRKEYL),PPRKEY                                           
         GOTOR BUFFERIN,DMCB,('BUFFARDH',ABUFF3),PPRD,ACOMFACS,XA=N             
         TM    DM2,EOFQ                                                         
         BNZ   PGMRCP62                                                         
         B     PGMRCP44                                                         
                                                                                
PGMRCP42 GOTOR BUFFERIN,DMCB,('BUFFASEQ',ABUFF3),PPRD,ACOMFACS,XA=N             
         TM    DM2,EOFQ                                                         
         BNZ   PGMRCP62                                                         
                                                                                
PGMRCP44 CLI   PPRNET,FF                                                        
         BNE   PGMRCP46                                                         
         MVC   PPRLNET,=C'*Total*'                                              
         MVI   SPACING,2                                                        
         B     PGMRCP48                                                         
                                                                                
PGMRCP46 MVC   PPRLNET(L'PPRNET),PPRNET                                         
                                                                                
PGMRCP48 MVC   PPRLTYP,PPRTYP                                                   
         CLI   PPRTYP,SPACE                                                     
         BH    PGMRCP50                                                         
         CLI   RPRGOPTN,YESQ       TEST PROGRAM TYPE USED                       
         BNE   PGMRCP50                                                         
         MVC   PPRLTYP(4),=C'None'                                              
                                                                                
PGMRCP50 CLI   PPRTYP,FF                                                        
         BNE   *+14                                                             
         MVC   PPRLTYP,ALL3L                                                    
         MVI   SPACING,2                                                        
         MVC   PPRLPGM,PPRPGM                                                   
         CLI   PPRPGM,FF                                                        
         BNE   *+14                                                             
         MVC   PPRLPGM(7),=C'*Total*'                                           
         MVI   SPACING,2                                                        
         ICM   R1,15,PPRTOT                                                     
         BNZ   *+12                                                             
         MVI   PPRLTOT+4,SPACE     LEAVE FOR FILL CHARACTER                     
         B     PGMRCP54                                                         
         CLI   PODRSW,YESQ         FOR POD RUN                                  
         BNE   PGMRCP52                                                         
         M     R0,FW10             CONVERT SECONDS TO UNITS                     
         LH    RF,PODEQU                                                        
         GOTOR DIVIDE                                                           
         EDIT  (R1),(6,PPRLTOT),1                                               
         B     PGMRCP54                                                         
PGMRCP52 EDIT  (R1),(6,PPRLTOT)                                                 
PGMRCP54 LH    RF,NPRDSKIP         PRODUCTS TO SKIP                             
         SLL   RF,1                2 BYTE PER PRODUCT                           
         LA    R3,PPRPRD(RF)                                                    
         LA    R4,PPRLCNTS                                                      
         LH    R8,NPRDPRNT         NUMBER OF PRODUCTS TO DO                     
                                                                                
PGMRCP56 CHI   R8,1                TEST DOING UNALL (LAST PRODUCT)              
         BNE   PGMRCP58                                                         
         CLI   BYTE,YESQ           ON FINAL SET                                 
         BNE   PGMRCP58                                                         
         CLI   PODRSW,YESQ         AND IF POD RUN                               
         BNE   PGMRCP58                                                         
         SR    R1,R1                                                            
         ICM   R1,3,0(R3)          CONVERT SECONDS TO UNITS                     
         BNZ   *+12                                                             
         MVI   5(R4),SPACE         LEAVE FOR FILL CHARACTER                     
         B     PGMRCP60                                                         
                                                                                
         M     R0,FW10                                                          
         LH    RF,PODEQU                                                        
         GOTOR DIVIDE                                                           
         EDIT  (R1),(6,0(R4)),1                                                 
         B     PGMRCP60                                                         
                                                                                
PGMRCP58 OC    0(2,R3),0(R3)                                                    
         BNZ   *+12                                                             
         MVI   3(R4),SPACE         LEAVE FOR FILL CHARACTER                     
         B     PGMRCP60                                                         
         EDIT  (B2,0(R3)),(4,0(R4)),ZERO=NOBLANK                                
                                                                                
PGMRCP60 AHI   R3,2                                                             
         AHI   R4,4                                                             
         BCT   R8,PGMRCP56                                                      
         GOTOR REPORT,XA=OFF                                                    
         B     PGMRCP42                                                         
                                                                                
PGMRCP62 LH    R0,NPRDPRNT         NUMBER TO DO THIS TIME                       
         LH    RF,NPRDSKIP         NUMBER TO SKIP                               
         AR    RF,R0               BUMP NUMBER TO SKIP                          
         SR    R5,R0                                                            
         BP    PGMRCP26            TEST ANY LEFT                                
                                                                                
PGMRCPX  J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Add/update program/product summary buffer entry                     *         
***********************************************************************         
                                                                                
PGMPUT   NTR1  ,                                                                
         L     R2,APXCREC          USE PXCREC FOR READING                       
B        USING PPRD,R2             R2=A(BUFFER RECORD)                          
         MVC   B.PPRKEY(PPRKEYL),PPRKEY                                         
         GOTOR BUFFERIN,DMCB,('BUFFAGET',ABUFF3),B.PPRKEY,ACOMFACS,XA=N         
         BNE   PGMPUT04                                                         
                                                                                
         ICM   RF,15,B.PPRTOT      UPDATE TOTAL COUNT                           
         ICM   RE,15,PPRTOT                                                     
         AR    RF,RE                                                            
         STCM  RF,15,B.PPRTOT                                                   
                                                                                
         LH    R0,NPRDS            R0=NUMBER OF PRODUCTS                        
         AHI   R0,1                PLUS 1 FOR UNALLOCATED                       
         LA    RE,B.PPRPRD         RE=A(BUFFER RECORD COUNTS)                   
         LA    RF,PPRPRD           RF=A(NEW RECORD COUNTS)                      
PGMPUT02 LH    R1,0(RE)            UPDATE PRODUCT COUNTS                        
         AH    R1,0(RF)                                                         
         STH   R1,0(RE)                                                         
         AHI   RE,L'PPRPRD                                                      
         AHI   RF,L'PPRPRD                                                      
         BCT   R0,PGMPUT02                                                      
                                                                                
         GOTOR BUFFERIN,DMCB,('BUFFAPUT',ABUFF3),B.PPRKEY,ACOMFACS,XA=N         
         JE    EXIT                                                             
         DC    H'0'                                                             
                                                                                
PGMPUT04 GOTOR BUFFERIN,DMCB,('BUFFAPUT',ABUFF3),PPRKEY,ACOMFACS,XA=N           
         JE    EXIT                                                             
         DC    H'0'                                                             
         DROP  R6,RB,B,W                                                        
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Report on request parameters                                        *         
***********************************************************************         
                                                                                
PARREP   NMOD1 PARWRKL,**PARREP,R8                                              
         LR    R5,RC                                                            
         USING PARWRKD,R5          R5=A(LOCAL WORKING STORAGE)                  
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         LH    R0,HIGHPRDN                                                      
         SHI   R0,1                                                             
         MH    R0,PRDBUFLN                                                      
         A     R0,PRDBUFF                                                       
         ST    R0,PARPBUFX                                                      
                                                                                
         MVI   FORCEHED,YESQ                                                    
         MVI   RCSUBPRG,1                                                       
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(29),=C'Run control options in effect'                         
         MVC   P2(29),DASHES                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(26),=C'**Live run - file marked**'                            
         CLI   QOPT4,YESQ                                                       
         BNE   *+10                                                             
         MVC   P1(L'TRUNFNML),TRUNFNML                                          
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(34),=C'Allocation basis..............Cost'                    
         CLI   GOALOPT,GOALDOLS                                                 
         BE    PARREP00                                                         
         MVC   P1+30(DEMNNAML),DEMNMS+(DEMNNADP-DEMNAMD)                        
         CLI   P1+30,SPACE                                                      
         BNE   PARREP00                                                         
         MVC   P1+30(DEMNNAML+1),P+31                                           
         B     *-14                                                             
PARREP00 TM    REQFLAG1,REQFMIXB                                                
         BZ    *+10                                                             
         MVC   P1+30(16),=C'Mixed demo goals'                                   
         GOTOR REPORT,XA=OFF                                                    
         CLI   GOALOPT,GOALDOLS                                                 
         BE    PARREP02                                                         
         TM    REQFLAG1,REQFMIXB                                                
         BZ    PARREP04                                                         
PARREP02 MVC   P1(30),=C'Corporate demo................'                        
         MVC   P1+30(L'DEMNNAME),DEMNMS+(DEMNNAME-DEMNAMD)                      
         CLI   DEMNMS,0            IF A NAD DEMO                                
         BE    *+10                                                             
         MVC   P1+30(DEMNNAML),DEMNMS+(DEMNNADP-DEMNAMD)                        
         GOTOR REPORT,XA=OFF                                                    
PARREP04 MVC   P1(32),=C'Allocate excess supply........No'                      
         CLI   EXCSOPT,NOQ                                                      
         BE    *+10                                                             
         MVC   P1+30(3),=C'Yes'                                                 
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(32),=C'Goal balancing option.........No'                      
         CLI   RSWKOPT,RSWKNOQ                                                  
         BE    PARREP06                                                         
         MVC   P1+30(3),=C'Yes'                                                 
         CLI   RSWKOPT,RSWKYESQ                                                 
         BE    PARREP06                                                         
         MVC   P1+33(7),=C',Report'                                             
PARREP06 GOTOR REPORT,XA=OFF                                                    
         MVC   P1(32),=C'Re-allocation option..........No'                      
         CLI   REALLOC,NOQ                                                      
         BE    PARREP08                                                         
         MVC   P1+30(3),=C'Yes'                                                 
         CLI   REALLOC,YESQ                                                     
         BE    PARREP08                                                         
         GOTOR DATCON,DMCB,(2,REALLSDT),(5,P1+30),XA=OFF                        
PARREP08 GOTOR REPORT,XA=OFF                                                    
         MVC   P1(36),=C'Weeks with no goals...........Ignore'                  
         CLI   ZERWKOPT,ZERWIGNQ                                                
         BE    PARREP10                                                         
         MVC   P1+30(6),=C'Error '                                              
         CLI   ZERWKOPT,ZERWERRQ                                                
         BE    PARREP10                                                         
         MVC   P1+30(17),=C'Use previous week'                                  
         CLI   ZERWKOPT,ZERWPRVQ                                                
         BE    PARREP10                                                         
         MVC   P1+30(17),=C'Use average week '                                  
PARREP10 GOTOR REPORT,XA=OFF                                                    
         CLI   DPTFLT,0            SKIP IF HAVE DAYPART FILTER                  
         BNE   PARREP12                                                         
         MVC   P1(32),=C'Allocate dayparts separately..No'                      
         TM    REQFLAG2,REQFSDPT                                                
         BZ    *+10                                                             
         MVC   P1+30(3),=C'Yes'                                                 
         GOTOR REPORT,XA=OFF                                                    
PARREP12 CLI   LENFLT,0            SKIP IF HAVE LENGTH FILTER                   
         BNE   PARREP14                                                         
         MVC   P1(32),=C'Allocate lengths separately...No'                      
         TM    REQFLAG2,REQFSLEN                                                
         BZ    *+10                                                             
         MVC   P1+30(3),=C'Yes'                                                 
         GOTOR REPORT,XA=OFF                                                    
PARREP14 MVC   P1(33),=C'Daypart filter................All'                     
         CLI   DPTFLT,0                                                         
         BE    PARREP15                                                         
         MVC   P1+30(3),SPACES                                                  
         MVC   P1+30(1),QPROG+58                                                
         CLI   QPROG+58,C' '                                                    
         BNE   PARREP15                                                         
         MVC   P1+30(L'QDPTFLT),QDPTFLT                                         
PARREP15 GOTOR REPORT,XA=OFF                                                    
         MVC   P1(33),=C'Unit length filter............All'                     
         CLI   LENFLT,0                                                         
         BE    PARREP18                                                         
         CLI   PODRSW,YESQ                                                      
         BNE   PARREP16                                                         
         MVC   P1+30(5),=C'Group'                                               
         MVC   P1+36(L'PODCOD),PODCOD                                           
         MVI   P1+37,DASH                                                       
         MVC   P1+38(L'PODPRNT),PODPRNT                                         
         B     PARREP18                                                         
PARREP16 EDIT  (B1,LENFLT),(3,P1+30),ALIGN=LEFT                                 
PARREP18 GOTOR REPORT,XA=OFF                                                    
         MVC   P1(38),=C'Indexing basis................Percents'                
         CLI   INDXOPT,INDXPCTQ                                                 
         BE    *+10                                                             
         MVC   P1+30(13),=C'Actual values'                                      
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(33),=C'Reports requested.............All'                     
         CLI   RPTOPTN,RPTOALLQ                                                 
         BE    PARREP20                                                         
         MVC   P1+30(10),=C'Recap only'                                         
         CLI   RPTOPTN,RPTORCPQ                                                 
         BE    PARREP20                                                         
         MVC   P1+30(22),=C'Weekly summary + recap'                             
PARREP20 GOTOR REPORT,XA=OFF                                                    
         MVC   P1(36),=C'CPM/CPP equalization basis....Weekly'                  
         CLI   CPMSOPTN,CPMSWKYQ                                                
         BE    *+10                                                             
         MVC   P1+30(17),=C'By Daypart/Length'                                  
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(36),=C'Assigned/Actual costs.........Actual'                  
         LA    RF,P1+36                                                         
         CLI   ASSGNOPT,YESQ                                                    
         BNE   *+14                                                             
         MVC   P1+30(8),=C'Assigned'                                            
         LA    RF,P1+38                                                         
         CLI   INTGOPTN,YESQ                                                    
         BNE   *+10                                                             
         MVC   1(13,RF),=C'+ Integration'                                       
         GOTOR REPORT,XA=OFF                                                    
PARREP22 MVI   SPACING,3                                                        
         GOTOR REPORT,XA=OFF                                                    
         LARL  R7,INTTAB           DO TIME INTERVALS                            
         LA    R3,PINTRVL                                                       
         LHI   R4,INTTABN                                                       
PARREP24 MVC   P1(30),0(R7)                                                     
         MVC   P2(30),30(R7)                                                    
         EDIT  (B1,0(R3)),(3,P1+30),ZERO=NOBLANK,ALIGN=LEFT                     
         CLI   0(R3),0                                                          
         BNE   *+14                                                             
         MVC   P1+34(10),=C'(Not used)'                                         
         B     PARREP26                                                         
         CLI   0(R3),1                                                          
         BNE   *+14                                                             
         MVC   P1+30(7),=C'Program'                                             
         B     PARREP26                                                         
         MVC   P1+34(7),=C'Minutes'                                             
PARREP26 EDIT  (B1,1(R3)),(3,P2+30),ZERO=NOBLANK,ALIGN=LEFT                     
         MVI   SPACING,3                                                        
         GOTOR REPORT,XA=OFF                                                    
         AHI   R7,L'INTTAB                                                      
         AHI   R3,2                                                             
         BCT   R4,PARREP24                                                      
*                                  LIST OBJECTIVES AND WEIGHTS                  
         MVC   P1(41),=C'Weights assigned to allocation objectives'             
         MVC   P2(30),DASHES                                                    
         MVC   P2+30(11),DASHES                                                 
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1+2(18),=C'Scale from 0 to 10'                                  
         MVI   P2,0                                                             
         MVC   P3+2(37),=C' 0 = No importance (ignore objective)'               
         MVC   P4+2(21),=C'10 = Great importance'                               
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
         LARL  R3,OBJTAB                                                        
         LA    R4,OBJWGTS                                                       
         LA    R2,P1                                                            
PARREP28 MVC   0(30,R2),0(R3)                                                   
         EDIT  (B1,0(R4)),(2,30(R2)),ZERO=NOBLANK,ALIGN=LEFT                    
         AHI   R2,L'P1                                                          
         AHI   R3,L'OBJTAB                                                      
         AHI   R4,L'OBJWGTS                                                     
         CLI   0(R3),FF                                                         
         BNE   PARREP28                                                         
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
*                                  DO BRAND LIST                                
         MVI   PMHLSW,PMHLBRDQ     BRAND LIST HEADINGS                          
         CLI   LINE,48             ALLOW SOME ROOM                              
         BNH   PARREP34                                                         
         MVI   FORCEHED,YESQ       LET HEDBLD TAKE CARE OF HEADINGS             
         B     PARREP36                                                         
PARREP34 LHI   R0,PARHDN                                                        
         LA    R2,P1                                                            
         LARL  R3,PARHD1                                                        
         MVC   0(L'PARHD1,R2),0(R3)                                             
         AHI   R2,L'P1                                                          
         AHI   R3,L'PARHD1                                                      
         BCT   R0,*-14                                                          
         MVI   SPACING,2                                                        
         GOTOR REPORT,XA=OFF                                                    
PARREP36 MVI   PARINACT,NOQ                                                     
                                                                                
         L     R6,PRDBUFF                                                       
         USING PTBUFFD,R6                                                       
PARREP38 MVC   PMBBRD,PTPRDA                                                    
         TM    PTSTAT,PTSACTVQ     TEST ACTIVE                                  
         BNZ   *+12                                                             
         MVI   PMBBSTAT,ASTERISK   FLAG INACTIVE PRODUCTS                       
         MVI   PARINACT,YESQ       SET HAVE INACTIVES                           
         MVC   PMBBNM(L'PTNAME),PTNAME                                          
         MVC   PMBPRI,=C' No'                                                   
         TM    PTSTAT,PTSPRTYQ                                                  
         BZ    *+10                                                             
         MVC   PMBPRI,=C'Yes'                                                   
         GOTOR SETCLS,PTCLASS                                                   
         BE    PARREP44                                                         
         MVC   PMBCLAS,CLASS1                                                   
         BH    PARREP44            NO                                           
         MVI   PMBCLAS+1,COMMA                                                  
         MVC   PMBCLAS+2,CLASS2                                                 
                                                                                
PARREP44 LA    R2,PTTRGS           TARGETS                                      
         LHI   R0,NTGVARS                                                       
         LA    R3,PMBTRG1                                                       
PARREP46 SR    RF,RF                                                            
         ICM   RF,1,0(R2)                                                       
         BZ    PARREP50                                                         
         MHI   RF,L'TARGETS                                                     
         LA    RF,TARGETS-L'TARGETS(RF)                                         
         LA    RE,DEMNMS                                                        
         USING DEMNAMD,RE                                                       
         LHI   R1,PTZDEMMX                                                      
PARREP48 CLC   DEMNDEMN,0(RF)                                                   
         BE    *+16                                                             
         AHI   RE,DEMNLENQ                                                      
         BCT   R1,PARREP48                                                      
         J     PARREP50                                                         
         MVC   0(L'DEMNNAME,R3),DEMNNAME                                        
         CLI   DEMNDEMN,0                                                       
         BE    PARREP50                                                         
         MVC   0(L'DEMNNADP+L'DEMNNAME,R3),DEMNNADP                             
PARREP50 AHI   R2,1                NEXT TARGET                                  
         AHI   R3,PMBTRG2-PMBTRG1                                               
         BCT   R0,PARREP46                                                      
                                                                                
         LA    RF,PTDEMNO          GOALED DEMO                                  
         LA    RE,DEMNMS                                                        
         USING DEMNAMD,RE                                                       
         LHI   R0,PTZDEMMX                                                      
PARREP52 CLC   DEMNDEMN,0(RF)                                                   
         BE    *+16                                                             
         AHI   RE,DEMNLENQ                                                      
         BCT   R0,PARREP52                                                      
         B     PARREP53                                                         
         MVC   PMBGDEM(L'DEMNNAME),DEMNNAME                                     
         CLI   DEMNDEMN,0                                                       
         BE    PARREP53                                                         
         MVC   PMBGDEM(L'DEMNNADP+L'DEMNNAME),DEMNNADP                          
         DROP  RE                                                               
                                                                                
PARREP53 L     R7,XCTATAB          EXCLUSIONS                                   
         ICM   R4,15,XCTNREC                                                    
         BZ    PARREP74                                                         
         USING XCTABD,R7                                                        
PARREP54 SR    R1,R1                                                            
         ICM   R1,PRDMSKQ,XCTPRD                                                
         CLC   PTPRDA,PTPRDA-PTBUFFD(R1)                                        
         BNE   PARREP72                                                         
         MVC   PMBXEST,ALL3L                                                    
         CLI   XCTEST,0                                                         
         BE    PARREP56                                                         
         SR    R0,R0                                                            
         IC    R0,XCTEST                                                        
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  PMBXEST,DUB                                                      
PARREP56 MVC   PMBXNET(L'ALL3L),ALL3L                                           
         CLI   XCTNET,FF                                                        
         BE    PARREP58                                                         
         MVC   PMBXNET(L'XCTNET),XCTNET                                         
PARREP58 CLI   XCTTYPE,XCTTTODQ    TEST IF TIME OF DAY                          
         BE    PARREP60                                                         
         CLI   XCTTYPE,XCTTADYQ    OR TIME + DAY                                
         BNE   PARREP62                                                         
PARREP60 MVC   PMBXPGM(5),=C'Time='                                             
         GOTOR UNTIME,DMCB,XCTDAY,PMBXPGM+5,XA=OFF                              
         CLI   XCTTYPE,XCTTADYQ                                                 
         BNE   PARREP66                                                         
         LA    RF,PMBXPGM+20       FIND END OF TIME                             
         CLI   0(RF),SPACE                                                      
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVI   1(RF),SLASH                                                      
         AHI   RF,2                                                             
         GOTOR CODAY,DMCB,XCTDOW,(RF),XA=OFF                                    
         B     PARREP66                                                         
PARREP62 CLI   XCTTYPE,XCTTDOWQ    TEST IF DAY OF WEEK                          
         BNE   PARREP64                                                         
         MVC   PMBXPGM(5),=C'Days='                                             
         GOTOR CODAY,DMCB,XCTDAY,PMBXPGM+5,XA=OFF                               
         CLI   XCTDPT,0            TEST IF HAVE DAYPART/LENGTH                  
         BE    PARREP66            NO, DONE                                     
         LA    RE,PMBXPGM+L'PMBXPGM-1                                           
         CLI   0(RE),SPACE                                                      
         BH    *+8                                                              
         BCT   RE,*-8                                                           
         MVI   2(RE),OPAREN                                                     
         MVC   3(1,RE),XCTDPT                                                   
         EDIT  (B1,XCTLEN),(3,4(RE)),ALIGN=LEFT                                 
         AR    RE,R0                                                            
         MVI   4(RE),CPAREN                                                     
         B     PARREP66                                                         
PARREP64 MVC   PMBXPGM,XCTPGM                                                   
PARREP66 MVC   PMBXDTS+3(5),=C'Start'                                           
         CLI   XCTSDATE,0                                                       
         BE    PARREP68                                                         
         GOTOR DATCON,DMCB,(2,XCTSDATE),(5,PMBXDTS),XA=OFF                      
         CLC   XCTSDATE,XCTEDATE                                                
         BE    PARREP70                                                         
PARREP68 MVI   PMBXDTS+8,DASH                                                   
         MVC   PMBXDTS+9(3),=C'End'                                             
         CLI   XCTEDATE,FF                                                      
         BE    PARREP70                                                         
         GOTOR (RF),(R1),(2,XCTEDATE),(5,PMBXDTS+9),XA=OFF                      
PARREP70 GOTOR REPORT,XA=OFF                                                    
PARREP72 A     R7,XCTLREC          NEXT ENTRY                                   
         BCT   R4,PARREP54                                                      
                                                                                
PARREP74 CLI   PMBBRD,SPACE                                                     
         BNH   PARREP76                                                         
         MVC   PMBXEST(8),=C'--None--'                                          
         GOTOR REPORT,XA=OFF                                                    
                                                                                
PARREP76 AH    R6,PRDBUFLN                                                      
         C     R6,PARPBUFX                                                      
         BL    PARREP38                                                         
                                                                                
         CLI   PARINACT,YESQ                                                    
         BNE   PARREP78                                                         
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(26),=C'* -No goals for this brand'                            
         GOTOR REPORT,XA=OFF                                                    
                                                                                
PARREP78 TM    REQFLAG1,REQFMIXB   MIXED GOAL BASIS NOT ALLOWED                 
         BZ    PARREPX                                                          
         GOTOR REPORT,XA=OFF                                                    
         MVC   P1(43),=C'**Mixed demo allocation basis not allowed**'           
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         J     ENDREQ                                                           
                                                                                
PARREPX  MVI   PMHLSW,0                                                         
         MVI   RCSUBPRG,0                                                       
         J     EXIT                                                             
         DROP  R5,R6,R7,R8,RB                                                   
                                                                                
         LTORG                                                                  
                                                                                
PARWRKD  DSECT                     ** PARREP LOCAL WORKING STORAGE **           
PARPBUFX DS    A                   A(LAST PTBUFFER ENTRY TO REPORT)             
PARINACT DS    C                   INACTIVE SWITCH                              
PARWRKL  EQU   *-PARWRKD                                                        
SPK502   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Headline building routines                                          *         
***********************************************************************         
                                                                                
HEDBLD   NMOD1 0,**HEDBLD                                                       
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
         LM    R9,RA,SAVER9RA      RESTORE R9 AND RA                            
                                                                                
         CLI   SKIPSPEC,YESQ                                                    
         BE    HEDBLDX                                                          
         CLI   SVQNET,SPACE                                                     
         BNH   HEDBLD02                                                         
         CLC   ALL3L,SVQNET                                                     
         BE    HEDBLD02                                                         
         MVC   HEAD7+12(L'QNET),QNET                                            
                                                                                
HEDBLD02 CLI   RCSUBPRG,1          PARAMETER REPORT                             
         BE    HEDBLD1                                                          
         MVC   HEAD5+51(25),=C'Allocation based on costs'                       
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+10                                                             
         MVC   HEAD5+50+21(DEMNNAML),DEMNMS+(DEMNNADP-DEMNAMD)                  
         CLI   QOPT4,YESQ                                                       
         BNE   *+10                                                             
         MVC   HEAD6+51(L'TRUNFNML),TRUNFNML                                    
         CLI   RCSUBPRG,2          RECAP REPORT                                 
         BE    HEDBLD2                                                          
         CLI   RCSUBPRG,3          SUMMARY REPORT (WEEKLY ANALYSIS)             
         BE    HEDBLD3                                                          
         CLI   RCSUBPRG,4          DETAIL REPORT - MODE 1                       
         BE    HEDBLD4                                                          
         CLI   RCSUBPRG,5          DETAIL REPORT - MODE 2                       
         BE    HEDBLD5                                                          
         CLI   RCSUBPRG,6          PROGRAM/PRODUCT RECAP                        
         BE    HEDBLD6                                                          
         CLI   RCSUBPRG,7          GOAL REPORT                                  
         BE    HEDBLD7                                                          
         CLI   RCSUBPRG,8          POD CHANGE ANALYSIS REPORT                   
         BE    HEDBLD8                                                          
         B     HEDBLDX                                                          
         EJECT                                                                  
***********************************************************************         
* Parameter report headlines                                          *         
***********************************************************************         
                                                                                
HEDBLD1  CLI   PMHLSW,PMHLBRDQ                                                  
         BNE   HEDBLD11                                                         
         LA    RE,HEAD9                                                         
         LARL  RF,PARHD1                                                        
         LHI   R0,PARHDN                                                        
         MVC   0(L'PARHD1,RE),0(RF)                                             
         AHI   RE,L'P1                                                          
         AHI   RF,L'PARHD1                                                      
         BCT   R0,*-14                                                          
HEDBLD11 B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* Recap report headlines                                              *         
***********************************************************************         
                                                                                
HEDBLD2  MVC   HEAD8(L'DPSLDESC),DPSLDESC                                       
         MVC   HEAD10+1(5),=C'Brand'                                            
         MVC   HEAD11+1(5),DASHES                                               
         LARL  RE,RECHD1                                                        
         MVC   HEAD10+49(L'RECHD1),0(RE)                                        
         MVC   HEAD11+49(L'RECHD2),L'RECHD1(RE)                                 
         B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* Summary (and goal balance) report headlines                         *         
***********************************************************************         
                                                                                
HEDBLD3  MVC   HEAD8(L'DPSLDESC),DPSLDESC                                       
HEDBLD31 LA    R6,HEAD10                                                        
         AH    R6,ROWDISP                                                       
         MVC   L'P1(5,R6),=C'Brand'                                             
         MVC   L'P1*2(5,R6),DASHES                                              
         LH    R5,RPTNOWKS                                                      
         AH    R6,AMTDISP                                                       
         CLI   RPTSWK,0            ARE WE STARTING WITH 'TOTAL WEEK'            
         BNE   HEDBLD32                                                         
         MVC   2(L'TOTALL,R6),TOTALL                                            
         MVC   L'P1(8,R6),=C'Campaign'                                          
         MVC   L'P1*2(8,R6),DASHES                                              
         AH    R6,WEEKWID          POINT TO WEEK 1 COLUMN                       
         BCTR  R5,0                ONE LESS WEEK                                
HEDBLD32 CLI   PBMODE,PBMDPTQ      TEST DOING DAYPART RESCALING                 
         BE    HEDBLD34                                                         
         MVC   1(8,R6),=C'Week of-'                                             
         L     R4,AWEEKLST         ADJUSTED COPY OF MEDWEEKS                    
         SR    RF,RF                                                            
         ICM   RF,1,RPTSWK         POINT TO STARTING WEEK                       
         BZ    HEDBLD33                                                         
         BCTR  RF,0                                                             
         MHI   RF,L'MEDQ1WKS                                                    
         AR    R4,RF                                                            
HEDBLD33 GOTOR DATCON,DMCB,(2,0(R4)),(4,L'P1+3(R6)),XA=OFF                      
         MVC   L'P1*2+3(5,R6),DASHES                                            
         AH    R6,WEEKWID                                                       
         AHI   R4,L'MEDQ1WKS                                                    
         BCT   R5,HEDBLD33                                                      
         B     HEDBLD36                                                         
HEDBLD34 LA    R4,DSTAB            TABLE OF DAYPART/LENGTHS                     
         SR    RF,RF                                                            
         ICM   RF,1,RPTSWK         POINT TO STARTING DAYPART                    
         BZ    HEDBLD35                                                         
         BCTR  RF,0                                                             
         SLL   RF,1                2 BYTE ENTRIES IN TABLE                      
         AR    R4,RF                                                            
HEDBLD35 MVC   L'P1+4(1,R6),0(R4)                                               
         LA    R2,L'P1+5(R6)                                                    
         EDIT  (B1,1(R4)),(3,0(R2)),ALIGN=LEFT                                  
         MVC   L'P1*2+3(5,R6),DASHES                                            
         AHI   R4,L'DSTAB          NEXT DSTAB ENTRY                             
         AH    R6,WEEKWID                                                       
         BCT   R5,HEDBLD35                                                      
HEDBLD36 CLI   NOMID,YESQ                                                       
         BE    HEDBLD37                                                         
         LA    R6,MID1                                                          
         AH    R6,ROWDISP                                                       
         MVC   0(L'SRPNL1,R6),SRPNL1                                            
         MVC   L'P1(L'SRPNL2,R6),SRPNL2                                         
HEDBLD37 B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* Detail report headlines - Mode 1                                    *         
***********************************************************************         
                                                                                
HEDBLD4  MVC   HEAD8(L'DPSLDESC),DPSLDESC                                       
         LARL  RE,DETHD1                                                        
         MVC   HEAD10(L'DETHD1),0(RE)                                           
         MVC   HEAD11(L'DETHD2),L'DETHD1(RE)                                    
         MVC   HEAD12(L'DETHD3),L'DETHD1+L'DETHD2(RE)                           
         MVC   HEAD11(7),=C'  Est  '                                            
HEDBLD41 CLI   PODRSW,YESQ         FOR POD RUNS                                 
         BNE   HEDBLD42                                                         
         MVC   HEAD11+36(3),=C'Len'                                             
         MVC   HEAD12+36(3),DASHES                                              
HEDBLD42 LA    R2,HEAD10                                                        
         LA    R4,CORPDEM          SET DEMO NAMES                               
         LH    R5,NTARGETS                                                      
         AHI   R5,1                INCLUDE CORPORATE                            
         CHI   R5,9                NINE MAXIMUM ALTOGETHER                      
         BNH   *+8                                                              
         LHI   R5,9                                                             
         LA    R6,HEAD10+51        START OF NAMES                               
HEDBLD43 GOTOR DEMNAM,0(R4)                                                     
         MVC   000+4(L'DEMNNADP,R6),DEMNNADP-DEMNAMD(RF)                        
         MVC   WORK(L'DEMNNAME),SPACES      RIGHT ALIGN DEMO NAME               
         MVC   WORK+L'DEMNNAME(L'DEMNNAME),DEMNNAME-DEMNAMD(RF)                 
         LA    R3,WORK+L'DEMNNAME                                               
HEDBLD44 MVC   L'P1+1(L'DEMNNAME,R6),0(R3)                                      
         CLI   L'P1+L'DEMNNAME(R6),SPACE                                        
         BH    *+10                                                             
         BCTR  R3,0                                                             
         B     HEDBLD44                                                         
         MVC   L'P1*2+1(L'DEMNNAME,R6),DASHES                                   
         AHI   R6,9                                                             
         AHI   R4,4                                                             
         BCT   R5,HEDBLD43                                                      
         B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* Detail report headlines - Mode 2                                    *         
***********************************************************************         
                                                                                
HEDBLD5  MVC   HEAD8(L'DPSLDESC),DPSLDESC                                       
         LARL  RE,D2RHD1                                                        
         MVC   HEAD10(L'D2RHD1),0(RE)                                           
         MVC   HEAD11(L'D2RHD2),L'D2RHD1(RE)                                    
HEDBLD51 LA    R2,HEAD10                                                        
         LA    R4,CORPDEM          SET DEMO NAMES                               
         LH    R5,NTARGETS                                                      
         AHI   R5,1                INCLUDE CORPORATE DEMO                       
         CHI   R5,9                NINE TARGETS WON'T FIT                       
         BL    *+8                                                              
         LHI   R5,9                NOTE - DROPS TARGETS 9+                      
         LA    R6,HEAD9+83         START OF NAMES                               
HEDBLD52 GOTOR DEMNAM,0(R4)                                                     
         MVC   000+3(L'DEMNNADP,R6),DEMNNADP-DEMNAMD(RF)                        
         MVC   L'P1+11(3,R6),=C'CPP' CPP                                        
         CLI   DEMNRVSA-DEMNAMD(RF),DEMNRATQ                                    
         BE    HEDBLD53                                                         
         MVC   L'P1+11(3,R6),=C'CPM' CPM                                        
HEDBLD53 MVC   WORK(L'DEMNNAME),SPACES                                          
         MVC   WORK+L'DEMNNAME(L'DEMNNAME),DEMNNAME-DEMNAMD(RF)                 
         LA    R3,WORK+L'DEMNNAME                                               
HEDBLD54 MVC   L'P1(L'DEMNNAME,R6),0(R3)                                        
         CLI   L'P1+L'DEMNNAME-1(R6),SPACE                                      
         BH    *+10                                                             
         BCTR  R3,0                                                             
         B     HEDBLD54                                                         
         MVC   L'P1*2+00(L'DEMNNAME,R6),DASHES                                  
         MVC   L'P1*2+10(5,R6),DASHES                                           
         AHI   R6,16                                                            
         AHI   R4,4                                                             
         BCT   R5,HEDBLD52                                                      
         B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* Program/product recap report headlines                              *         
***********************************************************************         
                                                                                
HEDBLD6  MVC   HEAD8(L'DPSLDESC),DPSLDESC                                       
         LARL  RF,PGMHD1           A(HEADLINES)                                 
         MVC   HEAD10,000(RF)                                                   
         MVC   HEAD11,L'P1(RF)                                                  
         MVC   HEAD12,L'P1*2(RF)                                                
         B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* Summary report headlines                                            *         
***********************************************************************         
                                                                                
HEDBLD7  CLI   PBMODE,PBMDPTQ                                                   
         BNE   *+14                                                             
         MVC   HEAD8(29),=C'**Overall Daypart Balancing**'                      
         B     HEDBLD31                                                         
         MVC   HEAD8(L'DPSLDESC),DPSLDESC                                       
         LA    RE,HEAD8+L'DPSLDESC-1                                            
         CLI   0(RE),SPACE                                                      
         BNE   *+8                                                              
         BCT   RE,*-8                                                           
         MVC   2(31,RE),=C'**Week by Week Goal Balancing**'                     
         B     HEDBLD31                                                         
                                                                                
***********************************************************************         
* POD change analysis report headlines                                *         
***********************************************************************         
                                                                                
HEDBLD8  LARL  RE,PCAHD1                                                        
         MVC   HEAD9(L'PCAHD1),0(RE)                                            
         MVC   HEAD10(L'PCAHD2),L'PCAHD1(RE)                                    
         MVC   HEAD11(L'PCAHD3),L'PCAHD1+L'PCAHD2(RE)                           
                                                                                
HEDBLDX  J     EXIT                                                             
         DROP  RB                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Build product table                                                 *         
*                                                                     *         
* Exit:  CC=not equal if product table built                          *         
***********************************************************************         
                                                                                
PRDBLD   NMOD1 PBWORKL,**PRDBLD,CLEAR=YES                                       
         LR    R5,RC                                                            
         USING PBWORKD,R5          R5=A(LOCAL WORKING STORAGE)                  
                                                                                
         LARL  RC,GLOBALS          POINT TO GLOBALS                             
                                                                                
         L     R0,PRDBUFF          CLEAR PRODUCT BUFFER                         
         LHI   R1,PTZBUFFL                                                      
         MHI   R1,MAXPRDS                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         XC    HIGHPRDN,HIGHPRDN   CLEAR HIGH PRODUCT                           
         XC    CORPDEM,CORPDEM     CLEAR BASE DEMO                              
         XC    APOLPRD,APOLPRD     CLEAR A(POL ENTRY)                           
                                                                                
         LA    R0,PBIOA                                                         
         ST    R0,AREC             SET A(I/O AREA FOR READING)                  
                                                                                
         L     R8,PRDBUFF                                                       
         USING PTBUFFD,R8          R8=A(PRODUCT ENTRY)                          
         EJECT                                                                  
***********************************************************************         
* If QEST=NO or range of estimates read POL estimate records and      *         
* build a list of all estimates that qualify in PBESTLST else use     *         
* requested estimate number                                           *         
***********************************************************************         
                                                                                
         MVC   PBESTLST(L'BEST),BEST                                            
                                                                                
         CLI   QESTEND,C' '        TEST ESTIMATE RANGE OR FILTER                
         BNE   *+14                                                             
         CLC   NOL,QEST                                                         
         BNE   PRDBLD08                                                         
                                                                                
         LA    R4,KEY              READ ESTIMATES AND BUILD A LIST              
         USING ESTHDR,R4                                                        
         XC    EKEY,EKEY                                                        
         MVC   EKEYAM,BAGYMD                                                    
         MVC   EKEYCLT,BCLT                                                     
         MVC   EKEYPRD,POLPRDL     SET TO READ 'POL' ESTIMATES                  
         LA    R2,PBESTLST         R2=A(ESTIMATE LIST)                          
         MVI   0(R2),0                                                          
                                                                                
         CLC   NOL,QEST                                                         
         BE    PRDBLD02                                                         
         MVC   EKEYEST,BEST                                                     
         B     PRDBLD04                                                         
                                                                                
PRDBLD02 LA    R4,KEY              BUMP ESTIMATE NUMBER IN KEY                  
         CLI   EKEYEST,255         TEST HIGHEST ESTIMATE JUST READ              
         BE    PRDBLD06                                                         
         IC    R0,EKEYEST          BUMP ESTIMATE NUMBER IN KEY                  
         AHI   R0,1                                                             
         STC   R0,EKEYEST                                                       
         XC    EKEYREST,EKEYREST                                                
                                                                                
         CLC   NOL,QEST            TEST ESTIMATE FILTERS                        
         BE    PRDBLD04                                                         
         CLC   EKEYEST,BESTEND     TEST RANGE EXCEEDED                          
         BH    PRDBLD06                                                         
                                                                                
PRDBLD04 MVC   KEYSAVE,KEY         READ FOR FIRST/NEXT ESTIMATE                 
         GOTOR DATAMGR,DMCB,DMRDHI,SPTDIR,EKEY,EKEY,XA=OFF                      
                                                                                
         CLC   EKEY(EKEYEST-ESTHDR),KEYSAVE                                     
         BNE   PRDBLD06                                                         
         OC    EKEYREST,EKEYREST   (ENSURE AN ESTIMATE RECORD)                  
         BNZ   PRDBLD02                                                         
                                                                                
         GOTOR DATAMGR,DMCB,GETREC,SPTFILE,EKDA,AREC,DMWORK,XA=OFF              
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R4,AREC                                                          
         CLC   EEND,QSTART         APPLY DATE FILTERS                           
         BL    PRDBLD02                                                         
         CLC   ESTART,QEND                                                      
         BH    PRDBLD02                                                         
                                                                                
         GOTOR FLTEST              APPLY ESTIMATE FILTERS IF REQUIRED           
         BNE   PRDBLD02                                                         
         MVC   0(L'EKEYEST,R2),EKEYEST                                          
         AHI   R2,L'EKEYEST                                                     
         B     PRDBLD02                                                         
                                                                                
PRDBLD06 CLI   PBESTLST,0          TEST ANY POL ESTIMATES FOUND                 
         BE    PRDBLDX             NO - EXIT                                    
         EJECT                                                                  
***********************************************************************         
* Build a list of products that have estimates for this request by    *         
* reading through product alpha passives - product table is built in  *         
* alpha sequence apart from POL which will always be the last entry   *         
***********************************************************************         
                                                                                
PRDBLD08 LA    R4,KEY                                                           
         USING PLSTPSSV,R4                                                      
         XC    PLSTPSSV,PLSTPSSV                                                
         MVI   PLSTTYPE,PLSTTYPQ                                                
         MVI   PLSTSUB,PLSTSUBQ                                                 
         MVC   PLSTAM,BAGYMD                                                    
         MVC   PLSTCLT,BCLT                                                     
                                                                                
PRDBLD10 LA    R4,KEY              BUMP TO FIRST/NEXT PRODUCT CODE              
         IC    R0,PLSTPRD+L'PLSTPRD-1                                           
         AHI   R0,1                                                             
         STC   R0,PLSTPRD+L'PLSTPRD-1                                           
         XC    PLSTBPRD(L'PLSTBPRD+L'PLSTREST),PLSTBPRD                         
                                                                                
         MVC   KEYSAVE,KEY                                                      
         GOTOR DATAMGR,DMCB,DMRDHI,SPTDIR,KEY,KEY,XA=OFF                        
         CLC   PLSTPSSV(PLSTXFF-PLSTPSSV),KEYSAVE                               
         BNE   PRDBLDX                                                          
         MVC   KEYSAVE,KEY         SAVE PASSIVE PRODUCT KEY                     
                                                                                
         GOTOR DATAMGR,DMCB,GETREC,SPTFILE,PKDA,AREC,DMWORK,XA=OFF              
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R4,AREC                                                          
         USING PRDHDR,R4           R4=A(PRODUCT RECORD)                         
                                                                                
***********************************************************************         
* Read estimates for the product just found using the POL estimate    *         
* list built above                                                    *         
***********************************************************************         
                                                                                
B        USING PTBUFFD,PBBUILD     BUILD PRODUCT BUFFER ENTRY                   
         XC    B.PTBUFFD(PTZBUFFL),B.PTBUFFD                                    
         MVC   B.PTPRDN,PCODE+1    SET PRODUCT NUMBER                           
         MVC   B.PTPRDA,PKEYPRD    SET PRODUCT CODE                             
         MVC   B.PTNAME,PNAME      SET PRODUCT NAME                             
         MVC   B.PTCLASS,PCLASS    SET PRODUCT CLASS                            
         CLI   B.PTCLASS,SPACE                                                  
         BH    *+8                                                              
         MVI   B.PTCLASS,0                                                      
                                                                                
         MVC   PBPKEY,PKEY         SAVE PRODUCT KEY                             
         LA    R2,PBESTLST         R2=A(ESTIMATE LIST)                          
         LHI   R3,L'PBESTLST       R3=MAXIMUM NUMBER OF ESTIMATES               
         NI    PBFLAG,FF-(PBFESTF) SET NO ESTIMATES FOUND                       
                                                                                
PRDBLD12 LA    R7,KEY                                                           
         USING EKEY,R7                                                          
         MVC   EKEY,PBPKEY         USE PRODUCT KEY AS MODEL                     
         MVC   EKEYEST,0(R2)       SET ESTIMATE NUMBER                          
         GOTOR DATAMGR,DMCB,DMREAD,SPTDIR,EKEY,EKEY,XA=OFF                      
         BNE   PRDBLD30                                                         
                                                                                
         GOTOR DATAMGR,DMCB,GETREC,SPTFILE,EKDA,AREC,DMWORK,XA=OFF              
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R7,AREC             POINT TO ESTIMATE RECORD                     
         OI    PBFLAG,PBFESTF      SET ESTIMATE FOUND                           
                                                                                
         MVC   B.PTZDEM(L'EDEMLST),EDEMLST                                      
         MVC   B.PTZDEM+L'EDEMLST(L'EDEMLST1),EDEMLST1                          
         MVC   B.PTZDEM+L'EDEMLST+L'EDEMLST1(L'EDEMLST2),EDEMLST2               
         MVC   B.PTZWGHT(L'EWGTLST),EWGTLST                                     
         MVC   B.PTZWGHT+L'EWGTLST(L'EWGTLST2),EWGTLST2                         
                                                                                
         LA    RE,ETRGLST          TEST TARGET DEMOS PRESENT                    
         OC    0(L'PTDEMNO,RE),0(RE)                                            
         BNZ   PRDBLD14                                                         
         CLI   TARGOPTN,YESQ       TEST PROFILE SET TO USE EST DEMOS            
         BNE   PRDBLD14                                                         
         LA    RE,EDEMLST          YES - POINT TO ESTIMATE DEMO LIST            
PRDBLD14 LA    R1,B.PTTRGS         R1=A(TARGET DEMO INDEX)                      
         LA    R0,L'PTTRGS         R0=NUMBER OF TARGET DEMOS                    
         XC    B.PTTRGS,B.PTTRGS   INITIALIZE TARGET DEMOS                      
PRDBLD16 CLI   0(RE),FF            TEST END OF LIST                             
         BE    PRDBLD24                                                         
         OC    0(L'PTDEMNO,RE),0(RE)                                            
         BZ    PRDBLD22                                                         
         LA    RF,B.PTDEMO         RF=A(DEMO LIST)                              
         LHI   R6,1                R0=INDEX VALUE (1 OR 2)                      
PRDBLD18 CLC   0(L'B.PTDEMNO,RE),0(RF)                                          
         BE    PRDBLD20                                                         
         AHI   RF,L'B.PTDEMNO                                                   
         AHI   R6,1                                                             
         B     PRDBLD18                                                         
PRDBLD20 STC   R6,0(R1)            SET DEMO POSITION NUMBER IN PTTRGS           
PRDBLD22 AHI   RE,L'PTDEMNO        NEXT TARGET                                  
         AHI   R1,1                                                             
         BCT   R0,PRDBLD16                                                      
                                                                                
PRDBLD24 CLI   GDEMOPTN,YESQ       TEST OPTION TO FORCE TO RATINGS              
         BNE   PRDBLD30                                                         
         LA    RE,B.PTDEMNO        YES - ADJUST DEMOS                           
         USING PTDEMNO,RE                                                       
         LHI   R0,PTZDEMMX                                                      
PRDBLD26 CLI   PTDEMNO,FF          TEST END OF LIST                             
         BE    PRDBLD30                                                         
         OC    PTDEMNO,PTDEMNO     TEST DEMO SLOT USED                          
         BZ    PRDBLD28                                                         
         CLI   PTDEMTYP,USERDEMO   SKIP USER DEMOS                              
         BE    PRDBLD28                                                         
         MVI   PTDEMTYP,PTDEMRQ    SET TO RATING                                
PRDBLD28 AHI   RE,L'PTDEMNO        NEXT DEMO                                    
         BCT   R0,PRDBLD26                                                      
         DROP  RE                                                               
                                                                                
PRDBLD30 AHI   R2,1                BUMP TO NEXT ESTIMATE                        
         CLI   0(R2),0             TEST END OF ESTIMATE LIST                    
         BE    *+8                                                              
         BCT   R3,PRDBLD12         DO FOR MAXIMUM NUMBER OF ESTIMATES           
                                                                                
         MVC   KEY,KEYSAVE         RESTORE LAST PRODUCT KEY                     
                                                                                
         TM    PBFLAG,PBFESTF      TEST ANY ESTIMATES FOUND FOR PRODUCT         
         BZ    PRDBLD10            NO - GET NEXT PRODUCT                        
                                                                                
         CLC   B.PTPRDA,POLPRDL    TEST THIS IS THE POL PRODUCT ENTRY           
         BNE   PRDBLD32                                                         
         MVC   CORPDEM,B.PTDEMNO   YES - SAVE BASE (CORPORATE) DEMO             
         LA    R0,PTBUFFD                                                       
         ST    R0,APOLPRD          SET A(POL PRODUCT ENTRY)                     
         OI    PBFLAG,PBFPOLF      SET POL PRODUCT FOUND                        
                                                                                
PRDBLD32 LH    R0,HIGHPRDN         ALLOCATE NEXT NUMBER TO PRODUCT              
         AHI   R0,1                                                             
         CHI   R0,MAXPRDS          INCREASE MAXPRDS VALUE                       
         BNH   *+6                                                              
         DC    H'0'                                                             
         STH   R0,HIGHPRDN         SET HIGHEST PRODUCT NUMBER USED              
         MVC   PTBUFFD(PTZBUFFL),B.PTBUFFD                                      
         AH    R8,PRDBUFLN         BUMP TO NEXT PRODUCT BUFFER ENTRY            
         B     PRDBLD10            GET NEXT PRODUCT                             
         DROP  B                                                                
                                                                                
PRDBLDX  TM    PBFLAG,PBFPOLF      TEST POL PRODUCT FOUND                       
         BNZ   *+10                                                             
         XC    HIGHPRDN,HIGHPRDN   NO - CLEAR HIGH PRODUCT                      
         OC    HIGHPRDN,HIGHPRDN   SET CC FOR CALLER                            
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Filter estimates on filter values in QESTEND if required            *         
***********************************************************************         
                                                                                
FLTEST   CLC   NOL,QEST            INCLUDE IF SINGLE/RANGE OF ESTIMATES         
         BNE   FLTESTY                                                          
         CLC   QESTEND,SPACES      INCLUDE IF NO FILTERS                        
         BE    FLTESTY                                                          
         LA    R1,QESTEND                                                       
         LA    RF,EPROF                                                         
         LHI   R0,L'QESTEND                                                     
                                                                                
FLTEST02 CLI   0(R1),C'*'          TEST WILD CARDS                              
         BE    FLTEST06                                                         
         CLI   0(R1),C' '                                                       
         BE    FLTEST06                                                         
         TM    0(R1),X'40'         TEST NEGATIVE FILTERS                        
         BZ    FLTEST04                                                         
         CLC   0(1,R1),0(RF)       POSITIVE FILTER MUST MATCH                   
         BNE   FLTESTN                                                          
         B     FLTEST06                                                         
                                                                                
FLTEST04 MVC   BYTE,0(R1)          NEGATIVE FILTER MATCH                        
         OI    BYTE,C' '                                                        
         CLC   BYTE,0(RF)          NEGATIVE FILTER MUST NOT MATCH               
         BE    FLTESTN                                                          
                                                                                
FLTEST06 AHI   R1,1                BUMP AND DO FOR NUMBER OF FILTERS            
         AHI   RF,1                                                             
         BCT   R0,FLTEST02                                                      
                                                                                
FLTESTY  CR    RE,RE               CC=EQUAL TO INCLUDE                          
         BR    RE                                                               
                                                                                
FLTESTN  LTR   RE,RE               CC=NOT EQUAL TO EXCLUDE                      
         BR    RE                                                               
         DROP  R4,R5,R7,R8,RB                                                   
                                                                                
PTFIRST  DC    X'00'               FIRST TIME FLAG                              
         LTORG                                                                  
                                                                                
PBWORKD  DSECT                     ** PRDBLD LOCAL WORKING STORAGE **           
PBBUILD  DS    XL(PTZBUFFL)        BUILD AREA                                   
PBFLAG   DS    X                   ** FLAG BYTE **                              
PBFESTF  EQU   X'80'               ESTIMATE(S) FOUND                            
PBFPOLF  EQU   X'40'               POL PRODUCT FOUND                            
PBPKEY   DS    XL(L'PKEY)          PRODUCT KEY                                  
PBESTLST DS    XL256               POL ESTIMATE LIST                            
PBIOA    DS    XL2000              I/O AREA FOR ESTIMATE/PRODUCT READS          
PBWORKL  EQU   *-PBWORKD                                                        
SPK502   CSECT                                                                  
         EJECT                                                                  
         DS    0D                                                               
         DC    C'**BUF1**'                                                      
BUFF1    BUFFD TYPE=D,KEYLEN=0,COMLEN=0,FILE=BUFFWK,BUFFERS=100                 
                                                                                
         DS    0D                                                               
         DC    C'**BUF2**'                                                      
BUFF2    BUFFD TYPE=D,KEYLEN=0,COMLEN=0,FILE=SORTWK01,BUFFERS=100               
                                                                                
         DS    0D                                                               
         DC    C'**BUF3**'                                                      
BUFF3    BUFFD TYPE=D,KEYLEN=0,COMLEN=0,FILE=BUFFWK1,BUFFERS=20                 
                                                                                
DAYTAB   DS    0H                  ** DAY CONVERSION TABLE **                   
         DC    X'4001'             MON                                          
         DC    X'2002'             TUE                                          
         DC    X'1003'             WED                                          
         DC    X'0804'             THU                                          
         DC    X'0405'             FRI                                          
         DC    X'0206'             SAT                                          
         DC    X'0107'             SUN                                          
         DC    X'7C08'             MON-FRI                                      
         DC    X'7F09'             MON-SUN                                      
DAYTABN  EQU   (*-DAYTAB)/L'DAYTAB                                              
         DC    X'FF0A'             OTHERS                                       
                                                                                
***********************************************************************         
* Table of column spacing controls (# of weeks is index)              *         
*                                                                     *         
* Table is indexed by week number - each entry contains 2 sets of     *         
* values:                                                             *         
*                                                                     *         
* Byte 1 - Start of row desc                                          *         
* Byte 2 - Over to total column                                       *         
* Byte 3 - Column spacing                                             *         
***********************************************************************         
                                                                                
         DS    0H                                                               
SRLTAB   DS    0XL6                                                             
*                                                                               
*                  Regular       NAD                                            
*                  Report        Report                                         
*                                                                               
         DC    AL1(13,18,12),AL1(13,18,12)       1                              
         DC    AL1(13,18,12),AL1(13,18,12)       2                              
         DC    AL1(12,18,12),AL1(12,18,12)       3                              
         DC    AL1(11,18,12),AL1(11,18,12)       4                              
         DC    AL1(10,18,12),AL1(10,18,12)       5                              
         DC    AL1(09,18,12),AL1(09,18,12)       6                              
         DC    AL1(08,18,12),AL1(08,18,12)       7                              
         DC    AL1(07,18,11),AL1(07,18,11)       8                              
         DC    AL1(06,18,11),AL1(06,18,11)       9                              
         DC    AL1(05,15,10),AL1(05,18,10)       10                             
         DC    AL1(04,15,10),AL1(04,18,10)       11                             
         DC    AL1(03,15,09),AL1(03,18,09)       12                             
         DC    AL1(02,15,08),AL1(02,18,08)       13                             
         DC    AL1(01,15,08),AL1(01,18,08)       14                             
         DC    AL1(00,12,08),AL1(00,00,00)       15                             
                                                                                
***********************************************************************         
* Table of column spacing controls (# of weeks is index)              *         
*                                                                     *         
* Byte 1 - Start of row desc                                          *         
* Byte 2 - Over to total column                                       *         
* Byte 3 - Column spacing                                             *         
***********************************************************************         
                                                                                
         DS    0H                                                               
RSLTAB   DS    0XL3                                                             
         DC    AL1(05,30,12)       1                                            
         DC    AL1(05,30,12)       2                                            
         DC    AL1(05,30,12)       3                                            
         DC    AL1(05,30,12)       4                                            
         DC    AL1(05,30,12)       5                                            
         DC    AL1(05,30,12)       6                                            
         DC    AL1(08,18,12)       7                                            
         DC    AL1(07,18,11)       8                                            
         DC    AL1(06,18,11)       9                                            
         DC    AL1(05,15,10)       10                                           
         DC    AL1(04,15,10)       11                                           
         DC    AL1(03,15,09)       12                                           
         DC    AL1(02,15,09)       13                                           
         DC    AL1(01,15,08)       14                                           
         DC    AL1(00,12,08)       15                                           
                                                                                
***********************************************************************         
* Translate table for rec types - GBTYP.  position of code is index   *         
* to word in summary record row                                       *         
***********************************************************************         
                                                                                
SCELLS   DS    0AL1                                                             
         DC    AL1(TGOLDOLQ)                                                    
         DC    AL1(TGOLDEMQ)                                                    
         DC    AL1(TRSCGOLQ)                                                    
         DC    AL1(TACHUNTQ)                                                    
         DC    AL1(TPREUNTQ)                                                    
         DC    AL1(TACHDOLQ)                                                    
         DC    AL1(TPREDOLQ)                                                    
         DC    AL1(TACHDEMQ)                                                    
         DC    AL1(TPREDEMQ)                                                    
         DC    AL1(TACHT01Q)                                                    
         DC    AL1(TPRET01Q)                                                    
         DC    AL1(TACHT02Q)                                                    
         DC    AL1(TPRET02Q)                                                    
         DC    AL1(TACHT03Q)                                                    
         DC    AL1(TPRET03Q)                                                    
         DC    AL1(TACHT04Q)                                                    
         DC    AL1(TPRET04Q)                                                    
         DC    AL1(TACHT05Q)                                                    
         DC    AL1(TPRET05Q)                                                    
         DC    AL1(TACHT06Q)                                                    
         DC    AL1(TPRET06Q)                                                    
         DC    AL1(TACHT07Q)                                                    
         DC    AL1(TPRET07Q)                                                    
         DC    AL1(TACHT08Q)                                                    
         DC    AL1(TPRET08Q)                                                    
         DC    AL1(TACHT09Q)                                                    
         DC    AL1(TPRET09Q)                                                    
         DC    AL1(TACHT10Q)                                                    
         DC    AL1(TPRET10Q)                                                    
         DC    AL1(TACHT11Q)                                                    
         DC    AL1(TPRET11Q)                                                    
         DC    AL1(TACHT12Q)                                                    
         DC    AL1(TPRET12Q)                                                    
         DC    AL1(TACHT13Q)                                                    
         DC    AL1(TPRET13Q)                                                    
         DC    AL1(TACHT14Q)                                                    
         DC    AL1(TPRET14Q)                                                    
         DC    AL1(TACHT15Q)                                                    
         DC    AL1(TPRET15Q)                                                    
         DC    AL1(TACHT16Q)                                                    
         DC    AL1(TPRET16Q)                                                    
         DC    AL1(TACHT17Q)                                                    
         DC    AL1(TPRET17Q)                                                    
         DC    AL1(TACHT18Q)                                                    
         DC    AL1(TPRET18Q)                                                    
         DC    AL1(TACHT19Q)                                                    
         DC    AL1(TPRET19Q)                                                    
         DC    AL1(TACHT20Q)                                                    
         DC    AL1(TPRET20Q)                                                    
         DC    AL1(TACHT21Q)                                                    
         DC    AL1(TPRET21Q)                                                    
         DC    AL1(TACHT22Q)                                                    
         DC    AL1(TPRET22Q)                                                    
         DC    AL1(TACHT23Q)                                                    
         DC    AL1(TPRET23Q)                                                    
         DC    AL1(TACHT24Q)                                                    
         DC    AL1(TPRET24Q)                                                    
         DC    AL1(TACHT25Q)                                                    
         DC    AL1(TPRET25Q)                                                    
         DC    AL1(TACHT26Q)                                                    
         DC    AL1(TPRET26Q)                                                    
         DC    AL1(TACHT27Q)                                                    
         DC    AL1(TPRET27Q)                                                    
         DC    AL1(TACHT28Q)                                                    
         DC    AL1(TPRET28Q)                                                    
         DC    AL1(TACHT29Q)                                                    
         DC    AL1(TPRET29Q)                                                    
         DC    AL1(TACHT30Q)                                                    
         DC    AL1(TPRET30Q)                                                    
         DC    AL1(TACHT31Q)                                                    
         DC    AL1(TPRET31Q)                                                    
         DC    AL1(TACHT32Q)                                                    
         DC    AL1(TPRET32Q)                                                    
         DC    AL1(TACHT33Q)                                                    
         DC    AL1(TPRET33Q)                                                    
         DC    AL1(TACHT34Q)                                                    
         DC    AL1(TPRET34Q)                                                    
         DC    AL1(TACHT35Q)                                                    
         DC    AL1(TPRET35Q)                                                    
         DC    AL1(TACHT36Q)                                                    
         DC    AL1(TPRET36Q)                                                    
         DC    AL1(TACHT37Q)                                                    
         DC    AL1(TPRET37Q)                                                    
         DC    AL1(TACHT38Q)                                                    
         DC    AL1(TPRET38Q)                                                    
         DC    AL1(TACHT39Q)                                                    
         DC    AL1(TPRET39Q)                                                    
         DC    AL1(TACHT40Q)                                                    
         DC    AL1(TPRET40Q)                                                    
         DC    AL1(TACHT41Q)                                                    
         DC    AL1(TPRET41Q)                                                    
         DC    AL1(TACHT42Q)                                                    
         DC    AL1(TPRET42Q)                                                    
         DC    AL1(TACHT43Q)                                                    
         DC    AL1(TPRET43Q)                                                    
         DC    AL1(TACHT44Q)                                                    
         DC    AL1(TPRET44Q)                                                    
         DC    AL1(TACHT45Q)                                                    
         DC    AL1(TPRET45Q)                                                    
         DC    AL1(TACHT46Q)                                                    
         DC    AL1(TPRET46Q)                                                    
         DC    AL1(TACHT47Q)                                                    
         DC    AL1(TPRET47Q)                                                    
         DC    AL1(TACHT48Q)                                                    
         DC    AL1(TPRET48Q)                                                    
         DC    AL1(TACHT49Q)                                                    
         DC    AL1(TPRET49Q)                                                    
         DC    AL1(TACHT50Q)                                                    
         DC    AL1(TPRET50Q)                                                    
SCELLSX  DC    AL1(FF)                                                          
                                                                                
         DS    0H                                                               
TYPTAB   DS    0XL10               ** GBTYP NAMES **                            
         DC    AL1(TGOLDOLQ),C'Goal-$   '                                       
         DC    AL1(TGOLDEMQ),C'Goal-Demo'                                       
         DC    AL1(TRSCGOLQ),C'Rescale  '                                       
         DC    AL1(TACHUNTQ),C'Ach -Unit'                                       
         DC    AL1(TPREUNTQ),C'Pre -Unit'                                       
         DC    AL1(TACHDOLQ),C'Ach -$   '                                       
         DC    AL1(TPREDOLQ),C'Pre -$   '                                       
         DC    AL1(TACHDEMQ),C'Ach -Demo'                                       
         DC    AL1(TPREDEMQ),C'Pre -Demo'                                       
         DC    AL1(TGOLUNTQ),C'Goal-Unit'                                       
         DC    AL1(TACHT01Q),C'Ach -T1  '                                       
         DC    AL1(TPRET01Q),C'Pre -T1  '                                       
         DC    AL1(TACHT02Q),C'Ach -T2  '                                       
         DC    AL1(TPRET02Q),C'Pre -T2  '                                       
         DC    AL1(TACHT03Q),C'Ach -T3  '                                       
         DC    AL1(TPRET03Q),C'Pre -T3  '                                       
         DC    AL1(TACHT04Q),C'Ach -T4  '                                       
         DC    AL1(TPRET04Q),C'Pre -T4  '                                       
         DC    AL1(TACHT05Q),C'Ach -T5  '                                       
         DC    AL1(TPRET05Q),C'Pre -T5  '                                       
         DC    AL1(TACHT06Q),C'Ach -T6  '                                       
         DC    AL1(TPRET06Q),C'Pre -T6  '                                       
         DC    AL1(TACHT07Q),C'Ach -T7  '                                       
         DC    AL1(TPRET07Q),C'Pre -T7  '                                       
         DC    AL1(TACHT08Q),C'Ach -T8  '                                       
         DC    AL1(TPRET08Q),C'Pre -T8  '                                       
         DC    AL1(TACHT09Q),C'Ach -T9  '                                       
         DC    AL1(TPRET09Q),C'Pre -T9  '                                       
         DC    AL1(TACHT10Q),C'Ach -T10 '                                       
         DC    AL1(TPRET10Q),C'Pre -T10 '                                       
         DC    AL1(TACHT11Q),C'Ach -T11 '                                       
         DC    AL1(TPRET11Q),C'Pre -T11 '                                       
         DC    AL1(TACHT12Q),C'Ach -T12 '                                       
         DC    AL1(TPRET12Q),C'Pre -T12 '                                       
         DC    AL1(TACHT13Q),C'Ach -T13 '                                       
         DC    AL1(TPRET13Q),C'Pre -T13 '                                       
         DC    AL1(TACHT14Q),C'Ach -T14 '                                       
         DC    AL1(TPRET14Q),C'Pre -T14 '                                       
         DC    AL1(TACHT15Q),C'Ach -T15 '                                       
         DC    AL1(TPRET15Q),C'Pre -T15 '                                       
         DC    AL1(TACHT16Q),C'Ach -T16 '                                       
         DC    AL1(TPRET16Q),C'Pre -T16 '                                       
         DC    AL1(TACHT17Q),C'Ach -T17 '                                       
         DC    AL1(TPRET17Q),C'Pre -T17 '                                       
         DC    AL1(TACHT18Q),C'Ach -T18 '                                       
         DC    AL1(TPRET18Q),C'Pre -T18 '                                       
         DC    AL1(TACHT19Q),C'Ach -T19 '                                       
         DC    AL1(TPRET19Q),C'Pre -T19 '                                       
         DC    AL1(TACHT20Q),C'Ach -T20 '                                       
         DC    AL1(TPRET20Q),C'Pre -T20 '                                       
         DC    AL1(TACHT21Q),C'Ach -T21 '                                       
         DC    AL1(TPRET21Q),C'Pre -T21 '                                       
         DC    AL1(TACHT22Q),C'Ach -T22 '                                       
         DC    AL1(TPRET22Q),C'Pre -T22 '                                       
         DC    AL1(TACHT23Q),C'Ach -T23 '                                       
         DC    AL1(TPRET23Q),C'Pre -T23 '                                       
         DC    AL1(TACHT24Q),C'Ach -T24 '                                       
         DC    AL1(TPRET24Q),C'Pre -T24 '                                       
         DC    AL1(TACHT25Q),C'Ach -T25 '                                       
         DC    AL1(TPRET25Q),C'Pre -T25 '                                       
         DC    AL1(TACHT26Q),C'Ach -T26 '                                       
         DC    AL1(TPRET26Q),C'Pre -T26 '                                       
         DC    AL1(TACHT27Q),C'Ach -T27 '                                       
         DC    AL1(TPRET27Q),C'Pre -T27 '                                       
         DC    AL1(TACHT28Q),C'Ach -T28 '                                       
         DC    AL1(TPRET28Q),C'Pre -T28 '                                       
         DC    AL1(TACHT29Q),C'Ach -T29 '                                       
         DC    AL1(TPRET29Q),C'Pre -T29 '                                       
         DC    AL1(TACHT30Q),C'Ach -T30 '                                       
         DC    AL1(TPRET30Q),C'Pre -T30 '                                       
         DC    AL1(TACHT31Q),C'Ach -T31 '                                       
         DC    AL1(TPRET31Q),C'Pre -T31 '                                       
         DC    AL1(TACHT32Q),C'Ach -T32 '                                       
         DC    AL1(TPRET32Q),C'Pre -T32 '                                       
         DC    AL1(TACHT33Q),C'Ach -T33 '                                       
         DC    AL1(TPRET33Q),C'Pre -T33 '                                       
         DC    AL1(TACHT34Q),C'Ach -T34 '                                       
         DC    AL1(TPRET34Q),C'Pre -T34 '                                       
         DC    AL1(TACHT35Q),C'Ach -T35 '                                       
         DC    AL1(TPRET35Q),C'Pre -T35 '                                       
         DC    AL1(TACHT36Q),C'Ach -T36 '                                       
         DC    AL1(TPRET36Q),C'Pre -T36 '                                       
         DC    AL1(TACHT37Q),C'Ach -T37 '                                       
         DC    AL1(TPRET37Q),C'Pre -T37 '                                       
         DC    AL1(TACHT38Q),C'Ach -T38 '                                       
         DC    AL1(TPRET38Q),C'Pre -T38 '                                       
         DC    AL1(TACHT39Q),C'Ach -T39 '                                       
         DC    AL1(TPRET39Q),C'Pre -T39 '                                       
         DC    AL1(TACHT40Q),C'Ach -T40 '                                       
         DC    AL1(TPRET40Q),C'Pre -T40 '                                       
         DC    AL1(TACHT41Q),C'Ach -T41 '                                       
         DC    AL1(TPRET41Q),C'Pre -T41 '                                       
         DC    AL1(TACHT42Q),C'Ach -T42 '                                       
         DC    AL1(TPRET42Q),C'Pre -T42 '                                       
         DC    AL1(TACHT43Q),C'Ach -T43 '                                       
         DC    AL1(TPRET43Q),C'Pre -T43 '                                       
         DC    AL1(TACHT44Q),C'Ach -T44 '                                       
         DC    AL1(TPRET44Q),C'Pre -T44 '                                       
         DC    AL1(TACHT45Q),C'Ach -T45 '                                       
         DC    AL1(TPRET45Q),C'Pre -T45 '                                       
         DC    AL1(TACHT46Q),C'Ach -T46 '                                       
         DC    AL1(TPRET46Q),C'Pre -T46 '                                       
         DC    AL1(TACHT47Q),C'Ach -T47 '                                       
         DC    AL1(TPRET47Q),C'Pre -T47 '                                       
         DC    AL1(TACHT48Q),C'Ach -T48 '                                       
         DC    AL1(TPRET48Q),C'Pre -T48 '                                       
         DC    AL1(TACHT49Q),C'Ach -T49 '                                       
         DC    AL1(TPRET49Q),C'Pre -T49 '                                       
         DC    AL1(TACHT50Q),C'Ach -T50 '                                       
         DC    AL1(TPRET50Q),C'Pre -T50 '                                       
TYPTABX  DC    AL1(FF),C'*Unknown '                                             
                                                                                
PODDSC   DS    0H                  ** POD RUN DESCRIPTIONS **                   
                                                                                
*                                  ** POD TYPE A **                             
PODA     DC    AL1(SECS15,SECS30,SECS45,SECS60,SECS90)                          
PODANUM  EQU   *-PODA                                                           
         DC    (PODLENN-PODANUM)AL1(FF)                                         
         DC    AL2(PODANUM)                                                     
         DC    AL2(SECS90)                                                      
         DC    AL2(SECS30)                                                      
         DC    CL(L'PODPRNT)'15,30,45,60,90'                                    
                                                                                
*                                  ** POD TYPE B **                             
PODB     DC    AL1(SECS20,SECS30,SECS60)                                        
PODBNUM  EQU   *-PODB                                                           
         DC    (PODLENN-PODBNUM)AL1(FF)                                         
         DC    AL2(PODBNUM)                                                     
         DC    AL2(SECS60)                                                      
         DC    AL2(SECS30)                                                      
         DC    CL(L'PODPRNT)'20,30,60'                                          
                                                                                
*                                  ** POD TYPE C **                             
PODC     DC    AL1(SECS10,SECS20,SECS30,SECS60)                                 
PODCNUM  EQU   *-PODC                                                           
         DC    (PODLENN-PODCNUM)AL1(FF)                                         
         DC    AL2(PODCNUM)                                                     
         DC    AL2(SECS60)                                                      
         DC    AL2(SECS30)                                                      
         DC    CL(L'PODPRNT)'10,20,30,60'                                       
                                                                                
*                                  ** POD TYPE D **                             
PODD     DC    AL1(SECS10,SECS15,SECS20,SECS30,SECS60)                          
PODDNUM  EQU   *-PODD                                                           
         DC    (PODLENN-PODDNUM)AL1(FF)                                         
         DC    AL2(PODDNUM)                                                     
         DC    AL2(SECS60)                                                      
         DC    AL2(SECS30)                                                      
         DC    CL(L'PODPRNT)'10,15,20,30,60'                                    
                                                                                
PODDSCN  EQU   (*-PODDSC)/PODDSCL NUMBER OF POD GROUPS                          
                                                                                
*                                  INDEX TO POD SPLITS FOR 'A' PODS             
PLAINDX  DC    AL1(SECS15),AL3(PLTBA15)                                         
         DC    AL1(SECS30),AL3(PLTBA30)                                         
         DC    AL1(SECS45),AL3(PLTBA45)                                         
         DC    AL1(SECS60),AL3(PLTBA60)                                         
         DC    AL1(SECS75),AL3(PLTBA75)                                         
         DC    AL1(SECS90),AL3(PLTBA90)                                         
         DC    AL1(FF)                                                          
                                                                                
*                                  INDEX TO POD SPLITS FOR 'B' PODS             
PLBINDX  DC    AL1(SECS20),AL3(PLTBB20)                                         
         DC    AL1(SECS30),AL3(PLTBB30)                                         
         DC    AL1(SECS40),AL3(PLTBB40)                                         
         DC    AL1(SECS50),AL3(PLTBB50)                                         
         DC    AL1(SECS60),AL3(PLTBB60)                                         
         DC    AL1(FF)                                                          
                                                                                
*                                  INDEX TO POD SPLITS FOR 'C' PODS             
PLCINDX  DC    AL1(SECS10),AL3(PLTBC10)                                         
         DC    AL1(SECS20),AL3(PLTBC20)                                         
         DC    AL1(SECS30),AL3(PLTBC30)                                         
         DC    AL1(SECS40),AL3(PLTBC40)                                         
         DC    AL1(SECS50),AL3(PLTBC50)                                         
         DC    AL1(SECS60),AL3(PLTBC60)                                         
         DC    AL1(FF)                                                          
                                                                                
*                                  INDEX TO POD SPLITS FOR 'D' PODS             
PLDINDX  DC    AL1(SECS10),AL3(PLTBD10)                                         
         DC    AL1(SECS25),AL3(PLTBD15)                                         
         DC    AL1(SECS20),AL3(PLTBD20)                                         
         DC    AL1(SECS25),AL3(PLTBD25)                                         
         DC    AL1(SECS30),AL3(PLTBD30)                                         
         DC    AL1(SECS35),AL3(PLTBD35)                                         
         DC    AL1(SECS40),AL3(PLTBD40)                                         
         DC    AL1(SECS45),AL3(PLTBD45)                                         
         DC    AL1(SECS50),AL3(PLTBD50)                                         
         DC    AL1(SECS55),AL3(PLTBD55)                                         
         DC    AL1(SECS60),AL3(PLTBD60)                                         
         DC    AL1(FF)                                                          
                                                                                
*                                  INDEX TO PSEUDO-POD SPLITS TYPE 'A'          
PPAINDX  DC    AL1(SECS15),AL3(PPTBA15)                                         
         DC    AL1(SECS30),AL3(PPTBA30)                                         
         DC    AL1(SECS45),AL3(PPTBA45)                                         
         DC    AL1(SECS60),AL3(PPTBA60)                                         
         DC    AL1(SECS75),AL3(PPTBA75)                                         
         DC    AL1(SECS90),AL3(PPTBA90)                                         
         DC    AL1(FF)                                                          
                                                                                
*                                  INDEX TO PSEUDO-POD SPLITS TYPE 'B'          
PPBINDX  DC    AL1(SECS20),AL3(PPTBB20)                                         
         DC    AL1(SECS30),AL3(PPTBB30)                                         
         DC    AL1(SECS40),AL3(PPTBB40)                                         
         DC    AL1(SECS50),AL3(PPTBB50)                                         
         DC    AL1(SECS60),AL3(PPTBB60)                                         
         DC    AL1(FF)                                                          
                                                                                
*                                  INDEX TO PSEUDO-POD SPLITS TYPE 'C'          
PPCINDX  DC    AL1(SECS10),AL3(PPTBC10)                                         
         DC    AL1(SECS20),AL3(PPTBC20)                                         
         DC    AL1(SECS30),AL3(PPTBC30)                                         
         DC    AL1(SECS40),AL3(PPTBC40)                                         
         DC    AL1(SECS50),AL3(PPTBC50)                                         
         DC    AL1(SECS60),AL3(PPTBC60)                                         
         DC    AL1(FF)                                                          
                                                                                
*                                  INDEX TO PSEUDO-POD SPLITS TYPE 'D'          
PPDINDX  DC    AL1(SECS10),AL3(PPTBD10)                                         
         DC    AL1(SECS25),AL3(PPTBD15)                                         
         DC    AL1(SECS20),AL3(PPTBD20)                                         
         DC    AL1(SECS25),AL3(PPTBD25)                                         
         DC    AL1(SECS30),AL3(PPTBD30)                                         
         DC    AL1(SECS35),AL3(PPTBD35)                                         
         DC    AL1(SECS40),AL3(PPTBD40)                                         
         DC    AL1(SECS45),AL3(PPTBD45)                                         
         DC    AL1(SECS50),AL3(PPTBD50)                                         
         DC    AL1(SECS55),AL3(PPTBD55)                                         
         DC    AL1(SECS60),AL3(PPTBD60)                                         
         DC    AL1(FF)                                                          
                                                                                
*                                  INDEX TO 'SPLITS' FOR NON-PODS               
PLXINDX  DC    AL1(00),AL3(PDRFXSPL)                                            
         DC    AL1(FF)                                                          
                                                                                
***********************************************************************         
* POD split combinations                                              *         
*                                                                     *         
* Format:  Count of lengths within split (1 byte)                     *         
*          Control (not used) (1 byte)                                *         
*          List of lengths with split (1 byte each)                   *         
*          FF - end of lengths for split                              *         
*                                                                     *         
* Note:  - PLTB entries are for regular pod runs                      *         
*        - PPTB entries are for pseudo-piggyback runs                 *         
*          in which no POD gets more than 2 brands                    *         
***********************************************************************         
                                                                                
*                                  'A' 15'S                                     
PLTBA15  DC    AL1(01,00)             15                                        
         DC    AL1(SECS15,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'A' 30'S                                     
PLTBA30  DC    AL1(01,00)             30                                        
         DC    AL1(SECS30,FF)                                                   
         DC    AL1(02,00)             15-15                                     
         DC    AL1(SECS15,SECS15,FF)                                            
         DC    AL1(FF)                                                          
*                                  'A' 45'S                                     
PLTBA45  DC    AL1(01,00)             45                                        
         DC    AL1(SECS45,FF)                                                   
         DC    AL1(02,00)             30-15                                     
         DC    AL1(SECS30,SECS15,FF)                                            
         DC    AL1(03,00)             15-15-15                                  
         DC    AL1(SECS15,SECS15,SECS15,FF)                                     
         DC    AL1(FF)                                                          
*                                  'A' 60'S                                     
PLTBA60  DC    AL1(01,00)             60                                        
         DC    AL1(SECS60,FF)                                                   
         DC    AL1(02,00)             45-15                                     
         DC    AL1(SECS45,SECS15,FF)                                            
         DC    AL1(02,00)             30-30                                     
         DC    AL1(SECS30,SECS30,FF)                                            
         DC    AL1(03,00)             30-15-15                                  
         DC    AL1(SECS30,SECS15,SECS15,FF)                                     
         DC    AL1(04,00)             15(4)                                     
         DC    AL1(SECS15,SECS15,SECS15,SECS15,FF)                              
         DC    AL1(FF)                                                          
*                                  'A' 75'S                                     
PLTBA75  DC    AL1(02,00)             60-15                                     
         DC    AL1(SECS60,SECS15,FF)                                            
         DC    AL1(02,00)             45-30                                     
         DC    AL1(SECS45,SECS30,FF)                                            
         DC    AL1(03,00)             45-15-15                                  
         DC    AL1(SECS45,SECS15,SECS15,FF)                                     
         DC    AL1(03,00)             30-30-15                                  
         DC    AL1(SECS30,SECS30,SECS15,FF)                                     
         DC    AL1(04,00)             30-15(3)                                  
         DC    AL1(SECS30,SECS15,SECS15,SECS15,FF)                              
         DC    AL1(05,00)             15(5)                                     
         DC    AL1(SECS15,SECS15,SECS15,SECS15,SECS15,FF)                       
         DC    AL1(FF)                                                          
*                                  'A' 90'S                                     
PLTBA90  DC    AL1(01,00)             90                                        
         DC    AL1(SECS90,FF)                                                   
         DC    AL1(02,00)             60-30                                     
         DC    AL1(SECS60,SECS30,FF)                                            
         DC    AL1(03,00)             60-15-15                                  
         DC    AL1(SECS60,SECS15,SECS15,FF)                                     
         DC    AL1(02,00)             45-45                                     
         DC    AL1(SECS45,SECS45,FF)                                            
         DC    AL1(03,00)             45-30-15                                  
         DC    AL1(SECS45,SECS30,SECS15,FF)                                     
         DC    AL1(04,00)             45-15-15-15                               
         DC    AL1(SECS45,SECS15,SECS15,SECS15,FF)                              
         DC    AL1(03,00)             30-30-30                                  
         DC    AL1(SECS30,SECS30,SECS30,FF)                                     
         DC    AL1(04,00)             30-30-15-15                               
         DC    AL1(SECS30,SECS30,SECS15,SECS15,FF)                              
         DC    AL1(05,00)             30-15(4)                                  
         DC    AL1(SECS30,SECS15,SECS15,SECS15,SECS15,FF)                       
         DC    AL1(06,00)             15(6)                                     
         DC    AL1(SECS15,SECS15,SECS15,SECS15,SECS15,SECS15,FF)                
         DC    AL1(FF)                                                          
*                                  'B' 20'S                                     
PLTBB20  DC    AL1(01,00)             20                                        
         DC    AL1(SECS20,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'B' 30'S                                     
PLTBB30  DC    AL1(01,00)             30                                        
         DC    AL1(SECS30,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'B' 40'S                                     
PLTBB40  DC    AL1(02,00)             20-20                                     
         DC    AL1(SECS20,SECS20,FF)                                            
         DC    AL1(FF)                                                          
*                                  'B' 50'S                                     
PLTBB50  DC    AL1(02,00)             30-20                                     
         DC    AL1(SECS30,SECS20,FF)                                            
         DC    AL1(FF)                                                          
*                                  'B' 60'S                                     
PLTBB60  DC    AL1(01,00)             60                                        
         DC    AL1(SECS60,FF)                                                   
         DC    AL1(02,00)             30-30                                     
         DC    AL1(SECS30,SECS30,FF)                                            
         DC    AL1(03,00)             20-20-20                                  
         DC    AL1(SECS20,SECS20,SECS20,FF)                                     
         DC    AL1(FF)                                                          
                                                                                
*                                  'C' 10'S                                     
PLTBC10  DC    AL1(01,00)             10                                        
         DC    AL1(SECS10,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'C' 20'S                                     
PLTBC20  DC    AL1(01,00)             20                                        
         DC    AL1(SECS20,FF)                                                   
         DC    AL1(02,00)             10-10                                     
         DC    AL1(SECS10,SECS10,FF)                                            
         DC    AL1(FF)                                                          
*                                  'C' 30'S                                     
PLTBC30  DC    AL1(01,00)             30                                        
         DC    AL1(SECS30,FF)                                                   
         DC    AL1(02,00)             20-10                                     
         DC    AL1(SECS20,SECS10,FF)                                            
         DC    AL1(03,00)             10-10-10                                  
         DC    AL1(SECS10,SECS10,SECS10,FF)                                     
         DC    AL1(FF)                                                          
*                                  'C' 40'S                                     
PLTBC40  DC    AL1(02,00)             30-10                                     
         DC    AL1(SECS30,SECS10,FF)                                            
         DC    AL1(02,00)             20-20                                     
         DC    AL1(SECS20,SECS20,FF)                                            
         DC    AL1(03,00)             20-10-10                                  
         DC    AL1(SECS20,SECS10,SECS10,FF)                                     
         DC    AL1(04,00)             10(4)                                     
         DC    AL1(SECS10,SECS10,SECS10,SECS10,FF)                              
         DC    AL1(FF)                                                          
*                                  'C' 50'S                                     
PLTBC50  DC    AL1(02,00)             30-20                                     
         DC    AL1(SECS30,SECS20,FF)                                            
         DC    AL1(03,00)             30-10-10                                  
         DC    AL1(SECS30,SECS10,SECS10,FF)                                     
         DC    AL1(04,00)             20-10(3)                                  
         DC    AL1(SECS20,SECS10,SECS10,SECS10,FF)                              
         DC    AL1(05,00)             10(5)                                     
         DC    AL1(SECS10,SECS10,SECS10,SECS10,SECS10,FF)                       
         DC    AL1(FF)                                                          
*                                  'C' 60'S                                     
PLTBC60  DC    AL1(01,00)             60                                        
         DC    AL1(SECS60,FF)                                                   
         DC    AL1(02,00)             30-30                                     
         DC    AL1(SECS30,SECS30,FF)                                            
         DC    AL1(03,00)             30-20-10                                  
         DC    AL1(SECS30,SECS20,SECS10,FF)                                     
         DC    AL1(04,00)             30-10(3)                                  
         DC    AL1(SECS30,SECS10,SECS10,SECS10,FF)                              
         DC    AL1(03,00)             20-20-20                                  
         DC    AL1(SECS20,SECS20,SECS20,FF)                                     
         DC    AL1(04,00)             20-20-10-10                               
         DC    AL1(SECS20,SECS20,SECS10,SECS10,FF)                              
         DC    AL1(05,00)             20-10(4)                                  
         DC    AL1(SECS20,SECS10,SECS10,SECS10,SECS10,FF)                       
         DC    AL1(06,00)             10(6)                                     
         DC    AL1(SECS10,SECS10,SECS10,SECS10,SECS10,SECS10,FF)                
         DC    AL1(FF)                                                          
                                                                                
*                                  'D' 10'S                                     
PLTBD10  DC    AL1(01,00)             10                                        
         DC    AL1(SECS10,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'D' 15'S                                     
PLTBD15  DC    AL1(01,00)             15                                        
         DC    AL1(SECS15,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'D' 20'S                                     
PLTBD20  DC    AL1(01,00)             20                                        
         DC    AL1(SECS20,FF)                                                   
         DC    AL1(02,00)             10-10                                     
         DC    AL1(SECS10,SECS10,FF)                                            
         DC    AL1(FF)                                                          
*                                  'D' 25'S                                     
PLTBD25  DC    AL1(02,00)             15-10                                     
         DC    AL1(SECS15,SECS10,FF)                                            
         DC    AL1(FF)                                                          
*                                  'D' 30'S                                     
PLTBD30  DC    AL1(01,00)             30                                        
         DC    AL1(SECS30,FF)                                                   
         DC    AL1(02,00)             20-10                                     
         DC    AL1(SECS20,SECS10,FF)                                            
         DC    AL1(02,00)             15-15                                     
         DC    AL1(SECS15,SECS15,FF)                                            
         DC    AL1(03,00)             10-10-10                                  
         DC    AL1(SECS10,SECS10,SECS10,FF)                                     
         DC    AL1(FF)                                                          
*                                  'D' 35'S                                     
PLTBD35  DC    AL1(02,00)             20-15                                     
         DC    AL1(SECS20,SECS15,FF)                                            
         DC    AL1(03,00)             15-10-10                                  
         DC    AL1(SECS15,SECS10,SECS10,FF)                                     
         DC    AL1(FF)                                                          
*                                  'D' 40'S                                     
PLTBD40  DC    AL1(02,00)             30-10                                     
         DC    AL1(SECS30,SECS10,FF)                                            
         DC    AL1(02,00)             20-20                                     
         DC    AL1(SECS20,SECS20,FF)                                            
         DC    AL1(03,00)             20-10-10                                  
         DC    AL1(SECS20,SECS10,SECS10,FF)                                     
         DC    AL1(03,00)             15-15-10                                  
         DC    AL1(SECS15,SECS15,10,FF)                                         
         DC    AL1(04,00)             10(4)                                     
         DC    AL1(SECS10,SECS10,SECS10,SECS10,FF)                              
         DC    AL1(FF)                                                          
*                                  'D' 45'S                                     
PLTBD45  DC    AL1(01,00)             45                                        
         DC    AL1(SECS45,FF)                                                   
         DC    AL1(02,00)             30-15                                     
         DC    AL1(SECS30,SECS15,FF)                                            
         DC    AL1(03,00)             20-15-10                                  
         DC    AL1(SECS20,SECS15,SECS10,FF)                                     
         DC    AL1(03,00)             15-15-15                                  
         DC    AL1(SECS15,SECS15,SECS15,FF)                                     
         DC    AL1(04,00)             15-10(3)                                  
         DC    AL1(SECS15,SECS10,SECS10,SECS10,FF)                              
         DC    AL1(FF)                                                          
*                                  'D' 50'S                                     
PLTBD50  DC    AL1(02,00)             30-20                                     
         DC    AL1(SECS30,SECS20,FF)                                            
         DC    AL1(03,00)             30-10-10                                  
         DC    AL1(SECS30,SECS10,SECS10,FF)                                     
         DC    AL1(03,00)             20-15-15                                  
         DC    AL1(SECS20,SECS15,SECS15,FF)                                     
         DC    AL1(04,00)             20-10(3)                                  
         DC    AL1(SECS20,SECS10,SECS10,SECS10,FF)                              
         DC    AL1(04,00)             15-15-10-10                               
         DC    AL1(SECS15,SECS15,SECS10,SECS10,FF)                              
         DC    AL1(05,00)             10(5)                                     
         DC    AL1(SECS10,SECS10,SECS10,SECS10,SECS10,FF)                       
         DC    AL1(FF)                                                          
*                                  'D' 55'S                                     
PLTBD55  DC    AL1(02,00)             45-10                                     
         DC    AL1(SECS45,SECS10,FF)                                            
         DC    AL1(03,00)             30-15-10                                  
         DC    AL1(SECS30,SECS15,SECS10,FF)                                     
         DC    AL1(03,00)             20-20-15                                  
         DC    AL1(SECS20,SECS20,SECS15,FF)                                     
         DC    AL1(04,00)             20-15-10-10                               
         DC    AL1(SECS20,SECS15,SECS10,SECS10,FF)                              
         DC    AL1(04,00)             15-15-15-10                               
         DC    AL1(SECS15,SECS15,SECS15,SECS10,FF)                              
         DC    AL1(05,00)             15-10(4)                                  
         DC    AL1(SECS15,SECS10,SECS10,SECS10,SECS10,FF)                       
         DC    AL1(FF)                                                          
*                                  'D' 60'S                                     
PLTBD60  DC    AL1(01,00)             60                                        
         DC    AL1(SECS60,FF)                                                   
         DC    AL1(02,00)             45-15                                     
         DC    AL1(SECS45,SECS15,FF)                                            
         DC    AL1(02,00)             30-30                                     
         DC    AL1(SECS30,SECS30,FF)                                            
         DC    AL1(03,00)             30-20-10                                  
         DC    AL1(SECS30,SECS20,SECS10,FF)                                     
         DC    AL1(03,00)             30-15-15                                  
         DC    AL1(SECS30,SECS15,SECS15,FF)                                     
         DC    AL1(04,00)             30-10(3)                                  
         DC    AL1(SECS30,SECS10,SECS10,SECS10,FF)                              
         DC    AL1(03,00)             20-20-20                                  
         DC    AL1(SECS20,SECS20,SECS20,FF)                                     
         DC    AL1(04,00)             20-20-10-10                               
         DC    AL1(SECS20,SECS20,SECS10,SECS10,FF)                              
         DC    AL1(04,00)             20-15-15-10                               
         DC    AL1(SECS20,SECS15,SECS15,SECS10,FF)                              
         DC    AL1(05,00)             20-10(4)                                  
         DC    AL1(SECS20,SECS10,SECS10,SECS10,SECS10,FF)                       
         DC    AL1(04,00)             15(4)                                     
         DC    AL1(SECS15,SECS15,SECS15,SECS15,FF)                              
         DC    AL1(05,00)             15-15-10(3)                               
         DC    AL1(SECS15,SECS15,SECS10,SECS10,SECS10,FF)                       
         DC    AL1(06,00)             10(6)                                     
         DC    AL1(SECS10,SECS10,SECS10,SECS10,SECS10,SECS10,FF)                
         DC    AL1(FF)                                                          
                                                                                
*                                  PSEUDO-PIG POD SPLIT ENTRIES                 
*                                  'A' 15'S                                     
PPTBA15  DC    AL1(01,00)             15                                        
         DC    AL1(SECS15,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'A' 30'S                                     
PPTBA30  DC    AL1(01,00)             30                                        
         DC    AL1(SECS30,FF)                                                   
         DC    AL1(02,00)             15-15                                     
         DC    AL1(SECS15,SECS15,FF)                                            
         DC    AL1(FF)                                                          
*                                  'A' 45'S                                     
PPTBA45  DC    AL1(01,00)             45                                        
         DC    AL1(SECS45,FF)                                                   
         DC    AL1(02,00)             30-15                                     
         DC    AL1(SECS30,SECS15,FF)                                            
         DC    AL1(FF)                                                          
*                                  'A' 60'S                                     
PPTBA60  DC    AL1(01,00)             60                                        
         DC    AL1(SECS60,FF)                                                   
         DC    AL1(02,00)             45-15                                     
         DC    AL1(SECS45,SECS15,FF)                                            
         DC    AL1(02,00)             30-30                                     
         DC    AL1(SECS30,SECS30,FF)                                            
         DC    AL1(FF)                                                          
*                                  'A' 75'S                                     
PPTBA75  DC    AL1(02,00)             60-15                                     
         DC    AL1(SECS60,SECS15,FF)                                            
         DC    AL1(02,00)             45-30                                     
         DC    AL1(SECS45,SECS30,FF)                                            
         DC    AL1(FF)                                                          
*                                  'A' 90'S                                     
PPTBA90  DC    AL1(01,00)             90                                        
         DC    AL1(SECS90,FF)                                                   
         DC    AL1(02,00)             60-30                                     
         DC    AL1(SECS60,SECS30,FF)                                            
         DC    AL1(02,00)             45-45                                     
         DC    AL1(SECS45,SECS45,FF)                                            
         DC    AL1(FF)                                                          
*                                  'B' 20'S                                     
PPTBB20  DC    AL1(01,00)             20                                        
         DC    AL1(SECS20,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'B' 30'S                                     
PPTBB30  DC    AL1(01,00)             30                                        
         DC    AL1(SECS30,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'B' 40'S                                     
PPTBB40  DC    AL1(02,00)             20-20                                     
         DC    AL1(SECS20,SECS20,FF)                                            
         DC    AL1(FF)                                                          
*                                  'B' 50'S                                     
PPTBB50  DC    AL1(02,00)             30-20                                     
         DC    AL1(SECS30,SECS20,FF)                                            
         DC    AL1(FF)                                                          
*                                  'B' 60'S                                     
PPTBB60  DC    AL1(01,00)             60                                        
         DC    AL1(SECS60,FF)                                                   
         DC    AL1(02,00)             30-30                                     
         DC    AL1(SECS30,SECS30,FF)                                            
         DC    AL1(FF)                                                          
                                                                                
*                                  'C' 10'S                                     
PPTBC10  DC    AL1(01,00)             10                                        
         DC    AL1(SECS10,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'C' 20'S                                     
PPTBC20  DC    AL1(01,00)             20                                        
         DC    AL1(SECS20,FF)                                                   
         DC    AL1(02,00)             10-10                                     
         DC    AL1(SECS10,SECS10,FF)                                            
         DC    AL1(FF)                                                          
*                                  'C' 30'S                                     
PPTBC30  DC    AL1(01,00)             30                                        
         DC    AL1(SECS30,FF)                                                   
         DC    AL1(02,00)             20-10                                     
         DC    AL1(SECS20,SECS10,FF)                                            
         DC    AL1(FF)                                                          
*                                  'C' 40'S                                     
PPTBC40  DC    AL1(02,00)             30-10                                     
         DC    AL1(SECS30,SECS10,FF)                                            
         DC    AL1(02,00)             20-20                                     
         DC    AL1(SECS20,SECS20,FF)                                            
         DC    AL1(FF)                                                          
*                                  'C' 50'S                                     
PPTBC50  DC    AL1(02,00)             30-20                                     
         DC    AL1(SECS30,SECS20,FF)                                            
         DC    AL1(FF)                                                          
*                                  'C' 60'S                                     
PPTBC60  DC    AL1(01,00)             60                                        
         DC    AL1(SECS60,FF)                                                   
         DC    AL1(02,00)             30-30                                     
         DC    AL1(SECS30,SECS30,FF)                                            
         DC    AL1(FF)                                                          
                                                                                
*                                  'D' 10'S                                     
PPTBD10  DC    AL1(01,00)             10                                        
         DC    AL1(SECS10,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'D' 15'S                                     
PPTBD15  DC    AL1(01,00)             15                                        
         DC    AL1(SECS15,FF)                                                   
         DC    AL1(FF)                                                          
*                                  'D' 20'S                                     
PPTBD20  DC    AL1(01,00)             20                                        
         DC    AL1(SECS20,FF)                                                   
         DC    AL1(02,00)             10-10                                     
         DC    AL1(SECS10,SECS10,FF)                                            
         DC    AL1(FF)                                                          
*                                  'D' 25'S                                     
PPTBD25  DC    AL1(02,00)             15-10                                     
         DC    AL1(SECS15,SECS10,FF)                                            
         DC    AL1(FF)                                                          
*                                  'D' 30'S                                     
PPTBD30  DC    AL1(01,00)             30                                        
         DC    AL1(SECS30,FF)                                                   
         DC    AL1(02,00)             20-10                                     
         DC    AL1(SECS20,SECS10,FF)                                            
         DC    AL1(02,00)             15-15                                     
         DC    AL1(SECS15,SECS15,FF)                                            
         DC    AL1(FF)                                                          
*                                  'D' 35'S                                     
PPTBD35  DC    AL1(02,00)             20-15                                     
         DC    AL1(SECS20,SECS15,FF)                                            
         DC    AL1(FF)                                                          
*                                  'D' 40'S                                     
PPTBD40  DC    AL1(02,00)             30-10                                     
         DC    AL1(SECS30,SECS10,FF)                                            
         DC    AL1(02,00)             20-20                                     
         DC    AL1(SECS20,SECS20,FF)                                            
         DC    AL1(FF)                                                          
*                                  'D' 45'S                                     
PPTBD45  DC    AL1(01,00)             45                                        
         DC    AL1(SECS45,FF)                                                   
         DC    AL1(02,00)             30-15                                     
         DC    AL1(SECS30,SECS15,FF)                                            
         DC    AL1(FF)                                                          
*                                  'D' 50'S                                     
PPTBD50  DC    AL1(02,00)             30-20                                     
         DC    AL1(SECS30,SECS20,FF)                                            
         DC    AL1(FF)                                                          
*                                  'D' 55'S                                     
PPTBD55  DC    AL1(02,00)             45-10                                     
         DC    AL1(SECS45,SECS10,FF)                                            
         DC    AL1(FF)                                                          
*                                  'D' 60'S                                     
PPTBD60  DC    AL1(01,00)             60                                        
         DC    AL1(SECS60,FF)                                                   
         DC    AL1(02,00)             45-15                                     
         DC    AL1(SECS45,SECS15,FF)                                            
         DC    AL1(02,00)             30-30                                     
         DC    AL1(SECS30,SECS30,FF)                                            
         DC    AL1(FF)                                                          
                                                                                
EQVMSG   DC    C'Note- Totals for demographics and number of units are *        
               30 second equivalenced.'                                         
                                                                                
         DS    0H                                                               
INTTAB   DS    0CL60                                                            
         DC    CL30'Brand time interval...........'                             
         DC    CL30'Brand percent leeway..........'                             
         DC    CL30'Class time interval...........'                             
         DC    CL30'Class percent leeway..........'                             
INTTABN  EQU   (*-INTTAB)/L'INTTAB                                              
                                                                                
         DS    0H                                                               
OBJTAB   DS    0CL30                                                            
         DC    CL30'Brand goal fulfillment........'                             
         DC    CL30'CPM/CPP equalization..........'                             
         DC    CL30'Sched. balance - Program......'                             
         DC    CL30'Sched. balance - Network......'                             
         DC    CL30'Sched. balance - Day of week..'                             
         DC    CL30'Target 1 maximization.........'                             
         DC    CL30'Target 2 maximization.........'                             
OBJTABX  DC    AL1(FF)                                                          
                                                                                
         DS    0H                                                               
PCAHD1   DC    C'                                   --Before---   ---Af*        
               ter---'                                                          
PCAHD2   DC    C'Network   Date    Program  Est     Lin Prd Len   Lin P*        
               rd Len'                                                          
PCAHD3   DC    C'------- --------  -------  ---     --- --- ---   --- -*        
               -- ---'                                                          
                                                                                
         DS    0H                                                               
PRTHD1   DC    C'-Env- -Prd-'                                                   
PRTHD2   DC    C'SQ CD SQ CD   Total '                                          
PRTHD3   DC    C'-- -- -- --  -------'                                          
                                                                                
         DS    0H                                                               
DETHD1   DC    C'Network/ Day/'                                                 
DETHD2   DC    C'Est-Lin  Time       Date   Brand         Unit cost'            
DETHD3   DC    C'-------  ----       ----   -----         ---------'            
                                                                                
         DS    0H                                                               
RECHD1   DC    C'   Goal    Pct   Achieved   Pct   Indx'                        
RECHD2   DC    C'  ------   ---   --------   ---   ----'                        
                                                                                
         DS    0H                                                               
D2RHD1   DC    C'Network  Date  Day      Time        Program          E*        
               st     Brand  Len  Unit Cost'                                    
D2RHD2   DC    C'-------  ----  ---      ----        -------          -*        
               --     -----  ---  ---------'                                    
                                                                                
         DS    0H                                                               
PARHD1   DS    0CL132                                                           
         DC    CL40'** Active brand list **                 '                   
         DC    CL40'                                        '                   
         DC    CL40'                                        '                   
         DC    CL12'            '                                               
         DC    CL40'                           Pri-        G'                   
         DC    CL40'oaled      Target      Target         --'                   
         DC    CL40'--------------E X C L U S I O N S-------'                   
         DC    CL12'------------'                                               
         DC    CL40'Brand                     ority Class   '                   
         DC    CL40' Demo       Demo1       Demo2         Es'                   
         DC    CL40't  Network     Program               Eff'                   
         DC    CL12'ective dates'                                               
         DC    CL40'-----                     ----- -----  -'                   
         DC    CL40'-----      ------      ------         --'                   
         DC    CL40'-  -------  -------------            ---'                   
         DC    CL12'------------'                                               
PARHDN   EQU   (*-PARHD1)/L'PARHD1                                              
                                                                                
         DS    0H                                                               
NETHD1   DC    CL132'Dpt  Netwk Est Lin Seq Stat PDL      UNL Alloc    *        
                    WK  E1  E2  E3 Disk adr DY  Date No    Cost    Base*        
                  Targ1   Targ2   Targ3'                                        
NETHD2   DC    CL132'---  ----- --- --- --- ---- ---      --- -----    *        
                    --  --  --  -- -------- --  ---- --    ----    ----*        
                  -----   -----   -----'                                        
                                                                                
         DS    0H                                                               
VARHDS   DS    0CL24                                                            
         DC    CL24'   Goal    Fill    -----'                                   
         DC    CL24'   CPP/M   Divrg   -----'                                   
         DC    CL24'            Env1   -----'                                   
         DC    CL24'            Env2   -----'                                   
         DC    CL24'            Env3   -----'                                   
         DC    CL24'    Targ      1    -----'                                   
         DC    CL24'    Targ      2    -----'                                   
                                                                                
         DS    0H                                                               
VARHDL   DC    CL24'    Wgtd    Sum  -------'                                   
                                                                                
         DS    0H                                                               
PDRHD1   DC    CL15'Una     Avg'                                                
PDRHD2   DC    CL15'Len    Value'                                               
PDRHD3   DC    CL15'---    -----'                                               
                                                                                
         DS    0H                                                               
VARHD1   DC    CL132'              **Daypart**    Ach      Acg   **Week*        
               **    Ach      Ach      Ach    Re-       Roll      New'          
VARHD2   DC    CL132'Prd C  Ln          Goal     Demo       $      Goal*        
                    Demo       $     Units  mainder      up      Goal  *        
                  CPP/M   Targ 1   Targ 2'                                      
VARHD3   DC    CL132'--- -  --          ----     ----     ----     ----*        
                    ----     ----    -----  -------     ----     ----  *        
                  -----   ------   ------'                                      
                                                                                
         DS    0H                                                               
PGMHD1   DC    CL132'        Prog                  Total'                       
PGMHD2   DC    CL132'Network type Program          units'                       
PGMHD3   DC    CL132'------- ---- -------          -----'                       
                                                                                
         DS    0H                                                               
VPLHD1   DC    C'Len Prd Class PSQ CS1 CS2 Max Act Ctl  Value1  Value2 *        
                Value3  Value4  Value5  Value6'                                 
         EJECT                                                                  
         DS    0D                                                               
         DC    C'*WEEKLST'                                                      
WEEKLST  DS    XL512                                                            
                                                                                
         DS    0D                                                               
         DC    C'*CLSTRT*'                                                      
CLSTRT   DS    XL256                                                            
                                                                                
         DS    0D                                                               
         DC    C'*VPLIST*'                                                      
VPLIST   DS    XL(VPLDL*MAXPRDS)                                                
                                                                                
         DS    0D                                                               
         DC    C'*APCLST*'                                                      
APCLST   DS    XL(APCLSTL*MAXPRDS)                                              
                                                                                
         DS    0D                                                               
         DC    C'*VPECNT*'                                                      
VPECNTS  DS    (MAXPRDS)H                                                       
                                                                                
         DS    0D                                                               
         DC    C'*PODPRD*'                                                      
PODPRDS  DS    XL(256*2)                                                        
                                                                                
         DS    0D                                                               
         DC    C'*SUBTAB*'                                                      
SUBTAB   DS    XL(SUBTABL*PDTLINSL)                                             
SUBTABX  DS    0X                                                               
                                                                                
         DS    0D                                                               
         DC    C'*ALCTAB*'                                                      
ALCTABM  EQU   512                                                              
ALCTAB   DS    (ALCTABL*ALCTABM)X                                               
ALCTABX  DS    0X                                                               
                                                                                
         DS    0D                                                               
         DC    C'*NETBLK*'                                                      
NETBLK   DS    (XDBLKEND-NETBLKD)X                                              
                                                                                
         DS    0D                                                               
         DC    C'*NETBUF*'                                                      
NETBUFF  DS    XL(SIXK)                                                         
                                                                                
         DS    0D                                                               
         DC    C'*PXCREC*'                                                      
PXCREC   DS    XL(EIGHTK)                                                       
                                                                                
         DS    0D                                                               
         DC    C'*XCTTAB*'                                                      
XCTABC   DC    (XCTTABL*XCTTMAX)X'00'                                           
                                                                                
         DS    0D                                                               
         DC    C'*PODTAB*'                                                      
PODTAB   DS    (PDTABMAX)XL(PDTABL)                                             
PODTABX  DS    0X                                                               
                                                                                
         DS    0D                                                               
         DC    C'*ABUFFER'                                                      
ABUFFER  DS    (ABUFFL)X                                                        
         EJECT                                                                  
ENV1SET  DS    0D                  ** VALUE SET FOR ENVIRONMENT 1 **            
         DC    C'*EN1SET*'                                                      
         DC    A(ENV1TAB,ENV1TOT,ENVS1MAX,ENVS1MAX*((MAXWEEKS+1)*2))            
         ORG   ENV1SET+ENVSETCL                                                 
                                                                                
ENV1TRT  DS    XL(L'ENVS1TRT)                                                   
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN1TAB*'                                                      
ENV1TAB  DS    (ENVS1MAX)XL(ENVS1LEN)                                           
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN1TOT*'                                                      
ENV1TOT  DS    (ENVS1MAX)XL((MAXWEEKS+1)*2)                                     
         DC    X'0000'                                                          
                                                                                
ENV2SET  DS    0D                  ** VALUE SET FOR ENVIRONMENT 2 **            
         DC    C'*EN2SET*'                                                      
         DC    A(ENV2TAB,ENV2TOT,ENVS2MAX,ENVS2MAX*((MAXWEEKS+1)*2))            
         ORG   ENV2SET+ENVSETCL                                                 
                                                                                
ENV2TRT  DS    XL(L'ENVS2TRT)                                                   
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN2TAB*'                                                      
ENV2TAB  DS    XL(L'ENVS2TAB)                                                   
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN2TOT*'                                                      
ENV2TOT  DS    XL(L'ENVS2TOT)                                                   
         DC    X'0000'                                                          
                                                                                
ENV3SET  DS    0D                  ** VALUE SET FOR ENVIRONMENT 3 **            
         DC    C'*EN3SET*'                                                      
         DC    A(ENV3TAB,ENV3TOT,ENVS3MAX,ENVS3MAX*((MAXWEEKS+1)*2))            
         ORG   ENV3SET+ENVSETCL                                                 
                                                                                
ENV3TRT  DS    XL(L'ENVS3TRT)                                                   
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN3TAB*'                                                      
ENV3TAB  DS    XL(L'ENVS3TAB)                                                   
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN3TOT*'                                                      
ENV3TOT  DS    XL(L'ENVS3TOT)                                                   
         DC    X'0000'                                                          
         EJECT                                                                  
ABUFFD   DSECT                     ** ACTUAL BUFFER 1 RECORD **                 
ABUFFK   DS    XL(GBUFFHL)         KEY AND COMMENT                              
ABTOT    DS    (MAXWEEKS+1)PL8     TOTAL AND WEEKLY ACCUMULATORS                
ABUFFL   EQU   *-ABUFFD                                                         
                                                                                
UBUFFRD  DSECT                     ** UNIT BUFFER RECORD **                     
UBUFEOTQ EQU   FF                  END OF TABLE INDICATOR                       
                                                                                
UBUFFK   DS    0X                  ** RECORD KEY **                             
UBDPT    DS    CL(L'NBACTDP)       DAYPART                                      
UBLEN    DS    XL(L'NBLEN)         LENGTH (0 FOR PODS)                          
UBNET    DS    CL(L'NBACTNET)      NETWORK                                      
UBEST    DS    XL(L'NBACTEST)      ESTIMATE                                     
UBSEQ    DS    XL2                 ASSIGNED SEQUENCE NUMBER                     
UBUFFKL  EQU   *-UBUFFK                                                         
                                                                                
UBDATA   DS    0X                  ** RECORD DATA **                            
UBPDLEN  DS    X                   TOTAL LENGTH (PODS)                          
UBUNLEN  DS    X                   LENGTH STILL UNALLOCATED (PODS)              
                                                                                
UBSTAT   DS    0X                  ** ALLOCATION STATUS **                      
                                                                                
UBSTAT1  DS    X                   ** ALLOCATION STATUS 1 **                    
UBSANETQ EQU   X'40'               ALLOCATED IN UNIT PHASE                      
UBSABRDQ EQU   X'20'               ALLOCATED IN BRAND PHASE                     
UBSAEXCQ EQU   X'10'               ALLOCATED IN EXCHANGE PHASE                  
UBSEXRJQ EQU   X'08'               EXCLUSION REJECT                             
UBSZPRJQ EQU   X'04'               ZERO PASS REJECT                             
UBSENRJQ EQU   X'02'               ENVIRONMENT REJECT                           
UBSPRRJQ EQU   X'01'               PRIORITY REJECT                              
UBSRJCTQ EQU   UBSEXRJQ+UBSZPRJQ+UBSENRJQ+UBSPRRJQ                              
                                                                                
UBSTAT2  DS    X                   ** ALLOCATION STATUS 2 **                    
UBSPRALQ EQU   X'80'               PRE-ALLOCATED                                
UBSLPRAQ EQU   X'40'               LENGTH PRE-ALLOCATED                         
UBSDPODQ EQU   X'20'               IS A DIVISIBLE POD                           
UBSMSUBQ EQU   X'10'               'MASTER' SUB-POD                             
                                                                                
UBSTATL  EQU   *-UBSTAT                                                         
                                                                                
UBPRD    DS    0FL(PRDLENQ)        (LABEL FOR GENERAL USE)                      
                                                                                
UBPRDS   DS    0X                  ** ALLOCATED PRODUCT/LENGTHS **              
UBPRD1   DS    FL(PRDLENQ)         PRODUCT 1                                    
UBLEN1   DS    FL(L'UBLEN)         LENGTH FOR PRODUCT 1                         
UBPRDL   EQU   *-UBPRDS                                                         
UBPRD2   DS    FL(PRDLENQ)         PRODUCT 2                                    
UBLEN2   DS    FL(L'UBLEN)         LENGTH FOR PRODUCT 2                         
UBPRD3   DS    FL(PRDLENQ)         PRODUCT 3                                    
UBLEN3   DS    FL(L'UBLEN)         LENGTH FOR PRODUCT 3                         
UBPRD4   DS    FL(PRDLENQ)         PRODUCT 4                                    
UBLEN4   DS    FL(L'UBLEN)         LENGTH FOR PRODUCT 4                         
UBPRD5   DS    FL(PRDLENQ)         PRODUCT 5                                    
UBLEN5   DS    FL(L'UBLEN)         LENGTH FOR PRODUCT 5                         
UBPRDX   DS    0FL(PRDLENQ)        LAST POD ENTRY                               
UBPRD6   DS    FL(PRDLENQ)         PRODUCT 6                                    
UBLEN6   DS    FL(L'UBLEN)         LENGTH FOR PRODUCT 6                         
UBPRDSL  EQU   *-UBPRDS                                                         
UBPODMAX EQU   (*-UBPRDS)/UBPRDL   MAXIMUM ALLOCATION PER POD                   
                                                                                
UBWEEK   DS    X                   WEEK NUMBER                                  
                                                                                
UBENV1   DS    H                   ENVIRONMENT 1 VALUE                          
UBENV2   DS    H                   ENVIRONMENT 2 VALUE                          
UBENV3   DS    H                   ENVIRONMENT 3 VALUE                          
                                                                                
UBDATE   DS    XL2                 UNIT DATE                                    
UBSTIM   DS    XL2                 START TIME                                   
UBDA     DS    XL4                 DISK ADDRESS (ZERO FOR PODS)                 
UBDAY    DS    XL(L'NBDAY)         DAY CODE                                     
UBCOST   DS    XL4                 COST                                         
UBCDEM   DS    XL4                 CORPORATE DEMO                               
                                                                                
UBDATAL  EQU   *-UBDATA            LENGTH OF DATA                               
UBFIXLN  EQU   *-UBUFFRD           LENGTH OF FIXED PORTION OF RECORD            
                                                                                
UBTARGS  DS    (PTZDEMMX)XL4       TARGET DATA                                  
UBTOTLN  EQU   *-UBUFFRD                                                        
                                                                                
UBPODD   DS    0XL10               EXTENSION FOR FULL POD DESCRIPTION           
                                                                                
UBPDLINS DS    XL6                 SUB-LINES                                    
         DS    XL4                 N/D                                          
                                                                                
UBUFFL   EQU   *-UBUFFRD                                                        
         EJECT                                                                  
PDTABD   DSECT                     ** DSECT FOR POD TABLE **                    
PDTEOTQ  EQU   FF                  END OF TABLE INDICATOR                       
PDTABMAX EQU   64                  MAXIMUM NUMBER OF ENTRIES                    
                                                                                
PDTCSW   DS    X                   COST TYPE                                    
PDTDEM   DS    XL(L'XDESTDEM)      DEMO VALUES 01-25                            
PDTDEM2  DS    XL(L'XDESTDM2)      DEMO VALUES 26-50                            
PDTDEML  EQU   *-PDTDEM            LENGTH OF DEMO VALUES                        
PDTDMN   DS    XL(L'XDDEMOS)       DEMO CODES                                   
PDTPKG   DS    XL(L'NBPACK)        PACKAGE                                      
PDTKL    EQU   *-PDTABD            KEY LENGTH                                   
                                                                                
PDTHDEM  DS    XL(PTZDEMMX*4)      SAVE REFORMATTED DEMO LIST                   
PDTSVPD  DS    XL(UBTOTLN)         SAVE POD BUFFER DESCRIPTION                  
PDTTIME  DS    F                   TIME COST                                    
PDTLEN   DS    H                   TOTAL SECONDS                                
PDTLINSL EQU   L'UBPDLINS*42       42 SUBPODS FULL OF LINE NUMBERS              
PDTLINS  DS    XL(PDTLINSL)        SUB-LINE NUMBERS                             
PDTLINSX EQU   *                                                                
                                                                                
PDTABL   EQU   *-PDTABD            ENTRY LENGTH                                 
                                                                                
XCTABD   DSECT                     ** DSECT FOR EXCLUSION TABLE **              
XCTTMAX  EQU   8192                MAXIMUM NUMBER OF TABLE ENTRIES              
                                                                                
XCTKEY   DS    0X                  ** TABLE HEADER **                           
XCTNET   DS    CL(L'QNET)          NETWORK CODE                                 
XCTPRD   DS    CL(L'TABPRD)        PRODUCT POINTER                              
XCTEST   DS    XL(L'PXCKEST)       ESTIMATE NUMBER                              
XCTKEYL  EQU   *-XCTKEY                                                         
                                                                                
XCTDATA  DS    0X                  ** TABLE DATA **                             
XCTPGM   DS    0XL(L'ENVS1PGM)     PROGRAM NAME                                 
                                                                                
XCTTYPE  DS    X                   ** EXCLUSION TYPE **                         
XCTTTODQ EQU   X'00'               TIMES OF DAY                                 
XCTTDOWQ EQU   X'01'               DAY-OF-WEEK/DAYPART/LENGTH                   
XCTTADYQ EQU   X'02'               TIMES + DAY OF WEEK                          
XCTSPCLQ EQU   X'40'               SPECIAL PROGRAM                              
                                                                                
XCTDAY   DS    X                   DAY                                          
XCTDPT   DS    X                   DAYPART                                      
XCTLEN   DS    X                   SECONDS LENGTH                               
                                                                                
         ORG   XCTDAY                                                           
XCTSTIME DS    XL2                 START TIME                                   
XCTETIME DS    XL2                 END TIME                                     
XCTDOW   DS    X                   DAY-OF-WEEK                                  
                                                                                
         ORG   XCTPGM+L'XCTPGM                                                  
         DS    X                                                                
XCTDATES DS    0X                                                               
XCTSDATE DS    XL2                 START DATE                                   
XCTEDATE DS    XL2                 END DATE                                     
XCTDATEL EQU   *-XCTDATES                                                       
                                                                                
XCTDATAL EQU   *-XCTDATA                                                        
XCTTABL  EQU   *-XCTABD                                                         
         EJECT                                                                  
ENVSETD  DSECT                     ** DSECT FOR ENVIRONMENT HEADER **           
ENVSEYEC DS    CL8                 EYE CATCHER                                  
ENVSATAB DS    A                   A(TABLE)                                     
ENVSATOT DS    A                   A(TOTALS)                                    
ENVSMAXN DS    A                   MAXIMUM N'ENTRIES IN TABLE                   
ENVSLTOT DS    A                   L'TABLE                                      
ENVSVAR  DS    F                   VARIABLE                                     
ENVSACNT DS    A                   A(COUNTS)                                    
ENVSACTC DS    A                   A(ACTUAL UNIT COUNTS)                        
ENVSASHR DS    A                   A(SHARES)                                    
ENVSWCNT DS    F                   COUNT OF ENVIRONMENTS (FOR WEEK)             
ENVSTLEN DS    F                   LENGTH OF ENVIRONMENT TABLE                  
ENVSETCL EQU   *-ENVSETD                                                        
                                                                                
ENVSTTAB DS    0AL2                TRANSLATE TABLES START HERE                  
                                                                                
ENVS1TRT DS    XL(ENVS1MAX*2)      TRANSLATE TABLE FOR ENVIRONMENT 1            
         DS    XL2                                                              
                                                                                
         DS    0F                                                               
ENVS1TAB DS    (ENVS1MAX)XL(ENVS1LEN)                                           
         DS    XL2                                                              
                                                                                
         DS    0F                                                               
ENVS1TOT DS    (ENVS1MAX)XL((MAXWEEKS+1)*2)                                     
         DS    XL2                                                              
                                                                                
ENVS1TBL EQU   *-ENVS1TRT                                                       
                                                                                
         ORG   ENVSTTAB                                                         
ENVS2TRT DS    XL(ENVS2MAX*2)      TRANSLATE TABLE FOR ENVIRONMENT 2            
         DS    XL2                                                              
                                                                                
ENVS2TAB DS    XL(ENVS2LEN*ENVS2MAX)                                            
         DS    XL2                                                              
                                                                                
ENVS2TOT DS    XL(ENVS2MAX*((MAXWEEKS+1)*2))                                    
         DS    XL2                                                              
                                                                                
ENVS2TBL EQU   *-ENVS2TRT                                                       
                                                                                
         ORG   ENVSTTAB                                                         
ENVS3TRT DS    XL(ENVS3MAX*2)      TRANSLATE TABLE FOR ENVIRONMENT 3            
         DS    XL2                                                              
                                                                                
ENVS3TAB DS    XL(ENVS3LEN*ENVS3MAX)                                            
         DS    XL2                                                              
                                                                                
ENVS3TOT DS    XL(ENVS3MAX*((MAXWEEKS+1)*2))                                    
         DS    XL2                                                              
                                                                                
ENVS3TBL EQU   *-ENVS3TAB                                                       
                                                                                
ENVTABD  DSECT                     ** DSECT FOR ENVIRONMENT 1 TABLE **          
ENVSEOTQ EQU   X'FF'               END OF TABLE INDICATOR                       
                                                                                
ENVS1MAX EQU   3000                MAXIMUM ENTRIES FOR ENVIRONMENT 1            
ENVS1KEY DS    0X                  ** ENVIRONMENT 1 TABLE KEY **                
ENVS1NET DS    CL(L'UBNET)         NETWORK                                      
ENVS1DAY DS    XL(L'NBDAY)         DAY                                          
ENVS1TIM DS    0XL(L'NBTIME)       START-END TIMES                              
ENVS1STR DS    XL(L'ENVS1TIM/2)    START TIME                                   
ENVS1END DS    XL(L'ENVS1TIM/2)    END TIME                                     
ENVS1PGC DS    CL(L'NBACTPRG)      PROGRAM CODE                                 
ENVS1PGM DS    CL(L'NBPROGNM)      PROGRAM NAME                                 
ENVS1KLN EQU   *-ENVS1KEY                                                       
                                                                                
ENVS1PID DS    X                   PROGRAM INDEX DISPLACEMENT                   
ENVS1TYP DS    CL2                 PROGRAM FILTER                               
ENVS1SLP DS    XL2                 SLOTS FOR A PRODUCT                          
ENVS1SLC DS    XL2                 SLOTS FOR A CLASS                            
ENVS1LEN EQU   *-ENVTABD                                                        
                                                                                
         ORG   ENVTABD                                                          
ENVS2MAX EQU   100                 MAXIMUM ENTRIES FOR ENVIRONMENT 2            
ENVS2KEY DS    0X                  ** ENVIRONMENT 2 TABLE KEY **                
ENVS2NET DS    CL(L'UBNET)         NETWORK                                      
ENVS2KLN EQU   *-ENVS2KEY                                                       
ENVS2LEN EQU   *-ENVTABD                                                        
                                                                                
         ORG   ENVTABD                                                          
ENVS3MAX EQU   70                  MAXIMUM ENTRIES FOR ENVIRONMENT 3            
ENVS3KEY DS    0X                  ** ENVIRONMENT 3 TABLE KEY **                
ENVS3DAY DS    XL(L'NBDAY)         DAY-OF-WEEK                                  
ENVS3KLN EQU   *-ENVS3KEY                                                       
ENVS3LEN EQU   *-ENVTABD                                                        
         EJECT                                                                  
DEMNAMD  DSECT                     ** DSECT TO COVER DEMNMS ENTRY **            
DEMNDEMN DS    XL(L'PTDEMNO)       DEMO NUMBER                                  
DEMNNADP DS    CL4                 NAD PREFIX                                   
DEMNNAME DS    CL7                 DEMO NAME                                    
DEMNNAML EQU   L'DEMNNADP+L'DEMNNAME                                            
                                                                                
DEMNRVSA DS    C                   ** RATING VS AUDIENCE INDICATOR **           
DEMNRATQ EQU   C'R'                RATING                                       
DEMNAUDQ EQU   C'A'                AUDIENCE                                     
DEMNLENQ EQU   *-DEMNAMD                                                        
                                                                                
       ++INCLUDE SPREPPTBUF                                                     
PTBEOTQ  EQU   0                   END OF TABLE INDICATOR/NULL ENTRY            
                                                                                
*                                  ** PTSTAT BITS FOR ALLOCATION **             
PTSACTVQ EQU   X'80'               BRAND ACTIVE                                 
PTSPRTYQ EQU   X'40'               PRIORITY BRAND                               
PTSCLSEQ EQU   X'20'               CLASS ERROR                                  
                                                                                
PTDEMRQ  EQU   RATINGQ             DEMO TYPE = RATING                           
                                                                                
         ORG   PTDEMO                                                           
PTZDEMMX EQU   (L'XDDEMOS/L'XDDEMLST)                                           
PTZDEM   DS    XL(PTZDEMMX*L'PTDEMNO)                                           
PTZDEML  EQU   *-PTZDEM                                                         
PTZWGHT  DS    XL(PTZDEMMX)                                                     
                                                                                
PTENVSEQ DS    FL(L'ENVSTTAB)      PRODUCT TRANSLATION                          
PTENVSNC EQU   FF                  PRODUCT NOT COUNTED                          
                                                                                
PTZBUFFL EQU   *-PTBUFFD           EXTRA EXTENDED BUFFER WIDTH                  
                                                                                
         PRINT OFF                                                              
       ++INCLUDE SPREPWORKD                                                     
         PRINT ON                                                               
                                                                                
QNET     EQU   QSTA,4,C'C'         REQUESTED NETWORK                            
QSUBMED  EQU   QSTA+L'QNET         REQUESTED SUB-MEDIA                          
                                                                                
         ORG   QGRP                                                             
QOPT6    DS    C                   ZERO WEEK OPTION OVERRIDE                    
QOPT7    DS    C                   SPLIT 30 OPTION                              
         ORG   Q2TRADE+L'Q2TRADE                                                
QDPTFLT  DS    CL2                 DAYPART FILTER                               
                                                                                
         ORG   PROGPROF                                                         
ALOCOPTN DS    C                   ALLOCATION BASIS                             
GOALOPTN DS    C                   GOAL BALANCING OPTION                        
ZEROOPTN DS    C                   WEEKS WITH ZERO GOALS                        
DSEPOPTN DS    C                   DO DAYPARTS SEPARATELY                       
DSECOPTN DS    C                   DO UNIT LENGTHS SEPARATELY                   
INDXOPT  DS    C                   ** INDEX OPTION **                           
INDXPCTQ EQU   C'P'                INDEXED USING PERCENTS                       
INDXRAWQ EQU   C'R'                INDEXED USING RAW DATA                       
RPTOPTN  DS    C                   ** REPORT PRINTING OPTION **                 
RPTOALLQ EQU   C'D'                ALL REPORTS                                  
RPTORCPQ EQU   C'R'                RECAP ONLY                                   
RPTOWKRQ EQU   C'W'                WEEKLY SUMMARY AND RECAP                     
INTGBOPT DS    C                   IGNORE NON TARGET BRANDS                     
BTVLOPTN DS    C                   BRAND TIME INTERVAL (MINUTES)                
BPCTOPTN DS    C                   BRAND PERCENT LEEWAY                         
CTVLOPTN DS    C                   CLASS TIME INTERVAL (MINUTES)                
CPCTOPTN DS    C                   CLASS PERCENT LEEWAY                         
TARGOPTN DS    C                   USE ESTIMATE DEMOS AS TARGETS                
ASSGNOPT DS    C                   USE ASSIGNED $ (NETPAK ONLY)                 
PODGOPTN DS    C                   ** POD GROUPING OVERRIDE OPTION **           
PODGOACT EQU   C'1'                POD GROUPING BY ACTUAL COST                  
PODGOASS EQU   C'2'                POD GROUPING BY ASSIGNED COST                
         DS    C                   N/D                                          
         EJECT                                                                  
         ORG   P1                  ** LAYOUT FOR BRAND LIST **                  
PMBBSTAT DS    C                                                                
PMBBRD   DS    CL3                                                              
         DS    C                                                                
PMBBNM   DS    CL20                                                             
         DS    CL2                                                              
PMBPRI   DS    CL3                                                              
         DS    CL4                                                              
PMBCLAS  DS    C                                                                
         DS    CL4                                                              
PMBGDEM  DS    CL11                                                             
         DS    C                                                                
PMBTRG1  DS    CL11                                                             
         DS    C                                                                
PMBTRG2  DS    CL11                                                             
         DS    CL4                                                              
PMBXEST  DS    CL3                                                              
         DS    CL2                                                              
PMBXNET  DS    CL8                                                              
         DS    C                                                                
PMBXPGM  DS    CL(L'XCTPGM)                                                     
         DS    CL7                                                              
PMBXDTS  DS    CL17                                                             
                                                                                
         ORG   P1                  ** LAYOUT FOR POD ANALYSIS LINE **           
         DS    CL2                                                              
PDLNET   DS    CL4                 NETWORK                                      
         DS    CL2                                                              
PDLDATE  DS    CL8                 AIR DATE                                     
         DS    CL2                                                              
PDLPGM   DS    CL6                 PROGRAM                                      
         DS    CL3                                                              
PDLEST   DS    CL3                 ESTIMATE                                     
         DS    CL5                                                              
PDLBFLIN DS    CL3                 'BEFORE' LINE                                
         DS    C                                                                
PDLBFPRD DS    CL3                          PRODUCT                             
         DS    C                                                                
PDLBFLEN DS    CL3                          LENGTH                              
         DS    CL3                                                              
PDLAFLIN DS    CL3                 'AFTER'  LINE                                
         DS    C                                                                
PDLAFPRD DS    CL3                          PRODUCT                             
         DS    C                                                                
PDLAFLEN DS    CL3                          LENGTH                              
                                                                                
         ORG   P1                  ** LAYOUT FOR PGM/PRD LINE **                
PPRLNET  DS    CL7                 NETWORK                                      
         DS    C                                                                
PPRLTYP  DS    CL2                 PROGRAM TYPE                                 
         DS    CL3                                                              
PPRLPGM  DS    CL16                PROGRAM                                      
PPRLTOT  DS    CL6                 TOTALS                                       
PPRLCNTS DS    24CL4               PRODUCTS                                     
                                                                                
         ORG   P1                  ** LAYOUT FOR DETAIL LINE **                 
D2RNET   DS    CL8                                                              
         DS    C                                                                
D2RDATE  DS    CL5                                                              
         DS    C                                                                
D2RDAYS  DS    CL8                                                              
         DS    C                                                                
D2RTIME  DS    CL11                                                             
         DS    C                                                                
D2RPROG  DS    CL16                                                             
         DS    C                                                                
D2REST   DS    CL3                                                              
         DS    CL5                                                              
D2RPRD   DS    CL3                                                              
         DS    CL3                                                              
D2RLEN   DS    CL3                                                              
         DS    C                                                                
D2RCOST  DS    CL11                                                             
         DS    C                                                                
D2RBASD  DS    CL7                                                              
         DS    C                                                                
D2RBASCP DS    CL7                                                              
         DS    C                                                                
D2RTARG1 DS    CL7                                                              
         DS    C                                                                
D2RTG1CP DS    CL7                                                              
         DS    C                                                                
                                                                                
         ORG   P1                  ** LAYOUT FOR DETAIL LINE 1 **               
DRNET    DS    CL8                                                              
         DS    C                                                                
DRDAYS   DS    CL8                                                              
         DS    CL3                                                              
DRDATE   DS    CL5                                                              
         DS    CL3                                                              
DRPRD    DS    CL3                                                              
         DS    CL2                                                              
DRLEN    DS    CL3                                                              
         DS    CL3                                                              
DRCOST   DS    CL11                                                             
         DS    C                                                                
DRBASD   DS    CL9                                                              
DRTARG1  DS    CL9                                                              
                                                                                
         ORG   P2                  ** LAYOUT FOR DETAIL LINE 2 **               
DREST    DS    CL3                                                              
         DS    C                                                                
DRLIN    DS    CL3                                                              
         DS    CL2                                                              
DRTIME   DS    CL11                                                             
         DS    CL8                                                              
DRSTAT   DS    CL4                                                              
         DS    C                                                                
DRPRDLEN DS    CL5                                                              
                                                                                
         ORG   P3                  ** LAYOUT FOR DETAIL LINE 3 **               
DRPROG   DS    CL17                                                             
                                                                                
SLINED   DSECT                     ** DSECT FOR UNIT TRACE LINE **              
SLDPT    DS    C                                                                
SLLEN    DS    CL3                                                              
         DS    C                                                                
SLNET    DS    CL4                                                              
         DS    CL2                                                              
SLEST    DS    CL3                                                              
         DS    CL3                                                              
SLSEQ    DS    CL5                                                              
         DS    C                                                                
SLSTAT   DS    CL4                                                              
         DS    C                                                                
SLPDLEN  DS    CL3                                                              
         DS    C                                                                
SLEQU    DS    CL4                                                              
         DS    C                                                                
SLUNLEN  DS    CL3                                                              
         DS    C                                                                
SLALLOC  DS    CL13                                                             
         DS    C                                                                
SLWK     DS    CL2                                                              
         DS    C                                                                
SLENV1   DS    CL3                                                              
         DS    C                                                                
SLENV2   DS    CL3                                                              
         DS    C                                                                
SLENV3   DS    CL3                                                              
         DS    C                                                                
SLDA     DS    CL8                                                              
         DS    C                                                                
SLDAY    DS    CL2                                                              
         DS    C                                                                
SLDATE   DS    CL5                                                              
         DS    C                                                                
SLSPTNO  DS    CL2                                                              
SLCOST   DS    CL8                                                              
         DS    C                                                                
SLBASE   DS    CL7                                                              
         DS    C                                                                
SLTARG1  DS    CL7                                                              
         DS    C                                                                
SLTARG2  DS    CL7                                                              
         DS    C                                                                
SLTARG3  DS    CL7                                                              
                                                                                
RRLIND   DSECT                     ** DSECT FOR RECAP REPORT LINE **            
         DS    C                                                                
RRBRD    DS    CL3                                                              
         DS    C                                                                
RRBRDN   DS    CL20                                                             
         DS    CL3                                                              
RRDESC   DS    CL16                                                             
         DS    CL5                                                              
RRGOAL   DS    CL8                                                              
         DS    CL3                                                              
RRGPCT   DS    CL3                                                              
         DS    CL3                                                              
RRACH    DS    CL8                                                              
         DS    CL3                                                              
RRAPCT   DS    CL3                                                              
         DS    CL3                                                              
RRINDX   DS    CL4                                                              
         EJECT                                                                  
VPLD     DSECT                     ** DSECT FOR VALUE/PRODUCT LIST **           
VPLEOTQ  EQU   X'FF'               END OF TABLE INDICATOR                       
VPLEN    DS    XL(L'TABLEN)        UNIT LENGTH                                  
VPPRD    DS    FL(PRDLENQ)         PRODUCT CODE                                 
VPPRDA   DS    AL4                 ADDRESS OF PRODUCT/LENGTH ENTRY              
VPCLASS1 DS    X                   CLASS 1                                      
VPCLASS2 DS    X                   CLASS 2                                      
VPPSQ    DS    FL(L'PTENVSEQ)      PRODUCT SEQUENCE FOR ENV CHECK               
VPC1SQ   DS    X                   CLASS1 SEQUENCE FOR ENV CHECK                
VPC2SQ   DS    X                   CLASS2 SEQUENCE FOR ENV CHECK                
VPMOCS   DS    X                   MAXIMUM OCCURRENCES                          
VPAOCS   DS    X                   ACTUAL OCCURRENCES                           
VPVALS   DS    (UBPODMAX)XL4                                                    
VPLDL    EQU   *-VPLD                                                           
                                                                                
*                                  ** DSECT FOR LIST OF AVAILABLE               
APCLSTD  DSECT                        CLASSES AND PRDS WITH NO CLASS **         
                                                                                
APCTYPE  DS    C                   ** TYPE **                                   
APCTPRD  EQU   C'P'                PRODUCT                                      
APCTCLS  EQU   C'C'                CLASS                                        
                                                                                
APCCLASS DS    0XL(L'VPCLASS1)     CLASS OR...                                  
APCPRD   DS    FL(PRDLENQ)         ...PRODUCT                                   
APCKEYL  EQU   *-APCLSTD                                                        
                                                                                
APCHLEN  DS    XL(L'VPLEN)         HIGHEST GOALED LENGTH                        
APCLSTL  EQU   *-APCLSTD                                                        
                                                                                
SUBTABD  DSECT                     ** DSECT FOR SUBLINE TABLE **                
SUBTEOTQ EQU   FF                  END OF TABLE INDICATOR                       
                                                                                
SUBTSTAT DS    X                   ** STATUS **                                 
SUBTSUSQ EQU   X'80'               USED                                         
SUBTSRWQ EQU   X'40'               ACTUALLY RE-WRITTEN                          
                                                                                
SUBTPRD  DS    FL(PRDLENQ)         CURRENT PRODUCT ASSIGNMENT                   
SUBTLEN  DS    XL(L'NULEN)         CURRENT LENGTH                               
SUBTACT  DS    F                   ACTUAL COST                                  
SUBTASN  DS    F                   ASSIGNED COST                                
SUBTINT  DS    F                   INTEGRATION COST                             
SUBTSUB  DS    XL(L'NUKSUB)        SUB-LINE                                     
                                                                                
SUBTDA   DS    XL(L'NUDA)          DISK ADDRESS                                 
SUBTSTIM DS    XL(L'NUKTIME)       START QUARTER HOUR                           
                                                                                
SUBTABL  EQU   *-SUBTABD                                                        
                                                                                
ALCTABD  DSECT                     ** DSECT FOR ALLOCATION TABLE **             
ALCTEOTQ EQU   FF                  END OF TABLE INDICATOR                       
                                                                                
ALCTSTAT DS    X                   ** STATUS **                                 
ALCTSUSQ EQU   X'80'               ENTRY USED                                   
ALCTSRWQ EQU   X'40'               RECORD WRITTEN                               
ALCTSRAQ EQU   X'20'               RECORD ADDED                                 
                                                                                
ALCTPRD  DS    FL(PRDLENQ)         PRODUCT                                      
ALCTLEN  DS    XL(L'SUBTLEN)       LENGTH                                       
ALCTACT  DS    F                   ACTUAL COST                                  
ALCTASN  DS    F                   ASSIGNED COST                                
ALCTINT  DS    F                   INTERGRATION COST                            
ALCTSUB  DS    XL(L'SUBTSUB)       SUBLINE (FOR POD ANALYSIS TABLE)             
                                                                                
ALCTABL  EQU   *-ALCTABD                                                        
                                                                                
PPRD     DSECT                     ** DSECT FOR PGM/PRD TABLE **                
                                                                                
PPRKEY   DS    0X                  ** TABLE KEY **                              
PPRNET   DS    CL(L'ENVS1NET)      NETWORK                                      
PPRTYP   DS    CL(L'ENVS1TYP)      PROGRAM TYPE                                 
PPRPGM   DS    CL(L'ENVS1PGM)      PROGRAM NAME                                 
PPRPGMC  DS    CL(L'ENVS1PGC)      PROGRAM CODE                                 
PPRKEYL  EQU   *-PPRKEY                                                         
                                                                                
PPRTOT   DS    XL4                 TOTAL SECONDS/UNITS                          
                                                                                
PPRPRD   DS    0XL2                PRODUCT COUNTS                               
                                                                                
TABD     DSECT                     ** DSECT FOR BRAND TABLE **                  
                                                                                
TABKEY   DS    0X                  ** TABLE KEY **                              
TABDPT   DS    X                   DAYPART                                      
TABLEN   DS    X                   UNIT LENGTH (POD=0)                          
TABPRD   DS    AL3                 PRODUCT                                      
TABTYP   DS    X                   RECORD TYPE (SEE TYP EQUATES)                
TABCLASS DS    X                   PRODUCT CLASS                                
TABKEYL  EQU   *-TABKEY                                                         
                                                                                
TABPRI   DS    X                   PRIORITY                                     
TABNOSPT DS    X                   NO USABLE UNIT FOR PRODUCT                   
TABACTWK DS    X                   ACTIVE WEEKS                                 
TABGLDEM DS    X                   GOAL DEMO                                    
                                                                                
TABROLL  DS    F                   ROLL-UP AMOUNT                               
TABGOAL  DS    F                   GOAL                                         
TABVALL  EQU   *-TABD                                                           
                                                                                
TABDATA  DS    0X                  ** ACCUMULATORS **                           
TRSCGOL  DS    F                                                                
TPREDEM  DS    F                                                                
TPREDOL  DS    F                                                                
TPREUNT  DS    F                                                                
TSAVDEM  DS    F                                                                
TABTA1   DS    0F                  DISPLACEMENT TO FIRST TARGET                 
TMINRES  DS    F                                                                
                                                                                
         ORG   TABDATA                                                          
SUMDATA  DS    0F                  ** SUMMARY DATA **                           
SUMGLDD  DS    F                   GOAL DOLLARS                                 
SUMGLRD  DS    F                   GOAL DEMO                                    
SUMRSGD  DS    F                   RESCALED GOALS                               
SUMASD   DS    F                   ACH UNITS                                    
SUMPSD   DS    F                   PRE UNITS                                    
SUMADD   DS    F                   ACH DOLLARS                                  
SUMPDD   DS    F                   PRE DOLLARS                                  
SUMARD   DS    F                   ACH DEMO                                     
SUMPRD   DS    F                   PRE DEMO                                     
SUMDATAL EQU   *-SUMDATA                                                        
                                                                                
SUMAUD   DS    0F                  ** SUMMARY AUDIENCE DATA **                  
SUMAT1D  DS    F                   ACH TARGET 1                                 
SUMPT1D  DS    F                   PRE TARGET 1                                 
SUMAUDL  EQU   *-SUMAUD                                                         
         EJECT                                                                  
* OTHER INCLUDED DSECTS                                                         
         PRINT OFF                                                              
NETBLKD  DSECT                                                                  
       ++INCLUDE NETBLOCKN                                                      
       ++INCLUDE NETDEMOP          Personal language demos                      
         ORG   XDDEMOS                                                          
XDDEMLST DS    (PTZDEMMX)XL(L'PTDEMNO)                                          
         ORG                                                                    
                                                                                
NBDUNTQ  EQU   C'U'                UNITS                                        
NBSNETQ  EQU   C'N'                NETWORK                                      
NBESTOUQ EQU   C'M'                RETURN ESTIMATE DEMOS                        
NBSPRGQ  EQU   C'P'                PROGRAM (DAY OF WEEK FIRST)                  
NBUNPREQ EQU   X'40'               PREEMPT                                      
NBUNMISQ EQU   X'02'               MISSED                                       
NBUNMGOQ EQU   X'01'               MAKE-GOOD                                    
NBUNPFBQ EQU   X'04'               PFB                                          
NBUNPAFQ EQU   X'20'               PRODUCT ALLOCATION FROZEN                    
NBUNLFAQ EQU   X'10'               LENGTH FROZEN FOR ALLOCATION                 
NBSTCABQ EQU   C'C'                CABLE                                        
NBSTSYNQ EQU   C'S'                SYNDICATION                                  
NBSTOTHQ EQU   C'O'                OTHER                                        
                                                                                
       ++INCLUDE NEGENUNIT                                                      
NUACTD   DSECT                                                                  
NUACTLNQ EQU   *-NUACTD                                                         
                                                                                
NUKSTRAQ EQU   X'C1'               FIRST TRAFFIC SUB-LINE NUMBER                
                                                                                
NUPDEFLQ EQU   NUPDEPR-NUPDED      LENGTH OF FIXED PART OF ELEMENT              
NUPDEFL1 EQU   NUPDEFLQ+(NUPDTLEN*1)                                            
NUPDEFL2 EQU   NUPDEFLQ+(NUPDTLEN*2)                                            
NUCMLEQ  EQU   X'21'                                                            
NUFDCEIQ EQU   X'23'                                                            
NUOTELQ  EQU   X'60'                                                            
NUACTELQ EQU   X'99'                                                            
*                                  ** UNIT STATUS (NUUNITST) **                 
NUUNPREQ EQU   X'40'               PRE-EMPT                                     
*                                  ** UNIT STATUS (NUSDST3) **                  
NUSDUCSQ EQU   X'40'               UNIT IS A COPY SPLIT                         
NUSDADUQ EQU   X'02'               ADU UNIT (COST NOT ALLOWED)                  
*                                  ** FLAGS (NUCMLFLG) **                       
NUCULCIQ EQU   X'80'               UNIT LEN CHANGED, ELEMENT INVALID            
NUCUPCIQ EQU   X'40'               UNIT PRD CHANGED, ELEMENT INVALID            
*                                  ** OTHER TYPE (NUOTTYP) **                   
NUOTPACQ EQU   C'G'                PIGGYBACK ALLOWANCE CODE                     
       ++INCLUDE NEGENDPT                                                       
       ++INCLUDE SPGENAGY                                                       
       ++INCLUDE SPGENCLT                                                       
       ++INCLUDE SPGENPRD                                                       
         ORG   PKEYPRD+L'PKEYPRD                                                
PKEYREST DS    XL(L'PKEY-(*-PKEY))                                              
         ORG                                                                    
       ++INCLUDE SPGENPXC                                                       
       ++INCLUDE SPGENEST                                                       
         ORG   EKEYEST+L'EKEYEST                                                
EKEYREST DS    XL(L'EKEY-(*-EKEY))                                              
         ORG                                                                    
       ++INCLUDE SPGENGOAL                                                      
       ++INCLUDE SPREPMODES                                                     
       ++INCLUDE SPMEDBLOCK                                                     
       ++INCLUDE DDBUFFD                                                        
       ++INCLUDE DDMASTD                                                        
       ++INCLUDE DDCOREQUS                                                      
       ++INCLUDE FALOCKETD                                                      
       ++INCLUDE DDCOMFACSD                                                     
       ++INCLUDE DEDBLOCK                                                       
SSBD     DSECT                                                                  
       ++INCLUDE FASSBOFF                                                       
         PRINT ON                                                               
         EJECT                                                                  
***********************************************************************         
* Global equates                                                      *         
***********************************************************************         
                                                                                
QPROGN2  EQU   C'N2',2                                                          
                                                                                
ONEK     EQU   1024                                                             
FOURK    EQU   ONEK*4                                                           
SIXK     EQU   ONEK*6                                                           
EIGHTK   EQU   ONEK*8                                                           
                                                                                
NENVS    EQU   3                   NUMBER OF ENVIRONMENTS                       
                                                                                
MINHOUR  EQU   60                  # OF MINUTES IN AN HOUR                      
SECSMIN  EQU   60                  # OF SECONDS IN A MINUTE                     
HOURDAY  EQU   24                  # OF HOURS IN A DAY                          
DAYWEEK  EQU   7                   # OF DAYS IN A WEEK                          
                                                                                
SECS10   EQU   10                  10 SECONDS                                   
SECS15   EQU   15                  15 SECONDS                                   
SECS20   EQU   20                  20 SECONDS                                   
SECS25   EQU   25                  25 SECONDS                                   
SECS30   EQU   30                  30 SECONDS                                   
SECS35   EQU   35                  35 SECONDS                                   
SECS40   EQU   40                  40 SECONDS                                   
SECS45   EQU   45                  45 SECONDS                                   
SECS50   EQU   50                  50 SECONDS                                   
SECS55   EQU   55                  55 SECONDS                                   
SECS60   EQU   60                  60 SECONDS                                   
SECS75   EQU   75                  75 SECONDS                                   
SECS90   EQU   90                  90 SECONDS                                   
                                                                                
YESQ     EQU   C'Y'                                                             
NOQ      EQU   C'N'                                                             
SPACE    EQU   C' '                                                             
SLASH    EQU   C'/'                                                             
EQUAL    EQU   C'='                                                             
OPAREN   EQU   C'('                                                             
CPAREN   EQU   C')'                                                             
ASTERISK EQU   C'*'                                                             
RATINGQ  EQU   C'R'                                                             
EXDRTGQ  EQU   C'E'                                                             
DASH     EQU   C'-'                                                             
COMMA    EQU   C','                                                             
                                                                                
EOR      EQU   0                                                                
FF       EQU   X'FF'                                                            
                                                                                
EOFQ     EQU   X'80'               END OF FILE                                  
NTFQ     EQU   X'10'               NOT FOUND                                    
                                                                                
ZONE     EQU   X'F0'               HIGH ORDER NIBBLE                            
DIGIT    EQU   X'0F'               LOW ORDER NIBBLE                             
                                                                                
TVNOPQ   EQU   X'80'               VARIABLE NO-OPED                             
TVOFFQ   EQU   X'40'               TARGET VARIABLE NO-OPED                      
                                                                                
ATOIBITS EQU   X'C0'               CONVERT TO ALPHA (A-I FOR CLASSES)           
TWOPTCLS EQU   X'99'               2-PART CLASS                                 
                                                                                
USERDEMO EQU   33                  USER DEMO NUMBER                             
NTGVARS  EQU   2                   N'TARGETS PER BRAND                          
RCPPPG   EQU   22                  PRODUCTS PER PAGE                            
RLOOPMAX EQU   15                  MAXIMUM N'RSCALE ITERATIONS                  
                                                                                
MAXPRDS  EQU   1024                MAXIMUM PRODUCTS (INCLUDING POL)             
MAXWEEKS EQU   26                  MAXIMUM N'WEEKS IN A RUN                     
MAXWKPP  EQU   15                  MAXIMUM N'WEEKS ON A PAGE                    
MAXWKPP2 EQU   12                  MAXIMUM N'WEEKS ON A PAGE 2                  
MAXWKNAD EQU   14                  MAXIMUM N'WEEKS FOR NAD REPORT               
                                                                                
PRDLENQ  EQU   3                   LENGTH OF PRODUCT CODE                       
PRDMSKQ  EQU   7                   ICM MASK FOR PRODUCT POINTER                 
                                                                                
ALLDPT   EQU   X'F9'               ALL DAYPART VALUE                            
ALLLEN   EQU   X'7F'               ALL LENGTH VALUE                             
                                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'010SPREPK502 01/06/10'                                      
         END                                                                    
