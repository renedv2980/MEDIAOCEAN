*          DATA SET PXB12A     AT LEVEL 021 AS OF 05/01/02                      
*  COPY OF DATA SET PPB12A     AT LEVEL 020 AS OF 04/06/94                      
*CATALP PPB12A                                                                  
         TITLE 'PRREPB102 - NEW PRINT BILLING'                                  
*        CHANGE LOG                                                             
*                                                                               
*  BPLA 9/96      PPB12AO SOURCE MADE LIVE                                      
*                 NOW INCLUDES PPREPB1WRK                                       
*                 NEEDS PPB1ACC                                                 
*                                                                               
*  BPLA 7/96      FIX RETAIL SUMMARY BILL HEADLINE                              
*                                                                               
*  BPLA 5/96      MOLSON FEATURE FOR BACKER - BS NOT TH                         
*                                                                               
*  BPLA 5/96      WHEN PAYOPT IS "Y" PROCESS INSERTIONS WITH                    
*                 NO DATED PAYELEMS IF BGROSS(12) IS NOT ZERO                   
*                 - NEED TO PRODUCE CREDITS                                     
*                                                                               
*  BPLA 4/96      SPECIAL FEATURE FOR ZENITH - MOLSON (RETAIL)                  
*                                                                               
*  BPLA 1/96      IN PRBUY - IF PROCESSING MANUAL BILL                          
*                 SKIP EXCULDING BILLING CHECK                                  
*                 IN RESTART - SKIP GOTO ARMBILL (MANUAL BILL READ)             
*                 IF MODE IS PGR1LAST                                           
*                 IN BKPRD - IF PROCESSING MANUAL BILL USE PRODUCT              
*                 FROM "BUY" INSTEAD OF KPRD                                    
*                                                                               
*  BPLA 9/95      CHANGES FOR SEQUENCING INVOICES BY OFFICE AND                 
*                 OFFICE LIST                                                   
*                                                                               
*  BPLA 7/95      WHEN REVERSING FINANCIAL BILL SET IDSP(4,RF) TO               
*                 F'1' EVEN IF I ONLY FIND OPEN BILLING                         
*                 WHEN I WASN'T PEPTAB WAS EMPTY AND BILLABLE                   
*                 AMOUNTS WERE WRONG.                                           
*                                                                               
*  BPLA 3/95      ALSO CLEAR VBTAB WHEN I GO TO SETDATE IN CFIRST               
*                              WHEN I DIDN'T SOMETIMES VAT BASIS                
*                              WAS WRONG FOR OFFICE AND BILLING GROUP           
*                              REQUESTS                                         
*                                                                               
*  BPLA 9/94      NEW PROFILE OPTION ON B4-B7 PROFILE                           
*                 AAA ADDRESS OPTION - Y MEANS USE AAA ADDRESS                  
*                 UNLESS A "REAL" ADDRESS HAS BEEN SET-UP FOR                   
*                 THE PRODUCT (EVEN IF PRODUCTS ARE ON SEPERATE                 
*                 INVOICES)                                                     
*                                                                               
*  BPLA 8/94      AT BH5F - CHECK FOR SPACES IN AJADDRS - NOT 0                 
*                                                                               
*  BPLA 7/27/94   IN BILHEAD - AT BH5F CHANGE                                   
*                        CLC   AJOBBRK,AINVBRK                                  
*                     TO CLI   JOBCTL,C'S'                                      
*                                                                               
*  BPLA 6/27/94   FIX PEPTAB KEY LENGHT IN PEPPARS                              
*  BPLA 6/23/94   IN CFIRST CHECK FOR AGY/MED/CLT BREAK                         
*                 INSTEAD OF AGY/MED WHEN GOING TO AAGMPROC                     
*                 ALSO RESTORE READ OF B1X PROFILE                              
*                 IN AGMPROC                                                    
*                 ALSO GOTO GETNUM EIF SAME MEDIA (IN CFIRST)                   
*                                                                               
*  BPLA 6/15/94   AND FINANCIAL BYTE TO MEDIA IN BRKTAB                         
*                 AS AN ATTEMPT TO HANDLE MIX OF FINANCIAL                      
*                 AND NON-FINANCIAL ON SAME BILL                                
*                                                                               
*  BPLA 5/13/94   IN GETNUM USE PPFMTINO TO FORMAT INVOICE NUMBERS              
*                 ALSO MOVE READING OF PB1X PROFILE TO SETDATE                  
*                                                                               
*                                                                               
*  BPLA 4/6/94    IN BLDTAB IF REQUEST IS FOR A SINGLE EST                      
*                 DON'T SET EST TO SEPERATE IF AGMFORMS IS 'L'                  
*                 OR 'B' (LONG LOGOS) AND REG/DST IS EPERATE                    
*                 THIS WOULD CAUSE DUMPS IN BILHEAD (TOO MANY                   
*                 HEADLINES)                                                    
*                                                                               
*  BPLA 2-3/94    CHANGES FOR PST                                               
*                                                                               
*  BPLA 1/94      IN GETNUM SET ON FCRDCLOS TO 'Y' TO READ CLOSED-OUT           
*                 BILLS - NEEDED SINCE UNBILLING NOW MAY CLOSE-OUT              
*                 BILLS INSTEAD OF DELETING THEM                                
*                                                                               
*  BPLA 10/93     CHANGES FOR RETPROF+13  DISTRIBUTOR DETAILS                   
*                                                                               
*  BPLA 10/5/93   NEW CDSEP OPTION - R - SPECIAL CD HANDLING                    
*                 WITH 'APPLY' MESSAGES                                         
*                                                                               
*  BPLA  8/20/93  AT BUYBK3A7 SEE IF DELETED WITH NO PAY ELEMS                  
*                 IF SO THEN SKIP THAT BUY                                      
*   BPLA 6/23/93  CHECK FOR 0 IN PROFB2B+1 BEFORE ALTERING                      
*                 QESTEND                                                       
*   BPLA 6/10/93  FIX BUG AFFECTING PAYOPTS E-F-G                               
*                                                                               
*   BPLA 5/25/93  PROCESS MANUAL BILLS WHEN DOING CLEARED ITEMS                 
*                 ONLY                                                          
*   BPLA 5/10/93  GETUSER ADDED TO ACONS                                        
*                                                                               
*   BPLA 3/1/93   DISALLOW SPECIAL CD HANDLING FOR UFC CLIENTS                  
*                                                                               
*   BPLA 1/27/93  FIXED BUG  - GOT "NO BILLING GERNERATED"                      
*                 WHEN USER TRIED TO REVERSE A FINANCIAL BILL                   
*                 THAT HAD NO OPEN BILLING                                      
*                                                                               
*   BPLA 10/26/92 IF QOPT8 = C SET OFF ADJSEP (CDSEP MUST BE LEFT ON            
*                 BUT NOT CD SEP BILL IS PRODUCED)                              
*                 IF QOPT8 = N SET OFF ADJSEP                                   
*                                                                               
*   BPLA 9/28/92  USE NTAXCALC TO GET TAX WHEN BILLING PAID ITEMS               
*                                                                               
*   BPLA 9/21/92  "FREE" DATE CHECK CHANGED FROM AUG01/92 TO SEP01/92           
*                                                                               
*   BPLA 8/4/92   IN BILHEAD CHECK RETPROF+13 TO SEE IF SUPPRESSING             
*                 DETAILS ON DISTRIBUTOR BILLS                                  
*   BPLA 7/31/92  IN BILHEAD CHECK FOR BLANK ESTIMATE NAME LINE 2               
*                                                                               
*   BPLA 7/29/92  DON'T BILL "FREE" INSERTIONS WHOSE INSERTION DATE             
*                 IS BEFORE AUG01/92                                            
*                 ALSO NEW MEANING FOR 7TH BYTE OF B2 PROFILE (+6)              
*                 WAS BEING MOVED TO ORIGTYPE (NO DETAIL MARKING)               
*                                                                               
*                 NEW VALUE - "Y"  MEANS BILL "FREE" INSERTIONS                 
*                 WHOSE INSERTION DATE IS ON OR AFTER AUG01/92                  
*                                                                               
*   BPLA 7/21/92  WHEN CHECKING PROFB2B AT REQFRST DON'T ALTER REQUEST          
*                 IF PROFB2B = "N"                                              
*                                                                               
*   BPLA 7/9/92   CHANGES TO USE PBBILST (IN PBILELEM) TO INDICATE              
*                 UPFRONT COMMISSION AND NET BILLING - INSTEAD OF               
*                 X'46' ELEMENTS FOR COMMISSION BILLING                         
*                 NOTE - THIS MODULE NEEDS NEW VERSION OF GETINS                
*                 THAT CAN HANDLE REQUESTS FOR UFC COMM AND                     
*                 UFC NET BILLING                                               
*                                                                               
*   BPLA 6/16/92  NO NEW COMMISSION BILLING FOR FINANCIAL CLIENTS               
*                                                                               
*   BPLA 6/8/92   WHEN BILLING CLEARED ITEMS ONLY CHK FOR ANY PAY               
*                 ELEM WITH A DATE ("FREE" INSERTIONS CHANGES                   
*                 CAUSED ALL UNPAID ITEMS TO GET BILLED WHEN                    
*                 REQUESTING CLEARED ITEMS ONLY)                                
*   BPLA 6/1/92   SETTING FILTER VALUES FOR COMM BILLING MUST BE                
*                 IN REQFRST, REMOVED FROM CFIRST                               
*                                                                               
*   BPLA 5/28/92  IF QDIST IS BLANK ONLY CHECK REGION AT BUYBK5I                
*                 PREVIOUS BILLS WERE MISSING WHEN QREG WAS REQUESTED           
*                 AND QDIST WAS BLANK IF THE SCHEME WAS REG/DST                 
*                                                                               
*   BPLA 5/26/92  B2B PROFILE EST FILTERS FOR COMM. BILLING                     
*                                                                               
*   BPLA 4/29/92  COMMISSION BILLING CHANGES                                    
*                                                                               
*   BPLA 4/20/92  CHANGES FOR BILLING "FREE" INSERTIONS                         
*                                                                               
*   BPLA 4/20/92  COPY OF PPB12AL (LEVEL 40)                                    
*                                                                               
*   BPLA 4/1/92   PCT. BILLING CONTROL                                          
*                 AT BUYBK3C CLEAR PREVIOUS BILLING IF MANPCT IS NOT            
*                 0 AND PCTCTL IS "N"                                           
*                                                                               
*   BPLA 3/25/92  EFFECTIVE DATE CHECK FOR PERCTL = "T"                         
*                 IN BUYBK3G                                                    
*   BPLA 7/18/91  FIX CLOBBERING OF "DOCUMENT" BY *AOR* AND                     
*                 "MEDIA BILLING" (EXPANDED FOR FRENCH)                         
*   BPLA 5/7/91   DISALLOW ADJ SEP OR CD SEP WITH AOR CLIENT LIST               
*                                                                               
*   BPLA 5/7/91   COPY OF PPB12AN (LEVEL 25)                                    
*                                                                               
*   BPLA 5/2/91   FIX 'BILLING' DISPLAY FOR STRIP OFF                           
*                                                                               
*   BPLA 4/25/91  NEW ROUTINE TO EXTRACT NET FROM NET+TAX                       
*                 TO ACCOUNT FOR GST                                            
*                                                                               
*   BPLA 3/26/91  CODE FOR DRAFT RBATE BILLING - RD                             
*                                                                               
*   BPLA 3/25/91  MORE FRENCH CHANGES                                           
*                                                                               
*   BPLA 3/11/91  CHANGES FOR GRANT'S AOR FEATURES                              
*                                                                               
*   BPLA 11/30/90 CHANGES FOR CANADIAN GST                                      
*                                                                               
*   BPLA 11/12/90 SKIP MANUAL BILL READ IN RESTART IF MODE=CLILAST -            
*                 WAS REREADING MANUAL BILLS OF LAST PRODUCT (READ              
*                 AT PRDLAST                                                    
*                                                                               
*   BPLA 9/26/90  REVERSAL INVOICE NUMBER NOW CHARACTERS (QMANUAL+7(4))         
*                 WAS BINARY (QMANUAL+7(2))                                     
*                                                                               
*        QOPT3 C=CD PUBS ONLY                                                   
*              N=NON-CD PUBS ONLY                                               
*                                                                               
*        QOPT1 C=CD ITEMS ONLY                                                  
*              N=NON-CD ITEMS ONLY                                              
*                                                                               
*        QOPT8 - ONLY FOR COMMISSION BILLING (B2B PROFILE SET TO 'Y')           
*              C= COMMISSION ONLY BILL                                          
*              N= NET BILL                                                      
*              R= REGULAR BILL                                                  
*         NOTE THAT QOPT8 IS IN QAREA2 (COL 62)                                 
*                                                                               
*        QPUB+1  MIGHT HAVE RD=XXX FOR DIV/REG/DST OVERRIDE CLIENT XXX          
*        QPUB+1(7) = IF JXXXXXX  AD CODE FILTER                                 
*                                                                               
*        QINVDATE AND QDUEDAYS IN QPAY (COL 53) USED TO BE IN                   
*        QPUB+1 AND QPUB+7                                                      
*                                                                               
*        QMANUAL NOW IN REC CARD 2 (COL 27)                                     
*                                                                               
PPB102   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,PPB102                                                         
         SPACE 2                                                                
         B     PROC                                                             
PATCH    DC    32X'00'                                                          
TRCE     DC    C'N'                                                             
         SPACE 2                                                                
PROC     DS    0H                                                               
         L     RA,0(R1)                                                         
         USING PPWORKD,RA                                                       
         MVI   RC2DSECT,C'Y'       2ND DSECT                                    
         L     R9,PPWORK2C                                                      
         USING PPWORK2D,R9                                                      
         LA    RC,SPACEND                                                       
         USING BILWRKD,RC                                                       
*                                  SAVE BASE REGS FOR HEADHOOK                  
         RELOC RELO                                                             
         L     RF,=A(SAVREGS)                                                   
         A     RF,RELO                                                          
         STM   R9,RA,0(RF)                                                      
*                                                                               
         CLI   MODE,PROCBUY                                                     
         BE    PROCESS                                                          
         BH    *+8                                                              
         MVI   DONESW,C'N'         RESET AT RESTART                             
         CLI   MODE,RUNFRST                                                     
         BE    RUNF                                                             
         CLI   MODE,REQFRST                                                     
         BE    REQF                                                             
         CLI   MODE,CLIFRST                                                     
         BE    CLTF                                                             
         CLI   MODE,PGR1FRST        DIVISIONS                                   
         BE    PGR1F                                                            
         CLI   MODE,PRDFRST                                                     
         BE    PRDF                                                             
         CLI   MODE,ESTFRST                                                     
         BE    ESTF                                                             
         CLI   MODE,MGR1FRST        REGIONS                                     
         BE    MGR1F                                                            
         CLI   MODE,MGR2FRST         DISTRICTS                                  
         BE    MGR2F                                                            
         CLI   MODE,PGR1LAST                                                    
         BE    PGR1L                                                            
         CLI   MODE,PGR2LAST                                                    
         BE    PGR2L                                                            
         CLI   MODE,PGR3LAST                                                    
         BE    PGR3L                                                            
         CLI   MODE,PRDLAST                                                     
         BE    PRDL                                                             
         CLI   MODE,MGR1LAST                                                    
         BE    MGR1L                                                            
         CLI   MODE,MGR2LAST                                                    
         BE    MGR2L                                                            
         CLI   MODE,MGR3LAST                                                    
         BE    MGR3L                                                            
         CLI   MODE,MKTLAST                                                     
         BE    MKTL                                                             
         CLI   MODE,CLILAST                                                     
         BE    CLTL                                                             
         CLI   MODE,FBUYPUB                                                     
         BE    PUBF                                                             
         CLI   MODE,RUNLAST                                                     
         BE    RUNL                                                             
         CLI   MODE,REQLAST                                                     
         BE    REQL                                                             
         CLI   MODE,LBUYXRQ    LAST FOR MULTI-MEDIA REQ                         
         BNE   EXIT                                                             
         XC    QSAVE,QSAVE                                                      
         MVI   DONESW,C'N'                                                      
         B     RESTART                                                          
*                                                                               
         SPACE 2                                                                
EXIT     DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
*        RUNFRST                                                                
         SPACE 2                                                                
RUNF     DS    0H                                                               
         MVI   DMINBTS,X'08'       SET TO PASS DELETES                          
         MVI   DMOUTBTS,X'FD'                                                   
*                                  RELOCATE ADDRESSES                           
         MVC   SQEND,=CL6' '                                                    
*                                                                               
         LA    R0,(ACONSX-ACONS)/4      NO. OF ADDRS                            
         L     R2,=A(ACONS)                                                     
         A     R2,RELO                                                          
         LA    R3,RCONS                                                         
RUNF2    DS    0H                                                               
         L     RF,0(R2)                                                         
         A     RF,RELO                                                          
         ST    RF,0(R3)                                                         
         LA    R2,4(R2)                                                         
         LA    R3,4(R3)                                                         
         BCT   R0,RUNF2                                                         
*                                                                               
         MVI   FFS,X'FF'                                                        
         MVC   FFS+1(L'FFS-1),FFS                                               
         MVI   DASHES,C'-'                                                      
         MVC   DASHES+1(L'DASHES-1),DASHES                                      
         MVI   ZEROS,C'0'                                                       
         MVC   ZEROS+1(L'ZEROS-1),ZEROS                                         
         MVC   TOTSIZH,=Y(TOTSIZE)                                              
         MVC   XXPUB,=X'9999999999E9'   SPECIAL PUB-99999999,99,Z               
*                                                                               
         L     RE,ALEVTOTS                                                      
         L     RF,=A(TOTSIZE*MAXLEVS)                                           
         XCEF                                                                   
*                                                                               
         L     RF,ALINTAB                                                       
         LA    0,LINTABN                                                        
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
         MVC   ANXTLIN,ALINTAB                                                  
         MVI   PRSW,C'N'                                                        
*                                                                               
*                                  SET BINSRCH PARS FOR PEPTAB                  
         SR    R0,R0                                                            
         L     R1,=V(PEPTAB)                                                    
         A     R1,RELO                                                          
         SR    R2,R2                                                            
         LA    R3,PEPTABRL                                                      
         LA    R4,PEPTKEYL         PRINT KEY LENGHT (12)                        
*                           MED,FIN,PRD(3), EST(2), PER(2), SPARE(3)            
         LA    R5,PEPTBN                                                        
         STM   R0,R5,PEPPARS                                                    
*                             SET BINSRCH PARS FOR INVTAB                       
         L     R1,=V(INVTAB)                                                    
         A     R1,RELO                                                          
         LA    R3,INVTABRL                                                      
         LA    R4,INVTABKL                                                      
         LA    R5,INVTBN                                                        
         STM   R0,R5,INVPARS                                                    
*                                                                               
         SR    R0,R0               SET CLIENT LIST BINSRCH PARS                 
         L     R1,=V(CLTTAB)                                                    
         A     R1,RELO                                                          
         SR    R2,R2                                                            
         LA    R3,4                                                             
         LA    R4,4                                                             
         LA    R5,CLTBMAX                                                       
         STM   R0,R5,CLTPARS                                                    
*                                                                               
*                             SET BINSRCH PARS FOR UPETAB                       
         L     R1,=V(UPETAB)                                                    
         A     R1,RELO                                                          
         LA    R3,UPETABRL                                                      
         LA    R4,UPETABKL                                                      
         LA    R5,UPETABN                                                       
         STM   R0,R5,UPEPARS                                                    
*                                                                               
         B     EXIT                                                             
         SPACE 3                                                                
*        REQFRST                                                                
         SPACE 2                                                                
REQF     DS    0H                                                               
*                              DO CONTROLLERS WORK-SET PPWORK2D FIELDS          
         L     R6,PPFILEC                                                       
         LA    R7,1(R6)                                                         
         LA    R7,4095(R7)                                                      
         USING PPFILED,R6,R7                                                    
*                                                                               
         LA    RF,PAGYREC                                                       
         ST    RF,ADAGY                                                         
         LA    RF,PCLTREC                                                       
         ST    RF,ADCLT                                                         
         LA    RF,PPRDREC                                                       
         ST    RF,ADPRD                                                         
         LA    RF,PESTREC                                                       
         ST    RF,ADEST                                                         
         LA    RF,PBUYREC                                                       
         ST    RF,ADBUY                                                         
         LA    RF,PBILLREC                                                      
         ST    RF,ADBILL                                                        
         LA    RF,PUBREC                                                        
         ST    RF,ADPUB                                                         
         DROP  R6,R7                                                            
*                                                                               
         L     R6,=V(DICSECT)                                                   
         USING DICSECT,R6                                                       
*                                                                               
         XC    DMCB,DMCB                                                        
         LA    R1,DMCB                                                          
         USING DICTATED,R1                                                      
         MVI   DDACTN,DDACTNL      TRANSLATE LIST                               
         MVI   DDRETN,DDCASEU                                                   
         MVI   DDSYS,4                                                          
         MVC   DDLANG,RCLANG                                                    
         LA    RF,DCLIST                                                        
         STCM  RF,7,DDIADR                                                      
         LA    RF,DSLIST                                                        
         STCM  RF,7,DDOADR                                                      
         GOTO1 DICTATE                                                          
         DROP  R1,R6                                                            
*                                                                               
         MVI   MOLSON,C'N'         SET OFF MOLSON OPTION                        
*                                                                               
         MVI   CURTAB+3,2          SET DEFAULT TO 2 DECIMALS                    
*                                                                               
         L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   MGR1BK(6),=C'REGION'                                             
*--->    MVC   MGR2BK(8),=C'DISTRICT'                                           
*--->    MVC   PGR1BK(8),=C'DIVISION'                                           
         MVC   MGR1BK(L'PP@REGN),PP@REGN                                        
         MVC   MGR2BK(L'PP@DIST),PP@DIST                                        
         MVC   PGR1BK(L'PP@DIV),PP@DIV                                          
         DROP  RE                                                               
*                                                                               
         MVI   MGR1LEN,3                                                        
         MVI   MGR2LEN,3                                                        
         MVI   PGR1LEN,3                                                        
         XC    SAVMGRU,SAVMGRU                                                  
         CLI   QREGION,C'0'        FOR  REQS FOR ONE REG/DST                    
         BL    *+10                MUST SET SAVMGRU HERE                        
         MVC   SAVMGRU(3),QREGION  BECAUSE I DON'T GET MODE SETTINGS            
         CLI   QDIST,C'0'                                                       
         BL    *+10                                                             
         MVC   SAVMGRU+3(3),QDIST                                               
*                                                                               
         L     RF,ADAGY                                                         
         MVC   AGYADR,PAGYADDR-PAGYREC(RF)                                      
         MVC   AGYNM,PAGYNAME-PAGYREC(RF)                                       
*                                                                               
         MVC   MED,QMEDIA                                                       
         MVC   MEDNM,PAGYMED-PAGYREC(RF)                                        
         CLI   RCLANG,4            SEE IF FRENCH                                
         BNE   REQF3               CHANGE NEWPAPERS TO JOURNAUX                 
         CLI   QMEDIA,C'N'                                                      
         BNE   REQF2                                                            
         MVC   MEDNM,=CL10'JOURNAUX'                                            
         B     REQF3                                                            
*                                                                               
REQF2    CLI   QMEDIA,C'O'       CHANGE OUTDOOR TO EXTERIOR                     
         BNE   REQF3                                                            
         MVC   MEDNM,=CL10'EXTERIEUR'                                           
*                                                                               
REQF3    DS    0H                                                               
         MVC   TODAY(2),RCDATE+6                                                
         MVC   TODAY+2(2),RCDATE                                                
         MVC   TODAY+4(2),RCDATE+3                                              
         GOTO1 DATCON,DMCB,TODAY,(3,TODAYB)                                     
*                                                                               
         CLI   RCMULTIQ,C'Y'       SEE IF DOING MULTI-MEDIA REQ                 
         BNE   REQF5                                                            
         CLI   QMEDIA,C'M'         SEE IF FIRST MEDIA                           
         BE    REQF5                                                            
         B     REQF7              DON'T RESET PAGE,SETDSW,BTABSW                
*                                                                               
REQF5    MVC   PAGE,=H'1'                                                       
         MVI   SETDSW,C'N'                                                      
         MVI   BTABSW,C'N'                                                      
         MVI   CLTRDSW,C'N'                                                     
         CLI   QCLIENT,C'*'       SEE IF OFFICE GROUP REQUEST                   
         BE    REQF6                                                            
         CLI   QCLIENT,C'&&'      SEE IF OFFICE GROUP REQUEST                   
         BNE   REQF7                                                            
REQF6    XC    QSAVE,QSAVE        MUST CLEAR LAST REQUEST                       
         MVC   SQEND(6),QEND      SAVE ORIGINAL QEND                            
*                                 RESET IN QEND AT CLIFRST                      
*                                 TO ASSURE PROPER B1 PROFILE                   
*                                 AND INVOICE NUMBER SEQUENCING                 
*                                                                               
REQF7    MVI   FCRDBUY,C'Y'       ACTIVATE READING OF BUYS                      
         MVI   FCRDACTV,C'N'                                                    
         MVI   PUBSW,0                                                          
         XC    ESTNAM2,ESTNAM2                                                  
         CLC   QPRODUCT,SPACES                                                  
         BNE   *+8                                                              
         MVI   FCRDACTV,C'Y'                                                    
         MVI   ACTSW,C'N'                                                       
         XC    DBTOTS(24),DBTOTS   CLEAR REQ CHECKING TOTALS                    
         MVC   SORTTRCE,TRCE                                                    
         MVI   RETDRAFT,C'N'                                                    
         CLC   QPROG,=C'BD'                                                     
         BNE   *+8                                                              
         MVI   RETDRAFT,C'Y'                                                    
         MVC   TYPE,QOPT2          BILLING TYPE IS QOPT2                        
         CLI   TYPE,C' '                                                        
         BNE   *+8                                                              
         MVI   TYPE,C'4'                                                        
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+8                                                              
         MVI   TYPE,C'D'                                                        
*                                                                               
         MVC   SAVTRACE,RCTRACE                                                 
*                                                                               
         L     RE,APDLIST         CLEAR PRDLIST FOR RETAIL                      
         LH    RF,=H'1500'                                                      
         XCEF                                                                   
*                                  STANDARDIZE QEST (BLANK = ALL)               
*                                  IF USING FILTERS MUST LEAVE                  
*                                  QEST BLANK                                   
*                                                                               
*                                                                               
         CLC   QEST(6),SPACES                                                   
         BNE   *+10                                                             
         MVC   QEST,=C'ALL'                                                     
*                                                                               
         XC    MANGRS(16),MANGRS    IN CASE NEXT REQ IS A MANUAL                
*                                   BILL WITH NO ACTIVITY                       
*                                SO I'LL GO TO ACFIRST IN CLTLAST               
**********                                                                      
*        ENTER/ALTER ESTIMATE FILTER FOR COMMISSION BILLING CLTS                
*        ONLY FOR SINGLE CLIENT REQUESTS                                        
*        WARNING BILLING WILL BE SCREWED UP IF B2B PROFILE IS                   
*        DIFFERENT BY MEDIA AND THE REQUEST IS FOR MEDIA *                      
*        OR IF CLT HEADER DOES NOT EXIST                                        
**********                                                                      
*                                  READ B2B PROFILE                             
         CLC   QCLIENT,=C'ALL'                                                  
         BE    REQF20                                                           
         CLI   QCLIENT,C'*'                                                     
         BE    REQF20                                                           
         CLI   QCLIENT,C'&&'       BILLING GROUP                                
         BE    REQF20                                                           
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),QAGENCY                                                   
         MVC   KEY+2(1),QMEDIA                                                  
         MVI   KEY+3,X'02'                                                      
         MVC   KEY+4(3),QCLIENT                                                 
REQF9    L     RF,ADCLT                                                         
         CLC   0(7,RF),KEY         SEE IF CLIENT ALREADY THERE                  
         BE    REQF15                                                           
         GOTO1 HIGH                                                             
         CLC   KEY(7),KEYSAVE                                                   
         BE    REQF10                                                           
         B     EXIT              CLIENT NOT FOUND - EXIT                        
*                                COULD HAPPEN FOR MULTI-MEDIA REQUEST           
*                                                                               
REQF10   GOTO1 GETCLI                                                           
*                                                                               
REQF15   XC    WORK,WORK                                                        
         MVC   WORK(4),=C'PB2B'                                                 
         NI    WORK,X'BF'          LOWER CASE                                   
         MVC   WORK+4(3),QAGENCY                                                
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   *+14                                                             
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
         CLI   WORK+6,C'*'         SEE IF MEDIA "*" REQUEST                     
         BNE   REQF18                                                           
         L     RF,ADCLT                                                         
         MVC   WORK+6(1),2(RF)     USE MEDIA FORM CLIENT HEADER                 
*                                                                               
REQF18   GOTO1 GETPROF,DMCB,WORK,PROFB2B,DATAMGR                                
*                                                                               
         OC    PROFB2B,PROFB2B                                                  
         BZ    REQF20                                                           
*                                                                               
         CLI   PROFB2B,C'N'                                                     
         BE    REQF20                                                           
*                                                                               
         CLI   PROFB2B+1,0    SEE IF REGULAR EST FILTER POSITION                
         BE    REQF20         DESIGNATED                                        
*                                                                               
REQF18E  CLC   QEST,=C'ALL'                                                     
         BNE   REQF20                                                           
*                                                                               
         CLI   QESTEND,C' '         CHK FOR FILTER ALREADY THERE                
         BH    *+10                                                             
         MVC   QESTEND(3),=C'***'                                               
*                                                                               
         ZIC   RF,PROFB2B+1                                                     
         LA    RF,QESTEND-1(RF)                                                 
         MVC   0(1,RF),PROFB2B+2        SET FILTER VALUE IN REQUEST             
         CLI   QOPT8,C'R'                                                       
         BE    *+8                                                              
         NI    0(RF),X'BF'              SET TO ALL BUT                          
*                                                                               
*                                                                               
REQF20   DS    0H                                                               
         GOTO1 =V(VBADD),DMCB,(C'C',0)     CLEAR VBTAB                          
         B     EXIT                                                             
         SPACE 3                                                                
*        CLTFRST                                                                
CLTF     DS    0H                                                               
*                                                                               
         GOTO1 ACFIRST                                                          
*                          CLTSW MAY BE SET TO 'N'                              
*                          FOR TYPERRS AND PROFERRS                             
*                          IF QCLIENT = ALL,*,&                                 
         B     EXIT                                                             
         SPACE 2                                                                
PGR1F    DS    0H                                                               
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         MVC   SAVPGRU(3),PDIVKDIV                                              
*                                                                               
         MVI   MOLSON,C'N'      SET OFF MOLSON OPTION                           
         CLC   QAGENCY,=C'BS'   SEE IF BACKER                                   
         BNE   PGR1FX                                                           
*******  CLC   QAGENCY,=C'TH'   SEE IF ZENITH                                   
*******  BNE   PGR1FX                                                           
         CLI   RETPROF,0         SEE IF RETAIL                                  
         BE    PGR1FX                                                           
         CLC   PDIVKDIV,=C'002' SEE IF DIVISION 2                               
         BNE   PGR1FX                                                           
         CLC   PDIVNAME(6),=C'MOLSON'   SHOULD CLINCH IT                        
         BNE   PGR1FX                                                           
         MVI   MOLSON,C'Y'      SET ON MOLSON OPTION                            
*                                                                               
PGR1FX   B     EXIT                                                             
         SPACE 2                                                                
         DROP  RF                                                               
*                                                                               
*        PRDFRST                                                                
PRDF     DS    0H                                                               
*                                  SET BILL FORMULA EFF DATE                    
         XC    EFFDTE,EFFDTE                                                    
         XC    PRDFORM,PRDFORM                                                  
         XC    PRDFORM2,PRDFORM2                                                
         XC    PRDFORM3,PRDFORM3                                                
         XC    ESTFORM,ESTFORM                                                  
         XC    ESTFORM2,ESTFORM2                                                
         XC    ESTFORM3,ESTFORM3                                                
         L     RF,ADPRD                                                         
         MVC   KPRD,PPRDKPRD-PPRDREC(RF)   USED IN PRBUY                        
         MVC   PRDFORM,PPRDBILP-PPRDREC(RF)                                     
         MVC   PRDFORM2,PPRDBILP+37-PPRDREC(RF)                                 
         MVC   PRDFORM3,PPRDBILP+44-PPRDREC(RF)                                 
*                                                                               
         CLI   PREVSW,C'P'         IF PREVIOUS ONLY                             
         BE    PRDF4                                                            
         OC   MANGRS(12),MANGRS    OR MANUAL BILL                               
         BZ    PRDF6                                                            
**NEW 6/20/88                                                                   
         CLI   ESTQ,C'1'           FOR SINGLE EST REQ                           
         BNE   PRDF3                                                            
         OC    RETPROF,RETPROF     AND RETAIL                                   
         BZ    PRDF3                                                            
         B     PRDF6             DON'T SET FCRDBUY TO 'N' YET                   
*                                NEEDED SO I'LL READ ESTIMATE                   
*                                AND CAN SET NON-RETAIL IF                      
*                                NON-RETAIL ESTIMATE.                           
*                                ESTF WILL THEN SET MODE TO CLILAST             
**NEW 6/20/88                                                                   
PRDF3    MVI   MODE,CLILAST        TO SKIP BUY READING                          
         B     CLTL                                                             
PRDF4    DS    0H                                                               
         MVI   FCRDBUY,C'N'       SET NO TO READ BUYS                           
PRDF6    DS    0H                                                               
         B     EXIT                                                             
         SPACE 2                                                                
*        ESTFRST                                                                
ESTF     DS    0H                                                               
         L     RF,ADEST                                                         
         MVC   ESTFORM,PESTBILP-PESTREC(RF)                                     
         MVC   ESTFORM2,PESTREVN+3-PESTREC(RF)                                  
         MVC   ESTFORM3,PESTREVN+10-PESTREC(RF)                                 
         XC    AAEFORM,AAEFORM                                                  
         XC    AAEFORM2,AAEFORM2                                                
         XC    AAEFORM3,AAEFORM3                                                
         L     RE,AAELIST                                                       
*                                                                               
ESTF10   CLC   0(6,RE),FFS                                                      
         BE    ESTF20                                                           
         CLC   10(2,RF),0(RE)                                                   
         BE    ESTF15                                                           
         LA    RE,53(RE)                                                        
         B     ESTF10                                                           
*                                                                               
ESTF15   DS    0H                                                               
         MVC   AAEFORM,2(RE)                                                    
         MVC   AAEFORM2,39(RE)                                                  
         MVC   AAEFORM3,46(RE)                                                  
*                                                                               
ESTF20   DS    0H                                                               
         CLI   ESTQ,C'1'           IF ONE EST REQ                               
         BNE   EXIT                                                             
         L     RF,ADEST                                                         
*                                                                               
*                                                                               
         CLC   PESTRSCH-PESTREC(2,RF),SPACES     NO RETAIL SCHEME               
         BH    ESTF25                                                           
         MVI   NONRET,C'Y'         THEN SET OFF RETAIL                          
         XC    RETPROF,RETPROF                                                  
         MVI   SUMOPT,C'N'                                                      
         B     ESTF25                                                           
*                                                                               
ESTF25   DS    0H                                                               
         CLI   SCBOPT,C'Y'             SEP COMM BILLING OPT                     
         BNE   ESTF30                                                           
         CLI   PROFB2B+1,0             CHK FOR FILTER POSITION                  
         BE    ESTF30                                                           
         ZIC   R2,PROFB2B+1                                                     
         LA    R2,PESTGRPS-1-PESTREC(R2,RF)                                     
*                                                                               
         CLI   SCBNCSW,C'R'            REGULAR ESTIMATE REQUEST                 
         BNE   ESTF26                                                           
         CLC   0(1,R2),PROFB2B+2                                                
         BE    ESTF30                                                           
         B     ESTFERR                 MISMATCH - REJECT                        
*                                                                               
ESTF26   DS    0H                                                               
         CLC   0(1,R2),PROFB2B+2       REJECT IF EQUAL                          
         BNE   ESTF30                                                           
*                                                                               
ESTFERR  MVI   ERR,ESTERR                                                       
         GOTO1 AERRPROC                                                         
*                                                                               
ESTF30   OC    MANGRS(12),MANGRS       SEE IF DOING A MANUAL BILL               
         BZ    ESTFX                                                            
         MVI   MODE,CLILAST            NEEDED SINCE I MAY GET HERE              
         B     CLTL                    IF DOING A MANUAL BILL FOR               
*                                       A SINGLE EST RETAIL REQUEST             
ESTFX    B     EXIT                                                             
*                                                                               
**NEW 6/20/88                                                                   
         SPACE 2                                                                
*        MGR1FRST                                                               
MGR1F    DS    0H                                                               
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         MVC   SAVMGRU(3),PREGKREG                                              
         B     EXIT                                                             
         SPACE 3                                                                
MGR2F    DS    0H                                                               
         CLI   QDIST,C' '              SEE IF DISTRICT REQ                      
         BE    EXIT                    NO JUST EXIT                             
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         CLC   PREGKCLT(9),PDSTKCLT     DISTRICT MUST BE FOR                    
         BNE   MGERR                    RIGHT CLT/DIV/REG                       
         MVC   SAVMGRU+3(3),PDSTKDST                                            
         B     EXIT                                                             
*                                                                               
MGERR    CLI   PROGPRO2+3,C'N'         SEE IF REG/DST SUPPRESSED                
         BNE   MGERR5                                                           
         CLC   QDIST,=C'ALL'                                                    
         BNE   MGERR5                                                           
         MVC   SAVMGRU+3(3),=C'999'    SET DUMMY DISTRICT                       
         B     EXIT                                                             
*                                                                               
MGERR5   MVI   ERR,MGRERR              REGION/DISTRICT ERROR                    
*                                      CAUSED WHEN PUB ASSGINED                 
*                                      TO A REGION BUT NOT A DST                
*                                      USED TO CAUSE DUMPS AT FMGR2             
         GOTO1 AERRPROC                                                         
         B     EXIT                                                             
         DROP  RF                                                               
*                                                                               
         EJECT                                                                  
*        PGR1LAST                                                               
PGR1L    DS    0H                                                               
         L     R3,APGR1BRK                                                      
         B     PGRXL                                                            
         SPACE 2                                                                
*        PGR2LAST                                                               
PGR2L    DS    0H                                                               
         L     R3,APGR2BRK                                                      
         B     PGRXL                                                            
         SPACE 2                                                                
*        PGR3LAST                                                               
PGR3L    DS    0H                                                               
         L     R3,APGR3BRK                                                      
         B     PGRXL                                                            
         SPACE 2                                                                
PGRXL    DS    0H                                                               
         LTR   R3,R3                                                            
         BZ    EXIT                LEVEL NOT USED                               
         C     R3,AINVBRK                                                       
         BH    EXIT                LEVEL 'BELOW' INV BREAK                      
         B     RESTART                                                          
         SPACE 2                                                                
*        PRDLAST                                                                
PRDL     DS    0H                                                               
         CLC   APRDBRK,AINVBRK                                                  
         BH    PRDL2                LEVEL 'BELOW' INV BREAK                     
         L     RF,ADPRD                                                         
         MVC   KPRD,PPRDKPRD-PPRDKEY(RF)                                        
         B     RESTART                                                          
PRDL2    DS    0H                                                               
         CLI   PREVSW,C'N'         SEE IF DOING PREVIOUS BILLS                  
         BE    EXIT                                                             
         L     RF,ADPRD                                                         
         MVC   KPRD,PPRDKPRD-PPRDKEY(RF)                                        
         GOTO1 ARMBILL             MUST READ MANUAL BILLS                       
         B     EXIT                                                             
         SPACE 2                                                                
*        MGR1LAST                                                               
MGR1L    DS    0H                                                               
         L     R3,AMGR1BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
*        MGR2LAST                                                               
MGR2L    DS    0H                                                               
         L     R3,AMGR2BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
*        MGR3LAST                                                               
MGR3L    DS    0H                                                               
         L     R3,AMGR3BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
MGRXL    DS    0H                                                               
         LTR   R3,R3                                                            
         BZ    EXIT                LEVEL NOT USED                               
         CLI   SUMOPT,C'Y'         IF DOING RETAIL CORP SUMMARY                 
         BE    EXIT                DONT DO 1 MGR AT A TIME                      
         CLI   MGRBKTS,C'Y'        OR IF MGR BUCKETS                            
         BE    EXIT                                                             
         C     R3,AINVBRK                                                       
         BH    EXIT                LEVEL 'BELOW' INV BREAK                      
         CLC   APRDBRK,AINVBRK                                                  
         BH    EXIT                PRD 'BELOW' INV BREAK                        
         L     RF,ADPRD                                                         
         MVC   KPRD,PPRDKPRD-PPRDREC(RF)                                        
         B     RESTART                                                          
         SPACE 2                                                                
*        MKTLAST                                                                
         SPACE 2                                                                
MKTL     DS    0H                  **INACTIVE**                                 
         B     EXIT                                                             
         SPACE 2                                                                
*        CLTLAST                                                                
         SPACE 2                                                                
CLTL     DS    0H                                                               
         OC   MANGRS(12),MANGRS      MANUAL BILL (WITH ACTIVITY)                
         BNZ   RESTART                                                          
         CLI   QMANUAL,C'G'          TEST FOR MANUAL BILL                       
         BE    CLTL5                 WITH NO ACTIVITY                           
         CLI   QMANUAL,C'F'          OR MANUAL FEE                              
         BNE   RESTART                                                          
CLTL5    GOTO1 ACFIRST               MUST GO THROUGH CLI FIRST                  
         MVC   KPRD,QPRODUCT         MUST SET PRD FOR PRBUY                     
         MVI   DONESW,C'N'                                                      
         B     RESTART                                                          
         EJECT                                                                  
         SPACE 2                                                                
RESTART  DS    0H                                                               
RSTR     DS    0H                                                               
         CLI   DONESW,C'D'                                                      
         BE    RSTR2                                                            
         MVI   DONESW,C'D'                                                      
         OC   MANGRS(12),MANGRS    TEST MANUAL BILLING                          
         BZ    RSTR1D              NO                                           
*                                  YES - SET UP DUMMY BUY AND POST IT           
         L     RF,ADBUY                                                         
         USING PBUYREC,RF                                                       
         MVC   PBUYKCLT,QCLIENT                                                 
         MVC   PBUYKPRD,QPRODUCT                                                
         MVC   KPRD,QPRODUCT                                                    
         PACK  DUB,QEST                                                         
         CVB   R0,DUB                                                           
         STH   R0,HALF                                                          
         MVC   PBUYKEST,HALF                                                    
         MVC   PBUYKPUB(6),XXPUB                                                
         MVC   PBDBDATE,PERLIST+5       MOVE START DATE                         
*                                                                               
         DROP  RF                                                               
*                                                                               
         GOTO1 APRBUY              PROCESS MANUAL AS DUMMY BUYS                 
*                                                                               
RSTR1D   DS    0H                                                               
         OC    BRKTAB,BRKTAB       TEST HAVE SET KEY TABLE                      
         BZ    RSTR1H              NO- NO PROCESSING                            
         OC   MANGRS(12),MANGRS    SEE IF MANUAL BILL                           
         BNZ   RSTR1F              YES - SKIP READ OF OLD MANUAL BILLS          
         CLI   MODE,PGR3LAST                                                    
         BNL   RSTR1F                                                           
         CLI   PREVSW,C'N'                                                      
         BE    RSTR1F                                                           
*                                                                               
         CLI   MODE,CLILAST        SEE IF CLIENT LAST                           
         BE    RSTR1F              SKIP MANUAL BILL READ                        
         CLI   MODE,PGR1LAST       OR LAST FOR DIVISION                         
         BE    RSTR1F              SKIP MANUAL BILL READ                        
         GOTO1 ARMBILL             READ OLD MANUAL BILLS                        
RSTR1F   L     RF,ABUFFC                                                        
         L     RF,BUFFSOFA-BUFFALOD(RF)                                         
         LTR   RF,RF                                                            
         BZ    RSTR1H              NO DATA                                      
         CLI   RCMULTIQ,C'Y'       SEE IF DOING MULTI-MEDIA REQ                 
         BNE   RSTR1G                                                           
         CLI   MODE,LBUYXRQ         SEE IF LAST FOR MULTIU-MEDIA REQ            
         BNE   RSTR2                                                            
*                                                                               
RSTR1G   GOTO1 ARDBUFF                                                          
*                                                                               
RSTR1H   DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'RESET',ABUFFC                                    
*                                                                               
*                                                                               
RSTR2    DS    0H                                                               
         CLI   MODE,CLILAST                                                     
         BNE   EXIT                                                             
**NEW 3/11/91                                                                   
         CLI   AORLOPT,C'C'                                                     
         BNE   RSTR3                                                            
         MVI   AORLCTL,C'P'                                                     
         GOTO1 AAORINV                                                          
         XC    PEPTABN,PEPTABN     CAN FINALLY CLEAR PEPTAB                     
*                                  IT'S NORMALLY CLEARED IN ENDINV              
*                                                                               
RSTR3    DS    0H                                                               
**NEW 3/11/91                                                                   
         OC   MANGRS(12),MANGRS    SEE IF MANUAL BILL                           
         BZ    RSTR4                                                            
         MVC   DBTOTS,MANGRS                                                    
         MVI   MODE,LBUYREQ        SO PPG WILL GO TO NEXT REQ                   
*                                  TEST DISCREPANT TOTALS                       
RSTR4    CLI   RETDRAFT,C'Y'                                                    
         BE    EXIT                                                             
***E***                                                                         
         CLC   QPROG,=C'E1'      ESTIMATE - NO OBTOTS + DBTOTS CHK              
         BE    EXIT                                                             
***E***                                                                         
         CLC   OBTOTS,DBTOTS                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   ACTSW,C'Y'                                                       
         BE    EXIT                                                             
*                                                                               
RSTR6    DS    0H                                                               
**NEW 7/13/88                                                                   
         CLI   QCLIENT,C'&&'       CHK GROUP REQUEST                            
         BE    EXIT                YES - JUST EXIT                              
         CLI   QCLIENT,C'*'        CHK OFFICE REQUEST                           
         BE    EXIT                YES - JUST EXIT                              
         CLC   QCLIENT,=C'ALL'      CHK ALL CLT REQUEST                         
         BE    EXIT                YES - JUST EXIT                              
**NEW 7/13/88                                                                   
         CLI   RCMULTIQ,C'Y'       SEE IF MULTI-MEDIA REQ                       
         BNE   RSTR8                                                            
         CLI   MODE,LBUYXRQ        ONLY FOR LAST MEDIA                          
         BNE   EXIT                                                             
RSTR8    MVI   ERR,NOBILERR        NO BILLING GENERATED                         
         GOTO1 AERRPROC                                                         
         SPACE 3                                                                
*                                                                               
*        REQUEST LAST                                                           
REQL     MVC   QSAVE,QPROG                                                      
         CLI   CLTRDSW,C'Y'         SEE IF REQUEST READ A CLIENT                
         BE    EXIT                                                             
         CLI   RCMULTIQ,C'Y'        SEE IF MULTI-MEDIA REQUEST                  
         BE    EXIT                 YES - MUST LEAVE QSAVE ALONE                
*                                   IT WILL BE CLEARED AT LBUYXRQ               
         XC    QSAVE,QSAVE                                                      
*                                   CLEAR QSAVE IF NO CLIENT READ               
*                                   FOR THIS REQUEST SO NEXT REQ                
*                                   WILL GO TO AMGPROC AT CFIRST                
         B     EXIT                                                             
*                                                                               
*        RUN LAST                                                               
RUNL     DS    0H                                                               
***E***                                                                         
         CLC   QPROG,=C'E1'                                                     
         BE    EXIT                                                             
***E***                                                                         
         GOTO1 AINVREG                                                          
         B     EXIT                                                             
         EJECT                                                                  
*        PROCESS BUY                                                            
PROCESS  DS    0H                                                               
         CLI   QOPT1,C' '                                                       
         BE    PROC20                                                           
         L     RF,ADBUY                                                         
         USING PBUYREC,RF                                                       
         CLI   QOPT1,C'C'          SEE IF DOING CD ITEMS ONLY                   
         BNE   PROC5                                                            
         CP    PBDCD,=P'0'                                                      
         BE    EXIT                NO CD SO IGNORE ITEM                         
         B     PROC20                                                           
*                                                                               
PROC5    CP    PBDCD,=P'0'         MUST BE DOING NON-CD ITEMS                   
         BE    PROC20                                                           
         B     EXIT                CD ITEM SO IGNORE IT                         
*                                                                               
PROC20   GOTO1 APRBUY                                                           
         B     EXIT                                                             
         DROP  RF                                                               
         EJECT                                                                  
PUBF     DS    0H                                                               
CHKSRT   DS    0H                                                               
         CLI   RETPROF,0        NO MULTIPLE ASSIGN ALLOWED FOR RETAIL           
         BNE   CKS8                                                             
         CLC   QREGION,SPACES                                                   
         BE    CKS13                                                            
         CLI   MGR1CTL,C'S'     NO MULTIPLE ASSIGNS FOR                         
         BE    CKS8             SEPERATE INV BY REG                             
         CLI   MGR2CTL,C'S'     NO MULTIPLE ASSIGNS FOR                         
         BE    CKS8             SEPERATE INV BY DISTRICT                        
         CLI   QMANUAL,C'R'     SEE IF REVERSAL                                 
         BE    CKS8             CAN'T REVERSE IF MULTIPLE REG/DST               
*                               MUST UNBILL                                     
*                               WILL GET MULTIPLE REVERSAL BILLINGS             
         CLC   QREGION,=C'ALL'                                                  
         BE    CKS13                                                            
*                  IF BY SINGLE REG OR DIST, NO MULTIPLE ASSIGN                 
CKS8     L     R2,ALTLREC                                                       
         LTR   R2,R2                                                            
         BZ    CKS13               NO LTLREC                                    
         LA    R2,33(R2)                                                        
         MVI   ELCODE,X'71'                                                     
         MVI   BYTE,0                                                           
         CLI   0(R2),X'71'                                                      
         BE    CKS12B                                                           
*                                                                               
CKS12    DS    0H                                                               
         BAS   RE,PNEXTEL                                                       
         BNE   CKS13                                                            
*                                                                               
CKS12B   DS    0H                                                               
         USING PUBDSTEL,R2                                                      
         L     RF,ADCLT                                                         
         CLC   PUBDCLT,PCLTKCLT-PCLTREC(RF)                                     
         BNE   CKS12                                                            
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         CLC   PUBDDIV,PDIVKDIV                                                 
         BE    CKS12D                                                           
         CLC   PUBDDIV,PPRDDIV         TRY PRD DIVISION                         
         BNE   CKS12                                                            
CKS12D   CLI   BYTE,0                                                           
         BE    CKS12F                                                           
*                                                                               
         MVC   P1(80),QPROG                                                     
         MVC   P2(80),QAREA2                                                    
         GOTO1 REPORT                                                           
         L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P2(90),=CL90'MULTIPLE REG/DST ASSGNS NOT ALLOWED FOR REG         
*--->          S OR DSTS ON SEPERATE INVS - OR RETAIL'                          
         MVC   P1(L'PP@MLT01),PP@MLT01                                          
         MVC   P2(L'PP@MLT02),PP@MLT02                                          
         MVC   P3(25),=C'IF REVERSAL - MUST UNBILL'                             
         DROP  RE                                                               
         GOTO1 REPORT                                                           
         MVI   MODE,LBUYREQ                                                     
         B     EXIT                                                             
         SPACE 3                                                                
PNEXTEL  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    PNEXTEL2                                                         
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     PNEXTEL                                                          
PNEXTEL2 DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
*                                                                               
CKS12F   DS    0H                                                               
         MVI   BYTE,1                                                           
         B     CKS12                                                            
*                                                                               
CKS13    DS    0H                                                               
         MVI   PUBSW,0                                                          
         CLI   QOPT3,C' '                                                       
         BE    SETFLT              DOING ALL PUBS                               
         L     RF,PPFILEC                                                       
         LA    R7,1(RF)                                                         
         LA    R7,4095(R7)                                                      
         USING PPFILED+4096,R7                                                  
         LA    R3,PUBREC+33                                                     
         USING PUBGENEL,R3                                                      
         CLI   0(R3),X'10'                                                      
         BE    *+6                                                              
         DC    H'0'                NO NAME ELEMENT                              
         SR    R0,R0                                                            
         IC    R0,1(R3)                                                         
         AR    R3,R0                                                            
         CLI   0(R3),X'20'                                                      
         BE    HAVEL       HAVE PROD ELEMENT                                    
         CLI   QOPT3,C'C'                                                       
         BE    GETNEXT                                                          
         B     SETFLT                                                           
*                                                                               
HAVEL    DS    0H                                                               
         OC    PUBCDDAT,PUBCDDAT   CHK FOR EFF DATE                             
         BNZ   HAVEL5              IF PRESENT THIS IS OR WAS A CD PUB           
         CP    PUBCD,=P'0'                                                      
         BE    NCHDIS              NO CASH DISCOUNT                             
HAVEL5   CLI   QOPT3,C'C'                                                       
         BE    SETFLT                                                           
         B     GETNEXT                                                          
*                                                                               
NCHDIS   CLI   QOPT3,C'C'                                                       
         BE    GETNEXT                                                          
         B     SETFLT                                                           
*                                                                               
GETNEXT  MVI   PUBSW,1             DON'T PROCESS THIS PUB                       
         B     PUBFEXT                                                          
*                                                                               
         DROP  R7                                                               
         DROP  R3                                                               
SETFLT   DS    0H                                                               
PUBFEXT  B     EXIT                                                             
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
ACONS    DS    0F                                                               
         DC    A(PRNT)                                                          
         DC    A(TOSORT)                                                        
         DC    A(BLDTAB)                                                        
         DC    A(GETNUM)                                                        
         DC    A(AGMPROC)                                                       
         DC    A(SETDATE)                                                       
         DC    V(RDBUFF)                                                        
         DC    V(FMTAMT)                                                        
         DC    V(PRTADJ)                                                        
         DC    V(ADJINV)                                                        
         DC    V(AORINV)                                                        
         DC    V(GETAOR)                                                        
         DC    V(WNBILL)                                                        
         DC    V(WBILL)                                                         
         DC    V(LSTINV)                                                        
         DC    A(BILHEAD)                                                       
         DC    A(BH50)                                                          
         DC    A(ERRPROC)                                                       
         DC    V(INVREG)                                                        
         DC    V(BILCALC)                                                       
         DC    V(FINDOUTP)                                                      
         DC    V(WKREC)                                                         
         DC    V(CHOPPER)                                                       
         DC    V(CENTER)                                                        
         DC    V(FOTABS)                                                        
         DC    V(BUFFALOC)                                                      
         DC    V(LEVTOTS)                                                       
         DC    V(LINTAB)                                                        
         DC    A(PATCH)                                                         
         DC    A(CFIRST)                                                        
         DC    V(TOTOUT)                                                        
         DC    V(ENDINV)                                                        
         DC    V(TSTRET)                                                        
         DC    V(SAVCORP)                                                       
         DC    V(AELIST)                                                        
         DC    V(GRID)                                                          
         DC    V(PPBYOWRK)                                                      
         DC    V(RMBILL)                                                        
         DC    A(PRBUY)                                                         
         DC    V(PRTCMNT)                                                       
         DC    V(CDINV)                                                         
         DC    V(LASTDSC)                                                       
         DC    V(JOBFRST)                                                       
         DC    V(PDLIST)                                                        
         DC    V(PUBFRST)                                                       
         DC    V(MYHEADS)                                                       
         DC    V(GDAREA)                                                        
         DC    V(PPBVAL)                                                        
         DC    V(GETUSER)                                                       
         DC    V(VATTAB)                                                        
         DC    V(VATACCS)                                                       
         DC    V(PRVTAB)                                                        
         DC    V(PRVNAMS)                                                       
         DC    V(AADDRS)                                                        
         DC    V(BADDRS)                                                        
         DC    V(AORADDR)                                                       
         DC    V(CADDRS)                                                        
         DC    V(JADDRS)                                                        
ACONSX   EQU   *                                                                
         LTORG                                                                  
         TITLE 'PROCESS BUY - OR MANUAL BILLS AS DUMMY BUYS'                    
PRBUY    CSECT                                                                  
         NMOD1 0,PRBUY                                                          
************************  NOTE USE OF R8 AS SECOND BASE REGISTER                
         LA    R8,PRBUY+4095                                                    
         LA    R8,1(R8)                                                         
         USING PRBUY+4096,R8                                                    
*                                                                               
         LA    RC,SPACEND                                                       
*                                                                               
         MVI   RECSW,0                                                          
         CLI   CLTSW,C'N'          SEE IF PROCESSING THIS CLIENT                
         BE    PRBUYX              NO - THEN SKIP THIS INSERTION                
         CLI   PUBSW,0             SEE IF PROCESSING THIS PUB                   
         BNE   PRBUYX              NO - THEN SKIP THIS INSERTION                
*                                                                               
*                                                                               
PRBUY20  DS    0H                                                               
         L     RF,ADBUY                                                         
*                                                                               
         CLI   3(RF),X'88'         SEE IF PROCESSING MANUAL BILL                
         BE    PRBUY30             SKIP EXCLUDING BILLING CHECK                 
*                                                                               
         OC    EXDATE,EXDATE       SEE IF EXCLUDING BILLING                     
         BZ    PRBUY25                                                          
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'                                                     
PRBUY20A BAS   RE,NEXTEL                                                        
         BNE   PRBUY20C                                                         
         CLC   5(3,R2),EXDATE                                                   
         BNE   PRBUY20A                                                         
         MVI   0(R2),X'F6'    ALTER ELEM CODE SO GETINS WILL IGNORE             
         B     PRBUY20A                                                         
*                                                                               
PRBUY20C LA    R2,33(RF)                                                        
         MVI   ELCODE,X'28'     FINANCIAL BILLING                               
PRBUY20D BAS   RE,NEXTEL                                                        
         BNE   PRBUY20E                                                         
         CLC   5(3,R2),EXDATE                                                   
         BNE   PRBUY20D                                                         
         MVI   0(R2),X'F8'    ALTER ELEM CODE SO GETINS WILL IGNORE             
         B     PRBUY20D                                                         
*                                                                               
PRBUY20E LA    R2,33(RF)                                                        
         MVI   ELCODE,X'29'     REBATE BILLING                                  
PRBUY20F BAS   RE,NEXTEL                                                        
         BNE   PRBUY20H                                                         
         CLC   5(3,R2),EXDATE                                                   
         BNE   PRBUY20F                                                         
         MVI   0(R2),X'F9'    ALTER ELEM CODE SO GETINS WILL IGNORE             
         B     PRBUY20F                                                         
*                                                                               
*                                                                               
PRBUY20H B     PRBUY20X                                                         
*                                                                               
PRBUY20X L     R2,ADBUY                                                         
*                                                                               
         CLI   SCBNCSW,C'C'       UFC COMM BILLING                              
         BE    PRBUY23                                                          
         CLI   SCBNCSW,C'N'       UFC NET BILLING                               
         BE    PRBUY23D                                                         
         GOTO1 GETINS,DMCB,(R2),GROSS,KPRD                                      
         B     PRBUY30                                                          
*                                                                               
PRBUY23  GOTO1 GETINS,DMCB,(R2),(C'C',GROSS),KPRD                               
         B     PRBUY30                                                          
*                                                                               
PRBUY23D GOTO1 GETINS,DMCB,(R2),(C'N',GROSS),KPRD                               
         B     PRBUY30                                                          
*                                                                               
PRBUY25  DS    0H                                                               
         CLI   SCBNCSW,C'C'       UFC COMM BILLING                              
         BNE   PRBUY25D                                                         
         L     R2,ADBUY                                                         
         GOTO1 GETINS,DMCB,(R2),(C'C',GROSS),KPRD                               
         B     PRBUY30                                                          
*                                                                               
PRBUY25D CLI   SCBNCSW,C'N'       UFC NET BILLING                               
         BNE   PRBUY30                                                          
         L     R2,ADBUY                                                         
         GOTO1 GETINS,DMCB,(R2),(C'N',GROSS),KPRD                               
*                                                                               
PRBUY30  DS    0H                                                               
         BAS   RE,BUYBK                                                         
         B     PRBUYX                                                           
*                                                                               
         SPACE 3                                                                
NEXTEL   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    NEXTEL2                                                          
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     NEXTEL                                                           
NEXTEL2  DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
         EJECT                                                                  
*        BUILD BUYREC SORT KEYS AND PASS TO SORT                                
         SPACE 2                                                                
BUYBK    NTR1                                                                   
         SPACE 2                                                                
BUYBK1   DS    0H                                                               
BUYBK2   DS    0H                                                               
         XC    SORTREC,SORTREC                                                  
         L     RF,ASORTDTA                                                      
         OC    0(16,RF),MANGRS      IF MANUAL USE MAN GROSS AND NET CD          
         BNZ   BUYBK5                                                           
*                                  SEE IF DOING REVERSAL                        
         CLI   MANRVDTP,0                                                       
         BE    BUYBK3              NO                                           
         XC    FULL,FULL           USED BY TAXCALC                              
         L     R3,ADBUY                                                         
BUYBK2B  LA    R2,33(R3)                                                        
         MVI   ELCODE,X'26'        FIND BILLING ELEMS                           
***R***                                                                         
BUYBK2B5 CLC   QPROG,=C'R1'        SEE IF FINANCIAL REBATE REVERSAL             
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'  SEE IF FINANCIAL REBATE REVERSAL - DRAFT           
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
***R***                                                                         
BUYBK2C  BAS   RE,NEXTEL                                                        
         BE    BUYBK2C2                                                         
         CLC   QPROG,=C'R1'          FINANCIAL REBATE BILLING                   
         BE    BUYBK2F               SKIP THIS BUY                              
         CLC   QPROG,=C'RD'     FINANCIAL REBATE BILLING  - DRAFT               
         BE    BUYBK2F               SKIP THIS BUY                              
         CLI   FINANSW,X'01'         SEE IF FINANCIAL REVERSAL                  
         BNE   BUYBK2F               NO- SKIP THIS BUY                          
         B     BUYBK2C8  MUST STILL CHECK FOR OPEN                              
*                        BILLING ELEMS EVEN IF I DIDN'T FIND CONTRACT           
         USING PBILELEM,R2                                                      
BUYBK2C2 OC    PBLDATE,PBLDATE     SEE IF BILLED                                
         BZ    BUYBK2C                                                          
***R***                                                                         
         CLC   PBPRD,KPRD                                                       
         BNE   BUYBK2C                                                          
***R***                                                                         
         CLI   SCBNCSW,C'C'        SEE IF UPFRONT COMM BILLING                  
         BNE   BUYBK2C3                                                         
         TM    PBBILST,X'01'       MUST BE UFC COM BILLING                      
         BZ    BUYBK2C             SKIP                                         
         B     BUYBK2C5                                                         
*                                                                               
BUYBK2C3 DS    0H                                                               
         CLI   SCBNCSW,C'N'        SEE IF UPFRONT COMM BILLING -NET             
         BNE   BUYBK2C5                                                         
         TM    PBBILST,X'02'       MUST BE UFC NET BILLING                      
         BZ    BUYBK2C             SKIP                                         
*                                                                               
BUYBK2C5 DS    0H                                                               
         CLC   PBLDATE,MANRVDTP                                                 
         BNE   BUYBK2C                                                          
         CLC   PBINVNO,MANRVNO     MATCH INVOICE NUMBERS                        
         BNE   BUYBK2C                                                          
**TEST REMOVED 9/7/88                                                           
**NO-OP  TM    PBBILST,X'80'       SEE IF ALREADY REVERSED                      
**NO-OP  BNZ   BUYBK2C             YES  - JUST SKIP                             
*                                                                               
*              LEAVE ORDERED AS ZERO                                            
         MVC   IDSP(4,RF),=F'1'    INSERTS                                      
         MVC   BGDSP(4,RF),PBGROSS PREV BILLING                                 
         L     R0,BGDSP(RF)                                                     
         DS    0H                                                               
         S     R0,PBAGYCOM                                                      
         ST    R0,BNDSP(RF)         NET                                         
         MVC   BCDSP(4,RF),PBCSHDSC                                             
         MVC   BADSP(4,RF),PBAGYCOM                                             
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,BADSP(RF)                                                     
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         L     RE,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RE),PBDTAX-PBUYREC(RE)                          
         BZ    BUYBK2C7                                                         
         CLI   ELCODE,X'29'                                                     
         BE    BUYBK3D            NO TAX FOR REBATE BILLING                     
         LA    R4,BNDSP(RF)        SET R4 TO NET                                
         BAS   RE,NTAXCALC                                                      
         MVC   BTDSP(4,RF),FULL                                                 
***TAX                                                                          
*                                                                               
BUYBK2C7 CLI   FINANSW,X'01'       SEE IF FINANCIAL CLIENT                      
         BNE   BUYBK3D             SKIP CHK FOR ZERO AMTS                       
***R***                                                                         
         CLC   QPROG,=C'R1'        SEE IF FINANCIAL REBATE REVERSAL             
         BE    BUYBK3D                                                          
         CLC   QPROG,=C'RD'  SEE IF FINANCIAL REBATE REVERSAL DRAFT             
         BE    BUYBK3D                                                          
***R***                                                                         
*                                  MUST LOOK FOR OPEN BILLING ELEMS             
BUYBK2C8 L     R3,ADBUY                                                         
BUYBK2D  LA    R2,33(R3)                                                        
         MVI   ELCODE,X'28'        FIND BILLING ELEMS                           
BUYBK2E  BAS   RE,NEXTEL                                                        
         BNE   BUYBK2E5                                                         
         USING PBILELEM,R2                                                      
         OC    PBLDATE,PBLDATE     SEE IF BILLED                                
         BZ    BUYBK2E                                                          
***R***                                                                         
         CLC   PBPRD,KPRD                                                       
         BNE   BUYBK2E                                                          
***R***                                                                         
         CLC   PBLDATE,MANRVDTP                                                 
         BNE   BUYBK2E                                                          
         CLC   PBINVNO,MANRVNO     MATCH INVOICE NUMBERS                        
         BNE   BUYBK2E                                                          
**TEST NO-OPED 9/7/88                                                           
**NO-OP  TM    PBBILST,X'80'       SEE IF ALREADY REVERSED                      
**NO-OP  BNZ   BUYBK2E             YES  - JUST SKIP                             
*                                                                               
*              LEAVE ORDERED AS ZERO                                            
         MVC   OBGDSP(4,RF),PBGROSS PREV BILLING                                
         L     R0,OBGDSP(RF)                                                    
         DS    0H                                                               
         S     R0,PBAGYCOM                                                      
         ST    R0,OBNDSP(RF)        NET                                         
         MVC   OBCDSP(4,RF),PBCSHDSC                                            
         MVC   OBADSP(4,RF),PBAGYCOM                                            
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,OBADSP(RF)                                                    
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         MVC   OBTDSP(4,RF),FULL   SET OPEN BILLED TAX - SAME AS                
***TAX                             CONTRACT                                     
         MVC   IDSP(4,RF),=F'1'    INSERTS                                      
*                                  NEEDED SO $ GET POSTED TO PEPTAB             
*                                                                               
         B     BUYBK3D             SKIP ZERO AMT CHK                            
*                                                                               
BUYBK2E5 DS    0H      I GET HERE IF NO OPEN BILLING FOUND                      
*                      WHEN REVERSING FINANCIAL BILL                            
         OC    IDSP(4,RF),IDSP(RF)    ENSURES THAT I FOUND CONTRACT             
         BNZ   BUYBK3D          SKIP ZERO AMT CHECK                             
*                                                                               
BUYBK2F  B     BUYBK9              SKIP THIS BUY                                
*                                                                               
**NEW 6/20/88                                                                   
BUYBK3   CLI   FINANSW,X'01'      SEE IF DOING FINANCIAL CLIENT                 
         BNE   BUYBK3A                                                          
         CLC   QAGENCY,=C'SJ'     SPECIAL FOR SJR FINANCIAL CLIENTS             
         BE    BUYBK3A0                                                         
         CLC   QAGENCY,=C'DM'     SPECIAL FOR DOREMUS FINANCIAL CLIENTS         
         BNE   BUYBK3A                                                          
BUYBK3A0 L     RE,ADBUY                                                         
         OC    PBDJOB-PBUYREC(6,RE),PBDJOB-PBUYREC(RE)                          
         BZ    BUYBK9             SKIP BUYS WITH NO AD CODE                     
*                                                                               
BUYBK3A  CLI   QPUB+1,C'J'        AD CODE FILTER                                
         BNE   BUYBK3A2                                                         
         L     RE,ADBUY                                                         
         CLC   PBDJOB-PBUYREC(6,RE),QPUB+2                                      
         BNE   BUYBK9                WRONG AD CODE                              
*                                                                               
BUYBK3A2 MVC   0(4,RF),GROSS                                                    
         L     R0,0(RF)                                                         
         S     R0,AGYCOM                                                        
         ST    R0,NDSP(RF)         NET                                          
         MVC   CDSP(4,RF),CSHDSC                                                
         MVC   ADSP(4,RF),AGYCOM                                                
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,ADSP(RF)                                                      
         BAS   RE,FIXAC                                                         
***TAX   DS    0H                                                               
         MVC   IDSP(4,RF),=F'1'        LEAVE AS INSERTIONS IF NO TAX            
         L     RE,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RE),PBDTAX-PBUYREC(RE)                          
         BZ    BUYBK3A4                                                         
         MVC   TDSP(4,RF),TAX          TAX                                      
*                                                                               
BUYBK3A4 DS    0H                                                               
         MVC   BGDSP(4,RF),BGROSS  PREV BILLING                                 
         L     R0,BGDSP(RF)                                                     
         S     R0,BAGYCOM                                                       
         ST    R0,BNDSP(RF)         NET                                         
         MVC   BCDSP(4,RF),BCSHDSC                                              
         MVC   BADSP(4,RF),BAGYCOM                                              
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,BADSP(RF)                                                     
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         XC    FULL,FULL                                                        
*                                  IF NOT BREAKINGOUT TAX                       
*                                  OR PBDTAX IS 0                               
*                                                                               
         L     RE,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RE),PBDTAX-PBUYREC(RE)                          
         BZ    BUYBK3A5                                                         
         LA    R4,BNDSP(RF)                                                     
         BAS   RE,NTAXCALC     MUST CALCULATE TAX OF PREVIOUS BILLING           
*                              R4 INCLUDES TAX                                  
BUYBK3A5 MVC   BTDSP(4,RF),FULL                                                 
         DS    0H                                                               
***TAX                        NOTE - PAYOPT MAY CAUSE TAX PROBLEM               
         CLI   PAYOPT,C'N'                                                      
         BE    BUYBK3B                                                          
*                                                                               
*                                  MUST NOW CHECK FOR PAY ELEM                  
*                                  WITH DATE SINCE "FREE" INSERTION             
*                                  LOGIC WILL CAUSE ANY UNPAID                  
*                                  INSERTION TO GET BILLED                      
*                                                                               
         L     R3,ADBUY                                                         
         CLI   3(R3),X'88'         SEE IF MANUAL BILL                           
         BE    BUYBK3B             PROCESS AS CLEARED                           
*                                                                               
         LA    R2,33(R3)                                                        
         MVI   ELCODE,X'25'        FIND PAYELEM WITH DATE                       
BUYBK3A6 BAS   RE,NEXTEL                                                        
         BNE   BUYBK3A7              SKIP THIS BUY                              
         OC    2(3,R2),2(R2)         CHK FOR PAY DATE                           
         BZ    BUYBK3A6              FALL THROUGH IF DATE FOUND                 
*                                                                               
         CLI   PAYOPT,C'E'    FOR PAYOPTS E-F-G                                 
         BL    BUYBK3A8                                                         
         CLI   PAYOPT,C'G'    FOR PAYOPTS E-F-G                                 
         BH    BUYBK3A8                                                         
         MVC   X(12),GROSS                                                      
         L     R3,ADBUY                                                         
         TM    27(R3),X'80'       SEE IF DELETED                                
         BZ    *+10                                                             
         XC    X(12),X                                                          
         CLC   X(12),PGROSS   SEE IF FULLY PAID                                 
         BE    BUYBK3A8                                                         
*                             NO ADD TO UNPAID EST TABLE                        
         BAS   RE,SETSKIP     GO SET EST IN UPETAB                              
         B     BUYBK3A8                                                         
*                                                                               
BUYBK3A7 DS    0H             GET HERE IF NO DATED PAY ELEMENTS                 
         CLI   PAYOPT,C'E'    CHK PAYOPTS E-F-G                                 
******** BL    BUYBK9         SKIP THIS BUY                                     
         BL    BYBK3A7D       GO CHECK FOR BILLING                              
         CLI   PAYOPT,C'G'                                                      
******** BH    BUYBK9         SKIP THIS BUY                                     
         BH    BYBK3A7D       GO CHECK FOR BILLING                              
*                                                                               
         L     R3,ADBUY                                                         
         TM    27(R3),X'80'   SEE IF DELETED                                    
         BZ    BYBK3A7B                                                         
         OC    BGROSS(12),BGROSS   YES, IF NOT BILLED                           
         BZ    BUYBK9              THEN SKIP THIS BUY                           
         B     BUYBK3A8            ELSE PROCESS AND DON'T SET IN                
*                                  UNPAID TABLE                                 
BYBK3A7B DS    0H                                                               
         BAS   RE,SETSKIP     ADD EST TO UNPAID TABLE                           
         B     BUYBK3A8                                                         
*                                                                               
BYBK3A7D DS    0H         NO PAY ELEMS - WITH PAYOPT "Y"                        
         OC    BGROSS(12),BGROSS     SEE IF BILLED OR FREE                      
         BZ    BUYBK9        SKIP IF FREE OR NOT BILLED                         
*                            MUST SILL PROCESS TO GET CREDIT                    
*                                                                               
BUYBK3A8 DS    0H                                                               
         MVC   0(4,RF),PGROSS                                                   
         L     R0,0(RF)                                                         
         S     R0,PAGYCOM                                                       
         ST    R0,NDSP(RF)         NET                                          
         MVC   CDSP(4,RF),PCSHDSC                                               
         MVC   ADSP(4,RF),PAGYCOM                                               
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,ADSP(RF)                                                      
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         L     RE,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RE),PBDTAX-PBUYREC(RE)                          
         BZ    BUYBK3B                                                          
         LA    R4,NDSP(RF)                                                      
         BAS   RE,NTAXCALC    MUST CALCULATE TAX ON NET PAID                    
         MVC   TDSP(4,RF),FULL     SAVE AS ORDERED TAX                          
***TAX                                                                          
BUYBK3B  DS    0H                                                               
         L     R3,ADBUY                                                         
         TM    27(R3),X'80'        TEST DELETED                                 
         BZ    BUYBK3B2                                                         
***TAX    WAS 0(12,RF)                                                          
*** 8/28/90   FIXED TO CLEAR TAX IF DELETED  (WAS 16)                           
         XC    0(20,RF),0(RF)      YES- CLEAR ALL ORDERED $                     
*                                                                               
BUYBK3B2 CLI   FINANSW,X'01'       SEE IF FINANCIAL CLIENT                      
         BNE   BUYBK3C                                                          
         L     R2,ADBUY                                                         
         LA    R2,33(R2)                                                        
         MVI   ELCODE,X'30'        MUST FIND OPEN RATE ELEM                     
         BAS   RE,NEXTEL                                                        
         BE    *+6                                                              
         DC    H'0'                SOMETING VERY WRONG                          
         ST    RF,FULL2                                                         
BUYBK3B3 L     RF,ADBUY                                                         
         LR    R2,RF                                                            
*                                                                               
*                                 GOTO GETINS TO GET OPEN VALUES                
         GOTO1 GETINS,DMCB,(R2),(C'O',GROSS),KPRD                               
*                                                                               
*        TAX SHOULD NOW BE IN TAX                                               
*        IT IS ALSO INCLUDED IN GROSS,PYABLE, AND BLABLE                        
***********                                                                     
****     MUST USE REG/DST SPLIT ROUTINE                                         
****     FOR REG/DST REQUESTS                                                   
***********                                                                     
         L     RF,FULL2                                                         
         MVC   OGDSP(4,RF),GROSS                                                
         L     R0,OGDSP(RF)                                                     
         S     R0,AGYCOM                                                        
         ST    R0,ONDSP(RF)                                                     
         MVC   OCDSP(4,RF),CDSP(RF)     USE CONTRACT CD                         
         MVC   OADSP(4,RF),AGYCOM                                               
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,OADSP(RF)                                                     
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         MVC   OTDSP(4,RF),TAX        NOTE TAX BASED ON CONTRACT NET            
***TAX                                                                          
         MVC   OBGDSP(4,RF),BGROSS                                              
         L     R0,OBGDSP(RF)                                                    
         S     R0,BAGYCOM                                                       
         ST    R0,OBNDSP(RF)                                                    
         MVC   OBCDSP(4,RF),BCSHDSC                                             
         MVC   OBADSP(4,RF),BAGYCOM                                             
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,OBADSP(RF)                                                    
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         MVC   OBTDSP(4,RF),FULL     MUST USE CONTRACT TAX                      
*                          STILL IN FULL - CALCULATED                           
*                          AT BUYBK3A4 OR BUYBK3B IF PAYOPT=C'Y'                
*                          OR PAYOPT = 'S' (SUPPRESS MESSAGE)                   
***TAX                     NOTE - PAYOPT MAY CAUSE TAX PROBLEM                  
         CLI   PAYOPT,C'N'                                                      
         BE    BUYBK3B4                                                         
         MVC   OGDSP(4,RF),PGROSS                                               
         L     R0,OGDSP(RF)                                                     
         S     R0,PAGYCOM                                                       
         ST    R0,ONDSP(RF)                                                     
         MVC   OCDSP(4,RF),PCSHDSC                                              
         MVC   OADSP(4,RF),PAGYCOM                                              
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,OADSP(RF)                                                     
         BAS   RE,FIXAC                                                         
         B     BUYBK3B4                                                         
*                                                                               
BUYBK3B4 DS    0H                                                               
         L     R3,ADBUY                                                         
         TM    27(R3),X'80'        SEE IF DELETED                               
         BZ    *+10                                                             
         XC    OGDSP(20,RF),OGDSP(RF) CLEAR OPEN ORDERED ALSO                   
*                                                                               
***R***                                                                         
BUYBK3B5 CLC   QPROG,=C'R1'        SEE IF DOING OPEN/CONTRACT REBATE            
         BE    BUYBK3B6                                                         
         CLC   QPROG,=C'RD'  SEE IF DOING OPEN/CONTRACT REBATE DRAFT            
         BNE   BUYBK3B9                                                         
BUYBK3B6 L     R0,BGDSP(RF)      OPEN BILLING - GROSS                           
         S     R0,OBGDSP(RF)     CONTRACT BILLING                               
         ST    R0,0(RF)          SET AS 'ORDERED'                               
         L     R0,BNDSP(RF)      OPEN BILLING - AGYCOM                          
         S     R0,OBNDSP(RF)     CONTRACT BILLING                               
         ST    R0,NDSP(RF)       SET AS 'ORDERED'                               
         L     R0,BCDSP(RF)      OPEN BILLING  -CD                              
         S     R0,OBCDSP(RF)     CONTRACT BILLING                               
         ST    R0,CDSP(RF)      SET AS 'ORDERED'                                
         L     R0,BADSP(RF)      OPEN BILLING  -AC                              
         S     R0,OBADSP(RF)     CONTRACT BILLING                               
         ST    R0,ADSP(RF)      SET AS 'ORDERED' AC                             
***TAX                                                                          
         XC    TDSP(4,RF),TDSP(RF)      CLEAR TAX FOR REBATE BILLING            
***TAX                                                                          
         XC    IDSP(ROW2L-IDSP,RF),IDSP(RF) CLEAR ALL OTHER ACCUMS              
         L     R2,ADBUY                                                         
         LA    R2,33(R2)                                                        
         MVI   ELCODE,X'29'        FIND PREVIOUS REBATE BILLING                 
BUYBK3B7 BAS   RE,NEXTEL                                                        
         BNE   BUYBK3B9                                                         
         OC    5(3,R2),5(R2)       CHK FOR DATE                                 
         BZ    BUYBK3B7                                                         
         USING PBILELEM,R2                                                      
         CLC   PBPRD,KPRD         MUST BE RIGHT PRD                             
         BNE   BUYBK3B7                                                         
         L     R0,BGDSP(RF)                                                     
         DS    0H                                                               
         A     R0,PBGROSS                                                       
         ST    R0,BGDSP(RF)                                                     
         L     R1,PBGROSS          NET=GROSS-AC                                 
         S     R1,PBAGYCOM                                                      
         L     R0,BNDSP(RF)                                                     
         AR    R0,R1                                                            
         ST    R0,BNDSP(RF)                                                     
         L     R0,BCDSP(RF)                                                     
         A     R0,PBCSHDSC                                                      
         ST    R0,BCDSP(RF)                                                     
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   BUYBK3B8                                                         
         MVC   FULL,PBAGYCOM                                                    
         LA    R4,FULL                                                          
         BAS   RE,FIXAC                                                         
         L     R0,BADSP(RF)                                                     
         A     R0,FULL                                                          
         ST    R0,BADSP(RF)                                                     
         B     BUYBK3B7                                                         
*                                                                               
BUYBK3B8 L     R0,BADSP(RF)                                                     
         A     R0,PBAGYCOM                                                      
         ST    R0,BADSP(RF)                                                     
         B     BUYBK3B7                                                         
***TAX    NOTE - NO TAX FOR REBATE BILLING                                      
*                                                                               
         DROP  R2                                                               
***R***                                                                         
BUYBK3B9 DS    0H                                                               
*                                                                               
***E***                                                                         
BUYBK3C  CLC   QPROG,=C'E1'        FOR ESTIMATE PASS ALL BUYS                   
         BE    BUYBK3D                                                          
***E***                                                                         
***TAX      WAS (12,RF) ETC.                                                    
         OC    0(16,RF),0(RF)      NO DATA  - ORDERED                           
         BNZ   BUYBK3D                                                          
         OC    BGDSP(20,RF),BGDSP(RF) NO DATA - BILLED                          
         BNZ   BUYBK3D                                                          
         OC    OGDSP(20,RF),OGDSP(RF) NO DATA - ORDERED OPEN                    
         BNZ   BUYBK3D                                                          
         OC    OBGDSP(20,RF),OBGDSP(RF) NO DATA - BILLED OPEN                   
         BNZ   BUYBK3D                                                          
*                                                                               
         CLI   FREEOPT,C'Y'       SEE IF BILING FREE INSERTIONS                 
         BNE   BUYBK3C3                                                         
         L     RF,ADBUY                                                         
         CLC   PBUYKDAT-PBUYREC(3,RF),=X'5C0901'  NOT BEFORE 9/1/92             
         BL    BUYBK3C3                                                         
*                                                                               
         DS    0H                I MUST NOW PROCESS "FREE" BUYS                 
*                                UNLESS THEY HAVE A BILLING ELEMENT             
*                                WITH A BILL DATE                               
         L     RF,ADBUY                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'                                                     
*                                                                               
BUYBK3C0 CLC   QPROG,=C'R1'        SEE IF DOING REBATE BILLING                  
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'   SEE IF DOING REBATE BILLING DRAFT                 
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
*                                                                               
BUYBK3C1 BAS   RE,NEXTEL                                                        
         BNE   BUYBK3C2        IF NO PREV BILLING - GO SEE IF DELETED           
         USING PBILELEM,R2                                                      
         OC    PBLDATE,PBLDATE       SEE IF HAS DATE                            
         BZ    BUYBK3C1              NO - SKIP                                  
         CLC   PBPRD,KPRD            MUST BE RIGHT PRODUCT                      
         BNE   BUYBK3C1                                                         
         TM    PBBILST,X'C0'         SKIP REVERSED - REVERSALS                  
         BNZ   BUYBK3C1                                                         
         CLI   SCBNCSW,C'C'        SEE IF UFC COMM BILLING                      
         BNE   *+16                                                             
         TM    PBBILST,X'01'                                                    
         BZ    BUYBK3C1              NOT RIGHT TYPE - SKIP                      
         B     BUYBK3C3                                                         
*                                                                               
         CLI   SCBNCSW,C'N'          UFC NET BILLING                            
         BNE   BUYBK3C3                                                         
         TM    PBBILST,X'02'         SEE IF UFC NET BILLING                     
         BZ    BUYBK3C1              NOT RIGHT TYPE - SKIP                      
         DROP  R2                    PROCESS                                    
         B     BUYBK3C3                                                         
*                                                                               
BUYBK3C2 DS    0H                                                               
*                                 "FREE" BUY THAT WAS NEVER BILLED              
*                                 SEE IF DELETED                                
         L     RF,ADBUY                                                         
         TM    27(RF),X'80'                                                     
         BNZ   BUYBK9             YES - THEN I CAN SKIP                         
         B     BUYBK3D            PROCESS                                       
*                                                                               
*                                                                               
BUYBK3C3 DS    0H                                                               
         CLI   ZUOPT,C'O'         SEE IF OMITTING PREV. BILLED INS              
         BE    BUYBK9             YES THEN I CAN SKIP THIS BUY                  
         CLI   LSTOPT,C'Y'        SEE IF LISTING PREV BILLS                     
         BE    BUYBK3C4                                                         
         CLI   LSTOPT,C'R'                                                      
         BE    BUYBK3C4                                                         
         CLI   LSTOPT,C'B'                                                      
         BE    BUYBK3C4                                                         
         CLI   LSTOPT,C'I'                                                      
         BE    BUYBK3C4                                                         
         B     BUYBK9            NO  - I CAN SKIP THIS BUY                      
*                                                                               
BUYBK3C4 DS    0H                PROCESS BUY TO GET CORRECT                     
*                                PREVIOUS BILLED AMTS                           
         L     RF,ADBUY                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'                                                     
*                                                                               
BUYBK3C5 CLC   QPROG,=C'R1'        SEE IF DOING REBATE BILLING                  
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'   SEE IF DOING REBATE BILLING DRAFT                 
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
*                                                                               
BUYBK3C6 BAS   RE,NEXTEL                                                        
         BNE   BUYBK9               IF NO PREV BILLING - CAN SKIP               
         USING PBILELEM,R2                                                      
         OC    PBLDATE,PBLDATE       SEE IF HAS DATE                            
         BZ    BUYBK3C6              NO - SKIP                                  
         CLC   PBPRD,KPRD            MUST BE RIGHT PRODUCT                      
         BNE   BUYBK3C6                                                         
         TM    PBBILST,X'C0'         SKIP REVERSED - REVERSALS                  
         BNZ   BUYBK3C6                                                         
         CLI   SCBNCSW,C'C'          UFC COMM BILLING                           
         BNE   BUYBK3C7                                                         
         TM    PBBILST,X'01'         CHECK RIGHT TYPE                           
         BZ    BUYBK3C6                                                         
         B     BUYBK3D                                                          
*                                                                               
BUYBK3C7 DS    0H                                                               
         CLI   SCBNCSW,C'N'          UFC NET BILLING                            
         BNE   BUYBK3D                                                          
         TM    PBBILST,X'02'         CHECK RIGHT TYPE                           
         BZ    BUYBK3C6                                                         
         DROP  R2                    PROCESS                                    
*                                                                               
BUYBK3D  DS    0H                                                               
*                                                                               
         OC    MANPCT,MANPCT         SEE IF PCT BILL                            
         BZ    BUYBK3D5                                                         
         CLI   PCTCTL,C'N'           AND NO PREVIOUS BILLING                    
         BNE   BUYBK3D5                                                         
         L     RF,ASORTDTA                                                      
         XC    BGDSP(20,RF),BGDSP(RF)         CLEAR BILLED $                    
         XC    OBGDSP(20,RF),OBGDSP(RF)       CLEAR OPEN BILLED $               
*                                                                               
BUYBK3D5 LA    R2,PERLIST                                                       
         L     RF,ADBUY                                                         
         CLC   PBDBDATE-PBUYREC(3,RF),2(R2)   SEE IF BEFORE FIRST               
         BL    BUYBK9                         MTH START - YES SKIP              
*                                                                               
BUYBK3E  CLC   PBDBDATE-PBUYREC(3,RF),5(R2)                                     
         BNH   BUYBK3G                                                          
         LA    R2,8(R2)                                                         
         CLI   0(R2),X'FF'          SEE IF AT END OF PERLIST                    
         BE    BUYBK9              PAST END OF LIST SO SKIP                     
         B     BUYBK3E                                                          
*                                                                               
BUYBK3G  DS    0H                                                               
         MVC   THISPER,0(R2)       SAVE THIS YM                                 
*                                                                               
         CLI   PERCTL,C'T'                                                      
         BNE   BUYBK5                                                           
*                                  IF MULTI-MONTH                               
         LA    RF,ESTFORM                                                       
         CLI   ESTFORM+BILNBSW-BILPROF,C'Y'    SEE IF NOT FOR BILLING           
         BE    BUYBK3H                                                          
         OC    ESTFORM(7),ESTFORM     SEE IF I HAVE A FORMULA/DATE              
         BNZ   BUYBK3M             YES THEN USE IT                              
*                                                                               
BUYBK3H  LA    RF,PRDFORM          TRY FOR PRODUCT                              
         CLI   PRDFORM+BILNBSW-BILPROF,C'Y'    SEE IF NOT FOR BILLING           
         BE    BUYBK3K                                                          
         OC    PRDFORM,PRDFORM     SEE IF I HAVE A FORMULA/DATE                 
         BNZ   BUYBK3M             YES THEN USE IT                              
*                                                                               
BUYBK3K  LA    RF,AAEFORM          TRY FOR AAA ESTIMATE                         
         CLI   AAEFORM+BILNBSW-BILPROF,C'Y'    SEE IF NOT FOR BILLING           
         BE    BUYBK3L                                                          
         OC    AAEFORM(7),AAEFORM     SEE IF I HAVE A PRD FORMULA/DATE          
         BNZ   BUYBK3M              YES THEN USE IT                             
BUYBK3L  LA    RF,AAAFORM           TRY FOR PRD AAA FORMULA                     
         CLI   AAAFORM+BILNBSW-BILPROF,C'Y'    SEE IF NOT FOR BILLING           
         BE    BUYBK4                                                           
*                                                                               
BUYBK3M  CLC   CURPER,5(RF)        CURRENT MO NOT LOWER THAN                    
         BL    BUYBK4              FORMULA EFF DATE                             
         CLC   THISPER,5(RF)                                                    
         BL    BUYBK9              BYPASS ALL MONTHS BEFORE EFF DATE            
BUYBK4   DS    0H                                                               
**GST                                                                           
         CLI   CVATCOD,0           CHECK FOR CANADINA GST                       
         BE    BUYBK5                                                           
         CLC   CURPER,CVATSTRT     AND CURRENT MTH NOT LOWER THAN               
         BL    BUYBK5              GST START DATE                               
         CLC   THISPER,CVATSTRT    BYPASS EARLIER MONTHS                        
         BL    BUYBK9                                                           
**GST                                                                           
*                                                                               
BUYBK5   DS    0H                                                               
         MVI   ZLSW,C'N'                                                        
***E***                                                                         
         CLC   QPROG,=C'E1'        FOR ESTIMATES DON'T SET ZLSW                 
         BE    BUYBK5B                                                          
***E***                                                                         
         CLI   MANRVDTP,0          SEE IF DOING REVERSAL                        
         BNE   BUYBK5B             YES - DON'T SET ZLSW                         
*                                  UNLESS OLD MANUAL BILL                       
         CLI   ZUOPT,C'S'          SEE IF PRINTING PREV BILLED UNITS            
         BE    BUYBK5B                                                          
*                                  MUST BE LUMPING PREV BILLED UNITS            
         L     RF,ASORTDTA                                                      
         CLC   0(16,RF),BGDSP(RF)  CHK G,N,CD,AC                                
         BNE   BUYBK5B                                                          
         CLC   OGDSP(16,RF),OBGDSP(RF) ALSO CHK OPEN BILLING                    
         BNE   BUYBK5B                                                          
***TAX     NOTE - CHECKS ABOVE TO NOT COMPARE TAX ORDERED VS. BILLED            
***TAX     BECAUSE ROUNDING ERRORS ARE POSSIBLE                                 
***TAX     SHOULD BE OK SINCE THE BUY PROGRAM WILL NOT ALLOW TAX PCT.           
***TAX     TO CHANGE AFTER BILLING                                              
*                                                                               
         CLI   FREEOPT,C'Y'      SEE IF BILLING FREE INSERTIONS                 
         BNE   BUYBK5A8                                                         
         L     RE,ADBUY                                                         
         CLC   PBUYKDAT-PBUYREC(3,RE),=X'5C0901'   NOT BEFORE 9/1/92            
         BL    BUYBK5A8                                                         
*                                                                               
         OC    0(16,RF),0(RF)                                                   
         BNZ   BUYBK5A8                                                         
         OC    OGDSP(16,RF),OGDSP(RF)                                           
         BNZ   BUYBK5A8                                                         
*                                                                               
*                                FREE BUY-SEE IF IT HAS BEEN BILLED             
         L     RF,ADBUY                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'                                                     
*                                                                               
BUYBK5A1 CLC   QPROG,=C'R1'        SEE IF DOING REBATE BILLING                  
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'   SEE IF DOING REBATE BILLING DRAFT                 
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
*                                                                               
BUYBK5A2 BAS   RE,NEXTEL                                                        
         BNE   BUYBK5B              IF NO PREV BILLING - PROCESS                
         USING PBILELEM,R2                                                      
         OC    PBLDATE,PBLDATE       SEE IF HAS DATE                            
         BZ    BUYBK5A2              NO - SKIP                                  
         CLC   PBPRD,KPRD            MUST BE RIGHT PRODUCT                      
         BNE   BUYBK5A2                                                         
         TM    PBBILST,X'C0'         SKIP REVERSED - REVERSALS                  
         BNZ   BUYBK5A2                                                         
         CLI   SCBNCSW,C'C'          UFC COMM BILLING                           
         BNE   BUYBK5A4                                                         
         TM    PBBILST,X'01'                                                    
         BZ    BUYBK5A2                                                         
         B     BUYBK5A8                                                         
*                                                                               
BUYBK5A4 CLI   SCBNCSW,C'N'          UFN NET BILLING                            
         BNE   BUYBK5A8                                                         
         TM    PBBILST,X'02'                                                    
         BZ    BUYBK5A2                                                         
*                                                                               
         DROP  R2                    PROCESS                                    
*                                                                               
*                                                                               
BUYBK5A8 CLI   ZUOPT,C'O'          SEE IF OMITING PREV BILLED INS               
         BE    BUYBK9              YES                                          
         MVI   ZLSW,C'Y'           SET TOTALLY BILLED                           
         B     BUYBK5C                                                          
*                                                                               
BUYBK5B  L     RF,ADBUY                                                         
         CLI   3(RF),X'88'         SEE IF DOING OLD MANUAL BILL                 
*                                  DUMMIED UP AS BUYREC                         
         BNE   BUYBK5C                                                          
         MVI   ZLSW,C'Y'           SET TO FULLY BILLED                          
*                                                                               
BUYBK5C  LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
BUYBK5E  DS    0H                                                               
         CLI   LSTOPT,C'Y'         SEE IF LISTING PREV BILLS                    
         BE    BUYBK5E5                                                         
         CLI   LSTOPT,C'R'         SEE IF LISTING PREV BILLS                    
         BE    BUYBK5E5            (+ RESTATE AMTDUE)                           
         CLI   LSTOPT,C'B'         SEE IF LISTING INVS FOR INSERTS              
         BE    BUYBK5E5            AND PREV BILLS (+ RESTATE AMTDUE)            
         CLI   LSTOPT,C'I'         OR LISTING INV FOR INSERTS                   
         BNE   BUYBK7              AND PREV BILLS                               
*                                                                               
BUYBK5E5 OC    SAVMGRU(6),SAVMGRU      SEE IF DOING REG/DSTS                    
         BZ    BUYBK6                                                           
         L     R2,ALTLREC                                                       
         LTR   R2,R2                                                            
         BZ    BUYBK6                                                           
         LA    R2,33(R2)                                                        
         MVI   ELCODE,X'71'                                                     
         CLI   0(R2),X'71'                                                      
         BE    BUYBK5H                                                          
*                                                                               
BUYBK5F  DS    0H                                                               
         BAS   RE,BNEXTEL                                                       
         BNE   BUYBK5J                                                          
*                                                                               
BUYBK5H  DS    0H                                                               
         USING PUBDSTEL,R2                                                      
         L     RF,ADCLT                                                         
         CLC   PUBDCLT,PCLTKCLT-PCLTREC(RF)                                     
         BNE   BUYBK5F                                                          
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         CLC   PUBDDIV,PDIVKDIV                                                 
         BE    BUYBK5I                                                          
         CLC   PUBDDIV,PPRDDIV       TRY PRODUCT DIVISION                       
         BNE   BUYBK5F                                                          
BUYBK5I  CLC   PUBDREG(3),SAVMGRU    CHK FOR PRIMARY REG                        
         BNE   BUYBK7              NO - THEN SKIP SAVE OF                       
*                                  PREV INVOICE DATA TO                         
*                                  PREVENT SAME ELEM BEING ADDED TWICE          
*                                                                               
         CLI   QDIST,C' '          IF NOT BY DISTRICT                           
         BE    BUYBK5J                                                          
         CLC   PUBDREG(6),SAVMGRU    CHK FOR PRIMARY REG/DST                    
         BNE   BUYBK7              NO - THEN SKIP SAVE OF                       
*                                  PREV INVOICE DATA TO                         
*                                  PREVENT SAME ELEM BEING ADDED TWICE          
*                                                                               
         B     BUYBK5J                                                          
         DROP  RF                                                               
*                                                                               
         SPACE 3                                                                
BNEXTEL  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    BNEXTEL2                                                         
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     BNEXTEL                                                          
BNEXTEL2 DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
*                                                                               
***TAX                                                                          
NTAXCALC NTR1         USED TO EXTRACT NET FROM NET + TAX                        
*                     RETURNS NET IN FULL                                       
         MVC   DUB(4),0(R4)           SET TO NET (+TAX)                         
         L     RF,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RF),PBDTAX-PBUYREC(RF)                          
         BZ    NTAXCX                 IF NO TAX - DONE                          
*                                                                               
NTAXC2   TM    PBDCNDA-PBUYREC(RF),X'80'   SEE IF CANADIAN                      
         BZ    NTAXC40                NO USE OLD ROUTINE                        
*                                                                               
         MVC   FULL(1),PBDGST-PBUYREC(RF)                                       
         LA    RE,PGSTTAB                                                       
         CLI   FULL,0                                                           
         BNE   *+8                                                              
         MVI   FULL,C'S'           DEFAULT TO STANDARD                          
*                                                                               
NTAXC4   CLC   0(1,RE),FULL                                                     
         BE    NTAXC5                                                           
         LA    RE,8(RE)                                                         
         CLI   0(RE),X'FF'                                                      
         BNE   NTAXC4                                                           
         B     NTAXC40         INVALID TAX CODE - TREAT LIKE NO GST             
*                                                                               
NTAXC5   OC    2(2,RE),2(RE)      CHK FOR GST PCT                               
         BZ    NTAXC40                                                          
         TM    1(RE),X'01'        SEE IF SALES TAX BASED ON NET                 
         BO    NTAXC40                                                          
         CLC   PBUYKDAT-PBUYREC(3,RF),4(RE)                                     
         BL    NTAXC40                                                          
         CLC   PBDPDATE-PBUYREC(3,RF),4(RE)                                     
         BL    NTAXC40                                                          
*                                                                               
NTAXC7   DS    0H                                                               
*        DUB = NET + SALES TAX % (NET + GST % OF NET)                           
*     SO DUB = NET + SALES TAX % (1+GST% X NET)                                 
*     SO DUB = NET + (SALES TAX % X (1+GST%)) NET                               
*     SO DUB = (1 + (SALES TAX % X (1+GST %))) X NET                            
*  THEREFORE NET = DUB DIVIDED BY (1+(SALES TAX % X (1+GST %)))                 
*                                                                               
         XC    FULL,FULL                                                        
         MVC   FULL+2(2),2(RE)   GST %                                          
         L     RE,FULL                                                          
         A     RE,=F'100000'     1 + GST % (3 DECIMALS)                         
         XC    FULL2,FULL2                                                      
         MVC   FULL2+1(3),PBDTAX-PBUYREC(RF)                                    
         L     RF,FULL2                                                         
         MR    RE,RE                                                            
         D     RE,=F'1000000' SINCE PBDTAX IS 4 DECIMALS                        
*                             RF = SALES TAX % X (1+GST%)                       
         A     RF,=F'100000'  RF = 1 + (SALES % X (1+GST%))                     
         ST    RF,FULL                                                          
         L     RF,DUB                                                           
         M     RE,=F'100000'                                                    
         SLDL  RE,1                                                             
         D     RE,FULL                                                          
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
         ST    RF,DUB            SHOULD NOW BE NET                              
         B     TAXC3                                                            
*                                                                               
*                                                                               
NTAXC40  DS    0H                                                               
         XC    FULL2,FULL2                                                      
         MVC   FULL2+1(3),PBDTAX-PBUYREC(RF)                                    
*                                                                               
         L     RE,FULL2           N+TAX= N + TAX PCT(N)                         
         A     RE,=F'1000000'     N = N+TAX/100.0000 + TAX PCT                  
         ST    RE,FULL2                                                         
*                                                                               
         L     RF,DUB                                                           
         M     RE,=F'1000000'                                                   
         SLDL  RE,1                                                             
         D     RE,FULL2            SINCE PBDTAX HAS 4 DECIMALS                  
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
         ST    RF,DUB                                                           
NTAXCX   DS    0H                                                               
         B     TAXC3             REST SAME AS TAXCALC                           
*                                                                               
TAXCALC  NTR1                     R4 POINTS TO NET                              
         MVC   DUB(4),0(R4)                                                     
TAXC3    XC    FULL,FULL                                                        
         L     RF,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RF),PBDTAX-PBUYREC(RF)                          
         BZ    TAXCX                                                            
**GST                                                                           
         TM    PBDCNDA-PBUYREC(RF),X'80'     SEE IF CANADIAN BUY                
         BZ    TAXC8                                                            
         MVC   FULL(1),PBDGST-PBUYREC(RF)                                       
         LA    RE,PGSTTAB                                                       
         CLI   FULL,0                                                           
         BNE   *+8                                                              
         MVI   FULL,C'S'           DEFAULT TO STANDARD                          
*                                                                               
TAXC4    CLC   0(1,RE),FULL                                                     
         BE    TAXC5                                                            
         LA    RE,8(RE)                                                         
         CLI   0(RE),X'FF'                                                      
         BNE   TAXC4                                                            
         B     TAXC7              INVALID TAX CODE                              
*                                                                               
TAXC5    OC    2(2,RE),2(RE)      CHK FOR GST PCT                               
         BZ    TAXC7                                                            
*                                                                               
TAXC6    TM    1(RE),X'01'        SEE IF TAX BASED ON NET                       
         BO    TAXC7              TREAT AS NO GST                               
*                                                                               
TAXC6C   CLC   PBUYKDAT-PBUYREC(3,RF),4(RE)                                     
         BL    TAXC7                                                            
         CLC   PBDPDATE-PBUYREC(3,RF),4(RE)                                     
         BL    TAXC7                                                            
*                                                                               
         XC    FULL,FULL                                                        
         MVC   FULL+2(2),2(RE)                                                  
         L     RE,FULL                                                          
         L     RF,DUB                                                           
         MR    RE,RE                                                            
         SLDL  RE,1                                                             
         D     RE,=F'100000'          GST HAS 3 DECIMALS                        
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
         A     RF,DUB                 ADD GST TO DUB (NET)                      
         ST    RF,DUB                                                           
*                                                                               
TAXC7    XC    FULL,FULL                                                        
TAXC8    DS    0H                                                               
         L     RF,ADBUY                                                         
         MVC   FULL+1(3),PBDTAX-PBUYREC(RF)                                     
*                                                                               
         L     RE,FULL                                                          
         L     RF,DUB                                                           
         MR    RE,RE                                                            
         SLDL  RE,1                                                             
         D     RE,=F'1000000'      SINCE PBDTAX HAS 4 DECIMALS                  
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
         ST    RF,FULL            SALES TAX                                     
*                                                                               
TAXCX    XIT1                                                                   
***TAX                                                                          
*                                                                               
**GST                                                                           
       ++INCLUDE PGSTTAB                                                        
         EJECT                                                                  
FIXAC    NTR1                                                                   
*                                  R4 HAS ADDR OF 'BAD' AC                      
*                                  WILL BE SAME AS GROSS                        
*                                  FOR 'C' RATE BUYS                            
         L     RF,ADBUY                                                         
         ZAP   DUB,PBDACP-PBUYREC(3,RF)                                         
         BNZ   FIXAC5                                                           
         XC    0(4,R4),0(R4)       CLEAR AC                                     
         B     FIXACX                                                           
*                                                                               
FIXAC5   CVB   R0,DUB                                                           
         L     R1,0(R4)                                                         
         L     RF,=F'100000'                                                    
         SR    RF,R0                                                            
         MR    RE,R1                                                            
         SLDL  RE,1                                                             
         D     RE,=F'100000'                                                    
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
*                                                                               
         LR    R0,R1                                                            
         SR    R0,RF                                                            
         ST    R0,0(R4)            STORE 'FIXED' AGY COM                        
FIXACX   XIT1                                                                   
         EJECT                                                                  
*        SETSKIP  - SET TO SKIP PRD/EST IF UNPAID INS. FOUND                    
*                   USED WITH PAYOPTS E,F,G                                     
         SPACE 2                                                                
SETSKIP  NTR1                                                                   
         XC    X(20),X                                                          
         LA    R5,X                                                             
         USING UPED,R5                                                          
*                                                                               
         MVC   UPEPRD,KPRD   CAN'T USE PBUYKPRD  - MIGHT BE ZZZ                 
*                                                                               
         L     RE,ADBUY                                                         
         MVC   UPEEST,PBUYKEST-PBUYKEY(RE)                                      
*                                                                               
         GOTO1 BINSRCH,UPEPARS,(1,X)   ADD TO TABLE                             
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'      TOO MANY UNPAID ESTS - EXPAND UPETAB                   
*                                                                               
SETSKX   DS    0H                                                               
         XIT1                                                                   
         DROP  R5                                                               
         SPACE 3                                                                
*                                                                               
BUYBK5J  DS    0H                  NO REG/DST ELEM FOUND                        
*                                  SAVE INVOICE FOR LISTING                     
BUYBK6   L     RF,ADBUY                                                         
BUYBK6B  LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'        FIND BILLING ELEMS                           
*                                                                               
BUYBK6B5 CLI   FINANSW,X'01'       SEE IF DOING FINANCIAL CLIENT                
         BNE   BUYBK6C                                                          
         MVI   ELCODE,X'28'        LOOK FOR OPEN BILLING ELEMS                  
***R***                                                                         
         CLC   QPROG,=C'R1'        SEE IF FINANCIAL REBATE                      
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'        SEE IF FINANCIAL REBATE DRAFT                
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
***R***                                                                         
BUYBK6C  BAS   RE,NEXTEL                                                        
         BNE   BUYBK7                                                           
         USING PBILELEM,R2                                                      
         OC    PBLDATE,PBLDATE     SEE IF BILLED                                
         BZ    BUYBK6C                                                          
         CLC   PBPRD,KPRD          MUST BE RIGHT PRODUCT                        
         BNE   BUYBK6C             SKIP                                         
         TM    PBBILST,X'C0'       SKIP REVERSED AND REVERSALS                  
         BNZ   BUYBK6C                                                          
         CLI   SCBNCSW,C'C'        UFC COMM BILLING                             
         BNE   BUYBK6C3                                                         
         TM    PBBILST,X'01'                                                    
         BZ    BUYBK6C                                                          
         B     BUYBK6C8                                                         
*                                                                               
BUYBK6C3 DS    0H                                                               
         CLI   SCBNCSW,C'N'        UFC NET BILLING                              
         BNE   BUYBK6C8                                                         
         TM    PBBILST,X'02'                                                    
         BZ    BUYBK6C                                                          
*                                                                               
BUYBK6C8 DS    0H                                                               
         XC    X,X                                                              
         LA    R7,X                                                             
         USING INVLD,R7                                                         
         MVC   INVLINV(2),PBLDATE    YEAR AND MONTH                             
*                                                                               
         MVC   INVLINV+2(2),PBINVNO     INVOICE NUMBER                          
*                                                                               
*                                                                               
BUYBK6F  DS    0H                                                               
         OC    AMEDBRK,AMEDBRK                                                  
         BZ    BUYBK61                                                          
         CLC   AMEDBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLMED,QMEDIA                                                   
*                                                                               
BUYBK61  OC    APGR1BRK,APGR1BRK                                                
         BZ    BUYBK6F2                                                         
         CLC   APGR1BRK,AINVBRK                                                 
         BH    *+10                                                             
         MVC   INVLPGR,SAVPGRU     PGROUP - DIVISION                            
BUYBK6F2 CLC   APRDBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLPRD,PBPRD       PRD                                          
*                                                                               
         CLC   AESTBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLEST,PBUYKEST-PBUYKEY(RF)      EST                            
*                                                                               
         OC    AJOBBRK,AJOBBRK                                                  
         BZ    *+20                                                             
         CLC   AJOBBRK,AINVBRK                                                  
         BH    BUYBK6F4                                                         
         MVC   INVLJOB,PBDJOB-PBUYKEY(RF)      JOB                              
**NEW 4/25/90                                                                   
         OC    INVLJOB,INVLJOB                 SEE IF THERE IS A JOB            
         BNZ   BUYBK6F4                                                         
         MVC   INVLJOB,=X'FFFFFFFFFFFF'                                         
*                                    SO I WILL FIND IF JOB= *NONE*              
*                                    AJOB = 6X'FF'                              
**NEW 4/25/90                                                                   
BUYBK6F4 OC    APUBBRK,APUBBRK                                                  
         BZ    *+20                                                             
         CLC   APUBBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLPUB,PBUYKPUB-PBUYKEY(RF)      PUB                            
         OC    AMGR1BRK,AMGR1BRK                                                
         BZ    *+20                                                             
         CLC   AMGR1BRK,AINVBRK                                                 
         BH    *+10                                                             
         MVC   INVLMGR,SAVMGRU     MARKET GROUP - REG/DST                       
         OC    AMKTBRK,AMKTBRK                                                  
         BZ    BUYBK6G                                                          
         CLC   AMKTBRK,AINVBRK                                                  
         BH    BUYBK6G                                                          
         L     RF,ADPUB                                                         
         XC    WORK(20),WORK                                                    
         MVC   WORK(2),PUBSTACD-PUBREC(RF)                                      
         CLI   PUBSTACD-PUBREC(RF),C' '     USE STACD                           
         BNH   *+12                                                             
         CLI   PUBSTACD-PUBREC(RF),C'0'     UNLESS NUMERIC                      
         BL    *+10                                                             
         MVC   WORK(2),PUBSTATE-PUBREC(RF)                                      
         MVI   WORK+2,C','                                                      
         MVC   WORK+4(16),PUBZNAME-PUBREC(RF)  CAN ONLY USE 16 CHARS            
         CLI   QMEDIA,C'O'         FOR OUTDOOR MKT IS STATE, ZONE               
         BE    BUYBK6F5                                                         
         XC    WORK(20),WORK                                                    
         CLI   QMEDIA,C'N'                                                      
         BNE   BUYBK6F5            NO MKTS FOR MAGS,TRADE,SUPPLEMENTS           
         MVC   WORK(2),PUBSTATE-PUBREC(RF)                                      
         MVI   WORK+2,C','                                                      
         MVC   WORK+4(16),PUBCITY-PUBREC(RF)                                    
BUYBK6F5 LA    R5,WORK                                                          
BUYBK6F8 MVC   INVLMKT,0(R5)       MARKET                                       
         L     RF,ADBUY            MUST RESET RF                                
*                                                                               
BUYBK6G  CLC   APERBRK,AINVBRK                                                  
         BH    BUYBK6I                                                          
*                           FIND PERIOD THAT CONTAINS BILLABLE DATE             
         LA    RE,PERLIST                                                       
BUYBK6H  DS    0H                                                               
         CLC   PBDBDATE-PBUYKEY(3,RF),5(RE)                                     
         BNH   BUYBK6H2                                                         
         LA    RE,8(RE)                                                         
         B     BUYBK6H                                                          
*                                                                               
BUYBK6H2 DS    0H                                                               
         MVC   INVLPER,0(RE)                                                    
*                                                                               
BUYBK6I  DS    0H                                                               
         CLC   APERGBRK,AINVBRK                                                 
         BH    BUYBK6J                                                          
*                           FIND PERIOD THAT CONTAINS BILLABLE DATE             
         LA    RE,PERLIST                                                       
BUYBK6I2 CLC   PBDBDATE-PBUYKEY(3,RF),5(RE)                                     
         BNH   BUYBK6I4                                                         
         LA    RE,8(RE)                                                         
         B     BUYBK6I2                                                         
*                                                                               
BUYBK6I4 DS    0H                                                               
         MVI   INVLPERG,C'1'       SET PERIOD GROUP                             
         CLC   0(2,RE),CURPER                                                   
         BNE   BUYBK6J                                                          
         CLI   PRIOR,C'M'                                                       
         BNE   BUYBK6J                                                          
         MVI   INVLPERG,C'5'                                                    
*                                                                               
BUYBK6J  DS    0H                                                               
         OC    ACRDBBRK,ACRDBBRK                                                
         BZ    BUYBK6M                                                          
         CLC   ACRDBBRK,AINVBRK                                                 
         BH    BUYBK6M                                                          
         MVI   INVLCRDB,C'D'       DEBIT                                        
         L     RF,ASORTDTA                                                      
         L     R0,0(RF)                                                         
         L     R1,BGDSP(RF)                                                     
         CR    R0,R1                                                            
         BNL   BUYBK6M                                                          
         MVI   INVLCRDB,C'C'       CREDIT                                       
*                                                                               
BUYBK6M  MVC   INVLGRS(4),PBGROSS                                               
         MVC   FULL,PBGROSS                                                     
         L     RF,FULL                                                          
         MVC   FULL,PBAGYCOM                                                    
         S     RF,FULL                                                          
         ST    RF,INVLNET                                                       
         MVC   INVLCD,PBCSHDSC     CD                                           
         MVC   INVLAC,PBAGYCOM                                                  
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C' SEE IF 'C' RATE BUY                    
         BNE   BUYBK6O                                                          
         LA    R4,INVLAC                                                        
         BAS   RE,FIXAC                                                         
*                                                                               
BUYBK6O  GOTO1 BINSRCH,INVPARS,(1,X)                                            
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         L     RF,ADBUY            MUST RESET RF                                
*                                                                               
         CLI   0(R1),1             ALREADY THERE                                
         BE    BUYBK6C             NO - NEXT ELEM                               
*                                                                               
         L     R1,0(R1)            ADD INTO EXISTING ELEM                       
         MVC   DMCB(16),INVLGRS-INVLD(R1)                                       
         ST    R3,FULL              SAVE BRKTAB R3                              
         LM    R3,R6,DMCB                                                       
         MVC   DMCB(16),INVLGRS                                                 
         A     R3,DMCB                                                          
         A     R4,DMCB+4                                                        
         A     R5,DMCB+8                                                        
         A     R6,DMCB+12                                                       
         STM   R3,R6,DMCB                                                       
         L     R3,FULL                RESTORE BRKTAB R3                         
         MVC   INVLGRS-INVLD(16,R1),DMCB                                        
         B     BUYBK6C                                                          
*                                                                               
BUYBK7   LH    R0,SPTSEQ                                                        
         AH    R0,=H'1'                                                         
         STH   R0,SPTSEQ                                                        
BUYBK7B  L     RF,BRKCODE                                                       
         LTR   RF,RF                                                            
         BZ    BUYBK8                                                           
         BAS   RE,BUYBRKS-4(RF)                                                 
         LA    R3,BRKL(R3)                                                      
         B     BUYBK7B                                                          
*                                                                               
BUYBK8   DS    0H                                                               
         CLI   ZLSW,C'Y'           SEE IF TOTALLY BILLED                        
         BE    BUYBK8B                                                          
         L     R2,ASORTCOM                                                      
         OC   MANGRS(12),MANGRS                                                 
         BNZ   *+10                                                             
         MVC   0(4,R2),KEY+27      DISK ADDRESS                                 
         B     BUYBK8E                                                          
*                                                                               
BUYBK8B  L     R2,ASORTDTA                                                      
         OC    BGDSP(20,R2),BGDSP(R2) SEE IF BILLED                             
         BZ    BUYBK9                                                           
**NEW 5/3/88                                                                    
         L     RF,ADBUY                                                         
*                              SEE IF OLD MANUAL BILL                           
         CLI   3(RF),X'88'                                                      
         BE    BUYBK8E         YES - DON'T SET AS BILLED INSERTION              
*                              SO ORDERED(20) WON'T' EQUAL BILLED               
*                              SINCE IDSP(R2) STILL SET TO F'1'                 
*                              IN BUYBK3A                                       
*                                                                               
         MVC   BIDSP(4,R2),=F'1' SET 1 BILLED INS                               
BUYBK8E  GOTO1 ATOSORT                                                          
BUYBK9   DS    0H                                                               
PRBUYX   XIT1                                                                   
         SPACE 2                                                                
BUYBRKS  DS    0F                                                               
         B     BKMED                                                            
         B     BKPGR1                                                           
         B     BKPGR2                                                           
         B     BKPGR3                                                           
         B     BKPRD                                                            
         B     BKEST                                                            
         B     BKMGR                                                            
         B     BKMGR                                                            
         B     BKMGR                                                            
         B     BKMKT                                                            
         B     BKJOB                                                            
         B     BKPUB                                                            
         B     BKDESC                                                           
         B     BKPER                                                            
         B     BKPERG                                                           
         B     BKCRDB                                                           
*                                                                               
         SPACE 2                                                                
BKMED    DS    0H                                                               
         L     RF,ADBUY                                                         
         MVC   HALF(1),PBUYKMED-PBUYREC(RF)                                     
         MVC   HALF+1(1),FINANSW                                                
         LA    R2,HALF                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKPGR1   DS    0H                                                               
         LA    R2,SAVPGRU                                                       
         B     BKALL                                                            
         SPACE 2                                                                
BKPGR2   DS    0H                                                               
         LA    R2,SAVPGRU                                                       
         ZIC   RF,PGR1LEN                                                       
         AR    R2,RF               POINT OT PGR2                                
         B     BKALL                                                            
         SPACE 2                                                                
BKPGR3   DS    0H                                                               
         LA    R2,SAVPGRU                                                       
         ZIC   RF,PGR2LEN                                                       
         AR    R2,RF               POINT OT PGR3                                
         B     BKALL                                                            
         SPACE 2                                                                
BKPRD    DS    0H                  PRD                                          
         LA    R2,KPRD                                                          
         L     RF,ADBUY                                                         
         CLI   3(RF),X'88'         SEE IF PROCESSING MANUAL BILL                
         BNE   BKALL                                                            
         LA    R2,PBUYKPRD-PBUYREC(RF)                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKEST    DS    0H                  EST                                          
         L     RF,ADBUY                                                         
         LA    R2,PBUYKEST-PBUYREC(RF)                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKPER    DS    0H                  PERIOD                                       
*                                  FIND PERIOD THAT CONTAINS BLBL DATE          
         LA    R2,PERLIST                                                       
BKPER2   DS    0H                                                               
         L     RF,ADBUY                                                         
         CLC   PBDBDATE-PBUYREC(3,RF),5(R2)                                     
         BNH   BKPER3                                                           
         LA    R2,8(R2)                                                         
         B     BKPER2                                                           
*                                                                               
BKPER3   DS    0H                                                               
         LA    R0,PERLIST                                                       
         SR    R2,R0                                                            
         SRL   R2,3                                                             
         STC   R2,BYTE              CODE FOR PERIOD                             
         LA    R2,BYTE                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKPERG   DS    0H                                                               
         LA    R5,PERLIST                                                       
BKPERG2  DS    0H                                                               
         L     RF,ADBUY                                                         
         CLC   PBDBDATE-PBUYREC(3,RF),5(R5)                                     
         BNH   BKPERG5                                                          
         LA    R5,8(R5)                                                         
         B     BKPERG2                                                          
*                                                                               
BKPERG5  DS    0H                                                               
         LA    R2,=C'1'            OLD MONTHS                                   
         CLC   0(2,R5),CURPER                                                   
         BNE   BKALL                                                            
         CLI   PRIOR,C'M'                                                       
         BNE   BKALL                                                            
         LA    R2,=C'5'                                                         
         B     BKALL                                                            
*                                                                               
         SPACE 2                                                                
BKCRDB   DS    0H                                                               
         LA    R2,=C'D'             DEBIT                                       
         L     RF,ASORTDTA                                                      
         L     R0,0(RF)                                                         
         L     R1,ROWHL(RF)                                                     
         CR    R0,R1                                                            
         BNL   BKALL                                                            
         LA    R2,=C'C'                                                         
         B     BKALL                MUST BE CREDIT                              
         SPACE 2                                                                
BKMGR    DS    0H                                                               
         LA    R2,SAVMGRU                                                       
         CLI   BRKCODE+3,MGR1EQ                                                 
         BE    BKALL                                                            
         LR    R0,R2                                                            
         ZIC   RF,MGR1LEN                                                       
         AR    R2,RF               POINT TO MGR2                                
         CLI   BRKCODE+3,MGR2EQ                                                 
         BE    BKALL                                                            
         LR    R2,R0                                                            
         ZIC   RF,MGR2LEN                                                       
         AR    R2,RF               POINT OT MGR3                                
         B     BKALL                                                            
*                                                                               
         SPACE 2                                                                
BKMKT    DS    0H                  MKT                                          
         L     RF,ADPUB                                                         
         XC    WORK(20),WORK                                                    
         MVC   WORK(2),PUBSTACD-PUBREC(RF)                                      
         CLI   PUBSTACD-PUBREC(RF),C' '     USE STACD                           
         BNH   *+12                                                             
         CLI   PUBSTACD-PUBREC(RF),C'0'     UNLESS NUMERIC                      
         BL    *+10                                                             
         MVC   WORK(2),PUBSTATE-PUBREC(RF)                                      
         MVI   WORK+2,C','                                                      
         MVC   WORK+4(16),PUBZNAME-PUBREC(RF)  CAN ONLY USE 16 CHARS            
         CLI   QMEDIA,C'O'         FOR OUTDOOR MKT IS STATE, ZONE               
         BE    BKMKT5                                                           
         XC    WORK(20),WORK                                                    
         CLI   QMEDIA,C'N'                                                      
         BNE   BKMKT5              NO MKTS FOR MAGS,TRADE,SUPPLEMENTS           
         MVC   WORK(2),PUBSTATE-PUBREC(RF)                                      
         MVI   WORK+2,C','                                                      
         MVC   WORK+4(16),PUBCITY-PUBREC(RF)                                    
BKMKT5   LA    R2,WORK                                                          
         B     BKALL                                                            
         SPACE 2                                                                
*                                                                               
         SPACE 2                                                                
BKPUB    DS    0H                  PUB                                          
         L     RF,ADBUY                                                         
         LA    R2,PBUYKPUB-PBUYREC(RF)                                          
         CLC   XXPUB,0(R2)                                                      
         BE    BKALL               OLD OR NEW MANUAL BILLS                      
         CLI   ZUOPT,C'P'          SEE IF COMBINING PREV BILLS                  
*                                  ACROSS PUBS                                  
         BNE   BKALL                                                            
         CLI   ZLSW,C'Y'           SEE IF FULLY BILLED                          
         BNE   BKALL                                                            
         LA    R2,=X'FFFFFFFFFFFF'                                              
         B     BKALL                                                            
*                                                                               
BKJOB    DS    0H                  JOB (WITH PRD)                               
         XC    WORK,WORK                                                        
         LA    R2,WORK                                                          
         L     RF,ADBUY                                                         
         MVC   WORK(3),PBUYKPRD-PBUYREC(RF)                                     
         MVC   WORK+3(6),PBDJOB-PBUYREC(RF)                                     
         CLC   WORK+3(6),SPACES                                                 
         BE    BKJOB5                                                           
         OC    WORK+3(6),WORK+3                                                 
         BNZ   BKALL                                                            
BKJOB5   MVC   WORK(9),=9X'FF'     FOR BUYS WITH NO JOB                         
         B     BKALL                                                            
*                                                                               
BKDESC   DS    0H                                                               
         XC    WORK,WORK                                                        
         CLI   ZLSW,C'Y'           TEST ALREADY BILLED                          
         BE    BKDESC2                                                          
         OC   MANGRS(12),MANGRS                                                 
         BNZ   BKDESC3                                                          
         L     RF,ADBUY                                                         
         MVC   WORK(3),PBUYKDAT-PBUYREC(RF)                                     
         MVC   WORK+3(2),SPTSEQ                                                 
         B     BKDESC9                                                          
*                                                                               
BKDESC2  MVI   WORK,X'FA'          PREVBILLED INS                               
         L     RF,ADBUY                                                         
         CLI   PBUYKRCD-PBUYREC(RF),X'88'   SEE IF PREV MANUAL BILL             
         BNE   BKDESC9                                                          
         MVI   WORK,X'FC'          PREV MANUAL BILL (FROM RMBILL)               
*                                                                               
*              THE FOLLOWING IS NEEDED TO INSURE UNIQUE DECSRIPTIONS            
*              THE FIELDS WERE SET IN RMBILL IN THE DUMMY BUY                   
*                                                                               
         MVC   WORK+1(1),PBDPDATE+2-PBUYREC(RF)  PBILKMN+1 - MONTH              
         MVC   WORK+2(2),PBDPDATE-PBUYREC(RF)  PBILKBNO - INVOICE NO.           
         L     R2,ASORTCOM         SET DISK ADDR                                
         MVC   0(4,R2),KEY+27                                                   
         B     BKDESC9                                                          
*                                                                               
BKDESC3  MVI   WORK,X'FB'          CURRENT MANUAL                               
*                                                                               
BKDESC9  LA    R2,WORK                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKALL    DS    0H                                                               
         LA    R5,SORTKEY                                                       
         A     R5,BRKDISP                                                       
         L     RF,BRKLENM1                                                      
         EX    RF,*+6                                                           
         BR    RE                                                               
         MVC   0(0,R5),0(R2)                                                    
         SPACE 2                                                                
         LTORG                                                                  
         SPACE 3                                                                
         TITLE 'SPREPB102 -  FIRST FOR CLIENT'                                  
         SPACE 2                                                                
CFIRST   CSECT                                                                  
         NMOD1 0,CFIRST                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
         MVI   CLTRDSW,C'Y'          SET CLT READ FOR THIS REQUEST              
*                                    CHECKED AT REQLAST                         
         MVI   CLTSW,C'Y'            SET TO PROCESS THIS CLIENT                 
*                                    CLTSW IS SET TO 'N' IN AERRPROC            
*                                    IF ERR=PROFERR OR TYPERR                   
         XC    UPETABN,UPETABN       RESET UPETAB                               
*                                    FOR EACH CLIENT                            
*                               MUST REST MEDNM AT EACH CLIENT                  
*                               SINCE IT MIGHT HAVE BEEN ALTERED                
         L     RF,ADAGY                                                         
         MVC   MED,QMEDIA                                                       
         MVC   MEDNM,PAGYMED-PAGYREC(RF)                                        
         L     RF,ADCLT                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'41'                                                     
         BAS   RE,CNEXTEL                                                       
         BNE   *+10                                                             
         MVC   MEDNM,2(R2)                                                      
*                                                                               
         CLI   RCLANG,4            SEE IF FRENCH                                
         BNE   CLT3                CHANGE NEWPAPERS TO JOURNAUX                 
         CLI   QMEDIA,C'N'                                                      
         BNE   CLT2                                                             
         MVC   MEDNM,=CL10'JOURNAUX'                                            
         B     CLT3                                                             
*                                                                               
CLT2     CLI   QMEDIA,C'O'       CHANGE OUTDOOR TO EXTERIOR                     
         BNE   CLT3                                                             
         MVC   MEDNM,=CL10'EXTERIEUR'                                           
*                                                                               
CLT3     DS    0H                                                               
         L     RF,ADCLT                                                         
         MVC   CLIENT,PCLTKCLT-PCLTREC(RF)                                      
         MVI   FINANSW,0                                                        
         CLI   PCLTFIN-PCLTREC(RF),C'Y'                                         
         BNE   *+8                                                              
         MVI   FINANSW,X'01'                                                    
***R***                                                                         
         CLC   QPROG,=C'R1'   FINANCIAL REBATE ONLY FOR FINANCIAL CLTS          
         BE    CLTF0                                                            
         CLC   QPROG,=C'RD'  FINANCIAL REBATE DRAFT                             
         BNE   CLTF1                                                            
CLTF0    TM    FINANSW,X'01'   ONLY FOR FINANCIAL CLIENTS                       
         BNZ   CLTF1                                                            
         MVI   ERR,PROFERR                                                      
         GOTO1 AERRPROC                                                         
         B     CLXFX                                                            
***R***                                                                         
*                                                                               
********                             CHK FOR FINANCIAL CLIENT HERE              
********                             AND SET FINANSW TO X'01' IF YES            
********                                                                        
CLTF1    CLI   RCMULTIQ,C'Y'        SEE IF DOING MULTI-MEDIA REQ                
         BNE   CLTF2                                                            
         CLI   QMEDIA,C'M'                                                      
         BE    CLTF2            ONLY CLEAR BRKTAB FOR FIRST MEDIA               
         CLI   SETDSW,C'Y'                                                      
         BE    CLTF4                                                            
*                               ON MULTI-MEDIA REQS                             
*                               AND DONT GO TO AAGMPROC                         
*                               IF DATE ALREADY SET IN CLTF                     
CLTF2    XC    BRKTAB,BRKTAB                                                    
         MVC   PAGE,=H'1'       RESET PAGE FOR NON-MULTIMEDIA REQS              
         CLI   QCLIENT,C'*'      SEE IF OFFICE REQUEST                          
         BE    CLTF2A                                                           
         CLI   QCLIENT,C'&&'     SEE IF BILLING GROUP REQUEST                   
         BNE   *+10                                                             
CLTF2A   MVC   QEND,SQEND         MUST RESET QEND SAVED AT REQFRST              
*                                 SO SETDATE WILL NOT THINK IT'S                
*                                 ONLY DOING ONE MONTH                          
*                                                                               
         CLC   QAGENCY(6),QSAVE+2       AGY/MED/CLT BREAK                       
         BE    CLTF2C                                                           
         GOTO1 AAGMPROC            GET AGM BILLING PROFILE                      
*                                                                               
CLTF2C   CLI   RCMULTIQ,C'Y'                                                    
         BNE   CLTF2T                                                           
         CLI   AGMSEQ,C'A'                                                      
         BE    CLTF2T                                                           
         DC    H'0'        MULTI-MEDIA REQ MUST SEQ ACROSS MEDIA                
*                                                                               
CLTF2T   DS    0H                  GET STARTING INVNO                           
         CLC   SVAGMINV,AGMSTANO   TEST CHANGE OF INVNO CTLS                    
         BE    *+14                                                             
         MVC   SVAGMINV,AGMSTANO                                                
         B     CLTF3D                                                           
*                                                                               
         CLI   AGMOCTL,0           IF DOING BY OFFICE                           
         BE    CLTF2V                                                           
         L     RF,ADCLT                                                         
         CLC   SVOFF,PCLTOFF-PCLTREC(RF) AND OFFICE HAS CHANGED                 
         BNE   CLTF3D                    GET NEW STARTING INVNO                 
         CLC   SVAGMOCT,AGMOCTL          OR IF AGMOCTL HAS CHANGED              
         BNE   CLTF3D                                                           
*                                                                               
****                                CODE MOVED FROM AFTER CLTF5                 
CLTF2V   DS    0H                                                               
CLTF3    DS    0H                                                               
         CLC   QSAVE(2),QPROG         FIRST TIME                                
         BNE   CLTF3D              YES                                          
**                                                                              
         CLI   RCMULTIQ,C'Y'       SEE IF DOING MULTIMEDIA REQ                  
         BNE   CLTF3A                                                           
         CLI   SETDSW,C'N'         SEE IF FIRST MEDIA ENCOUNTERED               
         BE    CLTF3D              YES                                          
**                NOTE AGMSEQ MUST BE "A" FOR MULTI MEDIA REQS                  
**                                                                              
CLTF3A   CLI   AGMSEQ,C'C'         TEST SEQ BY CLIENT                           
         BE    CLTF3D                                                           
         CLI   AGMSEQ,C'D'         TEST SEQ BY CLIENT ACROSS MEDIA              
         BE    CLTF3D                                                           
         CLC   QMEDIA,QSAVE+4                                                   
         BE    CLTF3C              MUST STILL GO TO GETNUM                      
         CLI   AGMSEQ,C'M'                                                      
         BE    CLTF3D                                                           
*                                  REDO INV NO TO GET RIGHT MEDIA               
CLTF3C   MVC   W(2),TODAYB         SET MONTH FOR GETNUM                         
         GOTO1 AGETNUM,DMCB,(1,INVNO),PINVNO                                    
         B     CLTF3F                                                           
CLTF3D   DS    0H                  GET FIRST INVOICE NO.                        
         XC    INVNO,INVNO                                                      
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO                                        
*                                                                               
CLTF3F   DS    0H                                                               
         OC    INVNO,INVNO         IF NO INVOICE NUMBER                         
         BNZ   CLTF4              (DUE TO ERROR)                                
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO   GET ONE NOW                          
*                                                                               
CLTF4    DS    0H                                                               
         LA    RF,SVAADDRS              RESTORE SAVE CORP ADDR                  
         L     RE,AAADDRS                                                       
         MVC   0(L'SVAADDRS,RE),0(RF)                                           
*                                                                               
         CLC   QAGENCY(6),QSAVE+2       CLIENT BREAK                            
         BE    CLTF8                                                            
***                                                                             
***  NOTE - FOR MULTI-MEDIA REQS AAA FORMULAS + ADDRS ARE GOTTEN                
***         ONLY FOR FIRST MEDIA - MAGAZINES                                    
***         SINCE CLIENT IS THE SAME                                            
*                                  READ AAA PRDHDR                              
*                                  FOR ADDRESS AND FORMULA                      
         L     RE,AAADDRS                                                       
         MVC   0(132,RE),SPACES                                                 
         MVC   132(ADDRLEN-132,RE),SPACES                                       
*                                                                               
         XC    AAAFORM,AAAFORM                                                  
         XC    AAAFORM2,AAAFORM2                                                
         XC    AAAFORM3,AAAFORM3                                                
         L     RF,AAELIST                                                       
         MVC   0(6,RF),FFS                                                      
*                                                                               
         MVC   KEY1,KEY                                                         
         L     RF,ADCLT                                                         
         MVC   KEY(25),0(RF)                                                    
         MVI   KEY+3,X'06'                                                      
         MVC   KEY+7(3),=C'AAA'                                                 
         GOTO1 HIGH                                                             
         CLC   KEY(25),KEYSAVE                                                  
         BNE   CLTF5                                                            
         MVC   AREC,ADWKREC        READ INTO WORK REC                           
         GOTO1 GETPRT                                                           
         L     RF,AREC                                                          
         LA    RF,PPRDBILL-PPRDREC(RF)                                          
         CLC   =C'NONE',0(RF)                                                   
         BE    CLTF4A                                                           
         CLC   =C'XX',0(RF)                                                     
         BE    CLTF4A                                                           
         CLC   =C'X ',0(RF)                                                     
         BE    CLTF4A                                                           
         CLI   0(RF),C'A'                                                       
         BL    CLTF4A                                                           
         L     RE,AAADDRS       CORP ADDRESS                                    
         MVC   000(20,RE),00(RF)                                                
         MVC   036(30,RE),20(RF)                                                
         MVC   072(30,RE),50(RF)                                                
         MVC   108(24,RE),80(RF)                                                
**NEW 3/7/89                                                                    
*                        CHECK FOR SECOND BILL RECEIPT NAME LINE                
*                                                                               
         L     R1,AREC              DID USE RE  NOW USE R1                      
         LA    R1,PPRDBIL2-PPRDREC(R1)  AND LEAVE RE SET TOAAADDRS              
*                                       RF IS STILL SET TO PPRDBILL             
         CLI   0(R1),C'A'                                                       
         BL    CLTF4A                                                           
         CLC   =C'NONE',0(R1)                                                   
         BE    CLTF4A                                                           
         CLC   =C'XX',0(R1)                                                     
         BE    CLTF4A                                                           
         CLC   =C'X ',0(R1)                                                     
         BE    CLTF4A                                                           
         MVC   036(30,RE),SPACES      CLEAR                                     
         MVC   036(20,RE),0(R1)                                                 
         MVC   072(30,RE),20(RF)                                                
         MVC   108(30,RE),50(RF)                                                
         MVC   144(24,RE),80(RF)                                                
**NEW 3/7/89                                                                    
*                                                                               
CLTF4A   DS    0H                                                               
         L     RF,AREC                                                          
         MVC   AAAFORM,PPRDBILP-PPRDREC(RF)    DATE, BASE + COMMISSION          
         MVC   AAAFORM2,PPRDBILP+37-PPRDREC(RF)   2ND FORMULA + DATE            
         MVC   AAAFORM3,PPRDBILP+44-PPRDREC(RF)   3ND FORMULA + DATE            
*                                                                               
*                                  BUILD LIST OF ANY AAA EST FORMULAS           
         L     R6,AAELIST          START                                        
         L     RF,AREC                                                          
         MVC   KEY,0(RF)                                                        
         MVI   KEY+3,7                                                          
CLTF4B   DS    0H                                                               
         GOTO1 SEQ                                                              
         CLC   KEY(10),KEYSAVE                                                  
         BNE   CLTF5               DONE                                         
*                                                                               
         GOTO1 GETREC                                                           
         L     RF,AREC                                                          
         MVC   0(2,R6),10(RF)      EST NO.                                      
         MVC   2(37,R6),PESTBILP-PESTREC(RF)    FORMULA                         
         OC    2(37,R6),2(R6)                                                   
         BZ    CLTF4D                                                           
         OC    2(5,R6),2(R6)                                                    
         BNZ   CLTF4D                                                           
         MVC   2(2,R6),=X'0505'              SET DEFAULT                        
*                                     IF CHAB WITH NO FORMULA                   
*                                                                               
CLTF4D   MVC   39(14,R6),PESTREVN+3-PESTREC(RF)    FORMULAS 2 + 3               
*                                                                               
**             2ND AND 3RD FORMULAS                                             
*                                                                               
         LA    R6,53(R6)                                                        
         MVC   0(6,R6),FFS         SET EOL                                      
         L     RE,AAELIST                                                       
         AH    RE,=H'5300'         MAX 100 ESTS                                 
         CR    R6,RE                                                            
         BL    CLTF4B                                                           
         DC    H'0'                TABLE FULL                                   
*                                                                               
CLTF5    DS    0H                                                               
         LA    RF,SVAADDRS         SAVE CORP ADDR                               
         L     RE,AAADDRS                                                       
         MVC   0(L'SVAADDRS,RF),0(RE)                                           
*                                                                               
         MVC   KEY,KEY1                                                         
         GOTO1 HIGH                RESTORE SEQ                                  
*                                                                               
CLTF8    DS    0H                                                               
CLTF10   DS    0H                                                               
*                                       CHECK FOR MANUAL AMOUNTS                
         XC    MANUALS,MANUALS                                                  
         XC    EXDATE,EXDATE                                                    
         MVI   NONRET,C'N'                                                      
         MVI   PREVSW,0                                                         
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+8                                                              
         MVI   PREVSW,C'N'              NO PREV FOR RETAIL DRAFT                
         CLC   =C'ONLY PREV',QMANUAL    ONLY PREV BILLS                         
         BNE   CLTF10B                                                          
         MVI   PREVSW,C'P'                                                      
         B     CLTF50                                                           
CLTF10B  DS    0H                                                               
         CLC   =C'PREV',QMANUAL                                                 
         BNE   CLTF10C                                                          
         MVI   PREVSW,C'Y'                                                      
         B     CLTF50                                                           
CLTF10C  DS    0H                                                               
         CLC   =C'NO PREV',QMANUAL NO PREVIOUS BILLS                            
         BNE   CLTF10D                                                          
         MVI   PREVSW,C'N'                                                      
         B     CLTF50                                                           
CLTF10D  DS    0H                                                               
         CLI   QMANUAL,C'X'       TO EXCULDE BILLING ON THIS DATE               
         BNE   CLTF10E                                                          
         GOTO1 DATCON,DMCB,QMANUAL+1,(3,EXDATE)                                 
         B     CLTF50                                                           
*                                                                               
CLTF10E  CLC   =C'NO PRIOR',QMANUAL                                             
         BE    CLTF50                                                           
*                                                                               
*                                       NON-RETAIL                              
         CLC   =C'NON-RETAI',QMANUAL    SUPPRESS RETAIL                         
         BNE   CLTF10M                                                          
         MVI   NONRET,C'Y'                                                      
         B     CLTF50                                                           
*                                                                               
CLTF10M  DS    0H                                                               
         CLC   QMANUAL,SPACES                                                   
         BE    CLTF50                                                           
         CLI   QMANUAL,C'P'         PCT                                         
         BE    CLTF20                                                           
         CLI   QMANUAL,C'R'        REVERSAL                                     
         BE    CLTF30                                                           
         CLI   QMANUAL,C'G'                                                     
         BE    CLTF10R                  ERROR                                   
         CLI   QMANUAL,C'F'        FEE                                          
         BNE   CLTF39                   ERROR                                   
CLTF10R  MVC   MANGRS,QMANUAL+1                                                 
         MVC   MANNET,QMANUAL+1                                                 
         XC    MANAC,MANAC          CLEAR MANAC                                 
         CLC   QPROG,=C'R1'   NO MANUAL AMOUNTS FOR R1- REBATE BILL             
         BE    CLTF39                                                           
         CLC   QPROG,=C'RD' NO MANUAL AMOUNTS FOR R1-REBATE BILL DRAFT          
         BE    CLTF39                                                           
*                                                                               
         CLC   QMANCD,SPACES                                                    
         BE    *+10                                                             
         MVC   MANCD,QMANCD        MANUAL CD                                    
*                                                                               
         CLI   QMANUAL,C'F'        SEE IF FEE                                   
         BE    CLTF14              LEAVE MANGRS=MANNET                          
*                                  LEAVE MANAC AS ZERO                          
*                                                                               
         L     R1,MANGRS                                                        
         CLI   QMEDIA,C'O'         SEE IF OUTDOOR                               
         BNE   CLTF11                                                           
**NEW 6/22/88                                                                   
         L     RF,ADAGY                                                         
         CLI   PAGYNAT-PAGYREC(RF),C'C'   SEE IF CANADIAN AGY                   
         BE    CLTF11                     ALWAYS 15.00 PCT                      
**NEW 6/22/88                                                                   
         L     RF,=F'10000'         NET IS 16.67% FOR OUTDOOR                   
         L     RE,=F'8333'                                                      
         B     CLTF12                                                           
*                                                                               
*                                                                               
CLTF11   LA    RF,100              NET IS 85/100                                
         LA    RE,85                                                            
CLTF12   DS    0H                                                               
         MR    R0,RE                                                            
         DR    R0,RF                                                            
         ST    R1,MANNET                                                        
         L     RE,MANGRS                                                        
         SR    RE,R1                                                            
         ST    RE,MANAC          AC = GROSS- NET                                
*                                                                               
CLTF14   DS    0H                                                               
         B     CLTF50                                                           
         SPACE 2                                                                
*                                  PCT                                          
CLTF20   DS    0H                                                               
         MVI   NONRET,C'Y'         NO RETAIL IF PCT BILL                        
         MVC   MANPCT,QMANUAL+1    2 DECIMALS                                   
         OC    MANPCT,MANPCT                                                    
         BZ    CLTF39                                                           
         B     CLTF50                                                           
         SPACE 2                                                                
*                                  REVERSAL INVOICE NUMBER                      
CLTF30   DS    0H                                                               
         LA    R2,QMANUAL+1                                                     
         GOTO1 DATCON,DMCB,(R2),(3,MANRVDTP)                                    
*                                                                               
**NEW 9/26/90   QMANUAL+7(4) WAS BINARY FIELD - REVERSAL INV NUMBER             
**              MVC   MANRVNO,QMANUAL                                           
         PACK  DUB,QMANUAL+7(4)                                                 
         CVB   R0,DUB                                                           
         STH   R0,MANRVNO                                                       
         OC    MANRVNO,MANRVNO                                                  
         BZ    CLTF39                                                           
         CLC   QMANCD,=C'NON-'      SEE IF NON-RETAIL REVERSAL                  
         BNE   CLTF30C                                                          
         MVI   NONRET,C'Y'          SET TO NON-RETAIL                           
*                                                                               
*        NO-OPED                                                                
******   CLC   QREGION(6),SPACES                                                
******   CLI   QMGR,C' '           IF MGR'S DONT SUPPRESS BUY READ              
******   BNE   *+8                                                              
******   MVI   FCRDBUY,C'N'       SUPPRESS READING OF BUYS                      
CLTF30C  MVI   PREVSW,C'Y'                                                      
*                                                                               
         B     CLTF50                                                           
         SPACE 2                                                                
CLTF39   DS    0H                                                               
         MVI   ERR,MANERR                                                       
         GOTO1 AERRPROC                                                         
         B     CLXFX                                                            
*                                                                               
CLTF50   DS    0H                                                               
         CLI   RCMULTIQ,C'Y'     SEE IF DOING MULTI-MEDIA REQ                   
         BNE   CLTF51                                                           
*                                                                               
         CLI   SETDSW,C'Y'       SEE IF DATES SET                               
         BE    CLTF52                                                           
*                                                                               
CLTF51   GOTO1 ASETDATE                                                         
*                                                                               
         GOTO1 =V(VBADD),DMCB,(C'C',0)     CLEAR VBTAB                          
*                              WHEN I DIDN'T SOMETIMES VAT BASIS                
*                              WAS WRONG FOR OFFICE AND BILLING GROUP           
*                              REQUESTS                                         
*                                                                               
         CLI   CLTSW,C'N'      MEANS SKIP THIS CLIENT                           
         BE    CLXFX                                                            
         MVI   SETDSW,C'Y'  SO THEY WON'T BE RESET ON MULTI-MED REQ             
**GST                                                                           
*                            NOTE- CODES FOR PSTS ARE SET IN SETCPVC            
*                                  IF CVATCOD IS SET TO NULL HERE               
*                                  IT STAYS NULL AND ALL VATS ARE OFF           
         MVC   CVATSTRT,=X'5B01'          JAN/91                                
******** MVC   CVATRATE,=F'7000'          7.000 PCT                             
         MVI   CVATCOD,0                                                        
         L     RF,ADAGY                                                         
         CLI   PAGYNAT-PAGYREC(RF),C'C'    SEE IF CANADIAN                      
         BNE   CLTF51F                                                          
         CLC   CURPER,CVATSTRT     SEE IF CURRENT PER BEFORE START              
         BL    CLTF51F                                                          
         MVI   CVATCOD,C'S'        SET DEFAULT                                  
         L     RF,ADCLT                                                         
         CLI   PCLTGST-PCLTREC(RF),C' '                                         
         BNH   CLTF51F                                                          
         MVC   CVATCOD,PCLTGST-PCLTREC(RF)                                      
*                                                                               
CLTF51F  DS    0H                                                               
*******  CLI   CVATCOD,C'S'                                                     
*******  BE    *+10                                                             
*******  XC    CVATRATE,CVATRATE    OTHER CODES = ZERO PCT                      
*                                                                               
*                                                                               
***E***                                                                         
         CLC   QPROG,=C'E1'   FIX OPTIONS AND PROFILES FOR ESTIMATES            
         BNE   CLTF52                                                           
         MVI   PEOVOPT,C'N'                                                     
         MVI   CDSEP,C'N'                                                       
         MVI   ADJSEP,C'N'                                                      
         MVI   TEST,C'T'                                                        
         MVI   PRIOR,C'T'                                                       
         MVI   LSTOPT,C'N'                                                      
         MVI   ZBOPT,C'N'                                                       
         MVI   ZUOPT,C'S'                                                       
         MVI   ZLOPT,C'0'                                                       
         MVI   ORIGTYPE,0                                                       
         MVI   PROGPRO3+5,C'0'             NO STRIP-OFF                         
         MVI   PROGPRO4+5,C'0'             NO STRIP-OFF                         
         MVC   PROGPRO3+6(3),=C'YNN'       SET TO ORDERED ONLY                  
         MVC   PROGPRO4+6(3),=C'YNN'       SET TO ORDERED ONLY                  
***E***                                                                         
*                                                                               
*                                                                               
CLTF52   DS    0H                                                               
         CLI   SCBOPT,C'Y'       SEE IF SEP COMMISSION OPTION                   
         BNE   CLTF70                                                           
         CLC   =C'ALL',QCLIENT                                                  
         BE    CLTF53                                                           
         CLI   QCLIENT,C'*'         OFFICE                                      
         BE    CLTF53                                                           
         CLI   QCLIENT,C'&&'        OR GROUP                                    
         BNE   CLTF54                                                           
*                                                                               
CLTF53   MVI   MODE,CLILAST         SKIP THIS CLIENT                            
         B     CLXFX                                                            
*                                                                               
CLTF54   CLI   PROFB2B+1,0          CHK FOR EST FILTER PROFILE                  
         BNH   CLTF60                                                           
         CLI   PROFB2B+2,C'*'       CAN'T BE AN *                               
         BE    CLTF62                                                           
         B     CLTF56                                                           
******                                                                          
******   FILTERS NOW ADDED/ALTERED AT REQFRST                                   
******   CLC   =C'ALL',QEST                                                     
*****    BNE   CLTF56                                                           
***                                                                             
***      CLI   QESTEND,C' '         CHK FOR FILTER ALREADY THERE                
***      BH    *+10                                                             
***      MVC   QESTEND(3),=C'***'                                               
***                                                                             
***      ZIC   RF,PROFB2B+1                                                     
***      LA    RF,QESTEND-1(RF)                                                 
***      MVC   0(1,RF),PROFB2B+2        SET FILTER VALUE IN REQUEST             
***      CLI   SCBNCSW,C'R'                                                     
***      BE    *+8                                                              
***      NI    0(RF),X'BF'              SET TO ALL BUT                          
***      B     CLTF70                                                           
***                                                                             
CLTF56   DS    0H                                                               
         CLI   QESTEND,C'0'                                                     
         BL    CLTF70                                                           
         MVI   ERR,ESTERR             CAN'T HANDLE RANGE OF ESTS                
         GOTO1 AERRPROC                                                         
*                                                                               
CLTF60   DS    0H             HERE IF NO FILTER POSITION                        
         CLI   SCBNCSW,C'R'                                                     
         BNE   CLTF70                                                           
CLTF62   MVI   ERR,SCBERR                                                       
         GOTO1 AERRPROC       IF REGULAR MUST HAVE FILTER POSITION              
*                             OR FILTER VALUE WAS *                             
*                                                                               
CLTF70   DS    0H                                                               
*                             SET PRD AND EST Q'S                               
CLXF4    DS    0H                                                               
         MVI   ESTQ,C'S'           SERIES                                       
         CLI   QESTEND,C' '                                                     
         BH    CLXF6                                                            
         MVI   ESTQ,C'A'           ALL                                          
         CLC   =C'ALL',QEST                                                     
         BE    CLXF6                                                            
         MVI   ESTQ,C'1'           ONE EST                                      
*                                                                               
CLXF6    DS    0H                                                               
         MVI   PRDQ,C'A'           ALL                                          
         CLC   QPRODUCT,=C'ALL'                                                 
         BE    CLXF7                                                            
         CLC   QPRODUCT,=C'ZZZ'                                                 
         BE    CLXF7                                                            
         MVI   PRDQ,C'1'           ONE PRD                                      
*                                                                               
CLXF7    DS    0H                                                               
         MVI   PGRQ,C'N'           NO PGRS                                      
         CLI   QDIV,C' '                                                        
         BE    CLXF8                                                            
         MVI   PGRQ,C'A'           MORE THAN 1 PGR                              
         CLC   QDIV,=C'ALL'                                                     
         BE    CLXF8                                                            
         MVI   PGRQ,C'1'           1 PGR                                        
*                                                                               
CLXF8    DS    0H                                                               
         MVI   MGRQ,C'N'           NO MGRS                                      
         CLC   QREGION(6),SPACES                                                
         BE    CLXF9                                                            
         MVI   MGRQ,C'A'           MORE THAN 1 MGR                              
         CLC   =C'ALL',QREGION                                                  
         BE    CLXF9                                                            
         CLC   =C'ALL',QDIST                                                    
         BE    CLXF9                                                            
         MVI   MGRQ,C'1'           1 MGR                                        
*                                                                               
CLXF9    DS    0H                                                               
         MVI   MKTQ,C'A'           ALL MKTS                                     
         MVI   JOBQ,C'A'                                                        
         CLI   QPUB+1,C'J'         SEE IF REQ FOR ONE JOB                       
         BNE   *+8                                                              
         MVI   JOBQ,C'1'                                                        
*                                                                               
CLXF10   DS    0H                                                               
         OC   MANGRS(12),MANGRS                                                 
         BZ    CLXF12                                                           
         CLI   PRDQ,C'1'                                                        
         BNE   CLTF39                                                           
         CLI   ESTQ,C'1'                                                        
         BNE   CLTF39                                                           
         CLI   MGRQ,C'N'           NO REG/DST FOR MANUAL BILLS                  
         BNE   CLTF39                                                           
         CLI   PGRQ,C'N'           NO DIV FOR MANUAL BILLS                      
         BNE   CLTF39                                                           
CLXF12   DS    0H                                                               
         CLI   RCMULTIQ,C'Y'       SEE IF PART OF MULTI-MEDIA REQ               
         BNE   CLXF12C                                                          
         CLI   BTABSW,C'Y'         ONLY GO TO BLDTAB ONCE                       
         BE    CLXF13              FOR FIRST ACTIVE MEDIA                       
*                                                                               
CLXF12C  GOTO1 ABLDTAB             BUILD KEY TAB                                
         CLI   CLTSW,C'N'          MEANS SKIP THIS CLIENT                       
         BE    CLXFX                                                            
         MVI   BTABSW,C'Y'                                                      
CLXF13   DS    0H                                                               
CLXFX    DS    0H                                                               
         L     RF,ADCLT       SAVE OFFICE AND AMGOCTL                           
         MVC   SVOFF,PCLTOFF-PCLTREC(RF)                                        
         MVC   SVAGMOCT,AGMOCTL                                                 
         XIT1                                                                   
         SPACE 2                                                                
CNEXTEL  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    CNEXTEL2                                                         
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     CNEXTEL                                                          
CNEXTEL2 DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
SVAADDRS DS    CL(ADDRLEN)                                                      
         TITLE 'BLDTAB - BUILD SORT/BREAK CONTROL TABLE'                        
BLDTAB   CSECT                                                                  
         NMOD1 0,BLDTAB                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                  READ B5 PROFILE                              
*                                       MOVE PROFILE INTO BRKEQV                
BT1      DS    0H                                                               
         MVI   NOINSSW,0                                                        
         XC    SPTSEQ,SPTSEQ                                                    
         XC    X,X                                                              
         MVC   X(7),PROGPRO2      HOLD PROF IN X                                
*                                                                               
         MVC   X+10(7),PROGPRO2   SAVE ORIG VALUES                              
*                                                                               
         CLI   RCMULTIQ,C'Y'      MULTIMEDIA REQ                                
         BE    BT01A              YES - CAN'T ALTER BLDTAB                      
         CLI   QMEDIA,C'M'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR MAGS                          
         CLI   QMEDIA,C'T'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR TRADE MAGS                    
         CLI   QMEDIA,C'S'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR SUPPLEMENTS                   
*                                                                               
BT01A    MVI   PRDMKT,C'P'         PRD HIGHER THAN MKT                          
         CLI   X+4,C'R'            UNLESS MKT OPT = R                           
         BNE   BT01C                                                            
         MVI   X+4,C'T'            THEN RESET TO T                              
         CLI   X+1,C'T'            PRD MUST ALSO BE T                           
         BNE   BT01C                                                            
         MVI   PRDMKT,C'M'         AND SET MKT HIGHER THAN PRD                  
BT01C    DS    0H                                                               
*                                                                               
*              IF REQ FOR SINGLE SET PROF TO SEPARATE                           
         CLI   PGRQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+0,C'S'                                                         
         CLI   PRDQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+1,C'S'                                                         
         CLI   ESTQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+2,C'S'                                                         
         CLI   MGRQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+3,C'S'                                                         
         CLI   MKTQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+4,C'S'                                                         
         CLI   JOBQ,C'1'         REQ FOR ONE JOB  - SET TO SEPERATE             
         BNE   *+8                                                              
         MVI   X+5,C'S'                                                         
*                                                                               
         CLI   X+6,C'I'            MEANS PUBS TOGEHTER WITH NO                  
         BNE   BT01C5                                                           
         MVI   X+6,C'T'                                                         
         MVI   NOINSSW,C'Y'                                                     
BT01C5   MVI   X+7,C'T'            DESC                                         
         MVI   SPOTSW,C'N'         REALLY INSERTION DETAILS                     
         OC   MANGRS(12),MANGRS                                                 
         BNZ   *+8                                                              
         MVI   SPOTSW,C'Y'                                                      
         MVI   BRKPUB+2,1             SET PUB REQ                               
         MVI   BRKDESC+2,0            SET DESC NOT REQ                          
         OC   MANGRS(12),MANGRS    IF MANUAL                                    
         BZ    BT01D                                                            
         XC    MGR1BK,MGR1BK     CLEAR MGROUP NAMES                             
         XC    MGR2BK,MGR2BK                                                    
         MVC   X+3(6),=6C'N'       SUPPRESS MGR,MKT,JOB,PUB                     
         MVI   BRKPUB+2,0             SET PUB NOT REQ                           
         MVI   BRKDESC+2,1            SET DESC REQ                              
*                                                                               
BT01D    DS    0H                                                               
*                                                                               
*                                                                               
         CLI   AGMFORMS,C'L'    CHK FOR LONG LOGO                               
         BE    BT01D2                                                           
         CLI   AGMFORMS,C'B'    CHK FOR LONG LOGO                               
         BE    BT01D2                                                           
         B     BT01D8                                                           
*                                                                               
*                                                                               
*        TRY AND CATCH PROBLEMS WITH HEADLINES IF USING LONG LOGO               
*                                                                               
BT01D2   CLC   X(4),=C'SSSS'    SEE IF DIV/PRD/EST/(REG/DST)                    
         BNE   BT01D8           ARE ALL SEPERATE                                
         CLI   QDIST,C' '       SEE IF DISTRICT REQUESTED                       
         BE    BT01D8           NO - THEN I SHOULD HAVE ROOM IN THE             
*                               HEADLINES                                       
         CLI   X+13,C'T'        CHK ORIG REG/DST VALUE                          
         BNE   BT01D3                                                           
         MVI   X+3,C'T'         RESET REG/DST TO TOGETHER                       
         B     BT01D8                                                           
*                                                                               
BT01D3   CLI   X+12,C'T'        CHK ORIG EST VALUE OF TOGETHER                  
         BNE   BT01D8                                                           
         MVI   X+2,C'T'        SET EST TO TOGETHER                              
*                                                                               
BT01D8   XC    WORK,WORK                                                        
         MVC   WORK(BRKEQVL),BRKEQV                                             
         LA    R2,WORK                                                          
         MVC   03(1,R2),X+0     PGR1                                            
         MVC   06(1,R2),X+0     PGR2                                            
         MVC   09(1,R2),X+0     PGR3                                            
         MVC   12(1,R2),X+1     PRD                                             
         MVC   15(1,R2),X+2     EST                                             
         MVC   18(1,R2),X+3     MGR1                                            
         MVC   21(1,R2),X+3     MGR2                                            
         MVC   24(1,R2),X+3     MGR3                                            
         MVC   27(1,R2),X+4     MKT                                             
         MVC   30(1,R2),X+5     JOB                                             
         MVC   33(1,R2),X+6     PUB                                             
         MVC   36(1,R2),X+7     DESC                                            
*                                                                               
         CLI   QDIV,C' '                                                        
         BNE   BT01F                                                            
         MVI   3(R2),C'N'          SET ALL  PGROUPS TO N                        
         MVI   6(R2),C'N'                                                       
         MVI   9(R2),C'N'                                                       
*                                                                               
BT01F    CLI   QREGION,C' '                                                     
         BNE   BT01H                                                            
         MVI   18(R2),C'N'         NO REGIONS                                   
*                                                                               
BT01H    CLI   QDIST,C' '                                                       
         BNE   BT01J                                                            
         MVI   21(R2),C'N'         NO DISTRICTS                                 
         MVI   24(R2),C'N'                                                      
*                                                                               
BT01J    DS    0H                                                               
         CLI   QPUB,C' '           SEE IF DOING ONE PUB                         
         BE    BT01J5              NO                                           
         CLC   QPUB+8(3),=C'ZZZ'   SEE IF DOING ONE PUB/ALL EDITIONS            
         BE    BT01J5              YES - LEAVE PUB CONTROL ALONE                
         MVI   33(R2),C'S'         SET PUB TO SEPERATE                          
*                                                                               
BT01J5   MVI   39(R2),C'S'         RPIOR SEPARATE                               
         CLI   PRIOR,C'1'          IF 1 - 3                                     
         BNL   BT1A                                                             
         MVI   39(R2),C'T'         PRIOR TOGETHER                               
         CLI   PRIOR,C'C'          IF A - C                                     
         BNH   BT1A                                                             
*                                                                               
         MVC   39(1,R2),PRIOR           PERIOD                                  
*                                                                               
BT1A     DS    0H                                                               
         CLI   PRIOR,C'N'          IF NO PRIOR                                  
         BNE   *+8                                                              
         MVI   39(R2),C'S'         TREAT AS SEPARATE                            
         MVI   42(R2),C'N'         NO PERIOD GROUP                              
         CLI   PRIOR,C'M'          UNLESS DOING CUR MO SEPARATE                 
         BNE   *+12                                                             
         MVI   39(R2),C'T'                                                      
         MVI   42(R2),C'S'                                                      
         CLI   SUMOPT,C'Y'         IF DOING RETAIL SUMMARY                      
         BNE   *+8                                                              
         MVI   42(R2),C'R'         USE PER GRP AS DUMMY 'SEPARATE'              
*                                  (USE 'R' TO CAUSE TO SORT FIRST)             
*                                                                               
*                                  IF NO 'SEPARATE' SET PERIOD GROUP            
*                                  TO SEP AND USE AS DUMMY INV BRK              
         LR    RF,R2                                                            
         LA    R0,14                                                            
BT1B     DS    0H                                                               
         CLI   0(RF),C'S'                                                       
         BE    BT1D                                                             
         LA    RF,3(RF)                                                         
         BCT   R0,BT1B                                                          
         MVI   42(R2),C'S'         PERIOD GROUP TO S                            
BT1D     DS    0H                                                               
         MVI   0(R2),C'N'         SET MEDIA BRK TO NO                           
         CLI   RCMULTIQ,C'Y'       UNLESS DOING A MULTI-MEDIA REQ               
         BNE   BT1G                                                             
         MVI   0(R2),C'T'         SET MEDIAS TOGETHER                           
         CLI   33(R2),C'S'        SEE IF PUB SEPERATE                           
         BNE   BT1G                                                             
         B     BPRFERR            SEND INVALID BILLING PROFILE                  
*                                                                               
BT1G     MVI   45(R2),C'N'         SET CRBD BREAK TO NO                         
         CLI   PROGPRO2+13,C'Y'                                                 
         BNE   *+8                                                              
         MVI   45(R2),C'S'                                                      
*                                                                               
BT2      DS    0H                                                               
**NEW 4/25/90                                                                   
         CLI   PAYOPT,C'E'         SEE IF BILLING CLEARED ESTS ONLY             
         BE    BT2A                                                             
         CLI   PAYOPT,C'G'         SEE IF BILLING CLEAEDS EST ONLY              
         BNE   BT2AK                                                            
*                                  IF BILLING CLEARED ESTS ONLY                 
*                                  REG/DST, MKT, JOB, PUB                       
*                                  CAN'T BE ON SEPERATE INVOICES                
*                              **  OPTION WILL NOT WORK **                      
BT2A     CLI   18(R2),C'S'         REGIONS                                      
         BE    BPRFERR5                                                         
         CLI   21(R2),C'S'         DISTRICTS                                    
         BE    BPRFERR5                                                         
         CLI   24(R2),C'S'                                                      
         BE    BPRFERR5                                                         
         CLI   27(R2),C'S'         MARKETS                                      
         BE    BPRFERR5                                                         
         CLI   30(R2),C'S'         JOBS                                         
         BE    BPRFERR5                                                         
         CLI   33(R2),C'S'         PUBS                                         
         BE    BPRFERR5                                                         
         CLI   QPUB,C' '                                                        
         BE    BT2AK                                                            
         CLC   QPUB+8(3),=C'ZZZ'   OR ALL ZONES/EDITIONS                        
         BE    BPRFERR5                                                         
         B     BT2AK                                                            
*                                  SET PAGE BREAK                               
BPRFERR5 MVI   ERR,PROFERR5        INVALID BILLING PROFILE                      
         GOTO1 AERRPROC                                                         
         B     BLDTABX                                                          
*                                                                               
BT2AK    DS    0H                                                               
         ZIC   RF,PROGPRO2+8                                                    
         LTR   RF,RF                                                            
         BZ    BT3                                                              
         LA    RF,1(RF)            ADJUST FOR MEDIA                             
***                                                                             
         LA    RF,2(RF)            ADJUST FOR PGR AND MGR LUMPING               
         CLI   PROGPRO2+8,4                                                     
         BL    *+8                                                              
         LA    RF,2(RF)                                                         
         MH    RF,=H'3'                                                         
         LA    RF,WORK-3(RF)                                                    
         LA    RE,WORK                                                          
BT2B     DS    0H                                                               
         CLI   0(RE),C'T'                                                       
         BNE   *+8                                                              
         OI    2(RE),X'80'         PAGE BREAK                                   
         LA    RE,3(RE)                                                         
         CR    RE,RF                                                            
         BNH   BT2B                                                             
*                                                                               
BT3      DS    0H                                                               
*                                  SET RECAP LEVEL                              
         ZIC   RF,PROGPRO2+7                                                    
         LTR   RF,RF                                                            
         BZ    BT3B                                                             
         LA    RF,1(RF)            ADJUST FOR MEDIA                             
         LA    RF,2(RF)            ADJUST FOR PGR AND MGR LUMPING               
         CLI   PROGPRO2+7,5        SO 4 WILL LOOK AT REGION                     
         BL    *+8                                                              
         LA    RF,2(RF)                                                         
         MH    RF,=H'3'                                                         
         LA    RF,WORK-3(RF)                                                    
*                                                                               
         CLI   0(RF),C'N'          RECAP LEVEL CAN'T BE NOT DISPLAYED           
         BE    BPRFERR             IF IT'S NOT MAIN BILL LOOKS FUNNY            
*                                                                               
         LA    RE,WORK                                                          
BT3A     DS    0H                                                               
         OI    2(RE),X'40'         RECAP LEVEL                                  
         LA    RE,3(RE)                                                         
         CR    RE,RF                                                            
         BNH   BT3A                                                             
BT3B     DS    0H                                                               
         MVC   BFORMAT(5),PROGPRO3        BILL $ CATAGORIES                     
         MVC   BFORMAT+5(1),PROGPRO3+9    AGY COM                               
         CLI   BFORMAT+5,0                                                      
         BNE   *+8                                                              
         MVI   BFORMAT+5,C'N'   OLD PROFLIES WILL HAVE X'00'                    
         MVC   BSTRIP,PROGPRO3+5                                                
         MVC   BORDSW,PROGPRO3+6                                                
         MVC   BPBILSW,PROGPRO3+7                                               
         MVC   BBILLSW,PROGPRO3+8                                               
*                                                                               
         MVC   PCTCTL,PROGPRO3+10         PCT BILLING CONTROL                   
         CLI   PCTCTL,C' '                                                      
         BH    *+8                                                              
         MVI   PCTCTL,C'P'                SET DEFAULT                           
*                                                                               
         MVC   DFORMAT(5),PROGPRO4        BILL $ CATAGORIES                     
         MVC   DFORMAT+5(1),PROGPRO4+9    AGY COM                               
         CLI   DFORMAT+5,0                                                      
         BNE   *+8                                                              
         MVI   DFORMAT+5,C'N'    FOR OLD PROFLIES WHICH MAY HAVE X'00'          
*                                  FOR DETAIL BACK-UP                           
         MVC   DSTRIP,PROGPRO4+5                                                
         MVC   DORDSW,PROGPRO4+6                                                
         MVC   DPBILSW,PROGPRO4+7                                               
         MVC   DBILLSW,PROGPRO4+8                                               
         CLI   QMANUAL,C'G'                                                     
         BE    BT3B2                                                            
         CLI   QMANUAL,C'F'        FEE                                          
         BNE   BT3B4                                                            
BT3B2    MVC   BORDSW(3),=C'NNY'   FOR MANUALS SET TO BILLABLE ONLY             
         B     BT3B4X                                                           
BT3B4    CLC   =C'NO PREV',QMANUAL                                              
         BNE   BT3B4C                                                           
         MVI   BPBILSW,C'N'        SET FOR NO PREV                              
         B     BT3B4X                                                           
*                                                                               
BT3B4C   CLC   =C'ONLY PREV',QMANUAL                                            
         BNE   BT3B4E                                                           
         MVC   BORDSW(3),=C'NYN'   SET FOR ONLY PREVIOUS                        
         B     BT3B4X                                                           
*                                                                               
BT3B4E   CLC   =C'PREV',QMANUAL                                                 
         BNE   BT3B4X                                                           
         MVI   BPBILSW,C'Y'        SET ON PREV BILLING                          
BT3B4X   LA    RF,BFORMAT          EDIT BILLING PROFILE                         
         LA    RE,6                                                             
         SR    R1,R1               USED TO COUNT $ CATS                         
BT3B5    CLI   0(RF),C'Y'                                                       
         BNE   *+8                                                              
         LA    R1,1(R1)                                                         
         LA    RF,1(RF)                                                         
         BCT   RE,BT3B5                                                         
         LTR   R1,R1                                                            
         BNZ   BT3B10                                                           
BPRFERR  MVI   ERR,PROFERR         INVALID BILLING PROFILE                      
         GOTO1 AERRPROC                                                         
         B     BLDTABX                                                          
BT3B10   STC   R1,BDOLNUM                                                       
         LA    RF,BORDSW           EDIT BILLING PROFILE                         
         LA    RE,3                                                             
         SR    R1,R1               USED TO COUNT $ TYPES                        
         MVI   BTYPNUM,0                                                        
BT3B15   CLI   0(RF),C'N'                                                       
         BE    BT3B18                                                           
         LA    R1,1(R1)            COUNT 'Y'S AND 'D'S                          
         CLI   0(RF),C'Y'                                                       
         BNE   *+8                                                              
         OI    BTYPNUM,X'01'       SET 'Y' FOUND                                
         CLI   0(RF),C'D'                                                       
         BNE   *+8                                                              
         OI    BTYPNUM,X'80'                                                    
BT3B18   LA    RF,1(RF)                                                         
         BCT   RE,BT3B15                                                        
         LTR   R1,R1                                                            
         BZ    BPRFERR                                                          
         TM    BTYPNUM,X'01'                                                    
         BNO   BPRFERR              MUST HAVE AT LEAST ONE NOT D OR N           
         TM    BTYPNUM,X'80'        SEE IF A 'D' ENTERED                        
         BZ    BT3B20                                                           
         CLI   PROGPRO2+7,0         THEN CAN'T HAVE DETAIL BACK-UP              
         BNE   BPRFERR                                                          
BT3B20   STC   R1,BTYPNUM                                                       
*                                                                               
*        EDIT DETAIL BACKUP BILLING PROFILE                                     
BT3B25   LA    RF,DFORMAT                                                       
         LA    RE,6                                                             
         SR    R1,R1               USED TO COUNT $ CATS                         
BT3B27   CLI   0(RF),C'Y'                                                       
         BNE   *+8                                                              
         LA    R1,1(R1)                                                         
         LA    RF,1(RF)                                                         
         BCT   RE,BT3B27                                                        
         LTR   R1,R1                                                            
         BNZ   BT3B30                                                           
DPRFERR  MVI   ERR,PROFERR         INVALID BILLING PROFILE                      
         GOTO1 AERRPROC                                                         
         B     BLDTABX                                                          
*                                                                               
BT3B30   STC   R1,DDOLNUM                                                       
         LA    RF,DORDSW           EDIT BILLING PROFILE                         
         LA    RE,3                                                             
         SR    R1,R1               USED TO COUNT $ TYPES                        
         MVI   DTYPNUM,0                                                        
BT3B35   CLI   0(RF),C'N'                                                       
         BE    BT3B38                                                           
         LA    R1,1(R1)                                                         
         CLI   0(RF),C'Y'          MUST FIND AT LEAST ONE 'Y'                   
         BNE   BT3B38                                                           
         OI    DTYPNUM,X'01'                                                    
BT3B38   LA    RF,1(RF)                                                         
         BCT   RE,BT3B35                                                        
         LTR   R1,R1                                                            
         BZ    DPRFERR                                                          
         CLI   DTYPNUM,X'01'       MUST FIND AT LEAST ONE 'Y'                   
         BNE   DPRFERR             CAN'T BE ALL 'D' AND 'N' S                   
         STC   R1,DTYPNUM                                                       
*                                                                               
         MVC   LSTOPT,PROGPRO2+11                                               
***           CHECK USED TO BE FOR PROGPRO2+6,C'S'  - BNE                       
***           CHANGED TO SUPPRESS PREVIOUS INV LIST FOR REQ FOR                 
***           ONE PUBLICATION  OCT27/87                                         
         CLI   QPUB,C'0'           IF ONE PUB                                   
         BL    BT3I              ONLY SHOW PREV INV AT DETAIL LEVEL             
*                                NO LIST OF PREV INV AT END                     
         CLI   LSTOPT,C'D'        LEAVE 'D' ALONE                               
         BE    BT3I                                                             
         IF    LSTOPT,EQ,C'I',OR,LSTOPT,EQ,C'B',BT3E                            
*                                  CHANGE OTHERS TO 'N'                         
         MVI   LSTOPT,C'N'         NO PREVIOUS INV LIST                         
         B     BT3I                                                             
*                                                                               
BT3E     MVI   LSTOPT,C'D'         CHANGE 'I' OR 'B' TO 'D'                     
*                                                                               
BT3I     CLI   PRDMKT,C'M'         TEST MKT TO BE HIGHER THAN PRD               
         BNE   BT3J                                                             
*                                  SWAP MKT AND PRD CLTS                        
         MVC   X(15),WORK+00                                                    
         MVC   WORK+00(12),WORK+15                                              
         MVC   WORK+12(15),X                                                    
*                                                                               
BT3J     DS    0H                                                               
*                                  S=SEPARATE                                   
*                                  T=TOGETHER                                   
*                                  N=NO                                         
         LA    R0,BRKEQVL/3                                                     
BT4      DS    0H                                                               
         CLI   0(R2),C'N'                                                       
         BNE   *+8                                                              
         MVI   0(R2),X'FF'         SET N'S LAST                                 
         LA    R2,3(R2)                                                         
         BCT   R0,BT4                                                           
*                                  SORT ON PROFILE BYTE (POSITION)              
         LA    R0,BRKEQVL/3                                                     
         GOTO1 XSORT,DMCB,WORK,(R0),3,1,0                                       
*                                  BUILD BRKTAB                                 
         LA    R2,WORK                                                          
         LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
         XC    BRKTAB,BRKTAB                                                    
         SR    R7,R7                                                            
         XC    ABRKS(ABRKSL),ABRKS CLEAR CONTROL ADDRESSES                      
         XC    ATOTS,ATOTS                                                      
         XC    ATOTSV,ATOTSV                                                    
         XC    ALEVS,ALEVS                                                      
         XC    LEVCTLS,LEVCTLS                                                  
BT6      DS    0H                                                               
         ZIC   RF,1(R2)            CODE                                         
         LTR   RF,RF                                                            
         BZ    BT8                                                              
         BAS   RE,BTTAB-4(RF)                                                   
         LA    R2,3(R2)                                                         
         B     BT6                                                              
BT8      DS    0H                                                               
*                                                                               
         L     R6,ABUFFC                                                        
         USING BUFFALOD,R6                                                      
*                                                                               
         ST    R7,SORTKLEN         ACCUMED KEY LEN                              
         A     R7,BUFFLCOM                                                      
         A     R7,BUFFLDTA                                                      
         ST    R7,SORTRLEN                                                      
         LA    R7,SORTREC                                                       
         A     R7,SORTKLEN                                                      
         ST    R7,ASORTCOM                                                      
         A     R7,BUFFLCOM                                                      
         ST    R7,ASORTDTA                                                      
*                                                                               
*                                  RECALCULATE MAX LINES                        
         L     RF,BUFFCRMX                                                      
         M     RE,BUFFLALL                                                      
         D     RE,SORTRLEN                                                      
         ST    RF,BUFFCRMX                                                      
*                                                                               
         MVC   BUFFLIST(1),SORTKLEN+3     SET LENGTH OF KEY                     
         MVC   BUFFLKEY,SORTKLEN                                                
         MVC   BUFFLALL,SORTRLEN        SET LENGTH OF REC                       
         MVI   BUFFDOPT,C'Y'                                                    
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'SET',ABUFFC                                      
*                                                                               
         DROP  R6                                                               
*                                                                               
*                                  SET A(TOTALS)                                
         L     R3,ALOWBRK          START AT END OF BRKTAB AND BACK UP           
         LA    R0,BRKTAB                                                        
         L     R4,ALEVTOTS                                                      
         L     R5,=V(VBTAB)                                                     
BT10     DS    0H                                                               
         L     RF,BRKCODE                                                       
         LA    RF,ATOTS(RF)                                                     
         ST    R4,0(RF)                                                         
         L     RF,BRKCODE                                                       
         LA    RF,ATOTSV(RF)                                                    
         ST    R5,0(RF)                                                         
         AH    R4,TOTSIZH                                                       
         AH    R5,=Y(VTOTSIZE)                                                  
         SH    R3,=Y(BRKL)                                                      
         CR    R3,R0                                                            
         BNL   BT10                                                             
*                                                                               
         CLC   AINVBRK,APMSELO                                                  
         BNH   *+10                                                             
         MVC   APMSELO,AINVBRK                                                  
         OC    MANGRS(12),MANGRS    IF MANUAL                                   
         BZ    *+10                                                             
         XC    ARECAP,ARECAP       TEN NO RECAPS                                
         CLC   APAGBRK,AINVBRK                                                  
         BNL   *+10                                                             
         MVC   APAGBRK,AINVBRK                                                  
         OC    ARECAP,ARECAP                                                    
         BZ    BT10B                                                            
         CLC   ARECAP,AINVBRK      IF RECAP OPT IS NOT LOGICAL                  
         BNL   *+10                                                             
         MVC   ARECAP,AINVBRK      SET TO INVOICE BRK                           
BT10B    DS    0H                                                               
         MVC   SVPAGBRK,APAGBRK    SAVE PAGE LEVEL                              
         MVC   SVLOWTOG,ALOWTOG    AND LOWEST TOGETHER                          
*                                  CHANGE CTL FROM T TO P                       
*                                  FOR TOGETHERS ON SEP PAGE                    
         LA    R3,BRKTAB                                                        
         XC    AHITOG,AHITOG                                                    
BT11     DS    0H                                                               
         OC    BRKCODE,BRKCODE                                                  
         BZ    BT11D                                                            
         CLI   BRKCTL1,C'T'                                                     
         BNE   BT11B                                                            
         C     R3,APAGBRK                                                       
         BH    BT11A                                                            
         MVI   BRKCTL1,C'P'                                                     
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         MVI   0(RF),C'P'                                                       
         B     BT11B                                                            
*                                                                               
BT11A    DS    0H                                                               
         OC    AHITOG,AHITOG       SAVE HIGHEST TOGETHER BRK                    
         BNZ   *+8                                                              
         ST    R3,AHITOG                                                        
*                                                                               
*                                                                               
BT11B    DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         B     BT11                                                             
BT11D    DS    0H                                                               
         CLI   AORSW,C'Y'          SEE IF DOING AOR                             
         BNE   BT11F                                                            
         CLI   RCMULTIQ,C'Y'       NO MULTI-MEDIA REQ FOR AOR                   
         BE    BT11E                                                            
         CLI   AORLOPT,C'Y'     SEE IF LISTING PRD/EST ON AOR                   
         BE    BT11F            YES - ALLOW PRDS TOGETHER                       
         CLI   AORLOPT,C'C'     SEE IF LISTING PRD/EST ON AOR AT END            
         BE    BT11F            YES - ALLOW PRDS TOGETHER                       
         CLI   PRDCTL,C'S'         NO - THEN PRODUCT MUST BE SEPERATE           
         BE    BT11F                                                            
BT11E    MVI   ERR,AORERR                                                       
         GOTO1 AERRPROC                                                         
         B     BLDTABX                                                          
*                                                                               
BT11F    DS    0H                                                               
*                                                                               
*                                                                               
BLDTABX  DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
BTTAB    DS    0F                                                               
         B     BTMED                                                            
         B     BTPGR1                                                           
         B     BTPGR2                                                           
         B     BTPGR3                                                           
         B     BTPRD                                                            
         B     BTEST                                                            
         B     BTMGR1                                                           
         B     BTMGR2                                                           
         B     BTMGR3                                                           
         B     BTMKT                                                            
         B     BTJOB                                                            
         B     BTPUB                                                            
         B     BTDESC                                                           
         B     BTPER                                                            
         B     BTPERG                                                           
         B     BTCRDB                                                           
*                                                                               
         SPACE 2                                                                
BTPGR1   DS    0H                                                               
         ZIC   R4,PGR1LEN          DIVISIONS                                    
         B     BTALL                                                            
         SPACE 2                                                                
BTPGR2   DS    0H                  FUTURE USE                                   
         ZIC   R4,PGR2LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTPGR3   DS    0H                  FUTURE USE                                   
         ZIC   R4,PGR3LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTPRD    DS    0H                                                               
         LA    R4,3                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR1   DS    0H                  REGIONS                                      
         ZIC   R4,MGR1LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR2   DS    0H                  DISTRICTS                                    
         ZIC   R4,MGR2LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR3   DS    0H                  FUTURE USE                                   
         ZIC   R4,MGR3LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTMKT    DS    0H                                                               
         LA    R4,20                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTEST    DS    0H                                                               
         LA    R4,2                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTJOB    DS    0H                                                               
         LA    R4,9                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTDESC   DS    0H                                                               
         LA    R4,6                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTPER    DS    0H                                                               
         LA    R4,1                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTPERG   DS    0H                                                               
         LA    R4,1                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTMED    DS    0H                                                               
         LA    R4,2                MEDIA AND FINANSW                            
         B     BTALL                                                            
         SPACE 2                                                                
BTCRDB   DS    0H                                                               
         LA    R4,1                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTPUB    DS    0H                                                               
         LA    R4,6                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTALL    DS    0H                                                               
         LTR   R4,R4               BYPASS = LEN = 0                             
         BNE   BTALL1                                                           
         MVI   0(R2),C'N'                                                       
         BR    RE                                                               
BTALL1   DS    0H                                                               
         CLI   0(R2),X'FF'         TEST BYPASSED                                
         BNE   BTALL2                                                           
         MVI   0(R2),C'N'          RESET FF TO N                                
         TM    2(R2),X'0F'         TEST OK TO BYPASS                            
         BZR   RE                  YES                                          
BTALL2   DS    0H                                                               
         CLI   0(R2),C'R'          CHAGE R TO S                                 
         BNE   *+8                 (PER GRP FOR RETAIL SUMMARY)                 
         MVI   0(R2),C'S'                                                       
         TM    2(R2),X'01'                                                      
         BZ    BTALL4                                                           
         ST    R3,APMSELO         SAVE 'LOWEST' (HIGH IN CORE)                  
*                                  OF PRD,MKT,STA,EST                           
BTALL4   DS    0H                                                               
         TM    2(R2),X'02'                                                      
         BZ    BTALL6                                                           
         ST    R3,APEPLO           SAVE 'LOWEST' OF PRD-EST-PER                 
         OC    APEPHI,APEPHI                                                    
         BNZ   *+8                                                              
         ST    R3,APEPHI           SAVE 'HIGHEST'                               
BTALL6   DS    0H                                                               
         ZIC   RF,1(R2)                                                         
         ST    RF,BRKCODE          CODE                                         
         ST    R7,BRKDISP          DISP = CUMED LENGTH                          
         AR    R7,R4                                                            
         BCTR  R4,R0                                                            
         ST    R4,BRKLENM1         LENGTH OF FIELD - 1                          
*                                                                               
         MVC   BRKCTL1,0(R2)       CONTROL BYTE                                 
*                                                                               
         ST    R3,ALOWBRK          SAVE ADDR OF LOWEST BRK                      
         LA    RF,ABRKS-4                                                       
         A     RF,BRKCODE                                                       
         ST    R3,0(RF)            SET ADDR OF THIS LEV BRK                     
*                                                                               
         CLI   BRKCTL1,C'T'                                                     
         BNE   BTALL7                                                           
         C     R3,APERBRK                                                       
         BE    BTALL7                                                           
         ST    R3,ALOWTOG     LOWEST 'TOGETHER' (EXC PER )                      
BTALL7   DS    0H                                                               
         LA    RF,ALEVS                                                         
         A     RF,BRKCODE                                                       
         LA    R0,SORTREC                                                       
         A     R0,BRKDISP                                                       
         ST    R0,0(RF)            SET ADDR OF FIELD                            
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         MVC   0(4,RF),BRKCTL1                                                  
         CLI   0(R2),C'S'                                                       
         BNE   *+8                                                              
         ST    R3,AINVBRK          A(LEVEL FOR NEW INVOICE)                     
         CLI   0(R2),C'N'                                                       
         BE    BTALL8                                                           
         TM    2(R2),X'80'                                                      
         BZ    *+8                                                              
         ST    R3,APAGBRK          A(PAGE BREAK LEVEL)                          
         TM    2(R2),X'40'                                                      
         BZ    *+8                                                              
         ST    R3,ARECAP           A(RECAP LEVEL)                               
BTALL8   DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         BR    RE                                                               
         SPACE 3                                                                
*                                  TABLE OF BRK CODES AND LENGTHS               
*                                  BYTE 1 - TO BE FILLED IN FROM PROF           
*                                  BYTE 2 - CODE                                
*                                  BYTE 3 - CONTROL GROUP                       
*                                  X'01' = PRD,EST,MKT,STA                      
*                                  X'02' = PRD,EST,PER                          
*                                  X'04' = NECESSARY FOR OTHER REASON           
*                                         (COST TYPE FOR NETWORK)               
BRKEQV   DS    0C                                                               
         DC    X'000400'           MEDIA                                        
         DC    X'000800'           PGR1                                         
         DC    X'000C00'           PGR2                                         
         DC    X'001000'           PGR3                                         
         DC    X'001403'           PRD                                          
         DC    X'001803'           EST                                          
         DC    X'001C00'           MGR1                                         
         DC    X'002000'           MGR2                                         
         DC    X'002400'           MGR3                                         
         DC    X'002800'           MKT                                          
BRKJOB   DC    X'002C00'           JOB                                          
BRKPUB   DC    X'003001'           PUB                                          
BRKDESC  DC    X'003400'           DESC                                         
         DC    X'003802'           PERIOD                                       
         DC    X'003C00'           PERIOD GROUP                                 
         DC    X'004000'           CREDIT/DEBIT BREAK                           
BRKEQVL  EQU   *-BRKEQV                                                         
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'GETNUM - GET AND FORMAT INVOICE NUMBER'                         
GETNUM   CSECT                                                                  
         NMOD1 0,GETNUM                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVI   RCTRACE,C'N'        SUPPRESS TRACE                               
         MVI   FCRDCLOS,C'Y'        SO I WILL READ CLOSED-OUT BILLS             
*                              NEEDED SINCE UNBILLING NOW CLOSES-OUT            
*                              BILLS INSTEAD OF DELETING THEM                   
*                                                                               
         ST    R1,SAVR1                                                         
         LM    R2,R3,0(R1)                                                      
         CLI   0(R1),0                                                          
         BNE   GN31                                                             
         MVC   W(2),TODAYB         YM                                           
         OC    0(2,R2),0(R2)                                                    
         BNZ   GN22                DONT SEARCH FILE                             
         XC    HALF,HALF                                                        
**NEW 2/23/90                                                                   
         CLC   QPROG,=C'D1'        SEE IF DRAFT BILLING                         
         BE    GN20                DON'T SEARCH JUST START WITH 1               
         CLC   QPROG,=C'RD'        SEE IF DRAFT BILLING (REBATE)                
         BE    GN20                DON'T SEARCH JUST START WITH 1               
*                                                                               
         BAS   RE,GNOFFSET         BUILD TABLE FOR OFFICE CHECKING              
*                                                                               
**NEW 2/23/90                                                                   
         MVC   KEY1,KEY            PRESERVE KEY                                 
         XC    KEY,KEY                                                          
         MVC   KEY(3),QAGENCY                                                   
         CLI   AGMSEQ,C'A'         BY AGY                                       
         BE    GN2                                                              
         CLI   AGMSEQ,C'D'         BY CLT ACROSS MEDIA                          
         BNE   GN2B                                                             
GN2      MVI   KEY+2,C'M'          LOWEST MEDIA                                 
GN2B     CLI   AGMSEQ,C'C'                                                      
         BE    GN2D                                                             
         CLI   AGMSEQ,C'D'         BY CLT ACROSS MEDIA                          
         BNE   *+10                                                             
GN2D     MVC   KEY+4(3),CLIENT                                                  
GN2E     DS    0H                                                               
         MVI   KEY+3,X'08'                                                      
GN3      GOTO1 HIGH                                                             
         B     GN4B                                                             
GN4      DS    0H                                                               
         GOTO1 SEQ                                                              
GN4B     DS    0H                                                               
         CLC   KEY(3),KEYSAVE           AGENCY/MEDIA                            
         BNE   GN6                                                              
GN4C     CLI   KEY+3,X'08'         SEE IF BILLREC                               
         BE    GN4D                                                             
         BH    GN6                 YES GO SEE IF I HAVE TO                      
*                                  CHK NEXT MEDIA                               
         MVI   KEY+3,X'08'                                                      
         CLI   AGMSEQ,C'C'                                                      
         BE    GN4C5                                                            
         CLI   AGMSEQ,C'D'                                                      
         BNE   *+10                                                             
GN4C5    MVC   KEY+4(3),CLIENT                                                  
         B     GN3                                                              
*                                                                               
GN4D     CLI   AGMSEQ,C'C'                                                      
         BE    GN4E                                                             
         CLI   AGMSEQ,C'D'                                                      
         BNE   GN4F                                                             
GN4E     CLC   KEY+4(3),KEYSAVE+4       CLIENT                                  
         BNE   GN6D                                                             
GN4F     DS    0H                                                               
         CLI   AGMOCTL,0           DOING OFFICES?                               
         BE    GN4H                NO, OK                                       
*                                                                               
         MVC   MEDCLT(1),KEY+2      MEDIA                                       
         MVC   MEDCLT+1(3),KEY+4                                                
*                                                                               
         GOTO1 BINSRCH,CLTPARS,(0,MEDCLT)                                       
         CLI   0(R1),1             IF IN LIST, OK                               
         BNE   GN4H                                                             
         MVC   KEY+7(3),=X'FFFFFF' ELSE SKIP TO NEXT CLIENT                     
         B     GN2E                                                             
*                                                                               
GN4H     DS    0H                                                               
         CLC   KEY(2),=C'KN'       FOR K&N NO INV NUMBER RESEQ                  
         BE    GN5F                                                             
         OC    INRSQYM,INRSQYM                                                  
         BZ    GN5                                                              
         CLC   KEY+14(2),INRSQYM                                                
         BL    GN4                                                              
         BH    GN5F                                                             
         CLC   INRSQDA,=C'01'                                                   
         BE    GN5F                                                             
*                                      MUST READ BILL TO CHECK DAY              
         GOTO1 GETBILL                                                          
         L     RF,ADBILL                                                        
         CLC   PBILLDAT+4-PBILLREC(2,RF),INRSQDA                                
         BL    GN4                                                              
         B     GN5F                                                             
*                                                                               
GN5      DS    0H                                                               
         CLC   KEY+14(2),W              YM                                      
         BNE   GN4                                                              
         B     GN5F                                                             
*                                                                               
*                                                                               
GN5F     DS    0H                                                               
         CLC   HALF,KEY+16              INVOICE NO.                             
         BNL   GN4                                                              
         MVC   HALF,KEY+16                                                      
         B     GN4                                                              
*                                                                               
GN6      DS    0H                  END OF AGY/MEDIA                             
         CLI   AGMSEQ,C'A'                                                      
         BE    GN7                                                              
GN6D     CLI   AGMSEQ,C'D'         OR BY CLT ACROSS MEDIA                       
         BNE   GN20                                                             
*                                  IF BY AGY TRY NEXT MEDIA                     
GN7      CLC   KEY(2),KEYSAVE                                                   
         BH    GN20                END OF AGY                                   
         XC    KEY+4(21),KEY+4                                                  
         ZIC   R1,KEYSAVE+2                                                     
         LA    R1,1(R1)                                                         
         STC   R1,KEY+2            NEXT MEDIA                                   
         MVI   KEY+3,X'08'                                                      
         CLI   AGMSEQ,C'C'                                                      
         BE    GN8                                                              
         CLI   AGMSEQ,C'D'         OR BY CLT ACROSS MEDIA                       
         BNE   *+10                                                             
GN8      MVC   KEY+4(3),CLIENT                                                  
         GOTO1 HIGH                                                             
         CLC   KEY(2),KEYSAVE      CHK RIGHT AGY                                
         BH    GN20                                                             
         B     GN4C                                                             
*                                  HAVE HIGHEST NO.                             
GN20     DS    0H                                                               
         LH    RF,HALF                                                          
         LA    RF,1(RF)                                                         
         STH   RF,0(R2)                                                         
         CLC   0(2,R2),AGMSTANO                                                 
         BNL   *+10                                                             
         MVC   0(2,R2),AGMSTANO                                                 
         B     GN23                                                             
*                                  BUMP TO NEXT NO.                             
GN22     DS    0H                                                               
         LH    RF,0(R2)                                                         
         LA    RF,1(RF)                                                         
         STH   RF,0(R2)                                                         
*                                                                               
GN23     DS    0H                                                               
         CH    RF,=H'9999'                                                      
         BL    *+6                                                              
         DC    H'0'                NO BILL OVER 10,000                          
*                                  (USED TO RESET TO 1)                         
         LA    R4,AGMSKP1S                                                      
GN25     DS    0H                                                               
         OC    0(4,R4),0(R4)                                                    
         BZ    GN30                                                             
         CLC   0(2,R2),0(R4)                                                    
         BL    GN30                                                             
         CLC   0(2,R2),2(R4)                                                    
         BNL   GN26                                                             
         MVC   0(2,R2),2(R4)                                                    
         LH    RF,0(R2)                                                         
         LA    RF,1(RF)                                                         
         STH   RF,0(R2)                                                         
GN26     DS    0H                                                               
*                                                                               
*                                  FORMAT INVOICE NUMBER                        
GN30     DS    0H                                                               
GN31     DS    0H                                                               
         ZIC   R0,W                                                             
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  GNDATE(2),DUB                                                    
         ZIC   R0,W+1              W HAS Y/M                                    
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  GNDATE+2(2),DUB                                                  
         MVC   GNDATE+4(2),=C'01'      DAY                                      
*                                                                               
*                                                                               
         GOTO1 =V(PPFMTINO),DMCB,GNDATE,(2,(R2)),(QMEDIA,PROFB1),      X        
               PROGPROX                                                         
         L     RF,DMCB                 A(FULL INVOICE NUMBER)                   
         MVC   0(10,R3),0(RF)                                                   
         L     RF,DMCB+8                                                        
         MVC   SVINVMO,0(RF)           SAVE MONTH                               
*                                                                               
GNX      DS    0H                                                               
         MVC   RCTRACE,SAVTRACE                                                 
         MVI   FCRDCLOS,C'N'         RESET TO NO CLOSED-OUT RECORDS             
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        GNOFFSET - SET FOR OFFICE CHECKING                                     
*                                                                               
***********************************************************************         
         SPACE 2                                                                
GNOFFSET NTR1                                                                   
         XC    CLTPARS+8(4),CLTPARS+8    CLEAR CLIENT TABLE                     
         CLI   AGMOCTL,0           ANY OFFICE CHECKING                          
         BE    GNOSX               NO, DONE                                     
         XC    WK,WK               CLEAR LIST OF OFFICES                        
         LA    R4,MED                                                           
         CLI   AGMSEQ,C'A'     SEE IF SEQUENCING BY AGENCY                      
         BNE   GNOS4D                                                           
         LA    R4,MEDTAB                                                        
*                                                                               
GNOS2    CLI   AGMOCTL,C'*'        TEST OFFICE SEQUENCING                       
         BNE   GNOS4                                                            
         L     R2,ADCLT                                                         
         MVC   WK(1),PCLTOFF-PCLTREC(R2) SET THIS OFFICE IN LIST                
         B     GNOS6                                                            
*                                                                               
GNOS4    DS    0H              IF NOT 0 OR *, SHOULD BE OFFICE LIST             
*                                                                               
GNOS4D   DS    0H                                                               
         XC    WORK,WORK       READ '$X' PROFILE                                
         MVC   WORK(3),=C'P0$'                                                  
         MVC   WORK+3(1),AGMOCTL   OFFICE LIST CODE                             
         MVC   WORK+4(2),QAGENCY                                                
         MVC   WORK+6(1),0(R4)           MEDIA                                  
         GOTO1 GETPROF,DMCB,WORK,WK,DATAMGR                                     
*                                                                               
GNOS6    DS    0H                  READ OFF/CLT PASSIVES FOR EACH OFF           
         LA    R2,WK               LIST OF OFFICES                              
         LA    R3,16               MAX 16                                       
*                                                                               
GNOS8    DS    0H                                                               
         CLI   0(R2),0             NOT AN OFFICE                                
         BE    GNOS12                                                           
         CLI   0(R2),C'0'          NOT AN OFFICE                                
         BE    GNOS12                                                           
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),QAGENCY      OFF/CLT PASSIVES                             
         MVC   KEY+2(1),0(R4)                                                   
         MVI   KEY+3,X'A2'                                                      
         MVC   KEY+4(1),0(R2)      OFFICE CODE                                  
         GOTO1 HIGH                                                             
         B     GNOS10B                                                          
*                                                                               
GNOS10   DS    0H                                                               
         GOTO1 SEQ                                                              
GNOS10B  DS    0H                                                               
         CLC   KEY(5),KEYSAVE     THROUGH OFFICE                                
         BNE   GNOS12                                                           
         MVC   MEDCLT(1),KEY+2      MEDIA                                       
         MVC   MEDCLT+1(3),KEY+5    CLIENT                                      
*                                                                               
         GOTO1 BINSRCH,CLTPARS,(1,MEDCLT)                                       
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                CLIENT TABLE FULL                            
         B     GNOS10              NEXT POINTER                                 
*                                                                               
GNOS12   DS    0H                                                               
         LA    R2,1(R2)            NEXT OFFICE                                  
         BCT   R3,GNOS8                                                         
         CLI   AGMSEQ,C'A'        SEE IF ACROSS AGENCY                          
         BNE   GNOSX                                                            
         LA    R4,1(R4)           POINT TO NEXT MEDIA                           
         CLI   0(R4),X'FF'        SEE IF AT END                                 
         BE    GNOSX                                                            
         B     GNOS2                  GO DO NEXT MEDIA                          
*                                                                               
GNOSX    DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
*                                                                               
GNDATE   DS    CL6                                                              
MEDCLT   DS    CL4                   USED AS KEY TO CLIENT BINSEARCH            
*                                                                               
MEDTAB   DC    C'MNOST',X'FF'        MEDIA TABLE                                
*                                                                               
*                                                                               
         TITLE 'AGMPROC - HANDLE AGENCY/MEDIA PROFILE'                          
AGMPROC  CSECT                                                                  
         NMOD1 0,AGMPROC                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
*        READ PB1X PROFILE                                                      
*                                                                               
         XC    PROGPROX,PROGPROX   FIRST GET EXTENSION PROFILE                  
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'PB1X'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         MVC   WORK+4(3),QAGENCY   AGY/MED                                      
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   *+14                                                             
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
         GOTO1 GETPROF,DMCB,WORK,PROGPROX,DATAMGR                               
*                                                                               
         CLI   PROGPROX+10,0           TEST OVERRIDE OF MAXLINES                
         BNH   *+10                                                             
         MVC   MAXLINES,PROGPROX+10                                             
*                                                                               
         MVC   AGMINBY,PROGPROX+4     SET INVOICE NUMBER BASE YEAR              
         XC    INRSQYM(4),INRSQYM     CLEAR INVOICE NO. RESEQ DATE              
         OC    PROGPROX,PROGPROX                                                
         BZ    AGMP1                                                            
         MVC   INRSQYM(2),PROGPROX   YEAR AND MONTH (LEAVE AS BINARY)           
         ZIC   R0,PROGPROX+2             DAY                                    
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  INRSQDA,DUB             MAKE EBCDIC                              
*                                                                               
AGMP1    DS    0H                                                               
*                                  READ B1 PROFILE                              
*                                                                               
         DS    0H                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'POB1'                                                 
         MVC   WORK+4(3),QAGENCY                                                
***      CODE TO READ OFFICE LEVEL B1 PROFILE                                   
***      FOR THOSE AGYS WHO WANT DIFFERENT PAPER/ADDRESS BY OFFICE              
***      NOTE - ONLY GET HERE FROM CLTFRST IF AGY/MED CHANGES                   
*** START OF NEW CODE 9/29/87                                                   
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   AGMP2                                                            
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
         B     AGMP3                                                            
*                                                                               
AGMP2    XC    WORK+7(5),WORK+7     NO OFFICE-SO CLEAR CLT                      
*** END OF NEW CODE 9/29/87                                                     
AGMP3    GOTO1 GETPROF,DMCB,WORK,PROFB1,DATAMGR                                 
         MVC   W(16),PROFB1                                                     
*                                                                               
         MVC   AGMSTADT,W          START MOS FOR NEW BILLING                    
*                                                                               
*                                  MEDIA EXP                                    
*                                  *=BLANK, **=USE MEDIA CODE                   
         CLI   W+2,C'*'                                                         
         BNE   *+8                                                              
         MVI   W+2,C' '                                                         
         CLI   W+3,C'*'                                                         
         BNE   *+8                                                              
         MVI   W+3,C' '                                                         
         CLC   W+2(2),SPACES                                                    
         BNE   *+10                                                             
         MVC   W+2(1),MED                                                       
*                                                                               
         MVC   AGMEXP,W+2          MEDIA EXP                                    
         MVC   AGMFMT,W+4          FORMAT                                       
         MVC   AGMSEQ,W+5          SEQ CONTROL                                  
         MVC   AGMCLOPT,W+12       OPT FOR 1 CLT/PAGE ON REGISTER               
         MVC   AGMFORMS,W+13       PAPER TYPE (D=DDS)                           
         MVC   AGMCLNO,W+14        CLT INTERFACE NO. OPT                        
*                                                                               
         MVC   AGMOCTL,W+9                                                      
         CLI   AGMOCTL,C'0'                                                     
         BNE   *+8                                                              
         MVI   AGMOCTL,0                                                        
*                                                                               
*******                                                                         
*******  MVC   AGMMTH,W+9       MONTH SEQUENCE CONTROL - INOPERATIVE            
*******                                                                         
         MVC   AGMTITL,W+10                                                     
         MVC   AGMSCOM,W+15    COMMENT SKIP CHARACTER                           
         CLI   AGMSCOM,0                                                        
         BNE   *+8                                                              
         MVI   AGMSCOM,C'N'     SET 0 TO N                                      
*                                  START NO. AND SKIPS                          
         LA    R2,W+6                                                           
         LA    R3,AGMSTANO                                                      
         LA    R0,3                                                             
AGMP4    DS    0H                                                               
         ZIC   RF,0(R2)                                                         
         MH    RF,=H'100'                                                       
         STH   RF,0(R3)                                                         
         LA    R2,1(R2)                                                         
         LA    R3,2(R3)                                                         
         BCT   R0,AGMP4                                                         
*                                                                               
         OC    AGMSTANO,AGMSTANO                                                
         BNZ   *+8                                                              
         MVI   AGMSTANO+1,1        START AT 1 NOT ZERO                          
         LH    RF,AGMSKP1E         ADJUST END OF RANGES                         
         LTR   RF,RF                                                            
         BZ    AGMP4B                                                           
         LA    RF,99(RF)                                                        
         STH   RF,AGMSKP1E                                                      
AGMP4B   DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'SETDATE - MASSAGE QSTART + QEND'                                
*                                                                               
SETDATE  CSECT                                                                  
         NMOD1 0,SETDATE                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                  READ B2 PROFILE                              
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'POB2'                                                 
***E***                                                                         
         CLC   QPROG,=C'E1'        FOR ESTIMATE READ E PROFILES                 
         BNE   *+10                                                             
         MVC   WORK+2(2),=C'E2'                                                 
***E***                                                                         
         MVC   WORK+4(3),QAGENCY                                                
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   *+14                                                             
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
         GOTO1 GETPROF,DMCB,WORK,PROGPROF,DATAMGR                               
*                                                                               
         OC    PROGPROF,PROGPROF                                                
         BNZ   SETD0                                                            
         MVI   ERR,TYPERR          NO B2 PROFILE                                
         GOTO1 AERRPROC                                                         
         B     SETDATEX                                                         
*                                  READ TYPE PROF INTO PROGPRO2                 
SETD0    MVC   WORK+3(1),TYPE                                                   
         GOTO1 (RF),(R1),,PROGPRO2                                              
         OC    PROGPRO2,PROGPRO2                                                
         BNZ   SETD01                                                           
         MVI   ERR,TYPERR          NO PROFILE                                   
         GOTO1 AERRPROC                                                         
         B     SETDATEX                                                         
*                                                                               
SETD01   DS    0H                                                               
         MVC   WORK(4),=C'PB A'    MUST READ B4-7A PROFILE                      
***E***                                                                         
         CLC   QPROG,=C'E1'        FOR ESTIMATE READ E4-7 A PROFILE             
         BNE   *+8                                                              
         MVI   WORK+1,C'E'                                                      
***E***                                                                         
         MVC   WORK+2(1),TYPE                                                   
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         GOTO1 (RF),(R1),,PROGPRO3                                              
         OC    PROGPRO3,PROGPRO3                                                
         BNZ   SETD01D                                                          
         MVI   ERR,TYPERR          NO PROFILE                                   
         GOTO1 AERRPROC                                                         
         B     SETDATEX                                                         
*                                  TRY FOR RETAIL PROFILE - B9                  
SETD01D  MVC   WORK(4),=C'PB B'    MUST READ B4-7B PROFILE                      
*                                  HAS FORMAT FOR DETAIL BACK-UP                
*                                  THIS PROFILE IS OPTIONAL                     
***E***                                                                         
         CLC   QPROG,=C'E1'     FOR ESTIMATE USE E4-7 B PROFILE                 
         BNE   *+8                                                              
         MVI   WORK+1,C'E'                                                      
***E***                                                                         
         MVC   WORK+2(1),TYPE                                                   
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         GOTO1 (RF),(R1),,PROGPRO4                                              
         OC    PROGPRO4,PROGPRO4                                                
         BNZ   SETD01X                                                          
         MVC   PROGPRO4,PROGPRO3   USE B4-7A PROFILE IF B                       
*                                  IS NOT FOUND                                 
SETD01X  MVI   SUMOPT,C'N'                                                      
         MVC   CDSEP,PROGPROF+2                                                 
         MVC   ADJSEP,PROGPROF+3                                                
         MVC   OSDOPT,PROGPROF+4    ON-SALE DATE OPTION                         
         MVC   DOCOPT,PROGPROF+13   DOCUMENT/INV OPTION                         
         MVI   AORSW,C'Y'                                                       
         CLI   PROGPROF+3,C'A'      SAME PROFILE BYTE AS ADJSEP                 
         BE    *+8                                                              
         MVI   AORSW,C'N'                                                       
         CLI   ADJSEP,C'A'                                                      
         BNE   *+8                                                              
         MVI   ADJSEP,C'N'                                                      
*                                                                               
         CLI   QOPT8,C'C'         SEE IF UFC COMMISSION BILLING                 
         BNE   *+8                                                              
         MVI   ADJSEP,C'N'                                                      
*                                                                               
         CLI   QOPT8,C'N'         SEE IF UFC NET BILLING                        
         BNE   *+8                                                              
         MVI   ADJSEP,C'N'         ONLY SET ADJSEP TO "N"                       
*                                  CDSEP CAN BE LEFT ALONE                      
*                                  READ FOR B1A PROFILE                         
         XC    PROFB1A,PROFB1A                                                  
         MVC   WORK(4),=C'PB1A'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         GOTO1 (RF),(R1),,PROFB1A                                               
*                                                                               
***                                                                             
*        READING OF PB1X PROFILE MOVED HERE FROM AGMPROC                        
***                                                                             
         XC    PROGPROX,PROGPROX   FIRST GET EXTENSION PROFILE                  
         MVC   WORK(4),=C'PB1X'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         GOTO1 GETPROF,DMCB,WORK,PROGPROX,DATAMGR                               
*                                                                               
SETD03   DS    0H                                                               
         XC    PROFAOR,PROFAOR     GET AOR PROFILE                              
         MVI   AORLOPT,C'N'        SET TO NO                                    
         MVC   WORK(4),=C'PB2A'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         GOTO1 (RF),(R1),,PROFAOR                                               
         OC    PROFAOR,PROFAOR           SEE IF I HAVE AOR PROFILE              
         BZ    SETD05                                                           
         MVC   AORSW,PROFAOR+0                                                  
         MVC   AORLOPT,PROFAOR+1        AOR DETAIL OPTION                       
*                                                                               
         CLI   AORLOPT,C' '                                                     
         BH    *+8                                                              
         MVI   AORLOPT,C'N'             DEFAULT TO N                            
         MVC   AORTXOPT,PROFAOR+3       AOR TAX OPTION                          
         CLI   AORTXOPT,C' '                                                    
         BH    *+8                                                              
         MVI   AORTXOPT,C'Y'                                                    
*                                                                               
SETD05   XC    PROFB2B,PROFB2B     GET B2B PROFILE                              
         MVC   WORK(4),=C'PB2B'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         GOTO1 (RF),(R1),,PROFB2B                                               
         MVC   SCBOPT,PROFB2B+0                                                 
         MVI   SCBNCSW,0                                                        
         CLI   SCBOPT,C'Y'                                                      
         BNE   SETD10                                                           
*                                                                               
         CLI   CDSEP,C'R'       DISALLOW SPECIAL CD HANDLING (+APPLY)           
         BE    SETD05A                                                          
         CLI   CDSEP,C'C'          DISALLOW SPECIAL CD HANDLING                 
         BNE   SETD05B                                                          
SETD05A  MVI   ERR,PROFERR         INVALID PROFILE                              
         GOTO1 AERRPROC                                                         
         B     SETDATEX                                                         
*                                                                               
SETD05B  CLI   FINANSW,X'01'                                                    
         BNE   SETD05C                                                          
         MVI   ERR,PROFERR         NO UPFRONT COMMISSION BILLING                
         GOTO1 AERRPROC            FOR FINANCIAL CLIENTS                        
         B     SETDATEX                                                         
*                                                                               
*                                                                               
SETD05C  MVC   SCBNCSW,QOPT8                                                    
         CLI   SCBNCSW,C'C'          MUST HAVE TYPE C, N, OR R                  
         BE    SETD15                                                           
         CLI   SCBNCSW,C'N'                                                     
         BE    SETD15                                                           
         CLI   SCBNCSW,C'R'                                                     
         BE    SETD15                                                           
SETD05E  MVI   ERR,SCBERR                                                       
         GOTO1 AERRPROC                                                         
*                                                                               
SETD10   CLI   QOPT8,C' '      IF NOT COMMISSION OPTION IS INVALID              
         BNE   SETD05E                                                          
*                                                                               
SETD15   DS    0H                                                               
         XC    RETPROF,RETPROF                                                  
         CLI   NONRET,C'Y'                                                      
         BE    SETD25B                                                          
***E***                                                                         
         CLC   QPROG,=C'E1'   FOR RETAIL FOR ESTIMATES                          
         BE    SETD25B                                                          
***E***                                                                         
*                                                                               
         MVC   WORK(4),=C'P0B9'        READ FOR RETAIL PROFILE                  
         GOTO1 (RF),(R1),,RETPROF                                               
*                                                                               
         CLI   RETPROF,0                                                        
         BE    SETD25B                                                          
*                                                                               
         CLI   FINANSW,X'01'       NO RETAIL FOR FINANCIAL CLIENTS              
         BNE   *+6                                                              
         DC    H'0'                MUST DIE                                     
*                                                                               
         MVI   PROGPRO2+7,0        NO DETAIL-BACKUP FOR RETAIL                  
*                                                                               
         MVI   CDSEP,C'N'          NO CD SEPERATE FOR RETAIL                    
         MVI   ADJSEP,C'N'         NO ADJ SEPERATE FOR RETAIL                   
         MVI   AORSW,C'N'          NO AOR FOR RETAIL                            
*                                                                               
         MVC   SUMOPT,RETPROF+6    CORP SUMMARY                                 
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+12                                                             
         MVI   SUMOPT,C'N'                                                      
         MVI   RETPROF+11,C'Y'     ACTIVATE PCT PRINTING                        
*                                                                               
*                                  SET UP GDAREA FOR FINDOUT                    
         L     R4,AGDAREA                                                       
         USING GDSECT,R4                                                        
         XC    GDCOMP(255),GDCOMP                                               
         XC    GDCOMP+255(GDSECTL-255),GDCOMP+255                               
         MVC   GDCOMP(3),RETPROF                                                
         MVC   GDMED,QMEDIA        SET MEDIA CODE                               
         MVC   GDMGRLEN,RETPROF+3     REGION LENGTH                             
         MVC   SVREGLEN,RETPROF+3                                               
         MVC   SVDSTLEN,RETPROF+4                                               
         ZIC   R0,GDMGRLEN                                                      
         ZIC   R1,RETPROF+4      ADD DISTRICT LENGTH                            
         AR    R0,R1                                                            
         STC   R0,GDMGRLEN                                                      
         CLI   RETPROF+14,C'*'     TEST PSEUDO MGR (ACCT PREFIX)                
         BNH   *+8                                                              
         MVI   GDMGRLEN,1                                                       
         MVI   GDMKTLEN,0                                                       
         MVC   GDOUTLEN,RETPROF+5                                               
*                                                                               
         MVC   GDDMGR,DATAMGR                                                   
         MVC   GDAUTL,UTL                                                       
         MVC   GDACCSYS,ACCTSE                                                  
         MVC   GDATABS,AFOTABS                                                  
         MVI   GDOUTNO,0                                                        
         DROP  R4                                                               
*                                                                               
         CLI   ACCTSE,0        MUST HAVE VALID ACCOUNT SE                       
         BNE   SETD25B                                                          
         MVI   ERR,IDERR                                                        
         GOTO1 AERRPROC                                                         
         B     SETDATEX                                                         
*                                                                               
SETD25B  DS    0H                                                               
*                                                                               
         L     R4,AVATACCS         VAT ACCOUNT TABLE                            
         SR    R5,R5                                                            
         MVC   WORK(4),=C'P0VA'                                                 
*                                                                               
STD26    DS    0H                                                               
         GOTO1 GETPROF,DMCB,WORK,X,DATAMGR                                      
         BAS   RE,FIXVACC          *'S TO SPACES                                
         MVC   0(16,R4),X                                                       
         LA    R5,1(R5)                                                         
         CH    R5,=Y(NPROVS)                                                    
         BH    STD26B                                                           
         LA    R4,16(R4)                                                        
         LA    RF,X'F0'(R5)                                                     
         STC   RF,WORK+3           PROVINCE NUMBER                              
         MVC   WORK(3),=C'PVA'                                                  
         NI    WORK,X'BF'          SYSTEM LOWER CASE                            
         B     STD26                                                            
*                                                                               
STD26B   DS    0H                                                               
*                                                                               
         L     RF,APATCH           CHECK FOR SPECIAL PATCHES                    
         OC    0(16,RF),0(RF)                                                   
         BZ    *+10                                                             
         MVC   PROGPRO2,0(RF)                                                   
         OC    16(16,RF),16(RF)                                                 
         BZ    *+10                                                             
         MVC   PROGPRO4(14),16(RF)     DONT CLOBBER DATE                        
*                                                                               
*                                                                               
*                                                                               
*                                  INVOICE DATE                                 
         LA    R4,TODAY            USE TODAY                                    
** CODE NO-OPED 7/19/90                                                         
** SINCE QINVDATE AND QDUEDAYS MOVED TO QPAY (COL 53)                           
** AND CAN CO-EXIST WITH PUB,JOB, OR RD=                                        
**       CLI   QPUB,C' '           SEE IF PUB SPECIFIED                         
**       BNE   SETD25E                                                          
**       CLI   QPUB+1,C'J'      AD CODE FILTER                                  
**       BE    SETD25E                                                          
**       CLC   QPUB+1(3),=C'RD='      DIV/REG/DST OVERRIDE                      
**       BE    SETD25E                                                          
*                                                                               
         CLI   QINVDATE,C' '                                                    
         BNH   *+8                                                              
         LA    R4,QINVDATE         UNLESS REQ OVERRIDE                          
*                                                                               
SETD25E  MVC   EINVDTE,0(R4)                                                    
         GOTO1 DATCON,DMCB,(R4),(5,PINVDTE)                                     
         GOTO1 (RF),(R1),,(3,BINVDTE)                                           
         GOTO1 (RF),(R1),,(2,BINVDTEP)                                          
*                                  DUE DATE CALC                                
** CODE NO-OPED 7/19/90                                                         
** SINCE QINVDATE AND QDUEDAYS MOVED TO QPAY (COL 53)                           
** AND CAN CO-EXIST WITH PUB,JOB, OR RD=                                        
**       CLI   QPUB,C' '           SEE IF PUB SPECIFIED                         
**       BNE   SETD26                                                           
**       CLI   QPUB+1,C'J'      AD CODE FILTER                                  
**       BE    SETD26                                                           
*                                                                               
         CLI   QDUEDAYS,C' '                                                    
         BNH   SETD26                                                           
         PACK  DUB,QDUEDAYS(2)                                                  
         CVB   R0,DUB                                                           
         STC   R0,BYTE                                                          
         B     SETD28                                                           
*                                                                               
SETD26   DS    0H                                                               
         MVC   BYTE,PROGPROF                                                    
SETD28   DS    0H                                                               
         MVC   PDUEDTE(14),SPACES                                               
         XC    BDUEDTE(5),BDUEDTE                                               
         CLI   BYTE,0                                                           
         BE    SETD30                                                           
         ZIC   R0,BYTE                                                          
         GOTO1 ADDAY,DMCB,EINVDTE,EDUEDTE,(R0)                                  
         GOTO1 DATCON,(R1),EDUEDTE,(5,PDUEDTE)                                  
         GOTO1 (RF),(R1),,(3,BDUEDTE)                                           
         GOTO1 (RF),(R1),,(2,BDUEDTEP)                                          
*                                                                               
SETD30   DS    0H                                                               
         MVC   PEOVOPT,PROGPROF+11   'Y' = USE PRD/EST COLS OVERRIDE            
*                                                                               
         MVC   JOBOPT,PROGPROF+1     FOR SHOW AD FILE INFO  N,1,2,A,B           
         CLI   PROGPROF+8,C'4'                                                  
         BL    SETD30A                                                          
         CLC   TYPE,PROGPROF+8     TEST VALID BILLING TYPE                      
         BNH   SETD30A                                                          
         MVI   ERR,TYPERR                                                       
         GOTO1 AERRPROC                                                         
         B     SETDATEX                                                         
SETD30A  DS    0H                                                               
*                                                                               
         CLI   PROGPRO2+3,C'S'      REG/DST                                     
         BE    SETD30A2                                                         
         CLI   PROGPRO2+4,C'S'      MKTS                                        
         BE    SETD30A2                                                         
         CLI   PROGPRO2+5,C'S'      JOBS                                        
         BE    SETD30A2                                                         
         CLI   PROGPRO2+6,C'S'      PUBS                                        
         BE    SETD30A2                                                         
*                                                                               
         CLI   ADJSEP,C'Y'          ADJ SEP                                     
         BE    SETD30A2                                                         
         CLI   CDSEP,C'Y'           OR CD SEP                                   
         BNE   SETD30A3                                                         
*                                                                               
SETD30A2 CLI   AORLOPT,C'C'          INCOMPATIBLE WITH AOR                      
         BNE   SETD30A3              CLIENT LIST MODE                           
         MVI   ERR,AORPERR                                                      
         GOTO1 AERRPROC                                                         
*                                                                               
SETD30A3 DS    0H                                                               
         MVC   TEST,PROGPROF+7                                                  
*******                                                                         
         CLC   QPROG,=C'D1'      DRAFT BILLING                                  
         BNE   *+8                                                              
         MVI   TEST,C'T'            SET TEST MODE                               
         CLC   QPROG,=C'RD'      DRAFT BILLING (REBATE)                         
         BNE   *+8                                                              
         MVI   TEST,C'T'            SET TEST MODE                               
*******                                                                         
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+8                                                              
         MVI   TEST,C'T'                                                        
******                                                                          
         B     SETD30A4            BYPASS SEP VS. BACK-UP CHECK                 
*******                                                                         
**       CLI   ADJSEP,C'Y'         CANNOT HAVE SEP ADJ                          
**       BE    SETD30A2                                                         
**       CLI   CDSEP,C'Y'         CANNOT HAVE SEP CD                            
**       BNE   SETD30A4                                                         
**TD30A2 CLI   PROGPRO2+7,0        AND DETAIL BACKUP                            
**       BE    SETD30A4                                                         
**       MVI   ERR,ADJERR                                                       
**       GOTO1 AERRPROC                                                         
**                                                                              
SETD30A4 DS    0H                                                               
         MVI   BOXNO,0               WAS PROGPROF+4                             
         MVC   PAYOPT,PROGPRO2+10    BILL CLEARED ITEMS ONLY                    
         CLI   PAYOPT,0                                                         
         BNE   *+8                                                              
         MVI   PAYOPT,C'N'           TO INSURE DEFAULT TO 'N'                   
*                                                                               
*        PAYOPT VALUES                                                          
* N  =  ALL ITEMS                                                               
* Y  =  CLEARED ITEMS ONLY                                                      
* S  =        "             + NO MESSAGE                                        
* C  =        "             + NO MESSAGE + CHG ORDERED TO CLEARED               
* E  =  CLEARED ESTS ONLY  (NO UNPAID INSERTIONS)                               
* F  =        "             + NO MESSAGE                                        
* G  =        "             + NO MESSAGE + CHG ORDERED TO CLEARED               
*                                                                               
****************** SPECIAL FOR MW(TO)  TO SUPPRESS MESSAGE                      
****************** SPECIAL FOR PA(TO)  TO SUPPRESS MESSAGE                      
         CLC   QAGENCY,=C'MW'                                                   
         BE    *+14                                                             
         CLC   QAGENCY,=C'PA'                                                   
         BNE   SETD30A5                                                         
         CLI   PAYOPT,C'Y'                                                      
         BNE   SETD30A5                                                         
         MVI   PAYOPT,C'S'           RESET TO SUPPRESS MESSAGE                  
****************** END OF SPECIAL FOR MW(TO)                                    
*                                                                               
SETD30A5 CLI   FINANSW,X'01'         NO PAYED OPT FOR FINANCIAL CLIENTS         
         BNE   SETD30A6                                                         
         CLI   PAYOPT,C'N'                                                      
         BE    SETD30A6                                                         
         MVI   ERR,PROFERR                                                      
         GOTO1 AERRPROC                                                         
         B     SETDATEX                                                         
*                                                                               
SETD30A6 MVC   TAXOPT,PROGPROF+12                                               
         CLI   TAXOPT,0                                                         
         BNE   *+8                                                              
         MVI   TAXOPT,C'N'      CAN BE 'Y' OR 'S' (SUPPRESS DISPLAY)            
         MVI   NOPMBRK,C'N'                                                     
         MVC   PRIOR,PROGPRO2+9                                                 
         CLI   PRIOR,C'Z'                                                       
         BNE   SETD30A8                                                         
         MVI   PRIOR,C'T'                                                       
         MVI   NOPMBRK,C'Y' PRIOR MONTHS TOGETHER WITH NO BREAKOUT              
*                                                                               
SETD30A8 CLC   =C'NO PRIOR',QMANUAL                                             
         BNE   *+8                                                              
         MVI   PRIOR,C'N'                                                       
         MVI   NMOS,1              NO PRIOR MONTHS                              
         CLI   PRIOR,C'N'                                                       
         BE    SETD31                                                           
         MVI   NMOS,MAXMOS                                                      
         CLI   PRIOR,C'C'          A-C = 1-3 PRIOR MOS SEPARATE                 
         BNH   SETD30B                                                          
         CLI   PRIOR,C'1'          AND 1-3 = 1-3 PRIORS TOGETHER                
         BL    SETD31                                                           
SETD30B  DS    0H                                                               
         ZIC   RF,PRIOR                                                         
         LA    RF,1(RF)                                                         
         STC   RF,NMOS                                                          
         NI    NMOS,X'0F'                                                       
SETD31   DS    0H                                                               
         MVC   ZBOPT,PROGPROF+5    ZERO BILL OPTION                             
         MVC   ZUOPT,PROGPROF+9    PREVIOUSLY BILLED INS OPT                    
         MVC   ZLOPT,PROGPROF+10      ZERO LINE OPTION                          
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+8                                                              
         MVI   ZLOPT,C'0'                                                       
         MVI   ORIGTYPE,0                                                       
*******  MVC   ORIGTYPE,PROGPROF+6     TYPE NOT TO MARK DETAILS                 
         MVC   FREEOPT,PROGPROF+6      Y = BILL "FREE" BUYS                     
*                                      WHOSE INS. DATE IS ON OR AFTER           
*                                      AUG01/92                                 
         OC    MANGRS(12),MANGRS                                                
         BZ    *+12                                                             
         MVI   NMOS,1                                                           
         MVI   PRIOR,C'N'          NO PRIOR IF MANUAL                           
SETD32   DS    0H                                                               
*                                  SET MGR BUCKETS OPT                          
         MVI   MGRBKTS,C'N'                                                     
         B     SETD34                                                           
***                                                                             
*        WAS MKTGROUP SCHEME CHK FOR SPOT                                       
***                                                                             
*                                                                               
SETD34   DS    0H                                                               
SETD34D  DS    0H                                                               
         OC    MANUALS,MANUALS     IF ANY MANUAL ENTRY                          
         BNZ   SETD35              IGNORE PROF PERCENTZGE                       
         ZIC   RF,PROGPRO2+12      TAKE FROM B4-7 PROFILE                       
         MH    RF,=H'100'                                                       
         ST    RF,MANPCT                                                        
SETD35   DS    0H                                                               
         MVI   PCTNET,C'Y'         PCT ON BOTH GROSS + NET                      
         CLC   MANPCT,=F'14900'    BUT, IF OVER 149 PCT                         
         BNH   SETD36                                                           
         L     RF,MANPCT                                                        
         S     RF,=F'10000'        SUBTRACT 100 PCT AND TAKE                    
         ST    RF,MANPCT                                                        
         MVI   PCTNET,C'N'         PCT OF GROSS ONLY                            
SETD36   DS    0H                                                               
         MVC   NEWSTART,PROGPROF+14     STARTING YM FOR NEW BILLING             
         CLI   NEWSTART,0                                                       
         BNE   *+10                                                             
         MVC   NEWSTART,AGMSTADT                                                
         CLI   NEWSTART,0                                                       
         BNE   *+10                                                             
         MVC   NEWSTART,FFS        NOT USING                                    
         SPACE 2                                                                
         XC    PERLIST,PERLIST                                                  
         MVI   PARTIAL,C'N'                                                     
         CLI   QEND,C' '       TEST START-END GIVEN                             
         BE    SETD3                                                            
*                                  YES- SET DATES DIRECTLY                      
         GOTO1 DATCON,DMCB,QSTART,(3,BQSTART)                                   
         GOTO1 (RF),(R1),QEND,(3,BQEND)                                         
         LA    RF,PERLIST                                                       
         MVC   0(2,RF),BQSTART     YM                                           
         MVC   2(6,RF),BQSTART     YMD,YMD                                      
         MVI   8(RF),X'FF'                                                      
         CLC   BQSTART(2),BQEND    DATES CANNOT SPAN MONTH                      
         BE    SETD2B                                                           
SETDERR  MVI   ERR,DATERR2         INVALID PERIOD                               
         GOTO1 AERRPROC                                                         
         B     SETDATEX                                                         
*                                                                               
SETD2B   DS    0H                                                               
         MVC   WORK(2),BQSTART                                                  
         BAS   RE,DTEXP                                                         
         CLC   WORK(6),BQSTART     UNLESS DATES = MONTH DATES                   
         BE    *+8                                                              
         MVI   PARTIAL,C'Y'        SET PARTIAL MONTH REQ                        
         MVC   CURPER(8),PERLIST                                                
         B     SETD4                                                            
*                                                                               
SETD3    DS    0H                  MONTH REQUEST                                
         MVC   WORK(4),QSTART                                                   
         MVC   WORK+4(2),=C'01'                                                 
         GOTO1 DATCON,DMCB,WORK,(3,WORK)                                        
*                                                                               
         ZIC   R6,NMOS                                                          
         SLL   R6,3                X 8                                          
         LA    R6,PERLIST-8(R6)    POINT TO LAST ENTRY                          
         LR    R5,R6               SAVE ADDR OF LAST ENTRY                      
         MVI   8(R6),X'FF'         SET END                                      
*                                                                               
SETD3B   DS    0H                                                               
         BAS   RE,DTEXP                                                         
         MVC   0(2,R6),WORK        YM                                           
         MVC   2(6,R6),WORK        YMD,YMD                                      
*                                                                               
         CLI   WORK+1,1            IF JANUARY                                   
         BNE   SETD3F                                                           
         MVI   WORK+1,12           SET TO DEC                                   
         ZIC   RF,WORK             OF PREV YEAR                                 
         BCTR  RF,R0                                                            
         STC   RF,WORK                                                          
         B     SETD3H                                                           
*                                                                               
SETD3F   DS    0H                                                               
         ZIC   RF,WORK+1           ELSE DECREMENT MONTH                         
         BCTR  RF,R0                                                            
         STC   RF,WORK+1                                                        
*                                                                               
SETD3H   DS    0H                                                               
         SH    R6,=H'8'            UP ONE POSITION                              
         LA    R0,PERLIST                                                       
         CR    R6,R0                                                            
         BNL   SETD3B                                                           
*                                                                               
*                                  SET DERIVED START-END DATES IN REQ           
         MVC   CURPER(8),0(R5)                                                  
         MVC   BQSTART(6),2(R5)                                                 
         GOTO1 DATCON,DMCB,(3,BQSTART),QSTART                                   
         GOTO1 (RF),(R1),(3,BQEND),QEND                                         
*                                                                               
SETD4    DS    0H                                                               
SETD45   CLC   PERLIST(2),NEWSTART                                              
         BNL   SETD23              BEFORE START OF NEW BILLING                  
         XC    W,W                                                              
         MVC   W(L'PERLIST),PERLIST                                             
         XC    PERLIST,PERLIST                                                  
         MVC   PERLIST(L'PERLIST-8),W+8                                         
         B     SETD45                                                           
SETD23   DS    0H                                                               
         CLI   PERLIST,X'FF'                                                    
         BE    SETDERR             MUST HAVE SOME DATE LEFT                     
         XC    W,W                                                              
*                                                                               
SETDATEX DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
DTEXP    DS    0H                EXPAND YYMM IN WORK TO YYMMDD-YYMMDD           
         MVI   WORK+2,1                                                         
         MVC   WORK+3(3),WORK                                                   
         MVC   WORK+6(12),MTHDAYS  TABLE OF HIGH DAYS                           
         TM    WORK,X'01'          TEST LEAP                                    
         BNZ   *+8                                                              
         MVI   WORK+6+1,29         SET FEB TO 29                                
*                                                                               
         ZIC   RF,WORK+1                                                        
         LA    RF,WORK+6-1(RF)     POINT TO MONTH                               
         MVC   WORK+5(1),0(RF)                                                  
         BR    RE                                                               
*                                                                               
MTHDAYS  DC    AL1(31,28,31,30,31,30,31,31,30,31,30,31)                         
*                                                                               
         SPACE 2                                                                
*              FIXVACC - FIX VAT ACCOUNT CODES                                  
*                                                                               
FIXVACC  DS    0H                                                               
         LA    RF,X                CHANGE * TO SPACE                            
         LA    R0,16                                                            
         CLI   0(RF),C'*'                                                       
         BNE   *+8                                                              
         MVI   0(RF),C' '                                                       
         LA    RF,1(RF)                                                         
         BCT   R0,*-16                                                          
         BR    RE                                                               
*                                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'TOSORT - PASS RECORDS TO SORT/BUFFALO'                          
*                                                                               
TOSORT   CSECT                                                                  
         NMOD1 0,TOSORT                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         CLI   SORTTRCE,C'Y'                                                    
         BNE   TS4                                                              
*                                                                               
         MVC   P1+1(7),=C'SORT IN'                                              
         MVI   P1,X'10'             FORCE PRINT                                 
         GOTO1 HEXOUT,DMCB,SORTREC,P1+10,SORTRLEN,=C'N'                         
         MVI   SKIPSPEC,C'Y'                                                    
         GOTO1 APRNT                                                            
TS4      DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFFC,SORTREC                              
*                                                                               
TSX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'PRNT - PRINT CONTROL MODULE'                                    
*                                                                               
PRNT     CSECT                                                                  
         NMOD1 0,PRNT                                                           
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVC   SAVMODE,MODE                                                     
         MVI   MODE,0              LET REPORT DO ALL LEVELS OF HEADS            
         CLI   RCSUBPRG,100        SPECIAL TO GET CATEGORY HEADS                
         BNE   PRNT4               AND NOT RPINT ANYTHING                       
*                                                                               
         MVC   MIDHOOK,ABILHEAD                                                 
         XC    HEADHOOK,HEADHOOK                                                
         MVI   FORCEHED,C'N'                                                    
         MVI   LINE,0                                                           
         MVI   FORCEMID,C'Y'                                                    
*                                  CLEAR ALL P'S                                
         LA    R1,P1                                                            
         LA    R0,14                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         GOTO1 REPORT                                                           
         MVI   RCSUBPRG,0                                                       
         XC    MIDHOOK,MIDHOOK                                                  
         B     PRNTX                                                            
         SPACE 2                                                                
PRNT4    DS    0H                                                               
         MVI   RCSUBPRG,20                                                      
         L     RF,ADAGY                                                         
         CLI   PAGYPROF+14-PAGYREC(RF),C'0'                                     
         BNE   *+8                                                              
         MVI   RCSUBPRG,22              NET LESS CD COLUMN                      
         CLI   AORSW,X'03'              SEE IF DOING AOR REGISTER               
         BNE   PRNT4A                                                           
         ZIC   RF,RCSUBPRG                                                      
         LA    RF,1(RF)                                                         
         STC   RF,RCSUBPRG                                                      
PRNT4A   DS    0H                                                               
*                                                                               
         CLI   SAVMODE,RUNLAST                                                  
         BE    PRNT4B                                                           
         MVI   RCSUBPRG,10                                                      
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+8                                                              
         MVI   RCSUBPRG,30                                                      
*                                                                               
PRNT4B   MVC   HEADHOOK,ABILHEAD                                                
         CLI   PRSW,C'C'           CLEAR LINES                                  
         BE    PRNT24                                                           
         CLI   SORTTRCE,C'Y'                                                    
         BE    PRNT5                                                            
         CLI   PRSW,C'N'                                                        
         BNE   PRNT8                                                            
PRNT5    DS    0H                                                               
         GOTO1 REPORT                                                           
         B     PRNTX                                                            
*                                                                               
PRNT8    DS    0H                                                               
         CLI   PRSW,C'F'                                                        
         BE    PRNT20                                                           
*                                  HOLD PRINT LINES                             
         CLI   PRSW,C'M'           TEST 'MERGE UP'                              
         BNE   PRNT8W                                                           
*                                                                               
         CLC   P2,SPACES           MUST BE SINGLE LINE                          
         BNE   PRNT8W                                                           
         CLC   P1(21),SPACES        BLANK IN DESC                               
         BNE   PRNT8W                                                           
         CLC   P1,SPACES            NON-SPACES                                  
         BE    PRNT8W                                                           
*                                                                               
         SR    R4,R4                                                            
         L     R2,ANXTLIN                                                       
PRNT8F   DS    0H                                                               
         SH    R2,=H'132'                                                       
         C     R2,ALINTAB          BEFORE START                                 
         BL    PRNT8M                                                           
         CLC   21(111,R2),SPACES   LOLUMNS CLEAR                                
         BNE   PRNT8M                                                           
         CLC   0(21,R2),SPACES     DESC NOT CLEAR                               
         BE    PRNT8M                                                           
*                                                                               
         LR    R4,R2               SAVE A(LINE)                                 
         B     PRNT8F                                                           
PRNT8M   DS    0H                                                               
         LTR   R4,R4               NO LINE IS OK FOR MERGE                      
         BZ    PRNT8W                                                           
*                                                                               
         MVC   21(111,R4),P1+21     MERGE LINES                                 
         MVC   P1,SPACES                                                        
         CLI   SPACING,1                                                        
         BNH   PRNTX                                                            
         L     R2,ANXTLIN          MULT SPACING AFTER MERGE                     
         B     PRNT10                                                           
         B     PRNTX                                                            
*                                                                               
PRNT8W   DS    0H                                                               
         LA    R0,14                                                            
         L     R2,ANXTLIN                                                       
         LA    R4,P1                                                            
PRNT9    DS    0H                                                               
         CLC   0(132,R4),SPACES                                                 
         BE    PRNT10                                                           
         MVC   0(132,R2),0(R4)                                                  
         MVC   0(132,R4),SPACES    CLEAR LINE                                   
         LA    R2,132(R2)                                                       
         LA    R4,132(R4)                                                       
         BCT   R0,PRNT9                                                         
PRNT10   DS    0H                  ADJUST FOR SPACING                           
         CLI   SPACING,2                                                        
         BL    PRNT11                                                           
         ZIC   R0,SPACING                                                       
         BCTR  R0,R0                                                            
         MVI   0(R2),0                                                          
         LA    R2,132(R2)                                                       
         BCT   R0,*-8                                                           
PRNT11   DS    0H                                                               
         ST    R2,ANXTLIN                                                       
         MVI   SPACING,1                                                        
         B     PRNTX                                                            
*                                                                               
*                                  FLUSH PRINT LINES                            
*                                                                               
PRNT20   DS    0H                                                               
         MVI   PRSW,C'N'                                                        
         CLC   ANXTLIN,ALINTAB                                                  
         BE    PRNTX                                                            
*                                  FIRST COUNT LINES                            
         L     R5,ANXTLIN                                                       
         S     R5,ALINTAB                                                       
         SR    R4,R4                                                            
         D     R4,=F'132'                                                       
         CH    R5,=H'25'           NOT MUCH POINT IS REQUIRING                  
         BNH   *+8                 MORE THAN 25 LINES                           
         LA    R5,25                                                            
         STC   R5,ALLOWLIN         NUMBER OF LINES                              
*                                                                               
         L     R2,ALINTAB                                                       
PRNT22   DS    0H                                                               
         MVC   P1,0(R2)                                                         
         GOTO1 REPORT                                                           
         LA    R2,132(R2)                                                       
         C     R2,ANXTLIN                                                       
         BL    PRNT22                                                           
*                                                                               
PRNT24   DS    0H                                                               
         MVC   ANXTLIN,ALINTAB                                                  
         L     RF,ALINTAB                                                       
         LA    R0,LINTABN                                                       
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
*                                                                               
PRNTX    DS    0H                                                               
         MVC   MODE,SAVMODE                                                     
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'BILHEAD - HEADLINE ROUTINES  (HEADHOOK)'                        
         SPACE 2                                                                
BILHEAD  CSECT                                                                  
         NMOD1 0,BILHEAD                                                        
         LM    R9,RA,SAVREGS                                                    
         LA    RC,SPACEND                                                       
         B     BH1                                                              
*                                                                               
SAVREGS  DS    3F                                                               
*                                                                               
BH1      DS    0H                                                               
         SPACE 2                                                                
         CLI   RCSUBPRG,100        SPECIAL TO SAVE HEADS                        
**NEW 10/27/89                                                                  
         BNE   BH1B                                                             
         GOTO1 ABH50                                                            
         B     BHX                                                              
**NEW 10/27/89                                                                  
BH1B     CLI   RCSUBPRG,20         INVOICE REGISTER                             
         BE    BH80                                                             
         CLI   RCSUBPRG,21         INVOICE REGISTER                             
         BE    BH80                                                             
         CLI   RCSUBPRG,22         INVOICE REGISTER                             
         BE    BH80                                                             
         CLI   RCSUBPRG,23         INVOICE REGISTER                             
         BE    BH80                                                             
*                                  NORMAL HEADLINE ROUTINE                      
         CLI   AGMFORMS,C'D'       DDS+ PAPER                                   
         BE    BH1F                                                             
         CLI   AGMFORMS,C'A'       AGY ADDR ON AGY PAPER (HEAD1)                
         BNE   BH1D                                                             
*                                                                               
         MVC   HEAD1+27(33),AGYADR                                              
         B     BH1G                                                             
*                                                                               
**NEW 4/18/90                                                                   
BH1D     CLI   AGMFORMS,C'B'       AGY ADDR ON AGY PAPER  (HEAD3)               
         BNE   BH2                                                              
*                                                                               
         MVC   HEAD3+27(33),AGYADR                                              
         OC    HEAD3,SPACES                                                     
         GOTO1 ACENTER,DMCB,HEAD3+27,33                                         
         B     BH2                                                              
**NEW 4/18/90                                                                   
*                                                                               
BH1F     DS    0H                                                               
         MVC   HEAD1+27(33),AGYNM                                               
         MVC   HEAD2+27(33),AGYADR                                              
         OC    HEAD2,SPACES                                                     
         GOTO1 ACENTER,DMCB,HEAD2+27,33                                         
BH1G     DS    0H                                                               
         OC    HEAD1,SPACES                                                     
         GOTO1 ACENTER,DMCB,HEAD1+27,33                                         
*                                                                               
BH2      DS    0H                                                               
         CLI   SKIPSPEC,C'Y'                                                    
         BE    BHX                                                              
*                                                                               
         LA    R4,HEAD5            START WITH HEAD5                             
         CLI   AGMFORMS,C'L'     LONG LOGO' FORMS                               
         BE    BH2C                                                             
         CLI   AGMFORMS,C'B'    'LONG LOGO' FORMS (ADDRESS IN HEAD3)            
         BE    BH2C                                                             
         LA    R4,HEAD4          ELSE USE HEAD4                                 
*                                                                               
BH2C     DS    0H                                                               
***E***                                                                         
***E***  CLC   QPROG,=C'E1'        FOR ESTIMATE - CALL RUN ON                   
***E***  BNE   BH3                                                              
***E***  MVC   0(6,R4),=C'RUN ON'                                               
***E***  MVC   8(8,R4),PINVDTE    INVOICE DATE                                  
***E***  B     BH4B                NO INVOICE NUMBER                            
***E***                                                                         
*                                                                               
BH3      DS    0H                                                               
         L     R3,=V(DICSECT)                                                   
         USING DICSECT,R3                                                       
*                                                                               
         CLI   DOCOPT,C'Y'  SEE IF REALLY BILLING THRU PROD                     
         BNE   BH3D                                                             
*--->    MVC   0(13,R4),=C'DOCUMENT DATE'                                       
         MVC   0(L'PP@DOCDT,R4),PP@DOCDT                                        
         MVC   14(8,R4),PINVDTE    INVOICE DATE                                 
         B     BH3F                                                             
*                                                                               
BH3D     DS    0H                                                               
*--->    MVC   0(12,R4),=C'INVOICE DATE'                                        
         MVC   0(L'PP@INVDT,R4),PP@INVDT                                        
         MVC   14(8,R4),PINVDTE    INVOICE DATE                                 
BH3F     CLI   PDUEDTE,C' '                                                     
         BE    BH4                                                              
*--->    MVC   132(8,R4),=C'DUE DATE'                                           
         MVC   132(L'PP@DUEDT,R4),PP@DUEDT                                      
         MVC   132+14(8,R4),PDUEDTE    DUE DATE                                 
BH4      DS    0H                                                               
*                                                                               
***E***                                                                         
***E***  CLC   QPROG,=C'E1'        NO INV. NO. FOR ESTIMATE                     
***E***  BE    BH4B                                                             
***E***                                                                         
         CLI   CORPZ,C'Y'          TEST CORP RETAIL NOT AN INVOICE              
         BNE   BH4A                                                             
*--->    MVC   62(11,R4),=C'CONTROL NO.'                                        
         MVC   62(L'PP@CTRLN,R4),PP@CTRLN                                       
         B     BH4B                                                             
BH4A     DS    0H                                                               
*--->    MVC   66(7,R4),=C'INVOICE'                                             
         MVC   66(L'PP@INVOC,R4),PP@INVOC                                       
         CLI   DOCOPT,C'Y'  SEE IF REALLY BILLING THRU PROD                     
         BNE   BH4B                                                             
*--->    MVC   61(12,R4),=C'DOCUMENT NO.'                                       
         MVC   61(L'PP@DOCNO,R4),PP@DOCNO                                       
*                                                                               
BH4B     DS    0H                                                               
*--->    MVC   132+75(4,R4),=C'PAGE'                                            
         MVC   132+75(L'PP@PAGE,R4),PP@PAGE                                     
         LA    R6,132+80(R4)                                                    
         EDIT  (B2,PAGE),(3,0(R6))                                              
***                                                                             
         CLI   RCMULTIQ,C'Y'          SEE IF DOING MULTI-MEDIA REQ              
         BNE   BH4B2                  YES - DON'T SHOW MEDIA IN HEADS           
*--->    MVC   38(13,R4),=C'MEDIA BILLING'                                      
         MVC   38(L'PP@MEDBL,R4),PP@MEDBL                                       
         LA    RF,38(R4)              MUST SET RF FOR BH4B4                     
***E***                                                                         
***E***  CLC   QPROG,=C'E1'           SEE IF ESTIMATE                           
***E***  BNE   BH4B1                                                            
***E***  MVC   38(14,R4),=C'MEDIA ESTIMATE'                                     
***E***  B     BH4B4                                                            
***E***                                                                         
***R***                                                                         
BH4B1    CLC   QPROG,=C'R1'         REBATE BILLING                              
         BE    BH4B1C                                                           
         CLC   QPROG,=C'RD'         REBATE BILLING - DRAFT                      
         BNE   BH4B4                                                            
*--->    MVC   30(29,R4),=C'MEDIA CONTRACT REBATE BILLING'                      
BH4B1C   MVC   30(L'PP@MED02,R4),PP@MED02                                       
         LA    RF,35(R4)           MUST SET R4 FOR BH4B4                        
         B     BH4B4                                                            
***R***                                                                         
*                                                                               
BH4B2    DS    0H                                                               
         CLI   RCLANG,4            SPECIAL CODE FOR FRENCH                      
         BNE   BH4B2E                                                           
         MVC   30(L'PP@MEDBL,R4),PP@MEDBL                                       
         LA    RF,L'PP@MEDBL+30(R4)                                             
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(10,RF),MEDNM                                                   
         B     BH4B3                                                            
*                                                                               
BH4B2E   MVC   30(10,R4),MEDNM                                                  
         LA    RF,40(R4)                                                        
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
*--->    MVC   2(13,RF),=C'MEDIA BILLING'                                       
         MVC   2(L'PP@MEDBL,RF),PP@MEDBL                                        
***E***                                                                         
***E***  CLC   QPROG,=C'E1'           SEE IF ESTIMATE                           
***E***  BNE   BH4B3                                                            
***E***  MVC   2(14,RF),=C'MEDIA ESTIMATE'                                      
***E***  B     BH4B4                                                            
***E***                                                                         
***R***                                                                         
BH4B3    CLC   QPROG,=C'R1'           REBATE                                    
         BE    BH4B3C                                                           
         CLC   QPROG,=C'RD'           REBATE  - DRAFT                           
         BNE   BH4B4                                                            
BH4B3C   MVC   28(10,R4),MEDNM                                                  
         MVI   38(R4),C' '                                                      
         LA    RF,38(R4)                                                        
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
*--->    MVC   2(23,RF),=C'CONTRACT REBATE BILLING'                             
         MVC   2(L'PP@CRB,RF),PP@CRB                                            
***R***                                                                         
BH4B4    CLI   PASSNO,2                                                         
         BNE   BH5                                                              
         CLI   DUESW,C'A'          SEE IF DOING ADJSEP NOW                      
         BE    BH5                                                              
         CLI   DUESW,C'R'          OR AOR                                       
         BE    BH5                                                              
         CLI   DUESW,C'C'          OR CD SEP INV                                
         BE    BH5                                                              
         LA    R0,32-14(R4)                                                     
         SR    RF,R0               RF = LENGTH OF TITLE                         
         LA    RE,132+32(R4)                                                    
         SH    RF,=H'20'                                                        
         BNP   BH4D                                                             
         SRL   RF,1                                                             
         AR    RE,RF                                                            
BH4D     DS    0H                                                               
*--->    MVC   0(20,RE),=C'** DETAIL BACK-UP **'                                
         MVC   0(L'PP@DTLBK,RE),PP@DTLBK                                        
         CLI   AGMTITL,C'I'                                                     
         BNE   *+10                                                             
*--->    MVC   0(21,RE),=C'** INVOICE BACK-UP **'                               
         MVC   0(L'PP@INVBK,RE),PP@INVBK                                        
***E***                                                                         
***E***  CLC   QPROG,=C'E1'       NO INV NO. FOR ESTIMATE                       
***E***  BNE   BH5                                                              
***E***  MVC   0(22,RE),=C'** ESTIMATE BACK-UP **'                              
***E***  B     BH5D                                                             
*                                                                               
***E***                                                                         
BH5      DS    0H                                                               
**NEW 3/11/91                                                                   
         CLI   DUESW,C'R'           SEE IF DOING AOR BILL                       
         BNE   BH5A                                                             
         CLI   DOCOPT,C'Y'           SEE IF DOCUMENT                            
         BE    BH5A                  DON'T CLOBBER WITH *AOR*                   
         MVI   61(R4),C'*'                                                      
         MVC   62(3,R4),PP@AOR       MUST BE 3 CHARS                            
         MVI   65(R4),C'*'                                                      
BH5A     DS    0H                                                               
**NEW 3/11/91                                                                   
***E***                                                                         
***E***  CLC   QPROG,=C'E1'         NO INV. NUMBER FOR ESTIMATES                
***E***  BE    BH5D                                                             
***E***                                                                         
         MVC   74(10,R4),PINVNO                                                 
BH5D     CLI   TEST,C'T'                                                        
         BNE   BH5E                                                             
***E***                                                                         
***E***  CLC   QPROG,=C'E1'            NO MESSAGE ON ESTIMATES                  
***E***  BE    BH5E                                                             
***E***                                                                         
*--->    MVC   132+58(16,R4),=C'**TEST BILLING**'                               
         MVC   132+58(L'PP@TSTBL,R4),PP@TSTBL                                   
         CLC   QPROG,=C'D1'                                                     
         BNE   *+10                                                             
*--->    MVC   132+57(17,R4),=C'**DRAFT BILLING**'                              
         MVC   132+57(L'PP@DRFBL,R4),PP@DRFBL                                   
         CLC   QPROG,=C'RD'       REBATE DRAFT                                  
         BNE   *+10                                                             
*--->    MVC   132+57(17,R4),=C'**DRAFT BILLING**'                              
         MVC   132+57(L'PP@DRFBL,R4),PP@DRFBL                                   
*                                                                               
*                                  BILLING ADDR                                 
BH5E     L     RF,AAADDRS          USE AAA ADDR                                 
         CLC   APRDBRK,AINVBRK     IF MULTI-PROD BILL                           
         BH    BH5E5                                                            
         L     RF,ABADDRS          SET TO BRAND ADDRESS                         
*                                                                               
         CLI   PROGPRO2+14,C'Y'    CHECK FOR AAA ADDRESS OPTION                 
         BNE   BH5E5                                                            
         L     RF,AAADDRS          USE AAA ADDRESS                              
         L     RE,ABADDRS          UNLESS I HAVE A BRAND ADDRESS                
         CLC   0(10,RE),SPACES                                                  
         BE    BH5E5                                                            
         L     RF,ABADDRS          USE IT                                       
*                                                                               
BH5E5    CLI   DUESW,C'R'          OR AOR BILL                                  
         BNE   BH5F                                                             
         L     RF,AAORADDR       NOTE : USE AOR ADDRESS                         
         B     BH5FX                                                            
*                                                                               
BH5F     DS    0H                                                               
         CLI   JOBCTL,C'S'              SEE IF JOB ON SEPERATE INVS             
         BNE   BH5FX                                                            
         L     RE,AJADDRS               SEE IF I HAVE A JOB-REP ADDR            
         CLC   0(20,RE),SPACES                                                  
         BE    BH5FX                                                            
         L     RF,AJADDRS               USE IT                                  
*                                                                               
*                            NOTE -     IF MULTI-PRD BILL                       
*                                       AOR ADDRESS WILL BE FROM LAST           
*                                       PRODUCT                                 
**NEW 10/17/89                          UNLESS DOING AOR DETAILS                
*                                                                               
BH5FX    DS    0H                                                               
         MVC   HEAD7+46(36),00(RF)                                              
         MVC   HEAD8+46(36),36(RF)                                              
         MVC   HEAD9+46(36),72(RF)                                              
         MVC   HEAD10+46(36),108(RF)                                            
         MVC   HEAD11+46(36),144(RF)      PRINT ONLY USES 4 LINES               
*                                                                               
         LA    R4,HEAD11+46                                                     
         CLC   0(36,R4),SPACES                                                  
         BE    *+8                                                              
         LA    R4,HEAD12+46                                                     
         CLI   QOPT3,C'C'                                                       
         BNE   BH5G                                                             
*--->    MVC   0(32,R4),=C'** CASH DISCOUNT VENDORS ONLY **'                    
         MVC   0(L'PP@CDVO,R4),PP@CDVO                                          
         B     BH5I                                                             
BH5G     CLI   QOPT3,C'N'                                                       
         BNE   BH5I                                                             
*--->    MVC   0(36,R4),=C'** NON-CASH DISCOUNT VENDORS ONLY **'                
         MVC   0(L'PP@NCDVO,R4),PP@NCDVO                                        
*                                                                               
BH5I     CLI   QOPT1,C'C'                                                       
         BNE   BH5K                                                             
         MVC   0(36,R4),SPACES                                                  
*--->    MVC   0(30,R4),=C'** CASH DISCOUNT ITEMS ONLY **'                      
         MVC   0(L'PP@CDIO,R4),PP@CDIO                                          
         CLI   QOPT3,C'C'                                                       
         BNE   BH5I5                                                            
*--->    MVC   0(31,R4),=C'** CD VENDORS AND ITEMS ONLY **'                     
         MVC   0(L'PP@CDVIO,R4),PP@CDVIO                                        
         B     BH5X                                                             
BH5I5    CLI   QOPT3,C'N'                                                       
         BNE   BH5X                                                             
*--->    MVC   0(33,R4),=C'** NON-CD VENDORS CD ITEMS ONLY**'                   
         MVC   0(L'PP@NCDVC,R4),PP@NCDVC                                        
         B     BH5X                                                             
*                                                                               
BH5K     CLI   QOPT1,C'N'                                                       
         BNE   BH5X                                                             
         MVC   0(36,R4),SPACES                                                  
*--->    MVC   0(34,R4),=C'** NON-CASH DISCOUNT ITEMS ONLY **'                  
         MVC   0(L'PP@NCDIO,R4),PP@NCDIO                                        
         CLI   QOPT3,C'C'                                                       
         BNE   BH5K5                                                            
*--->    MVC   0(39,R4),=C'** CD VENDORS WITH NON-CD ITEMS ONLY **'             
         MVC   0(L'PP@CDVNC,R4),PP@CDVNC                                        
         B     BH5X                                                             
BH5K5    CLI   QOPT3,C'N'                                                       
         BNE   BH5X                                                             
*--->    MVC   0(38,R4),=C'** NON-CD VENDORS NON-CD ITEMS ONLY **'              
         MVC   0(L'PP@NCDVN,R4),PP@NCDVN                                        
         B     BH5X                                                             
BH5X     DS    0H                                                               
*                                       PUT CATEGORY HEADS SAVED                
*                                       INTO REAL HEADLINES                     
         LA    R4,HEAD8                                                         
         LA    R0,6                                                             
         CLI   AGMFORMS,C'L'  'LONG LOGO' FORMS                                 
         BE    BH5X5                                                            
         CLI   AGMFORMS,C'B'  'LONG LOGO' FORMS WITH ADDRESS HEAD3              
         BE    BH5X5                                                            
         LA    R4,HEAD7                                                         
         LA    R0,7                                                             
*                                                                               
BH5X5    L     R5,AMYHEADS                                                      
**NEW 10/17/89                                                                  
         CLI   DUESW,C'R'           AOR BILL                                    
         BNE   BH6                                                              
         CLI   AORLOPT,C'N'         SEE IF DOING DETAILS                        
         BE    BH6                                                              
**NEW 3/11/91     ABOVE INSTRUCTIONS WERE C'Y' AND BNE                          
         LA    R0,1                                                             
         MVI   45(R5),C' '           THEN ONLY SHOW CLIENT                      
**NEW 10/17/89                                                                  
BH6      DS    0H                                                               
         MVC   0(45,R4),0(R5)                                                   
         LA    R4,132(R4)                                                       
         LA    R5,45(R5)                                                        
         BCT   R0,BH6                                                           
         CLI   0(R5),C' '                                                       
         BNH   *+6                                                              
         DC    H'0'                TOO MANY HEADLINES                           
*                                                                               
         CLI   HEAD13,C' '                                                      
         BNE   *+8                                                              
         MVI   HEAD13,0            ENSURE 13 HEADS                              
*                                                                               
         SPACE 3                                                                
         LA    R2,MID1             USE MID LINES FOR COL HEADS                  
         USING ALINED,R2                                                        
         MVI   MID1+131,0              NO COL HEADS ON ADJ BILL                 
         MVI   MID2+131,0                                                       
         CLI   DUESW,C'A'          ADJ INV                                      
         BE    BH40                                                             
         CLI   DUESW,C'R'          OR AOR                                       
         BE    BH39X                                                            
         CLI   DUESW,C'C'          OR CD INV                                    
         BE    BH40                                                             
         CLI   UPASS,C'S'                                                       
         BNE   BH7                                                              
*                                  RETAIL SUMMARY FORMAT                        
*                                                                               
         MVC   INVWD1+5(L'PP@CNTRL),PP@CNTRL                                    
         MVC   ALCOL3,INVWD1                                                    
         MVC   INVWD2+6(L'PP@NUM),PP@NUM                                        
         MVC   ALCOL3+132,INVWD2                                                
         MVC   BAMTWD,PP@BLAMT                                                  
         MVC   ALCOL4+132,BAMTWD                                                
*                                                                               
         B     BH20                                                             
*                                                                               
BH7      DS    0H                                                               
         CLI   FMTSW,C'D'          INSERTION DETAILS                            
         BNE   BH8                                                              
         OC    ARECAP,ARECAP       SEE IF DOING RECAP                           
         BNZ   BH7B                                                             
         CLI   NOINSSW,C'Y'       SEE IF SUPPRESSING INS DETAIL                 
         BE    BH8                ON MAIN BILL                                  
*                                  ***************************                  
*                                  FMTSW  D - INSERTION DETAILS                 
BH7B     MVI   MID1+0,0                                                         
         CLI   RCMULTIQ,C'Y'       SEE IF MULTI-MEDIA REQ                       
         BE    BH7D                                                             
*--->    MVC   MID1+0(6),=C'INSERT'                                             
         MVC   MID1+0(L'PP@INSRT),PP@INSRT                                      
         CLI   QMEDIA,C'O'                                                      
         BNE   *+10                                                             
*--->    MVC   MID1+0(7),=C'POSTING'                                            
         MVC   MID1+0(L'PP@POST),PP@POST                                        
BH7D     DS    0H                                                               
*--->    MVC   MID2+0(4),=C'DATE'                                               
         MVC   MID2+0(L'PP@DATE),PP@DATE                                        
*--->    MVC   MID2+12(5),=C'SPACE'                                             
         MVC   MID2+12(L'PP@SPACE),PP@SPACE                                     
*                                                                               
BH7F     DS    0H                                                               
         CLI   RCLANG,4            SEE IF FRENCH                                
         BNE   BH8                 NO                                           
         CLI   QMEDIA,C'O'         SEE IF OUTDOOR                               
         BE    BH8                 YES                                          
         CLI   RCMULTIQ,C'Y'       SEE IF MULTI-MEDIA REQ                       
         BE    BH8                 YES                                          
*                                                                               
*        SPECIAL CODE TO ALTER "INSERT DATE"                                    
*        TO "DATE D'INSERTN"                                                    
*                                                                               
         MVC   MID1+0(L'PP@INSRT),SPACES                                        
         MVC   MID1+0(L'PP@DATE),PP@DATE                                        
         MVC   MID2+0(9),=C'D''INSERTN'                                         
*                                                                               
BH8      DS    0H                                                               
*                                  MONTH OF SERVICE                             
BH20     DS    0H                                                               
         CLI   PERCTL,C'T'                                                      
         BNE   BH22                                                             
         CLI   NOPMBRK,C'Y'        NO PERIOD BREAKOUT                           
         BE    BH22                                                             
*                                                                               
         CLI   FMTSW,C'D'          NO BILL PER HEADLINE FOR                     
         BE    BH22                BUY  DETAIL FORMAT                           
         CLC   QPROG,=C'E1'        SEE IF ESTIMATE                              
         BNE   BH21                                                             
*--->    MVC   MID1+11(6),=C'PERIOD'                                            
         MVC   MID1+11(L'PP@PERD),PP@PERD                                       
         B     BH22                                                             
*                                                                               
BH21     LA    R4,MID1+11                                                       
*--->    MVC   0(7,R4),=C'BILLING'                                              
         MVC   0(L'PP@BLNG,R4),PP@BLNG                                          
*--->    MVC   132(6,R4),=C'PERIOD'                                             
         MVC   132(L'PP@PERD,R4),PP@PERD                                        
*                                  PUB                                          
BH22     DS    0H                                                               
****                                                                            
         B     BH24                BYPASS THIS CODE FOR NOW                     
******                                                                          
         CLI   PUBCTL,C'T'                                                      
         BNE   BH24                                                             
         CLC   APUBBRK,ALOWTOG                                                  
         BH    BH24                                                             
         CLI   PERCTL,C'T'                                                      
         BE    BH22B                                                            
*                                  SINGLE MOS                                   
         LA    R4,MID2+8                                                        
         B     BH22D                                                            
*                                  MULTI MOS                                    
BH22B    DS    0H                                                               
         LA    R4,MID2+8                                                        
         CLI   FMTSW,C'D'          INSERTION DETAILS                            
         BE    BH22D                                                            
         LA    R4,MID2+0                                                        
*                                                                               
BH22D    DS    0H                                                               
*--->    MVC   0(3,R4),=C'PUB'                                                  
         MVC   0(L'PP@PUB,R4),PP@PUB                                            
*                                  MARKET                                       
BH24     DS    0H                                                               
         CLI   PRDMKT,C'M'         SKIP IF MKT HIGHER THAN PRD                  
         BE    BH26                                                             
         CLC   AMKTBRK,APAGBRK     ONLY IF TOGETHER ON PAGE                     
         BNH   BH26                                                             
         CLC   AMKTBRK,ALOWTOG                                                  
         BH    BH26                                                             
         CLC   MID2(6),SPACES                                                   
         BE    BH24B                                                            
*--->    MVC   MID1(7),=C'MARKET/'                                              
         MVC   MID1(L'PP6MARKT),PP6MARKT                                        
         MVI   MID1+L'PP6MARKT,C'/'                                             
         B     BH26                                                             
BH24B    DS    0H                                                               
*--->    MVC   MID2(6),=C'MARKET'                                               
         MVC   MID2(L'PP6MARKT),PP6MARKT                                        
*                                  ESTIMATE                                     
BH26     DS    0H                                                               
         CLC   ALOWTOG,AHITOG      TEST ONLY ONE TOGETHER                       
         BNE   BH30                                                             
*                                  YES - PRINT DESC HERE                        
         OC    ALOWTOG,ALOWTOG     IF ZERO THEN ONLY TOGETHER IS PER            
         BZ    BH30 SKIP                                                        
*                                                                               
         L     R0,ALOWTOG                                                       
*--->    LA    R6,=C'ESTIMATE    '                                              
         MVC   WORK(12),SPACES                                                  
         MVC   WORK(L'PP@EST),PP@EST                                            
         LA    R6,WORK                                                          
         C     R0,AESTBRK                                                       
         BE    BH28                                                             
*--->    LA    R6,=C'PRODUCT     '                                              
         MVC   WORK(12),SPACES                                                  
         MVC   WORK(L'PP@PRO),PP@PRO                                            
         LA    R6,WORK                                                          
         C     R0,APRDBRK                                                       
         BE    BH28                                                             
         LA    R6,MGR1BK                                                        
         C     R0,AMGR1BRK                                                      
         BE    BH28                                                             
         LA    R6,MGR2BK                                                        
         C     R0,AMGR2BRK                                                      
         BE    BH28                                                             
         LA    R6,MGR3BK                                                        
         C     R0,AMGR3BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR1BK                                                        
         C     R0,APGR1BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR2BK                                                        
         C     R0,APGR2BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR3BK                                                        
         C     R0,APGR3BRK                                                      
         BE    BH28                                                             
         B     BH30                                                             
*                                                                               
BH28     DS    0H                                                               
         CLC   MID2(14),SPACES                                                  
         BNE   BH28A                                                            
         MVC   MID2(12),0(R6)                                                   
         B     BH29C                                                            
BH28A    DS    0H                                                               
         CLC   10(2,R6),SPACES                                                  
         BNE   BH28B                                                            
         MVC   MID2(10),0(R6)                                                   
         B     BH29C                                                            
BH28B    DS    0H                                                               
         GOTO1 ACHOPPER,DMCB,(12,0(R6)),(10,MID1),(C'P',2)                      
BH29C    DS    0H                                                               
*                                                                               
BH30     DS    0H                                                               
         CLI   UPASS,C'S'          SEE IF DOING RETAIL SUMMARY PASS             
         BE    BH40                YES - SKIP                                   
*                                                                               
         CLI   RETPROF+13,C'N'     SEE IF SKIPPING DETAILS ON DISTRIB           
         BE    BH30C               BILL - NO-SHOW CATS                          
         CLI   RETPROF+13,0        SEE IF SKIPPING DETAILS ON DISTRIB           
         BE    BH30C               BILL - NO-SHOW CATS                          
         CLI   UPASS,1             SEE IF CORP                                  
         BE    BH30C                                                            
         CLI   RETPROF+13,C'I'     SEE IF NO INS $                              
         BE    BH40                IF SO - THEN SKIP CATS                       
         CLI   RETPROF+13,C'B'     SEE IF NO INS $                              
         BE    BH40                IF SO - THEN SKIP CATS                       
*                                                                               
         CLI   PGR1CTL,C'T'        SEE IF DIV/PRD/EST                           
         BE    BH30C               IS TOGETHER - IF SO MUST SHOW CATS           
         CLI   PRDCTL,C'T'                                                      
         BE    BH30C                                                            
         CLI   ESTCTL,C'T'                                                      
         BE    BH30C                                                            
         CLI   MKTCTL,0          FIRST CHK FOR X'00'                            
         BE    BH30A                                                            
         CLI   MKTCTL,C'N'       IF MKT/JOB/PUB IS SHOWN                        
         BNE   BH30C             MUST SHOW CATS                                 
BH30A    CLI   JOBCTL,0          FIRST CHECK FOR X'00'                          
         BE    BH30B                                                            
         CLI   JOBCTL,C'N'                                                      
         BNE   BH30C                                                            
BH30B    CLI   PUBCTL,C'N'                                                      
         BNE   BH30C                                                            
         B     BH40                DISTRIBUTOR BILL - SKIP                      
*                                                                               
BH30C    L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
         MVC   TYPNAMES,PP@ORD                                                  
         MVC   TYPRVBD,PP@PRV04                                                 
         MVC   TYBILLA,PP@BILLA                                                 
*                                                                               
         MVC   CATNAMES(L'PPRGROSS),PPRGROSS                                    
         MVC   CATNET(L'PPRNET),PPRNET                                          
         MVC   CATCDISC(L'PP@CDISC),PP@CDISC                                    
         MVC   CATGRSLC(L'PPRGRSLC),PPRGRSLC                                    
         MVC   CATNETCD(L'PPRNETCD),PPRNETCD                                    
         MVC   CATAGYCM(L'PPAAGYCM),PPAAGYCM                                    
         DROP  RE                                                               
*              SEE IF DOING ONE DOL CAT                                         
         MVC   HFORMAT,FORMAT    SAVE FORMAT                                    
         MVC   HTYPES,ORDSW     SAVE TYPES                                      
         CLI   DOLNUM,1                                                         
         BNE   BH33                                                             
         CLI   TYPNUM,1                                                         
         BNE   BH33                                                             
         LA    R4,MID1+(ALCOL4-ALINE-2)  ONE COL - PUT IN LAST                  
         BAS   RE,GETCAT                                                        
         MVC   0(16,R4),WORK                                                    
         BAS   RE,GETTYP                                                        
         MVC   132(16,R4),WORK                                                  
         B     BH39                GO DO STRIP-OFF                              
*                                                                               
BH33     CLI   DOLNUM,1            SEE IF ONE CAT AND MULTIPLE TYPES            
         BNE   BH34                                                             
*                                  IF SHOWING INVOICE DETAILS AT INS            
*                                  LEVEL MUST USE GRID FORMAT EVEN              
*                                  FOR ONE CATEGORY                             
*                                                                               
         IF    FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'I',BH34                            
         IF    FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'B',BH34                            
         IF    FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'D',BH34                            
         ZIC   R2,TYPNUM                                                        
         LA    R4,MID1+(ALCOL2-ALINE-2)                                         
         CLI   TYPNUM,3                                                         
         BE    *+8                                                              
         LA    R4,MID1+(ALCOL3-ALINE-2)                                         
         BAS   RE,GETCAT                                                        
         MVC   0(16,R4),WORK                                                    
BH33B    BAS   RE,GETTYP                                                        
         MVC   132(16,R4),WORK                                                  
         LA    R4,16(R4)                                                        
         BCT   R2,BH33B                                                         
         B     BH39                                                             
*                                                                               
BH34     CLI   TYPNUM,1            ONE TYPE AND MULTIPLE CATS                   
         BNE   BH36                                                             
         CLI   DOLNUM,5                                                         
         BNL   BH36                                                             
         LA    R4,MID1+(ALCOL1-ALINE-2)                                         
         CLI   DOLNUM,4                                                         
         BE    BH34A                                                            
         LA    R4,MID1+(ALCOL2-ALINE-2)                                         
         CLI   DOLNUM,3                                                         
         BE    BH34A                                                            
         LA    R4,MID1+(ALCOL3-ALINE-2)                                         
BH34A    ZIC   R6,DOLNUM                                                        
BH34B    BAS   RE,GETCAT                                                        
         MVC   0(16,R4),WORK                                                    
         MVC   HTYPES,ORDSW        MUST RESTORE TYPES                           
         BAS   RE,GETTYP           IF ONE TYPE - PUT UNDER CAT                  
         MVC   132(16,R4),WORK                                                  
BH34E    LA    R4,16(R4)                                                        
         BCT   R6,BH34B                                                         
         B     BH39                                                             
*                                                                               
*        MULTIPLE CATS AND TYPES MUST USE GRID                                  
*                                                                               
BH36     CLI   DOLNUM,3            SEE IF MORE THAN 3 CATS                      
         BH    BH38                                                             
         LA    R4,MID2+(ALCOL3-ALINE-2)  3 OR LESS CATS - ACROSS                
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R4,MID2+(ALCOL2-ALINE-2)                                         
         ZIC   R6,DOLNUM           TYPES DOWN                                   
BH36B    BAS   RE,GETCAT                                                        
         MVC   0(16,R4),WORK                                                    
         LA    R4,16(R4)                                                        
         BCT   R6,BH36B                                                         
         B     BH39                                                             
BH38     DS    0H                  4 OR MORE CATS - DOWN                        
         LA    R4,MID2+(ALCOL3-ALINE-2) TYPES ACROSS                            
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R4,MID2+(ALCOL2-ALINE-2)                                         
         ZIC   R6,TYPNUM                                                        
BH38B    BAS   RE,GETTYP                                                        
         MVC   0(16,R4),WORK                                                    
         LA    R4,16(R4)                                                        
         BCT   R6,BH38B                                                         
         B     BH39                                                             
*                                                                               
BH39     DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
         LA    R4,CATNAMES                                                      
         LA    R5,5                                                             
         LA    R6,CATTAB                                                        
BH39A    CLC   STRIP,0(R6)                                                      
         BE    BH39B                                                            
         LA    R6,1(R6)                                                         
         LA    R4,16(R4)                                                        
         BCT   R5,BH39A                                                         
         B     BH40                IF NOT IN TABLE SKIP STRIP                   
*                                                                               
BH39B    DS    0H                                                               
         CLI   RCLANG,4            SEE IF FRENCH                                
         BE    BH39D                                                            
         MVC   MID1+85(16),0(R4)                                                
*--->    MVC   MID2+94(7),=C'BILLING'                                           
         MVC   MID2+94(L'PP@BLNG),PP@BLNG                                       
         B     BH40                                                             
*                                                                               
BH39D    DS    0H                    FRENCH - PUT BILLING ON TOP                
*                                  90 SINCE FRENCH WORD IS 11 CHAR              
         MVC   MID1+90(L'PP@BLNG),PP@BLNG                                       
         MVC   MID2+85(16),0(R4)                                                
         B     BH40                                                             
*                                                                               
         DROP  RE                                                               
*                                                                               
GETCAT   NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
         LA    R4,HFORMAT                                                       
         LA    R5,6                FOR BCT                                      
         LA    R6,CATNAMES                                                      
GETC5    CLI   0(R4),C'Y'                                                       
         BE    GETC10                                                           
         LA    R4,1(R4)                                                         
         LA    R6,16(R6)                                                        
         BCT   R5,GETC5                                                         
         LA    R6,SPACES                                                        
         B     GETCX                                                            
*                                                                               
GETC10   MVC   WORK(16),0(R6)                                                   
         MVI   0(R4),C'N'          SET OFF IN HFORMAT                           
GETCX    XIT1                                                                   
*                                                                               
*                                                                               
GETTYP   NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
         LA    R4,HTYPES                                                        
         LA    R5,3                FOR BCT                                      
*                                                                               
         LA    R6,TYPNAMES                                                      
GETT5    CLI   0(R4),C'Y'                                                       
         BE    GETT10                                                           
         CLI   0(R4),C'D'          MEANS SHOW AT DETAIL LEVEL ONLY              
         BE    GETT10              SKIP $ BUT STILL SHOW ANNOTATION             
         LA    R4,1(R4)                                                         
         LA    R6,16(R6)                                                        
         BCT   R5,GETT5                                                         
         LA    R6,SPACES                                                        
         B     GETTX                                                            
*                                                                               
GETT10   MVC   WORK(16),0(R6)                                                   
**NEW 10/17/89                                                                  
         L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
         CLI   PAYOPT,C'G'         SEE IF CHANGING ORDERED TO CLEARED           
         BE    GETT10B                                                          
         CLI   PAYOPT,C'C'         SEE IF CHANGING ORDERED TO CLEARED           
         BNE   GETT15                                                           
*--->    CLC   WORK+9(7),=C'ORDERED'                                            
GETT10B  CLC   WORK+(16),PP@ORD                                                 
         BNE   GETT15                                                           
*--->    MVC   WORK+9(7),=C'CLEARED'                                            
         MVC   WORK+7(L'PP@CLEAR),PP@CLEAR                                      
GETT15   MVI   0(R4),C'N'          SET OFF IN HFORMAT                           
**NEW 10/17/89                                                                  
GETTX    XIT1                                                                   
*                                                                               
CATTAB   DC    C'GNC12'     1=G-CD,2=N-CD                                       
*                                                                               
**NEW 10/17/89                                                                  
*                                                                               
BH39X    DS    0H                  AOR BILLS                                    
         CLI   AORLOPT,C'N'        IF DOING AOR PRD/EST/MOS LIST                
         BE    BH40                NEED SPECIAL HEADS                           
*                                                                               
         L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
         LA    R2,MID1             USE MID LINES FOR COL HEADS                  
         USING ALINED,R2                                                        
*--->    MVC   ALCOL1(16),=C'      MONTH OF  '                                  
         MVC   ALCOL1+7(L'PP@MTHOF),PP@MTHOF                                    
         LA    R2,132(R2)                                                       
*--->    MVC   ALDESC(7),=C'PRODUCT'                                            
*--->    MVC   ALCOL1(16),=C' EST   SERVICE  '                                  
*--->    MVC   ALCOL2+2(12),=C'GROSS AMOUNT'                                    
*--->    MVC   ALCOL3(14),=C'  AOR%   BASIS'                                    
*--->    MVC   ALCOL4+2(12),=C'     AOR FEE'                                    
*--->    MVC   ALSTRIP+2(12),=C'BASIS AMOUNT'                                   
         MVC   ALDESC(L'PP@PRO),PP@PRO                                          
         MVC   ALCOL1(L'PP@ESTSV),PP@ESTSV                                      
         MVC   ALCOL2(L'PP@GRSAM),PP@GRSAM                                      
         MVC   ALCOL3(L'PP@AORBS),PP@AORBS                                      
         MVC   ALCOL4(L'PP@AORFE),PP@AORFE                                      
         MVC   ALSTRIP(L'PP@BASAM),PP@BASAM                                     
         B     BHX                 FOR AOR LIST, SKIP BILLING PERIOD            
         DROP  R2                                                               
         DROP  RE                                                               
**NEW 10/17/89                                                                  
*                                                                               
BH40     DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
         CLI   PERCTL,C'S'                                                      
         BNE   BHX                                                              
*                                                                               
BH42     CLI   PARTIAL,C'Y'                                                     
         BE    BH46                                                             
         L     RF,APER                                                          
         ZIC   R5,0(RF)                                                         
         SLL   R5,3                                                             
         LA    R5,PERLIST(R5)                                                   
*                                                                               
         LA    R4,HEAD13                                                        
*--->    MVC   54(8,R4),=C'MONTH OF'                                            
         MVC   54(L'PP@MTHOF,R4),PP@MTHOF                                       
         GOTO1 DATCON,DMCB,(3,0(R5)),(6,64(R4))   MMM/YY                        
         B     BHX                                                              
BH46     DS    0H                                                               
         CLI   HEAD12+46,C' '      COULD HAVE CD/NONCD MESSAGE                  
         BH    BH47                IF SO USE ONE LINE                           
         LA    R4,HEAD12                                                        
         LA    R6,132+46(R4)                                                    
         CLI   HEAD11+46,C' '      TEST LAST ADDRESS LINE USED                  
         BNH   *+12                                                             
BH47     LA    R4,HEAD13           YES - PRINT DATES ON ONE LINE                
         LA    R6,18(R4)                                                        
*--->    MVC   46(16,R4),=C'BILLING PERIOD -'                                   
         MVC   46(L'PP@BILPD,R4),PP@BILPD                                       
         CLC   QPROG,=C'E1'         SEE IF ESTIMATE                             
         BNE   *+10                                                             
         MVC   46(7,R4),SPACES         BLANK -OUT 'BILLING'                     
         GOTO1 DATCON,DMCB,QSTART,(5,0(R6))                                     
         GOTO1 (RF),(R1),QEND,(5,14(R6))                                        
         L     RE,=V(DICSECT)           MUST RESET RE                           
*--->    MVC   9(4,R6),=C'THRU'                                                 
         MVC   9(L'PP@THRU,R6),PP@THRU                                          
         B     BHX                                                              
         DROP  RE                                                               
         EJECT                                                                  
         SPACE 2                                                                
BH80     DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
         CLC   RCSVAGY,=C'DM'      DOREMUS - NO MEDIA IN REGISTER               
         BE    BHX                                                              
         CLC   RCSVAGY,=C'SJ'      OR SJR                                       
         BE    BHX                                                              
*--->    MVC   HEAD9(5),=C'MEDIA'                                               
         MVC   HEAD9(L'PP@MED),PP@MED                                           
         MVC   HEAD9+9(1),MED                                                   
         MVC   HEAD9+13(10),MEDNM                                               
         SPACE 2                                                                
BHX      DS    0H                                                               
         DROP  R3                                                               
         XIT1                                                                   
         DROP  RE                                                               
         SPACE 3                                                                
*                                                                               
INVWD1   DC    C'       CONTROL  '                                              
INVWD2   DC    C'        NUMBER  '                                              
BAMTWD   DC    C'   BILL AMOUNT  '                                              
*                                                                               
         SPACE 3                                                                
         LTORG                                                                  
TYPNAMES DC    CL16'         ORDERED'                                           
TYPRVBD  DC    CL16'    PREV. BILLED'                                           
TYBILLA  DC    CL16'        BILLABLE'                                           
*                                                                               
CATNAMES DC    CL16'           GROSS'                                           
CATNET   DC    CL16'             NET'                                           
CATCDISC DC    CL16'      CASH DISC.'                                           
CATGRSLC DC    CL16'   GROSS LESS CD'                                           
CATNETCD DC    CL16'     NET LESS CD'                                           
CATAGYCM DC    CL16'    AGENCY COMM.'                                           
         EJECT                                                                  
BH50     CSECT                                                                  
         NMOD1 0,BH50                                                           
         LA    RC,SPACEND                                                       
*                             HERE FROM DUMMY NON-PRINTING HEADLINE             
*                             SETTING REPORT CALL                               
*                             SAVE NEEDED LINES                                 
         L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
*                                                                               
         CLC   AESTBRK,APAGBRK     TEST EST TO BE IN B.MY HEADLINES             
         BH    BH51B                NO                                          
BH51     DS    0H                  STATE ESTIMATE                               
         MVC   HEAD6,SPACES                                                     
         MVC   HEAD7,SPACES                                                     
*--->    MVC   HEAD6(8),=C'ESTIMATE'                                            
         MVC   HEAD6(L'PP@EST),PP@EST                                           
         MVC   HEAD6+9(3),EST                                                   
         MVC   HEAD6+13(20),ESTNM                                               
         MVC   HEAD7+13(20),ESTNAM2                                             
         CLC   QPROG,=C'E1'             FOR E1 SHOW REVISION NUMBER             
         BNE   BH52                                                             
         OC    ESTREV,ESTREV            CHK FOR REVISION NUMBER                 
         BZ    BH52                                                             
         CLC   HEAD7+13(4),SPACES        USE HEAD7 IF I CAN                     
         BH    BH51A                                                            
*--->    MVC   HEAD7+13(3),=C'REV'                                              
         MVC   HEAD7+13(L'PP@REVIS),PP@REVIS                                    
         MVC   HEAD7+17(3),ESTREV                                               
         B     BH52                                                             
*                                                                               
BH51A    DS    0H                                                               
*--->    MVC   HEAD7+35(3),=C'REV'                                              
         MVC   HEAD7+35(L'PP@REVIS),PP@REVIS                                    
         MVC   HEAD7+39(3),ESTREV                                               
         DROP  RE                                                               
         B     BH52                                                             
*                                                                               
BH51B    DS    0H                                                               
         CLC   HEAD6+11(8),=C'FILTERED'   IF USING FILTERS                      
         BE    BH52                       LEAVE HEAD6 AND HEAD7 ALONE           
         MVC   HEAD6,SPACES        CLEAR ESTIMATE                               
         MVC   HEAD7,SPACES        CLEAR ESTIMATE                               
BH52     DS    0H                                                               
*                                  ADD CLT INTERFACE NO AFTER CLT NME           
         CLI   AGMCLNO,C'Y'                                                     
         BE    BH52B                                                            
         CLI   AGMCLNO,C'C'        Y OR C MEANS YES                             
         BNE   BH52D                                                            
*                                                                               
BH52B    L     R7,ADCLT                                                         
         CLI   PCLTNUM-PCLTREC(R7),X'FF'                                        
         BNE   BH52C                        PWOS                                
         UNPK  WORK(5),PCLTNUM+1-PCLTREC(3,R7)                                  
         LA    R7,HEAD1+45                                                      
         CLI   0(R7),C' '                                                       
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVI   3(R7),C'('                                                       
         MVC   4(4,R7),WORK                                                     
         MVI   8(R7),C')'                                                       
         B     BH52D                                                            
*                                                                               
BH52C    MVC   BYTE,PCLTNUM-PCLTREC(R7)                                         
         NI    BYTE,X'F0'                                                       
         CLI   BYTE,X'80'                                                       
         BNE   BH52C8                                                           
         XC    FULL,FULL                                                        
         MVC   FULL+1,PCLTNUM-PCLTREC(R7)                                       
         NI    FULL+1,X'7F'              SET-OFF X'80'                          
         L     R0,FULL                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(5),DUB                                                      
         LA    R7,HEAD1+45                                                      
         CLI   0(R7),C' '                                                       
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVI   3(R7),C'('                                                       
         CLC   QAGENCY,=C'KA'        SPECIAL FOR KA                             
         BNE   BH52C4                                                           
         MVC   4(4,R7),WORK+1       NOTE - DROPS HIGH DIGIT                     
         MVI   8(R7),C')'                                                       
         B     BH52D                                                            
*                                                                               
BH52C4   MVC   4(5,R7),WORK                                                     
         MVI   9(R7),C')'                                                       
         B     BH52D                                                            
*                                                                               
BH52C8   MVC   WORK(3),PCLTNUM-PCLTREC(R7)                                      
         OC    WORK(3),SPACES                                                   
         CLC   WORK(3),SPACES                                                   
         BE    BH52D                                                            
*                                                                               
         LA    R7,HEAD1+45                                                      
         CLI   0(R7),C' '                                                       
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVI   3(R7),C'('                                                       
         MVC   4(3,R7),WORK                                                     
         MVI   7(R7),C')'                                                       
*                                                                               
BH52D    DS    0H                                                               
*                                  ADD ACCT NO AFTER PRD NAME                   
         CLI   AGMCLNO,C'C'        C OR X MEANS NO                              
         BE    BH53                                                             
         CLI   AGMCLNO,C'X'                                                     
         BE    BH53                                                             
*                                                                               
         L     R7,ADPRD                                                         
         MVC   FULL,PPRDACCT-PPRDREC(R7)                                        
         CLI   FULL,C' '                                                        
         BNH   BH53                                                             
         CLC   FULL,=4C'0'                                                      
         BE    BH53                                                             
         LA    R7,HEAD5+45                                                      
         CLI   0(R7),C' '                                                       
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVI   3(R7),C'('                                                       
         MVC   4(4,R7),FULL                                                     
         MVI   8(R7),C')'                                                       
         CLI   FULL,X'FF'          TEST NUMERIC ACCOUNT CODE                    
         BNE   BH53                                                             
         MVI   FULL,0                                                           
         CLC   QAGENCY,=C'JW'      SPECIAL FORMAT FOR JWT                       
         BNE   BH52F                                                            
         L     R0,FULL                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  4(5,R7),DUB                                                      
         MVI   9(R7),C')'                                                       
         B     BH53                                                             
*                                                                               
BH52F    CLC   QAGENCY,=C'KA'      SPECIAL FORMAT FOR KETCHEM                   
         BNE   BH52K                                                            
         L     R0,FULL                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  4(4,R7),DUB         **NOTE - DROPS HIGH DIGIT OF 5               
         MVI   8(R7),C')'                                                       
         B     BH53                                                             
*                                                                               
BH52K    EDIT  (B4,FULL),(5,4(R7)),ALIGN=LEFT                                   
         AR    R7,R0               ADD EDITED LENGHT                            
         MVI   4(R7),C')'                                                       
*                                                                               
BH53     DS    0H                                                               
         MVI   BYTE,0                                                           
         OC    AMGR1BRK,AMGR1BRK        TEST MGR'S IN HEADLINE                  
         BZ    BH53B                    NO                                      
         CLC   AMGR1BRK,APAGBRK                                                 
         BH    BH53B                    NO                                      
         OI    BYTE,X'40'               YES                                     
BH53B    DS    0H                                                               
         OC    APGR1BRK,APGR1BRK        TEST PGR'S IN HEADLINE                  
         BZ    BH53D                    NO                                      
         CLC   APGR1BRK,APAGBRK                                                 
         BH    BH53D                    NO                                      
         OI    BYTE,X'80'               YES                                     
*                                                                               
BH53D    DS    0H                                                               
         CLI   BYTE,0              NO MGRS AND NO PGRS                          
         BNE   BH53E                                                            
         CLC   AMKTBRK,APAGBRK     AND NO MKT                                   
         BH    BH53Z               NO NEED FOR ALIGNING                         
BH53E    DS    0H                                                               
*                                                                               
*                                  FIRST ALIGN ALL FIELDS LIKE PGRS             
*                                  AND MGRS- DESC(12),CODE(5)                   
         MVC   X(45),HEAD6         SAVE EST MEADLINE                            
         MVC   X+45(45),HEAD7       SAVE EST LINE 2                             
         LA    R6,HEAD1            CLT                                          
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD2            DIVISION                                     
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD5            PRD                                          
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD6            EST   EST USES HEAD 6 AND 7                  
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD7            EST   EST USES HEAD 6 AND 7                  
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD8            REGION                                       
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD9            DISTRICT                                     
         BAS   RE,BHMVR                                                         
BH53T    DS    0H                                                               
*                                  RESTORE ESTIMATE LINE                        
*                                  IF NOT STANDARD                              
         CLC   X(3),=C'ALL'                                                     
         BE    BH53V                                                            
         CLC   X+9(5),=C'GROUP'                                                 
         BNE   *+16                                                             
BH53V    DS    0H                                                               
         MVC   HEAD6(45),X                                                      
         MVC   HEAD7(45),X+45                                                   
*                                                                               
         B     BH53Z                                                            
         SPACE 2                                                                
BHMVR    DS    0H                  ALIGN AS DESC(12),CODE(5)                    
         MVC   WORK,0(R6)                                                       
         MVC   9(40,R6),SPACES                                                  
         MVC   10(3,R6),WORK+9                                                  
         MVC   15(30,R6),WORK+13                                                
         BR    RE                                                               
         SPACE 2                                                                
BH53Z    DS    0H                                                               
*                                                                               
*                                  CLEAR MYHEADS                                
         L     R4,AMYHEADS                                                      
         LA    R0,10             450 / 10                                       
         MVC   0(45,R4),SPACES                                                  
         LA    R4,45(R4)                                                        
         BCT   R0,*-10                                                          
*                                                                               
         L     R4,AMYHEADS                                                      
         MVC   0(45,R4),HEAD1       CLIENT                                      
         LA    R4,45(R4)                                                        
         LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
*                                                                               
BH54     DS    0H                                                               
         OC    BRKCODE,BRKCODE                                                  
         BZ    BH50X                                                            
         CLI   BRKCODE+3,PUBEQ     BYPASS BREAKS 'BELOW' PUB                    
         BH    BH55                                                             
*                                                                               
         CLI   UPASS,C'S'          TEST RETAIL SUMMARY PASS                     
         BE    BH54A                                                            
*                                                                               
         C     R3,APAGBRK          FOR REG BULL PAGBRK IS LIMIT                 
         BH    BH56                                                             
         B     BH54B                                                            
*                                  FOR SUMMARY PASS - USE LEVCTLS               
BH54A    DS    0H                                                               
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         CLI   0(RF),C'S'          SEPARATE                                     
         BE    BH54B                                                            
         CLI   0(RF),C'P'          OR PAGE BREAK                                
         BNE   BH56                                                             
BH54B    DS    0H                                                               
         L     RF,BRKCODE                                                       
         CLI   BRKCODE+3,ESTEQ                                                  
         BNH   BH54C                                                            
         LA    RF,4(RF)            SINCE EST USES 2 LINES                       
BH54C    MH    RF,=H'33'           132/4 = INDEX INTO HEADS                     
****                                                                            
****  WAS LA   RF,HEAD1(RF)            OK WHEN FIRST BRKCODE WAS 04             
****                                                                            
         LA    RF,HEAD1-L'HEAD1(RF)  SINCE FIRST BRKCODE IS NOW 08              
*                                    NOT 04                                     
         MVC   0(45,R4),0(RF)                                                   
         LA    R4,45(R4)           NEXT LINE                                    
         CLI   BRKCODE+3,ESTEQ       SEE IF DOING EST                           
         BNE   BH55                                                             
         LA    RF,L'HEAD1(RF)      ALSO DO 2ND EST LINE                         
*                                                                               
         CLC   0(45,RF),SPACES     SEE IF USED                                  
         BNH   BH55                NO THEN SKIP                                 
*                                                                               
         MVC   0(45,R4),0(RF)                                                   
         LA    R4,45(R4)           NEXT LINE                                    
BH55     DS    0H                                                               
         LA    R3,BRKL(R3)         NEXT LEVEL                                   
         B     BH54                                                             
BH56     DS    0H                                                               
         C     R3,AESTBRK                                                       
         BNE   BH55                                                             
*                                  EVEN IF EST NOT ON BILL                      
*                                  PUT IT IN HEADS                              
         MVC   0(45,R4),HEAD6                                                   
         B     BH55                                                             
*                                                                               
BH50X    XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*                             INVOICE REGISTER HEADLINES                        
         TITLE 'ERRPROC - HANDLE RRRORS'                                        
         SPACE 2                                                                
ERRPROC  CSECT                                                                  
         NMOD1 0,ERRPROC                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         LA    RE,ERRLIST                                                       
         L     RF,=F'780'                                                       
         XCEF                                                                   
         L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
         MVC   INVL3,PP@INVL3      INVALID PRODUCT GROUP                        
         MVC   INVL4,PP@INVL4      INVALID REGION/DISTRICT SCHEME               
         MVC   NEWB,PP@NEWB  NEW BILLING NOT EFFECTIVE FOR THIS DATE            
         MVC   NOBG,PP@NOBG        NO BILLING GENERATED                         
         MVC   MERR1,PP@MERR1      MANUAL AMOUNT ERROR                          
         MVC   INVL5,PP@INVL5      INVALID BILLING PERIOD                       
         MVC   INVL6,PP@INVL6      INVALID BILLING TYPE                         
         MVC   PROF,PP@PROF        PROFILE INCOMPATIBILITY - RETAIL             
         MVC   DTL1,PP@DTL1   DETAIL BACK-UP INCOMP. WITH SEP ADJ.              
         MVC   INVL7,PP@INVL7      INVALID BILLING PROFILE                      
         MVC   MERR2,PP@MERR2      MANUAL REVERSAL ERROR                        
         MVC   AORBL,PP@AORBL  AOR BILL - PRDS NOT SEPERATE,OR MEDIA            
         MVC   REG,PP@REG                                                       
         DROP  RE                                                               
*                                                                               
         MVC   P1(80),QPROG                                                     
         MVC   P2(80),QAREA2                                                    
         MVI   SKIPSPEC,C'Y'                                                    
         MVI   FORCEHED,C'Y'                                                    
         MVI   PRSW,C'N'                                                        
         GOTO1 APRNT                                                            
         ZIC   RF,ERR                                                           
         MH    RF,=H'60'                                                        
         LA    RF,ERRLIST-60(RF)                                                
         MVC   P1(2),=C'**'                                                     
         MVC   P1+3(60),0(RF)                                                   
         MVI   SKIPSPEC,C'Y'                                                    
         MVI   PRSW,C'N'                                                        
         GOTO1 APRNT                                                            
         CLC   QCLIENT,=C'ALL'                                                  
         BE    ERRP5                                                            
         CLI   QCLIENT,C'*'        OFFICE                                       
         BE    ERRP5                                                            
         CLI   QCLIENT,C'&&'       CLIENT GROUP                                 
         BE    ERRP5                                                            
         B     ERRPX                                                            
ERRP5    CLI   ERR,PROFERR         SEE IF PROFILE ERROR                         
         BE    ERRP7                                                            
         CLI   ERR,PROFERR5        SEE IF PROFILE ERROR                         
         BE    ERRP7                                                            
         CLI   ERR,TYPERR          OR TYPE ERROR                                
         BE    ERRP7                                                            
         B     ERRPX                                                            
*                                                                               
ERRP7    DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P1(34),=C'** NO BILLING GENERATED FOR CLIENT'                    
         MVC   P1(L'PP@NOBIL),PP@NOBIL                                          
         DROP  RE                                                               
         L     RF,ADCLT                                                         
         MVC   P1+35(3),PCLTKCLT-PCLTREC(RF)                                    
         GOTO1 APRNT                                                            
         MVI   CLTSW,C'N'          SKIP TO NEXT CLIENT                          
         XIT1                                                                   
**                                                                              
ERRPX    GOTO1 AENDREQ             NEXT REQUEST                                 
         SPACE 3                                                                
ERRLIST  DS    0C                                                               
INVL3    DC    CL60'INVALID PRODUCT GROUP'            1                         
INVL4    DC    CL60'INVALID REGION/DISTRICT SCHEME'              2              
*              USUALLY BECAUSE PUB NOT ASSGINED TO A DISTRICT                   
*              FOR 'ALL' DISTRICT REQUEST                                       
NEWB     DC    CL60'NEW BILLING NOT EFFECTIVE FOR THIS DATE'     3              
NOBG     DC    CL60'NO BILLING GENERATED'                        4              
MERR1    DC    CL60'MANUAL AMOUNT ERROR'                         5              
INVL5    DC    CL60'INVALID BILLING PERIOD'                      6              
INVL6    DC    CL60'INVALID BILLING TYPE'                        7              
PROF     DC    CL60'PROFILE INCOMPATIBILITY - RETAIL'            8              
DTL1     DC    CL60'DETAIL BACK-UP  INCOMP. WITH SEP ADJ.'       9              
INVL7    DC    CL60'INVALID BILLING PROFILE'                    10              
MERR2    DC    CL60'MANUAL REVERSAL ERROR'                      11              
*  ATTEMPT TO MANUALLY REVERSE A BILL WHICH 'REBILLED' AN OLD MANUAL            
AORBL    DC    CL60'AOR BILL - PRDS NOT SEPERATE,OR MEDIA *'    12              
REG      DC    CL60'REG/DST,MKT,JOB,PUB CAN''T BE SEPERATE WITH CLEAREDX        
                ESTS'                                           13              
         DC    CL60'PROFILE INCOMPATIBILITY - AOR'              14              
         DC    CL60'COMMISSION/NET/REG OPTION INVALID'          15              
         DC    CL60'INVALID ESTIMATE OPTION'                    16              
         DC    CL60'INVALID REQUESTING ID'                      17              
*                                                                               
*                                                                               
         SPACE 3                                                                
PGRERR   EQU   1                                                                
MGRERR   EQU   2                                                                
DATERR   EQU   3                                                                
NOBILERR EQU   4                                                                
MANERR   EQU   5                                                                
DATERR2  EQU   6                                                                
TYPERR   EQU   7                                                                
RETPERR  EQU   8                                                                
ADJERR   EQU   9                                                                
PROFERR  EQU   10                                                               
AORERR   EQU   12                                                               
PROFERR5 EQU   13                                                               
AORPERR  EQU   14                                                               
SCBERR   EQU   15                                                               
ESTERR   EQU   16                                                               
IDERR    EQU   17                                                               
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
       ++INCLUDE PPBDICS                                                        
       ++INCLUDE DDDICTATED                                                     
*                                                                               
       ++INCLUDE DDBUFFALOD                                                     
         SPACE 2                                                                
*                                                                               
       ++INCLUDE DDLOGOD                                                        
         EJECT                                                                  
*                                                                               
       ++INCLUDE PPREPB1WRK                                                     
         EJECT                                                                  
*                                                                               
       ++INCLUDE DDREPMASTD                                                     
ERRPROC  CSECT                                                                  
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'021PXB12A    05/01/02'                                      
         END                                                                    
