*          DATA SET FALCM      AT LEVEL 025 AS OF 01/23/13                      
*&&      SET   NOP=N                                                            
*CATALP FALCM                                                                   
         TITLE 'FALCM - LINE CONTROL WITH STRUCTURED FIELDS'                    
*==========================================================*                    
* TASK CONTROL ENTERS HERE TO PROCESS POSTED ECB'S         *                    
* CONTROL RETURNS WHEN ALL COMPLETIONS HAVE BEEN PROCESSED *                    
*==========================================================*                    
         PRINT NOGEN                                                            
LCM      CSECT                                                                  
         ENTRY APPLID                                                           
         ENTRY LCMECB                                                           
         ENTRY RPLLST                                                           
*                                                                               
         NMOD1 LCMWRKL,**LCM**,RA,CLEAR=YES                                     
         USING LCMWRK,RC                                                        
         USING COMMON,R9                                                        
         LARL  R9,COMMON                                                        
         SAM31 ,                                                                
*                                                                               
         L     R2,ASYSFAC          R2=V(SYSFACS)                                
         USING SYSFACD,R2                                                       
         LARL  R7,RPLLST           R7=A(RPL LIST)                               
         USING FARPLD,R7                                                        
*                                                                               
         ICM   RF,15,0(R1)         GET ENTRY POINT INDEX                        
         SLL   RF,2                X 4                                          
         L     RF,LCBRTAB(RF)                                                   
         BASR  RE,RF               SET RE IN CASE OF BUG                        
         DC    H'0'                BUT NO RETURN EXPECTED                       
*                                                                               
         EJECT                                                                  
*=====================================================================*         
* VTAM WAIT - CHECK FOR COMPLETIONS                                   *         
*=====================================================================*         
NXT      XC    LCMECB,LCMECB       MAKE SURE ECB IS CLEAR                       
*                                                                               
         USING IFGRPL,R8                                                        
NXT02    L     R8,FARPLRPL         POINT TO RPL                                 
         TM    RPLECB,RPLPOST      TEST VTAM COMPLETION POSTED                  
         BZ    NXT18                                                            
*                                                                               
         TM    FARPLFLG,FARPL62    IS THIS AN LU6.2 FARPL/RPL?                  
         BNO   NXT04               NO, CONTINUE LU 2                            
         BRAS  RE,DOLU62           YES, GO DO LU6.2 PROCESSING OF FARPL         
         B     NXTRPL                                                           
*                                                                               
DOLU62   DC    H'0'                HOW ? WHY ?                                  
*                                                                               
NXT04    DS    0H                                                               
         PUSH ACONTROL                                                          
         ACONTROL COMPAT(NOCASE),FLAG(NOPAGE0)                                  
         CHECK RPL=(R8)            LU 2 PROCESSING, CHECK AND FREE RPL          
         POP ACONTROL                                                           
*                                                                               
         LTR   RF,RF               ALL IS GOOD?                                 
         BZ    NXT06               YES                                          
         CLI   RPLACTIV,X'FF'      TEST RPL STILL ACTIVE                        
         BNE   NXT06               NO                                           
*                                                                               
         MVI   DDSFLAG,C'Z'        SET ERR NUM                                  
         ST    R0,ERRDATA          NEED TO PASS R0 AND RF                       
         ST    RF,ERRDATA+4        TO TRACE                                     
         BRAS  RE,LCMTRC                                                        
         B     NXTRPL              SKIP THIS RPL FOR NOW                        
*                                                                               
NXT06    NI    FARPLFLG,255-FARPLBSY    RESET BUSY FLAG                         
*                                                                               
         USING UTLD,R3                                                          
         ICM   R3,15,RPLUSFLD      GET UTL POINTER                              
         BZ    NXT08                                                            
         TM    TSTAT4,TST4TRC      TEST TRACE ACTIVE                            
         BZ    NXT08                                                            
         BRAS  RE,LCMTRC                                                        
*                                                                               
NXT08    CLI   RPLRTNCD,RPLNOERR   RETURN CODE = 0 ?                            
         BNE   LCERR                                                            
         CLI   RPLFDB2,0           CHECK FEEDBACK CODE                          
         BNE   LCERR                                                            
*                                                                               
         LTR   R3,R3               TEST UTL POINTER EXISTS                      
         BZ    NXT10               NO - BETTER NOT TEST IF PRINTER              
         OC    TXPRNT,TXPRNT       TEST PRINTER                                 
         BNZ   NXT10               YES                                          
         TM    RPLCNTDC,RPLLUS     TEST FOR TERMINAL STATUS MSG                 
         BO    LCERR               YES                                          
*                                                                               
NXT10    TM    FARPLFLG,FARPLRD    TEST A RECEIVE RPL                           
         BO    NXT20                                                            
         TM    FARPLFLG,FARPLWRT   TEST A WRITE RPL                             
         BO    WRT                 YES - RELEASE BUFFER AND WRITE AGAIN         
*                                                                               
         CLI   RPLREQ,RPLCLOSE     CONTROL RPL / DID CLSDST COMPLETE            
         BNE   NXT12                                                            
*                                                                               
         ICM   R1,15,RPLAREA       DID IT HAVE AN AREA                          
         BZ    NXT11                                                            
         SHI   R1,1                                                             
         BRAS  RE,FREEBUFF         BUFFER NEEDS FREEING THEN                    
         XC    RPLAREA,RPLAREA     THEN CLEAR IT                                
*                                                                               
NXT11    LTR   R3,R3               TEST UTL POINTER EXISTS                      
         BZ    CTL                 NO                                           
*                                                                               
         NI    TSTAT4,255-TST4CLIP RESET CLSDST IN PROCESS                      
         TM    TSTAT4,TST4TRC      TEST TRACE ACTIVE                            
         BO    *+8                 YES - DONE IT ALREADY                        
         BRAS  RE,LCMTRC           ELSE TRACE THE CLSDST                        
         B     CTL                                                              
*                                                                               
NXT12    CLI   RPLREQ,RPLOPNDS     CONTROL RPL/ DID OPNDST COMPLETE             
         BNE   CTL                 NO - CONTINUE                                
*                                                                               
         ICM   R3,15,RPLUSFLD      GET UTL POINTER FROM RPL                     
         USING UTLD,R3                                                          
*                                                                               
         TM    RPLEXTDS,RPLNIB     TEST RPL HAS NIB ADDRESS                     
         BO    *+10                IF SO, CAN'T USE IT AS CID                   
         MVC   TCID,RPLARG         USE CID FROM OPNDST                          
*                                                                               
         TM    TSTAT4,TST4TRC      TEST TRACE ACTIVE                            
         BO    *+8                 YES - DONE IT ALREADY                        
         BRAS  RE,LCMTRC           ELSE, TRACE THE COMPLETION                   
*                                                                               
         OC    TXPRNT,TXPRNT       TEST PRINTER                                 
         BZ    NXT14               NO                                           
         NI    TSTAT4,X'FF'-TST4UNLG    RESET UNABLE TO LOGON                   
                                                                                
*=====================================================================*         
* RESET ERROR FLAGS IN PQHDR + SET PRINTER ACTIVE                               
*=====================================================================*         
         ICM   RE,15,TXPRNT                                                     
         MVI   PRSTAT-PRHDR(RE),PRSACTV                                         
         NI    PRSTAT2-PRHDR(RE),X'FF'-PRS2PATH-PRS2UNLG                        
         GOTO1 VLCM,P1,VTPRSTRT,(R3)   QUEUE PRINTER FOR WRITE                  
         B     NXT18                                                            
         EJECT                                                                  
*=====================================================================*         
* ATTEMPT TO SEND A LOGON CONFIRMATION TO TERMINAL                    *         
*=====================================================================*         
NXT14    ICM   RF,15,TBUFF         TEST TRM HAS BUFFER                          
         BZ    NXT16                                                            
         AHI   RF,-8               TEST GOBACK FOR FULL LOGON                   
         TM    TBHINDS-TBHD(RF),TBHIBACK                                        
         BZ    CTL                 NO FORGET IT                                 
*                                                                               
         GOTO1 VMSGQIN,P1,(R2),TBUFF,(R3)                                       
         B     CTL                 REQUEUE AND GET OUT                          
*                                                                               
NXT16    BRAS  RE,GETBUFF          GET BUFFER RETURN ZERO IF N/A                
         LTR   R1,R1                                                            
         BZ    CTL                 IF NOT, FORGET IT                            
         STCM  R1,15,TBUFF                                                      
*                                                                               
NXTSEND  BRAS  RE,SIGNON                                                        
         GOTO1 VLCM,P1,VTWRITE,(R3),0                                           
         B     CTL                                                              
         DROP  R3                                                               
         EJECT                                                                  
*=====================================================================*         
* NO VTAM COMPLETION - MAKE SURE RPL IS BUSY                          *         
*=====================================================================*         
NXT18    TM    FARPLFLG,FARPLBSY                                                
         BO    NXTRPL                                                           
         TM    FARPLFLG,FARPLRD    TEST A RECEIVE RPL                           
         BO    RCV                                                              
         TM    FARPLFLG,FARPLWRT   TEST A WRITE RPL                             
         BO    WRT                                                              
         B     CTL                                                              
*                                                                               
NXTRPL   ICM   R7,15,FARPLNXT                                                   
         BNZ   NXT02                                                            
         OC    PRTQLEN,PRTQLEN                                                  
         BNZ   PRT                                                              
*                                                                               
         OC    FMH5CTR,FMH5CTR     ARE ANY FMH5'S OUTSTANDING                   
         BZ    EXIT                                                             
         L     R1,FMH5CTR          YES,                                         
         BRAS  RE,DOFMH5           GO ISSUE SPECIAL FMH5 RECEIVE                
         B     EXIT                                                             
*                                                                               
DOFMH5   DC    H'0'                                                             
         EJECT                                                                  
*=====================================================================*         
* BSC BUFFER FORMAT AS FOLLOWS                                        *         
*                                                                     *         
* BYTES 0-3 UNUSED IN VTAM (AND NO ETX EITHER MIND YOU)               *         
*     ACCSBB        SBB        E                                      *         
* ....IAABUU..DATA..BUU..DATA..T   FOR ENTER/PF-KEYS                  *         
*     D12A11        A22        X                                      *         
* 01234567                                                            *         
* NSCDAE                                                              *         
* DTUVIT                           FOR CLEAR/PA-KEYS                  *         
* XXAADX                                                              *         
*=====================================================================*         
NXT20    CLI   RPLREQ,RPLRCVCD     TEST A RECEIVE COMPLETED                     
         BNE   RCV                 NO - IGNORE AND ISSUE RECEIVE                
*                                                                               
         TM    RPLCHN,RPLLAST+RPLONLY                                           
         BNZ   NXT22               LAST OR ONLY BUFFER                          
                                                                                
*=====================================================================*         
* NOT LAST BUFFER SO CONTINUE SPECIFIC                                *         
*=====================================================================*         
         L     RE,RPLAREA          GET CURRENT BUFFER ADDRESS                   
         A     RE,RPLRLEN          GIVES NEW IOAREA ADDR                        
         ST    RE,RPLAREA                                                       
*                                                                               
         L     RE,RPLBUFL          CURRENT AREA LEN                             
         S     RE,RPLRLEN          LESS DATA LEN                                
         ST    RE,RPLBUFL          GIVES REMAINING AREA LEN (WE HOPE)           
*                                                                               
         RECEIVE RPL=(R8),OPTCD=(Q,ASY,CS,SPEC),ECB=INTERNAL                    
         LTR   RF,RF                                                            
         BZ    NXTRPL                                                           
         DC    H'0'                                                             
         EJECT                                                                  
*=====================================================================*         
* LAST OR ONLY BUFFER                                                 *         
*=====================================================================*         
NXT22    TM    RPLSRTYP,RPLRRESP   TEST THIS IS A RESPONSE                      
         BZ    NXT24               NO - CONTINUE                                
                                                                                
*=====================================================================*         
* WE HAVE A RESPONSE THAT IS NOT AN ERROR                             *         
* IGNORE IT IF IT IS NOT FROM A PRINTER                               *         
*=====================================================================*         
         USING UTLD,R3                                                          
         ICM   R3,15,RPLUSFLD                                                   
         ICM   RE,15,TXPRNT                                                     
         BZ    RCV                                                              
         TM    PRSTAT-PRHDR(RE),PRSERR    TEST IN ERROR STATUS                  
         BZ    *+8                        NO                                    
         MVI   PRSTAT-PRHDR(RE),PRSACTV   ELSE SET PRINTER ACTIVE               
*                                                                               
         TM    TSTATU,TSTATDNE                                                  
         BZ    NXT40                                                            
         NI    TSTATU,255-TSTATDNE                                              
         GOTO1 VLCM,P1,VTPRSTOP,(R3)      STOP PRINTER                          
         B     NXTRPL                                                           
         EJECT                                                                  
*=====================================================================*         
* NOT A RESPONSE                                                      *         
*=====================================================================*         
NXT24    TM    TSTAT5,TST5TBP      TEST TERMINAL BUILD PENDING                  
         BZ    NXT26               NO                                           
         OC    TXPRNT,TXPRNT                                                    
         BNZ   NXT26               DON'T SEND THIS TO A PRINTER                 
                                                                                
*=====================================================================*         
* NEED TIME TO EXECUTE INITIALIZE SERVICE REQUEST                     *         
* USE THE INPUT BUFFER TO RESPOND TO THE TERMINAL                     *         
*=====================================================================*         
         L     RE,FARPLIOA                                                      
         MVC   0(2,RE),=X'F5C3'    WRITE ERASE/WCC                              
         MVC   2(WAITMSGL,RE),WAITMSG                                           
         AHI   RE,-8               BACK UP TO HEADER                            
         ST    R3,0(RE)            SET UTL ENTRY ADDRESS                        
*                                                                               
         L     R5,FARPLIOA                                                      
         LA    R6,WAITMSGL+2                                                    
         ST    R6,FARPLIOL         SET MESSAGE LENGTH                           
         L     R0,TCID                                                          
         SEND  RPL=(R8),AREA=(R5),RECLEN=(R6),ARG=(R0),STYPE=REQ,      X        
               POST=SCHED,OPTCD=(ASY,LMPEO,CA),RESPOND=(EX,QRESP),     X        
               CHNGDIR=CMD                                                      
         OI    FARPLFLG,FARPLBSY                                                
         B     NXTRPL                                                           
         EJECT                                                                  
*=====================================================================*         
* NO TERMINAL BUILD PENDING                                           *         
*=====================================================================*         
NXT26    TM    TTYPE2,TTYPE2SF+TTYPE2SC  TEST STRUCT FIELD XMT                  
         BNZ   NXT50                     YES - DON'T TOUCH THE BUFFER !         
*                                                                               
         L     RE,FARPLIOA         POINT TO BUFFER START                        
         MVC   0(4,RE),=C'VTRD'    SET EYECATCHER WHERE STX USED TO BE          
         L     RE,RPLAREA          POINT TO CURRENT BUFFER ADDR                 
         A     RE,RPLRLEN          ADD RECORD LENGTH                            
         MVI   0(RE),ETX           SET AN ETX                                   
*                                                                               
         LA    RE,1(RE)            SET END ADDRESS + 1                          
         S     RE,FARPLIOA         LESS MESSAGE START ADDR                      
         ST    RE,FARPLIOL         GIVES LENGTH OF ENTIRE MESSAGE               
         L     RE,FARPLIOA                                                      
         LA    RF,AIDTAB           SEARCH TABLE OF VALID PF KEYS                
*                                                                               
NXT28    CLC   0(1,RF),4(RE)                                                    
         BE    NXT30                                                            
         LA    RF,1(RF)                                                         
         CLI   0(RF),X'FF'                                                      
         BE    NXT32               AID CODE NOT IN TABLE                        
         B     NXT28                                                            
*                                                                               
NXT30    LA    R0,AIDTAB                                                        
         SR    RF,R0               CONVERT AID TO INTEGER 0 THRU 24             
         STC   RF,4(RE)                                                         
         B     NXT40                                                            
*                                                                               
NXT32    L     RE,FARPLIOA                                                      
         LA    RF,PAKTAB           SEARCH TABLE OF VALID PA KEYS                
*                                                                               
NXT34    CLC   0(1,RF),4(RE)                                                    
         BE    NXT36                                                            
         AHI   RF,L'PAKTAB                                                      
         CLI   0(RF),X'FF'                                                      
         BNE   NXT34                                                            
         LA    RF,PAKDATA0                                                      
*                                                                               
NXT36    MVI   04(RE),0            SET AID TO ENTER                             
         LA    R0,7                SET ZERO LENGTH FOR SOFT FIELDS              
         TM    TSTAT6,TST6STSS                                                  
         BO    NXT38                                                            
         TM    TSTAT8,TST8STSS                                                  
         BO    NXT38                                                            
*                                                                               
         MVC   05(2,RE),=X'407E'   SET CURSOR ADDRESS                           
         MVC   07(3,RE),=X'11407E' SET SCREEN LOCATION TO (01,63)               
         MVC   10(7,RE),1(RF)      SET DATA FROM PA-KEY TABLE                   
         MVI   17(RE),ETX                                                       
         LHI   R0,18               FORCE INPUT LENGTH                           
*                                                                               
NXT38    ST    R0,FARPLIOL         ADJUST COUNT FOR DATA                        
         EJECT                                                                  
*=====================================================================*         
* BUILD A BUFFER HEADER AT A(BUFFER)-8.                               *         
* BYTES 0-3 = UTL ENTRY ADDRESS                                       *         
*        4  = SPARE                                                   *         
*        5 =  DSP TO STX (SET BY MSGQIN) OR WRITE TYPE (LCWRITE)      *         
*       6-7 = MESSAGE LENGTH                                          *         
*=====================================================================*         
NXT40    ICM   R3,15,RPLUSFLD      PICK UP UTL ENTRY ADDRESS                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         USING UTLD,R3                                                          
*                                                                               
         TM    RPLEXTDS,RPLNIB     TEST RPL HAS NIB ADDRESS                     
         BO    *+14                YES - DO NOT PROCESS MESSAGE                 
         OC    TCID,TCID                                                        
         BNZ   NXT42                                                            
         MVI   DDSFLAG,4           RECORD EVENT THAT CID IS ZERO                
         BRAS  RE,LCMTRC                                                        
         B     RCV                 IGNORE READ WITH ZERO CID                    
*                                                                               
NXT42    CLC   TCID,RPLARG         TEST CID'S MATCH                             
         BE    NXT44               YES - OK                                     
         TM    TSTAT4,TST4TRC      TEST TRACE ACTIVE                            
         BO    NXT44               YES - SO TRACED ALREADY                      
         BRAS  RE,LCMTRC           RECORD THIS MARVELOUS EVENT                  
*                                                                               
NXT44    ICM   R1,15,TXPRNT        TEST IF PRINTER                              
         BZ    NXT46               NO                                           
         TM    PRSTAT-PRHDR(R1),PRSACTV                                         
         BO    NXT46                                                            
         MVI   DDSFLAG,1           SET TRACE MSGNUM                             
         BRAS  RE,LCMTRC                                                        
         B     RCV                 IGNORE NON-ACTIVE PRINTERS                   
*                                                                               
NXT46    OC    TBUFF,TBUFF         TEST TRM HAS BUFFER                          
         BZ    NXT50               NO TREAT THIS AS A NORMAL INPUT              
         L     RE,FARPLIOA         YES POINT TO THIS INPUT BUFFER               
*                                                                               
         TM    TTYPE,TTYPE327      TEST 3270 SPECIAL SERVICE REQUESTS           
         BZ    RCV                 IGNORE MESSAGE                               
         CLC   7(3,RE),=X'11407E'  TEST FIRST DATA AT (01,63)                   
         BNE   RCV                                                              
         LA    RE,10(RE)           POINT TO FIRST DATA BYTE                     
         LA    RF,EBCEBC                                                        
         TR    0(7,RE),0(RF)       TRANSLATE TO UPPER CASE EBCDIC               
*                                                                               
         LA    R1,PAKKILL                                                       
         CLC   0(5,RE),1(R1)       TEST FOR $KILL                               
         BNE   NXT48                                                            
         OI    TSTAT2,TSTATCAN     SET CANCEL PENDING                           
         B     RCV                                                              
*                                                                               
NXT48    LA    R1,PAKSTAT                                                       
         CLC   0(7,RE),1(R1)       TEST FOR $STATUS                             
         BNE   RCV                 IGNORE MESSAGE                               
         B     RCV ================ NOP ======================                  
         TM    TSTAT3,TSTATWRT     TEST A WRITE PENDING                         
         BNZ   RCV                 YES- IGNORE REQUEST                          
         EJECT                                                                  
*=====================================================================*         
* BUILD $STATUS REPLY IN INPUT BUFFER                                 *         
*=====================================================================*         
         DC    H'0' ============ CODE SHOULD NEVER EXECUTE ===========          
         L     RE,FARPLIOA                                                      
         MVC   0(5,RE),=X'1140401D60'                                           
         LA    R1,5(RE)                                                         
         BRAS  RE,BLDSTAT          SET STATUS MESSAGE                           
*                                                                               
         L     RE,FARPLIOA                                                      
         MVI   65(RE),ETX                                                       
         AHI   RE,-8               BACK UP TO HEADER                            
         ST    R3,0(RE)            SET UTL ENTRY ADDRESS                        
         LHI   RF,66                                                            
         ST    RF,4(RE)            STORE 0000.LEN                               
         L     R0,FARPLIOA                                                      
         GOTO1 VLCM,P1,VTWRITE,(R3),(R0)                                        
         XC    FARPLIOA,FARPLIOA   CLEAR RPL BUFFER ADDRESS                     
         B     NXT02                                                            
*                                                                               
NXT50    L     RE,FARPLIOA                                                      
         AHI   RE,-8               BACK UP TO HEADER                            
         ST    R3,0(RE)            SET UTL ENTRY ADDRESS                        
*                                                                               
         L     RF,FARPLIOL         BUFFER SIZE                                  
         ST    RF,4(RE)            STORE 0000.LEN                               
*                                                                               
         MVC   TBUFF,FARPLIOA      MOVE BUFFER ADDR TO TRM ENTRY                
         XC    FARPLIOA,FARPLIOA   CLEAR RPL BUFFER ADDRESS                     
         XC    FARPLIOL,FARPLIOL   CLEAR MSG LEN                                
         NI    TSTAT3,255-TSTATWIP WRITE NOT PENDING                            
         NI    TSTAT4,255-TST4HUNG TURN OFF ANY WRITE HUNG                      
*                                                                               
*AH3     CODE DOESN'T DO ANYTHING, COMMENTED OUT MAR24TH 2011.                  
*                                                                               
*        OC    TXPRNT,TXPRNT       TEST PRINTER                                 
*        BNZ   NXT52                                                            
*        TM    TTYPE2,TTYPE2SF     TEST SF TRANSMIT                             
*        BO    NXT52                                                            
         EJECT                                                                  
*=====================================================================*         
* QUEUE INPUT TO PROPER SE                                            *         
*=====================================================================*         
NXT52    L     R6,TBUFF            SET FLAG TO INDICATE REAL INPUT              
         AHI   R6,-8                                                            
         OI    4(R6),X'20'                                                      
         GOTO1 VMSGQIN,P1,(R2),TBUFF,(R3)                                       
*                                                                               
         NI    4(R6),255-X'20'     CLEAR REAL INPUT FLAG                        
         EJECT                                                                  
*=====================================================================*         
* ISSUE ANOTHER VTAM RECEIVE IF BUFFER AVAILABLE                      *         
*=====================================================================*         
         USING SSBD,RE                                                          
RCV      L     RE,VSSB                                                          
         TM    SSBSTAT1,SSBSEOJ    TEST EOJ PENDING                             
         BO    NXTRPL              YES - NO MORE READS                          
         DROP  RE                                                               
         TM    FARPLFLG,FARPLRD    TEST A RECEIVE RPL                           
         BZ    NXTRPL              NO - JUST CONTINUE                           
*                                                                               
         L     R1,FARPLRPL         POINT TO RPL                                 
         TM    69(R1),X'FF'        TEST SOMEHOW STILL BUSY                      
         BO    RCV12X              YES - GET OUT NOW                            
*                                                                               
         OC    FARPLIOA,FARPLIOA   TEST BUFFER ASSIGNED                         
         BNZ   RCV2                                                             
*                                                                               
         BRAS  RE,GETBUFF          GET AN INPUT BUFFER                          
         LTR   R1,R1                                                            
         BZ    NXTRPL              BUFFER RETURNED                              
         ST    R1,FARPLIOA         ELSE SET ADDRESS IN RPL                      
*                                                                               
RCV2     XC    FARPLIOL,FARPLIOL   RESET LENGTH                                 
         L     R1,FARPLIOA                                                      
         MVI   0(R1),C'*'                                                       
         MVC   1(15,R1),0(R1)      SET A FLAG FOR LATER                         
*                                                                               
         L     R8,FARPLRPL         POINT TO RPL                                 
         TM    RPLEXTDS,X'04'      IF THIS FLAG IS ON,                          
         BO    RCV12               RPLARG POINTS TO A NIB                       
         OC    RPLARG,RPLARG       ELSE IT IS A CID                             
         BZ    RCV12               SKIP RESETSR IF NO CID                       
                                                                                
         RESETSR RPL=(R8),OPTCD=(CA,SYN)   THIS IS SYNCHRONOUS                  
         LTR   RF,RF               IF YOU CHANGE IT BE SURE TO FLAG             
         BZ    *+8                 THE RPL AS BUSY                              
         BRAS  RE,LCMTRC           TRACE THE EVENT AND CONTINUE                 
         EJECT                                                                  
RCV12    L     R4,FARPLIOA         GET I/O AREA ADDRESS                         
         LA    R4,4(R4)            LEAVE TOP 4 BYTES OPEN                       
         L     R5,=A(TBUFFXL-5)    TBUFF  -  LEAVE ROOM FOR STX...ETX           
*                                                                               
         RECEIVE RPL=(R8),AREA=(R4),AREALEN=(R5),OPTCD=(Q,ASY,ANY,CS), X        
               RTYPE=(DFSYN,RESP),ECB=INTERNAL                                  
*                                                                               
         LTR   RF,RF                                                            
         BZ    RCV12X                                                           
         DC    H'0'                                                             
*                                                                               
RCV12X   OI    FARPLFLG,FARPLBSY   SET BUSY                                     
         B     NXTRPL                                                           
         EJECT                                                                  
*=====================================================================*         
* A VTAM SEND RPL IS FREE - RELEASE BUFFER AND TEST SENDS PENDING     *         
* NTRY: R7    = FARPL                                                 *         
*       R8    = RPL                                                   *         
*=====================================================================*         
WRT      L     R1,FARPLRPL                                                      
         TM    69(R1),X'FF'        TEST SOMEHOW RPL IS BUSY                     
         BO    WRT26               YES - GET OUT                                
*                                                                               
         ICM   R3,15,FARPLUTL      GET UTL POINTER                              
*&&DO*&& BZ    *+12                                                             
*&&DO*&& NI    TSTAT3,255-TSTATWIP                                              
*&&DO*&& NI    TSTAT4,255-TST4HUNG                                              
*                                                                               
         OC    FARPLIOA,FARPLIOA   TEST BUFFER ASSIGNED                         
         BZ    WRT02               NO                                           
*                                                                               
         ICM   R4,15,TXTWIN        VIRTUAL UTL INVOLVED?                        
         BNZ   *+6                                                              
         LR    R4,R3               SIAMESE TWIN THEN!!!                         
                                                                                
TWIN     USING UTLD,R4                                                          
*=====================================================================*         
* SOME STRUCTURED FIELD WRITES DON'T GET A RESPONSE                   *         
*=====================================================================*         
         TM    TWIN.TTYPE2,TTYPE2SC                                             
         BZ    WRT01               ONLY IF STRUCTURED FIELD MODE                
*                                                                               
         XR    RF,RF                                                            
         ICM   RF,1,TWIN.TTSCCNT   TEST CONVERSATION COUNTER                    
         BZ    *+10                NON-ZERO (CONTINUE)                          
         BCTR  RF,0                                                             
         STC   RF,TWIN.TTSCCNT     DECREMENT AND SAVE                           
*                                                                               
WRT01    TM    TWIN.TTYPE2,TTYPE2CH   STRUCTURED FIELD CHAINED WRITES           
         BZ    WRT01A                                                           
         LR    R3,R4               REQUEUE TWINNED TERMINAL                     
         B     NXT50                                                            
*                                                                               
WRT01A   NI    TWIN.TTYPE2,255-TTYPE2SC                                         
         NI    TTYPE2,255-TTYPE2SC                                              
*                                                                               
         L     R1,FARPLIOA                                                      
         BRAS  RE,FREEBUFF                                                      
         XC    FARPLIOA,FARPLIOA                                                
*                                                                               
         XC    TXTWIN,TXTWIN       CLEAR OUT JOINS                              
         XC    TWIN.TXTWIN,TWIN.TXTWIN                                          
***********************************************************************         
* PULL FROM HEAD OF QUEUE OF UTL READY TO WRITE OUT                             
***********************************************************************         
WRT02    ICM   R0,15,OUTQLEN       TEST ANY OUTPUT QUEUE                        
         BZ    NXTRPL              NO, BUMMER                                   
*                                                                               
         USING UTLD,R3                                                          
         L     R3,OUTQFRST                                                      
         ICM   R4,15,TXTWIN        VIRTUAL UTL INVOLVED?                        
         BNZ   *+6                                                              
         LR    R4,R3               SIAMESE TWIN THEN!!!                         
*                                                                               
         MVC   OUTQFRST,TXNEXTOT   SET NEW HEAD OF QUEUE                        
         XC    TXNEXTOT,TXNEXTOT   CLEAR POINTER                                
         L     R0,OUTQLEN                                                       
         BCTR  R0,0                DECR QUEUE LEN                               
         ST    R0,OUTQLEN                                                       
         LTR   R0,R0               TEST ANY LEFT IN QUEUE                       
         BNZ   *+10                                                             
         XC    OUTQLAST,OUTQLAST                                                
*                                                                               
         NI    TSTAT3,255-TSTATWRT WRITE PENDING (NOT YET SO CLEAR)             
*                                                                               
         ICM   R0,15,TCID          TEST STILL LOGGED ON                         
         BZ    WRT28               NO, CLOSE DEST WHILE QUEUED?                 
*                                                                               
         TM    TSTAT3,TSTATWIP     TEST PREVIOUS WRITE STILL ACTIVE             
         BZ    WRT04               NO, SO ALL IS GOOD                           
*&&DO*&& TM    TSTAT1,TSTATWEB     ALLOW WEB TERMINALS (OSA BOX)                
*&&DO*&& BO    WRT04               EVERYTHING WILL BE OSA, SO?                  
         TM    TSTAT1,TSTATMWT     ALLOW MULTI WRITES                           
         BO    WRT04                                                            
         TM    TSTAT4,TST4HUNG     HAVE WE HIT A WRITE HUNG ALREADY             
         BO    WRT03               RECORD EVENT, LU IS LOST                     
         OI    TSTAT4,TST4HUNG     SET FLAG THAT WRITE HUNG                     
         B     WRT04               SET THAT WE THINK IT IS WRITE HUNG           
*                                                                               
WRT03    NI    TSTAT6,255-TST6IAMD IF IAM DEST TURN THIS OFF                    
         MVI   DDSFLAG,8           SET TRACE MESSAGE NUMBER                     
         BRAS  RE,LCMTRC                                                        
*                                                                               
         TIME  DEC                                                              
         L     RE,VSSB                                                          
         STCM  R0,15,SSBVTHNG-SSBD(RE)                                          
         B     WRT02               GET NEXT UTL OUT OF QUEUE                    
*                                                                               
WRT04    NI    TSTAT1,X'FF'-TSTATMWT   MULTI-WRITE                              
         OI    TSTAT3,TSTATWIP     SET WRITE IN PROCESS                         
         ST    R3,FARPLUTL         SET UTL POINTER                              
         ST    R3,RPLUSFLD         SET HERE FOR TRACE IF ERROR                  
*                                                                               
         LA    R5,TMSGBUFF         IF TMSGBUFF PRESENT, SEND IT                 
         OC    0(4,R5),0(R5)                                                    
         BNZ   *+8                                                              
         LA    R5,TBUFF                                                         
         OC    0(4,R5),0(R5)       TEST STILL HAVE BUFFER                       
         BNZ   WRT06                                                            
         MVI   DDSFLAG,2           SET TRACE MSGNUM                             
         BRAS  RE,LCMTRC                                                        
         B     NXTRPL              AND GET OUT FAST                             
*                                                                               
WRT06    MVC   FARPLIOA,0(R5)      SAVE MESSAGE ADDRESS                         
         XC    0(4,R5),0(R5)       CLEAR BUFFER ADDRESS IN UTL                  
         L     RE,FARPLIOA                                                      
         AHI   RE,-8                                                            
         SR    R6,R6                                                            
         ICM   R6,3,6(RE)          GET MESSAGE LENGTH                           
         ST    R6,FARPLIOL         SET MESSAGE LENGTH                           
         BNZ   WRT08                                                            
                                                                                
*=====================================================================*         
* ZERO LENGTH MESSAGE IS SPECIAL FROM SRTOP                           *         
*=====================================================================*         
**NOP**  MVI   DDSFLAG,3           SET TRACE MSGNUM                             
**NOP**  BRAS  RE,LCMTRC                                                        
         L     R1,FARPLIOA         RELEASE BUFFER AND EXIT                      
         BRAS  RE,FREEBUFF                                                      
         XC    FARPLIOA,FARPLIOA                                                
         B     NXTRPL                                                           
*                                                                               
WRT08    OC    TXPRNT,TXPRNT       TEST PRINTER                                 
         BNZ   WRT18                                                            
         L     R5,FARPLIOA                                                      
         TM    TWIN.TTYPE2,TTYPE2SF+TTYPE2SC   XMT STRUCTURED FIELD             
         BNZ   WRT10                                                            
*                                                                               
         MVC   DUB(1),5(RE)          SAVE WRITE TYPE                            
         MVC   4(4,RE),=X'0227F1C3'  MOVE STX/ESC/WRT/WCC TO BUFFHDR            
         TM    DUB,X'01'             TEST WRITE ERASE                           
         BZ    *+8                                                              
         MVI   6(RE),X'F5'                                                      
         TM    DUB,X'02'             TEST SOUND ALARM                           
         BZ    *+8                                                              
         MVI   7(RE),X'C7'                                                      
*                                                                               
         L     R5,FARPLIOA         POINT TO BUFFER                              
         AHI   R5,-2               FOR BSC START WITH WCC AT BUFF-2             
         L     R6,FARPLIOL         NET CHANGE TO LENGTH                         
         LA    R6,1(R6)            IS PLUS 1                                    
*                                                                               
WRT10    MVI   RPLRH3,0            RESET BRACKET FLAGS                          
         TM    TSTAT3,TSTATBB      TEST BB SENT                                 
         BO    *+12                YES                                          
         OI    TSTAT3,TSTATBB      SET FLAG THAT BB SENT                        
         OI    RPLRH3,RPLBB        SET BB IN RPL CHAIN                          
         EJECT                                                                  
         SEND  RPL=(R8),AREA=(R5),RECLEN=(R6),ARG=(R0),STYPE=REQ,      X        
               POST=SCHED,OPTCD=(ASY,LMPEO,CA),RESPOND=(EX,QRESP),     X        
               CHNGDIR=CMD                                                      
         ORG   *-2                 ORG OVER BASR 14,15                          
         TM    RPLRH3,RPLBB        TEST BB SET                                  
         BZ    *+8                                                              
         NI    20(R1),X'FB'        IF BB SET, SET RESPOND=NEX                   
*                                                                               
         TM    TWIN.TTYPE2,TTYPE2CH   STRUCTURED FIELD CHAINED WRITE            
         BZ    *+8                 NO                                           
         NI    RPLRH3,255-X'20'    TURN OFF CHNGDIR                             
*                                                                               
         TM    TSTAT6,TST6IAMD     TEST IAM DEST                                
         BZ    WRT14                                                            
         NI    RPLRH3,255-X'20'    TURN OFF CHNGDIR                             
         OI    RPLRH3,RPLEB        TURN ON END BRACKET                          
         NI    TSTAT3,255-TSTATBB                                               
         B     WRT16                                                            
*                                                                               
WRT14    OC    TBUFF,TBUFF         IF WE STILL HAVE A TBUFF                     
         BZ    WRT16                                                            
         NI    RPLRH3,255-X'20'    TURN OFF CHNGDIR                             
*                                                                               
WRT16    BASR  RE,RF                                                            
         B     WRT24                                                            
         EJECT                                                                  
*=====================================================================*         
* BUFFER FORMAT IS  STX/ESC/WCC/WCC ... EOM/ETX                       *         
* MUST SEND WCC                                                       *         
*=====================================================================*         
WRT18    MVI   RPLRH3,0            CLEAR PREVIOUS                               
*                                                                               
         L     R5,FARPLIOA         POINT TO BUFFER                              
         LA    R5,2(R5)            FOR BSC START WITH WCC                       
         L     R6,FARPLIOL         NET CHANGE TO LENGTH                         
         AHI   R6,-3               INCLUDES ETX                                 
*                                                                               
         TM    TSTAT3,TSTATBB      TEST BB SENT (FIRST BUFFER)                  
         BZ    WRT20               FIRST - LEAVE CTL CHARS IN MSG               
**NOP**  LA    R5,3(R5)            ELSE REMOVE THEM                             
**NOP**  AHI   R6,-3                                                            
         B     WRT22                                                            
*                                                                               
WRT20    OI    TSTAT3,TSTATBB      SET FLAG THAT BB SENT                        
         OI    RPLRH3,RPLBB        SET BB IN RPL CHAIN                          
*                                                                               
WRT22    ICM   RF,15,TXPRNT                                                     
         TM    PNEX-PRQD(RF),PREXEOR   TEST E-O-R PENDING                       
         BZ    *+12                                                             
         NI    TSTAT3,255-TSTATBB      RESET BB SENT                            
         OI    RPLRH3,RPLEB                                                     
*                                                                               
         SEND  RPL=(R8),AREA=(R5),RECLEN=(R6),ARG=(R0),STYPE=REQ,      X        
               POST=SCHED,OPTCD=(ASY,LMPEO,CA),RESPOND=(NEX,FME,QRESP)          
*                                                                               
WRT24    LTR   RF,RF                                                            
         BZ    WRT26                                                            
         DC    H'0'                                                             
*                                                                               
WRT26    OI    FARPLFLG,FARPLBSY                                                
         B     NXTRPL                                                           
                                                                                
*=====================================================================*         
* ABORT WRITE - TERMINAL NO LONGER CONNECTED                          *         
*=====================================================================*         
WRT28    MVI   DDSFLAG,4           SET TRACE MSGNUM                             
         BRAS  RE,LCMTRC                                                        
*                                                                               
         ICM   R4,15,TXTWIN                                                     
         BNZ   *+6                                                              
         LR    R4,R3                                                            
         XC    TXTWIN,TXTWIN                                                    
         XC    TWIN.TXTWIN,TWIN.TXTWIN                                          
         NI    TWIN.TTYPE2,255-TTYPE2SC                                         
         NI    TTYPE2,255-(TTYPE2SC+TTYPE2CH)                                   
*                                                                               
         ICM   R1,15,TMSGBUFF      TEST FOR EXP FLOW FIRST                      
         BZ    *+8                                                              
         BRAS  RE,FREEBUFF                                                      
         XC    TMSGBUFF,TMSGBUFF                                                
         ICM   R1,15,TBUFF         RELEASE BUFFER                               
         BZ    *+8                                                              
         BRAS  RE,FREEBUFF                                                      
         XC    TBUFF,TBUFF                                                      
         B     NXTRPL                                                           
         EJECT                                                                  
*=====================================================================*         
* PROCESS VTAM LOGON/SIMLOGON REQUESTS                                *         
*=====================================================================*         
CTL      TM    FARPLFLG,FARPLLOG   TEST A LOGON RPL                             
         BZ    CTCLS               NO - MUST BE CLSDST RPL                      
*                                                                               
         L     R0,LOGQLEN                                                       
         A     R0,SIMQLEN                                                       
         LTR   R0,R0               IF NO LOG ACTIONS PENDING, EXIT              
         BZ    NXTRPL                                                           
                                                                                
*=====================================================================*         
* FIND A  UTL ENTRY WITH A LOGON/SIMLOGON PENDING                     *         
*=====================================================================*         
         L     R3,VUTL                                                          
         LH    R4,0(R3)                                                         
         L     R5,2(R3)                                                         
         LA    R3,6(R3)                                                         
         USING UTLD,R3                                                          
*                                                                               
CTLOG2   TM    TSTAT3,TSTATLOG+TSTATSIM       TEST ACTION PENDING               
         BNZ   CTLOG10                                                          
         BXLE  R3,R4,CTLOG2                                                     
                                                                                
*=====================================================================*         
* NO ACTIONS PENDING IN UTL - MUST HAVE BAD COUNTER SO RESET          *         
*=====================================================================*         
CTLOG4   L     R1,SIMQLEN                                                       
         SR    R0,R0                                                            
         CS    R1,R0,SIMQLEN                                                    
         BNZ   CTLOG4                                                           
*                                                                               
CTLOG6   L     R1,LOGQLEN                                                       
         SR    R0,R0                                                            
         CS    R1,R0,LOGQLEN                                                    
         BNZ   CTLOG6                                                           
         B     CTLOGX                                                           
         EJECT                                                                  
*=====================================================================*         
* ACTION PENDING                                                      *         
*=====================================================================*         
CTLOG10  TM    TSTAT3,TSTATSIM     TEST SIMLOGON PENDING                        
         BZ    CTLOG20                                                          
*                                                                               
         L     R4,FARPLNIB                                                      
         USING ISTDNIB,R4                                                       
         MVC   NIBSYM,TSYM                                                      
         XC    NIBLMODE,NIBLMODE   CLEAR LOGMODE                                
         DROP  R4                                                               
*                                                                               
CTLOG12  OI    FARPLFLG,FARPLBSY   SET RPL BUSY                                 
*                                                                               
         ST    R3,RPLUSFLD         SET UTL ADDRESS IN RPL                       
*                                                                               
**       SIMLOGON RPL=(R8),OPTCD=ASY,POST=SCHED,NIB=(R4)                        
*                                                                               
*        ALLOW Q'ING FOR PRINTERS THAT ARE AT THEIR SESSION LIMIT               
*        BUT NOT FOR THOSE NOT-ENABLED BECAUSE I HAVE NO IDEA WHAT              
*        THIS MEANS.  ONCE A SESSION CAN BE ESTABLISHED THE LOGON EXIT          
*        WILL BE DRIVEN AND ULTIMATELY WE WILL DO AN OPNDST AS WELL             
*                                                                               
         SIMLOGON RPL=(R8),OPTCD=(ASY,Q,QALL),NIB=(R4)                          
*               SIMLOGON'S USE THE SAME RPLS AS OPNDST                          
*               SOME OPTCD SETTINGS ARE APPLICABLE TO BOTH MACROS               
*               SO BECAREFUL WHEN CHANGING THEM ON EITHER MACRO                 
*                                                                               
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         EJECT                                                                  
         NI    TSTAT3,255-TSTATSIM RESET FLAG                                   
         LA    R1,SIMQLEN                                                       
         BRAS  RE,QDOWN                                                         
         B     CTLOGX                                                           
*                                                                               
CTLOG20  TM    TSTAT3,TSTATLOG     TEST LOGON PENDING                           
         BO    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    TSTAT4,TST4LU62     IS IT A LU6.2 SESSION REQUEST?               
         BO    CTL62L1             YES, GO PROCESS AS ACCORDINGLY               
         SPACE 1                                                                
*=====================================================================*         
* GET THE BIND IMAGE TO SET TERMINAL ATTRIBUTES                       *         
*=====================================================================*         
         SPACE 1                                                                
         LA    R8,SESSRPL                                                       
         L     R4,RPLARG                                                        
         USING ISTDNIB,R4                                                       
         MVC   NIBSYM,TSYM         SET LUID IN NIB                              
         DROP  R4                                                               
         LA    R4,SESSAREA                                                      
         XC    0(256,R4),0(R4)                                                  
*                                                                               
         INQUIRE RPL=(R8),ACB=ACB,OPTCD=SESSPARM                                
*                                                                               
         USING ISTDBIND,R4                                                      
         TM    BINPSCHR,X'80'      TEST SUPPORTS EXTENDED ATTRIBUTES            
         B     *+14                NO-OP THIS                                   
         OI    TTYPE,TTYPECOL                                                   
         MVC   TCLRMSK,=X'81234567'   SET DEFAULT COLOURS                       
         DROP  R4                                                               
*                                                                               
         L     R4,FARPLNIB                                                      
         USING ISTDNIB,R4                                                       
         MVC   NIBSYM,TSYM                                                      
         MVC   NIBCID,TCID         USE EXACTLY THE CID GIVEN IN THE             
*                                  LOGON EXIT DUE TO PARALLEL SESSIONS          
         XC    NIBLMODE,NIBLMODE   CLEAR LOGMODE                                
*                                                                               
CTLOG22  ST    R3,NIBUSER          SET UTL ADDRESS IN USER DATA                 
         DROP  R4                                                               
*                                                                               
         L     R8,FARPLRPL                                                      
         ST    R3,RPLUSFLD         SET IN RPL BECAUSE OPNDST DOESN'T            
         OI    FARPLFLG,FARPLBSY   SET BUSY FLAG                                
         OPNDST RPL=(R8),NIB=(R4),OPTCD=(ASY,ACCEPT,CA,NQ)                      
*                       OPNDST AND SIMLOGON USE THE SAME RPLS AND               
*                       SOME OPTCD VALUES ARE COMMON TO BOTH MACROS             
         LTR   RF,RF                                                            
         BZ    CTLOGXY                                                          
         DC    H'0'                                                             
*=====================================================================*         
*   PROCESS LU6.2 LOGON REQUESTS                                      *         
*   THIS REQUIRES THAT THE SESSION BE FORMALLY ACCEPTED               *         
*   THE PROCESSING IS DONE HERE OUTSIDE OF THE RESTRICTIVE            *         
*   ENVIRONMENT OF THE VTAM LOGON (IRB) EXIT                          *         
*=====================================================================*         
         SPACE 1                                                                
CTL62L1  ST    R7,FA62SAVE                                                      
         BRAS  RE,DOACTSES                                                      
*                                                                               
         L     R7,FA62SAVE                                                      
CTLOGXY  NI    TSTAT3,X'FF'-TSTATLOG                                            
         LA    R1,LOGQLEN                                                       
         BRAS  RE,QDOWN                                                         
*                                                                               
CTLOGX   B     NXTRPL                                                           
*                                                                               
DOACTSES DC    H'0'                                                             
*                                                                               
FA62SAVE DC    F'0'             SAVE AREA FOR FARPL ADDRESS                     
         EJECT                                                                  
*=====================================================================*         
* PROCESS VTAM CLSDST REQUESTS                                        *         
*=====================================================================*         
         SPACE 1                                                                
CTCLS    TM    FARPLFLG,FARPLCLS   TEST A CLSDST RPL                            
         BZ    CTCLSX              NO - MUST BE LU62                            
         OC    CLSQLEN,CLSQLEN     IF NO CLS ACTIONS PENDING, EXIT              
         BZ    CTCLSX                                                           
         SPACE 1                                                                
*=====================================================================*         
* FIND A UTL ENTRY WITH A CLSDST PENDING                              *         
*=====================================================================*         
         SPACE 1                                                                
         SR    R1,R1               CLSQUE COUNTER                               
         XC    FULL,FULL           A(TERMINAL TO BE CLOSED)                     
         L     R3,VUTL                                                          
         LH    R4,0(R3)                                                         
         L     R5,2(R3)                                                         
         LA    R3,6(R3)                                                         
         USING UTLD,R3                                                          
         MVI   CLSFLAG,0           RESET CLSDST PENDING FOUND                   
*                                                                               
CTCLS2   TM    TSTAT3,TSTATCLS     TEST CLSDST PENDING                          
         BZ    CTCLS2X             NO                                           
         LA    R1,1(R1)            BUMP CLSQ COUNTER                            
         OC    TXNEXTIN,TXNEXTIN   IS ANYONE AFTER HIM                          
         BNZ   CTCLS2A             FOR FUCKSAKE DONT TAKE HIM OUT               
         TM    TSTAT2,TSTATTIP     TEST TERMINAL IN PROCESS                     
         BO    CTCLS2A             YES - DEFER                                  
         TM    TSTAT8,TST8INQ      TEST TERMINAL IN A QUEUE SOMEWHERE           
         BO    CTCLS2A             YES - DEFER                                  
         ST    R3,FULL                                                          
         B     CTCLS2X                                                          
*                                                                               
CTCLS2A  MVI   CLSFLAG,C'Y'        SET FLAG FOR DEFERRED CLSDST FOUND           
*                                                                               
CTCLS2X  BXLE  R3,R4,CTCLS2                                                     
*                                                                               
         C     R1,CLSQLEN                                                       
         BE    CTCLS3                                                           
         ST    R1,CLSQLEN                                                       
         WTO   '+LCM+ CLSQ COUNTER IS WRONG '                                   
*                                                                               
CTCLS3   ICM   R3,15,FULL                                                       
         BNZ   CTCLS10                                                          
         SPACE 1                                                                
*=====================================================================*         
* NO CLSDSTS PENDING IN UTL - RESET COUNTER UNLESS DEFERRED           *         
*   CLSDSTS PENDING                                                   *         
*=====================================================================*         
         SPACE 1                                                                
         CLI   CLSFLAG,0           TEST DEFERRED CLSDST PENDING                 
         BNE   CTCLSX              YES - DON'T RESET COUNTER YET                
*                                                                               
CTCLS4   L     R1,CLSQLEN                                                       
         SR    R0,R0                                                            
         CS    R1,R0,CLSQLEN                                                    
**NOP**  BNZ   CTCLS4              REMOVED 24OCT96 MH. IF COUNT IS              
         B     CTCLSX              WRONG, JUST LEAVE IT ALONE                   
         EJECT                                                                  
CTCLS10  DS    0H                  BEFORE CLSDST, CHECK SESSION ACTIVE          
         GOTO1 VLCM,P1,VTGETCID,(R3),0                                          
         OC    12(2,R1),12(R1)     TEST RETURN CODE                             
         BNZ   CTCLS17             NON-ZERO ==> CLEAN UP AND GET OUT            
*                                                                               
         TM    TSTAT4,TST4CLIP     TEST CLSDST IN PROCESS ALREADY               
         BO    CTCLS16             YES - DROP DUPLICATE REQUEST                 
         TM    TSTAT3,TSTATNAM     TEST CLSDST BY NAME NECESSARY                
         BO    CTCLS14                                                          
         ICM   R0,15,TCID          TEST ALREADY DISCONNECTED                    
         BZ    CTCLS16                                                          
*                                                                               
         TM    TSTAT4,TST4SWAP     TEST CLS & SWAP REQUESTED                    
         BO    CTCLS11                                                          
*                                                                               
CTCLS10A ST    R3,RPLUSFLD         SET UTL ADDRESS IN RPL                       
         OI    FARPLFLG,FARPLBSY                                                
         CLSDST RPL=(R8),ARG=(R0),OPTCD=(ASY,RELEASE)                           
         LTR   RF,RF                                                            
         BZ    CTCLS16                                                          
         DC    H'0'                                                             
         EJECT                                                                  
* CLSDST AND SWAP *                                                             
CTCLS11  NI    TSTAT4,255-TST4SWAP CLR SWAP BIT                                 
         SR    R4,R4                                                            
         SR    R5,R5                                                            
         ICM   R4,15,TBUFF         TBUFF SHOULD CONTAIN SWAP PARMS              
         BZ    *+12                                                             
         IC    R5,0(R4)            TBUFF+0 IS MESSAGE LEN                       
         LA    R4,1(R4)            TBUFF+1 IS MESSAGE                           
*                                                                               
         L     RE,VSSB                                                          
         MVC   DUB(1),SSBSYSID-SSBD(RE)                                         
         CLI   TSWAPLID,0          LOOK FOR SWAP ID IN UTL                      
         BE    *+14                                                             
         MVC   DUB(1),TSWAPLID     USE IT IF THERE                              
         B     CTCLS11C                                                         
*                                                                               
         LA    RE,SWAPTAB2                                                      
CTCLS11A CLI   0(RE),X'FF'         EOT DO NORMAL CLSDST                         
         BE    CTCLS10A                                                         
         CLC   0(1,RE),DUB         FIND THIS SYSTEM                             
         BE    CTCLS11B                                                         
         LA    RE,2(RE)                                                         
         B     CTCLS11A            TRY NEXT TABLE ENTRY                         
*                                                                               
CTCLS11B MVC   DUB(1),1(RE)        DUB=SYS TO SWAP TO                           
*                                                                               
CTCLS11C LA    RE,SWAPTAB                                                       
CTCLS11D CLI   0(RE),X'FF'         EOT DO NORMAL CLSDST                         
         BE    CTCLS10A                                                         
         CLC   0(1,RE),DUB         FIND THIS APPLID                             
         BE    CTCLS11E                                                         
         LA    RE,9(RE)                                                         
         B     CTCLS11D            TRY NEXT TABLE ENTRY                         
*                                                                               
CTCLS11E MVC   SWAPLID,1(RE)       MOVE APPLID TO SWAPPLID                      
*                                                                               
         ST    R3,RPLUSFLD         SET UTL ADDRESS IN RPL                       
         OI    FARPLFLG,FARPLBSY                                                
         CLSDST RPL=(R8),ARG=(R0),OPTCD=(ASY,PASS),AAREA=SWAPLID,      X        
               PARMS=(THRDPTY=NONOTIFY),AREA=(R4),RECLEN=(R5)                   
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* THIS CODE MOVED TO CLSDEST COMPLETIONS  /DELETE THIS NEXT UPDATE              
*                                                                               
*NOP     ICM   R1,15,TMSGBUFF      TEST FOR EXP FLOW FIRST                      
*        BZ    *+8                                                              
*        BRAS  RE,FREEBUFF                                                      
*        XC    TMSGBUFF,TMSGBUFF                                                
*        ICM   R1,15,TBUFF         RELEASE BUFFER                               
*        BZ    *+8                                                              
*NOP     BRAS  RE,FREEBUFF                                                      
*                                                                               
         XC    TBUFF,TBUFF                                                      
         B     CTCLS16                                                          
*                                                                               
SWAPLID  DC    CL8' '                                                           
         EJECT                                                                  
* CLSDST BY NAME *                                                              
         SPACE 1                                                                
CTCLS14  L     R4,FARPLNIB                                                      
         USING ISTDNIB,R4                                                       
         MVC   NIBSYM,TSYM                                                      
         ST    R3,RPLUSFLD         SET IN RPL IN CASE CLSDST DOESN'T            
         OI    FARPLFLG,FARPLBSY                                                
         CLSDST RPL=(R8),NIB=(R4),OPTCD=(ASY,RELEASE)                           
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
CTCLS16  OC    TXPRNT,TXPRNT       NEVER EVER DO THIS FOR PRINTERS              
         BNZ   CTCLS16A                                                         
         TM    TSTAT4,TST4SWAP     OR =SWAP                                     
         BO    CTCLS16A                                                         
         OC    TCTDATA,TCTDATA     OR CONNECTED TERMINALS                       
         BNZ   CTCLS16A                                                         
         TM    TSTAT1,TSTATSSV     OR SECURITY VIOLATORS                        
         BO    CTCLS16A                                                         
         OI    TSTATU,TSTATAVA     SET AVAILABLE FOR REUSE                      
*                                                                               
CTCLS16A OI    TSTAT4,TST4CLIP     SET CLSDST IN PROCESS                        
*                                                                               
CTCLS17  NI    TSTAT3,X'FF'-TSTATCLS-TSTATNAM-TSTATBB                           
         XC    TCID,TCID           RESET CID                                    
*                                                                               
         LA    R1,CLSQLEN          NOW ADJUST COUNT                             
         BRAS  RE,QDOWN                                                         
*                                                                               
         TM    TSTAT3,TSTATLOG     TEST LOGON PENDING TOO                       
         BZ    CTCLS18                                                          
         NI    TSTAT3,255-TSTATLOG                                              
         LA    R1,LOGQLEN                                                       
         BRAS  RE,QDOWN                                                         
*                                                                               
CTCLS18  TM    TSTAT3,TSTATSIM     TEST SIMLOGON PENDING TOO                    
         BZ    CTCLSX                                                           
         NI    TSTAT3,255-TSTATSIM                                              
         LA    R1,SIMQLEN                                                       
         BRAS  RE,QDOWN                                                         
*                                                                               
CTCLSX   B     NXTRPL                                                           
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* AS OF 12 SEP 90 14.55 I WOULD HOPE THAT WE NEVER HAVE TO LOOK AT              
* THE STUPID FUCKING CLSDST INSTRUCTIONS AGAIN. CERTAINLY THE ONES THAT         
* FOLLOW THIS REMARK DO NOT WORK TOO WELL.                                      
*=====================================================================*         
* CLSDEST PENDING ON DEVICE IN A QUEUE                                *         
* PURGE DEVICE FROM INPUT OR OUTPUT QUEUE                             *         
* R3 POINTS TO UTL ENTRY OF TERMINAL TO BE PURGED                     *         
*=====================================================================*         
*&&NOP                                                                          
CTCLS20  L     RE,OUTQFRST         GET POINTER TO FIRST IN Q                    
         CR    R3,RE               IS IT FIRST IN Q                             
         BNE   CTCLS22             NO                                           
         MVC   OUTQFRST,TXNEXTOT   SET NEW HEAD OF QUEUE                        
         B     CTCLS26                                                          
*                                                                               
CTCLS22  C     R3,TXNEXTOT-UTLD(RE) IS IT NEXT IN QUEUE                         
         BE    CTCLS24                                                          
         ICM   RE,15,TXNEXTOT-UTLD(RE)                                          
         BNZ   CTCLS22                                                          
         B     CTCLS30             NOT FOUND IN O/P QUEUE                       
*                                                                               
CTCLS24  MVC   TXNEXTOT-UTLD(4,RE),TXNEXTOT                                     
*                                                                               
CTCLS26  OC    TXNEXTOT,TXNEXTOT   WERE WE LAST IN QUEUE                        
         BNZ   CTCLS27                                                          
         ST    RE,OUTQLAST         YES - SET NEW LAST                           
         XC    TXNEXTOT,TXNEXTOT                                                
CTCLS27  L     R0,OUTQLEN                                                       
         BCTR  R0,0                DECR QUEUE LEN                               
         ST    R0,OUTQLEN                                                       
         LTR   R0,R0               TEST ANY LEFT IN QUEUE                       
         BNZ   *+10                                                             
         XC    OUTQLAST,OUTQLAST                                                
*                                                                               
CTCLS28  NI    TSTAT3,X'FF'-TSTATWRT                                            
         ICM   R1,15,TMSGBUFF      TEST FOR EXP FLOW FIRST                      
         BZ    *+8                                                              
         BRAS  RE,FREEBUFF                                                      
         XC    TMSGBUFF,TMSGBUFF                                                
         ICM   R1,15,TBUFF         RELEASE BUFFER                               
         BZ    *+8                                                              
         BRAS  RE,FREEBUFF                                                      
         XC    TBUFF,TBUFF                                                      
         B     CTCLS10             GO BACK AND ISSUE CLSDST                     
         EJECT                                                                  
*=====================================================================*         
* NOT FOUND IN O/P QUEUES - SEARCH I/P QUEUES                         *         
*=====================================================================*         
CTCLS30  SR    RF,RF                                                            
         ICM   RF,7,TASYS          POINT TO SELIST                              
         BZ    *+12                                                             
         BRAS  RE,CHKSE            REMOVE FROM QUEUE  (IF THERE)                
         BE    CTCLS28                                                          
*                                                                               
         L     RF,VSELIST          NOT IN SYSTEM QUEUE SEARCH SE1               
         LA    RF,6(RF)                                                         
         BRAS  RE,CHKSE            REMOVE FROM SE1 QUEUE (IF THERE)             
         B     CTCLS28                                                          
*                                                                               
         USING SELISTD,RF                                                       
CHKSE    L     R1,SEFIRST                                                       
         CR    R3,R1                   ARE WE FIRST IN QUEUE                    
         BNE   CHKSE2                                                           
         MVC   SEFIRST,TXNEXTIN        SET NEW HEAD OF QUEUE                    
         B     CHKSE6                                                           
*                                                                               
CHKSE2   C     R3,TXNEXTIN-UTLD(R1)    ARE WE NEXT IN QUEUE                     
         BE    CHKSE4                                                           
         ICM   R1,15,TXNEXTIN-UTLD(R1)                                          
         BNZ   CHKSE2                                                           
         B     CHKSENQ                 NOT FOUND IN QUEUE                       
*                                                                               
CHKSE4   MVC   TXNEXTIN-UTLD(4,R1),TXNEXTIN                                     
*                                                                               
CHKSE6   OC    TXNEXTIN,TXNEXTIN   WERE WE LAST IN QUEUE                        
         BZ    CHKSE7                                                           
         ST    R1,SELAST           YES - SET NEW LAST                           
         XC    TXNEXTIN,TXNEXTIN                                                
*                                                                               
CHKSE7   LH    R0,SEQLEN                                                        
         BCTR  R0,0                DECR QUEUE LEN                               
         STH   R0,SEQLEN                                                        
         LTR   R0,R0               TEST ANY LEFT IN QUEUE                       
         BNZ   CHKSEQ                                                           
         XC    SELAST,SELAST                                                    
*                                                                               
CHKSEQ   CR    RE,RE               REMOVED FROM QUEUE OK                        
         BR    RE                                                               
CHKSENQ  LTR   RE,RE               NOT FOUND IN QUEUE                           
         BR    RE                                                               
         DROP  RF                                                               
*&&                                                                             
         EJECT                                                                  
*=====================================================================*         
* QUEUE A PRINTER VIA MSGQIN IF OUTPUT BUFFER AVAILABLE               *         
*=====================================================================*         
         SPACE 1                                                                
PRT      ICM   R4,15,PRTQLEN       TEST PRINTER WRITE PENDING                   
         BZ    EXIT                NO - EXIT                                    
         OC    PRTQFRST,PRTQFRST   TEST HAVE A VALID QUEUE                      
         BNZ   PRT2                YES                                          
* IF NON-ZERO COUNTER WITH NO HEAD OF QUEUE, CLEAR COUNTER AND EXIT             
         XC    PRTQLEN,PRTQLEN                                                  
         XC    PRTQLAST,PRTQLAST   CAN'T HAVE LAST IF NO FIRST                  
         B     EXIT                                                             
*                                                                               
PRT2     BRAS  RE,GETBUFF          GET A BUFFER                                 
         LTR   R1,R1               TEST AVAILABLE                               
         BZ    EXIT                NO - EXIT                                    
         BCTR  R4,0                DECREMENT Q LEN                              
         ST    R4,PRTQLEN                                                       
*                                                                               
         L     R3,PRTQFRST         GET FIRST UTL ENTRY ADDRESS                  
         USING UTLD,R3                                                          
         STCM  R1,15,TBUFF         SET BUFFER ADDRESS                           
         MVC   PRTQFRST,TXNEXTOT   UPDATE FIRST IN QUEUE                        
         XC    TXNEXTOT,TXNEXTOT                                                
         OC    PRTQFRST,PRTQFRST                                                
         BNZ   *+10                                                             
         XC    PRTQLAST,PRTQLAST                                                
*                                                                               
         GOTO1 VMSGQIN,P1,(R2),TBUFF,(R3)                                       
         B     PRT                                                              
         EJECT                                                                  
*=====================================================================*         
* ERROR PROCESSING ROUTINES                                           *         
*=====================================================================*         
LCERR    DS    0H                                                               
         TM    TSTAT4,TST4TRC      TEST TRACE ACTIVE                            
         BO    *+8                 YES - EVENT ALREADY TRACED                   
         BRAS  RE,LCMTRC           ELSE TRACE IT NOW                            
*                                                                               
         XC    RPLECB,RPLECB                                                    
         CLC   =X'2003',RPLSSEI    TEST BRACKET STATE ERROR                     
         BE    LCERR20             YES - IGNORE ERROR                           
*                                                                               
         USING UTLD,R3                                                          
         ICM   R3,15,RPLUSFLD      POINT TO UTL ENTRY                           
         BZ    LCERR10                                                          
*                                                                               
         NI    TSTAT3,X'FF'-TSTATWIP  RESET WRITE IN PROC BIT                   
         OC    TXPRNT,TXPRNT       TEST PRINTER                                 
         BZ    LCERR10             NO                                           
         CLI   RPLREQ,RPLOPNDS     TEST OPNDST REQUEST                          
         BE    LCERR2                                                           
         CLI   RPLREQ,RPLSMLGO     TEST SIMLOGON REQUEST                        
         BNE   LCERR10                                                          
*                                                                               
LCERR2   OI    TSTAT4,TST4UNLG     SET PRINTER UNABLE TO LOG ON                 
         ICM   RE,15,TXPRNT                                                     
         OI    PRSTAT2-PRHDR(RE),PRS2UNLG  SET FLAG IN PRTQUE TOO               
         MVI   PRSTAT-PRHDR(RE),PRSERR     SET MASTER ERROR FLAG                
*                                                                               
LCERR10  MVC   DUB(1),RPLRTNCD                                                  
         MVC   DUB+1(1),RPLFDB2                                                 
         LA    R1,ERRTAB                                                        
*                                                                               
LCERR12  CLC   DUB(2),0(R1)        MATCH RETURN/FDBK2 CODES                     
         BE    LCERR14                                                          
         LA    R1,6(R1)                                                         
         CLI   0(R1),X'FF'                                                      
         BNE   LCERR12                                                          
         B     LCERR20             IGNORE ANY UNFUCKINGEXPECTED ERROR           
*                                                                               
LCERR14  CLC   2(4,R1),=A(IGNORE)                                               
         BE    LCERR20                                                          
         EJECT                                                                  
*                                                                               
LCERR16  ICM   RF,15,2(R1)         GET PROCESSNG ROUTINE ADDRESS                
         BNZ   *+6                                                              
         DC    H'0'                NO WAY TO DEAL WITH IT                       
         ICM   R3,15,RPLUSFLD      MAKE SURE RPLUSFLD STILL VALID               
         BZ    LCERR20             IF NOT, LET'S GET OUT FAST                   
         BASR  RE,RF               DON'T EXPECT RETURN HERE                     
*                                                                               
LCERR20  TM    FARPLFLG,FARPLWRT   TEST A WRITE RPL                             
         BZ    LCERRX                                                           
         ICM   R1,15,FARPLIOA      TEST I/O AREA GIVEN                          
         BZ    LCERRX                                                           
         BRAS  RE,FREEBUFF         RELEASE THE BUFFER                           
         XC    FARPLIOA,FARPLIOA                                                
*                                                                               
LCERRX   B     NXT18               RETURN TO MAINLINE                           
         EJECT                                                                  
*=====================================================================*         
* SIMLOGON/OPNDST FAILED - SET ERROR IF PRINTER                       *         
*=====================================================================*         
         SPACE 1                                                                
LC0008   ICM   RE,15,TXPRNT                                                     
         BZ    LC0404                                                           
         CLC   =X'0805',RPLSSEI    TEST SESSION LIMIT EXCEEDED                  
         BE    LC2019B             YES - SHUT PREVIOUS SESSION DOWN             
         MVI   PRSTAT-PRHDR(RE),PRSERR      SET MASTER ERROR FLAG               
         OI    PRSTAT3-PRHDR(RE),PRS3FTS    SET FAILED TO START                 
         B     LC0404X                      AND CLSDST IF NECESSARY             
                                                                                
*=====================================================================*         
* THIS IS A NEGATIVE RESPONSE FROM A 3270 PRINTER                     *         
*=====================================================================*         
LC0403   DS    0H                  EXCEPTION REQ RCVD                           
         CLC   RPLUSNSI,=X'0200'   TEST PURE DEVICE END POSTED                  
         BNE   LC0404              IF NOT, TREAT AS AN ERROR                    
         ICM   RE,15,TXPRNT                                                     
         BZ    LCERRX              IGNORE THIS                                  
         TM    PRSTAT-PRHDR(RE),PRSERR  TEST CURRENT STATUS = ERROR             
         BZ    *+12                     NO                                      
         NI    PRSTAT-PRHDR(RE),255-PRSERR  YES - RESET ERROR                   
         OI    PRSTAT-PRHDR(RE),PRSACTV     AND SET PRINTER ACTIVE              
         B     NXT40                                                            
                                                                                
*=====================================================================*         
* THIS IS A NEGATIVE RESPONSE                                         *         
*=====================================================================*         
LC0404   ICM   RE,15,TXPRNT        TEST DEVICE IS A PRINTER                     
         BZ    LC0404C             NO                                           
         TM    RPLSSEI,X'80'       TEST PATH ERROR                              
         BZ    LC0404A             NO                                           
         OI    PRSTAT2-PRHDR(RE),PRS2PATH  SET PATH ERROR FLAG                  
*                                                                               
LC0404A  DS    0H                                                               
         CLC   =X'2003',RPLSSEI    TEST FAILED TO START BRACKET                 
         BNE   LC0404B                                                          
         NI    TSTAT3,X'FF'-TSTATBB       SET TO START NEXT TIME                
         OI    PRSTAT2-PRHDR(RE),PRS2RTB  SET RETRANSMIT FLAG                   
         GOTO1 VLCM,P1,VTPRSTRT,(R3)      QUEUE PRINTER FOR WRITE               
         B     LCERR20                                                          
*                                                                               
LC0404B  MVI   PRSTAT-PRHDR(RE),PRSERR                                          
         B     LCERR20                                                          
*                                                                               
LC0404C  CLC   =X'0813',RPLSSEI    TEST BRACKET BID REJECT                      
         BNE   LC0404D                                                          
         TM    TSTAT6,TST6IAMD     TEST TERM IN RECEIVE MODE                    
         BZ    LC0404C1                                                         
*                                                                               
         NI    TSTAT6,X'FF'-TST6IAMD   CLEAR MODE                               
         OI    TSTAT2,TSTATNIT         FORCE RE                                 
         OI    TSTAT3,TSTATBB          SET BB SENT                              
         B     NXT40                   QUEUE TO SE                              
*                                                                               
LC0404C1 TM    TSTAT3,TSTATBRJ     TEST PREVIOUS BRACKET REJECT                 
         BO    LC0404X             YES - MAKE SURE NO LOOP                      
         OC    TBUFF,TBUFF         TEST BUFFER PRESENT                          
         BNZ   LCERR20             YES - IGNORE ERROR                           
         OI    TSTAT3,TSTATBRJ     NO - SET FLAG ON                             
         MVC   TBUFF,FARPLIOA      GIVE THE BUFFER TO THE TRM                   
         XC    FARPLIOA,FARPLIOA                                                
         B     NXTSEND             AND SEND WITHOUT START BRACKET               
*                                                                               
LC0404D  OI    TSTAT2,TSTATNIT     SET TRM NOT INITIALIZED                      
         CLC   =X'082B',RPLSSEI    TEST PRESENTATION SPACE LOST                 
         BE    LC0404X                                                          
         CLC   =X'0831',RPLSSEI                                                 
         BE    LC0404X                                                          
         B     LCERR20                                                          
         SPACE 1                                                                
*=====================================================================*         
* CLSDST THE TERMINAL FOR SPECIAL ERROR SITUATIONS                    *         
*=====================================================================*         
         SPACE 1                                                                
LC0404X  TM    TSTAT3,TSTATCLS     TEST CLSDST PENDING                          
         BO    LC0404X2                                                         
         TM    TSTAT2,TSTATTIP     TEST TRM IN PROCESS                          
         BO    LCERRX              IGNORE ERROR IF TRM IN PROCESS               
         OI    TSTAT3,TSTATCLS     SET CLSDST PENDING                           
         LA    R1,CLSQLEN                                                       
         BRAS  RE,QUP                                                           
LC0404X2 DS    0H                                                               
         POST  LCMECB                                                           
         B     LCERR20                                                          
         EJECT                                                                  
*=====================================================================*         
* TEMPORARY STORAGE SHORTAGE - WAIT AND RETRY                         *         
*=====================================================================*         
LC0800   DS    0H                  TEMP STORAGE SHORTAGE                        
         STIMERM SET,ID=STIMERID,BINTVL=WAITTIME,WAIT=YES                       
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
* RETRY THE FAILING RPL                                                         
         L     R1,FARPLRPL                                                      
         OI    FARPLFLG,FARPLBSY                                                
         EXECRPL RPL=(1)                                                        
         B     LCERR20                                                          
         EJECT                                                                  
*=====================================================================*         
* CID IS NOT VALID - SEE IF VTAM HAS A BETTER ONE                     *         
*=====================================================================*         
LC2019   DS    0H                  INVALID CID - ASSUME LOST SESSION            
         L     R4,TCID             SAVE OLD CID                                 
         XC    TCID,TCID           MY CID IS NO GOOD SO CLEAR IT                
         GOTO1 VLCM,P1,VTGETCID,(R3),0                                          
         OC    12(2,R1),12(R1)     TEST RCFD=0                                  
         BZ    LC2019A             IF SO, TRY RESEND WITH NEW CID               
*                                  ELSE ASSUME LOST SESSION                     
         MVI   DDSFLAG,5           SET TRACE MSGNUM                             
         BRAS  RE,LCMTRC                                                        
*                                                                               
         NI    TSTAT3,X'FF'-TSTATBB  RESET BRACKET CONTROL                      
         ICM   RE,15,TXPRNT                                                     
         BZ    LCERR20                                                          
         TM    PRSTAT2-PRHDR(RE),PRS2PATH DID WE HAVE A PATH ERROR              
         BO    LCERR20                    YES - LEAVE STATUS FOR SRTIM          
         MVI   PRSTAT-PRHDR(RE),0                                               
         NI    PNEX-PRHDR(RE),X'FF'-PREXACTV                                    
         LA    RF,PRCIADDR-PRHDR(RE)                                            
         XC    0(4,RF),0(RF)                                                    
         B     LCERR20                                                          
*                                                                               
LC2019A  L     R0,8(R1)            PICK UP NEW CID                              
         ST    R0,TCID             SAVE IN UTL                                  
*                                                                               
         MVI   DDSFLAG,6           SET TRACE MSGNUM                             
         BRAS  RE,LCMTRC                                                        
*                                                                               
         CR    R4,R0               TEST OLD CID = NEW CID                       
         BNE   LC2019D                                                          
         EJECT                                                                  
LC2019B  DS    0H                                                               
         OI    TSTAT3,TSTATNAM     SET CLSDST BY NAME REQUIRED                  
         TM    TSTAT3,TSTATCLS     TEST CLSDST ALREADY PENDING                  
         BO    LC2019C                                                          
         OI    TSTAT3,TSTATCLS     SET CLSDST PENDING                           
         LA    R1,CLSQLEN                                                       
         BRAS  RE,QUP                                                           
*                                                                               
LC2019C  DS    0H                                                               
         POST  LCMECB                                                           
         B     LCERR20                                                          
*                                                                               
LC2019D  CLI   RPLREQ,RPLSNDCD     TEST OPCODE = SEND                           
         BNE   LCERR20                                                          
*                                                                               
         SEND  RPL=(R8),ARG=(R0)   AND TRY AGAIN                                
         B     WRT24               AND GO POST RPL BUSY                         
*                                                                               
WAITTIME DC    F'100'              ONE SECOND                                   
STIMERID DC    F'0'                                                             
*                                                                               
         TITLE 'FALCM - SEND MESSAGE TO TERMINAL'                               
         EJECT                                                                  
*=====================================================================*         
* LCWRITE - MONITOR ENTERS HERE TO SEND A MESSAGE TO A TERMINAL       *         
*                                                                     *         
* NTRY: P2     = A(UTL)                                               *         
*       P3     = A(BUFFER)                      (EXP FLOW MESSAGE)    *         
*              = 0                              (NORMAL FLOW MESSAGE) *         
*                                                                     *         
* IF P3 = 0 THEN TBUFF POINTS TO BUFFER AND BUFFER IS PRECEDED BY AN  *         
* EIGHT BYTE HEADER COVERED BY FATBHD                                 *         
*                                                                     *         
* BYTES 0-3    UTL ENTRY ADDRESS                                      *         
*         4    SPARE                                                  *         
*         5    X'01'=WRITE ERASE/X'02'=SOUND ALARM                    *         
*       6-7    MESSAGE LENGTH                                         *         
*=====================================================================*         
         USING UTLD,R3             R4=ZERO IF TBUFF ELSE IS A(BUFFER)           
LCW      LM    R3,R4,4(R1)         R3=A(UTL ENTRY)                              
*                                                                               
         LTR   R4,R4               TEST NORMAL ENTRY                            
         BZ    *+12                YES                                          
         TM    TSTAT3,TSTATWRT     IS A WRITE ALREADY PENDING                   
         BO    LCW20                                                            
*                                                                               
         OI    TSTAT3,TSTATWRT     SET WRITE PENDING                            
         LTR   R4,R4               TEST FOR NORMAL FLOW MESSAGE                 
         BZ    LCW2                YES - ADDRESS IS IN TBUFF                    
         STCM  R4,15,TMSGBUFF      SAVE EXP FLOW MSG ADDRESS                    
         B     LCW10                                                            
*                                                                               
LCW2     OC    TCID,TCID           TEST TERMINAL LOGGED ON                      
         BNZ   LCW10               YES                                          
                                                                                
*=====================================================================*         
* IF TRM NOT LOGGED ON, RELEASE THE BUFFER                            *         
*=====================================================================*         
         LTR   R1,R4               TEST HAVE BUFFER ADDRESS                     
         BNZ   LCW4                                                             
         ICM   R1,15,TBUFF                                                      
         BZ    LCW6                TEST SOMEHOW IT HAS NO BUFFER                
*                                                                               
LCW4     BRAS  RE,FREEBUFF                                                      
*                                                                               
LCW6     NI    TSTAT3,X'FF'-TSTATWRT                                            
         XC    TBUFF,TBUFF         CLEAR TERMINAL BUFFER ADDR                   
         B     LCWX                                                             
         EJECT                                                                  
*=====================================================================*         
* TEST FOR =WATCH SOURCE TERMINAL. QUEUE TO DESTINATION               *         
*=====================================================================*         
LCW10    TM    TSTAT6,TST6IAMS     TEST IAM SOURCE                              
         BZ    LCW14               NO                                           
*                                                                               
         BRAS  RE,GETBUFF          GET ANOTHER BUFFER                           
         LTR   R8,R1                                                            
         BZ    LCW14               IF WE FAIL THEN FORGET IT                    
*                                                                               
         LR    R0,R1                                                            
         ICM   RE,15,TBUFF         GET A(BUFFER)                                
         BZ    LCW14                                                            
*                                                                               
         AHI   RE,-32              BACK UP TO HEADER                            
         AHI   R0,-32              BACK UP TO HEADER                            
         LHI   R1,32+TBUFFL                                                     
         LR    RF,R1                                                            
         MVCL  R0,RE               COPY THE BUFFER                              
*                                                                               
         ICM   R1,15,=V(IAMTAB)                                                 
         LH    RE,0(R1)            SET BXLE                                     
         L     RF,2(R1)                                                         
         LA    R1,6(R1)                                                         
         XR    R0,R0                                                            
         ICM   R0,3,TNUM                                                        
LCW11    C     R0,0(R1)            FIND LINKED TERMINAL                         
         BE    LCW12                                                            
         BXLE  R1,RE,LCW11                                                      
         NI    TSTAT6,255-TST6IAMS CLEAR FLAG IF NOT FOUND                      
         B     LCW14                                                            
*                                                                               
LCW12    L     RF,4(R1)            TEST TERMINAL FOR IAMD FLAG                  
         BCTR  RF,0                                                             
         L     RE,VUTL                                                          
         MH    RF,0(RE)                                                         
         LA    RF,6(RE,RF)                                                      
*                                                                               
         TM    TSTAT6-UTLD(RF),TST6IAMD                                         
         BZ    LCW13               CLEAR LINK IF NOT FLAGGED                    
*                                                                               
         TM    TSTAT1-UTLD(RF),TSTATDDS                                         
         BNZ   LCW13A              OK IF DDS TERMINAL DEST                      
         L     RE,0(R1)            GET A(SENDER UTL)                            
         CLC   TUSER-UTLD(2,RE),TUSER-UTLD(RF)                                  
         BE    LCW13A              OK IF SAME USERID                            
*                                                                               
LCW13    NI    TSTAT6-UTLD(RF),255-TST6IAMD                                     
         SR    RF,RF                                                            
         XC    0(8,R1),0(R1)       CLEAR LINK                                   
         B     LCW14                                                            
*                                                                               
LCW13A   EQU   *                   WRITE THIS BUFFER                            
         GOTO1 VLCM,DUB,1,(RF),(R8)                                             
         B     LCW14                                                            
                                                                                
*=====================================================================*         
* IF TRM LOGGED ON, ADD TO THE OUTPUT QUEUE                           *         
*=====================================================================*         
LCW14    L     R1,OUTQLEN                                                       
         LA    R1,1(R1)                                                         
         ST    R1,OUTQLEN                                                       
         ICM   RE,15,OUTQLAST      ANY THING ON THE QUEUE?                      
         BNZ   LCW16               YES                                          
         ST    R3,OUTQFRST         NO, SO IT IS 1ST                             
         B     LCW18                                                            
*                                      CHAIN TO END OF QUEUE                    
LCW16    ST    R3,(TXNEXTOT-UTLD)(RE)  POINT CURRENT LAST TO ME                 
*                                                                               
LCW18    ST    R3,OUTQLAST             AND MAKE ME LAST                         
         POST  LCMECB                                                           
         B     LCWX                                                             
         EJECT                                                                  
*=====================================================================*         
* A WRITE IS PENDING -                                                *         
* THIS MUST BE A NORMAL FLOW MSG WITH EXP FLOW IN QUEUE               *         
* WE WILL ATTEMPT TO PURGE THE EXP FLOW BUFFER AND JUST               *         
* WRITE THE NORMAL MESSAGE       (HA HA)                              *         
*=====================================================================*         
LCW20    OC    TMSGBUFF,TMSGBUFF                                                
         BZ    LCWX                                                             
         NI    TMSGBUFF,X'7F'      MAKE SURE THIS OFF                           
*                                                                               
         L     R5,VLCBUFFS                                                      
         LA    RE,4                                                             
         L     RF,VLCBUFFX                                                      
*                                                                               
LCW22    MVC   FULL,0(R5)          COPY BUFFER, TURN OFF BUSY FLAG              
         NI    FULL,X'7F'                                                       
         CLC   TMSGBUFF,FULL                                                    
         BE    *+10                                                             
         BXLE  R5,RE,LCW22                                                      
         DC    H'0'                                                             
*                                                                               
         NI    0(R5),X'7F'         RESET BUSY FLAG                              
         XC    TMSGBUFF,TMSGBUFF   AND CLEAR EXP FLOW ADDRESS                   
*                                                                               
LCW25    L     RE,LCBUFFS          ADJUST AVAIL BUFFER COUNT                    
         LA    RF,1(RE)                                                         
         CS    RE,RF,LCBUFFS                                                    
         BNE   LCW25                                                            
*                                                                               
LCWX     B     EXIT                                                             
         EJECT                                                                  
*=====================================================================*         
* CONSTRUCT A NEW UTL ENTRY                                           *         
* EXIT : R1    = A(ENTRY ADDRESS) OR 0 IF UTL FULL                    *         
*=====================================================================*         
GETUTL   L     R3,VUTL                                                          
         LH    RE,0(R3)                                                         
         ICM   RF,15,2(R3)                                                      
         AHI   R3,6                                                             
         USING UTLD,R3                                                          
*                                                                               
GUTL02   TM    TSTATU,TSTATAVA     IS THIS UTL AVAILABLE FOR REUSE              
         BZ    GUTL04              NO                                           
         TM    TSTAT2,TSTATTIP     TEST IF STILL IN PROCESS                     
         BO    GUTL04              YES - IGNORE                                 
*                                                                               
         OC    TCID,TCID           TEST UTL LOGGED OFF                          
         BNZ   GUTL04              NO - IGNORE                                  
         TM    TSTAT4,TST4CLIP     TEST CLSDST IN PROCESS                       
         BO    GUTL04              YES - IGNORE                                 
*                                                                               
         TM    TTYPE2,TTYPEDUM     TEST DUMMY TERMINAL                          
         BO    GUTL04              YES - IGNORE NO MATTER WHAT (SCRIPT)         
         OC    TXPRNT,TXPRNT       TEST PRINTER                                 
         BNZ   GUTL04              YES - IGNORE NO MATTER WHAT (TXPRNT)         
*                                                                               
         MVC   DUB+0(2),TNUM       SAVE IMPORTANT UTL INFO                      
         MVC   DUB+2(4),TUTLXADR                                                
         B     GUTL10                                                           
*                                                                               
GUTL04   AHI   R4,1                                                             
         BXLE  R3,RE,GUTL02                                                     
*                                                                               
         L     RE,VUTL             USE NEXT FREE ENTRY NOW                      
         AHI   RE,-6                                                            
*                                                                               
GUTL06   L     R3,0(RE)            GET NUMBER SO FAR                            
         LA    R4,1(R3)            SET THIS TERMINAL NUMBER                     
         CH    R4,4(RE)            COMPARE TO UTL MAX                           
         BNH   GUTL08                                                           
         SR    R1,R1               SET NO MORE ROOM                             
         B     GETUTLX                                                          
*                                                                               
GUTL08   CS    R3,R4,0(RE)         DEAD GOOD                                    
         BNE   GUTL06                                                           
*                                                                               
         L     RE,VSSB                                                          
         USING SSBD,RE                                                          
         STH   R4,SSBTRMS          SET NUM OF TRMS IN SSB                       
         OI    SSBSTAT1,SSBSCHK1   SET SSB UPDATED IN CHKPNT1 AREA              
         DROP  RE                                                               
*                                                                               
         L     RE,VUTL                                                          
         MH    R3,0(RE)            TNUM-1 X ENTRY LENGTH                        
         LA    R3,6(RE,R3)         POINT TO NEW ENTRY                           
*                                                                               
         LR    RF,R3                                                            
         AH    RF,0(RE)            ADD ENTRY LENGTH                             
         BCTR  RF,0                                                             
         ST    RF,2(RE)            SET NEW E-O-L ADDRESS                        
*                                                                               
         STH   R4,DUB                                                           
         MVC   DUB+2(4),TUTLXADR                                                
*                                                                               
GUTL10   ICM   R1,15,TMSGBUFF      FREE ANY ALLOCATED BUFFERS                   
         BZ    *+8                                                              
         BRAS  RE,FREEBUFF                                                      
         ICM   R1,15,TBUFF                                                      
         BZ    *+8                                                              
         BRAS  RE,FREEBUFF                                                      
*                                                                               
         LA    R0,UTLD                                                          
         L     RE,VUTL                                                          
         LH    R1,0(RE)            R1 = LENGTH OF UTL                           
         XR    RF,RF                                                            
         MVCL  R0,RE               CLEAR UTL                                    
*                                                                               
         MVC   TNUM,DUB+0          RESTORE ESSENTIAL VALUES                     
         MVC   TUTLXADR,DUB+2                                                   
*                                                                               
         ICM   RF,15,TUTLXADR                                                   
         ICM   R0,15,XAAPASSR-XAUTLD(RF)                                        
         ICM   R1,15,=AL4(XAPASSRL)                                             
         XR    RF,RF                                                            
         MVCL  R0,RE               CLEAR EXTENDED WSSVR AREA                    
*                                                                               
         ICM   RF,15,TUTLXADR                                                   
         ICM   R0,15,XAASWTAB-XAUTLD(RF)                                        
         ICM   R1,15,=AL4(XASWTABL)                                             
         XR    RF,RF                                                            
         MVCL  R0,RE               CLEAR EXTENDED SWTAB AREA                    
*                                                                               
         OI    TSTAT2,TSTATNIT     SET TRM NOT INITIALISED                      
         LA    R1,UTLD             SAVE ENTRY ADDRESS IN R1                     
*                                                                               
GETUTLX  LTR   R1,R1                                                            
         B     EXITR1                                                           
         EJECT                                                                  
*=====================================================================*         
* CONSTRUCT A NEW PRQ ENTRY                                           *         
* NTRY: R1+4   = # QUEUE ENTRIES REQUIRED OR ZERO                     *         
*                # ENTRIES ALLOCATED IS BETWEEN 99 AND 255            *         
* EXIT: R1     = A(NEW ENTRY) OR 0 IF FULL                            *         
*=====================================================================*         
GETPRQ   L     RF,4(R1)            GET REQUESTED NUMBER OF ENTRIES              
         CHI   RF,99                                                            
         BH    *+8                                                              
         LHI   RF,99               SET DEFAULT MIN NUM OF ENTRIES               
         CHI   RF,255                                                           
         BL    *+8                                                              
         LHI   RF,255              SET DEFAULT MAX NUM OF ENTRIES               
         ST    RF,4(R1)            RETURN TO CALLER                             
*                                                                               
         LA    RF,PRQDL            RF=FIXED LEN PRQ ENTRY                       
         L     RE,VPRQ                                                          
         AHI   RE,-6               BACK UP TO PRECEDING FLWD                    
*                                                                               
GETPRQ2  L     R3,0(RE)            GET NUMBER SO FAR                            
         LA    R4,1(R3)            SET THIS TERMINAL NUMBER                     
         CH    R4,4(RE)            COMPARE TO PRQ MAX                           
         BNH   GETPRQ4                                                          
GETPRQ3  XR    R1,R1               SET NO MORE ROOM                             
         B     GETPRQX                                                          
*                                                                               
GETPRQ4  CS    R3,R4,0(RE)         DEAD GOOD                                    
         BNE   GETPRQ2                                                          
*                                                                               
         L     RE,VPRQ                                                          
         AHI   RE,-10                                                           
         L     R0,0(RE)            R0=A(MAX END OF PRQ LIST)                    
         L     RE,VPRQ                                                          
         L     RE,2(RE)                                                         
         LA    RE,1(RE)            POINT TO NEW LAST ENTRY                      
         LR    R3,RE                                                            
         USING PRQD,R3                                                          
         AR    RF,RE                                                            
         BCTR  RF,0                RF=A(NEW LAST-1)                             
         CR    RF,R0                                                            
         BH    GETPRQ3                                                          
         XC    PRHDR(PRQDL),PRHDR  INITIALISE NEW ENTRY                         
         MVC   PRHDR3(2),=X'FFFF'  FLAG NEW FORMAT                              
         L     R4,4(R1)                                                         
         STC   R4,PRQNEMAX                                                      
         LR    R1,R3               SAVE ENTRY ADDRESS IN R1                     
*                                                                               
         L     RE,VPRQ             SET NEW EOL-1                                
         ST    RF,2(RE)                                                         
*                                                                               
GETPRQX  LTR   R1,R1                                                            
         B     EXITR1                                                           
*                                                                               
         TITLE 'FALCM - GET A FREE BUFFER'                                      
         EJECT                                                                  
*=====================================================================*         
* GETBUF - GET A FREE BUFFER                                          *         
* EXIT: R1     = A(ALLOCATED BUFFER) OR ZERO IF NONE AVAILABLE        *         
*=====================================================================*         
GETBUF   BRAS  RE,GETBUFF                                                       
         B     EXITR1                                                           
*                                                                               
         TITLE 'FALCM - VTAM LINE CONTROL - START-UP'                           
         EJECT                                                                  
*=====================================================================*         
* RELBUF - RELEASE A BUFFER                                           *         
*=====================================================================*         
RELBUF   L     R1,4(R1)                                                         
         BRAS  RE,FREEBUFF                                                      
         B     EXIT                                                             
*                                                                               
         TITLE 'FALCM - VTAM LINE CONTROL - START-UP'                           
         EJECT                                                                  
*=====================================================================*         
* VTAM OPEN ROUTINE                                                   *         
*=====================================================================*         
OPN      L     RE,VSSB                                                          
         TM    SSBSTAT4-SSBD(RE),SSBSAOR                                        
         BO    OPN3                                                             
*                                                                               
         MVC   APPLID+1(L'SSBVTID),SSBVTID-SSBD(RE)                             
         LA    R0,L'SSBVTID                                                     
         LA    R1,APPLID           POINT TO LAST CHAR                           
         AR    R1,R0                                                            
         CLI   0(R1),C' '                                                       
         BH    *+10                                                             
         BCTR  R1,0                                                             
         BCT   R0,*-10                                                          
         STC   R0,APPLID           SET ACTUAL LENGTH                            
*                                                                               
OPN2     LA    R1,ACB                                                           
         USING IFGACB,R1                                                        
         L     RF,ACBTNIB          GET NIB POINTER                              
         USING ISTDNIB,RF                                                       
         MVC   NIBSYM,APPLID+1     MOVE APPL ID TO NIB                          
         DROP  RF                                                               
*                                                                               
         OPEN  ACB,MODE=31                                                      
         LTR   RF,RF                                                            
         BNZ   OPNERR                                                           
                                                                                
*=====================================================================*         
* SET THE NUMBER OF BUFFERS                                           *         
*=====================================================================*         
OPN3     L     RF,VLCBUFFX                                                      
         LA    RF,1(RF)            ARITHMETIC                                   
         S     RF,VLCBUFFS                                                      
         SRL   RF,2                DIVIDE BY 4                                  
         ST    RF,LCBUFFS                                                       
*                                                                               
         L     RE,VSSB                                                          
         TM    SSBSTAT4-SSBD(RE),SSBSAOR                                        
         BO    EXIT                                                             
*                                                                               
*=====================================================================*         
* SET THE ACB ADDRESS IN EACH RPL                                     *         
* AND MOVE THE 8 CHAR APPLID TO THE NIB                               *         
*=====================================================================*         
         LARL  R7,RPLLST                                                        
         USING FARPLD,R7                                                        
*                                                                               
OPN10    L     R8,FARPLRPL         POINT TO RPL                                 
         USING IFGRPL,R8                                                        
         LA    R0,ACB                                                           
         ST    R0,RPLDACB          SET ACB ADDRESS                              
*                                                                               
         TM    FARPLFLG,FARPL62    IS THIS AN LU6.2 FARPL?                      
         BO    OPNL62              YES, PROCESS DIFFERENTLY (NO NIB)            
         L     RF,RPLARG           GET NIB POINTER                              
         USING ISTDNIB,RF                                                       
         MVC   NIBSYM,APPLID+1                                                  
         DROP  RF                                                               
         B     OPNNXTR          GO GET NEXT FARPL                               
*                                                                               
R62LEN   EQU   RPL62AX-RPL62A   RPL EXTENSION LENGTH                            
*                                                                               
OPNL62   DS    0H               INITIALIZE LU62 FARPL                           
         LA    RF,R62LEN(,R8)   RPL EXTENSION RIGHT AFTER RPL                   
         ST    RF,RPLAAREA      CHAIN IT TO THE RPL                             
*                                                                               
OPNNXTR  ICM   R7,15,FARPLNXT                                                   
         BNZ   OPN10                                                            
         B     OPN30                                                            
         SPACE 1                                                                
*&&NOP                                                                          
*=====================================================================*         
* SETUP FARPL'S DEDICATED FOR SEND/RECEIVE OPERATIONS                           
*=====================================================================*         
         SPACE 1                                                                
         LA    R7,RECVFARP                                                      
OPN20    L     R8,FARPLRPL      POINT TO RPL                                    
         BRAS  RE,GETBUFF       GO GET BUFFER FIXED FOR RPL                     
         LTR   R1,R1                                                            
         BNZ   *+6                                                              
         DC    H'0'             REAL WEIRD IF NONE AVAILABLE NOW                
*                                                                               
         STCM  R1,15,FARPLIOA      SET ADDRESS IN FARPL                         
         ICM   R7,15,FARPLNXT   GET ADDRESS OF NEXT RARPL                       
         BNZ   OPN20            IF NON-ZERO PTR THEN INITIALIZE                 
         SPACE 1                                                                
*&&                                                                             
*=====================================================================*         
* NOW ALLOW LOGON REQUESTS TO PROCEED                                 *         
*=====================================================================*         
         SPACE 1                                                                
OPN30    DS    0H                                                               
         SETLOGON RPL=LOGRPL,OPTCD=(SYN,START)                                  
         LTR   RF,RF                                                            
         BZ    EXIT                                                             
         DC    H'0'                                                             
         EJECT                                                                  
*=====================================================================*         
* NOTE THERE IS A LITTLE PROBLEM HERE SINCE R2 POINTS TO SYSFACS      *         
* AND VWCTYPE, VRCTYPE, VSSB ARE ALL IN SYSFACS                       *         
*=====================================================================*         
         SPACE 1                                                                
OPNERR   L     RE,VSSB                                                          
         MVC   BADOPEN+4(4),SSBSYSNA-SSBD(RE) MOVE NAME TO MESSAGE              
         MVC   BADOPEN+28(8),SSBVTID-SSBD(RE) MOVE ACB NAME                     
*                                                                               
         L     RF,VDMOD000                                                      
         MVC   P1,VWCTYPE                                                       
         LA    R2,WORK             POINT TO FUCKING DUMMY DMCB                  
         GOTO1 (RF),P1,,BADOPEN,L'BADOPEN                                       
*                                                                               
         L     RF,VDMOD000                                                      
         L     R2,ASYSFAC                                                       
         MVC   P1,VRCTYPE                                                       
         LA    R2,WORK             POINT TO FUCKING DUMMY DMCB                  
         GOTO1 (RF),(R1),,WORK,6                                                
*                                                                               
         L     R2,ASYSFAC          RESTORE R2 STUPID                            
         CLC   =C'GO',WORK                                                      
         BE    OPN2                                                             
         CLC   =C'CAN',WORK                                                     
         BNE   OPNERR                                                           
         B     EXITX               SET CC NOT EQUAL                             
*&&US                                                                           
BADOPEN  DC    C'*FACPAK* CANT OPEN VTAM ACB=???????? - GO OR CANCEL ?'         
*&&                                                                             
*&&UK                                                                           
BADOPEN  DC    C'+FACPAK+ CANT OPEN VTAM ACB=???????? - GO OR CANCEL ?'         
*&&                                                                             
*                                                                               
LOGRPL   RPL   AM=VTAM,ACB=ACB,NIB=ACBNIB                                       
         TITLE 'FALCM - CLOSE VTAM'                                             
*=====================================================================*         
* VTAM CLOSE ROUTINE                                                  *         
*=====================================================================*         
         SPACE 1                                                                
CLS      EQU   *                                                                
         CLOSE ACB,MODE=31                                                      
         B     EXIT                                                             
         TITLE 'FALCM - START A PRINTER '                                       
*=====================================================================*         
* STRTPR - START A PRINTER                                            *         
* NTRY: R1     = A(UTL ENTRY)                                         *         
*=====================================================================*         
         USING UTLD,R3                                                          
STRTPR   L     R3,4(R1)            PICK UP UTL ENTRY ADDRESS                    
         LA    R3,0(R3)            CLEAR HOB                                    
         NI    TSTATU,255-TSTATDNE CLEAR CLSDST REQUEST FLAG                    
*                                                                               
STRTPR2  OC    TCID,TCID           TEST LOGGED ON                               
         BNZ   STRTPR6                                                          
                                                                                
*=====================================================================*         
* PRINTER IS NOT LOGGED ON, ADD TO SIMLOGON QUEUE                     *         
*=====================================================================*         
         OI    TSTAT3,TSTATSIM     SET SIMLOGON PENDING                         
*                                                                               
STRTPR4  LA    R1,SIMQLEN          BUMP THE CTL QUEUE LENGTH                    
         BRAS  RE,QUP                                                           
         B     STRTPRX                                                          
                                                                                
*=====================================================================*         
* PRINTER IS LOGGED ON - ADD TO PRINTER OUTPUT QUEUE                  *         
*=====================================================================*         
STRTPR6  LA    R1,PRTQLEN                                                       
         BRAS  RE,QUP                                                           
*                                                                               
         ICM   RE,15,PRTQLAST                                                   
         BNZ   STRTPR8                                                          
         STCM  R3,15,PRTQFRST                                                   
         B     STRTPR10                                                         
*                                                                               
STRTPR8  ST    R3,TXNEXTOT-UTLD(RE)                                             
*                                                                               
STRTPR10 STCM  R3,15,PRTQLAST                                                   
*                                                                               
STRTPRX  POST  LCMECB                                                           
         B     EXIT                                                             
         TITLE 'FALCM - STOP A PRINTER'                                         
         EJECT                                                                  
*=====================================================================*         
* STOPPR - CLSDST A DEVICE TO RELEASE IT                              *         
* NTRY: R1     = A(UTL ENTRY)                                         *         
*=====================================================================*         
         USING UTLD,R3                                                          
STOPPR   L     R3,4(R1)            PICK UP UTL ENTRY ADDRESS                    
         LA    R3,0(R3)            CLEAR HOB                                    
         TM    TSTAT3,TSTATCLS     TEST CLSDST PENDING                          
         BO    EXIT                                                             
         TM    TSTAT4,TST4CLIP     TEST CLSDST IN PROCESS                       
         BO    EXIT                                                             
         OI    TSTAT3,TSTATCLS     SET CLSDST PENDING                           
                                                                                
*=====================================================================*         
* IF LU IS LOGGED ON, ADD TO THE CLSDST QUEUE                         *         
*=====================================================================*         
         OC    TCID,TCID           TEST LOGGED ON                               
         BNZ   *+8                 YES                                          
         OI    TSTAT3,TSTATNAM     ELSE SET CLSDST BY NAME                      
*                                                                               
         LA    R1,CLSQLEN                                                       
         BRAS  RE,QUP                                                           
         POST  LCMECB                                                           
         B     EXIT                                                             
         TITLE 'FALCM - RETURN TRACE BUFFER ADDRESS'                            
         EJECT                                                                  
*=====================================================================*         
* RETURN TRACE BUFFER ADDRESS TO USER                                 *         
*=====================================================================*         
SETADDR  L     R0,=A(TRCBUFF)                                                   
         ST    R0,4(R1)                                                         
         B     EXIT                                                             
*                                                                               
         TITLE 'FALCM - RETURN CID FOR THIS LU'                                 
         EJECT                                                                  
*=====================================================================*         
* ASK VTAM FOR CID FOR THIS LU                                        *         
* NTRY: P2     = A(UTL ENTRY)                                         *         
* EXIT: P3     = VTAM CID ON EXIT                                     *         
*       P4(2)  = RETURN CODES                                         *         
*=====================================================================*         
         USING UTLD,R3                                                          
GETCID   L     R3,4(R1)            POINT TO UTL ENTRY                           
         LR    R4,R1               SAVE PARAM LIST POINTER                      
*                                                                               
         L     R8,AINQRPL                                                       
         USING IFGRPL,R8                                                        
*                                                                               
         L     RF,RPLARG                                                        
         USING ISTDNIB,RF                                                       
         MVC   NIBSYM,TSYM         SET LUID IN NIB                              
         DROP  RF                                                               
*                                                                               
         XC    INQAREA,INQAREA                                                  
         INQUIRE RPL=(R8),ACB=ACB,OPTCD=CIDXLATE                                
*                                                                               
         MVC   8(4,R4),INQAREA       MOVE RESULT TO USER                        
         MVC   12(2,R4),RPLRTNCD     AND RETURN/FEEDBACK CODES                  
*                                                                               
         B     EXIT                                                             
*                                                                               
AINQRPL  DC    A(INQRPL)                                                        
INQAREA  DS    F                                                                
*                                                                               
         DS    0D                                                               
         DC    CL8'*INQRPL*'                                                    
INQRPL   RPL   AM=VTAM,NIB=INQNIB,AREA=INQAREA,AREALEN=4                        
         DC    CL8'*INQNIB*'                                                    
INQNIB   NIB   MODE=RECORD                                                      
*                                                                               
         TITLE 'FALCM - RETURN RPLLST ADDRESS'                                  
         EJECT                                                                  
*=====================================================================*         
* RETURN RPLLST ADDRESS                                               *         
*=====================================================================*         
GETRPL   ST    R7,4(R1)            RETURN RPLLST ADDRESS                        
         B     EXIT                                                             
*                                                                               
         TITLE 'FALCM - DELETE AN ENTRY FROM THE PRINTER QUEUE'                 
         EJECT                                                                  
*=====================================================================*         
* DELETE AN ENTRY FROM THE PRINTER QUEUE FROM POOL                    *         
* NTRY: P2     = INDEX NUMBER                                         *         
* EXIT: CC     = NEQ IF BAD ENTRY NUMBER PASSED                       *         
*=====================================================================*         
DELPRQ   L     RE,VPRQENTS                                                      
         ICM   RF,15,4(R1)         LOCATE ENTRY IN POOL                         
         BZ    EXITX               ERROR IF NO INDEX NUMBER PASSED              
         BCTR  RF,0                                                             
         MHI   RF,L'PNTRY                                                       
         LA    RF,6(RF)                                                         
         AR    RF,RE               RF=A(ENTRY IN POOL)                          
*                                                                               
         AHI   RE,-10              TEST WE HAVE NOT INDEXED TOO FAR             
         C     RF,0(RE)                                                         
         BNL   EXITX                                                            
         OC    0(L'PNTRY,RF),0(RF) AND THAT THE ENTRY IS IN USE                 
         BZ    EXITX                                                            
         XC    0(L'PNTRY,RF),0(RF) DELETE IT                                    
*                                                                               
DELPRQ1  L     R3,4(RE)            DECREMENT NUMBER OF IN USE ENTRIES           
         LR    R4,R3                                                            
         BCTR  R4,0                                                             
         CS    R3,R4,4(RE)         COUNTER AT VPRQENTS-6(4)                     
         BNE   DELPRQ1                                                          
         B     EXIT                                                             
*                                                                               
         TITLE 'FALCM - ADD AN ENTRY FROM THE PRINTER QUEUE'                    
         EJECT                                                                  
*=====================================================================*         
* ADD AN ENTRY TO THE PRINTER QUEUE FROM POOL                         *         
* NTRY: P2     = A(PNTRY)                                             *         
* EXIT: P3     = FULLWORD CONTAINING INDEX NUMBER. ZERO IF FULL       *         
*=====================================================================*         
ADDPRQ   XC    8(4,R1),8(R1)       CLEAR P3                                     
         ICM   RE,15,4(R1)                                                      
         BZ    EXITX               ERROR IF P2 IS ZERO                          
         OC    0(L'PNTRY,RE),0(RE)                                              
         BZ    EXITX               ERROR IF NULL ENTRY PASSED                   
         L     RE,VPRQENTS                                                      
         AHI   RE,-6                                                            
*                                                                               
ADDPRQ1  L     R3,0(RE)            R3=NUMBER OF INUSE ENTRIES                   
         LA    R4,1(R3)                                                         
         CH    R4,4(RE)                                                         
         BH    EXITX               ERROR IF ENTRY POOL FULL                     
         CS    R3,R4,0(RE)         UPDATE NUMBER IN USE                         
         BNE   ADDPRQ1                                                          
*                                                                               
         LH    R4,4(RE)            SAVE MAX IN R4                               
         LA    RE,12(RE)           RE=A(FIRST ENTRY)                            
         SR    RF,RF               RF=COUNT                                     
         L     R0,=F'-1'                                                        
*                                                                               
ADDPRQ2  XR    R3,R3                                                            
         CS    R3,R0,0(RE)         SET X'FFFFFFFF' TO GRAB ENTRY                
         BE    ADDPRQ3                                                          
         LA    RE,L'PNTRY(RE)      TRY NEXT ENTRY                               
         LA    RF,1(RF)                                                         
         CR    RF,R4                                                            
         BNH   ADDPRQ2                                                          
         DC    H'0'                CAN'T FIND FREE ENTRY                        
*                                                                               
ADDPRQ3  L     R4,4(R1)            PUT ENTRY INTO POOL                          
         MVC   0(L'PNTRY,RE),0(R4)                                              
         LA    RF,1(RF)                                                         
         ST    RF,8(R1)            RETURN ENTRY NUMBER AT 8(R1)                 
         B     EXIT                                                             
         EJECT                                                                  
         DROP  RB,RA                                                            
         EJECT                                                                  
*=====================================================================*         
* RECORD EVENT IN VTAM TRACE BUFFER                                   *         
* WHEN BUFFER IS FULL WRITE TO DISK, CLEAR AND SAVE PREV REC ADDRESS  *         
* NTRY:  R2     = V(SYSFAC)                                           *         
*        R8     = A(RPL)                                              *         
*=====================================================================*         
         USING SYSFACD,R2                                                       
LCMTRC   NTR1  BASE=*,LABEL=*                                                   
         ICM   R4,15,TRCNEXT       GET NEXT SLOT ADDRESS                        
         BNZ   LCMTRC4                                                          
         USING VTTRCD,R4           R4=A(NEXT SLOT IN VTAM TRACE BUFFER)         
*                                                                               
         ICM   R5,15,TRCBUFFL      GET BUFFER LENGTH                            
         BNZ   LCMTRC1                                                          
         LHI   R5,1900             SET BUFFER LENGTH                            
         L     RE,VSSB                                                          
         TM    SSBSTAT3-SSBD(RE),SSBXTADR                                       
         BZ    *+8                                                              
         LHI   R5,6400                                                          
         ST    R5,TRCBUFFL                                                      
         L     R4,ATRCBUFF                                                      
         AR    R4,R5                                                            
         ST    R4,TRCBUFFX                                                      
LCMTRC1  L     R4,ATRCBUFF         POINT TO START OF BUFFER                     
         SR    RF,RF               CLEAR FROM LENGTH                            
         MVCL  R4,RE               ZEROIZE TRACE BUFFER                         
*                                                                               
LCMTRC2  L     R4,ATRCBUFF                                                      
         MVC   0(5,R4),=C'*VTAM'   SET BUFFER ID                                
         MVC   5(4,R4),TRCPRVDA    SET D/A OF PREVIOUS                          
         L     RE,VSSB             SET FACPAK SYSTEM ID NUMBER                  
         MVC   9(1,R4),SSBSYSID-SSBD(RE)                                        
         LA    R4,10(R4)                                                        
         ST    R4,TRCNEXT          SET NEXT SLOT ADDRESS                        
*                                                                               
LCMTRC4  MVC   VTTRCLU,=8C'?'                                                   
         TIME  DEC                                                              
         STCM  R0,15,VTTRCTIM      SET TIME AS HHMMSSTH                         
         STCM  R1,15,VTTRCDAT      SET DATE AS 00DDDYYF                         
*                                                                               
         CLI   DDSFLAG,0           TEST FOR SPECIAL EVENT                       
         BE    *+12                NO                                           
         CLI   DDSFLAG,X'C0'                                                    
         BNH   LCMTRC10            YES - GO LOOK UP MESSAGE                     
*                                                                               
         MVC   VTTRCRPL,0(R8)                                                   
         CLI   DDSFLAG,C'Y'        TEST INTERNAL TRACE                          
         BNE   *+8                                                              
         OI    VTTRCRPL+2,X'80'    SET FLAG IN RPL OPCODE                       
*                                                                               
         ICM   R3,15,RPLUSFLD      POINT TO UTL ENTRY                           
         BZ    *+10                                                             
         USING UTLD,R3                                                          
         MVC   VTTRCLU,TSYM        MOVE LUNAME TO TRACE                         
                                                                                
*=====================================================================*         
* IF WE HAVE A NON-ZERO RETURN/FEEDBACK CODE,                         *         
* TEST TO SEE IF CID IN UTL AGREES WITH CID IN RPL                    *         
*=====================================================================*         
         CLI   DDSFLAG,C'Z'        TEST BAD CHECK                               
         BE    LCMTRC12                                                         
         CLI   DDSFLAG,C'Y'        TEST INTERNAL TRACE FLAG                     
         BE    LCMTRC6             YES                                          
         CLI   RPLREQ,RPLCLOSE     TEST CLSDST                                  
         BE    LCMTRC6                                                          
         TM    RPLEXTDS,RPLNIB     TEST RPL HAS NIB ADDRESS                     
         BO    LCMTRC6             YES - CAN'T CHECK CID                        
         LTR   R3,R3               TEST UTL ADDRESS PRESENT                     
         BZ    LCMTRC6             NO - AND DON'T MOVE THIS INST AGAIN          
         CLC   TCID,RPLARG         TEST SAME CID                                
         BE    LCMTRC6                                                          
         MVC   VTTRCDTA(16),=C'*** BAD CID *** '                                
         MVC   VTTRCDTA+16(4),RPLARG                                            
         MVC   VTTRCDTA+20(4),TCID                                              
         B     LCMTRC20                                                         
*                                                                               
LCMTRC6  ICM   RE,15,RPLAREA       POINT TO I/O AREA                            
         BZ    *+10                                                             
         MVC   VTTRCDTA,0(RE)                                                   
         B     LCMTRC20                                                         
                                                                                
*=====================================================================*         
* LOOK UP MESSAGE FOR SPECIAL EVENT TRACE                             *         
*=====================================================================*         
LCMTRC10 MVC   VTTRCLU,TSYM       SET LUNAME                                    
*                                                                               
LCMTRC12 LA    R1,TRMSGTAB        FIND THE MESSAGE IN TABLE                     
         LLC   R0,DDSFLAG                                                       
         CLI   DDSFLAG,C'Z'       TEST BAD CHECK                                
         BNE   *+8                                                              
         LHI   R0,7                USE MESSAGE 7                                
         BCTR  R0,0                                                             
         SLL   R0,4                X 16                                         
         AR    R1,R0                                                            
         MVC   VTTRCDTA(16),0(R1)                                               
         MVC   VTTRCDTA+16(16),ERRDATA  MOVE EXTRA ERR DATA IF ANY              
*****************************************                                       
* PRINT WRITE HUNG MESSAGE FOR FRED ROE *                                       
*****************************************                                       
         CLI   DDSFLAG,8                                                        
         BNE   LCMTRC20                                                         
*                                                                               
*&&UK*&& MVI   WRTHUNG+0,C'+'      +FACPAK+ NOT *FACPAK*                        
*&&UK*&& MVI   WRTHUNG+7,C'+'                                                   
*                                                                               
         L     RE,VSSB                                                          
         MVC   WRTHUNG+4(3),SSBSYSNA-SSBD(RE)   MOVE ADV NAME                   
         MVC   WRTHUNG+28(8),VTTRCLU            MOVE LUID NAME                  
         L     RF,VDMOD000                                                      
         MVC   P1,VWCTYPE                                                       
         LA    R2,WORK             POINT TO FUCKING DUMMY DMCB                  
         GOTO1 (RF),P1,,WRTHUNG,L'WRTHUNG                                       
         L     R2,ASYSFAC          RESTORE R2                                   
*                                                                               
LCMTRC20 MVI   DDSFLAG,0           RESET INTERNAL TRACE FLAG                    
         XC    ERRDATA,ERRDATA                                                  
         LA    R4,VTTRCLEN(R4)     POINT TO NEXT SLOT                           
         ST    R4,TRCNEXT                                                       
         LA    R0,VTTRCLEN(R4)     POINT TO END OF NEXT SLOT                    
         C     R0,TRCBUFFX         TEST GOES PAST END OF BUFFER                 
         BL    LCMTRCX             NO - DONE                                    
         EJECT                                                                  
*=================================================================*             
* TRACE BUFFER IS FULL - WRITE TO DISK AND SET TO CLEAR NEXT TIME *             
*=================================================================*             
         XC    TRCNEXT,TRCNEXT     SET TO CLEAR NEXT TIME                       
         L     R1,ATRCBUFF                                                      
         GOTO1 VLOGGER,(R1)                                                     
         MVC   TRCPRVDA,5(R1)      SAVE THE PREVIOUS RECORD ADDRESS             
*                                                                               
LCMTRCX  B     EXIT                                                             
         DROP  R4                                                               
*                                                                               
TRCBUFFL DC    F'0'                TRACE BUFFER LENGTH                          
TRCBUFFX DC    A(0)                A(END OF TRACE BUFFER)                       
TRCNEXT  DC    A(0)                A(NEXT TRACE BUFFER RECORD)                  
TRCPRVDA DC    F'0'                DISK ADDR OF PREVIOUS TRACE RECORD           
*                                                                               
ATRCBUFF DC    A(TRCBUFF)                                                       
WRTHUNG  DC    C'*FACPAK* VTAM WRITE HUNG ON ????????'                          
         EJECT                                                                  
*=====================================================================*         
* SEND SIGNON MESSAGE TO TERMINAL                                     *         
* NTRY: R2     = V(SYSFAC)                                            *         
*       R3     = A(UTL)                                               *         
*=====================================================================*         
         USING SYSFACD,R2                                                       
         USING UTLD,R3                                                          
SIGNON   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R1,TBUFF                                                         
         MVC   0(5,R1),=XL5'115C6F1DE8'       SBA/23/80/HIPROT                  
         MVC   5(L'TSYM,R1),TSYM              LUID                              
         LA    R1,5+L'TSYM(R1)                                                  
         MVC   0(L'SIGNDON,R1),SIGNDON        SIGNED ONTO DDS                   
*                                                                               
         L     RE,VSSB                        SYSTEM ID                         
         MVC   L'SIGNDON(L'SSBVTID,R1),SSBVTID-SSBD(RE)                         
         LA    R1,L'SIGNDON+L'SSBVTID(R1)                                       
*                                                                               
         MVC   0(5,R1),=XL5'115DD61D40'       SBA/24/39/UNP                     
         MVC   5(6,R1),=XL6'3C5DE8001D60'     RA /24/57/NULL/PROT               
*                                                                               
         LA    R1,11(R1)           BUMP PAST TALK DIRTY TO ME! FIELD            
         MVI   0(R1),ETX                                                        
         LA    R1,1(R1)                                                         
*                                                                               
         L     RE,TBUFF                                                         
         AHI   RE,-8               BACK UP TO BUFFER HEADER                     
         USING TBHD,RE                                                          
         STCM  R3,15,TBHAUTL       SET A(UTL ENTRY)                             
         S     R1,TBUFF                                                         
         STCM  R1,15,TBHINDS       SET 0000.LEN                                 
         MVI   5(RE),X'01'         SET ERASE WRITE                              
         B     EXIT                                                             
         DROP  R2,R3,RE                                                         
*                                                                               
         EJECT                                                                  
*=====================================================================*         
* SEARCH BUFFER LIST FOR A FREE BUFFER                                *         
* NTRY:  R2    = V(SYSFAC)                                            *         
* EXIT:  R1    = A(BUFFER) OR 0 IF NO BUFFER AVAILABLE                *         
*=====================================================================*         
         USING SYSFACD,R2                                                       
GETBUFF  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
GETBUFF2 ICM   RE,15,LCBUFFS       GET FREE BUFFER COUNT                        
         BNZ   GETBUFF4                                                         
         XR    R1,R1                                                            
         B     GETBUFFX                                                         
*                                                                               
GETBUFF4 LR    RF,RE                                                            
         BCTR  RF,0                                                             
         CS    RE,RF,LCBUFFS       DEAD GOOD (REALLY)                           
         BNE   GETBUFF2                                                         
*                                                                               
         L     R5,VLCBUFFS         NOW FIND A FREE ENTRY                        
         LHI   RE,4                                                             
         L     RF,VLCBUFFX                                                      
         TM    0(R5),X'80'         TEST FREE                                    
         BZ    *+10                YES                                          
         BXLE  R5,RE,*-8                                                        
         DC    H'0'                NOT WONDERFUL THIS                           
*                                                                               
         ICM   R1,15,0(R5)                                                      
         OI    0(R5),X'80'         FLAG BUFFER BUSY                             
*                                                                               
GETBUFFX B     EXITR1                                                           
         DROP  R2                                                               
         EJECT                                                                  
*=====================================================================*         
* FREE BUFFER ADDRESS IN R1                                           *         
* NTRY: R2     = V(SYSFACS)                                           *         
*=====================================================================*         
         USING SYSFACD,R2                                                       
FREEBUFF NTR1  BASE=*,LABEL=*                                                   
         LTR   R1,R1                                                            
         BZ    FREEBUFX            MUST HAVE A(BUFFER TO FREE)                  
*                                                                               
         L     R5,VLCBUFFS                                                      
         LHI   RE,4                                                             
         L     RF,VLCBUFFX                                                      
FREEBUF2 ICM   R0,15,0(R5)         COPY ADDRESS, TURN OFF X'80' BIT             
         N     R0,=XL4'7FFFFFFF'                                                
         CR    R1,R0               MATCH ADDRESS                                
         BE    FREEBUF4            YES                                          
         BXLE  R5,RE,FREEBUF2                                                   
         B     FREEBUFX            ***** IGNORE ERROR *****                     
*                                                                               
FREEBUF4 STCM  R0,15,0(R5)         RESET 'BUSY' FLAG                            
*                                                                               
FREEBUF6 L     RE,LCBUFFS          DECREMENT USED BUFFER COUNT                  
         LA    RF,1(RE)                                                         
         CS    RE,RF,LCBUFFS                                                    
         BNE   FREEBUF6                                                         
*                                                                               
FREEBUFX B     EXIT                                                             
         DROP  R2,R9                                                            
         EJECT                                                                  
*=====================================================================*         
* BUILD STATUS MESSAGE AT AREA POINTED TO BY R1                       *         
* NTRY:  R3    = A(UTL ENTRY)                                         *         
*=====================================================================*         
         USING COMMON,R9                                                        
BLDSTAT  NTR1  BASE=*,LABEL=*                                                   
         LARL  R9,COMMON                                                        
         ST    R1,BLDSTATR                                                      
*                                                                               
         L     R2,ASYSFAC          R2=A(FACPAK SYSFAC LIST)                     
         USING SYSFACD,R2                                                       
*                                                                               
         MVC   BLDSTATA(6),=6C'0'  SET OUTPUT COUNTS TO ZERO                    
         MVC   BLDSTATB(4),=6C'0'                                               
         MVC   BLDSTATC(2),=6C'0'                                               
*                                                                               
         L     R1,VTCB             SEARCH TCB FOR UTL ENTRY                     
         LH    RE,0(R1)                                                         
         L     RF,2(R1)                                                         
         LA    R1,6(R1)                                                         
         CLM   R3,7,TCBUTL+1-TCBD(R1)                                           
         BE    *+12                                                             
         BXLE  R1,RE,*-8                                                        
         B     BLDSTATX            IF NOT IN TASK THEN ZERO COUNTS              
*                                                                               
         L     RF,TCBCPUTM-TCBD(R1)                                             
         M     RE,=F'1000'                                                      
         D     RE,=F'38400'                                                     
         CVD   RF,BLDSTATD         CPU TIME (MILLISECONDS)                      
         OI    BLDSTATD+7,X'0F'                                                 
         UNPK  BLDSTATA(6),BLDSTATD                                             
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,7,TCBIOCNT-TCBD(R1)                                           
         CVD   RF,BLDSTATD         I/O COUNT                                    
         OI    BLDSTATD+7,X'0F'                                                 
         UNPK  BLDSTATB(4),BLDSTATD                                             
*                                                                               
         SR    RF,RF                                                            
         IC    RF,TCBPRTY-TCBD(R1)                                              
         CVD   RF,BLDSTATD         TASK PRIORITY                                
         OI    BLDSTATD+7,X'0F'                                                 
         UNPK  BLDSTATC(2),BLDSTATD                                             
*                                                                               
BLDSTATX L     R1,BLDSTATR                                                      
         MVC   0(60,R1),BLDSTATM   MOVE MESSAGE TO OUTPUT AREA                  
         XIT1                                                                   
         DROP  R9                                                               
                                                                                
         EJECT                                                                  
         TITLE 'FALCM - VTAM LOGON EXIT'                                        
*=====================================================================*         
* VTAM LOGON EXIT                                                     *         
* THIS RUNS ASYNCHRONOUSLY AS AN MVS IRB -- AS SUCH THIS MAY          *         
* RESULT IN PRE-EMPTION OF THE MAINLINE AT ANY POINT                  *         
*=====================================================================*         
         USING LOGXIT,RB                                                        
         USING COMMON,R9                                                        
LOGXIT   LR    RB,RF                                                            
         LARL  R9,COMMON                                                        
         J     *+12                                                             
         DC    CL8'*LOGXIT*'                                                    
         ST    RE,LOGXITRE                                                      
*                                                                               
         LARL  RD,LOGXSAVE         SUPPLY D-CHAIN SAVE AREA                     
         L     R2,ASYSFAC          R2=V(SYSFACS)                                
         USING SYSFACD,R2                                                       
         LR    RA,R1               SAVE PARAM POINTER                           
         USING LOGONPRM,RA                                                      
         L     R6,LOGONSYM         SYMBOLIC NAME                                
                                                                                
*=====================================================================*         
* FIND A FREE UTL ENTRY OR MATCH TO AN EXISTING ONE                   *         
*=====================================================================*         
LOGXIT1  L     R3,VUTL                                                          
         LH    R4,0(R3)                                                         
         L     R5,2(R3)                                                         
         AHI   R3,6                                                             
         USING UTLD,R3                                                          
*                                                                               
LOGXIT2  CLC   TSYM,0(R6)          TEST MATCH ON SYMBOLIC NAME                  
         BNE   LOGXIT4                                                          
         TM    TSTAT2,TSTATTIP     TEST IF STILL IN PROCESS                     
         BO    LOGXITX             YES IGNORE LOGON                             
         TM    TSTAT8,TST8INQ      TEST IF IN A QUEUE SOMEWHERE                 
         BO    LOGXITX             YES IGNORE LOGON                             
*                                                                               
         TM    TSTAT5,TST5TBP      TEST IF BUILD STILL PENDING                  
         BO    LOGXIT8             YES POST ALSO IN SSB                         
         B     LOGXIT10                                                         
*                                                                               
LOGXIT4  BXLE  R3,R4,LOGXIT2                                                    
*                                                                               
         GOTO1 VLCM,LOGXPARM,VTGETUTL                                           
         LTR   R3,R1               GET NEW ENTRY ADDRESS                        
         BNZ   LOGXIT6                                                          
*                                                                               
         WTO   'FACPAK - RAN OUT OF UTL ALLOCATIONS'                            
         ABEND 922                 NO MORE SPACE IN UTL                         
*                                                                               
LOGXIT6  OI    TSTAT5,TST5TBP                                                   
*                                                                               
LOGXIT8  L     RE,VSSB             SET TERMINAL BUILD PENDING IN SSB            
         OI    SSBVTFL1-SSBD(RE),SSBVTTBP                                       
*                                                                               
LOGXIT10 OC    TCID,TCID           WE SHOULD NOT HAVE A CID HERE                
         BZ    *+10                                                             
         XC    TCTDATA,TCTDATA     SO ZAP OLD SESSION INFO (SECURITY)           
*                                                                               
         MVC   TSYM,0(R6)          SET VTAM ID                                  
         OI    TSTAT2,TSTATNIT     SET NOT INIT                                 
         OC    TPASSWD,TPASSWD     TEST USER PASSWORD ENTERED                   
         BZ    *+8                                                              
         OI    TSTAT5,TST5PSWD     SET PASSWORD REQUIRED FLAG                   
         MVC   TCID,LOGONCID       SAVE THE BLOODY CID                          
         NI    TTYPE2,255-(TTYPE2SC+TTYPE2SF+TTYPE2CH)                          
         NI    TSTATC,255-TSTCXSES UNSET FLAG                                   
*                                                                               
         ICM   R1,15,TMSGBUFF      FREE ANY ALLOCATED BUFFERS                   
         BZ    *+8                                                              
         BRAS  RE,FREEBUFF                                                      
         XC    TMSGBUFF,TMSGBUFF                                                
         ICM   R1,15,TBUFF                                                      
         BZ    *+8                                                              
         BRAS  RE,FREEBUFF                                                      
         XC    TBUFF,TBUFF                                                      
         B     LOGXIT11                                                         
                                                                                
*=====================================================================*         
* CHECK FOR ADV LOGON PARAMETERS                                      *         
*=====================================================================*         
LOGXIT11 ICM   R0,15,LOGONLEN      TEST FOR USER DATA                           
         BZ    LOGXIT12                                                         
*                                                                               
         L     R4,LOGONRPL               GET READ-ONLY RPL ADDRESS              
         L     R5,(RPLAREA-IFGRPL)(R4)   GET ADDRESS OF CINIT                   
         SR    R1,R1                                                            
         ICM   R1,3,10(R5)         BUMP PAST BIND IMAGE                         
         LA    R5,12(R1,R5)                                                     
         SR    R1,R1                                                            
         IC    R1,1(R5)            BUMP PAST LUID                               
         LA    R5,2(R1,R5)                                                      
         LA    R5,3(R5)            GET ADDRESS OF USER DATA                     
                                                                                
*=====================================================================*         
* R5 NOW POINTS AT DATA                                               *         
*=====================================================================*         
         CLC   0(2,R5),=C'<>'      TEST STEREO FLAG FROM SRDON00                
         BNE   LOGO010                                                          
         OI    TSTAT6,TST6STSS     SET STEREO FLAG IN UTL                       
         OI    TSTAT8,TST8STSS     SET STEREO FLAG IN UTL                       
         LA    R5,2(R5)            SKIP PAST FLAG                               
         AHI   R0,-2               AND ADJUST LENGTH                            
         BNP   LOGXIT13                                                         
*                                                                               
LOGO010  CLI   0(R5),C'+'          TEST COMPRESSION FROM SRDON00                
         BNE   LOGO014                                                          
         OI    TSTAT8,TST8BINT     SET COMPRESSION FLAGS                        
         OI    TSTAT9,TST9CMAD+TSTNVRSN                                         
         AHI   R5,1                SKIP PAST FLAG                               
         AHI   R0,-1               AND ADJUST LENGTH                            
         BNP   LOGXIT13                                                         
*                                                                               
         CLI   0(R5),C'#'          TEST MORE THAT 4 SESSIONS                    
         BNE   LOGO014                                                          
         OI    TSTATC,TSTCXSES     SET FLAG                                     
         AHI   R5,1                SKIP PAST FLAG                               
         AHI   R0,-1               AND ADJUST LENGTH                            
         BNP   LOGXIT13                                                         
*                                                                               
LOGO014  CLI   0(R5),C'='          MUST BE = SOMETHING THEN                     
         BNE   LOGXIT12                                                         
*                                                                               
LOGO015  BRAS  RE,GETBUFF                                                       
         LTR   R1,R1               TEST BUFFER AVAILABLE                        
         BZ    LOGXIT12            IF NOT, FORGET IT                            
         ST    R1,TBUFF                                                         
*                                                                               
         AHI   R1,-8                                                            
         MVI   4(R1),X'10'         SET GOBACK FLAG                              
         LA    R1,8(R1)                                                         
*                                                                               
LOGO020  LR    RE,R1               SAVE THIS FOR LENGTH                         
         LA    RF,3                START LEN COUNT AT 3                         
         MVC   1(2,R1),=X'003E'    SET FIELD ADDR                               
         LA    R1,3(R1)                                                         
*                                                                               
LOGO030  CLI   0(R5),C';'          ; MEANS NEXT FIELD                           
         BE    LOGO040                                                          
*                                                                               
         MVC   0(1,R1),0(R5)       MOVE CHR TO FIELD                            
         LA    R1,1(R1)                                                         
         LA    R5,1(R5)                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,LOGO030          NEXT CHR                                     
*                                                                               
LOGO040  LA    R5,1(R5)            BUMP PAST ;                                  
         MVI   0(R1),0             ALWAYS PUT A ZERO AT THE END                 
         STC   RF,0(RE)            SET THIS LEN                                 
         LTR   R0,R0                                                            
         BZ    LOGXIT13            EXIT IF LAST                                 
*                                                                               
         BCT   R0,LOGO020          BACK FOR ANOTHER                             
         B     LOGXIT13            OR MAYBE NOT                                 
                                                                                
*=====================================================================*         
* NOTE THAT THE NEXT INSTRUCTION CONSCIOUSLY OVERWRITES               *         
* ANY OTHER STUPID FUCKING BITS THAT MAY BE ON IN TSTAT3,             *         
* ESPECIALLY CLSDST PENDING. BAD QUEUE LENGTHS ARE RESET              *         
* BY THE CONTROL RPL PROCESSING LOGIC.                                *         
*=====================================================================*         
LOGXIT12 TM    TSTAT5,TST5PSWD     TEST PASSWORD RECONNECT                      
         BO    LOGXIT13                                                         
         MVI   TSSBITS,0           REMOVE BACKGROUND SESS (SECURITY)            
         MVI   TSESSION,0          SET TO SESSION 1                             
*                                                                               
LOGXIT13 MVI   TSTAT3,TSTATLOG     SET LOGON PENDING                            
         NI    TSTAT4,255-(TST4CLIP+TST4UNLG)  RESET FLAGS                      
                                                                                
*=====================================================================*         
* LOCATE THE BIND IMAGE AND SET TERMINAL TYPE                         *         
*=====================================================================*         
         L     R4,LOGONRPL               GET READ-ONLY RPL ADDRESS              
         L     R5,RPLAREA-IFGRPL(R4)     GET ADDRESS OF CINIT                   
         LA    R5,12(R5)                 GET ADDRESS OF BIND IMAGE              
         CLC   14(2,R5),=X'0602'         IS LU6.2 IN BIND IMAGE                 
         TM    RPLCHN-IFGRPL(R4),RPLVACS APPC OR NOT?                           
         BNO   LOG3270T                                                         
         OI    TSTAT4,TST4LU62     INDICATE WE HAVE AN LU62 SESSION             
         B     LOGXCTR                                                          
*                                                                               
LOG3270T OI    TTYPE,TTYPE327                                                   
         CLI   1(R5),2             TEST FM PROFILE 2 (LU 0/3270)                
         BE    *+8                                                              
         OI    TTYPE,TTYPESNA      SET SNA TERMINAL                             
*                                                                               
LOGXCTR  L     R1,LOGQLEN          BUMP THE INPUT QUEUE LENGTH                  
         LA    R0,1(R1)                                                         
         CS    R1,R0,LOGQLEN       THIS IS THE NUTS                             
         BNE   LOGXCTR                                                          
*                                                                               
         POST  LCMECB              POST THE LOGON ECB                           
*                                                                               
LOGXITX  L     RE,LOGXITRE                                                      
         BSM   0,RE                RETURN TO FUCKING VTAM                       
*                                                                               
         EJECT                                                                  
         DROP  R2,R9                                                            
         TITLE 'FALCM - VTAM LOSTERM EXIT'                                      
         EJECT                                                                  
*=================================================================*             
* VTAM LOSTERM EXIT                                               *             
*=================================================================*             
         USING LSTXIT,RB                                                        
         USING COMMON,R9                                                        
LSTXIT   LR    RB,RF                                                            
         LARL  R9,COMMON                                                        
         ST    RE,LSTXITRE                                                      
         LARL  RD,LSTXSAVE         SUPPLY D-CHAIN SAVE AREA                     
         SAM31 ,                                                                
*                                                                               
         L     R2,ASYSFAC                                                       
         USING SYSFACD,R2                                                       
         LR    RA,R1               SAVE PARAM POINTER                           
         USING LSTXPRM,RA                                                       
*                                                                               
         USING UTLD,R3                                                          
         ICM   R3,15,LSTXUSER      GET UTL ENTRY ADDRESS                        
         BZ    LSTXITX             IF 0, HE NEVER LOGGED ON                     
                                                                                
         MVC   LUMSGID,TLUID                                                    
         LA    R0,L'LUMSGWHY       HEX OUT SENSE ERROR                          
         LA    R6,LUMSGWHY                                                      
         L     RF,LSTXWHY          GET SENSE CODE VALUE                         
         CHI   RF,X'14'            STANDARD LOST                                
         JNE   LSTXIT1                                                          
         AP    LSTCOUNT,=P'1'                                                   
         J     LSTXIT2                                                          
                                                                                
LSTXIT1  XR    RE,RE                                                            
         SLDL  RE,4                NIBBLE AT A TIME                             
         LA    RE,HEXTAB(RE)                                                    
         MVC   0(1,R6),0(RE)       HEXOUT VALUE                                 
         LA    R6,1(,R6)           NEXT                                         
         JCT   R0,LSTXIT1                                                       
         LARL  R6,LUMSG            JUST OF TESTING                              
         WTO   TEXT=(R6)                                                        
*                                                                               
LSTXIT2  TM    TSTAT3,TSTATCLS     TEST CLSDST PENDING ALREADY                  
         BO    LSTXIT4                                                          
         OI    TSTAT3,TSTATCLS     SET CLSDST PENDING                           
*                                                                               
LSTXIT3  L     RE,CLSQLEN                                                       
         LA    RF,1(RE)                                                         
         CS    RE,RF,CLSQLEN                                                    
         BNZ   LSTXIT3                                                          
*                                                                               
LSTXIT4  POST  LCMECB              POST THE ECB                                 
*                                                                               
LSTXITX  L     RE,LSTXITRE                                                      
         BSM   0,RE                                                             
         DROP  R3,R8,R9                                                         
         EJECT                                                                  
*======================================================================         
*  VTAM ATTENTION EXIT  --- LU6.2 SPECIFIC                                      
*======================================================================         
         USING ATTNXIT,RB                                                       
         USING COMMON,R9                                                        
ATTNXIT  LR    RB,RF                                                            
         LARL  R9,COMMON                                                        
         ST    RE,ATTNRE    SAVE RETURN ADDRESS                                 
         SAM31 ,                                                                
*                                                                               
         LR    R2,R1                                                            
         LARL  RD,ATNXSAVE  SUPPLY D-CHAIN SAVE AREA                            
         USING LOGONPRM,R2  MAP VTAM PARMS PASSED                               
         L     R8,LOGONACB  GET ACB ADDRESS (1ST WORD OF PLIST)                 
         L     R7,XRORPL    GET READ-ONLY RPL                                   
         USING IFGRPL,R7                                                        
         L     R6,RPLAAREA  GET READ-ONLY RPL EXTENSION                         
         USING ISTRPL6X,R6                                                      
         CLC   XREASON,=C'FMH5'  ARE WE HERE FOR FMH5 ARRIVAL?                  
         BNE   ATTNRET                                                          
         L     R5,ACNTR                                                         
         L     R1,0(R5)     GET CURRENT FMH5 COUNT                              
         LA    R0,1(R1)     ADD 1                                               
         CS    R1,R0,0(R5)  THIS UPDATES IT                                     
*                           SUPPOSE TO TEST CC HERE                             
         POST  LCMECB       POST THE MAIN ECB                                   
*                                                                               
ATTNRET  L     RE,ATTNRE                                                        
         BSM   0,RE                                                             
         DROP  R2,R6,R7,R9                                                      
         EJECT                                                                  
*=================================================================*             
* VTAM TPEND EXIT                                                 *             
*=================================================================*             
         USING TPENDXIT,RB                                                      
         USING COMMON,R9                                                        
TPENDXIT LR    RB,RF                                                            
         LARL  R9,COMMON                                                        
         ST    RE,TPENDXRE                                                      
         LARL  RD,TPNXSAVE  SUPPLY D-CHAIN SAVE AREA                            
*                                                                               
         L     R2,ASYSFAC                                                       
         USING SYSFACD,R2                                                       
         L     RE,VSSB                                                          
         USING SSBD,RE                                                          
         OI    SSBSTAT1,SSBSEOJ    SET EOJ PENDING                              
         L     RE,TPENDXRE                                                      
         BSM   0,RE                                                             
         DROP  R2,RE,R9                                                         
         EJECT                                                                  
*=================================================================*             
* VTAM NETWORK SERVICES EXIT (NSEXIT)                             *             
*=================================================================*             
         USING NSEXIT,RB                                                        
         USING COMMON,R9                                                        
NSEXIT   LR    RB,RF                                                            
         LARL  R9,COMMON                                                        
         ST    RE,NSEXITRE                                                      
         LARL  RD,NSEXSAVE  SUPPLY D-CHAIN SAVE AREA                            
*                                                                               
         L     R2,ASYSFAC                                                       
         USING SYSFACD,R2                                                       
         SAM31 ,                                                                
         L     RE,NSEXITRE                                                      
         BSM   0,RE                                                             
         DROP  R2,R9                                                            
         EJECT                                                                  
*=====================================================================*         
* COMMON STORAGE AND USEFUL ROUTINES - ALL ADDRESSED FROM R9          *         
* RECOMMEND THAT WE USE RELATIVE CODE BELOW HERE                      *         
*=====================================================================*         
         DROP  RB                                                               
         DS    0D                                                               
COMMON   DC    CL8'COMMON'                                                      
*                                                                               
EXIT     SR    RB,RB                                                            
*                                                                               
EXITX    LTR   RB,RB               SET CC EQ                                    
         XIT1  ,                                                                
*                                                                               
EXITR1   XIT1  REGS=(R1)                                                        
*                                                                               
QDOWN    ICM   R0,15,0(R1)         DECREMENT QUEUE COUNT AT 0(R1)               
         BZR   RE                  ERROR IN COUNTER                             
         LR    RF,R0                                                            
         BCTR  RF,0                                                             
         CS    R0,RF,0(R1)                                                      
         JNE   QDOWN                                                            
         BR    RE                                                               
*                                                                               
QUP      L     RF,0(R1)            INCREMENT QUEUE COUNT AT 0(R1)               
         LA    R0,1(RF)                                                         
         CS    RF,R0,0(R1)                                                      
         JNE   QUP                                                              
         BR    RE                                                               
                                                                                
HEXTAB   DC    C'0123456789ABCDEF'                                              
         EJECT                                                                  
***********************************************************************         
* VTAM ROUTINES TO GOTO BASE ON INDEX NUMBER                          *         
***********************************************************************         
LCBRTAB  DC    A(NXT)              0  (=VTWAIT)                                 
         DC    A(LCW)              1  (=VTWRITE)                                
         DC    A(GETUTL)           2  (=VTGETUTL)                               
         DC    A(GETPRQ)           3  (=VTGETPRQ)                               
         DC    A(GETBUF)           4  (=VTGETBUF)                               
         DC    A(OPN)              5  (=VTOPEN)                                 
         DC    A(CLS)              6  (=VTCLOSE)                                
         DC    A(STRTPR)           7  (=VTPRSTRT)                               
         DC    A(STOPPR)           8  (=VTPRSTOP)                               
         DC    A(SETADDR)          9  (=VTBUFFAD)                               
         DC    A(GETCID)           10 (=VTGETCID)                               
         DC    A(GETRPL)           11 (=VTGETRPL)                               
         DC    A(DELPRQ)           12 (=VTDELPRQ)                               
         DC    A(ADDPRQ)           13 (=VTADDPRQ)                               
         DC    A(RELBUF)           14 (=VTRELBUF)                               
         DC    3A(0)               SPARE                                        
         EJECT                                                                  
*=====================================================================*         
* CONSTANTS                                                           *         
*=====================================================================*         
ASYSFAC  DC    V(SYSFAC)                                                        
VMSGQIN  DC    V(MSGQIN)                                                        
         EJECT                                                                  
*=====================================================================*         
* LITERAL POOL                                                        *         
*=====================================================================*         
         LTORG                                                                  
         EJECT                                                                  
         DS    XL128               THESE ARE 256 BYTE FROM L & ST               
LOGXITRE DC    F'0'                                                             
LOGXPARM DC    4F'0'                                                            
*                                                                               
LSTXITRE DC    F'0'                                                             
TPENDXRE DC    F'0'                                                             
NSEXITRE DC    F'0'                                                             
ATTNRE   DS    F'0'                                                             
*                                                                               
ACNTR    DC    A(FMH5CTR)                                                       
*                                                                               
SIGNDON  DC    CL18' SIGNED ON TO DDS '                                         
*                                                                               
BLDSTATM DC    C'**STATUS** TRANSACTION PROCESSING UNITS='                      
BLDSTATA DC    C'000000,'                                                       
BLDSTATB DC    C'0000,'                                                         
BLDSTATC DC    C'00      '                                                      
BLDSTATD DS    D                                                                
BLDSTATR DS    F                                                                
         DC    0H                                                               
LUMSG    DC    AL2(LUMSGQ-2)                                                    
         DC    C'AUTONOTE* AHYDN:LU='                                           
LUMSGID  DC    CL8' '                                                           
         DC    C' LOST TERM, SENSE='                                            
LUMSGWHY DC    CL8'00000000'                                                    
LUMSGQ   EQU   *-LUMSG                                                          
*=====================================================================*         
* COUNTER VALUES                                                      *         
*=====================================================================*         
         DS    0L                                                               
         DC    CL8'LOST TRM'                                                    
LSTCOUNT DC    PL8'0'                                                           
                                                                                
         ORG   LCM+(((*-LCM+15)/16)*16)                                         
         DC    CL8'LCBUFFS='                                                    
LCBUFFS  DC    F'0',F'0'                                                        
         DC    CL8'LOGQLEN='                                                    
LOGQLEN  DC    F'0',F'0'                                                        
         DC    CL8'CLSQLEN='                                                    
CLSQLEN  DC    F'0',F'0'                                                        
         DC    CL8'SIMQLEN='                                                    
SIMQLEN  DC    F'0',F'0'                                                        
         DC    CL8'OUTQLEN='                                                    
OUTQLEN  DC    F'0',F'0'                                                        
         DC    CL8'OUTQFST='                                                    
OUTQFRST DC    A(0)                                                             
OUTQLAST DC    A(0)                                                             
         DS    0D         FOLLOWING WORD UPDATED BY COMPARE & SWAP              
FMH5CTR  DC    F'0'       RUNNING COUNT OF OUTSTANDING FMH5'S                   
*                         INCREMENTED IN LU6.2 ATTENTION EXIT                   
*                         DECREMENTED BY THE RECEIVE FMH5 RTN                   
         DS    0D                                                               
         DC    C'PRTQLEN*'                                                      
PRTQLEN  DC    F'0'                                                             
PRTQFRST DC    A(0)                                                             
PRTQLAST DC    A(0)                                                             
         EJECT                                                                  
*                                                                               
WAITMSG  DC    X'1140401D60',C'SYSTEM NOT READY FOR INPUT'                      
WAITMSGL EQU   *-WAITMSG                                                        
*                                                                               
APPLID   DC    X'00',CL8'VTS'                                                   
         DC    CL3'ECB'                                                         
LCMECB   DC    F'0'                                                             
         DS    0D                                                               
*                                                                               
         DC    CL8'*LCMACB*'                                                    
ACB      ACB   AM=VTAM,APPLID=APPLID,EXLST=EXLST,MACRF=LOGON,          X        
               PARMS=(NIB=ACBNIB)                                               
ACBNIB   NIB   MODE=RECORD                                                      
*                                                                               
EXLST    EXLST AM=VTAM,LOGON=LOGXIT,                                   X        
               TPEND=TPENDXIT,LOSTERM=LSTXIT,NSEXIT=NSEXIT,            X        
               ATTN=ATTNXIT                                                     
         SPACE 2                                                                
TRMSGTAB DS    0H                                                               
         DC    CL16'INACTIVE PRINTER'  01                                       
         DC    CL16'NO UTL BUFFER   '  02                                       
         DC    CL16'ZERO LENGTH MSG '  03                                       
         DC    CL16'TCID = ZERO     '  04                                       
         DC    CL16'LOST SESSION    '  05                                       
         DC    CL16'NEW CID         '  06                                       
         DC    CL16'BAD CHECK       '  07                                       
TRMSG8   DC    CL16'WRITE HUNG      '  08                                       
TRMSGTBX EQU   *                                                                
         EJECT                                                                  
*=================================================================*             
* VTAM RTNCD/FDBK2 ERRORS                                         *             
*=================================================================*             
IGNORE   EQU   X'FFFFFFFF'                                                      
                                                                                
ERRTAB   DS    0D                                                               
         DC    AL1(00,00),AL4(LC0404)   FOR STATUS MESSAGE ERRORS               
         DC    AL1(00,05),AL4(IGNORE)   INPUT AREA TOO SMALL                    
         DC    AL1(00,06),AL4(IGNORE)   NO INPUT AVAILABLE                      
         DC    AL1(00,07),AL4(IGNORE)   INQUIRE INFORMATION NOT AVLBL           
         DC    AL1(00,08),AL4(LC0008)   OPENDST/SIMLOGON FAILED                 
         DC    AL1(00,09),AL4(IGNORE)   OPENDST OPTCD=ACCEPT DENIED             
         DC    AL1(04,03),AL4(LC0403)   EXCEPTION REQUEST RECEIVED              
         DC    AL1(04,04),AL4(LC0404)   NEGATIVE RESPONSE RECEIVED              
         DC    AL1(08,00),AL4(LC0800)   TEMPORARY STORAGE SHORTAGE              
         DC    AL1(12,10),AL4(IGNORE)   REQ CANCELED BY RESETSR                 
         DC    AL1(12,11),AL4(IGNORE)   REQ CANCELED - SESS TERMINATED          
         DC    AL1(12,12),AL4(IGNORE)   REQ CANCELED BY CLEAR REQ               
         DC    AL1(12,13),AL4(IGNORE)   PRIOR EXCPTN IN CHAIN DTCTD             
         DC    AL1(16,00),AL4(IGNORE)   LOGICAL UNIT NOT AVAILABLE              
         DC    AL1(16,01),AL4(LC0404X)  OPNDST FAILED                           
         DC    AL1(16,02),AL4(IGNORE)   LOGICAL UNIT INHIBITED FOR SESS         
         DC    AL1(16,03),AL4(IGNORE)   HALT ISSUED                             
         DC    AL1(16,05),AL4(IGNORE)   REQ OR RESP ENCRYPT FAILURE             
         DC    AL1(16,07),AL4(LC0404X)  REQUEST CANCELED BY VARY                
         DC    AL1(16,09),AL4(IGNORE)   UNCOND TERM OR LOGOFF RECEIVED          
         DC    AL1(16,10),AL4(IGNORE)   VTAM ERROR (RE-YNNYF4FP)                
         DC    AL1(16,13),AL4(IGNORE)   VTAM INACTIVE FOR ACB                   
         DC    AL1(16,14),AL4(IGNORE)   REQUEST ABORTED                         
         DC    AL1(16,15),AL4(IGNORE)   BUFFERS FILLED                          
         DC    AL1(16,17),AL4(IGNORE)   SDT FAILURE ON OPENDST                  
         DC    AL1(16,18),AL4(IGNORE)   MACRO INST FAILURE                      
         DC    AL1(16,20),AL4(IGNORE)   LOGMODE IN OPNDST FAILED                
         DC    AL1(20,02),AL4(IGNORE)   ZERO EXIT FIELD                         
         DC    AL1(20,03),AL4(IGNORE)   ZERO ECB FIELD                          
         DC    AL1(20,04),AL4(IGNORE)   INACTIVE RPL CHECKED                    
         DC    AL1(20,16),AL4(IGNORE)   INVALID CONTROL BLOCK                   
         DC    AL1(20,17),AL4(IGNORE)   RTYPE INVALID                           
         DC    AL1(20,18),AL4(IGNORE)   CLSDST IN PROGRESS                      
         DC    AL1(20,19),AL4(LC2019)   INVALID CID                             
         DC    AL1(20,30),AL4(IGNORE)   INVALID ADDRESS OR DATA LEN             
         DC    AL1(20,35),AL4(IGNORE)   REQUEST TYPE INVALID                    
         DC    AL1(20,36),AL4(IGNORE)   REQUEST INVALID FOR ADDR SPACE          
         DC    AL1(20,59),AL4(IGNORE)   NFME-NRRN RESPONSE                      
         DC    AL1(20,60),AL4(IGNORE)   PREVIOUS MACRO OUTSTANDING              
         DC    AL1(20,64),AL4(IGNORE)   CONTROL INVALID                         
         DC    AL1(20,65),AL4(IGNORE)   DATA TRAFFIC NOT ALLOWED                
         DC    AL1(20,66),AL4(IGNORE)   INVALID STYPE FOR SESSIONC              
         DC    AL1(20,68),AL4(IGNORE)   RESPLIM EXCEEDED                        
         DC    AL1(20,71),AL4(IGNORE)   3270 SEND OPTION INVALID                
         DC    AL1(20,72),AL4(IGNORE)   SESS-CTL PROTOCOL VIOLATION             
         DC    AL1(20,75),AL4(IGNORE)   INVALID BIND IMAGE                      
         DC    AL1(20,78),AL4(IGNORE)   INVALID USE OF NIB LIST                 
         DC    AL1(20,79),AL4(IGNORE)   ACQUIRE/ACCEPT OPTION INVALID           
         DC    AL1(20,80),AL4(IGNORE)   RPL FIELD INVALID                       
         DC    AL1(20,81),AL4(IGNORE)   SIMLOGON NOT ALLOWED                    
         DC    AL1(20,82),AL4(IGNORE)   NIB INVALID                             
         DC    AL1(20,83),AL4(IGNORE)   LU NOT FOUND                            
         DC    AL1(20,85),AL4(IGNORE)   PROG NOT AUTHORIZED                     
         DC    AL1(20,87),AL4(IGNORE)   INVALID MODE FIELD                      
         DC    AL1(20,94),AL4(IGNORE)   CLSDST/PASS NOT AUTH                    
         DC    AL1(20,96),AL4(IGNORE)   INVALID LU FOR CLSDST/SESSC             
         DC    AL1(20,97),AL4(IGNORE)   INVALID SETLOGON                        
         DC    AL1(20,108),AL4(IGNORE)  TOO MANY RCVCMD REQUESTS                
         DC    AL1(20,109),AL4(IGNORE)  APPL NOT AUTH FOR CMDS                  
         DC    AL1(20,110),AL4(IGNORE)  SYNTAX ERROR IN OPER REPLY              
         DC    AL1(20,111),AL4(IGNORE)  CMD PROCESSOR INACTIVE                  
         DC    AL1(20,112),AL4(IGNORE)  PROG OPER CLOSING ACB                   
         DC    AL1(20,119),AL4(IGNORE)  FM DATA REQ UNIT REQ'D ???              
         DC    AL1(20,126),AL4(IGNORE)  MACRO OPTCD CONFLICT                    
         DC    X'FF'                                                            
         EJECT                                                                  
AIDTAB   DC    X'7D'                                ENTER                       
         DC    X'F1F2F3F4F5F6F7F8F97A7B7C'          PF01-PF12                   
         DC    X'C1C2C3C4C5C6C7C8C94A4B4C'          PF13-PF24                   
         DC    X'FF'                                                            
         SPACE 2                                                                
PAKTAB   DS    0CL8                                 PA KEY EQUATES              
PAKSTAT  DC    X'6C',CL7'=STATUS'                   PA1                         
PAKKILL  DC    X'6E',CL7'=KILL  '                   PA2                         
         DC    X'6D',CL7'=CT    '                   CLEAR                       
PAKDATA0 DC    X'00',CL7'=NODATA'                   FOR BAD MSG LEN             
         DC    X'FF',CL7'       '                                               
         EJECT                                                                  
         CNOP  0,4       RECEIVE TABLE LOWER CASE EBC TO UPPER CASE EBC         
EBCEBC   EQU   *                                                                
*                 0 1 2 3 4 5 6 7 8 9 A B C D E F                               
         DC    X'000102030405060708090A0B0C0D0E0F'  0                           
         DC    X'101112131415161718191A1B1C1D1E1F'  1                           
         DC    X'202122232425262728292A2B2C2D2E2F'  2                           
         DC    X'303132333435363738393A3B3C3D3E3F'  3                           
         DC    X'404142434445464748494A4B4C4D4E4F'  4                           
         DC    X'505152535455565758595A5B5C5D5E5F'  5                           
         DC    X'606162636465666768696A6B6C6D6E6F'  6                           
         DC    X'707172737475767778797A7B7C7D7E7F'  7                           
         DC    X'80C1C2C3C4C5C6C7C8C98A8B8C8D8E8F'  8                           
         DC    X'90D1D2D3D4D5D6D7D8D99A9B9C9D9E9F'  9                           
         DC    X'A0A1E2E3E4E5E6E7E8E9AAABACADAEAF'  A                           
         DC    X'B0B1B2B3B4B5B6B7B8B9BABBBCBDBEBF'  B                           
         DC    X'C0C1C2C3C4C5C6C7C8C9CACBCCCDCECF'  C                           
         DC    X'D0D1D2D3D4D5D6D7D8D9DADBDCDDDEDF'  D                           
         DC    X'E0E1E2E3E4E5E6E7E8E9EAEBECEDEEEF'  E                           
         DC    X'F0F1F2F3F4F5F6F7F8F9FAFBFCFDFEFF'  F                           
         EJECT                                                                  
*&&UK                                                                           
SWAPTAB  DC    AL1(1),CL8'LTST     '   SYSTEM NUMBER & LUID                     
         DC    AL1(2),CL8'LADV1    '                                            
         DC    AL1(3),CL8'TTS      '                                            
         DC    AL1(4),CL8'LADV2    '                                            
         DC    AL1(5),CL8'NEW      '                                            
         DC    AL1(6),CL8'LADV3    '                                            
         DC    AL1(8),CL8'LADV4    '                                            
         DC    AL1(10),CL8'LADVA   '                                            
         DC    AL1(11),CL8'LCSC    '                                            
         DC    AL1(12),CL8'LADVB   '                                            
         DC    AL1(13),CL8'LFQA    '                                            
         DC    AL1(14),CL8'LADVC   '                                            
         DC    AL1(255)                                                         
         SPACE 2                                                                
SWAPTAB2 DC    AL1(01,11)               TST  TO CSC                             
         DC    AL1(03,01)               TTS  TO TST                             
         DC    AL1(05,11)               NEW  TO CSC                             
         DC    AL1(11,01)               CSC  TO TST                             
         DC    AL1(02,11)               ADV1 TO CSC                             
         DC    AL1(04,11)               ADV2 TO CSC                             
         DC    AL1(06,11)               ADV3 TO CSC                             
         DC    AL1(08,11)               ADV4 TO CSC                             
         DC    AL1(10,11)               ADVA TO CSC                             
         DC    AL1(12,11)               ADVB TO CSC                             
         DC    AL1(14,11)               ADVC TO CSC                             
         DC    AL1(255)                                                         
*&&                                                                             
*&&US                                                                           
SWAPTAB  DC    AL1(01),CL8'TST     '    SYSTEM NUMBER & LUID                    
         DC    AL1(02),CL8'ADV1    '                                            
         DC    AL1(03),CL8'ADV5    '                                            
         DC    AL1(04),CL8'REPA    '                                            
         DC    AL1(05),CL8'ADV2    '                                            
         DC    AL1(06),CL8'MEL     '                                            
         DC    AL1(07),CL8'ADV3    '                                            
         DC    AL1(08),CL8'ADV4    '                                            
         DC    AL1(09),CL8'REPC    '                                            
         DC    AL1(10),CL8'ADV6    '                                            
         DC    AL1(11),CL8'CSC     '                                            
         DC    AL1(12),CL8'ADV7    '                                            
         DC    AL1(13),CL8'ADV8    '                                            
         DC    AL1(14),CL8'REPB    '                                            
         DC    AL1(15),CL8'FQA     '                                            
         DC    AL1(255)                                                         
*                                                                               
         SPACE 2                                                                
SWAPTAB2 DC    AL1(01,11)               TST  TO CSC                             
         DC    AL1(06,01)               MEL  TO TST                             
         DC    AL1(11,01)               CSC  TO TST                             
         DC    AL1(02,11)               ADV1 TO CSC                             
         DC    AL1(03,11)               ADV5 TO CSC                             
         DC    AL1(04,11)               REPA TO CSC                             
         DC    AL1(05,11)               ADV2 TO CSC                             
         DC    AL1(07,11)               ADV3 TO CSC                             
         DC    AL1(08,11)               ADV4 TO CSC                             
         DC    AL1(09,11)               REPC TO CSC                             
         DC    AL1(10,11)               ADV6 TO CSC                             
         DC    AL1(12,11)               ADV7 TO CSC                             
         DC    AL1(13,11)               ADV8 TO CSC                             
         DC    AL1(14,11)               REPB TO CSC                             
         DC    AL1(255)                                                         
*&&                                                                             
         EJECT                                                                  
         DS    0D                                                               
         DC    CL8'*SESSRPL'                                                    
SESSRPL  RPL   AM=VTAM,NIB=SESSNIB,AREA=SESSAREA,AREALEN=256                    
SESSNIB  NIB   MODE=RECORD                                                      
         DS    0D                                                               
         DC    CL8'SESSAREA*'                                                   
SESSAREA DS    XL256                                                            
         DS    0D                                                               
         DC    C'LOGXSAVE'                                                      
LOGXSAVE DS    80D                                                              
         DC    C'LSTXSAVE'                                                      
ATNXSAVE DS    80D                                                              
         DC    C'ATNXSAVE'                                                      
LSTXSAVE DS    80D                                                              
         DC    C'TPNXSAVE'                                                      
TPNXSAVE DS    80D                                                              
         DC    C'NSEXSAVE'                                                      
NSEXSAVE DS    80D                                                              
         EJECT                                                                  
*=====================================================================*         
* FARPLS                                                              *         
*=====================================================================*         
         DS    0D                                                               
         DC    CL8'*RPLLST*'                                                    
RPLLST   DS    0D                                                               
*                                                                               
W01      DC    CL3'W01',AL1(FARPLWRT),A(W02,NIBW01,RPLW01,0,0,0)                
W02      DC    CL3'W02',AL1(FARPLWRT),A(W03,NIBW02,RPLW02,0,0,0)                
W03      DC    CL3'W03',AL1(FARPLWRT),A(W04,NIBW03,RPLW03,0,0,0)                
W04      DC    CL3'W04',AL1(FARPLWRT),A(W05,NIBW04,RPLW04,0,0,0)                
W05      DC    CL3'W05',AL1(FARPLWRT),A(W06,NIBW05,RPLW05,0,0,0)                
W06      DC    CL3'W06',AL1(FARPLWRT),A(W07,NIBW06,RPLW06,0,0,0)                
W07      DC    CL3'W07',AL1(FARPLWRT),A(W08,NIBW07,RPLW07,0,0,0)                
W08      DC    CL3'W08',AL1(FARPLWRT),A(R01,NIBW08,RPLW08,0,0,0)                
*                                                                               
R01      DC    CL3'R01',AL1(FARPLRD),A(R02,NIBR01,RPLR01,0,0,0)                 
R02      DC    CL3'R02',AL1(FARPLRD),A(R03,NIBR02,RPLR02,0,0,0)                 
R03      DC    CL3'R03',AL1(FARPLRD),A(R04,NIBR03,RPLR03,0,0,0)                 
R04      DC    CL3'R04',AL1(FARPLRD),A(R05,NIBR04,RPLR04,0,0,0)                 
R05      DC    CL3'R05',AL1(FARPLRD),A(R06,NIBR05,RPLR05,0,0,0)                 
R06      DC    CL3'R06',AL1(FARPLRD),A(R07,NIBR06,RPLR06,0,0,0)                 
R07      DC    CL3'R07',AL1(FARPLRD),A(R08,NIBR07,RPLR07,0,0,0)                 
R08      DC    CL3'R08',AL1(FARPLRD),A(C01,NIBR08,RPLR08,0,0,0)                 
*                                                                               
C01      DC    CL3'C01',AL1(FARPLLOG),A(C02,NIBC01,RPLC01,0,0,0)                
C02      DC    CL3'C02',AL1(FARPLLOG),A(C03,NIBC02,RPLC02,0,0,0)                
C03      DC    CL3'C03',AL1(FARPLLOG),A(C04,NIBC03,RPLC03,0,0,0)                
C04      DC    CL3'C04',AL1(FARPLLOG),A(C05,NIBC04,RPLC04,0,0,0)                
C05      DC    CL3'C05',AL1(FARPLLOG),A(C06,NIBC05,RPLC05,0,0,0)                
C06      DC    CL3'C06',AL1(FARPLLOG),A(C07,NIBC06,RPLC06,0,0,0)                
C07      DC    CL3'C07',AL1(FARPLLOG),A(C08,NIBC07,RPLC07,0,0,0)                
C08      DC    CL3'C08',AL1(FARPLLOG),A(C09,NIBC08,RPLC08,0,0,0)                
C09      DC    CL3'C09',AL1(FARPLLOG),A(C10,NIBC09,RPLC09,0,0,0)                
C10      DC    CL3'C10',AL1(FARPLLOG),A(C11,NIBC10,RPLC10,0,0,0)                
C11      DC    CL3'C11',AL1(FARPLLOG),A(C12,NIBC11,RPLC11,0,0,0)                
C12      DC    CL3'C12',AL1(FARPLLOG),A(C13,NIBC12,RPLC12,0,0,0)                
*                                                                               
C13      DC    CL3'C13',AL1(FARPLCLS),A(C14,NIBC13,RPLC13,0,0,0)                
C14      DC    CL3'C14',AL1(FARPLCLS),A(C15,NIBC14,RPLC14,0,0,0)                
C15      DC    CL3'C15',AL1(FARPLCLS),A(OFP,NIBC15,RPLC15,0,0,0)                
*                                                                               
OFP      DC    CL3'62A',AL1(FARPL62),A(FHM5FARP,0,RPL62A,0,0,0)                 
FHM5FARP DC    CL3'62B',AL1(FARPL62),A(RECVFARP,0,RPL62B,0,0,0)                 
RECVFARP DC    CL3'62C',AL1(FARPL62),A(RECVFAR2,0,RPL62C,0,0,0)                 
RECVFAR2 DC    CL3'62D',AL1(FARPL62),A(0,0,RPL62D,0,0,0)                        
*                                                                               
*=====================================================================*         
* RPL DEFINITIONS                                                     *         
*=====================================================================*         
         SPACE 1                                                                
         DC    CL8'*RPLW01*'                                                    
RPLW01   RPL   AM=VTAM,NIB=NIBW01                                               
         DC    CL8'*NIBW01*'                                                    
NIBW01   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLW02*'                                                    
RPLW02   RPL   AM=VTAM,NIB=NIBW02                                               
         DC    CL8'*NIBW02*'                                                    
NIBW02   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLW03*'                                                    
RPLW03   RPL   AM=VTAM,NIB=NIBW03                                               
         DC    CL8'*NIBW03*'                                                    
NIBW03   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLW04*'                                                    
RPLW04   RPL   AM=VTAM,NIB=NIBW04                                               
         DC    CL8'*NIBW04*'                                                    
NIBW04   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLW05*'                                                    
RPLW05   RPL   AM=VTAM,NIB=NIBW05                                               
         DC    CL8'*NIBW05*'                                                    
NIBW05   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLW06*'                                                    
RPLW06   RPL   AM=VTAM,NIB=NIBW06                                               
         DC    CL8'*NIBW06*'                                                    
NIBW06   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLW07*'                                                    
RPLW07   RPL   AM=VTAM,NIB=NIBW07                                               
         DC    CL8'*NIBW07*'                                                    
NIBW07   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLW08*'                                                    
RPLW08   RPL   AM=VTAM,NIB=NIBW08                                               
         DC    CL8'*NIBW08*'                                                    
NIBW08   NIB   MODE=RECORD                                                      
*********************************                                               
         DC    CL8'*RPLR01*'                                                    
RPLR01   RPL   AM=VTAM,NIB=NIBR01                                               
         DC    CL8'*NIBR01*'                                                    
NIBR01   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLR02*'                                                    
RPLR02   RPL   AM=VTAM,NIB=NIBR02                                               
         DC    CL8'*NIBR02*'                                                    
NIBR02   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLR03*'                                                    
RPLR03   RPL   AM=VTAM,NIB=NIBR03                                               
         DC    CL8'*NIBR03*'                                                    
NIBR03   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLR04*'                                                    
RPLR04   RPL   AM=VTAM,NIB=NIBR04                                               
         DC    CL8'*NIBR04*'                                                    
NIBR04   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLR05*'                                                    
RPLR05   RPL   AM=VTAM,NIB=NIBR05                                               
         DC    CL8'*NIBR05*'                                                    
NIBR05   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLR06*'                                                    
RPLR06   RPL   AM=VTAM,NIB=NIBR06                                               
         DC    CL8'*NIBR06*'                                                    
NIBR06   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLR07*'                                                    
RPLR07   RPL   AM=VTAM,NIB=NIBR07                                               
         DC    CL8'*NIBR07*'                                                    
NIBR07   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLR08*'                                                    
RPLR08   RPL   AM=VTAM,NIB=NIBR08                                               
         DC    CL8'*NIBR08*'                                                    
NIBR08   NIB   MODE=RECORD                                                      
*************************************                                           
         DC    CL8'*RPLC01*'                                                    
RPLC01   RPL   AM=VTAM,NIB=NIBC01                                               
         DC    CL8'*NIBC01*'                                                    
NIBC01   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC02*'                                                    
RPLC02   RPL   AM=VTAM,NIB=NIBC02                                               
         DC    CL8'*NIBC02*'                                                    
NIBC02   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC03*'                                                    
RPLC03   RPL   AM=VTAM,NIB=NIBC03                                               
         DC    CL8'*NIBC03*'                                                    
NIBC03   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC04*'                                                    
RPLC04   RPL   AM=VTAM,NIB=NIBC04                                               
         DC    CL8'*NIBC04*'                                                    
NIBC04   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC05*'                                                    
RPLC05   RPL   AM=VTAM,NIB=NIBC05                                               
         DC    CL8'*NIBC05*'                                                    
NIBC05   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC06*'                                                    
RPLC06   RPL   AM=VTAM,NIB=NIBC06                                               
         DC    CL8'*NIBC06*'                                                    
NIBC06   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC07*'                                                    
RPLC07   RPL   AM=VTAM,NIB=NIBC07                                               
         DC    CL8'*NIBC07*'                                                    
NIBC07   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC08*'                                                    
RPLC08   RPL   AM=VTAM,NIB=NIBC08                                               
         DC    CL8'*NIBC08*'                                                    
NIBC08   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC09*'                                                    
RPLC09   RPL   AM=VTAM,NIB=NIBC09                                               
         DC    CL8'*NIBC09*'                                                    
NIBC09   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC10'                                                     
RPLC10   RPL   AM=VTAM,NIB=NIBC10                                               
         DC    CL8'*NIBC10*'                                                    
NIBC10   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC11*'                                                    
RPLC11   RPL   AM=VTAM,NIB=NIBC11                                               
         DC    CL8'*NIBC11*'                                                    
NIBC11   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC12*'                                                    
RPLC12   RPL   AM=VTAM,NIB=NIBC12                                               
         DC    CL8'*NIBC12*'                                                    
NIBC12   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC13*'                                                    
RPLC13   RPL   AM=VTAM,NIB=NIBC13                                               
         DC    CL8'*NIBC13*'                                                    
NIBC13   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC14*'                                                    
RPLC14   RPL   AM=VTAM,NIB=NIBC14                                               
         DC    CL8'*NIBC14*'                                                    
NIBC14   NIB   MODE=RECORD                                                      
         DC    CL8'*RPLC15*'                                                    
RPLC15   RPL   AM=VTAM,NIB=NIBC15                                               
         DC    CL8'*NIBC15*'                                                    
NIBC15   NIB   MODE=RECORD                                                      
         SPACE 2                                                                
******  LU6.2  RPLS & EXTENSIONS  NOTE; NIB NOT NEEDED FOR THESE                
         DC    CL8'*RPL62A*'                                                    
RPL62A   RPL   AM=VTAM                                                          
RPL62AX  ISTRPL6              LU6.2 EXTENSION                                   
         DC    CL8'*RPL62B*'                                                    
RPL62B   RPL   AM=VTAM                                                          
RPL62BX  ISTRPL6              LU6.2 EXTENSION                                   
         DC    CL8'*RPL62C*'                                                    
RPL62C   RPL   AM=VTAM                                                          
RPL62CX  ISTRPL6              LU6.2 EXTENSION                                   
         DC    CL8'*RPL62D*'                                                    
RPL62D   RPL   AM=VTAM                                                          
RPL62DX  ISTRPL6              LU6.2 EXTENSION                                   
         EJECT                                                                  
*=====================================================================*         
* VTAM CORE-RESIDENT TRACE BUFFER                                     *         
*=====================================================================*         
         SPACE 1                                                                
         DS    0D                                                               
         DC    CL8'*TRCBUFF'                                                    
TRCBUFF  DS    6400C                                                            
FMH5AREA DS    CL255                                                            
         TITLE 'FALCM - DSECTS'                                                 
         EJECT                                                                  
*=====================================================================*         
* WORKING STORAGE DSECT                                               *         
*=====================================================================*         
         SPACE 1                                                                
LCMWRK   DSECT                                                                  
P1       DS    A                                                                
P2       DS    A                                                                
P3       DS    A                                                                
P4       DS    A                                                                
P5       DS    A                                                                
P6       DS    A                                                                
DUB      DS    D                                                                
FULL     DS    F                                                                
WORK     DS    6F                                                               
DDSFLAG  DS    C                                                                
CLSFLAG  DS    C                                                                
         DS    CL2                                                              
ERRDATA  DS    CL16                                                             
*                                                                               
LOGREC   DS    0CL38                                                            
LOGID    DS    CL4                                                              
LOGLINE  DS    CL4                                                              
LOGCUDV  DS    CL4                                                              
LOGTIME  DS    PL4                                                              
LOGDATA  DS    CL22                                                             
*                                                                               
LCMWRKL  EQU   *-LCMWRK                                                         
***********************************************************************         
* LOGON EXIT CALLING PARAMETERS                                                 
***********************************************************************         
LOGONPRM DSECT                                                                  
LOGONACB DS    A                   A(ACB)                                       
LOGONSYM DS    A                   A(EIGHT BYTE SYMBOLIC NAME)                  
LOGONUSR DS    A                   SIMLOGON DATA OR ZERO                        
LOGONLEN DS    F                   L'USER DATA FROM LU                          
LOGONRPL DS    A                   VTAM SUPPLIED READ ONLT RPL                  
LOGONCID DS    F                   NUMBER ASSIGNED TO SESSION                   
         ORG   LOGONLEN                                                         
XREASON  DS    CL4                                                              
XRORPL   DS    A                                                                
                                                                                
***********************************************************************         
* LOST TERMINAL EXIT CALLING PARAMETERS                                         
***********************************************************************         
LSTXPRM  DSECT                                                                  
LSTXACB  DS    A                   A(ACB)                                       
LSTXCID  DS    F                   CID                                          
LSTXUSER DS    F                   USERFLD OF NIB                               
LSTXWHY  DS    F                   LOSTERM REASON CODE                          
                                                                                
***********************************************************************         
* NSX EXIT CALLING PARAMETERS                                                   
***********************************************************************         
NSXPRM   DSECT                                                                  
NSXACB   DS    A                   A(ACB)                                       
NSXCID   DS    F                   CID -- CLEAN UP CALL ONLY                    
NSXUSER  DS    F                   USERFLD OF NIB -- CLEANUP                    
         DS    F                   RESERVED                                     
NSXRORPL DS    F                   READ ONLY RPL                                
         DS    F                   RESERVED                                     
         EJECT                                                                  
*=====================================================================*         
* FARPLD - COVERS RPLLST                                              *         
*=====================================================================*         
       ++INCLUDE FARPLD                                                         
FARPL62  EQU     X'10'          LU62 ENTRY                                      
FARPL62A EQU     X'20'          DEDICATED FARPL HAS BEEN ASSIGNED               
         EJECT                                                                  
*=====================================================================*         
* OTHER INCLUDED DSECTS                                               *         
*=====================================================================*         
* VTTRCBUFF                                                                     
         PRINT OFF                                                              
       ++INCLUDE VTTRCBUFF                                                      
         PRINT ON                                                               
* FAUTL                                                                         
         PRINT OFF                                                              
       ++INCLUDE FAUTL                                                          
         PRINT ON                                                               
* FASSB                                                                         
         PRINT OFF                                                              
       ++INCLUDE FASSB                                                          
         PRINT ON                                                               
* FATCB                                                                         
         PRINT OFF                                                              
       ++INCLUDE FATCB                                                          
         PRINT ON                                                               
* FASCREQUS                                                                     
         PRINT OFF                                                              
       ++INCLUDE FASCREQUS                                                      
         PRINT ON                                                               
* FASYSFAC                                                                      
         PRINT OFF                                                              
       ++INCLUDE FASYSFAC                                                       
         PRINT ON                                                               
* FAPRQ                                                                         
         PRINT OFF                                                              
       ++INCLUDE FAPRQ                                                          
         PRINT ON                                                               
* FATBHD                                                                        
         PRINT OFF                                                              
       ++INCLUDE FATBHD                                                         
         PRINT ON                                                               
* FASELIST                                                                      
         PRINT OFF                                                              
       ++INCLUDE FASELIST                                                       
         PRINT ON                                                               
         EJECT                                                                  
*=====================================================================*         
* IBM INCLUDED DSECTS                                                 *         
*=====================================================================*         
         SPACE 2                                                                
         ISTUSFBC                                                               
         EJECT                                                                  
         PRINT GEN                                                              
         IFGRPL AM=VTAM                                                         
         EJECT                                                                  
         IFGACB AM=VTAM                                                         
         EJECT                                                                  
         ISTDNIB                                                                
         EJECT                                                                  
         ISTDBIND                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'025FALCM     01/23/13'                                      
         END                                                                    
