*          DATA SET GECFMIO    AT LEVEL 001 AS OF 10/07/08                      
*CATALP CFMIO                                                                   
CFMIO    TITLE '- Spot/Net/Print MediaVantage downloads'                        
CFMIO    CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 WORKL,**CFMIO*,CLEAR=YES                                         
         USING WORKD,RC                                                         
         MVC   SAVERD,4(RD)        Save RD for called server routines           
         LR    R9,R1                                                            
         USING CFMIOD,R9           R9=A(Interface block)                        
         LARL  R8,GLOBALS                                                       
         USING GLOBALS,R8          R8=A(Global literals)                        
                                                                                
         MVI   CFMERR,0            Initialize return byte                       
         ICM   RF,15,CFMACOM                                                    
         MVC   ADDAY,CADDAY-COMFACSD(RF)                                        
         MVC   DATCON,CDATCON-COMFACSD(RF)                                      
         MVC   GETDAY,CGETDAY-COMFACSD(RF)                                      
         MVC   DMGR,CDATAMGR-COMFACSD(RF)                                       
         MVC   BINSRCH,CBINSRCH-COMFACSD(RF)                                    
                                                                                
         ICM   RA,15,CFMALP                                                     
         USING LP_D,RA             RA=A(LP_D)                                   
         MVC   AGY,LP_AGY                                                       
         TM    LP_FLAG,LP_FOFFL    Set A(TSAR) for DDLINK on-line               
         JNZ   *+10                                                             
         MVC   LP_ATSAR,CFMATSAR                                                
                                                                                
         CLI   CFMACTN,CFMANXT     Test get next record                         
         JE    REQRUN                                                           
         CLI   CFMACTN,CFMAINI     Test initialization                          
         JE    REQINI                                                           
         DC    H'0'                                                             
         EJECT                                                                  
***********************************************************************         
* Initialize a new request                                            *         
***********************************************************************         
                                                                                
REQINI   MVI   CFMINDS,0           Clear indicators                             
         XC    CFMVALS(CFMVALL),CFMVALS                                         
         XC    CFMLVALS(CFMLVALL),CFMLVALS                                      
                                                                                
         LARL  RE,SPT                                                           
         CLI   CFMSYS,MPTRSSPT     Test Spotpak                                 
         JE    REQINI02                                                         
         LARL  RE,NET                                                           
         CLI   CFMSYS,MPTRSNET     Test Netpak                                  
         JE    REQINI02                                                         
         LARL  RE,PRT                                                           
         CLI   CFMSYS,MPTRSPRT     Test Printpak                                
         JE    REQINI02                                                         
         DC    H'0'                Unknown system                               
                                                                                
REQINI02 ST    RE,CFMASYS          Set A(System handling routine)               
                                                                                
         GOTOR MEDINI              Initialize media table                       
         JNE   EXITSET             Exit if no media                             
                                                                                
         GOTOR DATINI              Initialize request dates                     
         JNE   EXITSET             Exit if bad dates                            
                                                                                
         GOTOR VENINI              Initialize vendor buffer                     
         JNE   EXITSET             Exit if no vendors at given node             
                                                                                
         GOTOR ADVINI              Initialize for advertiser requests           
         JE    REQINI04            Process if advertiser node(s) given          
                                                                                
         GOTOR BRDINI              Initialize for brand requests                
         JNE   EXITSET             Exit if no brands or error                   
                                                                                
REQINI04 MVI   CFMINDS,CFMINXT     Set first time flag                          
         MVI   CFMACTN,CFMANXT     Set next time action code                    
         XC    CFMTREC1,CFMTREC1   Initialize client record                     
         XC    CFMTREC2,CFMTREC2   Initialize vendor record                     
                                                                                
REQINIX  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Go to system handler                                                *         
***********************************************************************         
                                                                                
REQRUN   MVC   VALS(VALL),CFMLVALS Set driver values/dates                      
         MVC   DATES(DATESL),CFMSTDTB                                           
         GOTOR CFMASYS             Go to system handler                         
         EJECT                                                                  
***********************************************************************         
* Initialize media table                                              *         
***********************************************************************         
                                                                                
MEDINI   NTR1  LABEL=*                                                          
         LA    R4,CFMMTAB                                                       
         USING CFMMTD,R4           R4=A(Media table)                            
         SR    R5,R5               R5=N'Media table entries                     
         LA    R2,KEY                                                           
         USING CFMRECD,R2                                                       
         XC    CFMKEY,CFMKEY                                                    
         MVI   CFMKTYPE,CFMKTYPQ                                                
         MVC   CFMKAGY,LP_CUAGY                                                 
         MVI   CFMKSUBR,CFMKSMED                                                
         MVC   KEYSAVE,CFMKEY                                                   
         GOTOR DMGR,DMCB,DMRDHI,GENDIR,CFMKEY,CFMKEY                            
         J     MEDINI04                                                         
                                                                                
MEDINI02 LA    R2,KEY                                                           
         GOTOR DMGR,DMCB,DMRSEQ,GENDIR,CFMKEY,CFMKEY                            
                                                                                
MEDINI04 JE    *+6                                                              
         DC    H'0'                                                             
         CLC   CFMKEY(CFMKCODE-CFMKEY),KEYSAVE                                  
         JNE   MEDINI14                                                         
         GOTOR DMGR,DMCB,GETREC,GENFIL,CFMKDA,IO,WORK                           
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         LA    R2,IO                                                            
         LA    R6,CFMFIRST                                                      
         USING MPTRD,R6                                                         
MEDINI06 CLI   MPTREL,0            Test end of record                           
         JE    MEDINI02                                                         
         CLI   MPTREL,MPTRELQ                                                   
         JE    *+16                                                             
         LLC   RE,MPTRLN                                                        
         AR    R6,RE                                                            
         J     MEDINI06                                                         
                                                                                
         CLC   MPTRSYS,CFMSYS      Test for this system                         
         JNE   MEDINI02                                                         
         CLI   MPTRSYS,MPTRSNET    Test Netpak                                  
         JNE   *+8                                                              
         CLI   MPTRMED,C'*'        Yes - test client media code                 
         JNE   *+10                                                             
         MVC   NETMNODE,CFMKRNOD   Yes - save it                                
                                                                                
         SR    RF,RF                                                            
         ICM   RF,7,CFMAMED+1      Test any media filters                       
         JZ    MEDINI10                                                         
         USING LW_D,RF                                                          
         CLI   LW_TYPE,LQ_TLSTQ                                                 
         JE    *+6                                                              
         DC    H'0'                                                             
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN                                                     
         LA    RE,LW_DATA2                                                      
                                                                                
MEDINI08 CLC   CFMKRNOD,0(RE)      Test this media was requested                
         JE    MEDINI10                                                         
         AHI   RE,L'CFMKRNOD                                                    
         JCT   R0,MEDINI08                                                      
         J     MEDINI02            No - get next media record                   
                                                                                
MEDINI10 MVC   CFMMTMED,MPTRMED    Build media table entry                      
         MVC   CFMMTNOD,CFMKRNOD                                                
                                                                                
         LARL  RE,MEDINI12         Call server to translate media               
         NTR1  LABEL=NO                                                         
         GOTOR ,DMCB,CFMMTMED,CFMMTAGM                                          
         ICM   RF,15,CFMACNVM                                                   
         L     RE,SAVERD                                                        
         LM    R2,RC,28(RE)        Restore caller's registers 2-C               
         CR    RE,RE                                                            
         BASR  RE,RF                                                            
         J     EXIT                                                             
MEDINI12 JNE   MEDINI02            Media rejected by server                     
                                                                                
         AHI   R4,CFMMTLNQ         Bump to next media table entry               
         AHI   R5,1                Bump N'table entries                         
         J     MEDINI02                                                         
         DROP  R4,R6                                                            
                                                                                
MEDINI14 LTR   R0,R5               Test any media for this request              
         JNZ   *+12                                                             
         MVI   CFMERR,CFMENMED     No - nothing more to do                      
         J     EXITN                                                            
                                                                                
         SHI   R0,1                                                             
         JZ    MEDINIX                                                          
         LA    R1,CFMMTAB          Sort media table into key sequence           
MEDINI16 LA    RF,CFMMTLNQ(R1)                                                  
         LR    RE,R0                                                            
MEDINI18 CLC   CFMMTAGM-CFMMTD(,R1),CFMMTAGM-CFMMTD(RF)                         
         JNH   *+22                                                             
         XC    0(CFMMTLNQ,R1),0(RF)                                             
         XC    0(CFMMTLNQ,RF),0(R1)                                             
         XC    0(CFMMTLNQ,R1),0(RF)                                             
         AHI   RF,CFMMTLNQ                                                      
         JCT   RE,MEDINI18                                                      
         AHI   R1,CFMMTLNQ                                                      
         JCT   R0,MEDINI16                                                      
                                                                                
MEDINIX  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Initialize request dates                                            *         
***********************************************************************         
                                                                                
DATINI   NTR1  LABEL=*                                                          
         OC    CFMSTDTB(L'CFMSTDTB+L'CFMENDTB),CFMSTDTB                         
         JNZ   *+14                                                             
         OC    CFMSTDTC(L'CFMSTDTC+L'CFMENDTC),CFMSTDTC                         
         JZ    DATINI08                                                         
                                                                                
         OC    CFMSTDTB,CFMSTDTB   Test binary start date given                 
         JZ    DATINI02                                                         
         OC    CFMSTDTC,CFMSTDTC   Test compressed start date given             
         JNZ   DATINI04                                                         
         GOTOR DATCON,DMCB,(3,CFMSTDTB),(2,CFMSTDTC)                            
         J     DATINI04                                                         
                                                                                
DATINI02 OC    CFMSTDTC,CFMSTDTC   Test compressed start date given             
         JZ    DATINI04                                                         
         GOTOR DATCON,DMCB,(2,CFMSTDTC),(3,CFMSTDTB)                            
                                                                                
DATINI04 OC    CFMENDTB,CFMENDTB   Test binary end date given                   
         JZ    DATINI06                                                         
         OC    CFMENDTC,CFMENDTC   Test compressed end date given               
         JNZ   DATINI10                                                         
         CLC   CFMENDTB,XFFS                                                    
         JNE   *+14                                                             
         MVC   CFMENDTC,XFFS                                                    
         J     DATINI10                                                         
         GOTOR DATCON,DMCB,(3,CFMENDTB),(2,CFMENDTC)                            
         J     DATINI10                                                         
                                                                                
DATINI06 OC    CFMENDTC,CFMENDTC   Test compressed end date given               
         JZ    DATINI08                                                         
         CLC   CFMENDTC,XFFS                                                    
         JNE   *+14                                                             
         MVC   CFMENDTB,XFFS                                                    
         J     DATINI10                                                         
         GOTOR DATCON,DMCB,(2,CFMENDTC),(3,CFMENDTB)                            
         J     DATINI10                                                         
                                                                                
DATINI08 MVC   CFMENDTB,XFFS       Set default end dates                        
         MVC   CFMENDTC,XFFS                                                    
                                                                                
***********************************************************************         
* Initialize for month table building                                 *         
***********************************************************************         
                                                                                
DATINI10 CLI   CFMSUMOP,CFMSUMMQ   Handle monthly period requests               
         JE    *+12                                                             
         CLI   CFMSUMOP,CFMSUMQQ                                                
         JNE   DATINIX                                                          
                                                                                
         OC    CFMSTDTB,CFMSTDTB   Must have a start date                       
         JNZ   *+6                                                              
         DC    H'0'                                                             
         CLC   CFMENDTB,XFFS       and a real end date                          
         JNE   *+6                                                              
         DC    H'0'                                                             
                                                                                
         LA    R2,CFMBTAB          R2=A(Binary date table)                      
         LA    R3,CFMCTAB          R3=A(Compressed date table)                  
         LHI   R4,1                Set to do monthly intervals                  
         CLI   CFMSUMOP,CFMSUMQQ   Test quarters requested                      
         JNE   *+8                                                              
         LHI   R4,3                Set to do quarterly intervals                
         LHI   R0,CFMPMAX          R0=Maximum number of periods                 
         CLI   CFMSYS,MPTRSPRT     Printpak only uses calendar dates            
         JE    *+12                                                             
         CLI   CFMCALOP,CFMCALBQ   Test broadcast months requested              
         JE    DATINI14                                                         
                                                                                
***********************************************************************         
* Build calendar month tables                                         *         
***********************************************************************         
                                                                                
         GOTOR DATCON,DMCB,(3,CFMSTDTB),(0,WORK)                                
         MVC   WORK+4(2),=C'01'                                                 
         GOTOR ADDAY,(R1),WORK,WORK+6,-1                                        
         MVC   WORK(6),WORK+6                                                   
                                                                                
DATINI12 GOTOR ADDAY,DMCB,(C'M',WORK),(X'80',WORK+6),(R4)                       
         MVC   WORK(6),WORK+6                                                   
         MVC   WORK+10(2),=C'01'                                                
         GOTOR DATCON,(R1),WORK+6,(3,(R2))                                      
         GOTOR (RF),(R1),WORK+6,(2,(R3))                                        
         CLC   0(L'CFMENDTB,R2),CFMENDTB                                        
         JH    DATINI20                                                         
         AHI   R2,L'CFMBTAB                                                     
         AHI   R3,L'CFMCTAB                                                     
         JCT   R0,DATINI12                                                      
         J     DATINI20                                                         
                                                                                
***********************************************************************         
* Build broadcast month tables                                        *         
***********************************************************************         
                                                                                
DATINI14 GOTOR DATCON,DMCB,(3,CFMSTDTB),(0,WORK)                                
         GOTOR CFMAGBRD,(R1),(1,WORK),WORK+12,GETDAY,ADDAY                      
         MVC   WORK(6),WORK+12     Get start date of current month              
         GOTOR ADDAY,(R1),WORK,WORK+6,-1                                        
         MVC   WORK(6),WORK+6      WORK=end of previous month                   
                                                                                
DATINI16 LR    R5,R4               R5=month interval                            
DATINI18 GOTOR ADDAY,(R1),WORK,WORK+6,1                                         
         MVC   WORK(6),WORK+6                                                   
         GOTOR CFMAGBRD,(R1),(1,WORK),WORK+12,GETDAY,ADDAY                      
         MVC   WORK(6),WORK+18     End of broadcast month                       
         JCT   R5,DATINI18                                                      
         GOTOR DATCON,DMCB,WORK+12,(3,(R2))                                     
         GOTOR (RF),(R1),WORK+12,(2,(R3))                                       
         CLC   0(L'CFMENDTB,R2),CFMENDTB                                        
         JH    DATINI20                                                         
         AHI   R2,L'CFMENDTB                                                    
         AHI   R3,L'CFMENDTC                                                    
         JCT   R0,DATINI16                                                      
                                                                                
DATINI20 MVI   0(R2),FF            Set end of period tables                     
         MVI   0(R3),FF                                                         
                                                                                
         MVC   CFMBTAB,CFMSTDTB    Start tables with start date                 
         MVC   CFMCTAB,CFMSTDTC                                                 
                                                                                
DATINIX  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Read MFM tree and build client look-up buffer                       *         
***********************************************************************         
                                                                                
ADVINI   NTR1  LABEL=*                                                          
                                                                                
         MVI   CFMLTYPE,CFMLTCLI                                                
         XC    CFMCLIP,CFMCLIP                                                  
         OC    CFMACBA,CFMACBA     Test brand oriented request                  
         JZ    *+14                No                                           
         OC    CFMADVN,CFMADVN     Test advertiser node given                   
         JZ    ADVINI34                                                         
                                                                                
         GOTOR INICLB              Initialize client buffer                     
                                                                                
         LHI   R0,2                                                             
         STCM  R0,15,SAVEPNOD                                                   
         LA    R5,SAVEPNOD                                                      
         LHI   R6,1                                                             
         OC    CFMADVN,CFMADVN     Test advertiser node present                 
         JZ    ADVINI02                                                         
         ICM   R5,7,CFMADVN+1      Yes - point to list                          
         SR    R6,R6                                                            
         ICM   R6,3,LW_NUMN-LW_D(R5)                                            
         AHI   R5,LW_LN2Q          Point to list of advertiser nodes            
                                                                                
ADVINI02 LA    R2,KEY                                                           
         USING CFMRECD,R2          R2=A(Record key)                             
         XC    CFMKEY,CFMKEY       Initialize key for tree reading              
         MVI   CFMKTYPE,CFMKTYPQ                                                
         MVC   CFMKAGY,LP_CUAGY                                                 
         MVC   CFMKPNOD,0(R5)                                                   
         MVI   CFMKSUBR,CFMKSAG1                                                
         MVC   KEYSAVE,CFMKEY                                                   
         GOTOR DMGR,DMCB,DMRDHI,GENDIR,CFMKEY,CFMKEY                            
         CLC   CFMKEY(CFMKSUBR-CFMKEY),KEYSAVE                                  
         JNE   ADVINI32                                                         
                                                                                
         LA    R3,KEYSTACK         Point to start of key stack                  
S        USING CFMKEY,R3                                                        
         MVC   S.CFMKEY,CFMKEY                                                  
         LHI   R4,1                R4=Nesting level                             
                                                                                
ADVINI04 CLI   CFMKSUBR,CFMKSCLT   Test client pointer                          
         JE    ADVINI06            Yes - check correct node                     
         CLI   CFMKSUBR,CFMKSMV1   Test vendor node                             
         JNL   ADVINI26            Yes - percolate                              
         CLI   CFMKSUBR,CFMKSAD1   Test advertizer node                         
         JL    ADVINI24            No - continue tree search                    
                                                                                
         XC    CFMKEY,CFMKEY       Look for client pointer at this node         
         MVC   CFMKEY(CFMKSUBR-CFMKEY),S.CFMKEY                                 
         MVI   CFMKSUBR,CFMKSCLT                                                
         MVC   KEYSAVE,CFMKEY                                                   
         GOTOR DMGR,DMCB,DMRDHI,GENDIR,CFMKEY,CFMKEY                            
         JE    ADVINI06                                                         
         DC    H'0'                                                             
                                                                                
ADVINI06 SR    R0,R0               Initialize client pointer count              
         CLC   CFMKEY(CFMKSUBR-CFMKEY),S.CFMKEY                                 
         JNE   *+12                                                             
         CLI   CFMKSUBR,CFMKSCLT                                                
         JE    ADVINI08                                                         
         GOTOR DMGR,DMCB,DMREAD,GENDIR,S.CFMKEY,CFMKEY                          
         JE    *+6                                                              
         DC    H'0'                                                             
         J     ADVINI24                                                         
                                                                                
ADVINI08 LA    RF,CFMMTAB          Look up media in table                       
         CLI   CFMSYS,MPTRSNET     Test Netpak                                  
         JNE   ADVINI10                                                         
         CLC   CFMKCMED,NETMNODE   Test Netpak client media node                
         JE    ADVINI12                                                         
         J     ADVINI22                                                         
                                                                                
         USING CFMMTD,RF                                                        
ADVINI10 BASR  RE,0                                                             
         CLI   CFMMTD,CFMMTEOT     Test end of media table                      
         JE    ADVINI22            Yes - get next pointer                       
         CLC   CFMMTNOD,CFMKCMED   Find correct media                           
         JE    ADVINI12                                                         
         AHI   RF,CFMMTLNQ                                                      
         BR    RE                                                               
                                                                                
         USING CLIBRECD,CFMTREC1   Build client pointer buffer record           
ADVINI12 XC    CLIBRECD(L'CFMTREC1),CLIBRECD                                    
                                                                                
         CLI   CFMSYS,MPTRSPRT     Test Printpak                                
         JNE   ADVINI14                                                         
         MVC   CLIBPMED,CFMMTMED                                                
         MVC   CLIBPCLI,CFMKCLTE                                                
         MVC   CLIBPNOD,CFMKPNOD                                                
         MVC   SAVEMED,CLIBPMED                                                 
         MVC   SAVECLIE,CLIBPCLI                                                
                                                                                
         LARL  RE,ADVINI20         Call server to validate client               
         NTR1  LABEL=NO                                                         
         GOTOR ,DMCB,SAVEMED,SAVECLIE                                           
         L     RF,CFMAVALC                                                      
         L     RE,SAVERD                                                        
         LM    R2,RC,28(RE)        Restore server's registers 2-C               
         BASR  RE,RF                                                            
         J     EXIT                                                             
                                                                                
ADVINI14 CLI   CFMSYS,MPTRSSPT     Test Spotpak                                 
         JNE   ADVINI16                                                         
         MVC   CLIBSAGM,CFMMTAGM                                                
         MVC   CLIBSCLI,CFMKCLTI                                                
         MVC   CLIBSCLE,CFMKCLTE   External client code                         
         MVC   CLIBSNOD,CFMKPNOD                                                
         MVC   SAVEMED,CLIBSAGM                                                 
         MVC   SAVECLII,CLIBSCLI                                                
         J     ADVINI18                                                         
                                                                                
ADVINI16 MVC   CLIBNAGM,CFMMTAGM   Netpak                                       
         MVC   CLIBNCLI,CFMKCLTI                                                
         MVC   CLIBNCLE,CFMKCLTE   External client code                         
         MVC   CLIBNNOD,CFMKPNOD                                                
         MVC   SAVEMED,CLIBNAGM                                                 
         MVC   SAVECLII,CLIBNCLI                                                
         DROP  RF                                                               
                                                                                
ADVINI18 LARL  RE,ADVINI20         Call server to validate client               
         NTR1  LABEL=NO                                                         
         GOTOR ,DMCB,SAVEMED                                                    
         L     RF,CFMAVALC                                                      
         L     RE,SAVERD                                                        
         LM    R2,RC,28(RE)        Restore server's registers 2-C               
         BASR  RE,RF                                                            
         J     EXIT                                                             
                                                                                
ADVINI20 JNE   ADVINI22            Client code rejected by server               
                                                                                
         GOTOR BUFFER,DMCB,('CLIBUFQ',TSAADD)                                   
         JNE   ADVINI22                                                         
         AHI   R0,1                Bump pointer count                           
                                                                                
ADVINI22 GOTOR DMGR,DMCB,DMRSEQ,GENDIR,CFMKEY,CFMKEY                            
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   CFMKEY(CFMKSUBR-CFMKEY),S.CFMKEY                                 
         JNE   *+12                                                             
         CLI   CFMKSUBR,CFMKSCLT                                                
         JE    ADVINI08                                                         
                                                                                
         GOTOR DMGR,DMCB,DMREAD,GENDIR,S.CFMKEY,CFMKEY                          
         JE    *+6                                                              
         DC    H'0'                                                             
         A     R0,CFMCLIP          Update number of client pointers             
         ST    R0,CFMCLIP                                                       
         J     ADVINI26                                                         
                                                                                
ADVINI24 OC    CFMKRNOD,CFMKRNOD   Test this node has branches                  
         JZ    ADVINI30            No - get next at same node                   
         MVC   CFMKPNOD,CFMKRNOD   Initialize for nested reading                
         XC    CFMKSUBR(L'CFMKEY-(CFMKSUBR-CFMKEY)),CFMKSUBR                    
         MVC   KEYSAVE,CFMKEY                                                   
         GOTOR DMGR,DMCB,DMRDHI,GENDIR,CFMKEY,CFMKEY                            
         CLC   CFMKEY(CFMKSUBR-CFMKEY),KEYSAVE                                  
         JNE   ADVINI28                                                         
                                                                                
         AHI   R3,L'CFMKEY         Bump to next keystack entry                  
         MVC   S.CFMKEY,CFMKEY                                                  
         AHI   R4,1                Bump nesting level                           
         CHI   R4,KEYSTMAX         Test maximum nest level reached              
         JNH   ADVINI04                                                         
         DC    H'0'                Need to make the stack bigger                
                                                                                
ADVINI26 SHI   R4,1                Decrement nesting level                      
         JZ    ADVINI32            All nodes processed when zero                
         SHI   R3,L'CFMKEY         Back up to parent key                        
                                                                                
ADVINI28 MVC   CFMKEY,S.CFMKEY     Re-position to current node                  
         GOTOR DMGR,DMCB,DMREAD,GENDIR,CFMKEY,CFMKEY                            
         JE    ADVINI30                                                         
         DC    H'0'                                                             
                                                                                
ADVINI30 GOTOR DMGR,DMCB,DMRSEQ,GENDIR,CFMKEY,CFMKEY                            
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   CFMKEY(CFMKSUBR-CFMKEY),S.CFMKEY                                 
         JNE   ADVINI26            Up to parent if node is exhausted            
         MVC   S.CFMKEY,CFMKEY                                                  
         J     ADVINI04            Else process this record                     
                                                                                
ADVINI32 AHI   R5,L'CFMKPNOD       Bump to next advertiser node                 
         JCT   R6,ADVINI02         Do for number of nodes                       
                                                                                
ADVINI34 OC    CFMCLIP,CFMCLIP     Test any client pointers found               
         JNZ   EXITY                                                            
         J     EXITN                                                            
         DROP  S                                                                
         EJECT                                                                  
***********************************************************************         
* Read MFM tree and build client/brand look-up buffer                 *         
***********************************************************************         
                                                                                
BRDINI   NTR1  LABEL=*                                                          
                                                                                
         MVI   CFMLTYPE,CFMLTBRD                                                
         OC    CFMACBA,CFMACBA     Test have brands to process                  
         JZ    BRDINI40            Yes - exit                                   
                                                                                
         SR    R0,R0                                                            
         XC    SAVECLIE,SAVECLIE                                                
         XC    SAVLMED,SAVLMED                                                  
                                                                                
         GOTOR INICLB              Initialize client buffer                     
                                                                                
         ICM   R5,7,CFMACBA+1                                                   
         XC    CFMACBA,CFMACBA                                                  
         SR    R6,R6                                                            
         ICM   R6,3,LW_NUMN-LW_D(R5)                                            
         AHI   R5,LW_LN2Q          Point to list of brand nodes                 
         USING BRDTABD,R5                                                       
                                                                                
BRDINI02 LA    R2,KEY                                                           
         USING CFMRECD,R2          R2=A(Record key)                             
         XC    CFMKEY,CFMKEY       Initialize for tree reading                  
         MVI   CFMKTYPE,CFMKTYPQ                                                
         MVC   CFMKAGY,LP_CUAGY                                                 
         MVC   CFMKPNOD,BRDPNOD    Set brand node                               
         MVI   CFMKSUBR,CFMKSBRD                                                
         MVC   KEYSAVE,CFMKEY                                                   
         GOTOR DMGR,DMCB,DMRDHI,GENDIR,CFMKEY,CFMKEY                            
         CLC   CFMKEY(CFMKCODE-CFMKEY),KEYSAVE                                  
         JNE   BRDINI36                                                         
                                                                                
BRDINI06 LA    RF,CFMMTAB          Look up media in table                       
         CLI   CFMSYS,MPTRSNET     Test Netpak                                  
         JNE   BRDINI08                                                         
         CLC   CFMKBMED,NETMNODE   Test Netpak brand media node                 
         JE    BRDINI10                                                         
         J     BRDINI34                                                         
                                                                                
         USING CFMMTD,RF                                                        
BRDINI08 BASR  RE,0                                                             
         CLI   CFMMTD,CFMMTEOT     Test end of media table                      
         JE    BRDINI34            Yes - get next pointer                       
         CLC   CFMMTNOD,CFMKBMED   Find correct media                           
         JE    BRDINI10                                                         
         AHI   RF,CFMMTLNQ                                                      
         BR    RE                                                               
                                                                                
BRDINI10 LA    RE,CFMMTMED         Print media                                  
         CLI   CFMSYS,MPTRSPRT     Test Printpak                                
         JE    *+8                                                              
         LA    RE,CFMMTAGM         Spot/Net agemcy/media                        
         MVC   SAVEMED,0(RE)                                                    
         DROP  RF                                                               
                                                                                
         LA    R1,BRDTABD                                                       
T        USING BRDTABD,R1                                                       
BRDINI12 CLC   T.BRDPNOD,BRDPNOD   Test if the same node                        
         JNE   BRDINI36                                                         
         OC    T.BRDCLTE,T.BRDCLTE Do we have a client code?                    
         JZ    *+14                                                             
         CLC   T.BRDCLTE,CFMKBCLT                                               
         JNE   BRDINI14                                                         
         OC    T.BRDBRDE,T.BRDBRDE                                              
         JZ    BRDINI16                                                         
         CLC   T.BRDBRDE,CFMKBRDE                                               
         JE    BRDINI16                                                         
BRDINI14 AHI   R1,BRDTABL                                                       
         J     BRDINI12                                                         
         DROP  T                                                                
                                                                                
BRDINI16 CLC   SAVLMED,SAVEMED     Same media or agy/med as before?             
         JNE   *+14                No - re-read client record                   
         CLC   SAVECLIE,CFMKBCLT                                                
         JE    BRDINI26                                                         
         GOTOR GETCLI              Read client passives                         
         MVC   SAVLMED,SAVEMED     Save media or agy/med for next time          
                                                                                
         USING CLIBRECD,CFMTREC1   Build client level buffer record             
         XC    CLIBRECD(L'CFMTREC1),CLIBRECD                                    
                                                                                
         CLI   CFMSYS,MPTRSPRT     Test Printpak                                
         JNE   BRDINI18                                                         
         MVC   CLIBPMED,SAVEMED                                                 
         MVC   CLIBPCLI,SAVECLIE                                                
         MVC   CLIBPNOD,SAVECNOD                                                
                                                                                
         LARL  RE,BRDINI24         Call server to validate client               
         NTR1  LABEL=NO                                                         
         GOTOR ,DMCB,SAVEMED,SAVECLIE                                           
         L     RF,CFMAVALC                                                      
         L     RE,SAVERD                                                        
         LM    R2,RC,28(RE)        Restore server's registers 2-C               
         BASR  RE,RF                                                            
         J     EXIT                                                             
                                                                                
BRDINI18 CLI   CFMSYS,MPTRSSPT     Test Spotpak                                 
         JNE   BRDINI20                                                         
         MVC   CLIBSAGM,SAVEMED                                                 
         MVC   CLIBSCLI,SAVECLII   Internal client code from above              
         MVC   CLIBSCLE,SAVECLIE   External client code                         
         MVC   CLIBSNOD,SAVECNOD   Set client node                              
         J     BRDINI22                                                         
                                                                                
BRDINI20 MVC   CLIBNAGM,SAVEMED    Netpak                                       
         MVC   CLIBNCLI,SAVECLII   Internal client code from above              
         MVC   CLIBNCLE,SAVECLIE   External client code                         
         MVC   CLIBNNOD,SAVECNOD   Set client node                              
                                                                                
BRDINI22 LARL  RE,BRDINI24         Call server to validate client               
         NTR1  LABEL=NO                                                         
         GOTOR ,DMCB,SAVEMED                                                    
         L     RF,CFMAVALC                                                      
         L     RE,SAVERD                                                        
         LM    R2,RC,28(RE)        Restore server's registers 2-C               
         BASR  RE,RF                                                            
         J     EXIT                                                             
                                                                                
BRDINI24 JE    *+14                Client code accepted - continue              
         XC    SAVECLIE,SAVECLIE   Client code rejected by server               
         J     BRDINI34            Clear client code and read next              
                                                                                
         GOTOR BUFFER,DMCB,('CLIBUFQ',TSAADD)                                   
         JNE   BRDINI26                                                         
         AHI   R0,1                Bump pointer count                           
                                                                                
BRDINI26 CLI   CFMSYS,MPTRSPRT     Test Printpak                                
         JNE   BRDINI28                                                         
         MVC   CLIBPMED,SAVEMED                                                 
         MVC   CLIBPCLI,SAVECLIE   Client code                                  
         MVC   CLIBPPRC,CFMKBRDE   Product code                                 
         XC    CLIBPNOD,CLIBPNOD                                                
         J     BRDINI32                                                         
                                                                                
BRDINI28 CLI   CFMSYS,MPTRSSPT     Test Spotpak                                 
         JNE   BRDINI30                                                         
         MVC   CLIBSAGM,SAVEMED                                                 
         MVC   CLIBSCLI,SAVECLII   Internal client code                         
         MVC   CLIBSPRN,CFMKBRDI   Product number                               
         MVC   CLIBSPRE,CFMKBRDE   External product code                        
         XC    CLIBSNOD,CLIBSNOD                                                
         J     BRDINI32                                                         
                                                                                
BRDINI30 MVC   CLIBNAGM,SAVEMED    Netpak                                       
         MVC   CLIBNCLI,SAVECLII   Internal client code                         
         MVC   CLIBNPRE,CFMKBRDE   External product code                        
         MVC   CLIBNPRN,CFMKBRDI   Product number                               
         XC    CLIBNNOD,CLIBNNOD                                                
                                                                                
BRDINI32 GOTOR BUFFER,DMCB,('CLIBUFQ',TSAADD)                                   
         JNE   BRDINI34                                                         
         AHI   R0,1                Bump pointer count                           
                                                                                
BRDINI34 GOTOR DMGR,DMCB,DMRSEQ,GENDIR,CFMKEY,CFMKEY                            
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   CFMKEY(CFMKCODE-CFMKEY),KEYSAVE                                  
         JE    BRDINI06                                                         
                                                                                
BRDINI36 ICM   R1,15,BRDPNOD       Get current node                             
BRDINI38 AHI   R5,BRDTABL          Bump to next brand node                      
         CLM   R1,15,BRDPNOD       Test same node as previous                   
         JNE   *+12                                                             
         JCT   R6,BRDINI38         Locate next different node                   
         J     *+8                                                              
         JCT   R6,BRDINI02         Do for number of nodes                       
                                                                                
         LTR   R0,R0               Test any brand pointers found                
         JNZ   EXITY                                                            
                                                                                
BRDINI40 MVI   CFMERR,CFMENBRD     Set no brand pointers found                  
         J     EXITN                                                            
         DROP  R2,R5                                                            
         EJECT                                                                  
***********************************************************************         
* Read client passive and pull client info for brand-centric buffer   *         
***********************************************************************         
                                                                                
         USING CFMRECD,R2          R2=A(Client passive record key)              
GETCLI   NTR1  LABEL=*                                                          
                                                                                
         MVC   SAVEKEY,CFMKEY      Read client passive                          
         LA    RF,SAVEKEY                                                       
         LA    R2,KEY                                                           
         XC    CLTPAS,CLTPAS                                                    
         MVI   CLTPTYPE,CLTPTYPQ                                                
         MVC   CLTPAGY,LP_CUAGY                                                 
         MVC   CLTPMED,CFMKBMED-CFMKEY(RF)                                      
         MVC   CLTPCLT,CFMKBCLT-CFMKEY(RF)                                      
         MVC   KEYSAVE,CFMKEY                                                   
                                                                                
         GOTOR DMGR,DMCB,DMRDHI,GENDIR,CFMKEY,CFMKEY                            
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLC   CFMKEY((CLTPCLT-CLTPAS)+L'CLTPCLT),KEYSAVE                       
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR DMGR,DMCB,GETREC,GENFIL,CFMKDA,IO,WORK                           
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         LA    R2,IO                                                            
         MVC   SAVECLIE,CFMKCLTE   External client code                         
         MVC   SAVECLII,CFMKCLTI   Internal client code                         
         MVC   SAVECNOD,CFMKPNOD   Client node                                  
                                                                                
         LA    R2,KEY                                                           
         MVC   CFMKEY,SAVEKEY      Restore sequence                             
         MVC   KEYSAVE,CFMKEY                                                   
         GOTOR DMGR,DMCB,DMREAD,GENDIR,CFMKEY,CFMKEY                            
         JE    EXITY                                                            
         DC    H'0'                                                             
         EJECT                                                                  
***********************************************************************         
* Read MFM tree and build vendor look-up buffer                       *         
***********************************************************************         
                                                                                
VENINI   NTR1  LABEL=*                                                          
         XC    CFMVENP,CFMVENP                                                  
                                                                                
         LHI   R0,VENSKEYL         R0=L'vendor key                              
         LHI   RF,VENSRECL         RF=L'vendor record                           
         CLI   CFMSYS,MPTRSSPT                                                  
         JE    VENINI02                                                         
         LHI   R0,VENNKEYL                                                      
         LHI   RF,VENNRECL                                                      
         CLI   CFMSYS,MPTRSNET                                                  
         JE    VENINI02                                                         
         LHI   R0,VENPKEYL                                                      
         LHI   RF,VENPRECL                                                      
VENINI02 GOTOR BUFFER,DMCB,('VENBUFQ',TSAINI),((R0),(RF))                       
                                                                                
         OC    CFMVENN,CFMVENN     Exit if no vendor nodes given                
         JZ    EXITY                                                            
         ICM   R6,7,CFMVENN+1      Point to LW_D                                
         SR    R7,R7                                                            
         ICM   R7,3,LW_NUMN-LW_D(R6)                                            
         AHI   R6,LW_LN2Q          Point to list of vendor nodes                
                                                                                
VENINI04 LA    R2,KEY                                                           
         USING CFMRECD,R2          R2=A(Record key)                             
         XC    CFMKEY,CFMKEY       Initialize for tree reading                  
         MVI   CFMKTYPE,CFMKTYPQ                                                
         MVC   CFMKAGY,LP_CUAGY                                                 
         MVC   CFMKPNOD,0(R6)      Move node to key                             
         MVI   CFMKSUBR,CFMKSMV1                                                
         MVC   KEYSAVE,CFMKEY                                                   
         GOTOR DMGR,DMCB,DMRDHI,GENDIR,CFMKEY,CFMKEY                            
         CLC   CFMKEY(CFMKSUBR-CFMKEY),KEYSAVE                                  
         JNE   VENINI34                                                         
                                                                                
         LA    R3,KEYSTACK         Point to start of key stack                  
S        USING CFMKEY,R3                                                        
         MVC   S.CFMKEY,CFMKEY                                                  
         LHI   R4,1                R4=Nesting level                             
                                                                                
VENINI06 CLI   CFMKSUBR,CFMKSMV1   Test vendor node                             
         JL    VENINI26                                                         
                                                                                
         XC    CFMKEY,CFMKEY       Look for vendor pointer at this node         
         MVC   CFMKEY(CFMKSUBR-CFMKEY),S.CFMKEY                                 
         MVI   CFMKSUBR,CFMKSVEN                                                
         MVC   KEYSAVE,CFMKEY                                                   
         GOTOR DMGR,DMCB,DMRDHI,GENDIR,CFMKEY,CFMKEY                            
         JE    *+6                                                              
         DC    H'0'                                                             
         SR    R0,R0               Initialize vendor pointer count              
         CLC   CFMKEY(CFMKCODE-CFMKEY),KEYSAVE                                  
         JE    VENINI08                                                         
         GOTOR DMGR,DMCB,DMREAD,GENDIR,S.CFMKEY,CFMKEY                          
         JE    VENINI26                                                         
         DC    H'0'                                                             
                                                                                
VENINI08 LA    R5,CFMMTAB          Look up media in table                       
         USING CFMMTD,R5                                                        
         BASR  RE,0                                                             
         CLI   CFMMTD,CFMMTEOT     Test end of media table                      
         JE    VENINI24            Yes - get next pointer                       
         CLC   CFMMTNOD,CFMKVMED   Locate correct media                         
         JE    *+10                                                             
         AHI   R5,CFMMTLNQ                                                      
         BR    RE                                                               
                                                                                
         MVC   WORK(L'CFMMTMED),CFMMTMED                                        
                                                                                
         LARL  RE,VENINI10         Call server to validate vendor               
         NTR1  LABEL=NO                                                         
         GOTOR ,DMCB,(CFMMTMED,CFMKCODE),(CFMMTAGM,WORK)                        
         L     RF,CFMAVALV                                                      
         L     RE,SAVERD                                                        
         LM    R2,RC,28(RE)        Restore server's registers 2-C               
         BASR  RE,RF                                                            
         J     EXIT                                                             
VENINI10 JNE   VENINI24            Vendor code rejected by server               
                                                                                
         CLI   CFMSYS,MPTRSSPT                                                  
         JNE   VENINI12                                                         
         USING VENSRECD,CFMTREC2   Build Spotpak vendor buffer record           
         MVC   VENSAGM,CFMMTAGM                                                 
         MVC   VENSCALL,CFMKSSTA                                                
         XC    VENSCLI,VENSCLI                                                  
         MVC   VENSMKT,WORK                                                     
         MVC   VENSSTA,WORK+L'VENSMKT                                           
         MVC   VENSNODE,CFMKPNOD                                                
         J     VENINI16                                                         
                                                                                
VENINI12 CLI   CFMSYS,MPTRSNET                                                  
         JNE   VENINI14                                                         
         USING VENNRECD,CFMTREC2   Build Netpak vendor buffer record            
         MVC   VENNNET,WORK                                                     
         MVC   VENNNODE,CFMKPNOD                                                
         J     VENINI16                                                         
                                                                                
         USING VENPRECD,CFMTREC2   Build Printpak vendor buffer record          
VENINI14 MVC   VENPMED,CFMMTMED                                                 
         MVC   VENPPUB,WORK                                                     
         MVC   VENPNODE,CFMKPNOD                                                
         MVI   VENPSTAT,0                                                       
                                                                                
VENINI16 GOTOR BUFFER,DMCB,('VENBUFQ',TSAADD)                                   
         TM    BUFFRET,TSEDUP      Ignore duplicate keys                        
         JNZ   VENINI18                                                         
         CLI   BUFFRET,0           Test other errors                            
         JE    *+6                                                              
         DC    H'0'                                                             
         AHI   R0,1                Bump pointer count                           
                                                                                
VENINI18 CLI   CFMSYS,MPTRSSPT     Test Spotpak                                 
         JNE   VENINI24                                                         
         USING STARECD,IO          Yes - read client exception records          
         XC    STAKEY,STAKEY                                                    
         MVI   STAKTYPE,STAKTYPQ                                                
         MVC   STAKMED,CFMMTMED                                                 
         MVC   STAKCALL,VENSCALL                                                
         MVC   STAKAGY,LP_AGY                                                   
         MVC   WORK(STAKCLT-STAKEY),STAKEY                                      
         GOTOR DMGR,DMCB,DMRDHI,STAFIL,STARECD,STARECD                          
         JE    VENINI22                                                         
         DC    H'0'                                                             
                                                                                
VENINI20 GOTOR DMGR,DMCB,DMRSEQ,STAFIL,STARECD,STARECD                          
         JE    VENINI22                                                         
         DC    H'0'                                                             
                                                                                
VENINI22 CLC   STAKEY(STAKCLT-STAKEY),WORK                                      
         JNE   VENINI24                                                         
         CLC   STAKCLT,EZEROS      Test default record                          
         JE    VENINI20                                                         
         MVC   VENSCLI,STAKCLT     No - set client code                         
         PACK  DUB,SMKT                                                         
         CVB   RF,DUB                                                           
         STCM  RF,3,VENSMKT        and override market number                   
         GOTOR BUFFER,DMCB,('VENBUFQ',TSAADD)                                   
         JE    VENINI20                                                         
         TM    BUFFRET,TSEDUP      Ignore duplicate keys                        
         JNZ   VENINI20                                                         
         DC    H'0'                                                             
                                                                                
VENINI24 GOTOR DMGR,DMCB,DMRSEQ,GENDIR,CFMKEY,CFMKEY                            
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   CFMKEY(CFMKCODE-CFMKEY),KEYSAVE                                  
         JE    VENINI08                                                         
                                                                                
         A     R0,CFMVENP          Update number of vendor pointers             
         ST    R0,CFMVENP                                                       
         GOTOR DMGR,DMCB,DMREAD,GENDIR,S.CFMKEY,CFMKEY                          
         JE    VENINI28                                                         
         DC    H'0'                                                             
                                                                                
VENINI26 OC    CFMKRNOD,CFMKRNOD   Test this node has branches                  
         JZ    VENINI32            No - get next at same node                   
         MVC   CFMKPNOD,CFMKRNOD   Initialize for nested reading                
         XC    CFMKSUBR(L'CFMKEY-(CFMKSUBR-CFMKEY)),CFMKSUBR                    
         MVC   KEYSAVE,CFMKEY                                                   
         GOTOR DMGR,DMCB,DMRDHI,GENDIR,CFMKEY,CFMKEY                            
         CLC   CFMKEY(CFMKSUBR-CFMKEY),KEYSAVE                                  
         JNE   VENINI30                                                         
                                                                                
         AHI   R3,L'CFMKEY         Bump to next key stack entry                 
         MVC   S.CFMKEY,CFMKEY                                                  
         AHI   R4,1                Bump nesting level                           
         CHI   R4,KEYSTMAX         Test maximum nest level reached              
         JNH   VENINI06                                                         
         DC    H'0'                Need to make the stack bigger                
                                                                                
VENINI28 SHI   R4,1                Decrement nesting level                      
         JZ    VENINI34            All nodes processed when zero                
         SHI   R3,L'CFMKEY         Back up to parent key                        
                                                                                
VENINI30 MVC   CFMKEY,S.CFMKEY     Re-position to current node                  
         GOTOR DMGR,DMCB,DMREAD,GENDIR,CFMKEY,CFMKEY                            
         JE    VENINI32                                                         
         DC    H'0'                                                             
                                                                                
VENINI32 GOTOR DMGR,DMCB,DMRSEQ,GENDIR,CFMKEY,CFMKEY                            
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   CFMKEY(CFMKSUBR-CFMKEY),S.CFMKEY                                 
         JNE   VENINI28            Up to parent if node is exhausted            
         MVC   S.CFMKEY,CFMKEY                                                  
         J     VENINI06            Else process this record                     
                                                                                
VENINI34 AHI   R6,L'CFMKPNOD       Bump to next node                            
         JCT   R7,VENINI04         Do for number of nodes                       
                                                                                
         OC    CFMVENP,CFMVENP     Test any vendors found                       
         JNZ   EXITY                                                            
         MVI   CFMERR,CFMENVEN     No - exit with error                         
         J     EXITN                                                            
         DROP  R2,R5,S                                                          
         EJECT                                                                  
***********************************************************************         
* Read Spotpak buys                                                   *         
***********************************************************************         
                                                                                
SPT      TM    CFMINDS,CFMIBUF     Test sending buffer records                  
         JNZ   SPT290                                                           
                                                                                
SPT010   XC    CLIBRECD(L'CFMTREC1),CLIBRECD                                    
         MVC   CLIBSAGM,CFMLMEDC                                                
         SR    R0,R0               Get next client buffer record                
         ICM   R0,3,CFMLCLIC                                                    
         AHI   R0,1                                                             
         STCM  R0,3,CLIBSCLI                                                    
                                                                                
         XC    SAVECLII,SAVECLII   Clear saved area for compares                
         XC    SAVEMED,SAVEMED     Clear saved area for media                   
         XC    NUMPRD,NUMPRD                                                    
         ICM   RE,15,CFMAPRD                                                    
         JNZ   *+20                                                             
         L     RE,LP_AWMP                                                       
         STCM  RE,15,CFMAPRD                                                    
         LA    RF,255+LW_LN2Q(RE)                                               
         ST    RF,LP_AWMP                                                       
                                                                                
         USING LW_D,RE                                                          
         STCM  RE,7,APRD           Point to WMP                                 
         MVI   LW_TYPE,LW_TSINQ                                                 
         MVI   LW_DATA1,FF                                                      
         LA    R3,LW_DATA2         Point to data field                          
         MVI   BUYFLD,0            Default is reading active buys               
         DROP  RE                                                               
                                                                                
         GOTOR BUFFER,DMCB,('CLIBUFQ',TSARDH)                                   
         J     SPT030                                                           
                                                                                
SPT020   GOTOR BUFFER,DMCB,('CLIBUFQ',TSANXT)                                   
                                                                                
SPT030   TM    BUFFRET,TSEEOF      Test end of client buffer                    
         JZ    SPT040                                                           
         OC    NUMPRD,NUMPRD       Any products found?                          
         JZ    ALLNXT                                                           
         J     SPT060                                                           
                                                                                
SPT040   CLI   CFMLTYPE,CFMLTCLI   Is this a brand request?                     
         JNE   SPT050              No - skip all this stuff                     
         MVC   SAVECLII,CLIBSCLI                                                
         MVC   SAVECLIE,CLIBSCLE                                                
         MVC   SAVEMED,CLIBSAGM                                                 
         MVC   SAVECNOD,CLIBSNOD                                                
         J     SPT080                                                           
                                                                                
SPT050   OC    SAVEMED,SAVEMED     Do we have a prev media or agy/med?          
         JZ    *+14                                                             
         CLC   SAVEMED,CLIBSAGM                                                 
         JNE   SPT060                                                           
         MVC   SAVEMED,CLIBSAGM                                                 
         OC    SAVECLII,SAVECLII   Do we have a previous client code?           
         JZ    *+14                                                             
         CLC   SAVECLII,CLIBSCLI                                                
         JNE   SPT060                                                           
         MVC   SAVECLII,CLIBSCLI   Save for next time                           
         OC    CLIBSPRN,CLIBSPRN   Do we have a brand?                          
         JNZ   SPT052                                                           
         MVC   SAVECLIE,CLIBSCLE                                                
         MVC   SAVECNOD,CLIBSNOD                                                
         J     SPT020                                                           
                                                                                
SPT052   MVC   0(L'CLIBSPRN,R3),CLIBSPRN                                        
         AHI   R3,L'CLIBSPRN                                                    
                                                                                
         LH    R1,NUMPRD                                                        
         AHI   R1,1                                                             
         STH   R1,NUMPRD                                                        
         J     SPT020                                                           
                                                                                
SPT060   OC    NUMPRD,NUMPRD                                                    
         JZ    SPT070                                                           
         ICM   RE,7,APRD                                                        
         USING LW_D,RE                                                          
         MVI   LW_TYPE,LW_TLSTQ                                                 
         MVC   LW_NUMN,NUMPRD                                                   
         MVI   BUYFLD,FF           Set to read buy passives                     
         J     SPT080                                                           
         DROP  RE                                                               
                                                                                
SPT070   CLI   CFMLTYPE,CFMLTBRD   Test brand-centric request                   
         JE    SPT020              Yes - have to be brands then                 
                                                                                
SPT080   MVC   CFMLMEDC,SAVEMED    Set media/client in CFMIOD                   
         MVC   CFMLCLIC(L'SAVECLII),SAVECLII                                    
         MVC   CFMLCLIE,SAVECLIE                                                
         MVC   CFMLCNOD,SAVECNOD                                                
                                                                                
         LARL  RF,RANGE51F         Build station driver extension               
         LA    R1,CFMMTAB                                                       
         USING CFMMTD,R1                                                        
         BASR  RE,0                                                             
         CLI   CFMMTMED,0                                                       
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLC   CFMMTAGM,CFMLMEDC                                                
         JE    *+10                                                             
         AHI   R1,CFMMTLNQ                                                      
         BR    RE                                                               
         CLI   CFMMTMED,NETMEDQ    Test Canadian network media                  
         JNE   *+10                                                             
         LARL  RF,RANGE5NW                                                      
         DROP  R1                                                               
                                                                                
         LHI   RE,LL_IRNGQ                                                      
         OC    CFMVENN,CFMVENN     Test vendor node given                       
         JZ    SPT140              No - process all markets/stations            
                                                                                
         XC    VENSKEY(VENSKEYL),VENSKEY                                        
         MVC   VENSAGM,CFMLMEDC                                                 
         GOTOR BUFFER,DMCB,('VENBUFQ',TSARDH)                                   
         TM    BUFFRET,TSEEOF                                                   
         JNZ   NOMORE                                                           
         CLC   VENSAGM,CFMLMEDC    Test correct media                           
         JE    SPT090                                                           
         MVC   CFMLMEDC,VENSAGM    No - get first client for this media         
         XC    CFMLCLIC,CFMLCLIC                                                
         J     SPT010                                                           
                                                                                
***********************************************************************         
* Build station/market look-up buffer                                 *         
***********************************************************************         
                                                                                
SPT090   GOTOR BUFFER,DMCB,('SUPBUFQ',TSAINI),(L'BUYKMSTA,L'BUYKMSTA)           
         J     SPT120                                                           
                                                                                
SPT100   CLC   VENSCALL,WORK       Test change of station                       
         JNE   SPT110                                                           
         CLC   VENSCLI,CFMLCLIE    Yes - must be client exception               
         JNE   SPT130                                                           
         MVC   CFMLVEND(L'VENSMKT),VENSMKT                                      
         J     SPT130                                                           
                                                                                
SPT110   GOTOR BUFFER,DMCB,('SUPBUFQ',TSAADD)                                   
         JE    SPT120                                                           
         DC    H'0'                                                             
                                                                                
SPT120   MVC   CFMLVEND(L'VENSMKT),VENSMKT                                      
         MVC   CFMLVEND+L'VENSMKT(L'VENSSTA),VENSSTA                            
         MVC   WORK(L'VENSCALL),VENSCALL                                        
                                                                                
SPT130   GOTOR BUFFER,DMCB,('VENBUFQ',TSANXT)                                   
         JNE   *+14                                                             
         CLC   VENSAGM,CFMLMEDC    Test correct media                           
         JE    SPT100                                                           
         OC    CFMLVEND,CFMLVEND                                                
         JZ    SPT010                                                           
         GOTOR BUFFER,DMCB,('SUPBUFQ',TSAADD)                                   
         JE    *+6                                                              
         DC    H'0'                                                             
         LHI   RE,LL_ITSAR                                                      
         L     RF,ATSARD                                                        
                                                                                
SPT140   STCM  RE,1,LLBIND+0       Set driver type                              
         STCM  RF,7,LLBIND+1       Set A(extension control block)               
         MVC   CFMLSTAC,LLBIND     Set driver extension in CFMIOD               
                                                                                
SPT150   LARL  RE,SPT160           Call server to get client                    
         NTR1  LABEL=NO                                                         
         GOTOR ,DMCB,SAVEMED                                                    
         L     RF,CFMAVALC                                                      
         L     RE,SAVERD                                                        
         LM    R2,RC,28(RE)        Restore server's registers 2-C               
         BASR  RE,RF                                                            
         J     EXIT                                                             
                                                                                
SPT160   JE    *+6                 Client code rejected by server?              
         DC    H'0'                Cannot be so                                 
                                                                                
         MVC   MED,CFMLMEDC        Set media/client in WORKD                    
         MVC   CLI,CFMLCLIC                                                     
                                                                                
         GOTOR BLDEST              Get first/next estimate record               
         JZ    SPT010              No estimates - get next client               
                                                                                
         MVI   CFMRMODE,0          Set first time for buy read routine          
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSAINI),('SPTRKEYL',SPTRRECL)             
                                                                                
SPT190   GOTOR NXTSBY              Get first/next buy record                    
         JNE   SPT280                                                           
                                                                                
         USING BUYREC,IO           R2=A(Buy record)                             
         CLC   CFMENDTB,BDSTART    Apply date filters to buy                    
         JL    SPT190                                                           
         CLC   CFMSTDTB,BDEND                                                   
         JH    SPT190                                                           
                                                                                
         L     R3,CFMAIO                                                        
         USING SPTRECD,R3                                                       
         MVI   SPTRECD,SPTREOAQ    Set end of spot array                        
                                                                                
         LA    R3,SPTWORK          R3=A(Spot work area)                         
         XC    SPTRECD(SPTRRECL),SPTRECD                                        
                                                                                
         LA    R1,CFMMTAB                                                       
         USING CFMMTD,R1                                                        
         BASR  RE,0                                                             
         CLI   CFMMTMED,0                                                       
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLC   CFMMTAGM,BUYKAM                                                  
         JE    *+10                                                             
         AHI   R1,CFMMTLNQ                                                      
         BR    RE                                                               
         MVC   SPTMEDCD,CFMMTMED   Set key values                               
         DROP  R1                                                               
         MVC   SPTCLICD,CFMLCLIE                                                
         MVC   SPTMKSTA,BUYKMSTA                                                
         MVC   SPTCNODE,CFMLCNOD                                                
                                                                                
         CLI   CFMESTOP,CFMESTYQ   Test estimate requested                      
         JNE   *+10                                                             
         MVC   SPTESTNO,BUYKEST    Estimate number                              
         CLI   CFMSPLOP,CFMSPLNQ   Test no split option set                     
         JE    *+10                                                             
         MVC   SPTSPROT,BDDAY      Set day if split option set                  
         CLI   CFMPNTOP,CFMPNTYQ   Test program data requested                  
         JNE   SPT200                                                           
         MVC   SPTPRGNM,BDPROGRM   Set optional program values                  
         MVC   SPTPRGTM,BDTIMST                                                 
                                                                                
SPT200   LA    R4,BDELEM                                                        
         USING REGELEM,R4                                                       
SPT210   CLI   RCODE,0             Test end of record                           
         JE    SPT240                                                           
         CLI   RCODE,RCORGQ        Test spot elements                           
         JL    SPT230                                                           
         CLI   RCODE,RCPOTOQ                                                    
         JH    SPT230                                                           
         CLC   RDATE,CFMSTDTC      Test spot within request period              
         JL    SPT230                                                           
         CLC   RDATE,CFMENDTC                                                   
         JH    SPT230                                                           
         TM    RSTATUS,RSMINUSQ+RSHIATSQ+RSMINSDQ                               
         JNZ   SPT230                                                           
                                                                                
         CLC   VENSAGM,BUYKAM      Test change of media/station                 
         JNE   *+14                                                             
         CLC   VENSSTA,BUYKSTAC                                                 
         JE    SPT220                                                           
         MVC   VENSAGM,BUYKAM      Yes - read vendor buffer record              
         MVC   VENSSTA,BUYKSTAC                                                 
         XC    VENSCLI,VENSCLI                                                  
         GOTOR BUFFER,DMCB,('VENBUFQ',TSARDH)                                   
         JE    SPT220                                                           
         MVC   VENSAGM,BUYKAM      Build dummy entry if not found               
         MVC   VENSSTA,BUYKSTAC                                                 
         XC    VENSNODE,VENSNODE                                                
                                                                                
SPT220   MVC   SPTVNODE,VENSNODE   Set vendor node                              
                                                                                
         XC    SPTVALS(SPTVALL),SPTVALS                                         
         MVC   SPTPRDCD,BDMASPRD                                                
         CLI   BDMASPRD,0                                                       
         JNE   *+10                                                             
         MVC   SPTPRDCD,CFMRKEY+(BUYKPRD-BUYKEY)                                
         MVI   BYTE,0                                                           
         CLI   RLEN,RLPOL1LQ       Test allocated                               
         JL    *+16                                                             
         MVC   SPTPRDCD,RPPRD      Yes - set product code                       
         MVC   BYTE,RPTIME                                                      
         GOTOR SPTPST,REGELEM                                                   
         CLI   RLEN,RLPOL2LQ       Test piggyback allocation                    
         JL    SPT230                                                           
         MVC   SPTPRDCD,RPALLOC2+(RPPRD-RPALLOC)                                
         MVC   BYTE,RPALLOC2+(RPTIME-RPALLOC)                                   
         GOTOR SPTPST,REGELEM                                                   
                                                                                
SPT230   LLC   R0,RLEN             Bump to next buy record element              
         AR    R4,R0                                                            
         J     SPT210                                                           
                                                                                
SPT240   OI    NETFLAG,1           Set not first network buy                    
         L     R3,CFMAIO           Point to start of array                      
         CLI   SPTRECD,SPTREOAQ    Test anything in this buy record             
         JE    SPT190              No - get next                                
                                                                                
BUFF     USING SPTRECD,MVDATA                                                   
SPT250   MVC   BUFF.SPTRKEY(SPTRKEYL),SPTRKEY                                   
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSARDH),BUFF.SPTRECD                      
         JNE   SPT260                                                           
         CLI   BUFFRET,0                                                        
         JE    *+6                                                              
         DC    H'0'                                                             
         ICM   R0,15,BUFF.SPTSPOTS Update existing buffer record                
         ICM   R1,15,SPTSPOTS                                                   
         AR    R0,R1                                                            
         STCM  R0,15,BUFF.SPTSPOTS                                              
         ICM   R0,15,BUFF.SPTZSPTS                                              
         ICM   R1,15,SPTZSPTS                                                   
         AR    R0,R1                                                            
         STCM  R0,15,BUFF.SPTZSPTS                                              
         AP    BUFF.SPTGCOST,SPTGCOST                                           
         AP    BUFF.SPTNCOST,SPTNCOST                                           
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSAPUT),BUFF.SPTRECD                      
         J     SPT270                                                           
                                                                                
SPT260   MVC   BUFF.SPTRECD(SPTRRECL),SPTRECD                                   
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSAADD),BUFF.SPTRECD                      
         JE    SPT270                                                           
         DC    H'0'                                                             
         DROP  BUFF                                                             
                                                                                
SPT270   AHI   R3,SPTRRECL         Bump to next array entry                     
         CLI   SPTRECD,SPTREOAQ    Test end of array                            
         JNE   SPT250              No - post next to buffer                     
         J     SPT190              Yes - get next buy record                    
                                                                                
SPT280   L     R1,CFMAIO                                                        
         XC    0(L'SPTMEDCD+L'SPTCLICD,R1),0(R1)                                
         LA    R3,MVDATA           Point to TSAR record                         
         XC    SPTRKEY(SPTRKEYL),SPTRKEY                                        
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSARDH),SPTRECD                           
         TM    BUFFRET,TSEEOF                                                   
         JNZ   SPT010                                                           
         J     SPT300                                                           
                                                                                
SPT290   NI    CFMINDS,FF-(CFMIBUF)                                             
         LA    R3,MVDATA           Point to TSAR record                         
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSANXT),SPTRECD                           
         JNE   SPT010              Get next client                              
                                                                                
SPT300   L     R4,LP_ADATA         Return summary record to server              
         USING SPSTATD,R4                                                       
         XC    SPSTATD(SPVALUEL),SPSTATD                                        
                                                                                
         MVC   SPMEDCDE,SPTMEDCD   Media code                                   
         MVC   SPCLTCDE,SPTCLICD   Client code                                  
         MVC   SPCLTNDE,SPTCNODE   Client node                                  
         MVC   SPMKTSTA,SPTMKSTA   Market/Station                               
                                                                                
         MVC   SPVENNDE,SPTVNODE   Vendor node                                  
         MVC   SPPRDCDE,SPTPRDCD   Product code                                 
         MVC   SPDATPER,SPTDTPSD   Date/period start date                       
                                                                                
         MVC   SPWKYROT,SPTSPROT   Rotation                                     
         MVC   SPSPTLEN,SPTSSLEN   Spot length                                  
         MVC   SPPRGNAM,SPTPRGNM   Program name                                 
         MVC   SPPRGTIM,SPTPRGTM   Program time                                 
         MVC   SPESTNUM,SPTESTNO   Estimate number                              
                                                                                
         MVC   SPSPTNUM,SPTSPOTS   Number of ono-zero spots                     
         MVC   SPZSPOTS,SPTZSPTS   Number of zero spots                         
         ZAP   SPGROSS,SPTGCOST    Gross cost                                   
         ZAP   SPNET,SPTNCOST      Net cost                                     
                                                                                
         CLI   CFMEDTOP,CFMEDTYQ   Test estimate names required                 
         JNE   SPT310                                                           
         OC    SPTESTNO,SPTESTNO   Test we have an estimate number              
         JZ    SPT310                                                           
                                                                                
         L     R1,CFMAIO           Can use I/O area for estimate table          
         CLC   SPTMEDCD,0(R1)      Test same media/client as previous           
         JNE   *+14                                                             
         CLC   SPTCLICD,L'SPTMEDCD(R1)                                          
         JE    *+10                                                             
         XC    L'SPTMEDCD+L'SPTCLICD(256,R1),L'SPTMEDCD+L'SPTCLICD(R1)          
         MVC   0(L'SPTMEDCD,R1),SPTMEDCD                                        
         MVC   L'SPTMEDCD(L'SPTCLICD,R1),SPTCLICD                               
         AHI   R1,L'SPTMEDCD+L'SPTCLICD                                         
         LLC   R0,SPTESTNO                                                      
         AR    R1,R0                                                            
         CLI   0(R1),0             Test estimate name sent                      
         JNE   SPT310                                                           
         MVI   0(R1),1             Set estimate name sent                       
                                                                                
E        USING EKEY,CFMRKEY        Read estimate record                         
         XC    E.EKEY,E.EKEY                                                    
         MVC   E.EKEYAM,CFMLMEDC                                                
         MVC   E.EKEYCLT,CFMLCLIC                                               
         MVC   E.EKEYPRD,=C'POL'   for product POL                              
         MVC   E.EKEYEST,SPTESTNO                                               
         GOTOR DMGR,DMCB,DMREAD,SPTDIR,E.EKEY,E.EKEY                            
         JNE   SPT310                                                           
         GOTOR DMGR,DMCB,GETREC,SPTFIL,E.EKDA,IO,WORK                           
         JNE   SPT310                                                           
E        USING EKEY,IO                                                          
         MVC   SPEDESC,E.EDESC                                                  
         DROP  E                                                                
                                                                                
SPT310   LARL  R0,SPTOPTT                                                       
         GOTOR OPTMIZ,DMCB,SPSTATD,(R0)                                         
                                                                                
         OI    CFMINDS,CFMIBUF     Set in array/buffer mode                     
         J     EXITY               Yes - we are running in buffer mode          
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Call GETRATE to establish values for spot element and add/update    *         
* spot array entry                                                    *         
*                                                                     *         
* Ntry:- R1=A(Spot element)                                           *         
*        SPTRECD contains partly formed spot buffer record            *         
***********************************************************************         
                                                                                
SPTPST   NTR1  LABEL=NO                                                         
         LR    R4,R1               R4=A(Spot element)                           
         USING REGELEM,R4                                                       
                                                                                
         CLI   BUYFLD,FF                                                        
         JNE   *+14                                                             
         CLC   SPTPRDCD,PRD        Test correct product for posting             
         JNE   SPTPSTX                                                          
                                                                                
         ICM   R0,3,BUYKMKT        Fudge market number for Canada net           
         JNZ   *+8                                                              
         MVI   BUYKMKT+L'BUYKMKT-1,1                                            
         GOTOR CFMAGRAT,DMCB,(SPTPRDCD,SPTVALS),(BYTE,BUYREC),REGELEM,0         
         STCM  R0,3,BUYKMKT                                                     
         CLI   CFMRMODE,2          Test network buy                             
         JNE   SPTPST12                                                         
         TM    NETFLAG,1           Test first network buy                       
         JZ    SPTPST12                                                         
         XC    SPTVSPT,SPTVSPT     No - clear spot count                        
SPTPST12 MVI   COSTFLAG,0                                                       
         ICM   R0,15,SPTVGRS       Convert gross/net to packed                  
         CVD   R0,DUB                                                           
         ZAP   SPTGCOST,DUB                                                     
         JNZ   *+8                                                              
         OI    COSTFLAG,COSTFZGQ   Set gross is zero                            
         ICM   R0,15,SPTVNET                                                    
         CVD   R0,DUB                                                           
         ZAP   SPTNCOST,DUB                                                     
         JNZ   *+8                                                              
         OI    COSTFLAG,COSTFZNQ   Set net is zero                              
         XC    SPTSPOTS(L'SPTSPOTS+L'SPTZSPTS),SPTSPOTS                         
         LA    RF,SPTSPOTS                                                      
         TM    COSTFLAG,COSTFZEQ   Test net and gross are zero                  
         JNO   *+8                                                              
         LA    RF,SPTZSPTS                                                      
         MVC   0(L'SPTVSPT,RF),SPTVSPT                                          
         GOTOR GETCPD,RDATE        Set summary posting period                   
         MVC   SPTDTPSD,WORK                                                    
         L     RF,CFMAIO                                                        
SPTA     USING SPTRECD,RF          RF=A(output array)                           
         CLI   CFMSPLOP,CFMSPLNQ   Test no split option set                     
         JE    SPTPST14                                                         
         MVC   SPTSSLEN,BDSEC      Set seconds if split option set              
         CLI   BYTE,0              Test piggyback                               
         JE    SPTPST14                                                         
         MVC   SPTSSLEN,BYTE       Yes - use split length                       
                                                                                
SPTPST14 CLI   SPTA.SPTRECD,SPTREOAQ                                            
         JE    SPTPST20                                                         
         CLC   SPTA.SPTDTPSD,SPTDTPSD                                           
         JNE   SPTPST16                                                         
         CLC   SPTA.SPTSSLEN,SPTSSLEN                                           
         JNE   SPTPST16                                                         
         CLC   SPTA.SPTPRDCD,SPTPRDCD                                           
         JE    SPTPST18                                                         
                                                                                
SPTPST16 AHI   RF,SPTRRECL         Bump to next array entry                     
         J     SPTPST14                                                         
                                                                                
SPTPST18 ICM   R0,15,SPTSPOTS                                                   
         ICM   R1,15,SPTA.SPTSPOTS                                              
         AR    R0,R1                                                            
         STCM  R0,15,SPTA.SPTSPOTS                                              
         ICM   R0,15,SPTZSPTS                                                   
         ICM   R1,15,SPTA.SPTZSPTS                                              
         AR    R0,R1                                                            
         STCM  R0,15,SPTA.SPTZSPTS                                              
         AP    SPTA.SPTGCOST,SPTGCOST                                           
         AP    SPTA.SPTNCOST,SPTNCOST                                           
         J     SPTPSTX                                                          
                                                                                
SPTPST20 MVC   SPTA.SPTRECD(SPTRRECL),SPTRECD                                   
         MVI   SPTA.SPTRECD+SPTRRECL,SPTREOAQ                                   
                                                                                
SPTPSTX  J     EXIT                                                             
         DROP  R3,R4,SPTA                                                       
         EJECT                                                                  
         DS    0H                                                               
SPTOPTT  DS    0XL2                ** Spotpak optimization table **             
         DC    AL1(SPMEDCDE-SPVALUES,L'SPMEDCDE-1)                              
         DC    AL1(SPCLTCDE-SPVALUES,L'SPCLTCDE-1)                              
         DC    AL1(SPCLTNDE-SPVALUES,L'SPCLTNDE-1)                              
         DC    AL1(SPPRDCDE-SPVALUES,L'SPPRDCDE-1)                              
         DC    AL1(SPPRDNDE-SPVALUES,L'SPPRDNDE-1)                              
         DC    AL1(SPMKTSTA-SPVALUES,L'SPMKTSTA-1)                              
         DC    AL1(SPVENNDE-SPVALUES,L'SPVENNDE-1)                              
         DC    AL1(SPDATPER-SPVALUES,L'SPDATPER-1)                              
         DC    AL1(SPWKYROT-SPVALUES,L'SPWKYROT-1)                              
         DC    AL1(SPSPTLEN-SPVALUES,L'SPSPTLEN-1)                              
         DC    AL1(SPPRGNAM-SPVALUES,L'SPPRGNAM-1)                              
         DC    AL1(SPPRGTIM-SPVALUES,L'SPPRGTIM-1)                              
         DC    AL1(SPESTNUM-SPVALUES,L'SPESTNUM-1)                              
SPTOPTTX DC    AL1(FF,FF)                                                       
                                                                                
SPTRECD  DSECT                     ** Spotpak summary records **                
SPTREOAQ EQU   FF                  End of array indicator                       
                                                                                
SPTRKEY  DS    0X                  ** Buffer key **                             
                                                                                
SPTMEDCD DS    CL(L'SPMEDCDE)      Media code                                   
SPTCLICD DS    CL(L'SPCLTCDE)      Client code                                  
SPTPRDCD DS    XL(L'SPPRDCDE)      Product code                                 
SPTMKSTA DS    XL(L'SPMKTSTA)      Market/station                               
SPTDTPSD DS    XL(L'SPDATPER)      Date/period start date                       
                                                                                
SPTSPROT DS    XL(L'SPWKYROT)      Rotation                                     
SPTSSLEN DS    XL(L'SPSPTLEN)      Spot length                                  
SPTPRGNM DS    CL(L'SPPRGNAM)      Program name                                 
SPTPRGTM DS    XL(L'SPPRGTIM)      Program time                                 
SPTESTNO DS    XL(L'SPESTNUM)      Estimate number                              
                                                                                
SPTRKEYL EQU   *-SPTRKEY           Key length                                   
                                                                                
SPTCNODE DS    XL(L'CFMKPNOD)      Client node                                  
SPTVNODE DS    XL(L'CFMKPNOD)      Vendor node                                  
                                                                                
SPTSPOTS DS    XL(L'SPSPTNUM)      Number of non-zero spots                     
SPTZSPTS DS    XL(L'SPSPTNUM)      Number of zero spots                         
SPTGCOST DS    PL(L'SPGROSS)       Gross cost                                   
SPTNCOST DS    PL(L'SPNET)         Net cost                                     
SPTRRECL EQU   *-SPTRKEY                                                        
CFMIO    CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Get next Spotpak buy record                                         *         
***********************************************************************         
                                                                                
         USING BUYREC,IO                                                        
NXTSBY   NTR1  LABEL=*                                                          
         CLI   CFMRMODE,2          Test network reading mode                    
         JE    NXTSBY10                                                         
         CLI   CFMRMODE,0          Test first time call                         
         JNE   NXTSBY02                                                         
         MVI   CFMRMODE,1          Reset first time call                        
         XC    CFMRKEY,CFMRKEY                                                  
                                                                                
NXTSBY02 GOTOR LP_ASETK,DMCB,(0,SPTBUYT),CFMRKEY,WORKD,('FF',LP_D)              
         JH    EXIT                                                             
         GOTOR DMGR,DMCB,DMRDHI,SPTDIR,CFMRKEY,CFMRKEY                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR LP_ASETK,DMCB,(1,SPTBUYT),CFMRKEY,WORKD,('FF',LP_D)              
         JNE   NXTSBY02                                                         
         MVC   PRD,CFMRKEY+(BUYKPRD-BUYKEY)                                     
         MVC   DA,CFMRKEY+(BUYKDA-BUYKEY)                                       
         GOTOR DMGR,DMCB,GETREC,SPTFIL,DA,BUYREC,WORK                           
         JE    NXTSBY04                                                         
         TM    8(R1),IOEDEL        Test deleted record                          
         JNZ   NXTSBY02                                                         
         DC    H'0'                Die on errors                                
                                                                                
NXTSBY04 TM    BDCIND2,BDCCANAQ    Test Canadian buy                            
         JZ    EXITY                                                            
         OC    BUYKMKT,BUYKMKT     Test network buy record                      
         JNZ   EXITY                                                            
                                                                                
         LAY   RE,NETLST           Build market/station list                    
         LA    R1,BDELEM                                                        
         USING NTWKELEM,R1                                                      
         SR    R0,R0                                                            
NXTSBY06 CLI   NTWKELEM,0          Test end of market/station list              
         JE    NXTSBY08                                                         
         CLI   NTWKELEM,NTWKCODQ                                                
         JNE   *+14                                                             
         MVC   0(L'NTWKMKST,RE),NTWKMKST                                        
         AHI   RE,L'NTWKMKST                                                    
         IC    R0,NTWKLEN          Bump to next element                         
         AR    R1,R0                                                            
         J     NXTSBY06                                                         
                                                                                
NXTSBY08 LAY   R0,NETLST           Point to market/station list                 
         CR    RE,R0               No networks - get next buy                   
         JE    NXTSBY02                                                         
         XC    0(L'NTWKMKST,RE),0(RE)                                           
         LR    RE,R0                                                            
         ST    RE,ANEXT            Point to first market/station                
         MVC   SVBUYKEY,CFMRKEY    Save network buy keys                        
         MVC   SVNETKEY,BUYKEY                                                  
         MVI   CFMRMODE,2          Set network reading mode                     
         MVI   NETFLAG,0           Initialize network flag                      
                                                                                
K        USING BUYKEY,CFMRKEY                                                   
NXTSBY10 L     R1,ANEXT            Process next market/station                  
         OC    0(L'BUYKMSTA,R1),0(R1)                                           
         JZ    NXTSBY12            End of list                                  
         MVC   K.BUYKEY,SVNETKEY                                                
         MVC   K.BUYKMSTA,0(R1)                                                 
         AHI   R1,L'BUYKMSTA       Bump and set address of next entry           
         ST    R1,ANEXT                                                         
         MVI   K.BUYKBUY,0                                                      
         MVC   K.BUYKBUY+1(L'BUYKBUY-1),BUYKBUY                                 
                                                                                
         GOTOR DMGR,DMCB,DMREAD,SPTDIR,K.BUYKEY,K.BUYKEY                        
         JNE   NXTSBY10                                                         
         MVC   DA,K.BUYKDA                                                      
         GOTOR DMGR,DMCB,GETREC,SPTFIL,DA,BUYKEY,WORK                           
         JNE   NXTSBY10            Exit with selective buy                      
         MVC   BUYKMSTA,SVNETKEY+(BUYKMSTA-BUYKEY)                              
         J     EXITY                                                            
                                                                                
NXTSBY12 MVC   CFMRKEY,SVBUYKEY    Restore last network buy key                 
         MVI   CFMRMODE,1          Set not network                              
         J     NXTSBY02            Get next network buy                         
         EJECT                                                                  
***********************************************************************         
* Read Netpak units                                                   *         
***********************************************************************         
                                                                                
NET      TM    CFMINDS,CFMIBUF     Test passing buffer records                  
         JNZ   NET160                                                           
         TM    CFMINDS,CFMINXT     Test first time                              
         JZ    NET010                                                           
         NI    CFMINDS,FF-(CFMINXT)                                             
                                                                                
         OC    CFMVENN,CFMVENN     Test vendor node provided                    
         JNZ   *+12                                                             
         GOTOR GETNVE              Read Network station records                 
         JZ    NOMORE              Exit if no networks found                    
                                                                                
         MVI   LLBIND+0,LL_ITSAR   Build station driver extension               
         LA    RF,CFMTBLK2                                                      
         TM    LP_FLAG,LP_FOFFL                                                 
         JZ    *+8                                                              
         LA    RF,VENBUF                                                        
         STCM  RF,7,LLBIND+1                                                    
         MVC   CFMLSTAC,LLBIND                                                  
                                                                                
NET010   XC    CLIBRECD(L'CFMTREC1),CLIBRECD                                    
         MVC   LLBIND,CFMLSTAC     Reset station extension in LLBIND            
         MVC   CLIBNAGM,CFMLMEDC                                                
         SR    R0,R0                                                            
         ICM   R0,3,CFMLCLIC       Bump client code                             
         AHI   R0,1                                                             
         STCM  R0,3,CLIBNCLI       and get next client from buffer              
                                                                                
         XC    SAVECLII,SAVECLII   Clear saved area for compares                
         XC    SAVEMED,SAVEMED     Clear saved area for media                   
         XC    NUMPRD,NUMPRD                                                    
         ICM   RE,15,CFMAPRD                                                    
         JNZ   *+20                                                             
         L     RE,LP_AWMP                                                       
         STCM  RE,15,CFMAPRD                                                    
         LA    RF,255+LW_LN2Q(RE)                                               
         ST    RF,LP_AWMP                                                       
                                                                                
         USING LW_D,RE                                                          
         STCM  RE,7,APRD           Point to WMP                                 
         MVI   LW_TYPE,LW_TNZRQ                                                 
         LA    R3,LW_DATA2         Point to data field                          
         LAY   R4,PRDLST           Point to product list                        
         DROP  RE                                                               
                                                                                
         GOTOR BUFFER,DMCB,('CLIBUFQ',TSARDH)                                   
         J     NET030                                                           
                                                                                
NET020   GOTOR BUFFER,DMCB,('CLIBUFQ',TSANXT)                                   
NET030   TM    BUFFRET,TSEEOF                                                   
         JZ    NET040                                                           
         OC    NUMPRD,NUMPRD       Test any products found                      
         JZ    ALLNXT                                                           
         J     NET060                                                           
                                                                                
NET040   CLI   CFMLTYPE,CFMLTCLI   Is this a brand request?                     
         JNE   NET050              No - skip all this stuff                     
         MVC   SAVECLII,CLIBNCLI                                                
         MVC   SAVEMED,CLIBNAGM                                                 
         MVC   SAVECNOD,CLIBNNOD                                                
         J     NET070                                                           
                                                                                
NET050   OC    SAVEMED,SAVEMED     Do we have a prev media or agy/med?          
         JZ    *+14                                                             
         CLC   SAVEMED,CLIBNAGM                                                 
         JNE   NET060                                                           
         MVC   SAVEMED,CLIBNAGM                                                 
         OC    SAVECLII,SAVECLII   Do we have a prev client code?               
         JZ    *+14                                                             
         CLC   SAVECLII,CLIBNCLI                                                
         JNE   NET060                                                           
         MVC   SAVECLII,CLIBNCLI   Save for next time                           
         OC    CLIBNPRE,CLIBNPRE   Do we have a brand?                          
         JNZ   *+14                                                             
         MVC   SAVECNOD,CLIBNNOD                                                
         J     NET020                                                           
                                                                                
         MVC   0(L'CLIBNPRN,R3),CLIBNPRN                                        
         AHI   R3,L'CLIBNPRN                                                    
                                                                                
         MVC   0(L'CLIBNPRN,R4),CLIBNPRN                                        
         MVC   L'CLIBNPRN(L'CLIBNPRE,R4),CLIBNPRE                               
         AHI   R4,L'CLIBNPRN+L'CLIBNPRE                                         
         XC    0(L'CLIBNPRN+L'CLIBNPRE,R4),0(R4)                                
                                                                                
         LH    R1,NUMPRD                                                        
         AHI   R1,1                                                             
         STH   R1,NUMPRD                                                        
         J     NET020                                                           
                                                                                
NET060   OC    NUMPRD,NUMPRD       Test any products                            
         JZ    NET020              None - go to next client                     
         ICM   RE,7,APRD                                                        
         USING LW_D,RE                                                          
         MVI   LW_TYPE,LW_TLSTQ    Set list and number of entries               
         MVC   LW_NUMN,NUMPRD                                                   
         DROP  RE                                                               
                                                                                
NET070   MVC   CFMLMEDC,SAVEMED    Set media/client in CFMIOD                   
         MVC   CFMLCLIC(L'SAVECLII),SAVECLII                                    
         MVC   CFMLCLIE,CLIBNCLE                                                
         MVC   CFMLCNOD,SAVECNOD                                                
                                                                                
         MVC   MED,CFMLMEDC        Set media/client in WORKD                    
         MVC   CLI,CFMLCLIC                                                     
                                                                                
         GOTOR BLDPRD              Build product list if necessary              
                                                                                
         GOTOR BLDEST              Build estimate list                          
         JZ    NET010              No estimates - get next client               
                                                                                
         MVI   CFMRMODE,0          Set first time for buy reader                
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSAINI),('NETRKEYL',NETRRECL)             
                                                                                
NET080   GOTOR NXTNBY              Get first/next unit record                   
         JNE   NET150                                                           
                                                                                
         USING NURECD,IO                                                        
                                                                                
         L     R4,CFMAIO                                                        
         USING NETRECD,R4          R4=A(Output unit array)                      
         XC    NETRECD(NETRRECL),NETRECD                                        
         MVI   NETMEDCD,C'*'       Set default (client) media code              
         MVC   NETCLICD,CFMLCLIE   Client code                                  
         MVC   NETSTNET,NUKNET     Network code                                 
         MVC   NETCNODE,CFMLCNOD   Client node                                  
                                                                                
         CLI   CFMESTOP,CFMESTYQ   Test estimate number required                
         JNE   *+10                                                             
         MVC   NETESTNO,NUKEST     Set estimate number                          
                                                                                
         CLI   CFMSPLOP,CFMSPLNQ   Test no split option set                     
         JE    *+16                                                             
         MVC   NETSPROT,NUDAY      Rotation                                     
         MVC   NETUNLEN,NULEN      Unit length                                  
                                                                                
         CLI   CFMPNTOP,CFMPNTYQ   Test program data required                   
         JNE   *+16                                                             
         MVC   NETPRGNM,NUPROGNM   Set optional program values                  
         MVC   NETPRGTM,NUTIME                                                  
                                                                                
         CLC   NUKNET,VENNNET      Test change of network                       
         JE    NET090                                                           
         MVC   VENNNET,NUKNET      Yes - read vendor buffer record              
         GOTOR BUFFER,DMCB,('VENBUFQ',TSARDH)                                   
         JE    NET090                                                           
         MVC   VENNNET,NUKNET      Build dummy entry if not found               
         XC    VENNNODE,VENNNODE                                                
                                                                                
NET090   MVC   NETVNODE,VENNNODE   Set vendor node                              
                                                                                
         LA    R1,NUDATA                                                        
         USING NUSDRD,R1                                                        
         SR    R0,R0                                                            
NET100   CLI   NUSDREL,0           If no NUSDREL skip this record               
         JE    NET080                                                           
         CLI   NUSDREL,NUSDRELQ                                                 
         JE    *+14                                                             
         IC    R0,NUSDRLEN         Bump to next element on record               
         AR    R1,R0                                                            
         J     NET100                                                           
                                                                                
         CLI   NUSTATYP,C' '       Any sub media code?                          
         JNH   *+10                                                             
         MVC   NETMEDCD,NUSTATYP   Sub media override                           
                                                                                
         SR    R0,R0                                                            
         CLI   NUSDSRT,C' '        Any special rate?                            
         JNH   *+8                                                              
         IC    R0,NUSDSRT          Yes - set it                                 
         DROP  R1                                                               
                                                                                
         XC    NETVALS(NETVALL),NETVALS                                         
         GOTOR CFMAGRAT,DMCB,((R0),NUACTUAL),NETVALS                            
         MVI   COSTFLAG,0                                                       
         ICM   R0,15,NETVGRS       Convert gross/net to packed                  
         CVD   R0,DUB                                                           
         ZAP   PGROSS,DUB                                                       
         JNZ   *+8                                                              
         OI    COSTFLAG,COSTFZGQ   Set gross is zero                            
         ICM   R0,15,NETVNET                                                    
         CVD   R0,DUB                                                           
         ZAP   PNET,DUB                                                         
         JNZ   *+8                                                              
         OI    COSTFLAG,COSTFZNQ   Set net is zero                              
                                                                                
         GOTOR BLDPCT,NUDATA       Build product percentages                    
         JNE   NET080              Next unit if no products qualify             
                                                                                
         LA    R3,PCTTAB                                                        
         USING PCTTABD,R3          R3=A(Product percent table)                  
         GOTOR GETCPD,NUKDATE      Get summary posting period                   
         MVC   NETDTPSD,WORK       Set summary posting period                   
                                                                                
NET110   MVC   NETPRDCD,PCTTPRD    Set product code                             
         LHI   R0,1                                                             
         LA    RF,NETUNITS                                                      
         TM    COSTFLAG,COSTFZEQ   Test net and gross are zero                  
         JNO   *+8                                                              
         LA    RF,NETZUNTS                                                      
         STCM  R0,15,0(RF)         Set one unit                                 
         SR    R0,R0                                                            
         ICM   R0,3,PCTTPCT        There must be a split percent                
         JNZ   *+8                                                              
         LHI   R0,10000                                                         
         CVD   R0,DUB              DUB=Percentage split (2dp)                   
         ZAP   WORK(16),PGROSS     Calculate gross share                        
         MP    WORK(16),DUB                                                     
         SRP   WORK(16),64-4,5                                                  
         ZAP   NETGCOST,WORK(16)   Set gross allocated cost                     
         ZAP   WORK(16),PNET       Calculate net share                          
         MP    WORK(16),DUB                                                     
         SRP   WORK(16),64-4,5                                                  
         ZAP   NETNCOST,WORK(16)   Set net allocated cost                       
         MVC   NETRECD+NETRRECL(NETRREPL),NETRECD                               
         AHI   R4,NETRRECL         Bump to next array entry                     
         XC    NETRDATA(NETRDATL),NETRDATA                                      
         AHI   R3,PCTTABL          Bump to next product percent                 
         CLI   PCTTPRD,PCTTPLEQ    Test end of list                             
         JNE   NET110                                                           
                                                                                
         MVI   NETRECD,NETREOAQ    Set end of array                             
         L     R4,CFMAIO           Point back to start of array                 
                                                                                
BUFF     USING NETRECD,MVDATA                                                   
NET120   MVC   BUFF.NETRKEY(NETRKEYL),NETRKEY                                   
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSARDH),BUFF.NETRECD                      
         JNE   NET130                                                           
         ICM   R0,15,BUFF.NETUNITS Update existing buffer record                
         ICM   R1,15,NETUNITS                                                   
         AR    R0,R1                                                            
         STCM  R0,15,BUFF.NETUNITS                                              
         ICM   R0,15,BUFF.NETZUNTS                                              
         ICM   R1,15,NETZUNTS                                                   
         AR    R0,R1                                                            
         STCM  R0,15,BUFF.NETZUNTS                                              
         AP    BUFF.NETGCOST,NETGCOST                                           
         AP    BUFF.NETNCOST,NETNCOST                                           
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSAPUT),BUFF.NETRECD                      
         J     NET140                                                           
                                                                                
NET130   MVC   BUFF.NETRECD(NETRRECL),NETRECD                                   
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSAADD),BUFF.NETRECD                      
         JE    NET140                                                           
         DC    H'0'                                                             
         DROP  BUFF                                                             
                                                                                
NET140   AHI   R4,NETRRECL         Bump to next array entry                     
         CLI   NETRECD,NETREOAQ    Test end of array                            
         JNE   NET120              No - post next to buffer                     
         J     NET080              Yes - get next unit record                   
                                                                                
NET150   L     R1,CFMAIO                                                        
         XC    0(L'NETMEDCD+L'NETCLICD,R1),0(R1)                                
         LA    R4,MVDATA           Point to TSAR record                         
         XC    NETRKEY(NETRKEYL),NETRKEY                                        
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSARDH),NETRECD                           
         TM    BUFFRET,TSEEOF                                                   
         JNZ   NET010              Get next client                              
         J     NET170                                                           
                                                                                
NET160   NI    CFMINDS,FF-(CFMIBUF)                                             
         LA    R4,MVDATA           Point to TSAR record                         
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSANXT),NETRECD                           
         TM    BUFFRET,TSEEOF                                                   
         JNZ   NET010              Get next client                              
                                                                                
NET170   L     R5,LP_ADATA         Return summary record to server              
         USING NPSTATD,R5                                                       
         XC    NPSTATD(NPVALUEL),NPSTATD                                        
                                                                                
         MVC   NPMEDCDE,NETMEDCD   Media code                                   
         MVC   NPCLTCDE,NETCLICD   Client code                                  
         MVC   NPCLTNDE,NETCNODE   Client node                                  
         MVC   NPSTANET,NETSTNET   Network code                                 
                                                                                
         MVC   NPVENNDE,NETVNODE   Vendor node                                  
         MVC   NPPRDCDE,NETPRDCD   Product code                                 
         MVC   NPDATPER,NETDTPSD   Date/period start date                       
                                                                                
         MVC   NPWKYROT,NETSPROT   Rotation                                     
         MVC   NPUNTLEN,NETUNLEN   Unit length                                  
         MVC   NPPRGNAM,NETPRGNM   Program name                                 
         MVC   NPPRGTIM,NETPRGTM   Program time                                 
         MVC   NPESTNUM,NETESTNO   Estimate number                              
                                                                                
         CLI   CFMEDTOP,CFMEDTYQ   Test estimate names required                 
         JNE   NET180                                                           
         OC    NETESTNO,NETESTNO   Test we have an estimate                     
         JZ    NET180                                                           
                                                                                
         L     R1,CFMAIO           Can use I/O area for estimate table          
         CLC   MED,0(R1)           Test same media/client as previous           
         JNE   *+14                                                             
         CLC   CLI,L'MED(R1)                                                    
         JE    *+10                                                             
         XC    L'MED+L'CLI(256,R1),L'MED+L'CLI(R1)                              
         MVC   0(L'MED,R1),MED                                                  
         MVC   L'MED(L'CLI,R1),CLI                                              
         AHI   R1,L'MED+L'CLI                                                   
         LLC   R0,NETESTNO                                                      
         AR    R1,R0                                                            
         CLI   0(R1),0             Test estimate name already sent              
         JNE   NET180                                                           
         MVI   0(R1),1             Set estimate name sent                       
                                                                                
E        USING EKEY,CFMRKEY        Read estimate record                         
         XC    E.EKEY,E.EKEY                                                    
         MVC   E.EKEYAM,CFMLMEDC                                                
         MVC   E.EKEYCLT,CFMLCLIC                                               
         MVC   E.EKEYPRD,=C'POL'   for product POL                              
         MVC   E.EKEYEST,NETESTNO                                               
         GOTOR DMGR,DMCB,DMREAD,SPTDIR,E.EKEY,E.EKEY                            
         JNE   NET180                                                           
         GOTOR DMGR,DMCB,GETREC,SPTFIL,E.EKDA,IO,WORK                           
         JNE   NET180                                                           
E        USING EKEY,IO                                                          
         MVC   NPEDESC,E.EDESC                                                  
         DROP  E                                                                
                                                                                
NET180   MVC   NPUNITS,NETUNITS    Number of non-zero units                     
         MVC   NPZUNITS,NETZUNTS   Number of zero units                         
         ZAP   NPGROSS,NETGCOST    Gross cost                                   
         ZAP   NPNET,NETNCOST      Net cost                                     
                                                                                
         LARL  R0,NETOPTT                                                       
         GOTOR OPTMIZ,DMCB,NPSTATD,(R0)                                         
                                                                                
         OI    CFMINDS,CFMIBUF     Set in array/buffer mode                     
         J     EXITY               Yes - we are running in buffer mode          
         DROP  R3,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Build product list if not a brand request                           *         
***********************************************************************         
                                                                                
BLDPRD   NTR1  LABEL=*                                                          
         CLI   CFMLTYPE,CFMLTBRD   Is this a brand request?                     
         JE    EXITY               Yes - already have product list              
B        USING PLSTPSSV,KEY        Build key of product list passive            
         XC    B.PLSTPSSV,B.PLSTPSSV                                            
         MVI   B.PLSTTYPE,PLSTTYPQ                                              
         MVI   B.PLSTSUB,PLSTSUBQ                                               
         MVC   B.PLSTAM,CFMLMEDC                                                
         MVC   B.PLSTCLT,CFMLCLIC                                               
         LAY   R4,PRDLST           Point to product list                        
         MVC   KEYSAVE,B.PLSTPSSV                                               
         GOTOR DMGR,DMCB,DMRDHI,SPTDIR,B.PLSTPSSV,B.PLSTPSSV                    
         JE    BLDPRD04                                                         
         DC    H'0'                                                             
                                                                                
BLDPRD02 GOTOR DMGR,DMCB,DMRSEQ,SPTDIR,B.PLSTPSSV,B.PLSTPSSV                    
         JE    BLDPRD04                                                         
         DC    H'0'                                                             
                                                                                
BLDPRD04 CLC   B.PLSTPSSV(PLSTXFF-PLSTPSSV),KEYSAVE                             
         JNE   EXITY                                                            
         MVC   0(L'CLIBNPRN,R4),B.PLSTBPRD+(L'PLSTBPRD-L'CLIBNPRN)              
         MVC   L'CLIBNPRN(L'CLIBNPRE,R4),B.PLSTPRD                              
         AHI   R4,L'CLIBNPRN+L'CLIBNPRE                                         
         XC    0(L'CLIBNPRN+L'CLIBNPRE,R4),0(R4)                                
         J     BLDPRD02            Get next passive pointer                     
         EJECT                                                                  
***********************************************************************         
* Build table of products and cost percentages                        *         
***********************************************************************         
                                                                                
BLDPCT   NTR1  LABEL=*                                                          
         XC    UNTVALS(UNTVALL),UNTVALS                                         
         USING NUMAINEL,R1                                                      
         SR    R0,R0                                                            
                                                                                
BLDPCT02 CLI   NUMAINEL,0          Test end of unit record                      
         JE    BLDPCT06                                                         
                                                                                
         CLI   NUMAINEL,NUMAIELQ   Test main element                            
         JNE   *+12                                                             
         ST    R1,UNTVAX01                                                      
         J     BLDPCT04                                                         
                                                                                
         USING NUPRDD,R1                                                        
         CLI   NUPRDEL,NUPRDELQ    Test old style product element               
         JNE   *+12                                                             
         ST    R1,UNTVAX14                                                      
         J     BLDPCT04                                                         
                                                                                
         USING NUPDED,R1                                                        
         CLI   NUPDEEL,NUPDEELQ    Test new style product element               
         JNE   BLDPCT04                                                         
         ST    R1,UNTVAX19                                                      
                                                                                
BLDPCT04 IC    R0,NUPDELEN         Bump to next element on record               
         AR    R1,R0                                                            
         J     BLDPCT02                                                         
         DROP  R1                                                               
                                                                                
BLDPCT06 LA    R3,PCTTAB           Build table of product percentages           
         USING PCTTABD,R3          R3=A(Product percentage table)               
                                                                                
         ICM   R2,15,UNTVAX01                                                   
         JNZ   *+6                                                              
         DC    H'0'                                                             
         USING NUMAINEL,R2                                                      
         MVC   UNTVPPCT,NUP1SHR    Set product 1 share                          
                                                                                
         ICM   R2,15,UNTVAX19      Point to NUPDED                              
         JZ    BLDPCT16                                                         
         USING NUPDED,R2                                                        
         MVC   BYTE,NUPDEIND       Save indicator byte                          
         CLI   NUPDELEN,NUPDEDL    Test one product in element                  
         JE    BLDPCT08                                                         
         OC    UNTVPPCT,UNTVPPCT   Test product 1 share is set                  
         JNZ   BLDPCT08                                                         
         LHI   R0,5000                                                          
         STCM  R0,3,UNTVPPCT       No - set to 50%                              
BLDPCT08 LLC   R0,NUPDELEN                                                      
         SHI   R0,NUPDEPR-NUPDED   R0=Length of product entries                 
         LA    R2,NUPDEPR                                                       
         USING NUPDEPR,R2          R2=A(Product entry)                          
BLDPCT10 GOTOR GETPRC,NUPDEPR      Look up product code                         
         JNE   BLDPCT14                                                         
         MVC   PCTTPRD,0(RF)       Set product code                             
         MVC   PCTTPCT,NUPDEPCT    Set product percentage                       
         TM    BYTE,X'C0'          Test more than 2 products                    
         JNZ   *+14                                                             
         MVC   PCTTPCT,UNTVPPCT    Set product 1 percentage                     
         J     BLDPCT12                                                         
         OC    PCTTPCT,PCTTPCT     Don't update if zero cost percentage         
         JZ    BLDPCT14                                                         
BLDPCT12 AHI   R3,PCTTABL          Bump to next table entry                     
BLDPCT14 AHI   R2,NUPDTLEN         Bump to next product in element              
         SHI   R0,NUPDTLEN         Decrement entry length                       
         JNZ   BLDPCT10            Do next product                              
         J     BLDPCT36                                                         
                                                                                
BLDPCT16 ICM   R2,15,UNTVAX14      Point to NUPRDD                              
         JZ    BLDPCT26                                                         
         USING NUPRDD,R2                                                        
         CLI   NUPRDLEN,NUPRDDL    Test one product in element                  
         JE    BLDPCT18                                                         
         OC    UNTVPPCT,UNTVPPCT   Test product 1 share is set                  
         JNZ   BLDPCT18                                                         
         LHI   R0,5000                                                          
         STCM  R0,3,UNTVPPCT       No - set to 50%                              
BLDPCT18 LLC   R0,NUPRDLEN                                                      
         SHI   R0,NUPRDPR-NUPRDD   R0=Length of product entries                 
         LA    R2,NUPRDPR                                                       
         USING NUPRDPR,R2          R2=A(Product entry)                          
BLDPCT20 GOTOR GETPRN,NUPRDPR      Look-up product number                       
         JNE   BLDPCT24                                                         
         MVC   PCTTPRD,0(RF)       Set product code                             
         MVC   PCTTPCT,NUPRDPCT    Set product percentage                       
         OC    PCTTPCT,PCTTPCT     Don't update if zero cost percentage         
         JZ    BLDPCT24                                                         
BLDPCT22 AHI   R3,PCTTABL          Bump to next table entry                     
BLDPCT24 AHI   R2,NUPRPLEN         Bump to next product in element              
         SHI   R0,NUPRPLEN         Decrement entry length                       
         JNZ   BLDPCT20            Do next product                              
         J     BLDPCT36                                                         
                                                                                
BLDPCT26 ICM   R2,15,UNTVAX01      Point to NUMAINEL                            
         JNZ   *+6                                                              
         DC    H'0'                                                             
         USING NUMAINEL,R2                                                      
         CLI   NUPRD,0             Test allocated                               
         JE    BLDPCT34                                                         
         CLI   NUPRD2,0            Test second product allocated                
         JE    BLDPCT30                                                         
         CLC   NUPRD,NUPRD2        or first=second product                      
         JE    BLDPCT30                                                         
         TM    NUUNST2,X'04'       Test product 1 zero allocation               
         JNZ   BLDPCT32                                                         
         GOTOR GETPRN,NUPRD        Build entry for product 1                    
         JNE   BLDPCT28                                                         
         MVC   PCTTPRD,0(RF)       Set product code                             
         MVC   PCTTPCT,UNTVPPCT                                                 
         LHI   R0,5000                                                          
         OC    PCTTPCT,PCTTPCT                                                  
         JNZ   *+8                                                              
         STCM  R0,3,PCTTPCT        Set 50% if none specified                    
         AHI   R3,PCTTABL                                                       
                                                                                
BLDPCT28 GOTOR GETPRN,NUPRD2                                                    
         JNE   BLDPCT36                                                         
         MVC   PCTTPRD,0(RF)       Set product code                             
         SR    R0,R0                                                            
         ICM   R0,3,UNTVPPCT                                                    
         JNZ   *+12                                                             
         LHI   R0,5000             Set share to 50% if not defined              
         J     *+12                                                             
         LHI   R1,10000            Else calculate second product %              
         SR    R1,R0                                                            
         LR    R0,R1                                                            
         STCM  R0,3,PCTTPCT                                                     
         AHI   R3,PCTTABL                                                       
         J     BLDPCT36                                                         
                                                                                
BLDPCT30 GOTOR GETPRN,NUPRD        Build single entry for product 1             
         JNE   BLDPCT36                                                         
         MVC   PCTTPRD,0(RF)       Set product code                             
         LHI   R0,10000                                                         
         STCM  R0,3,PCTTPCT                                                     
         AHI   R3,PCTTABL                                                       
         J     BLDPCT36                                                         
                                                                                
BLDPCT32 GOTOR GETPRN,NUPRD2       Build single entry for product 2             
         JNE   BLDPCT36                                                         
         MVC   PCTTPRD,0(RF)       Set product code                             
         LHI   R0,10000                                                         
         STCM  R0,3,PCTTPCT                                                     
         AHI   R3,PCTTABL                                                       
         J     BLDPCT36                                                         
         DROP  R2                                                               
                                                                                
BLDPCT34 GOTOR GETPRC,POLPRDC      Build single entry for product 'POL'         
         JNE   BLDPCT36                                                         
         MVC   PCTTPRD,0(RF)                                                    
         LHI   R0,10000                                                         
         STCM  R0,3,PCTTPCT                                                     
         AHI   R3,PCTTABL                                                       
                                                                                
BLDPCT36 LA    R0,PCTTAB           Point to start of percent list               
         CR    R0,R3               Test any entries added                       
         JE    EXITN                                                            
         MVI   PCTTPRD,PCTTPLEQ    Set end of list                              
         J     EXITY                                                            
         DROP  R3                                                               
                                                                                
GETPRN   LAY   RF,PRDLST           Locate product by number                     
GETPRN02 OC    0(L'CLIBNPRN+L'CLIBNPRE,RF),0(RF)                                
         JNZ   *+8                                                              
         LTR   RE,RE               Exit with CC=not equal at end                
         BR    RE                                                               
         CLC   0(L'CLIBNPRN,RF),0(R1)                                           
         JNE   *+12                                                             
         AHI   RF,L'CLIBNPRN                                                    
         CR    RE,RE               Exit with CC=equal if found                  
         BR    RE                                                               
         AHI   RF,L'PRDLST                                                      
         J     GETPRN02                                                         
                                                                                
GETPRC   LAY   RF,PRDLST           Locate product by code                       
GETPRC02 OC    0(L'CLIBNPRN+L'CLIBNPRE,RF),0(RF)                                
         JNZ   *+8                                                              
         LTR   RE,RE               Exit with CC=not equal at end                
         BR    RE                                                               
         CLC   L'CLIBNPRN(L'CLIBNPRE,RF),0(R1)                                  
         JNE   *+12                                                             
         AHI   RF,L'CLIBNPRN                                                    
         CR    RE,RE               Exit with CC=equal if found                  
         BR    RE                                                               
         AHI   RF,L'PRDLST                                                      
         J     GETPRC02                                                         
         EJECT                                                                  
         DS    0H                                                               
NETOPTT  DS    0XL2                ** Netpak optimization table **              
         DC    AL1(NPMEDCDE-NPVALUES,L'NPMEDCDE-1)                              
         DC    AL1(NPCLTCDE-NPVALUES,L'NPCLTCDE-1)                              
         DC    AL1(NPCLTNDE-NPVALUES,L'NPCLTNDE-1)                              
         DC    AL1(NPPRDCDE-NPVALUES,L'NPPRDCDE-1)                              
         DC    AL1(NPPRDNDE-NPVALUES,L'NPPRDNDE-1)                              
         DC    AL1(NPSTANET-NPVALUES,L'NPSTANET-1)                              
         DC    AL1(NPVENNDE-NPVALUES,L'NPVENNDE-1)                              
         DC    AL1(NPDATPER-NPVALUES,L'NPDATPER-1)                              
         DC    AL1(NPWKYROT-NPVALUES,L'NPWKYROT-1)                              
         DC    AL1(NPUNTLEN-NPVALUES,L'NPUNTLEN-1)                              
         DC    AL1(NPPRGNAM-NPVALUES,L'NPPRGNAM-1)                              
         DC    AL1(NPPRGTIM-NPVALUES,L'NPPRGTIM-1)                              
         DC    AL1(NPESTNUM-NPVALUES,L'NPESTNUM-1)                              
NETOPTTX DC    AL1(FF,FF)                                                       
                                                                                
NETRECD  DSECT                     ** Netpak summary records **                 
NETREOAQ EQU   FF                  End of array indicator                       
                                                                                
NETRKEY  DS    0X                  ** Buffer key **                             
                                                                                
NETMEDCD DS    CL(L'NPMEDCDE)      Media code                                   
NETCLICD DS    CL(L'NPCLTCDE)      Client code                                  
NETPRDCD DS    CL(L'NPPRDCDE)      Product code                                 
NETSTNET DS    XL(L'NPSTANET)      Station/network code                         
NETDTPSD DS    XL(L'NPDATPER)      Date/period start date                       
                                                                                
NETSPROT DS    XL(L'NPWKYROT)      Rotation                                     
NETUNLEN DS    XL(L'NPUNTLEN)      Unit length                                  
NETPRGNM DS    CL(L'NPPRGNAM)      Program name                                 
NETPRGTM DS    XL(L'NPPRGTIM)      Program time                                 
NETESTNO DS    XL(L'NUKDEST)       Estimate number                              
                                                                                
NETRKEYL EQU   *-NETRKEY           Key length                                   
                                                                                
NETCNODE DS    XL(L'CFMKPNOD)      Client node                                  
NETVNODE DS    XL(L'CFMKPNOD)      Vendor node                                  
NETRREPL EQU   *-NETRKEY           Replicated data (multi-product)              
                                                                                
NETRDATA DS    0X                  ** Buffer data **                            
NETUNITS DS    XL(L'NPUNITS)       Number of non-zero units                     
NETZUNTS DS    XL(L'NPUNITS)       Number of zero units                         
NETGCOST DS    PL(L'NPGROSS)       Gross cost                                   
NETNCOST DS    PL(L'NPNET)         Net cost                                     
NETRDATL EQU   *-NETRDATA                                                       
                                                                                
NETRRECL EQU   *-NETRKEY                                                        
CFMIO    CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Get Netpak vendor records and post to vendor buffer                 *         
***********************************************************************         
                                                                                
GETNVE   NTR1  LABEL=*                                                          
         XC    STAKEY,STAKEY                                                    
                                                                                
GETNVE02 GOTOR LP_ASETK,DMCB,(0,NETSTAT),STAKEY,WORKD,('FF',LP_D)               
         JH    GETNVE04                                                         
         GOTOR DMGR,DMCB,DMRDHI,STAFIL,STARECD,STARECD                          
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   CFMRKEY,STAKEY                                                   
         GOTOR LP_ASETK,DMCB,(1,NETSTAT),STAKEY,WORKD,('FF',LP_D)               
         JNE   GETNVE02                                                         
                                                                                
         LA    RF,CFMMTAB          Look up media in table                       
         USING CFMMTD,RF                                                        
         BASR  RE,0                                                             
         CLI   CFMMTD,CFMMTEOT     Test end of media table                      
         JE    GETNVE02            Yes - ignore this vendor                     
         CLC   CFMMTMED,STYPE      Match station media to table                 
         JE    *+10                                                             
         AHI   RF,CFMMTLNQ                                                      
         BR    RE                                                               
                                                                                
         MVC   VENNNET,STAKCALL                                                 
         GOTOR BUFFER,DMCB,('VENBUFQ',TSARDH)                                   
         JE    GETNVE02                                                         
         XC    VENNRECD(VENNRECL),VENNRECD                                      
         MVC   VENNNET,STAKCALL                                                 
         GOTOR BUFFER,DMCB,('VENBUFQ',TSAADD)                                   
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R0,CFMVENP                                                       
         AHI   R0,1                                                             
         ST    R0,CFMVENP                                                       
         J     GETNVE02                                                         
                                                                                
GETNVE04 OC    CFMVENP,CFMVENP     Test any station records found               
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Get next Netpak unit record                                         *         
***********************************************************************         
                                                                                
NXTNBY   NTR1  LABEL=*                                                          
         CLI   CFMRMODE,0          Test first time call                         
         JNE   NXTNBY02                                                         
         MVI   CFMRMODE,1          Reset first time call                        
         XC    CFMRKEY,CFMRKEY                                                  
                                                                                
NXTNBY02 GOTOR LP_ASETK,DMCB,(0,NETBUYT),CFMRKEY,WORKD,('FF',LP_D)              
         JH    EXIT                                                             
         GOTOR DMGR,DMCB,DMRDHI,UNTDIR,CFMRKEY,CFMRKEY                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR LP_ASETK,DMCB,(1,NETBUYT),CFMRKEY,WORKD,('FF',LP_D)              
         JNE   NXTNBY02                                                         
         MVC   DA,CFMRKEY+(NUDA-NURECD)                                         
         GOTOR DMGR,DMCB,GETREC,UNTFIL,DA,IO,WORK                               
         JE    *+6                                                              
         DC    H'0'                Die on errors                                
         USING NURECD,IO                                                        
         TM    NUUNITST,X'42'      Drop pre-empted/missed units                 
         JNZ   NXTNBY02                                                         
         TM    NUPACKST,NUPALOKQ   Drop locked packages                         
         JNZ   NXTNBY02                                                         
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Read Printpak insertions                                            *         
***********************************************************************         
                                                                                
PRT      TM    CFMINDS,CFMIBUF     Test passing buffer records                  
         JNZ   PRT210                                                           
                                                                                
PRT010   XC    CLIBRECD(L'CFMTREC1),CLIBRECD                                    
         MVC   CLIBPMED,CFMLMEDC                                                
         SR    R0,R0                                                            
         ICM   R0,7,CFMLCLIC       Bump client code                             
         AHI   R0,1                                                             
         STCM  R0,7,CLIBPCLI       and get next client from buffer              
                                                                                
         XC    SAVECLIE,SAVECLIE   Clear saved values for compares              
         XC    SAVEMED,SAVEMED                                                  
         XC    NUMPRD,NUMPRD                                                    
         ICM   RE,15,CFMAPRD                                                    
         JNZ   *+20                                                             
         L     RE,LP_AWMP                                                       
         STCM  RE,15,CFMAPRD                                                    
         LA    RF,255+LW_LN2Q(RE)                                               
         ST    RF,LP_AWMP                                                       
                                                                                
         USING LW_D,RE                                                          
         STCM  RE,7,APRD           Point to WMP                                 
         MVI   LW_TYPE,LW_TNZRQ                                                 
         LA    R3,LW_DATA2         Point to data field                          
         DROP  RE                                                               
                                                                                
         GOTOR BUFFER,DMCB,('CLIBUFQ',TSARDH)                                   
         J     PRT030                                                           
                                                                                
PRT020   GOTOR BUFFER,DMCB,('CLIBUFQ',TSANXT)                                   
PRT030   TM    BUFFRET,TSEEOF                                                   
         JZ    PRT040                                                           
         OC    NUMPRD,NUMPRD       Any products found?                          
         JZ    ALLNXT                                                           
         J     PRT060                                                           
                                                                                
PRT040   CLI   CFMLTYPE,CFMLTCLI   Is this a brand request?                     
         JNE   PRT050              No - skip all this stuff                     
         MVC   SAVECLIE,CLIBPCLI                                                
         MVC   SAVEMED,CLIBPMED                                                 
         MVC   SAVECNOD,CLIBPNOD                                                
         J     PRT080                                                           
                                                                                
PRT050   OC    SAVEMED,SAVEMED     Do we have a prev media or agy/med?          
         JZ    *+14                                                             
         CLC   SAVEMED,CLIBPMED                                                 
         JNE   PRT060                                                           
         MVC   SAVEMED,CLIBPMED    Save for next time                           
         OC    SAVECLIE,SAVECLIE   Do we have a prev client code?               
         JZ    *+14                                                             
         CLC   SAVECLIE,CLIBPCLI                                                
         JNE   PRT060                                                           
         MVC   SAVECLIE,CLIBPCLI   Save for next time                           
         CLC   CLIBPPRC,SPACES     Do we have a brand?                          
         JH    *+14                                                             
         MVC   SAVECNOD,CLIBPNOD                                                
         J     PRT020                                                           
                                                                                
         MVC   0(L'CLIBPPRC,R3),CLIBPPRC                                        
         AHI   R3,L'CLIBPPRC                                                    
                                                                                
         LH    R1,NUMPRD                                                        
         AHI   R1,1                                                             
         STH   R1,NUMPRD                                                        
         J     PRT020                                                           
                                                                                
PRT060   OC    NUMPRD,NUMPRD                                                    
         JZ    PRT070                                                           
         ICM   RE,7,APRD                                                        
         USING LW_D,RE                                                          
         MVI   LW_TYPE,LW_TLSTQ                                                 
         MVC   LW_NUMN,NUMPRD                                                   
         J     PRT080                                                           
         DROP  RE                                                               
                                                                                
PRT070   CLI   CFMLTYPE,CFMLTBRD   Is this a brand request?                     
         JE    PRT020              Yes - must have brands then                  
                                                                                
PRT080   CLC   SAVEMED,VENPMED     Test change of media                         
         JE    PRT120                                                           
         MVC   CFMLMEDC,SAVEMED    Set media                                    
                                                                                
         LHI   RE,LL_IRNGQ         Build publication driver extension           
         LARL  RF,RANGE61F                                                      
         OC    CFMVENN,CFMVENN     Test vendor node given                       
         JZ    PRT110              No - process all publications                
                                                                                
         XC    VENPKEY(VENPKEYL),VENPKEY                                        
         MVC   VENPMED,CFMLMEDC    Test any publications for this media         
         GOTOR BUFFER,DMCB,('VENBUFQ',TSARDH)                                   
         TM    BUFFRET,TSEEOF                                                   
         JNZ   NOMORE                                                           
         CLC   VENPMED,CFMLMEDC    Test correct (client) media                  
         JE    PRT090                                                           
         MVC   CFMLMEDC,VENPMED    No - get first client for this media         
         XC    CFMLCLIC,CFMLCLIC                                                
         MVI   VENPMED,0           (force re-read of vendor next time)          
         J     PRT010                                                           
                                                                                
***********************************************************************         
* Build publication driver                                            *         
***********************************************************************         
                                                                                
PRT090   GOTOR BUFFER,DMCB,('SUPBUFQ',TSAINI),(L'VENPPUB,L'VENPPUB)             
                                                                                
PRT100   MVC   CFMLVEND,VENPPUB                                                 
         GOTOR BUFFER,DMCB,('SUPBUFQ',TSAADD)                                   
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R0,ATSARD           Remember where TSAR block is                 
         GOTOR BUFFER,DMCB,('VENBUFQ',TSANXT)                                   
         JNE   *+14                                                             
         CLC   VENPMED,CFMLMEDC    Test correct media                           
         JE    PRT100              Yes - build entry and get next               
         MVC   VENPMED,CFMLMEDC    Reset media for next time through            
         XC    VENPPUB,VENPPUB     Clear publication number                     
         LHI   RE,LL_ITSAR                                                      
         LR    RF,R0               Set a(TSAR block) in RF                      
                                                                                
PRT110   STCM  RE,1,LLBIND+0       Set driver type                              
         STCM  RF,7,LLBIND+1       Set A(extension control block)               
         MVC   CFMLSTAC,LLBIND     Set driver extension in CFMIOD               
                                                                                
PRT120   MVC   CFMLCLIC,SAVECLIE   Set client code                              
         MVC   CFMLCNOD,SAVECNOD   Set client node                              
                                                                                
         MVC   MED,CFMLMEDC        Set media/client in WORKD                    
         MVC   CLI,CFMLCLIC                                                     
                                                                                
         MVI   CFMRMODE,0          Set first for insertion reader               
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSAINI),('PRTRKEYL',PRTRRECL)             
                                                                                
PRT130   GOTOR NXTPBY              Get first/next insertion record              
         JNE   PRT200                                                           
                                                                                
         USING PBUYRECD,IO                                                      
K        USING PBUYRECD,CFMRKEY                                                 
                                                                                
         L     R3,CFMAIO                                                        
         USING PRTRECD,R3          R3=A(Output array)                           
         XC    PRTRECD(PRTRRECL),PRTRECD                                        
         MVC   PRTMEDCD,CFMLMEDC   Set key values                               
         MVC   PRTCLICD,CFMLCLIC   Client code                                  
         MVC   PRTPRDCD,PBUYKPRD   Product code                                 
         MVC   PRTPUBCD,PBUYKPUB   Publication code                             
         MVC   PRTCNODE,CFMLCNOD   Client node                                  
                                                                                
         CLI   CFMESTOP,CFMESTYQ   Estimate number                              
         JNE   *+10                                                             
         MVC   PRTESTNO,PBUYKEST   Estimate number                              
                                                                                
         CLI   CFMPNTOP,CFMPNTYQ   Test space/desc requested                    
         JNE   PRT140                                                           
                                                                                
         LARL  RE,PRT140           Call server to get space/desc                
         NTR1  LABEL=NO                                                         
         GOTOR ,DMCB,PBUYRECD,PRTSPCDS                                          
         L     RF,CFMAGSPC                                                      
         L     RE,SAVERD                                                        
         LM    R2,RC,28(RE)        Restore server's register 2-C                
         BASR  RE,RF                                                            
         J     EXIT                                                             
                                                                                
PRT140   GOTOR CFMAGRAT,DMCB,PBUYRECD,PRTVALS,PBUYKPRD,0,0,0                    
         MVI   COSTFLAG,0                                                       
         USING PRTVALSD,PRTVALS                                                 
         ICM   R0,15,PRTGROSS                                                   
         CVD   R0,DUB                                                           
         ZAP   PGROSS,DUB                                                       
         JNZ   *+8                                                              
         OI    COSTFLAG,COSTFZGQ                                                
         S     R0,PRTAGYCOM                                                     
         CVD   R0,DUB                                                           
         ZAP   PNET,DUB                                                         
         JNZ   *+8                                                              
         OI    COSTFLAG,COSTFZNQ   Show that net is zero                        
                                                                                
         GOTOR GETBPD,PBUYKDAT     Set summary posting record                   
                                                                                
         MVC   PRTINSDT,WORK       First for new record                         
         LHI   R0,1                                                             
         LA    RF,PRTBUYS                                                       
         TM    COSTFLAG,COSTFZEQ   Test net and gross are zero                  
         JNO   *+8                                                              
         LA    RF,PRTZBUYS                                                      
         STCM  R0,15,0(RF)                                                      
         ZAP   PRTGCOST,PGROSS                                                  
         ZAP   PRTNCOST,PNET                                                    
                                                                                
         CLC   VENPMED,PBUYKMED    Test change of media/publication             
         JNE   *+14                                                             
         CLC   VENPPUB,PBUYKPUB                                                 
         JE    PRT180                                                           
         MVC   VENPMED,PBUYKMED    Yes - read vendor buffer record              
         MVC   VENPPUB,PBUYKPUB                                                 
         GOTOR BUFFER,DMCB,('VENBUFQ',TSARDH)                                   
         JE    PRT150                                                           
         XC    VENPRECD(VENPRECL),VENPRECD                                      
         MVC   VENPMED,PBUYKMED    Build dummy entry if not found               
         MVC   VENPPUB,PBUYKPUB                                                 
         MVI   VENPSTAT,VENPSDUM                                                
                                                                                
PRT150   TM    VENPSTAT,VENPSSNT   Test details already sent                    
         JNZ   PRT180                                                           
         MVC   PRTVNODE,VENPNODE   Set vendor node first time                   
                                                                                
         USING PUBRECD,IO          Read publication record                      
         XC    PUBKEY,PUBKEY                                                    
         MVC   PUBKMED,K.PBUYKMED                                               
         MVC   PUBKPUB(L'PRTPUBCD),PRTPUBCD                                     
         MVC   PUBKAGY,AGY                                                      
         MVI   PUBKCOD,PUBKCODQ                                                 
                                                                                
         GOTOR DMGR,DMCB,DMREAD,PUBDIR,PUBKEY,PUBKEY                            
         JNE   PRT160                                                           
         MVC   DA,PUBKEY+27                                                     
         GOTOR DMGR,DMCB,GETREC,PUBFIL,DA,PUBRECD,WORK                          
         JE    *+6                                                              
         DC    H'0'                Die on errors                                
         MVC   PRTPUBNM,PUBNAME    Send publication name once only              
                                                                                
PRT160   CLI   VENPSTAT,VENPSDUM   Test record found                            
         MVI   VENPSTAT,VENPSSNT   Set status to 'details sent'                 
         JNE   PRT170                                                           
         GOTOR BUFFER,DMCB,('VENBUFQ',TSAADD)                                   
         JE    PRT180                                                           
         DC    H'0'                                                             
                                                                                
PRT170   GOTOR BUFFER,DMCB,('VENBUFQ',TSAPUT)                                   
         JE    PRT180                                                           
         DC    H'0'                                                             
                                                                                
BUFF     USING PRTRECD,MVDATA                                                   
PRT180   MVC   BUFF.PRTRKEY(PRTRKEYL),PRTRKEY                                   
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSARDH),BUFF.PRTRECD                      
         JNE   PRT190                                                           
         ICM   R0,15,BUFF.PRTBUYS  Update existing buffer record                
         ICM   R1,15,PRTBUYS                                                    
         AR    R0,R1                                                            
         STCM  R0,15,BUFF.PRTBUYS                                               
         ICM   R0,15,BUFF.PRTZBUYS                                              
         ICM   R1,15,PRTZBUYS                                                   
         AR    R0,R1                                                            
         STCM  R0,15,BUFF.PRTZBUYS                                              
         AP    BUFF.PRTGCOST,PRTGCOST                                           
         AP    BUFF.PRTNCOST,PRTNCOST                                           
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSAPUT),BUFF.PRTRECD                      
         J     PRT130                                                           
                                                                                
PRT190   MVC   BUFF.PRTRECD(PRTRRECL),PRTRECD                                   
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSAADD),BUFF.PRTRECD                      
         JE    PRT130                                                           
         DC    H'0'                                                             
         DROP  BUFF                                                             
                                                                                
PRT200   L     R1,CFMAIO                                                        
         XC    0(L'PRTMEDCD+L'PRTCLICD,R1),0(R1)                                
         LA    R3,MVDATA           Point to TSAR record                         
         XC    PRTRKEY(PRTRKEYL),PRTRKEY                                        
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSARDH),PRTRECD                           
         TM    BUFFRET,TSEEOF                                                   
         JNZ   PRT010              Get next client                              
         J     PRT220              Else return first record                     
                                                                                
PRT210   NI    CFMINDS,FF-(CFMIBUF)                                             
         LA    R3,MVDATA           Point to TSAR record                         
         GOTOR BUFFER,DMCB,('BUYBUFQ',TSANXT),PRTRECD                           
         JNE   PRT010              Get next client                              
                                                                                
PRT220   L     R4,LP_ADATA         Return summary record to server              
         USING PPSTATD,R4                                                       
         XC    PPSTATD(PPVALUEL),PPSTATD                                        
                                                                                
         MVC   PPMEDCDE,PRTMEDCD   Media code                                   
         MVC   PPCLTCDE,PRTCLICD   Client code                                  
         MVC   PPCLTNDE,PRTCNODE   Client node                                  
         MVC   PPPUBCOD,PRTPUBCD   Pub code                                     
         MVC   PPPUBNAM,PRTPUBNM   Pub name                                     
                                                                                
         MVC   PPVENNDE,PRTVNODE   Vendor node                                  
         MVC   PPPRDCDE,PRTPRDCD   Product code                                 
         MVC   PPDATPER,PRTINSDT   Date/period start date                       
                                                                                
         MVC   PPSPACE,PRTSPCDS    Space description                            
         MVC   PPESTNUM,PRTESTNO   Estimate number                              
                                                                                
         CLI   CFMEDTOP,CFMEDTYQ   Test estimate names requested                
         JNE   PRT230                                                           
         OC    PRTESTNO,PRTESTNO   Test we have an estimate number              
         JZ    PRT230                                                           
                                                                                
         L     R2,CFMAIO           Point to estimate table                      
         CLC   PRTMEDCD,0(R2)      Test change of media/client                  
         JNE   *+14                                                             
         CLC   PRTCLICD,L'PRTMEDCD(R2)                                          
         JE    *+10                                                             
         XC    L'PRTMEDCD+L'PRTCLICD(4,R2),L'PRTMEDCD+L'PRTCLICD(R2)            
         MVC   0(L'PRTMEDCD,R2),PRTMEDCD                                        
         MVC   L'PRTMEDCD(L'PRTCLICD,R2),PRTCLICD                               
         AHI   R2,L'PRTMEDCD+L'PRTCLICD                                         
                                                                                
         MVC   WORK(L'PRTPRDCD),PRTPRDCD                                        
         MVC   WORK+L'PRTPRDCD(L'PRTESTNO),PRTESTNO                             
         ICM   R0,15,0(R2)                                                      
         GOTOR BINSRCH,DMCB,(1,WORK),4(R2),(R0),L'PRTPRDCD+L'PRTESTNO, +        
               L'PRTPRDCD+L'PRTESTNO,800                                        
         MVC   0(4,R2),8(R1)       Extract number of entries                    
         CLI   0(R1),1             Test was not found                           
         JNE   PRT230                                                           
E        USING PESTKEY,CFMRKEY     Yes - read estimate record                   
         XC    E.PESTKEY,E.PESTKEY                                              
         MVC   E.PESTKAGY,AGY                                                   
         MVC   E.PESTKMED,CFMLMEDC                                              
         MVI   E.PESTKRCD,X'07'                                                 
         MVC   E.PESTKCLT,PRTCLICD                                              
         MVC   E.PESTKPRD,PRTPRDCD                                              
         MVC   E.PESTKEST,PRTESTNO                                              
         GOTOR DMGR,DMCB,DMREAD,PRTDIR,E.PESTKEY,E.PESTKEY                      
         JNE   PRT230                                                           
         MVC   DA,E.PESTKEY+L'PESTKEY+L'PESTCNTL                                
         GOTOR DMGR,DMCB,GETREC,PRTFIL,DA,IO,WORK                               
         JNE   PRT230                                                           
E        USING PESTKEY,IO                                                       
         MVC   PPESTNAM,E.PESTNAME                                              
         DROP  E                                                                
                                                                                
PRT230   MVC   PPBUYS,PRTBUYS      Number of non-zero insertions                
         MVC   PPZBUYS,PRTZBUYS    Number of zero insertions                    
         ZAP   PPGROSSC,PRTGCOST   Gross cost                                   
         ZAP   PPNETC,PRTNCOST     Net cost                                     
                                                                                
         LARL  R0,PRTOPTT                                                       
         GOTOR OPTMIZ,DMCB,PPSTATD,(R0)                                         
                                                                                
         OI    CFMINDS,CFMIBUF     Set in array/buffer mode                     
         J     EXITY                                                            
         DROP  R3,R4                                                            
         EJECT                                                                  
         DS    0H                                                               
PRTOPTT  DS    0XL2                ** Printpak optimization table **            
         DC    AL1(PPMEDCDE-PPVALUES,L'PPMEDCDE-1)                              
         DC    AL1(PPCLTCDE-PPVALUES,L'PPCLTCDE-1)                              
         DC    AL1(PPCLTNDE-PPVALUES,L'PPCLTNDE-1)                              
         DC    AL1(PPPRDCDE-PPVALUES,L'PPPRDCDE-1)                              
         DC    AL1(PPPRDNDE-PPVALUES,L'PPPRDNDE-1)                              
         DC    AL1(PPPUBCOD-PPVALUES,L'PPPUBCOD-1)                              
         DC    AL1(PPDATPER-PPVALUES,L'PPDATPER-1)                              
         DC    AL1(PPSPACE-PPVALUES,L'PPSPACE-1)                                
         DC    AL1(PPESTNUM-PPVALUES,L'PPESTNUM-1)                              
PRTOPTTX DC    AL1(FF,FF)                                                       
                                                                                
PRTRECD  DSECT                     ** Printpak summary records **               
PRTREOAQ EQU   FF                  End of array indicator                       
                                                                                
PRTRKEY  DS    0X                  ** Buffer key **                             
                                                                                
PRTMEDCD DS    CL(L'PPMEDCDE)      Media code                                   
PRTCLICD DS    CL(L'PPCLTCDE)      Client code                                  
PRTPRDCD DS    CL(L'PPPRDCDE)      Product code                                 
PRTPUBCD DS    XL6                 Publication/Zone/Edition                     
PRTINSDT DS    XL(L'PPDATPER)      Insertion date                               
PRTSPCDS DS    CL(L'PPSPACE)       Space description (optional)                 
PRTESTNO DS    CL(L'PBUYKEST)      Estimate number   (optional)                 
PRTRKEYL EQU   *-PRTRKEY           Key length                                   
                                                                                
PRTCNODE DS    XL(L'PPCLTNDE)      Client node                                  
PRTVNODE DS    XL(L'PPVENNDE)      Vendor node                                  
PRTPUBNM DS    CL(L'PPPUBNAM)      Publication name                             
                                                                                
PRTBUYS  DS    XL(L'PPBUYS)        Number of non zero insertions                
PRTZBUYS DS    XL(L'PPZBUYS)       Number of zero insertions                    
PRTGCOST DS    PL(L'PPGROSSC)      Gross cost                                   
PRTNCOST DS    PL(L'PPNETC)        Net cost                                     
PRTRRECL EQU   *-PRTRKEY                                                        
CFMIO    CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Get next Printpak insertion record                                  *         
***********************************************************************         
                                                                                
         USING PBUYREC,IO                                                       
NXTPBY   NTR1  LABEL=*                                                          
         CLI   CFMRMODE,0          Test first time call                         
         JNE   NXTPBY02                                                         
         MVI   CFMRMODE,1          Reset first time call                        
         XC    CFMRKEY,CFMRKEY                                                  
                                                                                
NXTPBY02 GOTOR LP_ASETK,DMCB,(0,PRTBUYT),CFMRKEY,WORKD,('FF',LP_D)              
         JH    EXIT                                                             
         GOTOR DMGR,DMCB,DMRDHI,PRTDIR,CFMRKEY,CFMRKEY                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR LP_ASETK,DMCB,(1,PRTBUYT),CFMRKEY,WORKD,('FF',LP_D)              
         JNE   NXTPBY02                                                         
         MVC   DA,CFMRKEY+(L'PBUYKEY+L'PBUYCNTL)                                
         GOTOR DMGR,DMCB,GETREC,PRTFIL,DA,PBUYREC,WORK                          
         JE    *+6                                                              
         DC    H'0'                Die on errors                                
         CLI   PBDBFD,C'T'         Test if a test buy                           
         JE    NXTPBY02            Yes - ignore                                 
         TM    PBDSTAT2,X'40'      Test stewardship buy                         
         JNZ   NXTPBY02            Yes - ignore                                 
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Get period date for compressed input date                           *         
***********************************************************************         
                                                                                
GETCPD   MVC   WORK(L'CFMSTDTC),0(R1)                                           
         CLI   CFMSUMOP,0          Default is day (actual date)                 
         BER   RE                                                               
         CLI   CFMSUMOP,CFMSUMDQ   Test request is for day                      
         BER   RE                                                               
                                                                                
         CLI   CFMSUMOP,CFMSUMMQ   Test monthly/quarterly                       
         JE    *+12                                                             
         CLI   CFMSUMOP,CFMSUMQQ                                                
         JNE   GETCPD04                                                         
                                                                                
         LA    RF,CFMCTAB                                                       
GETCPD02 CLC   0(L'CFMCTAB,R1),L'CFMCTAB(RF)                                    
         JL    *+12                                                             
         AHI   RF,L'CFMCTAB                                                     
         J     GETCPD02                                                         
         MVC   WORK(L'CFMCTAB),0(RF)                                            
         BR    RE                                                               
                                                                                
GETCPD04 NTR1  LABEL=*             Handle weekly posting dates                  
         LR    R0,R1                                                            
         GOTOR DATCON,DMCB,(2,(R0)),WORK                                        
         GOTOR GETDAY,(R1),WORK,WORK+6                                          
         SR    RF,RF                                                            
         ICM   RF,1,0(R1)                                                       
         JNZ   *+6                                                              
         DC    H'0'                                                             
         CHI   RF,1                                                             
         JE    GETCPD06                                                         
         SHI   RF,1                                                             
         LCR   RF,RF                                                            
         GOTOR ADDAY,(R1),WORK,WORK+6,(RF)                                      
         GOTOR DATCON,(R1),WORK+6,(2,WORK)                                      
         J     EXIT                                                             
                                                                                
GETCPD06 LR    R1,R0               Input date is a Monday                       
         MVC   WORK(L'CFMSTDTC),0(R1)                                           
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Get period date for binary input date                               *         
***********************************************************************         
                                                                                
GETBPD   MVC   WORK(L'CFMSTDTB),0(R1)                                           
         CLI   CFMSUMOP,0          Default is day (actual date)                 
         BER   RE                                                               
         CLI   CFMSUMOP,CFMSUMDQ   Test request is for day                      
         BER   RE                                                               
                                                                                
         CLI   CFMSUMOP,CFMSUMMQ   Test monthly/quarterly                       
         JE    *+12                                                             
         CLI   CFMSUMOP,CFMSUMQQ                                                
         JNE   GETBPD04                                                         
                                                                                
         LA    RF,CFMBTAB                                                       
GETBPD02 CLC   0(L'CFMBTAB,R1),L'CFMBTAB(RF)                                    
         JL    *+12                                                             
         AHI   RF,L'CFMBTAB                                                     
         J     GETBPD02                                                         
         MVC   WORK(L'CFMBTAB),0(RF)                                            
         BR    RE                                                               
                                                                                
GETBPD04 NTR1  LABEL=*             Handle weekly posting dates                  
         LR    R0,R1                                                            
         GOTOR DATCON,DMCB,(3,(R0)),WORK                                        
         GOTOR GETDAY,(R1),WORK,WORK+6                                          
         SR    RF,RF                                                            
         ICM   RF,1,0(R1)                                                       
         JNZ   *+6                                                              
         DC    H'0'                                                             
         CHI   RF,1                                                             
         JE    GETBPD06                                                         
         SHI   RF,1                                                             
         LCR   RF,RF                                                            
         GOTOR ADDAY,(R1),WORK,WORK+6,(RF)                                      
         GOTOR DATCON,(R1),WORK+6,(3,WORK)                                      
         J     EXIT                                                             
                                                                                
GETBPD06 LR    R1,R0               Input date is a Monday                       
         MVC   WORK(L'CFMSTDTB),0(R1)                                           
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* If we have just done the advertiser nodes and there are brand nodes *         
* to process initialize for brand reading and go back to system       *         
* handler as though it is the first time                              *         
***********************************************************************         
                                                                                
ALLNXT   GOTOR BRDINI              Initialize brand table                       
         JNE   NOMORE                                                           
         MVI   CFMINDS,CFMINXT     Set first time flag                          
         XC    CFMTREC1,CFMTREC1   Initialize client record                     
         XC    CFMTREC2,CFMTREC2   Initialize vendor record                     
         MVI   CFMLMEDC,0          Initialize media                             
         XC    CFMLCLIC,CFMLCLIC   Initialize client                            
         GOTOR CFMASYS             Return to system handler                     
         EJECT                                                                  
***********************************************************************         
* Interface to TSAR                                                   *         
*                                                                     *         
* Ntry:- R1 points to a parameter list as follows:-                   *         
*                                                                     *         
*        P1/0   - Buffer number                                       *         
*        P1/1-3 - TSAR action code                                    *         
*        P2/0   - Key length (initialization call)                    *         
*        P2/2-3 - Record length (initialization call)                 *         
*        - or -                                                       *         
*        P2     - Optional address of record (buy buffer)             *         
***********************************************************************         
                                                                                
BUFFER   NTR1  LABEL=*                                                          
         LR    R2,R1               R2=A(Parameter list)                         
                                                                                
         LARL  R3,BUFFTAB                                                       
         USING BUFFTABD,R3         Locate buffer definition                     
         LHI   R0,BUFFTABN                                                      
BUFFER02 CLC   BUFFTBUF,0(R2)      Match on buffer number                       
         JE    BUFFER04                                                         
         AHI   R3,BUFFTABL                                                      
         JCT   R0,BUFFER02                                                      
         DC    H'0'                                                             
                                                                                
BUFFER04 SR    R1,R1               Get disp. to record                          
         ICM   R1,3,BUFFTREC                                                    
         JZ    *+12                                                             
         LA    RE,CFMIOD(R1)                                                    
         J     *+8                                                              
         L     RE,4(R2)            Use caller's area if not defined             
                                                                                
         TM    LP_FLAG,LP_FOFFL    Test off-line                                
         JNZ   BUFFER06                                                         
                                                                                
         ICM   R1,3,BUFFTBLK       Point to block                               
         JNZ   *+6                                                              
         DC    H'0'                                                             
         LA    R4,CFMIOD(R1)                                                    
         J     BUFFER08                                                         
                                                                                
BUFFER06 SR    R1,R1                                                            
         ICM   R1,3,BUFFTLOC       Get disp. to local block copy                
         JNZ   *+6                                                              
         DC    H'0'                                                             
         LA    R4,BUFFTLOC(R1)     and point to it                              
                                                                                
         USING TSARD,R4            R3=A(TSAR control block)                     
BUFFER08 ST    R4,ATSARD           Set address for caller                       
         MVC   TSACTN,3(R2)        Set action code                              
         ST    RE,TSAREC           Set a(record)                                
         CLI   TSACTN,TSAINI       Test initialization call                     
         JNE   BUFFER10                                                         
         XC    TSARD(TSPNEWL),TSARD                                             
         MVI   TSACTN,TSAINI                                                    
         MVC   TSACOM,CFMACOM                                                   
         MVC   TSKEYL,4(R2)        Set key length                               
         MVC   TSRECL,6(R2)        Set record size                              
         MVI   TSINDS,TSINODSK                                                  
         MVI   TSIND2,TSI2BIGN+TSI2MANY                                         
         MVC   TSRECI,BUFFTIND     Set TSAR buffer flag                         
         MVC   TSBUFFL,BUFFTSIZ    Set buffer size (nK)                         
                                                                                
BUFFER10 GOTOR CFMATSAR,TSARD      Call TSAR to process action                  
         MVC   BUFFRET,TSERRS                                                   
         TM    BUFFRET,TSEINIF     Test initialization failure                  
         JZ    *+6                                                              
         DC    H'0'                Yes - take a hit                             
         CLI   BUFFRET,0           Set condition code                           
         J     EXIT                                                             
         DROP  R3,R4                                                            
                                                                                
         DS    0H                                                               
BUFFTAB  DS    0XL(BUFFTABL)       ** Buffer table **                           
         DC    AL1(CLIBUFQ),AL2(CLIBUF-*)                                       
         DC    AL2(CFMTBLK1-CFMIOD,CFMTREC1-CFMIOD)                             
         DC    AL1(TSRTSARB+TSRXTN),AL2(ONEK)   One megabyte                    
         DC    AL1(VENBUFQ),AL2(VENBUF-*)                                       
         DC    AL2(CFMTBLK2-CFMIOD,CFMTREC2-CFMIOD)                             
         DC    AL1(TSRWSSVR+TSRXTN),AL2(4*ONEK) Four megabytes                  
         DC    AL1(SUPBUFQ),AL2(SUPBUF-*)                                       
         DC    AL2(CFMTBLK3-CFMIOD,CFMLVEND-CFMIOD)                             
         DC    AL1(TSRMINB2+TSRXTN),AL2(4*ONEK) Four megabytes                  
         DC    AL1(BUYBUFQ),AL2(BUYBUF-*)                                       
         DC    AL2(CFMTBLK4-CFMIOD,0)                                           
         DC    AL1(TSRMINB1+TSRXTN),AL2(8*ONEK) Eight megabytes                 
BUFFTABN EQU   (*-BUFFTAB)/L'BUFFTAB                                            
                                                                                
BUFFTABD DSECT                     ** Buffer table layout **                    
BUFFTBUF DS    X                   Buffer number                                
BUFFTLOC DS    AL2                 Displacement to local TSAR block             
BUFFTBLK DS    AL2                 Displacement to CFMIOD TSAR block            
BUFFTREC DS    AL2                 Displacement to record in CFMIOD             
BUFFTIND DS    X                   TSAR indicator byte                          
BUFFTSIZ DS    AL2                 Buffer size when running off-line            
BUFFTABL EQU   *-BUFFTABD          Length of table entry                        
CFMIO    CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Routine to optimize the sending values in an output record          *         
*                                                                     *         
* Ntry:- R1 points to a parameter list as follows:-                   *         
*                                                                     *         
*        P1     - A(output record)                                    *         
*        P2     - A(optimization table)                               *         
***********************************************************************         
                                                                                
OPTMIZ   NTR1  LABEL=*                                                          
         LM    R2,R3,0(R1)         R2=A(Record),R3=A(Table)                     
         LA    R4,CFMLDATA         R4=A(Last time values)                       
                                                                                
OPTMIZ02 CLC   0(2,R3),XFFS        Test end of table                            
         JE    EXIT                                                             
         LLC   RF,0(R3)            Get displacement to data                     
         LA    RF,0(R2,RF)         RF=A(Record data value)                      
         LLC   R1,1(R3)            R1=Length of data-1                          
         BASR  RB,0                                                             
         CLC   0(0,RF),0(R4)                                                    
         EX    R1,0(RB)            Test value is same as last time              
         JNE   OPTMIZ04            No                                           
         BASR  RB,0                                                             
         XC    0(0,RF),0(RF)                                                    
         EX    R1,0(RB)            Yes - clear the sending value                
         J     OPTMIZ06                                                         
                                                                                
OPTMIZ04 BASR  RB,0                Sending value is different                   
         MVC   0(0,R4),0(RF)       Save the new value                           
         EX    R1,0(RB)                                                         
                                                                                
OPTMIZ06 LA    R4,1(R1,R4)         Bump to next saved value                     
         AHI   R3,2                Bump to next table entry                     
         J     OPTMIZ02                                                         
         EJECT                                                                  
***********************************************************************         
* Initialize client buffer                                            *         
***********************************************************************         
                                                                                
INICLB   NTR1  LABEL=NO                                                         
         CLI   CFMSYS,MPTRSSPT     Test Spotpak                                 
         JNE   *+12                                                             
         LHI   R0,CLIBSKLQ         Lengths for Spotpak                          
         LHI   RF,CLIBSRLQ                                                      
         CLI   CFMSYS,MPTRSNET     Test Netpak                                  
         JNE   *+12                                                             
         LHI   R0,CLIBNKLQ         Lengths for Netpak                           
         LHI   RF,CLIBNRLQ                                                      
         CLI   CFMSYS,MPTRSPRT     Test Printpak                                
         JNE   *+12                                                             
         LHI   R0,CLIBPKLQ         Lengths for Printpak                         
         LHI   RF,CLIBPRLQ                                                      
         GOTOR BUFFER,DMCB,('CLIBUFQ',TSAINI),((R0),(RF))                       
         JE    EXIT                                                             
         DC    H'0'                                                             
         EJECT                                                                  
***********************************************************************         
* Build a list of estimates in the WMP                                *         
***********************************************************************         
                                                                                
BLDEST   NTR1  LABEL=*                                                          
                                                                                
         ICM   RE,15,CFMAEST       Point to estimate list                       
         JNZ   BLDEST02                                                         
         L     RE,LP_AWMP                                                       
         STCM  RE,15,CFMAEST                                                    
         AHI   RE,255+LW_LN2Q                                                   
         ST    RE,LP_AWMP                                                       
                                                                                
         USING LW_D,RE                                                          
BLDEST02 STCM  RE,7,AEST           Point to WMP                                 
         MVI   ESTIND,LQ_TLSTQ                                                  
         LHI   R0,LW_LN2Q+255                                                   
         STCM  R0,3,LW_LN                                                       
         XC    LW_NUMN,LW_NUMN     Set no entries in list                       
         MVI   LW_TYPE,LQ_TLSTQ                                                 
                                                                                
         XC    ESDSDTE,ESDSDTE     Build estimate start date range              
         MVC   ESDEDTE,ENDTC                                                    
         MVC   EEDSDTE,STDTC       Build estimate end date range                
         MVC   EEDEDTE,XFFS                                                     
         USING EPKEY,CFMRKEY                                                    
         XC    EPKEY,EPKEY                                                      
                                                                                
BLDEST04 GOTOR LP_ASETK,DMCB,(0,SPTESTT),EPKEY,WORKD,('FF',LP_D)                
         JH    BLDEST06                                                         
         GOTOR DMGR,DMCB,DMRDHI,SPTDIR,EPKEY,EPKEY                              
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR LP_ASETK,DMCB,(1,SPTESTT),EPKEY,WORKD,('FF',LP_D)                
         JNE   BLDEST04                                                         
         TM    EPKCNTRL,EPKSTSTW   Ignore stewardship estimates                 
         JNZ   BLDEST04                                                         
         GOTOR LP_AAWMP,DMCB,(L'EPKEYEST,EPKEYEST),ESTIND,255,LP_D              
         J     BLDEST04                                                         
                                                                                
BLDEST06 ICM   RE,7,AEST           Exit with cc=zero if no estimates            
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(RE)                                            
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Exits                                                               *         
***********************************************************************         
                                                                                
NOMORE   MVI   LP_RMODE,LP_RLAST   Set no more records to come                  
         J     EXITN                                                            
                                                                                
EXITSET  CLI   CFMERR,0            Set CC based on CFMERR                       
         J     EXIT                                                             
                                                                                
EXITN    LHI   RE,0                Set CC not equal                             
         J     EXITCC                                                           
EXITY    LHI   RE,1                Set CC equal                                 
EXITCC   CHI   RE,1                                                             
                                                                                
EXIT     XIT1  ,                                                                
         EJECT                                                                  
NETMEDQ  EQU   C'N'                Network media code                           
                                                                                
FF       EQU   X'FF'                                                            
ONEK     EQU   1024                                                             
                                                                                
IOEEOF   EQU   X'80'               End-of-file                                  
IOEDSK   EQU   X'40'               Non-recoverable disk error                   
IOEDUP   EQU   X'20'               Duplicate key on add                         
IOERNF   EQU   X'10'               Record not found                             
IOEDEL   EQU   X'02'               Record is deleted                            
IOERRS   EQU   FF                  Any error condition                          
                                                                                
GLOBALS  DS    0D                  ** Global literal values **                  
         LTORG                                                                  
                                                                                
PZERO    DC    P'0'                                                             
P10000   DC    P'10000'                                                         
EZEROS   DC    C'000'                                                           
XFFS     DC    X'FFFFFFFF'                                                      
SPACES   DC    C'        '                                                      
POLPRDC  DC    C'POL'                                                           
                                                                                
DMRDHI   DC    C'DMRDHI  '                                                      
DMRSEQ   DC    C'DMRSEQ  '                                                      
DMREAD   DC    C'DMREAD  '                                                      
GETREC   DC    C'GETREC  '                                                      
                                                                                
GENDIR   DC    C'GENDIR  '                                                      
GENFIL   DC    C'GENFIL  '                                                      
                                                                                
STAFIL   DC    C'STATION '                                                      
SPTDIR   DC    C'SPTDIR  '                                                      
SPTFIL   DC    C'SPTFIL  '                                                      
                                                                                
UNTDIR   DC    C'UNTDIR  '                                                      
UNTFIL   DC    C'UNTFIL  '                                                      
                                                                                
PRTDIR   DC    C'PRTDIR  '                                                      
PRTFIL   DC    C'PRTFIL  '                                                      
                                                                                
PUBDIR   DC    C'PUBDIR  '                                                      
PUBFIL   DC    C'PUBFIL  '                                                      
         EJECT                                                                  
***********************************************************************         
* Key driver tables                                                   *         
***********************************************************************         
                                                                                
SPTESTT  LKKEY H,EPKEY,WORKD       ** Spot estimate driver **                   
         LKKEY LIT,EPKEYTYP,EPKEYTYQ                                            
         LKKEY LIT,EPKEYSUB,EPKEYSBQ                                            
         LKKEY SIN,EPKEYAM,MED                                                  
         LKKEY SIN,EPKEYCLT,CLI                                                 
         LKKEY RNG,EPKEYSDT,ESDSDTE                                             
         LKKEY RNG,EPKEYEDT,EEDSDTE                                             
         LKKEY NZR,EPKEYEST                                                     
         LKKEY NZR,EPKEYPRD                                                     
         LKKEY E                                                                
                                                                                
SPTBUYT  LKKEY H,BUYKEY            ** Spot buy driver **                        
         LKKEY SIN,BUYKAM,MED                                                   
         LKKEY SIN,BUYKCLT,CLI                                                  
         LKKEY WMP,BUYKPRD,APRD                                                 
         LKKEY XTN,BUYKMSTA,LLBIND                                              
         LKKEY WMP,BUYKEST,AEST                                                 
         LKKEY SIN,BUYKBUY,BUYFLD,L'BUYFLD                                      
         LKKEY ALL,BUYKBUY+L'BUYFLD,,L'BUYKBUY-L'BUYFLD                         
         LKKEY E                                                                
                                                                                
NETSTAT  LKKEY H,STAKEY            ** Network station driver **                 
         LKKEY LIT,STAKTYPE,STAKTYPQ                                            
         LKKEY LIT,STAKMED,NETMEDQ                                              
         LKKEY NZR,STAKCALL                                                     
         LKKEY SIN,STAKAGY,AGY                                                  
         LKKEY LIT,STAKCLT,C'0',L'STAKCLT+L'STAKFILL                            
         LKKEY E                                                                
                                                                                
NETBUYT  LKKEY H,NUKPKEY           ** Network unit driver **                    
         LKKEY LIT,NUKPTYPE,X'84'                                               
         LKKEY SIN,NUKPAM,MED                                                   
         LKKEY SIN,NUKPCLT,CLI                                                  
         LKKEY XTN,NUKPNET,LLBIND                                               
         LKKEY NZR,NUKPPROG                                                     
         LKKEY RNG,NUKPDATE,STDTC                                               
         LKKEY WMP,NUKPEST,AEST                                                 
         LKKEY NZR,NUKPSUB                                                      
         LKKEY NZR,NUKPDP                                                       
         LKKEY E                                                                
                                                                                
PRTBUYT  LKKEY H,PBUYKEY           ** Print insertion driver **                 
         LKKEY SIN,PBUYKAGY,AGY                                                 
         LKKEY SIN,PBUYKMED,MED                                                 
         LKKEY LIT,PBUYKRCD,PBUYKRCQ                                            
         LKKEY SIN,PBUYKCLT,CLI                                                 
         LKKEY WMP,PBUYKPRD,APRD                                                
         LKKEY XTN,PBUYKPUB,LLBIND,L'PBUYKPUB+L'PBUYKZON+L'PBUYKEDT             
         LKKEY RNG,PBUYKDAT,STDTB                                               
         LKKEY NZR,PBUYKEST                                                     
         LKKEY LIT,PBUYKACT,0                                                   
         LKKEY ALL,PBUYKLIN                                                     
         LKKEY E                                                                
         EJECT                                                                  
         DS    0D                                                               
         DC    C'*CLIBUF*'                                                      
CLIBUFQ  EQU   1                   ** Client buffer **                          
CLIBUF   DS    XL(TSPXTNL)                                                      
                                                                                
         DC    C'*VENBUF*'                                                      
VENBUFQ  EQU   2                   ** Vendor buffer **                          
VENBUF   DS    XL(TSPXTNL)                                                      
                                                                                
SUPBUFQ  EQU   3                   ** Supplier buffer **                        
         DC    C'*SUPBUF*'                                                      
SUPBUF   DS    XL(TSPXTNL)                                                      
                                                                                
BUYBUFQ  EQU   4                   ** Buy buffer **                             
         DC    C'*BUYBUF*'                                                      
BUYBUF   DS    XL(TSPXTNL)                                                      
                                                                                
         DS    0H                                                               
RANGE51F DC    X'0000000001',X'FFFFFFFFFF'                                      
         DS    0H                                                               
RANGE5NW DC    X'0000000001',X'0000FFFFFF'                                      
         DS    0H                                                               
RANGE61F DC    X'000000000001',X'FFFFFFFFFFFF'                                  
         EJECT                                                                  
WORKD    DSECT                     ** Working storage **                        
                                                                                
DUB      DS    D                                                                
DMCB     DS    6F                                                               
WORK     DS    XL64                                                             
BYTE     DS    X                                                                
                                                                                
ADDAY    DS    A                                                                
GETDAY   DS    A                                                                
DATCON   DS    A                                                                
DMGR     DS    A                                                                
BINSRCH  DS    A                                                                
                                                                                
SAVERD   DS    A                                                                
                                                                                
ATSARD   DS    A                   A(current TSAR control block)                
ANEXT    DS    A                   A(next market/station)                       
                                                                                
UNTVALS  DS    0F                  ** Unit values **                            
UNTVAX01 DS    A                   A(NUMAINEL)                                  
UNTVAX14 DS    A                   A(NUPRDD)                                    
UNTVAX19 DS    A                   A(NUPDED)                                    
UNTVPPCT DS    XL(L'NUP1SHR)       Product 1 share                              
UNTVALL  EQU   *-UNTVALS                                                        
                                                                                
AGY      DS    CL(L'LP_AGY)        Agency code                                  
                                                                                
VALS     DS    0X                  ** Values saved in CFMIOD **                 
         ORG   VALS+(CFMLMEDC-CFMLVALS)                                         
MED      DS    XL(L'CFMLMEDC)      Current media                                
         ORG   VALS+(CFMLCLIC-CFMLVALS)                                         
CLI      DS    XL(L'CFMLCLIC)      Current client                               
         ORG   VALS+(CFMLSTAC-CFMLVALS)                                         
LLBIND   DS    XL(LL_LNQ)          Vendor key driver extension block            
         ORG   VALS+(CFMAEST-CFMLVALS)                                          
ESTIND   DS    X                   Estimate indicator                           
AEST     DS    AL3                 A(Estinate area in WMP)                      
         ORG   VALS+(CFMLPNOD-CFMLVALS)                                         
PRDIND   DS    X                   Product indicator                            
APRD     DS    AL3                 A(Product area in WMP)                       
VALL     EQU   *-VALS                                                           
                                                                                
PRD      DS    X                   Product from current directory ptr           
BUYFLD   DS    X                   BUYKBUY field (X'00' or X'FF')               
                                                                                
DATES    DS    0X                  ** Dates for driver tables **                
STDTB    DS    XL(L'CFMSTDTB)                                                   
ENDTB    DS    XL(L'CFMENDTB)                                                   
STDTC    DS    XL(L'CFMSTDTC)                                                   
ENDTC    DS    XL(L'CFMENDTC)                                                   
DATESL   EQU   *-DATES                                                          
                                                                                
ESDSDTE  DS    XL(L'EPKEYSDT)      Estimate start/end date range                
ESDEDTE  DS    XL(L'EPKEYSDT)                                                   
EEDSDTE  DS    XL(L'EPKEYEDT)      Estimate end date range                      
EEDEDTE  DS    XL(L'EPKEYEDT)                                                   
                                                                                
NETMNODE DS    XL(L'CFMKRNOD)      Netpak media node for clients                
                                                                                
COSTFLAG DS    X                   ** Cost flag **                              
COSTFPRQ EQU   X'80'               Processing NUPRDEL (Netpak)                  
COSTFZGQ EQU   X'40'               Buys/Units/Insertions zero gross             
COSTFZNQ EQU   X'20'               Buys/Units/Insertions zero net               
COSTFZEQ EQU   COSTFZGQ+COSTFZNQ   Net and gross costs are zero                 
                                                                                
SAVEMED  DS    XL(L'CFMMTMED)      Saved media (agy/med for Spot)               
SAVECLII DS    CL(L'CFMKCLTI)      Saved internal client code                   
         DS    XL3                 Spare-Print VALCLI blows this away           
SAVECLIE DS    CL(L'CFMKCLTE)      Saved external client code                   
SAVECNOD DS    CL(L'CFMKPNOD)      Saved client parent node                     
SAVEPROD DS    XL(L'NETPRDCD)      Saved product code                           
SAVEPNOD DS    XL(L'CFMKPNOD)      Saved parent node                            
SAVEKEY  DS    XL(L'CFMKEY)        Saved brand key                              
SAVLMED  DS    XL(L'CFMMTMED)      Saved last media (agy/med for Spot)          
                                                                                
NUMPRD   DS    H                   Product counter for brand request            
                                                                                
SPTWORK  DS    XL(SPTRRECL)        Spotpak work area                            
                                                                                
SVNETKEY DS    XL(L'BUYKEY)        Saved network buy key (directory)            
SVBUYKEY DS    XL(L'BUYKEY)        Saved network buy key (file)                 
                                                                                
NETFLAG  DS    X                   Network buy flag                             
                                                                                
         DS    0F                                                               
SYSVALS  DS    XL128               System GETRATE values                        
                                                                                
PGROSS   DS    PL8                 Packed gross cost                            
PNET     DS    PL8                 Packed net cost                              
                                                                                
         ORG   SYSVALS                                                          
SPTVALS  DS    0F                  ** Spotpak cost values **                    
SPTVSPT  DS    F                                                                
SPTVGRS  DS    F                                                                
SPTVNET  DS    F                                                                
SPTVADJ  DS    F                                                                
SPTVALL  EQU   *-SPTVALS                                                        
                                                                                
         ORG   SYSVALS                                                          
NETVALS  DS    0F                  ** Netpak cost values **                     
NETVGRS  DS    F                                                                
NETVNET  DS    F                                                                
NETVALL  EQU   *-NETVALS                                                        
                                                                                
         ORG   SYSVALS                                                          
PRTVALS  DS    XL(PRTVALSL)        ** Printpak cost values **                   
         ORG                                                                    
                                                                                
BUFFRET  DS    X                   BUFFER S/R return indicators                 
                                                                                
KEYSTMAX EQU   32                  Key stack for tree reading                   
KEYSTACK DS    (KEYSTMAX)XL(L'CFMKEY)                                           
                                                                                
TSARKSAV DS    XL64                TSAR record key save area                    
MVDATA   DS    XL256               MediaVantage data record                     
PCTTAB   DS    (PCTTABM)XL(PCTTABL),X                                           
                                                                                
KEY      DS    XL64                                                             
KEYSAVE  DS    XL64                                                             
DA       DS    XL4                                                              
IO       DS    XL(6*ONEK)                                                       
                                                                                
NETLST   DS    0X                                                               
PRDLST   DS    1024XL(L'CLIBNPRN+L'CLIBNPRE)                                    
                                                                                
WORKL    EQU   *-WORKD                                                          
         EJECT                                                                  
CLIBRECD DSECT                     ** Client buffer record **                   
                                                                                
CLIBSAGM DS    X                   Spotpak agency/media code                    
CLIBSCLI DS    XL(L'CFMKCLTI)      Client code (internal value)                 
CLIBSPRN DS    XL(L'CFMKBRDI)      Brand number (0=client)                      
CLIBSNOD DS    XL(L'CFMKPNOD)      Client node                                  
CLIBSCLE DS    CL(L'CFMKCLTE)      External client code                         
         ORG   CLIBSCLE                                                         
CLIBSPRE DS    CL(L'CFMKBRDE)      External brand code                          
         ORG                                                                    
CLIBSKLQ EQU   *-CLIBRECD          Key length                                   
CLIBSRLQ EQU   *-CLIBRECD          Record length                                
                                                                                
         ORG   CLIBRECD                                                         
CLIBNAGM DS    X                   Netpak agency/media code                     
CLIBNCLI DS    XL(L'CFMKCLTI)      Client code (internal value)                 
CLIBNPRE DS    CL(L'CFMKBRDE)      External brand code (0=client)               
CLIBNPRN DS    XL(L'CFMKBRDI)      Brand number                                 
CLIBNNOD DS    XL(L'CFMKPNOD)      Client/brand node                            
CLIBNCLE DS    CL(L'CFMKCLTE)      External client code                         
CLIBNKLQ EQU   *-CLIBRECD          Key length                                   
CLIBNRLQ EQU   *-CLIBRECD          Record length                                
                                                                                
         ORG   CLIBRECD                                                         
CLIBPMED DS    CL(L'MPTRMED)       Printpak media code                          
CLIBPCLI DS    CL(L'CFMKCLTE)      Client code                                  
CLIBPPRC DS    CL(L'CFMKBRDE)      Brand code (0=client)                        
CLIBPNOD DS    XL(L'CFMKPNOD)      Client/brand node                            
CLIBPKLQ EQU   *-CLIBRECD                                                       
CLIBPRLQ EQU   *-CLIBRECD                                                       
                                                                                
VENSRECD DSECT                     ** Spotpak vendor record **                  
VENSKEY  DS    0X                                                               
VENSAGM  DS    X                   Agency/media code                            
VENSSTA  DS    XL(L'BUYKSTAC)      Station code                                 
VENSCLI  DS    CL(L'STAKCLT)       Client code (or binary zeroes)               
VENSKEYL EQU   *-VENSKEY                                                        
VENSMKT  DS    XL(L'BUYKMKT)       Market number                                
VENSCALL DS    CL(L'STAKCALL)      Station call letters                         
VENSNODE DS    XL(L'CFMKPNOD)      Vendor node                                  
VENSRECL EQU   *-VENSRECD                                                       
                                                                                
VENNRECD DSECT                     ** Netpak vendor record **                   
VENNKEY  DS    0X                                                               
VENNNET  DS    CL(L'NUKNET)        Network code                                 
VENNKEYL EQU   *-VENNKEY                                                        
VENNNODE DS    XL(L'CFMKPNOD)      Vendor node                                  
VENNRECL EQU   *-VENNRECD                                                       
                                                                                
VENPRECD DSECT                     ** Printpak vendor record **                 
VENPKEY  DS    0X                                                               
VENPMED  DS    C                   Media code                                   
VENPPUB  DS    XL6                 Publication/Zone/Edition code                
VENPKEYL EQU   *-VENPKEY                                                        
VENPNODE DS    XL(L'CFMKPNOD)      Vendor node                                  
VENPSTAT DS    X                   Status                                       
VENPSSNT EQU   X'80'               Publication details sent                     
VENPSDUM EQU   FF-(VENPSSNT)       Dummy status                                 
VENPRECL EQU   *-VENPRECD                                                       
                                                                                
BRDTABD  DSECT                     ** Brand entry **                            
BRDPNOD  DS    XL(L'CFMKRNOD)      Node                                         
BRDCLTE  DS    XL(L'CFMKBCLT)      Client code                                  
BRDBRDE  DS    XL(L'CFMKBRDE)      Brand code                                   
BRDTABL  EQU   *-BRDTABD                                                        
                                                                                
PCTTABD  DSECT                     ** Product percent table **                  
PCTTPLEQ EQU   FF                  Last entry                                   
PCTTPRD  DS    CL(L'NUPDEPR)       Product code                                 
PCTTPCT  DS    XL2                 Product percentage (2dp)                     
PCTTABL  EQU   *-PCTTABD           Length of table entry                        
PCTTABM  EQU   16                  Maximum number of products supported         
         EJECT                                                                  
* GECFMIOD                                                                      
         PRINT OFF                                                              
       ++INCLUDE GECFMIOD                                                       
         PRINT ON                                                               
                                                                                
* GEGENCFM                                                                      
         PRINT OFF                                                              
       ++INCLUDE GEGENCFM                                                       
         PRINT ON                                                               
                                                                                
* DDCOMFACS                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCOMFACS                                                      
         PRINT ON                                                               
                                                                                
* DDLINKD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DDLINKD                                                        
         PRINT ON                                                               
                                                                                
* DDRUNNERD                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDRUNNERD                                                      
         PRINT ON                                                               
                                                                                
* DDTSARD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DDTSARD                                                        
         PRINT ON                                                               
                                                                                
* DDWRKIOD                                                                      
         PRINT OFF                                                              
WRKIOD   DSECT                                                                  
       ++INCLUDE DDWRKIOD                                                       
         PRINT ON                                                               
                                                                                
* PPBVAL                                                                        
         PRINT OFF                                                              
PPBVALDD DSECT                                                                  
       ++INCLUDE PPBVALD                                                        
         PRINT ON                                                               
                                                                                
* PESTREC                                                                       
         PRINT OFF                                                              
PESTRECD DSECT                                                                  
       ++INCLUDE PESTREC                                                        
         PRINT ON                                                               
                                                                                
* PBUYREC                                                                       
         PRINT OFF                                                              
PBUYKRCQ EQU   X'20'                                                            
PBUYRECD DSECT                                                                  
       ++INCLUDE PBUYREC                                                        
         PRINT ON                                                               
                                                                                
* PBDELEM                                                                       
         PRINT OFF                                                              
PBDELQ   EQU   X'20'                                                            
       ++INCLUDE PBDELEM                                                        
         PRINT ON                                                               
                                                                                
* PUBREC                                                                        
         PRINT OFF                                                              
PUBRECD  DSECT                                                                  
PUBKCODQ EQU   X'81'                                                            
       ++INCLUDE PUBREC                                                         
       ++INCLUDE PUBNAMEL                                                       
         PRINT ON                                                               
                                                                                
* PVALUES                                                                       
         PRINT OFF                                                              
PRTVALSD DSECT                                                                  
*PREFIX=PRT                                                                     
       ++INCLUDE PVALUES                                                        
*PREFIX=                                                                        
PRTVALSL EQU   *-PRTPVALUES                                                     
         PRINT ON                                                               
                                                                                
* NEGENUNIT                                                                     
         PRINT OFF                                                              
       ++INCLUDE NEGENUNIT                                                      
         PRINT ON                                                               
NUMAIELQ EQU   X'01'               Unit record main element                     
NUSDRELQ EQU   X'02'               Unit record second main element              
NUPRDELQ EQU   X'14'               Product element                              
NUPDEELQ EQU   X'19'               New-style product element                    
*                                  ** Package status (NUPACKST) **              
NUPAFRZQ EQU   X'80'               Frozen                                       
NUPALOKQ EQU   X'20'               Locked                                       
NUPADNPQ EQU   X'10'               Do not print                                 
NUPANCIQ EQU   X'04'               Non-commissionable integration               
NUPAAIOQ EQU   X'02'               Audit is on                                  
NUPANSDQ EQU   X'01'               No-show/delete                               
                                                                                
NUPDED   DSECT                                                                  
NUPDEDL  EQU   *-NUPDED                                                         
NUPRDD   DSECT                                                                  
NUPRPLEN EQU   *-NUPRDPR                                                        
NUPRDDL  EQU   *-NUPRDD                                                         
                                                                                
* NETBLOCKD                                                                     
         PRINT OFF                                                              
NETIOD   DSECT                                                                  
       ++INCLUDE NETBLOCKD                                                      
         PRINT ON                                                               
                                                                                
* SPGENCLT                                                                      
         PRINT OFF                                                              
       ++INCLUDE SPGENCLT                                                       
         PRINT ON                                                               
                                                                                
* SPGENPRD                                                                      
         PRINT OFF                                                              
       ++INCLUDE SPGENPRD                                                       
         PRINT ON                                                               
                                                                                
* SPGENBUY                                                                      
         PRINT OFF                                                              
       ++INCLUDE SPGENBUY                                                       
         PRINT ON                                                               
                                                                                
* SPGENEST                                                                      
         PRINT OFF                                                              
       ++INCLUDE SPGENEST                                                       
         PRINT ON                                                               
                                                                                
* SPGENESTD                                                                     
         PRINT OFF                                                              
       ++INCLUDE SPGENESTD                                                      
         PRINT ON                                                               
                                                                                
* SPGENSTA                                                                      
         PRINT OFF                                                              
STARECD  DSECT                                                                  
       ++INCLUDE SPGENSTA                                                       
         PRINT ON                                                               
                                                                                
* GESTATSPT                                                                     
         PRINT OFF                                                              
SPSTATD  DSECT                                                                  
       ++INCLUDE GESTATSPT                                                      
         PRINT ON                                                               
                                                                                
* GESTATNET                                                                     
         PRINT OFF                                                              
NPSTATD  DSECT                                                                  
       ++INCLUDE GESTATNET                                                      
         PRINT ON                                                               
                                                                                
* GESTATPRT                                                                     
         PRINT OFF                                                              
PPSTATD  DSECT                                                                  
       ++INCLUDE GESTATPRT                                                      
         PRINT ON                                                               
                                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'001GECFMIO   10/07/08'                                      
         END                                                                    
