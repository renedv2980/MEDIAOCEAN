*          DATA SET SPSYSDRV3  AT LEVEL 046 AS OF 03/21/17                      
*CATALP SPSYSD3                                                                 
         TITLE 'SPSYSDRV3 - SYSTEM DRIVER FOR SPOTPAK WRITER PART 3'            
*                                                                               
*********************************************************************           
*                                                                   *           
*          SPSYSDRV3 - SYSTEM DRIVER FOR SPOT WRITER (PART 3)       *           
*                                                                   *           
***********************************************************************         
* USER    JIRA       DATE                  CHANGE LOG                 *         
* ---- ----------  -------- ----------------------------------------- *         
* AKAT DSSUP-6879  02/02/16 BFORUMLA BUG FIX                          *         
* 28JAN15 44 AKT -- SUPPORT FOR NEW INVNUM8 AND INVNUM10 KEYWORD    *           
* 27AUG13 43 AKT -- SUPPORT FOR NEW NTYPE KEYWORD                   *           
* 10JAN13 42 AKT -- SUPPORT REPORTING FOR MANUAL BILLING            *           
* 15DEC10 41 AKT -- SUPPORT FOR NEW BHXNET KEYWORD                  *           
* 04NOV09 40 AKT -- REPORT 2-BYTE BUYLINES AS 3 CHARS               *           
* 20OCT09 39 AKT -- SUPPORT 2-BYTE BUYLINES                         *           
* 28APR09 37 AKT -- SUPPORT NEW BHHST KEYWORD                       *           
* 14JAN09 37 AKT -- SUPPORT NEW BFORM OPTION                        *           
* 16APR08 36 AKT -- NEW BHINVM AND BHINVMND KEYWORD SUPPORT         *           
* 06NOV07 34 EFJ -- SUPPORT DPTCD KWD FOR LOCKIN RECS               *           
* 25JUL07 33 AKT -- SUPPORT NEW STATION BUFFER FORMAT               *           
* 27FEB07 32 AKT -- BILLGST NOW FULLWORD, NOT XL3                   *           
* 13SEP03 31 AKT -- BUY INFOMERCIAL KEYWORDS NOW DEFUNCT            *           
* 25NOV03 30 EFJ -- SUPPORT 6 CHAR INVNUM OUTPUT                    *           
* 11SEP03 29 AKT -- SET EDITOR TO ROUND OFF IF NUMBER GETS TOO BIG  *           
* 06JAN01 28 EFJ -- ALLOW 6 DIGIT AORPCT & NEGATIVE                 *           
* 06JAN01 26 EFJ -- COST2 SUPPORT                                   *           
* 14NOV00 25 EFJ -- SUPPORT DATE OPTS FOR BH DATES                  *           
*                -- USE WORK FOR DATCON CALLS, NOT DUB              *           
* 20JUN00 24 EFJ -- J1DIFF KEYWORD                                  *           
* 11JAN00 23 EFJ -- FIX ROUNDING FOR CLTPBIL                        *           
* 01NOV99 22 EFJ -- NEW BH KEYWORD FOR EDIT TRANSMIT DATE (BHEDATE) *           
* 28JUN99 21 EFJ -- INCLUDE BILLING ADJUSTMENT IN *NETCBIL          *           
* 24AUG98 20 EFJ -- *NETBUY & *NETLOCK WITHOUT TAX...               *           
*                -- MOVE ROUTINES TO DRV4 FOR ADDRESSABILITY        *           
* 14AUG98 19 EFJ -- USE PWPCT FROM REC IF REPORTING AT WEEKLY LEVEL *           
* 16JUL98 18 EFJ -- UNDO L16                                        *           
* 06JUL98 17 EFJ -- FIX BUG IN PW CPP                               *           
* 25JUN98 16 EFJ -- DON'T NET DOWN *NETLOCK & *NETBUY IF NO BILFORM *           
* 03JUN98 15 EFJ -- SUPPORT NEGATIVE PW PCT                         *           
* 01JUN98 14 NRK -- ADD STATION ZIP CODE ROUTINES                   *           
* 06MAY98 13 EFJ -- PASS B1 PROFILE TO SPFMTINO                     *           
* 05MAY98 12 EFJ -- Y2K                                             *           
* 25MAR98 11 EFJ -- DON'T NET DOWN TAX FOR *NETGLTX                 *           
* 18MAR98 10 EFJ -- REMOVE GETTAX ROUTINE                           *           
* 04FEB98 09 EFJ -- SUPPORT DPTCD FROM GOAL REC                     *           
* 23JAN98 08 EFJ -- FIX BUG IN NET GOAL CALCULATION                 *           
* 16DEC97 07 EFJ -- WESTERN PW CPS SUPPORT                          *           
* 21NOV97 06 EFJ -- WESTERN PW CPS SUPPORT                          *           
* 23SEP97 05 EFJ -- WESTERN PW CPP SUPPORT                          *           
* 22SEP97 04 EFJ -- MOVE SOME ROUTINES TO DRV4                      *           
* 09JUL97 03 EFJ -- CMLNM2 & CMLNM3                                 *           
* 06MAY97 02 EFJ -- SUPPORT NEWER INVOICE NUMBERS                   *           
* 06MAY97 01 EFJ -- LEVEL RESET                                     *           
*-------------------------------------------------------------------*           
* 10APR97 63 EFJ -- SUPPORT UP TO 255 FILM CODES IN INVOICES        *           
* 04DEC96 62 EFJ -- ONLY STORE YM FOR BHIMN KEYWORD                 *           
* 12AUG96 61 EFJ -- FIX UDEF BUG - LEN IS WRONG FOR TOTALS          *           
* 18JUN96 60 EFJ -- FIX BILLFORM OUTPUT WHEN 100%                   *           
* 28MAY96 59 EFJ -- DEMONAME KEYWORD                                *           
* 03MAY96 58 EFJ -- SUPPORT FILM CODES FROM INVOICES                *           
* 25APR96 57 EFJ -- PICK UP LOCK $ OVERRIDES FOR LOCK PCT           *           
*                -- DON'T CHECK FOR PW OVERRIDES - THEY WILL BE 0   *           
* 20APR96 56 EFJ -- ONLY SKIP SOME DATA FOR OVERRIDE                *           
* 12APR96 55 EFJ -- CHECK FOR OVERRIDE DATA PASSED FOR PW FROM SPBY *           
* 22MAR96 54 EFJ -- STILL MORE SFPFW.                               *           
* 14MAR96 53 EFJ -- FORCE BLANK INVOICE NUMBERS TO PRINT LAST       *           
* 28FEB96 52 EFJ -- MORE SFPFW.                                     *           
* 29JAN96 51 EFJ -- FIX BUG W/CLTLKTAX                              *           
* 12JAN96 50 EFJ -- NET DOWN CLT $ OVERRIDES FOR *NETBUY & *NETLOCK *           
* 11DEC95 49 EFJ -- SUPPORT INVOICE HEADER COST & SPOTS             *           
* 27NOV95 48 EFJ -- SUPPORT INVOICE NUMBERS & DATES                 *           
* 21NOV95 47 EFJ -- SUPPORT OLD STYLE INVOICE RECS                  *           
* 09NOV95 46 EFJ -- SUPPORT ROUNDING OF INV $$$                     *           
* 03NOV95 45 EFJ -- YA IIDR FIX - OC DATA W/SPACES                  *           
* 25OCT95 44 EFJ -- FIX IIDR - MOVE IN SPACES IF NO DATA            *           
* 23OCT95 43 EFJ -- SUPPORT INVOICE $$$ & SPOTS                     *           
* 02OCT95 42 EFJ -- FIX INETBUY (USE TOTAL GROSS $$$)               *           
*                -- INCLUDE OVERRIDE $$$ IN INETBUY                 *           
* 11SEP95 41 EFJ -- NEW PW KEYWORDS                                 *           
* 08SEP95 40 EFJ -- ADD SUPPORT FOR BUY CHANGED DATE                *           
* 14AUG95 39 EFJ -- SUPPORT FOR MILLER EXTENDED ID REF (IDR)        *           
* 25JUL95 38 EFJ -- SUPPORT FOR PACKED CHILD SPOT CPP               *           
* 19JUL95 37 EFJ -- SUPPORT FOR PACKED CPP KEYWORDS                 *           
* 28JUN95 36 EFJ -- FIX *NETLKTX BUG & *NETGLTX BUG                 *           
* 27JUN95 35 EFJ -- SUPPORT CLTPCT                                  *           
* 15JUN95 34 EFJ -- HDCMML KEYWORD TO SUPPORT CLASS SPLIT ON WRITER *           
* 13JUN95 33 EFJ -- SUPPORT BILLING OVERRIDE ADJ                    *           
* 13JUN95 32 EFJ -- NET DOWN TAXES BEFORE APPLYING BILL FORM        *           
* 12JUN95 31 EFJ -- FIX *NETGOAL BUG (USING WIM , NOT CLT $$$)      *           
* 12JUN95 30 EFJ -- *NETLOCK & *NETBUY NOT READING =COST OVERRIDES  *           
*                   & CLTLOCK                                       *           
* 30MAY95 29 EFJ -- FIX *NETGOAL BUG                                *           
* 25MAY95 28 EFJ -- SUPPORT *NETLKTX                                *           
* 24MAY95 27 EFJ -- SUPPORT BFORMULA & AFORMULA KEYWORDS            *           
* 23MAY95 26 EFJ -- SUPPORT GOAL EFFECTIVE COSTS                    *           
* 22MAY95 25 EFJ -- FIX NETLOCK CALC (INCL TAX)                     *           
* 17MAY95 24 EFJ -- BILLST KEYWORD                                  *           
* 09MAY95 23 EFJ -- SUPPORT PW LOCK STATUS                          *           
* 08MAY95 22 EFJ -- FIX BUG IN PWPCT & PROJPWPCT                    *           
* 02MAY95 21 EFJ -- SUPPORT EFFECTIVE TAX FOR PW                    *           
* 02MAY95 20 EFJ -- CLTLKTX THE WAY IT SHOULD BE                    *           
* 02MAY95 19 EFJ -- CLTLKTX IS REALLY WIMLKTX                       *           
* 28APR95 18 EFJ -- SUPPORT ESTPCT                                  *           
* 28APR95 17 EFJ -- SUPPORT WIMGOLN & CLTLKTX                       *           
* 27APR95 16 EFJ -- SUPPORT EFFECTIVE COST FOR PW                   *           
* 27APR95 15 EFJ -- REMOVE IAGYBUYN CODE (SHOULD HAVE BEEN IBYNET)  *           
* 24APR95 14 EFJ -- SUPPORT LOCKPCT KEYWORD                         *           
* 20APR95 13 EFJ -- STAADDR KEYWORD                                 *           
* 05APR95 12 EFJ -- YASFPW BUG                                      *           
* 27MAR95 11 EFJ -- SUPPORT PW LOCK DATES                           *           
*                -- FIX BUGS IN GETDBCR/REDO OVRD $$$               *           
* 22MAR95 10 EFJ -- FIX BUG ADDED IN L09                            *           
*                -- MORE PW CHANGES                                 *           
* 20MAR95 09 EFJ -- MOVE IN REST OF WI PW ROUTINES                  *           
* 06MAR95 08 EFJ -- SUPPORT NEW PW FEATURES                         *           
* 09FEB95 07 EFJ -- MORE PST SUPPORT                                *           
* 08FEB95 06 EFJ -- TEMP PST SUPPORT                                *           
* 20OCT94 05 EFJ -- NEW KEYWORD SUPPORT                             *           
* 18AUG94 04 EFJ -- ADD DEMO CODE FOR PACKED NUMBERS                *           
* 20JUL94 02 EFJ -- MOVE IN SOME WESTERN PW ROUTINES                *           
* 01JUL94 01 EFJ -- MERGE W/SPSYSDRIVC                              *           
*                                                                   *           
*                                                                   *           
*********************************************************************           
SPSYSD3  CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,**SPD3**,R7,R8                                                 
         USING GLOBALD,RA                                                       
         L     RC,GLAWORKD                                                      
         USING GEND,RC                                                          
         L     R9,ASYSD                                                         
         USING SYSD,R9                                                          
*                                                                               
         CLI   GLHOOK,GLRESOLV     RESOLVE ADDRESSES                            
         BE    RESOLVE                                                          
*                                                                               
         CLI   GLHOOK,GLROUT       EXECUTE ROUTINES                             
         BE    EXEC                                                             
*                                                                               
         CLI   GLHOOK,GLINCOMP     INTERNAL COMPUTES                            
         BE    EXEC                                                             
*                                                                               
XITYES   CR    RB,RB                                                            
         B     XIT                                                              
*                                                                               
XITNO    LTR   RB,RB                                                            
*                                                                               
XIT      XIT1  ,                                                                
XITR1    XIT1  REGS=(R1)                                                        
         EJECT                                                                  
* RESOLVE ROUTINE ADDRESSES                                                     
* ON INPUT, R2 = A(ROUTINE TABLE ENTRY)                                         
*                                                                               
         SPACE 1                                                                
         USING WRIRTBD,R2                                                       
RESOLVE  SR    R1,R1                                                            
         ICM   R1,3,WRRNUM                                                      
         SLL   R1,1                                                             
         LA    R1,ROUTTAB-2(R1)                                                 
         MVC   *+8(2),0(R1)                                                     
         LA    RF,0                                                             
         ST    RF,GLAROUT                                                       
         B     XIT                                                              
         DROP  R2                                                               
         EJECT                                                                  
* EXECUTING ROUTINES                                                            
* ON EXIT,  CC EQ - EXECUTE GENOUT ROUTINE IN THE ROOT                          
*           CC NE - JUST EXIT WITHOUT FURTHER PROCESSING                        
*                                                                               
         SPACE 1                                                                
EXEC     MVI   DATADISP+1,24                                                    
         ST    R1,ALVLSWS          SAVE A(PUT TO SORT SWITCHES)                 
         L     RF,GLAROUT          RF=A(ROUTINE)                                
*                                                                               
EXEC2    BR    RF                  EXECUTE THE ROUTINES                         
*                                                                               
GENOUT   CR    RB,RB               CC EQ                                        
         B     XIT                                                              
*                                                                               
EXIT     LTR   RB,RB               CC NE                                        
         B     XIT                                                              
         EJECT                                                                  
IIFCPO   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
HIFCPO   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFTR    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
HIFTR    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFBEC   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
HIFBEC   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFPRC   DS    0H                  PRICES ON *ALL* STA REC ONLY                 
         B     EXIT                                                             
*                                                                               
HIFPRC   DS    0H                                                               
         B     EXIT                                                             
         SPACE                                                                  
IIFTO    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFBUD   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFSTAT  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
OIFSTAT  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFTYPE  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
OIFTYPE  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFDATE  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFTIME  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
OIFTIME  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFCTR   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIBYCHK  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
OIBYCHK  DS    0H                                                               
         B     GENOUT                                                           
*                                                                               
HIFUPS   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFRSPDT DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFRSPDW DS    0H                                                               
         B     EXIT                                                             
*                                                                               
OIFRSPDW DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFRSPDM DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFCOST  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
OIFCOST  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFINC   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFUPINC DS    0H                                                               
         B     EXIT                                                             
*                                                                               
HIFUPINC DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFCCMD  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFUPMD  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
HIFUPMD  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFGMD   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IIFPRFIT DS    0H                                                               
         B     EXIT                                                             
                                                                                
IIFTINC  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
IESTLIN  DS    0H                                                               
         L     RE,SBAIO1           ADDRESS THE BUY RECORD                       
         USING BUYRECD,RE                                                       
         MVC   0(1,R2),BUYKEST                                                  
         MVI   1(R2),0                                                          
         MVC   2(1,R2),BUYKBUY                                                  
         TM    BUYRCNTL,BUYRLN2    2-BYTE BUYLINE?                              
         BZ    EXIT                NO                                           
         MVC   1(2,R2),BUYKBUY     YES - MOVE THE 2-BYTE BUYLINE                
         B     EXIT                                                             
         DROP  RE                                                               
         SPACE                                                                  
OESTLIN  DS    0H                                                               
         LLC   R1,0(R2)                                                         
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  0(3,R3),DUB                                                      
         MVI   3(R3),C'-'                                                       
         ICM   R1,3,1(R2)                                                       
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  4(3,R3),DUB                                                      
         B     EXIT                                                             
         SPACE                                                                  
IBYDATES DS    0H                                                               
         L     RE,SBAIO1           ADDRESS THE BUY RECORD                       
         USING BUYRECD,RE                                                       
         MVC   0(L'BDSTART+L'BDEND,R2),BDSTART                                  
         B     EXIT                                                             
         DROP  RE                                                               
         SPACE                                                                  
OBYDATES DS    0H                                                               
         GOTO1 DATCON,DMCB,(X'13',0(R2)),(4,0(R3))                              
         B     EXIT                                                             
         SPACE                                                                  
IBYWKS   DS    0H                                                               
         L     RE,SBAIO1           ADDRESS THE BUY RECORD                       
         USING BUYRECD,RE                                                       
         MVC   0(L'BDWKS,R2),BDWKS                                              
         B     EXIT                                                             
         DROP  RE                                                               
         SPACE                                                                  
IDPTCD   DS    0H                                                               
         L     RE,SBAIO1           ADDRESS THE BUY RECORD                       
         CLI   SBMODE,SBPROCSP     BUY OR GOAL REC?                             
         BNE   IDPTCD2              GOAL                                        
         USING BUYRECD,RE                                                       
         MVC   0(L'BDDAYPT,R2),BDDAYPT                                          
         B     IDPTCDX                                                          
*                                                                               
         USING GOALRECD,RE                                                      
IDPTCD2  CLI   SBMODE,SBPROCGL                                                  
         BNE   IDPTCD6                                                          
         MVC   0(L'GKEYDPT,R2),GKEYDPT                                          
         B     IDPTCDX                                                          
*                                                                               
         USING SLKRECD,RE                                                       
IDPTCD6  CLI   SBMODE,SBPROCSL                                                  
         BNE   IDPTCDX                                                          
         MVC   0(L'SLKKDPT,R2),SLKKDPT                                          
*                                                                               
IDPTCDX  B     EXIT                                                             
         DROP  RE                                                               
         EJECT                                                                  
*-------------------------------- BILL HEADER INPUT ROUTINES                    
         SPACE 2                                                                
         USING BILLRECD,R4                                                      
         USING MAAORLKD,R5                                                      
         SPACE 2                                                                
IBHINV   CLI   GLARGS+2,C'M'       INVOICE NUMBER                               
         BNE   *+14                                                             
         MVC   0(1,R2),SBMED                                                    
         LA    R2,1(R2)                                                         
         CLI   GLARGS+2,X'01'      BHINVM KEYWORD?                              
         BE    IBHINV10            YES                                          
         CLI   GLARGS+2,X'02'                                                   
         BE    IBHINV10                                                         
         MVC   0(6,R2),BINVNO                                                   
         B     IBHX                                                             
*                                                                               
IBHINV10 DS    0H                                                               
*                                                                               
         LAY   R1,SBB1PROF         PASS B1 PROFILE                              
         ST    R1,DMCB+8                                                        
         MVC   DMCB+8(1),SBMED     PASS MEDIA                                   
         LAY   R1,SBB1XPRF         PASS B1X PROFILE                             
         ST    R1,DMCB+12                                                       
         ST    R4,DMCB+16          PASS A(BILL REC)                             
*                                                                               
         GOTO1 =V(SPFMTINO),DMCB,(C'B',BDATE),(6,BINVNO)                        
         L     R1,DMCB                                                          
         CLI   GLARGS+2,X'02'      PRINT WITH NO DASHES?                        
         BE    *+14                YES                                          
         MVC   0(10,R2),0(R1)      NO - PRINT WITH DASHES                       
         B     EXIT                                                             
*                                                                               
         LR    RE,R1               INVOICE NUMBER                               
         LA    RF,10               L'INVOICE NUMBER                             
         LR    R3,R2               A(OUTPUT)                                    
*                                                                               
BHINV20  CLI   0(RE),C'-'          DASH?                                        
         BE    *+14                YES - DON'T MOVE IT                          
         MVC   0(1,R3),0(RE)       MOVE 1 NON-DASH CHAR TO OUTPUT               
         AHI   R3,1                BUMP OUTPUT POINTER                          
         AHI   RE,1                NEXT CHAR ON INVOICE NUMBER                  
         BCT   RF,BHINV20                                                       
*                                                                               
         B     EXIT                                                             
*                                                                               
IBHRETL  CLI   BRETAIL,0          IF NON-RETAIL BILL                            
         BE    *+10               THEN RETAIL ACC NUMBER NOT SET                
         MVC   0(12,R2),BRETACCT  RETAIL ACCOUNT                                
         B     IBHX                                                             
*                                                                               
ISTATYP  CLI   BRETAIL,0          IF RETAIL BILL                                
         BE    *+10               THEN STATION TYPE NOT SET                     
         MVC   0(1,R2),BLMED      STATION TYPE                                  
         B     IBHX                                                             
*                                                                               
IBHTYPE  MVC   0(4,R2),BLANKS     BILL TYPE                                     
         MVC   0(2,R2),BTYPE      B4-B7                                         
         CLI   GLARGS+2,C'M'      REPORT MANUAL BILLING?                        
         BNE   IBHTYPE1           NO                                            
         TM    BILSTAT,X'40'      MANUAL BILL?                                  
         BZ    IBHTYPE1           NO                                            
         MVC   0(3,R2),=C'MAN'    YES - REPORT "MAN"                            
         B     IBHTYPE2                                                         
*                                                                               
IBHTYPE1 TM    BILSTAT,BSTSCOMQ   TEST SEPARATE COMMISSION BILL                 
         BZ    *+14                                                             
         MVC   0(3,R2),=C'COM'                                                  
         B     IBHTYPE2                                                         
         TM    BILSTAT,BSTTAORQ   TEST AOR                                      
         BZ    IBHX                                                             
         MVC   0(3,R2),=C'AOR'                                                  
IBHTYPE2 MVC   3(1,R2),BTYPE+1                                                  
         B     IBHX                                                             
*                                                                               
*                                                                               
IAORTYP  TM    BILSTAT,BSTTAORQ   TRUE AOR BILL?                                
         BNO   *+12                                                             
         MVI   0(R2),C'T'         --YES                                         
         B     IAORTYPX                                                         
         TM    BILSTAT,BSTCAORQ   AOR CLIENT BILL?                              
         BNO   *+8                                                              
         MVI   0(R2),C'C'         --YES                                         
IAORTYPX B     IBHX                                                             
*                                                                               
*                                                                               
ICOMTYP  TM    BILSTAT,BSTCMONQ   COMMISSION ONLY BILL?                         
         BNO   *+12                                                             
         MVI   0(R2),C'O'         --YES                                         
         B     ICOMTYPX                                                         
         TM    BILSTAT,BSTSADJQ   COMMISSION ADJUSTMENT INV?                    
         BNO   *+8                                                              
         MVI   0(R2),C'A'         --YES                                         
ICOMTYPX B     IBHX                                                             
*                                                                               
*                                                                               
IBHGRS   LA    R6,B4                                                            
         MVC   0(4,R2),SBBILGRS    GROSS AMOUNT                                 
         CLI   GLARGS+2,C'N'       BHXNET KEYWORD?                              
         BNE   IBHGRS10            NO                                           
         XC    0(4,R2),0(R2)       YES - CLEAR INPUT                            
         L     R4,SBAIO1           AIO1 = BILLING RECORD                        
         TM    BILSTAT3,BSTTRCNQ   GROUP M TRADE WITH CALCULATED NET?           
         BZ    IBHGRS10            NO                                           
         MVC   0(4,R2),BCLDNET     CALCULATED NET                               
*                                                                               
IBHGRS10 BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHNET   LA    R6,B4                                                            
         MVC   0(4,R2),SBBILNET    NET AMOUNT                                   
         BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHACT   LA    R6,B4                                                            
         ICM   RE,15,BILLCOST      ACTUAL AMOUNT                                
         ICM   RF,15,BILLGST                                                    
         AR    RE,RF               ADD GST IF ANY                               
         ST    RE,0(R2)                                                         
*                                                                               
         TM    SBEFLAG,SBEPST                                                   
         BZ    IBH10                                                            
         ICM   RF,15,BILLPST                                                    
         AR    RE,RF                                                            
         ST    RE,0(R2)                                                         
*                                                                               
IBH10    BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHAGY   LA    R6,B4                                                            
         ICM   RE,15,BILLCOST                                                   
         TM    BILSTAT,BSTTAORQ   IF TRUE AOR BILL                              
         BO    IBHAGY5            AGY COM = ACTUAL AMOUNT                       
         ICM   RF,15,SBBILNET     OTHERWISE                                     
         SR    RE,RF              AGY COM = ACTUAL-NET AMOUNT                   
*                                                                               
IBHAGY5  STCM  RE,15,0(R2)                                                      
         BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
IBHTAX   LA    R6,B4                                                            
         MVC   0(4,R2),SBBILTAX   TAX AMOUNT                                    
         BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHGST   LA    R6,B4                                                            
         ICM   R1,15,BILLGST      GST AMOUNT                                    
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
IBHPST   LA    R6,B4                                                            
         CLI   GLARGS+2,C'H'             WANT HST                               
         BNE   *+14                      NO                                     
         MVC   0(L'BILLHST,R2),BILLHST   HST AMOUNT                             
         B     IBHX                                                             
         MVC   0(L'BILLPST,R2),BILLPST   PST AMOUNT                             
         BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
*                                 CLIENT CURRENCY FIELDS                        
IBHCGRS  LA    R6,B4                                                            
         MVC   0(4,R2),BCCGRS     GROSS                                         
         BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHCNET  LA    R6,B4                                                            
         MVC   0(4,R2),BCCNET     NET AMOUNT                                    
         BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHCACT  LA    R6,B4                                                            
         MVC   0(4,R2),BCCACT     ACTUAL AMOUNT                                 
         BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHCTAX  LA    R6,B4                                                            
         MVC   0(4,R2),BCCTAX    TAX AMOUNT                                     
         BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHPRDI  MVC   0(4,R2),SBPRDINT   PRODUCT INTERFACE CODE                        
         B     IBHX                                                             
*                                                                               
*                                                                               
IAOREFDT TM    BILSTAT,BSTTAORQ   IF AOR BILL - (CLIENT OR TRUE)                
         BO    IAOREFD5                                                         
         TM    BILSTAT,BSTCAORQ                                                 
         BNO   IBHX                                                             
IAOREFD5 MVC   0(2,R2),MAAOREFD   SET -AOR EFFECTIVE DATE                       
         B     IBHX                                                             
*                                                                               
*                                                                               
IAORBAS  MVC   0(1,R2),MAAORBAS   AOR BASIS                                     
         B     IBHX                                                             
*                                                                               
*                                                                               
IAORAMT  TM    BILSTAT,BSTCAORQ   DON'T SHOW FOR CLIENT BILL                    
         BO    IBHX                                                             
         MVC   0(4,R2),MAAORAMT   AOR AMOUNT                                    
         BAS   RE,BHROUND                                                       
         B     IBHX                                                             
*                                                                               
*                                                                               
IAORAGYN MVC   0(30,R2),MAAORAGY   AOR AGENCY NAME                              
         B     IBHX                                                             
*                                                                               
*                                                                               
IAORINCA MVC   0(14,R2),MAAORCOM   AOR INCOME/COMMISSION ACCOUNT                
         B     IBHX                                                             
*                                                                               
*                                                                               
IAORPCT  MVC   0(4,R2),MAAORPCT   AOR PERCENTAGE                                
         B     IBHX                                                             
*                                                                               
*                                                                               
IAORRPA  MVC   0(14,R2),MAAORRCV   AOR RECEIVABLE/PAYABLE ACCOUNT               
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHSING  ICM   R1,3,SINGNUM       UNIQUE NUMBER FOR BILL HEADER RECORDS         
         LA    R1,1(R1)                                                         
         STCM  R1,3,SINGNUM                                                     
         MVC   0(2,R2),SINGNUM                                                  
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHIDT   MVC   0(6,R2),BQDATE     INVOICE DATE                                  
         CLI   GLARGS+2,C'M'       YEAR/MONTH ONLY?                             
         BNE   IBHX                 NO                                          
         MVC   4(2,R2),=C'01'      MAKE SURE DATES COLLAPSE                     
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHRDT   MVC   0(6,R2),BDATE      RUN DATE                                      
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHDDT   MVC   0(3,R2),BDUEDATE   DUE DATE                                      
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHPDT   MVC   0(2,R2),BILPOST    POST DATE                                     
         B     IBHX                                                             
*                                                                               
*                                                                               
IBHSDT   MVC   0(4,R2),BMONSERV   MONTH OF SERVICE                              
         B     IBHX                                                             
*                                                                               
IBHEDT   MVC   0(2,R2),BEDIDTE    EDI TRANSMIT DATE                             
         B     IBHX                                                             
         EJECT                                                                  
* BILL HEADER INPUT ROUTINE EXIT                                                
*                                                                               
IBHX     LTR   R6,R6              TEST FOR ROW OR COLUMN                        
         BZ    EXIT                                                             
         CLI   INDATA,0           COLUMN-TEST ANY COL DATA YET                  
         BNE   EXIT                                                             
         LLC   RE,0(R6)                  NO - TEST ANY DATA IN THIS COL         
         EX    RE,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R2),1(R6)                                                    
         BE    *+8                                                              
         MVI   INDATA,1            YES                                          
         B     EXIT                                                             
         SPACE 2                                                                
*                                  ** ROUNDING ROUTINE **                       
BHROUND  TM    COLIND,COLIRND      TEST ROUNDING REQUIRED                       
         BZR   RE                                                               
         L     R0,0(R2)            YES                                          
         SRDA  R0,31                                                            
         D     R0,=F'100'                                                       
         LTR   R1,R1                                                            
         BM    *+8                                                              
         AHI   R1,1                                                             
         SRA   R1,1                                                             
         ST    R1,0(R2)                                                         
         BR    RE                                                               
         EJECT                                                                  
*------------------------------------BILL HEADER OUTPUT ROUTINES                
*                                                                               
OBHINV   MVC   LABLAREA(6),=C'INV NO'                                           
         LA    RE,5                                                             
         CLI   GLARGS,C'M'                                                      
         BNE   *+8                                                              
         LA    RE,6                                                             
         CLI   GLARGS+2,X'01'                                                   
         BNE   *+8                                                              
         LA    RE,9                                                             
         CLI   GLARGS+2,X'02'                                                   
         BNE   *+8                                                              
         LA    RE,7                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   NAMEAREA(0),0(R2)                                                
         B     GENOUT                                                           
*                                                                               
*                                                                               
OBHRETL  MVC   LABLAREA(9),=C'RETL ACCT'                                        
         MVC   NAMEAREA(12),0(R2)                                               
         B     GENOUT                                                           
*                                                                               
*                                                                               
OSTATYP  MVC   LABLAREA(8),=C'STA TYPE'                                         
         MVC   CODEAREA(1),0(R2)                                                
         B     GENOUT                                                           
*                                                                               
*                                                                               
OBHTYPE  MVC   LABLAREA(8),=C'BILL TYP'                                         
         MVC   CODEAREA(4),0(R2)                                                
         B     GENOUT                                                           
*                                                                               
*                                                                               
OAORTYP  MVC   LABLAREA(8),=C'AOR TYPE'                                         
         MVC   CODEAREA(1),0(R2)                                                
         B     GENOUT                                                           
*                                                                               
*                                                                               
OCOMTYP  MVC   LABLAREA(8),=C'COMM TYP'                                         
         MVC   CODEAREA(1),0(R2)                                                
         B     GENOUT                                                           
*                                                                               
*                                                                               
OBHPRDI  MVC   LABLAREA(9),=C'PRD INTER'                                        
         CLI   0(R2),X'FF'                                                      
         BNE   OBHPRDI5                                                         
         EDIT  (P3,1(R2)),(5,NAMEAREA)      PACKED VALUE                        
         B     GENOUT                                                           
OBHPRDI5 MVC   NAMEAREA(4),0(R2)            CHARACTERS                          
         B     GENOUT                                                           
*                                                                               
*                                                                               
OAOREFDT MVC   LABLAREA(9),=C'AOR EF DT'                                        
         OC    0(2,R2),0(R2)                                                    
         BZ    GENOUT                                                           
         XC    FULL,FULL                                                        
         MVC   FULL(2),0(R2)       YEAR AND MONTH                               
         MVI   FULL+2,X'01'        DUMMY DAY                                    
         GOTO1 DATCON,DMCB,(3,FULL),(7,NAMEAREA)                                
         B     GENOUT                                                           
*                                                                               
*                                                                               
OAORAGYN MVC   LABLAREA(9),=C'AOR AGYNM'                                        
         MVC   NAMEAREA(30),0(R2)                                               
         B     GENOUT                                                           
*                                                                               
*                                                                               
OAORINCA MVC   LABLAREA(8),=C'AOR COMM'                                         
         MVC   NAMEAREA(14),0(R2)                                               
         B     GENOUT                                                           
*                                                                               
*                                                                               
OAORPCT  MVC   LABLAREA(7),=C'AOR PCT'                                          
         EDIT  (4,0(R2)),(8,NAMEAREA),4,FLOAT=-  PACKED VALUE                   
         B     GENOUT                                                           
*                                                                               
*                                                                               
OAORRPA  MVC   LABLAREA(7),=C'REC/PAY'                                          
         MVC   NAMEAREA(14),0(R2)                                               
         B     GENOUT                                                           
*                                                                               
*                                           DATES                               
*                                                                               
OBHIDT   MVC   LABLAREA(12),=C'INVOICE DATE'  INVOICE DATE                      
         OC    0(6,R2),0(R2)                                                    
         BZ    GENOUT                                                           
         SR    R1,R1                                                            
         BAS   RE,OBHDATE                                                       
         B     GENOUT                                                           
*                                                                               
*                                                                               
OBHRDT   MVC   LABLAREA(8),=C'RUN DATE'   RUN DATE                              
         OC    0(6,R2),0(R2)                                                    
         BZ    GENOUT                                                           
         SR    R1,R1                                                            
         BAS   RE,OBHDATE                                                       
         B     GENOUT                                                           
*                                                                               
*                                                                               
OBHDDT   MVC   LABLAREA(8),=C'DUE DATE'   DUE DATE                              
         OC    0(3,R2),0(R2)                                                    
         BZ    GENOUT                                                           
         LA    R1,3                                                             
         BAS   RE,OBHDATE                                                       
         B     GENOUT                                                           
*                                                                               
*                                                                               
OBHPDT   MVC   LABLAREA(9),=C'POST DATE'  POST DATE                             
         OC    0(2,R2),0(R2)                                                    
         BZ    GENOUT                                                           
         LA    R1,2                                                             
         BAS   RE,OBHDATE                                                       
         B     GENOUT                                                           
*                                                                               
*                                                                               
OBHSDT   MVC   LABLAREA(8),=C'SRV DATE'          MONTH OF SERVICE               
         OC    0(4,R2),0(R2)                                                    
         BZ    GENOUT                                                           
         MVC   DUB(4),0(R2)                                                     
         MVC   DUB+4(2),=C'01'                                                  
         LA    R2,DUB                                                           
         SR    R1,R1                                                            
         BAS   RE,OBHMON                                                        
         B     GENOUT                                                           
*                                                                               
*                                             ROW DATES                         
OBHIMN   MVC   LABLAREA(8),=C'INV DATE'                                         
         B     OBHMON6                                                          
*                                                                               
*                                                                               
OBHRMN   MVC   LABLAREA(8),=C'RUN DATE'                                         
*                                                                               
OBHMON6  OC    0(6,R2),0(R2)                                                    
         BZ    GENOUT                                                           
         SR    R1,R1                                                            
         BAS   RE,OBHMON                                                        
         B     GENOUT                                                           
*                                                                               
*                                                                               
OBHDMN   MVC   LABLAREA(8),=C'DUE DATE'                                         
         OC    0(3,R2),0(R2)                                                    
         BZ    GENOUT                                                           
         LA    R1,3                                                             
         BAS   RE,OBHMON                                                        
         B     GENOUT                                                           
*                                                                               
*                                                                               
OBHPMN   MVC   LABLAREA(9),=C'POST DATE'                                        
         OC    0(2,R2),0(R2)                                                    
         BZ    GENOUT                                                           
         LA    R1,2                                                             
         BAS   RE,OBHMON                                                        
         B     GENOUT                                                           
*                                                                               
OBHEDT   MVC   LABLAREA(13),=C'EDI XMIT DATE'                                   
         OC    0(2,R2),0(R2)                                                    
         BZ    GENOUT                                                           
         LA    R1,2                                                             
         BAS   RE,OBHDATE                                                       
         B     GENOUT                                                           
*                                                                               
*                                                                               
OBHDATE  LR    R0,RE               GENERAL DATE OUTPUT ROUTINE                  
         ST    R2,DMCB                                                          
         STC   R1,DMCB                                                          
         XC    WORK,WORK                                                        
         LA    R1,WORK                                                          
         ST    R1,DMCB+4                                                        
         MVI   DMCB+4,5                                                         
*                                                                               
         TM    OPTIND2,OPTIYMD                                                  
         BNZ   *+12                                                             
         TM    OPTIND3,OPTICYMD                                                 
         BZ    *+8                                                              
         MVI   DMCB+4,X'20'                                                     
*                                                                               
         TM    OPTIND5,OPTISO                                                   
         BZ    *+8                                                              
         MVI   DMCB+4,23                                                        
*                                                                               
         TM    OPTIND5,OPTRFPDT                                                 
         BZ    *+8                                                              
         MVI   DMCB+4,6                                                         
*                                                                               
         GOTO1 DATCON,DMCB                                                      
         LA    R1,NAMEAREA                                                      
         MVC   0(8,R1),WORK                                                     
*                                                                               
         TM    OPTIND5,OPTISO                                                   
         BZ    *+10                                                             
         MVC   0(10,R1),WORK                                                    
*                                                                               
         TM    OPTIND3,OPTICYMD                                                 
         BZ    OBHDATEX                                                         
         MVC   0(2,R1),=C'19'                                                   
         CLI   WORK,C'6'                                                        
         BH    *+10                                                             
         MVC   0(2,R1),=C'20'                                                   
         MVC   2(6,R1),WORK                                                     
OBHDATEX LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
OBHMON   LR    R0,RE               GENERAL MONTH OUTPUT ROUTINE                 
         ST    R2,DMCB                                                          
         STC   R1,DMCB                                                          
         XC    WORK,WORK                                                        
         LA    R1,WORK                                                          
         ST    R1,DMCB+4                                                        
         MVI   DMCB+4,6                                                         
*                                                                               
         TM    OPTIND2,OPTIYMD                                                  
         BNZ   *+12                                                             
         TM    OPTIND3,OPTICYMD                                                 
         BZ    *+8                                                              
         MVI   DMCB+4,X'20'                                                     
*                                                                               
         TM    OPTIND5,OPTISO                                                   
         BZ    *+8                                                              
         MVI   DMCB+4,23                                                        
*                                                                               
         TM    OPTIND5,OPTRFPDT                                                 
         BZ    *+8                                                              
         MVI   DMCB+4,6                                                         
*                                                                               
         GOTO1 DATCON,DMCB                                                      
         MVC   NAMEAREA(6),WORK                                                 
*                                                                               
         TM    OPTIND5,OPTRFPDT                                                 
         BZ    *+10                                                             
         MVC   NAMEAREA+6(2),=C'00'                                             
*                                                                               
         TM    OPTIND2,OPTIYMD                                                  
         BZ    *+10                                                             
         MVC   NAMEAREA+4(2),=C'00'                                             
*                                                                               
         TM    OPTIND2,OPTISO                                                   
         BZ    *+16                                                             
         MVC   NAMEAREA(10),WORK                                                
         MVC   NAMEAREA+8(2),=C'00'                                             
*                                                                               
         TM    OPTIND3,OPTICYMD                                                 
         BZ    OBHMONX                                                          
         MVC   NAMEAREA(2),=C'19'                                               
         CLI   WORK,C'6'                                                        
         BH    *+10                                                             
         MVC   NAMEAREA(2),=C'20'                                               
         MVC   NAMEAREA+2(4),WORK                                               
OBHMONX  LR    RE,R0                                                            
         BR    RE                                                               
         EJECT                                                                  
ISTABINV DS    0H                                                               
         L     R4,SBACURCH                                                      
         USING STABELEM,R4                                                      
         GOTO1 DATCON,DMCB,(2,STABBDT),(0,DUB)                                  
*                                                                               
         LA    R1,SYSD                                                          
         AH    R1,=Y(SBB1PROF-SYSD)                                             
         ST    R1,DMCB+8                                                        
         MVC   DMCB+8(1),SBMED                                                  
         LA    R1,SYSD                                                          
         AH    R1,=Y(SBB1XPRF-SYSD)                                             
         ST    R1,DMCB+12                                                       
*                                                                               
         GOTO1 =V(SPFMTINO),DMCB,DUB,(2,STABINV)                                
         L     R1,DMCB+4                                                        
         MVC   0(7,R2),0(R1)                                                    
*                                                                               
         CLI   GLARGS+2,X'10'      WANT FULL INVOICE NUMBER?                    
         BNE   EXIT                NO                                           
         L     R1,DMCB             A(FULL INVOICE NUMBER)                       
         MVC   0(10,R2),0(R1)      MOVE FULL INVOICE NUMBER TO INPUT            
         B     EXIT                                                             
         DROP  R4                                                               
         SPACE 2                                                                
* OUTPUT INVOICE ROUTINE                                                        
*                                                                               
OSTABINV DS    0H                                                               
         TM    GLINDS,GLTOTLIN     IS THIS A TOTAL LINE                         
         BO    EXIT                                                             
         OC    0(7,R2),0(R2)                                                    
         BZ    EXIT                                                             
         MVC   LABLAREA(14),=C'INVOICE NUMBER'                                  
         MVC   NAMEAREA(7),0(R2)                                                
         CLI   GLARGS,X'10'        10 CHAR OUTPUT FMT?                          
         BNE   *+14                NO                                           
         MVC   NAMEAREA(10),0(R2)  YES - 10 CHAR OUTPUT                         
         B     OSTABX              AND DONE                                     
*                                                                               
         CLI   GLARGS,X'08'        8 CHAR OUTPUT FMT?                           
         BNE   *+18                NO                                           
         MVC   NAMEAREA(10),0(R2)  YES - MOVE WITH DASHES                       
         LA    R6,2                STRIP TWO DASHES                             
         B     OSTAB10             GO STRIP DASHES                              
*                                                                               
         CLI   GLARGS,C'6'         6 CHAR OUTPUT FMT?                           
         BNE   OSTABX                                                           
         LA    R6,1                STRIP ONE DASH                               
*                                                                               
OSTAB10  LA    R0,C'-'             GO FIND A '-'                                
         LA    RF,NAMEAREA                                                      
         LA    RE,L'NAMEAREA(RF)                                                
         SRST  RE,RF                                                            
***         BC    1,*-4               DON'T NEED IF LENGTH <256                 
         BC    2,OSTABX            NOT FOUND                                    
         LR    R1,RE               R1=A(CHARACTER FOUND)                        
         SR    RE,RF               RE=# BYTES INTO FIELD                        
         LHI   RF,L'NAMEAREA-1                                                  
         SR    RF,RE               LENGTH FOR EXECUTED MOVE                     
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),1(R1)       SHIFT EVERYTHING LEFT 1 CHAR                 
         BCT   R6,OSTAB10                                                       
*                                                                               
OSTABX   B     GENOUT                                                           
         EJECT                                                                  
*                                                                               
* WESTERN PW ROUTINES (FROM DRV2)                                               
         USING PWDOLEL,R4                                                       
ICLTLOCK DS    0H                                                               
         LA    R6,B4               CLIENT GROSS LOCK $$                         
         CLI   SBMODE,SBPROCPW     REAL $$ OR OVERRIDE $$?                      
         BNE   CLTLK10                                                          
         L     R1,SBACURCH                                                      
         CLI   0(R1),X'16'         IS THIS A CLTLOCK $OVRD ELEM?                
         BNE   INX                  NO                                          
         MVC   0(4,R2),4(R1)                                                    
         B     *+10                                                             
*                                                                               
CLTLK10  MVC   0(4,R2),PWDOLCG                                                  
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
ICLTLCKN DS    0H                                                               
         LA    R6,B4               CLIENT NET LOCK $$                           
         MVC   0(4,R2),PWDOLCN                                                  
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
IAGYLOCK DS    0H                                                               
         LA    R6,B4               AGENCY GROSS LOCK $$                         
         MVC   0(4,R2),PWDOLWG                                                  
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
IAGYLCKN DS    0H                                                               
         LA    R6,B4               AGENCY NET LOCK $$                           
         MVC   0(4,R2),PWDOLWN                                                  
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
ILOCKPCT LA    R6,B4                                                            
         CLI   SBMODE,SBPROCPW     OVERRIDE LOCK $$?                            
         BE    LKPCT10                                                          
         MVC   0(4,R2),PWDOLWG                                                  
         MVC   4(4,R2),PWDOLCG                                                  
         MVC   8(4,R2),PWDOLTAX                                                 
         B     INX                                                              
*                                                                               
LKPCT10  DS    0H                                                               
         L     R1,SBACURCH                                                      
         CLI   0(R1),X'16'         IS THIS A CLTLOCK $OVRD ELEM?                
         BNE   INX                  NO                                          
         MVC   4(4,R2),4(R1)                                                    
         MVI   INDATA,1                                                         
         B     INX                                                              
*                                                                               
IWIMLKTX LA    R6,B4                                                            
         MVC   0(4,R2),PWDOLTAX                                                 
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
ICLTLKTX LA    R6,B4                                                            
         MVC   0(4,R2),PWDOLCTX                                                 
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
INETLOCK LA    R6,B4                                                            
         CLI   SBMODE,SBPROCPW     REAL $$ OR OVERRIDE $$?                      
         BNE   NETLK10                                                          
         L     R1,SBACURCH                                                      
         CLI   0(R1),X'16'         IS THIS A CLTLOCK $OVRD ELEM?                
         BNE   INX                  NO                                          
         L     R1,4(R1)                                                         
         LR    RF,R1                                                            
         BAS   RE,NETGLCAL                                                      
         LR    R0,RF                                                            
         B     NETLK20                                                          
*                                                                               
NETLK10  L     R0,PWDOLCG          CALCULATE EFFECTIVE COST                     
         S     R0,PWDOLCTX                                                      
         L     R1,PWDOLCN          R0=GROSS-TAX                                 
         S     R1,PWDOLCTX                                                      
*                                                                               
NETLK20  BAS   RE,ECST                                                          
         CLI   SBMODE,SBPROCPW     REAL $$ OR OVERRIDE $$?                      
         BE    *+8                                                              
         A     R1,PWDOLCTX                                                      
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
INETLKTX LA    R6,B4                                                            
         ICM   R1,15,PWDOLCTX                                                   
         LR    RF,R1               SAVE GROSS                                   
         BAS   RE,NETGLCAL                                                      
         LR    R0,RF               RESTORE GROSS (NETGLCAL USES R0)             
         BAS   RE,ECST                                                          
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
* HERE ON MODE SBPROCPW, NOT SBPROCP2                                           
IADJDBCR DS    0H                                                               
         LA    R6,B4                                                            
         CLI   0(R4),X'06'         WEEKLY $ ELEM?                               
         BNE   INX                  NO                                          
         MVC   0(4,R2),PWDOLBIL    BILL OVRD DOLLARS                            
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
         USING SGLCHNKD,R5                                                      
         USING SCHUNKD,R4                                                       
ICLTDIFF DS    0H                                                               
         LA    R6,B4                                                            
         CLI   SBMODE,SBPROCP2     REAL $$ OR LOCK $$?                          
         BE    ICD10                                                            
         CLI   SBMODE,SBPROCPW     OVERRIDE $$                                  
         BE    ICD20                                                            
         CLI   SBMODE,SBPROCSP                                                  
         BNE   INX                                                              
*                                                                               
         MVC   0(4,R2),SCPWGRS                                                  
         B     INX                                                              
*                                                                               
* R4 = A(PWDOLEL) IF SBMODE=SBPROCP2                                            
*                                                                               
ICD10    ICM   R1,15,PWDOLCG-PWDOLEL(R4)                                        
         BZ    EXIT                                                             
         ST    R1,4(R2)                                                         
         MVI   INDATA,1            MAKE SURE PASSED TO SORT                     
         B     EXIT                                                             
*                                                                               
* R4 = A(X'06 OR X'15') IF SBMODE=SBPROCPW                                      
*                                                                               
ICD20    DS    0H                                                               
         CLI   0(R4),X'15'                                                      
         BNE   *+14                                                             
         MVC   0(4,R2),4(R4)                                                    
         B     INX                                                              
*                                                                               
         CLI   0(R4),X'16'         LOCK $ OVERRIDE?                             
         BNE   INX                                                              
         MVC   4(4,R2),4(R4)                                                    
         MVI   INDATA,1            MAKE SURE PASSED TO SORT                     
         BE    INX                                                              
*                                                                               
OCLTDIFF L     R4,0(R2)            CLT CURRENT                                  
         S     R4,4(R2)            - CLT LOCK                                   
         EDIT  (R4),(11,0(R3)),2,FLOAT=-                                        
         B     EXIT                                                             
*                                                                               
IPROJPW  DS    0H                                                               
         LA    R6,B4                                                            
         CLI   SBMODE,SBPROCPW                                                  
         BE    IPROJ10                                                          
         MVC   0(4,R2),SCGROSS                                                  
         MVC   8(4,R2),SCTAX                                                    
         MVC   4(4,R2),SCPWGRS                                                  
         B     INX                                                              
*                                                                               
IPROJ10  DS    0H                                                               
         CLI   0(R4),X'15'         WEEKLY $ ELEM?                               
         BNE   *+18                                                             
         MVC   4(4,R2),4(R4)       OVRD DOLLARS                                 
         MVI   INDATA,1            MAKE SURE PASSED TO SORT                     
         B     EXIT                                                             
*                                                                               
         CLI   0(R4),X'06'         WEEKLY $ ELEM?                               
         BNE   INX                  NO                                          
         MVC   4(4,R2),PWDOLBIL-PWDOLEL(R4)   ADJ DB/CR DOLLARS                 
         MVI   INDATA,1            MAKE SURE PASSED TO SORT                     
         B     EXIT                                                             
*                                                                               
OPROJPW  DS    0H                                                               
         OC    0(4,R2),0(R2)       DON'T CALL PWCALC W/0$                       
         BZ    OPROJPWX                                                         
         OC    4(4,R2),4(R2)                                                    
         BZ    OPROJPWX                                                         
         XC    WORK,WORK                                                        
         LA    R6,WORK                                                          
         USING PWBLKD,R6                                                        
*                                                                               
         MVI   PWACT,PWGETPW                                                    
         MVC   PWACTBUY,0(R2)                                                   
         MVC   PWADJBUY,4(R2)                                                   
         MVC   PWTAX,8(R2)                                                      
         GOTO1 PWCALC,DMCB,(R6)                                                 
         CLI   PWERR,0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         EDIT  PWVAL,(7,(R3)),2,MINUS=YES                                       
         DROP  R6                                                               
OPROJPWX B     EXIT                                                             
*                                                                               
ICLTPBIL DS    0H                                                               
         LA    R6,B4                                                            
         CLI   SBMODE,SBPROCPW                                                  
         BE    ICPB10                                                           
*                                                                               
         L     R1,SCPWGRS                                                       
         CLI   GLARGS+2,X'01'      APPLY BILL FORM?                             
         BNE   *+14                 NO                                          
         LR    R0,R1                                                            
         L     R1,SCPWNET                                                       
         BAS   RE,ECST                                                          
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
* MAY NOT BE X'06' ON SBPROCPW                                                  
ICPB10   ICM   R1,15,PWDOLBIL-PWDOLEL(R4)      BILL OVRD DOLLARS                
         CLI   0(R4),X'06'         WEEKLY LOCKED $ ELEM?                        
         BE    *+16                 YES                                         
         CLI   0(R4),X'15'         WEEKLY $ OVERRIDE?                           
         BNE   EXIT                                                             
         ICM   R1,15,4(R4)                                                      
*                                                                               
         CLI   GLARGS+2,X'01'      APPLY BILL FORM?                             
         BNE   *+10                 NO                                          
         LR    R0,R1                                                            
         BAS   RE,ECST                                                          
         ST    R1,4(R2)                                                         
         LR    RF,R2               MAKE SURE TO ROUND ANY OVERRIDE $$$          
         AHI   R2,4                                                             
         BAS   RE,BHROUND                                                       
         LR    R2,RF                                                            
         MVI   INDATA,1            MAKE SURE PASSED TO SORT                     
         B     EXIT                                                             
*                                                                               
OCLTPBIL DS    0H                                                               
         L     R4,0(R2)            CLT $ CURRENT                                
         A     R4,4(R2)            ADJUSTED DB/CR                               
         ST    R4,0(R2)                                                         
         MVI   GLHOOK,GLEDIT                                                    
         B     EXIT                                                             
*                                                                               
* WESTERN PW GOAL $ ROUTINES                                                    
IAGYGL   LA    R6,B4               AGENCY GOAL DOLLARS (WESTERN PW)             
         MVC   0(4,R2),SGLPWDOL                                                 
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
ICLTGLTX DS    0H                                                               
         LA    R6,B4               CLIENT GOAL TAX                              
         MVC   0(4,R2),SGLPWCTX                                                 
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
IAGYGLTX DS    0H                                                               
         LA    R6,B4               AGENCY GOAL TAX                              
         MVC   0(4,R2),SGLPWATX                                                 
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
IAGYGLN  DS    0H                  ((WIMGOAL-TAX) * .85) + TAX                  
         LA    R6,B4               NET DOLLARS                                  
         L     R1,SGLPWDOL                                                      
         S     R1,SGLPWATX                                                      
         BAS   RE,NETGLCAL                                                      
         A     R1,SGLPWATX                                                      
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
INETGOAL LA    R6,B4                                                            
         CLI   GLARGS+2,X'01'      TAX KEYWORD?                                 
         BNE   INET05                                                           
         L     R1,SGLPWCTX                                                      
         LR    R0,R1                                                            
         B     INET10                                                           
*                                  CALCULATE EFFECTIVE COST                     
INET05   L     R1,SGDOL                                                         
         BAS   RE,NETGLCAL         R1 HAS NET GOAL $                            
         L     R0,SGDOL            CALCULATE EFFECTIVE COST                     
*                                                                               
INET10   BAS   RE,ECST                                                          
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
* COMPUTE NET $$$ FROM GROSS                                                    
* PARMS: R1 = GROSS                                                             
* RETURNS R1 = NET                                                              
*                                                                               
NETGLCAL DS    0H                                                               
         SR    R0,R0                                                            
         M     R0,=F'85'           GROSS * .85                                  
         SLDA  R0,1                TWICE RESULT IN R0R1                         
         D     R0,=F'100'                                                       
         LTR   R1,R1               SEE IF THE ANSWER IS NEGATIVE                
         BM    *+8                 IF IT IS, WE DON'T NEED TO ADD 1             
         AHI   R1,1                (NOT A LA INSTRUCTION)                       
         SRA   R1,1                DIVIDE BY 2                                  
         BR    RE                                                               
*                                                                               
* ROUTINES FOR WESTERN PW                                                       
INETCLBL LA    R6,B4               *NETCLT$BILLED                               
         CLI   GLARGS+2,X'01'      IF CLT$BILL, ONLY PICK UP CUR=X'01'          
         BNE   *+12                                                             
         CLI   SBMODE,SBPROCB1                                                  
         BNE   INX                                                              
         L     R0,SBBILGRS                                                      
         L     R1,SBBILNET                                                      
         BAS   RE,ECST                                                          
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
ICLTBUY  DS    0H                                                               
         LA    R6,B4                                                            
         CLI   SBMODE,SBPROCPW     REAL $$ OR OVERRIDE $$?                      
         BNE   ICBUY10                                                          
         L     R1,SBACURCH                                                      
         CLI   0(R1),X'15'         IS THIS A $OVRD ELEM?                        
         BE    ICBUY05              YES                                         
         CLI   0(R1),X'06'         LOCKED $$$ ELEM?                             
         BNE   INX                                                              
         LA    R1,PWDOLBIL-PWDOLEL(R1)                                          
         B     ICBUY20                                                          
ICBUY05  LA    R1,4(R1)                                                         
         B     ICBUY20                                                          
ICBUY10  LA    R1,SCPWGRS                                                       
ICBUY20  MVC   0(4,R2),0(R1)                                                    
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
ICLTBUYN DS    0H                                                               
         LA    R6,B4               NET CLT BUY$                                 
         MVC   0(4,R2),SCPWNET                                                  
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
IBLSLDOL LA    R6,B4                                                            
         L     R1,SBACURCH                                                      
         CLI   GLARGS+2,C'2'       USE SECOND COST?                             
         BE    IBLSL2                                                           
         L     R0,SLDOL-SSLCHNKD(R1)                                            
         L     R1,SLNET-SSLCHNKD(R1)                                            
         B     IBLSL4                                                           
*                                                                               
IBLSL2   L     R0,SLDOL2-SSLCHNKD(R1)                                           
         L     R1,SLNET2-SSLCHNKD(R1)                                           
*                                                                               
IBLSL4   BAS   RE,ECST                                                          
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
IBLBYDOL LA    R6,B4                                                            
         L     R0,SCGROSS                                                       
         L     R1,SCNET                                                         
         CLI   GLARGS+2,C'2'       USE SECOND COST?                             
         BNE   *+12                                                             
         L     R0,SCGROSS2                                                      
         L     R1,SCNET2                                                        
*                                                                               
         S     R0,SCTAX                                                         
         S     R1,SCTAX                                                         
         BAS   RE,ECST                                                          
         A     R1,SCTAX                                                         
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
IBLGLDOL LA    R6,B4                                                            
         L     R1,SGDOL                                                         
         CLI   GLARGS+2,C'2'       USE SECOND COST?                             
         BNE   *+8                  NO                                          
         L     R1,SGLPWDOL                                                      
*                                                                               
         BAS   RE,NETGLCAL         R1 HAS NET GOAL $                            
         L     R0,SGDOL            CALCULATE EFFECTIVE COST                     
         CLI   GLARGS+2,C'2'       USE SECOND COST?                             
         BNE   *+8                  NO                                          
         L     R0,SGLPWDOL                                                      
         BAS   RE,ECST                                                          
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
INETBUY  DS    0H                                                               
         LA    R6,B4               PW EFFECTIVE COST                            
         L     R0,SCPWGRS                                                       
         S     R0,SCPWCLTX                                                      
         L     R1,SCPWNET                                                       
         S     R1,SCPWCLTX                                                      
         CLI   SBMODE,SBPROCSP     PROCESS BUY $$?                              
         BE    NETBY10                                                          
*                                                                               
         L     R1,SBACURCH                                                      
         CLI   0(R1),X'15'         IS THIS A CLTBUY $OVRD ELEM?                 
         BE    NETBY05              YES                                         
         CLI   0(R1),X'06'         LOCKED $$$ ELEM (ADJUSTMENT)?                
         BNE   INX                  NO                                          
         L     R1,PWDOLBIL-PWDOLEL(R1)                                          
         B     *+8                                                              
*                                                                               
NETBY05  L     R1,4(R1)                                                         
         LR    RF,R1                                                            
         BAS   RE,NETGLCAL                                                      
         LR    R0,RF                                                            
*                                                                               
NETBY10  BAS   RE,ECST                                                          
         CLI   SBMODE,SBPROCSP                                                  
         BNE   *+8                                                              
         A     R1,SCPWCLTX                                                      
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
INETTAX  DS    0H                                                               
         LA    R6,B4               PW EFFECTIVE TAX                             
         L     R1,SCPWCLTX                                                      
         LR    R0,R1                                                            
         BAS   RE,ECST                                                          
         ST    R1,0(R2)                                                         
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
IPWPCT   LA    R6,B4                                                            
         CLI   SBMODE,SBPROCPW                                                  
         BE    IPWPCT30                                                         
         MVC   0(4,R2),SCGROSS                                                  
         MVC   8(4,R2),SCTAX                                                    
         MVC   4(4,R2),SCPWGRS                                                  
*                                                                               
         LR    R1,R9               A(SYSD)                                      
         AH    R1,=Y(SBAWIPW-SYSD)                                              
         SR    RF,RF                                                            
         ICM   RF,7,0(R1)          SBAWIPW                                      
         BZ    INX                                                              
         AHI   RF,2                POINT TO DATE/PCT PAIRS                      
         LA    R0,14               MAX NUMBER OF ELEMS                          
*                                                                               
         TM    SBEFLAG,SBEEEST     IS THIS AN E EST?                            
         BNZ   IPWPCT20             YES - USE FIRST PCT                         
*                                                                               
IPWPCT10 CLC   SCDATE,0(RF)        CHUNK DATE                                   
         BNH   IPWPCT20            IF NOT HIGH, DONE                            
         AHI   RF,L'SBPWWK                                                      
         BCT   R0,IPWPCT10                                                      
         B     INX                                                              
*                                                                               
IPWPCT20 MVC   12(4,R2),2(RF)      PICK UP THE PERCENTAGE                       
         TM    12(R2),X'80'        OVERRIDE PW PCT?                             
         BNZ   *+8                  YES                                         
         MVI   19(R2),1                                                         
         B     INX                                                              
*                                                                               
IPWPCT30 DS    0H                                                               
         CLI   0(R4),X'15'         WEEKLY $ ELEM?                               
         BNE   INX                                                              
         MVC   4(4,R2),4(R4)       OVRD DOLLARS                                 
         MVI   INDATA,1            MAKE SURE PASSED TO SORT                     
         B     INX                                                              
*                                                                               
OPWPCT   DS    0H                                                               
         CLC   WEEKLEV,GLLEVEL                                                  
         BNE   OPWPCT20                                                         
*                                                                               
* IF AT THE WEEK LEVEL, JUST USE PWPCT OFF RECORD (DIV BY NUMBER OF             
* BUY LINES HERE TO GET CORRECT WEEKLY %)                                       
         OC    16(4,R2),16(R2)     OVERRIDE PW PCT?                             
         BZ    OPWPCT10             YES                                         
         L     R0,12(R2)                                                        
         BZ    OPWPCT10                                                         
         SRDA  R0,31                                                            
         D     R0,16(R2)                                                        
         LTR   R1,R1                                                            
         BM    *+8                                                              
         AHI   R1,1                                                             
         SRA   R1,1                                                             
         ST    R1,0(R2)                                                         
         MVI   GLHOOK,GLEDIT                                                    
         B     EXIT                                                             
*                                                                               
OPWPCT10 MVC   0(7,R3),=C'**OVRD*'                                              
         B     EXIT                                                             
*                                                                               
OPWPCT20 OC    0(4,R2),0(R2)       DON'T CALL PWCALC W/0$                       
         BZ    OPWX                                                             
         OC    4(4,R2),4(R2)                                                    
         BZ    OPWX                                                             
         XC    WORK,WORK                                                        
         LA    R6,WORK                                                          
         USING PWBLKD,R6                                                        
*                                                                               
         MVI   PWACT,PWGETPW                                                    
         MVC   PWACTBUY,0(R2)                                                   
         MVC   PWADJBUY,4(R2)                                                   
         MVC   PWTAX,8(R2)                                                      
         GOTO1 PWCALC,DMCB,(R6)                                                 
         CLI   PWERR,0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         EDIT  PWVAL,(7,(R3)),2,MINUS=YES                                       
         DROP  R6                                                               
OPWX     B     EXIT                                                             
*                                                                               
IAGYTAX  DS    0H                  AGY TAX                                      
         LA    R6,B4                                                            
         SR    R0,R0                                                            
         L     R1,SCTAX                                                         
         M     R0,=F'100'                                                       
         LR    R0,R1                                                            
         SR    R1,R1                                                            
         SRDA  R0,31               TWICE RESULT IN R0R1                         
         D     R0,=F'85'                                                        
         LTR   R1,R1               SEE IF THE ANSWER IS NEGATIVE                
         BM    *+8                 IF IT IS, WE DON'T NEED TO ADD 1             
         AHI   R1,1                (NOT A LA INSTRUCTION)                       
         SRA   R1,1                DIVIDE BY 2                                  
         ST    R1,0(R2)            ROUNDED ANSWER                               
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
IAGYTAXN DS    0H                                                               
         LA    R6,B4               AGY NET TAX                                  
         MVC   0(4,R2),SCTAX                                                    
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
ICLTTAX  DS    0H                                                               
         LA    R6,B4               CLIENT GROSS TAX                             
         MVC   0(4,R2),SCPWCLTX                                                 
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
ICLTTAXN DS    0H                                                               
         LA    R6,B4               CLIENT NET TAX                               
         MVC   0(4,R2),SCPWCTXN                                                 
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
IPWDATES DS    0H                                                               
         LLC   R6,GLARGS+1                                                      
         SLA   R6,1                * 2 STUPID, NOT 4                            
         LA    R6,PWLOCKDT(R6)                                                  
         MVC   0(2,R2),0(R6)                                                    
         B     EXIT                                                             
*                                                                               
ILOCKST  DS    0H                                                               
         MVC   0(1,R2),PWLOCKST                                                 
         B     EXIT                                                             
OLOCKST  DS    0H                                                               
         CLI   GLARGS,C'P'                                                      
         BNE   *+16                                                             
         TM    0(R2),PWGNPLKQ                                                   
         BNZ   OLOCKY                                                           
         B     OLOCKN                                                           
*                                                                               
         CLI   GLARGS,C'B'                                                      
         BNE   OLOCKX                                                           
         TM    0(R2),PWGNBILQ                                                   
         BZ    OLOCKN                                                           
*                                                                               
OLOCKY   MVI   0(R3),C'Y'                                                       
         B     OLOCKX                                                           
OLOCKN   MVI   0(R3),C'N'                                                       
*                                                                               
OLOCKX   B     EXIT                                                             
         EJECT                                                                  
*                                                                               
*    *** WESTERN PW CPP/CPS ROUTINES ***                                        
         USING PWDOLEL,R4                                                       
IWLCPS   DS    0H                                                               
         CLI   SBMODE,SBPROCSL                                                  
         BNE   IWLCPS10                                                         
         L     R1,SBACURCH                                                      
         MVC   4(4,R2),SLSPOTS-SSLCHNKD(R1)                                     
         B     INX                                                              
*                                                                               
IWLCPS10 LA    R6,B4               AGENCY GROSS LOCK $$                         
         MVC   0(4,R2),PWDOLWG                                                  
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
ICLCPS   DS    0H                                                               
         CLI   SBMODE,SBPROCSL                                                  
         BNE   ICLCPS10                                                         
         L     R1,SBACURCH                                                      
         MVC   4(4,R2),SLSPOTS-SSLCHNKD(R1)                                     
         B     INX                                                              
*                                                                               
ICLCPS10 LA    R6,B4               CLT GROSS LOCK $$                            
         CLI   SBMODE,SBPROCPW     REAL $$ OR OVERRIDE $$?                      
         BNE   ICLCPS20                                                         
         L     R1,SBACURCH                                                      
         CLI   0(R1),X'16'         IS THIS A CLTLOCK $OVRD ELEM?                
         BNE   INX                  NO                                          
         MVC   0(4,R2),4(R1)                                                    
         B     INX                                                              
*                                                                               
ICLCPS20 CLI   SBMODE,SBPROCP2                                                  
         BNE   INX                                                              
         MVC   0(4,R2),PWDOLCG                                                  
         BAS   RE,BHROUND                                                       
         B     INX                                                              
*                                                                               
ICCCPS   DS    0H                                                               
         CLI   SBMODE,SBPROCSP     PROCBUY?                                     
         BNE   ICLTBUY                                                          
         L     RF,SBACURCH         ADDRESS CURRENT CHUNK FOR INPUT              
         MVC   4(4,R2),SCSPOTS-SCHUNKD(RF)                                      
         B     ICLTBUY                                                          
*                                                                               
IWLCPP   DS    0H                  WIM LOCK CPP                                 
         L     RF,PWDOLWG                                                       
         B     WIMPAK                                                           
*                                                                               
IWLCPPN  DS    0H                  WIM LOCK NET CPP                             
         L     RF,PWDOLWN                                                       
         B     WIMPAK                                                           
*                                                                               
ICBCPP   DS    0H                  CLT BUY CPP                                  
         CLI   SBMODE,SBPROCSP                                                  
         BNE   ICBCPP1                                                          
         MVC   CPPDOL,PWGROSS                                                   
         MVC   CPPEDOL,CPPDOL                                                   
         B     ICPP                                                             
ICBCPP1  CLI   SBMODE,SBPROCPW     REAL $$ OR OVERRIDE $$?                      
         BNE   INX                                                              
         L     R1,SBACURCH                                                      
         CLI   0(R1),X'15'         IS THIS A $OVRD ELEM?                        
         BE    ICBCPP2              YES                                         
         CLI   0(R1),X'06'         LOCKED $$$ ELEM?                             
         BNE   INX                                                              
         L     RF,PWDOLBIL-PWDOLEL(R1)                                          
         B     WIMPAK2                                                          
ICBCPP2  L     RF,4(R1)                                                         
         B     WIMPAK2                                                          
*                                                                               
ICBCPPN  DS    0H                  CLT BUY NET CPP                              
         MVC   CPPDOL,PWNET                                                     
         MVC   CPPEDOL,CPPDOL                                                   
         B     ICPP                                                             
*                                                                               
ICLCPP   DS    0H                  CLIENT LOCK CPP                              
         CLI   SBMODE,SBPROCPW     REAL $$ OR OVERRIDE $$?                      
         BNE   ICLCPP2                                                          
         L     R1,SBACURCH                                                      
         CLI   0(R1),X'16'         IS THIS A CLTLOCK $OVRD ELEM?                
         BNE   INX                  NO                                          
         L     RF,4(R1)                                                         
         B     WIMPAK2                                                          
*                                                                               
ICLCPP2  CLI   SBMODE,SBPROCP2                                                  
         BNE   WIMPAK                                                           
         L     RF,PWDOLCG                                                       
         B     WIMPAK2                                                          
*                                                                               
ICLCPPN  DS    0H                  CLT LOCK NET CPP                             
         CLI   SBMODE,SBPROCP2                                                  
         BNE   WIMPAK                                                           
         L     RF,PWDOLCN                                                       
         B     WIMPAK2                                                          
*                                                                               
* INPUT  : RF = DOLLARS                                                         
WIMPAK   CLI   SBMODE,SBPROCSL                                                  
         BE    WIMPAK4                                                          
         LA    R6,PAK8                                                          
         CLI   SBMODE,SBPROCP2                                                  
         BNE   INX                                                              
WIMPAK2  CVD   RF,DUB                                                           
         ZAP   0(8,R2),DUB                                                      
         TM    COLIND,COLIRND      TEST ROUNDING                                
         BZ    INX                                                              
         SRP   0(8,R2),64-2,5      DIVIDE BY 100 TO GET ROUNDED $$$             
         B     INX                                                              
*                                                                               
WIMPAK4  DS    0H                                                               
         XC    CPPDOL,CPPDOL                                                    
         XC    CPPEDOL,CPPEDOL                                                  
         B     ISLCPP                                                           
*                                                                               
         EJECT                                                                  
*                                                                               
* ROUTINE TO CALCULATE EFFECTIVE COSTS                                          
*                                                                               
*  ARGS:  R0 = GROSS $$$                                                        
*         R1 = NET $$$                                                          
*   (FOR TAX, PASS R0 = R1 = TAX)                                               
*                                                                               
*  RETURNS R1 = EFFECTIVE COST                                                  
*                                                                               
ECST     NTR1                                                                   
         BAS   RE,GETFORM          GET BILLING FORMULA                          
         SR    RF,RF                                                            
         OC    FULL,FULL                                                        
         BZ    ECST6                                                            
         CLI   FULL,C'C'           TEST COMMISSION ONLY RATE                    
         BNE   ECST5                                                            
         SR    R0,R1               SET EFFECTIVE COST = GROSS                   
         ST    R0,0(R2)                                                         
         B     ECSTX                                                            
*                                                                               
ECST5    SR    RE,RE                                                            
         LR    RF,R0                                                            
         TM    BYTE,X'01'                                                       
         BZ    *+6                                                              
         LR    RF,R1                                                            
         M     RE,FULL                                                          
         SLDA  RE,1                                                             
         D     RE,=F'1000000'                                                   
         LTR   RF,RF                                                            
         BM    *+8                                                              
         A     RF,=F'1'                                                         
         SRA   RF,1                                                             
*                                                                               
ECST6    LR    RE,R0                                                            
         TM    BYTE,X'10'                                                       
         BZ    *+6                                                              
         LR    RE,R1                                                            
         AR    RE,RF                                                            
         LR    R1,RE                                                            
*                                                                               
ECSTX    B     XITR1                                                            
*                                                                               
* GETFORM                                                                       
*                                                                               
* RETURNS: BYTE = BILL BASE/COMM BASE (4 BITS EA)                               
*          FULL = SIGNED COMMISSION (99.9999)                                   
*                                                                               
GETFORM  NTR1                                                                   
         MVC   BYTE,SBBILBAS       DEFAULT BILL FORMULA                         
         MVC   FULL,SBBILCOM                                                    
         CLC   SBQEST,SBQESTND     TEST MULTIPLE ESTIMATES LUMPED               
         BE    *+12                TOGETHER                                     
         CLI   SBQSEPES,C'Y'                                                    
         BNE   GF2                 YES - USE PRODUCT BILL FORMULA               
         ICM   R1,15,SBAESTTB      NO - USE ESTIMATE BILL FORMULA               
         BZ    GFX                                                              
         LA    RE,255                                                           
         CLI   SBBPRD,X'FE'        TEST UNALLOCATED                             
         BE    *+8                 YES-USE PRODUCT POL                          
         IC    RE,SBBPRD                                                        
         BCTR  RE,0                                                             
         SLL   RE,8                                                             
         LLC   RF,SBBEST                                                        
         BCTR  RF,0                                                             
         AR    RE,RF                                                            
         LA    R1,0(R1,RE)                                                      
         SR    RE,RE                                                            
         ICM   RE,1,0(R1)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  RE,0                                                             
         MH    RE,=Y(ESTBUFFL)                                                  
         ICM   R1,15,SBAESTBF                                                   
         BZ    GFX                                                              
         LA    RE,0(R1,RE)                                                      
         USING ESTBUFFD,RE                                                      
         MVC   BYTE,EBBILBAS                                                    
         MVC   FULL,EBBILCOM                                                    
         B     GFX                                                              
         DROP  RE                                                               
*                                                                               
GF2      ICM   R1,15,SBAPRDBF      GET PRODUCT BILL FORMULA                     
         BZ    GFX                                                              
         LLC   RE,SBBPRD                                                        
         BCTR  RE,0                                                             
         MH    RE,=Y(PRDBUFFL)                                                  
         LA    RE,0(RE,R1)                                                      
         USING PRDBUFFD,RE                                                      
         MVC   BYTE,PBBILBAS                                                    
         MVC   FULL,PBBILCOM                                                    
         DROP  RE                                                               
*                                                                               
GFX      LR    RF,R9               GET ADDRESSABILITY TO END OF SBLOCK          
         AHI   RF,4096                                                          
         USING SYSD+4096,RF                                                     
         TM    SBEFLAG5,SBE5BFRM   OPT SET TO GET BILL FORM RECORD?             
         BZ    GFXIT               NO                                           
         CLI   SBB1XPRF+11,C'N'    PROFILE SET TO GET BILL FORMULA?             
         BE    GFXIT               NO                                           
         MVC   BYTE,SBBFORMB       YES - USE SFM BFORM REC                      
         MVC   FULL,SBBFORMC                                                    
         OC    SBBFORM,SBBFORM     HAVE ANY BFORM RECORD?                       
         BNZ   GFXIT               YES                                          
         MVI   BYTE,X'FE'          BFORM=X'FE' MEANS NO BFORM                   
         MVC   FULL,=X'FEFEFEFE'                                                
         DROP  RF                                                               
*                                                                               
GFXIT    B     EXIT                                                             
         EJECT                                                                  
IJ1DIFF  DS    0H                                                               
         SR    R6,R6                                                            
         ZAP   0(8,R2),=P'0'                                                    
*** THIS CODE TEST                                                              
         ZAP   8(8,R2),=P'0'                                                    
         ZAP   16(8,R2),=P'0'                                                   
*** THIS CODE TEST                                                              
         TM    ININD,INIBON        TEST PROCESSING BONUS DEMOS                  
         BO    INX                 YES-SKIP                                     
*                                                                               
         SR    R5,R5               R5=0 - NO DEMO FACTORING                     
         MVI   EQUIV,C'N'                                                       
         BAS   RE,IBDEM                                                         
         L     RF,VAL                                                           
         CLI   SBEDEMTY,C'A'                                                    
         BNE   IJ1D10                                                           
*** THIS CODE TEST                                                              
         CVD   RF,DUB                                                           
         ZAP   16(8,R2),DUB                                                     
*** THIS CODE TEST                                                              
         ST    RF,AFFDEM                                                        
         B     INX                                                              
*                                                                               
IJ1D10   CLI   SBEDEMTY,C'P'                                                    
         BNE   INX                                                              
*** THIS CODE TEST                                                              
         CVD   RF,DUB                                                           
         ZAP   8(8,R2),DUB                                                      
*** THIS CODE TEST                                                              
         S     RF,AFFDEM           BYPDEM-BYADEM                                
         LPR   RF,RF                                                            
         CVD   RF,DUB                                                           
         ZAP   0(8,R2),DUB                                                      
         B     INX                                                              
*                                                                               
OJ1DIFF  DS    0H                                                               
         CLI   GLHOOK,GLINCOMP     TEST INTERNAL COMPUTE TIME                   
         BNE   OJ1D10                                                           
         TM    COLIND,COLINDR      YES-TEST DEMO ROUNING                        
         BO    EXIT                NO                                           
*                                                                               
         SRP   0(8,R2),64-1,5      DIVIDE BY 10 TO GET ROUNDED DEMO             
         B     EXIT                                                             
*                                                                               
OJ1D10   L     R1,GLADTENT         EDIT                                         
         USING DROD,R1                                                          
         MVI   DRODEC,0                                                         
         TM    COLIND,COLINDR      TEST NO DEMO ROUNDING                        
         BZ    *+8                                                              
         MVI   DRODEC,1            YES                                          
         MVI   GLHOOK,GLEDIT                                                    
         B     EXIT                                                             
*                                                                               
* NEW DEMO INPUT & OUTPUT ROUTINES FOR PACKED NUMBERS                           
IPBYDEM  DS    0H                                                               
         ZAP   0(8,R2),=P'0'                                                    
         ZAP   8(8,R2),=P'0'                                                    
         TM    ININD,INIBON        TEST PROCESSING BONUS DEMOS                  
         BO    INX                 YES-SKIP                                     
         SR    R5,R5               R5=0 - NO DEMO FACTORING                     
*                                                                               
         CLI   GLARGS+2,0          TEST DEMO TYPE SENSITIVITY                   
         BE    *+14                                                             
         CLC   SBEDEMTY,GLARGS+2   YES-TEST CORRECT DEMO TYPE                   
         BNE   INX                                                              
*                                                                               
         CLC   CURBOOK,GLARGS+3    TEST CORRECT BOOK NUMBER                     
         BNE   INX                                                              
         LA    R6,PAK8                                                          
         MVI   EQUIV,C'N'                                                       
         BAS   RE,IBDEM                                                         
         L     RF,VAL                                                           
         CVD   RF,DUB                                                           
         ZAP   0(8,R2),DUB                                                      
         L     RF,VALWGT                                                        
         CVD   RF,DUB                                                           
         ZAP   8(8,R2),DUB                                                      
         TM    GLARGS+(GLIIND-GLARGSD),GLIIWGT  TEST WEIGHTED DEMO              
         BZ    INX                                                              
         ZAP   0(8,R2),DUB                                                      
         B     INX                                                              
*                                                                               
*                                  ** BUY CPP **                                
IPBYCPP  DS    0H                                                               
         MVC   CPPDOL,BYGROSS                                                   
         MVC   CPPEDOL,BYEGROSS                                                 
         B     ICPP                                                             
*                                                                               
*                                  ** CHILD SPOT DELIVERED CPP **               
IPDCPP   ZAP   0(8,R2),=P'0'                                                    
         ZAP   8(8,R2),=P'0'                                                    
         ZAP   16(8,R2),=P'0'                                                   
         ZAP   24(8,R2),=P'0'                                                   
         CLC   SBEDEMTY,GLARGS+2   TEST CORRECT DEMO TYPE                       
         BNE   IPDCPPX                                                          
         SR    R5,R5                                                            
         MVI   EQUIV,C'N'                                                       
         BAS   RE,IBDEM            GET DEMO VALUES                              
         BNE   IPDCPPX             (DEMO MIGHT BE REJECTED)                     
         L     RF,VAL              POINTS                                       
         CVD   RF,DUB                                                           
         ZAP   16(8,R2),DUB                                                     
         L     RF,VALWGT           WEIGHTED POINTS                              
         CVD   RF,DUB                                                           
         ZAP   24(8,R2),DUB                                                     
*                                                                               
         ICM   R1,15,CSDDOL        DELIVERED DOLLARS                            
         BZ    IPDCPP10                                                         
         BAS   RE,DOLSPLIT                                                      
         CVD   R1,DUB                                                           
         ZAP   0(8,R2),DUB         DOLLARS                                      
         CVD   R0,DUB                                                           
         ZAP   8(8,R2),DUB         PENNIES                                      
*                                                                               
IPDCPP10 TM    ININD,INIEQUIV      TEST EQUIVALENCING                           
         BZ    IPDCPPX                                                          
         CLI   SBSPPROF,C'D'       YES - TEST EQUIV DOLLARS OR PTS              
         BNE   *+6                                                              
         DC    H'0'                WE DON'T HAVE EQUIV DELIVERED DOL            
         MVI   EQUIV,C'Y'                                                       
         BAS   RE,IBDEM                                                         
         L     RF,VAL              POINTS                                       
         CVD   RF,DUB                                                           
         ZAP   16(8,R2),DUB                                                     
         L     RF,VALWGT           WEIGHTED POINTS                              
         CVD   RF,DUB                                                           
         ZAP   24(8,R2),DUB                                                     
IPDCPPX  DS    0H                  SIMULATE INX - CAN'T USE GEN RTN             
         CLI   INDATA,0           YES-IF THERE'S NO COLUMN DATA YET,            
         BNE   EXIT                                                             
         TM    DRINDS,GLPALDET    TEST PRINT ALL DETAILS                        
         BO    IPDCPPX2                                                         
         CP    0(8,R2),=P'0'                                                    
         BNE   IPDCPPX2                                                         
         CP    8(8,R2),=P'0'                                                    
         BNE   IPDCPPX2                                                         
         CP    16(8,R2),=P'0'                                                   
         BE    *+8                                                              
IPDCPPX2 MVI   INDATA,1           YES-MAKE SURE SORT RECORD'S PASSED            
         B     EXIT                   TO DRIVER'S SORT                          
         EJECT                                                                  
*                                                                               
*                                  ** GENERIC CPP **                            
* INPUT  : CPPDOL = F(GROSS OR NET), CPPEDOL = F(EQV GROSS OR NET)              
ICPP     ZAP   0(8,R2),=P'0'                                                    
         ZAP   8(8,R2),=P'0'                                                    
         ZAP   16(8,R2),=P'0'                                                   
         TM    ININD,INIBON        SKIP IF PROCESSING BONUS SPOTS NOW           
         BO    INX                                                              
         CLC   SBEDEMTY,GLARGS+2   TEST CORRECT DEMO TYPE                       
         BNE   INX                                                              
         CLC   CURBOOK,GLARGS+3                                                 
         BNE   INX                                                              
         LA    R6,PAK16                                                         
         SR    R5,R5                                                            
         MVI   EQUIV,C'N'                                                       
         BAS   RE,IBDEM            GET DEMO VALUES                              
         BNE   INX                 (DEMO MIGHT BE REJECTED)                     
         L     RF,CPPDOL           COST                                         
         CVD   RF,DUB                                                           
         ZAP   0(8,R2),DUB                                                      
         L     RF,VAL              POINTS                                       
         CVD   RF,DUB                                                           
         ZAP   8(8,R2),DUB                                                      
         L     RF,VALWGT           WEIGHTED POINTS                              
         CVD   RF,DUB                                                           
         ZAP   16(8,R2),DUB                                                     
         TM    ININD,INIEQUIV      TEST EQUIVALENCING                           
         BZ    ICPP3                                                            
         CLI   SBSPPROF,C'D'       YES - TEST EQUIV DOLLARS OR PTS              
         BNE   ICPP2                                                            
         L     RF,CPPEDOL                                                       
         CVD   RF,DUB                                                           
         ZAP   0(8,R2),DUB                                                      
         B     ICPP3                                                            
ICPP2    MVI   EQUIV,C'Y'                                                       
         BAS   RE,IBDEM                                                         
         L     RF,VAL                                                           
         CVD   RF,DUB                                                           
         ZAP   8(8,R2),DUB                                                      
         L     RF,VALWGT                                                        
         CVD   RF,DUB                                                           
         ZAP   16(8,R2),DUB                                                     
ICPP3    DS    0H                                                               
         TM    COLIND,COLIRND      TEST ROUNING                                 
         BZ    INX                 NO                                           
         SRP   0(8,R2),64-2,5      DIVIDE BY 100 TO GET ROUNDED $               
         B     INX                                                              
         EJECT                                                                  
*                                                                               
*                                  ** GENERIC SL CPP **                         
* INPUT  : CPPDOL = F(GROSS OR NET), CPPEDOL = F(EQV GROSS OR NET)              
ISLCPP   ZAP   0(8,R2),=P'0'                                                    
         ZAP   8(8,R2),=P'0'                                                    
         ZAP   16(8,R2),=P'0'                                                   
         CLI   DEMOPT,0            TEST TARGET/SECONDARY DEMOS ONLY             
         BE    *+12                                                             
         BAS   RE,CHKDEM           YES-CHECK THIS DEMO FOR TGT/SEC              
         BNE   INX                                                              
         LA    R6,PAK16                                                         
         L     R3,SBACURCH                                                      
         L     RF,CPPDOL                                                        
         CVD   RF,DUB                                                           
         ZAP   0(8,R2),DUB                                                      
         LLC   R1,GLARGS+1                                                      
         BCTR  R1,0                                                             
         SLL   R1,3                                                             
         LA    R1,SLDEMOS-SSLCHNKD(R1,R3)                                       
         MVC   VAL,0(R1)                                                        
         TM    ININD,INIEQUIV      TEST EQUIVALENCING                           
         BZ    ISLCPP2                                                          
         CLI   SBSPPROF,C'D'       YES - TEST EQUIV DOLLARS OR PTS              
         BNE   ISLCPPA                                                          
         L     RF,CPPEDOL                                                       
         CVD   RF,DUB                                                           
         ZAP   0(8,R2),DUB                                                      
         B     ISLCPP2                                                          
ISLCPPA  MVC   VAL,4(R1)                                                        
*                                                                               
ISLCPP2  XC    VALWGT,VALWGT                                                    
         CLI   SBQMKTWT,C'N'       TEST MARKET WEIGHTING                        
         BE    ISLCPP4                                                          
         LLC   RE,GLARGS+1         YES - TEST THIS DEMO IS RATING               
         BCTR  RE,0                                                             
         MHI   RE,3                                                             
         L     RF,ADEMLST                                                       
         LA    RE,0(RE,RF)                                                      
*                                                                               
         CLI   2(RE),0             COMSCORE DEMO?                               
         BNE   ISLCPP3             NO                                           
         XR    RF,RF               CLEAR RF                                     
         ICM   RF,1,1(RE)          HAVE COMSCORE INDEX?                         
         BZ    ISLCPP4             NO                                           
         BCTR  RF,0                -1                                           
         MHI   RF,8                INDEX INTO COMDLIST                          
         LA    RE,COMDLIST         RE = COMDLIST                                
         AR    RE,RF               PLUS INDEX = DEMO NAME                       
         BCTR  RE,0                -1 SO WE CAN USE NEXT INSTRUCTION            
*                                                                               
ISLCPP3  CLI   1(RE),C'R'                                                       
         BNE   ISLCPP4                                                          
         BAS   RE,WGT              YES - THEN WEIGHT                            
*                                                                               
ISLCPP4  L     RF,VAL                                                           
         CVD   RF,DUB                                                           
         ZAP   8(8,R2),DUB                                                      
         L     RF,VALWGT                                                        
         CVD   RF,DUB                                                           
         ZAP   16(8,R2),DUB                                                     
         TM    COLIND,COLIRND      TEST ROUNING                                 
         BZ    INX                 NO                                           
         SRP   0(8,R2),64-2,5      DIVIDE BY 100 TO GET ROUNDED $               
         B     INX                                                              
         EJECT                                                                  
*                                                                               
*                                  ** GENERAL BUY DEMO INPUT RTN **             
IBDEM    ST    RE,SVRE             INPUT  : R5=FACTOR FOR DEMO ADJUST           
         XC    VAL,VAL                      EQUIV=Y FOR EQUIVALENCING           
         XC    VALWGT,VALWGT                                                    
         CLI   DEMOPT,0            TEST TARGET/SECONDARY DEMOS ONLY             
         BE    *+12                NO                                           
         BAS   RE,CHKDEM           YES - CHECK THIS DEMO FOR TGT/SEC            
         BNE   IBDEMN                    NO                                     
         L     R1,SBACURCH                                                      
         LA    RE,SCDEMOS-SCHUNKD(R1)  RE=A(DEMO VALUES)                        
         L     RF,ADEMLST          RF=A(DEMO LIST)                              
         CLI   GLARGS+4,0          TEST FOR NON-STANDARD DEMO MODIFIER          
         BE    IBDEM4                                                           
         LLC   R0,SBENDEM          YES-GET ADDRESS OF DEMO VALUES FOR           
         MVC   HALF,=C'SX'             THIS MODIFIER                            
         CLI   GLARGS+4,C'S'                                                    
         BE    IBDEM2                                                           
         MVC   HALF,=C'PQ'                                                      
         CLI   GLARGS+4,C'P'                                                    
         BE    IBDEM2                                                           
         DC    H'0'                                                             
*                                                                               
IBDEM2   CLC   1(1,RF),HALF                                                     
         BE    IBDEM4                                                           
         CLC   1(1,RF),HALF+1                                                   
         BE    IBDEM4                                                           
         LA    RE,8(RE)                                                         
         LA    RF,3(RF)                                                         
         BCT   R0,IBDEM2                                                        
         B     IBDEMN                                                           
*                                                                               
IBDEM4   LLC   R1,GLARGS+1         POINT TO CORRECT DEMO VALUE                  
         BCTR  R1,0                                                             
         SLL   R1,3                                                             
         LA    R1,0(R1,RE)                                                      
         MVC   VAL,0(R1)                                                        
         CLI   EQUIV,C'Y'                                                       
         BNE   *+10                                                             
         MVC   VAL,4(R1)                                                        
         LTR   R5,R5               TEST ADJUST PURCHASED DEMO                   
         BZ    IBDEM6                                                           
         L     RF,0(R1)            YES                                          
         M     RE,=F'200'                                                       
         DR    RE,R5                                                            
         AHI   RF,1                NOT AN LA!!!                                 
         SRA   RF,1                                                             
         ST    RF,VAL                                                           
         L     RF,ADEMLST                                                       
*                                                                               
IBDEM6   CLI   SBQMKTWT,C'N'       TEST MARKET WEIGHTING                        
         BE    IBDEMY                                                           
         LLC   RE,GLARGS+1         YES - TEST THIS DEMO IS RATING               
         BCTR  RE,0                                                             
         MHI   RE,3                                                             
         LA    RE,0(RE,RF)                                                      
         CLI   1(RE),C'R'                                                       
         BNE   IBDEMY                                                           
         BAS   RE,WGT              YES - THEN WEIGHT                            
         B     IBDEMY                                                           
*                                                                               
IBDEMN   LTR   RB,RB               CC NE - DEMO REJECTED                        
         B     IBDEMX                                                           
IBDEMY   CR    RB,RB               CC EQ - NORMAL RETURN                        
IBDEMX   L     RE,SVRE                                                          
         BR    RE                                                               
*                                                                               
*                                  ** SPLIT INTO DOLLARS & PENNIES              
DOLSPLIT LR    R0,R1                                                            
         SRDA  R0,32                                                            
         D     R0,=F'100'                                                       
         BR    RE                                                               
*                                                                               
*                                  ** MARKET WEIGHT ROUTINE **                  
WGT      LR    R0,RE                                                            
         L     RF,VAL                                                           
         ICM   RE,15,SBMKTWGT                                                   
         MR    RE,RE                                                            
         ST    RF,VALWGT                                                        
         LR    RE,R0                                                            
         BR    RE                                                               
         SPACE 1                                                                
*                                                                               
CHKDEM   LR    R0,RE                                                            
         LLC   RE,GLARGS+1         FIND THIS COLUMN'S DEMO                      
         BCTR  RE,0                                                             
         MHI   RE,3                                                             
         L     R1,ADEMLST                                                       
         LA    RE,0(RE,R1)                                                      
         LA    R1,SBESTDEM         TARGET DEMO                                  
         CLI   DEMOPT,DEMOTGT      TEST TARGET DEMOS ONLY WANTED                
         BE    *+8                 YES                                          
         LA    R1,3(R1)            NO - THEN SECONDARY DEMOS ONLY               
         CLC   0(3,R1),0(RE)       COMPARE DEMOS                                
         BE    CHKDEMEQ                                                         
         B     CHKDEMNE                                                         
         SPACE 1                                                                
*                                  ** CHECK GOAL DEMO **                        
         SPACE 1                                                                
CHKDEMNE BAS   RE,CHKDEMLV                                                      
         MVI   0(RF),C'N'                                                       
         LTR   RE,R0                                                            
         BR    RE                                                               
*                                                                               
CHKDEMEQ BAS   RE,CHKDEMLV                                                      
         MVI   0(RF),C'Y'                                                       
         LR    RE,R0                                                            
         CR    RE,RE                                                            
         BR    RE                                                               
*                                                                               
CHKDEMLV LLC   RF,INLEVEL                                                       
         A     RF,ALVLSWS                                                       
         BCTR  RF,0                                                             
         BR    RE                                                               
         EJECT                                                                  
*                                                                               
* DEMO OUTPUT ROUTINES                                                          
OPDEMO   DS    0H                                                               
         TM    GLARGS+(GLOIND-GLARGSD),GLOIWGT  TEST COLUMN IS WEIGHTED         
         BZ    ODEMO2                                                           
         CLI   GLHOOK,GLINCOMP     YES-TEST INTERNAL COMPUTE TIME               
         BNE   ODEMO10             NO-JUST FORMAT                               
         BAS   RE,WGTCOL           GET WEIGHTED DEMO                            
*                                                                               
ODEMO2   CLI   GLHOOK,GLINCOMP     TEST INTERNAL COMPUTE TIME                   
         BNE   ODEMO8                                                           
         TM    COLIND,COLINDR      YES-TEST DEMO ROUNING                        
         BO    EXIT                NO                                           
*                                                                               
         SRP   0(8,R2),64-1,5      DIVIDE BY 10 TO GET ROUNDED DEMO             
         SRP   8(8,R2),64-1,5      DIVIDE BY 10 TO GET ROUNDED DEMO             
         B     EXIT                                                             
*                                                                               
ODEMO8   ZAP   DUB,0(8,R2)         MAYBE UNWEIGHT                               
         ZAP   DUB2,8(8,R2)                                                     
         BAS   RE,ODEMWGT                                                       
         ZAP   0(8,R2),DUB                                                      
*                                                                               
ODEMO10  L     R1,GLADTENT         EDIT                                         
         USING DROD,R1                                                          
         MVI   DRODEC,0                                                         
         TM    COLIND,COLINDR      TEST NO DEMO ROUNDING                        
         BZ    *+8                                                              
         MVI   DRODEC,1            YES                                          
         MVI   GLHOOK,GLEDIT                                                    
         B     EXIT                                                             
         DROP  R1                                                               
         SPACE 1                                                                
*                                  ** CPP **                                    
OPCPP    CLI   GLHOOK,GLINCOMP     TEST INTERNAL COMPUTE HOOK                   
         BE    OPCPP2              YES-ALWAYS CALCULATE CPP                     
         TM    COLIND,COLICPPT     TEST SUPPRESS TOTALS                         
         BZ    *+12                                                             
         TM    GLINDS,GLTOTLIN     YES-TEST TOTALING NOW                        
         BO    OPCPPX              YES-EXIT                                     
         TM    OUTIND,OUTICRDP     TEST FOR CROSS DAYPARTS NOW                  
         BZ    *+12                                                             
         TM    SBQDPTLN,SBQDLCPP   YES - TEST FOR WHETHER TO PRINT              
         BZ    OPCPPX                    NO - EXIT                              
*                                                                               
         ZAP   CPP,0(8,R2)                                                      
         OC    TOTWGT,TOTWGT       TEST THERE IS A TOTAL WEIGHT                 
         BZ    OPCPP6                                                           
         ZAP   DUB,8(8,R2)         YES-UNWEIGHT IF NECESSARY                    
         ZAP   DUB2,16(8,R2)                                                    
         BAS   RE,ODEMWGT                                                       
         BNE   OPCPP6              NO UNWEIGHTING                               
         ZAP   CPPDEM,DUB          DEMO IS UNWEIGHTED-REDO CALCULATION          
         ZAP   DOL,8(8,R2)                                                      
         B     OPCPP4                                                           
*                                  INTERNAL COMPUTE -                           
OPCPP2   ZAP   DOL,0(8,R2)         COST                                         
         ZAP   CPPDEM,8(8,R2)      POINTS                                       
         ZAP   8(8,R2),DOL         STORE COST IN CASE NEEDED IN FUTURE          
*                                                                               
OPCPP4   ZAP   0(8,R2),=P'0'                                                    
         BAS   RE,OCPPCAL          CPP CALCULATION                              
         BZ    OPCPPX                                                           
         ZAP   0(8,R2),CPP                                                      
*                                                                               
OPCPP6   ZAP   DUB,CPP             FORMAT THE CPP                               
         MVI   BYTE,0                                                           
         BAS   RE,OCPPFMT                                                       
*                                                                               
OPCPPX   B     EXIT                                                             
         SPACE 1                                                                
*                                  ** CHILD SPOT DELIVERED CPP **               
OPDCPP   CLI   GLHOOK,GLINCOMP     TEST INTERNAL COMPUTE HOOK                   
         BE    OPDCPP2             YES-ALWAYS CALCULATE CPP                     
         TM    COLIND,COLICPPT     TEST SUPPRESS TOTALS                         
         BZ    *+12                                                             
         TM    GLINDS,GLTOTLIN     YES-TEST TOTALING NOW                        
         BO    OPDCPPX             YES-EXIT                                     
         TM    OUTIND,OUTICRDP     TEST FOR CROSS DAYPARTS NOW                  
         BZ    *+12                                                             
         TM    SBQDPTLN,SBQDLCPP   YES - TEST FOR WHETHER TO PRINT              
         BZ    OPDCPPX                   NO - EXIT                              
         ZAP   CPP,0(8,R2)                                                      
         OC    TOTWGT,TOTWGT       TEST THERE IS A TOTAL WEIGHT                 
         BZ    OPDCPP6                                                          
         ZAP   DUB,16(8,R2)        YES-UNWEIGHT IF NECESSARY                    
         ZAP   DUB2,24(8,R2)                                                    
         BAS   RE,ODEMWGT                                                       
         BNE   OPDCPP6             NO UNWEIGHTING                               
         ZAP   CPPDEM,DUB          DEMO IS UNWEIGHTED-REDO CALCULATION          
         ZAP   DOL,8(8,R2)                                                      
         B     OPDCPP4                                                          
*                                  INTERNAL COMPUTE -                           
OPDCPP2  LR    R5,R2                                                            
         BAS   RE,CALCDOL          ADD PENNIES TO DOLLARS                       
         ZAP   CPPDEM,16(8,R2)                                                  
         ZAP   8(8,R2),DOL         STORE COST IN CASE NEEDED IN FUTURE          
*                                                                               
OPDCPP4  ZAP   0(8,R2),=P'0'                                                    
         BAS   RE,OCPPCAL          CALCULATE CPP                                
         BZ    OPDCPPX                                                          
         ZAP   0(8,R2),CPP                                                      
*                                                                               
OPDCPP6  ZAP   DUB,CPP             FORMAT CPP                                   
         MVI   BYTE,0                                                           
         BAS   RE,OCPPFMT                                                       
*                                                                               
OPDCPPX  B     EXIT                                                             
         SPACE 1                                                                
*                                  ** GET WEIGHTED VALUE **                     
WGTCOL   DS    0H                                                               
         SRP   0(8,R2),64-3,5      DIVIDE BY 1000 TO GET WEIGHTED               
         BR    RE                  VALUE (COVERAGE 10.0 = 100%)                 
*                                                                               
ODEMWGT  ST    RE,SVRE             ** GENERAL DEMO OUTPUT RTN **                
         CLI   SBQMKTWT,C'N'       TEST TO UNWEIGHT                             
         BE    ODEMWGT2                                                         
         TM    OUTIND,OUTICRMK     YES - TEST ACROSS MARKETS                    
         BZ    ODEMWGT2                                                         
         CP    DUB2,=P'0'          YES - TEST DEMO IS WEIGHTED                  
         BE    ODEMWGT2                                                         
         BAS   RE,UNWEIGHT                                                      
         L     RE,SVRE             RETURN CC EQ                                 
         CR    RE,RE                                                            
         BR    RE                                                               
ODEMWGT2 ICM   RE,15,SVRE          NO WEIGHTING - RETURN CC NE                  
         BR    RE                                                               
         SPACE                                                                  
*                                  ** CPP CALCULATION ROUTINE **                
OCPPCAL  ST    RE,SVRE                                                          
         ZAP   CPP,=P'0'                                                        
         CP    CPPDEM,=P'0'        TEST FOR ZERO DEMO                           
         BE    OCPPCALX                                                         
         ZAP   BIG,DOL                                                          
         TM    COLIND,COLIRND      TEST ROUND OPTION                            
         BZ    *+10                                                             
         MP    BIG,=PL2'100'       YES - ADD BACK PENNIES                       
         MP    BIG,=PL2'20'        X 10 FOR 2 DECIMAL POINT PRECISION           
         DP    BIG,CPPDEM          DIVIDE TO GET CPP                            
         ZAP   DUB,BIG(8)                                                       
         CP    DUB,=P'0'           TEST FOR ZERO CPP                            
         BE    OCPPCALX                                                         
         BL    *+10                                                             
         AP    DUB,=P'1'                                                        
         ZAP   BIG,DUB                                                          
         DP    BIG,=PL8'2'                                                      
         ZAP   CPP,BIG(8)                                                       
OCPPCALX CP    CPP,=P'0'           RETURN CC EQ - CPP=ZERO                      
         L     RE,SVRE                       NE - CPP NE ZERO                   
         BR    RE                                                               
         SPACE 1                                                                
*                                  ** CPP FORMAT ROUTINE **                     
OCPPFMT  ST    RE,SVRE                                                          
         CLI   BYTE,0              TEST TRAILING CHARACTER SUPPLIED             
         BNE   OCPPFMT4            YES                                          
         MVI   BYTE,C' '                                                        
         CLI   SBSPPROF+4,C'Y'     TEST FOR EQUIV THE DETAIL LINES              
         BE    OCPPFMT2                                                         
         TM    DATAIND,DIDPTLEN    OR DOES DPT/LEN NOT FIGURE IN REPORT         
         BZ    OCPPFMT2            YES-THERE'S ALWAYS EQUIVALENCING             
         TM    GLINDS,GLTOTLIN     NO EQUIV ON DRIVER TOTAL LINE                
         BO    OCPPFMT4                                                         
         TM    OUTIND,OUTIDTOT     EQUIV IF THIS IS A DPTLEN TOTAL LINE         
         BZ    OCPPFMT4                                                         
OCPPFMT2 MVI   BYTE,C'+'           INDICATE A '+' FOR EQUIVALENCING             
OCPPFMT4 CP    DUB,=P'0'                                                        
         BE    OCPPFMTX                                                         
         XC    EBLOCK,EBLOCK                                                    
         LA    R1,DUB                                                           
         ST    R1,EBAIN                                                         
         MVI   EBLIN,8                                                          
         MVI   EBTIN,C'P'                                                       
         ST    R3,EBAOUT                                                        
         LLC   R5,MYOLEN                                                        
         CP    DUB,=P'0'           TEST NEGATIVE                                
         BNL   *+12                                                             
         MVI   EBOPT,EBOQMEY                                                    
         B     *+6                                                              
         BCTR  R5,0                                                             
         STC   R5,EBLOUT                                                        
         TM    COLIND2,COLINOCT                                                 
         BO    *+12                                                             
         MVI   EBDECS,2            2 DECIMAL PLACES                             
         B     *+8                                                              
         MVI   EBROUND,2           UNLESS ROUNDING OUT PENNIES                  
         OI    EBTRIM,EBTQROD      ROUND OFF DECIMALS IF TOO BIG                
         GOTO1 GLAEDITR,DMCB,EBLOCK                                             
         LA    R1,0(R3,R5)                                                      
         MVC   0(1,R1),BYTE        TRAILING CHARACTER                           
OCPPFMTX L     RE,SVRE                                                          
         BR    RE                                                               
*                                  ** DEMO UNWEIGHT ROUTINE **                  
UNWEIGHT LR    R0,RE                                                            
         ICM   R1,15,TOTWGT        TOTAL WEIGHT                                 
         BZ    UNWTX                                                            
         CVD   R1,DUB3                                                          
         ZAP   DUB,=P'0'                                                        
         CP    DUB2,=P'0'                                                       
         BE    UNWTX                                                            
         ZAP   PACK16,DUB2                                                      
         SRP   PACK16+8(8),1,0     SHIFT LEFT                                   
         DP    PACK16,DUB3                                                      
         SRP   PACK16(8),64-1,5    SHIFT RIGHT                                  
*                                                                               
UNWT2    ZAP   DUB,PACK16(8)                                                    
*                                                                               
UNWTX    LR    RE,R0                                                            
         BR    RE                                                               
         EJECT                                                                  
* CALCULATE THE DOLLARS                                                         
* INPUT  : R5=A(PACKED DOLLARS(8)/PACKED PENNIES(8))                            
* OUTPUT : DOL=PACKED MONEY AMOUNT IN PENNIES OR DOLLARS IF ROUNDING            
*                                                                               
CALCDOL  LR    R0,RE               CALCULATE THE DOLLARS                        
         ZAP   DOL,0(8,R5)                                                      
         TM    COLIND,COLIRND      ROUND OPTION                                 
         BO    CD2                                                              
         MP    DOL,=P'100'                                                      
         ZAP   PEN,8(8,R5)                                                      
         AP    DOL,PEN                                                          
         B     CDX                                                              
*                                                                               
CD2      ZAP   DUB4,8(8,R5)                                                     
         SRP   DUB4,64-2,5                                                      
         AP    DOL,DUB4                                                         
*                                                                               
CDX      LR    RE,R0                                                            
         BR    RE                                                               
         EJECT                                                                  
ICGROUP  DS    0H                                                               
         LA    R6,SYSD                                                          
         AH    R6,=Y(SBASTANT-SYSD)                                             
         ZICM  RE,0(R6),3                                                       
         BZ    EXIT                                                             
         USING STABUFFD,RE                                                      
         CLI   GLARGS+2,C'N'       NTYPE KEYWORD?                               
         BNE   *+14                NO                                           
         MVC   0(L'STBNTYPE,R2),STBNTYPE                                        
         B     EXIT                                                             
*                                                                               
         MVC   0(L'STBGRPCD,R2),STBGRPCD                                        
         B     EXIT                                                             
         DROP  RE                                                               
*                                                                               
         EJECT                                                                  
ISTAADDR DS    0H                                                               
         LA    R6,SYSD                                                          
         AH    R6,=Y(SBASTANT-SYSD)                                             
         ZICM  RE,0(R6),3                                                       
         BZ    EXIT                                                             
         USING STABUFFD,RE                                                      
         LA    R1,STBELEM                                                       
         USING STBELEM,R1                                                       
         XR    RF,RF                                                            
*                                                                               
ISADD10  CLI   STBELEM,0            END OF RECORD?                              
         BE    EXIT                 YES, NO STATION ADDRESS                     
         CLI   STBELEM,SADDR        HAVE STATION ADDRESS ELEMENT?               
         BE    ISADD20              YES                                         
         IC    RF,STBELMLN          LENGTH OF ELEMENT                           
         AR    R1,RF                BUMP TO NEXT ELEM/END OF ENTRY              
         B     ISADD10                                                          
*                                                                               
ISADD20  IC    RF,STBELMLN          LENGTH OF ELEMENT                           
         SHI   RF,3                 MINUS OVERHEAD AND 1 FOR EX                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),STBADDR      ** EXECUTED **                              
         B     EXIT                                                             
         DROP  R1,RE                                                            
*                                                                               
ISTAZIP  DS    0H                                                               
         LA    R6,SYSD                                                          
         AH    R6,=Y(SBASTANT-SYSD)                                             
         ZICM  RE,0(R6),3                                                       
         BZ    EXIT                                                             
         USING STABUFFD,RE                                                      
         MVC   0(L'STBIGZIP,R2),STBIGZIP                                        
         B     EXIT                                                             
         DROP  RE                                                               
         EJECT                                                                  
IESTPCT  DS    0H                                                               
         ICM   R1,15,SBAESTTB      A(ESTTABLE)                                  
         BZ    IEPCTX                                                           
         LA    RE,255                                                           
         CLI   SBBPRD,X'FE'      TEST UNALLOCATED                               
         BE    *+8                 YES-USE PRODUCT POL                          
         IC    RE,SBBPRD                                                        
         BCTR  RE,0                                                             
         SLL   RE,8                                                             
         LLC   RF,SBBEST                                                        
         BCTR  RF,0                                                             
         AR    RE,RF                                                            
         LA    R1,0(R1,RE)                                                      
         SR    RE,RE                                                            
         ICM   RE,1,0(R1)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  RE,0                                                             
         MH    RE,=Y(ESTBUFFL)                                                  
         ICM   R1,15,SBAESTBF                                                   
         BZ    IEPCTX                                                           
         LA    RE,0(R1,RE)                                                      
         USING ESTBUFFD,RE                                                      
*                                                                               
         ICM   R1,14,EBUFPCT       GET DEFAULT PERCENTAGE                       
         SRA   R1,8                                                             
         C     R1,=X'FF800000'     TEST PW=0                                    
         BNE   *+6                                                              
         SR    R1,R1                                                            
         STCM  R1,7,0(R2)                                                       
         DROP  RE                                                               
*                                                                               
IEPCTX   B     EXIT                                                             
*                                                                               
OESTPCT  DS    0H                                                               
         MVC   LABLAREA(07),=C'EST PCT'                                         
         EDIT  (3,0(R2)),(5,CODEAREA),2,ALIGN=LEFT,MINUS=YES                    
         B     GENOUT                                                           
         EJECT                                                                  
*                                                                               
IESTCOS2 DS    0H                                                               
         ICM   R1,15,SBAESTTB      A(ESTTABLE)                                  
         BZ    IEC2X                                                            
         LA    RE,255                                                           
         CLI   SBBPRD,X'FE'      TEST UNALLOCATED                               
         BE    *+8                 YES-USE PRODUCT POL                          
         IC    RE,SBBPRD                                                        
         BCTR  RE,0                                                             
         SLL   RE,8                                                             
         LLC   RF,SBBEST                                                        
         BCTR  RF,0                                                             
         AR    RE,RF                                                            
         LA    R1,0(R1,RE)                                                      
         SR    RE,RE                                                            
         ICM   RE,1,0(R1)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  RE,0                                                             
         MH    RE,=Y(ESTBUFFL)                                                  
         ICM   R1,15,SBAESTBF                                                   
         BZ    IEC2X                                                            
         LA    RE,0(R1,RE)                                                      
         USING ESTBUFFD,RE                                                      
         MVC   0(4,R2),ECOS2                                                    
         DROP  RE                                                               
*                                                                               
IEC2X    B     EXIT                                                             
*                                                                               
ICLTCOS2 DS    0H                                                               
         LA    RF,SYSD                                                          
         AHI   RF,SBC2FACT-SYSD                                                 
         MVC   0(4,R2),0(RF)                                                    
         B     EXIT                                                             
         EJECT                                                                  
*                                                                               
ICLTPCT  DS    0H                                                               
         LA    RF,SYSD                                                          
         AH    RF,=Y(SBCLTPW-SYSD)                                              
         MVC   0(3,R2),0(RF)                                                    
         B     EXIT                                                             
*                                                                               
OCLTPCT  DS    0H                                                               
         MVC   LABLAREA(07),=C'CLT PCT'                                         
         EDIT  (3,0(R2)),(5,CODEAREA),2,ALIGN=LEFT                              
         B     GENOUT                                                           
         EJECT                                                                  
IBILLST  DS    0H                                                               
         CLI   SBMODE,SBPROCBH                                                  
         BNE   IB10                                                             
         USING BILLRECD,R4                                                      
         MVI   0(R2),1                                                          
         TM    BILSTAT2,BSTCLRDQ                                                
         BZ    IBX                                                              
         MVI   1(R2),1                                                          
         B     IBX                                                              
         DROP  R4                                                               
*                                                                               
IB10     CLI   SBMODE,SBPROCBL                                                  
         BNE   IBX                                                              
         MVI   0(R2),1                                                          
*                                                                               
IBX      B     EXIT                                                             
*                                                                               
OBILLST  DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    OBX                                                              
         MVI   0(R3),C'*'                                                       
         CLI   1(R2),0                                                          
         BE    OBX                                                              
         MVI   1(R3),C'*'                                                       
*                                                                               
OBX      B     EXIT                                                             
         EJECT                                                                  
*                                                                               
* BILL FORMULA KEYWORDS                                                         
IBFORM   DS    0H                                                               
         BAS   RE,GETFORM          GET BILL FORMULA                             
         MVC   0(1,R2),BYTE                                                     
         MVC   1(4,R2),FULL                                                     
         B     EXIT                                                             
*                                                                               
OBFORM   DS    0H                                                               
         CLC   0(5,R2),=X'FEFEFEFEFE'  BFORM REQUESTED=0?                       
         BNE   OB1                     NO                                       
         MVI   0(R3),C'G'              YES - DEFAULT TO GROSS                   
         TM    GLARGS,X'01'            AFORMULA KEYWORD?                        
         BNZ   *+10                    YES                                      
         MVC   0(6,R3),=C'GROSS '                                               
         B     OBXIT                                                            
*                                                                               
OB1      LR    R5,R3                                                            
         TM    GLARGS,X'01'                                                     
         BNZ   OB10                USE SHORT FORM                               
*                                                                               
         TM    0(R2),X'10'                                                      
         BZ    *+18                                                             
         MVC   0(4,R5),=C'NET '                                                 
         LA    R5,4(R5)                                                         
         B     *+14                                                             
         MVC   0(6,R5),=C'GROSS '                                               
         LA    R5,6(R5)                                                         
*                                                                               
         ICM   R1,15,1(R2)                                                      
         BZ    OBXIT               IF PCT = 0, SKIP THIS PART                   
         LTR   R1,R1                                                            
         BM    *+18                                                             
         MVC   0(5,R5),=C'PLUS '                                                
         LA    R5,5(R5)                                                         
         B     *+14                                                             
         MVC   0(6,R5),=C'MINUS '                                               
         LA    R5,6(R5)                                                         
*                                                                               
         LPR   R1,R1                                                            
         EDIT  (R1),(8,(R5)),4,ALIGN=LEFT                                       
         AR    R5,R0                                                            
         BCTR  R5,0                BACK UP ONE                                  
*                                  CLEAR EXTRANEOUS 0'S                         
OB5      CLI   0(R5),C'.'                                                       
         BNE   *+16                                                             
         MVI   0(R5),C' '                                                       
         LA    R5,1(R5)                                                         
         B     OB7                                                              
         CLI   0(R5),C'0'                                                       
         BH    *+12                                                             
         MVI   0(R5),C' '                                                       
         BCT   R5,OB5                                                           
         LA    R5,2(R5)                                                         
*                                                                               
OB7      MVC   0(7,R5),=C'PCT OF '                                              
         LA    R5,7(R5)                                                         
*                                                                               
         TM    0(R2),X'01'                                                      
         BZ    *+18                                                             
         MVC   0(4,R5),=C'NET '                                                 
         LA    R5,4(R5)                                                         
         B     *+14                                                             
         MVC   0(6,R5),=C'GROSS '                                               
         LA    R5,6(R5)                                                         
         B     OBXIT                                                            
*                                                                               
OB10     DS    0H                                                               
         TM    0(R2),X'10'                                                      
         BZ    *+12                                                             
         MVI   0(R5),C'N'                                                       
         B     *+8                                                              
         MVI   0(R5),C'G'                                                       
         LA    R5,1(R5)                                                         
*                                                                               
         ICM   R1,15,1(R2)                                                      
         BZ    OBXIT               IF PCT = 0, SKIP THIS PART                   
         LTR   R1,R1                                                            
         BM    *+12                                                             
         MVI   0(R5),C'+'                                                       
         B     *+8                                                              
         MVI   0(R5),C'-'                                                       
         LA    R5,1(R5)                                                         
*                                                                               
         LPR   R1,R1                                                            
         EDIT  (R1),(8,(R5)),4,ALIGN=LEFT                                       
         AR    R5,R0                                                            
         BCTR  R5,0                BACK UP ONE                                  
*                                  CLEAR EXTRANEOUS 0'S                         
OB20     CLI   0(R5),C'.'                                                       
         BNE   *+12                                                             
         MVI   0(R5),C' '                                                       
         B     OB30                                                             
         CLI   0(R5),C'0'                                                       
         BH    *+12                                                             
         MVI   0(R5),C' '                                                       
         BCT   R5,OB20                                                          
         LA    R5,1(R5)                                                         
*                                                                               
OB30     MVI   0(R5),C'%'                                                       
         LA    R5,1(R5)                                                         
*                                                                               
         TM    0(R2),X'01'                                                      
         BZ    *+12                                                             
         MVI   0(R5),C'N'                                                       
         B     *+8                                                              
         MVI   0(R5),C'G'                                                       
         LA    R5,1(R5)                                                         
*                                                                               
OBXIT    B     EXIT                                                             
         EJECT                                                                  
*                                                                               
* INPUT ROUTINE EXIT FOR COLUMNS                                                
INX      LTR   R6,R6              TEST THIS IS A COLUMN                         
         BZ    EXIT                                                             
         CLI   INDATA,0           YES-IF THERE'S NO COLUMN DATA YET,            
         BNE   EXIT                                                             
         TM    DRINDS,GLPALDET    TEST PRINT ALL DETAILS                        
         BO    INX2                                                             
         LLC   RE,0(R6)           OR, TEST ANY DATA IN THIS COL                 
         EX    RE,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R2),1(R6)                                                    
         BE    *+8                                                              
INX2     MVI   INDATA,1           YES-MAKE SURE SORT RECORD'S PASSED            
         B     EXIT                   TO DRIVER'S SORT                          
         EJECT                                                                  
         GETEL R6,DATADISP,ELCODE                                               
*                                                                               
ALVLSWS  DS    A                                                                
BLANKS   DC    CL32' '                                                          
SINGNUM  DS    XL2                MAKE EACH BILL HEADER REC UNIQUE              
*                                                                               
PACK16   DS    PL16                                                             
DUB2     DS    D                                                                
DUB3     DS    D                                                                
DUB4     DS    D                                                                
VAL      DS    F                                                                
VALWGT   DS    F                                                                
SVRE     DS    F                                                                
AFFDEM   DS    F                                                                
INLEVEL  DS    C                                                                
EQUIV    DS    CL1                                                              
B2       DC    X'01',XL2'0000'                                                  
B4       DC    X'03',XL4'00000000'                                              
PAK8     DC    X'07',PL8'0'                                                     
PAK16    DC    X'0F',PL16'0'                                                    
*                                                                               
         DS    0D                                                               
CPPDOL   DS    F                   $ FOR CPP CALC                               
CPPEDOL  DS    F                   EQUIVALENCED $ FOR CPP CALC                  
DOL      DS    PL8                 DOLLARS                                      
PEN      DS    PL8                 PENNIES                                      
BIG      DS    PL16                                                             
CPP      DS    PL8                 CPP                                          
CPPDEM   DS    PL8                 DEMO VALUE FOR CPP                           
*                                                                               
       ++INCLUDE DDEBLOCK                                                       
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
* ROUTINE TABLE                                                                 
*                                                                               
* ROUTINES 001 ==> 022 NOW IN DRV4  (25AUG98)                                   
*                                                                               
* NEW ROUTINES FOR MCBUY MACRO                                                  
ROUTTAB  DC    22S(0)                                                           
         DC    S(IESTLIN)                                                       
         DC    S(OESTLIN)                                                       
         DC    S(IBYDATES)         025                                          
         DC    S(OBYDATES)                                                      
         DC    S(IBYWKS)                                                        
         DC    S(IDPTCD)                                                        
         SPACE 1                                                                
* INFOMERCIAL ROUTINES                                                          
         DC    S(IIFCPO)                                                        
         DC    S(HIFCPO)           030                                          
         DC    S(IIFTR)                                                         
         DC    S(HIFTR)                                                         
         DC    S(IIFBEC)                                                        
         DC    S(HIFBEC)                                                        
         DC    S(IIFPRC)           035                                          
         DC    S(HIFPRC)                                                        
         DC    S(IIFTO)                                                         
         DC    S(IIFBUD)                                                        
         DC    S(IIFSTAT)                                                       
         DC    S(OIFSTAT)          040                                          
         DC    S(IIFTYPE)                                                       
         DC    S(OIFTYPE)                                                       
         DC    S(IIFDATE)                                                       
         DC    S(IIFTIME)                                                       
         DC    S(OIFTIME)          045                                          
         DC    S(IIFCTR)                                                        
         DC    S(IIBYCHK)                                                       
         DC    S(OIBYCHK)                                                       
         DC    S(HIFUPS)                                                        
         DC    S(IIFRSPDT)         050                                          
         DC    S(IIFRSPDW)                                                      
         DC    S(OIFRSPDW)                                                      
         DC    S(IIFRSPDM)                                                      
         DC    S(IIFCOST)                                                       
         DC    S(OIFCOST)          055                                          
         DC    S(IIFINC)                                                        
         DC    S(IIFUPINC)                                                      
         DC    S(HIFUPINC)                                                      
         DC    S(IIFCCMD)                                                       
         DC    S(IIFUPMD)          060                                          
         DC    S(HIFUPMD)                                                       
         DC    S(IIFGMD)                                                        
         DC    S(IIFPRFIT)                                                      
         DC    S(IIFTINC)                                                       
         SPACE 1                                                                
* BILL HEADER ROUTINES                                                          
         DC    S(IBHINV)           065                                          
         DC    S(OBHINV)                                                        
         DC    S(IBHRETL)                                                       
         DC    S(OBHRETL)                                                       
         DC    S(ISTATYP)                                                       
         DC    S(OSTATYP)          070                                          
         DC    S(IBHTYPE)                                                       
         DC    S(OBHTYPE)                                                       
         DC    S(IAORTYP)                                                       
         DC    S(OAORTYP)                                                       
         DC    S(ICOMTYP)          075                                          
         DC    S(OCOMTYP)                                                       
         DC    S(IBHGRS)                                                        
         DC    S(IBHNET)                                                        
         DC    S(IBHACT)                                                        
         DC    S(IBHAGY)           080                                          
         DC    S(IBHTAX)                                                        
         DC    S(IBHGST)                                                        
         DC    S(IBHCGRS)                                                       
         DC    S(IBHCNET)                                                       
         DC    S(IBHCACT)          085                                          
         DC    S(IBHCTAX)                                                       
         DC    S(IBHPRDI)                                                       
         DC    S(OBHPRDI)                                                       
         DC    S(IAOREFDT)                                                      
         DC    S(OAOREFDT)         090                                          
         DC    S(IAORBAS)                                                       
         DC    S(IAORAMT)                                                       
         DC    S(IAORAGYN)                                                      
         DC    S(OAORAGYN)                                                      
         DC    S(IAORINCA)         095                                          
         DC    S(OAORINCA)                                                      
         DC    S(IAORPCT)                                                       
         DC    S(OAORPCT)                                                       
         DC    S(IAORRPA)                                                       
         DC    S(OAORRPA)          100                                          
         DC    S(IBHIDT)                                                        
         DC    S(OBHIDT)                                                        
         DC    S(OBHIMN)                                                        
         DC    S(IBHRDT)                                                        
         DC    S(OBHRDT)           105                                          
         DC    S(OBHRMN)                                                        
         DC    S(IBHDDT)                                                        
         DC    S(OBHDDT)                                                        
         DC    S(OBHDMN)                                                        
         DC    S(IBHPDT)           110                                          
         DC    S(OBHPDT)                                                        
         DC    S(OBHPMN)                                                        
         DC    S(IBHSDT)                                                        
         DC    S(OBHSDT)                                                        
         DC    S(IBHSING)          115                                          
         DC    S(ISTABINV)                                                      
         DC    S(OSTABINV)                                                      
* WESTERN PW                                                                    
         DC    S(ICLTLOCK)                                                      
         DC    S(ICLTLCKN)                                                      
         DC    S(IAGYLOCK)         120                                          
         DC    S(IAGYLCKN)                                                      
         DC    S(IPBYDEM)                                                       
         DC    S(OPDEMO)                                                        
         DC    S(ICGROUP)                                                       
         DC    S(IBHPST)           125                                          
         DC    S(IWIMLKTX)                                                      
         DC    S(ICLTDIFF)                                                      
         DC    S(OCLTDIFF)                                                      
         DC    S(ICLTPBIL)                                                      
         DC    S(OCLTPBIL)         130                                          
         DC    S(IADJDBCR)                                                      
         DC    S(IPROJPW)                                                       
         DC    S(OPROJPW)                                                       
* REST OF WESTERN PW                                                            
         DC    S(ICLTBUY)                                                       
         DC    S(IAGYGL)           135                                          
         DC    S(ICLTBUYN)                                                      
         DC    S(IPWPCT)                                                        
         DC    S(OPWPCT)                                                        
         DC    S(IAGYGLN)                                                       
         DC    S(IAGYTAX)          140                                          
         DC    S(IAGYTAXN)                                                      
         DC    S(ICLTTAX)                                                       
         DC    S(ICLTTAXN)                                                      
         DC    S(ICLTGLTX)                                                      
         DC    S(IAGYGLTX)         145                                          
         DC    S(IPWDATES)                                                      
         DC    S(ISTAADDR)                                                      
         DC    S(ILOCKPCT)                                                      
         DC    S(INETBUY)                                                       
         DC    S(INETLOCK)         150                                          
         DC    S(IESTPCT)                                                       
         DC    S(OESTPCT)                                                       
         DC    S(ICLTLKTX)                                                      
         DC    S(INETTAX)                                                       
         DC    S(ILOCKST)          155                                          
         DC    S(OLOCKST)                                                       
         DC    S(IBILLST)                                                       
         DC    S(OBILLST)                                                       
         DC    S(INETGOAL)                                                      
         DC    S(IBFORM)           160                                          
         DC    S(OBFORM)                                                        
         DC    S(INETLKTX)                                                      
*                                                                               
         DC    2S(0)                                                            
*        DC    S(IHDCML)                                                        
*        DC    S(OHDCML)                                                        
*                                                                               
         DC    S(ICLTPCT)          165                                          
         DC    S(OCLTPCT)                                                       
         DC    S(IPBYCPP)                                                       
         DC    S(OPCPP)                                                         
         DC    S(IPDCPP)                                                        
         DC    S(OPDCPP)           170                                          
         DC    S(0)                                                             
         DC    S(INETCLBL)                                                      
         DC    S(IWLCPP)                                                        
         DC    S(IWLCPPN)                                                       
         DC    S(ICBCPP)           175                                          
         DC    S(ICBCPPN)                                                       
         DC    S(ICLCPP)                                                        
         DC    S(ICLCPPN)                                                       
         DC    S(IWLCPS)                                                        
         DC    S(ICLCPS)           180                                          
         DC    S(ICCCPS)                                                        
         DC    S(ISTAZIP)                                                       
         DC    S(IBHEDT)                                                        
         DC    S(OBHEDT)                                                        
         DC    S(IJ1DIFF)          185                                          
         DC    S(OJ1DIFF)                                                       
         DC    S(IBLBYDOL)                                                      
         DC    S(IBLGLDOL)                                                      
         DC    S(ICLTCOS2)                                                      
         DC    S(IESTCOS2)         190                                          
         DC    S(IBLSLDOL)                                                      
         EJECT                                                                  
*        INCLUDE SPGENSTAB                                                      
*        INCLUDE SPGENREP                                                       
*        INCLUDE SPGENCOM                                                       
*        INCLUDE SPGENCLRST                                                     
*        INCLUDE DRGLOBAL                                                       
*        INCLUDE DRIVETABLE                                                     
*        INCLUDE DRINTRECD                                                      
*        INCLUDE DDSPOOLD                                                       
*        INCLUDE DDSPLWORKD                                                     
*        INCLUDE SPWRIFFD                                                       
*        INCLUDE SPWRIF1D                                                       
*        INCLUDE MAAORLKD                                                       
         PRINT OFF                                                              
       ++INCLUDE SPGENSTAB                                                      
REPRECD  DSECT                                                                  
       ++INCLUDE SPGENREP                                                       
COMHDRD  DSECT                                                                  
       ++INCLUDE SPGENCOM                                                       
       ++INCLUDE SPGENCLRST                                                     
       ++INCLUDE DRGLOBAL                                                       
       ++INCLUDE DRIVETABLE                                                     
       ++INCLUDE DRINTRECD2                                                     
       ++INCLUDE DDSPOOLD                                                       
       ++INCLUDE DDSPLWORKD                                                     
       ++INCLUDE SPWRIFFD                                                       
         ORG   CONTAGH                                                          
       ++INCLUDE SPWRIF1D                                                       
         PRINT ON                                                               
         EJECT                                                                  
       ++INCLUDE SPWRIWORKD                                                     
         EJECT                                                                  
* SPGENBUY                                                                      
         PRINT OFF                                                              
BUYRECD  DSECT                                                                  
       ++INCLUDE SPGENBUY                                                       
         PRINT ON                                                               
         SPACE 1                                                                
* SPGENGOAL                                                                     
         PRINT OFF                                                              
GOALRECD DSECT                                                                  
       ++INCLUDE SPGENGOAL                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* SPGENAGY                                                                      
         PRINT OFF                                                              
AGYRECD  DSECT                                                                  
       ++INCLUDE SPGENAGY                                                       
         PRINT ON                                                               
         SPACE 1                                                                
* SPGENINFO                                                                     
         PRINT OFF                                                              
       ++INCLUDE SPGENINFO                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* SPGENBILL                                                                     
         PRINT OFF                                                              
BILLRECD DSECT                                                                  
       ++INCLUDE SPGENBILL                                                      
         EJECT                                                                  
       ++INCLUDE MAAORLKD                                                       
         PRINT ON                                                               
* SPGENSNV                                                                      
         PRINT OFF                                                              
SNVRECD  DSECT                                                                  
       ++INCLUDE SPGENSNV                                                       
         EJECT                                                                  
         PRINT ON                                                               
* SPGENINV                                                                      
         PRINT OFF                                                              
INVRECD  DSECT                                                                  
       ++INCLUDE SPGENINV                                                       
         EJECT                                                                  
         PRINT ON                                                               
* SPGENXLK                                                                      
         PRINT OFF                                                              
       ++INCLUDE SPGENXLK                                                       
         EJECT                                                                  
         PRINT ON                                                               
* SPGENWIPW                                                                     
         PRINT OFF                                                              
       ++INCLUDE SPGENWIPW                                                      
         EJECT                                                                  
         PRINT ON                                                               
* SPPWBLOCK                                                                     
         PRINT OFF                                                              
       ++INCLUDE SPPWBLOCK                                                      
         PRINT ON                                                               
         SPACE 1                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'046SPSYSDRV3 03/21/17'                                      
         END                                                                    
