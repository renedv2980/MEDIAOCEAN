*          DATA SET FAGETTXT   AT LEVEL 006 AS OF 04/06/20                      
*CATALP FAGETTXT                                                                
         TITLE 'FAGETTXT - GET SYSTEM MESSAGES FROM GENDIR/GENFIL'              
GETTXT   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 WORKX-WORKD,**GTXT**,R8,RR=RE,CLEAR=YES                          
         USING WORKD,RC            RC=A(W/S)                                    
         SAM24 ,                   SET IN 24-BIT MODE                           
         LR    R2,R1                                                            
         USING GETTXTD,R2          R2=A(PARMLIST/CONTROL BLOCK)                 
         CLI   GTINDX,X'FF'                                                     
         BNE   GETTXT1                                                          
         LA    R2,DMCB             SPECIAL CALL FOR FACPAK MESSAGES             
         XC    GTBLOCK,GTBLOCK                                                  
         MVC   0(4,R2),0(R1)                                                    
         MVI   GTMSYS,GTGENSYS                                                  
         MVI   GTMTYP,GTMFAC                                                    
*                                                                               
GETTXT1  MVI   ONOROFF,TEST        INITIALISED AS TEST MODE                     
         LR    R1,R0               TEST MODE R0=A(SYSFAC)                       
         TM    GT2INDS,GT2TEST     TEST FOR TEST MODE                           
         BO    GTONLINE                                                         
         ICM   R1,15,=V(SSB)       SEE IF SSB LINKED                            
         BZ    GTOFFL                                                           
         ICM   RE,3,0(R1)          IS IT A DUMMY SSB                            
         BZ    GTOFFL                                                           
*                                                                               
         MVI   ONOROFF,ONLINE      WE ARE ON LINE (LINKED IN FACPAK)            
         L     R1,=V(SYSFAC)                                                    
         USING SYSFACD,R1                                                       
*                                                                               
GTONLINE MVC   ADATAMGR,VDATAMGR-SYSFACD(R1)                                    
         MVC   ASSB,VSSB-SYSFACD(R1)                                            
         MVC   ACALLOV,VCALLOV-SYSFACD(R1)                                      
         STCM  R1,15,ASYSFACS                                                   
         L     RF,VSYSFAC0                                                      
         L     RF,CSWITCH-COMFACSD(RF)                                          
         STCM  RF,15,ASWITCH                                                    
*                                                                               
         L     R1,ASSB                                                          
         MVC   SYSID,SSBSYSID-SSBD(R1)                                          
         MVC   DELIM,SSBSYSCH-SSBD(R1)                                          
*                                                                               
         L     R1,SSBTKADR-SSBD(R1)                                             
         STCM  R1,15,ATCB                                                       
         MVC   TSKSYS,TCBOVSYS-TCBD(R1)                                         
         MVC   TSKTWA,TCBTWA-TCBD(R1)                                           
*                                                                               
         PROT  OFF                 DISABLE CALLER'S STORAGE PROTECTION          
*                                                                               
         ICM   R1,15,ATCB                                                       
         L     RE,TCBWRKA-TCBD(R1)                                              
         LA    R0,8                                                             
GTON1    CLC   0(4,RE),=C'MNTR'    FIND MONITORS REGISTERS                      
         BE    GTON2                                                            
         L     RE,8(RE)                                                         
         BCT   R0,GTON1                                                         
         B     GTON2A              ASSUME FROM SCRUNCH                          
*                                                                               
GTON2    LA    RE,72(RE)           RE=A(MONITORS W/S)                           
         ST    RE,TSKTIOB          SAVE A(TASK TRANSLATOR IOB)                  
*                                                                               
GTON2A   L     RA,TCBUTL-TCBD(R1)  A(CURRENT TASK UTL)                          
         USING UTLD,RA             RA=A(UTL)                                    
         STCM  RA,15,AUTL                                                       
         MVC   TSKLANG,TLANG       SAVE CONNECT LANGUAGE                        
         MVC   PHYSYS,TSYS         SAVE PHYSICAL SYSTEM                         
         MVC   TSKSVCRQ,TSVCREQ    SAVE TASKS SVC INFO                          
         MVC   PRGIND,TPRGIND      SAVE PROGRAM INDS                            
*&&US*&& OI    TPRGIND,X'02'       FLAG AS READ ONLY PROGRAM                    
         OC    TSVCREQ,TSVCREQ     FORCE TO SE1 IF IN A SERVICE REQUEST         
         BZ    *+8                                                              
         MVI   PHYSYS,1                                                         
*                                                                               
GTON3    TM    TSTAT6,TST6STRO+TST6STFU TEST FULL STEREO MODE                   
         BNO   GT000                                                            
         OC    GTAOUT,GTAOUT       ZERO ADDRESS MEANS TWA HEADER                
         BZ    GTON4                                                            
         L     RF,TSKTWA           RF=A(TWA)                                    
         LA    RF,64(RF)                                                        
         CLM   RF,7,GTAOUT         TEST A(FIRST FIELD HDR)                      
         BE    GTON4                                                            
         LA    RF,8(RF)                                                         
         CLM   RF,7,GTAOUT         TEST A(FIRST FIELD DATA)                     
         BNE   GT000                                                            
GTON4    MVI   DELIM,C'/'          FORCE STD DELIMITER FOR STEREO               
         TM    GT1INDS,GT1NOREF    HONOUR 'NO REFERENCE CODE' IF SET            
         BNZ   GT000                                                            
         OI    GT1INDS,GT1REF      FORCE REFERENCE CODE                         
         B     GT000                                                            
*                                                                               
GTOFFL   MVI   ONOROFF,OFFL                                                     
         MVC   ADATAMGR,=V(DATAMGR)     OFFLINE A(DATA MANAGER)                 
         L     R1,=V(UTL)                                                       
         STCM  R1,15,AUTL                                                       
         MVC   OFFSYS,4(R1)        SAVE CALLERS SE NUMBER                       
         MVI   4(R1),CONTROL       SET SE TO CONTROL SYSTEM                     
*                                                                               
         ICM   R3,15,=V(MASTC)                                                  
         BZ    GTOFF3              CALLER MUST PASS SYS/LANG                    
         USING MASTD,R3                                                         
         LA    R1,SYSLST           LOCATE OFFLINE SYSTEM ENTRY                  
         LH    RE,0(R1)                                                         
         L     RF,2(R1)                                                         
         LA    R1,6(R1)                                                         
         USING SYSLSTD,R1                                                       
*                                                                               
         CLC   MCSYSTEM,SYSLSHRT                                                
         BE    *+12                                                             
         BXLE  R1,RE,*-10                                                       
         BAS   RE,DEATH            UNKNOWN SYSTEM - UPDATE FASYSLST             
*                                                                               
         MVC   TSKSYS,SYSLEQU      SET EQUATED SYSTEM FROM SYSLIST              
         MVC   TSKLANG,MCLANG      GET TASK LANGUAGE                            
         DROP  R1,R3                                                            
         SPACE 1                                                                
GTOFF3   CLI   GENOPEN,YES         TEST IF GENDIR/FIL ALREADY OPEN              
         BE    OFFL4                                                            
         GOTO1 ADATAMGR,DMCB,=C'DMOPEN',CTLSYS,FILES,IOAREA                     
         MVI   GENOPEN,YES         FLAG FOR SUBSEQUENT CALLS                    
*                                                                               
OFFL4    OC    GTAOUT,GTAOUT                                                    
         BNZ   GT000                                                            
         BAS   RE,DEATH            OFFLINE A(OUTPUT) MUST BE DEFINED            
         EJECT                                                                  
***********************************************************************         
* EXTRACT CALLERS REQUEST DETAILS AND SET/OVERRIDE DEFAULTS           *         
***********************************************************************         
GT000    CLI   GTMLANG,0           TEST IF LANGUAGE FORCED BY CALL              
         BE    *+10                                                             
         MVC   TSKLANG,GTMLANG     OVERRIDE LANGUAGE                            
*                                                                               
CT005    CLI   TSKLANG,LANGMAX     SET LANGUAGE AND SUB LANGUAGE                
         BNH   *+8                                                              
         MVI   TSKLANG,0                                                        
         SR    R1,R1               GET LANGUAGE AND SUB LANGUAGE                
         IC    R1,TSKLANG                                                       
         SLL   R1,1                                                             
         LA    R1,LANGTAB(R1)                                                   
         MVC   DICLANG(2),0(R1)    SET DICT LANG AND SUB LANG CODES             
*                                                                               
         CLI   DICLANG,0           FORCE HOST LANGUAGE IF NONE DEFINED          
         BE    *+12                                                             
         TM    GT1INDS,GT1LHOST    TEST IF HOST LANGUAGE REQUIRED               
         BZ    *+12                                                             
         MVI   DICLANG,HOSTLC      FORCE HOST LANGUAGE CODE (ZERO)              
         MVI   SUBLANG,0                                                        
*                                                                               
GT010    CLI   GTMSYS,0            TEST OVERRIDE CONNECT SYSTEM                 
         BE    *+10                                                             
         MVC   TSKSYS,GTMSYS                                                    
         CLI   TSKSYS,0            CHECK SYSTEM IS DEFINED                      
         BNE   *+8                                                              
         BAS   RE,DEATH            NO SYSTEM DEFINED                            
         CLI   TSKSYS,X'FF'        REQUEST FOR SYSTEM ZERO (GENERAL)            
         BNE   *+8                                                              
         MVI   TSKSYS,0            DEFINED AS GENERAL SYSTEM MSG                
*                                                                               
         MVC   APLMTYP,GTMTYP      GET APPLICATION MESSAGE TYPE                 
         CLI   APLMTYP,0           SKIP IF DEFINED                              
         BNE   GT020                                                            
         MVI   APLMTYP,GTMERR      DEFAULT TO ERROR MESSAGES                    
         TM    GT1INDS,GT1OWRK     TEST IF WORK AREA / TWA HEADER               
         BZ    *+8                                                              
         MVI   APLMTYP,GTMTXT      DEFAULT TO TEXT MESSAGES                     
*                                                                               
GT020    TM    GT1INDS,GT1REF+GT1NOREF  TEST IF STD REF ON/OFF DEFINED          
         BNZ   GT024                                                            
         CLI   APLMTYP,GTMERR                                                   
         BE    GT022                                                            
         CLI   APLMTYP,GTMWRN                                                   
         BE    GT022                                                            
         OI    GT1INDS,GT1NOREF    DEFAULT FOR I,S,T,D                          
         B     *+8                                                              
GT022    OI    GT1INDS,GT1REF      DEFAULT FOR E,W                              
                                                                                
GT024    TM    GT1INDS,GT1DMGRE    TEST FOR EXPLICIT DMGR ERR REQ               
         BO    GT028                                                            
         ICM   R1,3,GTMSGNO        R1=MESSAGE NUMBER                            
         BNZ   GT026                                                            
         CLI   APLMTYP,GTMERR      ASSUME DMGR ERR CALL IF NO MSGNO             
         BE    GT028                                                            
         BAS   RE,DEATH            NO MESSAGE NUMBER DEFINED                    
GT026    STCM  R1,3,APLMNO                                                      
         B     GT030                                                            
*                                                                               
GT028    BAS   RE,GETDMGER         GENERATE DATA MANAGER ERR NO                 
*                                                                               
GT030    MVI   MESSAGE,C' '        CLEAR MESSAGE BUILDING AREA                  
         MVC   MESSAGE+1(L'MESSAGE-1),MESSAGE                                   
         CLI   GTMTYP,GTMFAC       FACPAK MESSAGES COME FROM CORE TABLE         
         BE    GTFAC                                                            
         MVI   MSGFLG,X'FF'        FLAG INCASE OVERFLOW                         
         MVI   OUTINDS,0           CLEAR O/P INDICATORS                         
         LA    R4,GTKEY            DEFINE MESSAGE KEY                           
         USING GMSGD,R4                                                         
         XC    GMKEY,GMKEY                                                      
         MVI   GMKREC,GMKRECQ                                                   
         MVC   GMKSYS,TSKSYS                                                    
         MVC   GMKTYP,APLMTYP                                                   
         MVC   GMKMSG,APLMNO                                                    
*                                  CORE KEY IS SYS/TYPE/LANG/NNNN               
         XC    COREADR,COREADR                                                  
         CLI   ONOROFF,OFFL        DON'T TRY CORE OFFLINE                       
         BE    GT035                                                            
         CLI   SUBLANG,0           DON'T TRY CORE IF SUB LANGUAGE               
         BNE   GT035                                                            
         TM    GT2INDS,GT2SRPF1    SVC REQ PFK1 CALL (NEEDS RECORD)             
         BNZ   GT035                                                            
         MVC   COREKEY+0(1),GMKSYS                                              
         MVC   COREKEY+1(1),GMKTYP                                              
         MVC   COREKEY+2(1),DICLANG                                             
         MVC   COREKEY+3(2),GMKMSG                                              
         BAS   RE,GETCORE          LOOK FOR MSG IN CORETAB                      
         EJECT                                                                  
***********************************************************************         
* SWITCH TO CONTROL SYSTEM TO ACCESS GENDIR/GENFIL                    *         
***********************************************************************         
GT035    MVI   SWFLAG,0            SET IF SWITCH REQUIRED                       
         OC    COREADR,COREADR     DON'T SWITCH IF CORE MSG                     
         BNZ   GT040                                                            
         CLI   ONOROFF,OFFL        DON'T TRY AND SWITCH OFFLINE                 
         BE    GT040                                                            
*                                                                               
         OC    TSVCREQ,TSVCREQ     SERVICE REQUEST WILL HAVE TO SWITCH          
         BNZ   *+12                                                             
         CLI   PHYSYS,CONTROL      SWITCH NOT REQUIRED IF CTL SYSTEM            
         BE    GT040                                                            
*                                                                               
         OC    TUSER,TUSER         CHECK USER CONNECTED TO A SYSTEM             
         BNZ   GT035A                                                           
         CLI   PHYSYS,1            CHECK SERVICE SYSTEM                         
         BNE   GT035A                                                           
         ICM   R1,15,ATCB          SAVE TCB RECOVERY DA FOR SWITCH BACK         
         MVC   RCVFSAVE,TCBRCVF-TCBD(R1) (ALLOWS =CT TO UPDATE CONTROL)         
         MVC   RCVLSAVE,TCBRCVL-TCBD(R1)                                        
*                                                                               
GT035A   GOTO1 ASWITCH,DMCB,X'0AFFFFFF',0   SWITCH TO CTL SYSTEM                
         MVI   SWFLAG,C'Y'         FLAG SWITCH BACK REQUIRED                    
         CLI   4(R1),0             SUCCESFUL SWITCH                             
         BE    GT040                                                            
         CLI   4(R1),2             SWITCHED TO NO-OP SYSTEM                     
         BE    *+8                                                              
         BAS   RE,DEATH            SWITCH TO AN INVALID SYSTEM                  
*                                                                               
GT036    TM    GT2INDS,GT2TEST     TEST FOR TEST MODE                           
         BO    GT038                                                            
*                                  LOGIC TO ACCESS GENDIR/GENFIL HERE           
*                                  CONTROL SYSTEM NOT AVAILABLE                 
GT038    LA    R4,IOAREA           FAKE UP A MESSAGE ELEMENT                    
         ZIC   R1,DICLANG                                                       
         MH    R1,=H'60'           INDEX BY LANGUAGE                            
         L     R0,=A(F00)                                                       
         AR    R1,R0                                                            
         MVC   GMKEY,GTKEY         DEFINE RECORD KEY                            
         MVI   GMSGEL,GMSGELC                                                   
         MVI   GMSGELL,GMSGFXDL+52 FAKE ELEMENT LENGTH                          
         MVC   GMSGTXT(52),8(R1)                                                
         NI    GT1INDS,X'FF'-GT1NOREF     PUT OUT THE REFERENCE ANYWAY          
         OI    OUTINDS,GT1NOCTL    INFORM CONTROL SYSTEM NOT AVAILABLE          
         LA    RF,GMSGEL                                                        
         ST    RF,AUSEEL                                                        
         ZIC   RF,GMSGELL                                                       
         STH   RF,LUSEEL                                                        
         B     GT060               SWITCH BACK & BUILD O/P MESSAGE              
         EJECT                                                                  
***********************************************************************         
* SUCCESSFUL SWITCH TO CONTROL SYSTEM SO GET REAL MESSAGE             *         
* LOOKUP HIERARCHY 1)REQUESTED MSG/LANG  2)MSG/ENG(FE+) 3)ZERO/LANG   *         
*                  4)ZERO/ENG(FE+) 5) DC H'0'                         *         
***********************************************************************         
GT040    MVC   GMKLANG,DICLANG     SET/RESET LANGUAGE CODE                      
         XI    GMKLANG,X'FF'       INVERT LANGUAGE CODE                         
         ICM   R1,15,COREADR       SEE IF CORE AVAILABLE                        
         BZ    GT045                                                            
         LA    R4,IOAREA                                                        
         MVC   GMKEY,GTKEY         COPY KEY DATA                                
         SR    RF,RF                                                            
         IC    RF,1(R1)                                                         
         BCTR  RF,0                                                             
         EX    RF,*+8              MOVE ELEMENT FROM CORE                       
         B     *+10                                                             
         MVC   GMSGEL(0),0(R1)                                                  
         LA    RF,1(RF,R1)                                                      
         MVI   0(RF),0             INSERT DUMMY END OF RECORD                   
         LA    RF,GMSGEL                                                        
         ST    RF,AUSEEL                                                        
         ZIC   RF,GMSGELL                                                       
         STH   RF,LUSEEL                                                        
         B     GT065                                                            
*                                                                               
GT045    GOTO1 ADATAMGR,DMCB,=C'DMRDHI',=C'GENDIR',GMKEY,IOAREA,0               
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+8                                                              
         BAS   RE,DEATH            DATAMANAGER RETURN NOT 0 OR EOF              
         CLI   8(R1),0                                                          
         BNE   GT050               EOF                                          
*                                                                               
         LA    R1,IOAREA                                                        
         CLC   GMKEY(GMKLANG-GMKEY),0(R1)                                       
         BNE   GT050               MESSAGE RECORD NOT FOUND                     
         CLC   GMKLANG,GMKLANG-GMKEY(R1)                                        
         BE    GT054               FOUND REQUESTED RECORD                       
         CLI   GMKLANG-GMKEY(R1),ENGHIGH                                        
         BNL   GT054               FOUND AN ENGLISH MSG (FD/FE/FF)              
         MVI   GMKLANG,ENGHIGH                                                  
         B     GT045               LOOK FOR ANY ENGLISH MESSAGE (FD+)           
*                                  SET UP FOR 'NOT FOUND' (MSG ZERO)            
GT050    CLI   GMKTYP,GMKTTXT      DON'T TRY FOR TEXT ,SCREEN OR DICT           
         BE    GTBADEX                                                          
         CLI   GMKTYP,GMKTSCR                                                   
         BE    GTBADEX                                                          
         CLI   GMKTYP,GMKTDIC                                                   
         BE    GTBADEX                                                          
         CLI   GMKTYP,GMKTGDIC                                                  
         BE    GTBADEX                                                          
         TM    GT1INDS,GT1RETNF    TEST IF RETURN 'NOT FOUND' REQ               
         BO    GTBADEX                                                          
         OC    GMKMSG,GMKMSG       CHECK IF 1ST TRY                             
         BZ    GT052                                                            
         MVI   GMKSYS,0            SET UP FOR GENERAL MESSAGE ZERO              
         XC    GMKMSG,GMKMSG                                                    
         B     GT040               TRY FOR MSG ZERO REQ LANG                    
*                                                                               
GT052    CLI   GMKLANG,ENGHIGH                                                  
         BL    *+8                                                              
         BAS   RE,DEATH            CANT FIND AN ENGLISH GENERAL MSG 0           
         MVI   GMKLANG,ENGHIGH     FINALLY TRY FOR ANY ENGLISH MESSAGE          
         B     GT045                                                            
*                                                                               
GT054    LA    R4,IOAREA           GET THE REQUIRED GENFIL REC                  
         MVC   DA,GMDDA                                                         
         XC    AFULEL(10),AFULEL                                                
         GOTO1 ADATAMGR,DMCB,=C'GETREC',=C'GENFIL',DA,GMSGD,IOWORK              
         CLI   8(R1),0                                                          
         BE    *+8                                                              
         BAS   RE,DEATH            CAN'T FIND RECORD                            
         LA    RF,GMSGEL                                                        
         ST    RF,AUSEEL           USE MASTER SHORT TEXT EL                     
         ZIC   RF,GMSGELL          POINT TO SECOND ELEMENT                      
         STH   RF,LUSEEL           SET MASTER SHORT TEXT EL LEN                 
         LA    RF,GMSGEL(RF)                                                    
         CLI   0(RF),GMTXTELC      IF ANY EXTENDED TEXT FOUND                   
         BNE   GT055                                                            
         ST    RF,AFULEL           SAVE A(FULL TEXT EL)                         
         B     GT058                                                            
*                                                                               
GT055    CLI   0(RF),GMSLELC       TEST IF SUB LANGUAGE ELEMENT                 
         BNE   GT058                                                            
         CLC   SUBLANG,GMSLLAN-GMSLD(RF)                                        
         BNE   GT056                                                            
         ST    RF,AUSEEL           USE SUB LANGAGE ELEMENT                      
         ZIC   RE,1(RF)                                                         
         STH   RE,LUSEEL           SET SUB LAGUAGE ELEMENT LENGTH               
GT056    SR    RE,RE                                                            
         IC    RE,1(RF)            POINT TO NEXT ELEMENT                        
         AR    RE,RF                                                            
         CLI   0(RE),GMTXTELC      IF ANY EXTENDED TEXT FOUND                   
         BNE   GT058                                                            
         ST    RE,AFULEL           SAVE A(FULL TEXT EL)                         
*                                                                               
GT058    CLI   SUBLANG,0                                                        
         BNE   GT060                                                            
         BAS   RE,PUTCORE          PUT MESSAGE INTO CORETAB                     
         B     GT060                                                            
*                                                                               
GTBADEX  OI    OUTINDS,GT1NOMSG    RETURNING WITH NO MESSAGE                    
*                                                                               
GT060    CLI   SWFLAG,C'Y'         CHECK IF SWITCH BACK REQUIRED                
         BNE   GT065                                                            
         OC    TUSER,TUSER         CHECK USER CONNECTED TO A SYSTEM             
         BNZ   GT064                                                            
         MVI   TSYS,0              FAKE SWITCH TO NOT CONNECTED                 
         ICM   R1,15,ATCB                                                       
         MVI   TCBSEN-TCBD(R1),1                                                
         CLI   PHYSYS,1            CHECK SWITCH BACK TO SERVICE SYSTEM          
         BNE   GT065               RESTORE SAVED RECOVERY DA SETTINGS           
         MVC   TCBRCVF-TCBD(3,R1),RCVFSAVE                                      
         MVC   TCBRCVL-TCBD(3,R1),RCVLSAVE                                      
         B     GT065                                                            
*                                                                               
GT064    MVC   DMCB(1),PHYSYS                                                   
         MVC   DMCB+1(3),=X'FFFFFF'                                             
         XC    DMCB+4(4),DMCB+4                                                 
         GOTO1 ASWITCH,DMCB                                                     
         CLI   4(R1),0                                                          
         BE    GT065                                                            
         CLI   4(R1),2             SWITCHED BACK TO NO-OP SYSTEM                
         BE    GT065                                                            
         BAS   RE,DEATH            MUST BE ABLE TO SWITCH BACK                  
         EJECT                                                                  
***********************************************************************         
* BUILD OUTPUT MESSAGE                                                *         
***********************************************************************         
GT065    TM    OUTINDS,GT1NOMSG    CHECK FOR ERROR RETURN                       
         BNZ   GT090               JUST CLEAR O/P AREA                          
*                                                                               
         LA    RE,MESSAGE          RE=A(INTERNAL MSG BUILING AREA)              
         CLI   GMKLANG,ENGHIGH                                                  
         BL    *+8                                                              
         OI    OUTINDS,GT1RETHL    INFORM ENG (FD+) RETURNED                    
         OC    GMKMSG,GMKMSG                                                    
         BNZ   *+12                                                             
         OI    OUTINDS,GT1RETM0    INFORM MESSAGE ZERO RETURNED                 
         B     GT066               FORCE MSG REF ANYWAY                         
         TM    GT1INDS,GT1NOREF    TEST DON'T GENERATE REFERENCE                
         BO    GT070                                                            
*&&US                                                                           
         CLI   GMSGSEV,C'I'        TREAT SEVERITY C'I' AS INFO                  
         BNE   *+12                                                             
         MVI   APLMTYP,GTMINF                                                   
         B     GT070                                                            
*&&                                                                             
GT066    MVC   0(1,RE),GMKTYP                                                   
         ZIC   RF,TSKSYS           REQUESTED SYS (MAY NOT BE GMKSYS)            
         LA    RF,SYSTAB(RF)                                                    
         MVC   1(1,RE),0(RF)                                                    
         SR    R0,R0                                                            
         ICM   R0,3,APLMNO         REQUESTED MSG (MAY NOT BE GMKMSG)            
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  2(5,RE),DUB                                                      
         CLI   2(RE),C'0'          OVERWRITE LEADING ZEROS                      
         BNE   *+10                                                             
         MVC   2(1,RE),DELIM       SYSID DEPENDANT DELIMITER                    
         MVC   7(1,RE),GMSGSEV                                                  
         CLI   7(RE),C' '          IGNORE SEVERITY IF SPACE                     
         BH    *+6                                                              
         BCTR  RE,0                                                             
         LA    RE,9(RE)            BUMP PAST REFERENCE + SPACE                  
*                                                                               
GT070    LH    RF,LUSEEL           ELEMENT LENGTH                               
         SH    RF,=Y(GMSGFXDL)     L'TEXT                                       
         BP    *+8                                                              
         BAS   RE,DEATH            CORRUPT ELEMENT LENGTH                       
         MVI   NESTLVL,0           INITIALISE RECURSION COUNTER                 
         MVI   INDSET,0            SET IF &I IN MSG REPLACED BY INDEX           
         MVI   TXTSET,0            SET IF &T IN MSG REPLACED BY TEXT            
         L     R0,AUSEEL                                                        
         AH    R0,=Y(GMSGFXDL)                                                  
         ST    RE,DMCB+4                                                        
         GOTO1 MOVEMSG,DMCB,((RF),(R0))                                         
         ICM   R1,15,MSGEND        A(END OF MESSAGE)                            
         TM    GT1INDS,GT1OEXT                                                  
         BZ    GT1071                                                           
         OC    AFULEL,AFULEL       TEST FOR EXTENDED TEXT PRESENT               
         BZ    GT1071                                                           
         MVC   1(3,R1),=C'...'     MOVE IN EXT INDICATORS                       
         LA    R1,3(R1)                                                         
         ST    R1,MSGEND           SET NEW END                                  
         DROP  R4                                                               
*                                                                               
GT1071   TM    OUTINDS,GT1RETM0    TEST RETURNING MESSAGE ZERO                  
         BO    GT090               JUST O/P FIXED MESSAGE                       
*                                                                               
         CLI   GTINDX,0            CHECK FOR A FIELD INDEX                      
         BE    GT080                                                            
         CLI   INDSET,0            SEE IF &I IN MSG WAS REPLACED                
         BNE   GT080                                                            
         MVI   2(R1),C'('          R1=A(END OF TEXT) FROM FINDEND               
         ZIC   RF,DICLANG                                                       
         LA    RF,NPREFIX(RF)      INDEX TO LANGUAGE DEPENDANT PREFIX           
         MVC   3(1,R1),0(RF)                                                    
         ZIC   RF,GTINDX                                                        
         CVD   RF,DUB                                                           
         UNPK  4(2,R1),DUB                                                      
         OI    5(R1),C'0'                                                       
         CLI   4(R1),C'0'                                                       
         BNE   *+12                                                             
         MVC   4(2,R1),5(R1)       MOVE "?) " OVER LEADING ZERO                 
         BCTR  R1,0                                                             
         LA    R1,6(R1)            NEW MESSAGE LENGTH                           
*                                                                               
         CLI   GTSUBX,0            CHECK FOR A SUB INDEX                        
         BE    GT075                                                            
         MVI   0(R1),C'/'                                                       
         ZIC   RF,GTSUBX                                                        
         CVD   RF,DUB                                                           
         UNPK  1(2,R1),DUB                                                      
         OI    2(R1),C'0'                                                       
         CLI   1(R1),C'0'                                                       
         BNE   *+12                                                             
         MVC   1(2,R1),2(R1)       OVERWRITE LEADING ZERO                       
         BCTR  R1,0                                                             
         LA    R1,3(R1)            NEW MESSAGE LENGTH                           
GT075    MVI   0(R1),C')'                                                       
         STCM  R1,15,MSGEND                                                     
*                                                                               
GT080    ICM   RF,7,GTATXT         A(TEXT STRING) TO APPEND                     
         BZ    GT090                                                            
         CLI   TXTSET,0            TEST IF &T WAS REPLACED                      
         BNE   GT090                                                            
*                                                                               
         SR    RE,RE               L'TEXT                                       
         ICM   RE,1,GTLTXT                                                      
         BNZ   *+12                                                             
         MVI   2(R1),C'?'                                                       
         B     GT085                                                            
*                                                                               
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   2(0,R1),0(RF)       MOVE IN TEXT                                 
GT085    BAS   RE,FINDEND                                                       
         EJECT                                                                  
***********************************************************************         
* MOVE MESSAGE TO OUTPUT AREA                                         *         
***********************************************************************         
GT090    ICM   RF,7,GTAOUT         MOVE TEXT TO OP AREA                         
         BNZ   GT095                                                            
*                                  OUTPUT TO SCREEN MESSAGE AREA                
         L     RF,TSKTWA           RF=A(TWA)                                    
         LA    RF,64(RF)           RF=A(1ST SCREEN HEADER)                      
         MVI   GTMAXL,60           MAX O/P LENGTH                               
         TM    1(RF),X'20'                                                      
         BZ    TWAERR              FIRST FIELD MUST BE PROTECTED                
         CLI   0(RF),68            60 BYTE + 8 HEADER (CANT BE EXTNDED)         
         BE    GT095                                                            
TWAERR   BAS   RE,DEATH            INVALID TWA 1ST FIELD                        
*                                                                               
GT095    SR    R1,R1                                                            
         TM    GT1INDS,GT1OWRK     TEST IF A(OUTPUT WORK AREA)                  
         BZ    *+12                                                             
         IC    R1,GTMAXL           GET MAX LENGTH OF O/P FIELD                  
         B     GT100                                                            
         OI    6(RF),X'80'         SET TRANSMIT                                 
         CLI   APLMTYP,GTMERR      HIGH INTENSITY IF ERRR                       
         BNE   *+8                                                              
         OI    6(RF),X'08'                                                      
         IC    R1,0(RF)            L'FIELD                                      
         SH    R1,=Y(8)                                                         
         TM    1(RF),X'02'         TEST FOR EXTENDED HEADER                     
         BZ    *+8                                                              
         SH    R1,=Y(8)                                                         
         LA    RF,8(RF)            SKIP HEADER                                  
         CLI   GTMAXL,0            USER MAY OVERRIDE LENGTH                     
         BE    GT100                                                            
         CLM   R1,1,GTMAXL                                                      
         BL    *+8                 MAX LEN >= FIELD SO IGNORE                   
         IC    R1,GTMAXL                                                        
         SPACE 1                                                                
GT100    CH    R1,=Y(L'MESSAGE)    R1=CANNOT BE > L'MESSAGE                     
         BNH   *+8                                                              
         LH    R1,=Y(L'MESSAGE)                                                 
         BCTR  R1,0                R1=EX LENGTH OF MAX TEXT                     
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),MESSAGE                                                  
         EJECT                                                                  
***********************************************************************         
* DEFINE RETURN VALUES FOR CALLER AND EXIT                            *         
***********************************************************************         
         TM    OUTINDS,GT1NOMSG    TEST FOR ERROR RETURN                        
         BNZ   GT110                                                            
         ICM   RE,15,MSGEND        A(END OF MESSAGE)                            
         LA    R0,MESSAGE-1                                                     
         SR    RE,R0                                                            
         STC   RE,GTMAXL           RE=L'FULL OUTPUT MESSAGE                     
         LA    R1,1(R1)            R1=L'OUTPUT FIELD                            
         CR    R1,RE                                                            
         BNL   GT110                                                            
         STC   R1,GTMAXL           R1=L'TRUNCATED TEXT                          
         AR    RF,R1               RF=A(END OF TEXT +1)                         
         BCTR  RF,0                                                             
         MVI   0(RF),C'>'          FLAG OVERFLOW                                
*                                                                               
GT110    CLI   ONOROFF,OFFL                                                     
         BNE   GT115                                                            
         ICM   R1,15,AUTL                                                       
         MVC   4(1,R1),OFFSYS      RESTORE CALLERS SE NUM                       
         B     EXIT                                                             
*                                                                               
GT115    CLI   APLMTYP,GTMERR      SET TO SOUND ALARM IF ERROR MSG              
         BE    GT117                                                            
         CLI   APLMTYP,GTMWRN      OR IF WARNING MSG                            
         BNE   GT120                                                            
GT117    ICM   R1,15,TSKTIOB       POINT TO TRANSLATOR I/O BLOCK                
         BZ    *+8                 IF SET                                       
         OI    TIOBINDS-TIOBD(R1),TIOBALRM                                      
*                                                                               
GT120    MVC   GT1INDS,OUTINDS     RETURN O/P INDICATORS                        
         MVC   TPRGIND,PRGIND      RESTORE PROGRAM INDS                         
         TM    GT2INDS,GT2SRPF1    SPECIAL SERVICE REQUEST PFK1 CALL            
         BZ    EXIT                                                             
         LA    R1,IOAREA           RETURN A(IOAREA)                             
         STCM  R1,7,GTAIO                                                       
*                                                                               
EXIT     DS    0H                                                               
         PROT  ON                  RESTORE CALLER'S STORAGE PROTECTION          
         XMOD1 1                                                                
*        ORG   *-2                                                              
*        BSM   0,RE                RESTORE CALLER'S ADDRESSING MODE             
*                                                                               
DEATH    CLI   ONOROFF,ONLINE      COME HERE VIA RE FOR PUNISHMENT              
         BNE   SUICIDE                                                          
         L     RF,=V(SSB)          EXIT IF WE ARE IN $DUMP                      
         L     RF,SSBTKADR-SSBD(RF)                                             
         L     RF,TCBUTL-TCBD(RF)                                               
         CLI   TSVCREQ+1-UTLD(RF),X'5D'                                         
         BE    EXIT                                                             
SUICIDE  LR    R0,RE               SET DISP AFTER DC H'0'                       
         SR    R0,RB                                                            
         STCM  R0,3,*+6                                                         
         DC    H'0',H'0'                                                        
         EJECT                                                                  
***********************************************************************         
* GENERATE DATMGR ERROR NUMBER                                        *         
***********************************************************************         
GETDMGER ICM   RF,7,GTADMCB        A(DMCB)                                      
         BNZ   *+8                                                              
         BAS   RE,DEATH            DMGR ERR CALL WITH NO A(DMCB)                
         ZIC   R1,8(RF)            R1=ERROR BITS (X'80'-X'01')                  
         SR    R0,R0                                                            
         SLL   R1,24                                                            
         LA    RF,8                                                             
*                                  CONVERT BIT TO BIT NUMBER                    
GTDM02   SLDL  R0,1                                                             
         LTR   R0,R0                                                            
         BNZ   *+8                                                              
         BCT   RF,GTDM02                                                        
         LA    R0,58                                                            
         SR    R0,RF                                                            
         STCM  R0,3,APLMNO         SET MESSAGE NUMBER                           
         MVI   TSKSYS,0                                                         
         BR    RE                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
* BUILD FACPAK MESSAGE                                                *         
***********************************************************************         
GTFAC    SR    RF,RF               VALIDATE MESSAGE NUMBER                      
         ICM   RF,3,GTMSGNO                                                     
         C     RF,FACMSGMX                                                      
         BNH   *+6                                                              
         SR    RF,RF               SET TO ZERO IF TOO HIGH                      
         SLL   RF,2                                                             
         LA    RF,FACMSG(RF)                                                    
         MVC   DUB(4),0(RF)        SAVE MESSAGE FLAGS AND A(MESSAGE)            
         ICM   RF,7,1(RF)                                                       
         ZIC   R1,DICLANG          INDEX MESSAGE BY LANGUAGE                    
         MH    R1,=H'60'                                                        
         AR    RF,R1                                                            
         MVC   MESSAGE(60),0(RF)                                                
         CLI   MESSAGE+2,C'/'      SET CORRECT FACPAK SYSTEM ID CHR             
         BNE   *+10                                                             
         MVC   MESSAGE+2(1),DELIM                                               
         L     RF,TSKTWA                                                        
         LA    RF,64(RF)           RF=A(HDR OF FIRST TWA FIELD)                 
         SR    R1,R1                                                            
         IC    R1,0(RF)                                                         
         BCTR  R1,0                                                             
         SH    R1,=H'8'            R1=L'FIELD-1                                 
         TM    1(RF),X'02'                                                      
         BZ    *+8                                                              
         SH    R1,=H'8'            ADJUST IF EXTENDED FIELD                     
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   8(0,RF),MESSAGE     SET MESSAGE IN TWA MESSAGE AREA              
         OI    6(RF),X'80'         SET TRANSMIT                                 
*                                                                               
         TM    DUB,X'80'           SET HIGH INTENSITY IF REQUIRED               
         BZ    *+8                                                              
         OI    6(RF),X'08'                                                      
         TM    DUB,X'40'           SET CUSOR TO MESSAGE IF REQUIRED             
         BZ    *+8                                                              
         OI    6(RF),X'40'                                                      
         TM    DUB,X'20'           SET TO SOUND ALARM IF REQUIRED               
         BZ    *+16                                                             
         ICM   R1,15,TSKTIOB       POINT TO TRANSLATOR I/O BLOCK                
         BZ    *+8                                                              
         OI    TIOBINDS-TIOBD(R1),TIOBALRM                                      
*                                                                               
         B     GT120                                                            
         EJECT                                                                  
***********************************************************************         
* MOVE TEXT TO MESSAGE BUILDING AREA                                  *         
* NTRY P1 BYTE 0    - L'INPUT MESSAGE                                 *         
* NTRY P1 BYTE 1-3  - A(INPUT MESSAGE)                                *         
* NTRY P2 BYTE 0-3  - A(OUTPUT MESSAGE)                               *         
* XIT  MSGEND       = A(LAST CHR INSERTED IN O/P MESSAGE)             *         
* NOTE R2=A(GTBLOCK)                                                  *         
***********************************************************************         
MOVEMSG  NTR1                                                                   
         ICM   R3,7,1(R1)          A(INPUT STRING)                              
         ICM   R4,15,4(R1)         A(OUTPUT STRING)                             
         ZIC   R5,0(R1)            L'INPUT STRING                               
*                                                                               
         ZIC   R1,NESTLVL          NUMBER OF RECURSIONS OF LOOP                 
         LA    R1,1(R1)                                                         
         STC   R1,NESTLVL                                                       
TEMP01   CLI   NESTLVL,1           DON'T NEST UNTIL C'&' MOD TO X'3F'           
TEMP02   BH    MV500                                                            
*                                                                               
**NOP    CLI   NESTLVL,5                                                        
**NOP    BL    *+8                                                              
**NOP    BAS   RE,DEATH            NESTED TOO DEEPLY                            
*                                                                               
MV010    CLI   0(R3),C'&&'         CHECK FOR SUBSTITUTION TEXT                  
         BNE   MV500                                                            
         CLI   1(R3),C'T'          SUBST PARAM = TEXT FIELD                     
         BE    MV150                                                            
         CLI   1(R3),C'I'          SUBST PARAM = INDEX FIELD                    
         BE    MV200                                                            
         CLI   1(R3),C'0'          SUBST PARAM FORMAT &1 TO &9                  
         BNH   MV500                                                            
         SPACE 1                                                                
MV100    ICM   R9,7,GTASUBST       A(SUBSTITUTION TEXT TABLE)                   
         BZ    MV300               NO SUBSTITUTION TEXT PROVIDED                
         MVC   DUB(1),1(R3)        PARAMETER NUMBER                             
         NI    DUB,X'0F'           CONVERT TO BINARY                            
         ZIC   R1,DUB                                                           
         SR    R0,R0                                                            
         SPACE 1                                                                
MV110    CLI   0(R9),0             END OF TABLE                                 
         BE    MV300               REQUIRED PARAMETER NOT SUPPLIED              
         BCT   R1,*+8                                                           
         B     MV120               FOUND REQUIRED PARAMETER                     
         IC    R0,0(R9)            L'TEXT TABLE ENTRY                           
         AR    R9,R0                                                            
         B     MV110                                                            
*                                                                               
MV120    ZIC   RF,0(R9)                                                         
         BCTR  RF,0                L'TEXT                                       
         LTR   RF,RF                                                            
         BZ    MV400               JUST REMOVE '&9'                             
         LA    R9,1(R9)            R9=A(TEXT)                                   
         B     MV190                                                            
*                                                                               
MV150    ICM   R9,7,GTATXT         R9=A(TEXT TO APPEND)                         
         BZ    MV400                                                            
         MVI   TXTSET,C'Y'         FLAG THAT TEXT HAS BEEN APPENDED             
*                                                                               
         SR    RF,RF               L'TEXT TO APPEND                             
         ICM   RF,1,GTLTXT                                                      
         BNZ   MV190                                                            
         LA    R9,=C'?'                                                         
         LA    RF,1                                                             
*                                                                               
MV190    GOTO1 MOVEMSG,DMCB,((RF),(R9)),(R4)                                    
         ICM   R4,15,MSGEND        A(END OF MESSAGE)                            
         LA    R4,1(R4)            NEXT AVAILABLE O/P CHR                       
         B     MV400                                                            
*                                                                               
MV200    CLI   GTINDX,0            CHECK FOR A FIELD INDEX                      
         BE    MV300               INSERT '?'                                   
         MVI   INDSET,C'Y'         FLAG THAT INDEX FIELD WAS SET                
         MVI   0(R4),C'('          BUILD (#99) FORMAT INDEX MESSAGE             
         ZIC   RF,DICLANG                                                       
         LA    RF,NPREFIX(RF)      INDEX TO LANGUAGE DEPENDANT PREFIX           
         MVC   1(1,R4),0(RF)                                                    
         ZIC   RF,GTINDX                                                        
         CVD   RF,DUB                                                           
         UNPK  2(2,R4),DUB                                                      
         OI    3(R4),C'0'                                                       
         CLI   2(R4),C'0'                                                       
         BNE   *+12                                                             
         MVC   2(2,R4),3(R4)       OVERWRITE LEADING ZERO                       
         BCTR  R4,0                                                             
         LA    R4,4(R4)            A(NEXT O/P CHR)                              
*                                                                               
         CLI   GTSUBX,0            CHECK FOR A SUB INDEX                        
         BE    MV210                                                            
         MVI   0(R4),C'/'                                                       
         ZIC   RF,GTSUBX                                                        
         CVD   RF,DUB                                                           
         UNPK  1(2,R4),DUB                                                      
         OI    2(R4),C'0'                                                       
         CLI   1(R4),C'0'                                                       
         BNE   *+12                                                             
         MVC   1(2,R4),2(R4)       OVERWRITE LEADING ZERO                       
         BCTR  R4,0                                                             
         LA    R4,3(R4)            A(NEXT O/P CHR)                              
MV210    MVI   0(R4),C')'                                                       
         LA    R4,1(R4)            NEXT O/P CHR                                 
         B     MV400                                                            
*                                                                               
MV300    MVI   0(R4),C'?'          SUBST PARAMETER NOT FOUND IN LIST            
         LA    R4,1(R4)            NEXT AVAILABLE O/P CHR                       
*                                                                               
MV400    LA    R3,2(R3)            SKIP OVER '&9' TO NEXT I/P CHR               
         BCTR  R5,0                1 LESS EXECUTION OF LOOP                     
         B     MV600                                                            
*                                                                               
MV500    MVC   0(1,R4),0(R3)       MOVE IN NEXT CHR (SIMPLE TRANSFER)           
         LA    R4,1(R4)            NEXT AVAILABLE O/P CHR                       
         LA    R3,1(R3)            NEXT I/P CHARACTER                           
*                                                                               
MV600    BCT   R5,TEMP01           TEMP DON'T CHECK FOR SUBST                   
*                                                                               
MVDONE   ZIC   R1,NESTLVL          DECREMENT NUMBER OF RECURSIONS               
         BCTR  R1,0                                                             
         STC   R1,NESTLVL                                                       
         BAS   RE,FINDEND          FIND LAST NON SPACE                          
         XIT1                      RETURN WITH R1=A(END OF TEXT)                
         EJECT                                                                  
***********************************************************************         
* SCAN CORE TABLE FOR MESSAGE                                         *         
* NTRY COREKEY CONTAINS SYS/TYPE/LANG/NNNN                            *         
* XIT  COREADR = A(ELEMENT)  ZERO IF NOT FOUND                        *         
***********************************************************************         
GETCORE  NTR1                                                                   
         ICM   R6,15,AMSGBUFF      HAVE WE GOT A(MSGBUFF)                       
         BNZ   GCORE010                                                         
         GOTO1 ACALLOV,DMCB,0,X'D9000AA0'                                       
         L     R6,0(R1)                                                         
         ST    R6,AMSGBUFF                                                      
         USING MSGBUFFD,R6                                                      
GCORE010 XC    COREADR,COREADR                                                  
         L     RF,MSGBTOTL                                                      
         LA    RF,1(RF)            BUMP NUMBER OF GTXT CALLS                    
         ST    RF,MSGBTOTL                                                      
         CLI   MSGBSTAT,C'+'       IS TABLE AVAILABLE                           
         BNE   GCOREX              NO GET OUT FAST                              
         LA    RF,MSGBNDX          RF=A(INDEX)                                  
         LH    R0,MSGBNUM          R0=N'INDEX ENTRIES                           
         LTR   R0,R0                                                            
         BZ    GCOREX              TEST FOR EMPTY TABLE                         
*                                                                               
GCORE020 CLC   COREKEY,0(RF)       KEEP THIS LOOP TIGHT!                        
         BE    GCORE030            WE GOT IT (OF COURSE)                        
         LA    RF,8(RF)                                                         
         BCT   R0,GCORE020                                                      
         B     GCOREX              NOT THERE GO GET FROM DISK                   
*                                                                               
GCORE030 CLI   5(RF),X'FF'                                                      
         BE    GCORE040                                                         
         IC    RE,5(RF)                                                         
         LA    RE,1(RE)            BUMP FREQUENCY COUNTER                       
         STC   RE,5(RF)                                                         
GCORE040 LA    RE,MSGBUFFS         RE=A(BUFFER)                                 
         ICM   R0,3,6(RF)          R0=DISPLACEMENT INTO BUFFER                  
         AR    RE,R0                                                            
         CLI   1(RE),83            TEST ELEMENT LEN <= 83                       
         BH    GCOREX                                                           
         ST    RE,COREADR                                                       
         LA    RE,1                BUMP SUCCESS RATE                            
         A     RE,MSGBCORE                                                      
         ST    RE,MSGBCORE                                                      
GCOREX   XIT1                                                                   
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* ADD MESSAGE INTO CORETAB                                            *         
* NTRY COREKEY CONTAINS SYS/TYPE/LANG/NNNN                            *         
* NTRY IOAREA CONTAINS MESSAGE RECORD                                 *         
* XIT  COULDN'T GIVE A STUFF                                          *         
***********************************************************************         
PUTCORE  NTR1                                                                   
         LA    R4,IOAREA                                                        
         USING GMSGD,R4                                                         
         ICM   R6,15,AMSGBUFF      HAVE MUST HAVE A(MSGBUFF)                    
         USING MSGBUFFD,R6                                                      
         BZ    PCOREX              IF NOT FORGET IT                             
         CLI   MSGBSTAT,C'+'                                                    
         BNE   PCOREX              MUST BE ENABLED                              
         TM    GMFELEM,GMCOREQ                                                  
         BNO   PCOREX              SO MUST MESSAGE                              
         OC    MSGBEND,MSGBEND                                                  
         BNZ   PCORE1                                                           
         LA    R1,MSGBUFFS         INITIALISE ADCONS 1ST TIME                   
         ST    R1,MSGBNXT                                                       
         L     R0,=A(MSGBUFFX-MSGBUFFS)                                         
         AR    R0,R1                                                            
         ST    R0,MSGBEND                                                       
PCORE1   CLC   MSGBNUM,MSGBMAX     TEST FOR INDEX FULL                          
         BNL   PCOREX                                                           
         LH    R1,MSGBNUM                                                       
         SLL   R1,3                                                             
         LA    R1,MSGBNDX(R1)      LOCATE FREE INDEX ENTRY                      
         MVC   0(5,R1),COREKEY                                                  
         MVI   5(R1),0             ZERO COUNTER                                 
         L     RF,MSGBEND                                                       
         S     RF,MSGBNXT          RF=BYTES AVAILABLE IN BUFFER                 
         SR    RE,RE                                                            
         IC    RE,GMSGELL                                                       
         CR    RE,RF               TEST MESSAGE WILL FIT                        
         BH    PCOREX                                                           
         L     RF,MSGBNXT          A(NEXT BUFFER ADDRESS)                       
         BCTR  RE,0                                                             
         EX    RE,*+8              MOVE MESSAGE ELEMENT IN                      
         B     *+10                                                             
         MVC   0(0,RF),GMSGEL                                                   
         LA    RE,1(RE,RF)         POINT PAST MESSAGE                           
         ST    RE,MSGBNXT          SET NEW A(NEXT)                              
         LA    R0,MSGBUFFS                                                      
         SR    RF,R0                                                            
         STCM  RF,3,6(R1)          SET DISP IN INDEX                            
         LH    R1,MSGBNUM                                                       
         LA    R1,1(R1)            BUMP N'INDEX ENTRIES                         
         STH   R1,MSGBNUM                                                       
PCOREX   XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* FIND LAST NON/NULL SPACE CHR IN MESSAGE                             *         
* RETURN ADDRESS IN MSGEND                                            *         
***********************************************************************         
FINDEND  LA    R1,MESSAGE+L'MESSAGE-1                                           
         LA    RF,LMESS                                                         
         CLI   MSGFLG,X'FF'        TEST FLAG STILL SET                          
         BE    *+8                                                              
         BAS   RE,DEATH            MESSAGE EXCEEDS MAX LENGTH                   
*                                                                               
FE010    TM    0(R1),255-X'40'     DROP THRU UNLESS NULL OR SPACE               
         BNZ   *+10                                                             
         BCTR  R1,0                                                             
         BCT   RF,FE010            NOTE - LAST PASS R1=A(MSG)-1                 
FE020    STCM  R1,15,MSGEND                                                     
         BR    RE                                                               
         EJECT                                                                  
* LITERALS ETC.                                                                 
*                                                                               
         LTORG                                                                  
*                                                                               
AMSGBUFF DC    F'0'                A(MSGBUFF) SET FIRST TIME IN                 
NPREFIX  DS    0XL16               PREFIX FOR INDEX (#99)                       
         DC    16C'#'                                                           
         ORG   NPREFIX+LANGFRE                                                  
         DC    X'5A'               FRENCH 'PARAGRAPH' SYMBOL                    
         ORG   NPREFIX+L'NPREFIX                                                
         EJECT                                                                  
SYSTAB   DS    0CL1                MAPS SYSTEM NUMBER TO SYSTEM LETTER          
*&&UK                                                                           
*                0123456789ABCDEF                                               
         DC    C'GD23MLAF8BCZ??I?' 00-0F                                        
         DC    C'????????????????' 10-1F                                        
         DC    C'????????????????' 20-2F                                        
         DC    C'????????????????' 30-3F                                        
         DC    C'????????????????' 40-4F                                        
         DC    C'????????????????' 50-5F                                        
         DC    C'????????????????' 60-6F                                        
         DC    C'????????????????' 70-7F                                        
         DC    C'????????????????' 80-8F                                        
         DC    C'????????????????' 90-9F                                        
         DC    C'????????????????' A0-AF                                        
         DC    C'????????????????' B0-BF                                        
         DC    C'????????????????' C0-CF                                        
         DC    C'????????????????' D0-DF                                        
         DC    C'????????????????' E0-EF                                        
         DC    C'????????????????' F0-FF                                        
*&&                                                                             
*&&US                                                                           
*                0123456789ABCDEF                                               
         DC    C'GDSNPLATRBCZWENS' 00-0F                                        
         DC    C'P????LLSNP??????' 10-1F                                        
         DC    C'????????????????' 20-2F                                        
         DC    C'????????????????' 30-3F                                        
         DC    C'??????T?????????' 40-4F                                        
         DC    C'????????????????' 50-5F                                        
         DC    C'????????????????' 60-6F                                        
         DC    C'????????????????' 70-7F                                        
         DC    C'????????????????' 80-8F                                        
         DC    C'????????????????' 90-9F                                        
         DC    C'????????????????' A0-AF                                        
         DC    C'????????????????' B0-BF                                        
         DC    C'????????????????' C0-CF                                        
         DC    C'????????????????' D0-DF                                        
         DC    C'????????????????' E0-EF                                        
         DC    C'????????????????' F0-FF                                        
*&&                                                                             
         SPACE 1                                                                
LANGTAB  DS    0XL2                LANGUAGE TABLE - INDEXED BY LANG             
         DC    AL1(00,00)          00 ENG                                       
         DC    AL1(00,00)          01 ENG UK                                    
         DC    AL1(00,00)          02 ENG US                                    
         DC    AL1(03,00)          03 GERMAN                                    
         DC    AL1(04,00)          04 FRENCH                                    
         DC    AL1(05,00)          05 SPANISH                                   
         DC    AL1(06,00)          06 ITALIAN                                   
         DC    AL1(07,00)          07 DUTCH                                     
         DC    AL1(00,00)          08 N/D                                       
         DC    AL1(00,00)          09 N/D                                       
         DC    AL1(00,00)          10 N/D                                       
         DC    AL1(00,00)          11 N/D                                       
         DC    AL1(00,00)          12 N/D                                       
         DC    AL1(00,00)          13 N/D                                       
         DC    AL1(00,00)          14 N/D                                       
         DC    AL1(00,00)          15 N/D                                       
         DC    AL1(01,01)          16 IRISH    (SUB OF UK ENGLISH)              
         DC    AL1(02,01)          17 CANADIAN (SUB OF US ENGLISH)              
LANGMAX  EQU   17                                                               
         EJECT                                                                  
*FASYSLST                          SYSTEM LIST USED OFFLINE ONLY                
         PRINT OFF                                                              
       ++INCLUDE FASYSLST                                                       
         PRINT ON                                                               
CTLSYS   DC    C'CONTROL'          OFFLINE SYSTEM NAME                          
FILES    DC    C'NGENDIR NGENFIL X'                                             
GENOPEN  DC    C'N'                OFFLINE FLAG ABOVE FILES OPEN                
*                                                                               
YES      EQU   C'Y'                                                             
HOSTLC   EQU   X'00'               HOST LANGUAGE CODE                           
HOSTLANG EQU   X'FF'               HOST LANGUAGE (INVERTED)                     
ENGHIGH  EQU   X'FD'               HIGHEST ENGLISH (INVERTED) = EUS             
CONTROL  EQU   X'0A'               CONTROL SYSTEM Id                            
*                                                                               
FACMSGMX DC    A(11)               MAXIMUM FACPAK MESSAGE NUMBER                
FACMSG   DC    X'00',AL3(F00)                                                   
         DC    X'00',AL3(F01)                                                   
         DC    X'00',AL3(F02)                                                   
         DC    X'00',AL3(F03)                                                   
         DC    X'E0',AL3(F04)      HIGH/CURSOR/ALARM                            
         DC    X'E0',AL3(F05)      HIGH/CURSOR/ALARM                            
         DC    X'E0',AL3(F06)      HIGH/CURSOR/ALARM                            
         DC    X'E0',AL3(F07)      HIGH/CURSOR/ALARM                            
         DC    X'E0',AL3(F08)      HIGH/CURSOR/ALARM                            
         DC    X'E0',AL3(F09)      HIGH/CURSOR/ALARM                            
         DC    X'E0',AL3(F10)      HIGH/CURSOR/ALARM                            
         DC    X'E0',AL3(F11)      HIGH/CURSOR/ALARM                            
*                                                                               
F00 DC C'DW/0000 Message data temporarily unavailable                '          
    DC C'DW/0000 Message data temporarily unavailable                '          
    DC C'DW/0000 Message data temporarily unavailable                '          
    DC C'DW/0000 Meldung zeitweise nicht verf}gbar                   '          
    DC C'DW/0000 Message data temporarily unavailable                '          
    DC C'DW/0000 Message data temporarily unavailable                '          
    DC C'DW/0000 Message data temporarily unavailable                '          
    DC C'DW/0000 Message data temporarily unavailable                '          
    DC C'DW/0000 Message data temporarily unavailable                '          
*                                                                               
F01 DC C'DW/0001 Invalid or no data received - Please re-enter       '          
    DC C'DW/0001 Invalid or no data received - Please re-enter       '          
    DC C'DW/0001 Invalid or no data received - Please re-enter       '          
    DC C'DW/0001 Bitte neue Eingabe                                  '          
    DC C'DW/0001 Entrez encore s''il vous plait                       '         
    DC C'DW/0001 Datos invalidos -  Anote otra vez por favor         '          
    DC C'DW/0001 Invalid or no data received - Please re-enter       '          
    DC C'DW/0001 Gegevens ongeldig - s.v.p. opnieuw invoeren         '          
    DC C'DW/0001 Invalid or no data received - Please re-enter       '          
*                                                                               
F02 DC C'DW/0002 Input inhibited - Please wait and try later         '          
    DC C'DW/0002 Input inhibited - Please wait and try later         '          
    DC C'DW/0002 Input inhibited - Please wait and try later         '          
    DC C'DW/0002 Eingabesperre - bitte warten und nochmals versuchen '          
    DC C'DW/0002 Entree restrictee - Attendez et essayez plus tard   '          
    DC C'DW/0002 Entrada impedida- Pruebe mas tarde por favor        '          
    DC C'DW/0002 Input inhibited - Please wait and try later         '          
    DC C'DW/0002 Invoer niet toegastaan - probeer het later opnieuw  '          
    DC C'DW/0002 Input inhibited - Please wait and try later         '          
*                                                                               
F03 DC C'DW/0003 Transaction cancelled as requested                  '          
    DC C'DW/0003 Transaction cancelled as requested                  '          
    DC C'DW/0003 Transaction cancelled as requested                  '          
    DC C'DW/0003 Vorgang abgebrochen                                 '          
    DC C'DW/0003 La transaction est complete                         '          
    DC C'DW/0003 Transaccion cancelada, como pedido                  '          
    DC C'DW/0003 Transaction cancelled as requested                  '          
    DC C'DW/0003 Transactie op verzoek geannuleerd                   '          
    DC C'DW/0003 Transaction cancelled as requested                  '          
*                                                                               
F04 DC C'DW/0004 Unable to create report - Print queue is full       '          
    DC C'DW/0004 Unable to create report - Print queue is full       '          
    DC C'DW/0004 Unable to create report - Print queue is full       '          
    DC C'DW/0004 Kein Report mºglich, da Warteschlange voll          '          
    DC C'DW/0004 Unable to create report - Print queue is full       '          
    DC C'DW/0004 Unable to create report - Print queue is full       '          
    DC C'DW/0004 Unable to create report - Print queue is full       '          
    DC C'DW/0004 Unable to create report - Print queue is full       '          
    DC C'DW/0004 Unable to create report - Print queue is full       '          
*                                                                               
F05 DC C'DW/0005 Data locked by another user - Please retry          '          
    DC C'DW/0005 Data locked by another user - Please retry          '          
    DC C'DW/0005 Data locked by another user - Please retry          '          
    DC C'DW/0005 Zugriff verhindert - Bitte neuer Versuch            '          
    DC C'DW/0005 Data locked by another user - Please retry          '          
    DC C'DW/0005 Data locked by another user - Please retry          '          
    DC C'DW/0005 Data locked by another user - Please retry          '          
    DC C'DW/0005 Data locked by another user - Please retry          '          
    DC C'DW/0005 Data locked by another user - Please retry          '          
*                                                                               
F06 DC C'DW/0006 Updates to files inhibited - Please try later       '          
    DC C'DW/0006 Updates to files inhibited - Please try later       '          
    DC C'DW/0006 Updates to files inhibited - Please try later       '          
    DC C'DW/0006 Aktual. nicht mºglich - Neuer Versuch sp{ter        '          
    DC C'DW/0006 Updates to files inhibited - Please try later       '          
    DC C'DW/0006 Updates to files inhibited - Please try later       '          
    DC C'DW/0006 Updates to files inhibited - Please try later       '          
    DC C'DW/0006 Updates to files inhibited - Please try later       '          
    DC C'DW/0006 Updates to files inhibited - Please try later       '          
*                                                                               
F07 DC C'DW/0007 All access to files inhibited - Please try later    '          
    DC C'DW/0007 All access to files inhibited - Please try later    '          
    DC C'DW/0007 All access to files inhibited - Please try later    '          
    DC C'DW/0007 Zugriff nicht mºglich - Neuer Versuch sp{ter        '          
    DC C'DW/0007 All access to files inhibited - Please try later    '          
    DC C'DW/0007 All access to files inhibited - Please try later    '          
    DC C'DW/0007 All access to files inhibited - Please try later    '          
    DC C'DW/0007 All access to files inhibited - Please try later    '          
    DC C'DW/0007 All access to files inhibited - Please try later    '          
*                                                                               
F08 DC C'DW/0008 Soon terminal queue is full - Please try later      '          
    DC C'DW/0008 Soon terminal queue is full - Please try later      '          
    DC C'DW/0008 Soon terminal queue is full - Please try later      '          
    DC C'DW/0008 Zuviele Anforderungen - Neuer Versuch sp{ter        '          
    DC C'DW/0008 Soon terminal queue is full - Please try later      '          
    DC C'DW/0008 Soon terminal queue is full - Please try later      '          
    DC C'DW/0008 Soon terminal queue is full - Please try later      '          
    DC C'DW/0008 Soon terminal queue is full - Please try later      '          
    DC C'DW/0008 Soon terminal queue is full - Please try later      '          
*                                                                               
F09 DC C'DW/0009 Temporary Storage not available - Please Reconnect  '          
    DC C'DW/0009 Temporary Storage not available - Please Reconnect  '          
    DC C'DW/0009 Temporary Storage not available - Please Reconnect  '          
    DC C'DW/0009 Speicher nicht verf}gbar - Bitte neu anmelden       '          
    DC C'DW/0009 Temporary Storage not available - Please Reconnect  '          
    DC C'DW/0009 Temporary Storage not available - Please Reconnect  '          
    DC C'DW/0009 Temporary Storage not available - Please Reconnect  '          
    DC C'DW/0009 Temporary Storage not available - Please Reconnect  '          
    DC C'DW/0009 Temporary Storage not available - Please Reconnect  '          
*                                                                               
*&&UK                                                                           
F10 DC C'DW/0010 Updates not available in this ADV application       '          
    DC C'DW/0010 Updates not available in this ADV application       '          
    DC C'DW/0010 Updates not available in this ADV application       '          
    DC C'DW/0010 nderungen in diesem ADV-System nicht mºglich       '          
    DC C'DW/0010 Updates not available in this ADV application       '          
    DC C'DW/0010 Updates not available in this ADV application       '          
    DC C'DW/0010 Updates not available in this ADV application       '          
    DC C'DW/0010 Updates not available in this ADV application       '          
    DC C'DW/0010 Updates not available in this ADV application       '          
*&&                                                                             
*&&US                                                                           
F10 DC C'DW/0010 Updates not available in this online application    '          
    DC C'DW/0010 Updates not available in this online application    '          
    DC C'DW/0010 Updates not available in this online application    '          
    DC C'DW/0010 nderungen in diesem ADV-System nicht mºglich       '          
    DC C'DW/0010 Updates not available in this online application    '          
    DC C'DW/0010 Updates not available in this online application    '          
    DC C'DW/0010 Updates not available in this online application    '          
    DC C'DW/0010 Updates not available in this online application    '          
    DC C'DW/0010 Updates not available in this online application    '          
*&&                                                                             
*                                                                               
F11 DC C'DW/0011 System access unavailable - Please contact DDS -    '          
    DC C'DW/0011 System access unavailable - Please contact DDS -    '          
    DC C'DW/0011 System access unavailable - Please contact DDS -    '          
    DC C'DW/0011 System access unavailable - Please contact DDS -    '          
    DC C'DW/0011 System access unavailable - Please contact DDS -    '          
    DC C'DW/0011 System access unavailable - Please contact DDS -    '          
    DC C'DW/0011 System access unavailable - Please contact DDS -    '          
    DC C'DW/0011 System access unavailable - Please contact DDS -    '          
    DC C'DW/0011 System access unavailable - Please contact DDS -    '          
         EJECT                                                                  
* DSECT TO COVER W/S                                                            
*                                                                               
WORKD    DSECT                                                                  
DUB      DS    D                                                                
DMCB     DS    6F                                                               
ADATAMGR DS    AL4                 A(DATAMANAGER)                               
ASYSFACS DS    AL4                 A(SYSFACS) - ONLINE                          
ASSB     DS    AL4                 A(SSB)                                       
ATCB     DS    AL4                 A(TCB)                                       
AUTL     DS    AL4                 A(UTL)                                       
ASWITCH  DS    AL4                 A(FASWITCH)                                  
ACALLOV  DS    AL4                 A(CALLOV)                                    
TSKTWA   DS    AL4                 CURRENT TASK A(TWA)                          
TSKTIOB  DS    AL4                 CURRENT TASK A(TIOT)                         
RELO     DS    F                   RELOCATION FACTOR                            
TSKSYS   DS    XL1                 CURRENT TASK CONNECT SYSTEM                  
TSKLANG  DS    XL1                 CURRENT TASK CONNECT LANGUAGE                
TSKSVCRQ DS    XL2                 TASK'S SVC REQ INFO                          
DICLANG  DS    XL1                 LANGUAGE CODE IN DICTIONARY                  
SUBLANG  DS    XL1                 SUB LANGUAGE CODE                            
PHYSYS   DS    XL1                 PHYSICAL SYSTEM NUMBER (ONLINE)              
OFFSYS   DS    XL1                 OFFLINE SE NUMBER                            
PRGIND   DS    XL1                 SAVED PROGRAM INDICATOR BYTE                 
APLMNO   DS    XL2                 MESSAGE NUMBER FROM APPLIC                   
APLMTYP  DS    XL1                 MESSAGE TYPE FROM APPLIC                     
OUTINDS  DS    XL1                 OUTPUT INDICATORS                            
NESTLVL  DS    XL1                 NESTING LEVEL WITHIN MOVEMSG                 
INDSET   DS    XL1                 FLAG THAT &I WAS REPLACED IN MSG             
TXTSET   DS    XL1                 FLAG THAT &T WAS REPLACED IN MSG             
SWFLAG   DS    XL1                 FLAG THAT A SWITCH HAS TAKEN PLACE           
RCVFSAVE DS    XL3                 TCB RECOVERY FIRST DA SAVE                   
RCVLSAVE DS    XL3                 TCB RECOVERY LAST DA SAVE                    
SYSID    DS    XL1                 SYSTEM I.D.                                  
DELIM    DS    CL1                 MESSAGE DELIMITER                            
MSGEND   DS    F                   A(END OF MESSAGE)                            
COREADR  DS    F                   A(CORE MESSAGE)                              
*                                                                               
AFULEL   DS    A                   A(FULL TEXT MSG EL)                          
AUSEEL   DS    A                   A(TEXT ELEMENT TO USE)                       
LUSEEL   DS    H                   L'TEXT ELEMENT TO USE                        
*                                                                               
COREKEY  DS    CL5                 5 BYTE CORE TABLE KEY                        
ONOROFF  DS    X                   ON/OFF LINE FLAG                             
ONLINE   EQU   1                                                                
TEST     EQU   2                                                                
OFFL     EQU   3                                                                
DA       DS    XL4                                                              
GTKEY    DS    XL44                                                             
MESSAGE  DS    XL100               NOTE - OVERFLOW INTO IOAREA                  
MSGFLG   DS    X                   SET TO 'FF' TO DETECT OVERFLOW               
LMESS    EQU   L'MESSAGE                                                        
IOAREA   DS    XL2000                                                           
IOWORK   DS    XL96                                                             
WORKX    EQU   *                                                                
         EJECT                                                                  
* GEGENMSG                                                                      
       ++INCLUDE GEGENMSG                                                       
         EJECT                                                                  
* FAGETTXTD                                                                     
       ++INCLUDE FAGETTXTD                                                      
         EJECT                                                                  
* FADSECTS                                                                      
       ++INCLUDE FADSECTS                                                       
* FASYSLSTD                                                                     
       ++INCLUDE FASYSLSTD                                                      
         SPACE 2                                                                
* DDCOMFACS                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCOMFACS                                                      
         PRINT ON                                                               
* FAMSGBUFFD                                                                    
         PRINT OFF                                                              
       ++INCLUDE FAMSGBUFFD                                                     
         PRINT ON                                                               
* DDLANGEQUS                                                                    
         PRINT OFF                                                              
       ++INCLUDE DDLANGEQUS                                                     
         PRINT ON                                                               
         SPACE 2                                                                
* DMDTFPH                                                                       
         PRINT OFF                                                              
       ++INCLUDE DMDTFPH                                                        
         PRINT ON                                                               
         SPACE 2                                                                
* DMDTFIS                                                                       
         PRINT OFF                                                              
       ++INCLUDE DMDTFIS                                                        
         PRINT ON                                                               
         SPACE 2                                                                
* DDMASTD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DDMASTD                                                        
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'006FAGETTXT  04/06/20'                                      
         END                                                                    
