*          DATA SET EZADDSNV   AT LEVEL 146 AS OF 01/23/20                      
*CATALP EZADDSNV                                                                
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - INIT'                         
***********************************************************************         
*                                                                     *         
*        USED WITH SPZ502 - LINK WITH LKSPZ502                        *         
*                                                                     *         
*  FIX COUNTS OF OVERWRITE REP INVOICES                               *         
***********************************************************************         
*                                                                     *         
*  LEV 01-   OCT10/94 CONVERT TO MINIO INVOICE RECORDS                *         
*  LEV 08-   DEC09/94 USE GETBROAD TO GET INVOICE START/END DTS       *         
*  LEV 09-   DEC21/94 CHECK FOR DUPLICATE INVOICE & CK OK TO ADD DUPE *         
*  LEV 10-   FEB13/95 DON'T PUT PRD IN HDR IF GETTING PRD FROM COMMMLS*         
*  LEV 11-   FEB21/95 PUT CT AND DOLLARS IN HEADER                    *         
*  LEV 12-   APR05/95 FIX DADDS DUMP                                  *         
*  LEV 13-   MAY09/95 FIX BDS - BVS DATA                              *         
*  LEV 14-   MAY11/95 FIX BROADCAST DATES IF NO FROM - TO DATES GIVEN *         
*  LEV 15-   MAY19/95 BYPASS MINIO WRITES IF TEST OR NO WRITE         *         
*  LEV 16-   JUN13/95 CHANGE MAX REC SIZE                             *         
*  LEV 17-   JUL11/95 CHANGE MAX REC SIZE FROM 4080 TO 3976           *         
*  LEV 18-   OCT26/95 CK FOR DUPLICATE INVOICE AT ADDEL               *         
*  LEV 19-   FEB21/96 RANDOMLY SET SNVHDAUQ BIT FOR AGENCY CK         *         
*  LEV 20    MAR29/96 PUT PROD AS START OF COKEAT INV #               *         
*  LEV 21    APR02/96 DROP OUT ABOVE CODE                             *         
*  LEV 22    APR26/96 IF NOT PUTTING PRD IN HDR, NO EST EITHER        *         
*  LEV 23    APR30/96 DO NOT CONVERT ZERO INVOICES                    *         
*  LEV 24    MAY02/96 DROP CODE FOR  ZERO INVOICES                    *         
*  LEV 25    MAY18/96 ADD NWK                                         *         
*  LEV 26    JUL24/96 DON'T ADD 2ND COMML UNLESS PTR PROD             *         
*  LEV 27-29 JUL29/96 FIX RANDOM BUG                                  *         
*  LEV 30    AUG09/96 FIX EZBLOCK AND ORDER #                         *         
*  LEV 31    AUG14/96 FORCE ORDER # TO BLKS                           *         
*  LEV 32    AUG20/96 CATCH BAD TIME                                  *         
*  LEV 33    AUG29/96 ADD TRANSFER BATCH DATE TO HDR ELEM             *         
*  LEV 34    SEP04/96 ADD SPOT DETAIL DATE CHECK                      *         
*  LEV 35    FEB25/97 STOP ADDING PROD TO DETAIL IF NOT GET FROM COMML*         
*  LEV 36    MAR18/97 STOP EST TO DETAIL/ADD AIL IF NOT GET FROM COMML*         
*  LEV 37    MAY21/97 ADD TAX TO NEW INVOICE HEADER ELEM (COKE ONLY)  *         
*  LEV 38    JUN11/97 IF PUTTING PROD IN DETAIL, PUT EST THERE ALSO   *         
*  LEV 39    JUN12/97 COKE ONLY - IF ZERO SPOTS/$, USE GROSS $        *         
*  LEV 40    JUN19/97 COKE ONLY - VALIDATE ESTIMATE - DONE IN EZMOD   *         
*  LEV 41    JUL24/97 CK SPOT DETAIL TIME MINUTES                     *         
*  LEV 42    AUG14/97 FOR COKE ONLY MOVE TRADING PTR TO CONTRACT      *         
*  LEV 43    OCT27/97 ADD STOP SPOT DATE OUTSIDE MOS DATES            *         
*  LEV 44    NOV05/97 MORE TIME CHECKING NEEDED                       *         
*  LEV 45    MAR04/98 PUT LOCAL CABLE IN X'40' INVOICE DETAIL ELEM    *         
*  LEV 46    MAR18/98 ONE MORE TEST FOR EZWRITE/EZTEST                *         
*  LEV 47    MAY03/98 ADD ERROR-NO NET FOR LOCAL CABLE                *         
*  LEV 48    JUN18/98 ADD FLAG INVOICE FOR ORDER TYPE MID FLIGHT CL   *         
*                     ALSO ALLOW ADD OVER DUPLICATE IF OLD IS MID FLT *         
*            AUG04/98 ADDED COMMENTS FOR MID FLIGHT CLEARANCE INVOICE *         
*  LEV 50    OCT30/98 CHECKED MORE CODES FOR STAPERR                  *         
*  LEV 51    DEC02/98 CHECKED FOR BAD INVOICE START DATE              *         
*  LEV 52    JAN13/99 USE EZTEST IN ADDITION TO EZWRITE               *         
*  LEV 53    JAN25/99 ADD CREATION DATE IN 10 ELEM - SNVHDCDT         *         
*  LEV 54    FEB08/99 CHECK FOR BAD (TOO HIGH) TIME - SCRATCHED       *         
*  LEV 55    MAR09/99 FOR N- CMMLS AND SET NO MATCH FLAG              *         
*  LEV 56    MAR29/99 SET AUTO I5 FOR RAPP (O MATCH FLAG              *         
*  LEV 57    APR22/99 BYPASS INVOICES WITH BAD DOLLAR FIELDS          *         
*  LEV 58    MAY06/99 BYPASS INVOICES WITH BAD DATE FIELDS            *         
*                     BYPASS BAD EST INVOICES                         *         
*  LEV 59    AUG04/97 JWT - REQUIRE ESTIMATE SPOT PAK ONLY            *         
*  LEV 60    AUG11/97 SET EZIHISDT/EDT TO CAL IF NETPAK/N             *         
*  LEV 61    AUG13/97 SET UP FR SAME AS JW                            *         
*  LEV 62    AUG19/97 SET EZERBRDT, SET ON IGNORE TIME IF TIME HAS T  *         
*  LEV 63    OCT28/99 FIX EZMCTINV                                    *         
*  LEV 64    NOV16/99 FIX EZSPDATE                                    *         
*  LEV 65    DEC22/99 FIX EZIHCMST IF 2000, ALSO EZIH                 *         
*  LEV 66    JAN19/00 ADD NET INTEGRATION CHARGE TO NEW INVOICE       *         
*  LEV 67    FEB09/00 FIX BNE TO PR170E TO BE                         *         
*  LEV 68    MAR28/00 ADD P/B CMML IF GETTING PROD FROM CMML          *         
*  LEV 69    JUN29/00 ADD INVOICE  IF GETTING PROD FROM CMML          *         
*  LEV 70    JUL18/00 CK CMML2 TO BE MORE THAN 1 BYTE                 *         
*  LEV 71    JUL24/00 DO NOT PUT EST IN DETAIL ORDER ELEM             *         
*  LEV 72    AUG23/00 ADD FE ELEM TO INVOICE REC                      *         
*  LEV 73    OCT03/00 ALLOW DUP ADD OF DETAIL ELEM IF DUPES ALLOWED   *         
*  LEV 74    OCT13/00 FIX INVOICE START/END DATES IF NOT PROVIDED     *         
*                     AND ADD NETWORK BYTE IN DETAIL ELEM             *         
*                     FIX ESTIMATE GOING IN BOTH HEADER & DETAIL      *         
*  LEV 75    JAN12/01 BYPASS PERIOD DATES IF NOT IN PERIOD            *         
*                     SOON PROCESSING CHANGE TO MAX MINIO REC LENGTH  *         
*  LEV 76    MAR19/01 SOON - BYPASS TOO LARGE INVOICES                *         
*  LEV 80    APR09/01 IGNORE STA TYP-ONLY CONVERT ABC/CBS/NBC/FOX/WBN *         
*                     UPN TO CALENDAR, ALL ELSE TO BROAD              *         
*  LEV 81    MAY03/01 MAKE 40 ELEM LONGER FOR NETPAK                  *         
*  LEV 82    MAY07/01 FIX REGISTER ERROR                              *         
*  LEV 83    MAY10/01 ALLOW FOR NETS WITH BLANKS                      *         
*  LEV 84    JUN13/01 MAKE MINIO BUFFERS LARGER, USE EZEQVSTA         *         
*  LEV 85    JUL30/01 FIX LOCAL CABLE EQUIVALENCED TO STATION         *         
*  LEV 86    NOV15/01 ADD H9 TO HARD CODE                             *         
*  LEV 87    JAN25/02 FIX START PERIOD OUT OF MOS                     *         
*  LEV 88    MAR06/02 MAKE MINIO BUFFER LARGER - FROM 128000 T0 194000*         
*  LEV 89    MAR21/02 REP INVOICING MINIO BUFF FROM 194000 T0 512000  *         
*                                                                     *         
*  LEV 95    MAR19/03 TAX=NET+TAX FOR CANADA ISCANADA SUBROUTINE      *         
***********************************************************************         
         PRINT NOGEN                                                            
EZADDSNV CSECT                                                                  
         NMOD1 EZADSDL,**EZADS                                                  
         LAY   RA,COMSUBS                                                       
         USING COMSUBS,RA                                                       
         USING EZADSD,RC                                                        
         L     R7,0(R1)            A(EZBLOCK)                                   
         USING EZBLOCKD,R7                                                      
         L     R8,4(R1)            A(SPWORK)                                    
         LR    R9,R8                                                            
         AHI   R9,4096                                                          
         USING SPWORKD,R8,R9                                                    
*                                                                               
         MVI   EZERRCD,0           CLEAR ERROR                                  
*                                                                               
         CLI   ADSCTL,ADS1STQ      SKIP IF NOT FIRST TIME                       
         BNE   DONEINIT                                                         
*                                                                               
         BRAS  RE,GENINIT                                                       
         BRAS  RE,MININIT             INIT STORAGE AREASÃ¡                       
*                                                                               
DONEINIT DS    0H                                                               
         LA    R5,MINBLKBF         USE BUFFER MINIO KEY                         
         USING MINBLKD,R5                                                       
*                                                                               
         CLI   EZMODE,EZINVP       PROC INV                                     
         BE    PRINV                                                            
         CLI   EZMODE,EZSPTP       PROCESS SPOT DETAIL                          
         BE    PRANN                                                            
         CLI   EZMODE,EZINVL       LAST FOR INVOICE                             
         BE    LINV                                                             
*                                                                               
EQXIT    CR    RB,RB                                                            
         J     EXIT                                                             
NEQXIT   LTR   RB,RB                                                            
EXIT     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - PRINV'                        
***********************************************************************         
*                                                                     *         
*        PROCESS INVOICE HEADER                                       *         
*                                                                     *         
***********************************************************************         
*                                                                               
PRINV    DS    0H                                                               
         XC    EZIHCINV,EZIHCINV                                                
*                                                                               
         XC    EZINVSIZ,EZINVSIZ                                                
*                                                                               
         XC    SNVDTELM,SNVDTELM   DETAIL ORDER ELEM                            
         LA    R6,SNVDTELM                                                      
         USING SNVDTELD,R6                                                      
         MVI   SNVDTELM,SNVDTELQ   (X'20')                                      
         MVI   SNVDTELM+1,11       DETAIL ELEM LEN WITH BASICS                  
         MVI   SNVDTFLD,FLDNDATE                                                
         MVI   SNVDTFLD+1,FLDNTIME                                              
         MVI   SNVDTFLD+2,FLDNSLEN                                              
         MVI   SNVDTFLD+3,FLDNCOST                                              
         DROP  R6                                                               
*                                                                               
         OC    EZIHLADB,EZIHLADB   TEST HAVE ADVERTISER                         
         BZ    PRI10                                                            
*                                                                               
         TM    EZIHLKST,EZIHLANF   AND IS OK SPOTPAK CODE                       
         BZ    PRI12                                                            
*                                                                               
PRI10    DS    0H                                                               
         MVI   EZERRCD,EZERRANF    CLIENT NOT ON FILE                           
         B     COMERR                                                           
*                                                                               
PRI12    DS    0H                                                               
         TM    EZIHLKST,EZIHBRDT   AND IS OK BROADCAST MONTH                    
         BZ    PRI14                                                            
         MVI   EZERRCD,EZERBRDT    BAD BROADCAST DATE                           
         B     COMERR                                                           
*                                                                               
PRI14    DS    0H                                                               
         CLC   EZIHLPRC,SPACES     TEST INVOICE PRD OK                          
         BNH   PRI16                (MISSING OR VARIOUS, ETC = FF)              
*                                                                               
         TM    EZIHLKST,EZIHLPNF   AND IS OK SPOTPAK CODE                       
         BZ    PRI17                                                            
*                                                                               
PRI16    DS    0H                                                               
         MVI   EZERRCD,EZERRPNF    PRODUCT NOT ON FILE                          
         B     COMERR                                                           
*                                                                               
PRI17    DS    0H                                                               
*                                                                               
         CLI   EZESTOPT,C'E'       IF ESTIMATE OPTION IS E                      
         BE    PRI19               MAKE SURE ESTIMATE IS PRESENT                
*                                                                               
         CLI   EZSPTNET,C'S'       BUT ONLY FOR SPOT                            
         BNE   PRI18                                                            
*                                                                               
         CLC   EZAGY,=AL2(AGYALPH_FR) FDMJW  ('FR')                             
         BE    PRI19                                                            
*                                                                               
         CLC   EZAGY,=AL2(AGYALPH_H9) MVNYR - MINDSHARE ('H9')                  
         BE    PRI19                                                            
*                                                                               
         CLC   EZAGY,=AL2(AGYALPH_JW) JWT ALSO  ('JW')                          
         BE    PRI19                                                            
*                                                                               
PRI18    DS    0H                                                               
         B     PRI24                                                            
*                                                                               
PRI19    DS    0H                                                               
         CLI   EZIHBEST,0          TEST INVOICE EST OK                          
         BE    PRI20                MANDATORY FOR COKE                          
*                                                                               
         TM    EZIHLKST,EZIHLENF   AND IS OK SPOTPAK EST                        
         BZ    PRI30                                                            
*                                                                               
PRI20    DS    0H                                                               
         MVI   EZERRCD,EZERESTR    ESTIMATE REQUIRED                            
         B     COMERR                                                           
*                                                                               
PRI24    DS    0H                                                               
         CLI   EZESTOPT,C'E'       SKIP IF NOT COPYING ESTIMATE NUMBERS         
         BE    *+12                                                             
         CLI   EZESTOPT,C'Y'       SKIP IF NOT COPYING ESTIMATE NUMBERS         
         BNE   PRI30                                                            
         TM    EZIHLKST,EZIHLENF   AND IS OK SPOTPAK EST                        
         BZ    PRI30                                                            
         CLI   EZIHBEST,0          WAS THERE AN ESTIMATE NUMBER                 
         BE    PRI30                                                            
         MVI   EZERRCD,EZERRENF    ESTIMATE NOT ON FILE                         
         B     COMERR                                                           
*                                                                               
PRI30    DS    0H                                                               
         TM    EZIHLKST,EZIHLEDT   AND IS OK SPOTPAK EST                        
         BZ    PRI32                                                            
*                                                                               
         MVI   EZERRCD,EZERREDT    INV DATES OUTSIDE ESTIMATE DATES             
         B     COMERR                                                           
*                                                                               
PRI32    DS    0H                                                               
         TM    EZIHLKST,EZIHBDDT   AND IS OK SPOTPAK START/END DATES            
         BZ    PRI40                                                            
*                                                                               
         MVI   EZERRCD,EZERBDDT    INV DATES ARE GARBAGE                        
*                                                                               
         B     COMERR                                                           
*                                                                               
PRI40    DS    0H                                                               
         L     R0,=A(SAVINVH)      A(INVOICE HEADER SAVE AREA)                  
         L     RE,EZWKRREC         A(INVOICE HEADER RECORD)                     
         LH    R1,0(RE)            INVOICE HEADER LENGTH                        
         CHI   R1,L'SAVINVH                                                     
         BNH   *+6                                                              
         DC    H'0'                INVOICE HEADER RECORD TOO LONG               
         LR    RF,R1               LENGTH OF SAVEAREA TO USE                    
         MVCL  R0,RE               SAVE INVOICE HEADER RECORD                   
*                                                                               
         L     R0,=A(SAVWKBUF)     A(WORKER BUFFER SAVE AREA)                   
         LHI   R1,L'SAVWKBUF      SAVE AREA LENGTH                              
         L     RE,EZWKRBUF         A(WORKER BUFFER)                             
         LR    RF,R1               LENGTH OF SAVEAREA TO USE                    
         MVCL  R0,RE               SAVE WORKER BUFFER AREA                      
*                                                                               
* BUILD MASTER INVOICE KEY                                                      
*                                                                               
         LA    R5,MINBLKBF         USE BUFFER MINIO KEY                         
         USING MINBLKD,R5                                                       
*                                                                               
         MVI   MINOPEN,C'N'        FORCE NEW RECORD                             
*                                                                               
         XC    MINMKEY,MINMKEY                                                  
         LA    R4,MINMKEY          ESTABLISH NEW INVOICE RECORD KEY             
         USING SNVKEY,R4                                                        
*                                                                               
         MVI   SNVKTYPE,SNVKTYPQ   RECORD TYPE                                  
         MVI   SNVKSUB,SNVKSUBQ    RECORD SUBTYPE                               
         MVC   SNVKAM,BAGYMD       AGENCY/MEDIA                                 
         MVC   SNVKCLT,EZIHLADB    CLIENT                                       
         MVC   SNVKSTA,BSTA                                                     
         MVC   WORK(2),EZIHBMOS    BINARY MONTH OF SERVICE                      
         MVI   WORK+2,1            FIRST DAY OF MONTH OF SERVICE                
         GOTO1 DATCON,DMCB,(3,WORK),(2,SNVKMOS)  COMPRES'D MOS                  
         XC    SNVKMOS,=X'FFFF'      COMPLEMENTED                               
*                                                                               
PRI50    MVC   SNVKINV,EZIHINV     INVOICE NUMBER                               
         OC    SNVKINV,SPACES      BLANK FILL                                   
*                                                                               
         CLC   SNVKINV,SPACES                                                   
         BNE   *+12                                                             
         MVI   EZERRCD,EZERRNUM    NO INVOICE NUMBER                            
         B     COMERR                                                           
         DROP  R4                                                               
*                                                                               
PRI60    DS   0H                                                                
         GOTO1 VMINIO,MNPRMS,('MINOPN',MINBLKD)    OPEN MINIO BLOCK             
*                                                                               
         LA    R1,MINMKEY             DUMP KEY                                  
         BRAS  RE,DMPREC                                                        
         DROP  R5                                                               
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - PRINVHD'                      
***********************************************************************         
*                                                                     *         
*        ADD INVOICE HEADER ELEMENT                                   *         
*        ADD ACTIVITY       ELEMENT                                   *         
*                                                                     *         
***********************************************************************         
*                                                                               
*                                                                               
PRINVHD  DS    0H                                                               
         XC    SNVELEM,SNVELEM                                                  
         XC    EZREPCT,EZREPCT                                                  
*                                                                               
         LA    R2,SNVELEM          BUILD INVOICE HEADER ELEMENT                 
         USING SNVHDELD,R2                                                      
*                                                                               
         MVI   SNVHDEL,SNVHDELQ    ELEMENT ID                                   
         MVI   SNVHDLEN,SNVHDLN3   LENGTH FOR 3-CHAR OVERRIDES                  
*                                                                               
         TM    EZLOOKSW,EZLCALEN   IS THIS CALENDAR?                            
         BZ    *+8                   NO                                         
         OI    SNVHDCTL,SNVHDCLQ   SET ON CALENDAR                              
*                                                                               
* PRODUCT AND ESTIMATE GO IN EITHER HEADER OR DETAILS, NOT BOTH                 
*                                                                               
         CLI   EZIHLPRB,X'FF'                                                   
         BE    PR080                                                            
         LAY   RF,EZ5APROF                                                      
         CLI   EZ5ANPPD-EZ5APROF(RF),C'Y'  NON-POOL PRODUCTS IN DETLS?          
         BE    PR100                                                            
*                                                                               
PR080    DS    0H                                                               
         CLI   EZIHLPRB,X'FF'      PRD NOT POOL - PUT IT IN HEADER              
         BNE   PR090                                                            
         CLI   EZCMLOPT,C'N'       USING COMMERCIALS?                           
         BE    PR090                                                            
         CLI   EZPROPT,C'Y'        SKIP IF GETTING PROD FROM COMML              
         BE    PR100                                                            
         CLI   EZPROPT,C'P'                                                     
         BE    PR100                                                            
*                                                                               
PR090    DS   0H                                                                
         MVC   SNVHDPRD,EZIHLPRB   PRODUCT (FF = VARIOUS)                       
         MVC   SNVHDPR2,EZIHLP2B   SECOND PRODUCT IF PIGGYBACK                  
*                                                                               
         MVC   SNVHDAP1,EZIHLPRC   3-CHAR PRODUCT CODE                          
         MVC   SNVHDAP2,EZIHLP2C   3-CHAR SECOND PRODUCT                        
*                                                                               
         CLI   EZESTOPT,C'E'       SKIP IF NOT COPYING ESTIMATE NUMBERS         
         BE    *+12                                                             
         CLI   EZESTOPT,C'Y'       SKIP IF NOT COPYING ESTIMATE NUMBERS         
         BNE   PR100                                                            
         MVC   SNVHDEST,EZIHBEST     COPY AGENCY ESTIMATE NUMBER                
*                                                                               
PR100    DS   0H                                                                
         CLI   EZCONOPT,C'S'       USE STATION CONTRACT IF 'S'                  
         BE    PR150                                                            
*                                                                               
         CLI   EZCONOPT,C'Y'       SKIP IF NOT COPYING CONTRACT NUMBERS         
         BNE   PR170                                                            
*                                                                               
         MVC   SNVHDCON(10),EZIHRORD   COPY REP CONTRACT/ORDER                  
*                                                                               
         CLI   SNVHDCON,C' '           IF NO REP CONTRACT/ORDER NUMBER          
         BH    PR156                                                            
*                                                                               
PR150    DS   0H                                                                
         MVC   SNVHDCON(10),EZIHSORD   USE STATION'S                            
*                                                                               
PR156    DS   0H                                                                
         OC    SNVHDCON,SPACES         FORCE BIN ZEROS TO SPACES                
*                                                                               
PR170    DS    0H                                                               
         CLI   EZSPTNET,C'N'       NET?                                         
         BNE   PR172               NO - DON'T DO PACKAGES                       
*                                                                               
         LAY   RF,EZ5APROF                                                      
         CLI   EZ5ANOPK-EZ5APROF(RF),C'Y'  SUPPRESSING PACKAGES?                
         BE    PR172                                                            
*                                                                               
         TMY   EZIHSFL2,EZIHF2NOPKGQ  NO-PACKAGE '#' OVERRIDE?                  
         BO    PR172                                                            
*                                                                               
         MVC   SNVHDPKG,EZIHBPKG   PACKAGE SENT BY CLIENT                       
         CLI   EZIHCVNP,X'00'      ANY OVERRIDES?                               
         BE    PR172                                                            
         MVC   SNVHDPKG,EZIHCVNP   OVERRIDE TAKES PRECEDENCE                    
*                                                                               
PR172    DS    0H                                                               
         MVC   SNVHDSDT,EZIHCMST   INVOICE START DATE                           
         MVC   SNVHDEDT,EZIHCMEN   INVOICE END DATE                             
*                                                                               
         GOTO1 DATCON,DMCB,(2,EZIHCMST),(X'20',WORK)                            
         GOTO1 DATCON,DMCB,(2,EZIHCMEN),(X'20',WORK+6)                          
*                                                                               
         CLC   EZIHISDT,WORK       PERIOD START TO STD MOS START                
         BL    PR172E               OUT OF PERIOD                               
         CLC   EZIHISDT,WORK+6     PERIOD START TO STD MOS END                  
         BH    PR172E               OUT OF PERIOD                               
*                                                                               
PR172C   DS    0H                                                               
         CLC   EZIHIEDT,WORK       PERIOD START TO STD MOS START                
         BL    PR172E               OUT OF PERIOD                               
         CLC   EZIHIEDT,WORK+6     PERIOD START TO STD MOS END                  
         BH    PR172E               OUT OF PERIOD                               
*                                                                               
         GOTO1 DATCON,DMCB,(0,EZIHISDT),(2,SNVHDSDT)                            
         GOTO1 DATCON,DMCB,(0,EZIHIEDT),(2,SNVHDEDT)                            
*                                                                               
PR172E   DS    0H                                                               
         MVC   SVHDSDT,SNVHDSDT                                                 
         MVC   SVHDEDT,SNVHDEDT                                                 
*                                                                               
         GOTO1 DATCON,DMCB,EZIHIDAT,(2,SNVHDIDT)   INVOICE DATE                 
*                                                                               
         CLC   EZIHDUDT,SPACES     SKIP IF NO DUE DATE                          
         BNH   PR174                                                            
         CLC   EZIHDUDT(2),=C'00'                                               
         BL    PR174                                                            
         CLC   EZIHDUDT(2),=C'99'                                               
         BH    PR174                                                            
         CLC   EZIHDUDT+2(2),=C'01'                                             
         BL    PR174                                                            
         CLC   EZIHDUDT+2(2),=C'12'                                             
         BH    PR174                                                            
         CLC   EZIHDUDT+4(2),=C'01'                                             
         BL    PR174                                                            
         CLC   EZIHDUDT+4(2),=C'31'                                             
         BH    PR174                                                            
*                                                                               
         GOTO1 (RF),(R1),EZIHDUDT,(2,SNVHDDDT) INVOICE DUE DATE                 
*                                                                               
PR174    DS    0H                                                               
         LA    RF,EZBLOCKD                                                      
         AHI   RF,EZIHPSPC-EZBLOCKD                                             
         ZAP   SNVHDTCS,0(8,RF)    TOTAL SPOT COST                              
*                                                                               
         ICM   RF,15,EZIHTSPN      TOTAL NUMBER OF SPOTS                        
         STCM  RF,3,SNVHDTSP                                                    
*                                                                               
         MVC   SNVHDEZS,EZSRCE     SOURCE                                       
         MVC   SNVHDEZB,EZBTBRDT   BATCH LOADED DATE                            
*                                                                               
         MVC   SNVHDCDT,TODAYP     ADD CREATION DATE                            
*                                                                               
         MVC   SNVHDREP,EZIHLREP   REP ID                                       
*                                                                               
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         DROP  R2                                                               
*                                                                               
* ADD EASI INVOICE ORIGIN ELEMENT                                               
*                                                                               
         XC    SNVELEM,SNVELEM                                                  
         LA    R2,SNVELEM                                                       
         USING SNVEOD,R2                                                        
         MVI   SNVEOEL,SNVEOELQ                                                 
         MVI   SNVEOLEN,SNVEOLQ                                                 
*                                                                               
         LAY   R3,EZWRKIOB                                                      
         USING WRKIOB,R3                                                        
         MVC   SNVEOUID,WRKEZUID                                                
         MVC   SNVEOCLL,WRKEZSCL                                                
*                                                                               
         LA    R1,WRKEZMED                                                      
         ICM   R1,8,=AL1(EZMTBNDQ)                                              
         GOTO1 =V(GETMED)                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   SNVEOMED,EZMTPMED-EZMEDTBD(RF)                                   
*                                                                               
         MVC   SNVEODAT,WRKEZBDT                                                
         DROP  R3                                                               
*                                                                               
         CLC   EZAGISID,SPACES                                                  
         BNH   *+16                                                             
         MVC   SNVEOAID,EZAGISID                                                
         OC    SNVEOAID,SPACES                                                  
*                                                                               
         DROP  R2                                                               
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
*                                                                               
*                                                                               
*                                  SET ACTIVITY ELEM                            
PR180    DS    0H                                                               
         TM    EZIHCVST,EZIHIMQ                                                 
         BZ    PR185                                                            
*                                                                               
         BRAS  RE,BLDIMID                                                       
         LA    R2,SNVELEM                                                       
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
PR185    DS    0H                                                               
         XC    SNVELEM,SNVELEM                                                  
         LA    R2,SNVELEM          BUILD INVOICE HEADER ELEMENT                 
         USING ACTVD,R2                                                         
*                                                                               
         MVI   ACTVEL,X'F1'                                                     
         MVI   ACTVLEN,ACTVLENQ                                                 
         MVC   ACTVADDT,TODAYB     DATE                                         
         MVC   ACTVADID,RCORIGID   USER ID                                      
*                                                                               
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         DROP  R2                                                               
*                                                                               
*==================================================================*            
* FOR SI2, ALWAYS ADD X'FE' ELEMENT SO UPDATIVE SOONS NEVER SPLIT  *            
* A RECORD. ELEMENT IS DELETED WHEN MATCHMAKER PASSIVES ADDED      *            
*==================================================================*            
*                                                                               
PR190    DS   0H                                                                
         XC    SNVELEM,SNVELEM                                                  
         LA    R2,SNVELEM          BUILD INVOICE HEADER ELEMENT                 
*                                                                               
         MVI   0(R2),X'FE'                                                      
         MVI   1(R2),100                                                        
*                                                                               
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
*==================================================================*            
* FOR REP, ALWAYS ADD X'24' ELEMENT FOR REP INFO                   *            
*==================================================================*            
*                                                                               
PR200    DS    0H                                                               
         B     EXIT                 NO                                          
*                                                                               
*                                                                               
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - PRANN'                        
***********************************************************************         
*                                                                     *         
*        PROCESS ANNOUNCEMENT                                         *         
*                                                                     *         
***********************************************************************         
PRANN    DS    0H                                                               
         OC    EZIHLADB,EZIHLADB   DONE IF NO VALID ADVERTISER                  
         BZ    PRAX                                                             
*                                                                               
PRANN00  DS    0H                                                               
         CLI   EZSPRUN,C'N'        SKIP IF DID NOT RUN                          
         BE    PRAX                                                             
*                                                                               
         CLI   EZSPBSLN,0          SPOT LENGTH = ZERO                           
         BE    PRAERR               BYPASS INVOICE                              
*                                                                               
         TM    EZSPLKST,EZSPBDDL   SEE IF BAD DOLLAR FIELD                      
         BZ    PRANN02                                                          
*                                                                               
         MVI   EZERRCD,EZERRDOL    BAD DOLLAR FIELD                             
         B     COMERR                                                           
*                                                                               
PRANN02  DS    0H                                                               
         TM    EZSPLKST,EZSPBDTM   SEE IF BAD TIME FIELD                        
         BZ    PRANN04                                                          
*                                                                               
         MVI   EZERRCD,EZERRTIM    BAD TIME FIELD                               
         B     COMERR                                                           
*                                                                               
*        BUILD DETAIL ELEMENT KEY                                               
*                                                                               
PRANN04  DS    0H                                                               
         XC    SNVELEM,SNVELEM                                                  
         LA    R2,SNVELEM                                                       
         USING SNVIDELD,R2         ESTABLISH DETAIL ELEMENT                     
*                                                                               
         MVI   SNVIDEL,SNVIDELQ    SET DETAIL ELEMENT CODE                      
*                                                                               
         MVI   SNVIDLEN,SNVIDSEQ-SNVIDELD                                       
*                                                                               
         CLC   EZSPCDT,SVHDSDT     SEE IF SPOT DATE OUTSIDE MOS                 
         BL    DATERR                                                           
         CLC   EZSPCDT,SVHDEDT                                                  
         BH    DATERR                                                           
*                                                                               
         GOTO1 DATCON,DMCB,(2,SVHDSDT),(X'20',DUB)  INVOICE START DATE          
*                                                                               
         GOTO1 VPERVERT,DMCB,DUB,EZSPDATE,0                                     
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,8(R1)          NUMBER OF DAYS BETWEEN DATES                 
         BCTR  RF,0                RELATIVE NUMBER OF DAYS                      
         STC   RF,SNVIDDAY                                                      
*                                                                               
         OC    EZSPTIM(2),EZSPTIM  TEST TIME MISSING                            
         BZ    TIMERR              THAT'S ALL SHE WROTE                         
*                                                                               
         LA    R0,4                                                             
         LA    R1,EZSPTIM                                                       
         CLI   0(R1),C'0'                                                       
         BL    TIMERR                                                           
         CLI   0(R1),C'9'                                                       
         BH    TIMERR                                                           
         LA    R1,1(,R1)                                                        
         BCT   R0,*-20                                                          
*                                                                               
         CLC   EZSPTIM(2),=C'24'   TEST TIME TOO HIGH                           
         NOP   TIMHIGH              THAT'S ALL SHE WROTE                        
*                                                                               
         PACK  DUB,EZSPTIM(2)      MILITARY HOURS OF TIME                       
*                                                                               
         CP    DUB,=P'6'           IF BEFORE 6AM                                
         BNL   *+10                                                             
         AP    DUB,=P'24'             ADD 24 HOURS                              
*                                                                               
         SP    DUB,=P'6'           SET HOURS RELATIVE TO 6AM                    
*                                                                               
         MP    DUB,=P'60'          CALCULATE MINUTES                            
*                                                                               
         CVB   RF,DUB              CVB HOURS IN RELATIVE MINUTES                
*                                                                               
         OC    EZSPTIM+2(2),EZSPTIM+2  TEST TIME MISSING                        
         BZ    TIMERR                   THAT'S ALL SHE WROTE                    
         CLI   EZSPTIM+2,X'F0'                                                  
         BL    TIMERR                                                           
         CLI   EZSPTIM+3,X'F0'                                                  
         BL    TIMERR                                                           
*                                                                               
         PACK  DUB,EZSPTIM+2(2)    GET MILITARY MINUTES                         
         CVB   RE,DUB              CVB                                          
*                                                                               
         AR    RF,RE               MINUTES RELATIVE TO 6AM                      
         STCM  RF,3,SNVIDTIM       SET IN KEY                                   
*                                                                               
         CLI   EZSPTIMT,C'T'       WAS TIME PRECEDED BY A 'T'                   
         BNE   *+8                                                              
         OI    SNVIDCTL,SNVIDITQ    IGNORE TIME FOR I2 INVOICE MATCH            
*                                                                               
         CLI   MEDIA,C'T'                                                       
         BE    PRANN06                                                          
         CLI   MEDIA,C'R'                                                       
         BE    PRANN06                                                          
         CLI   MEDIA,C'X'                                                       
         BE    PRANN06                                                          
*                                                                               
         MVC   SNVIDINT,EZSPBINT   SAVE ANY NETWORK INTEGRATION CHRG            
         OC    SNVIDINT,SNVIDINT   ANY NETWORK INTEGRATION CHRG?                
         BZ    PRANN06              NO                                          
*                                                                               
* PUT INTEGRATION CHARGE IN DETAIL ELEM IF NOT THERE                            
*                                                                               
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNINTG                                                      
         BRAS  RE,UPDORDER                                                      
*                                                                               
PRANN06  DS    0H                                                               
         OC    EZSPNET,EZSPNET     WAS LOCAL CABLE NET SENT                     
         BZ    PRANN40              NO                                          
*                                                                               
         CLI   EZEQVSTA,C'0'       THIS A CABLE STATION                         
         BL    PRANIDLP             CAN'T USE IT                                
*                                                                               
         XC    WORK,WORK                                                        
         LA    R1,WORK                                                          
         USING STAPACKD,R1                                                      
         MVI   STAPACT,C'P'                                                     
         MVC   STAPAGY,AGENCY                                                   
         MVC   STAPCTRY,COUNTRY                                                 
         MVC   STAPMED,QMED                                                     
         MVC   STAPACOM,ACOMFACS                                                
         MVC   STAPQMKT,=C'0000'   MARKET                                       
         MVC   STAPQSTA(4),EZEQVSTA                                             
         MVI   STAPQSTA+4,C'/'                                                  
         MVC   STAPQSTA+5(3),EZSPNET                                            
*                                                                               
         GOTO1 VSTAPACK,(R1)                                                    
*                                                                               
         CLI   STAPERR,0                                                        
         BE    PRANN20                                                          
*                                                                               
         CLI   STAPERR,04          UNKNOWN NETWORK                              
         BE    PRANN10              YES                                         
         CLI   STAPERR,07          NETWORK NOT ACTIVE ON THIS HEADEND           
         BE    PRANN10              YES                                         
         CLI   STAPERR,08          CABLE HEADEND NOT FOUND                      
         BE    PRANN10              YES                                         
         DC    H'0'                                                             
*                                                                               
PRANN10  DS    0H                                                               
         MVI   EZERRCD,EZERRSTA    SET BAD STATION CALL LETTERS                 
         B     COMERR                                                           
*                                                                               
PRANN20  MVC   EZSPNETB,STAPMKST+4                                              
         NI    EZSPNETB,X'7F'      SET OFF STATION                              
         MVC   SNVIDNWK,EZSPNETB                                                
         B     PRANN50                                                          
         DROP  R1                  STAPACKD,R1                                  
*                                                                               
PRANN40  CLI   EZSPNETH,0          NET FROM INVOICE HEADER?                     
         BNE   PRANN45                                                          
*                                                                               
         CLI   EZEQVSTA,C'0'       THIS A CABLE STATION                         
         BL    PRANIDLP            NO - PROCEED W/O ERROR                       
*                                                                               
         CLI   EZNETREQ,C'N'       REQUIRING NETWORKS?                          
         BE    PRANIDLP            NO - PROCEED                                 
         MVI   EZERRCD,EZERRNET    YES - NETWORK REQUIRED ERROR                 
         B     COMERR                                                           
*                                                                               
PRANN45  DS    0H                                                               
         MVC   SNVIDNWK,EZSPNETH                                                
*                                                                               
* PUT NETWORK IN DETAIL ELEM IF NOT THERE                                       
*                                                                               
PRANN50  DS   0H                                                                
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNNTWK       NETWORK                                        
         BRAS  RE,UPDORDER                                                      
*                                                                               
PRANIDLP DS    0H                                                               
         GOTO1 GETEL,DMCB,MINBLKBF,(R2),0     CHECK FOR DUPLICATE ELM           
*                                                                               
         ICM   RF,15,8(R1)         POINT TO RETURNED ELEMENT                    
         BZ    PRANIDDN            NONE FOUND                                   
*                                                                               
PRANIDCN DS    0H                                                               
*                                                                               
         SR    RE,RE                                                            
*                                                                               
         CLI   SNVIDSEQ-SNVIDELD(RF),X'FF'                                      
         BL    *+12                                                             
         MVI   EZERRCD,EZERR255    MORE THAN 255 IDENTICAL SPOTS                
         B     COMERR                                                           
*                                                                               
         ICM   RE,1,SNVIDSEQ-SNVIDELD(RF)   FOUND SEQUENCE NUMBER               
         LA    RE,1(RE)            BUMP                                         
         STC   RE,SNVIDSEQ         SET IN SEARCH KEY                            
*                                                                               
         B     PRANIDLP                                                         
*                                                                               
PRANIDDN DS    0H                                                               
*                                                                               
* BUILD DETAIL ELEMENT                                                          
*                                                                               
         MVI   SNVIDLEN,SNVIDL3Q   INCLUDING 3-CHAR PRODUCTS                    
*                                                                               
         LA    R1,EZEQVSTA+4                                                    
         ICM   R1,8,=AL1(EZMTBNDQ)                                              
         GOTO1 =V(GETMED)                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    EZMTFLAG-EZMEDTBD(RF),EZMTFDGQ DIGITAL MEDIA?                    
         BZ    *+8                                                              
         MVI   SNVIDLEN,SNVIDL4Q   INCLUDE ACTUALS                              
*                                                                               
         MVC   SNVIDSLN,EZSPBSLN   SPOT LENGTH                                  
*                                                                               
         CLI   EZIHLPRB,X'FF'     PRD=POL?                                      
         BE    PRA1                                                             
*                                                                               
* NON-POOL PRODUCT IN THE HEADER HERE                                           
*                                                                               
         LAY   RF,EZ5APROF                                                      
         CLI   EZ5ANPPD-EZ5APROF(RF),C'Y'  NON-POOL PRODUCTS IN DETLS?          
         BNE   PRA4                                                             
*                                                                               
         MVC   SNVIDPRD,EZIHLPRB   PRODUCT                                      
         MVC   SNVIDPR2,EZIHLP2B   SECOND PRODUCT IF PIGGYBACK                  
         MVC   SNVIDAP1,EZIHLPRC   3-CHAR PRODUCT CODE                          
         MVC   SNVIDAP2,EZIHLP2C   3-CHAR SECOND PRODUCT                        
*                                                                               
         B     PRA1X                                                            
*                                                                               
* GOT PRODUCT=POL IN HEADER HERE                                                
* SEE IF GETTING PRODUCTS FROM COMMERCIAL RECORDS                               
*                                                                               
PRA1     DS    0H                                                               
         CLI   EZCMLOPT,C'N'      USING COMMERCIALS?                            
         BE    PRA4                                                             
         CLI   EZPROPT,C'Y'       SKIP IF NOT GETTING PROD FROM COMML           
         BE    *+12                                                             
         CLI   EZPROPT,C'P'                                                     
         BNE   PRA4                                                             
*                                                                               
         MVC   SNVIDPRD,EZSPLPB1   PRODUCT 1                                    
         MVC   SNVIDPR2,EZSPLPB2   PRODUCT 2                                    
         MVC   SNVIDAP1,EZSPLPC1   PRODUCT 1 3-CHAR                             
         MVC   SNVIDAP2,EZSPLPC2   PRODUCT 2 3-CHAR                             
*                                                                               
* PUT PRODUCT IN DETAIL ELEM IF NOT THERE                                       
*                                                                               
PRA1X    DS    0H                                                               
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNPROD                                                      
         BRAS  RE,UPDORDER                                                      
*                                                                               
PRA2     DS    0H                                                               
         CLI   EZESTOPT,C'E'       IF ESTIMATE OPTION ON                        
         BE    *+12                                                             
         CLI   EZESTOPT,C'Y'       IF ESTIMATE OPTION ON                        
         BNE   PRA4                                                             
         MVC   SNVIDEST,EZIHBEST      PASS ESTIMATE NUMBER                      
*                                                                               
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNESTM                                                      
         BRAS  RE,UPDORDER                                                      
*                                                                               
PRA4     DS    0H                                                               
         ICM   R0,15,EZSPBRAT      GET COST                                     
         ICM   RE,15,EZSPBDR       AND DEBIT                                    
         ICM   RF,15,EZSPBCR           CREDIT                                   
         AR    R0,RE                                                            
         AR    R0,RF                                                            
         BZ    PRA5                NO COST IF NET IS ZERO                       
*                                                                               
         ICM   R0,15,EZSPBRAT                                                   
         LTR   R0,R0                                                            
         BNM   *+10                                                             
         LPR   R0,R0                                                            
         OI    SNVIDCTL,SNVIDNGQ                                                
*                                                                               
         STCM  R0,15,SNVIDCST                                                   
*                                                                               
PRA5     DS    0H                                                               
         CLI   EZSPCML1,0          TEST HAVE CMML 1                             
         BE    PRA8                                                             
*                                                                               
         LA    R3,EZSPCML1         LOOK IN CMML TABLE                           
         LA    R4,EZSPLCM1                                                      
         BAS   RE,SETCML                                                        
         BNE   PRA8                                                             
         MVC   SNVIDCML,BYTE       SET INTERNAL ID                              
*                                                                               
* PUT FILM CODE IN DETAIL ELEM IF NOT THERE                                     
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNFILM                                                      
         BRAS  RE,UPDORDER                                                      
*                                                                               
         CLI   EZSPCNOM,C'Y'       IS THIS AN 'N-' CML                          
         BNE   *+8                  NO                                          
         OI    SNVIDCTL,SNVIDIFQ   SET NO MATCH FLAG                            
*                                                                               
         CLI   EZSPCML2,0          TEST HAVE CMML 2                             
         BE    PRA8                                                             
         LA    R3,EZSPCML2         LOOK IN CMML TABLE                           
         LA    R4,EZSPLCM2                                                      
         BAS   RE,SETCML                                                        
         BNE   PRA8                                                             
         MVC   SNVIDCM2,BYTE       SET INTERNAL ID                              
*                                                                               
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNPFLM                                                      
         BRAS  RE,UPDORDER                                                      
*                                                                               
PRA8     DS    0H                                                               
         CLI   EZMGOPT,C'Y'        TEST TO USE MAKEGOOD STATUS                  
         BNE   PRA9                                                             
         CLI   EZSPDMD1,C' '       TEST SPOT IS A MAKEGOOD                      
         BNH   PRA9                                                             
*                                                                               
         OI    SNVIDCTL,SNVIDMGQ   SET STATUS BIT                               
*                                                                               
PRA9     DS    0H                                                               
         CLI   EZSPTNET,C'N'       NET?                                         
         BNE   PRA10               NO - DON'T DO PACKAGES                       
*                                                                               
         LAY   RF,EZ5APROF                                                      
         CLI   EZ5ANOPK-EZ5APROF(RF),C'Y'  SUPPRESSING PACKAGES?                
         BE    PRA10                                                            
*                                                                               
         CLI   EZPROF+12,C'Y'      SUPPORT FOR PACKAGE IN DETAILS?              
         BNE   PRA10               NO - DON'T DO PACKAGES                       
*                                                                               
         TMY   EZIHSFL2,EZIHF2NOPKGQ  NO-PACKAGE '#' OVERRIDE?                  
         BO    PRA10                                                            
*                                                                               
         CLI   EZIHCVNP,X'00'      DO WE HAVE PACKAGE IN THE HEADER?            
         BNE   PRA10               YES - DON'T PUT ANYTHING IN DETAILS          
*                                                                               
         CLI   EZIHBPKG,X'00'      DO WE HAVE PACKAGE IN THE HEADER?            
         BNE   PRA10               YES - DON'T PUT ANYTHING IN DETAILS          
*                                                                               
         MVC   SNVIDPKG,EZSPBPKG                                                
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNNPKG                                                      
         BRAS  RE,UPDORDER                                                      
*                                                                               
PRA10    DS    0H                                                               
         CLI   SNVIDLEN,SNVIDL4Q   INCLUDES ACTUALS?                            
         BL    PRA20                                                            
*                                                                               
* PUT ACTUALS IN DETAIL ELEM IF NOT THERE                                       
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNCLK                                                       
         BRAS  RE,UPDORDER                                                      
*                                                                               
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNRAT                                                       
         BRAS  RE,UPDORDER                                                      
*                                                                               
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNIMP                                                       
         BRAS  RE,UPDORDER                                                      
*                                                                               
         LAY   RF,EZSXIMP                                                       
         MVC   SNVIDIMP,0(RF)                                                   
         LAY   RF,EZSXRAT                                                       
         MVC   SNVIDRAT,0(RF)                                                   
         LAY   RF,EZSXCLK                                                       
         MVC   SNVIDCLK,0(RF)                                                   
*                                                                               
PRA20    DS    0H                                                               
         LAY   RF,EZ5APROF                                                      
         CLI   EZ5ABILB-EZ5APROF(RF),C'Y'  CONVERTING BILLBOARDS?               
         BNE   PRA30                                                            
         CLI   EZSPBBI,C'Y'                                                     
         BNE   PRA30                                                            
         OI    SNVIDCTL,SNVIDBLQ   BILLBOARD FLAG                               
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNBILB                                                      
         BRAS  RE,UPDORDER                                                      
*                                                                               
PRA30    DS    0H                                                               
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
PRAX     DS    0H                                                               
         B     EXIT                                                             
*                                                                               
*                                                                               
         DROP  R2                                                               
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - LINV'                         
***********************************************************************         
*                                                                     *         
*        LAST FOR INVOICE                                             *         
*                                                                     *         
***********************************************************************         
*                                                                               
LINV     DS    0H                                                               
         MVI   EZRPLACE,C'N'                                                    
         OC    EZIHLADB,EZIHLADB   EXIT IF INVALID ADVERTISER                   
         JZ    LINVX                                                            
*                                                                               
         LA    R5,MINBLKBF         ESTABLISH INV FILE MINIO BLOCK               
         USING MINBLKD,R5                                                       
*                                                                               
         MVC   SNVELEM,SNVDTELM             MOVE ELEM AS BUILT                  
         GOTO1 ADDEL,DMCB,MINBLKD,SNVELEM,0 ADD ELEMENT TO RECORD               
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         LA    R5,MINBLK           ESTABLISH INV FILE MINIO BLOCK               
         USING MINBLKD,R5                                                       
*                                                                               
         MVI   MINOPEN,C'N'        FORCE OPENING OF RECORD SET                  
         MVI   MINDELSW,C'N'       PROCESS DELETED RECORDS                      
*                                                                               
         MVI   MINWRITE,C'Y'       ENABLE WRITES                                
*                                                                               
         CLI   EZTEST,C'Y'         TEST TO SUPPRESS MARKING                     
         BE    *+12                                                             
         CLI   EZWRITE,C'Y'        IF WRITES NOT ALLOWED                        
         BE    *+8                                                              
*                                                                               
         MVI   MINWRITE,C'N'          DISABLE WRITES                            
*                                                                               
         MVC   MINMKEY,MINMKEY-MINBLKD+MINBLKBF COPY BUFFER KEY                 
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINOPN',MINBLKD)   OPEN MINIO SET                
         CLI   MINERR,MINESNF      SKIP IF RECORD NOT FOUND                     
         BE    LINVOLDX                                                         
*                                                                               
* INVOICE ALREADY EXISTS                                                        
*                                                                               
         CLI   EZRPLOPT,C'B'       ALLOW RECONVERTS AND REPLACEMENTS?           
         BE    LINVREP1            YES - PROCEED                                
*                                                                               
         L     RF,=A(SAVINVH)      A(INVOICE HEADER SAVE AREA)                  
         LA    RF,7(,RF)           SAVED INVOICE HEADER                         
         TM    0(RF),EZIHRCVQ      IS THIS A RECONVERT?                         
         BO    LINV110             YES                                          
*                                                                               
* HAVE A DUPLICATE INVOICE HERE                                                 
         CLI   EZRPLOPT,C'P'       ALLOWING DUPLICATES?                         
         BE    LINVREP1                                                         
         B     *+12                                                             
*                                                                               
* RE-CONVERTING AN INOVICE HERE                                                 
LINV110  DS    0H                  RE-CONVERT HERE                              
         CLI   EZRPLOPT,C'Y'       ALLOWING RECONVERTS?                         
         BE    LINVREP1                                                         
*                                                                               
         MVC   KEY,MINMKEY                                                      
         XC    KEY+24(6),KEY+24                                                 
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'XSPDIR',KEY,KEY1                      
*                                                                               
         CLC   KEY(24),KEY1                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R2,ADBUY                                                         
         GOTO1 (RF),(R1),=C'GETREC',=C'XSPFIL',KEY1+36,(R2),KEY2                
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R2,42(,R2)                                                       
         CLI   0(R2),X'10'         THIS HEADER ELEM                             
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* WAS EXISTING INVOICE MID FLIGHT CLEARANCE - IF SO, OKAY                       
* TO OVER-WRITE I WITH REAL INVOICE, OR ANOTHER MID FLIGHT CLEARANCE            
*                                                                               
         TM    SNVHDCTL-SNVHDELD(R2),SNVHDMCQ                                   
         BO    LINVREP1                                                         
*                                                                               
LINV220  DS    0H                                                               
         MVI   EZERRCD,EZERRDUP       SET ERROR CODE (DUPLICATE INV)            
         BAS   RE,GETERRM             TRANSLATE CODE                            
         MVI   EZMODE,EZINVL          SKIP TO NEXT INVOICE                      
*                                                                               
         B     EXIT                                                             
*                                                                               
LINVREP1 DS    0H                                                               
         MVI   EZRPLACE,C'Y'                                                    
         L     RF,=A(SAVINVH)      A(INVOICE HEADER SAVE AREA)                  
         LA    RF,7(,RF)           SAVED INVOICE HEADER                         
         TM    0(RF),EZIHRCVQ      IS THIS A RECONVERT?                         
         BZ    *+8                                                              
         MVI   EZRPLACE,C'R'       INDICATE RECONVERT                           
*                                                                               
         TM    MINSTAT,MINDELQ     IF RECORD SET IS DELETED                     
         BNO   LINVDELX                                                         
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINRSF',MINBLKD)  RESTORE MINIO SET              
*                                                                               
*        CLEAR OLD RECORD FROM FILE                                             
*                                                                               
LINVDELX DS    0H                                                               
         MVC   EZRPLVER,SPACES                                                  
         XC    MINFILTL,MINFILTL   CLEAR FILTER LENGTH                          
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY                             
*                                                                               
         L     RF,MINBUFF          POINT TO BUFFER                              
         XC    0(256,RF),0(RF)     CLEAR OLD DATA                               
*                                                                               
         LA    R0,MINHI            FIRST READ IS HIGH                           
*                                                                               
LINVDLLP DS    0H                                                               
*                                                                               
         GOTO1 VMINIO,MNPRMS,((R0),MINBLKD)   READ NEXT ELEMENT                 
*                                                                               
         L     RE,MINELEM                                                       
         CLI   0(RE),SNVIMELQ                                                   
         BNE   *+10                                                             
         MVC   EZRPLVER,SNVIMVER-SNVIMIDD(RE)                                   
*                                                                               
         CLI   MINERR,0            TREAT ALL ERRORS AS END OF RECORD            
         BNE   LINVDLDN                                                         
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINDEL',MINBLKD)   DELETE ELEMENT                
*                                                                               
LINVDLCN DS    0H                                                               
*                                                                               
         LA    R0,MINSEQ           NEXT READ IS SEQUENTIAL                      
         B     LINVDLLP                                                         
*                                                                               
LINVDLDN DS    0H                                                               
         GOTO1 VMINIO,MNPRMS,('MINCLS',MINBLKD)   CLOSE SET TO EMPTY            
         GOTO1 (RF),(R1),('MINOPN',MINBLKD)   OPEN EMPTY SET                    
*                                                                               
LINVOLDX DS    0H                                                               
*                                                                               
*        COPY BUFFER TO FILE                                                    
*                                                                               
LINVCPY  DS    0H                                                               
*                                                                               
         SR    R0,R0               SET FIRST TIME SWITCH                        
*                                                                               
         LA    R6,MINBLK           POINT TO FILE MINIO BLOCK                    
         LA    R5,MINBLKBF         POINT TO BUFFER MINIO RECORD                 
*                                                                               
         LA    R1,MINMKEY-MINBLKD+MINBLKBF   DUMP KEY                           
         BRAS  RE,DMPREC                                                        
*                                                                               
         LA    R2,SNVELEM          POINT TO ELEMENT WORKAREA                    
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY                             
         XC    SNVELEM,SNVELEM     INIT ELEMENT WORKAREA                        
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINHI',MINBLKBF)  READ FIRST ELEMENT             
*                                                                               
LINVCPLP DS    0H                                                               
         CLI   MINERR,MINEEOF      DONE IF AT END OF FILE                       
         BE    LINVCPDN                                                         
*                                                                               
         CLI   MINERR,0            NO OTHER ERRORS TOLERATED                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         ICM   RF,15,MINELEM-MINBLKD+MINBLKBF  POINT TO FOUND RECORD            
         BZ    LINVCPDN            END OF RECORD                                
*                                                                               
         MVC   SNVELEM,0(RF)       COPY ELEMENT                                 
*                                                                               
* CHECK FOR VARIOUS ELEMENTS                                                    
*                                                                               
         USING SNVHDELD,R2         ESTABLISH AS HEADER ELEMENT                  
*                                                                               
         CLI   SNVHDEL,SNVHDELQ    SKIP IF NOT HEADER ELEMENT                   
         BNE   LINVCHDN                                                         
*                                                                               
         LA    RF,EZBLOCKD                                                      
         AHI   RF,EZIHPSPC-EZBLOCKD                                             
         ZAP   SNVHDTCS,0(8,RF)    TOTAL SPOT COST                              
*                                                                               
         ICM   RF,15,EZIHTSPN      TOTAL NUMBER OF SPOTS                        
         STCM  RF,3,SNVHDTSP                                                    
*                                                                               
* SPEC-30121 - JAN/2020 CANADA GOES $NET                                        
*                                                                               
         BRAS  RE,ISCANADA                                                      
         BNE   LINV230                                                          
         CLC   =C'2001',EZIHMON    JAN/2020                                     
         BH    LINVMCT                                                          
         OI    SNVHDCTL,SNVHDNTQ   AMOUNTS ARE NET                              
         B     LINVMCT                                                          
*                                                                               
LINV230  DS    0H                  US AGENCY HERE                               
         CLC   =C'2001',EZIHMON    JAN/2020                                     
         BH    LINVMCT                                                          
         CLI   SVNETINV,C'Y'                                                    
         BNE   LINVMCT                                                          
         OI    SNVHDCTL,SNVHDNTQ   AMOUNTS ARE NET                              
*                                                                               
LINVMCT  DS    0H                                                               
         MVI   EZMCTINV,0          SET OFF MCT INVOICE                          
*                                                                               
         CLC   =C'MID FLIGHT CL',EZIHORD THIS SPECIAL 'PRE' INVOICE             
         BE    MCTINV                                                           
*                                                                               
         CLC   =C'BVS',EZSRCE      IF SOURCE BDS                                
         BE    MCTINV                                                           
         CLC   =C'BDS',EZSRCE      IF SOURCE BDS                                
         BNE   NOTMCTIN                                                         
*                                                                               
         OC    EZITBDUE,EZITBDUE   AND ZERO DOLLARS                             
         BNZ   NOTMCTIN                                                         
         LA    RF,EZBLOCKD                                                      
         AHI   RF,EZITPDUE-EZBLOCKD                                             
         CP    0(8,RF),=P'0'                                                    
         BNE   NOTMCTIN                                                         
*                                                                               
MCTINV   EQU   *                                                                
         OI    SNVHDCTL,SNVHDMCQ       SET ON MCT INVOICE                       
*                                                                               
         MVI   EZMCTINV,C'Y'           SET ON MCT INVOICE                       
*                                                                               
NOTMCTIN DS   0H                                                                
         BRAS  RE,ISCANADA                                                      
         BNE   LINTAX20            IF NOT CANADA - PROCEED NORMALLY             
*                                                                               
         MVC   SNVHDTAX(4),EZITBDUE                                             
         OI    SNVHDCT2,SNVHDTXQ                                                
*                                                                               
LINTAX20 DS    0H                                                               
         LAY   RF,EZIHDEM                                                       
         OC    0(L'EZIHDEM,RF),0(RF)                                            
         BZ    LINV20                                                           
*                                                                               
         XC    WORK,WORK                                                        
*                                                                               
         L     R3,ADBUY                                                         
         USING DBLOCK,R3             SET UP CALL TO DEMOVAL                     
*                                                                               
         XC    DBLOCK,DBLOCK                                                    
*                                                                               
         MVC   DBCOMFCS,ACOMFACS                                                
         MVC   DBFILE,=C'TP '        SET DBFILE = TP                            
*                                                                               
         LA    R1,EZEQVSTA+4                                                    
         ICM   R1,8,=AL1(EZMTBNDQ)                                              
         GOTO1 =V(GETMED)                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   DBSELMED,EZMTMED-EZMEDTBD(RF)                                    
*                                                                               
         MVI   DBSELSRC,C'N'                                                    
         DROP  R3                                                               
*                                                                               
         XC    EZWORK,EZWORK                                                    
         MVI   EZWORK+5,L'EZIHDEM                                               
         LAY   RE,EZIHDEM                                                       
         MVI   EZWORK,8+L'EZIHDEM    (FIELD LENGTH)                             
         MVC   EZWORK+8(L'EZIHDEM),0(RE)                                        
         OC    EZWORK+8(L'EZIHDEM),SPACES                                       
         LA    R3,EZWORK                                                        
         GOTO1 VDEMOVAL,DMCB,(1,(R3)),(1,WORK),(C'S',ADBUY),0                   
         CLI   DMCB+4,0                                                         
         BNE   *+12                                                             
         MVI   EZERRCD,EZERRDEM                                                 
         B     COMERR                                                           
*                                                                               
         MVC   SNVHDDEM,WORK                                                    
*                                                                               
LINV20   DS    0H                                                               
         LR    R1,R2               DUMP ELEM                                    
         BRAS  RE,DMPREC                                                        
         B     LINVCPCN                                                         
*                                                                               
         USING SNVIDELD,R2         ESTABLISH AS DETAIL ELEMENT                  
LINVCHDN DS    0H                                                               
         CLI   SNVIDEL,SNVIDELQ    SKIP IF NOT DETAIL ELEMENT                   
         BNE   LINVCIDN                                                         
*                                                                               
         CLC   =C'BVS',EZSRCE      IF SOURCE BVS                                
         BE    *+14                                                             
         CLC   =C'BDS',EZSRCE      IF SOURCE BDS                                
         BNE   LINVCH10                                                         
         OC    EZITBDUE,EZITBDUE   AND ZERO DOLLARS                             
         BNZ   LINVCH10                                                         
         AHI   RF,EZITPDUE-EZBLOCKD                                             
         CP    0(8,RF),=P'0'                                                    
         BNE   LINVCH10                                                         
         MVC   SNVIDRSP,SNVIDCST+1    COPY COST TO RESPONSES                    
         XC    SNVIDCST,SNVIDCST      CLEAR COST FIELD                          
*                                                                               
LINVCH10 DS    0H                                                               
         TM    EZIHFLG,EZIHINTQ    INT-ONLY INVOICE?                            
         BZ    LINVCPCN            NO - DON'T BOTHER WITH BONUS FLAGS           
         TM    EZIHFLG,EZIHIPQ     DO WE HAVE AT LEAST 1 INT SPOT?              
         BZ    LINVCPCN            NO - DON'T BOTHER WITH BONUS FLAGS           
         OI    SNVIDCT2,SNVIDBON                                                
*                                                                               
         B     LINVCPCN                                                         
*                                                                               
LINVCIDN DS    0H                                                               
         CLI   0(R2),SNVDTELQ      DETAIL ORDER ELEMENT?                        
         BNE   LINVDODN                                                         
*                                                                               
         TM    EZIHFLG,EZIHINTQ    INT-ONLY INVOICE?                            
         BZ    LINVDODN                                                         
         TM    EZIHFLG,EZIHIPQ     DO WE HAVE AT LEAST 1 INT SPOT?              
         BZ    LINVDODN                                                         
*                                                                               
         LR    R1,R2                                                            
         LHI   R0,FLDNINTG                                                      
         BRAS  RE,UPDORDER                                                      
*                                                                               
LINVDODN DS    0H                                                               
*                                                                               
LINVCPCN DS    0H                                                               
         CLI   EZTEST,C'Y'         TEST TO SUPPRESS MARKING                     
         BE    LINVCBY                                                          
         CLI   EZWRITE,C'Y'        IF WRITES NOT ALLOWED                        
         BNE   LINVCBY                                                          
*                                                                               
         GOTO1 ADDEL,DMCB,MINBLK,SNVELEM,0  ADD TO FILE RECORD                  
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         CLI   MINERR,0            NO ERRORS TOLERATED                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
LINVCBY  DS    0H                                                               
         GOTO1 VMINIO,MNPRMS,('MINSEQ',MINBLKBF)  NEXT BUFFER ELEMENT           
*                                                                               
LINVCPC1 DS    0H                                                               
*                                                                               
         B     LINVCPLP                                                         
*                                                                               
LINVCPDN DS    0H                                                               
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINCLS',MINBLK)    CLOSE FILE   RECORD           
         GOTO1 (RF),(R1),('MINCLS',MINBLKBF)  CLOSE BUFFER RECORD               
*                                                                               
         DROP  R5                                                               
*                                                                               
LINVCPYX DS    0H                                                               
*                                                                               
LINV90   DS    0H                  MARK INVOICE AS CONVERTED                    
         CLI   EZWRITE,C'Y'        IF WRITES NOT ALLOWED                        
         JNE   LINV96                                                           
*                                                                               
         CLI   EZTEST,C'Y'         TEST TO SUPPRESS MARKING                     
         JE    LINV96                                                           
*                               SET CONVERSION DATA IN INVOICE HEADER           
         L     R3,=A(SAVINVH)      A(INVOICE HEADER SAVE AREA)                  
         LA    R3,7(,R3)           SAVED INVOICE HEADER                         
*                                  SKIP RECLEN(4),RECCODE(2),DELIM(1)           
LINV91   DS    0H                  MARK INVOICES AS DELETED                     
         OI    0(R3),EZIHCVQ       INDICATE A CONVERTED INVOICE                 
         NI    0(R3),X'FF'-EZIHRCVQ  TURN OFF ANY RECONVERTED INDICATOR         
*                                                                               
         GOTO1 DATCON,DMCB,(0,TODAY),(1,1(R3)) TODAY PWOS                       
*                                                                               
         MVC   4(2,R3),EZIHLADB    CLIENT                                       
         MVC   6(1,R3),EZIHLPRB    PRODUCT                                      
         MVC   7(1,R3),EZIHLP2B    PRODUCT 2                                    
         MVC   8(1,R3),EZIHBEST    ESTIMATE                                     
         OI    11(R3),X'80'        STOP TRAILING BLANK DELETION                 
*                                                                               
         NI    0(R3),X'FF'-EZIHCONS TURN OFF SOON FLAG                          
         CLI   EZSOON,C'S'         THIS RUNNING SOON?                           
         BNE   *+8                 NO                                           
         OI    0(R3),EZIHCONS      INVICATE INV CONVERTED SOON                  
*                                                                               
         LHI   R0,36               COLUMN 36 - SECOND SAVE FIELD                
         L     R1,=A(SAVINVH)      A(INVOICE HEADER SAVE AREA)                  
         BRAS  RE,FINDFLD                                                       
         BNE   LINV92                                                           
         MVC   EZIHSPRD-EZIHSAV(L'EZIHSPRD,R1),EZIHLPRC                         
         MVC   EZIHSPR2-EZIHSAV(L'EZIHSPR2,R1),EZIHLP2C                         
*                                                                               
* NOW RESET TO HEADER (31) RECORD OF CURRRENT INVOICE *                         
*                                                                               
LINV92   DS    0H                                                               
         LAY   R6,EZWRKIOB                                                      
         USING WRKIOB,R6                                                        
         MVC   WRKEZREC,EZHDRSEQ                                                
         MVI   WRKIACTN,WRKIARAN                                                
         GOTO1 EZWRKIO,(R6)                                                     
         CLI   WRKIERRS,0                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     RE,=A(SAVINVH)                                                   
         L     RF,EZWKRREC         SAVE INVOICE HEADER RECORD                   
*                                                                               
         CLC   4(2,RF),=C'31'      MUST BE INVOICE HEADER RECORD                
         BE    *+6                                                              
         DC    H'0'                INVOICE HEADER RECORDS DIFFERENT             
*                                                                               
         CLC   0(7,RE),0(RF)       MUST BE SAME LENGTH AND RECORD               
         BE    *+6                                                              
         DC    H'0'                INVOICE HEADER RECORDS DIFFERENT             
*                                                                               
         LH    R1,0(RE)            LENGTH OF RECORD                             
*                                                                               
         LR    R0,RF               TO ADDR                                      
         LR    RF,R1               LENGTH OF MOVE                               
         MVCL  R0,RE                                                            
*                                                                               
         CLI   EZWRITE,C'Y'        TEST IF WRITE ALLOWED                        
         JNE   LINV94                                                           
*                                                                               
         LAY   R6,EZWRKIOB                                                      
         USING WRKIOB,R6                                                        
         MVI   WRKIACTN,WRKIAPUT                                                
         GOTO1 EZWRKIO,(R6)                                                     
         CLI   WRKIERRS,0                                                       
         JNE   *+2                                                              
*                                                                               
* NOW RESET BACK TO CURRENT RECORD *                                            
*                                                                               
LINV94   DS    0H                                                               
         LAY   R6,EZWRKIOB                                                      
         USING WRKIOB,R6                                                        
         LH    R0,EZRECSEQ                                                      
         AHI   R0,1                                                             
         STCM  R0,3,WRKEZREC                                                    
         MVI   WRKIACTN,WRKIARAN                                                
         GOTO1 EZWRKIO,(R6)                                                     
         CLI   WRKIERRS,0                                                       
         JNE   *+2                                                              
*                                                                               
LINV96   DS    0H                                                               
*                                                                               
LINVX    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - COMSUBS'                      
*                                                                               
***********************************************************************         
*                                                                     *         
*        COMSUBS - CODE AND DATA ADDRESSABLE FROM ALL CSECTS          *         
*                                                                     *         
***********************************************************************         
*                                                                               
COMSUBS  DS    0H                                                               
*                                                                               
SNVDTELM DS    XL256               DETAIL ORDER ELEM                            
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - SETCML'                       
***********************************************************************         
*                                                                     *         
*        SETCML - FIND/SET CMML ELEMENTS IN BUFFER                    *         
*                                                                     *         
*NTRY    R3 ==>  COMMERCIAL CODE                                      *         
*        R4 ==>  TRAFFIC SEQUENTIAL NUMBER                            *         
*        R5 ==>  A(MINBLK)                                            *         
*                                                                     *         
*EXIT    BYTE  -  COMMERCIAL INTERNAL CODE                            *         
*                                                                     *         
***********************************************************************         
*                                                                               
SETCML   NTR1                                                                   
*                                                                               
         MVC   SETCSVAD,SPACES     WORK AREA FOR AD-ID/COMML CODES              
         MVC   SETCSVAD(8),0(R3)   SAVE COMML CODE IN WORK AREA                 
*                                                                               
         TM    EZSPLKST,EZSPADID   AD-IDS?                                      
         BZ    SETCML10            NO - LEAVE COMML CODE IN WORK AREA           
*                                                                               
* AD-ID HERE.  REPLACE PACKED 8-BYTES WITH 12-CHARACTER AD-ID                   
*                                                                               
         XC    DMCB(24),DMCB                                                    
         MVC   DMCB+4(4),=X'D9000AFE'                                           
         L     RF,ACOMFACS         GET CALLOV ADDRESS                           
         L     RF,CCALLOV-COMFACSD(RF) A(CALLOV)                                
         GOTO1 (RF),DMCB                                                        
         CLI   4(R1),X'FF'                                                      
         BE    NEQXIT                                                           
*                                                                               
         L     RF,0(R1)            ADDRESS OF TRPACK                            
         GOTO1 (RF),DMCB,(C'U',0(R3)),SETCSVAD                                  
         BNE   NEQXIT                                                           
*                                                                               
SETCML10 DS    0H                                                               
         OC    SETCSVAD,SPACES     NO - GET RID OF NULLS                        
*                                                                               
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
         MVI   BYTE,0                                                           
*                                                                               
         XC    SNVCMELM,SNVCMELM                                                
         LA    R2,SNVCMELM         ESTABLISH COMMERCIAL ELEMENT                 
         USING SNVCMELD,R2                                                      
*                                                                               
         MVI   SNVCMEL,SNVCMELQ    SET ELEMENT ID                               
         MVI   SNVCMLEN,SNVCMICD-SNVCMELD  IGNORE INTERNAL CD IN SEARCH         
*                                                                               
         GOTO1 GETEL,DMCB,MINBLKD,SNVCMEL,0 FIND FIRST COMMERCIAL ELM           
*                                                                               
SETCMLLP DS    0H                                                               
         ICM   R2,15,8(R1)      R2 POINTS TO FOUND ELEMENT FROM HERE ON         
         BZ    SETCMLDN            END OF COMMERCIAL ELEMENTS REACHED           
*                                                                               
         MVC   SNVCMICD-SNVCMELD+SNVCMELM,SNVCMICD  SAVE INTERNAL CODE          
*                                                                               
         MVC   WORK(12),SNVCMCD    COMML CODE IN THE 30 ELEMENT                 
         OC    WORK(12),SPACES                                                  
         LHI   RF,11               ONE LESS THAN AD-ID LENGTH                   
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   WORK(0),SETCSVAD       MATCH ON COMMERCIAL CODE?                 
         BE    SETCMLFD            YES                                          
*                                                                               
SETCMLCN DS    0H                                                               
         GOTO1 SEQEL,DMCB,MINBLKD,SNVCMELM,0  GET NEXT ELEMENT                  
         B     SETCMLLP                                                         
*                                                                               
SETCMLFD DS    0H                                                               
         MVC   BYTE,SNVCMICD-SNVCMELD+SNVCMELM  RETURN INTERNAL CODE            
         B     SETCMLX                                                          
*                                                                               
SETCMLDN DS    0H                                                               
         LA    R2,SNVCMELM         RE-POINT TO COMML ELM BUILD AREA             
         MVI   SNVCMLEN,SNVCMLNQ   SET ELEMENT LENGTH                           
*                                                                               
         CLI   SNVCMICD,X'FF'                                                   
         BL    *+12                                                             
         MVI   EZERRCD,EZERRM2C    MORE THAN 255 DIFFERENT COMMERCIALS          
         B     COMERR                                                           
*                                                                               
         SR    RF,RF                                                            
         IC    RF,SNVCMICD         BUMP LAST FOUND INTERNAL CODE                
         LA    RF,1(RF)                                                         
         STC   RF,SNVCMICD                                                      
*                                                                               
         STC   RF,BYTE             RETURN NEWEST INTERNAL CODE                  
*                                                                               
         MVC   SNVCMSEQ,0(R4)      SET TRAFFIC SEQUENCE NUMBER                  
         TM    2(R4),X'01'         HI-DEF?                                      
         BZ    *+8                                                              
         OI    SNVCMFLG,SNVCMHDQ                                                
         MVC   SNVCMAID,SETCSVAD                                                
*                                                                               
         GOTO1 ADDEL,DMCB,MINBLKD,SNVCMELM,0  ADD TO RECORD                     
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
SETCMLX  DS    0H                                                               
         B     EQXIT                                                            
*                                                                               
SETCMLNX DS    0H                                                               
         B     NEQXIT                                                           
*                                                                               
*                                                                               
*        GETERRM - GET ERROR MESSAGE AND LEVEL                                  
*                                                                               
GETERRM  NTR1                                                                   
         L     R3,=A(ERRTAB)                                                    
         MVC   EZERRMSG,SPACES                                                  
         MVI   EZERRLEV,0                                                       
*                                                                               
GERM2    DS    0H                                                               
         CLI   0(R3),X'FF'         EOL                                          
         BE    GERMX                                                            
*                                                                               
         CLC   EZERRCD,0(R3)                                                    
         BE    GERM4                                                            
         LA    R3,ERRTABL(R3)                                                   
         B     GERM2                                                            
*                                                                               
GERM4    DS    0H                                                               
         MVC   EZERRLEV,1(R3)                                                   
         MVC   EZERRMSG,2(R3)                                                   
         OC    EZERRLVR,1(R3)      'OR' UP ERROR - RECORD                       
         OC    EZERRLVI,1(R3)                    - INVOICE                      
         OC    EZERRLVB,1(R3)                    - BATCH                        
*                                                                               
         CLI   EZERRCD,EZERRSTA                                                 
         BNE   GERMX                                                            
*                                                                               
         MVC   EZERRMSG(3),EZSPNET                                              
         OC    EZERRMSG(3),SPACES                                               
*                                                                               
GERMX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
SAVBUF   DS    0H                  SAVE WRKR BUFFER                             
         L     RF,EZWKRBUF                                                      
         L     R1,=A(SAVWKBUF)                                                  
*                                                                               
         LA    R0,16               16 X 256 BYTES = 4096                        
         MVC   0(256,R1),0(RF)                                                  
         LA    R1,256(R1)                                                       
         LA    RF,256(RF)                                                       
         BCT   R0,*-14                                                          
         BR    RE                                                               
*                                                                               
INVFILE  DC    CL8'XSPFIL '        INVOICE FILE NAME                            
INVDIR   DC    CL8'XSPDIR'         INVOICE DIRECTORY NAME                       
ERRTABL  EQU   42                                                               
*                                                                               
VMINIO   DS    A                   A(MINIO)                                     
VPERVERT DS    A                   A(PERVERT)                                   
VGTBROAD DS    A                   A(GETBROAD)                                  
VDEMOVAL DS    A                   A(DEMOVAL)                                   
*                                                                               
ADSCTL   DC    C'1'                CONTROL SWITCH                               
ADS1STQ  EQU   C'1'                FIRST TIME TO PROGRAM                        
*                                                                               
*                                                                               
*                                                                               
CADDEL   NTR1                                                                   
         GOTO1 ADDEL,DMCB,MINBLKD,(R2),0 ADD ELEMENT TO RECORD                  
         B     EXIT                                                             
*                                                                               
         TITLE 'ROUTINE TO ADD ELEMENT TO A MINIO BLOCK - ADDEL'                
***********************************************************************         
* ROUTINE TO ADD AN ELEMENT TO A RECORD                               *         
*                                                                     *         
* NTRY - PARM1    A(MINIO BLOCK)                                      *         
*        PARM2    A(ELEMENT)                                          *         
*                                                                     *         
***********************************************************************         
*                                                                               
ADDEL    NTR1                                                                   
*                                                                               
         L     R5,0(R1)            A(MINBLKD)                                   
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
*                                                                               
         ICM   R0,15,MINELEM       SAVE ELEMENT AREA POINTER                    
*                                                                               
         MVC   MINELEM,4(R1)       POINT BLOCK TO NEW ELEMENT                   
*                                                                               
         CLI   EZSOON,C'S'         THIS RUNNING SOON?                           
         BNE   ADDEL10              NO, DON'T TRACK REC SIZE                    
*                                                                               
         SR    RE,RE                                                            
         L     R2,4(R1)                                                         
         IC    RE,1(R2)                                                         
         SR    RF,RF                                                            
         ICM   RF,3,EZINVSIZ                                                    
         AR    RF,RE                                                            
         STCM  RF,3,EZINVSIZ                                                    
*                                                                               
*                                                                               
ADDEL10  DS    0H                                                               
         L     R1,4(R1)               POINT TO ELEMENT TO BE ADDED              
         BRAS  RE,DMPREC              GO DUMP ELEMENT                           
         GOTO1 VMINIO,MNPRMS,('MINADD',MINBLKD)                                 
         STCM  R0,15,MINELEM       RESTORE ELEMENT AREA POINTER                 
         CLI   MINERR,0            NO ERRORS ALLOWED                            
         BE    ADDELX                                                           
         CLI   MINERR,MINEDUP      EXCEPT DUPLICATES                            
         BE    *+6                                                              
         DC    H'0'                                                             
         LTR   RB,RB               SET BAD CONDITION CODE                       
*                                                                               
ADDELX   XIT1                                                                   
*                                                                               
         DROP  R5                                                               
*                                                                               
*                                                                               
*                                                                               
         TITLE 'ROUTINE TO DELETE AN ELEMENT IN A MINIO BLOCK - ADDEL'          
***********************************************************************         
* ROUTINE TO DELETE AN ELEMENT FROM A RECORD                          *         
*                                                                     *         
* NTRY - PARM1    A(MINIO BLOCK)                                      *         
*        PARM2    A(ELEMENT)                                          *         
*                                                                     *         
***********************************************************************         
*                                                                               
DELEL    NTR1  0H                                                               
         L     R5,0(R1)            A(MINBLKD)                                   
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
*                                                                               
         ICM   R0,15,MINELEM       SAVE ELEMENT AREA POINTER                    
*                                                                               
         L     R2,4(R1)            POINT TO ELEMENT TO BE DELETED               
*                                                                               
         ST    R2,MINELEM          POINT BLOCK TO ELEMENT                       
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY AREA                        
*                                                                               
         MVC   MINEKEY(1),0(R2)    BUILD ELEMENT KEY                            
*                                                                               
         ZIC   RF,1(R2)            GET ELEMENT LENGTH                           
         BCTR  RF,0                GET KEY LENGTH                               
*                                                                               
         CLM   RF,1,MINEKLEN       DEFAULT TO MINIO KEY LENGTH                  
         BNH   *+8                                                              
         IC    RF,MINEKLEN                                                      
*                                                                               
         AHI   RF,-2               DECREMENT FOR EXECUTE                        
*                                                                               
         EX    RF,DELELMV          SET REST OF KEY                              
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINDEL',MINBLKD)                                 
*                                                                               
         STCM  R0,15,MINELEM       RESTORE ELEMENT AREA POINTER                 
*                                                                               
         CLI   MINERR,0            NO ERRORS ALLOWED                            
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     DELELX                                                           
*                                                                               
DELELMV  MVC   MINEKEY+1(0),2(R2)   SETS REST OF ELEMENT KEY                    
*                                                                               
*                                                                               
DELELX   XIT1                                                                   
*                                                                               
         DROP  R5                                                               
*                                                                               
         TITLE 'ROUTINE TO GET AN ELEMENT IN A MINIO BLOCK - GETEL'             
***********************************************************************         
* ROUTINE TO GET AN ELEMENT IN A RECORD                               *         
*                                                                     *         
* NTRY - PARM1    A(MINIO BLOCK)                                      *         
*        PARM2    A(ELEMENT)                                          *         
*        ELEMENT  CONTAINS ELEMENT CODE AND DATA TO SEARCH FOR        *         
*        ELEMENT+1 CONTAINS LENGTH TO BE COMPARED INCLUDING LENGTH    *         
*                 BYTE WHICH IS NOT INCLUDED IN COMPARE               *         
* EXIT - 8(R1)  CONTAINS ADDRESS OF ELEMENT OR ZEROES IF NOT FOUND    *         
***********************************************************************         
*                                                                               
GETEL    NTR1                                                                   
         L     R5,0(R1)            A(MINBLKD)                                   
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
*                                                                               
         L     R2,4(R1)            POINT O ELEMENT KEY                          
         LR    R4,R1               SAVE PARAMETER REGISTER                      
*                                                                               
         ZIC   R6,MINFILTL         SAVE CURRENT FILTER VALUE                    
*                                                                               
         MVI   MINFILTL,0          INIT FILTER LENGTH                           
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY AREA                        
*                                                                               
         MVC   MINEKEY(1),0(R2)    BUILD ELEMENT KEY                            
*                                                                               
         LA    R0,MINRD            DEFAULT TO DIRECT READ                       
*                                                                               
         CLI   1(R2),0             USE DEFAULT IF NO LENGTH GIVEN               
         BE    GETEL10                                                          
*                                                                               
         ZIC   RF,1(R2)            GET ELEMENT LENGTH                           
         BCTR  RF,0                GET SEARCH LENGTH                            
*                                                                               
         CLM   RF,1,MINEKLEN       USE READ IF GREATER THAN KEY LENGTH          
         BNL   GETEL10                                                          
*                                                                               
         LA    R0,MINHI            SET FOR READ HI/EQUAL                        
         STC   RF,MINFILTL         SET FILTER LENGTH                            
*                                                                               
GETEL10  DS    0H                                                               
*                                                                               
         ZIC   RF,MINEKLEN         GET KEY LENGTH                               
         AHI   RF,-2               DECREMENT FOR EXECUTE                        
         EX    RF,GETELMV          SET REST OF KEY                              
*                                                                               
         GOTO1 VMINIO,MNPRMS,((R0),MINBLKD)                                     
*                                                                               
         STC   R6,MINFILTL         RESTORE CURRENT FILTER VALUE                 
*                                                                               
         XC    8(4,R4),8(R4)       INIT RETURNED PARAMETER                      
*                                                                               
         CLI   MINERR,0            NO MATCH                                     
         BNE   GETELX                                                           
*                                                                               
         MVC   8(4,R4),MINELEM     GET RETURNED ELEMENT ADDRESS                 
         B     GETELX                                                           
*                                                                               
GETELMV  MVC   MINEKEY+1(0),2(R2)  SETS REST OF ELEMENT KEY                     
*                                                                               
GETELX   XIT1                                                                   
         DROP  R5                                                               
*                                                                               
*                                                                               
*                                                                               
         TITLE 'ROUTINE TO GET NEXT ELEMENT IN A MINIO BLOCK - SEQEL'           
***********************************************************************         
* ROUTINE TO GET NEXT SEQUENTIAL ELEMENT IN A MINIO RECORD            *         
*                                                                     *         
* NTRY - PARM1    A(MINIO BLOCK)                                      *         
*        PARM2    A(ELEMENT)                                          *         
*        ELEMENT  CONTAINS ELEMENT CODE AND DATA TO SEARCH FOR        *         
*        ELEMENT+1 CONTAINS LENGTH TO BE COMPARED INCLUDING LENGTH    *         
*                 BYTE WHICH IS NOT INCLUDED IN COMPARE               *         
*                 ASSUMES LAST ACTION WAS A GETEL AND MINIO BLOCK     *         
*                  IS ALREADY SET UP FOR SEQUENTIAL READ              *         
*                                                                     *         
* EXIT - 8(R1)  CONTAINS ADDRESS OF ELEMENT OR ZEROES IF NOT FOUND    *         
***********************************************************************         
*                                                                               
SEQEL    NTR1                                                                   
         L     R5,0(R1)            A(MINBLKD)                                   
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
*                                                                               
         L     R2,4(R1)            POINT TO ELEMENT KEY                         
         LR    R4,R1               SAVE PARAMETER REGISTER                      
*                                                                               
         ZIC   R6,MINFILTL         SAVE CURRENT FILTER VALUE                    
*                                                                               
         MVI   MINFILTL,0          INIT FILTER LENGTH                           
*                                                                               
         CLI   1(R2),0             USE DEFAULT IF NO LENGTH GIVEN               
         BE    SEQEL10                                                          
*                                                                               
         ZIC   RF,1(R2)            GET ELEMENT LENGTH                           
         BCTR  RF,0                GET SEARCH LENGTH                            
*                                                                               
         CLM   RF,1,MINEKLEN       USE READ IF GREATER THAN KEY LENGTH          
         BNL   SEQEL10                                                          
*                                                                               
         STC   RF,MINFILTL         SET FILTER LENGTH                            
*                                                                               
SEQEL10  DS    0H                                                               
*                                                                               
         LA    R0,MINSEQ           SET FOR READ READ SEQUENTIAL                 
*                                                                               
         GOTO1 VMINIO,MNPRMS,((R0),MINBLKD)                                     
*                                                                               
         STC   R6,MINFILTL         RESTORE CURRENT FILTER VALUE                 
*                                                                               
         XC    8(4,R4),8(R4)       INIT RETURNED PARAMETER                      
*                                                                               
         CLI   MINERR,0            NO MATCH                                     
         BNE   SEQELX                                                           
*                                                                               
         MVC   8(4,R4),MINELEM     GET RETURNED ELEMENT ADDRESS                 
         B     SEQELX                                                           
*                                                                               
SEQELX   XIT1                                                                   
         DROP  R5                                                               
*                                                                               
*                                                                               
         TITLE 'ROUTINE TO PUT AN ELEMENT TO A MINIO BLOCK - PUTEL'             
***********************************************************************         
* ROUTINE TO PUT AN ELEMENT IN A RECORD                               *         
*       DELETES AND ADDS NEW ELEMENT WILL NOT GET UPSET IF THERE      *         
*         IS NO PRIOR ELEMENT                                         *         
*                                                                     *         
* NTRY - PARM1    A(MINIO BLOCK)                                      *         
*        PARM2    A(ELEMENT)                                          *         
*                                                                     *         
***********************************************************************         
*                                                                               
PUTEL    NTR1  0H                                                               
         GOTO1 GETEL,(R1)          FIND ELEMENT                                 
*                                                                               
         OC    8(4,R1),8(R1)       ADD ELEMENT IF NONE ALREADY                  
         BZ    PUTELADD            ELSE DELETE OLD ELEMENT                      
*                                                                               
         GOTO1 DELEL,(R1)          DELETE ELEMENT                               
*                                                                               
PUTELADD DS    0H                                                               
*                                                                               
         GOTO1 ADDEL,(R1)          ADD ELEMENT TO RECORD                        
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
PUTELX   XIT1                                                                   
*                                                                               
*                                                                               
*                                                                               
PRAERR   MVI   EZERRCD,EZERRSPL    SET ERROR SPOT LEN = ZERO                    
         B     COMERR                                                           
*                                                                               
TIMERR   MVI   EZERRCD,EZERRTMZ    SET ERROR TIME = ZERO                        
         B     COMERR                                                           
*                                                                               
TIMHIGH  MVI   EZERRCD,EZERRTMH    SET ERROR TIME = HIGH                        
         B     COMERR                                                           
*                                                                               
DATERR   MVI   EZERRCD,EZERRDTE    SET ERROR DATE = ZERO                        
*                                                                               
COMERR   DS    0H                                                               
         BAS   RE,GETERRM                                                       
         MVI   EZMODE,EZINVL       SET TO SKIP TO NEXT INV                      
         B     EXIT                                                             
*                                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
*                                                                               
SAVRC    DS    F                                                                
*                                                                               
SVHDSDT  DS    H                                                                
SVHDEDT  DS    H                                                                
*                                                                               
HOLDSE   DC    H'0'                                                             
         DS    0D                                                               
MINBLK   DS    XL(MINBLKL)         MINIO BLOCK FOR INVOICE RECORD               
         DS    0D                                                               
MINBLKBF DS    XL(MINBLKL)         MINIO BLOCK FOR BUFFER INVOICE REC           
****** END COMSUBS * ALL LABELS BELOW USE RELATIVE ADDRESSING *********         
*                                                                               
*                                                                               
*                                                                               
*                                                                               
         DS    0D                                                               
SNVMELEM DS    XL128               ELEMENT RETRIEVAL AREA                       
SNVMRTAB DS    XL14336             RECORD TABLE                                 
*                                                                               
         DS    0D                                                               
SAVINVH  DS    XL512               SAVE AREA FOR INVOICE HEADER                 
         DS    0D                                                               
SNVMBUF1 DS    XL4200              FIRST  MINIO BUFFER                          
SNVMBUF2 DS    XL4200              SECOND MINIO BUFFER                          
SNVMBUF3 DS    XL4200              THIRD  MINIO BUFFER                          
SNVMBUF4 DS    XL4200              FOURTH MINIO BUFFER                          
*                                                                               
SAVWKBUF DS    XL14336             WORKER FILE BUFFER SAVEAREA                  
*                                                                               
*                                  ERROR TABLE                                  
*                                  CODE(1),LEVEL(1),MESSAGE(40)                 
*                                                                               
ERRTAB   DS    0C                                                               
         DC    AL1(EZERRDUP)       DUPLICATE INVOICE                            
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVOICE ALREADY ON FILE'                                    
*                                                                               
         DC    AL1(EZERROVF)       OVERFLOW                                     
         DC    AL1(0)              LEVEL                                        
         DC    CL40'TOO MANY SPOTS IN INVOICE'                                  
*                                                                               
         DC    AL1(EZERRANF)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'CLIENT NOT ON FILE'                                         
*                                                                               
         DC    AL1(EZERRPNF)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'PRODUCT NOT ON FILE'                                        
*                                                                               
         DC    AL1(EZERRSPL)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'SPOT DETAIL SPOT LENGTH ZERO'                               
*                                                                               
         DC    AL1(EZERRMUL)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'COMBINED INVOICES, NO RECONVERT'                            
*                                                                               
         DC    AL1(EZERRZER)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'ZERO DOLLARS, NO CONVERT'                                   
*                                                                               
         DC    AL1(EZERRTMZ)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'SPOT DETAIL TIME ZERO'                                      
*                                                                               
         DC    AL1(EZERRDTE)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'SPOT DETAIL DATE OUT OF PERIOD'                             
*                                                                               
         DC    AL1(EZERRENF)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'ESTIMATE NOT ON FILE'                                       
*                                                                               
         DC    AL1(EZERREDT)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INV DATES NOT IN EST DATES'                                 
*                                                                               
         DC    AL1(EZERRSTA)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'XXX: UNKNOWN NET FOR CABLE STATION'                         
*                                                                               
         DC    AL1(EZERRTMH)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'SPOT DETAIL TIME HIGH'                                      
*                                                                               
         DC    AL1(EZERRDOL)       INVALID DOLLAR FIELD                         
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID DOLLARS'                                            
*                                                                               
         DC    AL1(EZERBDDT)       BAD DATE                                     
         DC    AL1(0)              LEVEL                                        
         DC    CL40'BAD DATE'                                                   
*                                                                               
         DC    AL1(EZERBRDT)       BAD BROADCAST MONTH                          
         DC    AL1(0)              LEVEL                                        
         DC    CL40'BAD BROADCAST MONTH'                                        
*                                                                               
         DC    AL1(EZERRSIZ)       INVOICE TOO BIG FOR SOON                     
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVOICE TOO BIG FOR SOON'                                   
*                                                                               
         DC    AL1(EZERRCON)       CONTRACT NUMBER NOT ON REP FILE              
         DC    AL1(0)              LEVEL                                        
         DC    CL40'CONTRACT NOT ON REP FILE'                                   
*                                                                               
*                                                                               
         DC    AL1(EZERRTIM)       BAD TIME                                     
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID TIME'                                               
*                                                                               
         DC    AL1(EZERRBDS)       REP - CONTRACT HAS DIFFERENT STA             
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVOICE WRONG STA FOR CONTRACT'                             
*                                                                               
         DC    AL1(EZERRNUM)       NO INVOICE NUMBER                            
         DC    AL1(0)              LEVEL                                        
         DC    CL40'NO INVOICE NUMBER'                                          
*                                                                               
         DC    AL1(EZERESTR)       ESTIMATE CODE REQUIRED                       
         DC    AL1(0)              LEVEL                                        
         DC    CL40'ESTIMATE CODE REQUIRED'                                     
*                                                                               
         DC    AL1(EZERR255)       MORE THAN 255 IDENTICAL SPOTS                
         DC    AL1(0)              LEVEL                                        
         DC    CL40'OVER 255 SPOTS WITH SAME DATE,TIME'                         
*                                                                               
         DC    AL1(EZERRNET)       NETWORK CODE MISSING                         
         DC    AL1(0)              LEVEL                                        
         DC    CL40'NETWORK CODE MISSING'                                       
*                                                                               
         DC    AL1(EZERRDEM)       INVALID DEMO CATEGORY                        
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID DEMO CATEGORY'                                      
*                                                                               
         DC    AL1(EZERRM2C)       MORE THAN 255 UNIQUE COMMERCIALS             
         DC    AL1(0)              LEVEL                                        
         DC    CL40'OVER 255 UNIQUE COMMERCIAL CODES'                           
*                                                                               
         DC    X'FFFF'                                                          
*                                                                               
         DROP  RB,RC                                                            
*                                                                               
*                                                                               
*                                                                               
         USING EZADSD,RC                                                        
GENINIT  NTR1  BASE=*,LABEL=*                                                   
         XC    DMCB(24),DMCB                                                    
         MVC   DMCB+4(4),=X'D9000AD9'    DEMOVAL                                
         L     RF,ACOMFACS         GET CALLOV ADDRESS                           
         L     RF,CCALLOV-COMFACSD(RF) A(CALLOV)                                
         GOTO1 (RF),DMCB                                                        
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   VDEMOVAL,0(R1)            ADDRESS OF DEMOVAL                     
         J     EQXIT                                                            
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
         TITLE 'EZADDSNV - PROGRAM INITIALIZATION - MININIT'                    
***********************************************************************         
*                                                                     *         
*        MININIT - PROGRAM INITIALIZATION                             *         
*              INIT SPOT INVOICE RECORD MINIO BLOCK                   *         
*              INIT SPOT INVOICE RECORD BUFFER MINIO BLOCK            *         
*                                                                     *         
***********************************************************************         
*                                                                               
MININIT  NMOD1 0,**+MIN**                                                       
*                                                                               
         L     RC,SAVRC                                                         
         USING EZADSD,RC                                                        
         MVI   ADSCTL,0               CLEAR FIRST TIME SWITCH                   
         L     RF,ACOMFACS         GET MINIO ADDRESS                            
         MVC   CDATAMGR-COMFACSD(4,RF),DATAMGR  SET A(DATAMGR)                  
         MVC   VMINIO,CMINIO-COMFACSD(RF)                                       
*                                                                               
         L     RF,CCALLOV-COMFACSD(RF) A(CALLOV)                                
         ICM   R0,15,=X'D9000A74'  MINIO PHASE NAME                             
*                                                                               
         IC    R0,=X'1D'           GETBROAD PHASE NAME                          
         GOTO1 (RF),DMCB,0,(R0)                                                 
         MVC   VGTBROAD,0(R1)      SET GETBROAD ADDRESS                         
*                                                                               
         L     RF,=V(PERVERT)                                                   
         ST    RF,VPERVERT                                                      
*                                                                               
*        INITIALIZE MINIO VALUES                                                
*                                                                               
         LA    R0,MINBLK           CLEAR MINBLOCK                               
         LA    R1,MINBLKL                                                       
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         LA    R5,MINBLK           ESTABLISH MINIO BLOCK                        
         USING MINBLKD,R5                                                       
*                                                                               
         MVI   MINBF2,X'00'        FIRST MINIO BUFFER                           
         MVC   MINSPCT,=AL2(90)                                                 
*                                                                               
         MVC   MINRECUP,=V(RECUP)  A(RECUP)                                     
         MVC   MINCOMF,ACOMFACS    A(COMFACS)                                   
         MVI   MINOPEN,C'N'        SET NOT OPEN                                 
         MVC   MINFIL,INVFILE      FILE NAME                                    
         MVC   MINDIR,INVDIR       DIR NAME                                     
         MVI   MINFKLEN,L'SNVKEY   KEY LENGTH                                   
         MVI   MINEKLEN,L'SNVKMINK   ELEMENT KEY LENGTH                         
         MVI   MINEKDSP,L'SNVKMAST   DISPLACEMENT TO ELEMENT KEY                
*                                                                               
         MVI   MINNCTL,L'SNVDSTAT  NUMBER OF CONTROL BYTES                      
         MVC   MINFRCLM,=H'3975'   MAXIMUM RECORD LENGTH                        
*                                                                               
         CLI   EZSOON,C'S'         THIS RUNNING SOON?                           
         BNE   *+10                                                             
         MVC   MINFRCLM,=H'3500'   MAXIMUM RECORD LENGTH                        
*                                  FOR SOON - MINIO WRITES REC MORE             
*                                  THAN ONCE, PART AT A TIME                    
*                                                                               
         L     RF,=A(SNVMBUF1)     POINT TO START OF MINIO BUFFERS              
         ST    RF,MINBUFF          A(FIRST BUFFER)                              
*                                                                               
         MVI   MINNBUF,4           USE FOUR BUFFERS                             
*                                                                               
         L     RF,=A(SNVMRTAB)                                                  
         ST    RF,MINRTAB          A(AREA FOR RECORD TABLE)                     
*                                                                               
         MVC   MINRTABL,=Y(L'SNVMRTAB) LENGTH OF RECORD TABLE                   
*                                                                               
         L     RF,=A(SNVMELEM)      A(AREA FOR ELEM OR CLUSTER)                 
         ST    RF,MINELEM                                                       
*                                                                               
         XC    0(L'SNVMELEM,RF),0(RF)  CLEAR MINELEM AREA                       
*                                                                               
         MVC   MINMAXEL,=Y(L'SNVMELEM)   MAX LENGTH OF ELEM OR CLUSTER          
*                                                                               
***********************************************************************         
*                                                                     *         
*        SET UP BUFFER FOR BUILDING INVOICE MINIO RECORD              *         
*            IT WILL BE USED TO HOLD RECORDS WHILE TAPE IS            *         
*            BEING PROCESSED. AT END OF INV ON TAPE RECORDS WILL      *         
*            BE WRITTEN BACK TO FILE FROM THE BUFFERS. NEEDED TO      *         
*            PREVENT MINIO FROM WRITING TO FILE PREMATURELY. ALSO     *         
*            ALLOWS FOR TRUE TEST MODE.                               *         
*                                                                     *         
***********************************************************************         
*                                                                               
*                                                                               
*        MINIO PARAMETERS FOR INVOICE BUFFER                                    
*                                                                               
*NVBBFL  EQU   128000+64000+64000+64000  MINIO BUFFER LENGTH                    
*SNVBBFL  EQU   512000                    MINIO BUFFER LENGTH                   
*SNVBBFL  EQU   4200000             MINIO BUFFER LENGTH                         
SNVBBFL  EQU   2200000             MINIO BUFFER LENGTH                          
SNVBNBUF EQU   1                   NUMBER OF BUFFERS                            
SNVBELML EQU   256                 ELEMENT AREA LENGTH                          
SNVBTBLL EQU   ((6+L'SNVKMINK)*1) TABLE AREA LENGTH - MAX 1 RECORD              
*                                                                               
         LA    R5,MINBLKBF         POINT TO BUFFER MINIO BLOCK                  
         USING MINBLKD,R5                                                       
         XC    MINBLKD(MINNRECS-MINBLKD),MINBLKD INIT MINIO AREA                
*                                                                               
         MVI   MINBF2,C'Y'         SECOND MINIO BUFFER                          
*                                                                               
         MVC   MINRECUP,=V(RECUP)  A(RECUP)                                     
         MVC   MINCOMF,ACOMFACS    A(COMFACS)                                   
         MVI   MINOPEN,C'N'        SET NOT OPEN                                 
         MVC   MINFIL,INVFILE      FILE NAME                                    
         MVC   MINDIR,INVDIR       DIR NAME                                     
         MVI   MINFKLEN,L'SNVKEY   KEY LENGTH                                   
         MVI   MINEKLEN,L'SNVKMINK   ELEMENT KEY LENGTH                         
         MVI   MINEKDSP,L'SNVKMAST   DISPLACEMENT TO ELEMENT KEY                
         MVI   MINNCTL,L'SNVDSTAT  NUMBER OF CONTROL BYTES                      
         MVC   MINFRCM3,=AL3(SNVBBFL)  MAX RECORD LENGTH                        
         MVI   MINNBUF,SNVBNBUF    USE ONE BUFFER                               
*                                                                               
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         IC    RF,MINNBUF          NUMBER OF MINIO BLOCKS                       
         ICM   RE,7,MINFRCM3       LENGTH OF A MINIO BUFFER                     
         MR    RE,RE               BUFFER AREA NEEDED                           
         LA    RF,SNVBELML+SNVBTBLL(RF) ADD ON ELM AND TABLE LENGTHS            
*                                                                               
         LA    R3,8(RF)            MAKE EVEN NO. OF DOUBLE WORDS                
         SRL   R3,3                                                             
         SLL   R3,3                                                             
*                                                                               
         LA    R4,MINBUFF          RETURN ADDRESS HERE                          
*                                                                               
         GETMAIN EC,LV=(R3),A=(R4) GET CORE                                     
         LTR   RF,RF               CHECK FOR ERRORS                             
         BZ    *+6                                                              
         DC    H'0'                NO BUFFER AREA AVAILABLE                     
*                                                                               
         ICM   R1,15,MINBUFF       BUFFER ADDRESS                               
         L     RF,=AL4(SNVBBFL)                                                 
         AR    R1,RF               A(ELEMENT AREA)                              
         ST    R1,MINELEM                                                       
         LA    R1,SNVBELML(R1)     A(RECORD TABLE)                              
         ST    R1,MINRTAB                                                       
*                                                                               
         MVC   MINRTABL,=Y(SNVBTBLL)   LENGTH OF RECORD TABLE                   
*                                                                               
         MVC   MINMAXEL,=Y(SNVBELML)   MAX LENGTH OF ELEM OR CLUSTER            
*                                                                               
         MVI   MINMODE,C'B'        SET FOR BUFFER MODE                          
         MVC   MINFRCLM,=AL4(SNVBBFL)                                           
*                                                                               
MININITX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         DROP  R5                                                               
*                                                                               
*                                                                               
*        DMPREC - HEX DUMP OF ELEMENT WORK AREA                                 
*                                                                               
*NTRY    R1 ==>  ELEMENT TO BE ADDED                                            
*                                                                               
DMPREC   DS    0H                                                               
         TM    EZTRACE,X'10'       IF TRACING                                   
         BZR   RE                  NO                                           
DMP      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         GOTO1 REPORT                                                           
         LR    R5,R1               POINT TO ELEMENT WORKAREA                    
         SR    R2,R2                                                            
         ICM   R2,1,1(R5)          ELEMENT LENGTH                               
*                                                                               
         CLC   =X'0EA3',0(R5)      IF DUMPING KEY                               
         BE    *+14                                                             
         CLC   =X'0E03',0(R5)      IF DUMPING KEY                               
         BNE   *+8                                                              
         LA    R2,L'SNVKEY+8       RESET DUMP LENGTH                            
*                                                                               
         LA    R3,0(R5,R2)         EOR                                          
*                                                                               
DMPREC2  DS    0H                                                               
         LR    R4,R3                                                            
         SR    R4,R5                                                            
         BNP   DMPRECX                                                          
         CHI   R4,32                                                            
         BNH   *+8                                                              
         LA    R4,32                                                            
         XC    WORK,WORK                                                        
         GOTO1 HEXOUT,DMCB,(R5),WORK,(R4),=C'N'                                 
*                                                                               
         MVC   P+01(8),WORK+00                                                  
         MVC   P+10(8),WORK+08                                                  
         MVC   P+19(8),WORK+16                                                  
         MVC   P+28(8),WORK+24                                                  
         MVC   P+37(8),WORK+32                                                  
         MVC   P+46(8),WORK+40                                                  
         MVC   P+55(8),WORK+48                                                  
         MVC   P+64(8),WORK+56                                                  
*                                                                               
         MVC   WORK(32),0(R5)                                                   
         TR    WORK(32),TRTAB                                                   
         BCTR  R4,R0                                                            
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   P+75(0),WORK                                                     
         LA    R4,1(R4)                                                         
         GOTO1 REPORT                                                           
         LA    R5,0(R5,R4)                                                      
         B     DMPREC2                                                          
*                                                                               
DMPRECX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
TRTAB    DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     00-0F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     10-1F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     20-2F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     30-3F                    
         DC    X'404B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     40-4F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B5B5C5D4B4B'     50-5F                    
         DC    X'60614B4B4B4B4B4B4B4B4B6B6C6D4B6F'     60-6F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B7B4B7D7E4B'     70-7F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     80-8F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     90-9F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     A0-AF                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     B0-BF                    
         DC    X'4BC1C2C3C4C5C6C7C8C94B4B4B4B4B4B'     C0-CF                    
         DC    X'4BD1D2D3D4D5D6D7D8D94B4B4B4B4B4B'     D0-DF                    
         DC    X'4B4BE2E3E4E5E6E7E8E94B4B4B4B4B4B'     E0-EF                    
         DC    X'F0F1F2F3F4F5F6F7F8F94B4B4B4B4B4B'     F0-FF                    
*                                                                               
*                                                                               
*                                                                               
ISCANADA NTR1  BASE=*,LABEL=*                                                   
         L     R6,ADAGY                                                         
         AHI   R6,24               DISPLACEMENT TO FIRST ELEMENT                
*                                                                               
ISCAN10  CLI   0(R6),0                                                          
         JE    NEQXIT                                                           
         CLI   0(R6),X'01'                                                      
         BE    ISCAN30             ELEMENT FOUND - CHECK IF CANADA              
         ZIC   RF,1(R6)                                                         
         LTR   RF,RF                                                            
         JZ    NEQXIT                                                           
         AR    R6,RF                                                            
         B     ISCAN10                                                          
*                                                                               
         USING AGYEL,R6                                                         
ISCAN30  CLI   AGYPCNDA,C'C'                                                    
         JE    EQXIT                                                            
         J     NEQXIT                                                           
         DROP  R6                                                               
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
* THIS SUBROUTINE UPDATES DETAIL ORDER ELEMENT BY ADDING FIELD EQUATE           
* SUPPLIED BY THE CALLER                                                        
* FOLLOWING IS EXPECTED TO BE TRUE ON INPUT:                                    
*    R1 ADDRESSES DETAIL ELEMENT                                                
*    R0 HAS FIELD NUMBER EQUATE IN LOW-ORDER BYTE                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
UPDORDER NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LR    R2,R1               A(DETAIL ORDER ELEM)                         
         USING SNVDTELD,R1         R1 POINTS TO DETAIL ORDER ELEM               
         LHI   RF,MAXFLDEQ-4       MAX NUMBER OF EQUATES COUNTER                
         LA    R1,SNVDTFLD-SNVDTEL(R1)   POINT TO EQUATE LIST                   
*                                                                               
UPDORD10 CLM   R0,1,0(R1)          EQUATE ALREADY THERE?                        
         BE    UPDORDX             YES - EXIT                                   
         CLI   0(R1),0             END OF USED PORTION                          
         BE    UPDORD20                                                         
         LA    R1,1(,R1)           NEXT BYTE                                    
         BCT   RF,UPDORD10                                                      
*                                                                               
         DC    H'0'                DIE, IF DETAIL ORDER ELEMENT FULL            
*                                                                               
UPDORD20 STC   R0,0(R1)            ADD FIELD EQUATE                             
         IC    RF,1(R2)            UPDATE ELEMENT LENGTH                        
         AHI   RF,1                                                             
         STC   RF,1(R2)                                                         
*                                                                               
UPDORDX  J     EQXIT                                                            
         LTORG                                                                  
         DROP  R2                                                               
*                                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
* R1 EXPECTED TO ADDRESS THE RECORD                                             
* R0 EXPECTED TO HAVE THE COLUMN NUMBER                                         
* NOTE, THAT RECORD, FIELD DELIMITERS ARE HARD-CODED                            
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
FINDFLD  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CHI   R0,0                                                             
         BNH   FINDNQX                                                          
*                                                                               
         BCTR  R0,0                NUMBER OF SEMICOLONS, REALLY                 
         CHI   R0,0                                                             
         BE    FINDX                                                            
*                                                                               
         LH    R2,0(R1)            REC LEN                                      
         AR    R2,R1               R2 POINTS TO THE END OF RECORD               
         LA    R1,4(R1)            SKIP THE 4 REC LENGTH BYTES                  
*                                                                               
         CLC   =C'31',0(R1)        INV HEADER?                                  
         BNE   FIND20                                                           
* FOR INV HDR SKIP REC TYPE, DELIMITER, 12-BYTE SAVE FLD                        
         LA    R1,16(R1)                                                        
* DO NOT COUNT THE 12-BYTE FIELD'S SEMICOLON                                    
         SHI   R0,1                UPDATE FIELD COUNT                           
         CHI   R0,0                                                             
         BNH   FINDX                                                            
         B     FIND20                                                           
*                                                                               
FIND10   LA    R1,1(R1)                                                         
FIND20   CR    R1,R2               REACHED EOR?                                 
         BNL   FINDNQX                                                          
         CLI   0(R1),X'15'         EOR?                                         
         BE    FINDNQX                                                          
         CLI   0(R1),X'5E'         EOF? (FIELD DELIMITER = SEMICOLON)           
         BNE   FIND10                                                           
         BCT   R0,FIND10                                                        
*                                                                               
FINDX    LA    R1,1(R1)            ADVANCE TO THE FIRST CHAR OF THE FLD         
         CR    RB,RB               EXIT WITH EQUAL CONDITION CODE               
         XIT1  REGS=(R1)                                                        
FINDNQX  J     NEQXIT                                                           
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
***********************************************************************         
* BUILD INVOICE MANAGER ID ELEMENT                                              
***********************************************************************         
BLDIMID  NTR1  BASE=*,LABEL=*                                                   
         XC    SNVELEM,SNVELEM                                                  
         LA    R2,SNVELEM                                                       
         USING SNVIMIDD,R2                                                      
         MVI   SNVIMEL,SNVIMELQ                                                 
         MVI   SNVIMLEN,SNVIMLQ                                                 
*                                                                               
         MVC   SNVIMSTA,EZSNSTA                                                 
         MVC   SNVIMBND,EZSNBND                                                 
         MVC   SNVIMMED,EZSNMED                                                 
         MVC   SNVIMMOS,EZIHMON                                                 
         MVC   SNVIMINV,EZIHINV                                                 
         CLI   EZIHSVER,X'00'                                                   
         BE    BLDMEQX                                                          
         EDIT  EZIHSVER,SNVIMVER                                                
*                                                                               
BLDMEQX  DS    0H                                                               
         J     EQXIT                                                            
         LTORG                                                                  
         DROP  R2                                                               
*                                                                               
*                                                                               
*                                                                               
         TITLE 'EASI - ADD INVOICE TO FILES - EZADSD'                           
***********************************************************************         
*                                                                     *         
*        WORKAREAS                                                    *         
*                                                                     *         
***********************************************************************         
*                                                                               
EZADSD   DSECT                                                                  
SNVELEM  DS    XL256               ELEMENT WORKAREA                             
SNVCMELM DS    XL(SNVCMLNQ+1)      COMMERCIAL ELM WORKAREA                      
ERR      DS    XL1                                                              
         DS    0D                                                               
EZWORK   DS    CL16                                                             
SETCSVAD DS    CL12                AD-ID/COMML CODE WORK AREA                   
*                                                                               
*        MINIO ROUTINES WORKAREAS                                               
*                                                                               
MNPRMS   DS    6A                  PARAMETER BLOCK                              
*                                                                               
EZADSDL  EQU   *-EZADSD                                                         
*                                                                               
*                                                                               
       ++INCLUDE SPGENSNV                                                       
       ++INCLUDE SPGENAGY                                                       
       ++INCLUDE SPSNVFEQTB        FIELD EQUATE TABLE                           
       ++INCLUDE DDMINBLK                                                       
       ++INCLUDE EZBLOCK                                                        
*                                                                               
EZBLOCKD DSECT                                                                  
         ORG   EZWRKIOB                                                         
       ++INCLUDE DDWRKIOD                                                       
         ORG                                                                    
*                                                                               
* MID FLIGHT CLEARANCE INVOICES ARE USED ONLY AS AN EARLY AFFIDAVID             
* FOR SPOTS SHOWN SO THE AGENCY CAN RUN AN I2 INVOICE MATCHING REPORT           
*                                                                               
       ++INCLUDE DDACTIVD                                                       
       ++INCLUDE SPGENCLT                                                       
       ++INCLUDE REGENCON                                                       
       ++INCLUDE SPREPWORKD                                                     
       ++INCLUDE SPGENEZ                                                        
       ++INCLUDE DMWRKFD                                                        
       ++INCLUDE DMWRKFK                                                        
       ++INCLUDE DDCOMFACSD                                                     
       ++INCLUDE CTGENFILE                                                      
       ++INCLUDE DEDBLOCK                                                       
       ++INCLUDE SPEZDSCTS                                                      
       ++INCLUDE DDAGYALPH                                                      
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'146EZADDSNV  01/23/20'                                      
         END                                                                    
