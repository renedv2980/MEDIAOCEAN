*          DATA SET DEGETTP    AT LEVEL 097 AS OF 01/22/21                      
*PROCESS USING(WARN(15))           ENABLE ALL USING STATEMENT WARNINGS          
*CATALP DEGETTP                                                                 
         TITLE 'DEGETTP - TIME PERIOD FILE READ CONTROLLER'                     
***********************************************************************         
***********************************************************************         
*============================= UPDATE LOG ============================*         
*                                                                     *         
*  DATE   LVL USER DESCRIPTION                                        *         
* ------- --- ---- -------------------------------------------------- *         
* 04NOV29 213 BPOO FIX BOOKTYPE "P" AND "I" FOR MBK AND MSTA REQUESTS *         
* 04APR28 193 BPOO SUPPORT TP OVERNIGHT FILE                          *         
*                                                                     *         
* 98Apr22 037 GLEE Reset DBXTLIDX to zero for each new book           *         
*                                                                     *         
* 97Feb24  2  MAYA Re-leveled. Canadian (TCN) Dbbest='m' -> 4wks rtnd *         
*                                                                     *         
* 96Oct14 158 GLEE 1996 Summer Olympics stuff                         *         
*                                                                     *         
* 96Sep11 154 BZEH Force S1 to parent if not found. This corrects     *         
*                  A REP PROBLEM WHERE WE HAVE S1 PAV DATA BUT NOT    *         
*                  time period.                                       *         
*                                                                     *         
* 95Apr19 134 GLEE Use default booktype in translating alpha mkts     *         
*                                                                     *         
* 95Feb28 133 GLEE Test if spill passed in DBSELALF near GETTP30 code *         
*                                                                     *         
* 95Feb09 132 GLEE Use DBSELALF for spill mkt if it is set            *         
*                                                                     *         
* 95Jan30 131 ZEN  More sweep tables                                  *         
*         130 ZEN  Sweep tables                                       *         
*                                                                     *         
* 94Dec07 129 ZEN  Station under book need mkt# for Arbitron radio    *         
*                                                                     *         
* 94Dec01 128 GLEE New code for DBFUNCT=DBGETIPR                      *         
*                                                                     *         
* 94Nov28 127 GLEE Fixed bad code in SDQTABD exhausted (GIP350)       *         
*                                                                     *         
* 94Nov22 126 ZEN  Fixed DBACTSRC in ARBLIVE routine                  *         
*                                                                     *         
* 94Nov22 125 ZEN  Fixed DBACTSRC in ARBLIVE routine                  *         
*                                                                     *         
* 94Nov11 124 GLEE Ignore spill mkt (save space) for DBFUNCT=DBGETISR *         
*                                                                     *         
* 94Nov09 123 GLEE Get daypart data for condensed radio markets (i.e. *         
*                   switch to DBFILE=RDP when TPRCNDS=Y)              *         
*                                                                     *         
* 94Nov07 122 GLEE Fixed bug--forgot to clear the low key fields when *         
*                   reading demo records in GETIPTR code              *         
*             GLEE Replaced some DC H'0' w/ DBEROR=HORREND and exits  *         
*                                                                     *         
* 94Oct31 121 GLEE Code for radio overnight dayparts                  *         
*                                                                     *         
* 94Sep16 120 GLEE Code for DBFUNCT=DBGETIPR & DBGETISI               *         
*                                                                     *         
* 94Sep02 119 GLEE Get demographic data for requested program         *         
***********************************************************************         
         EJECT                                                                  
GETTP    RSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 TPLWORKQ,**GETTP,RA,R7,R4,RR=R2,CLEAR=YES,END=GETTP_X            
         LR    R9,RC                                                            
         USING TPLWORK,R9                                                       
         L     RC,0(R1)                                                         
         USING DEGETD,RC           RC=A(W/S)                                    
         USING COMFACSD,R8         R8=A(COMFACS)                                
         USING DBLOCKD,R6          R6=A(DBLOCK)                                 
         ST    R2,RELO3                                                         
                                                                                
*                                                                               
* IGNORE REQUESTS FOR DIGITAL TV STATIONS.                                      
NODIG    CLI   DBSELSRC,C'N'       NSI                                          
         BNE   NODIGX                                                           
         CLI   DBSELMED,C'T'       USTV                                         
         BE    *+8                  OR                                          
         CLI   DBSELMED,C'W'       WEEKLY                                       
         BE    *+8                  OR                                          
         CLI   DBSELMED,C'O'       OVERNIGHTS                                   
         BNE   NODIGX                                                           
         CLI   DBSELSTA+4,C'D'                                                  
         BNE   NODIGX                                                           
         MVI   DBERROR,NOTFOUND                                                 
         B     GETX                                                             
NODIGX   DS    0X                                                               
*                                                                               
*********MVC   CANWLAT,=AL2(JUL_05)                                             
         XC    CANMBK,CANMBK                                                    
** CANADIAN FORCE TO USE RATING SERVICE/STATION THAT'S GIVEN                    
         CLI   DBSELMED,C'C'                                                    
         BNE   CSCX                                                             
         MVI   DBUSEBBM,C'Y'       ALWAYS USE BBM METERED                       
         CLI   DBBEST,C'W'                                                      
         BE    *+8                                                              
         MVI   DBBEST,C'M'         AND WEEKLY                                   
*                                                                               
CSCX     DS    0C                                                               
* ************************************************                              
*                                                                               
         LARL  RE,SUBR01                                                        
         ST    RE,VSUBR01                                                       
         MVI   DIRERR,0            NEEDED FOR COUNTY COVERAGE                   
         XC    PREVMKT,PREVMKT                                                  
*                                                                               
* SEE IF WE ARE DOING SQAD                                                      
         CLI   DBSELMED,C'R'       FOR RADIO                                    
         BNE   SQTV                                                             
         CLI   DBBTYPE,C'S'                                                     
         BNE   *+8                                                              
         MVI   DBSELSRC,C'S'                                                    
         CLI   DBSELSRC,C'S'       ITS THE SOURCE                               
         BNE   SQX                                                              
         MVI   SQADACT,C'Y'                                                     
         MVI   DBBTYPE,C'S'                                                     
****     L     RE,DBEXTEND                                                      
         ICM   RE,15,DBEXTEND      CHECK FOR MULIPLE DAY/TIME                   
         CLC   0(3,RE),=C'UID'                                                  
         BNE   SQTV                                                             
         MVC   8(2,RE),=H'2'                                                    
*                                                                               
SQTV     CLI   DBSELMED,C'T'       FOR TV ITS THE BOOK TYPE                     
         BNE   SQX                                                              
         CLI   DBSELSRC,C'N'                                                    
         BNE   SQX                                                              
         CLI   DBBTYPE,C'R'        SQAD HISPANIC                                
         BE    *+8                                                              
         CLI   DBBTYPE,C'Q'        SQAD HISPANIC                                
         BE    *+8                                                              
         CLI   DBBTYPE,C'S'        SQAD REGULAR                                 
         BNE   SQX                                                              
         MVI   SQADACT,C'Y'                                                     
SQX      DS    0C                                                               
*                                                                               
         MVI   RDAYPART,C'N'       CHECK FOR RADIO DAYPART FILE                 
         CLC   DBFILE,=C'RDP'      ARB DAYPART                                  
         BE    RDAYPRT2                                                         
         OC    DBSELPRG,DBSELPRG   HAVE A DAYPART                               
         BZ    RDAYPRTX                                                         
         CLC   DBFILE,=C'RTP'      FOR RTP                                      
         BNE   RDAYPRTX                                                         
         CLI   DBSELSRC,C'R'       AND RADAR                                    
         BNE   *+8                                                              
RDAYPRT2 MVI   RDAYPART,C'Y'                                                    
*                                                                               
RDAYPRTX DS    0C                                                               
*                                                                               
         SAC   0                   MAKE SURE ALL IS CLEAN                       
         LAM   AR0,ARF,ARZERO                                                   
         BRAS  RE,INIT             PERFORM INITIALISATION                       
         MVC   SVALF,DBSELALF                                                   
         MVC   SVSELMK,DBSELMK                                                  
         MVC   SVSELBK,DBSELBK                                                  
         MVC   SVSELDAT,DBSELDAT                                                
*                                                                               
*&&DO                                                                           
*  WE ONLY HAVE LS BOOKTYPES POST JAN17 FOR FUSION                              
GETTP1T  CLI   DBSELSRC,C'F'                                                    
         BNE   *+18                                                             
         CLC   DBSELBK,=AL2(JAN_17)                                             
         BL    *+8                                                              
         MVI   DBBTYPE,BOOKTYPE_LS                                              
*                                                                               
         CLI   DBVOPT,X'40'         CHECK IF POSTING CALL                       
         BNE   GETTP1Z                                                          
*                                                                               
         CLI   DBSELMED,C'F'                                                    
         BE    *+8                                                              
         CLI   DBSELMED,C'T'        6AM 2 MIN AFFID RULE ONLY FOR               
         BNE   GETTP1V              USTV, OVERNIGHTS, FUSION                    
****     CLC   DBSELBK,=AL2(NOV_13)   NOV13- TEST DATA 3A START                 
         CLC   DBSELBK,=AL2(DEC_15)   THIS SHOULD BE DEC_15 IN PROD             
         BL    GETTP1Z                                                          
         B     GETTP1Y                                                          
*                                                                               
GETTP1V  CLI   DBSELMED,C'O'         OVERNGIHTS 2MIN SHOULD ONLY                
         BNE   GETTP1Z               BE FUTURE BOOKS                            
****     CLC   DBSELBK,=X'7328'    SEP2815 -JAN0116  FOR TESTING                
         CLC   DBSELBK,=X'7332'    DEC0715 EFFECTIVE START FOR 2MIN             
         BL    GETTP1Z                                                          
GETTP1Y  MVC   SVSELTIM,DBSELTIM                                                
*&&                                                                             
GETTP1Z  MVC   SVSELPRG,DBSELPRG   SAVE-RESET FOR CONDENSED RADIO MKTS          
         XC    TPSVTIM,TPSVTIM                                                  
         B     GETTP02                                                          
*                                                                               
RELO1    DC    A(*)                                                             
*                                                                               
GETTP02  CLI   DBFUNCT,DBGETIPR    READ PROGRAM (PASSIVE) RECORDS?              
         BE    GETIPTR              YEP!                                        
         CLI   DBFUNCT,DBGETISI    READ PROGRAM (PASSIVE) RECORDS?              
         BE    GETIPTR              YEP!                                        
         CLI   DBFUNCT,DBGETISR    READ PROGRAM (PASSIVE) RECORDS?              
         BE    GETIPTR              YEP!                                        
         BRAS  RE,INITG                                                         
         MVC   SVSELMK2,DBSELMK                                                 
                                                                                
         NI    DBEXTFLG,X'FF'-DYTM_YES                                          
         ICM   RE,15,DBEXTEND      CHECK FOR MULIPLE DAY/TIME                   
CHKDYTM  BZ    CHK5AM              NO MULTI D/T   - END IT                      
         USING DBXTLID,RE                                                       
         CLC   DBXTLID,=C'DYTM'    THIS IS THE ONE WE WANT                      
         BE    *+12                                                             
         ICM   RE,15,DBXTLNXT                                                   
         B     CHKDYTM                                                          
         OI    DBEXTFLG,DYTM_YES   SET DBEXTEND FLAG TO MULTI DAYTIME           
         MVC   DBSELDAY(5),DBXTLIST  SET FIRST DAY/TM                           
* ADDED ON 3/26/18 DUE TO TICKET...DBSELTIM WAS CLEARED FOR TOON/ADSM           
* ON SECOND STATION LOOKUP BECAUSE SVSELTM2 WAS NEVER SET                       
         MVC   SVSELTM2,DBSELTIM                                                
         MVI   DBXTLIDX,0                                                       
         DROP  RE                                                               
*                                                                               
CHK5AM   DS    0C                                                               
         BRAS  RE,CHK5AMR                                                       
*                                                                               
                                                                                
DYTMNO   DS    0C                                                               
         CLI   DBSELBK,X'FF'                                                    
         BNE   GETTP03                                                          
         MVC   DWLASTN,DBSELBK     SAVE LAST N PARAMETER                        
         XC    DBSELBK,DBSELBK     FORCE LATEST BOOK                            
         NI    DWLASTN+1,X'0F'                                                  
                                                                                
GETTP03  CLI   DBSELMED,C'R'       FOR RADIO,                                   
         BNE   *+20                                                             
         CLC   DBSELTIM+2(2),=H'500'   IF REQUESTED END TIME IS 5:00A           
         BNE   *+10                                                             
         MVC   DBSELTIM+2(2),=H'459'   FORCE IT TO 4:59A                        
                                                                                
         CLI   DBSELMED,C'O'       OVERNIGHT TP                                 
         BE    *+8                                                              
         CLI   DBSELMED,C'T'       FOR TV,                                      
         BNE   *+20                                                             
         CLC   DBSELTIM+2(2),=H'500'   IF REQUESTED END TIME IS 5:00A           
         BNE   *+10                                                             
         MVC   DBSELTIM+2(2),=H'459'   FORCE IT TO 4:59A                        
                                                                                
         XC    TPAQH1ST,TPAQH1ST                                                
         CLI   0(R1),0             TEST FIRST/NEXT TIME                         
         BNE   GETTP34                                                          
         MVI   DEMOFLAG,0                                                       
         GOTO1 AFIXSTA             DEAL WITH REUSED CALL LETTERS                
*                                                                               
GETTP1   ICM   RE,15,DBEXTEND         CHECK FOR MULTIPLE STATIONS               
GETTP1_0 LTR   RE,RE                                                            
         BZ    GETTP1A                                                          
         USING DBXMSD,RE                                                        
                                                                                
         CLC   DBXMSID,=C'MSTA'                                                 
         BE    *+12                                                             
         ICM   RE,15,DBXMSNXT                                                   
         B     GETTP1_0                                                         
         CLI   DBXMSTA,0           SOMEONE MUCKED UP                            
         BE    GETTP2              SURVIVE IT                                   
         MVC   DBSELSTA,DBXMSTA    INITIALIZE                                   
         MVI   MSTAFLG,MSTAMORE                                                 
         MVI   DBXMSIDX,0                                                       
*                                                                               
*                                                                               
* SAVE THE BOOKTYPE FOR PRECAUTION SO WE CAN APPLY IT FOR THE                   
* MULTI STATION LIST                                                            
         MVC   SVBTYPE,DBBTYPE                                                  
*                                                                               
GETTP1A  DS    0H                                                               
**       MVI   MERGEF,C'Y'                                                      
         BRAS  RE,CHCKTOON                                                      
*                                                                               
***GETTP1A  ICM   RE,15,DBEXTEND      CHECK FOR MULTIPLE BOOKS                  
         ICM   RE,15,DBEXTEND      CHECK FOR MULTIPLE BOOKS                     
         MVC   SVBTYPE,DBBTYPE                                                  
         NI    DBEXTFLG,X'FF'-MBK_YES                                           
         NI    DBEXTFLG,X'FF'-MBK_DONE                                          
         LTR   RE,RE                                                            
GETTP1C  BZ    GETTP1X                                                          
         USING DBXMBID,RE                                                       
         CLC   DBXMBID,=C'BKDT'                                                 
         BE    GETTP1G                                                          
         CLC   DBXMBID,=C'MBKS'                                                 
         BE    *+12                                                             
         ICM   RE,15,DBXMBNXT                                                   
         B     GETTP1C                                                          
         OI    DBEXTFLG,MBK_YES                                                 
         CLI   DBXMBKS,0           SOMEONE MUCKED UP                            
         BE    GETTP2               SURVIVE IT                                  
*                                                                               
         MVC   DBSELBK,DBXMBKS     INITIALIZE                                   
         MVI   DBXMBIDX,0                                                       
         MVC   SVSELBK,DBSELBK     RESET SAVE BK--MBK USERS, WATCH OUT!         
         B     GETTP1X                                                          
GETTP1G  DS    0H                                                               
         USING DBBDTMD,RE                                                       
         MVC   DBSELBK,DBBDTMS     INITIALIZE                                   
         MVC   DBSELDAY(L'DBSELDAY+L'DBSELTIM),DBBDTMS+2                        
         MVI   DBBDTIDX,0                                                       
         MVC   SVSELBK,DBSELBK                                                  
* MAKE SURE WE HAVE DBSELDAY SET..ELSE BYPASS                                   
GETTP1H  CLI   DBSELDAY,0         FOUND A GOOD STARTING LINK                    
         BNE   GETTP1X                                                          
         ZIC   RF,DBBDTIDX                                                      
         LA    RF,1(RF)                                                         
         STC   RF,DBBDTIDX                                                      
         MHI   RF,7                                                             
         LA    RF,DBBDTMS(RF)                                                   
         CLI   0(RF),0                                                          
         BE    GETX                END OF BOOK LIST -EXIT                       
         MVC   DBSELBK,0(RF)                                                    
         MVC   DBSELDAY(L'DBSELDAY+L'DBSELTIM),2(RF)                            
         MVC   SVSELBK,DBSELBK     RESET SAVE BK--MBK USERS, WATCH OUT!         
         B     GETTP1H                                                          
*                                                                               
GETTP1X  DS    0H                                                               
*                                                                               
         CLI   DBSELMED,C'C'                                                    
         BNE   GETTP2                                                           
         BRAS  RE,BBMMTR           PULL 4-WEEKS GIVEN A MONTH FOR BBM?          
* BBM WEEKLY--->MONTHLY READING                                                 
         CLI   DBSELSRC,C'A'       SOURCE = BBM?                                
         BNE   *+12                                                             
         CLI   DBBTYPE,C'W'        INDICATES BBM WEEKLY FILE                    
         BE    *+8                                                              
* CSI WEEKLY--->MONTHLY READING                                                 
         CLI   DBSELSRC,C'N'       SOURCE = NSI?                                
         BNE   GETTP2                                                           
*                                                                               
         CLI   DBBEST,C'M'                                                      
         BNE   GETTP2                                                           
*                                                                               
         BAS   RE,CAN4WK           FIND THE WEEKS USED FOR THE BOOK             
         CLI   CANSWK,0            IF =0 --> ERROR                              
         BNE   *+12                                                             
         MVI   DBERROR,1           BAD BOOK PASSED OR YY NOT IN TABLE           
         B     GETX                                                             
         MVC   DBSELBK+1(1),CANSWK  GET 1ST WEEK                                
*                                                                               
GETTP2   GOTO1 AGETBOOK            GET INITIAL BOOK VALUE                       
         BNE   GETX                EXIT ON ERROR                                
         BAS   RE,ARBLIVE          CHANGE SRC TO NSI (IF NECESSARY)             
*  CHECK IF CABLE STATION OR NOT                                                
         BRAS  RE,CHECKCAB                                                      
* look up nielsen true week ?                                                   
*&&DO                                                                           
         TM    DBVOPT,X'40'                                                     
         BZ    GETTP2D                                                          
         OC    DBSEL1WK,DBSEL1WK                                                
         BNZ   GETTP2D                                                          
*                                                                               
         OC    DBSELWKN,DBSELWKN                                                
         BZ    GETTP2H                                                          
GETTP2D  CLI   DBSELMED,C'T'                                                    
         BNE   GETTP2H                                                          
         CLI   DBSELSRC,C'N'                                                    
         BNE   GETTP2H                                                          
         MVI   DBINTMED,C'w'                                                    
GETTP2H  DS    0C                                                               
*&&                                                                             
*                                                                               
*                                                                               
         LA    R1,DBACTBK                                                       
         CLI   BKDTFLAG,C'Y'       ROLLING AVG ALWAYS RECHECK ACCESS            
         BE    GETTP2K                                                          
         OC    ACONHDR,ACONHDR     TEST IF A(CONTROL TABLE) SET                 
         BNZ   GETTP3                                                           
GETTP2K  GOTO1 AGETCTRL            NO - GET AGENCY CONTROLS                     
         CLI   DBBTYPE,0           TEST ACCESS FOR BOOK TYPE ALWAYS             
         BNE   *+12                                                             
         CLI   DBSELMED,C'R'       TEST ACCESS FOR RADIO ALWAYS                 
         BNE   GETTP3                                                           
         MVC   TPSAVE(1),DBFUNCT                                                
         MVI   DBFUNCT,DBTSTACS                                                 
         CLI   SQADACT,C'Y'        MAINTAIN SELMKT FOR SQUAD                    
         BNE   *+10                                                             
         MVC   DUBSV(2),DBSELMK                                                 
         GOTO1 ATSTACS                                                          
         MVC   DBFUNCT,TPSAVE                                                   
         CLI   SQADACT,C'Y'        MAINTAIN SELMKT FOR SQUAD                    
         BNE   *+10                                                             
         MVC   DBSELMK,DUBSV                                                    
         CLI   DBERROR,0                                                        
         BNE   GETX                                                             
GETTP3   OC    DBSELUMK,DBSELUMK   TEST IF USER MARKET NUMBER PASSED            
         BZ    GETTP14                                                          
         OC    ACONHDR+1(3),ACONHDR+1                                           
         BZ    GETTP14                                                          
         MVC   DBACTRMK,DBSELRMK                                                
*                                                                               
         L     R2,ACONHDR          R2=A(CONTROL TABLE)                          
         USING CONHDRD,R2                                                       
         LA    R3,CONHDRD+CONHDRLN                                              
         USING CONDTAD,R3                                                       
         LAM   AR0,ARF,ARZERO                                                   
         LAM   AR2,AR2,ALET                                                     
         CPYA  AR3,AR2                                                          
         SAC   512                                                              
*                                                                               
         LA    RE,3               USE RE,RF FOR BXLE INSTRUCTION                
         XR    RF,RF                                                            
         ICM   RF,7,CONAET                                                      
         CR    R3,RF                                                            
         BE    GETTP14                                                          
*                                  PROCESS VALID MARKET LIST                    
*                                                                               
GETTP4   CLI   CONINDIC,0                                                       
         BNE   GETTP6                                                           
         OC    DBACTRMK,DBACTRMK   ONLY IF MARKET KNOWN                         
         BZ    GETTP10                                                          
         OI    DEMOFLAG,X'80'                                                   
         CLC   DBACTRMK,CONMRKT                                                 
         BNE   *+8                                                              
         OI    DEMOFLAG,X'40'                                                   
         B     GETTP10                                                          
*                                  PROCESS INVALID MARKET LIST                  
GETTP6   CLI   CONINDIC,X'FF'                                                   
         BNE   GETTP8                                                           
         OC    DBACTRMK,DBACTRMK   ONLY IF MARKET KNOWN                         
         BZ    GETTP10                                                          
         OI    DEMOFLAG,X'20'                                                   
         CLC   DBACTRMK,CONMRKT                                                 
         BNE   *+8                                                              
         OI    DEMOFLAG,X'10'                                                   
         B     GETTP10                                                          
*                                  PROCESS SOURCE OVERRIDE LIST                 
GETTP8   CLC   DBSELUMK,CONMRKT                                                 
         BNE   GETTP10                                                          
         OI    DEMOFLAG,X'08'                                                   
         MVC   DUB(1),CONINDIC                                                  
         CLI   DUB,C'A'                                                         
         BNE   GETTP11                                                          
         CLI   DBACTBK,0                                                        
         BE    GETTP14                                                          
         CLI   DBACTBK,YR_1994                                                  
         BL    GETTP11                                                          
         NI    DEMOFLAG,X'F7'                                                   
         B     GETTP14             OVERRIDE SOURCE - ALL OTHER DATA             
*                                  IS N/A FOR CURRENT SOURCE                    
GETTP10  BXLE  R3,RE,GETTP4        USE RE,RF AS BXLE REGISTERS                  
         DROP  R3                                                               
*                                  TEST MARKET NUMBERS VALID                    
         TM    DEMOFLAG,X'C0'                                                   
         BM    GETTP12                                                          
         TM    DEMOFLAG,X'30'                                                   
         BO    GETTP12                                                          
*                                                                               
         TM    DEMOFLAG,X'08'      TEST SOURCE OVERRIDE PRESENT                 
         BZ    GETTP14                                                          
*                                                                               
GETTP11  TM    DEMOFLAG,X'01'      YES - HAVE I BEEN HERE BEFORE                
         BNZ   GETTP12                                                          
         MVI   DEMOFLAG,X'01'      NO - SET NEW SOURCE CODE & RETRY             
         SAC   0                                                                
         LAM   AR2,AR3,ARZERO                                                   
         XC    ACONHDR,ACONHDR                                                  
         XC    DBACTUAL,DBACTUAL                                                
         MVC   DBACTSRC,DUB                                                     
         MVC   DBACTMED,DBINTMED                                                
         B     GETTP2                                                           
*                                  ERROR EXIT                                   
GETTP12  SAC   0                                                                
         LAM   AR2,AR3,ARZERO                                                   
         MVI   DBERROR,INVMRKT                                                  
         B     GETX                                                             
*                                                                               
GETTP14  SAC   0                                                                
         LAM   AR2,AR3,ARZERO                                                   
*                                                                               
         CLI   DBFUNCT,DBGETTOT    TEST IF MARKET TOTALS REQUIRED               
         BE    *+12                                                             
         CLI   DBFUNCT,DBGETTTL    TEST SPECIAL SPDEMUP CALL                    
         BNE   GETTP15                                                          
*                                                                               
         CLI   DBSELSRC,C'F'        FUSION - TOTALS ARE STORED                  
         BNE   *+10                 IN HUT T RECORDS                            
         CLC   =C'HUT T',DBSELSTA                                               
         BNE   *+14                                                             
         MVC   DBACTSTA,DBSELSTA    JUST USE LATEST BOOK FOR HUT F              
         B     HUTTFUS                                                          
*                                                                               
         SR    R1,R1               YES - SET STATION TO NNNNT                   
         ICM   R1,3,DBACTRMK                                                    
         LTR   R1,R1                                                            
         BNZ   *+8                                                              
         ICM   R1,3,DBSELRMK                                                    
         CVD   R1,DUB                                                           
         UNPK  DBACTSTA(4),DUB                                                  
         OI    DBACTSTA+3,X'F0'                                                 
         CLI   DBSELSRC,C'C'       DONT OVERRIDE D BAND FOR NCM                 
         BE    *+12                                                             
         MVI   DBACTSTA+4,C'T'                                                  
         MVI   DBSELSTA+4,C'T'     DISALLOW SATELLITES                          
HUTTFUS  DS    0H                                                               
         LA    R1,1                                                             
         CLI   SQADACT,C'Y'        SQAD IS OK                                   
         BE    *+14                                                             
         CLC   DBACTBK,=AL2(SEP_01) BOOKS AFTER OCT/01                          
         BH    GETTP14A            GET IND. DAY HUTS/PUTS                       
         CLI   DBFUNCT,DBGETTTL    TEST SPDEMUP MKT TOTALS                      
         BNE   *+6                                                              
         SR    R1,R1               YES-FORCE STATION TABLE USE                  
GETTP14A CLI   DBSELMED,C'R'       FORCE AN 'R' FOR RADIO MARKETS               
         BNE   *+8                                                              
         MVI   DBACTSTA+4,C'R'                                                  
         CLI   DBSELMED,C'O'       OVERNIGHT TP                                 
         BE    *+8                                                              
         CLI   DBSELMED,C'T'       FOR USTV,                                    
         BNE   GETTP14G                                                         
         CLI   DBSELSRC,C'N'        AND SOURCE = NSI,                           
         BNE   GETTP14G                                                         
** FEB04/2000 (GLEE) - THE GETDQ ROUTINE HAS BEEN CHANGED SO THAT IT            
**   IS ABLE TO BREAK OUT THE DAYS/QHS CORRECTLY FOR  USTV NIELSEN,             
**   IRRESPECTIVE OF BOOK.  ONE IMPORTANT THING TO REMEMBER IS THAT             
**   IF THE END TIME IS PAST 2AM, FOR WHICH THERE IS NO DATA FOR BOOKS          
**   PRIOR TO  NOV/99, THE POST-2AM QHS ARE STILL BUILT INTO THE                
**   DAYS/QHS ENTRIES--EVEN FOR BOOKS PRIOR TO  NOV/99.  I HOPE THIS            
**   WILL NOT PRESENT A PROBLEM FOR US.                                         
         LA    R1,1(R1)               USE THE FULL TIMES FOR 2A-6A DATA         
         CLI   SQADACT,C'Y'           SQAD IS OK                                
         BE    GETTP14E                                                         
         CLI   DBSELSRC,C'C'          FOR NCM WE ARE NOT PRODUCING              
         BE    *+12                   M-F AVERAGES                              
         CLI   DBSELDAY,X'7C'         M-F                                       
         BE    GETTP14E               USE PREV TABLE                            
         CLC   DBACTBK,=AL2(SEP_01)   AND BOOKS AFTER OCT/01                    
         BNH   *+8                                                              
         LA    R1,1(R1)               USE THE FULL TIMES FOR ALL DAYS           
GETTP14E BAS   RE,SETDQLNK                                                      
GETTP14G EQU   *                                                                
         CLI   RDAYPART,C'Y'       RADIO DAYPART                                
         BNE   *+18                                                             
         OC    DBSELPRG,DBSELPRG   AND DAYPART CODE GIVEN                       
         BZ    *+8                                                              
         LA    R1,X'80'(R1)        DON'T ALLOW EXPLOSION                        
         CLI   DBSELSRC,C'F'       FUSION                                       
         BE    *+8                                                              
         CLI   DBSELMED,C'O'       OVERNIGHT TP                                 
         BNE   GETTP14H                                                         
         LA    R1,0                                                             
GETTP14H CLI   DBSELMED,C'O'       OVERNIGHT TP                                 
         BNE   GETTP14I                                                         
***      CLC   DBACTBK,=X'7328'    SEP2815 FOR TESTING AS 1ST 3A BOOK           
* ALLOWING THEM TO CROSS STARTING MONDAY NOV3015 WEEK EVEN THOUGH               
* WE WONT HAVE TRUE 3A TILL THURSDAY DEC0315                                    
*                                                                               
         CLC   DBACTBK,=AL1(YR_2015,WEEK_49)                                    
         BL    GETTP14V                                                         
         B     GETTP14K                                                         
GETTP14I DS    0C                                                               
* USE 3A DQTAB - NOV13 AND FORWARD FOR TESTING PURPOSES                         
         CLI   DBSELSRC,C'V'                                                    
         BE    GETTP14K                                                         
         CLI   DBSELMED,C'T'                                                    
         BNE   GETTP14V                                                         
****     CLC   DBACTBK,=AL2(NOV_13)                                             
         CLC   DBACTBK,=AL2(DEC_15)  EFFECTIVE 3AM BOOK                         
         BL    GETTP14V                                                         
GETTP14K CHI   R1,2                                                             
         BNE   GETTP14V                                                         
         LA    R1,4                                                             
*                                                                               
GETTP14V GOTO1 AGETDQ              BUILD LIST OF DAYS/QTR HOURS                 
         BNE   GETX                                                             
         XC    DBACTKMK,DBACTKMK                                                
         MVC   BOOKTYPE,DBBTYPE    SET FOR SPECIAL SURVEYS                      
         B     GETTP16                                                          
*                                                                               
GETTP15  DS    0C                                                               
*                                                                               
         CLI   SQADACT,C'Y'             SQAD CHECKING                           
         BNE   GETSQX                                                           
         OC    DBSELMK,DBSELMK                                                  
         BZ    GETSQX                                                           
         LARL  RE,SQADTAB          SQAD TV DAYPARTS                             
         CLI   DBBTYPE,C'R'                                                     
         BNE   *+10                                                             
         LARL  RE,SQADTABH         SQAD HISP TV DAYPARTS                        
         CLI   DBSELMED,C'R'                                                    
         BNE   *+10                                                             
         LARL  RE,SQADTABR         SQAD RADIO DAYPARTS                          
GETSQ02  CLC   DBSELTIM(2),0(RE)                                                
         BE    GETSQ04                                                          
         CLI   0(RE),X'FF'         NOT IN TABLE ASSUME DAY/TIME                 
         BE    GETSQX               IS PASSED BY APP.                           
         LA    RE,5(RE)                                                         
         B     GETSQ02                                                          
GETSQ04  MVC   DBSELDAY,2(RE)                                                   
         MVC   DBSELTIM(2),3(RE)                                                
GETSQX   DS    0C                                                               
*                                                                               
         OC    DBSELTIM+2(2),DBSELTIM+2 TEST FOR BREAK TIME                     
         BNZ   GETTP15A            NO                                           
         CLC   DBSELTIM(2),=H'558' TEST 558A OR 559A                            
         BL    GETTP15A            NO                                           
         CLC   DBSELTIM(2),=H'600' IF YES, FORCE TO 600A                        
         BH    GETTP15A            GETDQ HAS BUG IN HANDLING 545A QHR           
         MVC   DBSELTIM(2),=H'600'                                              
*                                                                               
GETTP15A SR    R1,R1                                                            
         CLI   RDAYPART,C'Y'       RADIO DAYPART                                
         BNE   *+18                                                             
         OC    DBSELPRG,DBSELPRG   AND DAYPART CODE GIVEN                       
         BZ    *+8                                                              
         LA    R1,X'80'(R1)        DON'T ALLOW EXPLOSION                        
                                                                                
         CLI   DBDAYOPT,C'Y'       OPTION FOR NO INDIVIDUAL DAYS                
         BNE   *+12                                                             
         LA    R1,1(R1)                                                         
         B     GETTP15D                                                         
*                                                                               
         CLI   DBSELMED,C'W'       WEEKLY                                       
         BNE   *+12                                                             
         CLI   DBSELSRC,C'N'       NSI                                          
         BE    *+8                 OR                                           
         CLI   DBSELMED,C'O'       OVERNIGHTS                                   
         BE    *+8                 OR                                           
         CLI   DBSELMED,C'T'       USTV                                         
         BE    *+12                OR                                           
         CLI   DBSELMED,C'U'       COUNTY COVERAGE                              
         BNE   GETTP15C                                                         
         CLI   DBSELSRC,C'S'       NOT FOR SRC                                  
         BE    GETTP15D                                                         
         CLI   DBSELBK,0           EARLY FOR ALL LATEST BOOKS                   
         BE    *+14                                                             
         CLC   DBSELBK,=AL2(MAR_92) USE EARLY START AFTER FEB/92                
         BL    GETTP15D            FOR INDIVIDUAL DAYS                          
         LA    R1,1(R1)                                                         
                                                                                
         DS    0H                 THE INCREMENT BELOW NOT FOR WEEKLY            
         CLI   DBSELMED,C'W'       WEEKLY                                       
         BE    GETTP15E                                                         
** FEB04/2000 (GLEE) - (SEE COMMENT FROM FIRST CALL TO  GETDQ)                  
         LA    R1,1(R1)                                                         
         CLI   SQADACT,C'Y'        SQAD IS OK                                   
         BE    GETTP15B                                                         
         CLI   DBSELSRC,C'C'          FOR NCM WE ARE NOT PRODUCING              
         BE    *+12                   M-F AVERAGES                              
         CLI   DBSELDAY,X'7C'      M-F                                          
         BE    GETTP15B            USE PREV TABLE                               
         CLI   DBSELBK,0           LATEST IS AFTER OCT/01 ALWAYS                
         BE    *+14                                                             
         CLC   DBSELBK,=AL2(SEP_01) USE FULL TIMES AFTER OCT/01                 
         BNH   *+8                 HAVE INDIVIDUAL DAY DATA                     
         LA    R1,1(R1)                                                         
GETTP15B BAS   RE,SETDQLNK                                                      
         B     GETTP15D                                                         
*                                                                               
GETTP15C CLI   DBSELMED,C'C'       CANTV                                        
         BNE   GETTP15D                                                         
*&&DO                                                                           
         CLI   DBSELBK,0           EARLY FOR ALL LATEST BOOKS                   
         BE    *+14                                                             
         CLC   DBSELBK,=AL2(JUN_92) USE EARLY START AFTER MAY/92                
         BL    GETTP15D            FOR INDIVIDUAL DAYS                          
*&&                                                                             
         LA    R1,1(R1)                                                         
         CLI   DBSELSRC,C'A'                                                    
         BNE   GETTP15D                                                         
         CLI   DBBTYPE,C'W'                                                     
         BE    GETTP15D                                                         
         CLI   DBSELBK,0           EARLY FOR ALL LATEST BOOKS                   
         BE    *+14                                                             
         CLC   DBSELBK,=AL2(NOV_04) USE INDIVIDUAL DAYS NOV/04                  
         BL    GETTP15D            AND SUBSEQUENT                               
         LA    R1,1(R1)                                                         
         J     GETTP15G                                                         
*                                                                               
GETTP15D J     GETTP15G                                                         
*                                                                               
*                                  WEEKLY GET 2A-6A + INDIVIDUAL                
GETTP15E CLC   DBSELBK,=AL1(YR_2002,WEEK_45)                                    
         BL    GETTP15G              AFTER THIS                                 
         CLI   DBSELSRC,C'C'          FOR NCM WE ARE NOT PRODUCING              
         BE    *+12                   M-F AVERAGES                              
         CLI   DBSELDAY,X'7C'      M-F                                          
         BE    GETTP15G            USE PREV TABLE                               
         LA    R1,3                                                             
*                                                                               
GETTP15G DS    0H                  3a start time use table4                     
*                                                                               
* SPECIAL SU-SA CHECK FOR COUNTY COVERAGE                                       
         CLI   DBSELMED,C'U'                                                    
         BNE   *+16                                                             
         CLI   DBSELDAY,X'90'                                                   
         BNE   *+8                                                              
         LA    R1,4                                                             
*                                                                               
         CLI   DBSELSRC,C'F'       FUSION                                       
         BE    *+8                                                              
         CLI   DBSELMED,C'O'       OVERNIGHT TP                                 
         BNE   *+8                                                              
         LA    R1,0                                                             
*                                                                               
****     CLC   DBACTBK,=AL2(NOV_13)                                             
         CLC   DBACTBK,=AL2(DEC_15) EFFECTIVE 3AM BOOK                          
         BL    GETTP15V                                                         
*                                                                               
         CLI   DBSELMED,C'O'       OVERNIGHT TP                                 
         BNE   GETTP15J                                                         
***      CLC   DBACTBK,=X'7328'    SEP2815 FOR TESTING AS 1ST 3A BOOK           
*                                  NOV3015 FIRST 3AM WEEK EVEN THOUGH           
*                                  3AM STARTS ON THURSDAY                       
         CLC   DBACTBK,=AL1(YR_2015,WEEK_49)                                    
         BL    GETTP15V                                                         
*                                                                               
GETTP15J DS    0H                                                               
****     CLI   DBSELSRC,C'V'       VIDEOLOGY                                    
****     BE    GETTP15X                                                         
         CLI   DBSELMED,C'T'                                                    
         BNE   GETTP15V                                                         
GETTP15X CHI   R1,2                                                             
         BNE   GETTP15V                                                         
         LA    R1,4                3A DQTAB                                     
GETTP15V GOTO1 AGETDQ              BUILD LIST OF DAYS/QTR HOURS                 
         BNE   GETX                                                             
         OC    DBACTKMK,DBACTKMK   SET SPILL MARKET NUMBER                      
         BNZ   GETTP16                                                          
         MVC   DBACTKMK,DBSELMK                                                 
         OC    DBSELALF,DBSELALF   IF DBSELALF IS NOT NULLS                     
         BZ    GETTP16                                                          
         CLC   DBSELALF,=3C' '      AND IT'S NOT BLANKS,                        
         BE    GETTP16                                                          
         MVC   DUB(3),DBSELALF      THEN USE IT                                 
****     BAS   RE,TRAMKT           TRANSLATE ALPHAMKT TO NUMERIC MKT            
         BRAS  RE,TRAMKT           TRANSLATE ALPHAMKT TO NUMERIC MKT            
         MVC   DBACTKMK,DUB+3      DUB+3(2) = NUMERIC MARKET                    
         CLI   SQADACT,C'Y'        SQAD IS DIFFERENT                            
         BE    *+10                                                             
         MVC   DBSELMK,DBACTKMK                                                 
*                                                                               
         OC    DBACTKMK,DBACTKMK                                                
         BNZ   GETTP16                                                          
         MVI   DBERROR,NOTFOUND                                                 
         B     GETX                                                             
                                                                                
*                                  DETERMINE LATEST BOOK FIRST                  
GETTP16  CLC   DBSELSTA,=C'KMPHL'  SPECIAL LOW POWER EQUIV.                     
         BNE   *+10                                                             
         MVC   DBACTSTA,=C'KM58T'                                               
* FOR RADIO ALWAYS VERIFY THE ETHNIC MARKET NUMBER IS CORRECT                   
* BECAUSE SOME CALLERS ALWAYS PASS THE STANDARD MARKET NUMBER                   
* ONLY DO THIS WHEN ALPHA MARKET IS NOT PASSED IN.                              
         CLI   DBSELMED,C'R'                                                    
         BNE   GETTP16A                                                         
         OC    DBSELALF,DBSELALF                                                
         BNZ   GETTP16A                                                         
         OC    DBSELMK,DBSELMK                                                  
         BZ    GETTP16A                                                         
         BRAS   RE,CHKRNMKT                                                     
*                                                                               
*                                                                               
GETTP16A DS    0C                                                               
         BRAS  RE,LOCCABLK         PERFORM INITIALISATION                       
                                                                                
*&&DO                                                                           
         CLC   DBSELSTA,=C'WB16T'  SPECIAL SHIT FOR THIS STATION                
         BNE   WB16OK                                                           
         MVC   DBACTSTA,=C'WB16T'                                               
         OC    DBSELBK,DBSELBK                                                  
         BZ    GETTP17                                                          
         CLC   DBSELBK,=X'6500'                                                 
         BH    GETTP17                                                          
         MVC   DBACTSTA,=C'WB26T'                                               
         MVC   DBSELSTA,=C'WB26T'                                               
         B     GETTP17                                                          
*&&                                                                             
WB16OK   DS    0C                                                               
*&&DO                                                                           
         CLC   DBSELSTA,=C'WPTPF'  SPECIAL SHIT FOR THIS STATION                
         JNE   WPTPOK              TRIPLE CHANGE                                
         CLC   DBSELBK,=AL2(FEB_04) WPTPF->WLDWF->WRDWF                         
         JL    WPTPOK                                                           
         MVC   DBACTSTA,=C'WRDWF'                                               
         MVC   DBSELSTA,=C'WRDWF'                                               
         J     GETTP17                                                          
*&&                                                                             
WPTPOK   DS    0C                                                               
*&&DO                                                                           
         CLC   DBSELSTA,=C'WRDWF'  SPECIAL SHIT FOR THIS STATION                
         JNE   WRDWOK              TRIPLE CHANGE                                
         CLC   DBSELBK,=AL2(JUL_03) WPTPF->WLDWF->WRDWF                         
         JH    WRDWOK                                                           
         MVC   DBACTSTA,=C'WPTPF'                                               
         MVC   DBSELSTA,=C'WPTPF'                                               
         J     GETTP17                                                          
*&&                                                                             
WRDWOK   DS    0C                                                               
*                                                                               
         CLI   STALFLAG,C'Y'       IF STATION ALREADY LINKED                    
         BE    LINKED              THEN DONT DO IT AGAIN                        
***      BRAS  RE,STALINK                                                       
         GOTOR STALINK,DMCB,(X'00',SAVEBOOK),DBACTSTA                           
LINKED   DS    0H                                                               
*                                                                               
         MVI   LPMBTYP,0                                                        
         OC    DBSELBK,DBSELBK     TEST LATEST BOOK REQUESTED                   
         BNZ   GETTP21             NO                                           
*                                                                               
* HANDLE LATEST FOR PRELIMINARY LPM - SPOT PASSES P LONG AFTER IT'S DEAD        
                                                                                
         CLI   DBBTYPE,C'P'        PRELIM                                       
         JNE   LPMBTYPX                                                         
         CLI   DBINTMED,C'T'        FOR USTV                                    
         JNE   LPMBTYPX                                                         
         CLI   DBACTSRC,C'F'          FUSION - SOMETIMES SPOT PASSES P          
         JE    *+8                    OFR FUSION TOO- TAKE IT OUT               
         CLI   DBACTSRC,C'N'          NSI                                       
         JNE   LPMBTYPX                                                         
         MVC   LPMBTYP,DBBTYPE     SAVE LPM BOOKTYPE                            
         MVI   DBBTYPE,0           AND USE BASE FOR LATEST                      
LPMBTYPX DS    0C                                                               
*                                                                               
         CLI   DBSELSTA+4,C'L'     DON'T KILL THE PREV EQUATE                   
         BE    GETTP17                                                          
* COMPARE TO SEE IF WE ARE PROCESSING A STATION LINKED VIA                      
* CALL_LINK TABLE IN DEMTABS                                                    
         CLI   STALFLAG,C'Y'       STATION LINKED IN DEMTABS TABLE?             
         BNE   GETTP16B                                                         
         CLI   DBSELMED,C'O'       OVERNIGHT AND WEEKLY ALWAYS                  
         BE    GETTP17             STARTS WITH LAST ENTRY IN DEMTABS            
         CLI   DBSELMED,C'W'       TABLE- NO NEED TO CALL LATEQV                
         BE    GETTP17                                                          
         CLC   DBACTSTA,DBSELSTA   IF EQV, DOES DBSELSTA HAVE LATER BK          
         BE    *+8                                                              
         BAS   RE,LATEQV                                                        
         B     GETTP17                                                          
*                                                                               
GETTP16B XC    DUB(5),DUB                                                       
                                                                                
         MVI   DUB+5,1             GET LATEST CALL LETTERS (OLD-NEW)            
         GOTO1 AGETEQIV            BEFORE ANY READING                           
         ZIC   R1,CALLEN                                                        
         MVC   DBACTSTA,DUB                                                     
         LA    R1,DBACTSTA(R1)     READ ONLY ON PARENT TO                       
         CLC   DBACTSTA,DBSELSTA   IF EQV, DOES DBSELSTA HAVE LATER BK          
         BE    *+8                                                              
         BAS   RE,LATEQV                                                        
*                                                                               
         CLI   DBSELSRC,C'C'       NCM DONT OVERRIDE THE BAND                   
         BE    *+8                                                              
         CLI   DBSELMED,C'R'       DON'T FORCE FOR RADIO                        
         BE    *+8                                                              
         MVI   0(R1),C'T'          FIND LATEST BOOK                             
*                                                                               
GETTP17  MVC   SAVEBOOK,DBACTBK    SET INITIAL BOOK VALUE                       
*                                                                               
*        CLI   DBACTSRC,C'A'       BBM CANADIAN                                 
*        BNE   R2AN4FIX                                                         
*        CLI   DBINTMED,C'C'                                                    
*        BNE   R2AN4FIX                                                         
*        CLI   SAVEBOOK,X'FF'                                                   
*        BE    *+14                                                             
*        CLC   SAVEBOOK,=AL2(NOV_04) DISABLE NOV/04 AS LATEST                   
*        BL    *+10                                                             
*        MVC   SAVEBOOK,=X'680A'                                                
*2AN4FIX DS    0C                                                               
*                                                                               
         XC    SAVEBOOK,EFFS                                                    
*                                                                               
GETTP18  LA    R2,DBKEY            BUILD KEY OF DEMO RECORD                     
         USING DRKEY,R2            R2=A(KEY)                                    
         CLI   DBSELSRC,C'F'                                                    
         BNE   *+10                FUSION TOTALS ARE IN THE HUT T               
         CLC   =C'HUT T',DBSELSTA                                               
         BNE   *+10                                                             
         MVC   DBACTSTA,DBSELSTA                                                
*                                                                               
         XC    DRKMAJOR,DRKMAJOR                                                
*                                                                               
         CLC   DBFILE,=C'RTP'      bpoo  6/29/00                                
         BNE   *+8                                                              
         MVI   RECCODE,C'D'                                                     
*                                                                               
* latest fusion book lookup should default to booktype LS.                      
* if we dont set booktype to LS the latest book lookup will be done             
* against live standard booktype returning historial old fusion book            
         CLI   DBACTSRC,C'F'                                                    
         JNE   GETTP18A                                                         
         OC    DBSELBK,DBSELBK                                                  
         BNZ   GETTP18A                                                         
         CLI   DBBTYPE,0                                                        
         BNE   *+8                                                              
         MVI   DBBTYPE,BOOKTYPE_LS                                              
GETTP18A DS    0H                                                               
*                                                                               
*                                                                               
         MVC   DRCODE,RECCODE                                                   
         MVC   DRMEDIA,DBINTMED                                                 
         MVC   DRSRC,DBACTSRC                                                   
         MVC   DRSTAT,DBACTSTA     READ FOR PARENT STATION/BOOK                 
         MVC   DRBOOK,SAVEBOOK     HOME MARKET/REGULAR SURVEY                   
         MVC   DRBTYP,DBBTYPE      REQUESTED BTYP IF THERE                      
*&&DO                                                                           
* TRUE NIELSEN WEEK                                                             
         TM    DBVOPT,X'40'                                                     
         BZ    GETTP18A                                                         
         TM    DBNPMFLG,DBTRUEWK                                                
         BNO   GETTP18A                                                         
         OC    DBSEL1WK,DBSEL1WK                                                
         BNZ   YESWEEK                                                          
GETTP18A OC    DBSELWKN,DBSELWKN                                                
         BZ    NOTWKLY                                                          
YESWEEK  CLI   DBSELMED,C'T'                                                    
         BNE   NOTWKLY                                                          
         CLI   DBSELSRC,C'N'                                                    
         BNE   NOTWKLY                                                          
         MVI   DRHOME,C'w'                                                      
*&&                                                                             
NOTWKLY  CLI   SQADACT,C'Y'                                                     
         BE    *+20                                                             
         OC    DBSELALF,DBSELALF  I BELIEVE THE FOLLOWING SIX INSTR.            
         BZ    *+10               ARE NOT NECESSARY - BETTER TO BE SAFE         
         MVC   DRKMKT,DBSELMK                                                   
*                                                                               
*FOR CABLE FUSION SET THE SPILL MKT TOO                                         
*                                                                               
*                                                                               
*                                                                               
         CLI   DBSELMED,C'T'                                                    
         BNE   *+8                                                              
         CLI   DBBTYPE,C'W'                                                     
         BE    *+8                                                              
         CLI   DBBTYPE,C'4'                                                     
         BE    *+8                                                              
         CLI   DBBTYPE,C'C'                                                     
         BE    *+8                                                              
         CLI   DBBTYPE,C'3'                                                     
         BE    *+8                                                              
         CLI   DBSELSRC,C'F'                                                    
         BE    *+10                                                             
         CLC   =C'RRA',DRCODE       ARBITRON TP RECORDS                         
         BE    *+10                                                             
         CLC   =C'RRT',DRCODE       TRITON TP RECORDS                           
         BNE   *+10                                                             
         MVC   DRKMKT,DBSELMK                                                   
*                                                                               
* INCLUDE MARKET FOR CSI ANGLO FRANCO MARKETS                                   
         CLC   DRCODE(3),=C'RCA'   BBM CANADIAN                                 
         BNE   GETTP18C                                                         
         CLC   DBSELMK,=H'5071'                                                 
         BE    *+10                                                             
         CLC   DBSELMK,=H'5072'                                                 
         BE    *+10                                                             
         CLC   DBSELMK,=H'4480'                                                 
         BE    *+10                                                             
         CLC   DBSELMK,=H'4481'                                                 
         BE    *+10                                                             
         CLC   DBSELSTA(4),=C'CIII' SPECIAL NETWORKS                            
         BE    *+10                                                             
         CLC   DBSELSTA(4),=C'CHIF'                                             
         BE    *+10                                                             
         CLC   DBSELSTA(4),=C'ASN '                                             
         BE    *+10                                                             
         CLC   DBSELSTA(4),=C'TSN '                                             
         BNE   GETTP18D                                                         
         MVC   DRKMKT,DBSELMK                                                   
* INCLUDE MARKET FOR CSI ANGLO FRANCO MARKETS                                   
GETTP18C CLC   DRCODE(3),=C'RCN'   NSI CANADIAN                                 
         BNE   GETTP18D                                                         
         CLC   DBSELMK,=H'414'     MONTREAL ANGLO                               
         BE    *+10                                                             
         CLC   DBSELMK,=H'415'     MONTREAL FRANCO                              
         BE    *+10                                                             
         CLC   DBSELMK,=H'416'     OTTAWA ANGLO                                 
         BE    *+10                                                             
         CLC   DBSELMK,=H'478'     OTTAWA FRANCO                                
         BE    *+8                                                              
         B     GETTP18D                                                         
         MVC   DRKMKT,DBSELMK                                                   
*                                                                               
GETTP18D MVI   IOFLAG,DEM+HIGH+DIR                                              
         MVC   DUB(2),DRKMKT                                                    
*                                                                               
GETTP18E GOTO1 AIO,IOFLAG                                                       
         BL    GETX                                                             
*                                                                               
         CLC   DRKEY(DRBOOK-DRKEY),KEYSAVE TEST SAME STATION                    
         BNE   GETTP19             NO-TRY EQUIVALENCING                         
*                                                                               
         CLC   DRBTYP,DBBTYPE                                                   
         BE    GETTP18M                                                         
                                                                                
GETTP18F CLI   DRMEDIA,C'T'        BOOKTYPE MISMATCH                            
         BNE   GETTP18H            CHECK BOOKTYPE P AND I                       
         CLI   DRSRC,C'N'          IF NOT FOUND TRY 0 AND H                     
         BNE   GETTP18H                                                         
         CLI   DBBTYPE,C'P'                                                     
         BNE   *+12                                                             
         MVI   DBBTYPE,0                                                        
         B     GETTP18                                                          
         CLI   DBBTYPE,C'I'                                                     
         BNE   *+12                                                             
         MVI   DBBTYPE,C'H'                                                     
         B     GETTP18                                                          
GETTP18H CLI   DRMEDIA,C'O'        BOOKTYPE MISMATCH                            
         BNE   GETTP18T                                                         
         CLI   DRSRC,C'N'                                                       
         BNE   GETTP18T                                                         
*                                                                               
         CLI   CABLEFLG,C'Y'       ONLY VALID SWITCH                            
         BNE   *+8                 FOR CABLE STATIONS SINCE THIS                
         CLI   DBBTYPE,C'C'        BOOKTYPE ONLY HAS CABEL STATIONS             
         BNE   *+12                                                             
         MVI   DBBTYPE,C'U'                                                     
         B     GETTP18                                                          
*                                                                               
         CLI   DBBTYPE,C'W'                                                     
         BNE   *+12                                                             
         MVI   DBBTYPE,C'Z'                                                     
         B     GETTP18                                                          
*                                                                               
         CLI   DBBTYPE,C'H'                                                     
         BNE   *+12                                                             
         MVI   DBBTYPE,C'J'                                                     
         B     GETTP18                                                          
*                                                                               
         CLI   CABLEFLG,C'N'         ONLY VALID FOR BROADCAST                   
         BNE   GETTP18M              STATIONS SINCE BOOKTYPE                    
         CLI   DBBTYPE,0             L ONLY HAS BROADCAST STATIONS              
         BNE   GETTP18M                                                         
         MVI   DBBTYPE,C'L'                                                     
         B     GETTP18                                                          
*                                                                               
GETTP18M CLC   DRKMKT,DUB                                                       
         BE    GETTP20                                                          
*        OC    DRKMKT(DRBTYP-DRKMKT),DRKMKT USE ONLY HOME MARKET                
*        BZ    GETTP20                      FOR LATEST BOOK                     
*                                                                               
GETTP18T CLC   DRBOOK,SAVEBOOK     FOUND BOOK I LOOKED FOR                      
         BE    *+14                 YES - TRY NEXT BOOK                         
         MVC   SAVEBOOK,DRBOOK     NO - LOOK FOR FOUND BK/BTYP                  
         B     GETTP18                                                          
*                                                                               
         SR    R1,R1               FOUND SPILL MARKET OR SPECIAL SURVEY         
         ICM   R1,3,DRBOOK         INCREMENT ITS BOOK TO READ                   
         CLM   R1,3,=X'FFFE'       (PROTECT OURSELVES FROM                      
         BNL   GETTP19              BAD BOOK FIELDS IN KEY)                     
         LA    R1,1(R1)            FORWARD FOR A PREVIOUS BOOK                  
         STCM  R1,3,SAVEBOOK                                                    
         B     GETTP18                                                          
*                                  NOTHING ON STATION-TRY EQUIVALENCING         
* IF STATION PART OF STATION LINK TABLE IN DEMTABS                              
* SEE IF WE NEED TO READ BACKWARDS IN STATLINK DEMTABS TABLE                    
*                                                                               
GETTP19  CLI   STALFLAG,C'Y'                                                    
         BNE   GETTP19F                                                         
         CLI   DBSELMED,C'W'                                                    
         BE    *+8                                                              
         CLI   DBSELMED,C'O'                                                    
         BNE   GETTP19F                                                         
         GOTOR STALINK,DMCB,(X'01',SAVEBOOK),DBACTSTA                           
         CLC   =X'FFFF',DMCB+8     NO MORE STATIONS IN TABLE                    
         BE    GETTP19F            DONT READ                                    
         MVC   DBSELSTA,DBACTSTA                                                
         B     GETTP17                                                          
*                                                                               
GETTP19F TM    DEMOFLAG,X'04'      TEST IF ALREADY EQUIVALENCED                 
         BO    GETTP31             YES-EXIT WITH NOTFOUND                       
         OI    DEMOFLAG,X'04'                                                   
         XC    DUB,DUB           <-- NEED TO CLR! USE DBSELSTA                  
         MVI   DUB+5,2                                                          
         GOTO1 AGETEQIV            TRY EQUIVALENCING (NEW-OLD)                  
         BNE   GETTP31             NOTHING IN TABLES SO NOTFOUND                
         MVC   DBACTSTA,DUB        SET EQUIVALENT STATION                       
         ZIC   R1,CALLEN                                                        
         LA    R1,DBACTSTA(R1)                                                  
         CLI   DBSELMED,C'R'       DON'T FORCE FOR RADIO                        
         BE    *+8                                                              
         MVI   0(R1),C'T'          FORCE READ ON PARENT                         
         B     GETTP17                                                          
*                                  FOUND LATEST BOOK                            
GETTP20  MVC   DBACTBK,DRBOOK      SET LATEST BOOK VALUE                        
         XC    DBACTBK,EFFS                                                     
                                                                                
*====================================================================           
* COMMENT THIS OUT, - I DONT SEE A POINT IN CLEARING DBACTSTA                   
* IT ALSO MESSES UP THE STATION LINKS THAT SETS DBACTSTA TO A STATION           
* DIFF THAN DBSELSTA.  I TESTED LATEST BOOKS LOOKUPS AND THIS DOESNT            
* SEEM TO BREAK ANYTHING.  UNCOMMENT IF NECESSARY ,BUT                          
* KEEP IN MIND IT BREAKS STATION LINKS WHICH SETS DBACTSTA                      
* 03/2009 BEN POON                                                              
******   XC    DBACTSTA,DBACTSTA   CLEAR KEY STATION                            
*====================================================================           
         NI    DEMOFLAG,X'FF'-X'04' TURN OFF EQUIVALENCE BIT                    
         B     GETTP21             CONTINUE WITH READ FOR SELECTED VALS         
*                                  GET STATON KEY VALUE (DBACTSTA)              
GETTP21  BAS   RE,GETCALL                                                       
         STC   R1,CALLEN                                                        
*                                                                               
         CLI   LPMBTYP,0           RESTORE BOOKTYPE FOR LPM LATEST              
         BE    *+10                                                             
         MVC   DBBTYPE,LPMBTYP                                                  
*                                                                               
         MVC   BOOKTYPE,DBBTYPE    SET BOOK TYPE FOR READ                       
*                                                                               
GETTP21A ZIC   R1,CALLEN                                                        
         OC    DBACTSTA,DBACTSTA   TEST ACTUAL SET                              
         BNZ   *+10                                                             
         MVC   DBACTSTA,DBSELSTA   NO - SET FROM SELECTED                       
*****    CLI   DBSELSRC,C'V'       VIDEOLOGY DONT SET T AS BAND                 
*****    BE    GETTP22                                                          
         CLI   DBSELMED,C'R'                                                    
         BE    GETTP22                                                          
         LA    RE,DBSELSTA(R1)                                                  
         LA    R1,DBACTSTA(R1)                                                  
         MVC   0(1,R1),0(RE)       SET SATELLITE OPTION                         
*                                                                               
         CLI   DBSELSRC,C'C'       NCM DONT OVERRIDE THE BAND                   
         BE    *+16                                                             
         CLI   0(R1),C'T'          TEST IF P+S1 OR P+S2 REQUESTED               
         BH    GETTP22                                                          
         MVI   0(R1),C'T'          NO - SET PARENT ONLY                         
*                                   *********************************           
*RZ      CLI   DBSATLIT,C'Y'       TEST P+S2 OPTION SET                         
*RZ      BNE   GETTP22                                                          
*RZ      CLI   DBSELMED,C'T'                                                    
*RZ      BNE   GETTP22                                                          
*RZ      CLI   DBSELSRC,C'A'                                                    
*RZ      BNE   GETTP22                                                          
*RZ      CLC   DBACTSTA(4),=C'WOTV' DOUBLE SWITCH                               
*RZ      BE    *+8                                                              
*RZ      MVI   0(R1),C'2'          YES - SET P+S2 REQUIRED                      
*                                                                               
GETTP22  MVC   SAVEBOOK,DBACTBK    SET LOOK-UP BOOK VALUE                       
         XC    SAVEBOOK,EFFS                                                    
                                                                                
*        BAS   RE,SUMOLY96         ACCOUNT FOR 1996 SUMMER OLYMPICS             
*                                                                               
         MVI   TPRCNDS,0           ASSUME NOT CONDENSED RADIO MKT               
         MVI   BADBTFLG,0                                                       
         CLI   DBSELMED,C'R'                                                    
         BNE   GETTP24                                                          
         MVI   TPRCNDS,C'N'        ASSUME NOT CONDENSED MARKET                  
         BRAS  RE,TSTRCNDS                                                      
         BNE   GETTP24                                                          
         MVI   TPRCNDS,C'Y'        IT'S CONDENSED RADIO MKT                     
*                                                                               
GETTP24  LA    R2,DBKEY            BUILD KEY OF DEMO RECORD                     
         USING DRKEY,R2            R2=A(KEY)                                    
         XC    DRKMAJOR,DRKMAJOR                                                
         CLC   DBFILE,=C'RTP'                                                   
         BNE   *+8                                                              
         MVI   RECCODE,C'D'                                                     
         MVC   DRCODE,RECCODE                                                   
         CLI   TPRCNDS,C'Y'        IF CONDENSED RADIO MKT,                      
         BNE   *+8                                                              
         MVI   DRCODE,C'D'          GET DAYPART INFO INSTEAD                    
         MVC   DRMEDIA,DBINTMED                                                 
         MVC   DRSRC,DBACTSRC                                                   
         MVC   DRSTAT,DBACTSTA                                                  
         MVC   DRBOOK,SAVEBOOK                                                  
         MVC   DRKMKT,DBACTKMK                                                  
* TRUE NIELSEN WEEK                                                             
         CLI   DBSELMED,C'T'                                                    
         BNE   GETTP24B                                                         
         CLI   DBSELSRC,C'N'                                                    
         BNE   GETTP24B                                                         
GETTP24A OC    DBSELWKN,DBSELWKN                                                
         BNZ   YESWEEK                                                          
         TM    DBVOPT,X'40'                                                     
         BZ    GETTP24B                                                         
         TM    DBNPMFLG,DBTRUEWK                                                
         BNO   GETTP24B                                                         
         OC    DBSEL1WK,DBSEL1WK                                                
         BZ    GETTP24B                                                         
* ONLY READ TRUE WEEKLY IF IN SWEEP                                             
         GOTO1 VSUBR01,TPDMCB,('GETWEEKQ',(RC))                                 
         CLI   DBACT1WK,0                                                       
         BE    *+8                                                              
YESWEEK  MVI   DRHOME,C'w'                                                      
*                                                                               
GETTP24B CLI   DBSELSRC,C'F'                                                    
         BNE   *+10                                                             
         CLC   =C'HUT T',DBSELSTA  FUSION SET THE SPILL MKT FOR HUT T           
         BE    *+8                                                              
         CLI   SQADACT,C'Y'        SQUAD IS SPECIAL                             
         BNE   *+10                                                             
         MVC   DRKMKT,DBSELMK                                                   
*                                                                               
         MVC   DRSTYP,DBSTYPE                                                   
         MVC   DRBTYP,BOOKTYPE                                                  
*                                                                               
* FOR OVERNIGHTS LIVE ONLY LOOKUPS - IF WE START ASKING FOR                     
* LIVE ONLY FROM 3RD WEEK OF 2010 THEN FORCE TO LIVE +SD                        
* SINCE LIVE ONLY IS GOING AWAY ON THURSDAY OF WEEK 2                           
* WEEK 2 WILL CONTINUE TO READ THE LIVE ONLY MAJOR KEY SINCE THERE              
* WILL STILL BE LIVE ONLY DATA FOR M-WED OF WEEK_2                              
* THE CODE FURTHER DOWN BELOW WILL READJUST THE BOOKTYPE                        
* AND CLEAR OUT DBXNDA AND REREAD THE DIRECTORY FOR LIVE+SD                     
*                                                                               
         CLI   DBINTMED,C'O'                                                    
         BNE   GETTP24C                                                         
         MVC   HALF,DRBOOK                                                      
         XC    HALF,=X'FFFF'                                                    
*&&DO                                                                           
         CLC   HALF,=AL1(YR_2010,WEEK_3)                                        
         BL    GETTP24C                                                         
* LIVE DATA RETURNS MID WEEK OF AUG2310                                         
         CLC   HALF,=AL1(YR_2010,WEEK_35)                                       
         BNL   GETTP24C                                                         
* IF LIVE ONLY NOT FOUND LOOK FOR LIVE SAME DAY                                 
         CLI   CABLEFLG,C'N'                                                    
         BNE   *+8                                                              
         CLI   BOOKTYPE,C'L'                                                    
         BNE   *+12                                                             
         MVI   BOOKTYPE,BOOKTYPE_LS                                             
         MVI   DRBTYP,BOOKTYPE_LS                                               
* IF LIVE ONLY NOT FOUND LOOK FOR LIVE SAME DAY                                 
         CLI   BOOKTYPE,C'Z'                                                    
         BNE   *+12                                                             
         MVI   BOOKTYPE,BOOKTYPE_WS                                             
         MVI   DRBTYP,BOOKTYPE_WS                                               
* IF LIVE ONLY NOT FOUND LOOK FOR LIVE SAME DAY                                 
         CLI   CABLEFLG,C'Y'       ONLY VALID SWITCH                            
         BNE   *+8                 FOR CABLE STATIONS SINCE THIS                
         CLI   BOOKTYPE,C'U'                                                    
         BNE   *+12                                                             
         MVI   BOOKTYPE,BOOKTYPE_WS                                             
         MVI   DRBTYP,BOOKTYPE_WS                                               
* IF LIVE ONLY NOT FOUND LOOK FOR LIVE SAME DAY                                 
         CLI   BOOKTYPE,C'J'                                                    
         BNE   *+12                                                             
         MVI   BOOKTYPE,BOOKTYPE_HS                                             
         MVI   DRBTYP,BOOKTYPE_HS                                               
*&&                                                                             
****************************************                                        
                                                                                
GETTP24C MVI   TPMODE,0                                                         
         XC    TPLSTDIR,TPLSTDIR                                                
GETTP24G MVI   IOFLAG,DIR+HIGH+DEM READ HIGH/DIRECTORY                          
         GOTO1 AIO,IOFLAG                                                       
         BL    GETX                                                             
***      CLC   =C'TOON',DRSTAT                                                  
***      BNE   *+8                                                              
***      B     *+4                                                              
*                                  CHECK STATION FOUND                          
         CLC   DRKEY(DRBOOK-DRKEY),KEYSAVE                                      
         BE    GETTP30                                                          
*                                  DEAL WITH SATELLITES                         
GETTP26  ZIC   R1,CALLEN                                                        
         LA    RE,DBSELSTA(R1)                                                  
         LA    R1,DBACTSTA(R1)                                                  
         CLI   0(R1),C'1'          S1 DEFAULTS TO PARENT                        
         BE    GETTP27                                                          
         CLI   0(RE),C'T'          TEST IF P+S1 OR P+S2 REQUESTED               
         BH    GETTP28                                                          
         CLI   0(R1),C'2'          WAS P+S2 READ FOR                            
         BNE   GETTP28             NO - TRY EQUIVALENCING                       
GETTP27  MVI   0(R1),C'T'          SET TO READ PARENT RECORD                    
         B     GETTP24                                                          
*                                  DEAL WITH EQUIVALENCING                      
GETTP28  CLI   DBINTMED,C'O'                                                    
         BE    *+8                                                              
         CLI   DBINTMED,C'T'        TESTS FOR USTV ONLY                         
         BNE   GETTP28A                                                         
         CLI   BOOKTYPE,C'P'        TEST FOR PARALLEL LPM REGULAR               
         BNE   *+12                                                             
         MVI   BOOKTYPE,0          YES - TRY FOR REGULAR                        
         B     GETTP24                                                          
         CLI   BOOKTYPE,C'I'        OR HISPANIC                                 
         BNE   *+12                                                             
         MVI   BOOKTYPE,C'H'       YES - TRY FOR HISPANIC                       
         B     GETTP24                                                          
*  SEE WE ARE USING LOCAL CABLE CALL LETTERS AND IF THERE ARE MORE              
*  LEVELS TO READ                                                               
         OC    ALOCNTRY,ALOCNTRY                                                
         BZ    GETTP28A                                                         
                                                                                
         MVC   DBBTYPE,SVBTYPE  RESET THE BOOKTYPE FOR NEW LINK LOOKUP          
         BRAS  RE,LOCCABLK         GET NEW STATION/MKT/BOOKTYPE                 
         MVC   BOOKTYPE,DBBTYPE    SET BOOK TYPE FOR READ                       
         B     GETTP24             REREAD                                       
*                                                                               
*                                                                               
GETTP28A CLI   STALFLAG,C'Y'       STATION LINKED IN DEMTABS TABLE?             
         BNE   GETTP28B                                                         
         CLI   DBSELMED,C'O'       NO EQUIVALENCE CHECK FOR                     
         BE    GETTP29             WEEKLY/OVERNIGHTS FOR STATIONS IN            
         CLI   DBSELMED,C'W'       DEDEMTABS STATLINK TABLE                     
         BE    GETTP29                                                          
GETTP28B TM    DEMOFLAG,X'04'      TEST ALREADY EQUIVALENCED                    
         BO    GETTP31                                                          
         OI    DEMOFLAG,X'04'      SET ALREADY EQUIVALENCED                     
*                                                                               
         CLC   DBSELSTA(4),=C'CICT' CSI CICT HOME EQUATE                        
         JNE   GETTP28C                                                         
         MVC   DBACTSTA(4),=C'GLBL'    NOW W/MKT BECAUSE                        
         MVC   DBACTKMK(2),=AL2(484)   IT COMES IN AS A HOME                    
         B     GETTP21A                                                         
*                                                                               
GETTP28C CLC   DBSELSTA(4),=C'CHAN' CSI CHAN HOME EQUATE                        
         JNE   GETTP28D                                                         
         MVC   DBACTSTA(4),=C'GLBL'    NOW W/MKT BECAUSE                        
         MVC   DBACTKMK(2),=AL2(490)   ALSO IN ANOTHER MARKET                   
         B     GETTP21A                                                         
*                                                                               
GETTP28D CLC   DBSELSTA(4),=C'CKVU' CSI CALL LETTER CHANGE                      
         JNE   GETTP28F                                                         
         MVC   DBACTSTA(4),=C'CITY' NOW APPEARS W/MKT BECAUSE                   
         MVC   DBACTKMK(2),=AL2(490)   ALSO IN ANOTHER MARKET                   
         B     GETTP21A                                                         
*                                                                               
GETTP28F CLC   DBSELBK,=AL2(MAY_03)                                             
         BL    GETTP29                                                          
         CLC   DBSELSTA(4),=C'CFMT' CSI CALL LETTER CHANGE                      
         JE    *+10                                                             
         CLC   DBSELSTA(4),=C'OMNI' CSI CALL LETTER CHANGE                      
         JE    *+10                                                             
         CLC   DBSELSTA(4),=C'CFMN' CSI CALL LETTER CHANGE                      
         JNE   GETTP29                                                          
         MVC   DBACTSTA(4),=C'OMN1'                                             
         B     GETTP21A                                                         
*                                                                               
GETTP29  DS    0C                                                               
*  ADD CODE TO DEAL WITH OVERNIGHT STATION CALL LETTER CHANGES                  
*                                                                               
         CLI   STALFLAG,C'Y'                                                    
         BNE   GETTP29F                                                         
         CLI   DBSELMED,C'O'                                                    
         BE    *+8                                                              
         CLI   DBSELMED,C'W'                                                    
         BNE   GETTP29F                                                         
         GOTOR STALINK,DMCB,(X'01',SAVEBOOK),DBACTSTA                           
         CLC   =X'FFFF',DMCB+8     NO MORE STATIONS IN TABLE                    
         BE    GETTP31             DONT READ                                    
         B     GETTP21A                                                         
GETTP29F MVI   DUB+5,3             NO - SEARCH FOR OLD OR NEW                   
         GOTO1 AGETEQIV            GET EQUIVALENT CALL LETTERS                  
         BNE   GETTP26                                                          
         MVC   DBACTSTA,DUB        SET NEW STATION CALL LETTERS                 
         MVC   BOOKTYPE,SVBTYPE    IF DEALING WITH NEW CALL LETTER              
         MVC   DBBTYPE,SVBTYPE     RESET BOOKTYPE BACK TO ORGINAL               
         B     GETTP21A                                                         
*                                  DEAL WITH SELECTED BOOK                      
GETTP30  CLC   DRKEY(L'DRKMAJOR),KEYSAVE                                        
         BE    GETTP32             USE RECORD IF FOUND                          
* IF WE READ TRUE WEEKLY AND COULDNT FIND TRUE WEEKLY DIRECTORY                 
* KEY THEN WE SHOULD READ OLD DOMINANT PROGRAM KEY                              
* THIS IS DONE SO WE DONT BREAK OUT BOOKS WITH WE DONT BACKLOAD                 
* TRUE WEEKLY DATA FOR.  WE STILL CAN REQUEST -W OPTION.                        
*                                                                               
         CLI   DBSELMED,C'T'                                                    
         BNE   *+8                                                              
         CLI   DBSELSRC,C'N'                                                    
         BNE   *+8                                                              
         CLI   KEYSAVE+(DRHOME-DRKEY),C'w'                                      
         BNE   *+18                                                             
         MVC   DRKEY(L'DBKEY),KEYSAVE                                           
         MVI   DRKEY+(DRHOME-DRKEY),0   TURN OFF WEEKLY                         
         B     GETTP24G            REREAD FOR OLD DOMINANT DEMO REC             
*                                                                               
         CLI   DBSELMED,C'R'       RADIO                                        
         BNE   *+14                                                             
         CLC   DRKEY(DRHOME-DRKEY),KEYSAVE   DON'T CHECK HOME IND.              
         BE    GETTP32                                                          
*                                                                               
         DS    0H                  TEST SPILL MARKET REQUESTED                  
         OC    DBSELALF,DBSELALF   IF DBSELALF IS NOT NULLS,                    
         BZ    GETTP30A                                                         
         CLC   DBSELALF,=3C' '      AND IT'S NOT BLANKS                         
         BNE   GETTP30B                                                         
GETTP30A DS    0H                  SPILL MKT NOT PASSED IN DBSELALF             
*                                                                               
         CLI   DBSELMED,C'U'       COUNTY COVERAGE                              
         BNE   GETTP30B                                                         
         OC    DBSELMK,DBSELMK     IF NO COUNTY GIVEN,                          
         BNZ   GETTP30B            GET ALL COUNTIES FOR STATION/STATE           
GETP30AA CLC   DRKEY(DRKMKT-DRKEY),KEYSAVE                                      
         BE    *+12                                                             
         MVI   DIRERR,1                                                         
         B     GETTP28             NO MATCH ON STATION OR BOOK                  
         CLC   DRKMKT,PREVMKT                                                   
         BE    *+14                                                             
         MVI   DBDQPTR,0           START FROM BEGINNING OF DQTAB                
         MVC   PREVMKT,DRKMKT                                                   
         CLI   DBBTYPE,0                                                        
         BE    GETTP32             NO STATE GIVEN. RETURN ALL                   
         CLC   DRBTYP,DBBTYPE                                                   
         BE    GETTP32             MATCH ON STATION/BOOK/STATE                  
         MVI   IOFLAG,DIR+SEQ+DEM  READ SEQ FOR NEXT COUNTY,                    
         GOTO1 AIO,IOFLAG          UNTIL WE MATCH ON STATE                      
         B     GETP30AA                                                         
*                                                                               
GETTP30B DS    0H                  SPILL MARKET REQUESTED                       
         CLC   DRKEY(DRBTYP-DRKEY),KEYSAVE TEST MATCH UP TO BK TYPE             
*===================================================================            
         BE    GETTP30D                                             |           
* EVEN IS THE MARKET/BOOKTYPE DIDTNT MATCH  - TRY BOOKTYPE                      
* TRANSPARENCY CODE IF THE BOOK IS THE SAME                                     
* BECAUSE IF WE ARE LOOKING FOR THE HIGHEST BOOKTYPE LOADED ON                  
* THE FILE THE NEXT KEY RETURNED COULD BE FOR ANOTHER MARKET NUMBER             
* AS MARKET IS HIGHER THAN BOOKTYPE IN THE KEY                                  
         CLC   DRKEY(DRKMKT-DRKEY),KEYSAVE                                      
         BE    GETTP30D                                             |           
*                                                                               
* STATION FOUND / BOOK NOT FOUND                                                
***  new we should also be reading for ovenrights if book not found             
         CLI   DRMEDIA,C'O'        IF KEY IS NOT EQUAL              |           
         BE    GETTP30M                                                         
***                                                                             
         CLI   DRMEDIA,C'T'        IF KEY IS NOT EQUAL              |           
         BNE   *+12                CHECK TO SEE IF WE SHOULD        |           
         CLI   DRSRC,C'N'          READ FOR THE LIVE PLUS BOOKTYPE  |           
         BE    GETTP30H                                             |           
* ALL OTHERS GO TO GETTP28 LIKE WE DID BEFORE. WE WILL CHANGE       |           
* THIS LATER TO LOOK NICER.  ITS MESSY NOW.                         |           
         B     GETTP28                                              |           
*====================================================================           
* STATION BOOK FOUND /BOOKTYPE NOT FOUND                                        
GETTP30D CLI   DBBTYPE,0           TEST SPECIAL SURVEY REQUESTED                
         BE    GETTP30G                                                         
*                                                                               
         CLI   DRMEDIA,C'T'                                                     
         BE    GETTP30G                                                         
         CLI   DRSRC,C'N'                                                       
         BE    GETTP30G                                                         
         CLI   DRSRC,C'F'                                                       
         BE    GETTP30G                                                         
*                                                                               
*                                                                               
GETTP30F CLI   DRMEDIA,C'O'                                                     
         BNE   GETTP28             YES-SO DID NOT FIND IT                       
         CLI   DRSRC,C'N'                                                       
         BNE   GETTP28                                                          
* CODE TO CHECK IF WE ARE LOOKING FOR LIVE ONLY MONTHLY BOOK                    
GETTP30G CLC   DRBTYP,DBBTYPE      IS BTYPE THE MISMATCHING KEY?                
         BE    GETTP30P                                                         
         CLI   DRMEDIA,C'T'        USTV NSI                                     
         BNE   GETTP30M                                                         
         CLI   DRSRC,C'N'                                                       
         BNE   GETTP30M                                                         
* USTV MONTHLY BOOKTYPE SWITCHING  -                                            
GETTP30H CLI   DBVOPT,X'40'       SWITCH LIVE BKTYPE FOR SPOT                   
         BNE   GETTP28            POSTING                                       
         GOTO1 CDEMTABS,DMCB,LIVEBKTY   GET A(LIVE BOOKTYPE TABLE)              
         ICM   RE,15,0(R1)         A(TABLE) RETURNED IN P1                      
         JZ    *+2                 BAD TABLEID PASSED                           
         L     RF,4(R1)            L'TABLE ENTRY RETURNED IN P2                 
         USING LVBKTYD,RE                                                       
GETTP30I CLC   =X'FFFF',0(RE)                                                   
         BE    GETTP28                                                          
GETTP30J CLC   BOOKTYPE,LVONLYBT                                                
         BE    GETTP30L                                                         
GETTP30K AR    RE,RF                                                            
         B     GETTP30I                                                         
* FOUND BOOKTYPE - CHECK TO SEE IF BOOK FALLS WITHIN RANGE                      
GETTP30L CLC   DBSELBK,LEFFBOOK                                                 
         BL    GETTP30K                                                         
         CLC   DBSELBK,LENDBOOK                                                 
         BH    GETTP30K                                                         
         MVC   BOOKTYPE,LVPLUSBT                                                
         MVC   DBBTYPE,LVPLUSBT                                                 
         B     GETTP24                                                          
*  OVERNIGHTS BOOKTYPE SWITCHING                                                
GETTP30M CLI   DRMEDIA,C'O'        IF SO, IS IT OVERNIGHT FILES?                
         BNE   GETTP30N                                                         
         CLI   DRSRC,C'N'                                                       
         BNE   GETTP30N                                                         
*                                                                               
* IF LIVE PLUS NOT FOUND- LOOK FOR LIVE ONLY                                    
         CLI   BOOKTYPE,C'C'       DID WE TRY LIVE ALREADY                      
         BNE   *+16                                                             
         MVI   BOOKTYPE,C'U'       DID NOT FIND LIVEPLUS, TRY LIVE              
         MVI   DBBTYPE,C'U'                                                     
         B     GETTP24                                                          
         CLI   BOOKTYPE,C'H'                                                    
         BNE   *+16                                                             
         MVI   BOOKTYPE,C'J'                                                    
         MVI   DBBTYPE,C'J'                                                     
         B     GETTP24                                                          
*                                                                               
*                                                                               
         CLI   BOOKTYPE,C'W'       DID WE TRY LIVE ALREADY                      
         BNE   *+16                                                             
         MVI   BOOKTYPE,C'Z'       DID NOT FIND LIVEPLUS, TRY LIVE              
         MVI   DBBTYPE,C'Z'                                                     
         B     GETTP24                                                          
*                                                                               
         CLI   BOOKTYPE,0          DID WE TRY LIVE ALREADY                      
         BNE   *+16                                                             
         MVI   BOOKTYPE,C'L'       DID NOT FIND LIVEPLUS, TRY LIVE              
         MVI   DBBTYPE,C'L'                                                     
         B     GETTP24                                                          
*==================================================================             
*                                                                               
* NEWEST CODE TO READ FOR BAD BOOKTYPE WE LOADED BECAUSE OF BUG                 
* IN FILE CONVERSION LOADING BROADCAST AS CABLE BOOKTYPES                       
*                                                                               
* DONT DO IT FOR LOCAL CABLE                                                    
* BEST TO CONFIRM WE DONT HAVE THIS ISSUE FOR LOCCABL STATIONS                  
* WHICH IS LOADED AS BROADCAST                                                  
         OC    SVALOCNT,SVALOCNT   DONT DO THIS FOR LOCCAB                      
         BNZ   GETT30M2                                                         
         CLI   CABLEFLG,C'Y'       DONT DO FOR CABLE                            
         BE    GETT30M2                                                         
         CLI   SVBTYPE,0           ONLY DO IT FOR REQUEST BOOKTYPES             
         BE    *+8                 LIVE+7 AND L+3                               
         CLI   SVBTYPE,BOOKTYPE_L3                                              
         BNE   GETT30M2                                                         
         BRAS  RE,BADBTYPE         ONLY PROCESS THIS TRANSPARENCY CODE          
         BNE   GETT30M2            IF IT IS IN THE TABLE                        
*                                                                               
* USED TO 00 -> L , L -> LS                                                     
* NOW - 00 -> L ,L->C, C->U, U->LS                                              
* DO THIS FOR A SET LIST OF STATIONS                                            
* NEWLY ADDED- TO TRY TO FIX ISSUE WHERE WE LOADED SOME STATIONS TO             
* BOOKTYPE C                                                                    
         CLI   BOOKTYPE,C'L'       DID WE TRY LIVE ALREADY                      
         BNE   *+20                                                             
         MVI   BOOKTYPE,C'C'       DID NOT FIND LIVEPLUS, TRY LIVE              
         MVI   DBBTYPE,C'C'                                                     
         OI    BADBTFLG,BADBTDIR                                                
         B     GETTP24                                                          
* NEWLY ADDED - WHY DONT WE READ FOR LS IS LIVEONLY CABLE NOT FOUND             
* IF LIVE PLUS NOT FOUND- LOOK FOR LIVE ONLY                                    
         CLI   BOOKTYPE,C'U'       DID WE TRY LIVE ALREADY                      
         BNE   *+20                                                             
         MVI   BOOKTYPE,BOOKTYPE_LS    NOT FIND LIVEPLUS, TRY LIVE              
         MVI   DBBTYPE,BOOKTYPE_LS                                              
         OI    BADBTFLG,BADBTDIR                                                
         B     GETTP24                                                          
* WE NEVER HAD W3 TRANSARENCY SO ONLY STOP AT C3                                
         CLI   BOOKTYPE,BOOKTYPE_L3                                             
         BNE   *+20                                                             
         MVI   BOOKTYPE,BOOKTYPE_C3                                             
         MVI   DBBTYPE,BOOKTYPE_C3                                              
         OI    BADBTFLG,BADBTDIR                                                
         B     GETTP24                                                          
*                                                                               
*==================================================================             
*                                                                               
GETT30M2 DS    0H                                                               
         CLI   BOOKTYPE,C'P'       DID WE TRY PRELIM LPM                        
         BNE   *+16                                                             
         MVI   BOOKTYPE,0          DID NOT FIND - TRY LIVE LPM                  
         MVI   DBBTYPE,0                                                        
         B     GETTP24                                                          
                                                                                
         CLI   BOOKTYPE,C'I'       DID WE TRY PRELIM HISPANIC LPM               
         BNE   *+16                                                             
         MVI   BOOKTYPE,C'H'       DID NOT FIND -TRY LIVE HISPANIC LPM          
         MVI   DBBTYPE,C'H'                                                     
         B     GETTP24                                                          
*                                                                               
         CLI   BOOKTYPE,C'L'                                                    
         BNE   *+16                                                             
         MVI   BOOKTYPE,BOOKTYPE_LS                                             
         MVI   DBBTYPE,BOOKTYPE_LS                                              
         B     GETTP24                                                          
*                                                                               
*                                                                               
* FUSION DEFAULT BACK TO STANDARD BOOKTYPE                                      
* IF NOT FOUND...                                                               
GETTP30N CLI   DBSELSRC,C'F'                                                    
         BNE   GETTP30P                                                         
         CLI   DBBTYPE,BOOKTYPE_LS                                              
         BE    *+8                                                              
         CLI   DBBTYPE,BOOKTYPE_WS                                              
         BNE   *+16                                                             
         MVI   DBBTYPE,0                                                        
         MVI   BOOKTYPE,0                                                       
         B     GETTP24                                                          
*                                                                               
GETTP30P TM    DBCSPILL,DBOXSPL    TEST ACCESS TO EXTRA SPILL                   
         TM    DBCSPILL,DBOXSPL    TEST ACCESS TO EXTRA SPILL                   
         BZ    GETTP28             NO                                           
*                                                                               
         CLI   DRBTYP,XSPILL       TEST EXTRA SPILL RECORD RETURNED             
         BE    GETTP32             YES-AND TAKE IT                              
         CLI   BOOKTYPE,XSPILL     TEST IF EXTRA SPILL READ FOR YET             
         BE    *+12                YES                                          
         MVI   BOOKTYPE,XSPILL     NO-GO BACK AND TRY TO READ IT                
         B     GETTP24                                                          
*                                                                               
         MVI   BOOKTYPE,0                                                       
         B     GETTP28             ELSE TRY EQUIVALENCING                       
*                                  SET NOT FOUND                                
GETTP31  DS    0H                                                               
******************************************************************              
         CLI   DBSELMED,C'R'                                                    
         JNE   GETTP31B                                                         
         TM    DBBSTFLG,DBBSTMBK  GET BEST AVAILABLE MBK                        
         JO    *+8                                                              
         J     GETTP31B           ELSE REQUIRE ALL BOOKS IN MBK                 
         TM    DBEXTFLG,MBK_YES                                                 
         JZ    *+12                                                             
         TM    DBEXTFLG,MBK_DONE                                                
         JZ    GETTP34F                                                         
* FOR RADIO PREBUY - SPOT DESKTOP IF SPILL RULE IS TURNED ON                    
* WITH BEST BOOK AVAILABLE THEN REREAD FOR LATEST BOOK IF NOTHING WAS           
* FOUND. (DBFACTOR=0)                                                           
                                                                                
GETTP31A TM    DBBSTFLG,DBBSTLAT  GET LATEST BOOK MUST BE ON                    
         JZ    GETTP31B                                                         
         OC    DBSELBK,DBSELBK                                                  
         BZ    GETTP31B                                                         
         CLI   DBFACTOR,0                                                       
         BNE   GETTP31B                                                         
         XC    DBSELBK,DBSELBK                                                  
         B     GETTP34M                                                         
*                                                                               
*                                                                               
* SEE IF WE ARE PROCESSING END OF YEAR 53RD WEEK WEEKLY LOOKUP                  
* WE FAILED TO LOOKUP WEEK #53 - IT MIGHT ONLY BE A 52 WEEK YEAR                
* SO TRY TO READ WEEK 1 OF NEXT YEAR.                                           
* WE ONLY WANT TO DO THIS FOR WEEKLY AND POSTING SITUATION                      
GETTP31B CLI   DBBEST,C'R'                                                      
         BE    GETTP31H                                                         
         CLI   DBSELMED,C'W'                                                    
         BNE   GETTP31H                                                         
         CLI   WKBKDFLG,C'2'       IF WE ARE NOT PROCESSING 1ST                 
         BE    GETTP31H            SPLIT WEEK                                   
         OC    WKBKD2,WKBKD2       NOT A SPLIT WEEK SITUATION                   
         BNZ   GETTP31H            FOR A LOOKUP WITHIN A SINGLE WEEK            
         CLI   WKBKD1+1,X'FE'      IF ALREADY LOOKED UP 1ST WEEK                
         BE    GETTP31H                                                         
         CLI   DBSELBK+1,53                                                     
         BL    GETTP31H                                                         
***      BNE   GETTP31H                                                         
* HAVE TO HAVE MORE CHECKS TO PREVENT POSSIBLE INFINTE LOOPS                    
* SET DBSELBK TO 1ST WEEK?                                                      
* CHECK WKBKD1+1,X'FE'  1ST WEEK ALREADY- IF SO EXIT DONT DO AGAIN              
*                                                                               
         ZIC   RE,DBSELBK          REREAD FOR 1ST WEEK OF NEXT YEAR             
         AHI   RE,1                                                             
         STC   RE,WKBKD1                                                        
         MVI   WKBKD1+1,1                                                       
         XC    WKBKD1,=X'FFFF'                                                  
         MVC   DRBOOK,WKBKD1                                                    
         NI    DEMOFLAG,X'FF'-X'04' TURN OFF EQUIVALENCE BIT                    
         XC    DBNDXDA,DBNDXDA                                                  
         MVC   DRSRC,DBACTSRC                                                   
         MVC   DRSTAT,DBSELSTA                                                  
         MVC   DRKMKT,DBACTKMK                                                  
         MVC   DRSTYP,DBSTYPE                                                   
         MVC   DRBTYP,BOOKTYPE                                                  
         B     GETTP24G                                                         
******************************************************************              
*&&DO                                                                           
* LEAVE THIS OUT FOR NOW- IM NOT SURE WHAT WE WILL DO WITH                      
* SPLIT WEEKS WHERE FIRST PART IS NOT AVAILABLE                                 
* SEE IF WE ARE DEALING WITH 1ST HALF OF A SPLIT WEEK LOOKUP                    
* IF SO THEN CONTINUE TO LOOK AT SECOND PART OF SPLIT WEEK                      
         CLI   DBBEST,C'R'                                                      
         BE    GETTP31H                                                         
         CLI   WKBKDFLG,C'2'       IF WE ARE NOT PROCESSING 1ST                 
         BE    GETTP31H            SPLIT WEEK                                   
         OC    WKBKD2,WKBKD2                                                    
         BZ    GETTP31H                                                         
                                                                                
GETTP31C ZIC   R1,DBDQPTR                                                       
         CLI   DBLSTNXT,0                                                       
         BNE   *+16                                                             
         LA    R1,1(R1)            YES - BUMP POINTER VALUE                     
         MVI   DBLSTSQH,X'FF'      FORCE QTH HOUR MATCH N/E                     
         NI    TPMODE,X'FF'-TPMEOFSQ  RESET TPMODE                              
         STC   R1,DBDQPTR          SET CURRENT DQTAB POINTER VALUE              
         MHI   R1,DBDQLEN                                                       
         LA    R0,DBDQD-DBDQLEN                                                 
         CLC   =AL2(DBDQUXTD),DBDQTAB+0                                         
         BNE   GETTP31E                                                         
         LA    RF,DBEXTEND-4                                                    
GETTP31D DS   0H                                                                
         ICM   RF,15,4(RF)                                                      
         BZ    GETTP31E                                                         
         CLC   0(4,RF),DBDQTAB+2                                                
         BNE   GETTP31D                                                         
         LA    R0,(DBDQXFXL-DBDQLEN)(RF)                                        
GETTP31E EQU  *                                                                 
         AR    R1,R0                                                            
         ST    R1,ADQNTRY          SET A(DQTAB ENTRY)                           
         CLI   0(R1),X'60'                                                      
         BNL   GETTP31F                                                         
**       LH    RE,DBDIVSOR                                                      
**       AHI   RE,1                                                             
**       STH   RE,DBDIVSOR                                                      
         B     GETTP31C            BUMP UNTIL SAT                               
GETTP31F MVI   WKBKDFLG,C'2'       PROCESSING SAT/SUN SPLIT WEEK                
         MVC   DRBOOK,WKBKD2                                                    
         MVC   DRSTAT,DBSELSTA                                                  
         XC    DBNDXDA,DBNDXDA                                                  
         NI    DEMOFLAG,X'FF'-X'04' TURN OFF EQUIVALENCE BIT                    
* RESET THE # IN OF DBDQTR.  BECAUSE WE WILL BE BUMPING THIS                    
* NUMBER NATURALLY FURTHER DOWN.                                                
         ZIC   R1,DBDQPTR                                                       
         SHI   R1,1                                                             
         STC   R1,DBDQPTR          SET CURRENT DQTAB POINTER VALUE              
*                                                                               
         B     GETTP24G            REREAD DIRECTORY                             
*&&                                                                             
*********************************************************************           
GETTP31H MVI   DBERROR,NOTFOUND                                                 
         B     GETX                                                             
*                                  DIRECTORY ITEM FOUND                         
*                                                                               
*NEW CODE TO READ SYSCODE ADJUSTEMENT AND CORRECT                               
* STREAM BEFORE FILE READ!                                                      
GETTP32  CLI   DBSELMED,C'T'                                                    
         BNE   *+18                                                             
         OC    DBSELSYC,DBSELSYC                                                
         BZ    *+8                                                              
         BRAS  RE,FUSUEST                                                       
                                                                                
*GETTP32  MVC   DBACTBK,DRBOOK      SET BOOK VALUE                              
         MVC   DBACTBK,DRBOOK      SET BOOK VALUE                               
         XC    DBACTBK,EFFS                                                     
         CLI   DWLASTN,X'FF'       DOING LAST N                                 
         BNE   GETP32LX            NO - GET AROUND TESTS                        
         CLI   DBSELMED,C'R'       RADIO- DONT SET LIMIT TO LATEST              
         BE    GETTP32H            BOOKS                                        
         OC    LASTLMT,LASTLMT     LIMIT SET                                    
         BNZ   GETP32L             YES - CHECK IT                               
GETTP32H MVC   LASTLMT,DBACTBK     SET LIMIT BOOK                               
         SR    RE,RE                                                            
         ICM   RE,1,DBACTBK        DECREMENT YEAR BY 1                          
         BCTR  RE,0                                                             
         STC   RE,LASTLMT          AND SAVE AS LIMIT                            
GETP32L  CLC   LASTLMT,DBACTBK     CAN I USE THIS BOOK                          
         BNL   GETTP34X            NO - EXIT                                    
GETP32LX DS    0C                                                               
*                                                                               
         MVC   DBLSTBK,DBACTBK     SAVE ACTUAL BOOK FROM RECORD                 
         CLI   DBFUNCT,DBGETTLB    TEST LATEST BOOK REQUIRED                    
         BNE   GETTP34                                                          
         MVI   DBRECTYP,DBRECTLB   YES - EXIT WITH SPECIAL DBRECTYP             
         MVI   DBMODE,DBMFRST                                                   
         B     GETX                                                             
*                                  DEMO READING                                 
*                                  SET ACTUAL WEEK (IF REQUESTED)               
GETTP34  GOTO1 VSUBR01,TPDMCB,('GETWEEKQ',(RC))                                 
         MVI   TPQHWKS,1           INIT WEEKS                                   
         XC    DBFACTOR,DBFACTOR                                                
         ZIC   R1,DBDQPTR                                                       
         CLI   DBLSTNXT,0          GET NEXT DQTAB ENTRY                         
         BNE   *+16                                                             
         LA    R1,1(R1)            YES - BUMP POINTER VALUE                     
         MVI   DBLSTSQH,X'FF'      FORCE QTH HOUR MATCH N/E                     
         NI    TPMODE,X'FF'-TPMEOFSQ  RESET TPMODE                              
         STC   R1,DBDQPTR          SET CURRENT DQTAB POINTER VALUE              
         MHI   R1,DBDQLEN                                                       
         LA    R0,DBDQD-DBDQLEN                                                 
         CLC   =AL2(DBDQUXTD),DBDQTAB+0                                         
         BNE   GTTP34DQX                                                        
         LA    RF,DBEXTEND-4                                                    
GTTP34DQA DS   0H                                                               
         ICM   RF,15,4(RF)                                                      
         BZ    GTTP34DQX                                                        
         CLC   0(4,RF),DBDQTAB+2                                                
         BNE   GTTP34DQA                                                        
         LA    R0,(DBDQXFXL-DBDQLEN)(RF)                                        
GTTP34DQX EQU  *                                                                
         AR    R1,R0                                                            
         ST    R1,ADQNTRY          SET A(DQTAB ENTRY)                           
* WTP MAY HAVE SPLIT WEEK - IF SO SET IT AND FORCE REREAD OF DIR                
         MVI   WKBKDFLG,C'1'       DEFAULT -PROCESSING 1ST SPLIT BK             
         CLI   DBBEST,C'R'         RESEARCH BYPASSES                            
         BE    CHWKBKX                                                          
         CLI   MBKFLAG,C'Y'        ONLY WEEKLY LOOKUP GOING THOUGH              
         BE    CHWKBKX             UPGRADE -BYPASS                              
         CLI   WKBKD2,0            ANY SPLIT WEEK BOOK                          
         BE    CHWKBKX              NO - ITS OK                                 
*<<<<<<  CLC   DRBOOK,WKBKD2       IN SPLIT WEEK ALREADY                        
*<<<<<<  BE    CHWKBK90             YES - IT'S OK                               
*                                                                               
*======= CHECK DBBEST TO SEE IF WE HAVE SPECIAL SPLITS =====                    
CHWKBK16 CLI   DBBEST,X'16'        M-SA SPLITS OVERNIGHTS                       
         BNE   CHWKBK15                                                         
         CLI   0(R1),X'60'         M-SA NEXT WEEK                               
         BNH   CHWKBK80            READ 2ND HALF OF SPLIT BOOK                  
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
CHWKBK15 CLI   DBBEST,X'15'        M-F SPLITS OVERNIGHTS                        
         BNE   CHWKBK14                                                         
         CLI   0(R1),X'50'         M-F NEXT WEEK                                
         BNH   CHWKBK80            READ 2ND HALF OF SPLIT BOOK                  
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
CHWKBK14 CLI   DBBEST,X'14'        M-TH                                         
         BNE   CHWKBK13                                                         
         CLI   0(R1),X'40'         M-TH NEXT WEEK                               
         BNH   CHWKBK80            READ 2ND HALF OF SPLIT BOOK                  
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
CHWKBK13 CLI   DBBEST,X'13'                                                     
         BNE   CHWKBK12                                                         
         CLI   0(R1),X'30'         M-W NEXT WEEK                                
         BNH   CHWKBK80            READ 2ND HALF OF SPLIT BOOK                  
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
CHWKBK12 CLI   DBBEST,X'12'                                                     
         BNE   CHWKBK10                                                         
         CLI   0(R1),X'20'         M-TU NEXT WEEK                               
         BNH   CHWKBK80            READ 2ND HALF OF SPLIT BOOK                  
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
CHWKBK10 CLI   DBBEST,X'10'                                                     
         BNE   CHWKBK64                                                         
         CLI   0(R1),X'10'         MON NEXT WEEK                                
         BE    CHWKBK80            READ 2ND HALF OF SPLIT BOOK                  
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
*                                                                               
CHWKBK64 CLI   DBBEST,X'64'        SA-TH SPLITS TO NEXT WEEK                    
         BNE   CHWKBK63                                                         
         CLI   0(R1),X'60'         SA-SU NEXT WEEK                              
         BNL   CHWKBK80            READ 2ND HALF OF SPLIT BOOK                  
         CLI   0(R1),X'40'         M-TH NEXT WEEK                               
         BNH   CHWKBK80            READ 2ND HALF OF SPLIT BOOK                  
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
*                                                                               
CHWKBK63 CLI   DBBEST,X'63'        SA-WED SPLITS TO NEXT WEEK                   
         BNE   CHWKBK62                                                         
         CLI   0(R1),X'60'         SA-SU NEXT WEEK                              
         BNL   CHWKBK80            READ SECOND HALF OF SPLIT BOOK               
         CLI   0(R1),X'30'         M-W NEXT WEEK                                
         BNH   CHWKBK80            READ SECOND HALF OF SPLIT BOOK               
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
CHWKBK62 CLI   DBBEST,X'62'        SA-TU SPLITS TO NEXT WEEK                    
         BNE   CHWKBK61                                                         
         CLI   0(R1),X'60'         SA-SU NEXT WEEK                              
         BNL   CHWKBK80            READ SECOND HALF OF SPLIT BOOK               
         CLI   0(R1),X'20'         M-TU NEXT WEEK                               
         BNH   CHWKBK80            READ SECOND HALF OF SPLIT BOOK               
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
CHWKBK61 CLI   DBBEST,X'61'        SA-M SPLIT TO NEXT WEEK                      
         BNE   CHWKBK60                                                         
         CLI   0(R1),X'60'         SA-SU NEXT WEEK                              
         BNL   CHWKBK80            READ SECOND HALF OF SPLIT BOOK               
         CLI   0(R1),X'10'         MON NEXT WEEK                                
         BE    CHWKBK80            READ 2ND HALF OF SPLIT BOOK                  
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
CHWKBK60 CLI   DBBEST,X'60'        SA SPLIT TO NEXT WEEK                        
         BNE   CHWKBK70                                                         
         CLI   0(R1),X'60'         SAT NEXT WEEK                                
         BE    CHWKBK80            READ SECOND HALF OF SPLIT BOOK               
         B     CHWKBK85            READ 1ST HALF OF SPLIT BOOK                  
*                                                                               
*  NORMAL M-F STANDARD WEEK ONLY  SA/SUN SPLIT                                  
CHWKBK70 CLI   0(R1),X'60'         SAT/SUN                                      
         BL    CHWKBKX                                                          
CHWKBK80 MVC   DRBOOK,WKBKD2       YES - SET SPLIT BOOK                         
         XC    DBNDXDA,DBNDXDA     RESET TO READ IT                             
         MVI   WKBKDFLG,C'2'       PROCESSING SAT/SUN SPLIT BK                  
         B     CHWKBKX                                                          
CHWKBK85 MVC   DRBOOK,WKBKD1       YES - READ 1ST PART OF SPLIT WEEK            
         XC    DBNDXDA,DBNDXDA     RESET TO READ IT                             
         MVI   WKBKDFLG,C'1'       PROCESSING 1st HALF OF SPLIT WEEK            
         B     CHWKBKX                                                          
* SPLIT BOOK IS SET MAY NEED TO RESET IT                                        
CHWKBK90 CLI   0(R1),X'5F'         NOT SAT/SUN                                  
         BH    CHWKBKX                                                          
         MVC   DRBOOK,WKBKD1        SET TO REG BOOK                             
         XC    DBNDXDA,DBNDXDA     RESET TO READ IT                             
CHWKBKX  DS    0C                                                               
*                                                                               
                                                                                
         CLI   TPRCNDS,C'Y'        PROCESSING CONDENSED RADIO MKT?              
         BNE   GETTP34B                                                         
         CLI   0(R1),EOT            YES, TEST END OF DQTAB                      
         BE    GTTP34AX              IF YES, SKIP THIS LOGIC                    
         SR    R0,R0                                                            
         LARL  R1,RDPTAB            YEP, SET ADDRESSES OF RDPTAB                
         USING RDPTABD,R1                                                       
         L     RF,ADQNTRY                                                       
DBDQ     USING DBDQD,RF                                                         
         LA    RE,GTTP34AA                                                      
GTTP34AA CLI   RDPDPT,0            SET START ADDRESS OF SECTION                 
         BNE   *+12                                                             
         MVI   DBERROR,HORREND                                                  
         B     GETX                                                             
         CLC   DBDQ.DBDQKDAY,RDPDAY      CORRESPONDING TO KEY DAY               
         BNE   GTTP34AC            HAVEN'T FOUND SECTION YET                    
         ST    R1,TPATBLE                                                       
         LA    RE,GTTP34AB                                                      
GTTP34AB CLI   RDPDPT,0            SET END ADDRESS OF SECTION                   
         BE    *+14                                                             
         CLC   DBDQ.DBDQKDAY,RDPDAY      CORRESPONDING TO KEY DAY               
         BE    GTTP34AC            DAYS ARE SAME, NEED DIFF DAY                 
         BCTR  R1,0                                                             
         ST    R1,TPATBLEX                                                      
         B     GTTP34AX                                                         
GTTP34AC IC    R0,RDPLEN           BUMP TO NEXT ENTRY                           
         AR    R1,R0                                                            
         BR    RE                                                               
         DROP  R1,DBDQ                                                          
GTTP34AX DS    0H                                                               
         L     R1,ADQNTRY          RESTORE A(DQTAB ENTRY) TO R1                 
*                                  GET FIRST RECORD FOR DAY/QTR HOUR            
GETTP34B DS    0H                                                               
         CLI   DBLSTNXT,0                                                       
         BNE   GETTP38                                                          
         CLI   0(R1),EOT           TEST END OF DQTAB                            
         BNE   GETTP35                                                          
*&&DO                                                                           
* FOR RADIO DAYPART LOOKUP IF DBSELPRG IS PASSED IN THEN TRY TO                 
* READ FOR DAYPART ANYWAYS BECAUSE THE DAYCODE COMING IN MIGHT NOT              
* BE A NORMAL DAYCODE GETDQ UNDERSTOOD HENCE DBDQTAB WOULD NOT HAVE             
* BEEN FILLED IN.  DBDQTAB=X'FF' IF DAYTIME IS NOT NORMAL                       
         CLC   DBFILE,=C'RDP'                                                   
         BNE   GETTPXLA                                                         
         CLI   DBDQTAB,X'FF'                                                    
         BNE   GETTPXLA                                                         
         OC    DBSELPRG,DBSELPRG                                                
         BZ    GETTPXLA                                                         
         MVC   DBMINKEY(1),DBSELDAY                                             
         MVC   DBMINKEY+1(1),DBSELPRG+1                                         
         B     GETTP35A                                                         
*&&                                                                             
*                                                                               
*                                                                               
GETTPXLA OC    TPTIM2(2),TPTIM2    CHECK FOR SPLIT DAY/TIME                     
         BZ    GETTPXLB                                                         
         MVC   DBSELTIM(4),TPTIM2  AND SET IF THER                              
         XC    TPTIM2,TPTIM2                                                    
*                                                                               
*   FOR LATEST BOOK AND SPLIT TIME LOOKUP WE HAVE TO KEEP THE BOOK              
* IN SAVEBOOK-  WE WERE LOSING THE BOOK                                         
         CLI   DBSELBK,X'FF'                                                    
         BNE   GETTP34M                                                         
         XC    SAVEBOOK,EFFS       FLIP IT                                      
         MVC   DBSELBK,SAVEBOOK    FLIP IT                                      
         B     GETTP34M                                                         
GETTPXLB OC    TPSVTIM(2),TPSVTIM  OTHERWISE RESTORE ORIG IF THERE              
         BZ    GETTPXLC                                                         
         MVC   DBSELTIM(4),TPSVTIM                                              
                                                                                
         BRAS  RE,CHK5AMR          NEED TO CHECK FOR 5A SPLITS                  
*                                                                               
**GETTPXLC L     RE,DBEXTEND         CHECK FOR MULIPLE DAY/TIME                 
GETTPXLC ICM   RE,15,DBEXTEND      CHECK FOR MULIPLE DAY/TIME                   
         NI    DBEXTFLG,X'FF'-DYTM_YES   TURN OFF MULTI DYTM INDICATOR          
         LTR   RE,RE               NO MULTI D/T   - END IT                      
         BZ    GETTPXLH                                                         
         CLI   BKDTFLAG,C'Y'                                                    
GETDYTM  BE    GETTPXLH                                                         
         USING DBXTLID,RE                                                       
         CLC   DBXTLID,=C'DYTM'    THIS IS THE ONE WE WANT                      
         BE    *+12                                                             
         ICM   RE,15,DBXTLNXT                                                   
         B     GETDYTM                                                          
*                                                                               
         OI    DBEXTFLG,DYTM_YES   SET DBEXTEND FLAG TO MULTI DAYTIME           
*                                                                               
* KEEP THE SAME DAYTIME UNTIL DONE WITH MBK LINKS                               
* THE LOGIC TO PROCESS  ALL MULTIBOOKS OR LATN BKS FOR EACH DAYTIME             
         TM    DBEXTFLG,MBK_YES    KEEP PROCESSING MULT BKS UNTIL ALL           
         BZ    *+12                MULTI BKS ARE PROCESSED BEFORE               
         TM    DBEXTFLG,MBK_DONE   GETTING NEXT DAYTIME                         
         BZ    GETTPXLH                                                         
*                                                                               
* LATEST N BOOK LOOKUPS?                                                        
* ONLY PROCESS NEXT DAYTIME IF ALL LATEST BOOKS PROCESSED                       
*                                                                               
         CLI   DWLASTN,X'FF'       LAST N CONTROL                               
         BNE   GETTPXLD                                                         
* SAVE THE ACTBK - SO WE CAN RESTORE FOR NEXT DAYTIME LINK LOOKUP               
         MVC   HALF,DBSELBK                                                     
         NI    HALF+1,X'0F'                                                     
         CLC   HALF,DWLASTN                                                     
         BNE   *+10                                                             
         MVC   SVACTBK,DBACTBK                                                  
*                                                                               
         ZIC   RF,DWLASTN+1        DECREMENT COUNTER                            
         BCTR  RF,0                                                             
         LTR   RF,RF               PROCESS ALL LAT N BOOKS BEFORE               
         BNZ   GETTPXLH            PROCEEDING TO NEXT DAYTIME                   
* -DONE PROCESSING ALL LATEST BOOKS                                             
* -PROCEED TO RESTORE FIELDS AND PROCESS NEXT DAYTIME                           
         MVC   DWLASTN,DBSELBK     SAVE LAST N PARAMETER                        
         NI    DWLASTN+1,X'0F'                                                  
         ZIC   RF,DWLASTN+1        ADJUST UP TO READ N LATEST                   
         AHI   RF,1                BOOKS FOR NEW DAYTIME                        
         STC   RF,DWLASTN+1                                                     
         MVC   DBACTBK,SVACTBK                                                  
         ZIC   RF,DBACTBK+1        RESTORE DBACTBK                              
         AHI   RF,1                FOR NEXT DAYTIME LINK LOOKUP                 
         CHI   RF,12                                                            
         BH    *+12                                                             
         STC   RF,DBACTBK+1                                                     
         B     GETTPXLD                                                         
         ZIC   RF,DBACTBK                                                       
         AHI   RF,1                                                             
         STC   RF,DBACTBK                                                       
         MVI   DBACTBK+1,1                                                      
*                                                                               
* INDEX TO NEXT DAYTIME                                                         
*                                                                               
GETTPXLD ZIC   RF,DBXTLIDX                                                      
         LA    RF,1(RF)                                                         
         STC   RF,DBXTLIDX                                                      
         MHI   RF,5                                                             
         LA    RF,DBXTLIST(RF)                                                  
         CLI   0(RF),0                                                          
         BNE   GETTPXLE                                                         
*  END OF DAYTIME LIST                                                          
* SET DYTM DONE FLAG                                                            
         OI    DBEXTFLG,DYTM_DONE  SET DBEXTEND FLAG TO MULTI DAYTIME           
         B     GETTPXLG                                                         
* MORE DAYTIMES TO PROCESS                                                      
GETTPXLE MVC   DBSELDAY(5),0(RF)                                                
* ADDED ON 3/26/18 DUE TO TICKET...DBSELTIM WAS CLEARED FOR TOON/ADSM           
* ON SECOND STATION LOOKUP BECAUSE SVSELTM2 WAS NEVER SET                       
         MVC   SVSELTM2,DBSELTIM                                                
*                                                                               
         XC    TPTIM2,TPTIM2       RESTORE -CLEAR OUT AND RESET                 
         BRAS  RE,CHK5AMR          NEED TO CHECK FOR 5A SPLITS                  
         TM    DBEXTFLG,MBK_YES    MBK OR LATN BOOKS LOOKUPS                    
         BO    GETTPXLH            BRANCH BELOW TO PROCESS                      
         CLI   DWLASTN,X'FF'       LAST N CONTROL                               
         BE    GETTPXLH                                                         
*                                                                               
         B     GETTP34M            NOT LATN OR MBK LOOKUP                       
*                                                                               
GETTPXLG DS    0H                                                               
         MVC   DBSELDAY(5),DBXTLIST  RESET TO FIRST DAY/TM                      
         MVI   DBXTLIDX,0                                                       
*                                                                               
*                                                                               
*                                                                               
GETTPXLH DS    0H                                                               
*                                                                               
         CLI   DWLASTN,X'FF'       LAST N CONTROL                               
         BNE   GETTP34C                                                         
                                                                                
         CLI   DBSELSRC,C'A'       RESET FOR ARBITRON RADIO                     
         BE    *+8                                                              
         CLI   DBSELSRC,C'T'             AND TRITON                             
         BNE   *+10                                                             
         CLC   =C'TP',DBFILE                                                    
         BNE   *+8                                                              
         MVI   RDAYPART,C'N'                                                    
                                                                                
         ZIC   RE,DWLASTN+1        DECREMENT COUNTER                            
         BCTR  RE,0                                                             
***      LTR   RE,RE                                                            
***      BZ    GETTP34X                                                         
*                                                                               
         TM    DBEXTFLG,DYTM_YES   PROCESSING DAYTIME EXTENDS?                  
         BO    GETTPXLI                                                         
* ARE WE DONE WITH NUMBER OF LATEST BOOKS?                                      
         LTR   RE,RE                                                            
         BZ    GETTP34X                                                         
         B     GETTPXLJ                                                         
* IF PROCESSING DAYTIME EXTENDS AND NO MORE LATEST BOOKS TO PROCESS             
* CHECK IF WE ARE DONE PROCESSING ALL DAYTIME EXTENDS                           
GETTPXLI TM    DBEXTFLG,DYTM_DONE                                               
         BO    GETTP34X                                                         
         LTR   RE,RE                                                            
         BZ    GETTPXLC                                                         
* FOR DAYTIME LINK LOOKUPS- LOOP BACK UP TO PROCESS REST OF                     
* DAYTIME LINKS UNTIL WE ARE DONE                                               
*                                                                               
GETTPXLJ STC   RE,DWLASTN+1                                                     
         OC    DBACTBK,DBACTBK                                                  
         BZ    *+10                                                             
         MVC   DBSELDAT,DBACTBK                                                 
* CHECK PPM FOR RADIO- NEED TO SWITCH BOOKTYPES FOR PRELIM                      
         CLI   DBSELMED,C'R'                                                    
         BNE   GETTPXLY                                                         
         MVC   DBSELBK,DBSELDAT                                                 
         CLI   PPM_FLAG,PPMFIRST CALL CHKPLAT TO SEE IF BOOK IS POST            
         BNE   *+12              PPM LIVE BOOK                                  
         MVI   PPM_FLAG,PPMSEQ                                                  
         BRAS  RE,CHKPLAT                                                       
*                                                                               
         ZIC   RE,DBSELBK+1                                                     
         SHI   RE,1                                                             
         STC   RE,DBSELBK+1                                                     
         CLI   DBSELBK+1,1                                                      
         BNL   GETTPXLW                                                         
         ZIC   RE,DBSELBK                                                       
         SHI   RE,1                                                             
         STC   RE,DBSELBK                                                       
         MVI   DBSELBK+1,12                                                     
GETTPXLW CLI   PPM_FLAG,PPMLVBKY   DONT CALL CHKLPPM TO SET THE                 
         BNE   *+8                 BOOKTYPE TO PRELIMINARY UNLESS               
         BRAS  RE,CHKPLAT          THE LIVE BOOK IS LOADED                      
         XC    DBSELBK,DBSELBK     (LAT# BOOK LOOKUP FEATURE)                   
*                                                                               
GETTPXLY XC    DBSELBK,DBSELBK                                                  
         MVI   DBERROR,0                                                        
         ZIC   RE,DBSELDAT+1       START AT LAST BOOK -1                        
         BCTR  RE,0                                                             
         CHI   RE,1                MAKE SURE WE DONT GO BACK PAST               
         BL    *+12                BEGINNING OF YEAR                            
         STC   RE,DBSELDAT+1                                                    
         B     GETTPXLZ                                                         
         ZIC   RE,DBSELDAT                                                      
         SHI   RE,1                                                             
         STC   RE,DBSELDAT                                                      
         MVI   DBSELDAT+1,12                                                    
*                                                                               
GETTPXLZ TM    DBEXTFLG,DYTM_YES   IF PROCESSING DAYTIME EXTENDS, DONT          
         BO    *+8                 CALL ROUTINE TO RESET                        
         BAS   RE,RSTDTIDX         RESET DAY AND TIME, IF NECESSARY             
         B     GETTP34M                                                         
*                                                                               
GETTP34C CLI   DBSELMED,C'C'       PULLING WEEKS FOR A MONTH FOR CAN?           
         BNE   GETTP34F                                                         
* BBM WEEKLY--->MONTHLY READING                                                 
         CLI   DBSELSRC,C'A'       BBM IS CODED AS 'A'                          
         BNE   *+12                                                             
         CLI   DBBTYPE,C'W'        INDICATES BBM WEEKLY FILE                    
         BE    *+8                                                              
*                                                                               
* CSI WEEKLY--->MONTHLY READING                                                 
         CLI   DBSELSRC,C'N'       SOURCE = NSI                                 
         BNE   GETTP34F                                                         
         CLI   DBBEST,C'M'                                                      
         BNE   GETTP34F                                                         
* NEW POSTING METHDOLOGY FOR ACHIEVED POSTING                                   
* NEW ACHIEVED POSTING METHODLOGY?                                              
         IF    (CLI,DBNPMFLG,EQ,DBNPMACH),AND,                                  
               (OC,SPTTBPTR,SPTTBPTR,NZ),AND,                                   
               (CLI,DBVOPT,E,X'40')                                             
         BRAS  RE,NXTSPOT                                                       
         OC    NUMSPOTS,NUMSPOTS                                                
         BZ    GETTP34D                                                         
         B     GETTP34M                                                         
         ENDIF                                                                  
*                                                                               
GETT34CH CLC   CANSWK,CANEWK       IF THE SAME-> DONE WITH MONTH                
         BE    GETTP34D            DONE WITH THIS BOOK                          
         MVC   DBSELBK,DBACTBK                                                  
         ZIC   RE,CANSWK                                                        
         LA    RE,1(RE)            BUMP TO NEXT WEEK                            
         STC   RE,CANSWK                                                        
         MVC   DBSELBK+1(1),CANSWK  GET 1ST WEEK                                
         CLI   DBSELBK,0                                                        
         BNE   *+8                                                              
         MVI   DBSELBK,YR_2003                                                  
         B     GETTP34M                                                         
*                                                                               
GETTP34D MVC   DBACTBK,DBSELBK     FUDGE ACT BOOK TO MONTH                      
         OC    CANMBK,CANMBK       IF WE'VE USED WEEKLY TO CREATE               
         BZ    GETTP34F             A MONTH                                     
         MVC   DBACTBK,CANMBK      SET THAT MONTH NOW                           
*                                                                               
***GETTP34F L     RE,DBEXTEND         CHECK FOR MULIPLE BOOKS                   
GETTP34F ICM   RE,15,DBEXTEND         CHECK FOR MULIPLE BOOKS                   
         NI    DBEXTFLG,X'FF'-MBK_YES                                           
***      NI    DBEXTFLG,X'FF'-MBK_DONE                                          
         LTR   RE,RE               NO MULTI BOOKS - END IT                      
GETTP34G BZ    GETTP34P                                                         
         USING DBXMBID,RE                                                       
         CLC   DBXMBID,=C'BKDT'    THIS IS THE ONE WE WANT                      
         BE    GETTP34I                                                         
         CLC   DBXMBID,=C'MBKS'    THIS IS THE ONE WE WANT                      
         BE    *+12                                                             
         ICM   RE,15,DBXMBNXT                                                   
         B     GETTP34G                                                         
         OI    DBEXTFLG,MBK_YES                                                 
         ZIC   RF,DBXMBIDX         EXTEND                                       
         TM    DBEXTFLG,MBK_DONE   IF WE ARE STARTING FROM BEGENNING OF         
         BO    *+8                 MBK LINK AGAIN DONT BUMP INDEX BY 1          
         LA    RF,1(RF)                                                         
         STC   RF,DBXMBIDX                                                      
         SLL   RF,1                                                             
         LA    RF,DBXMBKS(RF)                                                   
*                                                                               
         TM    DBEXTFLG,DYTM_YES   ARE WE ALSO PROCESSING DAYTIME LINKS         
         BZ    *+12                                                             
         TM    DBEXTFLG,DYTM_DONE  IF NO MORE DAYTIME LINKS                     
         BO    GETTP34P            TO PROCESS                                   
                                                                                
         NI    DBEXTFLG,X'FF'-MBK_DONE   RESET FLAG                             
****     CLI   0(RF),0                                                          
****     BE    GETTP34P            END OF BOOK LIST                             
         CLI   0(RF),0                                                          
         BNE   GETTP34H                                                         
* NO MORE MULTIBOOKS TO PROCESS                                                 
* IF PROCESSING DAYTIME EXTENDS ALSO THEN LOOP BACK UP TO GRAB NEXT             
* DAYTIME                                                                       
         TM    DBEXTFLG,DYTM_YES   ARE WE ALSO PROCESSING DAYTIME               
         BZ    GETTP34P            LINKS?                                       
         OI    DBEXTFLG,MBK_DONE                                                
         MVI   DBXMBIDX,0          RESET MBK INDEX TO START OF LINK             
         B     GETTPXLC                                                         
*                                                                               
GETTP34H MVC   DBSELBK,0(RF)                                                    
         MVC   SVSELBK,DBSELBK     RESET SAVE BK--MBK USERS, WATCH OUT!         
         BRAS  RE,CHK5AMR          NEED TO CHECK FOR 5A SPLITS                  
         BRAS  RE,CHKPLAT                                                       
         CLI   DBERROR,EOF         RESET ERROR  FOR NEXT BOOK LOOKUP            
         BNE   *+8                                                              
         MVI   DBERROR,0                                                        
         B     GETTP34J                                                         
GETTP34I DS    0X                                                               
         USING DBBDTMD,RE                                                       
         ZIC   RF,DBBDTIDX                                                      
         LA    RF,1(RF)                                                         
         STC   RF,DBBDTIDX                                                      
         MHI   RF,7                                                             
         LA    RF,DBBDTMS(RF)                                                   
         CLI   0(RF),0                                                          
         BE    GETTP34P            END OF BOOK LIST                             
         MVC   DBSELBK,0(RF)                                                    
         MVC   DBSELDAY(L'DBSELDAY+L'DBSELTIM),2(RF)                            
         MVC   SVSELBK,DBSELBK     RESET SAVE BK--MBK USERS, WATCH OUT!         
* IF BILL A LINK WITH 00 DAYCODE THEN BYPASS                                    
         CLI   DBSELDAY,0                                                       
         JE    GETTP34I                                                         
         DROP  RE                                                               
         BRAS  RE,CHK5AMR          NEED TO CHECK FOR 5A SPLITS                  
*                                                                               
*                                                                               
GETTP34J CLI   DBSELMED,C'C'       PULL 4-WEEKS GIVEN A MONTH FOR TCN?          
         BNE   GETTP34M                                                         
* BBM WEEKLY--->MONTHLY READING                                                 
         CLI   DBSELSRC,C'A'       BBM IS CODED AS 'A'                          
         BNE   *+12                                                             
         CLI   DBBTYPE,C'W'        INDICATES BBM WEEKLY FILE                    
         BE    *+8                                                              
*                                                                               
* CSI WEEKLY--->MONTHLY READING                                                 
         CLI   DBSELSRC,C'N'       SOURCE = NSI                                 
         BNE   GETTP34M                                                         
         CLI   DBBEST,C'M'                                                      
         BNE   GETTP34M                                                         
         BAS   RE,CAN4WK                                                        
         CLI   CANSWK,0            IF =0 --> ERROR                              
         BNE   *+12                                                             
         MVI   DBERROR,1           BAD BOOK PASSED OR YY NOT IN TABLE           
         B     GETX                                                             
         MVC   DBSELBK+1(1),CANSWK  GET 1ST WEEK                                
*                                                                               
GETTP34M MVC   DUB,DBACTKMK                                                     
         XC    DBACTUAL,DBACTUAL                                                
         MVC   DBACTKMK,DUB                                                     
         MVI   DEMOFLAG,0                                                       
         MVI   DBMODE,DBMFRST                                                   
         MVC   DBACTMED,DBINTMED                                                
         MVC   DBACTSRC,DBSELSRC                                                
         MVI   STALFLAG,C'N'       RESET STATION CALL LETTER LINK FLAG          
         B     GETTP2                                                           
*                                                                               
* SEE IF WE ARE TOON STATION                                                    
GETTP34P DS    0C                                                               
         CLI   TOONSTAF,TOONDONE                                                
         BE    GETTP34Q                                                         
         MVI   TOONSTAF,TOON2ND                                                 
         BRAS  RE,CHCKTOON                                                      
         MVI   TOONSTAF,TOONDONE                                                
         B     GETTP34R                                                         
*                                                                               
*                                                                               
GETTP34Q DS    0C                                                               
*ETTP34P ICM   RE,15,DBEXTEND      CHECK FOR MULIPLE STATIONS                   
         ICM   RE,15,DBEXTEND      CHECK FOR MULIPLE STATIONS                   
         USING DBXMSD,RE                                                        
GETTP34N LTR   RE,RE                                                            
         BZ    GETTP34S            NO - DONE                                    
         CLC   DBXMSID,=C'MSTA'                                                 
         BE    *+12                                                             
         ICM   RE,15,DBXMSNXT                                                   
         B     GETTP34N                                                         
         ZIC   RF,DBXMSIDX                                                      
         LA    RF,1(RF)                                                         
         STC   RF,DBXMSIDX                                                      
         MHI   RF,L'DBXMSTA                                                     
         LA    RF,DBXMSTA(RF)                                                   
         MVI   MSTAFLG,MSTADONE                                                 
         CLI   0(RF),0                                                          
         BE    GETTP34X            END OF STATION LIST                          
         MVI   MSTAFLG,MSTAMORE                                                 
         MVC   DBSELSTA,0(RF)                                                   
GETTP34R XC    DBACTUAL,DBACTUAL                                                
         MVI   DEMOFLAG,0                                                       
         MVI   DBMODE,DBMFRST                                                   
         MVC   DBACTMED,DBINTMED                                                
         MVC   DBACTSRC,DBSELSRC                                                
* new we should restore original time for next station                          
* so we dont mess up crossing the split time 6am                                
         MVC   DBSELTIM,SVSELTM2                                                
*                                                                               
         XC    TPTIM2,TPTIM2       RESTORE -CLEAR OUT AND RESET                 
         BRAS  RE,CHK5AMR          NEED TO CHECK FOR 5A SPLITS                  
*  RESET THE BOOKTYPE WE STARTED WITH FOR ALL STATIONS                          
*  FOR PRECAUTION                                                               
         MVC   DBBTYPE,SVBTYPE                                                  
         B     GETTP1A                                                          
*                                                                               
*  CHECK TO SEE IF WE ARE PROCESSING STATION LINKS                              
*  IF SO CHECK TO SEE IF WE NEED TO TRAVERSE THE TABLE BACKWARDS                
*  AND REREAD PREVIOUS STATION IN TABLE                                         
GETTP34S DS    0H                                                               
         CLI   DBSELMED,C'W'                                                    
         BE    *+8                                                              
         CLI   DBSELMED,C'O'                                                    
         BNE   GETTP34X                                                         
         CLI   STALFLAG,C'Y'                                                    
         BNE   GETTP34X                                                         
         GOTOR STALINK,DMCB,(X'01',SAVEBOOK),DBSELSTA                           
         CLC   =X'FFFF',DMCB+8     NO MORE STATIONS IN TABLE                    
         BE    GETTP34X            DONT READ                                    
*                                                                               
         XC    DBACTUAL,DBACTUAL                                                
         MVI   DEMOFLAG,0                                                       
         MVI   DBMODE,DBMFRST                                                   
         MVC   DBACTMED,DBINTMED                                                
         MVC   DBACTSRC,DBSELSRC                                                
*  RESET THE BOOKTYPE WE STARTED WITH FOR ALL STATIONS                          
*  FOR PRECAUTION                                                               
         MVC   DBBTYPE,SVBTYPE                                                  
         B     GETTP1A                                                          
                                                                                
GETTP34X DS    0H                                                               
*                                                                               
* 1-/8/2015 BPOO- REMOVED CUNTY COVERAGE CODE FOR SPACE                         
*  COUNTRY COVERAGE NO LONGER USED                                              
*                                                                               
         CLI   DBSELMED,C'U'       FOR COUNTY COVERAGE                          
         BNE   GETP34XX                                                         
         OC    DBSELMK,DBSELMK     IF NO COUNTY REQUESTED,                      
         BNZ   GETP34XX            RETRN ALL CNTIES FOR STATION(&STATE)         
         CLI   DIRERR,1                                                         
         BNE   *+12                                                             
         MVI   DIRERR,0                                                         
         B     GETP34XX                                                         
         OC    DBBTYPE,DBBTYPE     IF NO SPECIFIC STATE,                        
         BNZ   GETP34XA                                                         
         ZIC   RE,DRBTYP                                                        
         LA    RE,1(RE)                                                         
         STC   RE,DRBTYP                                                        
         B     GETTP24G            GO READ FOR NEXT STATE                       
GETP34XA SR    RE,RE                                                            
         ICM   RE,3,DRKMKT                                                      
         LA    RE,1(RE)            GO READ FOR NEXT COUNTY                      
         STCM  RE,3,DRKMKT                                                      
         B     GETTP24G            READ HIGH ON DIRECTORY                       
* CHECK TO SEE IF WE ARE REQUESTING FOR RADIO WITH BEST MBK OPTION              
* IF SO- SPILL MARKET RULES APPLY WHERE WE WILL RETURN LATEST BOOK              
* WHEN NO BOOKS ARE FOUND                                                       
*                                                                               
GETP34XX DS    0C                                                               
         CLI   DBSELMED,C'R'                                                    
         BNE   GETP34XY                                                         
         TM    DBBSTFLG,DBBSTLAT  GET LATEST BK MUST BE TURNED ON               
         JZ    GETP34XY                                                         
         OC    DBSELBK,DBSELBK                                                  
         BZ    GETP34XY                                                         
         CLI   DBDIVSOR,0                                                       
         BNE   GETP34XY                                                         
         CLI   DBFACTOR,0                                                       
         BNE   GETP34XY                                                         
         XC    DBSELBK,DBSELBK                                                  
         B     GETTP34M                                                         
*                                                                               
GETP34XY MVC   DBSELBK,SVSELBK                                                  
         MVC   DBSELPRG,SVSELPRG   RESET FOR CONDENSED RADIO MKTS               
*                                                                               
         CLI   DBVOPT,X'40'        ONLY RESTORE THIS FOR SPOT POSTING           
         BNE   GETP34XZ            THIS IS FOR THE 6AM AFFID RULE               
         CLI   DBSELMED,C'T'        6AM 2 MIN AFFID RULE ONLY FOR               
         BE    *+8                  USTV, OVERNIGHTS, FUSION                    
         CLI   DBSELMED,C'F'                                                    
         BNE   *+18                                                             
***      CLC   DBSELBK,=AL2(NOV_13)     THIS SHOULD BE DEC_15 IN PROD           
         CLC   DBSELBK,=AL2(DEC_15)  EFFECTIVE 3AM START BOOK                   
         BL    GETP34XZ                                                         
         B     GETP34XV                                                         
*                                                                               
         CLI   DBSELMED,C'O'                                                    
         BNE   GETP34XZ                                                         
***      CLC   DBSELBK,=X'7328'    SEP2815 1ST TEST 3A BOOK                     
         CLC   DBSELBK,=AL1(YR_2015,WEEK_50) DEC0715 2MIN RULE BOOK             
         BL    GETP34XZ                                                         
GETP34XV MVC   DBSELTIM,SVSELTIM   SO WE DONT AFFECT ANYONE ELSE                
*                                                                               
GETP34XZ MVI   DBERROR,EOF         YES - SET E-O-F & EXIT                       
         B     GETX                                                             
                                                                                
GETTP35  CLI   DBSELMED,C'U'                                                    
         BNE   *+14                                                             
         MVC   DBMINKEY(1),0(R1)   SET MINOR KEY DAY-ONLY FOR                   
         B     *+10                COUNTY COVERAGE                              
         MVC   DBMINKEY,0(R1)      SET MINOR KEY (DAY/QTR HOUR)                 
*                                                                               
GETTP35A CLI   TPRCNDS,C'Y'        PROCESSING A CONDENSED RADIO MKT?            
         BNE   GETTP35C                                                         
         MVC   TPSELPRG,DBSELPRG   SAVE REQUESTED PRG #                         
         MVC   TPDBFILE,DBFILE       "   FILE                                   
         XC    DBSELPRG,DBSELPRG    AND INITIALIZE THEM                         
         MVC   DBFILE,=C'RDP'                                                   
*                                                                               
GETTP35B BAS   RE,GETRDPT          GO GET DAYPART CODE                          
         MVC   DBMINKEY,DBSELPRG   ASSUME GET WAS SUCCESSFUL                    
         BE    GETTP36                                                          
         CLI   DBERROR,HORREND     IF IT DIDN'T, CHECK FOR CORRUPTNESS          
         BE    GETX                                                             
         MVC   DBSELPRG,TPSELPRG    OTHERWISE, FINISHED W/ CURRENT              
         MVC   DBFILE,TPDBFILE                                                  
         MVI   DBLSTNXT,0           DQNTRY--GET NEXT DQNTRY                     
         B     GETTP34                                                          
*                                                                               
GETTP35C DS    0H                                                               
         MVI   BADBTFLG,0           RESET                                       
****                                                                            
*&&DO                                                                           
* REMOVE DATA NO LONGER ON FILE                                                 
* FOR LIVE ONLY LOOKUPS FOR WEEK OF AUG2310                                     
* AND DAY LOOKUP FOR M/TU/W READ FOR LIVE+SAME DAY                              
* SINCE LIVE ONLY ONLY CAME BACK STARTING ON THURSDAY                           
         CLC   HALF,=AL1(YR_2010,WEEK_35)                                       
         BNE   GETTP35D                                                         
         CLI   DRMEDIA,C'O'                                                     
         BNE   GETTP35D                                                         
*                                                                               
         CLI   BOOKTYPE,C'L'         REQUESTED LIVE ONLY?                       
         BNE   GETP35CC                                                         
         XC    DBNDXDA,DBNDXDA                                                  
         MVI   DBBTYPE,BOOKTYPE_LS                                              
         MVI   DRBTYP,BOOKTYPE_LS                                               
         CLI   DBMINKEY,X'30'                                                   
         BNH   *+12                                                             
         MVI   DBBTYPE,C'L'                                                     
         MVI   DRBTYP,C'L'                                                      
*                                                                               
GETP35CC CLI   BOOKTYPE,C'U'         REQUESTED LIVE ONLY?                       
         BNE   GETP35CD                                                         
         XC    DBNDXDA,DBNDXDA                                                  
         MVI   DBBTYPE,BOOKTYPE_WS                                              
         MVI   DRBTYP,BOOKTYPE_WS                                               
         CLI   DBMINKEY,X'30'                                                   
         BNH   *+12                                                             
         MVI   DBBTYPE,C'U'                                                     
         MVI   DRBTYP,C'U'                                                      
*                                                                               
GETP35CD CLI   BOOKTYPE,C'Z'         REQUESTED LIVE ONLY?                       
         BNE   GETP35CE                                                         
         XC    DBNDXDA,DBNDXDA                                                  
         MVI   DBBTYPE,BOOKTYPE_WS                                              
         MVI   DRBTYP,BOOKTYPE_WS                                               
         CLI   DBMINKEY,X'30'                                                   
         BNH   *+12                                                             
         MVI   DBBTYPE,C'Z'                                                     
         MVI   DRBTYP,C'Z'                                                      
*                                                                               
GETP35CE CLI   BOOKTYPE,C'J'         REQUESTED LIVE ONLY?                       
         BNE   GETTP35D                                                         
         XC    DBNDXDA,DBNDXDA                                                  
         MVI   DBBTYPE,BOOKTYPE_HS                                              
         MVI   DRBTYP,BOOKTYPE_HS                                               
         CLI   DBMINKEY,X'30'                                                   
         BNH   *+12                                                             
         MVI   DBBTYPE,C'J'                                                     
         MVI   DRBTYP,C'J'                                                      
***                                                                             
*        if we are dealing with radar then feed in dayparts                     
*        DC    H'0'                                                             
*&&                                                                             
GETTP35D CLC   DBFILE,=C'RTP'                                                   
         BNE   GETTP35E                                                         
*                                                                               
         LARL  R1,RARDPTAB          YEP, SET ADDRESSES OF RDPTAB                
         ST    R1,TPATBLE                                                       
*                                                                               
*   SAVE CURRENT                                                                
         MVC   TPSELPRG,DBSELPRG   SAVE REQUESTED PRG #                         
         MVC   TPDBFILE,DBFILE       "   FILE                                   
         MVC   DBFILE,=C'RTP'                                                   
*                                                                               
         CLI   RDAYPART,C'Y'       IF SPECIFIC DAYPART REQUSETED                
         BNE   *+14                                                             
         MVC   DBMINKEY+1(1),DBSELPRG+1  USE IT                                 
         B     GETTP36                                                          
*                                                                               
         XC    DBSELPRG,DBSELPRG    AND INITIALIZE THEM                         
***      BAS   RE,GETRARDP         GO GET RADAR DAYPARTS                        
         BRAS  RE,GETRARDP         GO GET RADAR DAYPARTS                        
         MVC   DBMINKEY,DBSELPRG   ASSUME GET WAS SUCCESSFUL                    
*        BE    GETTP35F                                                         
         BE    GETTP36                                                          
         CLI   DBERROR,HORREND     IF IT DIDN'T, CHECK FOR CORRUPTNESS          
         BE    GETX                                                             
         MVC   DBSELPRG,TPSELPRG    OTHERWISE, FINISHED W/ CURRENT              
         MVC   DBFILE,TPDBFILE                                                  
         MVI   DBLSTNXT,0           DQNTRY--GET NEXT DQNTRY                     
         B     GETTP34                                                          
*                                                                               
*                                                                               
*                                                                               
GETTP35E DS    0H                                                               
         CLI   RDAYPART,C'Y'       FOR RADIO DAYPART FILE                       
         BNE   GETTP36                                                          
GETTP35F MVI   DBMINKEY+1,0        FORCE QH TO ZERO                             
         OC    DBSELPRG,DBSELPRG                                                
         BZ    GETTP36                                                          
         MVC   DBMINKEY+1(1),DBSELPRG+1                                         
*                                                                               
GETTP36  MVI   IOFLAG,FILE+HIGH+DEM                                             
         MVC   KEYSAVE,DRKEY                                                    
         GOTO1 AIO,IOFLAG                                                       
*                                                                               
         BL    GETX                                                             
         BE    GETTP42                                                          
*                                                                               
* ========RECORD NOT FOUND  ==================================                  
* TEST FOR DBERROR =X'10' NOT FOUND                                             
* TEST IF WE ARE PROCESSING SPLIT WEEK POSTING                                  
*                                                                               
         CLI   DBBEST,C'R'                                                      
         BE    GETTP36B                                                         
         CLI   DBSELMED,C'W'                                                    
         BNE   GETTP36B                                                         
         CLI   WKBKDFLG,C'2'       PROCESSING SAT/SUN SPLIT BK                  
         BNE   GETTP36B                                                         
*                                                                               
* IF SECOND PART OF SPLIT WEEK NOT AVAILABLE                                    
* THEN TRY 1ST WEEK OF NEXT YEAR                                                
*                                                                               
         CLI   DBERROR,NOTFOUND    IF NOT FOUND - EXIT                          
         BNE   GETTP36B                                                         
         CLI   WKBKD2+1,X'CA'      53RD WEEK LOOKUP?                            
         BE    *+8                                                              
         CLI   WKBKD2+1,X'C9'      54RD WEEK LOOKUP?                            
         BNE   GETX                                                             
         XC    DBNDXDA,DBNDXDA     RESET TO READ IT                             
         ZIC   RE,WKBKD2                                                        
         SHI   RE,1                                                             
         STC   RE,WKBKD2            AHEAD 1 YEAR                                
         MVI   WKBKD2+1,X'FE'       1ST WEEK OF YEAR                            
         MVC   DRBOOK,WKBKD2                                                    
         B     GETTP36                                                          
***      B     CHWKBKX              REREAD FOR 1ST WEEK OF YEAR                 
GETTP36B DS    0H                                                               
*                                                                               
* TRANSPARENCY CODE WHERE WE HAVE SUCCESSFULLY READ THE MAJOR KEY FOR           
* THE WEEK, BUT THE DAY IS NOT FOUND READING MINOR KEY FROM FILE                
* EX, IF M IS IN, BUT TUES IS NOT IN, TUESDAY LOOKUP WILL                       
* ERROR ON THE FILE READ HIGH.                                                  
*        CLI   DBERROR,X'80'       EOF?                                         
*        BNE   GETTP37                                                          
         CLI   DRMEDIA,C'O'                                                     
         BNE   GETTP37                                                          
         CLI   DRSRC,C'N'                                                       
         BNE   GETTP37                                                          
         OI    BADBTFLG,BADBTFIL   SET FLAG DONE TRANS FOR BAD BOOKTYPE         
         CLI   CABLEFLG,C'N'       STANDARD BOOKTYPE ONLY FOR BROADCAST         
         BNE   GETTP36C                                                         
         CLI   DBBTYPE,0           WE WERE LOOKING FOR STANDARD?                
         BNE   GETTP36C                                                         
         MVI   DBBTYPE,C'L'        TRY LIVE                                     
         MVI   DRBTYP,C'L'                                                      
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
*                                                                               
GETTP36C CLI   DBBTYPE,C'C'        WE WERE LOOKING FOR CABLE+7                  
         BNE   GETTP36D                                                         
         CLI   CABLEFLG,C'Y'       BOOKTYPE C ONLY FOR CABLE STATIONS           
         BNE   GETTP36D                                                         
         MVI   DBBTYPE,C'U'        TRY LIVE ONLY CABLE                          
         MVI   DRBTYP,C'U'                                                      
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
*                                                                               
GETTP36D CLI   DBBTYPE,C'W'        WE WERE LOOKING FOR WIRED L+7                
         BNE   GETTP36E                                                         
         MVI   DBBTYPE,C'Z'        TRY LIVE ONLY WIRED CABLE                    
         MVI   DRBTYP,C'Z'                                                      
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
*                                                                               
GETTP36E CLI   DBBTYPE,C'H'        WE WERE LOOKING FOR HISPANIC L+7             
         BNE   GETTP36F                                                         
         MVI   DBBTYPE,C'J'        TRY LIVE ONLY HISPANIC                       
         MVI   DRBTYP,C'J'                                                      
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
* TRANSPRENCY CODE FOR PARTIAL WEEK WHERE PART OF WEEK NOT IN YET               
* OVERNIGHTS LOOK FOR LIVE + SAME DAY IF LIVE ONLY IS NOT FOUND                 
* THIS WILL SOLVE THE ISSUE WHERE LIVE+SD IS NOT AVAILABLE                      
* UNTIL 1ST WEEK OF JAN2010 ON THURSDAY AND THE MAJOR                           
* KEY WILL BE AVAILABLE FOR LIVE ONLY BUT THE MINOR KEY                         
* FOR LIVE ONLY ENDS FOR WEDS - WE NEED TO REREAD THE DIR FOR LIVE+SD           
* FOR THURS-SUN OF THAT WEEK                                                    
GETTP36F CLI   DBBTYPE,C'J'                                                     
***      BNE   GETTP36G                                                         
         BNE   GETT36F2                                                         
* restore keysave because we dont have live anymore so the key last             
* read and found could have diff book or spill market as the next               
* found key..we end up getting wrong data for a day where                       
* live +7 data was not available yet and it breaks the transparency ode         
* code..for ex, wabc end up reading for phl spill market when live only         
* was not found since thats the next key read                                   
         MVC   DRKEY(L'KEYSAVE),KEYSAVE                                         
         MVI   DBBTYPE,BOOKTYPE_HS                                              
         MVI   DRBTYP,BOOKTYPE_HS                                               
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
GETT36F2 DS    0H                                                               
*                                                                               
*========================================================                       
* NEWLY ADDED - ALSO CHECK BOOKTYPE C FOR BROADCAST                             
* TRYING TO FIX BAD DAILIES RECORDS WHICH LOADED AS C                           
* USED TO BE 00->L->LS                                                          
* NOW        00->L->C->LS                                                       
* USED TO BE L3 DIDNT HAVE TRANSPARENCY                                         
* NOW        L3-C3                                                              
* ONLY DO THIS FOR SET OF STATIONS FOR WEEKS BETWEEN ....                       
*                                                                               
*                                                                               
         CLI   CABLEFLG,C'Y'       ONLY FOR BROACAST                            
         BE    GETTP36G            BECAUSE WBTS GOT LOADED AS CABLE             
         OC    SVALOCNT,SVALOCNT   DONT DO THIS FOR LOCCAB                      
         BNZ   GETTP36G                                                         
         CLI   SVBTYPE,0           ONLY DO IT FOR REQUEST BOOKTYPES             
         BE    *+8                 LIVE+7 AND L+3                               
         CLI   SVBTYPE,BOOKTYPE_L3                                              
         BNE   GETTP36G                                                         
         BRAS  RE,BADBTYPE         ONLY PROCESS THIS TRANSPARENCY CODE          
         BNE   GETTP36G            IF IT IS IN THE TABLE                        
         CLI   DBBTYPE,C'L'        FOR DEMO FILE                                
         BNE   GETT36F3                                                         
         MVC   DRKEY(L'KEYSAVE),KEYSAVE                                         
         MVI   DBBTYPE,C'C'                                                     
         MVI   DRBTYP,C'C'                                                      
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
GETT36F3 CLI   DBBTYPE,C'C'                                                     
         BNE   GETT36F4                                                         
         MVC   DRKEY(L'KEYSAVE),KEYSAVE                                         
         MVI   DBBTYPE,BOOKTYPE_LS                                              
         MVI   DRBTYP,BOOKTYPE_LS                                               
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
* WE NEVER HAD TRANSPARENCY FOR C3 SO STOP AT C3                                
GETT36F4 CLI   DBBTYPE,BOOKTYPE_L3                                              
         BNE   GETTP36G                                                         
         MVC   DRKEY(L'KEYSAVE),KEYSAVE                                         
         MVI   DBBTYPE,BOOKTYPE_C3                                              
         MVI   DRBTYP,BOOKTYPE_C3                                               
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
*                                                                               
*========================================================                       
GETTP36G CLI   DBBTYPE,C'L'                                                     
         BNE   GETTP36H                                                         
         CLI   CABLEFLG,C'N'              BOOKTYPE L ONLY FOR BROADCAST         
         BNE   GETTP36H                                                         
* restore keysave because we dont have live anymore so the key last             
* read and found could have diff book or spill market as the next               
* found key..we end up getting wrong data for a day where                       
* live +7 data was not available yet and it breaks the transparency ode         
* code..for ex, wabc end up reading for phl spill market when live only         
* was not found since thats the next key read                                   
         MVC   DRKEY(L'KEYSAVE),KEYSAVE                                         
         MVI   DBBTYPE,BOOKTYPE_LS                                              
         MVI   DRBTYP,BOOKTYPE_LS                                               
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
*                                                                               
GETTP36H CLI   DBBTYPE,C'U'                                                     
         BNE   GETTP36I                                                         
         CLI   CABLEFLG,C'Y'              BOOKTYPE U ONLY FOR CABLE             
         BNE   GETTP36I                                                         
* restore keysave because we dont have live anymore so the key last             
* read and found could have diff book or spill market as the next               
* found key..we end up getting wrong data for a day where                       
* live +7 data was not available yet and it breaks the transparency ode         
* code..for ex, wabc end up reading for phl spill market when live only         
* was not found since thats the next key read                                   
         MVC   DRKEY(L'KEYSAVE),KEYSAVE                                         
         MVI   DBBTYPE,BOOKTYPE_WS                                              
         MVI   DRBTYP,BOOKTYPE_WS                                               
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
*                                                                               
GETTP36I CLI   DBBTYPE,C'Z'                                                     
         BNE   GETTP37                                                          
* restore keysave because we dont have live anymore so the key last             
* read and found could have diff book or spill market as the next               
* found key..we end up getting wrong data for a day where                       
* live +7 data was not available yet and it breaks the transparency ode         
* code..for ex, wabc end up reading for phl spill market when live only         
* was not found since thats the next key read                                   
         MVC   DRKEY(L'KEYSAVE),KEYSAVE                                         
         MVI   DBBTYPE,BOOKTYPE_WS                                              
         MVI   DRBTYP,BOOKTYPE_WS                                               
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
*========================================================                       
                                                                                
* CODE IN CASE STATION LINKED HAS CHANGED TO ANOTHER                            
* ENTITY IN THE MIDDLE OF A WEEK WE NEED TO SEE IF THERE IS ANOTHER             
* LEVEL IN THE TABLE WE CAN LINK TO                                             
* FOR EXAMPLE ZCSN CHANGED FROM NO SPILL ON A MONDAY 2A-5A                      
* AND LATER.                                                                    
GETTP37  OC    ALOCNTRY,ALOCNTRY   DONT DO THIS FOR LOCCAB                      
         BZ    GETTP37A                                                         
                                                                                
         MVC   DBBTYPE,SVBTYPE  RESET THE BOOKTYPE FOR NEW LINK LOOKUP          
         BRAS  RE,LOCCABLK         GET NEW STATION/MKT/BOOKTYPE                 
         MVC   DRBTYP,DBBTYPE     SET BOOK TYPE FOR READ                        
         MVC   DRSTAT,DBSELSTA                                                  
         MVC   DRKMKT,DBSELMK                                                   
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
*                                                                               
*                                                                               
GETTP37A BAS   RE,EOFSEQ           SEE IF THERE ANY MORE TASKS TO DO            
         BE    GETTP42                                                          
         BNE   GETTP34                                                          
                                                                                
*                                  GET NEXT RECORD FOR DAY/QTR HOUR             
GETTP38  CLI   DBLSTNXT,1                                                       
         BNE   GETTP52                                                          
*                                                                               
         OC    TPAQH1ST,TPAQH1ST   QH IN PROCESS                                
         BZ    GETTP39                                                          
         LA    RE,TPREC            MOVE QH DATA TO SAVE AREA                    
         ST    RE,TPAR1ST         SAVE RECORD ADDRESS                           
         L     R1,DBAREC                                                        
         LA    RF,6                                                             
GETTP38A MVC   0(200,RE),0(R1)                                                  
         LA    RE,200(RE)                                                       
         LA    R1,200(R1)                                                       
         BCT   RF,GETTP38A                                                      
         L     RE,DBAREC           RELOCATE DBAQUART                            
         L     R1,TPAQH1ST                                                      
         SR    R1,RE                                                            
         LA    R1,TPREC(R1)                                                     
         ST    R1,TPAQH1ST                                                      
*                                                                               
GETTP39  DS    0H                                                               
         CLI   TPRCNDS,C'Y'        IF PROCESSING CONDENSED RADIO MKT,           
         BE    GETTP35B             GO BACK & READHI ON NEXT DPT CODE           
                                                                                
         MVI   IOFLAG,FILE+SEQ+DEM                                              
         GOTO1 AIO,IOFLAG                                                       
         BE    GETTP42                                                          
         BL    GETX                                                             
*                                                                               
GETTP39A BAS   RE,EOFSEQ           CHECK ANY SPECIAL TASKS TO DO                
         BE    GETTP42                                                          
*                                  SET TO GET NEXT DQTAB ENTRY                  
GETTP40  DS    0H                                                               
         TM    TPMODE,TPMEOFSQ      FIRST SEE IF WE'VE BEEN TO EOFSEQ           
         BO    GETTP40A              FOR THIS DQTAB ENTRY                       
         BAS   RE,EOFSEQ              NOPE, GO TO IT NOW                        
         BE    GETTP42                                                          
GETTP40A TM    TPMODE,TPMROVDP      SEE IF IN RADIO OVRNGHT DPT MODE            
         BNZ   *+8                                                              
         TM    TPMODE,TPMN2A6A      SEE IF IN NSI 2A-6A DATA    MODE            
         BZ    *+8                                                              
         BAS   RE,EOFSEQ             YEP, WE CAN TURN IT OFF NOW                
         MVI   DBLSTNXT,0                                                       
         XC    TPAQH1ST,TPAQH1ST                                                
         B     GETTP34                                                          
*                                                                               
GETTP42  DS    0H                                                               
         GOTO1 ATSTMRKT            CHECK FOR VALID MARKET                       
         BNE   GETTP12                                                          
GETTP42A DS    0H                                                               
*                                                                               
         L     R1,DBAREC                                                        
         ST    R1,TPDBARS                                                       
         AH    R1,DBDTADSP                                                      
         USING MARELEM,R1                                                       
         CLI   MARCODE,MARCODEQ    MARKET ELEMENT                               
         BNE   GETTP44                                                          
*********MVC   DBCNVDTE,MARDATE    REMOVED BY DEIS: JAN/2020                    
*&&DO                                                                           
* FOR FUSION WE WANT TO READ THE NSI UNVERSES HERE                              
         CLI   DBSELSRC,C'F'                                                    
         BNE   GETTP42B                                                         
         CLC   DBSPANAD,=F'0'                                                   
         BNE   GETTP42B                                                         
         BRAS  RE,NSIUNV                                                        
*&&                                                                             
GETTP42B DS    0H                                                               
*                                                                               
* LPM PRELIM VS PARALLEL CHECKING                                               
         CLI   DBINTMED,C'T'      USTV ONLY                                     
         JNE   GETTP44                                                          
         CLI   DBBTYPE,C'I'       HISPANIC LPM BOOK                             
         JE    *+8                                                              
         CLI   DBBTYPE,C'P'       LPM BOOK                                      
         JNE   GETTP44                                                          
         CLI   PRELIMOK,C'Y'                                                    
         JE    GETTP44                                                          
         J     GETTP44            ****DISABLE FOR NOW****                       
         CLC   MARNO,=H'101'      NY LPM - NON-CURRENCY VS. PARALLEL            
         JNE   GETTP44             IT'S NOT NY SO USE IT                        
         CLC   DBACTBK,=AL2(MAY_04) IS PARALLEL STARTING MAY/04                 
         JL    GETTP44A                                                         
         DROP  R1                                                               
*                                                                               
         USING QHELEM,R1                                                        
GETTP44  CLI   QHCODE,0            TEST E-O-R                                   
         BNE   *+12                                                             
GETTP44A MVI   DBLSTNXT,1          YES - GO GET NEXT RECORD                     
         B     GETTP38                                                          
         CLI   QHCODE,QHCODEQ      TEST QTR HOUR ELEMENT FOUND                  
         BNE   GETTP54             NO - GET NEXT ELEMENT                        
*                                                                               
         CLI   RDAYPART,C'Y'       READ FOR A SPECIFIC RADIO DAYPART            
         BNE   GETTP45                                                          
GETTP44B OC    DBSELPRG,DBSELPRG                                                
         BZ    GETTP45                                                          
         CLC   QHSQH,DBSELPRG+1    DAYPART IS ACTUALLY THE QUARTER HOUR         
         BE    GETTP45                                                          
         TM    TPMODE,TPMROVDP     IF RADIO-OVERNIGHT-DAYPART MODE,             
         BZ    *+12                                                             
         BAS   RE,EOFSEQ            TURN OFF THIS MODE AND                      
         B     GETTP40              RETURN TO NORMAL FLOW                       
         MVI   DBERROR,EOF                                                      
         B     GETX                                                             
*                                                                               
GETTP45  BAS   RE,SETDYQH                                                       
                                                                                
                                                                                
         MVC   TPSAVE(1),QHWKS     SAVE THE WEEKS                               
*&&DO                                                                           
* REMOVING THIS ON 10/18/19 - CODE IS NOT LONGER NEEDED BECAUSE                 
* THE DATA IS NO LONGER ON THE FILE - BPOO                                      
*                                                                               
*** FIX FOR NSI BOSTON - NSI SCREWED UP THE WEEKS FOR SEP/02                    
*** AND SEP/03 SHIFT THE WEEKS ONE WEEK EARLIER                                 
         L     RE,DBAREC                                                        
         TM    QHWKS,X'0F'                                                      
         BO    NSIWOK92                                                         
         CLC   0(3,RE),=C'RTN'      NSI TIME PERIOD                             
         BNE   NSIWOK92                                                         
         CLC   DBACTBK,=AL2(SEP_03) SEPT/03                                     
         BE    *+10                                                             
         CLC   DBACTBK,=AL2(SEP_02) AND SEPT/02                                 
         BNE   NSIWOK92                                                         
         MVC   DUB(1),QHWKS         PREPARE FOR SHIFT                           
         NI    DUB,B'00001111'      ZAP THE CONTROL BITS                        
         ZIC   RE,DUB                                                           
         SLL   RE,1                 SHIFT THE WEEKS                             
         STC   RE,DUB                                                           
         NI    QHWKS,B'11110000'    ZAP THE WEEK BITS IN RECORD                 
         OC    QHWKS,DUB            RESET TO SHIFTED WEEKS                      
*&&                                                                             
**************************                                                      
*                                                                               
*                                                                               
NSIWOK92 CLI   DBSELMED,C'U'       COUNTY COVG DON'T TEST SAME QH               
         BE    *+8                                                              
         CLI   DBSELWKN,X'FF'      TEST 'ALL' WEEKS REQUIRED                    
         BE    *+14                                                             
         CLC   SVQHSQH,DBLSTSQH    TEST THIS SAME AS LAST QTR HOUR              
         BE    GETTP54             YES - IGNORE                                 
*                                  APPLY DAY/TIME CRITERIA                      
         L     RE,ADQNTRY                                                       
DBDQ     USING DBDQD,RE            RE=A(DQTAB ENTRY)                            
         CLC   SVQHDAY,DBDQ.DBDQKDAY    TEST IF DAY FOUND                       
         BL    GETTP54             LOW - GET NEXT ELEMENT                       
****     BH    GETTP40             HIGH - GET NEXT DQTAB ENTRY                  
         BH    GETTP45C            IS THERE A CABLE LINK??                      
         CLI   TPRCNDS,C'Y'        IF PROCESSING CONDENSED RADIO MKT,           
         BNE   GETTP45B                                                         
         CLI   DBSELPRG+1,12        AND DAYPART CODE IS 12,                     
         BNE   GETTP45B                                                         
         MVI   SVQHSQH,QX5A          FUDGE TO TEST AGAINST                      
         MVI   SVQHEQH,QX6A-1         5A-6A LIMITS                              
*                                                                               
GETTP45B DS    0H                                                               
* RDP DONT CHECK WITHIN LIMIT                                                   
* WE READ FOR A SPECIFIC DAYPART NUMBER                                         
         CLC   =C'RDP',DBFILE                                                   
         BE    GETTP45D                                                         
                                                                                
         CLC   DBDQ.DBDQSQH,SVQHEQH   QTR HOUR WITHIN LIMITS?                   
         BH    GETTP54                                                          
         CLC   DBDQ.DBDQEQH,SVQHSQH                                             
***      BL    GETTP40                                                          
         BNL   GETTP45D                                                         
*                                                                               
* WE DIDNT FIND THE MINOR KEY FOR THIS CALL LETTER FOR DAY AND QH               
* WE GOT HERE BECAUSE THE CALL LETTER CHANGED THE BEGINNING OF THE              
* NIELSEN DAY -2A FOR THE PREVIOUS DAY                                          
* CHECK TO SEE IF A NEXT CALL LETTER LINK IS AVAILABLE                          
GETTP45C DS    0C                                                               
*                                                                               
*===================================================                            
* NEWEST CODE TO FIX BAD BROADCAST LOADED AS CABLE                              
* WHERE THE FULL WEEK IS ALREADY IN BUT SOME DAYS ARE LOADED                    
* AS CABLE OTHER DAYS LOADED AS STANDARD                                        
* NORMALLY THE TRANSPARENCY CODE WOULD HAVE ALREADY RAN                         
* @GETTP36B WHEN WE HAVE PARTIAL WEEK FOR A MAJOR KEY                           
* FOR THE CURRENT WEEK IF WE HAVE M-W LIVE+7 DATA IN BUT TH-F IS NOT IN         
* YET, DAY IS ON MINOR KEY SO READING TH WOULD RESULT IN NOT FOUND              
* AND WE FALL DOWN TO THE TRANSPARENCY CODE.                                    
*                                                                               
* IN THIS SCENARIO THE MAJOR KEY IS FOUND IN THE DIR READ                       
* BUT THE DATA IS LOADED FOR TH CORRECTLY WITH THE CORRECT STANDARD             
* BOOKTYPE, BUT M-W WAS LOADED INCORRECTLY FOR THE WRONG CABLE BOOKTYPE         
* WE WOULD NOT FAIL THE READ HI ON THE FILE AND NOT GO THROUGH THE              
* TRANSPARENCY CODE.                                                            
*                                                                               
*  ADD CODE TO SIMPLY CHECK WHICH MAJOR KEY WE READ                             
*  AND READ THE OTHER CORRESPONDING BOOKTYPE.  SOMETIMES THE MAJOR KEY          
*  IS READ FOR THE CABLE BOOTKYPE DUE TO NEW TRANSPARENCY CODE                  
*  BUT SOME DAYS WERE LOADED UNDER STANDARD                                     
*  SOMETIMES THE MAJOR KEY IS READ FOR THE STANDARD BOOKTYPE BUT                
*  SOME DAYS WERE LOADED UNDER CABLE INCORRECTLY                                
*                                                                               
         CLI   DBSELMED,C'O'                                                    
         BNE   GETT45C2                                                         
         CLI   DBSELSRC,C'N'                                                    
         BNE   GETT45C2                                                         
         CLI   CABLEFLG,C'Y'                                                    
         BE    GETT45C2                                                         
         CLI   SVBTYPE,0           ONLY DO IT FOR REQUEST BOOKTYPES             
         BE    *+8                 LIVE+7 AND L+3                               
         CLI   SVBTYPE,BOOKTYPE_L3                                              
         BNE   GETT45C2                                                         
         BRAS  RE,BADBTYPE         ONLY PROCESS THIS TRANSPARENCY CODE          
         BNE   GETT45C2            IF IT IS IN THE TABLE                        
***      TM    BADBTFLG,BADBTDIR   ONLY DO IT IF DIRECORY READ FOR BAD          
***      BZ    GETT45C2            BOOKTYPE IN TRANSPARENCY CODE                
         TM    BADBTFLG,BADBTFIL   DID TRANSPARENCY FOR FILE DONT DO            
         BO    GETT45C2            AGAIN ELSE INFINITE LOOP                     
         OC    SVALOCNT,SVALOCNT   DONT DO THIS FOR LOCAL CABLE                 
         BNZ   GETT45C2            LOGIC IS COMPLICATED TO LOOP BACK            
* HAVE TO ALWAYS DO THIS - WHEN WE HAVE A WEEK LIKE WBTS SEP3019                
* M-W IS LOADED AS BOOKTYPE C WHILE TH-F IS LOADED AS STANDARD                  
* IF WE READ FOR STANDARD BOOKTYPE FOR MONDAY WE WOULD HAVE FOUND THE           
* MAJOR KEY FOR STANDARD BOOKTYPE THE FILE READ HIGH WOULD NOT ERROR            
* IT WOULD FIND A HIGHGER DAY (THUR) AND NEVER GO THROUGH TO THE                
* TRANSPARENCY CODE)                                                            
* WE SHOULD HAVE LIST OF STATIONS THIS LIMITS TO                                
         OI    BADBTFLG,BADBTFIL   TURN ON - ONLY DO TRANSPARENCY ONCE          
         MVC   DRKEY(L'KEYSAVE),KEYSAVE                                         
* IF WE READ STANDARD THIS DAY OF MAJOR KEY COULD HAVE BE LOADED                
* UNDER C BY ACCIDENT                                                           
* IF WE READ L3 THIS DAY OF MAJOR KEY COULD HAVE BE LOADED                      
* UNDER C3 BY ACCIDENT                                                          
* IF WE READ C THIS DAY OF MAJOR KEY COULD HAVE BE LOADED                       
* UNDER 00 COORECTLY                                                            
* IF WE READ C3 THIS DAY OF MAJOR KEY COULD HAVE BE LOADED                      
* UNDER L3 CORRECTLY                                                            
* RETRY READING THE FILE FOR THE OTHER BOOKTYPE ONE TIME!                       
         CLI   DBBTYPE,C'C'                                                     
         BNE   *+16                                                             
         MVI   DBBTYPE,0                                                        
         MVI   DRBTYP,0                                                         
         B     GETT45C1                                                         
*                                                                               
         CLI   DBBTYPE,0                                                        
         BNE   *+16                                                             
         MVI   DBBTYPE,C'C'                                                     
         MVI   DRBTYP,C'C'                                                      
         B     GETT45C1                                                         
*                                                                               
         CLI   DBBTYPE,BOOKTYPE_L3                                              
         BNE   *+16                                                             
         MVI   DBBTYPE,BOOKTYPE_C3                                              
         MVI   DRBTYP,BOOKTYPE_C3                                               
         B     GETT45C1                                                         
*                                                                               
         CLI   DBBTYPE,BOOKTYPE_C3                                              
         BNE   *+16                                                             
         MVI   DBBTYPE,BOOKTYPE_L3                                              
         MVI   DRBTYP,BOOKTYPE_L3                                               
         B     GETT45C1                                                         
*                                                                               
GETT45C1 XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
*                                                                               
*===================================================                            
GETT45C2 DS    0H                                                               
         OC    ALOCNTRY,ALOCNTRY   IS THERE A NEXT LINK SUPPLIED?               
         BZ    GETTP40                                                          
         CLC   ALOCNTRY,SVALOCNT   IS THERE ANOTHER LINK?                       
         BE    GETTP40             DONT RELOOK THE SAME LINK                    
                                                                                
         BRAS  RE,LOCCABLK         GET NEW STATION/MKT/BOOKTYPE                 
         MVC   DRBTYP,DBBTYPE     SET BOOK TYPE FOR READ                        
         MVC   DRSTAT,DBSELSTA                                                  
         MVC   DRKMKT,DBSELMK                                                   
         XC    DBNDXDA,DBNDXDA                                                  
         B     GETTP36                                                          
GETTP45D DS    0C                                                               
* IF WE HAVE SUCCESFULLY READ THE MINOR KEY THEN RESET ALOCNTRY                 
* TO THE 1ST LINK FOR THE DUMMY CALL LETTER IN THE TABLE                        
* SO SUBSEQUENT CALLS WHICH FAIL CAN LOOK FOR THE APPROPRIATE LINK              
* FROM THE BEGINNING AGAIN                                                      
         MVC   ALOCNTRY,SVALOCNT                                                
*                                                                               
         OC    TPAQH1ST(4),TPAQH1ST SAVE FIRST ELEM THIS QH                     
         BNZ   *+14                                                             
         ST    R1,TPAQH1ST         SAVE 1ST ELEM ADDR                           
         MVC   TPAR1ST,DBAREC                                                   
         B     FOLY00                                                           
*                                                                               
* SPECIAL STUFF FOR FEB/92 OLYMPICS - MISSING AVERAGES                          
*                                                                               
FOLY00   DS    0H                                                               
*&&DO                                                                           
*** TAKE OUT OLD CODE***                                                        
*        CLC   DBLSTBK,=AL2(FEB_94) FOR FEB/94                                  
*        BE    *+10                                                             
         CLC   DBLSTBK,=AL2(NOV_01) SAN FRAN/SACR MISSING 4TH WK                
         BE    SSMISS                                                           
         CLC   DBLSTBK,=AL2(JUL_96) FOR JUL/96                                  
         BE    *+10                                                             
         CLC   DBLSTBK,=AL2(FEB_92) FOR FEB/92                                  
         BNE   FOLYX                                                            
*&&DO                                                                           
         CLI   DBBTYPE,C'O'        OLYMPIC TAPE                                 
*&&                                                                             
         CLI   BOOKTYPE,C'O'       OLYMPIC TAPE                                 
         BNE   FOLYX                                                            
*        CLI   QHWKS,3             PROBLEM CONDITION WK 1-2                     
*        BE    *+8                                                              
*        CLI   QHWKS,9             PROBLEM CONDITION WK 1-4                     
*        BNE   FOLYX                                                            
         TM    QHWKS,X'09'         WEEKS 1 OR 4 INCLUDED                        
         BZ    FOLYX                                                            
         B     FOLY1                                                            
*                                                                               
SSMISS   TM    QHWKS,X'0E'         3 WEEK AVERAGE                               
         BNO   FOLYX                                                            
         CLI   QHDAY,X'60'         ONLY SATURDAY IS BAD                         
         BNE   FOLYX                                                            
         CLI   DBBTYPE,C'H'        HISPANIC SAPLE IS OK                         
         BE    FOLYX                                                            
         CLC   DBACTRMK,=H'407'    ONLY SAN FRAN                                
         BE    *+14                                                             
         CLC   DBACTRMK,=H'462'    OR SACREMENTO                                
         BNE   FOLYX                                                            
         TM    QHWKS,X'01'         CAN'T HAVE WEEK 4                            
         BO    FOLYX                                                            
*                                                                               
* LOOK AHEAD FOR ANOTHER AVERAGE WEEK ELEMENT                                   
FOLY1    LR    RF,R1                                                            
FOLY2    ZIC   R0,1(RF)                                                         
         AR    RF,R0                                                            
         CLI   0(RF),0             NONE FOUND USE THIS ONE                      
         BE    FOLY3                                                            
         CLI   0(RF),QHCODEQ                                                    
         BNE   FOLY2                                                            
         CLC   QHSQH,QHSQH-QHELEM(RF)                                           
         BE    FOLYX                   USE CURRENT ONE                          
FOLY3    OI    QHWKS-QHELEM(R1),X'2F'                                           
FOLYX    SR    RF,RF                                                            
*&&                                                                             
*                                  OLD FILE FORMAT FILTERS                      
         CLI   DBSELWKN,X'FF'      TEST 'ALL' WEEKS REQUIRED                    
         BE    GETTP50             YES - DON'T APPLY FILTERS                    
*                                                                               
*&&DO                                                                           
*** DEIS JAN/2020: OBSOLETE COMPRESSED DATE CODE NOW DISABLED                   
         CLC   DBCNVDTE,=X'ACE4'   JUL4/86 STARTS CANADIAN WEEKLY               
         BH    *+12                                                             
         CLI   DBSELMED,C'C'       CANADIAN FILES DONT HAVE TT BIT              
         BE    *+14                TREAT AS OLD BOOK                            
*&&                                                                             
         CLC   DBLSTBK,NEWBOOK                                                  
         BNL   GETTP46                                                          
*                                                                               
         TM    QHWKS,X'10'         TEST 2WK AVERAGE FOUND                       
         BZ    GETTP50             NO - THIS WILL DO                            
         CLI   DBTPSEL,C'2'        YES - TEST USER WANTS 2WK                    
         BE    GETTP50             YES - THIS WILL DO                           
         B     GETTP54             NO - WAIT FOR 4WK AVERAGE                    
*                                  HANDLE 1WEEK DATA OPTIONS                    
GETTP46  ICM   RF,1,DBACT1WK                                                    
         BZ    GETTP47                                                          
         EX    RF,*+8              TEST SPECIFIC WEEK BIT ON                    
         B     *+8                                                              
         TM    QHWKS,0                                                          
         BNZ   GETTP50             WEEK DATA FOUND                              
*                                  NEW FILE FORMAT FILTERS                      
GETTP47  CLI   DBTPTT,C'P'         TEST TIME PERIOD WANTED                      
         BNE   GETTP48             NO - USE TYPICAL TIME FILTERS                
*                                                                               
         CLI   DBSELMED,C'W'       WEEKLY WILL NO LONGER HAVE                   
         BE    GETTP48             THE 4 WK NUMBER IN IT                        
*                                  ACCORDING THE NIELSEN -07/2007               
*                                  no one is accessing the 4wk rolling          
*                                  avg- protective code                         
*                                                                               
         TM    QHWKS,X'10'         TEST 2WK AVERAGE FOUND                       
         BNZ   GETTP54             YES - WAIT FOR 4WK AVERAGE                   
         TM    QHWKS,X'0F'         TEST 4WK AVERAGE FOUND                       
         BO    GETTP50             YES - THIS WILL DO                           
         CLI   DBSELMED,C'C'                                                    
         BNE   GETTP54                                                          
         TM    QHWKS,X'0E'                                                      
         BO    GETTP50                                                          
         B     GETTP54             NO - WAIT FOR IT                             
*                                  TYPICAL TIME FILTERS                         
GETTP48  MVC   DUB(1),QHWKS        DUB FOR 1 = NO. OF WEEKS                     
         NI    DUB,X'0F'                                                        
         ZIC   RF,DUB                                                           
         IC    RF,WEEKTAB(RF)                                                   
         STC   RF,DUB                                                           
         STC   RF,TPQHWKS                                                       
******   TEMP FIX FOR CONVERSION PROBLEM - REMOVE WHEN FIXED*****               
         CLI   DBBTYPE,C'A'                                                     
         BNE   BTATEMPX                                                         
         CLI   DUB,2                                                            
         BL    BTATEMPX                                                         
         OI    QHWKS,X'20'                                                      
* *********************************************************                     
BTATEMPX CLI   DBSELMED,C'U'       QHWKS DOESNT APPLY TO COUNTY                 
         BE    GETTP48A            COVERAGE                                     
         TM    QHWKS,X'20'         TEST TYPICAL TIME                            
         BNZ   *+14                                                             
         MVC   DBLSTQHW,DUB        SAVE NO. OF WEEKS                            
         B     GETTP54                                                          
GETTP48A DS    0H                                                               
         CLI   DBTT211,C'Y'                                                     
         BNE   GETTP49                                                          
         CLI   DUB,2               TEST THIS IS 2W AVG                          
         BNE   GETTP50             NO - THEN WE WANT IT                         
         CLI   DBLSTQHW,1          PREV WAS 1W                                  
         BNE   GETTP49                                                          
*RZ      CLC   DBLSTBK,=AL2(JUL_84) ONLY FOR JULY 1984 BOOK                     
*RZ      BNE   GETTP49                                                          
*RZ      B     GETTP54                                                          
*                                                                               
GETTP49  DS    0H                                                               
         TM    QHWKS,X'10'         2W FOLLOWED BY 4W                            
         BZ    GETTP50                                                          
         CLI   DBTPSEL,C'2'        DO WE WANT 2W                                
         BNE   GETTP54                                                          
*                                                                               
GETTP50  ST    R1,DBAQUART                                                      
         ST    R1,TPDBAQHS         SAVE THE QH ELEM                             
         MVC   QHWKS,TPSAVE        RESTORE THE WEEKS                            
*                                                                               
* SPORTS PROGRAMMING OPTIONS                                                    
         CLI   DBSELSPO,0          ANY SPORTS FILTER 'Y' OR 'N'                 
         BE    GSPORTX                                                          
         CLI   DBSELSRC,C'N'       ONLY FOR NSI                                 
         BNE   GSPORTX                                                          
*                                                                               
         BRAS  RE,SPORTTYP         CHECK IF SPORT-TYPE PROGRAM                  
         BNE   GSPORTN                                                          
GSPORTY  CLI   DBSELSPO,C'Y'       THIS IS A SPORT-TYPE PROGRAM                 
         BE    GSPKEEP              LOOKING FOR SPORTS, KEEP                    
         B     GSPREJCT             LOOKING FOR NON-SPORTS, REJECT              
GSPORTN  CLI   DBSELSPO,C'Y'       THIS IS NOT A SPORT-TYPE PROGRAM             
         BE    GSPREJCT             LOOKING FOR SPORTS, REJECT                  
         B     GSPKEEP              LOOKING FOR NON-SPORTS, KEEP                
GSPREJCT MVI   DBMODE,DBMNEXT      REJECT                                       
         MVI   DBLSTNXT,2                                                       
         MVC   DBLSTSQH,SVQHSQH                                                 
         B     GETTP52                                                          
GSPKEEP  DS    0X                                                               
         L     RE,ADQNTRY          RESTORE RE=A(DQTAB ENTRY)                    
GSPORTX  DS    0X                                                               
*                                                                               
         L     R1,DBAQUART                                                      
*                                                                               
         MVC   DBLSTSQH,SVQHSQH                                                 
         MVC   DUB(1),DBDQ.DBDQSQH SET DUB(2)=ACTUAL START/END QTR HOUR         
         CLC   DBDQ.DBDQSQH,SVQHSQH                                             
         BH    *+10                                                             
         MVC   DUB(1),SVQHSQH                                                   
         MVC   DUB+1(1),DBDQ.DBDQEQH                                            
         CLC   DBDQ.DBDQEQH,SVQHEQH                                             
         BNH   *+10                                                             
         MVC   DUB+1(1),SVQHEQH                                                 
* FOR RDP DAYPART RADIO  -                                                      
* ALWAYS TAKE TRUE DURATION OF PROGRAM FROM RECORD                              
         CLC   =C'RDP',DBFILE                                                   
         BNE   GETTP50_01                                                       
         MVC   DUB(1),SVQHSQH                                                   
         MVC   DUB+1(1),SVQHEQH                                                 
         CLI   DUB+1,X'FF'                                                      
         BNE   *+8                                                              
         MVI   DUB+1,0                                                          
*                                                                               
GETTP50_01 DS  0H                                                               
         MVC   DBACTSQC(2),DUB     SET AS 'CURRENT' VALUES IN DBLOCK            
*                                                                               
         ZIC   R0,DUB              CALCULATE QTR HOUR WEIGHTING                 
         ZIC   R1,DUB+1            (ENDQH+1-STARTQH)*DAYS                       
         LA    R1,1(R1)                                                         
         SR    R1,R0                                                            
                                                                                
*  RADIO RDP - IF DAYPART RECORD END QH IS LESS THAN START THAT MEANS           
*  ENTIRE DAY LOOKUP OR CROSSING THE DAY                                        
         OC    DBSELPRG,DBSELPRG                                                
         BZ    GETTP50B                                                         
         CLC   =C'RDP',DBFILE                                                   
         BNE   GETTP50B                                                         
         CHI   R1,0                ALL DAY                                      
         BE    GETTP50A                                                         
         BNL   GETTP50B                                                         
* NEGATIVE NUMBER END QHR <START QH = CROSSING OF DAY                           
* THEN WE HAVE TO ADD THE NUMBER OF QH FROM DAY1 TO DAY 2                       
*&&DO                                                                           
         ZIC   R0,DUB              CALCULATE QTR HOUR WEIGHTING                 
         ZIC   R1,DUB+1            (ENDQH+1-STARTQH)*DAYS                       
         LA    R1,1(R1)                                                         
         AR    R1,R0                                                            
         B     GETTP50B                                                         
*&&                                                                             
* THE ABOV LOGIC WAS WRONG. REPLACE WITH FOLLOWING CODE                         
* IF NEGATIVE NUMBER END QTR<START QH = CROSSING THE DAY                        
* THEN (SUBTRACT END OF DAY 5F-START QH+1)+END QH = TOTAL DURATION              
*                                                                               
         ZIC   R0,DUB              CALCULATE QTR HOUR WEIGHTING                 
         LA    R1,96                                                            
         SR    R1,R0                                                            
         ZIC   R0,DUB+1                                                         
         AHI   R0,1                                                             
         AR    R1,R0                                                            
         B     GETTP50B                                                         
*                                                                               
*                                                                               
GETTP50A LA    R1,96                                                            
*                                                                               
*                                                                               
GETTP50B ZIC   R0,DBDQ.DBDQDAYW                                                 
         MR    R0,R0                                                            
         DROP  DBDQ                                                             
*                                                                               
* ABC INSISTS THAT THEY WANT WEEKLY WEIGHTING 3/25/98                           
* WHEN YOU GET HERE BECAUSE THEY DONT - CURSE DAVE DANIELS                      
         CLI   DBPRGDUR,C'Y'       ABC WEEK WEIGHTING                           
         BNE   ABCCRAPX            NO - IGNORE THIS CRAP                        
         ZIC   R0,TPQHWKS          YES - WEIGHT BY NUMBER OF WEEKS              
         MR    R0,R0                                                            
ABCCRAPX DS    0C                                                               
*                                                                               
* new code to get rid of calling degettp multiple times for the same            
* spot date for canadian new methodology posting                                
* there is a dup count in the spot table passed in for each spot date           
* multiply r1 by dbactdup                                                       
*                                                                               
         IF    (CLI,DBNPMFLG,EQ,DBNPMACH),AND,                                  
               (OC,SPTTBPTR,SPTTBPTR,NZ),AND,                                   
               (CLI,DBVOPT,E,X'40')                                             
           ZIC   R0,DBACTDUP                                                    
           MR    R0,R0                                                          
         ENDIF                                                                  
                                                                                
*                                                                               
* NEW CODE - FULL WORD DIVSOR                                                   
         L     RE,DBDIVSR2                                                      
         AR    RE,R1                                                            
         ST    RE,DBDIVSR2                                                      
                                                                                
         STH   R1,DBFACTOR                                                      
         AH    R1,DBDIVSOR         ACCUMULATE TOTAL WEIGHTING                   
         STH   R1,DBDIVSOR                                                      
* PATCH THIS IN TO GET PROGRAM NAMES ON OVERNIGHTS                              
*        B     BYPOPN <-------------BYPASS OPN ROUTINE                          
RDPFACTB CLI   DBSELMED,C'O'       OVERNITE - GET PROGRAM NAME                  
         BNE   *+8                                                              
         BRAS  RE,OPNGET                                                        
BYPOPN   DS    0C                                                               
*                                  RETURN TO CALLER                             
         MVI   DBRECTYP,DBRECDEM                                                
         MVI   DBMODE,DBMNEXT                                                   
         MVI   DBLSTNXT,2          FORCE ENTRY TO GETTP52                       
*                                                                               
*      ARB RADIO ASALE TAPE REQUIRES AUTHORIZATION                              
         TM    DBCADI,DBORADI      ADI OK FOR ARB/RADIO                         
         BO    GETTP51                                                          
         CLI   DBSELMED,C'R'                                                    
         BNE   GETTP51                                                          
         CLI   DBSELSRC,C'A'                                                    
         BNE   GETTP51                                                          
         L     R1,DBAQUART         CHECK SECTION LEAD ELEMENT                   
GETTP50D CLI   0(R1),X'00'                                                      
         BE    GETTP51                                                          
         CLI   0(R1),X'23'         SECTION LEAD ELEMENT                         
         BE    GETTP50F                                                         
GETTP50E ZIC   RE,1(R1)                                                         
         AR    R1,RE                                                            
         B     GETTP50D                                                         
GETTP50F CLI   2(R1),X'03'         AND ADI                                      
         BNE   GETTP50E                                                         
         MVI   2(R1),X'FF'         HIDE THE DATA                                
*                                                                               
* FOR FUSION WE WANT TO READ THE NSI UNVERSES HERE                              
GETTP51  CLI   DBSELSRC,C'F'                                                    
         BNE   GETTP51X                                                         
                                                                                
         BRAS  RE,NSIUNV                                                        
GETTP51X DS    0H                                                               
***      CLI   DBSELMED,C'T'                                                    
***      BNE   *+18                                                             
***      OC    DBSELSYC,DBSELSYC                                                
***      BZ    *+8                                                              
***      BRAS  RE,FUSUEST                                                       
*                                                                               
* find program name and see if we are off air for adsm or TOON                  
*&&DO                                                                           
         BRAS  RE,GETPNAME                                                      
         CLC   =C'ADSM',DRSTAT                                                  
         BE    *+10                                                             
         CLC   =C'TOON',DRSTAT                                                  
         BNE   GETTP51Y                                                         
         CLC   =C'OFF AIR',PRGNAME  DONT RETURN OFF AIR PROGRAMS                
         BE    GETTP51Z             FOR ADSM OR TOON                            
*&&                                                                             
*&&DO                                                                           
         CLC   =C'TOON',DRSTAT                                                  
         BNE   *+8                                                              
         B     *+4                                                              
         CLC   =C'OFF AIR',PRGNAME                                              
         BNE   GETTP51Z                                                         
         CLC   =C'ADSM',DRSTAT                                                  
         BNE   *+14                                                             
         MVC   DRSTAT,=C'TOONT'                                                 
         B     GETTP51Y                                                         
         CLC   =C'TOON',DRSTAT                                                  
         BNE   *+10                                                             
         MVC   DRSTAT,=C'ADSMT'                                                 
GETTP51Y DS    0C                                                               
***      MVI   DBDQPTR,0           START FROM BEGINNING OF DQTAB                
         ZIC   RE,DBDQPTR          REWIND BACK ONE BECAUSE WE                   
         SHI   RE,1                FAILED LOOKUP AND HAVE TO RELOOK             
         STC   RE,DBDQPTR          UP WITH CHANGED STATION                      
         B     GETTP24G                                                         
*                                                                               
GETTP51Z DS    0C                                                               
*&&                                                                             
*                                                                               
GETTP51Y DS    0C                                                               
         BAS   RE,GETX                                                          
GETTP51Z DS    0C                                                               
         MVC   DBINTFIL(2),SVINTFIL  (THESE WERE SAVED BEFORE HOOK)             
         MVC   DBAREC,TPDBARS                                                   
         MVC   DBAQUART,TPDBAQHS                                                
         XC    TPAQH1ST(4),TPAQH1ST                                             
*                                  ENTRY HERE ON SEQUENTIAL MODE                
GETTP52  L     R1,DBAQUART                                                      
         L     RE,ADQNTRY                                                       
DBDQ     USING DBDQD,RE                                                         
         CLI   DBSELWKN,X'FF'      TEST 'ALL' WEEKS REQUIRED                    
         BNE   GETTP53                                                          
         CLC   SVQHEQH,DBDQ.DBDQEQH  YES - GET NEXT IF LAST QHR LEQ END         
         BH    GETTP40                                                          
         B     GETTP54                                                          
GETTP53  MVI   DBLSTQHW,0                                                       
         CLI   DBSELMED,C'U'       CONTINUE FOR COUNTY CONVG                    
         BE    *+14                                                             
         CLC   SVQHEQH,DBDQ.DBDQEQH  TEST ALL QTR HOURS PROCESSED               
         BNL   GETTP40                                                          
*                                  BUMP TO NEXT ELEMENT                         
GETTP54  SR    R0,R0                                                            
         ICM   R0,1,1(R1)                                                       
         BNZ   *+8                                                              
         B     GETTP40                                                          
         AR    R1,R0                                                            
         B     GETTP44                                                          
         DROP  R1,DBDQ                                                          
*                                                                               
         EJECT                                                                  
***********************************************************************         
***********************************************************************         
*&&DO                                                                           
GETRARDP NTR1                                                                   
*                                                                               
         L     R3,TPATBLE          RE-->SECTN OF RAD DPT TAB W/ KEY DAY         
*        LA    R3,RARDPTAB                                                      
         USING RDPTABD,R3                                                       
GETRAR10 DS    0H                                                               
***      CLI   0(R3),0                                                          
***      BE    GETRANO                                                          
*                                                                               
         CLC   DBDQKDAY,RDPDAY      MATCH TO ENTRY IN RAD DPT TABLE             
         BE    GETRAR15                                                         
GETRAR12 ZIC   R0,RDPLEN                                                        
         AR    R3,R0                                                            
*        C     R3,TPATBLEX         BETTER NOT PASS EOTABLE!                     
         CLI   0(R3),0                                                          
         BE    GETRANO                                                          
         B     GETRAR10                                                         
*                                                                               
*                                                                               
*&&DO                                                                           
         CLC   DBDQEQH,RDPQXS                                                   
         BL    GRD20                                                            
         CLC   DBDQSQH,RDPQXE                                                   
         BH    GRD20                                                            
*&&                                                                             
*        CLC   RDPQXS,DBDQSQH                                                   
*        BE    GETRAR30                                                         
GETRAR15 CLC   DBDQKDAY,RDPDAY      MATCH TO ENTRY IN RAD DPT TABLE             
         BNE   GETRANO                                                          
         CLC   DBDQEQH,RDPQXS                                                   
         BL    GETRAR12                                                         
*        BL    GETRAR20                                                         
*ETRAR20 LA    R3,5(R3)                                                         
*        B     GETRAR10                                                         
*ETRAR30 CLC   RDPQXE,DBDQEQH                                                   
*        BNE   GETRAR20                                                         
GETRAR30 DS   0H                                                                
         CLC   DBDQSQH,RDPQXE                                                   
         BH    GETRAR12                                                         
         MVC   DBSELPRG(1),RDPDAY     GET KEY DAY                               
         MVC   DBSELPRG+1(1),RDPDPT   GET DAYPART CODE                          
         B     GETRAYES                                                         
*                                                                               
GETRANO  CR    RA,RB                                                            
         BNE   GETRAX                                                           
GETRAYES CR    RB,RB                                                            
         BE    GETRAX                                                           
*                                                                               
GETRAX   XIT1                                                                   
*&&                                                                             
***********************************************************************         
* INITIALISATION CODE                                                 *         
***********************************************************************         
         SPACE 1                                                                
INIT     NTR1  ,                                                                
*                                                                               
*                                                                               
         CLI   DBSELDAY,X'79'      CODE TO SWITCH ROTATION                      
         BNE   INIT60              FOR M-TH,SU                                  
         CLI   DBSELSRC,C'N'                                                    
         BNE   INIT60                                                           
         CLI   DBSELMED,C'O'                                                    
         BNE   INIT40                                                           
****     CLC   DBSELBK,=X'712C'    NOV0113 -JAN0116  FOR TESTING                
****     CLC   DBSELBK,=X'7328'    SEP2815 -JAN0116  FOR TESTING                
         CLC   DBSELBK,=AL1(YR_2015,WEEK_49)                   G                
         BL    INIT60              WE SWTICH M-TH,SU TO M-F                     
         CLC   DBSELBK,=AL1(YR_2017,WEEK_1)                                     
         BNL   INIT60                                                           
         B     INIT50                                                           
INIT40   CLI   DBSELMED,C'T'                                                    
         BNE   INIT60                                                           
***      CLC   DBSELBK,=AL2(NOV_13)  NOV_13-JAN16 SWITCH M-TH,SU TO M-F         
         CLC   DBSELBK,=AL2(DEC_15)  DEC_15-JAN17 SWITCH M-TH,SU TO M-F         
         BL    INIT60                                                           
         CLC   DBSELBK,=AL2(JAN_17)                                             
         BNL   INIT60                                                           
INIT50   MVI   DBSELDAY,X'7C'                                                   
*                                                                               
INIT60   DS    0C                                                               
* MAKE SURE WE ARENT LOOKING UP THE ZEROCELL BOOKTYPES ANYMORE AFTER IT         
* GOES LIVE JUL06                                                               
         MVI   PPM_FLAG,PPMFIRST                                                
         MVI   STALFLAG,C'N'                                                    
         CLI   DBSELSRC,C'N'                                                    
         BNE   INIT80                                                           
         CLC   DBSELBK,=AL2(JUL_06)                                             
         BL    INIT80                                                           
         CLI   DBBTYPE,C'4'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,C'W'                                                     
         CLI   DBBTYPE,C'3'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,C'C'                                                     
         CLI   DBBTYPE,C'2'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,C'H'                                                     
         CLI   DBBTYPE,C'1'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,0                                                        
*                                                                               
*   IF DBXMBKS IS SET - WE NEED TO SET DBSELBK HERE                             
INIT80   CLI   DBSELSRC,C'F'                                                    
         BNE   INIT100                                                          
*&&DO                                                                           
* WE SHOULD NOT NEED THIS CODE.. WE RAN INTO AN ISSUE WHERE                     
* THE XSPILL SETTING ON DCON RECORD CAUSED THE FUSION LOOKUPS                   
* NOT TO PERFORM TRANSPARENCY BOOKTYPE SWITCH, BUT WE TURNED OFF XSPILL         
* SETTING AND IT WORKED                                                         
* FUSION DONT HAVE PRELIMINARY BOOKTYPE                                         
         CLI   DBBTYPE,C'P'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,0                                                        
         CLI   DBBTYPE,C'I'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,C'H'                                                     
*&&                                                                             
         CLC   =C'TM',DBSELAGY     SJR AND UB                                   
         BE    *+10                ONLY                                         
         CLC   =C'SJ',DBSELAGY     SJR AND UB                                   
         BE    *+10                ONLY                                         
         CLC   =C'UB',DBSELAGY     GETS FUSION WEEKLY                           
         BE    *+8                 EVERY ONE ELSE GETS 4WEEK AVG                
         MVI   DBTPTT,C'P'                                                      
INIT100  DS    0X                                                               
*                                                                               
         XC    ALOCNTRY,ALOCNTRY                                                
         XC    SVALOCNT,SVALOCNT                                                
*                                                                               
         OC    AAMKTTAB,AAMKTTAB   A(ALPHAMKT TABLE) RESOLVED?                  
         JNZ   INIT140             YES                                          
         MVC   TPREC(TABLISTQ),TABLIST                                          
         GOTO1 CDEMADDR,TPDMCB,(X'FF',TPREC),COMFACSD                           
         MVC   AAMKTTAB,TPREC      A(TABLE) RETURNED IN TPREC                   
         LA    R1,DMCB             RESTORE R1 TO CALLER'S DMCB                  
*                                                                               
INIT140  OC    ALET,ALET           SSBTBLET RESOLVED?                           
         JNZ   INITBTC             YES                                          
         XC    DUB,DUB             SPECIAL CALL FOR SYSFACS                     
         MVC   DUB(4),=XL4'FEFFFFFF'                                            
         OC    CSWITCH,CSWITCH                                                  
         BNZ   INIT180                                                          
         L     RF,CMASTC                RF=AMASTC                               
         ICM   RF,15,MCSSB-MASTD(RF)    RF=ASSB                                 
         B     INIT250                                                          
*                                                                               
INIT180  GOTO1 CSWITCH,DUB                                                      
         L     RF,0(R1)            RF=V(SYSFACS)                                
         L     RF,VSSB-SYSFACD(RF) RF=V(SSB)                                    
INIT250  MVC   ALET,SSBTBLET-SSBD(RF)                                           
*                                                                               
* DEAL WITH OLYMPIC EXCLUSION STATIONS WHICH ARE MISSING                        
INITBTC  CLI   DBBTYPE,C'O'                                                     
****     BNE   CHKPLATE                                                         
         BNE   INIT300                                                          
*&&DO                                                                           
* NO LONGER NEED OLD CODE                                                       
         CLI   DBSELBK,YR_2001       2001-2002 CHECKING ONLY                    
         BL    INITX                                                            
         CLI   DBSELBK,YR_2002                                                  
         JH    INITX                                                            
         LARL  RE,FEB02SL          POINT TO TABLE OF EXCLUSIONS                 
NOOLY66  CLI   0(RE),X'FF'                                                      
         JE    INITX                                                            
         CLC   DBSELSTA(4),0(RE)                                                
         JE    *+12                                                             
         LA    RE,4(RE)                                                         
         J     NOOLY66                                                          
         MVI   DBBTYPE,0             FOUND ONE - MAKE IT NORMAL                 
         CLC   DBSELAGY,=C'WI'       FOR WESTERN                                
         JNE   INITX                                                            
         CLC   DBSELBK,=AL2(FEB_02) AND FEB/02                                  
         JNE   INITX                                                            
         MVC   DBSELBK,=AL2(NOV_01) SEND IT TO NOV/01                           
         J     INITX                                                            
*&&                                                                             
         J     INITX                                                            
INIT300  MVI   MBKFLAG,C'N'                                                     
         ICM   RE,15,DBEXTEND      CHECK FOR MULTIPLE BOOKS                     
         LTR   RE,RE                                                            
INIT320  BZ    CHKPLATE                                                         
         USING DBXMBID,RE                                                       
         MVI   BKDTFLAG,C'N'                                                    
         CLC   DBXMBID,=C'BKDT'                                                 
         BE    INIT400                                                          
         CLC   DBXMBID,=C'MBKS'                                                 
         BE    *+12                                                             
         ICM   RE,15,DBXMBNXT                                                   
*        B     *-20                                                             
         B     INIT320                                                          
         CLI   DBXMBKS,0           IF ITS NOT SET OR INVALID                    
         BE    CHKPLATE            THEN PROCEED                                 
         MVC   DBSELBK,DBXMBKS     INITIALIZE                                   
         MVI   MBKFLAG,C'Y'                                                     
         B     CHKPLATE                                                         
INIT400  DS    0X                                                               
         USING DBBDTMD,RE                                                       
         CLI   DBBDTMS,0           IF ITS NOT SET OR INVALID                    
         BE    CHKPLATE            THEN PROCEED                                 
         MVC   DBSELBK,DBBDTMS     INITIALIZE                                   
         MVC   DBSELDAY(L'DBSELDAY+L'DBSELTIM),DBBDTMS+2                        
         MVI   BKDTFLAG,C'Y'                                                    
         B     CHKPLATE                                                         
CHKPLATE BRAS  RE,CHKPLAT          LIMIT THE 'P' BOOK REQUEST                   
*                                                                               
INITX    B     GETXX                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
*LATEQV - GET LATEST BOOK FOR AN EQUIV STATION                                  
*  GET LATEST BOOK FOR DBSELSTA -> NON-EQUIV STATION                            
*  EQUIV STATION IS IN DBACTSTA                                                 
***********************************************************************         
LATEQV   NTR1                                                                   
         XC    DUB(8),DUB          DUB+5=0 -> READ W/DBSELSTA                   
*                                                                               
LAT17    MVC   SAVEBOOK,DBACTBK    SET INITIAL BOOK VALUE                       
         XC    SAVEBOOK,EFFS                                                    
*                                                                               
LAT18    LA    R2,DBKEY            BUILD KEY OF DEMO RECORD                     
         USING DRKEY,R2            R2=A(KEY)                                    
         XC    DRKMAJOR,DRKMAJOR                                                
         MVC   DRCODE,RECCODE                                                   
         MVC   DRMEDIA,DBINTMED                                                 
         MVC   DRSRC,DBACTSRC                                                   
         MVC   DRSTAT,DBSELSTA     <-- DUB+5=0 -> RD DBSELSTA                   
         CLI   DUB+5,0                                                          
         BE    *+10                                                             
         MVC   DRSTAT,DBACTSTA     <-- DUB+5=C'A'  -> RD DBACTSTA               
         CLI   DBINTMED,C'C'                                                    
         BE    *+8                                                              
         CLI   DBACTSRC,C'N'                                                    
         BNE   *+16                                                             
         CLI   DRSTAT+4,X'40'                                                   
         BH    *+8                                                              
         MVI   DRSTAT+4,C'T'                                                    
*                                                                               
         MVC   DRBOOK,SAVEBOOK     HOME MARKET/REGULAR SURVEY                   
         MVC   DRBTYP,DBBTYPE      REQUESTED BTYP IF THERE                      
*                                                                               
         OC    DBSELALF,DBSELALF  I BELIEVE THE FOLLOWING SIX INSTR.            
         BZ    *+10               ARE NOT NECESSARY - BETTER TO BE SAFE         
         MVC   DRKMKT,DBSELMK                                                   
         CLC   =C'RRA',DRCODE      ARBITRON                                     
         BE    *+10                                                             
         CLC   =C'RRT',DRCODE      TRITON                                       
         BNE   *+10                                                             
         MVC   DRKMKT,DBSELMK                                                   
*                                                                               
* INCLUDE MARKET FOR CSI ANGLO FRANCO MARKETS                                   
         CLC   DRCODE(3),=C'RCA'   BBM CANADIAN                                 
         BNE   LAT18A                                                           
         CLC   DBSELSTA(4),=C'CIII' SPECIAL NETWORKS                            
         BE    *+10                                                             
         CLC   DBSELSTA(4),=C'CHIF'                                             
         BE    *+10                                                             
         CLC   DBSELSTA(4),=C'ASN '                                             
         BE    *+10                                                             
         CLC   DBSELSTA(4),=C'TSN '                                             
         BNE   LAT18D                                                           
         MVC   DRKMKT,DBSELMK                                                   
* INCLUDE MARKET FOR CSI ANGLO FRANCO MARKETS                                   
LAT18A   CLC   DRCODE(3),=C'RCN'   NSI CANADIAN                                 
         BNE   LAT18D                                                           
         CLC   DBSELMK,=H'414'     MONTREAL ANGLO                               
         BE    *+10                                                             
         CLC   DBSELMK,=H'415'     MONTREAL FRANCO                              
         BE    *+10                                                             
         CLC   DBSELMK,=H'416'     OTTAWA ANGLO                                 
         BE    *+10                                                             
         CLC   DBSELMK,=H'478'     OTTAWA FRANCO                                
         BE    *+8                                                              
         B     LAT18D                                                           
         MVC   DRKMKT,DBSELMK                                                   
*                                                                               
LAT18D   MVI   IOFLAG,DEM+HIGH+DIR                                              
         MVC   DUB(2),DRKMKT                                                    
         GOTO1 AIO,IOFLAG                                                       
         BL    GETX                                                             
*                                                                               
         CLC   DRKEY(DRBOOK-DRKEY),KEYSAVE TEST SAME STATION                    
         BNE   LATEQVNX            NO NOT FOUND -> EXIT & USE EQVNCE            
         CLC   DRBTYP,DBBTYPE      MATCH IF BTYPE REQUEST                       
         BNE   LAT18T                                                           
         CLC   DRKMKT,DUB                                                       
         BE    LAT20                                                            
*                                                                               
LAT18T   CLC   DRBOOK,SAVEBOOK     FOUND BOOK I LOOKED FOR                      
         BE    *+14                                                             
         MVC   SAVEBOOK,DRBOOK     NO - LOOK FOR FOUND BK/BTYP                  
         B     LAT18                                                            
*                                                                               
         SR    R1,R1               FOUND SPILL MARKET OR SPECIAL SURVEY         
         ICM   R1,3,DRBOOK         INCREMENT ITS BOOK TO READ                   
         CLM   R1,3,=X'FFFE'       (PROTECT OURSELVES FROM                      
         BNL   LATEQVNX             BAD BOOK FIELDS IN KEY)                     
         LA    R1,1(R1)            FORWARD FOR A PREVIOUS BOOK                  
         STCM  R1,3,SAVEBOOK                                                    
         B     LAT18                                                            
*                                                                               
LAT20    DS    0H                                                               
         CLI   DUB+5,C'A'          DID WE READ DBACTSA (EQV) YET?               
         BE    *+18                                                             
         MVI   DUB+5,C'A'          GO READ DBACTSAT LATEST BK                   
         MVC   DUB+6(2),DRBOOK     SAVE LATEST BOOK OF NON-EQV STA              
         B     LAT17                                                            
*                                                                               
         CLC   DRBOOK,DUB+6        COMPARE EQV LATEST BK W/DBSELSTA BK          
         BNH   LATEQVX             USE EQUIV IF THE SAME/LATER FOR EQV          
         MVC   DBACTSTA,DBSELSTA   ELSE USE REQ STATION                         
*                                                                               
         B     LATEQVX                                                          
*                                                                               
LATEQVNX DS    0H                  STATION NOT FOUND                            
         CLI   DUB+5,0             DBSELSTA NOT FOUND -> USE EQUIV              
         BE    *+10                                                             
         MVC   DBACTSTA,DBSELSTA   EQV NOT FOUND->USE DBSELSTA                  
                                                                                
* ===  CHECK TO SEE IF OLD STATION CALL LETTERS ARE REUSED ====                 
* ===  ONLY DO THIS FOR ARBITRON RADIO FOR NOW                                  
* IF DBSELSTA IS DIFFERENT THAN DBACTSTA THEN THE STATION CHANGED...            
* IF THE STATION CHANGED VIA A LINK AND LATEST BOOK IN DUB+6 OF THE             
* ORGINAL STATION IS EQUAL TO OR GREATER THAN THE DSTATION LINK'S               
* EFFECTIVE BOOK  THEN KEEP THE ORIGINAL STATION CALL LETTER.                   
*                                                                               
LATEQVX  CLI   DBSELMED,C'R'                                                    
         BNE   GETXX                                                            
         CLC   DBSELSTA,DBACTSTA                                                
         BE    GETXX               BOOKS ARE FLIPPED                            
         CLC   DBEQEFBK,DUB+6      IF EFFECTIVE BOOK IS > LATEST                
         BL    GETXX               BOOK FOR OLD CALL LETTER THEN                
         MVC   DBACTSTA,DBSELSTA   KEEP NEW EQUIV CALL LETTERS                  
         B     GETXX               ELSE KEEP OLD CALL LETTERS BECAUSE           
*                                  OLD LETTERS CONTINUE TO HAVE BKS             
         EJECT                                                                  
***********************************************************************         
*CAN4WK - READ ALL WEEKS IN A MONTH FOR TCN FILE WHEN DBBEST=C'M'               
*   USE MMWKTAB TO GET START AND END WEEKS TO READ                              
***********************************************************************         
CAN4WK   NTR1                                                                   
         XC    CANSWK,CANSWK                                                    
         XC    CANEWK,CANEWK                                                    
*                                                                               
         XC    SPTTBPTR,SPTTBPTR                                                
* NEW ACHEIVED POSTING METHODLOGY?                                              
         IF    (CLI,DBNPMFLG,EQ,DBNPMACH),AND,                                  
               (OC,DBSELBK,DBSELBK,NZ),AND,                                     
               (CLI,DBVOPT,E,X'40')                                             
         ICM   RE,15,DBEXTEND      CHECK FOR MULIPLE STATIONS                   
         USING DBSPDTD,RE                                                       
CAN4WK02 LTR   RE,RE                                                            
         BZ    CAN4WK06                                                         
         CLC   DBSPDTID,=C'SPDT'                                                
         BE    *+12                                                             
         ICM   RE,15,DBSPDNXT                                                   
         B     CAN4WK02                                                         
         MVC   NUMSPOTS,DBSPNSPT   NUMBER OF SPOTS IN TABLE                     
         MVC   SPTTABLN,DBSPLEN     LENGTH OF TABLE ENTRY                       
         MVC   ASPTTAB,DBSPASPT                                                 
         OC    NUMSPOTS,NUMSPOTS   ANY SPOTS DATES IM TABLE?                    
         BZ    CAN4WK06                                                         
         L     RE,ASPTTAB                                                       
         USING SPTTABD,RE                                                       
         MVC   DBSELBK,SPTRDATE    2 BYTE DATE                                  
         MVC   DBACTDUP,2(RE)      1 BUYE DUP FACTOR                            
         ZIC   RF,SPTTABLN                                                      
         AR    RE,RF                                                            
         ST    RE,SPTTBPTR                                                      
         B     CAN4WK08                                                         
         DROP  RE                                                               
         ENDIF                                                                  
CAN4WK06 DS    0C                                                               
*                                                                               
* NEW AFFIDS POSTING METHDOLOGY?                                                
*  dbselbk is set to compressed afdate                                          
*  we must translate to weekly book                                             
*  with this option we post affids for the exact week and not the               
*  weeks agreggated monthly book                                                
         IF    (CLI,DBNPMFLG,EQ,DBNPMAFF),AND,                                  
               (OC,DBSELBK,DBSELBK,NZ),AND,                                     
               (CLI,DBVOPT,E,X'40')                                             
                                                                                
*                                                                               
CAN4WK08 GOTO1 CDATCON,DMCB,(2,DBSELBK),(0,DUB)                                 
*                                                                               
         L     RE,=V(NSIWEEK)                                                   
         A     RE,RELO3                                                         
         ST    RE,VNSIWEEK                                                      
         GOTO1 VNSIWEEK,DMCB,DUB,(1,CGETDAY),CADDAY,CDATCON                     
         MVC   DBSELBK(1),DMCB+4                                                
         MVC   DBSELBK+1(1),DMCB                                                
         MVI   DBBTYPE,C'W'                                                     
         MVC   CANSWK(1),DBSELBK+1                                              
         MVC   CANEWK(1),DBSELBK+1                                              
         B     CAN4WKX                                                          
         ENDIF                                                                  
*                                                                               
CAN4WK10 L     RE,=V(GETBROAD)                                                  
         A     RE,RELO3                                                         
         ST    RE,VGETBRO                                                       
         L     RE,=V(NETWEEK)                                                   
         A     RE,RELO3                                                         
         ST    RE,VNETWEEK                                                      
*                                                                               
         OC    DBSELBK,DBSELBK     LATEST? ALWAYS USE GETBROAD                  
         JNZ   CAN4WK2                                                          
*                                                                               
         LA    R2,DBKEY                                                         
         USING DRKEY,R2                                                         
         XC    DRKMAJOR,DRKMAJOR                                                
         MVC   DRCODE,RECCODE                                                   
         MVC   DRMEDIA,DBINTMED                                                 
         MVC   DRSRC,DBACTSRC                                                   
         MVC   DRSTAT,DBSELSTA     READ FOR PARENT STATION/BOOK                 
         MVC   DRBTYP,DBBTYPE      REQUESTED BTYP IF THERE                      
         MVC   DRKMKT,DBSELMK                                                   
         MVI   IOFLAG,DIR+HIGH+DEM                                              
         GOTO1 AIO,IOFLAG                                                       
         LA    RE,DBKEY                                                         
         MVC   CANWLAT(2),DRBOOK                                                
         XC    CANWLAT(2),=X'FFFF'                                              
         CLI   CANWLAT+1,WEEK_52   TERMINATE AT WEEK 52                         
         BL    *+8                                                              
         MVI   CANWLAT+1,WEEK_52                                                
*                                                                               
         XC    DUBSV,DUBSV         USING DUBSV TO STORE A TEMP DATE             
         MVC   DUBSV(1),CANWLAT                                                 
         MVI   DUBSV+1,1                                                        
         MVI   DUBSV+2,15          Y+M+15 EX. 10-01-15                          
CAN4WK0A GOTO1 CDATCON,DMCB,(3,DUBSV),(0,WORKSV),CGETDAY,CADDAY                 
         GOTO1 VGETBRO,DMCB,(X'01',WORKSV),WORKSV+6,CGETDAY,CADDAY              
         GOTO1 VNETWEEK,DMCB,WORKSV+6,CGETDAY,CADDAY                            
         CLC   CANWLAT+1(1),DMCB+8 HIGHER THAN 1ST WEEK OF MONTH?               
         BNH   CAN4WK0B                                                         
         GOTO1 VNETWEEK,DMCB,WORKSV+12,CGETDAY,CADDAY                           
         CLC   CANWLAT+1(1),DMCB+8 EQUAL TO LAST WEEK OF MONTH?                 
         BE    CAN4WK0C            EQUAL: THIS MONTH IS LATEST                  
         BNH   CAN4WK0B            LOWER: LAST MONTH IS LATEST                  
         CLI   DUBSV+1,12                                                       
         BE    CAN4WK0X            NOT FOUND                                    
         ZIC   RF,DUBSV+1          TRY NEXT MONTH                               
         AHI   RF,1                                                             
         STC   RF,DUBSV+1                                                       
         B     CAN4WK0A                                                         
*                                                                               
CAN4WK0B ZIC   RF,DUBSV+1          MONTH INCOMPLETE ON FILE                     
         SHI   RF,1                PREVIOUS MONTH IS LATEST                     
         STC   RF,DUBSV+1                                                       
         LTR   RF,RF               IF PREVIOUS MONTH IS 0                       
         BNZ   CAN4WK0C            TAKING INTO ACCOUNT YEAR CROSSOVER           
         ZIC   RE,CANWLAT          DECREMENT THE YEAR                           
         BCTR  RE,0                                                             
         STC   RE,CANWLAT                                                       
         LHI   RF,12               SET MONTH TO DEC                             
         STC   RF,DUBSV+1                                                       
*                                                                               
CAN4WK0C MVC   CANWLAT+1(1),DUBSV+1                                             
         B     CAN4WK1                                                          
CAN4WK0X MVC   CANWLAT,=X'800D'    NOT FOUND-FORCE A MISMATCH                   
*                                                                               
CAN4WK1  MVC   DBSELBK,CANWLAT                                                  
         OC    DBSELDAT,DBSELDAT   OF LIMIT NOT SET THEN                        
         BZ    CAN4WK2             DONT DESTROY DBSELBK                         
         CLC   DBSELBK,DBSELDAT    TAKE CARE OF ANY LIMIT THAT'S SET            
         BL    CAN4WK2                                                          
         MVC   DBSELBK,DBSELDAT                                                 
*                                                                               
CAN4WK2  CLI   DBSELBK+1,12        MAKE SURE THEY REQUESTED A MONTH             
         BH    CAN4WKX             ERROR                                        
         CLI   DBSELBK+1,0                                                      
         BE    CAN4WKX                                                          
         CLI   DBSELBK,YR_2010     2010+, USE GETBROAD                          
         BNL   CAN4BRO                                                          
***********************************************************************         
* WE WILL STILL USE MMWWTAB FOR PRE-2010 REQUESTS, FOR TRANSPARENCY             
***********************************************************************         
*                                                                               
         LARL  RE,MMWWTAB          PT TO MONTH->WK TABLE                        
CAN4WK5  CLC   DBSELBK(1),0(RE)                                                 
         BE    CAN4WK6                                                          
         LA    RE,YYDSPQ(RE)       BUMP TO NEXT YEAR IN TABLE                   
         CLI   0(RE),X'FF'         EOT?                                         
         BE    CAN4WKX             NOT FOUND                                    
         B     CAN4WK5                                                          
*                                                                               
CAN4WK6  DS    0H                                                               
         MVC   CANMBK,DBSELBK                                                   
         ZIC   R1,DBSELBK+1        R1 = REQSTED MONTH                           
         BCTR  R1,0                                                             
         SLL   R1,1                MONTH * 2-BYTE ENTRY IN TABLE                
         LA    RE,1(RE)                                                         
         AR    RE,R1                                                            
         MVC   CANSWK,0(RE)        START WK (GETS BUMPED AS WKS READ)           
         MVC   CANEWK,1(RE)        END WEEK                                     
         B     CAN4WKX                                                          
***********************************************************************         
CAN4BRO  MVC   CANMBK,DBSELBK                                                   
         MVC   DUBSV(2),DBSELBK                                                 
         MVI   DUBSV+2,15                                                       
         GOTO1 CDATCON,DMCB,(3,DUBSV),(0,WORKSV),CGETDAY,CADDAY                 
         GOTO1 VGETBRO,DMCB,(X'01',WORKSV),WORKSV+6,CGETDAY,CADDAY              
         GOTO1 VNETWEEK,DMCB,WORKSV+6,CGETDAY,CADDAY                            
         MVC   CANSWK,DMCB+8       START WEEK                                   
         GOTO1 VNETWEEK,DMCB,WORKSV+12,CGETDAY,CADDAY                           
         MVC   CANEWK,DMCB+8       END WEEK                                     
*                                                                               
CAN4WKX  B     GETXX               DONE                                         
*                                                                               
         EJECT                                                                  
***********************************************************************         
*====================== GET PROGRAM INFORMATION ======================*         
                                                                                
* Gets information via programs.  The following DBFUNCT values will             
*  cause this code to execute:                                                  
*   DBGETIPR - gets all programs ran by a station in a given book               
*   DBGETISI - gets all stations which ran a certain program                    
*   DBGETISR - gets the demographic data for a given program                    
                                                                                
GETIPTR  DS    0H                                                               
         LA    RE,TPLWORK          CLEAR WORK AREA                              
         LHI   RF,TPLWORKQ                                                      
         XCEF                                                                   
                                                                                
         MVC   SVSELBK,DBSELBK                                                  
         MVI   DBERROR,0                                                        
         CLC   DBFILE,=C'TP '      SO FAR, ONLY VALID FOR TP FILE               
         BNE   GIPXIF                                                           
         CLI   DBSELMED,C'T'        AND MEDIA=T                                 
         BNE   GIPXFM                                                           
         OC    DBSELPR4,DBSELPR4   A PROGRAM # IS EXPECTED,                     
         BNZ   *+12                                                             
         CLI   DBFUNCT,DBGETIPR     UNLESS DBFUNCT=DBGETIPR WHEN IT'S           
         BNE   GIPXEOF              NOT REQUIRED                                
                                                                                
         MVI   DEMOFLAG,0          INITIALIZE ACCESS FLAGS                      
*                                                                               
GIP10    GOTO1 AGETBOOK            SET DBACTBK                                  
         BNE   GIPXX                                                            
*                                                                               
** TEST USER'S ACCESS **                                                        
*                                                                               
         LA    R1,DBACTBK                                                       
         OC    ACONHDR,ACONHDR     TEST IF A(CONTROL TABLE) SET                 
         BNZ   GIP13                                                            
                                                                                
         GOTO1 AGETCTRL             NO - GET AGENCY CONTROLS                    
         CLI   DBBTYPE,0           TEST ACCESS FOR BOOK TYPE ALWAYS             
         BE    GIP13                                                            
         MVC   TPSAVE(1),DBFUNCT                                                
         MVI   DBFUNCT,DBTSTACS                                                 
         GOTO1 ATSTACS                                                          
         MVC   DBFUNCT,TPSAVE                                                   
         CLI   DBERROR,0                                                        
         BNE   GIPXX                                                            
*                                                                               
GIP13    OC    DBSELUMK,DBSELUMK   TEST IF USER MARKET NUMBER PASSED            
         BZ    GIP30                                                            
         OC    ACONHDR+1(3),ACONHDR+1                                           
         BZ    GIP30                                                            
         MVC   DBACTRMK,DBSELRMK                                                
                                                                                
         L     R2,ACONHDR          R2=A(CONTROL TABLE)                          
         USING CONHDRD,R2                                                       
         LA    R3,CONHDRD+CONHDRLN                                              
         USING CONDTAD,R3                                                       
         LAM   AR2,AR2,ALET                                                     
         CPYA  AR3,AR2                                                          
         SAC   512                                                              
*                                  PROCESS VALID MARKET LIST                    
         LA    RE,3                SET UP FOR BXLE INSTRUCTION                  
         XR    RF,RF               USE RE,RF AS EVEN ODD PAIR                   
         ICM   RF,7,CONAET                                                      
         CR    R3,RF                                                            
         BE    GIP30               USE RE,RF FOR BXLE INSTRUCTION               
*                                  PROCESS VALID MARKET LIST                    
GIP14    CLI   CONINDIC,0                                                       
         BNE   GIP16                                                            
         OC    DBACTRMK,DBACTRMK    ONLY IF MARKET KNOWN                        
         BZ    GIP20                                                            
         OI    DEMOFLAG,X'80'                                                   
         CLC   DBACTRMK,CONMRKT                                                 
         BNE   *+8                                                              
         OI    DEMOFLAG,X'40'                                                   
         B     GIP20                                                            
*                                  PROCESS INVALID MARKET LIST                  
GIP16    CLI   CONINDIC,X'FF'                                                   
         BNE   GIP18                                                            
         OC    DBACTRMK,DBACTRMK   ONLY IF MARKET KNOWN                         
         BZ    GIP20                                                            
         OI    DEMOFLAG,X'20'                                                   
         CLC   DBACTRMK,CONMRKT                                                 
         BNE   *+8                                                              
         OI    DEMOFLAG,X'10'                                                   
         B     GIP20                                                            
*                                  PROCESS SOURCE OVERRIDE LIST                 
GIP18    CLC   DBSELUMK,CONMRKT                                                 
         BNE   GIP20                                                            
         OI    DEMOFLAG,X'08'                                                   
         MVC   DUB(1),CONINDIC                                                  
         CLI   DUB,C'A'                                                         
         BNE   GIP23                                                            
         CLI   DBACTBK,0                                                        
         BE    GIP30                                                            
         CLI   DBACTBK,YR_1994                                                  
         BL    GIP23                                                            
         NI    DEMOFLAG,X'F7'                                                   
         B     GIP30               OVERRIDE SOURCE - ALL OTHER DATA             
*                                  IS N/A FOR CURRENT SOURCE                    
GIP20    BXLE  R3,RE,GIP14         USE RE,RF FOR BXLE INSTRUCTION               
         DROP  R3                                                               
*                                  TEST MARKET NUMBERS VALID                    
         TM    DEMOFLAG,X'C0'                                                   
         BM    GIP25                                                            
         TM    DEMOFLAG,X'30'                                                   
         BO    GIP25                                                            
                                                                                
         TM    DEMOFLAG,X'08'      TEST SOURCE OVERRIDE PRESENT                 
         BZ    GIP30                                                            
GIP23    TM    DEMOFLAG,X'01'       YES - HAVE I BEEN HERE BEFORE               
         BNZ   GIP25                                                            
         MVI   DEMOFLAG,X'01'       NO - SET NEW SOURCE CODE & RETRY            
         XC    ACONHDR,ACONHDR                                                  
         XC    DBACTUAL,DBACTUAL                                                
         MVC   DBACTSRC,DUB                                                     
         MVC   DBACTMED,DBINTMED                                                
         B     GIP10                                                            
*                                                                               
GIP25    SAC   0                                                                
         LAM   AR2,AR3,ARZERO                                                   
         B     GIPXIM              INVALID MARKET ERROR                         
*                                                                               
** SET SOME VALUES **                                                           
*                                                                               
GIP30    SAC   0                                                                
         LAM   AR2,AR3,ARZERO                                                   
         XR    R1,R1               DAY & QTR HOUR TABLE                         
         CLI   DBDAYOPT,C'Y'        OPTION FOR NO INDIVIDUAL DAYS               
         BNE   *+12                                                             
         LA    R1,1(R1)                                                         
         B     GIP32                                                            
                                                                                
         B     GIP32                                                            
                                                                                
         CLI   DBSELBK,0            EARLY FOR ALL LATEST BOOKS                  
         BE    *+14                                                             
         CLC   DBSELBK,=AL2(MAR_92) USE EARLY START AFTER FEB/92                
         BL    GIP32                 FOR INDIVIDUAL DAYS                        
         LA    R1,1(R1)                                                         
** FEB04/2000 (GLEE) - (SEE COMMENT FROM FIRST CALL TO  GETDQ)                  
         LA    R1,1(R1)                                                         
         BAS   RE,SETDQLNK                                                      
         B     GIP32                                                            
*                                                                               
GIP32    DS    0C                                                               
         CLI   DBSELMED,C'T'                                                    
         BNE   GIP32K                                                           
****     CLC   DBACTBK,=AL2(NOV_13) 3A CODE EFFECTOV                            
         CLC   DBACTBK,=AL2(DEC_15) 3A CODE EFFECTOV                            
         BL    GIP32K                                                           
         CHI   R1,2                                                             
         BNE   GIP32K                                                           
         LA    R1,4                                                             
GIP32K   GOTO1 AGETDQ               NOW GO BUILD LIST OF DAYS & QHS             
         BNE   GIPXX                                                            
                                                                                
         DS    0H                  OTHER VALUES TO SET                          
         MVC   BOOKTYPE,DBBTYPE                                                 
         MVC   SAVEBOOK,DBACTBK    SET LOOK-UP BOOK VALUE                       
         XC    SAVEBOOK,EFFS                                                    
         MVC   DBACTSTA,DBSELSTA                                                
         OC    DBACTSTA,DBACTSTA   SPECIFIC STATION REQUESTED?                  
         BZ    GIP40                NOPE                                        
                                                                                
         OC    DBSELBK,DBSELBK     TEST LATEST BOOK REQUESTED                   
         BNZ   GIP35                NOPE                                        
         XC    DUB(5),DUB                                                       
         MVI   DUB+5,X'01'         GET LATEST CALL LETTERS (OLD TO NEW)         
         GOTO1 AGETEQIV                                                         
         B     GIP37                                                            
*                                                                               
GIP35    BAS   RE,GETCALL          GET STATION VALUE INTO DUB                   
         STC   R1,CALLEN                                                        
*                                                                               
GIP37    DS    0H                                                               
         ZIC   R1,CALLEN                                                        
         MVC   DBACTSTA,DUB        SET STATION KEY VALUE                        
         LA    R1,DBACTSTA(R1)                                                  
         MVI   0(R1),C'T'          FORCE READ ON PARENT                         
*                                                                               
GIP40    DS    0H                  BRANCH OFF TO RESPECTIVE ROUTINES            
         CLI   DBFUNCT,DBGETIPR                                                 
*^^NOP   BE    GIP100                                                           
         BE    GIP400                                                           
         CLI   DBFUNCT,DBGETISI                                                 
         BE    GIP200                                                           
         CLI   DBFUNCT,DBGETISR                                                 
         BE    GIP300                                                           
         TITLE 'TP - TIME PERIOD FILE READ CONTROLLER (DBFUNCT=???+03383        
               ?????)'                                                          
GIP100   DS    0H                                                               
         MVI   DBERROR,0                                                        
*                                                                               
** BUILD KEY & READ THEM I-PTRS **                                              
*                                                                               
GIP110   BAS   RE,GIPKEY           GO BUILD MAJOR PIKEY                         
         LA    R3,TPREC                                                         
         USING PSMTABD,R3                                                       
                                                                                
         LR    RE,R3               CLEAR BUFFER FOR PSMTABD                     
         LA    RF,L'TPREC                                                       
         XCEF                                                                   
         XC    TPSAVE,TPSAVE       INITIALIZE SAVE FIELD                        
                                                                                
         LA    R2,DBKEY                                                         
         USING PIKEY,R2                                                         
GIP115   XC    PISTA(10),PISTA     CLEAR "UNIMPORTANT" PART OF KEY              
                                                                                
         MVI   DBRECTYP,DBRECPRG                                                
         MVI   IOFLAG,DIR+HIGH+DEM                                              
         GOTO1 AIO,IOFLAG                                                       
         BL    GIPXX                                                            
                                                                                
         CLC   PIKEY(5),KEYSAVE    WE WANT EVERYTHING UNDER A BOOK              
         BE    GIP120                                                           
         OC    TPDBARS,TPDBARS     ANY ENTRIES IN PSMTABD TO PROCESS?           
         BZ    GIPXEOF              NO, EXIT                                    
         MVI   TPSAVE,X'FF'        EXHAUSTED ALL I-PTRS FOR A BOOK              
         SHI   R3,PSMLENQ          SET SAVE FIELD                               
         MVC   TPSAVE+1(L'PSMPNUM),PSMPNUM                                      
         LA    R3,PSMLENQ(R3)                                                   
         B     GIP130A                                                          
                                                                                
GIP120   DS    0H                                                               
         MVC   PSMPNUM(PSMLENQ),PIPNUM   MOVE PRG#/STTN/MKT/DAY/SQH             
         L     R1,TPDBARS                                                       
         LA    R1,1(R1)                  UPDATE # OF ENTRIES                    
         ST    R1,TPDBARS                 IN PSMTABD                            
         CHI   R1,L'TPREC/PSMLENQ  REACH MAX # OF ENTRIES?                      
         BE    GIP130                     YEP                                   
         BL    GIP123                     NOT YET                               
         MVI   DBERROR,HORREND              SOMETHING'S REALLY WRONG            
         B     GIPXX                                                            
*                                                                               
GIP123   DS    0H                                                               
         LA    R3,PSMLENQ(R3)      BUMP TO NEXT ENTRY LOCATION                  
         ZICM  R1,PIPNUM,(7)       FORCE TO READ NEXT PROGRAM                   
         LA    R1,1(R1)                                                         
         STCM  R1,7,PIPNUM                                                      
         B     GIP115              GO BACK AND READ SOME MORE                   
*                                                                               
** PSMTABD FILLED UP OR NO MORE I-PTRS **                                       
*                                                                               
GIP130   DS    0H                                                               
         MVC   TPSAVE+1(L'PIPNUM),PIPNUM   SAVE LAST PROG READ                  
         DROP  R2                                                               
*                                                                               
GIP130A  DS    0H                                                               
                                                                                
         L     R0,TPDBARS          GET # OF ENTRIES IN PSMTABD                  
         LA    RE,RELO1                                                         
         S     RE,RELO1                                                         
         ST    RE,TPAR1ST                                                       
         GOTO1 =V(QSORT),DMCB,(0,TPREC),(R0),PSMLENQ,PSMBNKYL,PSMBNKYD,+        
               RR=TPAR1ST                                                       
                                                                                
         MVI   DBRECTYP,DBRECDEM   SET RECORD TYPE IN DBLOCK                    
         LA    R3,TPREC                                                         
         LA    R2,DBKEY                                                         
         USING DRKEY,R2                                                         
         XC    DRKMAJOR,DRKMAJOR                                                
         MVI   DRCODE,DRCODEQU     BUILD KEY OF DEMO RECORD                     
         MVC   DRMEDIA,DBINTMED                                                 
         MVC   DRSRC,DBACTSRC                                                   
         MVC   DRBOOK,SAVEBOOK                                                  
*                                                                               
GIP132A  MVC   DRSTAT,PSMSTTN      FILL IN INFO FROM PSMTABD                    
GIP132B  MVC   DRKMKT,PSMKMKT                                                   
         XC    DRSTYP(6),DRSTYP     AND ERASE LEFT-OVER GARBAGE                 
                                                                                
         MVI   IOFLAG,DIR+HIGH+DEM    READ DIRECTORY                            
         GOTO1 AIO,IOFLAG                                                       
         BNE   GIP1DIE                                                          
         CLC   DRKEY(12),KEYSAVE      MATCH UP TO & INCLDNG SPILL MKT           
         BNE   GIP1DIE                                                          
                                                                                
GIP132C  MVC   DBMINKEY(1),PSMDAY     SET THE MINOR KEY AS WELL                 
         MVC   DBMINKEY+1(1),PSMSQH                                             
                                                                                
         MVI   IOFLAG,FILE+HIGH+DEM   NOW READ FILE FOR                         
         B     *+8                                                              
GIP135   MVI   IOFLAG,FILE+SEQ+DEM                                              
         GOTO1 AIO,IOFLAG              DEMO RECORD                              
         BE    GIP130X                                                          
GIP1DIE  MVI   DBERROR,HORREND     SOMETHING'S REALLY WRONG                     
         B     GIPXX                EXIT NOW                                    
*                                                                               
GIP130X  DS    0H                                                               
         DROP  R2                                                               
                                                                                
         L     R1,DBAREC           NOW FIND QH ELEM FOR PROGRAM                 
         AH    R1,DBDTADSP                                                      
         USING QHELEM,R1                                                        
GIP140   CLI   QHCODE,0            IF WE REACH EORECORD,                        
         BE    GIP135               GET NEXT ONE                                
         CLI   QHCODE,QHCODEQ      LOOK FOR QH ELEM                             
         BNE   GIP145                                                           
                                                                                
         ZIC   RF,QHELN                                                         
         AR    RF,R1                                                            
         USING QIELEM,RF                                                        
         CLI   QIELEM,QICODEQ      NOW LOOK FOR INFO ELEM                       
         BNE   GIP145                                                           
         CLI   QIELN,4             IF ELEMENT IS A BACKWARD POINTER,            
         BNE   GIP142                                                           
         ICM   R0,3,2(RF)           ADJUST FOR IT                               
         SLL   R0,17                                                            
         SRL   R0,17                                                            
         LR    RF,R0                                                            
         A     RF,DBAREC                                                        
*                                                                               
GIP142   CLC   QIPNUM,PSMPNUM      NOW MATCH ON PROGRAM #                       
         BE    GIP150                                                           
*                                                                               
GIP145   SR    R0,R0               BUMP ELEMENT POINTER                         
         ICM   R0,1,QHELN                                                       
         JZ    *+2                                                              
         AR    R1,R0                                                            
         B     GIP140                                                           
         DROP  R1,RF                                                            
*                                                                               
GIP150   DS    0H                  QHELEM FOUND W/ CORRECT PROG #               
         ST    R1,DBAQUART                                                      
         MVI   DBMODE,DBMNEXT                                                   
         BAS   RE,GETX             GO OFF TO USER'S ROUTINE                     
         MVC   DBINTFIL(2),SVINTFIL  (THESE WERE SAVED BEFORE HOOK)             
                                                                                
         LR    RF,R3                                                            
         LA    R3,PSMLENQ(R3)      GET NEXT PSMTABD ENTRY                       
                                                                                
         LA    RE,GIP132A                                                       
         CLC   PSMSTTN,PSMSTTN-PSMTABD(RF)  IF CURRENT STATION,                 
         BNE   GIP155                                                           
         LA    RE,GIP132B                                                       
         CLC   PSMKMKT,PSMKMKT-PSMTABD(RF)   & SPILL MARKET MATCH,              
         BNE   GIP155                                                           
         LA    RE,GIP132C                    DON'T READ SAME RECORD             
*                                                                               
GIP155   DS    0H                                                               
         L     R1,TPDBARS                                                       
         SHI   R1,1                CHECK IF PSMTABD IS                          
         ST    R1,TPDBARS           EXHAUSTED OR NOT                            
         BNZR  RE                                                               
*                                                                               
** PSMTABD EXHAUSTED, READ MORE I-PTRS OR EXIT **                               
*                                                                               
         CLI   TPSAVE,X'FF'        ANY MORE I-PTRS TO READ?                     
         BE    GIPXEOF              NOPE, EXIT                                  
         SR    R1,R1                                                            
         ICM   R1,7,TPSAVE+1       YES, RECALL LAST PROG# READ,                 
         LA    R1,1(R1)                                                         
         STCM  R1,15,DBSELPR4       AND FORCE TO READ NEXT PROG#                
         B     GIP110                                                           
         DROP  R3                                                               
         TITLE 'DEGETTP - TIME PERIOD FILE READ CONTROLLER (DBFUNCT=DBG+        
               ETISI)'                                                          
GIP200   DS    0H                                                               
*                                                                               
** BUILD KEY & READ THEM I-PTRS **                                              
*                                                                               
         MVI   DBRECTYP,DBRECPRG                                                
         MVI   DBERROR,0                                                        
         BAS   RE,GIPKEY           GO BUILD MAJOR PIKEY                         
         LA    R2,DBKEY                                                         
         USING PIKEY,R2                                                         
         XC    PISTA(10),PISTA                                                  
*                                                                               
GIP208   DS    0H                                                               
         MVI   IOFLAG,DIR+HIGH+DEM                                              
         B     *+8                                                              
GIP210   MVI   IOFLAG,DIR+SEQ+DEM                                               
         GOTO1 AIO,IOFLAG                                                       
         BL    GIPXX                                                            
         LA    R1,(PIPNUM+L'PIPNUM-PIKMAJOR)-1                                  
         OC    DBSELPR4+1(3),DBSELPR4+1                                         
         BNZ   *+8                                                              
         LA    R1,(PIBOOK+L'PIBOOK-PIKMAJOR)-1                                  
         EXCLC R1,PIKEY,KEYSAVE                                                 
         BNE   GIPXEOF                                                          
                                                                                
         MVI   DBMODE,DBMNEXT                                                   
         BAS   RE,GETX                                                          
         MVC   DBINTFIL(2),SVINTFIL  (THESE WERE SAVED BEFORE HOOK)             
                                                                                
         DS    0H                                                               
         OC    DBSELPR4+1(3),DBSELPR4+1                                         
         BNZ   GIP210                                                           
         MVI   PISTA,X'FF'                                                      
         MVC   PISTA+1((L'PIKMAJOR-(PISTA-PIKMAJOR))-1),PISTA                   
         B     GIP208                                                           
         DROP  R2                                                               
         TITLE 'DEGETTP - TIME PERIOD FILE READ CONTROLLER (DBFUNCT=DBG+        
               ETISR)'                                                          
*                                                                               
** BUILD KEY & READ THEM I-PTRS **                                              
*                                                                               
GIP300   DS    0H                                                               
         MVI   DBRECTYP,DBRECPRG                                                
         MVI   DBERROR,0                                                        
         LA    R2,DBKEY                                                         
         USING PIKEY,R2                                                         
         XC    PIKMAJOR,PIKMAJOR                                                
         MVI   PIKCODE,PICODEQU                                                 
         MVC   PIMEDIA,DBINTMED                                                 
         MVC   PISRC,DBACTSRC                                                   
         MVC   PIBOOK,SAVEBOOK                                                  
         MVC   PIPNUM,DBSELPR4+1                                                
         MVC   PISTA,DBACTSTA                                                   
         B     GIP310                                                           
*                                                                               
GIP310   MVI   IOFLAG,DIR+HIGH+DEM                                              
         GOTO1 AIO,IOFLAG                                                       
         BL    GIPXX                                                            
                                                                                
         LA    R1,(PIPNUM-PIKEY)+(L'PIPNUM-1)                                   
         OC    DBSELSTA,DBSELSTA                                                
         BZ    *+8                                                              
         LA    R1,(PISTA-PIKEY)+(L'PISTA-1)                                     
         EXCLC R1,PIKEY,KEYSAVE    WAS RECORD FOUND?                            
         BE    GIP320                                                           
                                                                                
         OC    DBSELSTA,DBSELSTA    NOPE, WAS A STATION REQUESTED?              
         BZ    GIPXEOF               NO, FINISHED W/ EOF                        
         TM    DEMOFLAG,X'04'        YES, EQUIVALENCED YET?                     
         BO    GIPXNF                 YEAH, FINISH W/ NOT FOUND                 
         OI    DEMOFLAG,X'04'                                                   
         MVI   DUB+5,X'02'         EQUIVALENCING NEW TO OLD                     
         OC    DBSELBK,DBSELBK                                                  
         BNZ   *+8                                                              
         MVI   DUB+5,X'03'         SEARCH FOR OLD OR NEW                        
         GOTO1 AGETEQIV                                                         
         BNE   GIPXNF              GO TO NOT FOUND IF ERROR                     
         B     GIP37                ELSE, GO BACK & TRY AGAIN                   
*                                                                               
GIP315   DS    0H                                                               
         OC    PIKMKT,PIKMKT       IGNORE SPILL MARKETS                         
         BNZ   GIP327                                                           
         DROP  R2                                                               
*                                                                               
** BUILD TABLE OF STATION/DAY/QH **                                             
*                                                                               
GIP320   DS    0H                                                               
         USING PIKEY,R2            R2-->PROGRAM (PASSIVE) RECD                  
         LA    RE,DBDQTAB          SEE IF RECD'S QHS OVERLAP REQUEST'S          
*                                                                               
         DS    0H                   FIND ACTUAL LOCATION OF DAYS/QHS            
         CLC   =AL2(DBDQUXTD),DBDQTAB+0  DAYS/QHS IN EXTEND AREA?               
         BNE   GIP320X                    NOPE                                  
         LA    RE,DBEXTEND-4                                                    
GIP320M  DS    0H                        SEARCH EXTEND AREA                     
         ICM   RE,15,4(RE)                                                      
         JZ    *+2                                                              
         CLC   0(4,RE),DBDQTAB+2          FOR NAME SPECIFIED HERE               
         BNE   GIP320M                                                          
         AHI   RE,DBDQXFXL               RE-->DAYS/QHS TABLE                    
GIP320X  EQU  *                                                                 
                                                                                
*                                                                               
DBDQ     USING DBDQD,RE                                                         
GIP322   CLI   0(RE),EOT                                                        
         BE    GIP327                                                           
         CLC   PIDAY,DBDQ.DBDQKDAY MATCH ON DAY                                 
         BNE   GIP322A                                                          
         CLC   DBDQ.DBDQSQH,PIEQH  IF REQST SQH <= RECD'S EQH                   
         BH    GIP322A                                                          
         CLC   PISQH,DBDQ.DBDQEQH  AND RECD'S SQH <= REQST EQH,                 
         BNH   GIP322X              OVERLAP FOUND, ADD RECD TO SDQTABD          
GIP322A  LA    RE,DBDQLEN(RE)                                                   
         B     GIP322                                                           
         DROP  R2,DBDQ                                                          
GIP322X  DS    0H                                                               
                                                                                
         LH    RE,TPDBARS          TPDBARS(2) HOLD # OF ENTRIES                 
         LA    R1,1(RE)                                                         
         STH   R1,TPDBARS           UPDATE IT                                   
                                                                                
         MHI   RE,SDQLENQ          RE=DISPL TO PUT NEXT ENTRY                   
         LA    RE,TPREC(RE)        RE-->LOCATION TO PUT NEXT ENTRY              
         USING SDQTABD,RE                                                       
         LA    R2,DBKEY                                                         
         USING PIKEY,R2                                                         
         MVC   SDQSTA,PISTA                                                     
         MVC   SDQDAY,PIDAY                                                     
         MVC   SDQSQH,PISQH                                                     
         MVC   SDQEQH,PIEQH                                                     
         DROP  RE                                                               
                                                                                
         LHI   RF,L'TPREC/SDQLENQ                                               
         CH    RF,TPDBARS          REACH MAX ENTRY FOR SDQTABD?                 
         BH    GIP327               NO, GO GET NEXT RECORD                      
         MVC   TPSVMKT,PIKMKT       YES, SAVE PIKMKT VALUE AND                  
         B     GIP330                GO PROCESS STUFF IN TABLE NOW              
*                                                                               
GIP327   MVI   IOFLAG,DIR+SEQ+DEM                                               
         GOTO1 AIO,IOFLAG                                                       
         BL    GIPXX                                                            
                                                                                
         LA    R1,(PIPNUM-PIKEY)+(L'PIPNUM-1)                                   
         OC    DBSELSTA,DBSELSTA                                                
         BZ    *+8                                                              
         LA    R1,(PISTA-PIKEY)+(L'PISTA-1)                                     
         EXCLC R1,PIKEY,KEYSAVE    WAS RECORD FOUND?                            
         BE    GIP315               YEP, ADD ENTRY TO SDQTABD                   
         MVI   TPDBARS+2,X'FF'      NO, FLAG NO MORE I-PTRS                     
         B     GIP330                AND READ RATINGS RECORDS                   
         DROP  R2                                                               
*                                                                               
** READ RATINGS RECORDS, DRIVING OFF FROM SDQTABD **                            
*                                                                               
GIP330   DS    0H                                                               
         MVC   TPENTRYS,TPDBARS    # OF ENTRIES IN SDQTABD (S/B > 0)            
         MVI   DBRECTYP,DBRECDEM                                                
         LA    R2,DBKEY                                                         
         USING DRKEY,R2                                                         
         XC    DRKMAJOR,DRKMAJOR                                                
         MVI   DRCODE,DRCODEQU                                                  
         MVC   DRMEDIA,DBINTMED                                                 
         MVC   DRSRC,DBACTSRC                                                   
         MVC   DRBOOK,SAVEBOOK                                                  
                                                                                
         LA    R3,TPREC            GET INFO FROM SDQTABD                        
         USING SDQTABD,R3                                                       
         OC    TPDBARS(2),TPDBARS  SEE IF ANY ENTRIES IN SDQTABD                
         BZ    GIP350               IF NOTHING, DON'T READ DEMO RECDS           
GIP332   MVC   DRSTAT,SDQSTA       STATION                                      
         XC    DRKMKT(8),DRKMKT    IGNORE SPLL MKT & LEFT-OVER GARBAGE          
                                                                                
         MVI   IOFLAG,DEM+DIR+HIGH                                              
         GOTO1 AIO,IOFLAG                                                       
         BL    GIPXX                                                            
         CLC   DRKMAJOR(12),KEYSAVE  THIS PART OF RECORD MUST BE THERE          
         BE    GIP332A                                                          
         MVI   DBERROR,HORREND        IF NOT, EXIT NOW                          
         B     GIPXX                                                            
*                                                                               
GIP332A  DS    0H                                                               
         CLC   DRSTYP,DBSTYPE      MATCH LOWER PARTS OF KEY                     
         BNE   GIP336                                                           
         CLC   DRBTYP,BOOKTYPE      TO REQUEST                                  
         BE    GIP334                                                           
                                                                                
         MVI   IOFLAG,DEM+DIR+SEQ  READ SEQUENTIAL TO TRY TO MATCH              
         GOTO1 AIO,IOFLAG           BOOKTYPE                                    
         BL    GIPXX                                                            
         CLC   DRKMAJOR(12),KEYSAVE  SEE IF THIS STILL MATCHES                  
         BE    GIP332A                YEP, GO MATCH STYPE & BTYPE               
                                                                                
         MVC   DRKMAJOR(12),KEYSAVE   NOPE, RESTORE MAJOR KEY,                  
         LH    RF,TPDBARS                                                       
GIP332C  LA    R3,SDQLENQ(R3)          AND GET NEXT SDQTAB ENTRY                
         BCTR  RF,0                                                             
         LTR   RF,RF                   (MAKE SURE THERE WERE MORE               
         BZ    GIP332D                   TO GET)                                
         CLC   DRSTAT,SDQSTA                                                    
         BE    GIP332C                                                          
GIP332D  STH   RF,TPDBARS              W/ DIFFERENT STATION                     
         LTR   RF,RF                                                            
         BP    GIP332                                                           
         BZ    GIP350                                                           
         MVI   DBERROR,HORREND                                                  
         B     GIPXX                                                            
*                                                                               
GIP334   DS    0H                                                               
         MVC   DBMINKEY,SDQDAY     MOVE IN DAY & START QH                       
         MVI   IOFLAG,DEM+FILE+HIGH                                             
         B     *+8                                                              
GIP334A  MVI   IOFLAG,DEM+FILE+SEQ                                              
         GOTO1 AIO,IOFLAG                                                       
         BL    GIPXX                                                            
         BE    GIP338                                                           
*                                                                               
GIP336   LA    R3,SDQLENQ(R3)      GET NEXT ENTRY IN SDQTAB                     
         LA    RE,GIP332           SET BRANCH ADDRESS                           
         CLC   DRSTAT,SDQSTA        IF STATION IS SAME AS CURRENT,              
         BNE   *+8                                                              
         LA    RE,GIP334             BRANCH BACK TO READ FILE ONLY              
         LH    RF,TPDBARS          DECREMENT # OF ENTRIES COUNTER               
         BCTR  RF,0                                                             
         STH   RF,TPDBARS                                                       
         LTR   RF,RF                                                            
         BPR   RE                                                               
         BZ    GIP350                                                           
         MVI   DBERROR,HORREND     CAN'T BE NEGATIVE                            
         B     GIPXX                                                            
*                                                                               
GIP338   GOTO1 ATSTMRKT                                                         
         BNE   GIPXIM                                                           
                                                                                
         L     R1,DBAREC                                                        
         AH    R1,DBDTADSP                                                      
*&&DO                                                                           
*** DEIS JAN/2020: OBSOLETE COMPRESSED DATE CODE NOW DISABLED                   
         USING MARELEM,R1                                                       
         CLI   MARCODE,MARCODEQ                                                 
         BNE   *+10                                                             
         MVC   DBCNVDTE,MARDATE                                                 
         DROP  R1                                                               
*&&                                                                             
                                                                                
         USING QHELEM,R1                                                        
GIP340   CLI   QHCODE,0                                                         
         BE    GIP334A                                                          
         CLI   QHCODE,QHCODEQ      TEST QH ELEM FOUND                           
         BNE   GIPBUMP              NO, LET'S PARTY!!                           
                                                                                
         CLC   QHDAY,SDQDAY        IF DAY IN QH ELEM > DAY                      
         BH    GIP336               > DAY OF PROGRAM, GET NEXT RECD             
         BL    GIPBUMP              < DAY OF PROGRAM, GET NEXT ELEM             
         CLC   QHSQH,SDQEQH        IF SQH IN QH ELEM > EQH OF PROGRAM,          
         BH    GIP336               THEN WE'RE DONE W/ CURR NXDA                
                                                                                
         ZIC   RF,1(R1)            MATCH ON PROGRAM NUMBER                      
         AR    RF,R1                                                            
         USING QIELEM,RF                                                        
         CLI   QICODE,QICODEQ       IN THE INFO ELEMENT                         
         BNE   GIPBUMP                                                          
         CLI   QIELN,4             IF ELEMENT IS A BACKWARD POINTER,            
         BNE   GIP340A                                                          
         ICM   R0,3,2(RF)           ADJUST FOR IT                               
         SLL   R0,17                                                            
         SRL   R0,17                                                            
         LR    RF,R0                                                            
         A     RF,DBAREC                                                        
GIP340A  CLC   QIPNUM,DBSELPR4+1                                                
         BNE   GIPBUMP                                                          
         DROP  R1,RF                                                            
                                                                                
         BAS   RE,SETDYQH          FOUND THE RIGHT PROGRAM ELEM                 
         LA    RF,DBDQTAB           NOW FIND CORRECT TIMES                      
*                                                                               
         DS    0H                   FIND ACTUAL LOCATION OF DAYS/QHS            
         CLC   =AL2(DBDQUXTD),DBDQTAB+0  DAYS/QHS IN EXTEND AREA?               
         BNE   GIP341X                    NOPE                                  
         LA    RF,DBEXTEND-4                                                    
GIP341M  DS    0H                        SEARCH EXTEND AREA                     
         ICM   RF,15,4(RF)                                                      
         JZ    *+2                                                              
         CLC   0(4,RF),DBDQTAB+2          FOR NAME SPECIFIED HERE               
         BNE   GIP341M                                                          
         AHI   RF,DBDQXFXL               RF-->DAYS/QHS TABLE                    
GIP341X  EQU  *                                                                 
                                                                                
*                                                                               
DBDQ     USING DBDQD,RF                                                         
GIP342   CLI   0(RF),EOT           IF AT END OF TABLE,                          
         BE    GIPBUMP              THEN PRGM DOESN'T MATCH TIMES               
         CLC   DBDQ.DBDQKDAY,SVQHDAY    MATCH ON DAY                            
         BNE   GIP342A                                                          
         CLC   DBDQ.DBDQSQH,SVQHEQH     TEST QTR HOURS                          
         BH    GIP342A                                                          
         CLC   DBDQ.DBDQEQH,SVQHSQH      WITHIN LIMITS                          
         BNL   GIP342X                                                          
GIP342A  LA    RF,DBDQLEN(RF)                                                   
         B     GIP342                                                           
GIP342X  DS    0H                  FOUND A GOOD PRG ELEM                        
         ZIC   R0,DBDQ.DBDQDAYW    HOLD ONTO DAY WEIGHT                         
         DROP  DBDQ                                                             
                                                                                
         MVC   DBACTSQC(2),SVQHSQH SET AS 'CURRENT' VALUES IN DBLOCK            
         ZIC   RE,SVQHSQH          CALCULATE DBFACTOR & DBDIVSOR                
         ZIC   RF,SVQHEQH                                                       
         LA    RF,1(RF)                                                         
         SR    RF,RE               CALC # OF QH                                 
         SR    RE,RE                                                            
         MR    RE,R0                AND MULTIPLY BY WEIGHT                      
         STH   RF,DBFACTOR                                                      
         AH    RF,DBDIVSOR                                                      
         STH   RF,DBDIVSOR                                                      
                                                                                
         ST    R1,DBAQUART         SET A(QH ELEMENT)                            
         ST    R1,TPSAVE            AND SAVE IT                                 
         MVI   DBMODE,DBMNEXT                                                   
         BAS   RE,GETX                                                          
         MVC   DBINTFIL(2),SVINTFIL  (THESE WERE SAVED BEFORE HOOK)             
         L     R1,TPSAVE                                                        
         B     GIPBUMP                                                          
         DROP  R3                                                               
*                                                                               
GIPBUMP  SR    R0,R0                                                            
         ICM   R0,1,1(R1)                                                       
         JZ    *+2                                                              
         AR    R1,R0                                                            
         B     GIP340                                                           
         EJECT                                                                  
*                                                                               
** SDQTABD EXHAUSTED, SEE IF MORE I-PTRS NEEDED **                              
*                                                                               
GIP350   DS    0H                                                               
         CLI   TPDBARS+2,X'FF'     WAS FLAG SET BEFORE?                         
         BE    GIPXEOF              YEP, PROCESSING DONE                        
                                                                                
         LH    RE,TPENTRYS          NOPE, PULL INFO FROM LAST ENTRY             
         BCTR  RE,0                                                             
         MHI   RE,SDQLENQ                                                       
         LA    RE,TPREC(RE)                                                     
         USING SDQTABD,RE                                                       
                                                                                
         LA    R2,DBKEY              TO BUILD THE I-PTR FOR NEXT READ           
         USING PIKEY,R2                                                         
         XC    PIKMAJOR,PIKMAJOR                                                
         MVI   PIKCODE,PICODEQU                                                 
         MVC   PIMEDIA,DBINTMED                                                 
         MVC   PISRC,DBACTSRC                                                   
         MVC   PIBOOK,SAVEBOOK                                                  
         MVC   PIPNUM,DBSELPR4+1                                                
         MVC   PISTA,SDQSTA                                                     
         MVC   PIKMKT,TPSVMKT                                                   
         MVC   PIDAY,SDQDAY                                                     
         MVC   PISQH,SDQSQH                                                     
         ZIC   R1,SDQEQH                                                        
         LA    R1,1(R1)            FORCE READ OF NEXT RECORD                    
         STC   R1,PIEQH                                                         
         DROP  R2,RE                                                            
                                                                                
         LA    RE,TPREC            CLEAR SDQTABD FOR MORE ENTRIES               
         LA    RF,L'TPREC                                                       
         XCEF                                                                   
                                                                                
         B     GIP310                                                           
         TITLE 'DEGETTP - TIME PERIOD FILE READ CONTROLLER (DBFUNCT=DBG+        
               ETIPR)'                                                          
GIP400   DS    0H                                                               
         MVI   DBERROR,0                                                        
         LA    RE,TPREC                                                         
         LA    RF,L'TPREC                                                       
         XCEF                                                                   
         XC    TPSAVE,TPSAVE                                                    
         XC    TPDBARS,TPDBARS                                                  
*                                                                               
** BUILD KEY & READ DEMO RECORDS **                                             
*                                                                               
         LA    R2,DBKEY                                                         
         USING DRKEY,R2                                                         
         XC    DRKMAJOR,DRKMAJOR                                                
         MVI   DRCODE,DRCODEQU                                                  
         MVC   DRMEDIA,DBINTMED                                                 
         MVC   DRSRC,DBACTSRC                                                   
         MVC   DRSTAT,DBACTSTA                                                  
         MVC   DRBOOK,SAVEBOOK                                                  
         XC    DRKMKT(8),DRKMKT                                                 
                                                                                
         MVI   DBRECTYP,DBRECDEM                                                
         MVI   IOFLAG,DEM+DIR+HIGH                                              
         B     *+8                                                              
GIP420   MVI   IOFLAG,DEM+DIR+SEQ                                               
         GOTO1 AIO,IOFLAG                                                       
         BL    GIPXX                                                            
         CLC   DRKEY(12),KEYSAVE   MATCH EVERYTHING UP TO STTN TYPE             
         BNE   GIPXEOF                                                          
                                                                                
         XC    DBMINKEY,DBMINKEY   GET SET TO READ FILE                         
         MVI   IOFLAG,DEM+FILE+HIGH                                             
         B     *+8                                                              
GIP430   MVI   IOFLAG,DEM+FILE+SEQ                                              
         GOTO1 AIO,IOFLAG                                                       
         BL    GIPXX                                                            
         BH    GIP20                                                            
                                                                                
         DS    0H                  GET PROG # AND NAMES FROM RECORD             
         L     R1,DBAREC                                                        
         AH    R1,DBDTADSP                                                      
         USING QHELEM,R1                                                        
GIP440   CLI   QHCODE,0            AT END OF RECORD?                            
         BE    GIP430               YES, READ NEXT RECORD IN FILE               
         CLI   QHCODE,QHCODEQ      AT QTR HR ELEMENT?                           
         BNE   GIP470               NOPE, BUMP TO NEXT ELEMENT                  
                                                                                
         DS    0H                  LOOK FOR PROG INFO ELEMENT                   
         ZIC   RF,QHELN                                                         
         AR    RF,R1                                                            
         USING QIELEM,RF                                                        
         CLI   QICODE,QICODEQ      PROGRAM INFO ELEMENT?                        
         BNE   GIP470               NOPE                                        
         CLI   QIELN,4             IS THIS A BACKWARD POINTER?                  
         BE    GIP470               YES, DO NEXT PROGRAM NUMBER                 
         OC    QIPNUM,QIPNUM       ANY PROGRAM NUMBER?                          
         BZ    GIP470               NOPE, LOOK IN NEXT PROG INFO ELEM           
         CLC   TPDBARS(2),MXPROGS  REACHED MAX OF PROGRAMS YET?                 
         BNL   GIPXEOF              YEP, EXIT W/ EOF NOW                        
                                                                                
         DS    0H                  SEE IF PROG# PROCESSED YET                   
         LA    R3,TPREC                                                         
         ICM   R0,3,TPDBARS        R0=# OF ENTRIES IN TABLE                     
         BZ    GIP455                                                           
GIP450   CLC   QIPNUM,0(R3)                                                     
         BE    GIP470              MATCH FOUND, GO ON TO NEXT PROG#             
         LA    R3,L'QIPNUM(R3)                                                  
         BCT   R0,GIP450                                                        
*                                                                               
GIP455   DS    0H                  PROG# NOT PROCESSED YET                      
         MVC   0(L'QIPNUM,R3),QIPNUM    ADD IT TO TABLE                         
         LH    RE,TPDBARS                                                       
         LA    RE,1(RE)                                                         
         STH   RE,TPDBARS               INCREMENT # ENTRIES                     
                                                                                
         ST    R1,DBAQUART                                                      
         ST    R1,TPSAVE                                                        
         MVI   DBMODE,DBMNEXT                                                   
         BAS   RE,GETX                  PASS IT TO CALLER'S HOOK                
         MVC   DBINTFIL(2),SVINTFIL  (THESE WERE SAVED BEFORE HOOK)             
         L     R1,TPSAVE                                                        
*                                                                               
GIP470   DS    0H                  BUMP ELEMENT POINTER                         
         SR    R0,R0                                                            
         ICM   R0,1,QHELN                                                       
         JZ    *+2                                                              
         AR    R1,R0                                                            
         B     GIP440                                                           
                                                                                
         DROP  R1,R2,RF                                                         
         TITLE 'DEGETTP - TIME PERIOD FILE READ CONTROLLER (GET PROGRAM+        
               INFO)'                                                           
GIPKEY   DS    0H                  BUILD KEY OF I-PTR                           
         LA    R2,DBKEY                                                         
         USING PIKEY,R2                                                         
         XC    PIKMAJOR,PIKMAJOR                                                
         MVI   PIKCODE,PICODEQU                                                 
         MVC   PIMEDIA,DBINTMED                                                 
         MVC   PISRC,DBACTSRC                                                   
         MVC   PIBOOK,SAVEBOOK                                                  
         MVC   PIPNUM,DBSELPR4+1                                                
         MVC   PISTA,DBACTSTA                                                   
         DROP  R2                                                               
         BR    RE                                                               
         SPACE 2                                                                
GIPXIF   MVI   DBERROR,INVFILE                                                  
         B     GIPXX                                                            
GIPXFM   MVI   DBERROR,INVFM                                                    
         B     GIPXX                                                            
GIPXIM   MVI   DBERROR,INVMRKT                                                  
         B     GIPXX                                                            
GIPXNF   MVI   DBERROR,NOTFOUND                                                 
         B     GIPXX                                                            
GIPXEOF  MVI   DBERROR,EOF                                                      
         B     GIPXX                                                            
*                                                                               
GIPXX    B     GETX                                                             
***********************************************************************         
                                                                                
         TITLE 'DEGETTP - TIME PERIOD FILE READ CONTROLLER'                     
GETX     CLI   DBERROR,0           TEST IF ERROR SET                            
         BE    *+14                                                             
         XC    DBAQUART,DBAQUART   YES - CLEAR QTR HOUR ADDRESS                 
         MVI   DBMODE,DBMFRST      AND RESET SEQUENTIAL MODE                    
         MVC   DBLSTFNC,DBFUNCT    EQUATE LAST FUNCTION TO THIS                 
         MVC   DBSELBK,SVSELBK                                                  
         MVC   DBSELDAT,SVSELDAT                                                
*                                                                               
* THIS SECTION OF CODE ONKY ADDED TO SUPPORT TOON/ADSM                          
         OC    TOONLIST,TOONLIST                                                
         BZ    GETX4                                                            
         CLI   DBERROR,NOTFOUND                                                 
         BNE   GETX4                                                            
         CLI   MSTAFLG,MSTADONE                                                 
         BE    GETX4                                                            
         MVI   DBERROR,0                                                        
         MVI   MERGEF,C'N'     SET FLAG NOT TO MERGE ADSM/TOON                  
         B     GETTP34P        IF ONE OF STATION/BOOK NOT FOUND                 
*                                                                               
GETX4    CLI   DBERROR,0                                                        
         BE    *+10                                                             
         MVC   DBSELPRG,SVSELPRG                                                
         OC    AUSERRTN,AUSERRTN   TEST IF USER HOOK SUPPLIED                   
         BNZ   GETX5                YES - DON'T RETURN TO CALLER YET            
         GOTO1 VSUBR01,TPDMCB,('RSTDQLKQ',(RC))                                 
         MVC   DBSELSTA,SVCALL       RESTORE ORGINAL CALL LETTER                
         MVC   DBSELALF,SVALF                                                   
         MVC   DBSELMK,SVSELMK                                                  
         B     GETXX                NO - RETURN TO CALLER                       
                                                                                
GETX5    CLI   DBERROR,0           TEST IF ERROR SET                            
         BE    GETX10               NO - DON'T RETURN TO CALLER YET             
         GOTO1 VSUBR01,TPDMCB,('RSTDQLKQ',(RC))                                 
         MVC   DBSELSTA,SVCALL       RESTORE ORGINAL CALL LETTER                
         MVC   DBSELALF,SVALF                                                   
         MVC   DBSELMK,SVSELMK                                                  
         B     GETXX                YES - RETURN TO CALLER                      
                                                                                
GETX10   MVC   SVINTFIL(2),DBINTFIL  SAVE INTFIL/INTMED BEFORE HOOK             
         CLI   DBMODE,DBMNEXT      TEST IF SEQUENTIAL MODE                      
         BE    *+8                                                              
         LA    RE,GETXX            NO - SET RETURN TO EXIT                      
*                                                                               
         NTR1  ,                   SAVE REGS & GO TO USER HOOK                  
*                                                                               
         CLC   =C'NICK',DBSELSTA                                                
         BE    *+10                                                             
         CLC   =C'NAN ',DBSELSTA                                                
         BE    *+10                                                             
         CLC   =C'ADSM',DBSELSTA                                                
         BE    *+10                                                             
         CLC   =C'TOON',DBSELSTA                                                
         BNE   GETXX1                                                           
         BRAS  RE,GETPNAME                                                      
* IF MERGEF IS C'N' THAT MEANS ONE OF THE TOON STATION WAS NOT                  
* VALID EX, ADSM/DAV FOR NOV17(W) IS NOT VALID BUT TOON/DAV IS VALID            
* BUT HAS HOURS WHICH ARE OFF AIR.  WE CANT SKIP THESE                          
* JUST LEAVE ALONG ELSE THE SUMMARY AVERAGE IS MISSING THOSE OFF AIR            
* QTR HOURS                                                                     
         CLI   MERGEF,C'N'                                                      
         BE    GETXX1                                                           
         CLC   =C'OFF AIR',PRGNAME  DONT RETURN OFF AIR PROGRAMS                
         BNE   GETXX1               FOR ADSM OR TOON                            
                                                                                
         LH    RE,DBFACTOR                                                      
         LH    RF,DBDIVSOR         READJUST WEIGHTING                           
         SR    RF,RE                                                            
         STH   RF,DBDIVSOR                                                      
         B     GETXX                                                            
*                                                                               
GETXX1   DS    0C                                                               
***                                                                             
         L     RF,AUSERRTN                                                      
         L     RE,ROOTRD                                                        
         LR    R0,RE               R0=A(CALLER'S RD)                            
         LM    R1,RC,24(RE)        R1-RC=CALLERS REGISTERS                      
         BASR  RE,RF               GO TO USER HOOK                              
*                                                                               
GETXX    XIT1  ,                   EXIT TO CALLER OR DEMAND                     
         EJECT                                                                  
* EXTRACT STATION CALL LETTERS FROM DBLOCK INTO DUB                             
*                                                                               
* ON EXIT R1=L'STATION CALL LETTERS (EXCLUDING TYPE)                            
*                                                                               
GETCALL  MVI   DUB,C' '                                                         
         MVC   DUB+1(4),DUB                                                     
         MVC   DUB(4),DBSELSTA                                                  
         CLI   DBFUNCT,DBGETTOT                                                 
         BE    *+12                                                             
         CLI   DBFUNCT,DBGETTTL    TEST FOR SPDEMUP MKT TOTS                    
         BNE   *+10                                                             
         MVC   DUB(4),DBACTSTA                                                  
         LA    R1,4                                                             
         CLI   DBSELMED,C'R'                                                    
         BNER  RE                                                               
*                                                                               
         MVC   DUB(5),DBSELSTA     RADIO HAS 5 CHAR CALL LETTERS                
         CLI   DBFUNCT,DBGETTOT                                                 
         BNE   *+10                                                             
         MVC   DUB(5),DBACTSTA                                                  
         LA    R1,5                                                             
         BR    RE                                                               
         EJECT                                                                  
SETDYQH  NTR1  ,                                                                
         USING QHELEM,R1                                                        
         USING RDPTABD,RE                                                       
         MVC   SVQHDAY,QHDAY                                                    
         MVC   SVQHSQH,QHSQH                                                    
         MVC   SVQHEQH,QHEQH                                                    
*                                                                               
         CLC   DBFILE,=C'RTP'                                                   
         BNE   SETDYQH1                                                         
         LHI   RE,(RARDPTAB-GETTP)                                              
         LA    RE,GETTP(RE)                                                     
         B     SETDYQH2                                                         
SETDYQH1 CLI   RDAYPART,C'Y'                                                    
         BNE   SETDYQHX                                                         
*                                                                               
         LARL  RE,RARDPTAB                                                      
SETDYQH2 CLI   0(RE),0                                                          
         BE    SETDYQHX                                                         
         CLC   RDPDPT,SVQHSQH                                                   
         BNE   *+14                                                             
         CLC   RDPDAY,SVQHDAY                                                   
         BE    SETDYQH4                                                         
         ZIC   RF,RDPLEN                                                        
         AR    RE,RF                                                            
         B     SETDYQH2                                                         
         SPACE 1                                                                
SETDYQH4 MVC   SVQHSQH,RDPQXS                                                   
         MVC   SVQHEQH,RDPQXE                                                   
         ZIC   RF,SVQHEQH                                                       
         BCTR  RF,0                                                             
         STC   RF,SVQHEQH                                                       
*                                                                               
SETDYQH5 DS    0H                                                               
*        CLC   DBFILE,=C'RTP'                                                   
*        BNE   SETDYQHX                                                         
*        MVC   SVQHSQH,RDPDPT                                                   
*        MVC   SVQHEQH,RDPDPT                                                   
*        ZIC   RF,SVQHEQH                                                       
*        BCTR  RF,0                                                             
*        STC   RF,SVQHEQH                                                       
*                                                                               
SETDYQHX B     GETXX                                                            
         DROP  R1,RE                                                            
         EJECT                                                                  
***********************************************************************         
*=================== CHECK IF ABLE TO USE ARBITRON ===================*         
                                                                                
* Arbitron stopped its television service in Jan 1994, but it still             
*  swept 2 markets for the Feb/94 book.  If request is for TV/Arb in            
*  one of the two markets, leave it alone, else, change source to NSI           
                                                                                
ARBLIVE  NTR1                                                                   
         B     ARBLIVX                                                          
*&&DO                                                                           
         CLI   DBSELMED,C'T'       ARB TV DIED IN JAN 1994                      
         BNE   ARBLIVX              EXCEPT FOR 2 MARKETS                        
         CLI   DBSELSRC,C'A'       SO FORCE IT TO NSI                           
         BNE   ARBLIVX                                                          
*******taken out 99/12/17  ***********                                          
*        OC    DBACTBK,DBACTBK                                                  
*        BZ    ARBLIV6                                                          
*        CLI   DBACTBK,X'5E'       TEST PRIOR TO 94                             
*        BL    ARBLIVX              YES - LEAVE IT ALONE                        
*        CLC   DBACTBK,=AL2(FEB_94) LAST 94 BOOK IN FEB                         
*        BH    ARBLIV6              SO IF LATER, MAKE IT NSI                    
*                                                                               
*RBLIV2  LA    RE,ARBT94                                                        
*RBLIV4  CLI   0(RE),X'FF'         BYPASS FOR SELECT MARKETS                    
*        BE    ARBLIV6                                                          
*        CLC   DBSELSTA(4),0(RE)                                                
*        BE    ARBLIVX                                                          
*        LA    RE,4(RE)                                                         
*        B     ARBLIV4                                                          
******************end of 99/12/17 delete**************                          
ARBLIV6  MVI   DBSELSRC,C'N'                                                    
         MVI   DBACTSRC,C'N'                                                    
*&&                                                                             
ARBLIVX  B     GETXX                                                            
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*==================== EOF ON SEQUENTIAL FILE READS ===================*         
                                                                                
* In some cases, DEMAND may be required to do extra tasks on an EOF             
*  condition occurs while reading the DEMFIL sequentially.  This rtn            
*  lets DEMAND have a chance to do the task(s) it's expected to do.             
* At exit, a condition is set.  On EQUAL, it means that there are more          
*  records to process.  NOTEQUAL means really the end-of-file.                  
                                                                                
         DS    0H                                                               
EOFSEQ   NTR1                                                                   
                                                                                
         OI    TPMODE,TPMEOFSQ     WE'VE BEEN HERE FOR CURR DQTAB NTRY          
                                                                                
         CLI   DBSELMED,C'R'       TEST TO BRANCH TO CORRECT CODE               
         BE    RADOVDPT                                                         
         CLI   DBSELMED,C'O'       OVERNIGHT TP                                 
         BE    *+8                                                              
         CLI   DBSELMED,C'T'       TEST FOR TV,                                 
         BNE   EOFSQ06X                                                         
         CLI   DBSELSRC,C'N'        NSI                                         
         BNE   EOFSQ06X                                                         
         B     EOFSQTN                                                          
EOFSQ06X EQU   *                                                                
         BNE   EOFSEQNE                                                         
         SPACE 2                                                                
* For radio time-period requests, if the selected times happen to fall          
*  between 1am - 5am, then we should return info from the daypart file          
*  for those times.                                                             
                                                                                
RADOVDPT DS    0H                                                               
         CLI   TPRCNDS,C'Y'        PROCESSING CONDENSED RADIO MKT?              
         BE    EOFSEQNE             YEP, SKIP THIS OV DPT ROUTINE               
                                                                                
         L     RE,ADQNTRY                                                       
DBDQ     USING DBDQD,RE                                                         
         CLI   DBDQ.DBDQEQH,X'50'  CHECK REQUESTED END QH BETW/ 1AM             
         BL    EOFSEQNE                                                         
         CLI   DBDQ.DBDQEQH,X'5F'   AND 5AM                                     
         BH    EOFSEQNE                                                         
         DROP  DBDQ                                                             
         CLI   DBBEST,C'P'         CHECK IF RADIO POSTING                       
         BNE   EOFSEQNE                                                         
         TM    TPMODE,TPMROVDP     DONE RADIO OVERNGHT DPT YET?                 
         BO    ROD50                YEP, DON'T REPEAT IT                        
                                                                                
         DS    0H                  SAVE ORIGINAL VALUES                         
         LA    R1,TPL1Q-1           CLEAR TPLSTDIR, TPDBFILE,                   
         EX    R1,*+8                TPMINKEY, & TPSELPRG                       
         B     *+10                                                             
         XC    TPLSTDIR(0),TPLSTDIR                                             
         MVC   TPLSTDIR,DBLSTDIR    SAVE LAST KEY READ                          
         MVC   TPDBFILE,DBFILE       "   FILE                                   
         MVC   TPSELPRG,DBSELPRG     "   PROG NUM                               
         MVC   TPMINKEY,DBMINKEY     "   MINOR KEY BUILT FROM REQUEST           
         L     RE,DBAREC                                                        
         MVC   TPMNKYRD,L'DBKEY(RE)  "   MINOR KEY JUST READ                    
                                                                                
         DS    0H                  GET SET TO READ DAYPART RECORD               
         MVC   DBFILE,=C'RDP'       RADIO DAYPART                               
         CLI   DBSELSRC,C'R'                                                    
         BNE   *+10                                                             
         MVC   DBFILE,=C'RTP'                                                   
**       MVC   DBSELPRG,=H'8'       DAYPART CODE                                
         MVC   DBSELPRG,=H'21'      DAYPART CODE                                
         MVI   DBKEY,C'D'           RECORD CODE                                 
         L     RE,ADQNTRY                                                       
DBDQ     USING DBDQD,RE                                                         
         MVC   DBMINKEY(1),DBDQ.DBDQKDAY  SET MINOR KEY--DAY AND                
**       MVI   DBMINKEY+1,8           DAYPART CODE                              
         MVI   DBMINKEY+1,21          NEW DAYPART CODE                          
*** THIS MESSES UP LAT2 LOOKUP 11A-2A                                           
* but without it- it 1s-5a doesnt show up                                       
         MVI   RDAYPART,C'Y'          SET READ DAYPRT FILE FLAG                 
         DROP  DBDQ                                                             
                                                                                
         MVI   IOFLAG,DIR+HIGH+DEM       READ DIRECTORY                         
         GOTO1 AIO,IOFLAG                                                       
         BNE   ROD60                                                            
         CLC   DBKEY,KEYSAVE                                                    
         BNE   ROD60                                                            
         MVI   IOFLAG,FILE+HIGH+DEM      READ FILE                              
         GOTO1 AIO,IOFLAG                                                       
         BNE   ROD60                                                            
                                                                                
         DS    0H                  FOUND A GOOD RECORD,                         
         OI    TPMODE,TPMROVDP      FLAG THAT IT'S RADIO OVERNGHT DPT           
         B     EOFSEQEQ             AND EXIT W/ GOOD CC CODE                    
*                                                                               
ROD50    DS    0H                  RESET TPMODE                                 
         NI    TPMODE,X'FF'-TPMROVDP                                            
*                                                                               
ROD60    DS    0H                  RESTORE VALUES AND EXIT W/ NEQUAL            
         MVC   DBLSTDIR,TPLSTDIR    LAST KEY READ                               
         MVC   DBFILE,TPDBFILE      FILE                                        
         MVC   DBSELPRG,TPSELPRG    PROG NUM                                    
         MVC   DBMINKEY,TPMNKYRD    MINOR KEY FROM LAST READ                    
         MVI   RDAYPART,C'N'        REST TP RTP                                 
                                                                                
         MVI   IOFLAG,DEM+DIR+HIGH   RESTORE I/O READS                          
         GOTO1 AIO,IOFLAG                                                       
         MVI   IOFLAG,DEM+FILE+HIGH                                             
         GOTO1 AIO,IOFLAG                                                       
                                                                                
         MVC   DBMINKEY,TPMINKEY    RESTORE MINOR KEY OF DBLOCK                 
         B     EOFSEQNE                                                         
         EJECT                                                                  
EOFSQTN  DS    0H                                                               
                                                                                
* For NSI TV time-period requests, if the selected times fall between           
*  2am - 6am, then we need to read the file for booktype x'05'                  
                                                                                
         DS    0H                                                               
         CLI   DBBTYPE,0           2A-6A DATA IN REGULAR SURVEY ONLY            
         BNE   EOFSEQNE                                                         
*                                                                               
         DS    0H                                                               
         L     RE,ADQNTRY                                                       
DBDQ     USING DBDQD,RE                                                         
         CLI   DBDQ.DBDQEQH,QHTN0200 CHECK REQUESTED TIME OVERLAP 2A-6A         
         BNH   EOFSEQNE                                                         
         CLI   DBDQ.DBDQSQH,QHTN0545                                            
         BH    EOFSEQNE                                                         
         DROP  DBDQ                                                             
                                                                                
*                                                                               
NSI2A6A  DS    0H                                                               
         TM    TPMODE,TPMN2A6A     ARE WE PROCESSING NSI 2A6A DATA YET?         
         BO    N26060               YEP                                         
                                                                                
*                                                                               
         DS    0H                  SAVE ORIGINAL VALUES                         
         XC    TPLSTDIR(TPL1Q),TPLSTDIR                                         
         MVC   TPLSTDIR,DBLSTDIR    SAVE LAST KEY READ                          
         MVC   TPDBFILE,DBFILE       "   FILE                                   
         MVC   TPSELPRG,DBSELPRG     "   PROG NUM                               
         MVC   TPMINKEY,DBMINKEY     "   MINOR KEY BUILT FROM REQUEST           
         L     RE,DBAREC                                                        
         MVC   TPMNKYRD,L'DBKEY(RE)  "   MINOR KEY JUST READ                    
                                                                                
*                                                                               
         DS    0H                  GET SET TO READ NSI 2A-6A DATA               
         MVI   DBKEY+(DRBTYP-DRKEY),X'05'  IT'S WHERE NSI 2A-6A DATA IS         
*                                                                               
         L     RE,ADQNTRY                                                       
DBDQ     USING DBDQD,RE                                                         
         MVC   DBMINKEY+0(1),DBDQ.DBDQKDAY  SET MINOR KEY--DAY AND              
         MVC   DBMINKEY+1(1),DBDQ.DBDQSQH    QHR CODE                           
         DROP  DBDQ                                                             
                                                                                
         CLI   DBMINKEY+1,QHTN0200         IF QHR < 2A                          
         BNL   *+8                                                              
         MVI   DBMINKEY+1,QHTN0200          FORCE TO READ 2A                    
                                                                                
*                                                                               
         DS    0H                                                               
         MVI   IOFLAG,DIR+HIGH+DEM       READ DIRECTORY                         
         GOTO1 AIO,IOFLAG                                                       
         BNE   N26060                                                           
         CLC   DBKEY,KEYSAVE                                                    
         BNE   N26060                                                           
         MVI   IOFLAG,FILE+HIGH+DEM      READ HIGH ON FILE                      
         GOTO1 AIO,IOFLAG                                                       
         BNE   N26060                                                           
                                                                                
*                                                                               
         DS    0H                  FOUND A GOOD RECORD,                         
         OI    TPMODE,TPMN2A6A      FLAG THAT IT'S NSI 2A-6A DATA               
         B     EOFSEQEQ             AND EXIT W/ GOOD CC CODE                    
                                                                                
*                                                                               
N26060   DS    0H                  RESET TPMODE                                 
         NI    TPMODE,X'FF'-TPMN2A6A                                            
*                                                                               
         DS    0H                  RESTORE VALUES AND EXIT W/ NEQUAL            
         MVC   DBLSTDIR,TPLSTDIR    LAST KEY READ                               
         MVC   DBFILE,TPDBFILE      FILE                                        
         MVC   DBSELPRG,TPSELPRG    PROG NUM                                    
         MVC   DBMINKEY,TPMNKYRD    MINOR KEY FROM LAST READ                    
                                                                                
         MVI   IOFLAG,DEM+DIR+HIGH   RESTORE I/O READS                          
         GOTO1 AIO,IOFLAG                                                       
         MVI   IOFLAG,DEM+FILE+HIGH                                             
         GOTO1 (RF),IOFLAG                                                      
                                                                                
         MVC   DBMINKEY,TPMINKEY    RESTORE MINOR KEY OF DBLOCK                 
         B     EOFSEQNE                                                         
         EJECT                                                                  
         SPACE 2                                                                
*                                                                               
** EOFSEQ EXITS **                                                              
*                                                                               
EOFSEQEQ CR    RB,RB               SET CC TO EQUAL ON EXIT                      
         BE    GETXX                                                            
EOFSEQNE CR    RA,RB                                                            
         BNE   GETXX                                                            
         DC    H'0'                                                             
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*========================= GET RADIO DAYPART =========================*         
                                                                                
* This routine is used when TPRCNDS=C'Y', and is user for setting the           
*  next key day and daypart into DBSELPRG.  The return codes are:               
*   CC equal     ==> successful in getting next daypart                         
*   CC not equal & DBERROR=0       ==> no more daypart to get                   
*   CC not equal & DBERROR=HORREND ==> something's amiss                        
                                                                                
GETRDPT  NTR1                                                                   
         MVI   DBERROR,0                                                        
         LA    R1,RCNDSDPT         R1-->LIST OF DPT CODES TO USE                
         L     RE,TPATBLE          RE-->SECTN OF RAD DPT TAB W/ KEY DAY         
         USING RDPTABD,RE                                                       
         L     RF,ADQNTRY          RF-->REQUESTED DAY/QH ENTRY IN DQTAB         
DBDQ     USING DBDQD,RF                                                         
                                                                                
         CLI   DBSELPRG+1,0        FIRST TIME THROUGH FOR DQNTRY?               
         BNE   GRD10                NOPE, FIND WHERE WE LEFT OFF                
         CLI   RDPDAY,X'95'         YEP, GO FIND DAYPART ENTRY NOW              
         BE    GRD20A                                                           
         LA    R1,1(R1)              SKIP DAYPART CODE 12 IF                    
         B     GRD20A                NOT M-F DAY                                
*                                                                               
GRD10    DS    0H                  FIND DPT CODE LAST PROCESSED                 
         CLC   DBSELPRG+1(1),0(R1)                                              
         BE    GRD20               FOUND IT!                                    
         LA    R1,1(R1)                                                         
         CLI   0(R1),0             BETTER NOT BE AT EOLIST!                     
         BE    GRDBAD                                                           
         B     GRD10                                                            
*                                                                               
GRD20    DS    0H                 LOCATE DAYPART CODE ENTRY                     
         SR    R0,R0                                                            
         LA    R1,1(R1)            BUMP TO NEXT DPT CODE IN LIST                
         L     RE,TPATBLE          RE-->SECTN OF RAD DPT TAB W/ KEY DAY         
         CLI   0(R1),0             CHECK IF EOLIST                              
         BE    GRDNO                YEP, NO MORE TO COME                        
GRD20A   CLC   0(1,R1),RDPDPT      MATCH TO ENTRY IN RAD DPT TABLE              
         BE    GRD30                                                            
         IC    R0,RDPLEN                                                        
         AR    RE,R0                                                            
         C     RE,TPATBLEX         BETTER NOT PASS EOTABLE!                     
         BH    GRDBAD                                                           
         B     GRD20A                                                           
*                                                                               
GRD30    DS    0H                 CHECK DAYPART AND DQNTRY OVERLAP              
         CLC   DBDQ.DBDQEQH,RDPQXS                                              
         BL    GRD20                                                            
         CLC   DBDQ.DBDQSQH,RDPQXE                                              
         BH    GRD20                                                            
                                                                                
         CLI   RDPDPT,12           FOR DAYPART CODE OF 12,                      
         BNE   GRD35                                                            
         CLI   DBDQ.DBDQSQH,QX6A    MAKE SURE DQNTRY OVERLAPS                   
         BL    GRD35                 5A-6A HOUR                                 
         L     RE,TPATBLE           ELSE, GET NEXT DPT CODE IN LIST             
         B     GRD20                                                            
*                                                                               
GRD35    DS    0H                                                               
         MVC   DBSELPRG(1),RDPDAY     GET KEY DAY                               
         MVC   DBSELPRG+1(1),RDPDPT   GET DAYPART CODE                          
         B     GRDYES                                                           
         DROP  RE,DBDQ                                                          
*                                                                               
GRDBAD   MVI   DBERROR,HORREND     SIGNAL SOMETHING BAD HAS HAPPENED            
         B     GRDNO                                                            
         SPACE 2                                                                
GRDNO    CR    RA,RB                                                            
         BNE   GETXX                                                            
GRDYES   CR    RB,RB                                                            
         BE    GETXX                                                            
***********************************************************************         
         EJECT                                                                  
*&&DO                                                                           
***********************************************************************         
*======================= TRANSLATE ALPHA MARKET ======================*         
                                                                                
* This routine is used map an alpha mkt (stored in DUB(3)) to a                 
*  numeric market using the AlphaMkt table in high-core.                        
* At entry,                                                                     
*   DUB(3)   = blank-padded alpha market                                        
* At exit,                                                                      
*   DUB+3(2) = numeric market                                                   
***********************************************************************         
         SPACE 1                                                                
TRAMKT   NTR1  ,                                                                
         XC    DUB+3(2),DUB+3                                                   
* FOR FUSION TRANSLATE BASE ON NSI                                              
         CLI   DBSELSRC,C'F'                                                    
         BNE   *+8                                                              
         MVI   DBACTSRC,C'N'                                                    
* WEEKLY ALSO USE THE SAME TABLE AS USTV NSI                                    
         CLI   DBSELMED,C'W'                                                    
         BNE   *+8                                                              
         MVI   DBINTMED,C'T'                                                    
* OVENRIGHTS ALSOUSE SAME TABLE AS USTV NSI                                     
         CLI   DBSELMED,C'O'                                                    
         BNE   *+8                                                              
         MVI   DBINTMED,C'T'                                                    
*                                                                               
         ICM   R2,15,AAMKTTAB      R2-->ALPHAMKT TABLE IN HIGH CORE             
         BZ    TAMX                                                             
         LAM   AR2,AR2,ALET                                                     
         SAC   512                                                              
         USING DAMHDRD,R2                                                       
                                                                                
         MVI   WORK,X'FF'          ASSUME DEFAULT BOOK TYPE                     
         CLI   DBBTYPE,0                                                        
         BE    *+10                                                             
         MVC   WORK(1),DBBTYPE                                                  
                                                                                
         LA    RE,TAM02                                                         
         O     RE,=X'80000000'                                                  
         BSM   0,RE                SWITCH TO 31-BIT MODE                        
*                                                                               
TAM02    CLC   0(2,R2),=X'FFFF'    AT END OF TABLE YET?                         
         BE    TAM14                                                            
         CLC   DAMHMED,DBINTMED    MATCH AGAINST MEDIA,                         
         BNE   TAM04                                                            
*                                                                               
         CLI   DBACTSRC,C'T'       FOR TRITON,                                  
         BNE   TAM05                                                            
         CLI   DAMHSRC,C'A'        USE ARBITRON MARKET LIST                     
         BNE   TAM04                                                            
         B     TAM06                                                            
*                                                                               
TAM05    CLC   DAMHSRC,DBACTSRC    AND SOURCE                                   
         BNE   TAM04                                                            
         B     TAM06                                                            
*                                                                               
TAM04    ICM   R0,15,DAMHAET       BUMP TO NEXT MEDIA/SOURCE SECTION            
         AHI   R0,1                                                             
         LR    R2,R0                                                            
         B     TAM02                                                            
*                                                                               
TAM06    XR    R0,R0               MEDIA/SOURCE SECTION FOUND                   
         ICM   R0,3,DAMHLDE        R0=L(DATA ELEMENT)                           
         LR    R3,R2                                                            
         AHI   R3,DAMHDRL                                                       
         CPYA  AR3,AR2                                                          
         USING DAMDTAD,R3                                                       
                                                                                
TAM08    CLC   DAMDAMKT,DUB        NOW MATCH ON ALPHA MARKET                    
         BH    TAM14                EXIT NOW, NO USE LOOKING FURTHER            
         BL    TAM12                WANT EXACT MATCH                            
*                                                                               
*                                  NOW MATCH ON BOOKTYPE                        
*                                                                               
         CLI   WORK,C'R'           OVERLAP FOR SQAD HISPANIC                    
         BE    *+12                 DON'T DEFAULT                               
         CLI   DAMDBTYP,X'FF'      USE DEFAULT BOOKTYPE IF CAN'T MATCH          
         BE    TAM10                BOOKTYPE EXACTLY                            
         CLC   DAMDBTYP,WORK       BOOKTYPE MATCH (WORK(1)=BOOKTYPE) ?          
         BNE   TAM12                NO, BUMP TO NEXT ENTRY                      
                                                                                
TAM10    MVC   DUB+3(2),DAMDNMKT   FOUND NUMERIC MARKET                         
         CLI   DBSELMED,C'W'                                                    
         BNE   TAM14                                                            
         CLC   DUB+3(2),=X'00A8'   168 = ATL                                    
         BNE   *+10                FOR WEEKLY IT WAS NEVER CHANGED TO           
         MVC   DUB+3(2),=X'007C'   168- KEEP USING 124                          
         B     TAM14                                                            
                                                                                
TAM12    AR    R3,R0               BUMP TABLE POINTER                           
         CLM   R3,15,DAMHAET       COMPARE AGAINST EOTABLE ADDRESS              
         BL    TAM08                CONTINUE IF STILL LOW                       
*                                                                               
TAM14    SAC   0                                                                
         LAM   AR2,AR3,ARZERO                                                   
         LA    RE,*+6              SWITCH FROM 31-BIT MODE                      
         BSM   0,RE                                                             
*                                                                               
TAMX     CLI   DBSELSRC,C'F'       RESET BACK TO FUSION                         
         BNE   *+8                                                              
         MVI   DBACTSRC,C'F'                                                    
         CLI   DBSELMED,C'W'       RESET BACK FOR WEEKLY                        
         BNE   *+8                                                              
         MVI   DBINTMED,C'W'                                                    
         CLI   DBSELMED,C'O'       RESET BACK FOR OVERNIGHTS                    
         BNE   *+8                                                              
         MVI   DBINTMED,C'O'                                                    
         B     GETXX               EXIT                                         
         DROP  R2,R3                                                            
         EJECT                                                                  
*&&                                                                             
*&&DO                                                                           
***********************************************************************         
*======================== 1996 SUMMER OLYMPICS =======================*         
***********************************************************************         
         SPACE 1                                                                
* At entry,                                                                     
*   R6-->DBLOCK                                                                 
                                                                                
SUMOLY96 NTR1                                                                   
         USING DBLOCKD,R6                                                       
                                                                                
         CLI   DBSELMED,C'T'       IS IT TV?                                    
         BNE   SO96X                NO, DON'T BOTHER                            
         CLI   BOOKTYPE,0          IF BOOKTYPE SET ALREADY,                     
         BNE   SO96X                THEN DON'T BOTHER                           
         CLC   DBSELBK,=AL2(JUL_96) IF BOOK IS NOT JUL96                        
         BNE   SO96X                THEN DON'T BOTHER                           
         CLC   DBSELAGY,=C'11'     FOR CPPRS SPECIAL                            
         BE    SUMOL96A                                                         
         CLI   DBBEST,C'O'         IF NOT ASKING TO USE OLYMPIC EXCLSN          
         BNE   SO96X                THEN DON'T BOTHER                           
         OC    DBSEL1WK,DBSEL1WK   PASSED IN A SPECIFIC DATE?                   
         BZ    SO96X                NO, DON'T BOTHER                            
                                                                                
SUMOL96A CLC   DBSEL1WK,=X'C0EB'   IS DATE IN JUL96 SWEEP PERIOD?               
         BL    SO050                (JUL11/96 - AUG07/96)                       
         CLC   DBSEL1WK,=X'C107'                                                
         BH    SO050                YES, DON'T BOTHER                           
                                                                                
         B     SO96X                                                            
                                                                                
*                                                                               
SO050    DS    0H                  SEE IF STATION HAS BOOKTYPE 'O'              
         LA    R2,DBKEY                                                         
         USING DRKEY,R2                                                         
         XC    DRKMAJOR,DRKMAJOR                                                
         MVC   DRCODE,RECCODE                                                   
         MVC   DRMEDIA,DBINTMED                                                 
         MVC   DRSRC,DBACTSRC                                                   
         MVC   DRSTAT,DBACTSTA                                                  
         MVC   DRBOOK,SAVEBOOK                                                  
         MVC   DRKMKT,DBACTKMK                                                  
         MVC   DRSTYP,DBSTYPE                                                   
         MVI   DRBTYP,C'O'                                                      
                                                                                
         MVI   IOFLAG,DIR+HIGH+DEM                                              
         GOTO1 AIO,IOFLAG                                                       
         BL    SO96X                                                            
         CLC   DRKMAJOR,KEYSAVE                                                 
         BNE   SO96X                                                            
         MVI   BOOKTYPE,C'O'                                                    
         DROP  R2                                                               
                                                                                
*                                                                               
SO96X    DS    0H                                                               
         B     GETXX                                                            
         DROP  R6                                                               
*&&                                                                             
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*======================== RESET DAY/TIME INDEX =======================*         
                                                                                
* Routine just checks to see if there is a 'DYTM' link.  If there is,           
*  routine will just set the day/time index to zero, and set the select         
*   day and time to the first day/time of 'DYTM' list.                          
* At entry,                                                                     
*   R6-->DBLOCK                                                                 
                                                                                
RSTDTIDX NTR1                                                                   
         USING DBLOCKD,R6                                                       
         ICM   RE,15,DBEXTEND      CHECK FOR MULIPLE DAY/TIME                   
*                                                                               
         USING DBXTLID,RE                                                       
RDTI010  DS    0H                                                               
         LTR   RE,RE               MAKE SURE STILL ON LINK                      
         BZ    RDTIX                IF NOT, EXIT NOW                            
         CLI   BKDTFLAG,C'Y'                                                    
         BE    RDTIX                                                            
                                                                                
         CLC   DBXTLID,=C'DYTM'    THIS IS THE ONE WE WANT                      
         BE    *+12                                                             
         ICM   RE,15,DBXTLNXT                                                   
         B     RDTI010                                                          
                                                                                
         MVC   DBSELDAY(5),DBXTLIST  SET FIRST DAY/TM                           
         MVI   DBXTLIDX,0                                                       
         DROP  RE                                                               
                                                                                
*                                                                               
RDTIX    DS    0H                                                               
         B     GETXX                                                            
         DROP  R6                                                               
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*=========================== SET DBDQD LINK ==========================*         
                                                                                
* At entry,                                                                     
*   R6-->DBLOCK                                                                 
                                                                                
SETDQLNK NTR1                                                                   
         USING DBLOCKD,R6                                                       
         LA    RF,DBEXTEND-4                                                    
*                                                                               
SDQL010  DS    0H                                                               
         OC    4(4,RF),4(RF)                                                    
         BZ    SDQL020                                                          
*                                                                               
SDQL015  DS    0H                                                               
         ICM   RF,15,4(RF)                                                      
         CLC   0(3,RF),=C'DBDQ'    (LENGTH OF 3 IS INTENTIONAL!!)               
         BE    SDQL040             FOUND CALLER'S D/QH LINK AREA                
         B     SDQL010                                                          
                                                                                
*                                                                               
SDQL020  DS    0H                                                               
         LA    R1,TPDBDQD                                                       
         STCM  R1,15,4(RF)                                                      
         XC    0(TPDBDQDL,R1),0(R1)                                             
         MVC   0(4,R1),=C'DBDQ'                                                 
         LR    RF,R1                                                            
         B     SDQL040                                                          
                                                                                
*                                                                               
SDQL040  DS    0H                                                               
         MVC   DBDQTAB+0(2),=AL2(DBDQUXTD)                                      
         MVC   DBDQTAB+2(4),0(RF)                                               
         DROP  R6                                                               
                                                                                
*                                                                               
SDQLX    DS    0H                                                               
         B     GETXX                                                            
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
* LITERALS ETC.                                                       *         
***********************************************************************         
         SPACE 1                                                                
         LTORG                                                                  
*                                                                               
*IRERR   DS    X                   FLAG TO INDICATE ERROR ON DIRR READ          
*REVMKT  DS    XL(L'DRKMKT)                                                     
*                                                                               
* was arbt94 taken out 12/17/99                                                 
*RBT94   DC    C'WAKC'             CLEVLAND                                     
*        DC    C'WBNX'                                                          
*        DC    C'WEAO'                                                          
*        DC    C'WEWS'                                                          
*        DC    C'WJW '                                                          
*        DC    C'WKYC'                                                          
*        DC    C'WNEO'                                                          
*        DC    C'WOAC'                                                          
*        DC    C'WOIO'                                                          
*        DC    C'WUAB'                                                          
*        DC    C'WVIZ'                                                          
*        DC    C'WDIV'             DETRIOT                                      
*        DC    C'WGPR'                                                          
*        DC    C'WJBK'                                                          
*        DC    C'WKBD'                                                          
*        DC    C'WTVS'                                                          
*        DC    C'WXON'                                                          
*        DC    C'WXYZ'                                                          
*        DC    X'FF'                                                            
         SPACE 2                                                                
MXPROGS  DC    Y(L'TPREC/L'QIPNUM)      MAX # PRGRMS FIT IN TABLE               
EFFS     DC    X'FFFFFFFF'                                                      
WEEKTAB  DC    AL1(0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4)                             
RCNDSDPT DC    AL1(12,01,02,03,04,08),XL1'00'                                   
                                                                                
TABLIST  DS    0X                                                               
         DC    X'E3',3X'00'        ALPHAMKT TABLE (IN HIGH-CORE)                
         DC    X'FF'                                                            
TABLISTQ EQU   *-TABLIST                                                        
ARZERO   DC    16F'0'                                                           
*                                                                               
*                                                                               
GETTP_X  EQU   *                                                                
         EJECT                                                                  
*&&DO                                                                           
* FEB 02 OLYMPIC EXCLUSION EXCEPTIONS                                           
FEB02SL  DC    CL4'WGRZ'           BUFFALO                                      
         DC    CL4'WIVB'                                                        
         DC    CL4'WKBW'                                                        
         DC    CL4'WNGS'                                                        
         DC    CL4'WNLO'                                                        
         DC    CL4'WNYO'                                                        
         DC    CL4'WPXJ'                                                        
         DC    CL4'WUTV'                                                        
         DC    CL4'KCTV'           KANSAS CITY                                  
         DC    CL4'KCWE'                                                        
         DC    CL4'KMBC'                                                        
         DC    CL4'KMCI'                                                        
         DC    CL4'KPXE'                                                        
         DC    CL4'KSHB'                                                        
         DC    CL4'KSMO'                                                        
         DC    CL4'WDAF'                                                        
         DC    CL4'KAUT'           OAKLAHOMA CITY                               
         DC    CL4'KFOR'                                                        
         DC    CL4'KOCB'                                                        
         DC    CL4'KOCO'                                                        
         DC    CL4'KOKH'                                                        
         DC    CL4'KOPX'                                                        
         DC    CL4'KSBI'                                                        
         DC    CL4'KTBO'                                                        
         DC    CL4'KWTV'                                                        
         DC    CL4'ZN53'                                                        
         DC    X'FF'                                                            
         DS    0H                                                               
         EJECT                                                                  
*&&                                                                             
*---------------------------------------------------------------------          
* MMWWTAB  - TABLE OF NSI WEEKS IN MONTH.                                       
* BYTE   0    = YEAR                                                            
*        2    = NSI START WEEK NUMBER FOR MONTH POSN                            
*        3    = NSI END WEEK NUMBER FOR MONTH POSN                              
*               POSITONS: JAN-FEB-MAR-APR                                       
*                         MAY-JUN-JUL-AUG                                       
*                         SEP-OCT-NOV-DEC                                       
*---------------------------------------------------------------------          
         DS    0H                                                               
MMWWTAB  DS    0C                                                               
         DC    AL1(YR_1996)                                                     
         DC    AL1(01,04),AL1(05,08),AL1(09,12),AL1(13,17)  J-F-M-A             
         DC    AL1(18,21),AL1(22,25),AL1(26,30),AL1(31,34)  M-J-J-A             
         DC    AL1(35,39),AL1(40,43),AL1(44,48),AL1(49,52)  S-O-N-D             
YYDSPQ   EQU   *-MMWWTAB           DISP TO NEXT YEAR IN TABLE                   
         DC    AL1(YR_1997)                                                     
         DC    AL1(01,04),AL1(05,09),AL1(10,13),AL1(14,17)  J-F-M-A             
         DC    AL1(18,21),AL1(22,26),AL1(27,30),AL1(31,34)  M-J-J-A             
         DC    AL1(35,39),AL1(40,44),AL1(45,48),AL1(49,52)  S-O-N-D             
         DC    AL1(YR_1998)                                                     
         DC    AL1(01,05),AL1(06,09),AL1(10,13),AL1(14,17)  J-F-M-A             
         DC    AL1(18,22),AL1(23,26),AL1(27,30),AL1(31,35)  M-J-J-A             
         DC    AL1(36,39),AL1(40,44),AL1(45,48),AL1(49,52)  S-O-N-D             
         DC    AL1(YR_1999)                                                     
         DC    AL1(01,05),AL1(06,09),AL1(10,13),AL1(14,17)  J-F-M-A             
         DC    AL1(18,22),AL1(23,26),AL1(27,30),AL1(31,35)  M-J-J-A             
         DC    AL1(36,39),AL1(40,44),AL1(45,48),AL1(49,52)  S-O-N-D             
         DC    AL1(YR_2000)                                                     
         DC    AL1(01,05),AL1(06,09),AL1(10,13),AL1(14,17)  J-F-M-A             
         DC    AL1(18,22),AL1(23,26),AL1(27,30),AL1(31,35)  M-J-J-A             
         DC    AL1(36,39),AL1(40,44),AL1(45,48),AL1(49,52)  S-O-N-D             
         DC    AL1(YR_2001)                                                     
         DC    AL1(01,04),AL1(05,08),AL1(09,12),AL1(13,17)  J-F-M-A             
         DC    AL1(18,21),AL1(22,25),AL1(26,30),AL1(31,34)  M-J-J-A             
         DC    AL1(35,39),AL1(40,43),AL1(44,47),AL1(48,52)  S-O-N-D             
         DC    AL1(YR_2002)                                                     
         DC    AL1(01,04),AL1(05,08),AL1(09,12),AL1(13,17)  J-F-M-A             
         DC    AL1(18,21),AL1(22,25),AL1(26,30),AL1(31,34)  M-J-J-A             
         DC    AL1(35,39),AL1(40,43),AL1(44,47),AL1(48,52)  S-O-N-D             
         DC    AL1(YR_2003)                                                     
         DC    AL1(01,04),AL1(05,08),AL1(09,12),AL1(13,17)  J-F-M-A             
         DC    AL1(18,21),AL1(22,25),AL1(26,30),AL1(31,34)  M-J-J-A             
         DC    AL1(35,39),AL1(40,43),AL1(44,47),AL1(48,52)  S-O-N-D             
         DC    AL1(YR_2004)                                                     
         DC    AL1(01,04),AL1(05,08),AL1(09,12),AL1(13,17)  J-F-M-A             
         DC    AL1(18,21),AL1(22,25),AL1(26,30),AL1(31,35)  M-J-J-A             
         DC    AL1(36,39),AL1(40,43),AL1(44,47),AL1(48,52)  S-O-N-D             
         DC    AL1(YR_2005)                                                     
         DC    AL1(01,04),AL1(05,08),AL1(09,12),AL1(13,17)  J-F-M-A             
         DC    AL1(18,21),AL1(22,25),AL1(26,30),AL1(31,35)  M-J-J-A             
         DC    AL1(36,39),AL1(40,43),AL1(44,47),AL1(48,52)  S-O-N-D             
         DC    AL1(YR_2006)                                                     
         DC    AL1(01,05),AL1(06,09),AL1(10,13),AL1(14,18)  J-F-M-A             
         DC    AL1(19,22),AL1(23,26),AL1(27,31),AL1(32,35)  M-J-J-A             
         DC    AL1(36,39),AL1(40,44),AL1(45,48),AL1(49,53)  S-O-N-D             
*        DC    AL1(01,04),AL1(05,08),AL1(09,12),AL1(13,17)  J-F-M-A             
*        DC    AL1(18,21),AL1(22,25),AL1(26,30),AL1(31,35)  M-J-J-A             
*        DC    AL1(36,39),AL1(40,43),AL1(44,47),AL1(48,52)  S-O-N-D             
         DC    AL1(YR_2007)                                                     
         DC    AL1(01,04),AL1(05,08),AL1(09,12),AL1(13,17)  J-F-M-A             
         DC    AL1(18,21),AL1(22,25),AL1(26,30),AL1(31,34)  M-J-J-A             
         DC    AL1(35,39),AL1(40,43),AL1(44,47),AL1(48,52)  S-O-N-D             
         DC    AL1(YR_2008)                                                     
         DC    AL1(01,04),AL1(05,08),AL1(09,13),AL1(14,17)  J-F-M-A             
         DC    AL1(18,21),AL1(22,26),AL1(27,30),AL1(31,35)  M-J-J-A             
         DC    AL1(36,39),AL1(40,43),AL1(44,48),AL1(49,52)  S-O-N-D             
         DC    AL1(YR_2009)                                                     
         DC    AL1(01,04),AL1(05,08),AL1(09,13),AL1(14,17)  J-F-M-A             
         DC    AL1(18,22),AL1(23,26),AL1(27,30),AL1(31,35)  M-J-J-A             
         DC    AL1(36,39),AL1(40,43),AL1(44,48),AL1(49,52)  S-O-N-D             
         DC    AL1(YR_2010)                                                     
         DC    AL1(01,05),AL1(06,09),AL1(10,13),AL1(14,17)  J-F-M-A             
         DC    AL1(18,22),AL1(23,26),AL1(27,30),AL1(31,35)  M-J-J-A             
         DC    AL1(36,39),AL1(40,44),AL1(45,48),AL1(49,52)  S-O-N-D             
         DC    X'FFFF'                                                          
         EJECT                                                                  
         DS    0H                                                               
SQADTAB  DC    C'EM',X'40',AL2(620)  SPOT TV                                    
         DC    C'DA',X'40',AL2(640)                                             
         DC    C'EF',X'40',AL2(650)                                             
         DC    C'PA',X'40',AL2(710)                                             
         DC    C'PR',X'40',AL2(720)                                             
         DC    C'LF',X'40',AL2(740)                                             
         DC    C'EN',X'40',AL2(750)                                             
         DC    C'LN',X'40',AL2(810)                                             
         DC    X'FF'                                                            
         SPACE 2                                                                
         DS    0H                                                               
SQADTABH DC    C'PR',X'40',AL2(610)  SPOT HISPANIC TV                           
         DC    C'LF',X'40',AL2(620)                                             
         DC    C'EF',X'40',AL2(640)                                             
         DC    C'EN',X'40',AL2(650)                                             
         DC    C'LN',X'40',AL2(710)                                             
         DC    C'DA',X'40',AL2(720)                                             
         DC    C'PA',X'40',AL2(740)                                             
         DC    C'CF',X'40',AL2(750)                                             
         DC    C'EM',X'40',AL2(810)                                             
         DC    C'KD',X'40',AL2(820)                                             
         DC    C'SP',X'40',AL2(840)                                             
         DC    C'WE',X'40',AL2(850)                                             
         DC    C'PP',X'40',AL2(910)                                             
         DC    X'FF'                                                            
         SPACE 2                                                                
         DS    0H                                                               
SQADTABR DC    C'AM',X'40',AL2(520) RADIO                                       
         DC    C'DA',X'40',AL2(540)                                             
         DC    C'PM',X'40',AL2(550)                                             
         DC    C'EV',X'40',AL2(610)                                             
         DC    C'AV',X'40',AL2(620)                                             
         DC    C'WE',X'40',AL2(630)                                             
         DC    C'AP',X'40',AL2(640)                                             
         DC    C'MS',X'40',AL2(650)                                             
         DC    C'MF',X'40',AL2(660)                                             
         DC    C'WD',X'40',AL2(670)                                             
         DC    X'FF'                                                            
         EJECT                                                                  
         TITLE 'SUBR01 - FREE UP SPACE'                                         
         DROP  RB                                                               
         DROP  RA                                                               
         DROP  R7                                                               
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
*SUBR01 - FREES UP SPACE                                                        
***********************************************************************         
SUBR01   NMOD1 0,**SUB01**,RA,RR=R2,CLEAR=YES                                   
         SR    RC,RC                                                            
         ICM   RC,7,1(R1)                                                       
         USING DEGETD,RC                                                        
         USING DBLOCKD,R6                                                       
         ZIC   RF,0(R1)                                                         
         BCTR  RF,0                                                             
         SLL   RF,2                                                             
         B     SUBR1#(RF)                                                       
*                                                                               
XITS1    XIT1                                                                   
*                                                                               
RSTDQLKQ EQU   (RSTDQLK#-*)/4+1                                                 
GETWEEKQ EQU   (GETWEEK#-*)/4+1                                                 
*                                                                               
SUBR1#   DS    0H                                                               
RSTDQLK# B     RSTDQLNK                                                         
GETWEEK# B     GETWEEK                                                          
*                                                                               
***********************************************************************         
*========================= RESTORE DBDQD LINK ========================*         
                                                                                
* ROUTINE RESTORES AS MANY DAYS/QHS IN THE EXTENDED AREA TO THE                 
*  ORIGINAL LOCATION IN THE DBLOCK (DBDQD) AS POSSIBLE.                         
* THE RESTORING IS ONLY APPLICABLE IF AND ONLY IF  GETTP  CREATED THE           
*  DAYS/QHS LINK.                                                               
* At entry,                                                                     
*   R6-->DBLOCK                                                                 
                                                                                
RSTDQLNK DS    0H                                                               
         LA    RF,DBEXTEND-4                                                    
         SR    RE,RE                                                            
*                                                                               
RDQL010  DS    0H                  FIND DAYS/QHS ENTRIES LINK                   
         LR    RE,RF                KEEP PREVIOUS LINK ADDRESSABLE              
         ICM   RF,15,4(RF)          BUMP TO NEXT LINK                           
         BZ    RDQLX                NO MORE LINKS -- NOTHING TO RESTORE         
*                                                                               
         CLC   =C'DBDQ',0(RF)       LOOK FOR A GETTP-CREATED LINK               
         BNE   RDQL010              NOT THE DAYS/QHS ENTRIES WE WANT            
*                                                                               
         MVC   DBDQTAB,DBDQXFXL(RF)  RESTORE DBDQTAB                            
*                                                                               
         MVC   4(4,RE),4(RF)         REMOVE LINK FROM DBEXTEND                  
*                                                                               
         LA    RE,DBDQTAB                                                       
         LA    RF,(L'DBDQTAB-1)(RE)                                             
                                                                                
RDQL046  DS    0H                                                               
         CLI   0(RF),0                                                          
         BNE   RDQL046G                                                         
         SHI   RF,DBDQLEN                                                       
         CR    RE,RF                                                            
         BL    RDQL046                                                          
RDQL046G EQU   *                                                                
         MVI   0(RF),X'FF'                    RESTORE DELIMITER TOO!            
*                                                                               
RDQLX    DS    0H                                                               
         B     XITS1                                                            
*                                                                               
* ROUTINE TO SET DBACT1WK FROM DBSEL1WK VIA SWEEPTAB                            
* OR FROM DBSELWKN (X'FF'=ALL WEEKS REQUIRED)                                   
*                                                                               
GETWEEK  DS    0H                                                               
         MVI   DBACT1WK,0          RESET ACTUAL WEEK                            
         OC    DBSEL1WK,DBSEL1WK                                                
         BNZ   GETWEEK0                                                         
         SR    R1,R1                                                            
         ICM   R1,1,DBSELWKN       R1=SELECTED WEEK NUMBER (BINARY)             
         BZ    GETWEEKX                                                         
         LA    R0,X'FF'                                                         
         CR    R1,R0                                                            
         BNE   GETWEEK5                                                         
         STC   R1,DBACT1WK         SET ACTUAL WEEK='ALL'                        
         B     GETWEEKX                                                         
*                                                                               
GETWEEK0 DS    0H                  CONVERT DBSEL1WK TO EBCDIC YMD               
         GOTO1 CDATCON,DMCB,(2,DBSEL1WK),WORK                                   
*                                  BUILD KEY FOR TABLE LOOK-UP                  
         MVC   DUB(1),DBINTFIL                                                  
         MVC   DUB+1(1),DBINTMED                                                
         MVC   DUB+2(1),DBACTSRC                                                
***      CLC   =C'SJ',DBSELAGY     SJR AND CARAT                                
***      BE    *+10                ONLY                                         
***      CLC   =C'UB',DBSELAGY     POSTS OFF WEEKLY FUSION                      
***      BNE   *+8                                                              
         CLI   DBSELSRC,C'F'       FUSION READS SAME SWEEPTAB                   
         BNE   *+8                 AS NSI                                       
         MVI   DUB+2,C'N'                                                       
         MVC   DUB+3(2),DBACTBK                                                 
*                                                                               
         GOTO1 CDEMTABS,DMCB,SWEEPTBL     GET A(SWEEP DATE TABLE)               
         ICM   R2,15,0(R1)         A(TABLE) RETURNED IN P1                      
         JZ    *+2                 BAD TABLEID PASSED                           
         L     R3,4(R1)            L'TABLE ENTRY RETURNED IN P2                 
         USING SWPTABLD,R2                                                      
GETWEEK2 CLI   0(R2),0                                                          
         BE    GETWEEKX                                                         
         CLC   DUB(3),SWPTFMS      MATCH FILE/MEDIA/SOURCE/BOOK                 
         BNE   GETWEEK3                                                         
         CLC   DUB+3(2),SWPTBOOK                                                
         BE    GETWEEK4                                                         
GETWEEK3 AR    R2,R3               BUMP TO NEXT TABLE ENTRY                     
         B     GETWEEK2                                                         
*                                                                               
GETWEEK4 DS    0H                                                               
         GOTO1 CDATCON,DMCB,(10,SWPTST),WORK+6                                  
         CLC   WORK(6),WORK+6      TEST DATE LESS THAN SWEEP START              
         BL    GETWEEKX            YES - IGNORE                                 
*                                  CALCULATE SWEEP WEEK NUMBER                  
         GOTO1 CPERVERT,DMCB,WORK+6,WORK                                        
         LH    R1,8(R1)            R1=INCLUSIVE DAYS                            
         SR    R0,R0                                                            
         LA    RE,7                                                             
         DR    R0,RE                                                            
         LTR   R0,R0                                                            
         BZ    *+8                                                              
         LA    R1,1(R1)            R1=SWEEP WEEK NUMBER (1 THRU N)              
         CLM   R1,1,SWPTWKS        TEST WITHIN SWEEP                            
         BH    GETWEEK3                                                         
*                                                                               
GETWEEK5 IC    R1,SWEEPWK-1(R1)    CONVERT TO BIT VALUE IN DBACT1WK             
         STC   R1,DBACT1WK                                                      
         DROP  R2                                                               
*                                                                               
GETWEEKX B     XITS1                                                            
                                                                                
         SPACE 1                                                                
SWEEPWK  DC    X'08040201'                                                      
         EJECT                                                                  
*                                                                               
*LTORG FOR SUBR01                                                               
         LTORG                                                                  
         DROP  R6                                                               
         DROP  RA                                                               
* ROUTINE TO SEE IF WE LOADED DBACTSTA IS ONE OF THE STATIONS                   
* WE LOADED INCORRECTLY AS CABLE                                                
BADBTYPE NTR1  BASE=*,LABEL=*                                                   
         USING DBLOCK,R6                                                        
         LA    R1,BADSTATS                                                      
BADBTY10 CLC   =X'FFFF',0(R1)                                                   
         BE    BADBTYNO                                                         
         CLC   DBACTSTA,0(R1)                                                   
         BNE   BADBTY50                                                         
         CLC   DBACTKMK,5(R1)                                                   
         BNE   BADBTY50                                                         
         B     BADBTYES                                                         
BADBTY50 AHI   R1,L'BADSTATS                                                    
         B     BADBTY10                                                         
*                                                                               
BADBTYES CR    RB,RB                                                            
         J     BADBTYPX                                                         
BADBTYNO CR    RA,RB                                                            
BADBTYPX XIT1                                                                   
* 5 CHARS STATION, 2 BYTE SPILL MKT                                             
BADSTATS DS    0CL7                                                             
         DC    C'WBTST',AL2(0)                                                  
         DC    X'FFFF'                                                          
         DROP  R6                                                               
*                                                                               
*                                                                               
* SEE IF WE ARE TOON STATION AND NEED TO READ FROM TOONLIST                     
*                                                                               
CHCKTOON NTR1  BASE=*,LABEL=*                                                   
         USING DBLOCK,R6                                                        
         OC    TOONLIST,TOONLIST                                                
         BNZ   CHCKTN08                                                         
         MVI   TOONSTAF,TOONDONE                                                
         B     CHCKTNX                                                          
CHCKTN08 CLI   TOONSTAF,TOONFST                                                 
         BNE   CHCKTN10                                                         
         MVC   DBSELSTA,TOONLIST                                                
         B     CHCKTN30                                                         
CHCKTN10 CLI   TOONSTAF,TOON2ND                                                 
         BNE   CHCKTNX                                                          
         MVC   DBSELSTA,TOONLIST+5                                              
CHCKTN30 DS    0C                                                               
CHCKTNX  XIT1                                                                   
         DROP  R6                                                               
*                                                                               
         EJECT                                                                  
GETPNAME NTR1  BASE=*,LABEL=*                                                   
         USING DBLOCK,R6                                                        
         L     RF,DBCOMFCS                                                      
         L     RF,CDEFINE-COMFACSD(RF)                                          
         OR    RF,RF                                                            
         BNZ   GETPN10                                                          
*NEW CODE MAKE SURE DEFINE IS SET                                               
         L     RF,DBCOMFCS                                                      
         L     RF,CCALLOV-COMFACSD(RF)                                          
         GOTO1 (RF),DMCB,0,X'D9000A26'                                          
         L     RF,DBCOMFCS                                                      
         MVC   CDEFINE-COMFACSD(4,RF),0(R1)                                     
*                                                                               
GETPN10  DS    0H                                                               
         L     RF,DBCOMFCS                                                      
         L     RF,CDEFINE-COMFACSD(RF)                                          
         GOTO1 (RF),DMCB,=C'PROG+',DBLOCK,PRGNAME                               
         CLI   DBSELMED,C'O'                                                    
         BNE   GETPNAMX                                                         
         CLC   =C'NOT AVAILABLE',PRGNAME                                        
         BNE   GETPNAMX                                                         
         MVC   PRGNAME(16),=C'OFF AIR         '                                 
GETPNAMX XIT1                                                                   
         DROP  R6                                                               
***********************************************************************         
* RADAR DAYPART LOOKUP                                                          
***********************************************************************         
GETRARDP NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING DBLOCK,R6                                                        
         L     R3,TPATBLE          RE-->SECTN OF RAD DPT TAB W/ KEY DAY         
*        LA    R3,RARDPTAB                                                      
         USING RDPTABD,R3                                                       
GETRAR10 DS    0H                                                               
***      CLI   0(R3),0                                                          
***      BE    GETRANO                                                          
*                                                                               
         CLC   DBDQKDAY,RDPDAY      MATCH TO ENTRY IN RAD DPT TABLE             
         BE    GETRAR15                                                         
GETRAR12 ZIC   R0,RDPLEN                                                        
         AR    R3,R0                                                            
*        C     R3,TPATBLEX         BETTER NOT PASS EOTABLE!                     
         CLI   0(R3),0                                                          
         BE    GETRANO                                                          
         B     GETRAR10                                                         
*                                                                               
*                                                                               
*&&DO                                                                           
         CLC   DBDQEQH,RDPQXS                                                   
         BL    GRD20                                                            
         CLC   DBDQSQH,RDPQXE                                                   
         BH    GRD20                                                            
*&&                                                                             
*        CLC   RDPQXS,DBDQSQH                                                   
*        BE    GETRAR30                                                         
GETRAR15 CLC   DBDQKDAY,RDPDAY      MATCH TO ENTRY IN RAD DPT TABLE             
         BNE   GETRANO                                                          
         CLC   DBDQEQH,RDPQXS                                                   
         BL    GETRAR12                                                         
*        BL    GETRAR20                                                         
*ETRAR20 LA    R3,5(R3)                                                         
*        B     GETRAR10                                                         
*ETRAR30 CLC   RDPQXE,DBDQEQH                                                   
*        BNE   GETRAR20                                                         
GETRAR30 DS   0H                                                                
         CLC   DBDQSQH,RDPQXE                                                   
         BH    GETRAR12                                                         
         MVC   DBSELPRG(1),RDPDAY     GET KEY DAY                               
         MVC   DBSELPRG+1(1),RDPDPT   GET DAYPART CODE                          
         B     GETRAYES                                                         
*                                                                               
GETRANO  CR    RA,RB                                                            
         BNE   GETRAX                                                           
GETRAYES CR    RB,RB                                                            
         BE    GETRAX                                                           
*                                                                               
GETRAX   XIT1                                                                   
***********************************************************************         
* GET NEXT DATE IN SPOT TABLE                                                   
***********************************************************************         
NXTSPOT  NTR1  BASE=*,LABEL=*                                                   
         USING DBLOCK,R6                                                        
         ZICM  RE,NUMSPOTS,(3)                                                  
         SHI   RE,1                                                             
         STCM  RE,3,NUMSPOTS                                                    
         OC    NUMSPOTS,NUMSPOTS                                                
         BZ    NXTSPOTX                                                         
         ZICM  RE,SPTTBPTR,(15)                                                 
         USING SPTTABD,RE                                                       
         MVC   DBACTDUP,2(RE)      1 BUYE DUP FACTOR                            
         GOTO1 CDATCON,DMCB,(2,SPTRDATE),(0,DUB)                                
         L     RE,=V(NSIWEEK)                                                   
         A     RE,RELO3                                                         
         ST    RE,VNSIWEEK                                                      
         GOTO1 VNSIWEEK,DMCB,DUB,(1,CGETDAY),CADDAY,CDATCON                     
         MVC   DBSELBK(1),DMCB+4                                                
         MVC   DBSELBK+1(1),DMCB                                                
         DROP  RE                                                               
         ZICM  RE,SPTTBPTR,(15)                                                 
         ZIC   RF,SPTTABLN                                                      
         AR    RE,RF                                                            
         STCM  RE,15,SPTTBPTR                                                   
NXTSPOTX XIT1                                                                   
***********************************************************************         
*======================= TRANSLATE ALPHA MARKET ======================*         
                                                                                
* This routine is used map an alpha mkt (stored in DUB(3)) to a                 
*  numeric market using the AlphaMkt table in high-core.                        
* At entry,                                                                     
*   DUB(3)   = blank-padded alpha market                                        
* At exit,                                                                      
*   DUB+3(2) = numeric market                                                   
***********************************************************************         
         SPACE 1                                                                
TRAMKT   NTR1  BASE=*,LABEL=*                                                   
         USING DBLOCK,R6                                                        
         XC    DUB+3(2),DUB+3                                                   
* FOR FUSION TRANSLATE BASE ON NSI                                              
         CLI   DBSELSRC,C'F'                                                    
         BNE   *+8                                                              
         MVI   DBACTSRC,C'N'                                                    
* WEEKLY ALSO USE THE SAME TABLE AS USTV NSI                                    
         CLI   DBSELMED,C'W'                                                    
         BNE   *+8                                                              
         MVI   DBINTMED,C'T'                                                    
* OVERNIGHTS ALSO USE SAME TABLE AS USTV NSI                                    
         CLI   DBSELMED,C'O'                                                    
         BNE   *+8                                                              
         MVI   DBINTMED,C'T'                                                    
*                                                                               
         ICM   R2,15,AAMKTTAB      R2-->ALPHAMKT TABLE IN HIGH CORE             
         BZ    TAMX                                                             
         LAM   AR2,AR2,ALET                                                     
         SAC   512                                                              
         USING DAMHDRD,R2                                                       
                                                                                
         MVI   WORK,X'FF'          ASSUME DEFAULT BOOK TYPE                     
         CLI   DBBTYPE,0                                                        
         BE    *+10                                                             
         MVC   WORK(1),DBBTYPE                                                  
                                                                                
         LA    RE,TAM02                                                         
         O     RE,=X'80000000'                                                  
         BSM   0,RE                SWITCH TO 31-BIT MODE                        
*                                                                               
TAM02    CLC   0(2,R2),=X'FFFF'    AT END OF TABLE YET?                         
         BE    TAM14                                                            
         CLC   DAMHMED,DBINTMED    MATCH AGAINST MEDIA,                         
         BNE   TAM04                                                            
*                                                                               
         CLI   DBACTSRC,C'T'       FOR TRITON,                                  
         BNE   TAM05                                                            
         CLI   DAMHSRC,C'A'        USE ARBITRON MARKET LIST                     
         BNE   TAM04                                                            
         B     TAM06                                                            
*                                                                               
TAM05    CLC   DAMHSRC,DBACTSRC    AND SOURCE                                   
         BNE   TAM04                                                            
         B     TAM06                                                            
*                                                                               
TAM04    ICM   R0,15,DAMHAET       BUMP TO NEXT MEDIA/SOURCE SECTION            
         AHI   R0,1                                                             
         LR    R2,R0                                                            
         B     TAM02                                                            
*                                                                               
TAM06    XR    R0,R0               MEDIA/SOURCE SECTION FOUND                   
         ICM   R0,3,DAMHLDE        R0=L(DATA ELEMENT)                           
         LR    R3,R2                                                            
         AHI   R3,DAMHDRL                                                       
         CPYA  AR3,AR2                                                          
         USING DAMDTAD,R3                                                       
                                                                                
TAM08    CLC   DAMDAMKT,DUB        NOW MATCH ON ALPHA MARKET                    
         BH    TAM14                EXIT NOW, NO USE LOOKING FURTHER            
         BL    TAM12                WANT EXACT MATCH                            
*                                                                               
*                                  NOW MATCH ON BOOKTYPE                        
*                                                                               
         CLI   WORK,C'R'           OVERLAP FOR SQAD HISPANIC                    
         BE    *+12                 DON'T DEFAULT                               
         CLI   DAMDBTYP,X'FF'      USE DEFAULT BOOKTYPE IF CAN'T MATCH          
         BE    TAM10                BOOKTYPE EXACTLY                            
         CLC   DAMDBTYP,WORK       BOOKTYPE MATCH (WORK(1)=BOOKTYPE) ?          
         BNE   TAM12                NO, BUMP TO NEXT ENTRY                      
                                                                                
TAM10    MVC   DUB+3(2),DAMDNMKT   FOUND NUMERIC MARKET                         
         CLI   DBSELMED,C'W'                                                    
         BNE   TAM14                                                            
         CLC   DUB+3(2),=X'00A8'   168 = ATL                                    
         BNE   *+10                FOR WEEKLY IT WAS NEVER CHANGED TO           
         MVC   DUB+3(2),=X'007C'   168- KEEP USING 124                          
         B     TAM14                                                            
                                                                                
TAM12    AR    R3,R0               BUMP TABLE POINTER                           
         CLM   R3,15,DAMHAET       COMPARE AGAINST EOTABLE ADDRESS              
         BL    TAM08                CONTINUE IF STILL LOW                       
*                                                                               
TAM14    SAC   0                                                                
         LAM   AR2,AR3,=2F'0'                                                   
         LA    RE,*+6              SWITCH FROM 31-BIT MODE                      
         BSM   0,RE                                                             
*                                                                               
TAMX     CLI   DBSELSRC,C'F'       RESET BACK TO FUSION                         
         BNE   *+8                                                              
         MVI   DBACTSRC,C'F'                                                    
         CLI   DBSELMED,C'W'       RESET BACK FOR WEEKLY                        
         BNE   *+8                                                              
         MVI   DBINTMED,C'W'                                                    
         CLI   DBSELMED,C'O'       RESET BACK FOR OVERNIGHTS                    
         BNE   *+8                                                              
         MVI   DBINTMED,C'O'                                                    
***      B     GETXX               EXIT                                         
TAMKTX   XIT1                                                                   
         DROP  R2,R3                                                            
         DROP  R6                                                               
         EJECT                                                                  
*-------------------------------------------------------------------            
* ROUTINE CHECKS IF CURRENT PROGRAM (OR AVERAGE) IS OF TYPE SPORTS.             
* A 4-WEEK AVERAGE IS NEVER MARKED WITH A PROGRAM TYPE, SO IT WILL              
* BE COUNTED AS NON-SPORTS.                                                     
*                                                                               
* ON ENTRY, R1 -> X'20' ELEMENT OF CURRENT PROGRAM OR AVERAGE                   
*           R6 -> DBLOCK                                                        
* ON EXIT, CC IS SET TO EQ FOR SPORTS PROGRAMS                                  
*          CC IS SET TO NEQ FOR NON-SPORTS PROGRAMS                             
*-------------------------------------------------------------------            
SPORTTYP NTR1  BASE=*,LABEL=*                                                   
         USING DBLOCK,R6                                                        
*                                                                               
SPRT10   CLI   0(R1),0                                                          
         BE    SPRTNO              REACHED END OF RECORD, NOT SPORTS            
         CLI   0(R1),X'21'                                                      
         BH    SPRTNO              NO PROGRAM TYPE ELEMENT, NOT SPORTS          
         BE    SPRT20                                                           
         ZIC   R0,1(R1)                                                         
         AR    R1,R0                                                            
         B     SPRT10                                                           
*                                                                               
         USING QIELEM,R1                                                        
SPRT20   CLI   QIELN,4             HANDLE BACKPOINTER COMPRESSION               
         BNE   SPRT30                                                           
         SR    R0,R0                                                            
         NI    QIPNUM,X'7F'                                                     
         ICM   R0,3,QIPNUM                                                      
         OI    QIPNUM,X'80'                                                     
         L     R1,DBAREC                                                        
         AR    R1,R0                                                            
*                                                                               
SPRT30   CLC   QIPTYPE,=C'LS'      SPORTS PROGRAM TYPES                         
         BE    SPRTYES                                                          
         CLC   QIPTYPE,=C'SA'                                                   
         BE    SPRTYES                                                          
         CLC   QIPTYPE,=C'SC'                                                   
         BE    SPRTYES                                                          
         CLC   QIPTYPE,=C'SE'                                                   
         BE    SPRTYES                                                          
         CLC   QIPTYPE,=C'SN'                                                   
         BE    SPRTYES                                                          
         B     SPRTNO                                                           
         DROP  R1                                                               
*                                                                               
SPRTYES  CR    RB,RB                                                            
         B     SPORTTYX                                                         
SPRTNO   CHI   RB,0                                                             
SPORTTYX XIT1                                                                   
         DROP  R6                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*-------------------------------------------------------------------            
CHK5AMR  NTR1  BASE=*,LABEL=*                                                   
         USING DBLOCK,R6                                                        
         XC    TPTIM2,TPTIM2                                                    
***      CLI   DBSELMED,C'W'       REMOVE WEEKLY FROM 5A SPLIT                  
****     JE    *+8                                                              
         CLI   DBSELMED,C'O'       OVERNIGHT TP                                 
         JE    *+8                                                              
         CLI   DBSELMED,C'T'       FOR USTV                                     
         JNE   CHK5AMRX                                                         
***      CLI   DBSELSRC,C'V'       VIDEOLOGY                                    
***      BE    *+8                                                              
         CLI   DBSELSRC,C'F'       AND FUSION                                   
         JE    *+8                                                              
         CLI   DBSELSRC,C'N'       AND NSI                                      
         JNE   CHK5AMRX                                                         
         OC    DBSELTIM+2(2),DBSELTIM+2                                         
         JZ    CHK5AMRX                                                         
         CLC   DBSELTIM(2),DBSELTIM+2                                           
         JE    CHK5AMRX                                                         
*                                                                               
*                                                                               
*   TEST FOR NOW EFFECTIVE NOV_13 FOR TESTING PUPROSES                          
* effective 3a start time (DEC15)                                               
         CLI   DBSELMED,C'T'       FOR USTV                                     
         BNE   CHK5A00B                                                         
****     CLI   DBSELSRC,C'V'       VIDEOLOGY                                    
****     BE    CHK5A00D            IS 3AM                                       
         CLC   DBSELBK,=AL2(DEC_15) EFFECTIVE 3AM BOOK                          
         BL    CHK5AM02                                                         
         B     CHK5A00D                                                         
*                                                                               
CHK5A00B CLI   DBSELMED,C'O'       OVERIGHTS                                    
         BNE   CHK5AM02                                                         
****     CLC   DBSELBK,=X'712C'    DEC0113 WEEK FOR OVERNIGHTS                  
***      CLC   DBSELBK,=X'7328'    TESTING SEP2115 IS LAST 5A WEEK              
*                                  NOV3015 STARTWEEK OF 3AM FOR DAILIES         
         CLC   DBSELBK,=AL1(YR_2015,WEEK_49)                                    
         BL    CHK5AM02                                                         
********************************                                                
* NEW 3A NIELSEN START TIME CODE                                                
********************************                                                
************************                                                        
*  MAKE SURE WE DONT PASS 259AM END TIME                                        
*  IF START BEFORE 3AM AND END TIME >259A MAX END TIME IS 259AM                 
CHK5A00D DS    0C                                                               
*                                                                               
         MVC   TPSVTIM(4),DBSELTIM  DEAL WITH SWITCHED START OF DAY             
         CLC   DBSELTIM(2),=AL2(300)                                            
         BNL   CHK5AM01                                                         
         CLC   DBSELTIM+2(2),=AL2(259)                                          
         BL    CHK5AM01                                                         
         MVC   DBSELTIM+2(2),=AL2(259)  MAX END TIME 259A                       
         B     CHK5AM1D                                                         
* IF START >6AM - AND ENDTIME >259A THEN MAX END TIME IS 259A                   
CHK5AM01 CLC   DBSELTIM(2),=AL2(600)                                            
         BL    CHK5AM1B                                                         
         CLC   DBSELTIM+2(2),=AL2(259)                                          
         BL    CHK5AM1B                                                         
         CLC   DBSELTIM+2(2),DBSELTIM   ONLY IF ENDTIME<STARTTIME AND           
         BNL   CHK5AM1D                 ENDTIME>259 DO WE CAP ENTIME            
         MVC   DBSELTIM+2(2),=AL2(259)  MAX END TIME 259A                       
         B     CHK5AM1D                                                         
*START TIME BETWEEN 3A-6A (ENDTIME<START TIME) AND (ENDTIME<STARTTME)           
* THEN SET END TIME TO 259A                                                     
CHK5AM1B DS    0C                                                               
         CLC   DBSELTIM+2(2),=AL2(259)                                          
         BL    CHK5AM1D                                                         
         CLC   DBSELTIM(2),DBSELTIM+2                                           
         BNH   CHK5AM1D                                                         
         MVC   DBSELTIM+2(2),=AL2(259)  MAX END TIME 259A                       
************************                                                        
* effective 3a start time (DEC15)                                               
CHK5AM1D CLC   DBSELTIM(2),=AL2(300)    ALLOW DAY SPLIT FROM 3AM                
         BNL   CHK5AM10                 END OF DAY IS 259                       
****     MVC   DBSELTIM+2(2),=AL2(259) THIS IS WRONG - NOT NEEDED               
         B     CHK5AMRX                                                         
*                                                                               
********************************                                                
* OLD 5A NIELSEN START TIME CODE                                                
********************************                                                
CHK5AM02 DS    0H                                                               
         CLC   DBSELTIM(2),=AL2(500)                                            
         BL    CHK5AMRX                                                         
CHK5AM10 MVC   TPSVTIM(4),DBSELTIM  DEAL WITH SWITCHED START OF DAY             
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,3,DBSELTIM+2      ADJUST FOR 2400                             
         CHI   RE,2401                                                          
         BL    *+12                                                             
         SHI   RE,2400                                                          
         STCM  RE,3,DBSELTIM+2                                                  
                                                                                
         XC    TPTIM2,TPTIM2                                                    
         CLC   DBSELTIM(2),=AL2(559) START AFTER 6 IS OK                        
         BH    CHK5AMRX                                                         
*   TEST FOR NOW EFFECTIVE NOV_13 FOR TESTING PUPROSES                          
****     CLI   DBSELSRC,C'V'       VIDEOLOGY ALWAYS 3A                          
****     BE    CHK5AM16                                                         
         CLI   DBSELMED,C'T'       FOR USTV                                     
         BNE   *+18                                                             
****     CLC   DBSELBK,=AL2(NOV_13)                                             
         CLC   DBSELBK,=AL2(DEC_15) EFFECIVE 3AM BOOK                           
         BL    CHK5AM20                                                         
         B     CHK5AM16                                                         
         CLI   DBSELMED,C'O'       FOR USTV                                     
         BNE   CHK5AM20                                                         
***      CLC   DBSELBK,=X'7328'    TESTING SEP2815 IS FIRST 3A WEEK             
*                                  EFFECTIVE WK OF NOV3015 3A WEEK              
         CLC   DBSELBK,=AL1(YR_2015,WEEK_49)                                    
         BL    CHK5AM20                                                         
CHK5AM16 CLC   DBSELTIM+2(2),=AL2(300) END BEFORE 3A NEEDS SPLIT                
         BL    CHK5AM30                                                         
         CLC   DBSELTIM+2(2),=AL2(601) END BEFORE 601 IS OK                     
         BL    CHK5AMRX                                                         
*                                                                               
CHK5AM20 DS    0H                                                               
         CLC   DBSELTIM+2(2),=AL2(500) END BEFORE 5A NEEDS SPLIT                
         BL    *+14                                                             
         CLC   DBSELTIM+2(2),=AL2(601) END BEFORE 601 IS OK                     
         BL    CHK5AMRX                                                         
CHK5AM30 DS    0H                                                               
         MVC   TPTIM2(4),DBSELTIM  SET UP SPLIT TIMES                           
         MVC   DBSELTIM+2(2),=AL2(559)  END OF TIME1                            
         MVC   TPTIM2(2),=AL2(600)      START OF TIME2                          
***  SWAP ORDER                                                                 
*        ZICM  R0,TPTIM2,(15)                                                   
*        MVC   TPTIM2(4),DBSELTIM                                               
*        STCM  R0,15,DBSELTIM                                                   
***                                                                             
*                                                                               
CHK5AMRX DS    0C                                                               
*                                                                               
* SET UP TO SHIFT THE BOOK FOR NSI WEEKLY SAT/SUN                               
CHK5AMXX XC    WKBKD2,WKBKD2                                                    
         MVC   WKBKD1,DBSELBK                                                   
         CLI   DBSELMED,C'O'                                                    
         JE    *+8                                                              
         CLI   DBSELMED,C'W'                                                    
         JNE   SETWKBKX                                                         
         CLI   DBSELSRC,C'N'       AND NSI                                      
         JNE   SETWKBKX                                                         
         CLI   DBSELBK+1,0         BYPASS FOR YEAR SUMMARY RECORD               
         BE    SETWKBKX                                                         
         CLI   DBBEST,C'R'         RESEARCH OPTION-START WEEK ON SAT            
         BE    SETWKBKX                                                         
*                                                                               
         CLI   DBBEST,X'60'        SPECIAL OOWR SPLITS FOR WEEKLY               
         BL    *+12                X'60'-65'                                    
         CLI   DBBEST,X'65'                                                     
         BNH   SETWK10                                                          
         CLI   DBBEST,X'10'        SPECIAL OOWR SPLITS FOR OVERNIGHTS           
         BL    *+12                X'10'-16'                                    
         CLI   DBBEST,X'16'                                                     
         BNH   SETWK100                                                         
*                                                                               
* FOR M-SU WEEK  DBBEST NOT 60-65 OR 10-16 THEN SAT-SUN MUST BE                 
* PART OF THE ROTATION TO BE SPLIT WEEK                                         
*  IF NOT A SPECIAL SPLIT - MEANING REGULAR M-SU STANDARD WEEK                  
         CLI   DBSELMED,C'O'       M-SU WEEK FOR OVERNIGHTS HAVE NO             
         BE    SETWKBKX            SPLIT WEEK                                   
         TM    DBSELDAY,X'03'      IF SAT/SUN INCLUDED IN DAY                   
         BZ    SETWKBKX                                                         
*                                                                               
* NORMAL M-SU STANDARD WEEK NEED TO ONLY CHECK SAT/SUN                          
* IF SAT/SUN ONLY JUST BUMP BOOK TO NEXT WEEK DONT WORRY ABOUT SPLIT            
* WEEKS                                                                         
         TM    DBSELDAY,X'7C'      FOR NORMAL M-SU BUY WEEKS ONLY               
         BNZ   SETWK200            SAT/SUN SPLITS ACROSS WEEK                   
* IS THE WEEK COMING IN 54TH WEEK- IF SO ADJUST IT TO 1ST WEEK OF               
* NEXT YEAR - CALLERS PASS IN 54TH WEEK TO INDICATE WE WANT TO                  
* READ THE 1ST WEEK OF NEXT YEAR                                                
*                                                                               
         CLI   DBSELBK+1,54        USER SPECIFIES 54TH WEEK TO INDICATE         
***      BNE   SETWK10             THEY WANT THE 1ST WEEK OF NEXT YEAR          
         BNE   SETWK160            THEY WANT THE 1ST WEEK OF NEXT YEAR          
         ZIC   RE,DBSELBK                                                       
         AHI   RE,1                                                             
         STC   RE,DBSELBK                                                       
         MVI   DBSELBK+1,1                                                      
         B     SETWKBKX                                                         
*                                                                               
SETWK10  CLI   DBBEST,X'60'        SPECIAL OOWR SPLITS FOR WEEKLY               
         BL    SETWKBKX            X'60'-65'                                    
         CLI   DBBEST,X'65'                                                     
         BH    SETWKBKX                                                         
SETWK65  CLI   DBBEST,X'65'           SA-FRI WEEK NO SPLIT                      
         BNE   SETWK64                                                          
         B     SETWKBKX                                                         
SETWK64  CLI   DBBEST,X'64'           FRI-TH WEEK SA-TH SPLITS                  
         BNE   SETWK63                TO NEXT WEEK                              
         TM    DBSELDAY,X'04'         FRIDAY ON?                                
         BNZ   SETWK200               ELSE                                      
         B     SETWK160               READ NEXT WEEK AND EXIT                   
SETWK63  CLI   DBBEST,X'63'           TH-W  WEEK SA-WED SPLITS                  
         BNE   SETWK62                TO NEXT WEEK                              
         TM    DBSELDAY,X'0C'         TH-F ON?                                  
         BNZ   SETWK200               ELSE                                      
         B     SETWK160               READ NEXT WEEK AND EXIT                   
SETWK62  CLI   DBBEST,X'62'           W-TU  WEEK SAT-TU SPLITS                  
         BNE   SETWK61                TO NEXT WEEK                              
         TM    DBSELDAY,X'1C'         W-F ON?                                   
         BNZ   SETWK200               ELSE                                      
         B     SETWK160               SAT-SU READ NEXT WEEK                     
SETWK61  CLI   DBBEST,X'61'           TU-M  WEEK SAT-M SPLITS                   
         BNE   SETWK60                TO NEXT WEEK                              
         CLI   DBSELDAY,X'40'         MONDAY ONLY READ NEXT WEEK                
         BE    SETWK160               ELSE                                      
         B     SETWK200               SPLIT WEEK                                
SETWK60  CLI   DBBEST,X'60'           SU-SA WEEK SAT NEXT WEEK                  
         BNE   SETWK160                                                         
         CLI   DBSELDAY,X'02'         SAT ONLY READ NEXT WEEK                   
         BE    SETWK160               ELSE                                      
         B     SETWK200               SPLIT WEEK                                
*                                                                               
* CHECK SPLIT WEEK FOR OVERNIGHTS- OOWR                                         
* --------------------------------------                                        
SETWK100 DS    0C                                                               
         CLI   DBBEST,X'10'        SPECIAL OOWR SPLITS FOR OVERNIGHTS           
         BL    SETWKBKX            X'10'-15'                                    
         CLI   DBBEST,X'16'                                                     
         BH    SETWKBKX                                                         
SETWK116 CLI   DBBEST,X'16'           SU-SA WEEK M-SA SPLITS                    
         BNE   SETWK115                                                         
         TM    DBSELDAY,X'01'         SUNDAY ON                                 
         BNZ   SETWK200                                                         
         B     SETWK160               M-SA ONLY READ NEXT WEEK                  
                                                                                
SETWK115 CLI   DBBEST,X'15'           SA-FRI WEEK M-F SPLITS                    
         BNE   SETWK114                                                         
         TM    DBSELDAY,X'03'         SA-SUN ON?                                
         BNZ   SETWK200               ELSE                                      
         B     SETWK160               M-F ONLY READ NEXT WEEK                   
                                                                                
SETWK114 CLI   DBBEST,X'14'           FRI-TH WEEK M-TH SPLITS                   
         BNE   SETWK113               TO NEXT WEEK                              
         TM    DBSELDAY,X'07'         FRI TO SUNDAY ON?                         
         BNZ   SETWK200               ELSE                                      
         B     SETWK160               MON-TH READ ONLY NEXT WEEK                
                                                                                
SETWK113 CLI   DBBEST,X'13'           TH-W  WEEK M-WED SPLITS                   
         BNE   SETWK112               TO NEXT WEEK                              
         TM    DBSELDAY,X'0F'         TH-SU ON?                                 
         BNZ   SETWK200               ELSE                                      
         B     SETWK160               MON-WED ONLY READ NEXT WEEK               
                                                                                
SETWK112 CLI   DBBEST,X'12'           W-TU  WEEK M-TU SPLITS                    
         BNE   SETWK110               TO NEXT WEEK                              
         TM    DBSELDAY,X'1F'         W-SU ON?                                  
         BNZ   SETWK200               ELSE                                      
         B     SETWK160               MON-TU ONLY READ NEXT WEEK                
                                                                                
SETWK110 CLI   DBBEST,X'10'           TU-M  WEEK MON SPLITS                     
         BNE   SETWK200               TO NEXT WEEK                              
         TM    DBSELDAY,X'3F'         TU-SUN ON?                                
         BNZ   SETWK200               ELSE                                      
         B     SETWK160               MONDAY ONLY READ NEXT WEEK                
*                                                                               
*                                                                               
SETWK160 ZIC   RE,DBSELBK+1           BUMP TO NEXT WEEK AND EXIT                
         AHI   RE,1                                                             
         STC   RE,DBSELBK+1                                                     
*                                                                               
         MVC   TEMPBOOK,DBSELBK                                                 
         GOTO1 YR53WK                                                           
         MVC   DBSELBK(2),TEMPBOOK                                              
*                                                                               
         B     SETWKBKX                                                         
*                                                                               
SETWK200 MVC   WKBKD2,DBSELBK                                                   
         ZIC   RE,DBSELBK+1        SET BOOK TO BOOK+1                           
         LA    RE,1(RE)                                                         
         STC   RE,WKBKD2+1                                                      
         CLI   WKBKD2+1,54         NO SUCH THING AS 54 WEEKS                    
         BL    SETWK210            POINT TO 1ST WK NEXT YEAR                    
         MVI   WKBKD2+1,1                                                       
         ZIC   RE,WKBKD2                                                        
         AHI   RE,1                                                             
         STC   RE,WKBKD2                                                        
*                                                                               
SETWK210 DS    0C                                                               
         MVC   TEMPBOOK,WKBKD2     SEE IF WE NEED                               
         GOTO1 YR53WK              TO ADJUST TO NEXT YEAR                       
         MVC   WKBKD2(2),TEMPBOOK                                               
*                                                                               
         XC    WKBKD1,=X'FFFF'     COMPLIMENT M-F BOOK                          
         XC    WKBKD2,=X'FFFF'     COMPLIMENT SAT/SUN BOOK                      
SETWKBKX XIT1                                                                   
         DROP R6                                                                
* TEMPBOOK= BOOK TO COMPARE                                                     
* TEMPBOOK= BOOK (EITHER SAME AS INPUT OR ADJUST TO 1ST WK OF NEXT YR)          
YR53WK   NTR1                                                                   
                                                                                
         LA    RE,WK53TAB                                                       
YR53WK10 CLC   =X'FFFF',0(RE)                                                   
         BE    YR53WKN                                                          
         CLC   0(1,RE),TEMPBOOK COMPARE YEAR TO SEE IF IT HAS 53 WKS            
         BE    YR53WKY                                                          
         AHI   RE,L'WK53TAB                                                     
         B     YR53WK10                                                         
YR53WKY  DS    0C                  YEAR HAS 53 WEEKS                            
         CLI   TEMPBOOK+1,53       CANT HAVE MORE THAN 53 WEEKS                 
         BH    YR53WKNX                                                         
         J     YR53WKX             NO NEED TO ADJUST                            
YR53WKN  DS    0C                  YEAR DOESNT HAVE 53 WEEKS                    
         CLI   TEMPBOOK+1,52      IF BOOK IS WEEK 52 OR LESS EXIT               
         JNH   YR53WKX                                                          
YR53WKNX MVI   TEMPBOOK+1,1         NEW BOOK WEEK=1 OF NEXT YEAR                
         ZIC   RF,TEMPBOOK                                                      
         AHI   RF,1                                                             
         STC   RF,TEMPBOOK                                                      
*                                                                               
YR53WKX  XIT1                                                                   
*                                                                               
WK53TAB  DS    0CL1                YEARS THAT HAVE 53 BROADCAST WEEKS           
         DC    AL1(YR_2012)                                                     
         DC    AL1(YR_2017)                                                     
         DC    AL1(YR_2023)                                                     
         DC    AL1(133)                                                         
         DC    X'FFFF'                                                          
         EJECT                                                                  
*                                                                               
*-------------------------------------------------------------------            
* READ FUSION ESTIMATE POINTERS FOR AD INSERTABLE AND CARRIAGE UNIV             
*                                                                               
FUSUEST  NTR1  BASE=*,LABEL=*,WORK=(R5,NSIUNVL)                                 
         USING NSIUNVD,R5                                                       
         USING DEGETD,RC           RC=A(W/S)                                    
         USING COMFACSD,R8         R8=A(COMFACS)                                
         USING DBLOCKD,R6          R6=A(DBLOCK)                                 
*                                                                               
*                                                                               
         LA    R1,NUL1Q-1           CLEAR TPLSTDIR, TPDBFILE,                   
         EX    R1,*+8                TPMINKEY, & TPSELPRG                       
         B     *+10                                                             
         XC    NULSTDIR(0),NULSTDIR                                             
         MVC   NULSTDIR,DBLSTDIR    SAVE LAST KEY READ                          
         MVC   NUINKEY,DBMINKEY     "   MINOR KEY BUILT FROM REQUEST            
         MVC   NUAREC,DBAREC                                                    
         LA    R2,DBKEY                                                         
         USING DFUEKEY,R2          FUSION UNIV ESTIMATE PASSIVES                
                                                                                
*                                                                               
FUSUES2  L     RE,DBAREC                SAVE DEMO DIR KEY (RTN)                 
         USING DRKEY,RE                 INTO DBAREC TO BUILD DFUEKEY            
         MVC   DRKEY(L'DBKEY),DBKEY                                             
         XC    DBKEY,DBKEY                                                      
                                                                                
*                                                                               
* LOOK TO SEE IF WE HAVE DBEXTEND 'UPBK' WHICH PASSES THE                       
* LATEST BOOK FOR AN UPGRADE.  IF THE CURRENT LOOKUP IS PRE JAN08               
* THEN SEE IF LATEST BOOK PASSED IN IS JAN08 OR LATER- IF SO, USE THAT          
* BOOK TO FIND INDEX BOOK                                                       
*                                                                               
         ZICM  RF,DBEXTEND,(15)                                                 
         LTR   RF,RF                                                            
FUSUES22 BNZ   FUSUES23                                                         
* IF THERE IS NO UPBK LINK - JUST CHEKC THE DRBOOK AGAINST JAN08                
         CLC   DRBOOK,=AL2(65535-JAN_08) IF ACTBK IS JAN08 OR LATER             
         BNH   FUSUES26            JUST USE IT                                  
         B     FUSUEX                                                           
FUSUES23 CLC   =C'UPBK',0(RF)                                                   
         BE    FUSUES24                                                         
         ICM   RF,15,4(RF)                                                      
         B     FUSUES22                                                         
FUSUES24 DS    0C                                                               
         USING DBLATUBK,RF                                                      
*                                                                               
         CLC   DRBOOK,=AL2(65535-JAN_08) IF ACTBK IS JAN08 OR LATER             
******   BNH   FUSUES26            JUST USE IT                                  
*                                                                               
         CLC   DBLUPBK,=AL2(JAN_08)                                             
******   BL    FUSUEX                                                           
*EXTENSION BOOK IS JAN08 OR LATER                                               
* ACTBK IS PRIOR TO JAN08 BUT EXTENSION BOOK FROM UPGRADE                       
* IS JAN08 OR LATER -USE EXTENSION BOOK                                         
****     MVC   DFUEBOOK,DBLUPBK    USE LATEST BOOK FROM EXTENSION               
****     XC    DFUEBOOK,=X'FFFF'                                                
****     B     FUSUES28                                                         
*EXTENSION BOOK IS JAN08 OR LATER                                               
* FOLLOWING ROUTINE GETS THE FUSION UNIVERSE ESTIMATE                           
* RECORD WITH THE LATEST BOOK. (AIUE)                                           
*                                                                               
         BAS   RE,FUSELTST                                                      
         B     FUSUES60                                                         
*                                                                               
         DROP  RF,RE                                                            
FUSUES26 L     RE,DBAREC                SAVE DEMO DIR KEY (RTN)                 
         USING DRKEY,RE                 INTO DBAREC TO BUILD DFUEKEY            
         MVC   DFUEBOOK,DRBOOK                                                  
FUSUES28 MVI   DFUECODE,DFUECODQ                                                
         MVC   DFUEMED,DRMEDIA                                                  
         MVI   DFUESRC,C'F'                                                     
         MVC   DFUEMKT,DRKMKT                                                   
*                                                                               
         OC    DRKMKT,DRKMKT       IF THE SPILL MKT IS CLEARED OUT              
         BNZ   *+10                DUE TO A CALL LETTER SWITCH.. TRY            
         MVC   DFUEMKT,SVSELMK2    THE CALLER RQUESTED SPILL MKT-ZCTW           
*                                                                               
         MVC   DFUESYSC,DBSELSYC                                                
         MVC   DFUESTN,DRSTAT                                                   
         DROP  RE                                                               
         CLI   DFUESTN,X'F0'       NUMERIC STATION ALREADY?                     
         BNL   FUSUES50                                                         
         CLI   DFUESTN,X'00'       5 DIGIT STATION                              
         BE    FUSUES50                                                         
*                                                                               
* CONVERT CALL LETTER TO NETWORK NUMERIC ID                                     
         L     RF,DBCOMFCS                                                      
         ICM   RF,15,CDEMTABS-COMFACSD(RF)                                      
         GOTO1 (RF),DMCB,NSICABLE                                               
         ICM   RE,15,0(R1)                                                      
         JZ    *+2                                                              
         L     R0,4(R1)            R0 HAS LENGTH OF TABLE ENTRY                 
         LR    R1,RE               R1=A(TABLE)                                  
         USING NSICBLD,R1                                                       
                                                                                
FUSUES30 CLI   0(R1),X'FF'         EOT?                                         
         BNE   *+14                                                             
         XC    DFUESTN,DFUESTN     READ DEFAULT GTF PASSIVE                     
         B     FUSUES50            THE FILE                                     
*                                                                               
         CLC   DFUESTN(4),0(R1)    COMPARE STATION CALL LETTERS                 
         BE    FUSUES40                                                         
         AR    R1,R0                                                            
         B     FUSUES30                                                         
*                                                                               
FUSUES40 XC    DFUESTN,DFUESTN                                                  
         XR    RF,RF                                                            
         ICM   RF,7,NSICBNML       CONVERT TABLE VALUE TO CHAR                  
         CHI   RF,10000                                                         
         BL    FUSUES45                                                         
         STCM  RF,15,DFUESTN        5 DIGIT STATION NUMBER                      
         MVI   DFUESTN+4,C'T'                                                   
         B     FUSUES50                                                         
FUSUES45 CVD   RF,WORK                                                          
         OI    WORK+7,X'0F'                                                     
         UNPK  DFUESTN(4),WORK+5(3)                                             
         MVI   DFUESTN+4,C'T'                                                   
* FOR NAN (9043)USE NICK (6212) - WE ONLY HAVE SYSCODE FOR MAIN STA             
* FOR ADSM(4737) USE TOON (7241)                                                
         CLC   =C'9043',DFUESTN                                                 
         BNE   *+10                                                             
         MVC   DFUESTN(4),=C'6212'                                              
         CLC   =C'4737',DFUESTN                                                 
         BNE   *+10                                                             
         MVC   DFUESTN(4),=C'7241'                                              
         DROP  R1,R2                                                            
FUSUES50 MVI   IOFLAG,DIR+HIGH           READ DIRECTORY                         
                                                                                
         GOTO1 AIO,IOFLAG                                                       
         BE    FUSUES60                                                         
FUSUES60 L     R2,DBAREC                                                        
         USING DFUEKEY,R2                                                       
         CLC   DFUEKEY(DFUEAIUE-DFUEKEY),KEYSAVE                                
         BE    FUSUES70                                                         
                                                                                
*                                                                               
* CHECK TO SEE IF WE HAVE FOUND GTF KEY                                         
*                                                                               
         LA    RE,FUSUEID          POINT TO THE FUSION EST AREA TOO             
         MVC   0(4,RE),=C'AIUE'                                                 
         STCM  RE,15,DBSPANAD      IF KEY NOT FOUND                             
         MVC   FUSAIUE,=X'000000'  THEN FORCE 0 VALUE                           
         MVC   FUSCRUE,=X'000064'                                               
         B     FUSUEX                                                           
* SAVE OFF AD INSERTABLE UNIVERSE EST AND CARRIAGE UNIVERSE ESTIMATES           
FUSUES70 L     R2,DBAREC                                                        
         USING DFUEKEY,R2                                                       
*                                                                               
         LA    RE,FUSUEID          POINT TO THE FUSION EST AREA TOO             
         MVC   0(4,RE),=C'AIUE'                                                 
         STCM  RE,15,DBSPANAD                                                   
         MVC   FUSAIUE,DFUEAIUE                                                 
         MVC   FUSCRUE,DFUECAUE                                                 
*                                                                               
FUSUEX   MVC   DBLSTDIR,NULSTDIR    LAST KEY READ                               
         MVC   DBMINKEY,NUMNKYRD    MINOR KEY FROM LAST READ                    
         MVI   IOFLAG,DEM+DIR+HIGH   RESTORE I/O READS                          
*                                                                               
* FOR BOOKS PRIOR TO JAN08 WE DO NOT WANT TO CHECK FOR                          
* GTF KEY FIELDS SINCE WE DONT HAVE GTF KEYS                                    
*  IF  ACTBK IS BEFORE JAN08 THEN                                               
         CLC   DBLSTDIR+(DRBOOK-DRKEY),=AL2(65535-JAN_08)                       
         BH    FUSUE6X             WE NEVER READ GTF PASSIVES - SKIP            
*                                  THE BELOW BOOKTYPE SWITCH CODE               
*                                                                               
*                                                                               
* BEFORE WE REREAD THE SAVED DEMO DIRECTORY KEY LET CHECK OF WE                 
* SHOULD REREAD FOR DMA OR WIRED BOOKTYPE BASED ON AIUE GTF PASSIVES            
         MVC   SVFUEFLG,DFUEFLGS                                                
         TM    DFUEFLGS,DFUEFLGS_TOTAL_DMA                                      
         BZ    FUSUE3X                                                          
* DMA SYSCODE LOGIC                                                             
* SYSCODE IS A DIRECTV SYSCODE - SWITCH TO DMA DEMO READ                        
         CLI   DBSELSRC,C'N'                                                    
         BNE   FUSUE2X                                                          
         CLI   DBLSTDIR+(DRBTYP-DRKEY),C'W'                                     
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),C'C'                                     
* we cant override to c'                                                        
         CLI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_WS                              
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_LS   NO CS BOOK                 
         CLI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_W3                              
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_C3                              
         CLI   DBLSTDIR+(DRBTYP-DRKEY),C'Z'                                     
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),C'U'                                     
         B     FUSUE6X                                                          
*                                                                               
FUSUE2X  CLI   DBSELSRC,C'F'                                                    
         BNE   FUSUE6X                                                          
         CLI   DBLSTDIR+(DRBTYP-DRKEY),0                                        
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),C'C'                                     
         CLI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_WS                              
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_LS   NO CS BOOK                 
         CLI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_W3                              
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_C3                              
         CLI   DBLSTDIR+(DRBTYP-DRKEY),C'Z'                                     
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),C'U'                                     
         B     FUSUE6X                                                          
*                                                                               
* WIRED SYSCODE                                                                 
* SYSCODE IS A DIRECTV SYSCODE - SWITCH TO DMA DEMO READ                        
FUSUE3X  CLI   DBSELSRC,C'N'                                                    
         BNE   FUSUE4X                                                          
         CLI   DBLSTDIR+(DRBTYP-DRKEY),C'C'                                     
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),C'W'                                     
* we cant override to c'                                                        
         CLI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_LS                              
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_WS   NO CS BOOK                 
         CLI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_C3                              
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_W3                              
         CLI   DBLSTDIR+(DRBTYP-DRKEY),C'U'                                     
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),C'Z'                                     
         B     FUSUE6X                                                          
*                                                                               
FUSUE4X  CLI   DBSELSRC,C'F'                                                    
         BNE   FUSUE6X                                                          
         CLI   DBLSTDIR+(DRBTYP-DRKEY),C'C'                                     
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),0                                        
         CLI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_LS                              
         BNE   *+8                                                              
         MVI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_WS   NO CS BOOK                 
*                                                                               
FUSUE6X  GOTO1 AIO,IOFLAG                                                       
*                                                                               
*  TRANSPARENCY CODE FOR FUSION                                                 
         CLI   DBSELSRC,C'F'                                                    
         BNE   FUSUEXX                                                          
         CLC   DBLSTDIR+(DRBTYP-DRKEY)(1),KEYSAVE+(DRBTYP-DRKEY)                
         BE    FUSUEXX                                                          
* WE DID NOT FIND THE BOOKTYPE WE WANTED TO SWITCH TO FOR FUSION                
*                                                                               
**       TM    DFUEFLGS,X'80'                                                   
         TM    SVFUEFLG,DFUEFLGS_TOTAL_DMA                                      
         BZ    FUSUE9W                                                          
FUSUE9D  DS    0C                DMA SYSCODE                                    
         MVI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_C                               
         B     FUSUE10                                                          
FUSUE9W  DS    0C                WIRED SYSCODE                                  
         MVI   DBLSTDIR+(DRBTYP-DRKEY),BOOKTYPE_STANDARD                        
*                                                                               
FUSUE10  GOTO1 AIO,IOFLAG                                                       
         B     FUSUEXX                                                          
*                                                                               
FUSUEXX  MVC   DBAREC,NUAREC                                                    
         XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* READ THE LATEST FUSION ESTIMATE UNIVERS RECORD (AIUE)                         
***********************************************************************         
FUSELTST NTR1                                                                   
*                                                                               
         L     R5,DBAREC                SAVE DEMO DIR KEY (RTN)                 
         USING DRKEY,R5                 INTO DBAREC TO BUILD DFUEKEY            
         LA    R3,DBKEY                                                         
         USING DFUEKEY,R3          FUSION UNIV ESTIMATE PASSIVES                
*                                                                               
* CONVERT CALL LETTER TO NETWORK NUMERIC ID                                     
* AND STORE VALUE IN AIUESTAT                                                   
*                                                                               
         MVC   AIUEMKT,DRKMKT                                                   
*                                                                               
         OC    DRKMKT,DRKMKT       IF THE SPILL MKT IS CLEARED OUT              
         BNZ   *+10                DUE TO A CALL LETTER SWITCH.. TRY            
         MVC   AIUEMKT,SVSELMK2    THE CALLER RQUESTED SPILL MKT-ZCTW           
*                                                                               
         MVC   AIUESTAT,DRSTAT                                                  
         CLI   AIUESTAT,X'F0'        NUMERIC STATION ALREADY?                   
         BNL   FUSLT80                                                          
*                                                                               
         L     RF,DBCOMFCS                                                      
         ICM   RF,15,CDEMTABS-COMFACSD(RF)                                      
         GOTO1 (RF),DMCB,NSICABLE                                               
         ICM   RE,15,0(R1)                                                      
         MVC   DFUESYSC,DBSELSYC                                                
         MVC   DFUESTN,DRSTAT                                                   
         L     R0,4(R1)            R0 HAS LENGTH OF TABLE ENTRY                 
         LR    R1,RE               R1=A(TABLE)                                  
         USING NSICBLD,R1                                                       
                                                                                
FUSLT20  CLI   0(R1),X'FF'         EOT?                                         
         BNE   *+14                                                             
         XC    AIUESTAT,AIUESTAT                                                
         B     FUSLT80             THE FILE                                     
*                                                                               
         CLC   AIUESTAT(4),0(R1)   COMPARE STATION CALL LETTERS                 
         BE    FUSLT40                                                          
         AR    R1,R0                                                            
         B     FUSLT20                                                          
*                                                                               
FUSLT40  XC    DFUESTN,DFUESTN                                                  
         XR    RF,RF                                                            
******   ICM   RF,3,4(R1)          CONVERT TABLE VALUE TO CHAR                  
         ICM   RF,7,NSICBNML       CONVERT TABLE VALUE TO CHAR                  
         CHI   RF,10000            5 DIGIT STATION CODE                         
         BL    *+12                                                             
         STCM  RF,15,AIUESTAT                                                   
         B     FUSLT70                                                          
         CVD   RF,WORK                                                          
         OI    WORK+7,X'0F'                                                     
         UNPK  AIUESTAT(4),WORK+5(3)                                            
FUSLT70  MVI   AIUESTAT+4,C'T'                                                  
         DROP  R1                                                               
*                                                                               
FUSLT80  XC    AIUEBOOK,AIUEBOOK                                                
*                                                                               
* READ FUSION RECORDS STARTING FROM LATEST BOOK                                 
*                                                                               
FULST90  XC    DFUEKEY(DFUEAIUE-DFUEKEY),DFUEKEY                                
         MVI   DFUECODE,DFUECODQ                                                
         MVC   DFUEMED,DRMEDIA                                                  
         MVI   DFUESRC,C'F'                                                     
         MVC   DFUEBOOK,AIUEBOOK                                                
*                                                                               
         MVI   IOFLAG,DIR+HIGH           READ DIRECTORY                         
         GOTO1 AIO,IOFLAG                                                       
         CLC   DFUEKEY(DFUEBOOK-DFUEKEY),KEYSAVE  MAKE SURE VALID               
         BNE   FULSTEX                                                          
*                                                                               
         MVC   AIUEBOOK,DFUEBOOK                                                
*                                                                               
* READ FUSION RECORD USING BOOK FROM LAST READ TO SEE IF RECORD EXISTS          
* IF RECORD EXITS EXIT PROGRAM PROCESS USING THIS FUSION RECORD                 
* IF RECORD DOESNT EXIST ADD ONE TO BOOK GO BACK AND READ FUSION RECORD         
* TO FIND NEXT LATEST BOOK.                                                     
* CONTINUE UNTIL RECORD IS FOUND, OR THERE IS NO BOOK TO MATCH THIS             
* REQUEST                                                                       
*                                                                               
         XC    DFUEKEY+5(DFUESTAT-DFUEMKT),DFUEKEY+5                            
         MVC   DFUEMKT,AIUEMKT                                                  
         MVC   DFUESYSC,DBSELSYC                                                
         MVC   DFUESTN,AIUESTAT                                                 
         MVI   IOFLAG,DIR+HIGH           READ DIRECTORY                         
         GOTO1 AIO,IOFLAG                                                       
         CLC   DFUEKEY(DFUEAIUE-DFUEKEY),KEYSAVE  MAKE SURE VALID               
         BE    FULSTEX                                                          
*                                                                               
         LH    RE,AIUEBOOK                                                      
         AHI   RE,1                                                             
         STH   RE,AIUEBOOK                                                      
         B     FULST90                                                          
*                                                                               
FULSTEX  XIT1                                                                   
*                                                                               
         DROP  R3,R5                                                            
*-------------------------------------------------------------------            
*&&DO                                                                           
* READ FUSION ESTIMATE POINTERS FOR AD INSERTABLE AND CARRIAGE UNIV             
*                                                                               
FUSUEST  NTR1  BASE=*,LABEL=*,WORK=(R5,NSIUNVL)                                 
         USING NSIUNVD,R5                                                       
         USING DEGETD,RC           RC=A(W/S)                                    
         USING COMFACSD,R8         R8=A(COMFACS)                                
         USING DBLOCKD,R6          R6=A(DBLOCK)                                 
*                                                                               
*                                                                               
         LA    R1,NUL1Q-1           CLEAR TPLSTDIR, TPDBFILE,                   
         EX    R1,*+8                TPMINKEY, & TPSELPRG                       
         B     *+10                                                             
         XC    NULSTDIR(0),NULSTDIR                                             
         MVC   NULSTDIR,DBLSTDIR    SAVE LAST KEY READ                          
         MVC   NUINKEY,DBMINKEY     "   MINOR KEY BUILT FROM REQUEST            
         MVC   NUAREC,DBAREC                                                    
         LA    R2,DBKEY                                                         
         USING DFUEKEY,R2          FUSION UNIV ESTIMATE PASSIVES                
         XC    DBKEY,DBKEY                                                      
                                                                                
**       XC    DBSTATUS,DBSTATUS                                                
**       XC    DBNDXDA,DBNDXDA                                                  
**       XC    DBLASTS,DBLASTS                                                  
*                                                                               
FUSUES20 L     RE,DBAREC                                                        
         USING DRKEY,RE                                                         
*                                                                               
*                                                                               
* LOOK TO SEE IF WE HAVE DBEXTEND 'UPBK' WHICH PASSES THE                       
* LATEST BOOK FOR AN UPGRADE.  IF THE CURRENT LOOKUP IS PRE JAN08               
* THEN SEE IF LATEST BOOK PASSED IN IS JAN08 OR LATER- IF SO, USE THAT          
* BOOK TO FIND INDEX BOOK                                                       
*                                                                               
         ZICM  RF,DBEXTEND,(15)                                                 
         LTR   RF,RF                                                            
FUSUES22 BNZ   FUSUES23                                                         
* IF THERE IS NO UPBK LINK - JUST CHEKC THE DRBOOK AGAINST JAN08                
         CLC   DRBOOK,=X'93FE'     IF ACTBK IS JAN08 OR LATER                   
         BNH   FUSUES26            JUST USE IT                                  
         B     FUSUEX                                                           
*USUES22 BZ    FUSUES26                                                         
FUSUES23 CLC   =C'UPBK',0(RF)                                                   
         BE    FUSUES24                                                         
         ICM   RF,15,4(RF)                                                      
         B     FUSUES22                                                         
FUSUES24 DS    0C                                                               
         USING DBLATUBK,RF                                                      
*                                                                               
         CLC   DRBOOK,=X'93FE'     IF ACTBK IS JAN08 OR LATER                   
         BNH   FUSUES26            JUST USE IT                                  
*                                                                               
         CLC   DBLUPBK,=X'6C01'                                                 
         BL    FUSUEX                                                           
*EXTENSION BOOK IS JAN08 OR LATER                                               
* ACTBK IS PRIOR TO JAN08 BUT EXTENSION BOOK FROM UPGRADE                       
* IS JAN08 OR LATER -USE EXTENSION BOOK                                         
         MVC   DFUEBOOK,DBLUPBK    USE LATEST BOOK FROM EXTENSION               
         XC    DFUEBOOK,=X'FFFF'                                                
         B     FUSUES28                                                         
*                                                                               
         DROP  RF                                                               
FUSUES26 MVC   DFUEBOOK,DRBOOK                                                  
FUSUES28 MVI   DFUECODE,DFUECODQ                                                
         MVC   DFUEMED,DRMEDIA                                                  
         MVI   DFUESRC,C'F'                                                     
         MVC   DFUEMKT,DRKMKT                                                   
         MVC   DFUESYSC,DBSELSYC                                                
         MVC   DFUESTN,DRSTAT                                                   
         DROP  RE                                                               
         CLI   DFUESTN,X'F0'       NUMERIC STATION ALREADY?                     
         BNL   FUSUES50                                                         
*                                                                               
* CONVERT CALL LETTER TO NETWORK NUMERIC ID                                     
         L     RF,DBCOMFCS                                                      
         ICM   RF,15,CDEMTABS-COMFACSD(RF)                                      
         GOTO1 (RF),DMCB,NSICABLE                                               
         ICM   RE,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     R0,4(R1)            R0 HAS LENGTH OF TABLE ENTRY                 
         LR    R1,RE               R1=A(TABLE)                                  
         USING NSICBLD,R1                                                       
                                                                                
FUSUES30 CLI   0(R1),X'FF'         EOT?                                         
         BNE   *+14                                                             
         XC    DFUESTN,DFUESTN     READ DEFAULT GTF PASSIVE                     
         B     FUSUES50            THE FILE                                     
*                                                                               
         CLC   DFUESTN(4),0(R1)    COMPARE STATION CALL LETTERS                 
         BE    FUSUES40                                                         
         AR    R1,R0                                                            
         B     FUSUES30                                                         
*                                                                               
FUSUES40 XC    DFUESTN,DFUESTN                                                  
         XR    RF,RF                                                            
******   ICM   RF,3,4(R1)          CONVERT TABLE VALUE TO CHAR                  
         ICM   RF,7,NSICBNML       CONVERT TABLE VALUE TO CHAR                  
         C     RF,=F'10000'                                                     
         BL    *12                                                              
         STCM  RF,15,DFUESTN                                                    
         MVI   DFUESTN+4,C'T'                                                   
         B     FUSEUS50                                                         
         CVD   RF,WORK                                                          
         OI    WORK+7,X'0F'                                                     
         UNPK  DFUESTN(4),WORK+5(3)                                             
         MVI   DFUESTN+4,C'T'                                                   
         DROP  R1,R2                                                            
FUSUES50 MVI   IOFLAG,DIR+HIGH           READ DIRECTORY                         
                                                                                
         GOTO1 AIO,IOFLAG                                                       
         BE    FUSUES60                                                         
FUSUES60 L     R2,DBAREC                                                        
         USING DFUEKEY,R2                                                       
         CLC   DFUEKEY(DFUEAIUE-DFUEKEY),KEYSAVE                                
         BE    FUSUES70                                                         
                                                                                
*                                                                               
* CHECK TO SEE IF WE HAVE FOUND GTF KEY                                         
*                                                                               
         LA    RE,FUSUEID          POINT TO THE FUSION EST AREA TOO             
         MVC   0(4,RE),=C'AIUE'                                                 
         STCM  RE,15,DBSPANAD      IF KEY NOT FOUND                             
         MVC   FUSAIUE,=X'000000'  THEN FORCE 0 VALUE                           
         MVC   FUSCRUE,=X'000064'                                               
         B     FUSUEX                                                           
* SAVE OFF AD INSERTABLE UNIVERSE EST AND CARRIAGE UNIVERSE ESTIMATES           
FUSUES70 L     R2,DBAREC                                                        
         USING DFUEKEY,R2                                                       
*                                                                               
         LA    RE,FUSUEID          POINT TO THE FUSION EST AREA TOO             
         MVC   0(4,RE),=C'AIUE'                                                 
         STCM  RE,15,DBSPANAD                                                   
         MVC   FUSAIUE,DFUEAIUE                                                 
         MVC   FUSCRUE,DFUECAUE                                                 
         DROP  R2                                                               
*                                                                               
FUSUEX   MVC   DBLSTDIR,NULSTDIR    LAST KEY READ                               
         MVC   DBMINKEY,NUMNKYRD    MINOR KEY FROM LAST READ                    
         MVI   IOFLAG,DEM+DIR+HIGH   RESTORE I/O READS                          
*                                                                               
         GOTO1 AIO,IOFLAG                                                       
         MVC   DBAREC,NUAREC                                                    
         XIT1                                                                   
                                                                                
*&&                                                                             
*                                                                               
NSIUNV   NTR1  BASE=*,LABEL=*,WORK=(R5,NSIUNVL)                                 
NSIUNVL  EQU   2000                                                             
         USING NSIUNVD,R5                                                       
         USING DEGETD,RC           RC=A(W/S)                                    
         USING COMFACSD,R8         R8=A(COMFACS)                                
         USING DBLOCKD,R6          R6=A(DBLOCK)                                 
         MVI   USELAT,C'N'                                                      
         LA    R1,NUL1Q-1           CLEAR TPLSTDIR, TPDBFILE,                   
         EX    R1,*+8                TPMINKEY, & TPSELPRG                       
         B     *+10                                                             
         XC    NULSTDIR(0),NULSTDIR                                             
         MVC   NULSTDIR,DBLSTDIR    SAVE LAST KEY READ                          
         MVC   NUINKEY,DBMINKEY     "   MINOR KEY BUILT FROM REQUEST            
         MVC   NUAREC,DBAREC                                                    
NUID01   L     RE,DBAREC                                                        
         MVC   NUMNKYRD,L'DBKEY(RE)  "   MINOR KEY JUST READ                    
         MVC   NUREC(30),0(RE)                                                  
         LA    RE,NUREC                                                         
         ST    RE,DBAREC                                                        
         SR    RE,RE                                                            
         ICM   RE,3,DBSELMK                                                     
         CVD   RE,NUDUB                                                         
         UNPK  DBKEY+3(4),NUDUB                                                 
         OI    DBKEY+6,X'F0'                                                    
         XC    DBKEY+10(L'DBKEY-10),DBKEY+10                                    
         MVC   DBKEY+8(2),DBACTBK       READ ACTUAL BOOK                        
         XC    DBKEY+8(2),=X'FFFF'                                              
         CLI   USELAT,C'Y'                                                      
         BNE   *+10                                                             
         MVC   DBKEY+8(2),=X'FFFF'      READ LATEST BOOK                        
*&&DO                                                                           
* TAKE OUT THE HARDCODING OF THE BOOKS, READ FUSION BOOK                        
***********************************************************                     
         MVC   DBKEY+8(2),=X'98F8'                                              
**       CLC   DBSELBK,=AL2(OCT_03)                                             
         CLC   DBACTBK,=AL2(OCT_03)                                             
         BL    *+10                                                             
         MVC   DBKEY+8(2),=X'98F4'  NOV/03                                      
**       CLC   DBSELBK,=AL2(OCT_04)                                             
         CLC   DBACTBK,=AL2(OCT_04)                                             
         BL    *+10                                                             
         MVC   DBKEY+8(2),=X'97F4'  NOV/04                                      
*&&                                                                             
***********************************************************                     
         DS    0H                  READ DEMO RECORD FOR UNIVERSE                
         MVI   DBKEY+2,C'N'        FORCE TO READ NSI RECORD                     
*        MVC   DBMINKEY(1),5         SET MINOR KEY--DAY AND                     
***      MVI   DBMINKEY,5            SET MINOR KEY--DAY AND                     
***      MVI   DBMINKEY+1,24          AND TIME                                  
* READ FROM DBAQUART                                                            
         L     RE,DBAQUART                                                      
         MVC   DBMINKEY(2),2(RE)        SET DAY  & HIGH QHR                     
*        LA    RE,NUREC                                                         
*        ST    RE,DBAREC                                                        
                                                                                
NUID02   MVI   IOFLAG,DIR+HIGH+DEM       READ DIRECTORY                         
         GOTO1 AIO,IOFLAG                                                       
         BNE   NUD60                                                            
         CLC   DBKEY,KEYSAVE                                                    
***      BNE   NUD60                                                            
         BE    NUID08                    IF FOUND                               
*                                                                               
* WE DIDNT FIND THE NSI BOOK.  READ LATEST UNIVERSE LEVEL RECORD                
* TO GRAB THE LATEST BOOK                                                       
*                                                                               
         CLI   USELAT,C'N'               JUST READ NSI FOR DBACTBK              
         BE    NUID07                    BUT DIDNT FIND IT                      
*                                                                               
         CLI   DBKEY+7,C'U'              DID WE GET THE LATEST                  
         BNE   NUID07                    UNIVERSE RECORD?                       
         MVI   DBKEY+7,C'T'              READ LATEST MKT LEVEL                  
         B     NUID02                    RECORD                                 
* WE SHOULD HAVE READ THE LATEST MKT LEVEL RECORD HERE                          
NUID07   CLI   DBKEY+7,C'T'              WE SHOULD ONLY HAVE LATEST             
         BE    *+6                       C'XXXXT'MKT LEVEL RECORD               
         DC    H'0'                                                             
         CLI   USELAT,C'Y'                                                      
         BE    NUD60                                                            
         MVI   USELAT,C'Y'               READ LATEST U UNIVERSE                 
         B     NUID01                    RECORD                                 
*                                                                               
                                                                                
NUID08   MVI   IOFLAG,FILE+HIGH+DEM      READ FILE                              
         GOTO1 AIO,IOFLAG                                                       
         BNE   NUD60                                                            
                                                                                
         DS    0H                  FOUND A GOOD RECORD,                         
         MVC   NSIUID,=C'NSIU'     SAVE THE ID                                  
*****    LA    RE,NSIUID           POINT TO THE AREA                            
         LA    RE,FUSUEID          POINT TO THE FUSION EST AREA TOO             
         STCM  RE,15,DBSPANAD                                                   
         LA    RE,NUREC                                                         
         LA    RE,DRFRSTEL-DRKEY(RE)                                            
         SR    R0,R0                                                            
         LA    R1,NSIUEL            POINT TO BUFFER TO BUILD ELEMENT IN         
         XC    NSIUEL,NSIUEL        CLEAR SAVE AREA                             
NUID10   CLI   0(RE),0              UNIVERSE NOT FOUND - CLEAR SPANAD           
         BE    NUID18                                                           
         CLI   0(RE),X'36'          TEST IF IN UNIVERSE ELEMENT RANGE           
         BL    NUID11                (36-39)                                    
         CLI   0(RE),X'40'                                                      
         BL    NUID12                                                           
         BH    NUID13               DONE W UNIVERSE ELEMENTS                    
NUID11   IC    R0,1(RE)             NEXT ELEMENT                                
         AR    RE,R0                                                            
         B     NUID10                                                           
                                                                                
NUID12   DS    0H                                                               
         ST    RE,DUB              SAVE CURRENT ELEMENT POINTER                 
         TM    2(RE),X'80'         IF ELEMENT IS A BACKWARD POINTER,            
         BZ    NUID12C                                                          
         ICM   RF,3,2(RE)           ADJUST FOR IT                               
         SLL   RF,17                                                            
         SRL   RF,17                                                            
         LR    RE,RF                                                            
         A     RE,DBAREC                                                        
*                                                                               
NUID12C  DS    0H                                                               
         ZIC   RF,1(RE)             L'ELEMENT                                   
         SHI   RF,1                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(RE)        MOVE IN LENGTH OF ELEMENT                   
         IC    R0,1(RE)                                                         
         AR    R1,R0                BUMP TO NEXT ELEMENT IN BUFFER              
         L     RE,DUB               RESTORE ELEMENT POINTER                     
         IC    R0,1(RE)             BUMP TO NEXT ELEMENT IN RECORD              
         AR    RE,R0                                                            
         B     NUID10                                                           
*                                                                               
*                                                                               
NUID13   DS    0H                                                               
* WE ARE DONE WITH MOVING UNIVERSES TO BUFFER . LETS FIND THE                   
* CORRECT QTR HOUR ELEMENT AND MOVE IN THE PUTS.                                
         LA    RE,NUREC             FLAG THAT IT'S RADIO OVERNGHT DPT           
         LA    RE,DRFRSTEL-DRKEY(RE)                                            
*                                                                               
NUID14   DS    0H                                                               
         CLI   0(RE),0              PUTS NOT FOUND JUST USE OLD ONES            
         BE    NUD50                                                            
         CLI   0(RE),QHCODEQ        QTR HOUR ELEM?                              
         BNE   NUID14A                                                          
         CLC   DBMINKEY,2(RE)       MATCH NSI AND FUSION DAY/QHR                
         BH    NUID14A                                                          
         BE    NUID15               FOUND MATCHING DAY/QTR                      
         DC    H'0'                 THERES SOMETHING WRONG IF WE DONT           
NUID14A  IC    R0,1(RE)             NEXT ELEMENT                                
         AR    RE,R0                                                            
         B     NUID14                                                           
*                                   FIND THE DAY/QTR HOUR                       
NUID15   DS    0H                                                               
         CLI   0(RE),0              PUTS NOT FOUND JUST USE OLD ONES            
         BE    NUD50                                                            
         CLI   0(RE),X'43'          TEST IF IN PUT ELEMENT RANGE                
         BL    NUID17                (43-45)                                    
         CLI   0(RE),X'46'                                                      
         BL    NUID16                                                           
         BH    NUD50                                                            
*                                                                               
NUID16   DS    0H                                                               
         ST    RE,DUB              SAVE CURRENT ELEMENT POINTER                 
         TM    2(RE),X'80'         IF ELEMENT IS A BACKWARD POINTER,            
         BZ    NUID16C                                                          
         ICM   RF,3,2(RE)           ADJUST FOR IT                               
         SLL   RF,17                                                            
         SRL   RF,17                                                            
         LR    RE,RF                                                            
         A     RE,DBAREC                                                        
*                                                                               
NUID16C  DS    0H                                                               
         ZIC   RF,1(RE)             L'ELEMENT                                   
         SHI   RF,1                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(RE)        MOVE IN LENGTH OF ELEMENT                   
         IC    R0,1(RE)                                                         
         AR    R1,R0                BUMP TO NEXT ELEMENT IN BUFFER              
         L     RE,DUB               RESTORE ELEMENT POINTER                     
         IC    R0,1(RE)             BUMP TO NEXT ELEMENT IN RECORD              
         AR    RE,R0                                                            
         B     NUID15                                                           
*                                                                               
NUID17   IC    R0,1(RE)             NEXT ELEMENT                                
         AR    RE,R0                                                            
         B     NUID15                                                           
*                                                                               
NUID18   XC    DBSPANAD,DBSPANAD    NO UNIVERSES - CLEAR SPANAD                 
         B     NUFSEQEQ             AND EXIT W/ GOOD CC CODE                    
*                                                                               
NUD50    DS    0H                  RESET TPMODE                                 
*        NI    TPMODE,X'FF'-TPMROVDP                                            
*                                                                               
NUD60    DS    0H                  RESTORE VALUES AND EXIT W/ NEQUAL            
         MVC   DBLSTDIR,NULSTDIR    LAST KEY READ                               
         MVC   DBMINKEY,NUMNKYRD    MINOR KEY FROM LAST READ                    
                                                                                
         MVI   IOFLAG,DEM+DIR+HIGH   RESTORE I/O READS                          
         GOTO1 AIO,IOFLAG                                                       
         B     NUFSEQNE                                                         
*        MVI   IOFLAG,DEM+FILE+HIGH                                             
*        GOTO1 AIO,IOFLAG                                                       
*                                                                               
*        MVC   DBMINKEY,NUINKEY     RESTORE MINOR KEY OF DBLOCK                 
*        B     NUFSEQNE                                                         
         EJECT                                                                  
NUFSQTN  DS    0H                                                               
                                                                                
         SPACE 2                                                                
*                                                                               
** EOFSEQ EXITS **                                                              
*                                                                               
NUFSEQEQ CR    RB,RB               SET CC TO EQUAL ON EXIT                      
         BE    NUXIT                                                            
NUFSEQNE CR    RA,RB                                                            
         BNE   NUXIT                                                            
         DC    H'0'                                                             
NUXIT    MVC   DBAREC,NUAREC                                                    
         XIT1                                                                   
         DROP  R5                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* READ THE PROGRAM NAME RECORD TO GET LOCAL DAILIES PROGRAM NAME                
***********************************************************************         
OPNGET   NTR1  BASE=*,LABEL=*,WORK=(R5,PGMNAML)                                 
         USING PGMNAMD,R5                                                       
         USING DEGETD,RC           RC=A(W/S)                                    
         USING COMFACSD,R8         R8=A(COMFACS)                                
         USING DBLOCKD,R6          R6=A(DBLOCK)                                 
*                                                                               
         XC    PGMLSTDR,PGMLSTDR                                                
         MVC   PGMLSTDR,DBLSTDIR   SAVE TIME PERIOD RECORD INFO                 
         MVC   PGMQHMIN,DBMINKEY   TIME PERIOD RECORD MINOR KEY                 
         MVC   PGMAREC,DBAREC      TIME PERIOD RECORD                           
         MVC   SASTALNK,ASTALINK   STATION LINK                                 
*                                                                               
         L     RE,DBAREC                                                        
         MVC   PGMDTIME,L'DBKEY(RE) MINOR KEY JUST READ                         
*                                                                               
* BUILD PROGRMA NAME RECORD KEY                                                 
*                                                                               
         XC    DBKEY,DBKEY                                                      
         MVC   DBKEY(3),=C'PON'                                                 
         MVC   DBKEY+PRSTAT-PRKEY(5),PGMLSTDR+(DRSTAT-DRKEY)                    
         MVC   DBKEY+PRKMKT-PRKEY(2),PGMLSTDR+(DRKMKT-DRKEY)                    
         MVC   DBKEY+PRBOOK-PRKEY(2),PGMLSTDR+(DRBOOK-DRKEY)                    
         XC    DBKEY+PRBOOK-PRKEY(2),=X'FFFF'                                   
         MVI   DBKEY+PRPNMFLG-PRKEY,X'97'   LOWER CASE P                        
         ZIC   RE,PGMDTIME                                                      
         SRL   RE,4                                                             
         STC   RE,DBKEY+PRDAYWK-PRKEY   SET MAJOR KEY--DAY                      
         STC   RE,DBMINKEY+1            SET MINOR KEY--DAY                      
         MVC   DBMINKEY(1),PGMDTIME+1   SET MINOR KEY--TIME                     
*                                                                               
* FOR QTR HRS BETWEEN 6A-945A, SEARCH FOR OVERNIGHT PROGRAMS THAT               
* MIGHT'VE CROSSED THE DDS DAY BOUNDARY.                                        
* ONLY DO THIS FOR THE 1ST 4 HOURS - TO LIMIT EXTRA READS                       
* A "LOGICAL" DECISION WAS MADE THERE WON'T BE MANY IF ANY PROGRAMS             
* THAT GOES FROM 5AM TO 11AM.                                                   
*                                                                               
         MVI   READFLAG,READ_TODAY  DEFAULT IS READ TODAY'S KEYS                
         MVC   PGMSVKEY,DBKEY                                                   
         MVC   PGMSVMIN,DBMINKEY                                                
         ZIC   RF,PGMDTIME+1        UNLESS IT'S BETWEEN 5-945A                  
         CHI   RF,92                                                            
         BNL   OPND                                                             
         CHI   RF,16                                                            
         BH    OPND01                                                           
         AHI   RF,96                                                            
OPND     STC   RF,DBMINKEY                                                      
         MVI   READFLAG,READ_TONIGHT                                            
         B     OPND01                                                           
OPND00   BRAS  RE,ALTERKEY         ALTER DBKEY TO LAST NIGHTS PGM               
         MVC   DBMINKEY+1(1),DBKEY+PRDAYWK-PRKEY                                
         MVI   READFLAG,READ_YESTERDAY                                          
*                                                                               
OPND01   LA    RE,PGMREC                                                        
         ST    RE,DBAREC                                                        
                                                                                
OPND05   MVI   IOFLAG,DIR+HIGH+PAV READ DIRECTORY                               
         GOTO1 AIO,IOFLAG                                                       
         BNE   OPND60              NO PROGRAM LINEUP?                           
         CLC   DBKEY,KEYSAVE       FEB 08 - DISCOVERED FUNKY PRNT+ STAT         
         BE    OPND10              IMPLEMENTING A TRANSPARENCY CODE             
         CLI   DBKEY+PRSTAT+3-PRKEY,C'+'                                        
         BNE   OPND55              BETWEEN PROGRAM NAME AND QH                  
         CLI   KEYSAVE+PRSTAT+3-PRKEY,C'+'                                      
         BE    OPND55              ALREAD TRIED EQUIVALENCE FOR PARENT+         
         MVC   DBKEY,KEYSAVE                                                    
         MVI   DBKEY+PRSTAT+3-PRKEY,C'+'                                        
         MVI   KEYSAVE+PRSTAT+3-PRKEY,C'+'                                      
         B     OPND05                                                           
*                                                                               
OPND10   MVI   IOFLAG,FILE+HIGH+PAV READ FILE WITH QHR AS MINOR KEY             
         GOTO1 AIO,IOFLAG                                                       
         BE    OPND25                                                           
*                                                                               
* IF THERE ISN'T A PROGRAM THAT CROSSED OVER FROM LAST NIGHT INTO               
* EARLY MORNING THIS MORNING. RESTORE DBKEY AND START READING TODAY             
*                                                                               
OPND20   CLI   READFLAG,READ_TONIGHT                                            
         BE    OPND00              TRY YESTERDAY                                
         CLI   READFLAG,READ_TODAY TRIED EVERYTHING?                            
         BE    OPND60                                                           
         MVC   DBKEY,PGMSVKEY      RESTORE TODAY'S PGM DBKEY                    
         MVC   DBMINKEY,PGMSVMIN   RESTORE TODAY'S PGM MINOR KEY                
         MVI   READFLAG,READ_TODAY GO AND READ TODAY                            
         B     OPND05                                                           
*                                                                               
OPND25   DS    0H                  FOUND A GOOD RECORD,                         
         BRAS  RE,VAL5AM                                                        
         BNE   OPND20                                                           
         LA    RE,PGMREC                                                        
         LA    RE,PRFRSTEL-PRCODE(RE)                                           
         SR    R0,R0                                                            
OPND30   CLI   0(RE),0                                                          
         BE    OPND50                                                           
*==============================================================                 
* for adsm, toon, nick, nan, we are not showing                                 
* the correct program lineup, we are showing the next program lineup            
* when the program is not available because we do a read high                   
* this messes up the off line programs                                          
*                                                                               
         CLC   =C'ADSM',DBKEY+PRSTAT-PRKEY                                      
         BE    *+10                                                             
         CLC   =C'NICK',DBKEY+PRSTAT-PRKEY                                      
         BE    *+10                                                             
         CLC   =C'TOON',DBKEY+PRSTAT-PRKEY                                      
         BE    *+10                                                             
         CLC   =C'NAN ',DBKEY+PRSTAT-PRKEY                                      
         BNE   OPND39                                                           
         CLI   0(RE),X'20'         LOOK FOR THE PROGRAM PHELEM                  
         BNE   OPND39                                                           
         USING PHELEM,RE                                                        
         ZIC   R0,PHDUR            DURATION OF PROGRAM                          
         ZIC   R1,PGMREC+PRSTIM-PRKEY                                           
         STC   R1,SVOPNEQH         LAST QTR HOUR OF PROGRAM LINEUP              
         SR    R1,R0                                                            
         STC   R1,SVOPNSQH         START QTR HOUR OF PROGRAM LINEUP             
         DROP  RE                                                               
         MVI   OFFAIRF,C'N'                                                     
         CLC   PGMDTIME+1(1),SVOPNSQH       QTR HOUR RECORD QTR HOUR            
         BL    OPND38                                                           
         CLC   PGMDTIME+1(1),SVOPNEQH       QTR HOUR RECORD QTR HOUR            
         BH    OPND38                                                           
         B     OPND39                                                           
* PROGRAM DID NOT RUN IN THE QTR HOUR OF QTR RECORD                             
* MOVE IN "OFF AIR"                                                             
OPND38   DS    0H                                                               
         MVI   OFFAIRF,C'Y'                                                     
*==============================================================                 
*                                                                               
*                                                                               
OPND39   CLI   0(RE),X'21'         LOOK FOR THE PROGRAM NAME ELEMENT            
         BE    OPND40                                                           
         IC    R0,1(RE)                                                         
         AR    RE,R0                                                            
         B     OPND30                                                           
*                                                                               
OPND40   DS    0H                                                               
         XC    NSIUEL,NSIUEL                                                    
         ZIC   R1,1(RE)                                                         
         SHI   R1,1                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   NSIUEL(0),0(RE)     MOVE ELEMENTS TO SAVE AREA                   
*                                                                               
         L     RE,DBAQUART         NOW MOVE PROGRAM NAME INTO                   
*                                                                               
*                                                                               
         ZIC   R1,1(RE)            THE QHELEM OF THE QHR RECORD                 
         SHI   R1,6                                                             
         LTR   R1,R1                                                            
         JZ    OPND50                                                           
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         J     *+10                                                             
         MVC   6(0,RE),NSIUEL+2                                                 
*                                                                               
         CLI   OFFAIRF,C'Y'                                                     
         BNE   *+14                                                             
         MVC   6(14,RE),=C'NOT AVAILABLE '                                      
         B     OPND50                                                           
*                                                                               
OPND50   XC    DBSPANAD,DBSPANAD                                                
         B     OPND60              EXIT                                         
*                                                                               
OPND55   DS    0H                                                               
* IF NOT FOUND- CHECK TO SEE IF STATION IS A STATION LINKED IN                  
* DEMTABS TABLE                                                                 
*                                                                               
         CLI   STALFLAG,C'Y'                                                    
         BNE   OPND60                                                           
         L     RE,ASTALINK                                                      
         USING CALLLNKD,RE                                                      
         CLC   CALLSTBK,=AL2(FROM_BEGINNING)                                    
         BE    OPND60                                                           
         L     R0,LSTALINK                                                      
         SR    RE,R0                                                            
         ST    RE,ASTALINK                                                      
*                                                                               
         MVC   DBKEY,PGMSVKEY    RESTORE ORIGINAL KEY FIRST                     
         MVC   DBKEY+PRSTAT-PRKEY(4),CALLSTAT                                   
         B     OPND05                                                           
*                                                                               
OPND60   DS    0H                  RESTORE VALUES AND EXIT                      
         MVC   ASTALINK,SASTALNK                                                
         MVC   DBLSTDIR,PGMLSTDR   LAST KEY READ                                
         MVC   DBMINKEY,PGMDTIME   MINOR KEY FROM LAST READ                     
                                                                                
         MVI   IOFLAG,DEM+DIR+HIGH RESTORE I/O READS                            
         GOTO1 AIO,IOFLAG                                                       
         MVI   IOFLAG,DEM+FILE+HIGH                                             
         GOTO1 AIO,IOFLAG                                                       
                                                                                
         MVC   DBMINKEY,PGMQHMIN   RESTORE MINOR KEY OF DBLOCK                  
         MVC   DBAREC,PGMAREC                                                   
         B     OPNSEQEQ                                                         
*                                                                               
** EOFSEQ EXITS **                                                              
*                                                                               
OPNSEQEQ CR    RB,RB               SET CC TO EQUAL ON EXIT                      
         B     OPNXIT                                                           
OPNSEQNE CR    RA,RB                                                            
         B     OPNXIT                                                           
OPNXIT   XIT1                                                                   
         DROP  R5                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
VAL5AM   NTR1  BASE=*,LABEL=*                                                   
*        CLI   READFLAG,READ_TODAY WERE WE READING TODAY'S PROGRAM?             
*        BE    VA30                                                             
VA01     L     R5,DBAREC                                                        
         USING PRKEY,R5                                                         
         ZIC   R1,PRSTIM           END TIME OF THE PROGRAM                      
         AHI   R1,1                                                             
         LA    RE,PRFRSTEL                                                      
VA10     CLI   0(RE),0                                                          
         BE    VA5N                                                             
         CLI   0(RE),PHCODEQ                                                    
         BE    VA20                                                             
*                                                                               
         ZIC   R0,1(RE)                                                         
         AR    RE,R0                                                            
         B     VA10                                                             
*                                                                               
         USING PHELEM,RE                                                        
VA20     ZIC   R0,PHDURTOT         DURATION                                     
         SR    R1,R0                                                            
         CHI   R1,X'5C'            5AM START TIME?                              
         BNL   IS5AM                                                            
         BL    NOT5AM                                                           
*                                                                               
IS5AM    CLI   READFLAG,READ_TONIGHT   TONIGHT: 5AM IS GOOD                     
         BE    VA5Y                                                             
         CLI   READFLAG,READ_YESTERDAY YESTERDAY: 5AM IS BAD                    
         BE    CHK56A                                                           
         CLI   READFLAG,READ_TODAY     TODAY: WERE WE ASKING FOR 5-6?           
         BNE   VA5Y                                                             
         CLI   DBMINKEY,X'5C'                                                   
         BL    CHK56A                                                           
*                                                                               
NOT5AM   CLI   READFLAG,READ_TONIGHT   TONIGHT: NOT5AM IS BAD                   
         BE    VA5N                                                             
         CLI   READFLAG,READ_YESTERDAY YESTERDAY: NOT5AM IS GOOD                
         BE    VA5Y                                                             
         CLI   READFLAG,READ_TODAY     TODAY: NOT5AM IS GOOD                    
         BE    VA5Y                                                             
*                                                                               
CHK56A   MVI   IOFLAG,FILE+SEQ+PAV                                              
         GOTO1 AIO,IOFLAG                                                       
         BE    VA01                                                             
*                                                                               
VA5N     CR    RA,RB                                                            
         B     VA5X                                                             
VA5Y     CR    RB,RB                                                            
         B     VA5X                                                             
VA5X     XIT1                                                                   
         DROP  R5                                                               
         DROP  RE                                                               
***********************************************************************         
* ALTERKEY: ALTER DBKEY TO READ LAST NIGHT'S PROGRAM LINEUP                     
***********************************************************************         
ALTERKEY NTR1  BASE=*,LABEL=*                                                   
         LA    R5,DBKEY                                                         
         USING PRKEY,R5                                                         
         CLI   PRDAYWK,X'01'       MONDAY?                                      
         BE    AK10                                                             
         ZIC   RE,PRDAYWK          NO, SUBTRACT A DAY                           
         SHI   RE,1                                                             
         STC   RE,PRDAYWK                                                       
         B     AKX                                                              
*                                                                               
AK10     MVI   PRDAYWK,X'07'       CHANGE MONDAY TO SUNDAY AND FIX BOOK         
         L     RE,=V(NSIWEEK)                                                   
         A     RE,RELO3                                                         
         ST    RE,VNSIWEEK                                                      
         GOTO1 VNSIWEEK,DMCB,(C'D',PRBOOK),(1,CGETDAY),CADDAY,CDATCON           
         L     RE,DMCB                                                          
         MVC   DUB(6),0(RE)                                                     
         GOTO1 CADDAY,DMCB,DUB,DUB,-7                                           
         GOTO1 VNSIWEEK,DMCB,DUB,(1,CGETDAY),CADDAY,CDATCON                     
         MVC   PRBOOK(1),DMCB+4                                                 
         MVC   PRBOOK+1(1),DMCB                                                 
*                                                                               
AKX      XIT1                                                                   
***********************************************************************         
CHKPLAT  NTR1  BASE=*,LABEL=*                                                   
         USING DEGETD,RC           RC=A(W/S)                                    
         USING COMFACSD,R8         R8=A(COMFACS)                                
         USING DBLOCKD,R6          R6=A(DBLOCK)                                 
         MVC   SVCALL,DBSELSTA                                                  
         CLI   DBSELMED,C'R'       CHECK LIVE PPM FOR ARBITRON                  
         BE    CHKLPPM                                                          
         CLI   DBBTYPE,C'I'        LIMIT THE 'I' BOOK REQUEST                   
         BE    *+12                                                             
         CLI   DBBTYPE,C'P'        LIMIT THE 'P' BOOK REQUEST                   
         BNE   CHKPLATX                                                         
         CLI   DBINTMED,C'W'       WEEKLY  DO CHECK ALSO                        
         BE    *+8                                                              
         CLI   DBINTMED,C'T'                                                    
         BNE   CHKPLATX                                                         
*                                                                               
         CLI   DBFUNCT,DBGETTOT                                                 
         BNE   CHKPLAT2                                                         
         SR    RE,RE                                                            
         ICM   RE,3,DBSELRMK       CONVERT MARKET TO STATION                    
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  DBSELSTA(4),DUB+5(3)                                             
         MVC   DBSELSTA+4(1),DBSELMED                                           
*                                                                               
         USING BSKEY,R2                                                         
CHKPLAT2 LA    R2,DBKEY                                                         
         XC    BSKMAJOR,BSKMAJOR                                                
         MVI   BSCODE,BSCODEQU                                                  
         MVC   BSMEDIA,DBINTMED                                                 
         MVC   BSSRC,DBACTSRC                                                   
         MVC   BSBOOK,DBSELBK                                                   
         MVC   BSSTAT,DBSELSTA                                                  
         MVC   BSKMKT,DBSELMK                                                   
CHKPLAT3 XC    BSBOOK,=X'FFFF'                                                  
         MVI   BSIND,BSINDEQU                                                   
         MVI   IOFLAG,DEM+HIGH+DIR                                              
         GOTO1 AIO,IOFLAG                                                       
         JL    *+2                 FATAL DATAMGR ERROR                          
*                                                                               
         CLC   BSKEY(BSBTYP-BSKEY),KEYSAVE TEST SAME STATION                    
         BNE   CHKPLATX            NO NOT FOUND -> EXIT                         
*                                                                               
*IF WEEKLY METERED SET TABLE TO DEDEMTABS TABLE                                 
*                                                                               
         CLI   DBINTMED,C'W'                                                    
*        BNE   CHKPLAT6                                                         
         BNE   CHKPLAT5                                                         
         GOTO1 CDEMTABS,DMCB,WKLYLPM      GET WEEKLY LPM TABLE                  
         ICM   RE,15,0(R1)         A(TABLE) RETURNED IN P1                      
         JZ    *+2                 BAD TABLEID PASSED                           
         L     R0,4(R1)            L'TABLE ENTRY RETURNED IN P2                 
         USING WKLYLPMD,RE                                                      
CHKPWK1  CLI   0(RE),X'FF'         SCAN FOR THE MARKET                          
         BE    CHKPLATX                                                         
         CLC   BSRMKT,WKLYNMKT                                                  
         BE    CHKPWK2                                                          
         AR    RE,R0                                                            
         B     CHKPWK1                                                          
CHKPWK2  MVC   LPMEMON,WKLYDATE    AND SET PARALLEL END IF FOUND                
         B     CHKPLAT7                                                         
         DROP  RE                                                               
*                                                                               
CHKPLAT5 GOTO1 CDEMTABS,DMCB,LPMSTEND     GET WEEKLY LPM TABLE                  
         ICM   RE,15,0(R1)         A(TABLE) RETURNED IN P1                      
         JZ    *+2                 BAD TABLEID PASSED                           
         L     R0,4(R1)            L'TABLE ENTRY RETURNED IN P2                 
         USING LPMSETD,RE                                                       
CHKPLAT6 CLI   0(RE),X'FF'         SCAN FOR THE MARKET                          
         BE    CHKPLATX                                                         
         CLC   DBBTYPE,LPMSEBKT                                                 
         BNE   *+10                                                             
         CLC   BSRMKT,LPMSETMK                                                  
         BE    CHKPLT6A                                                         
         AR    RE,R0                                                            
         B     CHKPLAT6                                                         
CHKPLT6A MVC   LPMEMON,LPMEND      AND SET PARALLEL END IF FOUND                
CHKPLAT7 OC    DBSELBK,DBSELBK                                                  
         BZ    CHKPLAT8                                                         
         CLC   DBSELBK,LPMEMON                                                  
         BNH   CHKPLATX                                                         
         B     CHKPLAT9                                                         
CHKPLAT8 CLC   DBSELDAT,LPMEMON                                                 
         BL    CHKPLATX                                                         
CHKPLAT9 CLI   DBBTYPE,C'I'                                                     
         BNE   *+12                                                             
         MVI   DBBTYPE,C'H'        RESET HISPANIC                               
         B     CHKPLATX                                                         
         MVI   DBBTYPE,0           RESET NORMAL                                 
         DROP  RE                                                               
         B     CHKPLATX                                                         
         DROP  R2                                                               
CHKLPPM  DS    0C                  CHECK PPM MARKET FOR ARBITRON LOOKUP         
         CLI   DBSELSRC,C'T'       NOT FOR TRITON                               
         BE    CHKLPPMX                                                         
         GOTO1 CDEMTABS,DMCB,PPMTAB                                             
         ICM   RE,15,0(R1)         A(TABLE) RETURNED IN P1                      
         JZ    *+2                 BAD TABLEID PASSED                           
         L     R0,4(R1)            L'TABLE ENTRY RETURNED IN P2                 
         USING PPMTABD,RE                                                       
CHKLPPM2 CLC   =X'FFFF',0(RE)                                                   
         BE    CHKLPPMX                                                         
         OC    DBSELALF,DBSELALF                                                
         BNZ   CHKLPPM4                                                         
         CLC   DBSELMK,PPMNMKT                                                  
         BNE   CHKLPPM8                                                         
         B     CHKLPPM6                                                         
CHKLPPM4 CLC   DBSELALF,PPMAMKT    PPM MARKET IN TABLE?                         
         BNE   CHKLPPM8                                                         
CHKLPPM6 CLC   DBSELBK,PPMSTRTP    IF BOOK BEFORE START PRELIM                  
         BL    CHKLPPM7            ALSO GET RID OF PPM BOOKTYPES                
         CLC   DBSELBK,PPMLIVBK                                                 
         BL    CHKLPPM9                                                         
* FOR LATEST BOOK LOOKUP WE WANT TO SET A FLAG FOR THE 1ST REAL                 
* LATEST BOOK COMPARISON...DONT SET FLAG FOR FIRST INIT CALL                    
* WHERE DBSELBK IS NOT SET YET TO A REAL BOOK THAT HAS BEEN READ                
* ALSO LATEST BOOK LOOKUPS ALWAYS WILL END UP STRIPPING THE                     
* THE PRELIM BOOKTYPES BECAUSE LATEST ARB BOOK LOOKUPS WILL ONLY SHOW           
* THE PRELIM BOOKS IF THE LIVE PPM BOOK IS OUT- LATEST BOOK MUST BE             
* AFTER LIVE PPM BOOK HENCE THE BOOKTYPE SHOULD NOT BE A PRELIM BKTYP           
         OC    DBSELBK,DBSELBK                                                  
         BZ    CHKLPPM7                                                         
         CLI   DBSELBK,X'FF'                                                    
         BE    CHKLPPM7                                                         
         MVI   PPM_FLAG,PPMLVBKY   PPM LIVE BOOK IS LOADED                      
CHKLPPM7 DS    0C                                                               
CHKPP7B  CLI   DBBTYPE,C'P'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,0                                                        
         CLI   DBBTYPE,C'E'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,C'B'                                                     
         CLI   DBBTYPE,C'I'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,C'H'                                                     
         B     CHKLPPMX                                                         
CHKLPPM8 AR    RE,R0                                                            
         B     CHKLPPM2                                                         
*                                                                               
* BOOK BEFORE LIVE PPM BOOK                                                     
* CHECK TO SEE IF WITHIN PRELIMINARY PERIOD                                     
* IF SO USE PRELIMINARY BOOKTYPE                                                
* EXCEPT FOR RESEARCH ONLY APPLICATIONS                                         
*                                                                               
CHKLPPM9 DS    0H                                                               
CHKPPM10 CLC   DBSELBK,PPMSTRTP                                                 
         BL    CHKLPPMX                                                         
         CLC   DBSELBK,PPMENDP                                                  
         BH    CHKLPPMX                                                         
         CLI   MBKFLAG,C'Y'                                                     
         BNE   CHKPPM11                                                         
         CLI   PPM_FLAG,PPMLVBKY PRELIM BOOKS ONLY IF LIVE PPM                  
         BE    CHKPPM11          BOOK IS LOADED                                 
         MVC   HALF,PPMLIVBK                                                    
         MVC   DBSELRMK,PPMNMKT  SET JUST IN CASE NOT PASSED IN                 
         MVC   DBSELMK,PPMNMKT   SET JUST IN CASE NOT PASSED IN                 
         BAS   RE,CHLATPPM       FOR MULTIBOOK AVG ONLY READ                    
         CLI   PPM_FLAG,PPMLVBKY PRELIM BOOKS ONLY IF LIVE PPM                  
         BNE   CHKLPPMX          BOOK IS LOADED                                 
                                                                                
CHKPPM11 CLI   DBBTYPE,0                                                        
         BNE   *+8                                                              
         MVI   DBBTYPE,C'P'                                                     
         CLI   DBBTYPE,C'B'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,C'E'                                                     
         CLI   DBBTYPE,C'H'                                                     
         BNE   *+8                                                              
         MVI   DBBTYPE,C'I'                                                     
         B     CHKLPPMX                                                         
*                                                                               
CHKLPPMX B     CHKPLATX                                                         
*                                                                               
*                                                                               
CHKPLATX MVC   DBSELSTA,SVCALL                                                  
         XIT1  ,                                                                
*                                                                               
CHLATPPM NTR1                                                                   
         SR    RE,RE                                                            
         ICM   RE,3,DBSELRMK       CONVERT MARKET TO STATION                    
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  DBSELSTA(4),DUB+5(3)                                             
         MVI   DBSELSTA+4,C'A'                                                  
*                                                                               
         USING SBKEY,R2                                                         
         LA    R2,DBKEY                                                         
         XC    SBKMAJOR,SBKMAJOR                                                
         MVI   SBCODE,SBCODEQU                                                  
         MVC   SBMEDIA,DBINTMED                                                 
         MVC   SBSRC,DBACTSRC                                                   
         MVC   SBBOOK,DBSELBK                                                   
         MVC   SBSTAT,DBSELSTA                                                  
         MVC   SBKMKT,DBSELMK                                                   
         MVC   SBRMKT,DBSELMK                                                   
         MVC   SBBOOK,HALF                                                      
         MVI   IOFLAG,DEM+HIGH+DIR                                              
         GOTO1 AIO,IOFLAG                                                       
         JL    *+2                 FATAL DATAMGR ERROR                          
*                                                                               
         XC    HALF,HALF                                                        
         CLC   SBKEY(SBHOME-SBKEY),KEYSAVE TEST SAME STATION                    
         BNE   *+8                 NO NOT FOUND -> EXIT                         
         MVI   PPM_FLAG,PPMLVBKY   LIVE PPM BOOK LOADED                         
         XIT1                                                                   
*                                                                               
LPMENDP  DS    0CL4 TABLE OF LPM PARALLEL END DATES (REGULAR)                   
         DC    AL2(101),AL2(SEP_04) NY                                          
         DC    AL2(403),AL2(AUG_04) LA                                          
         DC    AL2(202),AL2(OCT_04) CHI                                         
         DC    AL2(407),AL2(JAN_05) SF                                          
         DC    AL2(111),AL2(JUN_05) WAS     MAY04 START LPM                     
         DC    AL2(104),AL2(JUN_05) PHL                                         
         DC    AL2(105),AL2(DEC_05) DET     LIVE JAN06                          
         DC    AL2(223),AL2(DEC_05) DALLAS FT WORTH                             
         DC    AL2(168),AL2(JUN_06) ATLANTA                                     
         DC    X'FFFF'                                                          
*                                                                               
LPMENDI  DS    0CL4 TABLE OF LPM PARALLEL END DATES (HISPANIC)                  
         DC    AL2(101),AL2(SEP_04) NY                                          
         DC    AL2(202),AL2(OCT_04) CHI                                         
         DC    AL2(407),AL2(JAN_05) SF                                          
         DC    X'FFFF'                                                          
*                                                                               
         EJECT                                                                  
*                                                                               
INITG    NTR1  BASE=*,LABEL=*                                                   
         USING DEGETD,RC           RC=A(W/S)                                    
         USING COMFACSD,R8         R8=A(COMFACS)                                
*                                                                               
         XC    TOONLIST,TOONLIST                                                
         MVI   TOONSTAF,TOONDONE                                                
         MVI   MERGEF,C'Y'                                                      
         CLC   =C'TOON',DBSELSTA                                                
         BE    *+10                                                             
         CLC   =C'ADSM',DBSELSTA                                                
         BNE   INITG1A                                                          
         MVC   TOONLIST(10),=C'ADSMTTOONT'                                      
         MVI   TOONSTAF,TOONFST                                                 
         B     INITG1B                                                          
INITG1A  CLC   =C'NICK',DBSELSTA                                                
         BE    *+10                                                             
         CLC   =C'NAN ',DBSELSTA                                                
         BNE   INITG1B                                                          
         MVC   TOONLIST(10),=C'NICKTNAN T'                                      
         MVI   TOONSTAF,TOONFST                                                 
         B     INITG1B                                                          
INITG1B  DS    0H                                                               
*                                                                               
         MVC   SVSELTM2,DBSELTIM                                                
*  WE ONLY HAVE LS BOOKTYPES POST JAN17 FOR FUSION                              
INITG1T  CLI   DBSELSRC,C'F'                                                    
         BNE   *+18                                                             
         CLC   DBSELBK,=AL2(JAN_17)                                             
         BL    *+8                                                              
         MVI   DBBTYPE,BOOKTYPE_LS                                              
*                                                                               
         CLI   DBVOPT,X'40'         CHECK IF POSTING CALL                       
         BNE   INITG1Z                                                          
*                                                                               
         CLI   DBSELMED,C'F'                                                    
         BE    *+8                                                              
         CLI   DBSELMED,C'T'        6AM 2 MIN AFFID RULE ONLY FOR               
         BNE   INITG1V              USTV, OVERNIGHTS, FUSION                    
****     CLC   DBSELBK,=AL2(NOV_13)   NOV13- TEST DATA 3A START                 
         CLC   DBSELBK,=AL2(DEC_15)   THIS SHOULD BE DEC_15 IN PROD             
         BL    INITG1Z                                                          
         B     INITG1Y                                                          
*                                                                               
INITG1V  CLI   DBSELMED,C'O'         OVERNGIHTS 2MIN SHOULD ONLY                
         BNE   INITG1Z               BE FUTURE BOOKS                            
****     CLC   DBSELBK,=X'7328'    SEP2815 -JAN0116  FOR TESTING                
*                                  DEC0715 EFFECTIVE START FOR 2MIN             
         CLC   DBSELBK,=AL1(YR_2015,WEEK_50)                                    
         BL    INITG1Z                                                          
INITG1Y  MVC   SVSELTIM,DBSELTIM                                                
INITG1Z  DS    0C                                                               
*                                                                               
INITG02  CLI   DBSELMED,C'T'                                                    
         BNE   INITG04                                                          
         CLI   DBSELSRC,C'N'                                                    
         BNE   INITG04                                                          
         CLC   DBSELBK,=AL2(FEB_17)                                             
         BL    INITG04                                                          
         CLC   DBSELBK,=AL2(MAY_17)                                             
         BH    INITG04                                                          
         CLC   =C'WNBD',DBSELSTA                                                
         BNE   *+14                                                             
         MVC   DBSELSTA,=C'ENBDT'                                               
         B     INITG04                                                          
         CLC   =C'WXVT',DBSELSTA                                                
         BNE   *+14                                                             
         MVC   DBSELSTA,=C'WNBDT'                                               
         B     INITG04                                                          
*                                                                               
*                                                                               
*  for the 2 min break rule - 6a lookups doesnt work because we cant            
*  decrement back pass 00                                                       
INITG04  CLI   DBVOPT,X'40'         CHECK IF POSTING CALL                       
         BNE   INITG10                                                          
         CLI   DBSELMED,C'T'        6AM 2 MIN AFFID RULE ONLY FOR               
         BE    *+8                  USTV, OVERNIGHTS, FUSION                    
         CLI   DBSELMED,C'F'                                                    
         BNE   INITG05                                                          
***      CLC   DBSELBK,=AL2(NOV_13)     THIS SHOULD BE DEC_15 IN PROD           
         CLC   DBSELBK,=AL2(DEC_15)     DEC_15 EFFECTIVE FOR 2MIN RULE          
         BL    INITG10                                                          
         B     INITG06                                                          
*                                                                               
INITG05  DS    0H                                                               
         CLI   DBSELMED,C'O'                                                    
         BNE   INITG10                                                          
***      CLC   DBSELBK,=X'7328'         THIS SHOULD BE DEC_0115 IN PROD         
*                                       DEC0715 EFFECTIVE FOR 2MIN RULE         
         CLC   DBSELBK,=AL1(YR_2015,WEEK_50)                                    
         BL    INITG10                                                          
INITG06  MVC   SVSELTIM,DBSELTIM                                                
         CLC   =X'02580000',DBSELTIM    6A AFFID LOOKUP CHANGE                  
         BE    *+10                     TO 545A-615A                            
         CLC   =X'02590000',DBSELTIM    601A AFFID LOOKUP CHANGE                
         BE    *+10                     TO 545A-615A                            
         CLC   =X'025A0000',DBSELTIM    602A AFFID LOOKUP CHANGE                
         BE    *+10                     TO 545A-615A                            
         CLC   =X'022F0000',DBSELTIM    559 AFFID LOOKUP CHANGE                 
         BE    *+10                     TO 545A-615A                            
         CLC   =X'022E0000',DBSELTIM    558 AFFID LOOKUP CHANGE                 
         BNE   INITG10                  TO 545A-615A                            
         MVC   DBSELTIM(4),=X'02210267'                                         
*                                                                               
* SQAD STUFF                                                                    
INITG10  OC    DBSELALF,DBSELALF   IF DBSELALF IS NOT NULLS                     
         BZ    SQSTAX                                                           
         CLC   DBSELALF,=3C' '      AND IT'S NOT BLANKS,                        
         BE    SQSTAX                                                           
         MVC   DUB(3),DBSELALF      THEN USE IT                                 
***      BAS   RE,TRAMKT           TRANSLATE ALPHAMKT TO NUMERIC MKT            
         BRAS  RE,TRAMKT           TRANSLATE ALPHAMKT TO NUMERIC MKT            
         MVC   DBACTKMK,DUB+3      DUB+3(2) = NUMERIC MARKET                    
*                                                                               
         CLI   DBSELMED,C'C'                                                    
         BNE   INITG16                                                          
         CLC   DBSELALF,=C'NWK'   REGIONAL NETWORKS                             
         BNE   INITG16            IF USER ASK FOR SPILL NWK                     
         LA    RE,REGIONTB        SWITCH TO THE REGIONAL MARKET NUMBER          
INITG12  CLI   0(RE),X'FF'                                                      
         BE    INITG16                                                          
         CLC   DBSELSTA(4),0(RE)                                                
         BE    INITG14                                                          
         AHI   RE,L'REGIONTB                                                    
         B     INITG12                                                          
INITG14  MVC  DBACTKMK,4(RE)                                                    
*                                                                               
INITG16  CLI   SQADACT,C'Y'                                                     
         BE    *+10                                                             
         MVC   DBSELMK,DBACTKMK                                                 
*                                                                               
         OC    DBSELSTA,DBSELSTA   NO STATION FOR SQAD                          
         BNZ   SQSTAX                                                           
         CLI   SQADACT,C'Y'                                                     
         BNE   SQSTAX                                                           
         SR    RE,RE                                                            
         ICM   RE,3,DBACTKMK       GET FROM ALPHA MRKT                          
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  DBACTSTA(4),DUB+5(3)                                             
         MVC   DBACTSTA+4(1),DBSELMED                                           
         MVC   DBSELSTA(5),DBACTSTA                                             
SQSTAX   DS    0C                                                               
*                                                                               
* CORRECTION FOR SPOT PROBLEM/INTERCHANGED OTA WITH OT AND MTA WITH MO          
* OT AND MO NO LONGET EXIST FOR BBM                                             
         CLI   DBSELMED,C'C'                                                    
         JNE   OKOTMO                                                           
         CLI   DBSELSRC,C'A'                                                    
         BNE   OKOTMO                                                           
         OC    DBSELBK,DBSELBK                                                  
         JZ    OKOTMO                                                           
         CLC   DBSELBK,=AL2(NOV_00)                                             
         BL    OKOTMO                                                           
         CLC   DBACTKMK,=AL2(4479)  OTTAWA GETS                                 
         BNE   *+10                                                             
         MVC   DBACTKMK,=AL2(4480)  OTTAW ANGLO                                 
         CLC   DBACTKMK,=AL2(5069)  MONTREAL GETS                               
         BNE   *+10                                                             
         MVC   DBACTKMK,=AL2(5071)  MONTREAL ANGLO                              
OKOTMO   DS    0C                                                               
         XIT1  ,                                                                
         LTORG                                                                  
REGIONTB DS    0CL6                TABLES OF REGIONAL NETWORKS                  
ONTARIO  DC    C'CBCO',AL2(3)      THAT SHOULD WORK IF REQUESTED                
         DC    C'CTVO',AL2(3)      WITH DBSELALF=NWK                            
         DC    C'CHUM',AL2(3)                                                   
         DC    C'WEYI',AL2(3)                                                   
         DC    C'WUTV',AL2(3)                                                   
         DC    C'TCIT',AL2(3)                                                   
         DC    C'CITY',AL2(3)                                                   
         DC    C'CPNW',AL2(3)                                                   
         DC    C'CKVR',AL2(3)                                                   
         DC    C'CIII',AL2(3)                                                   
         DC    C'CFMT',AL2(3)                                                   
         DC    C'OMNT',AL2(3)                                                   
         DC    C'SPN ',AL2(3)                                                   
QUEBEC   DC    C'ARTV',AL2(4)                                                   
         DC    C'ADDK',AL2(4)                                                   
         DC    C'CAND',AL2(4)                                                   
         DC    C'VIE ',AL2(4)                                                   
         DC    C'CASA',AL2(4)                                                   
         DC    C'EVAS',AL2(4)                                                   
         DC    C'HISF',AL2(4)                                                   
         DC    C'NVST',AL2(4)                                                   
         DC    C'LCN ',AL2(4)                                                   
         DC    C'METM',AL2(4)                                                   
         DC    C'MUSI',AL2(4)                                                   
         DC    C'PLUS',AL2(4)                                                   
         DC    C'PRIS',AL2(4)                                                   
         DC    C'RDI ',AL2(4)                                                   
         DC    C'RDS ',AL2(4)                                                   
         DC    C'SXVA',AL2(4)                                                   
         DC    C'SERI',AL2(4)                                                   
         DC    C'SRC ',AL2(4)                                                   
         DC    C'CBFT',AL2(4)                                                   
         DC    C'TELE',AL2(4)                                                   
         DC    C'TLQ ',AL2(4)                                                   
         DC    C'TV5 ',AL2(4)                                                   
         DC    C'TVA ',AL2(4)                                                   
         DC    C'CFTM',AL2(4)                                                   
         DC    C'TVAS',AL2(4)                                                   
         DC    C'TQS ',AL2(4)                                                   
         DC    C'CFJP',AL2(4)                                                   
         DC    C'VRAK',AL2(4)                                                   
         DC    C'CANZ',AL2(4)                                                   
         DC    C'SUPX',AL2(4)                                                   
         DC    C'CBET',AL2(4)                                                   
         DC    C'ELLE',AL2(4)                                                   
         DC    X'FF'                                                            
                                                                                
         EJECT                                                                  
*                                                                               
* CHECK TO SEE IF STATION IS CABLE                                              
*                                                                               
CHECKCAB NTR1  BASE=*,LABEL=*                                                   
         MVI   CABLEFLG,C'N'                                                    
         OC    DBSELMK,DBSELMK                                                  
         BNZ   *+14                                                             
         OC    DBSELALF,DBSELALF                                                
         BZ    CHKCABX                                                          
*                                                                               
* CONVERT CALL LETTER TO NETWORK NUMERIC ID                                     
         L     RF,DBCOMFCS                                                      
         ICM   RF,15,CDEMTABS-COMFACSD(RF)                                      
         GOTO1 (RF),DMCB,NSICABLE                                               
         ICM   RE,15,0(R1)                                                      
         JZ    *+2                                                              
         L     R0,4(R1)            R0 HAS LENGTH OF TABLE ENTRY                 
         LR    R1,RE               R1=A(TABLE)                                  
CHKCAB10 CLI   0(R1),X'FF'         EOT?                                         
         BE    CHKCABX                                                          
*                                                                               
         CLC   DBSELSTA(4),0(R1)   COMPARE STATION CALL LETTERS                 
         BE    CHKCAB20                                                         
         AR    R1,R0                                                            
         B     CHKCAB10                                                         
CHKCAB20 MVI   CABLEFLG,C'Y'                                                    
CHKCABX  XIT1  ,                                                                
         LTORG                                                                  
         EJECT                                                                  
LOCCABLK NTR1  BASE=*,LABEL=*                                                   
         CLI   DBFUNCT,DBGETTOT                                                 
         BE    LOCALX                                                           
         CLI   DBFUNCT,DBGETTTL                                                 
         BE    LOCALX                                                           
         OC    ALOCNTRY,ALOCNTRY                                                
         BZ    LOCCAB04                                                         
         MVC   DBSELALF,SVALF                                                   
         MVC   DBSELMK,SVSELMK                                                  
         MVC   DBSELSTA,SVCALL                                                  
* NEW CODE -BYPASS LOCAL CABLE LINK ENTIRELY IF SPILL MKT                       
* PASSED IN                                                                     
LOCCAB04 DS    0C                                                               
*&&DO                                                                           
LOCCAB04 CLC   =C'ZNY1',DBSELSTA   SPECIAL CASE TO TRANLATE ZNY1                
         BE    *+10                                                             
         CLC   =C'ZSPC',DBSELSTA   SPECIAL CASE TO TRANLATE ZNY1                
         BE    *+10                                                             
         CLC   =C'ZCFN',DBSELSTA   SPECIAL CASE TO TRANLATE ZNY1                
         BE    *+10                                                             
         CLC   =C'ZBN9',DBSELSTA   SPECIAL CASE TO TRANLATE ZBN9                
         BE    *+10                                                             
         CLC   =C'ZCTW',DBSELSTA   SPECIAL CASE TO TRANLATE ZCTW                
         BE    LOCCAB4A                                                         
* REMOVE REQUIREMENT THAT SPILL LOOKUPS DO NOT LOOK AT THIS TABLE               
         OC    DBSELALF,DBSELALF                                                
         BNZ   LOCALX              DONT CHECK SPILL MKT ANYMORE                 
         OC    DBSELMK,DBSELMK     DUE TO ZCTW SITUATION                        
         BNZ   LOCALX                                                           
*&&                                                                             
LOCCAB4A XC    DBACTBTY,DBACTBTY                                                
         CLI   DBSELMED,C'O'                                                    
         BE    *+8                                                              
         CLI   DBSELMED,C'T'                                                    
         BNE   LOCALX                                                           
* 05/1/18 REMOVED.  I DONT SEE WHY FUSION SHJOULD BE USING THIS                 
* TABLE.  FUSION LINKS ARE TO NSICBL TABLE                                      
***      CLI   DBSELSRC,C'F'                                                    
***      BE    *+8                                                              
         CLI   DBSELSRC,C'N'                                                    
         BNE   LOCALX                                                           
         GOTO1 CDEMTABS,DMCB,LOCALCAB   GET A(LOCAL CABLE TABLE)                
         ICM   RE,15,0(R1)         A(TABLE) RETURNED IN P1                      
         JZ    *+2                 BAD TABLEID PASSED                           
         L     RF,4(R1)            L'TABLE ENTRY RETURNED IN P2                 
         USING LOCCABD,RE                                                       
         OC    ALOCNTRY,ALOCNTRY   IF WE ALREADY HAD A LINK AND                 
         BZ    LOCAL10             WE DIDNT FIND DATA WE SHOULD READ            
         L     RE,ALOCNTRY         THE NEXT ENTRY STORED IN ALOCNTRY            
         B     LOCAL20                                                          
LOCAL10  CLI   0(RE),X'FF'                                                      
         BE    LOCALX                                                           
         CLC   LOCSPOTC,DBSELSTA                                                
         BE    LOCAL20                                                          
LOCAL15  AR    RE,RF                                                            
         B     LOCAL10                                                          
LOCAL20  MVC   DBSELSTA(5),LOCNSIC      LINK STATION TO READ                    
         MVC   DBACTSTA(5),LOCNSIC      LINK STATION TO READ                    
         OC    SVALOCNT,SVALOCNT        ONLY SET ONCE                           
         BNZ   *+8                                                              
         ST    RE,SVALOCNT                                                      
         CLI   LOCLEVEL,LOC_NOT_LAST_LEVEL                                      
         BNE   *+12                     IF THERE ARE MORE LEVELS FOR            
         LR    R0,RE                                                            
         AR    R0,RF                    LOC CALL LETTERS THEN                   
         ST    R0,ALOCNTRY              SAVE NEXT TABLE ENTRY                   
*                                                                               
         CLI   LOCLEVEL,LOC_LAST_LEVEL                                          
         BNE   *+10                                                             
         XC    ALOCNTRY,ALOCNTRY                                                
*&&DO                                                                           
* IF SPILL MKT PASED IN- AND ITS DIFFERENT THAN THE MKT IN TABLE                
* THEN BYPASS.  DEGET HAS ALREADY SET UP THE MKT AND SOURCE SWITCH              
* FOR FUSION LPM LOOKUPS                                                        
* IF MKT IS DIFFERENT THAN IN TABLE THAT MEANS WE ARE LOOKING AT A              
* REAL NSI CALL LETTER IN A SPILL MKT                                           
*                                                                               
         OC    DBSELALF,DBSELALF                                                
         BZ    LOCAL30                                                          
         CLC   DBSELALF,LOCALPHA                                                
         BE    LOCAL50                                                          
         B     LOCAL15                                                          
LOCAL30  OC    DBSELMK,DBSELMK                                                  
         BZ    LOCAL50                                                          
         CLC   DBSELMK,LOCSMKT                                                  
         BNE   LOCAL15                                                          
*&&                                                                             
LOCAL50  DS    0H                                                               
* IF WE FOUND A LINK TO A SPILL MARKET - MAKE SURE IF REQUESTING                
* BY SPILL MARKET WE MATCH THE HOME MARKET OF CALL LETTER                       
* WE DONT WANT CSNE/SCH TO READ CSNE/BOS IF CSNE/SCH IS NOT FOUND               
*                                                                               
*                                                                               
         OC    DBSELALF,DBSELALF                                                
         BZ    LOCAL50A                                                         
         CLC   DBSELALF,LOCHAMK                                                 
         BE    LOCAL51                                                          
         B     LOCAL15                                                          
LOCAL50A DS    0H                                                               
         OC    DBSELMK,DBSELMK                                                  
         BZ    LOCAL51                                                          
         CLC   DBSELMK,LOCHKMK                                                  
         BNE   LOCAL15                                                          
*                                                                               
LOCAL51  MVC   DBSELMK,LOCSMKT          SPILL MKT TO READ                       
         MVC   DBACTKMK,LOCSMKT          SPILL MKT TO READ                      
         MVC   DBSELALF,LOCALPHA         SPILL MKT TO READ                      
* GET ASSOCIATED BOOKTYPE SWITCH TABLE                                          
*                                                                               
                                                                                
         ZICM  RF,LOCABKTB,(15)         DISP TO BOOKTYPE TABLE                  
         AR    RE,RF                    ADD TO LOCAL CABLE TAB ENTRY            
         USING LOCBKTBD,RE                                                      
**       CLC   DBSELMK,=X'006A'                                                 
**       BNE   *+6                                                              
**       DC    H'0'                                                             
LOCAL52  CLI   0(RE),X'FF'                                                      
         BE    LOCAL60                                                          
*                                                                               
         CLC   DBBTYPE,LOCINBT                                                  
         BE    LOCAL54                                                          
         AHI   RE,LOCBKTBQ                                                      
         B     LOCAL52                                                          
*                                                                               
LOCAL54  MVC   DBBTYPE,LOCOUTBT         SWITCH BOOKTYPE                         
         MVC   DBACTBTY,LOCOUTBT                                                
**       CLC   DBSELMK,=X'006A'                                                 
**       BNE   *+6                                                              
**       DC    H'0'                                                             
         DROP  RE                                                               
*                                                                               
LOCAL60  MVI   DBACTSRC,C'N'            LOCAL CABLE ALWAYS READ NSI             
         MVI   DBSELSRC,C'N'            LOCAL CABLE ALWAYS READ NSI             
*                                                                               
         CLI   DBFUNCT,DBGETTOT         CABLE PUTS LOOK AT                      
         BNE   LOCALX                   STANDARD BOOKTYPE                       
*                                       AND CLEAR SPILL MKT FIELDS              
         CLI   DBBTYPE,C'C'                                                     
         BE    *+8                                                              
         CLI   DBBTYPE,C'4'                                                     
         BNE   LOCAL70                                                          
         MVI   DBBTYPE,0                                                        
         B     LOCAL80                                                          
*                                                                               
LOCAL70  CLI   DBBTYPE,BOOKTYPE_C3                                              
         BNE   LOCAL74                                                          
         MVI   DBBTYPE,BOOKTYPE_L3                                              
         B     LOCAL80                                                          
*                                                                               
LOCAL74  CLI   DBBTYPE,C'U'                                                     
         BNE   LOCALX                                                           
         MVI   DBBTYPE,C'L'                                                     
         B     LOCAL80                                                          
*                                                                               
LOCAL80  MVC   DBACTBTY,DBBTYPE                                                 
         MVC   DBACTRMK,DBACTKMK                                                
         SR    R1,R1               YES - SET STATION TO NNNNT                   
         ICM   R1,3,DBACTRMK                                                    
         LTR   R1,R1                                                            
         BNZ   *+8                                                              
         ICM   R1,3,DBSELRMK                                                    
         CVD   R1,DUB                                                           
         UNPK  DBACTSTA(4),DUB                                                  
         OI    DBACTSTA+3,X'F0'                                                 
         MVI   DBACTSTA+4,C'T'                                                  
         MVI   DBSELSTA+4,C'T'     DISALLOW SATELLITES                          
         XC    DBSELMK,DBSELMK                                                  
         XC    DBSELALF,DBSELALF                                                
         XC    DBACTKMK,DBACTKMK                                                
*                                                                               
LOCALX   XIT1  ,                                                                
         LTORG                                                                  
******************************************************************              
* STATION CALL LETTER LINK CODE                                                 
* CHECK DEMTABS TABLE FOR CALL LETTER LINKS                                     
* ENTRY  - DMCB(1)=00 = FOR OVN/WEEKLY INITIAL CALL.  SET DBACTSTA              
*                       TO CALL LETTERS IN LAST TABLE ENTRY                     
*                                                                               
*          DMCB(1)=01 = FOR OVN/WEEKLY- READ PREVIOUS TABLE ENTRY               
*          DMCB+1(3)=A(BOOK)                                                    
*          DMCB+4=A(STATION OUTPUT)                                             
*          IF NO MORE ENTRIES TO GO BACK DMCB+8(2),=X'FFFF'                     
*                                                                               
* FOR DMCB(1)=00                                                                
* ON EXIT- DBACTSTA IS SET                                                      
* FOR LATEST BOOK LOOKUPS                                                       
*          DBACTSTA IS SET TO LATEST STATION CALL LETTER                        
*          DBSELSTA IS SET TO NEXT TO LATEST STATION CALL LETTER                
*          FOR LATEST BOOK LOOKUP                                               
* OVERNIGHTS/WEEKLY LOOKUPS WILL ALWAYS EXIT WITH ASTALINK POINTING             
* TO THE LAST ENTRY IN THE GROUP                                                
*                                                                               
******************************************************************              
STALINK  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
* CHECK FOR SITUATION WHEN A STATION CALL LETTER WAS                            
* USED IMMEDIATELY AFTER IT WAS MADE AVAILABLE                                  
*                                                                               
*                                                                               
*  PREVIOUS                      NEW                                            
* -----------                   -------------                                   
*  KTVA (CBS)                    KYES (CBS)                                     
*  KYES (MYNET)                  QYES (MYNET)                                   
*                                                                               
* *********RESEARCH + POSTING  +BUY                                             
* KTVA -> KYES BOOK>=AUG20 OLD CBS -> NEW CBS AFFL                              
* KYES -> KYES BOOK>=AUG20 KYES IS REUSED AS CBS AFFL TOO BAD! NOLINK           
* QYES ->KYES BOOK<AUG20  QYES IS NEW MYNET AFFL POINT TO OLD MYNET             
*                                                                               
* *********POSTING ONLY                                                         
* KYES-> KYES (OLD MYNET) BOOK<AUG20 NO LINK                                    
* *********RESEARCH ONLY                                                        
* KYES-> KTVA BOOK<AUG20  POINT TO OLD CBS DATA FOR TRENDING                    
**                                                                              
*                                                                               
* POSTING + RESEARCH + BUY KTVA>=AUG20                                          
*RESEARCH AND POSTING                                                           
*KTVA >= AUG20 LOOK FOR KYES (NEW CBS AFFIL)                                    
STALNK01 CLC   =CL4'KTVA',DBSELSTA                                              
         BNE   STALNK1A                                                         
         CLC   DBSELBK,=AL2(AUG_20)                                             
         BL    STALNK1A                                                         
         MVC   DBSELSTA(4),=CL4'KYES'                                           
         B     STALNK15                                                         
*                                                                               
STALNK1A CLC   =CL4'QYES',DBSELSTA                                              
         BNE   STALNK1B                                                         
         CLC   DBSELBK,=AL2(AUG_20)                                             
         BNL   STALNK1B                                                         
         MVC   DBSELSTA(4),=CL4'KYES'                                           
         B     STALNK15                                                         
* NOT FOR POSTING                                                               
* FOR RESEARCH WE WANT KYES <AUG20 TO POINT TO KTVA)                            
* BUT ONLY AFTER AUG20 BOOK IS OUT?????                                         
* BECAUSE KYES USED TO BE MYNET WHAT DO WE DO?                                  
STALNK1B CLI   DBVOPT,X'40'         CHECK IF POSTING CALL                       
         BE    STALNK02                                                         
         CLC   =CL4'KYES',DBSELSTA                                              
         BNE   STALNK02                                                         
         CLC   DBSELBK,=AL2(AUG_20)                                             
         BNL   STALNK02                                                         
         MVC   DBSELSTA(4),=CL4'KTVA'                                           
         B     STALNK15                                                         
************************************************                                
*                                                                               
STALNK02 DS    0H                                                               
         CLC   =CL4'NYMA',DBSELSTA                                              
         BNE   STALNK03                                                         
         CLC   DBSELBK,=AL2(JAN_20)                                             
         BNL   *+14                                                             
         MVC   DBSELSTA(4),=CL4'KYMA'                                           
         B     STALNK15                                                         
         CLC   DBSELBK,=AL2(MAR_20)                                             
         BNL   *+14                                                             
         MVC   DBSELSTA(4),=CL4'MYMA'                                           
         B     STALNK15                                                         
*                                                                               
* CHECK FOR SITUATION WHEN A STATION CALL LETTER WAS                            
* USED IMMEDIATELY AFTER IT WAS MADE AVAILABLE                                  
*                                                                               
STALNK03 CLC   =CL4'WMMP',DBSELSTA                                              
         BNE   STALNK05                                                         
         CLC   DBSELBK,=AL2(OCT_14)                                             
         BNH   STALNK05                                                         
         MVC   DBSELSTA(4),=CL4'WCIV'                                           
         B     STALNK15                                                         
*                                                                               
STALNK05 CLC   =CL4'ECIV',DBSELSTA                                              
         BNE   STALNK10                                                         
         CLC   DBSELBK,=AL2(OCT_14)                                             
         BH    STALNK10                                                         
         MVC   DBSELSTA(4),=CL4'WCIV'                                           
         B     STALNK15                                                         
*                                                                               
STALNK10 CLI   DBVOPT,X'40'         CHECK IF POSTING CALL                       
         BE    STALNK11                                                         
         CLC   =CL4'WCIV',DBSELSTA                                              
         BNE   STALNK11                                                         
         CLC   DBSELBK,=AL2(OCT_14)                                             
         BH    STALNK20                                                         
         MVC   DBSELSTA(4),=CL4'WMMP'                                           
         B     STALNK15                                                         
*                                                                               
STALNK11 CLC   =CL4'OVMY',DBSELSTA                                              
         BNE   STALNK12                                                         
         CLC   DBSELBK,=AL2(JAN_15)                                             
         BNH   STALNK12                                                         
         MVC   DBSELSTA(4),=CL4'NVMY'                                           
         B     STALNK15                                                         
*                                                                               
STALNK12 CLI   DBVOPT,X'40'         CHECK IF POSTING CALL                       
         BE    STALNK13                                                         
         CLC   =CL4'KVMY',DBSELSTA                                              
         BNE   STALNK13                                                         
         CLC   DBSELBK,=AL2(JAN_15)                                             
         BH    STALNK13                                                         
         MVC   DBSELSTA(4),=CL4'NVMY'                                           
         B     STALNK15                                                         
*                                                                               
STALNK13 CLI   DBVOPT,X'40'         CHECK IF POSTING CALL                       
         BE    STALNK20                                                         
         CLC   =CL4'NVMY',DBSELSTA                                              
         BNE   STALNK20                                                         
         CLC   DBSELBK,=AL2(JAN_15)                                             
         BH    STALNK20                                                         
         MVC   DBSELSTA(4),=CL4'OVMY'                                           
*                                                                               
STALNK15 MVI   STALFLAG,C'N'                                                    
         B     STALINKX                                                         
*                                                                               
STALNK20 CLI   DMCB,X'01'                                                       
         BE    STALNKA0                                                         
                                                                                
         MVI   STALFLAG,C'N'                                                    
                                                                                
         L     RF,DBCOMFCS                                                      
         ICM   RF,15,CDEMTABS-COMFACSD(RF)                                      
         GOTO1 (RF),DMCB,CALL_LNK                                               
         ICM   RE,15,0(R1)                                                      
         JZ    *+2                                                              
         L     R0,4(R1)            R0 HAS LENGTH OF TABLE ENTRY                 
         USING CALLLNKD,RE                                                      
STALNK30 CLI   0(RE),X'FF'         EOT                                          
         BE    STALINKX                                                         
*                                                                               
STALNK40 CLC   CALLSTAT,DBSELSTA                                                
         BE    STALNK42                                                         
         AR    RE,R0                                                            
         B     STALNK30                                                         
*  A LATEST BOOK LOOKUP?                                                        
STALNK42 MVI   STALFLAG,C'Y'                                                    
         OC    DBSELBK,DBSELBK                                                  
         BZ    STALNK64                                                         
*                                                                               
* FOR OVERNIGHTS/WEEKLY  LOOKUPS                                                
* LETS ALWAYS GO TO THE LATEST STATION CALL LETTER.  THE CODE WILL              
* GO TO THE PREVIOUS LINK IN TABLE IF STATION IS NOT FOUND                      
* ITS TOO COMPLICATED GIVEN THAT CALL LETTER CHANGES FOR OVERNIGHTS             
* HAPPENS IN THE MIDDLE OF A WEEK AT TIMES- (CROSSING DIRECTORY MAJOR           
* KEYS).  IT WOULD BE DIFFICULT TO HANDLE SPOT OUT OF WEEK ROTATORS             
* ,LATEST LOOKUPS AND OVERNIGHT ROLLING AVERAGES.                               
*                                                                               
*                                                                               
STALNK50 CLI   DBSELMED,C'W'                                                    
         BE    STALNK64                                                         
         CLI   DBSELMED,C'O'                                                    
         BE    STALNK64                                                         
*                                                                               
STALNK56 CLC   DBSELBK,CALLSTBK                                                 
         BL    STALNK52                                                         
         CLC   DBSELBK,CALLEBK                                                  
         BH    STALNK54                                                         
         MVC   DBACTSTA,CALLSTAT  FOUND STATION LINK, MOVE IN STATION           
         MVI   DBACTSTA+4,C'T'                                                  
         B     STALINKX                                                         
* DBSELBK IS EARLIER THAN THIS TABLE ENTRY'S BOOK RANGE. MOVE BACKWARDS         
STALNK52 SR    RE,R0                                                            
         B     STALNK50                                                         
* DBSELBK IS LATER THAN THIS TABLE ENTRY'S BOOK RANGE.  MOVE BACKWARDS          
STALNK54 AR    RE,R0                                                            
         B     STALNK50                                                         
*                                                                               
*  LOOK FOR LATEST CALL LETTER CHANGE ENTRY                                     
STALNK64 CLI   0(RE),X'FF'        SOMETHING IS REALLY WRONG IF                  
         JE    *+2                FFFF ENTRY NOT FOUND IN TABLE                 
         CLC   CALLEBK,=X'FFFF'                                                 
         BE    STALNK80                                                         
         AR    RE,R0                                                            
         B     STALNK64                                                         
STALNK80 MVC   DBACTSTA,CALLSTAT  DBACTSTA=LATEST CALL LETTER                   
         MVI   DBACTSTA+4,C'T'                                                  
         ST    RE,ASTALINK        SAVE ADDRESS OF LAST ENTRY                    
         ST    R0,LSTALINK        L' STALINK TABLE ENTRY                        
         LR    RF,RE              RF= LATEST ENTRY IN TABLE                     
         CLI   DBSELMED,C'O'                                                    
         BE    STALNK90                                                         
         CLI   DBSELMED,C'W'                                                    
         BE    STALNK90                                                         
                                                                                
*                                                                               
         SR    RE,R0              NEXT TO LATEST ENTRY IN TABLE                 
                                                                                
STALNK90 MVC   DBSELSTA,CALLSTAT  DBSELSTA=NEXT  LATEST CALL LETTER             
         MVI   DBSELSTA+4,C'T'                                                  
         B     STALINKX                                                         
                                                                                
*  BUMP TO PREVIOUS TABLE ENTRY                                                 
STALNKA0 L     RE,DMCB                                                          
         MVC   INBOOK(2),0(RE)                                                  
         L     RF,DMCB+4           STATION OUTPUT AREA                          
         L     RE,ASTALINK                                                      
         USING CALLLNKD,RE                                                      
         XC    DMCB+8(2),DMCB+8                                                 
STALNKB0 CLC   CALLSTBK,=AL2(FROM_BEGINNING)                                    
         BE    STALNKF0                                                         
         L     R0,LSTALINK                                                      
         SR    RE,R0                                                            
         ST    RE,ASTALINK                                                      
         MVC   0(4,RF),CALLSTAT                                                 
         MVI   4(RF),C'T'                                                       
         OC    INBOOK,INBOOK       IF LATEST LOOKUP FAILED JUST BUMP            
         BZ    STALINKX            BACK ONE ENTRY AND RETRY                     
                                                                                
         XC    INBOOK,=X'FFFF'                                                  
         CLI   DBSELMED,C'O'                                                    
         BNE   STALNKD0                                                         
         CLC   INBOOK,CALLOSBK     NO NEED TO READ ANY FURTHER BACK             
         BL    STALNKE0                                                         
         CLC   INBOOK,CALLOEBK                                                  
         BH    STALNKE0                                                         
         XC    INBOOK,=X'FFFF'                                                  
         B     STALINKX                                                         
STALNKD0 CLI   DBSELMED,C'W'                                                    
         BNE   STALNKF0                                                         
         CLC   INBOOK,CALLWSBK     NO NEED TO READ ANY FURTHER BACK             
         BL    STALNKE0                                                         
         CLC   INBOOK,CALLWEBK                                                  
         BH    STALNKE0                                                         
         XC    INBOOK,=X'FFFF'                                                  
         B     STALINKX                                                         
STALNKE0 XC    INBOOK,=X'FFFF'      KEEP BUMPING BACKWARDS                      
         B     STALNKB0                                                         
*                                                                               
STALNKF0 MVC   DMCB+8(2),=X'FFFF'  INDICATE NO MORE TABLE ENTRIES               
*                                                                               
STALINKX XIT1  ,                                                                
*INBOOK   DS    XL(L'DBSELBK)                                                   
         DROP  RE,RB                                                            
         LTORG                                                                  
**********                                                                      
CHKRNMKT NTR1  BASE=*,LABEL=*                                                   
         USING DEGETD,RC           RC=A(W/S)                                    
         USING COMFACSD,R8         R8=A(COMFACS)                                
         USING DBLOCKD,R6          R6=A(DBLOCK)                                 
         GOTO1 CDEMTABS,DMCB,RAD_NMKT     RADIO ETHNIC NUMERIC MKT TAB          
         ICM   RE,15,0(R1)         A(TABLE) RETURNED IN P1                      
         JZ    *+2                 BAD TABLEID PASSED                           
         L     R0,4(R1)            L'TABLE ENTRY RETURNED IN P2                 
         USING RADNMKTD,RE                                                      
CHKRMK1  CLI   0(RE),X'FF'         SCAN FOR THE MARKET                          
         BE    CHKRMKTX                                                         
         CLC   DBSELMK,RADSNDMK    MATCH ON STANDARD MKT NUMBER                 
         BE    CHKRMK2                                                          
         AR    RE,R0                                                            
         B     CHKRMK1                                                          
CHKRMK2  CLC   DBBTYPE,RADBKTYP    MATCH ON BOOKTYPE                            
         BE    CHKRMK3                                                          
         CLI   DBBTYPE,C'I'        IF PPM BOOKTYPE CHECK AGAINST                
         BNE   *+12                NON PPM ETHNIC BOOKTYPE IN TABLE             
         CLI   RADBKTYP,C'H'       BECAUSE I DIDNT WANT TO DUPLICATE            
         BE    CHKRMK3             PPM BOOKTYPE ENTTRIES IN TABLE               
         CLI   DBBTYPE,C'E'        IF PPM BOOKTYPE CHECK AGAINST                
         BNE   *+12                NON PPM ETHNIC BOOKTYPEIN TABLE              
         CLI   RADBKTYP,C'B'                                                    
         BE    CHKRMK3                                                          
         AR    RE,R0                                                            
         B     CHKRMK1                                                          
CHKRMK3  MVC   DBSELMK,RADETHMK    SET CORRECT ETHNIC MKT NUMBER                
         MVC   DBACTKMK,RADETHMK    SET CORRECT ETHNIC MKT NUMBER               
         DROP  RE,RB                                                            
CHKRMKTX XIT1  ,                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*==================== TEST CONDENSED RADIO MARKET ====================*         
                                                                                
* This routine tests if DEMAND is to process requested market as a              
*  condensed radio market or not.  The criteria are:                            
*  > File = TP                                                                  
*  > Media = Radio                                                              
*  > DBBEST = C'P'                                                              
*  > MARTYPE = C'C' in MARELEM element                                          
* The return codes are:                                                         
*  CC equal     - process as a condensed radio market                           
*  CC not equal - don't process as condensed radio market                       
                                                                                
TSTRCNDS NTR1  BASE=*,LABEL=*                                                   
         CLC   DBFILE,=C'TP '      CHECK FOR TP                                 
         BNE   TRCNO                                                            
         CLI   DBSELMED,C'R'       CHECK FOR RADIO                              
         BNE   TRCNO                                                            
*                                                                               
*        CLC   DBSELAGY,=C'G7'                                                  
*        BE    TRCNO                                                            
*        CLC   DBSELAGY,=C'FM'                                                  
*        BE    TRCNO                                                            
*        CLC   DBSELAGY,=C'SJ'                                                  
*        BE    TRCNO                                                            
         B     TRCNO               DISABLE CONDENSED MARKETS                    
*                                                                               
         CLI   DBSELSRC,C'A'       CHECK FOR ARBITRON                           
         BE    *+12                                                             
         CLI   DBSELSRC,C'T'        OR TRITON                                   
         BNE   TRCNO                                                            
         CLI   DBBEST,C'P'         CHECK FOR POSTING                            
         BNE   TRCNO                                                            
                                                                                
         LA    R2,DBKEY            BUILD KEY OF DEMO RECORD                     
         USING DRKEY,R2            R2=A(KEY)                                    
         XC    DRKMAJOR,DRKMAJOR                                                
         MVC   DRCODE,RECCODE                                                   
         MVC   DRMEDIA,DBINTMED                                                 
         MVC   DRSRC,DBACTSRC                                                   
         MVC   DRSTAT,DBACTSTA                                                  
         MVC   DRBOOK,SAVEBOOK                                                  
         MVC   DRKMKT,DBACTKMK                                                  
                                                                                
         MVI   IOFLAG,DEM+DIR+HIGH                                              
         GOTO1 AIO,IOFLAG                                                       
         BNE   TRCNO                                                            
         CLC   DRKEY(DRSTYP-DRKEY),KEYSAVE                                      
         BNE   TRCNO                                                            
                                                                                
         XC    DBMINKEY,DBMINKEY                                                
         MVI   IOFLAG,DEM+FILE+HIGH                                             
         GOTO1 AIO,IOFLAG                                                       
         BNE   TRCNO                                                            
         DROP  R2                                                               
                                                                                
         L     R2,DBAREC                                                        
         AH    R2,DBDTADSP                                                      
         USING MARELEM,R2                                                       
         CLI   MARCODE,MARCODEQ                                                 
         BNE   TRCNO                                                            
         CLI   MARTYPE,C'C'        CONDENSED MARKET?                            
         BE    TRCYES                                                           
         DROP  R2                   YEP!                                        
         SPACE 2                                                                
TRCNO    CHI   RB,0                                                             
         JNE   GETXX                                                            
TRCYES   CR    RB,RB                                                            
         JE    GETXX                                                            
         DROP  RB                                                               
         EJECT                                                                  
********************************************************************            
* BBMMTR: MOSTLY USED TO DECIDE WHETHER TO LOOK UP WEEKLY BBM FILES*            
* IF IT'S BBM WEEKLY A BOOKTYPE OF w NEEDS TO BE PLUGGED IN.                    
* ***NEW-PPM***                                                                 
* FOLLOWING CODE NEEDS TO BE CHANGED FOR NEW BBM/PPM MARKETS                    
********************************************************************            
BBMMTR   NTR1  BASE=*,LABEL=*                                                   
         USING DBLOCKD,R6                                                       
         MVC   SVBBMBK,DBSELBK                                                  
         CLI   DBBEST,C'M'         DO MONTHLY FROM WEEKLY FILES                 
         BE    BMTR10                                                           
         OC    DBSELBK,DBSELBK                                                  
         BZ    *+14                                                             
         CLC   DBSELBK,=AL2(JAN_08) WE ONLY CARRY BBM METERED 2008+             
         JL    *+12                                                             
         MVI   DBBTYPE,C'W'                                                     
         MVI   SVBTYPE,C'W'                                                     
         J     BMTRX               FINAL EXIT                                   
*                                                                               
BMTR10   CLI   DBBTYPE,C'W'        IF WEEKLY REQUESTED LEAVE ALONE              
         JE    BMTRX                                                            
         OC    DBSELALF,DBSELALF   IF DBSELALF IS NOT NULLS                     
         BZ    BMTR30                                                           
         CLC   DBSELALF,=3C' '     AND IT'S NOT BLANKS,                         
         BE    BMTR30                                                           
         MVC   DUB(3),DBSELALF     THEN USE IT                                  
***      BAS   RE,TRAMKT           TRANSLATE ALPHAMKT TO NUMERIC MKT            
         BRAS  RE,TRAMKT           TRANSLATE ALPHAMKT TO NUMERIC MKT            
         MVC   DBSELMK,DUB+3       DUB+3(2) = NUMERIC MARKET                    
         CLI   DBSELSRC,C'A'       CHECK FOR BBM                                
         JNE   BBMOVRX                                                          
                                                                                
         LA    RE,BBMMTRL          LIST OF BBM METERED MARKETS                  
BMTR20   CLI   0(RE),X'FF'                                                      
         JE    BMTRX               ONLY DO THIS FOR METERED MKTS                
         CLC   DBSELALF,0(RE)                                                   
         JNE   *+14                                                             
         CLC   DBSELBK,5(RE)                                                    
         JNL   *+12                                                             
         LA    RE,L'BBMMTRL(RE)                                                 
         J     BMTR20                                                           
BMTR25   MVI   DBBTYPE,C'W'        WEEKLIES ARE UNDER BOOK TYPE W               
         MVI   SVBTYPE,C'W'                                                     
         J     BMTRX                                                            
***********************************************************************         
* WE ONLY GET TO BMTR30 WHEN ALPHA SPILL IS BLANK                               
***********************************************************************         
BMTR30   DS    0H                  SPILL ALPHA MKT IS BLANK                     
         OC    DBSELBK,DBSELBK                                                  
         BZ    BMTR40                                                           
         CLC   DBSELBK,=AL2(JAN_08)                                             
         BL    PRE2008                                                          
*                                                                               
BMTR40   GOTO1 CDEMTABS,DMCB,HOMESTA  CHECK METERED HOME STATIONS               
         ICM   R3,15,0(R1)                                                      
         JZ    *+2                                                              
         L     R0,4(R1)                                                         
         USING HOMESTAD,R3                                                      
*                                                                               
BMTR45   CLI   0(R3),X'FF'                                                      
         BE    BMTRX                                                            
         LA    RE,BBMMTRL                                                       
BMTR50   CLC   HOMEMKT,3(RE)       ONE OF THE METERED MKTS?                     
         BNE   BMTR55                                                           
         CLC   DBSELBK,=X'0000'    LATEST?                                      
         BE    BMTR52                                                           
         CLC   DBSELBK,5(RE)       SOME METERED MKTS HAVE START DATE            
         BL    BMTR60                                                           
         CLC   HOMEBK,=X'0000'                                                  
         BE    *+14                                                             
         CLC   HOMEBK,DBSELBK      SOME HOME STATIONS HAVE START DATE           
         BH    BMTR60                                                           
BMTR52   CLC   HOMECALL(4),DBSELSTA                                             
         BE    BMTR70                                                           
         B     BMTR60                                                           
BMTR55   LA    RE,L'BBMMTRL(RE)                                                 
         CLI   0(RE),X'FF'                                                      
         BNE   BMTR50                                                           
BMTR60   AR    R3,R0                                                            
         B     BMTR45                                                           
*                                                                               
BMTR70   MVI   DBBTYPE,C'W'        WEEKLIES ARE UNDER BOOK TYPE W               
         MVI   SVBTYPE,C'W'                                                     
         J     BMTRX                                                            
*                                                                               
***********************************************************************         
* WE ONLY GET TO THIS SECTION IF BOOK IS BEFORE JAN/2008                        
* FOR NEW PPM MARKETS, WE DON'T NEED TO CONCERN OURSELVES WITH THIS             
* CHUNK OF CODE.                                                                
***********************************************************************         
PRE2008  OC    DBSELMK,DBSELMK                                                  
         BNZ   BBMTORA1                                                         
         CLI   DBSELALF,0                                                       
         BNE   BBMTORA1                                                         
         CLC   DBSELSTA(4),=C'CBLT'   TORONTO HOME                              
         BE    USEBBMTH                                                         
         CLC   DBSELSTA(4),=C'CKXT'   TORONTO HOME                              
         BE    USEBBMTH                                                         
         CLC   DBSELSTA(4),=C'CFMT'   TORONTO HOME                              
         BE    USEBBMTH                                                         
         CLC   DBSELSTA(4),=C'CFTO'   TORONTO HOME                              
         BE    USEBBMTH                                                         
         CLC   DBSELSTA(4),=C'CHCH'   TORONTO HOME                              
         BE    USEBBMTH                                                         
         CLC   DBSELSTA(4),=C'CITY'   TORONTO HOME                              
         BE    USEBBMTH                                                         
         CLC   DBSELSTA(4),=C'CTS '   TORONTO HOME                              
         BE    USEBBMTH                                                         
         CLC   DBSELSTA(4),=C'CHTV'   TORONTO HOME                              
         BE    USEBBMTH                                                         
         CLC   DBSELSTA(4),=C'CITN'   TORONTO HOME                              
         BE    USEBBMTH                                                         
*                                                                               
BBMTORA1 CLC   DBSELMK,=H'440'        CSI TORONTO                               
         JE    *+10                                                             
         CLC   DBSELMK,=H'5199'       BBM TORONTO                               
         JE    *+10                                                             
         CLC   DBSELALF,=C'TOR'                                                 
         JNE   ALF1                                                             
*                                                                               
USEBBMTH OC    DBSELBK,DBSELBK        MAKE SURE WE HAVE DATA                    
         JZ    *+14                                                             
         CLC   DBSELBK,=AL2(JAN_03)   MAKE SURE WE HAVE DATA                    
         BL    USECSITO                                                         
*                                                                               
         CLI   DBSELSRC,C'A'       IF SOURCE=BBM (FOR HOME STATIONS)            
         JE    USEBBMTO             USE BBM                                     
         J     USECSITO            OTHERWISE USE CSI                            
*                                                                               
         CLC   DBSELAGY,=C'HD'        HD GETS BBM TORONTO DATA                  
         BE    *+10                                                             
         CLC   DBSELAGY,=C'OU'        OU GETS BBM TORONTO DATA                  
         BE    *+10                                                             
         CLC   DBSELAGY,=C'FG'        LETO GETS BBM TORONTO DATA                
         BNE   USECSITO                                                         
         CLI   DBUSEBBM,C'Y'          USE BBM TORONTO                           
         BE    USEBBMTO                                                         
*                                                                               
USECSITO MVC   DBSELMK,=H'440'                                                  
         MVC   DBACTKMK,=H'440'                                                 
         BAS   RE,GETCWLAT            LATEST BOOK                               
         MVC   SVBBMBK,DBSELBK                                                  
*                                                                               
         CLC   DBSELSTA(4),=C'CIII'   TORONTO SPILL                             
         BE    ALF2                                                             
         CLC   DBSELSTA(4),=C'WTBS'   TORONTO SPILL                             
         BE    ALF2                                                             
         CLC   DBSELSTA(4),=C'TLC '   TORONTO SPILL                             
         BE    ALF2                                                             
         CLC   DBSELSTA(4),=C'TSN '   TORONTO SPILL                             
         BE    ALF2                                                             
         CLC   DBSELSTA(4),=C'YTV '   TORONTO SPILL                             
         BE    ALF2                                                             
         CLC   DBSELSTA(4),=C'AEN '   TORONTO SPILL                             
         BE    ALF2                                                             
*                                                                               
         CLC   DBSELSTA(4),=C'CJMT'   TORONTO SPl (BBM=CJMT)                    
         BNE   *+10                    UNTIL SPOT PASSES TRUE RATING            
         MVC   DBSELSTA(4),=C'OMN2'    SERVICE EQUIVALENCE                      
*                                                                               
         CLC   DBSELSTA(4),=C'OMN2'   TORONTO SPILL                             
         BE    ALF2                                                             
         XC    DBSELMK,DBSELMK        TORONTO HOME BOGHT AS SPILL               
         XC    DBACTKMK,DBACTKMK                                                
         XC    DBSELALF,DBSELALF                                                
         J     ALF2                                                             
USEBBMTO DS    0C                                                               
*                                                                               
         BAS   RE,GETCWLAT            LATEST BOOK                               
         MVC   SVBBMBK,DBSELBK                                                  
*                                                                               
         MVC   DBSELMK,=H'5199'                                                 
         MVC   DBACTKMK,=H'5199'                                                
         MVI   DBSELSRC,C'A'                                                    
         MVI   DBACTSRC,C'A'                                                    
         MVI   DBBTYPE,C'W'                                                     
         MVI   DBBEST,C'M'                                                      
         CLC   DBSELSTA(4),=C'CBLT'   TORONTO HOME                              
         BE    USEBBMTO2                                                        
         CLC   DBSELSTA(4),=C'CKXT'   TORONTO HOME                              
         BE    USEBBMTO2                                                        
         CLC   DBSELSTA(4),=C'CFMT'   TORONTO HOME                              
         BE    USEBBMTO2                                                        
         CLC   DBSELSTA(4),=C'CFTO'   TORONTO HOME                              
         BE    USEBBMTO2                                                        
         CLC   DBSELSTA(4),=C'CHCH'   TORONTO HOME                              
         BE    USEBBMTO2                                                        
         CLC   DBSELSTA(4),=C'CITY'   TORONTO HOME                              
         BE    USEBBMTO2                                                        
         CLC   DBSELSTA(4),=C'CTS '   TORONTO HOME                              
         BE    USEBBMTO2                                                        
         CLC   DBSELSTA(4),=C'CHTV'   TORONTO HOME                              
         BE    USEBBMTO2                                                        
         CLC   DBSELSTA(4),=C'CITN'   TORONTO HOME                              
         BE    USEBBMTO2                                                        
         J     BBMOVRX                                                          
USEBBMTO2 DS   0C                                                               
         BAS   RE,GETCWLAT            LATEST BOOK                               
         MVC   SVBBMBK,DBSELBK                                                  
         XC    DBSELMK,DBSELMK                                                  
         XC    DBACTKMK,DBACTKMK                                                
         XC    DBSELALF,DBSELALF                                                
         J     BBMOVRX                                                          
*                                                                               
ALF1     CLC   DBSELALF,=C'VAN'                                                 
         JNE   ALF3                                                             
*                                                                               
         CLI   DBSELSRC,C'N'                                                    
         BE    ALF1A                                                            
*                                                                               
         CLI   DBUSEBBM,C'Y'       ITS VANCOUVER - USE CSI OR BBM               
         JNE   ALF1A                                                            
         MVI   DBBTYPE,C'W'                                                     
         MVI   DBSELSRC,C'A'                                                    
         MVI   DBACTSRC,C'A'                                                    
         J     ALF2A                                                            
*                                                                               
ALF1A    MVC   DBSELMK,=H'490'                                                  
         MVC   DBACTKMK,=H'490'                                                 
ALF2     MVI   DBSELSRC,C'N'                                                    
         MVI   DBACTSRC,C'N'                                                    
ALF2A    BAS   RE,GETCWLAT            LATEST BOOK                               
         MVC   SVBBMBK,DBSELBK                                                  
         J     BBMOVRX                                                          
*                                                                               
ALF3     DS    0H                                                               
         CLI   DBSELSRC,C'A'       DO BBM FOR THIS                              
         BE    ALF3B                                                            
         B     ALF3ANH             ELSE NSI                                     
*                                                                               
         CLC   DBSELAGY,=C'OU'     THESE DON'T GET CSI                          
         JE    ALF3B                                                            
         CLC   DBSELAGY,=C'MI'                                                  
         JE    ALF3B                                                            
         CLC   DBSELAGY,=C'CY'                                                  
         JE    ALF3B                                                            
         CLC   DBSELAGY,=C'DN'                                                  
         JE    ALF3B                                                            
         CLC   DBSELAGY,=C'GI'                                                  
         JE    ALF3B                                                            
         CLC   DBSELAGY,=C'PY'                                                  
         JE    ALF3B                                                            
         CLC   DBSELAGY,=C'S4'                                                  
         JE    ALF3B                                                            
ALF3ANH  CLC   DBSELALF,=C'CAL'                                                 
         JNE   ALF4                                                             
ALF3A    BAS   RE,GETCWLAT            LATEST BOOK                               
         CLC   DBSELBK,=AL2(SEP_01) WEEKLY DATA N/A BEFORE HERE                 
         JL    BBMOVRX                                                          
         MVC   SVBBMBK,DBSELBK                                                  
         MVI   DBSELSRC,C'N'                                                    
         MVI   DBACTSRC,C'N'                                                    
         XC    DBSELMK,DBSELMK                                                  
         XC    DBACTKMK,DBACTKMK                                                
         XC    DBSELALF,DBSELALF                                                
         CLC   DBSELSTA(4),=C'CICT'                                             
         JE    *+10                                                             
         CLC   DBSELSTA(4),=C'CIII'                                             
         JE    *+10                                                             
         CLC   DBSELSTA(4),=C'ACCS'                                             
         JE    *+10                                                             
         CLC   DBSELSTA(4),=C'TLC '                                             
         JE    *+10                                                             
         CLC   DBSELSTA(4),=C'TSN '                                             
         JE    *+10                                                             
         CLC   DBSELSTA(4),=C'WTBS'                                             
         JE    *+10                                                             
         CLC   DBSELSTA(4),=C'YTV '                                             
         JNE   BBMOVRX                                                          
         MVC   DBSELMK,=H'484'                                                  
         MVC   DBACTKMK,=H'484'                                                 
         J     BBMOVRX                                                          
ALF3B    CLC   DBSELALF,=C'CAL'          ZAP FOR BBM HOMES                      
         JNE   ALFX                                                             
         CLC   DBSELSTA(4),=C'CBRT'                                             
         JE    ALF3C                                                            
         CLC   DBSELSTA(4),=C'CFCN'                                             
         JE    ALF3C                                                            
         CLC   DBSELSTA(4),=C'CICT'                                             
         JE    ALF3C                                                            
         CLC   DBSELSTA(4),=C'CKAL'                                             
         JE    ALF3C                                                            
         J     ALFX                                                             
ALF3C    XC    DBSELALF,DBSELALF                                                
         XC    DBSELMK,DBSELMK                                                  
         XC    DBACTKMK,DBACTKMK                                                
         J     ALFX                                                             
*                                                                               
ALF4     CLC   DBSELMK,=H'415'        CSI MOF                                   
         JE    *+10                                                             
         CLC   DBSELMK,=H'4481'       BBM MOF                                   
         JE    *+10                                                             
         CLC   DBSELALF,=C'MOF'                                                 
         JNE   ALFX                                                             
*                                                                               
ALF4A    BAS   RE,GETCWLAT            LATEST BOOK                               
         MVC   SVBBMBK,DBSELBK                                                  
*                                                                               
         CLI   DBSELSRC,C'N'                                                    
         BE    ALF4B                                                            
*                                                                               
         CLC   DBSELBK,=AL2(SEP_04)   USE BBM CHECKING                          
         BL    *+12                                                             
         CLI   DBUSEBBM,C'Y'                                                    
         BE    ALF5                                                             
*                                                                               
ALF4B    CLC   DBSELBK,=AL2(OCT_01) WEEKLY DATA N/A BEFORE HERE                 
         JL    BBMOVRX                                                          
         MVC   DBSELMK,=H'415'                                                  
         MVC   DBACTKMK,=H'415'                                                 
         MVI   DBSELSRC,C'N'                                                    
         MVI   DBACTSRC,C'N'                                                    
         J     BBMOVRX                                                          
ALF5     DS    0C                                                               
         CLC   DBSELMK,=H'415'                                                  
         BNE   *+16                                                             
         MVC   DBSELMK,=H'4481'                                                 
         MVC   DBACTKMK,=H'4481'                                                
*                                                                               
         MVI   DBBTYPE,C'W'                                                     
         MVI   DBSELSRC,C'A'                                                    
         MVI   DBACTSRC,C'A'                                                    
         J     BBMOVRX                                                          
ALFX     DS    0C                                                               
*                                                                               
BBMALF   CLC   DBSELMK,=H'9109'    VANCOUVER                                    
         JE    *+10                                                             
         CLC   DBSELMK,=H'8069'    CALGARY                                      
         JE    *+10                                                             
         CLC   DBSELMK,=H'4481'    MONTREAL FRENCH                              
         JE    *+10                                                             
         CLC   DBSELMK,=H'5199'    TORONTO                                      
         JE    *+14                                                             
         OC    DBSELMK,DBSELMK                                                  
         JNZ   BBMOVRX                                                          
         CLI   DBSELSRC,C'N'                                                    
         JE    BBMOVRX                                                          
         OC    DBSELBK,DBSELBK                                                  
         JZ    *+12                                                             
         CLI   DBSELBK,YR_1997     WEEKLY DATA AVAILABLE                        
         JL    BBMTORX                                                          
         CLC   DBSELSTA+1(3),=C'TOR'  GLOBAL ETC.                               
         JE    BBMTOR2                                                          
*                                                                               
         CLC   DBSELMK,=H'5199'    IF TORONTO SPILL ALLOW THESE                 
         JNE   BBMTORH                                                          
         CLC   DBSELSTA(4),=C'CKCO'   BECAUSE THEY ALSO HAVE A BBM HOME         
         JE    BBMTOR2                IN A DIFFERENT MARKET                     
         CLC   DBSELSTA(4),=C'CKVR'                                             
         JE    BBMTOR2                                                          
*                                                                               
BBMTORH  LA    RE,BBMTORL          AND TORONTO STATION                          
BBMTOR1  CLI   0(RE),X'FF'                                                      
         JE    BBMTORX                                                          
         CLC   DBSELSTA(4),0(RE)                                                
         JE    BBMTOR2                                                          
         LA    RE,4(RE)                                                         
         J     BBMTOR1                                                          
BBMTOR2  MVI   DBBEST,C'M'         FORCE TO MONTHLY                             
         MVI   DBSELSRC,C'N'        CSI                                         
         MVI   DBACTSRC,C'N'        CSI                                         
         BAS   RE,GETCWLAT            LATEST BOOK                               
         MVC   SVBBMBK,DBSELBK                                                  
         CLC   DBSELSTA(4),=C'OMN2'                                             
         BE    *+10                                                             
         XC    DBSELMK,DBSELMK                                                  
         CLC   DBSELALF,=C'TOR'                                                 
         JE    *+10                                                             
         CLC   DBSELSTA(4),=C'TSN ' CABLE ALWAYS NEEDS MARKET'                  
         JNE   BBMTORX                                                          
BBMTORX  DS    0C                                                               
         OC    DBSELBK,DBSELBK                                                  
         JZ    *+12                                                             
         CLI   DBSELBK,YR_1998     WEEKLY DATA AVAILABLE                        
         JL    BBMOVRX                                                          
         CLC   DBSELSTA+1(3),=C'VAN'  GLOBAL ETC.                               
         BE    BBMOVRA                                                          
         CLC   DBSELSTA+1(3),=C'XVA'  SPECIALTY NET                             
         JE    BBMOVRA                                                          
         LA    RE,BBMVANL          AND VANCOUVER                                
BBMVAN1  CLI   0(RE),X'FF'                                                      
         JE    BBMVANX                                                          
         CLC   DBSELSTA(4),=C'JXVA'                                             
         JNE   *+10                                                             
         MVC   DBSELSTA(4),=C'SPNP'                                             
         CLC   DBSELSTA(4),0(RE)                                                
         JE    BBMOVRA                                                          
         LA    RE,4(RE)                                                         
         J     BBMVAN1                                                          
BBMOVRA  MVI   DBBEST,C'M'         FORCE TO MONTHLY                             
         MVI   DBSELSRC,C'N'        CSI                                         
         MVI   DBACTSRC,C'N'        CSI                                         
         XC    DBSELMK,DBSELMK                                                  
         BAS   RE,GETCWLAT            LATEST BOOK                               
         MVC   SVBBMBK,DBSELBK                                                  
*                                                                               
         CLI   DBUSEBBM,C'Y'       ITS VANCOUVER - USE CSI OR BBM               
         JNE   BBMOVRX                                                          
         OC    DBSELBK,DBSELBK                                                  
         JZ    *+12                                                             
         CLI   DBSELBK,YR_1999     BBM STARTS IN 99                             
         JL    BBMOVRX                                                          
         MVI   DBSELSRC,C'A'                                                    
         MVI   DBACTSRC,C'A'                                                    
         MVI   DBBTYPE,C'W'                                                     
         B     BBMOVRX                                                          
BBMOVRN  MVC   DBSELMK,=H'490'                                                  
         MVC   DBACTKMK,=H'490'                                                 
         B     BBMOVRX                                                          
*                                                                               
BBMVANX  DS    0C                                                               
         OC    DBSELBK,DBSELBK                                                  
         JZ    *+14                                                             
         CLC   DBSELBK,=AL2(SEP_01) WEEKLY DATA AVAILABLE                       
         JL    BBMOVCX                                                          
         CLC   DBSELAGY,=C'OU'     THESE DON'T GET CSI                          
         JE    BBMOVCX                                                          
         CLC   DBSELAGY,=C'CY'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'MI'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'DN'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'GI'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'PY'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'S4'                                                  
         JE    BBMOVRX                                                          
*                                                                               
         CLC   DBSELSTA+1(3),=C'CAL'  GLOBAL ETC.                               
         JE    ALF3A                                                            
*                                                                               
         CLI   DBSELSRC,C'A'                                                    
         BE    BBMOVCX                                                          
*                                                                               
         LA    RE,BBMCLGL          AND CALGARY                                  
         OC    DBSELMK,DBSELMK     CHECK NUMERIC MARKET AS WELL                 
         BZ    BBMCAL1                                                          
         CLC   DBSELMK,=H'8069'                                                 
         BNE   BBMOVCX                                                          
BBMCAL1  CLI   0(RE),X'FF'                                                      
         JE    BBMOVCX                                                          
         CLC   DBSELSTA(4),0(RE)                                                
         JE    ALF3A                                                            
         LA    RE,4(RE)                                                         
         B     BBMCAL1                                                          
*                                                                               
BBMOVCX  DS    0C                                                               
         BAS   RE,GETCWLAT            LATEST BOOK                               
         CLC   DBSELBK,=AL2(SEP_01) WEEKLY DATA AVAILABLE                       
         JL    BBMOVRX                                                          
         CLC   DBSELBK,=AL2(SEP_04) BBM MOF AVAIL AFTER SEP/04                  
         BL    *+14                                                             
         CLC   DBSELAGY,=C'OU'     THESE DON'T GET CSI                          
         JE    BBMMOF                                                           
         CLC   DBSELAGY,=C'OU'     THESE DON'T GET CSI                          
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'CY'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'MI'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'DN'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'DA'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'GI'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'PY'                                                  
         JE    BBMOVRX                                                          
         CLC   DBSELAGY,=C'S4'                                                  
         JE    BBMOVRX                                                          
BBMMOF   CLC   DBSELSTA+1(3),=C'MOF'  GLOBAL ETC.                               
         JE    ALF4A                                                            
         CLC   DBSELMK,=X'4481'                                                 
         JE    ALF4A                                                            
         LA    RE,BBMMOFL          AND MONTREAL FRANCO                          
BBMMOF1  CLI   0(RE),X'FF'                                                      
         JE    BBMMOF3                                                          
         CLC   DBSELSTA(4),0(RE)                                                
         JE    ALF4A                                                            
         LA    RE,4(RE)                                                         
         J     BBMMOF1                                                          
*                                                                               
BBMMOF3  LA    RE,BBMMOFLB         AND MONTREAL FRANCO                          
         CLC   DBSELAGY,=C'OU'     SELECTIVE STATIONS FOR BBM METER             
         B     BBMOVRX             *skipping this*** (sc feb 2008)              
*                                  cfcf and cbmt no longer spill in MOA         
         CLI   DBSELBK,0           DEAL WITH LATEST                             
         BE    BBMMOF4                                                          
         CLC   DBSELBK,=AL2(SEP_04) START WITH SEP/04                           
         BL    BBMOVRX                                                          
BBMMOF4  CLI   0(RE),X'FF'                                                      
         JE    BBMOVRX                                                          
         CLC   DBSELSTA(4),0(RE)                                                
         JE    ALF4A                                                            
         LA    RE,4(RE)                                                         
         J     BBMMOF4                                                          
*                                                                               
BBMOVRX  DS    0H                                                               
         LA    RF,RELBBM                                                        
         S     RF,RELBBM                                                        
         L     RE,=A(MMHOME)        CHECK IF IT'S A HOME STATION                
         AR    RE,RF                                                            
BBMOVRX1 CLI   0(RE),X'FF'                                                      
         BE    BMTRX                                                            
         CLC   4(2,RE),DBSELMK      MARKET AND STATION IN TABLE                 
         BNE   *+14                                                             
         CLC   0(4,RE),DBSELSTA                                                 
         BE    *+12                                                             
         LA    RE,L'MMHOME(RE)                                                  
         B     BBMOVRX1                                                         
*                                                                               
         XC    DBSELMK,DBSELMK      THEN ZAP THE MARKET                         
         XC    DBACTKMK,DBACTKMK                                                
         XC    DBSELALF,DBSELALF                                                
         MVC   SVBBMBK,DBSELBK                                                  
BMTRX    MVC   DBSELBK,SVBBMBK                                                  
         J     GETXX                                                            
*                                                                               
GETCWLAT OC    DBSELBK,DBSELBK        LATEST BOOK                               
         BNZ   *+16                                                             
         MVC   DBSELBK,CANWLAT                                                  
         MVC   SVSELBK,DBSELBK                                                  
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
RELBBM   DC    A(*)                                                             
*                                                                               
BBMTORL  DC    C'CBLT'                                                          
*        DC    C'CKXT'                                                          
         DC    C'CFTO'                                                          
         DC    C'CITY'                                                          
         DC    C'NITY'                                                          
         DC    C'CFMT'                                                          
         DC    C'OMN1' ALSO CFMT CSI CHANGE JAN27/03                            
         DC    C'OMN2'                                                          
         DC    C'NFMT'                                                          
*        DC    C'CKCO'                                                          
*        DC    C'CKVR'                                                          
         DC    C'WXTO'              WXTO AND CP24 ARE REALLY THE SAME           
         DC    C'CP24'                                                          
         DC    C'CTS '                                                          
         DC    C'GTOR'                                                          
         DC    C'GLBL'              OUT JAN/02                                  
         DC    C'ONTV'                                                          
         DC    C'OMNT'                                                          
         DC    C'CHCH'                                                          
         DC    C'CIII'              OUT JAN/02                                  
         DC    C'SPNP' JXTO                                                     
         DC    C'TSN '                                                          
         DC    C'WGRZ'                                                          
         DC    C'WIVB'                                                          
         DC    C'WKBW'                                                          
         DC    C'WNED'                                                          
         DC    C'WUTV'                                                          
         DC    C'NUTV'                                                          
         DC    X'FF'                                                            
BBMVANL  DC    C'CBUT'                                                          
         DC    C'CHAN'                                                          
         DC    C'CHEK'                                                          
         DC    C'CHNM'                                                          
         DC    C'CIVT'                                                          
         DC    C'CTVV' ALSO CIVT CSI CHANGE JAN27/03                            
         DC    C'CIVI'                                                          
*        DC    C'CKNO'                                                          
         DC    C'CKVU'                                                          
         DC    C'KCPQ'                                                          
         DC    C'KCTS'                                                          
         DC    C'KING'                                                          
         DC    C'KIRO'                                                          
         DC    C'KOMO'                                                          
         DC    C'KSTW'                                                          
         DC    C'KVOS'                                                          
         DC    C'NOW '                                                          
         DC    C'CHNU'             NOW ALIAS                                    
         DC    C'SPNP'             JXVA                                         
         DC    X'FF'                                                            
BBMMOFL  DC    C'ARTV'             MONTREAL FRENCH                              
         DC    C'CBFT'                                                          
         DC    C'CD  '                                                          
         DC    C'CFJP'                                                          
         DC    C'CFTM'                                                          
         DC    C'CIVM'                                                          
         DC    C'EVAS'                                                          
         DC    C'HSTA'                                                          
         DC    C'LCN '                                                          
         DC    C'MM  '                                                          
         DC    C'MMAX'                                                          
         DC    C'MP  '                                                          
         DC    C'RDI '                                                          
         DC    C'RDS '                                                          
         DC    C'SERI'                                                          
         DC    C'TOON'                                                          
         DC    C'TV5 '                                                          
         DC    C'VIE '                                                          
         DC    C'VOX '                                                          
         DC    C'Z   '                                                          
* AND DDS CALL LETTERS                                                          
         DC    C'LCD '                                                          
         DC    C'HISF'                                                          
         DC    C'METM'                                                          
         DC    C'MUSI'                                                          
         DC    C'PLUS'                                                          
         DC    C'TVC '                                                          
         DC    C'CANZ'                                                          
         DC    C'TELE'                                                          
         DC    X'FF'                                                            
* AND BBM CALL LETTERS                                                          
BBMMOFLB DC    C'CBMT'                                                          
         DC    C'CFCF'                                                          
         DC    X'FF'                                                            
BBMCLGL  DC    0C                                                               
*        DC    C'ACCS'                                                          
         DC    C'CBRT'                                                          
         DC    C'CFCN'                                                          
         DC    C'CTVC' WAS CFCN CSI CHANGE JAN27/03                             
         DC    C'CKAL'                                                          
         DC    C'GLBL'                                                          
         DC    C'CIII'                                                          
         DC    C'KAYU'                                                          
         DC    C'KHQ '                                                          
         DC    C'KREM'                                                          
         DC    C'KSPS'                                                          
         DC    C'KXLY'                                                          
         DC    C'SPNW'                                                          
         DC    C'TLC '                                                          
         DC    C'WTBS'                                                          
         DC    C'YTV '                                                          
* AND DDS CALL LETTERS                                                          
         DC    C'CICT'                                                          
         DC    X'FF'                                                            
         DS    0F                                                               
         EJECT                                                                  
                                                                                
BBMMTRL  DS    0XL7                LIST OF BBM METERED MARKETS                  
         DC    C'MOF',AL2(4481),X'0000'                                         
         DC    C'TOR',AL2(5199),X'0000'                                         
         DC    C'VAN',AL2(9109),X'0000'                                         
         DC    C'CAL',AL2(8069),X'0000'                                         
         DC    C'EDM',AL2(8119),AL2(MAY_11)                                     
         DC    C'MOA',AL2(4480),AL2(SEP_14)                                     
         DC    C'NWK',AL2(0002),X'0000'                                         
         DC    X'FF'                                                            
*                                                                               
MMHOME   DS    0CL6                                                             
         DC    C'CBRT',AL2(484)    CSI-CAL                                      
         DC    C'CKAL',AL2(484)    CSI-CAL                                      
         DC    C'CTVC',AL2(484)    CSI-CAL                                      
         DC    C'KAYU',AL2(484)    CSI-CAL                                      
         DC    C'KHQ ',AL2(484)    CSI-CAL                                      
         DC    C'KREM',AL2(484)    CSI-CAL                                      
         DC    C'KSPS',AL2(484)    CSI-CAL                                      
         DC    C'KXLY',AL2(484)    CSI-CAL                                      
         DC    C'CBC ',AL2(440)    CSI-TOR                                      
         DC    C'CBLT',AL2(440)    CSI-TOR                                      
         DC    C'CFTO',AL2(440)    CSI-TOR                                      
         DC    C'CHCH',AL2(440)    CSI-TOR                                      
         DC    C'CITY',AL2(440)    CSI-TOR                                      
         DC    C'CKCO',AL2(440)    CSI-TOR                                      
         DC    C'CKVR',AL2(440)    CSI-TOR                                      
         DC    C'CP24',AL2(440)    CSI-TOR                                      
         DC    C'CTS ',AL2(440)    CSI-TOR                                      
         DC    C'CTV ',AL2(440)    CSI-TOR                                      
         DC    C'DISC',AL2(440)    CSI-TOR                                      
         DC    C'OMN1',AL2(440)    CSI-TOR                                      
         DC    C'SPNO',AL2(440)    CSI-TOR                                      
         DC    C'TVO ',AL2(440)    CSI-TOR                                      
         DC    C'WGRZ',AL2(440)    CSI-TOR                                      
         DC    C'WIVB',AL2(440)    CSI-TOR                                      
         DC    C'WKBW',AL2(440)    CSI-TOR                                      
         DC    C'WNED',AL2(440)    CSI-TOR                                      
         DC    C'WUTV',AL2(440)    CSI-TOR                                      
         DC    C'CBUT',AL2(490)    CSI-VAN                                      
         DC    C'CHEK',AL2(490)    CSI-VAN                                      
         DC    C'CIVI',AL2(490)    CSI-VAN                                      
         DC    C'CIVT',AL2(490)    CSI-VAN                                      
         DC    C'CKNO',AL2(490)    CSI-VAN                                      
         DC    C'CTVV',AL2(490)    CSI-VAN                                      
         DC    C'KCPQ',AL2(490)    CSI-VAN                                      
         DC    C'KCTS',AL2(490)    CSI-VAN                                      
         DC    C'KING',AL2(490)    CSI-VAN                                      
         DC    C'KIRO',AL2(490)    CSI-VAN                                      
         DC    C'KOMO',AL2(490)    CSI-VAN                                      
         DC    C'KSTW',AL2(490)    CSI-VAN                                      
         DC    C'KVOS',AL2(490)    CSI-VAN                                      
         DC    C'MUL ',AL2(490)    CSI-VAN                                      
         DC    C'SPNP',AL2(490)    CSI-VAN                                      
         DC    X'FFFF'                                                          
         EJECT                                                                  
         DS    0H                                                               
       ++INCLUDE RARDAYPRT                                                      
         EJECT                                                                  
         DS    0H                                                               
       ++INCLUDE DERDAYPRT                                                      
         EJECT                                                                  
***********************************************************************         
*========================== GETTP'S EQUATES ==========================*         
                                                                                
QHTN0200 EQU   ((((0200+2400)-0600)/25)+0)   TV NSI 2A-215A QHR                 
QHTN0545 EQU   ((((0500+2400)-0600)/25)+3)   TV NSI 545A-6A QHR                 
***********************************************************************         
         EJECT                                                                  
         DS    0C                                                               
         SPACE 2                                                                
TPLWORK  DSECT                                                                  
TPDMCB   DS    6F                                                               
RELO3    DS    F                                                                
TPSAVE   DS    F                                                                
TPDBARS  DS    F                                                                
TPDBAQHS DS    F                                                                
TPAR1ST  DS    F                                                                
TPAQH1ST DS    F                                                                
TPATBLE  DS    A                   GENERIC START ADDR OF A TABLE                
TPATBLEX DS    A                   GENERIC END   ADDR OF A TABLE                
TPENTRYS DS    H                   GENERIC # OF ENTRIES COUNT                   
TPLSTDIR DS    XL(L'DBLSTDIR)                                                   
TPDBFILE DS    CL(L'DBFILE)                                                     
TPSELPRG DS    CL(L'DBSELPRG)                                                   
TPMINKEY DS    CL(L'DBMINKEY)                                                   
TPMNKYRD DS    CL(L'DBMINKEY)                                                   
TPL1Q    EQU   *-TPLSTDIR                                                       
TPMODE   DS    XL1                                                              
TPMEOFSQ EQU   X'80'                DID EOFSEQ RTN FOR CURR DQDTAB NTRY         
TPMROVDP EQU   X'40'                SWITCHED TO DPT FOR OVERNIGHT RADIO         
TPMN2A6A EQU   X'20'                SWITCHED TO READ NSI 2A-6A DATA             
TPRCNDS  DS    CL1                 X'00'/Y/N FOR CONDENSED RADIO MKT            
TPSVMKT  DS    XL(L'PIKMKT)        USED TO SAVE MKT NUMBER                      
TPTIM2   DS    XL4                 TIME PORTION 2 - AFTER 6AM                   
TPSVTIM  DS    XL4                                                              
TPREC    DS    CL1204                                                           
*                                                                               
*           ADD'L STORAGE FOR GETTP                                             
         DS    F                                                                
AIUEBOOK DS    H                   SAVED BOOK FOR AIUE LOOKUP                   
CANWLAT  DS    XL2                 LATEST MONTH FOR CANADIAN WEEKLY             
CANSWK   DS    XL1                 START BOOK (WEEK) FOR CSI                    
CANEWK   DS    XL1                 END   BOOK (WEEK) FOR CSI                    
TPQHWKS  DS    XL1                 WEEKS IN CURRENT QH                          
MBKFLAG  DS    C                                                                
BKDTFLAG DS    C                                                                
CABLEFLG DS    C                   Y = CABLE DEFINED IN DEMTABS                 
BADBTFLG DS    C                   BAD BOOKTYPE FLAG                            
BADBTDIR EQU   X'80'               READ FOR BAD BOOKTYPE IN DIR KEY             
BADBTFIL EQU   X'40'               READ FOR BAD BOOKTYPE IN DEMO FILE           
*                                                                               
TEMPBOOK DS    XL2                                                              
OFFAIRF  DS    X                                                                
MERGEF   DS    X                                                                
MSTAFLG  DS    X                                                                
MSTADONE EQU   X'80'                                                            
MSTAMORE EQU   X'40'                                                            
SVOPNSQH DS    X                   SAVE PROGRAM NAME SQH                        
SVOPNEQH DS    X                   SAVE PROGRAM NAME EQH                        
SVDBDQPT DS    X                                                                
SVFUEFLG DS    X                                                                
SVACTBK  DS    XL2                 SAVED ACTBK                                  
SVSELBK  DS    XL2                 SAVED USER'S DBSELBK                         
SVSELTIM DS    XL4                 SAVED USER'S DBSELTIM                        
SVSELTM2 DS    XL4                 SAVED USER'S DBSELTIM                        
SVSELPRG DS    XL2                 SAVED USER'S DBSELPRG                        
SVINTFIL DS    XL(L'DBINTFIL)      SAVED INTERNAL FILE                          
SVINTMED DS    XL(L'DBINTMED)      SAVED INTERNAL MEDIA                         
SVSELDAT DS    XL(L'DBSELDAT)      SAVE USER'S DBSELDAT                         
LASTLMT  DS    XL2                 LASTN LIMIT BOOK                             
RDAYPART DS    C                   Y=USE RADIO DAYPART SECTION                  
SQADACT  DS    C                                                                
CANMBK   DS    XL2                                                              
LPMEMON  DS    XL2                 LAST PARALLEL LPM DATE                       
SVBBMBK  DS    CL2                 REVERT TO BOOK IF NOT WEEKLY                 
LPMBTYP  DS    CL1                 LPM LATEST BTYP SAVE                         
SVBTYPE  DS    CL1                 SAVE THE BOOKTYPE                            
AIUESTAT DS    CL5                 SAVED STATION FOR AIUE LOOKUP                
AIUEMKT  DS    CL2                 SAVED MARKET # FOR AIUE LOOKUP               
ALOCNTRY DS    A                                                                
SVALOCNT DS    A                                                                
ASTALINK DS    A                                                                
LSTALINK DS    A                                                                
WKBKD1   DS    XL2                 FIRST BOOK(WK SPLIT BOOKS)                   
WKBKD2   DS    XL2                 SECOND BOOK(WK SPLIT BOOKS)                  
WKBKDFLG DS    C                   WKBK FLAG- WHICH SPLIT BOOK (1/2)            
USELAT   DS    C                                                                
SVCALL   DS    CL(L'DBSELSTA)                                                   
SVALF    DS    CL(L'DBSELALF)                                                   
SVSELMK  DS    XL(L'DBSELMK)                                                    
SVSELMK2 DS    XL(L'DBSELMK)                                                    
STALFLAG DS    C                   STATION LINK FLAG Y/N                        
PPM_FLAG DS    C                   PPM LIVE BOOK LOADED YET ?                   
PPMFIRST EQU   X'01'               1ST TIME CHECKING PPM_FLAG                   
PPMLVBKY EQU   X'10'               PPM LIVE BOOK IS IN                          
PPMSEQ   EQU   X'11'               NOT 1ST TIME CHECKING PPM FLAG               
DBEXTFLG DS    X                   DBXTEND FLAG                                 
MBK_YES  EQU   X'01'               MULTIBOOK LOOKUP=YES                         
MBK_DONE EQU   X'02'               MULTIBOOK LOOKUP IS DONE                     
DYTM_YES  EQU   X'04'              MULTI DAYTIM LOOKUP = YES                    
DYTM_DONE EQU   X'08'              MULTI DAYTIM LOOKUP IS DONE                  
MSTA_YES  EQU   X'10'               MULTI_STATION LOOKUP =YES                   
MSTA_DONE EQU   X'20'               MULTI_STATION LOOKUP IS DONE                
ASPTTAB  DS    A                   ADDRESS SPOT POSTING DATES                   
SPTTBPTR DS    A                   APOINTER TO SPOT POSTING DATES TAB           
NUMSPOTS DS    H                   NUMBER OF SPOTS                              
SPTTABLN DS    X                   LENGTH OF TABLE ENTRIES                      
HALF     DS    H                                                                
DIRERR   DS    X                   FLAG TO INDICATE ERROR ON DIRR READ          
PREVMKT  DS    XL(L'DRKMKT)                                                     
SASTALNK DS    A                                                                
READFLAG DS    X                                                                
READ_TODAY     EQU X'01'                                                        
READ_TONIGHT   EQU X'02'                                                        
READ_YESTERDAY EQU X'10'                                                        
INBOOK   DS    XL(L'DBSELBK)                                                    
VGETBRO  DS    V                                                                
VNETWEEK DS    V                                                                
VNSIWEEK DS    V                                                                
PRGNAME  DS    CL16                                                             
TOONLIST DS    CL10                                                             
TOONSTAF DS    C                                                                
TOONFST  EQU   X'80'                                                            
TOON2ND  EQU   X'40'                                                            
TOONDONE EQU   X'20'                                                            
******************************************************************              
* DO NOT ADD ANY STORAGE WITHIN THIS BOX !!!!! THIS AREA GETS                   
* PASSED INTO DBSPANAD AND THOSE WHO LOOK AT THIS AREA ASSUMES                  
* THE STORAGE LOOKS LIKE THE WAY IT IS DEFINED HERE!!!!                         
FUSUEID  DS    CL4                 ID=UEST                                      
FUSAIUE  DS    XL3                 AD INSERTABLE UNIVERSE ESTIMATE              
FUSCRUE  DS    XL3                 CARRIAGE UNIVERSE ESTIMATE                   
NSIUID   DS    CL4                 ID=NSIU                                      
NSIUEL   DS    CL250               NSI UNIVERSE ELEMENT                         
******************************************************************              
*                                                                               
TPDBDQD  DS    (8*3)XL(DBDQLEN),XL1  ALTERNATE DAY/QHR CONTROL AREA             
TPDBDQDL EQU   *-TPDBDQD                                                        
TPLWORKQ EQU   *-TPLWORK           L'WORKING STORAGE                            
         EJECT                                                                  
NSIUNVD  DSECT                                                                  
NUDUB    DS    D                                                                
NUAREC   DS    F                                                                
NULSTDIR DS    XL(L'DBLSTDIR)                                                   
NUINKEY  DS    CL(L'DBMINKEY)                                                   
NUMNKYRD DS    CL(L'DBMINKEY)                                                   
NUL1Q    EQU   *-NULSTDIR                                                       
NUREC    DS    CL1204                                                           
NSIUNVWX EQU   *                                                                
NSIUNVDL EQU   *-NSIUNVD                                                        
*                                                                               
PGMNAMD  DSECT                                                                  
PGMDUB   DS    D                                                                
PGMAREC  DS    F                                                                
PGMLSTDR DS    XL(L'DBLSTDIR)                                                   
PGMQHMIN DS    XL(L'DBMINKEY)      REQUEST MINOR KEY                            
PGMDTIME DS    XL(L'DBMINKEY)      CURRENT RECORD MINOR KEY                     
PGMKEYL  EQU   *-PGMLSTDR                                                       
PGMREC   DS    CL1204                                                           
PGMRECX  EQU   *                                                                
PGMSVKEY DS    XL18                PRE-ALTERED KEY                              
PGMSVMIN DS    XL(L'DBMINKEY)      PRE-ALTERED MINOR KEY                        
PGMNAML  EQU   *-PGMNAMD                                                        
*                                                                               
                                                                                
         SPACE 2                                                                
SDQTABD  DSECT                                                                  
SDQSTA   DS    CL5                 STATION                                      
SDQDAY   DS    XL1                 DAY                                          
SDQSQH   DS    XL1                 QH - START                                   
SDQEQH   DS    XL1                 QH - END                                     
SDQLENQ  EQU   *-SDQTABD           L(STATION/DAY/QH TABLE)                      
         SPACE 2                                                                
PSMTABD  DSECT                                                                  
PSMPNUM  DS    XL(L'PIPNUM)        PROGRAM #                                    
PSMSTTN  DS    CL(L'PISTA)         STATION                                      
PSMKMKT  DS    XL(L'PIKMKT)        SPILL MARKET                                 
PSMDAY   DS    XL(L'PIDAY)         DAY                                          
PSMSQH   DS    XL(L'PISQH)         START QH                                     
PSMLENQ  EQU   *-PSMTABD           L(PROG#/STTN/MKT/DAY/SQH TABLE)              
PSMBNKYL EQU   *-PSMSTTN           BINSRCH KEY LENGTH                           
PSMBNKYD EQU   PSMSTTN-PSMTABD     BINSRCH DISPLACEMENT TO KEY                  
         EJECT                                                                  
* FASSB                                                                         
* FASYSFAC                                                                      
* DEGETD                                                                        
* DEDBEXTRAD                                                                    
* DDMASTD                                                                       
* DDMONYREQU                                                                    
* SPOTTABD                                                                      
* FASSBOFF                                                                      
         PRINT OFF                                                              
       ++INCLUDE FASSB                                                          
         EJECT                                                                  
       ++INCLUDE FASYSFAC                                                       
         EJECT                                                                  
       ++INCLUDE DEGETD                                                         
         EJECT                                                                  
       ++INCLUDE DEDBEXTRAD                                                     
         EJECT                                                                  
       ++INCLUDE DDMASTD                                                        
         EJECT                                                                  
       ++INCLUDE DDMONYREQU                                                     
         EJECT                                                                  
       ++INCLUDE SPOTTABD                                                       
         EJECT                                                                  
SSBOFFD  DSECT                                                                  
       ++INCLUDE FASSBOFF                                                       
         PRINT ON                                                               
         SPACE 3                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'097DEGETTP   01/22/21'                                      
         END                                                                    
